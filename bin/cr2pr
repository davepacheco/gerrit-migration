#!/bin/bash
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
# Copyright 2019 Joyent, Inc.
#

#
# Call this to move a cr.joyent.us Gerrit CR to a Joyent GitHub PR.
#
# This will do the following:
# - Download the CR info from the archive and verify that it is open and for a
#   "joyent" org repo.
# - Summarize the CR discussion (if any) in a Markdown file to be used for the
#   PR description.
# - Get a clone of the repo, from which a PR will be created.
# - Download the latest patch set from the archive and apply it.
# - Use 'hub pull-request' to create PR.
# - Abandon the CR.
#
# Prerequisites:
# - You have "json" and "hub" installed and on your PATH.
#
# Limitations:
# -
#
#
# Usage (prompts for parameters):
#   bash -c "$(curl -ksSL https://raw.githubusercontent.com/joyent/gerrit-migration/master/bin/cr2pr)"
#
# or:
#   curl -ksSL -O https://raw.githubusercontent.com/joyent/gerrit-migration/master/bin/cr2pr
#   chmod +x ./cr2pr
#   ./cr2pr [-u GITHUB-USER] CR-NUM
#

if [[ -n "$TRACE" ]]; then
    export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
    set -o xtrace
fi
set -o errexit
set -o pipefail

VERSION=1.1.2


# ---- support functions

function fatal
{
    echo "$0: fatal error: $*"
    exit 1
}

function usage
{
    echo "Usage: ./cr2pr CR-NUM"
}


# ---- mainline

TOP=$(cd $(dirname $0)/../; pwd)

JSON=$(which json)
[[ -n "$JSON" ]] || fatal "'json' is not on your PATH"
HUB=$(which hub)
[[ -n "$HUB" ]] \
    || fatal "'hub' is not on your PATH, install it https://hub.github.com/"

# If this is other than "joyent", then we are working on a fork of the Joyent
# repo.
githubUser=joyent

if [[ $# -gt 0 ]]; then
    while getopts "hu:y" opt
    do
        case "$opt" in
            h)
                usage
                exit 0
                ;;
            u)
                # TODO: This is untested.
                githubUser=$OPTARG
                ;;
            *)
                usage
                fatal "unknown option: -$opt"
                exit 1
                ;;
        esac
    done
    shift $(( $OPTIND - 1 ))

    crNum=$1
    [[ -n "$crNum" ]] || fatal "missing CR-NUM argument"
else
    echo "Please provide the following CR info:"
    echo -n " - CR number: "
    read crNum
    [[ -n "$crNum" ]] || fatal "CR number cannot be empty"
    echo -n " - GitHub repo user or org (default 'joyent'): "
    read githubUser
    [[ -z "$githubUser" ]] && githubUser=joyent
    echo ""
fi

# Version (can help when getting surprised by curl'ing and caching).
echo "cr2pr version $VERSION"

# Working temp dir.
wrkDir=/var/tmp/cr2pr-$crNum-$(date '+%Y%m%dT%H%M%S')
echo "Temporary working dir: $wrkDir"
mkdir $wrkDir
cd $wrkDir

# Get the change info and some validation.
curl -sSO https://raw.githubusercontent.com/joyent/gerrit-migration/master/archive/$crNum/change.json
project=$(json -f change.json project)
echo "Repository: $project"
if [[ ${project} != joyent/* ]]; then
    fatal "'$project' not a joyent/NAME repo: this script doesn't support those"
fi
isOpen=$(json -f change.json open)
if [[ ${isOpen} != "true" ]]; then
    fatal "this CR is not open!"
fi
repoName=$(basename $project)
echo ""
echo "# This will migrate https://cr.joyent.us/$crNum to https://github.com/joyent/$repoName/pulls"
echo ""

# Create a PR message
echo "## Create a Markdown summary of the CR"
CR2MD=$TOP/bin/cr2md
if [[ ! -f $CR2MD ]]; then
    # This isn't running in the gerrit-migration repo, so we need to download
    # the script.
    curl -ksSL -O https://raw.githubusercontent.com/joyent/gerrit-migration/master/bin/cr2md
    chmod +x cr2md
    CR2MD=./cr2md
fi
$CR2MD change.json > pr-message.md
echo "wrote pr-message.md"

# Get the currentPatchSet diff.
curl -sSO https://raw.githubusercontent.com/joyent/gerrit-migration/master/archive/$crNum/currentPatchSet.diff

# Get a repo clone to work with.
echo ""
echo "## Getting a local clone of git@github.com:$githubUser/$repoName"
repoCacheDir=/var/tmp/cr2pr-repo-cache
mkdir -p $repoCacheDir
if [[ ! -d $repoCacheDir/$repoName ]]; then
    (cd $repoCacheDir && git clone git@github.com:$githubUser/$repoName)
else
    (cd $repoCacheDir/$repoName && git fetch)
fi
cp -PR $repoCacheDir/$repoName ./$repoName

# Create a feature branch based off the parent.
echo ""
branchName=cr$crNum
primaryTicket=$(json -f change.json subject | cut -d' ' -f1 | cut -d: -f1)
if [[ -n "$primaryTicket" ]]; then
    # primaryTicket could be MANTA-123 or joyent/name#123
    # Let's massage the latter to avoid branch names with '/' and '#'.
    branchName+=-$(echo -n "$primaryTicket" | tr -C '[:alnum:]' '-')
fi
parentCommit=$(json -f change.json currentPatchSet.parents.0)
[[ -n $parentCommit ]] || fatal "no parent commit sha?"
echo "## Creating branch $branchName for PR (from parent commit $parentCommit)"
cd $repoName
git branch $branchName $parentCommit
git checkout $branchName
git am --committer-date-is-author-date < ../currentPatchSet.diff
git push origin $branchName

# Create the pull request.
echo ""
echo "## Creating the PR"
ownerUsername=$(json -f ../change.json owner.username)
[[ -n "$ownerUsername" ]] || fatal "why no owner.username for this change?"
hubCmd="hub pull-request -F ../pr-message.md -a $ownerUsername"
reviewers=$(json -f ../change.json | json allReviewers | json -a username \
    | grep -v "$ownerUsername" | grep -v joyent-automation \
    | grep -v davepacheco | grep -v melloc | grep -v jclulow \
    | xargs | tr ' ' ',' || true)
if [[ -n "$reviewers" ]]; then
    hubCmd+=" -r $reviewers"
fi
echo "Running: '$hubCmd'"
prUrl=$($hubCmd)
if [[ -z "$prUrl" ]]; then
    fatal 'creation of PR failed: output of "hub pull-request -F ../pr-message.md" did not include a PR URL'
fi
echo "Created PR: $prUrl"

## Note: There is some bug in "gerrit review" such that it cannot handle
## spaces in the "--message" arg, so we've simplified our abandonment message.
echo ""
echo "## Abandoning the CR "
revision=$(json -f ../change.json currentPatchSet.revision)
echo "Running: ssh cr gerrit review --abandon -m $prUrl $revision"
ssh cr gerrit review --abandon -m $prUrl $revision

echo ""
echo "Successfully moved https://cr.joyent.us/$crNum to $prUrl"
