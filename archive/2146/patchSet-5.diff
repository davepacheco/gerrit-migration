From 02b9612cc8e35ad729f1c8f35eb4b80886e170c4 Mon Sep 17 00:00:00 2001
From: Sean Chittenden <sean@chittenden.org>
Date: Fri, 23 Jun 2017 10:47:50 -0700
Subject: [PATCH] MANTA-3323: initdb(1) with explicit locale and encoding

---
 lib/postgresMgr.js | 18 ++++++++----------
 1 file changed, 8 insertions(+), 10 deletions(-)

diff --git a/lib/postgresMgr.js b/lib/postgresMgr.js
index 620fc9d..4efe456 100644
--- a/lib/postgresMgr.js
+++ b/lib/postgresMgr.js
@@ -29,6 +29,7 @@ var fs = require('fs');
 var pg = require('pg');
 var Client = pg.Client;
 var shelljs = require('shelljs');
+var mod_forkexec = require('forkexec');
 var spawn = require('child_process').spawn;
 var exec = require('child_process').exec;
 var once = require('once');
@@ -1497,17 +1498,14 @@ PostgresMgr.prototype._initDb = function (callback) {
 
         },
         function _initDb(_, cb) {
-            var cmd = 'sudo -u ' + self._dbUser + ' ' +
-                self._pgInitDbPath + ' -D ' + self._dataDir;
-            log.info({cmd: cmd}, 'PostgresMgr.initDb: initializing db');
-            exec(cmd, function (err, stdout, stderr) {
+            var args = [ 'sudo', '-u', self._dbUser,
+                         self._pgInitDbPath, '--encoding=UTF-8', '--locale=C',
+                         '-D', self._dataDir ];
+            log.info({cmd: 'initdb', argv: args},
+                     'PostgresMgr.initDb: initializing db');
+            mod_forkexec.forkExecWait({ argv: args }, function (err, info) {
                 // ignore errors since the db could already be initialized
-                log.info({
-                    err: err,
-                    stdout: stdout,
-                    stderr: stderr,
-                    dataDir: self._dataDir
-                }, 'PostgresMgr.initDb: initdb returned');
+                log.info(info, 'PostgresMgr.initDb: initdb returned');
 
                 shelljs.cp('-f', self._hbaConf, self._dataDir + '/pg_hba.conf');
                 log.info({
-- 
2.21.0

