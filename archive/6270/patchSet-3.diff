From f2bb88bcc07e5f233973eaa78cc603a109979c18 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 17 May 2019 10:17:49 -0700
Subject: [PATCH] =?UTF-8?q?TRITON-1677=20broke=20callback=20handling=20in?=
 =?UTF-8?q?=20vmapi=20lib/endpoints/vms.js=20can=20lead=20to=20double-call?=
 =?UTF-8?q?back=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@?=
 =?UTF-8?q?joyent.com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20?=
 =?UTF-8?q?<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/endpoints/vms.js | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/lib/endpoints/vms.js b/lib/endpoints/vms.js
index 832b259..6d24871 100644
--- a/lib/endpoints/vms.js
+++ b/lib/endpoints/vms.js
@@ -1179,7 +1179,9 @@ function _cnapiServerNotFoundError(err) {
  */
 function createRoleTags(req, cb) {
     var error, message;
+    var i;
     var roleTags = req.params.role_tags;
+    var roleTag;
 
     if (!Array.isArray(roleTags) || Object.keys(roleTags).length === 0) {
         message = 'Must be an array of UUIDs';
@@ -1188,15 +1190,16 @@ function createRoleTags(req, cb) {
         return;
     }
 
-    roleTags.forEach(function (roleTag) {
+    for (i = 0; i < roleTags.length; ++i) {
+        roleTag = roleTags[i];
         if (!common.validUUID(roleTag)) {
             message = roleTag + ' is not a UUID';
             error = [ errors.invalidUuidErrorsElem('role_tags', message) ];
-            // XXX This is broken. It can `cb` multiple times.
             cb(new errors.ValidationFailedError('Invalid VM parameters',
                 error));
+            return;
         }
-    });
+    }
 
     req.app.moray.putVmRoleTags(req.params.uuid, roleTags, cb);
 }
-- 
2.21.0

