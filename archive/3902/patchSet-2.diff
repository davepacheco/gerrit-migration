From 85e976132b31c99d8ac33a167c9c355c9990bd3a Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody@kkantor.com>
Date: Thu, 3 May 2018 19:33:11 +0000
Subject: [PATCH] MORAY-462 artedi metrics should report shard name

---
 etc/config.coal.manta.json    | 3 ++-
 lib/server.js                 | 5 +++++
 package.json                  | 2 +-
 sapi_manifests/moray/template | 3 ++-
 4 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/etc/config.coal.manta.json b/etc/config.coal.manta.json
index 5790d98..c5e22ba 100644
--- a/etc/config.coal.manta.json
+++ b/etc/config.coal.manta.json
@@ -33,5 +33,6 @@
     "expiry": 60
   },
   "server_uuid": "fake-manta-coal-server-uuid",
-  "datacenter": "coal"
+  "datacenter": "coal",
+  "service_name": "1.moray.coal.joyent.us"
 }
diff --git a/lib/server.js b/lib/server.js
index b7e29a7..10e4ae8 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -68,6 +68,11 @@ function MorayServer(options) {
         pid: process.pid
     };
 
+    /* service_name includes the shard name in Manta deployments. */
+    if (options.service_name) {
+        labels.service_name = options.service_name;
+    }
+
     var collector = mod_artedi.createCollector({
         labels: labels
     });
diff --git a/package.json b/package.json
index a278751..6dc39a9 100644
--- a/package.json
+++ b/package.json
@@ -7,7 +7,7 @@
     "main": "lib/index.js",
     "dependencies": {
         "ajv": "4.11.4",
-        "artedi": "1.1.1",
+        "artedi": "1.3.0",
         "assert-plus": "1.0.0",
         "bunyan": "1.8.10",
         "bunyan-syslog": "0.2.2",
diff --git a/sapi_manifests/moray/template b/sapi_manifests/moray/template
index 00b9609..ea0fc5e 100644
--- a/sapi_manifests/moray/template
+++ b/sapi_manifests/moray/template
@@ -34,5 +34,6 @@
     "expiry": 60
   },
   "server_uuid": "{{auto.SERVER_UUID}}",
-  "datacenter": "{{DATACENTER}}"
+  "datacenter": "{{DATACENTER}}",
+  "service_name": "{{SERVICE_NAME}}"
 }
-- 
2.21.0

