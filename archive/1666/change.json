{"project":"joyent/illumos-joyent","branch":"master","id":"Ifc23aa9bfe9a967a31614f6829d88243205132e0","number":"1666","subject":"OS-6007 dladm tries setting persistent prop on temporary link Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/1666","commitMessage":"OS-6007 dladm tries setting persistent prop on temporary link\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1489597632,"lastUpdated":1490027966,"open":false,"status":"MERGED","comments":[{"timestamp":1489597632,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1489597784,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1489603142,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1489615218,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1489617742,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1489619380,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1489688867,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1489688974,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nRyan, yes, the comment sounds like a good idea, thanks for the explanation."},{"timestamp":1489698938,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4."},{"timestamp":1489700508,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1489700973,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nTest notes added to issue."},{"timestamp":1489701727,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nAt Robert\u0027s suggestion I\u0027m also going to add a case to our existing dladm tests in util-tests."},{"timestamp":1489777726,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5."},{"timestamp":1489777796,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5:\n\nI still need to verify that running this with the test-runner works, but I did run the script by hand to test before posting for review."},{"timestamp":1489786649,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1489803559,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5:\n\nOkay, verified it ran with test runner and added another note to the issue."},{"timestamp":1490010047,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1490027885,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1490027950,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1490027966,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"7","revision":"fc23aa9bfe9a967a31614f6829d88243205132e0","parents":["282642e497204e64144beac6ac94dbe281fc53f3"],"ref":"refs/changes/66/1666/7","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1490027950,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489786649,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1490010047,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1490027966,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":32,"deletions":-12},{"file":"usr/src/test/util-tests/runfiles/default.run","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/Makefile","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"usr/src/test/util-tests/tests/dladm/set-linkprop.ksh","type":"ADDED","insertions":208,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/vnic-mtu.ksh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":245,"sizeDeletions":-16},"patchSets":[{"number":"1","revision":"113a5d889658619bcc300e4abb41ebf920c912a1","parents":["65901b7e8233a3b0d360a62789ca81efa02f81ff"],"ref":"refs/changes/66/1666/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1489597632,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":19,"deletions":-12}],"sizeInsertions":19,"sizeDeletions":-12},{"number":"2","revision":"1101b31c408d02a457ccc695a3a65ef19d6f24d9","parents":["65901b7e8233a3b0d360a62789ca81efa02f81ff"],"ref":"refs/changes/66/1666/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1489597784,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","comments":[{"file":"usr/src/lib/libdladm/common/linkprop.c","line":1022,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It is maybe a little outside of the scope of your current change, but it seems like this code could be simplified a bit more to avoid the \u0027status\u0027 and \u0027s\u0027 dance, and simply use \u0027status\u0027 directly, setting it properly on the success path around line 1039."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":19,"deletions":-12}],"sizeInsertions":19,"sizeDeletions":-12},{"number":"3","revision":"6a76ba09929b89dadbbbe1e1fe144320a1817c48","parents":["65901b7e8233a3b0d360a62789ca81efa02f81ff"],"ref":"refs/changes/66/1666/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1489615218,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/libdladm/common/linkprop.c","line":1043,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"sorry, one more nit here, but the original code would break once it set the prop instead of going through everything. we probably want to preserve that behavior. I think a break here at the end is sufficient since the repeated original check for NULL seems unnecessary"},{"file":"usr/src/lib/libdladm/common/linkprop.c","line":1043,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Doh, how did I miss that!"},{"file":"usr/src/lib/libdladm/common/linkprop.c","line":1043,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"So it turns out we need this status dance. Some consumers (e.g., dladm_vnic_delete) pass a prop_name of NULL in order to loop through all props and reset them to their default value. I was going to change my latest patch to only break when prop_name !\u003d NULL but that\u0027s still not quite right.\n\nIn the original function the reason we do that status dance is so that any failure status (i.e. not OK or NOTSUP) is recorded in status and future return codes don\u0027t overwrite it. E.g., if the first call to i_dladm_set_single_prop is a failure then we a) still want to loop through all props and attempt to reset them and b) record the failure in status so that it is returned even if further calls to i_dladm_set_single_prop are successful.\n\nI can add a comment to this code to clarify the intent if you agree."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":31,"deletions":-23}],"sizeInsertions":31,"sizeDeletions":-23},{"number":"4","revision":"a1e8eae2235f7dfd86ea8961011fc7f9126e4961","parents":["65901b7e8233a3b0d360a62789ca81efa02f81ff"],"ref":"refs/changes/66/1666/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1489698938,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489700508,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":32,"deletions":-12}],"sizeInsertions":32,"sizeDeletions":-12},{"number":"5","revision":"25265a78caf951bda36c715a5978c59be5e64470","parents":["65901b7e8233a3b0d360a62789ca81efa02f81ff"],"ref":"refs/changes/66/1666/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1489777726,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489786649,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1490010047,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":32,"deletions":-12},{"file":"usr/src/test/util-tests/runfiles/default.run","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/Makefile","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"usr/src/test/util-tests/tests/dladm/set-linkprop.ksh","type":"ADDED","insertions":208,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/vnic-mtu.ksh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":245,"sizeDeletions":-16},{"number":"6","revision":"1b62793f3ca6c5ef3473023ac08a5d98d0a1cc95","parents":["282642e497204e64144beac6ac94dbe281fc53f3"],"ref":"refs/changes/66/1666/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1490027885,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489786649,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1490010047,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":32,"deletions":-12},{"file":"usr/src/test/util-tests/runfiles/default.run","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/Makefile","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"usr/src/test/util-tests/tests/dladm/set-linkprop.ksh","type":"ADDED","insertions":208,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/vnic-mtu.ksh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":245,"sizeDeletions":-16},{"number":"7","revision":"fc23aa9bfe9a967a31614f6829d88243205132e0","parents":["282642e497204e64144beac6ac94dbe281fc53f3"],"ref":"refs/changes/66/1666/7","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1490027950,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489786649,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1490010047,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1490027966,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/libdladm/common/linkprop.c","type":"MODIFIED","insertions":32,"deletions":-12},{"file":"usr/src/test/util-tests/runfiles/default.run","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/Makefile","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"usr/src/test/util-tests/tests/dladm/set-linkprop.ksh","type":"ADDED","insertions":208,"deletions":0},{"file":"usr/src/test/util-tests/tests/dladm/vnic-mtu.ksh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":245,"sizeDeletions":-16}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}