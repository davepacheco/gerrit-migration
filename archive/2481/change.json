{"project":"joyent/illumos-joyent","branch":"master","id":"I58cb9430032e4f58eaafab0be2b42662cb3f1180","number":"2481","subject":"OS-6275 lx pipe buffer is too small Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Jason King \u003cjason.king@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2481","commitMessage":"OS-6275 lx pipe buffer is too small\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1504182931,"lastUpdated":1504623074,"open":false,"status":"MERGED","comments":[{"timestamp":1504182931,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1504191971,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)\n\nThis looks like a good approach overall"},{"timestamp":1504204946,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1504204964,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI made the suggested changes."},{"timestamp":1504208465,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1504211676,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1504212089,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1504212370,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1504214153,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1504620908,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1504621513,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\ntest notes are in the ticket"},{"timestamp":1504621572,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1504622580,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1504623063,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1504623074,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"58cb9430032e4f58eaafab0be2b42662cb3f1180","parents":["9105a020d63cb56f2be32de07d869c429cf3d4a8"],"ref":"refs/changes/81/2481/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504623063,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504620908,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504621572,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1504623074,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","type":"MODIFIED","insertions":5,"deletions":-7},{"file":"usr/src/uts/common/fs/fifofs/fifovnops.c","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/fifonode.h","type":"MODIFIED","insertions":2,"deletions":-10}],"sizeInsertions":46,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"97e9755135c90660b8442afe93687b7ddd917539","parents":["9e58415e998e45a09444cd8c9b84809d3eb37d3f"],"ref":"refs/changes/81/2481/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504182931,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_fcntl.c","line":241,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would suggest that the logic to set fn_hiwat on the fifonode_t be rolled into the logic for lx_pipe_setsz.  Critically, it seems like fn_lock should be held when testing against fn_flag or setting fn_hiwat.\n\nThe sd_vnode and sd_mate fields under stdata_t should be adequate to locate the vnodes (and thus fifonode_t data) needed for that."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","line":182,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Same concerns about rolling fn_hiwat setting into lx_pipe_setsz"},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","line":1165,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Insert an empty line between the ASSERTs and the normal logic?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_fcntl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"usr/src/uts/common/fs/fifofs/fifovnops.c","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/fifonode.h","type":"MODIFIED","insertions":2,"deletions":-10}],"sizeInsertions":22,"sizeDeletions":-24},{"number":"2","revision":"fff383ac6f050e5679e5c80eff4afc0793dbc6b8","parents":["1be86b3cfe50fab77d37377138be07c9d974937e"],"ref":"refs/changes/81/2481/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504204946,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","line":133,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If this isn\u0027t always true, I think we\u0027re in deep trouble."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","line":133,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Its certainly not true on my system. This is set in the fnode_constructor from the fifodata_t passed in. This could come from the pipe_constructor or the fnode_constructor. In this path we create multiple fifodata_t\u0027s with the same fn_lock. I\u0027m more inclined to think this could never be true and just assert it, but I\u0027m not 100% sure there isn\u0027t some way it might be true."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","line":133,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I think an ASSERT seems reasonable here.  I\u0027ll take another spin through the fifodata_t neighborhood, but what you noted seemed correct -- the fn_lock pointers should always be the same.\n\nPerhaps specify in a comment that lx_pipe_setsz expects the caller to have verified that the vnodes in question are VFIFO and have v_op \u003d\u003d fifovnops (as already done by the two  call sites)?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","line":133,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sure, that sounds good. I\u0027ll make those changes."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","type":"MODIFIED","insertions":5,"deletions":-7},{"file":"usr/src/uts/common/fs/fifofs/fifovnops.c","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/fifonode.h","type":"MODIFIED","insertions":2,"deletions":-10}],"sizeInsertions":41,"sizeDeletions":-26},{"number":"3","revision":"d8aaaf82875342e82d59fc2edf761242b1f591fb","parents":["1be86b3cfe50fab77d37377138be07c9d974937e"],"ref":"refs/changes/81/2481/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504214153,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504620908,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504621572,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","type":"MODIFIED","insertions":5,"deletions":-7},{"file":"usr/src/uts/common/fs/fifofs/fifovnops.c","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/fifonode.h","type":"MODIFIED","insertions":2,"deletions":-10}],"sizeInsertions":46,"sizeDeletions":-26},{"number":"4","revision":"67a62269397802891b1a4e7a4a90fb8f5ee4fef9","parents":["9105a020d63cb56f2be32de07d869c429cf3d4a8"],"ref":"refs/changes/81/2481/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504622580,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504620908,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504621572,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","type":"MODIFIED","insertions":5,"deletions":-7},{"file":"usr/src/uts/common/fs/fifofs/fifovnops.c","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/fifonode.h","type":"MODIFIED","insertions":2,"deletions":-10}],"sizeInsertions":46,"sizeDeletions":-26},{"number":"5","revision":"58cb9430032e4f58eaafab0be2b42662cb3f1180","parents":["9105a020d63cb56f2be32de07d869c429cf3d4a8"],"ref":"refs/changes/81/2481/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504623063,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1504623074,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504620908,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504621572,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_pipe.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/uts/common/fs/fifofs/fifosubr.c","type":"MODIFIED","insertions":5,"deletions":-7},{"file":"usr/src/uts/common/fs/fifofs/fifovnops.c","type":"MODIFIED","insertions":8,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/fifonode.h","type":"MODIFIED","insertions":2,"deletions":-10}],"sizeInsertions":46,"sizeDeletions":-26}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}