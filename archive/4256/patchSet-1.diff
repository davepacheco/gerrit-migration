From c4954c7876051356551fe685cb1914ec17fd1375 Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Tue, 19 Jun 2018 10:43:09 -0500
Subject: [PATCH] Fix routing latency spikes

---
 usr/src/uts/common/io/overlay/overlay_target.c | 18 +++++++++++++++---
 1 file changed, 15 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/io/overlay/overlay_target.c b/usr/src/uts/common/io/overlay/overlay_target.c
index e02e80d1af..57f2078a43 100644
--- a/usr/src/uts/common/io/overlay/overlay_target.c
+++ b/usr/src/uts/common/io/overlay/overlay_target.c
@@ -877,8 +877,12 @@ overlay_target_lookup(overlay_dev_t *odd, mblk_t *mp, struct sockaddr *sock,
 		OVERLAY_DROP(mp, "VL2 target marked drop");
 		ret = OVERLAY_TARGET_DROP;
 	} else if (entry->ote_flags & OVERLAY_ENTRY_F_ROUTER) {
-		ret = overlay_route_lookup(odd, mp, VLAN_ID(mhi.mhi_tci), sock,
-		    slenp, vidp);
+		if (mhi.mhi_bindsap == ETHERTYPE_ARP) {
+			ret = overlay_target_try_queue(entry, mp);
+		} else {
+			ret = overlay_route_lookup(odd, mp,
+			    VLAN_ID(mhi.mhi_tci), sock, slenp, vidp);
+		}
 	} else if (entry->ote_flags & OVERLAY_ENTRY_F_VALID) {
 		overlay_target_point_t *otp = &entry->ote_u.ote_vl2.otvl2_dest;
 
@@ -1124,7 +1128,15 @@ again:
 	entry = list_remove_head(&overlay_target_list);
 	mutex_exit(&overlay_target_lock);
 	mutex_enter(&entry->ote_lock);
-	if (entry->ote_flags & OVERLAY_ENTRY_F_VALID) {
+	/*
+	 * Router entries may send lookups to varpd even when valid.  For
+	 * example, illumos systems will send unicast ARP queries to cached
+	 * entries (including the router mac address).  To answer those, we
+	 * need to forward on the query to varpd.
+	 */
+	if ((entry->ote_flags &
+	    (OVERLAY_ENTRY_F_VALID|OVERLAY_ENTRY_F_ROUTER)) ==
+	    OVERLAY_ENTRY_F_VALID) {
 		ASSERT(entry->ote_chead == NULL);
 		mutex_exit(&entry->ote_lock);
 		goto again;
-- 
2.21.0

