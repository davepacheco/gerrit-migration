{"project":"joyent/illumos-joyent","branch":"master","id":"I881ad294e65e1bdc2db9586d72cbcb9c8d801dc9","number":"1834","subject":"OS-6040 DLS stat delete and aggr kstat can deadlock Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/1834","commitMessage":"OS-6040 DLS stat delete and aggr kstat can deadlock\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1493085943,"lastUpdated":1493384507,"open":false,"status":"MERGED","comments":[{"timestamp":1493085943,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1493086125,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1493086817,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nThe idea here is to replace the use of the MAC perim with a mutex specific to the aggr to synchronize access to the stat fields."},{"timestamp":1493146865,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1493149793,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1493155270,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI\u0027ll defer to you on if you think the current approach is best or not. Maybe if you keep it this way, expanding the comment a bit with some of what you wrote here might be helpful for future maintenance?"},{"timestamp":1493329699,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1493329914,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\nIn this latest patch any access to these fields is protected by the lg_stat_lock mutex -- even if the MAC perim already guarantees safety. This makes it easier for future maintainers to reason about concurrent access.\n\nI also make a cstyle fix to one of the block comments."},{"timestamp":1493332704,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1493350406,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1493350543,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nTesting notes added to issue."},{"timestamp":1493379402,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1493384439,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1493384471,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1493384507,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"6","revision":"881ad294e65e1bdc2db9586d72cbcb9c8d801dc9","parents":["21894f7facc18d35f540a9f52fd1f3db4d0e679f"],"ref":"refs/changes/34/1834/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493384471,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493332704,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493379402,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1493384507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"67158701816a8544f484a355ac2a6fb2fff9573b","parents":["69aa191a3c86569c788df5bb23a7b5b6133f0225"],"ref":"refs/changes/34/1834/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493085943,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":15,"deletions":-4},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":25,"sizeDeletions":-5},{"number":"2","revision":"19991f8734f581d305182eac2e0b6865f95c1f9b","parents":["69aa191a3c86569c788df5bb23a7b5b6133f0225"],"ref":"refs/changes/34/1834/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493086125,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/sys/aggr_impl.h","line":196,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Is there still code that reads these within the perimeter without taking the lg_stat_lock mutex? If so, is there some reason not to use the new mutex for everything so that it is easier to reason about this?"},{"file":"usr/src/uts/common/sys/aggr_impl.h","line":196,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"The aggr_grp_{attach,detach}_port() functions read lg_ifspeed, but both functions assert the MAC perim so they can\u0027t run concurrently. Since they are also the only functions that can modify lg_ifspeed a read without the mutex is safe here.\n\nThe aggr_port_notify_link() function also reads lg_ifspeed with the MAC perim asserted.\n\nI can widen the mutex hold in the attach/detach functions and add it to the notify function to be more consistent. I wasn\u0027t sure of the proper convention in cases like this. I doubt the MAC perim will ever be removed from this code; but if it was then the mutex needs to be held -- so I guess it makes sense to add it everywhere even if the MAC perim is already doing its job in some places."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":15,"deletions":-4},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":25,"sizeDeletions":-5},{"number":"3","revision":"97c24a26c0ec46d0c4ffe0ba0f9e7a942e3c2d04","parents":["69aa191a3c86569c788df5bb23a7b5b6133f0225"],"ref":"refs/changes/34/1834/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493329699,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493332704,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-6},{"number":"4","revision":"8df7de1c1889c5605f743bef33c99a698d6a3513","parents":["393f2fb8132972f26b38450fe4dcd806f339c86d"],"ref":"refs/changes/34/1834/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493350406,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493332704,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493379402,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-6},{"number":"5","revision":"a3b9bffc54a1ea9cc106f1f53d1edf789d81bf57","parents":["393f2fb8132972f26b38450fe4dcd806f339c86d"],"ref":"refs/changes/34/1834/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493384439,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493332704,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493379402,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-6},{"number":"6","revision":"881ad294e65e1bdc2db9586d72cbcb9c8d801dc9","parents":["21894f7facc18d35f540a9f52fd1f3db4d0e679f"],"ref":"refs/changes/34/1834/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1493384471,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493332704,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493379402,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1493384507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-6}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}