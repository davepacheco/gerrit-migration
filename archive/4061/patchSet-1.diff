From 7fe2c8bf5b7e304d86587f5bb0e9124160874f61 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Thu, 31 May 2018 19:11:23 +0200
Subject: [PATCH] TRITON-455 sdcadm experimental doesn't load sdcApp when
 needed

---
 lib/cli/do_update.js        | 18 +++++++++++----
 lib/cli/do_update_agents.js | 46 +++++++++++++++++++++++--------------
 2 files changed, 42 insertions(+), 22 deletions(-)

diff --git a/lib/cli/do_update.js b/lib/cli/do_update.js
index 461ec31..9321e98 100644
--- a/lib/cli/do_update.js
+++ b/lib/cli/do_update.js
@@ -52,12 +52,20 @@ Update.prototype.execute = function cExecute(opts, args, cb) {
     var plan;
     var execStart;
 
-    // Set or override the default channel if anything is given:
-    if (opts.channel) {
-        self.sdcadm.updates.channel = opts.channel;
-    }
-
     vasync.pipeline({funcs: [
+        function ensureSdcApp(_, next) {
+            self.sdcadm.ensureSdcApp({}, function (err) {
+                if (err) {
+                    next(err);
+                    return;
+                }
+                // Set or override the default channel if anything is given:
+                if (opts.channel) {
+                    self.sdcadm.updates.channel = opts.channel;
+                }
+                next();
+            });
+        },
         /**
          * Also see 'sdcadm update' section in docs/index.md.
          *
diff --git a/lib/cli/do_update_agents.js b/lib/cli/do_update_agents.js
index aa81dc6..3c2d361 100644
--- a/lib/cli/do_update_agents.js
+++ b/lib/cli/do_update_agents.js
@@ -863,24 +863,36 @@ function do_update_agents(subcmd, opts, args, cb) {
         return;
     }
 
+    vasync.pipeline({funcs: [
+        function ensureSdcApp(_, next) {
+            self.sdcadm.ensureSdcApp({}, function (err) {
+                if (err) {
+                    next(err);
+                    return;
+                }
+                // Set or override the default channel if anything is given:
+                if (opts.channel) {
+                    self.sdcadm.updates.channel = opts.channel;
+                }
+                next();
+            });
+        },
+        function runUpdateAgents(_, next) {
+            updateAgents({
+                sdcadm: self.sdcadm,
+                agentsshar: agentsshar,
+                progress: self.progress,
+                justDownload: opts.just_download,
+                skipLatestSymlink: opts.skip_latest_symlink,
+                justUpdateSymlink: opts.just_update_symlink,
+                yes: opts.yes,
+                servers: servers,
+                all: opts.all,
+                concurrency: Number(opts.concurrency)
+            }, next);
+        }
+    ]}, cb);
 
-    // Set or override the default channel if anything is given:
-    if (opts.channel) {
-        self.sdcadm.updates.channel = opts.channel;
-    }
-
-    updateAgents({
-        sdcadm: self.sdcadm,
-        agentsshar: agentsshar,
-        progress: self.progress,
-        justDownload: opts.just_download,
-        skipLatestSymlink: opts.skip_latest_symlink,
-        justUpdateSymlink: opts.just_update_symlink,
-        yes: opts.yes,
-        servers: servers,
-        all: opts.all,
-        concurrency: Number(opts.concurrency)
-    }, cb);
 }
 do_update_agents.help = (
     /* BEGIN JSSTYLED */
-- 
2.21.0

