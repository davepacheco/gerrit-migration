From 78ebdf959bff76313591c88c603cf4b66ec8de78 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Tue, 1 Aug 2017 01:08:15 +0000
Subject: [PATCH] NET-375 Upgrade Portolan to Moray client v3

---
 lib/moray.js                     | 14 ++++++--------
 package.json                     |  4 ++--
 sapi_manifests/portolan/template |  6 ++++--
 3 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/lib/moray.js b/lib/moray.js
index d931da5..7407171 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -15,6 +15,7 @@
 'use strict';
 
 var assert = require('assert-plus');
+var clone = require('clone');
 var mod_moray = require('moray');
 
 
@@ -29,16 +30,13 @@ function createMorayClient(config, callback) {
     assert.object(config.log, 'config.log');
     assert.func(callback, 'callback');
 
-    var client = mod_moray.createClient({
-        host: config.moray.host,
-        port: config.moray.port,
-        log: config.log.child({
-            component: 'moray',
-            level: config.moray.logLevel || 'info'
-        })
+    var cfg = clone(config.moray);
+    cfg.log = config.log.child({
+        component: 'moray',
+        level: config.moray.logLevel || 'info'
     });
 
-    // XXX: Possible to get an error event here?
+    var client = mod_moray.createClient(cfg);
 
     client.once('connect', function _afterConnect() {
         return callback(null, client);
diff --git a/package.json b/package.json
index 90a7d83..219721f 100644
--- a/package.json
+++ b/package.json
@@ -15,9 +15,9 @@
         "lomstream": "^1.1.0",
         "lru-cache": "2.5.0",
         "mkdirp": "0.5.0",
-        "moray": "git+https://github.com/joyent/node-moray.git#b84ef0e",
+        "moray": "3.4.2",
         "node-uuid": "1.4.2",
-        "portolan-moray": "git+https://github.com/joyent/sdc-portolan-moray.git#72eb031",
+        "portolan-moray": "git+https://github.com/joyent/sdc-portolan-moray.git#7e2c4ca",
         "tape": "3.0.3",
         "vasync": "1.6.2",
         "verror": "1.6.0",
diff --git a/sapi_manifests/portolan/template b/sapi_manifests/portolan/template
index 7b45b67..27402b6 100644
--- a/sapi_manifests/portolan/template
+++ b/sapi_manifests/portolan/template
@@ -2,8 +2,10 @@
     "backend": "moray",
     "logLevel": "debug",
     "moray": {
-        "host": "{{{MORAY_SERVICE}}}",
-        "port": 2020
+        "srvDomain": "{{{MORAY_SERVICE}}}",
+        "cueballOptions": {
+            "resolvers": [ "{{{BINDER_SERVICE}}}" ]
+        }
     },
     "port": 1296
 }
-- 
2.21.0

