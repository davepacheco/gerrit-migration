From 0fbfe403c88700512a1a5055bdddb769c1462025 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 11 Jul 2016 16:30:29 -0700
Subject: [PATCH] backout PUBAPI-1310: needs more work

---
 lib/app.js      |  4 ++--
 lib/machines.js | 26 ++++++++------------------
 package.json    | 34 ++++++++++++++++++----------------
 3 files changed, 28 insertions(+), 36 deletions(-)

diff --git a/lib/app.js b/lib/app.js
index 52bf26d..afc816a 100644
--- a/lib/app.js
+++ b/lib/app.js
@@ -620,10 +620,10 @@ module.exports = {
                 policies.mount(server, userThrottle(config, 'policies'),
                         config);
                 roles.mount(server, userThrottle(config, 'roles'), config);
-                nics.mount(server, userThrottle(config, 'nics'));
-                mod_config.mount(server, userThrottle(config, 'config'));
                 resources.mount(server, userThrottle(config, 'resources'),
                         config);
+                nics.mount(server, userThrottle(config, 'nics'));
+                mod_config.mount(server, userThrottle(config, 'config'));
 
                 server.on('after', auditLogger({
                     log: log.child({component: 'audit'})
diff --git a/lib/machines.js b/lib/machines.js
index 6a81030..2e28682 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -306,13 +306,11 @@ function getListOptions(req) {
     opts.offset = req.params.offset || 0;
 
     // Copy in any and all tags
-    var tags = req.params.tag;
-    if (tags) {
-        Object.keys(tags).forEach(function (tag) {
-            opts['tag.' + tag] = tags[tag];
-        });
-    }
-
+    Object.keys(req.params).forEach(function (k) {
+        if (TAG_RE.test(k)) {
+            opts[k] = req.params[k];
+        }
+    });
     // By default, VMAPI will return everything unless it's told to not
     // retrieve destroyed machines.
     if (!req.params.tombstone && !opts.state) {
@@ -797,25 +795,17 @@ function xorIfPresent(a, b) {
 function loadMachine(req, res, next) {
     var pathname = req.getUrl().pathname;
 
-    if (pathname === '/--ping' || ! /\/machines/.test(pathname)) {
+    if (pathname === '/--ping') {
         return next();
     }
 
     assert.ok(req.sdc);
 
-
     var customer = req.account.uuid;
-    var name = req.params.machine;
-
-    // set by resources.js, if a PUT with role tags is being done
-    if (req.params.resource_name === 'machines' && req.params.resource_id) {
-        name = name || req.params.resource_id;
-    }
-
-    if (!name) {
+    if (!req.params.machine || !(/\/machines/.test(pathname))) {
         return next();
     }
-
+    var name = req.params.machine;
     var machine;
 
     return vasync.pipeline({
diff --git a/package.json b/package.json
index 2071cfb..fb2eee9 100644
--- a/package.json
+++ b/package.json
@@ -13,31 +13,33 @@
         "url": "git+ssh://git@github.com:joyent/sdc-cloudapi.git"
     },
     "dependencies": {
-        "vasync": "1.6.4",
-        "http-signature": "1.1.1",
-        "libuuid": "0.2.1",
+        "vasync": "1.4.3",
+        "filed": "0.0.7",
+        "http-signature": "1.1.0",
+        "mime": "1.2.7",
+        "libuuid": "0.1.2",
         "nopt": "2.0.0",
-        "restify": "4.1.1",
-        "bunyan": "1.8.1",
-        "sdc-clients": "git://github.com/joyent/node-sdc-clients.git#578665",
-        "ufds": "git://github.com/joyent/node-ufds.git#98a563d",
+        "restify": "git+ssh://git@github.com:mcavage/node-restify.git#0d7b4ba",
+        "bunyan": "0.22.1",
+        "sdc-clients": "9.4.0",
+        "ufds": "1.1.3",
         "semver": "2.2.1",
         "nodemailer": "0.3.29",
         "clone": "0.1.5",
         "assert-plus": "1.0.0",
-        "asn1": "0.2.3",
-        "ctype": "0.5.5",
-        "keyapi": "git://github.com/joyent/keyapi.git#f382a4",
-        "aperture": "git://github.com/joyent/node-aperture.git#92a84c9",
-        "mahi": "git://github.com/joyent/node-mahi.git#19e8c75",
-        "aperture-config": "git://github.com/joyent/aperture-config.git#8256060",
-        "joyent-schemas": "git://github.com/joyent/schemas.git#c661af3",
-        "jsprim": "1.3.0",
+        "asn1": "0.1.11",
+        "ctype": "0.5.2",
+        "keyapi": "git+ssh://git@github.com:joyent/keyapi.git#f382a4",
+        "aperture": "git+ssh://git@github.com:joyent/node-aperture.git#016977",
+        "mahi": "git+ssh://git@github.com:joyent/node-mahi.git#7c0499",
+        "aperture-config": "git+ssh://git@github.com:joyent/aperture-config.git#master",
+        "joyent-schemas": "git+ssh://git@github.com:joyent/schemas.git#caf3a226ed0707f5da897e1da151cc6d97fccda2",
+        "jsprim": "0.6.1",
         "verror": "1.6.1"
     },
     "devDependencies": {
         "tape": "3.5.0",
-        "smartdc": "git://github.com/joyent/node-smartdc.git#f7ccf57"
+        "smartdc": "git+ssh://git@github.com:joyent/node-smartdc.git#adea68"
     },
     "sdcDependencies": {
         "imgapi": ">=2.1.0",
-- 
2.21.0

