From ca17565566b44befc431909dca666f8daf0e7a84 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Mon, 1 Oct 2018 14:06:55 +0100
Subject: [PATCH] TRITON-774 imgapi should allow admin-only add-file from URLs

---
 CHANGES.md   |  4 ++++
 lib/cli.js   | 42 ++++++++++++++++++++++++++++++++++++++----
 package.json |  4 ++--
 3 files changed, 44 insertions(+), 6 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 9c340c2..7e1bb36 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -2,6 +2,10 @@
 
 ## not yet released
 
+## 2.4.0
+
+- TRITON-774 imgapi should allow admin-only add-file from URLs
+
 ## 2.3.1
 
 - TRITON-692 updates-imgadm doesn't work with npm v5 de-duped `node_modules`
diff --git a/lib/cli.js b/lib/cli.js
index 2bdda5c..10451b2 100644
--- a/lib/cli.js
+++ b/lib/cli.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -1813,7 +1813,39 @@ CLI.prototype.do_add_file = function do_add_file(subcmd, opts, args, callback) {
     assert.uuid(uuid, 'uuid');
 
     if (!opts.file) {
-        return callback(new errors.UsageError('no image file path given'));
+        return callback(new errors.UsageError(
+            'no image file path or url given'));
+    }
+
+    if (opts.url) {
+        var fopts = {
+            uuid: uuid,
+            file_url: opts.file
+        };
+        if (opts.sha1) {
+            fopts.sha1 = opts.sha1;
+        }
+        if (opts.storage) {
+            fopts.storage = opts.storage;
+        }
+        if (opts.compression) {
+            fopts.compression = opts.compression;
+        } else {
+            opts.compression = 'auto detected';
+        }
+        self.client.addImageFileFromUrl(fopts, function (err, image, res) {
+            self.log.trace({err: err, image: image, client_res: res},
+                'AddImageFileFromUrl');
+            if (err) {
+                return callback(self._errorFromClientError(err));
+            }
+            console.log(
+                'Added file from url "%s" (compression "%s") to image %s',
+                opts.file, opts.compression, uuid);
+            callback();
+
+        });
+        return;
     }
 
     function getFileInfo(next) {
@@ -1921,14 +1953,16 @@ CLI.prototype.do_add_file.description = (
     '                       file. Can be "local" or "manta". Will try to\n' +
     '                       default to "manta" when available, otherwise\n' +
     '                       "local"\n' +
-    '    -q, --quiet        Disable progress bar.\n'
+    '    -q, --quiet        Disable progress bar.\n' +
+    '    --url              Treat the -f argument as a URL to a file.\n'
 );
 CLI.prototype.do_add_file.longOpts = {
     'file': String,
     'compression': String,
     'sha1': String,
     'quiet': Boolean,
-    'storage': String
+    'storage': String,
+    'url': Boolean
 };
 CLI.prototype.do_add_file.shortOpts = {
     'f': ['--file'],
diff --git a/package.json b/package.json
index 7306993..0f140ef 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgapi-cli",
   "description": "a CLI for an Triton's IMGAPI (https://images.joyent.com/docs/)",
-  "version": "2.3.1",
+  "version": "2.4.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -11,7 +11,7 @@
     "mkdirp": "0.5.1",
     "nopt": "2.0.0",
     "progbar": "1.1.1",
-    "sdc-clients": "10.0.4",
+    "sdc-clients": "12.1.0",
     "restify-clients": "1.6.0",
     "strsplit": "1.0.0",
     "tabula": "1.8.0",
-- 
2.21.0

