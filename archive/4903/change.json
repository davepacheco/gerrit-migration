{"project":"joyent/sdc-imgapi-cli","branch":"master","id":"I5dc24e3891fe06a69f62e26d8c2f2d641a12abc4","number":"4903","subject":"TRITON-774 imgapi should allow admin-only add-file from URLs Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/4903","commitMessage":"TRITON-774 imgapi should allow admin-only add-file from URLs\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1538399218,"lastUpdated":1542740698,"open":false,"status":"MERGED","comments":[{"timestamp":1538399218,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1538399223,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit fe7f48171b411fabc1eaab7c936837ed3d17908e\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs"},{"timestamp":1538399243,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1538399971,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1538399975,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit ef5df551b85fc2ec55b0bc666b16e112a249ee56\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs"},{"timestamp":1538399998,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538607603,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1538660985,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1538660990,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit f9a9494930ac51064315a817d6abafafff661085\n    \n    address Trent\u0027s feedback"},{"timestamp":1538661011,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538661056,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(1 comment)\n\nFixed up the --storage STORAGE option, and clarified CHANGES.md because yes, this isn\u0027t admin-only anymore. I\u0027ve addressed these changes in Patch Set 3."},{"timestamp":1540503995,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1541176878,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4."},{"timestamp":1541176882,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 5a5f62e2d3063df1bf0cc36a87cd2e692c621b89\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs"},{"timestamp":1541176901,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541177137,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(1 comment)\n\nThe latest change addresses all of the feedback I think. The CLI is only sniffing for -f options that start with \u0027http\u0027 to make testing easier. Imgapi itself checks for https:// urls specifically."},{"timestamp":1542329348,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(2 comments)\n\nSorry for the continued nits here. Thanks for doing this."},{"timestamp":1542370603,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 5."},{"timestamp":1542370608,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit d395fffa17d090c8dcafb0ef1c14b20fd5ff5ab0\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs"},{"timestamp":1542370629,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542371084,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n(2 comments)\n\nThanks for the review! Here\u0027s the changes from patch-set 5 in action (note that the imgapi0 I was testing with was modified to allow http urls)\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm import -m 079b3201-b0ea-4551-b092-d4c692350d7f.imgmanifest\nImported image 079b3201-b0ea-4551-b092-d4c692350d7f (jenkins-agent-i386-14.2.0, 2.0.0, state\u003dunactivated)\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file -s f69eef62be0a0cf9c92dda6b639ecac72dd0e5b0 -f htztp://10.0.0.21:9000/079b3201-b0ea-4551-b092-d4c692350d7f-file.gz 079b3201-b0ea-4551-b092-d4c692350d7f\nsdc-imgadm: error (ENOENT): ENOENT, stat \u0027htztp://10.0.0.21:9000/079b3201-b0ea-4551-b092-d4c692350d7f-file.gz\u0027\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file -h\nAdd an image file.\n\nTypically this is used to add the image file to a newly created image,\nsdc-imgadm create. Then use `sdc-imgadm activate UUID` to activate the image.\n\nUsage:\n    sdc-imgadm add-file UUID -f FILE-OR-URL [OPTIONS]\n\nOptions:\n    -f FILE-OR-URL     Image file to add, either a path or a HTTPS url\n                       to the file to add\n    -c COMPRESSION     Specify the compression used for the image\n                       file. One of \"gzip\", \"bzip2\" or \"none\". If not\n                       given, it may be inferred from common file\n                       extensions.\n    -s SHA1            SHA-1 hash of the image file. If given, the\n                       server will use it compare it with the uploaded\n                       file SHA-1\n    --storage STORAGE  The type of storage preferred for this image\n                       file. Can be \"local\" or \"manta\". Will try to\n                       default to \"manta\" when available, otherwise\n                       \"local\"\n    -q, --quiet        Disable progress bar.\n[root@headnode (uk-1) /tmp]#  sdc-imgadm add-file -s f69eef62be0a0cf9c92dda6b639ecac72dd0e5b0 -f http://10.0.0.21:9000/079b3201-b0ea-4551-b092-d4c692350d7f-file.gz 079b3201-b0ea-4551-b092-d4c692350d7f\nAdded file from url \"http://10.0.0.21:9000/079b3201-b0ea-4551-b092-d4c692350d7f-file.gz\" (compression \"auto detected\") to image 079b3201-b0ea-4551-b092-d4c692350d7f\n[root@headnode (uk-1) /tmp]# sdc-imgadm activate 079b3201-b0ea-4551-b092-d4c692350d7f\nActivated image 079b3201-b0ea-4551-b092-d4c692350d7f\n[root@headnode (uk-1) /tmp]# sdc-imgadm list.\n.\n.\n.\n079b3201-b0ea-4551-b092-d4c692350d7f  jenkins-agent-i386-14.2.0       2.0.0                                                 -      smartos  2018-11-02T19:02:11Z\n[root@headnode (uk-1) /tmp]#"},{"timestamp":1542396052,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1542740605,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1542740611,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 1b2945008c15370dcaea96f188a2dafac8b9e00f\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n    Approved by: Trent Mick \u003ctrentm@gmail.com\u003e"},{"timestamp":1542740698,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"6","revision":"5dc24e3891fe06a69f62e26d8c2f2d641a12abc4","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/6","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1542740605,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542370629,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542396052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542396052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1542740698,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":41,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":47,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"ca17565566b44befc431909dca666f8daf0e7a84","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1538399218,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1538399243,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli.js","line":1890,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer fopts hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":38,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":44,"sizeDeletions":-6},{"number":"2","revision":"439dde3d0a8ee7e666413a9487267fd0e49826b1","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1538399971,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538399998,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":7,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is it admin-only?\n\n\nLet\u0027s mention the user-perspective difference here. E.g.:\n\n```\n- TRITON-774 Add support for `imgapi-cli add-file --url --file URL ...` for adding an image file from a remote URL. ```"},{"file":"lib/cli.js","line":1952,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Let\u0027s fix this to add \"STORAGE\" as an arg to that option while we are here."},{"file":"lib/cli.js","line":1952,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Fixed here, and elsewhere"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":38,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":44,"sizeDeletions":-6},{"number":"3","revision":"e1832884e9b5a1d0b1e864931a9e71a44393ecf7","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1538660985,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538661011,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli.js","line":1957,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027ve started a survey for what the CLI options should be here: https://chatlogs.joyent.us/logs/triton-dev/2018/10/25#21:41:51.528Z\n\nI\u0027m leaning towards `*-imgadm add-file UUID -f FILE-OR-URL` where we assume a URL if it begins with \u0027https://\u0027.\n\nOne benefit of that is that the `*-imgadm import -f URL ...` command that passes of that `-f` argument to `do_add_file()`, will just work."},{"file":"lib/cli.js","line":1957,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":42,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":48,"sizeDeletions":-10},{"number":"4","revision":"260a28690e75384b036093add7839d6e73c9ecf3","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1541176878,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541176901,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli.js","line":1764,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Could change this to \"FILE-OR-URL\" as well here, but we don\u0027t need to keep nit\u0027ing to death. Go ahead and get this in! :)"},{"file":"lib/cli.js","line":1820,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"That poor rare local file named something like httpie.tar.gz. ;)   Perhaps:\n\n```\nif (/^https?:\\/\\//i.test(opts.file)) {\n    // Looks like a URL.\n```"},{"file":"lib/cli.js","line":1820,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Good idea, fixed."},{"file":"lib/cli.js","line":1941,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Drop the brackets our `FILE|URL`. Don\u0027t want to imply that the arg to `-f` is optional. If a bare `|` is confusing (with a shell pipe operator) then perhaps `-f FILE-OR-URL`."},{"file":"lib/cli.js","line":1941,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Sure. I\u0027ve gone with -f FILE-OR-URL"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":41,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":47,"sizeDeletions":-10},{"number":"5","revision":"f4fddf635bf6159b6ecfba9cf9943880c7c6554f","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1542370603,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542370629,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542396052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542396052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":41,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":47,"sizeDeletions":-10},{"number":"6","revision":"5dc24e3891fe06a69f62e26d8c2f2d641a12abc4","parents":["17f2b7b394a77e7de042baf92c418648aa9a91b8"],"ref":"refs/changes/03/4903/6","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1542740605,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542370629,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542396052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542396052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1542740698,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli.js","type":"MODIFIED","insertions":41,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":47,"sizeDeletions":-10}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}