From 5dc24e3891fe06a69f62e26d8c2f2d641a12abc4 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Tue, 20 Nov 2018 19:03:21 +0000
Subject: [PATCH] TRITON-774 imgapi should allow admin-only add-file from URLs
 Reviewed by: Trent Mick <trentm@gmail.com> Approved by: Trent Mick
 <trentm@gmail.com>

---
 CHANGES.md   |  4 ++++
 lib/cli.js   | 49 +++++++++++++++++++++++++++++++++++++++++--------
 package.json |  4 ++--
 3 files changed, 47 insertions(+), 10 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 9c340c2..715b16e 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -2,6 +2,10 @@
 
 ## not yet released
 
+## 2.4.0
+
+- TRITON-774 imgapi should allow add-file from URLs
+
 ## 2.3.1
 
 - TRITON-692 updates-imgadm doesn't work with npm v5 de-duped `node_modules`
diff --git a/lib/cli.js b/lib/cli.js
index 2bdda5c..bf75624 100644
--- a/lib/cli.js
+++ b/lib/cli.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -1365,7 +1365,7 @@ CLI.prototype.do_create.description = (
     '    -s SHA1            SHA-1 hash of the image file. If given, the\n' +
     '                       server will use it compare it with the uploaded\n' +
     '                       file SHA-1\n' +
-    '    --storage          The type of storage preferred for this image\n' +
+    '    --storage STORAGE  The type of storage preferred for this image\n' +
     '                       file. Can be "local" or "manta". Will try to\n' +
     '                       default to "manta" when available, otherwise\n' +
     '                       "local". This flag will only be relevant if the\n' +
@@ -1771,7 +1771,7 @@ CLI.prototype.do_import.description = (
     '                       server will use it compare it with the uploaded\n' +
     '                       file SHA-1. This option is not allowed for\n' +
     '                       *source* URL imports.\n' +
-    '    --storage          The type of storage preferred for this image\n' +
+    '    --storage STORAGE  The type of storage preferred for this image\n' +
     '                       file. Can be "local" or "manta". Will try to\n' +
     '                       default to "manta" when available, otherwise\n' +
     '                       "local". This flag will only be relevant if the\n' +
@@ -1813,7 +1813,39 @@ CLI.prototype.do_add_file = function do_add_file(subcmd, opts, args, callback) {
     assert.uuid(uuid, 'uuid');
 
     if (!opts.file) {
-        return callback(new errors.UsageError('no image file path given'));
+        return callback(new errors.UsageError(
+            'no image file path or url given'));
+    }
+
+    if (/^https?:\/\//i.test(opts.file)) {
+        var ufopts = {
+            uuid: uuid,
+            file_url: opts.file
+        };
+        if (opts.sha1) {
+            ufopts.sha1 = opts.sha1;
+        }
+        if (opts.storage) {
+            ufopts.storage = opts.storage;
+        }
+        if (opts.compression) {
+            ufopts.compression = opts.compression;
+        } else {
+            opts.compression = 'auto detected';
+        }
+        self.client.addImageFileFromUrl(ufopts, function (err, image, res) {
+            self.log.trace({err: err, image: image, client_res: res},
+                'AddImageFileFromUrl');
+            if (err) {
+                return callback(self._errorFromClientError(err));
+            }
+            console.log(
+                'Added file from url "%s" (compression "%s") to image %s',
+                opts.file, opts.compression, uuid);
+            callback();
+
+        });
+        return;
     }
 
     function getFileInfo(next) {
@@ -1906,10 +1938,11 @@ CLI.prototype.do_add_file.description = (
     '$NAME create. Then use `$NAME activate UUID` to activate the image.\n' +
     '\n' +
     'Usage:\n' +
-    '    $NAME add-file UUID -f FILE [OPTIONS]\n' +
+    '    $NAME add-file UUID -f FILE-OR-URL [OPTIONS]\n' +
     '\n' +
     'Options:\n' +
-    '    -f FILE            Image file to add\n' +
+    '    -f FILE-OR-URL     Image file to add, either a path or a HTTPS url\n' +
+    '                       to the file to add\n' +
     '    -c COMPRESSION     Specify the compression used for the image\n' +
     '                       file. One of "gzip", "bzip2" or "none". If not\n' +
     '                       given, it may be inferred from common file\n' +
@@ -1917,7 +1950,7 @@ CLI.prototype.do_add_file.description = (
     '    -s SHA1            SHA-1 hash of the image file. If given, the\n' +
     '                       server will use it compare it with the uploaded\n' +
     '                       file SHA-1\n' +
-    '    --storage          The type of storage preferred for this image\n' +
+    '    --storage STORAGE  The type of storage preferred for this image\n' +
     '                       file. Can be "local" or "manta". Will try to\n' +
     '                       default to "manta" when available, otherwise\n' +
     '                       "local"\n' +
@@ -2031,7 +2064,7 @@ CLI.prototype.do_add_icon.description = (
     '    -s SHA1            SHA-1 hash of the image icon file. If given,\n' +
     '                       the server will use it compare it with the\n' +
     '                       uploaded file SHA-1\n' +
-    '    --storage          The type of storage preferred for this image\n' +
+    '    --storage STORAGE  The type of storage preferred for this image\n' +
     '                       file. Can be "local" or "manta". Will try to\n' +
     '                       default to "manta" when available, otherwise\n' +
     '                       "local"\n' +
diff --git a/package.json b/package.json
index 7306993..0f140ef 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgapi-cli",
   "description": "a CLI for an Triton's IMGAPI (https://images.joyent.com/docs/)",
-  "version": "2.3.1",
+  "version": "2.4.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -11,7 +11,7 @@
     "mkdirp": "0.5.1",
     "nopt": "2.0.0",
     "progbar": "1.1.1",
-    "sdc-clients": "10.0.4",
+    "sdc-clients": "12.1.0",
     "restify-clients": "1.6.0",
     "strsplit": "1.0.0",
     "tabula": "1.8.0",
-- 
2.21.0

