From 5d05a953f3edb4aecd60492d97ef51abee1e1580 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Fri, 15 Mar 2019 12:54:20 -0700
Subject: [PATCH] TRITON-1311 node 6.17.0 is broken

---
 nodeconfigs.json                              | 13 ++++++++++
 package.json                                  |  2 +-
 ...tp-keepAliveTimeout-default-0-v6.17+.patch | 26 +++++++++++++++++++
 ...http-keepAliveTimeout-default-0-v8.x.patch | 26 +++++++++++++++++++
 4 files changed, 66 insertions(+), 1 deletion(-)
 create mode 100644 patches/http-keepAliveTimeout-default-0-v6.17+.patch
 create mode 100644 patches/http-keepAliveTimeout-default-0-v8.x.patch

diff --git a/nodeconfigs.json b/nodeconfigs.json
index a9bc336..fbd595d 100644
--- a/nodeconfigs.json
+++ b/nodeconfigs.json
@@ -4,6 +4,7 @@
         "image": "1ad363ec-3b83-11e8-8521-2f68a4a34d5d",
         "version": "v8.15.1",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -18,6 +19,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v8.15.1",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -29,6 +31,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v8.15.1",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
@@ -40,6 +43,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v8.15.1",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -54,6 +58,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v8.15.1",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -65,6 +70,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v8.15.1",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
@@ -77,6 +83,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v8.11.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v8.x.patch",
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -88,6 +95,7 @@
         "image": "1ad363ec-3b83-11e8-8521-2f68a4a34d5d",
         "version": "v6.17.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v6.17+.patch",
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -102,6 +110,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v6.17.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v6.17+.patch",
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -113,6 +122,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v6.17.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v6.17+.patch",
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
@@ -158,6 +168,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v6.17.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v6.17+.patch",
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -172,6 +183,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v6.17.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v6.17+.patch",
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
@@ -183,6 +195,7 @@
         "comment": "For use by services running in zones. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v6.17.0",
         "patch_files": [
+            "patches/http-keepAliveTimeout-default-0-v6.17+.patch",
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
diff --git a/package.json b/package.json
index 770269d..c11d34c 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcnode",
   "description": "builds of node for SDC",
-  "version": "1.1.0",
+  "version": "1.1.1",
   "private": true,
   "author": "Joyent",
   "engines": [
diff --git a/patches/http-keepAliveTimeout-default-0-v6.17+.patch b/patches/http-keepAliveTimeout-default-0-v6.17+.patch
new file mode 100644
index 0000000..d444f91
--- /dev/null
+++ b/patches/http-keepAliveTimeout-default-0-v6.17+.patch
@@ -0,0 +1,26 @@
+diff --git a/lib/_http_server.js b/lib/_http_server.js
+index 7775984855..3b3a45f666 100644
+--- a/lib/_http_server.js
++++ b/lib/_http_server.js
+@@ -243,7 +243,7 @@ function Server(requestListener) {
+   this.addListener('connection', connectionListener);
+
+   this.timeout = 2 * 60 * 1000;
+-  this.keepAliveTimeout = 5000;
++  this.keepAliveTimeout = 0;
+
+   this._pendingResponseData = 0;
+   this.headersTimeout = 40 * 1000; // 40 seconds
+diff --git a/lib/https.js b/lib/https.js
+index 21b51cca09..bc313a086f 100644
+--- a/lib/https.js
++++ b/lib/https.js
+@@ -37,7 +37,7 @@ function Server(opts, requestListener) {
+   });
+
+   this.timeout = 2 * 60 * 1000;
+-  this.keepAliveTimeout = 5000;
++  this.keepAliveTimeout = 0;
+   this.headersTimeout = 40 * 1000; // 40 seconds
+ }
+ inherits(Server, tls.Server);
diff --git a/patches/http-keepAliveTimeout-default-0-v8.x.patch b/patches/http-keepAliveTimeout-default-0-v8.x.patch
new file mode 100644
index 0000000..f923ce4
--- /dev/null
+++ b/patches/http-keepAliveTimeout-default-0-v8.x.patch
@@ -0,0 +1,26 @@
+diff --git a/lib/_http_server.js b/lib/_http_server.js
+index a93e423961..c33f2063e8 100644
+--- a/lib/_http_server.js
++++ b/lib/_http_server.js
+@@ -293,7 +293,7 @@ function Server(options, requestListener) {
+   this.on('connection', connectionListener);
+
+   this.timeout = 2 * 60 * 1000;
+-  this.keepAliveTimeout = 5000;
++  this.keepAliveTimeout = 0;
+   this._pendingResponseData = 0;
+   this.maxHeadersCount = null;
+   this.headersTimeout = 40 * 1000; // 40 seconds
+diff --git a/lib/https.js b/lib/https.js
+index 04710a07bd..03ea87e0bc 100644
+--- a/lib/https.js
++++ b/lib/https.js
+@@ -69,7 +69,7 @@ function Server(opts, requestListener) {
+   });
+
+   this.timeout = 2 * 60 * 1000;
+-  this.keepAliveTimeout = 5000;
++  this.keepAliveTimeout = 0;
+
+   this.headersTimeout = 40 * 1000; // 40 seconds
+ }
-- 
2.21.0

