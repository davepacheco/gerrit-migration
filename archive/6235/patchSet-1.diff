From 6aa3c16c9cad0b9f191202f503b0442bf578cb90 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 10 May 2019 16:04:02 -0700
Subject: [PATCH] TRITON-1623 vmapi migration test has intermittent 'bandwidth
 progress event was seen' failure

---
 test/lib/migration.js | 42 ++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 40 insertions(+), 2 deletions(-)

diff --git a/test/lib/migration.js b/test/lib/migration.js
index d19a317..9b766c7 100644
--- a/test/lib/migration.js
+++ b/test/lib/migration.js
@@ -860,7 +860,26 @@ function TestMigrationCfg(test, cfg) {
                         sawBandwidthEvent = true;
                     }
                 });
-                t.ok(sawBandwidthEvent, 'a bandwidth progress event was seen');
+
+                if (sawBandwidthEvent) {
+                    t.ok(sawBandwidthEvent, 'bandwidth progress event seen');
+                } else {
+                    // In the case of a fast sync, it's possible that a
+                    // bandwidth event is not seen. So we let that slide if the
+                    // sync action completed within 10 seconds.
+                    var syncPhases = watcher.events.filter(
+                            function _filterSyncPhases(event) {
+                        return event.phase === 'sync' && event.duration_ms;
+                    });
+                    var lastSyncPhase = syncPhases.slice(-1)[0];
+                    t.ok(lastSyncPhase,
+                        'should have a sync phase with a duration_ms field');
+                    if (lastSyncPhase) {
+                        t.ok(lastSyncPhase.duration_ms < 10000,
+                            'no bandwidth event seen due to fast sync (' +
+                            lastSyncPhase.duration_ms + 'ms)');
+                    }
+                }
             }
 
             var endEvent = watcher.events.filter(function _filtEnd(event) {
@@ -1289,7 +1308,26 @@ function TestMigrationCfg(test, cfg) {
                         sawBandwidthEvent = true;
                     }
                 });
-                t.ok(sawBandwidthEvent, 'a bandwidth progress event was seen');
+
+                if (sawBandwidthEvent) {
+                    t.ok(sawBandwidthEvent, 'bandwidth progress event seen');
+                } else {
+                    // In the case of a fast sync, it's possible that a
+                    // bandwidth event is not seen. So we let that slide if the
+                    // sync action completed within 10 seconds.
+                    var syncPhases = watcher.events.filter(
+                            function _filterSyncPhases(event) {
+                        return event.phase === 'sync' && event.duration_ms;
+                    });
+                    var lastSyncPhase = syncPhases.slice(-1)[0];
+                    t.ok(lastSyncPhase,
+                        'should have a sync phase with a duration_ms field');
+                    if (lastSyncPhase) {
+                        t.ok(lastSyncPhase.duration_ms < 10000,
+                            'no bandwidth event seen due to fast sync (' +
+                            lastSyncPhase.duration_ms + 'ms)');
+                    }
+                }
             }
 
             var endEvent = watcher.events.filter(function _filtEnd(event) {
-- 
2.21.0

