From 6b5ae9baedae28029278d55489eeca4de897a7c5 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Thu, 20 Jul 2017 16:14:33 +0000
Subject: [PATCH] OS-6241 LTP new cve-2017-5669 test fails

---
 usr/src/lib/brand/lx/lx_brand/common/sysv_ipc.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/usr/src/lib/brand/lx/lx_brand/common/sysv_ipc.c b/usr/src/lib/brand/lx/lx_brand/common/sysv_ipc.c
index 99cc12704e..80b7b92be3 100644
--- a/usr/src/lib/brand/lx/lx_brand/common/sysv_ipc.c
+++ b/usr/src/lib/brand/lx/lx_brand/common/sysv_ipc.c
@@ -21,7 +21,7 @@
 /*
  * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2016 Joyent, Inc.  All rights reserved.
+ * Copyright 2017 Joyent, Inc.  All rights reserved.
  */
 
 #include <errno.h>
@@ -694,6 +694,18 @@ lx_shmat(int shmid, void *addr, int flags)
 
 	lx_debug("\tlx_shmat(%d, 0x%p, %d)\n", shmid, addr, flags);
 
+	/*
+	 * Linux has a fix for CVE-2017-5669 which LTP is testing for. The
+	 * kernel will disallow mapping into the first 64k of the address space.
+	 * LTP passes 1 as the address which will then round down to 0.
+	 * In the future, once more work has been done to tighten up the lx
+	 * brand handling for the minimum mappable address (e.g. with secflags),
+	 * then we can remove this check.
+	 */
+	if ((flags & LX_SHM_RND) && addr != NULL && addr < (void *)0x10000) {
+		return (-EINVAL);
+	}
+
 	sol_flags = 0;
 	if (flags & LX_SHM_RDONLY)
 		sol_flags |= SHM_RDONLY;
-- 
2.21.0

