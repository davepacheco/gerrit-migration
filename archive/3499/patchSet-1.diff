From d7623b3e883bece6e5cf8074d9c9b6c5899f8228 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 27 Feb 2018 12:39:38 -0800
Subject: [PATCH] TRITON-143 config-agent should randomize its SAPI GetConfig
 calls

---
 agent.js     | 17 +++++++++++++++--
 bin/agent.sh |  9 +++++++++
 2 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/agent.js b/agent.js
index 98ae5c1..9f94266 100644
--- a/agent.js
+++ b/agent.js
@@ -101,13 +101,26 @@ var autoMetadata = config.autoMetadata = {};
  * for config updates from SAPI and refreshing manifests/config files.
  */
 function startPeriodicRefresh() {
+	var delay;
+
+	// Return a random delay between 0.5*pollInterval and 1.5*pollInterval.
+	function getDelay() {
+		var min = config.pollInterval * 0.5;
+		var max = config.pollInterval * 1.5;
+		return Math.floor(Math.random() * (max - min + 1)) + min;
+	}
+
 	function checkOnce() {
 		agent.checkAndRefresh(function doneCheck(err) {
-			setTimeout(checkOnce, config.pollInterval);
+			delay = getDelay();
+			log.trace({delay: delay}, 'schedule checkAndRefresh');
+			setTimeout(checkOnce, delay);
 		});
 	}
 
-	setTimeout(checkOnce, config.pollInterval);
+	delay = getDelay();
+	log.trace({delay: delay}, 'schedule checkAndRefresh');
+	setTimeout(checkOnce, delay);
 }
 
 async.waterfall([
diff --git a/bin/agent.sh b/bin/agent.sh
index 9ec2ee9..194d8fc 100755
--- a/bin/agent.sh
+++ b/bin/agent.sh
@@ -116,6 +116,15 @@ if [[ -e $FIRST_RUN_FILE ]]; then
 fi
 echo "$0: start sync mode attempts (RAN_ONCE=$RAN_ONCE)"
 
+
+# Note: There is a possible dogpile-on-SAPI scenario for this first sync mode
+# config-agent run, if a large number of config-agents are restarted at the same
+# time -- e.g. all GZ config-agents for a large number of CNs.
+#
+# Adding an initial first-sync-run delay for all config-agents is undesirable
+# however, because it forever means slower Triton instance restarts.
+# Instead the expectation is that SAPI can cope with rate-limiting.
+
 COUNT=0
 SUCCESS=1
 while [[ $SUCCESS != 0 ]]; do
-- 
2.21.0

