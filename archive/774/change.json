{"project":"joyent/sdcadm","branch":"master","id":"I0cd8c1613f232ed5c8ab9124c449deebbeda48d9","number":"774","subject":"TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers Reviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e Approved by: Orlando Vazquez \u003corlando@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/774","commitMessage":"TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\nReviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e\nApproved by: Orlando Vazquez \u003corlando@joyent.com\u003e\n","createdOn":1477390124,"lastUpdated":1521834250,"open":false,"status":"MERGED","comments":[{"timestamp":1477390124,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1477390180,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1477493390,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1477493448,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1478511527,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1478511694,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1480021631,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(6 comments)"},{"timestamp":1483553551,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1483553599,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1483636244,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1483636281,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483636287,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(5 comments)\n\nTrent, all done but for the last one which, obviously, requires more work - and a separated issue?"},{"timestamp":1487779287,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1487779327,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1488221471,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 7."},{"timestamp":1488221502,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489488707,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1489488744,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"},{"timestamp":1502791933,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 9."},{"timestamp":1502791938,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 369872b6c5006836f012e82bbc7cc402dc363df1\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1502791972,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513191885,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 10: Patch Set 9 was rebased."},{"timestamp":1513191891,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit b005d2efdec34135d8160311f505f1157b456c1e\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1513191919,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10:\n\n\"make check\" passed ok"},{"timestamp":1513202085,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1513234949,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10:\n\n(1 comment)\n\nTrent, everything you suggested, but the creation of the command `sdcadm check` has been pushed as part of previous changesets. So, the separate issue would be \"Create sdcadm check command which would look for bogus resolvers, incorrect sapi-url, ... with the option to apply fixes for any issues found\". I think we should be good to go with this one otherwise."},{"timestamp":1516636202,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 11."},{"timestamp":1516636208,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit d5e701eed8f7028497ca4cca229fad9722fa1b4f\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1516636236,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516636372,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11:\n\nAnother tiny review, with some code cleanup, updated dates, including commit date."},{"timestamp":1516640772,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 12."},{"timestamp":1516640778,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 12:\n\nNew commits:\n    \n    commit f2e98918e0e1fd958449586b3db45a3eddbb1cb3\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1516640806,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516640876,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 12:\n\nFinally have been able to reproduce the timeout error we hit the other day in east-3b and fixed the associated error due to expected sprintf argument being an object (error) and we were passing a string instead: \"Uncaught Error: invalid type for %r: \u0027Timeout (5min) waiting for ZK cluster\u0027\""},{"timestamp":1516816376,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 13: Patch Set 12 was rebased."},{"timestamp":1516816380,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13:\n\nNew commits:\n    \n    commit a4037d1c2fd5e7f00851b6060161d662c5057003\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1516816408,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13:\n\n\"make check\" passed ok"},{"timestamp":1517015171,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 13:\n\n(12 comments)\n\nstarter review"},{"timestamp":1517333272,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 14."},{"timestamp":1517333278,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 14:\n\nNew commits:\n    \n    commit 5dc5a316c1fcc248a4c19b06f1f48a79b6ae60af\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n    \n    commit d89e5064e40b94e2041233bb3de9a15ef90d008e\n    \n    RELENG-612 prefer (git+)https urls\n    Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n    Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e"},{"timestamp":1517333309,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517333789,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 15."},{"timestamp":1517333795,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 15:\n\nNew commits:\n    \n    commit c2eefa1ad14ef63605f4b6c83c60f9e29df5d711\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n    \n    commit d89e5064e40b94e2041233bb3de9a15ef90d008e\n    \n    RELENG-612 prefer (git+)https urls\n    Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n    Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e"},{"timestamp":1517333825,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517333919,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13:\n\n(11 comments)\n\nPretty much done with everything you suggested. Should we get rid of the adminOnly option then?"},{"timestamp":1517412416,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 16."},{"timestamp":1517412421,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 16:\n\nNew commits:\n    \n    commit 31d5af54db864e175ff8faa91bc06b0d7266b1a1\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n    \n    commit fb4cadc9cb9813a986650a758657034a10fc4cc1\n    \n    TOOLS-1725 sdcadm up should not bypass Triton stack\n    Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n    Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e"},{"timestamp":1517412452,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517438994,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 16:\n\n(5 comments)\n\nFWIW, a first ha-binder attempt on COAL failed for me:\nhttps://gist.github.com/trentm/580a2b7e366f97315bde7065edaa8e84"},{"timestamp":1517439868,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 16:\n\nMy \u0027post-setup ha-binder\u0027 failure I think was related to my having two SAPIs, and neither of them at the original sapi0 URL. However \u0027sapi-url\u0027 on the new binder zones was setup to the IP of sapi0. So mdata:execute failed in download_metadata:\n\n```\n[2018-01-31T22:57:47Z] /opt/smartdc/boot/lib/util.sh:363: download_metadata(): _sdc_curl -o /var/tmp/metadata.json.raw http://10.99.99.31/configs/d72b289f-c033-4cb6-9426-cff50e77884a\n[2018-01-31T22:57:47Z] /opt/smartdc/boot/lib/util.sh:102: _sdc_curl(): curl -sSf --connect-timeout 45 --max-time 120 -o /var/tmp/metadata.json.raw http://10.99.99.31/configs/d72b289f-c033-4cb6-9426-cff50e77884a\n[ Jan 31 22:58:02 Method or service exit timed out.  Killing contract 3271. ]\n[ Jan 31 22:58:02 Method \"start\" failed due to signal KILL. ]\n```"},{"timestamp":1517506628,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13:\n\nThat\u0027s how binder should work: it needs the sapi admin ip, cannot use the domain name b/c otherwise it\u0027ll introduce a circular dependency with the binder service itself which hasn\u0027t booted yet at the moment we try to get information from SAPI.\n\nNot sure if the right thing to do by ha-binder could be to double check that value, but if so I\u0027d say that should be a different issue? \n\u003e My \u0027post-setup ha-binder\u0027 failure I think was related to my having\n \u003e two SAPIs, and neither of them at the original sapi0 URL. However\n \u003e \u0027sapi-url\u0027 on the new binder zones was setup to the IP of sapi0. So\n \u003e mdata:execute failed in download_metadata:\n \u003e \n \u003e ```\n \u003e [2018-01-31T22:57:47Z] /opt/smartdc/boot/lib/util.sh:363:\n \u003e download_metadata(): _sdc_curl -o /var/tmp/metadata.json.raw\n \u003e http://10.99.99.31/configs/d72b289f-c033-4cb6-9426-cff50e77884a\n \u003e [2018-01-31T22:57:47Z] /opt/smartdc/boot/lib/util.sh:102:\n \u003e _sdc_curl(): curl -sSf --connect-timeout 45 --max-time 120 -o\n \u003e /var/tmp/metadata.json.raw http://10.99.99.31/configs/d72b289f-c033-4cb6-9426-cff50e77884a\n \u003e [ Jan 31 22:58:02 Method or service exit timed out.  Killing\n \u003e contract 3271. ]\n \u003e [ Jan 31 22:58:02 Method \"start\" failed due to signal KILL. ]\n \u003e ```"},{"timestamp":1517585510,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 17."},{"timestamp":1517585515,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 17:\n\nNew commits:\n    \n    commit 9c0d4390bf3f97a450e4efef5c6f5d113cbeb8ed\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1517585568,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517585687,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 17:\n\n(6 comments)\n\nTrent, done with the suggested fixes, filled in the required issues and some extra testing made locally."},{"timestamp":1520615560,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 18: Patch Set 17 was rebased."},{"timestamp":1520615566,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\nNew commits:\n    \n    commit 2639562885fffffe164f20cf0bafa7c6f3e7ec87\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1520615595,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18:\n\n\"make check\" passed ok"},{"timestamp":1521563974,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 19: Patch Set 18 was rebased."},{"timestamp":1521563979,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 19:\n\nNew commits:\n    \n    commit ba83f61dd05800ab1d5d7eda7363c67bf8e9831f\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1521564011,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19:\n\n\"make check\" passed ok"},{"timestamp":1521824668,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 19: Code-Review+1 Integration-Approval+1\n\nDo we need to bump the package.json version?"},{"timestamp":1521833825,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 20."},{"timestamp":1521833830,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 20:\n\nNew commits:\n    \n    commit 0c3bd6cfd8ef6f062323bd33ee90fb7588e7dfb4\n    \n    TOOLS-1579 sdcadm post-setup ha-binder should update core zones resolvers\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1521833862,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1521833944,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 20: Code-Review+1 Integration-Approval+1"},{"timestamp":1521834250,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"20","revision":"0cd8c1613f232ed5c8ab9124c449deebbeda48d9","parents":["8b187755d53036bf05dbedb387cefbccbb109913"],"ref":"refs/changes/74/774/20","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1521833825,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521833862,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521833944,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521833944,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1521834250,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":329,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":96,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":349,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":891,"sizeDeletions":-109},"patchSets":[{"number":"1","revision":"a9f6fcb8c2307c3fef2356a4e4c145688ca01b98","parents":["27385a38a4578ad0b0247a76fc72a075c86b88cb"],"ref":"refs/changes/74/774/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1477390124,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477390180,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":181,"deletions":-13},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1}],"sizeInsertions":256,"sizeDeletions":-14},{"number":"2","revision":"ad394e668823ee5324a7528e6a92494717047b43","parents":["b4c58fedcd3771521f6fdab31c448ffea9419d5b"],"ref":"refs/changes/74/774/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1477493390,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477390180,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":181,"deletions":-13},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1}],"sizeInsertions":256,"sizeDeletions":-14},{"number":"3","revision":"d3c3614b3b107487ddd9f0b15d85dfad353b7cdc","parents":["5d14e20e4538153be5c88e83cea7b94e61e0e34d"],"ref":"refs/changes/74/774/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478511527,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477390180,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/post-setup/ha-binder.js","line":1064,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Any reason to not pull the functions in this \"vasync.pipeline\" up to the same level as \u0027updateCoreVmsResolvers\u0027 (i.e. up one level)?  Then we could avoid nesting one level deeper."},{"file":"lib/post-setup/ha-binder.js","line":1064,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not really. Actually, it\u0027s two levels of deep if I move them at the beginning of \u0027updateCoreVmsResolvers\u0027 so, moved"},{"file":"lib/post-setup/ha-binder.js","line":1096,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This really happens (SAPI \u0027type\u003dvm\u0027 services with no \u0027uuid\u0027)?"},{"file":"lib/post-setup/ha-binder.js","line":1096,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yes, probably due to bogus setups or manual breakage of SAPI but, given we hit that in the past, I rather add the line to prevent we hitting the issue again"},{"file":"lib/post-setup/ha-binder.js","line":1164,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think there is a subtle problem, e.g., for a \u0027nat\u0027 zone where this code is getting lucky.  Here are the \u0027nics\u0027 for a nat zone in my COAL:\n\n  \"nics\": [\n    {\n      \"interface\": \"net0\",\n      \"mac\": \"90:b8:d0:f6:d8:bd\",\n      \"vlan_id\": 0,\n      \"nic_tag\": \"external\",\n      \"gateway\": \"10.88.88.2\",\n      \"gateways\": [\n        \"10.88.88.2\"\n      ],\n      \"netmask\": \"255.255.255.0\",\n      \"ip\": \"10.88.88.8\",\n      \"ips\": [\n        \"10.88.88.8/24\"\n      ],\n      \"network_uuid\": \"288f2c29-9b5a-419f-9c86-8237c7960d6e\",\n      \"allow_ip_spoofing\": true,\n      \"mtu\": 1500,\n      \"primary\": true\n    },\n    {\n      \"interface\": \"net1\",\n      \"mac\": \"90:b8:d0:20:b5:fd\",\n      \"vlan_id\": 2,\n      \"nic_tag\": \"sdc_overlay/9689857\",\n      \"gateway\": \"192.168.128.1\",\n      \"gateways\": [\n        \"192.168.128.1\"\n      ],\n      \"netmask\": \"255.255.252.0\",\n      \"ip\": \"192.168.128.1\",\n      \"ips\": [\n        \"192.168.128.1/22\"\n      ],\n      \"network_uuid\": \"98649ee3-f310-4410-bd8f-69a403a759fe\",\n      \"allow_ip_spoofing\": true,\n      \"mtu\": 1400\n    }\n  ],\n\nThe code here is missing the resolvers from \u0027net1\u0027.\nIn general this code would need to hit NAPI again to get the resolvers for that network uuid. That could be a pain for a DC that could have 100s of nat zones.\n\nHowever, we can improve on that: Change the code to skip a VM that doesn\u0027t have any nics with \u0027nic_tag\u003d\u003d\u003dadmin\u0027, because we know we are only updating for VMs on the admin network."},{"file":"lib/post-setup/ha-binder.js","line":1164,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/ha-binder.js","line":1166,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This code should remove duplicates from \u0027resolvers\u0027. E.g. if it is only two networks that both have a particular resolver IP."},{"file":"lib/post-setup/ha-binder.js","line":1166,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/ha-binder.js","line":1167,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps avoid the \u0027updateVm\u0027 if resolvers array is unchanged?"},{"file":"lib/post-setup/ha-binder.js","line":1167,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/ha-binder.js","line":1180,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"One issue is that all this work can easily fail part way through and \u0027sdcadm post-setup ha-binder\u0027 won\u0027t know how to pick up where it left off.\n\nThe \"right\" answer might be a lot of work. Here is one idea:\n- Factor out a separate function (I\u0027d suggest putting it in something like lib/steps/binder.js to start creating re-usable async steps about binder updates) that knows how to check all core VM instances for the correct \u0027resolvers\u0027. It returns a set of VMs that don\u0027t have the correct resolvers (and the resolvers that it thinks they should have). It should probably take an option to only deal with core VMs on the \u0027admin\u0027 network (as a way to not have to deal with all \u0027nat\u0027 instances, for example).\n- Factor out a separate function that knows how to update all the core VMs with the resolvers using the output of the above function.\n- Update \u0027sdcadm post-setup ha-binder\u0027 to use those two functions for its handling.\n- Ideally update \u0027sdcadm post-setup ha-binder\u0027 to be re-runnable so that it can pick up where it left off. This might be a pain because IIUC it doesn\u0027t currently handle being re-run if binder is *already HA*.\n- Let\u0027s add a temporary hack \u0027sdcadm experimental fix-core-vm-resolvers\u0027 that calls these two. Give it a \u0027--dry-run\u0027 to just run a check and not actually update.\n- Let\u0027s finally start designing \u0027sdcadm check\u0027, which is a command with sub-commands for running integrity checks like this one on the core Triton setup. Time for an RFD on it. Perhaps it is called \u0027sdcadm integrity\u0027 or perhaps there are \u0027sdcadm check ...\u0027 and \u0027sdcadm fix ...\u0027."},{"file":"lib/post-setup/ha-binder.js","line":1180,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"@pedro: Any comment on this? Want to move this out to a separate ticket? or...?"},{"file":"lib/post-setup/ha-binder.js","line":1180,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I think this is already pushed for the latest commits and this comment is no longer valid but for the `sdcadm check` part which should, of course, be a different issue?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":181,"deletions":-13},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1}],"sizeInsertions":256,"sizeDeletions":-14},{"number":"4","revision":"d29c5860eebf8dd5eab04362d4e398d0ff567385","parents":["5334e7bc0b626cbbbd155e559d931cd6b2e49630"],"ref":"refs/changes/74/774/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1483553551,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477390180,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":181,"deletions":-13},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1}],"sizeInsertions":256,"sizeDeletions":-14},{"number":"5","revision":"1f9a5a2b885f75e4231ba5c8a44b3fe6dec39e1f","parents":["5334e7bc0b626cbbbd155e559d931cd6b2e49630"],"ref":"refs/changes/74/774/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1483636244,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483636281,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":209,"deletions":-14},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1}],"sizeInsertions":284,"sizeDeletions":-15},{"number":"6","revision":"bf5635dd10deef74f6e63863a234803c21af2b81","parents":["9453ff15bc397ed97ce5af4d067680446e46c894"],"ref":"refs/changes/74/774/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1487779287,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477390180,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":181,"deletions":-13},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1}],"sizeInsertions":256,"sizeDeletions":-14},{"number":"7","revision":"9d3735de6d00ecaddf884af0e3b9e2c030ba78ee","parents":["93905dca4f4fe846e8098e24b3cb057e2b337128"],"ref":"refs/changes/74/774/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1488221471,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488221502,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":243,"deletions":-33},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1},{"file":"lib/steps/binder.js","type":"ADDED","insertions":341,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":765,"sizeDeletions":-35},{"number":"8","revision":"e2b874405b35e2461dd0b569f2c831086f2043d1","parents":["58d4acb4ed7381b220f11836e13ac5e883f41196"],"ref":"refs/changes/74/774/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1489488707,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488221502,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":243,"deletions":-33},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1},{"file":"lib/steps/binder.js","type":"ADDED","insertions":341,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":765,"sizeDeletions":-35},{"number":"9","revision":"b6492d293940bc0ec23613e04b20c319c8797881","parents":["003277077f0006fa698189f39c7f7d48ce4ea049"],"ref":"refs/changes/74/774/9","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1502791933,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502791972,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":243,"deletions":-33},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1},{"file":"lib/steps/binder.js","type":"ADDED","insertions":341,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":766,"sizeDeletions":-35},{"number":"10","revision":"1655fcb566862484c0a5daba490323f04adf0c27","parents":["c3b20dc42de36fc7b5b1a3a572e76b034d4d2932"],"ref":"refs/changes/74/774/10","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1513191885,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502791972,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":243,"deletions":-33},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1},{"file":"lib/steps/binder.js","type":"ADDED","insertions":341,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":766,"sizeDeletions":-35},{"number":"11","revision":"674ea63601311b58e2f817e726716671fae4753a","parents":["bbde4fd33163212e524744b66f8831670198c947"],"ref":"refs/changes/74/774/11","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516636202,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516636236,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":310,"deletions":-78},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":75,"deletions":-1},{"file":"lib/steps/binder.js","type":"ADDED","insertions":339,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":835,"sizeDeletions":-85},{"number":"12","revision":"1157f62a795c3ab9dc8b11f689dedd0d1473a4d0","parents":["bbde4fd33163212e524744b66f8831670198c947"],"ref":"refs/changes/74/774/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516640772,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516640806,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":310,"deletions":-78},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":92,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":339,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":852,"sizeDeletions":-97},{"number":"13","revision":"a8fa55f4daf729b2c8e5bbbbb945fb3c58d73176","parents":["9be5e6870224b7e3214716e51381568ed5eecda8"],"ref":"refs/changes/74/774/13","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516816376,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516640806,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":44,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be nice to have the VM alias here, if available. If it isn\u0027t available, then certainly don\u0027t want to go looking up VM objects in VMAPI."},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":44,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Pretty simple, done"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":82,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Now I don\u0027t know why I\u0027d suggested in the ticket that this be an option. Why not always only consider those with NICs on the admin network?"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":82,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"B/C you wanted this tool to also be able to fix resolvers into the NAT zones networks, but we want to be able to don\u0027t do it by default in setups with a zillion of such instances. Anyway, I\u0027d pretty much remove it and would keep only those with admin networks. Thoughts?"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":82,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yes, let\u0027s:\n- drop this option\n- change the help output to state that it only operates on core VMs on the admin network. Include a \"Note: ...\" in the help output that mentions that this means skipping nat zones.\n- open a ticket to see if we need to have this command optionally update NAT zones"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":82,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. Issue is TRITON-101"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":85,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"XXX language"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":85,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Which we\u0027re also using for `sdcadm experimental update-other` or `sdcadm experimental update-gz-tools` ... and I\u0027m pretty sure I\u0027ve learnt it from sdcadm code base :-). I\u0027ll change it here."},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":89,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"fix-core-"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":89,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/cli/experimental.js","line":39,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Might want to update this to 27 to line up now that we have the long \"fix-core-vm-resolvers\". Do `sdcadm experimental` to see what I mean."},{"file":"lib/cli/experimental.js","line":39,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/ha-binder.js","line":123,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why add ctx.binderSvc if not using it later?\nIt would be nice to switch away from `svc` and use the `ctx.binderSvc` (better name) instead."},{"file":"lib/post-setup/ha-binder.js","line":123,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Agree. Done"},{"file":"lib/post-setup/ha-binder.js","line":1199,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This then won\u0027t fix an existing DC that has 3 binders already, but for which the admin network doesn\u0027t ahve the correct resolvers.\n\nPerhaps this should be called \"ensureAdminNetworkHasCorectResolvers\". It should always run. It should check the values and then only print status if it finds it needs to be updated."},{"file":"lib/post-setup/ha-binder.js","line":1199,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1945,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This should be called \"interval\"."},{"file":"lib/procedures/shared.js","line":1945,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1946,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"XXX expose this limit as an options.timeout? Perhaps all callers should be required to pass in a limit, and the default shoul be to not timeout. E.g. https://github.com/joyent/node-triton/blob/master/lib/cloudapi2.js#L2465-L2478"},{"file":"lib/procedures/shared.js","line":1946,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027m Ok with exposing it, but don\u0027t think we should default to none. This is sdcadm, I\u0027d say a default of 2 hours is reasonable for every job performed, specially the long ones. Specially, I don\u0027t want to allow \"infinite\" polling here."},{"file":"lib/procedures/shared.js","line":1956,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Allowing some failed GetJob calls is nice."},{"file":"lib/steps/binder.js","line":121,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Even if adminOnly we still may need to gather external network resolvers."},{"file":"lib/steps/binder.js","line":121,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/steps/binder.js","line":247,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is assuming that core zones only have NICs on the admin and/or external. Is that true? We should:\n\n- ask around for others that have setup and run TritonDCs if that\u0027s a rule; and\n- check JPC/SPC to see if this is true\n- have an \"else\" block here that errors out (or at least warns and skips a VM if it has a network we don\u0027t know)\n- consider handling other networks: ask NAPI for their resolvers (could do this later if we find we need to)."},{"file":"lib/steps/binder.js","line":247,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Agree on everything. For now I\u0027d just go with admin/external for core VMs and adding the else block skipping the VMs \"affected\" by networks with unknown Nic tags."},{"file":"lib/steps/binder.js","line":247,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Okay. Let\u0027s get a separate TRITON ticket for the followup on whether this needs to support arbitrary NICs on core Triton zones."},{"file":"lib/steps/binder.js","line":247,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Issue is TRITON-102"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":100,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":310,"deletions":-78},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":92,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":339,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":852,"sizeDeletions":-97},{"number":"14","revision":"d8de0f1397c908e37662f64db7e5deee814319ae","parents":["9be5e6870224b7e3214716e51381568ed5eecda8"],"ref":"refs/changes/74/774/14","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517333272,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517333309,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":326,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":95,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":340,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":878,"sizeDeletions":-112},{"number":"15","revision":"05f00b97a613e26dc065b9a6efb3c1d760f4cb68","parents":["9be5e6870224b7e3214716e51381568ed5eecda8"],"ref":"refs/changes/74/774/15","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517333789,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517333825,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":326,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":95,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":350,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":888,"sizeDeletions":-112},{"number":"16","revision":"78398ebece82c8790a456d30255dac5824c3251d","parents":["d89e5064e40b94e2041233bb3de9a15ef90d008e"],"ref":"refs/changes/74/774/16","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517412416,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517412452,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":87,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The \"XXX\" was more a note to myself to come back and give better feedback in the review. But then I submitted to get the other feedback in.\n\nPerhaps something like:\n\n```\n\u0027Update resolvers for core VMs on the admin network.\\n\u0027 +\n\u0027This is automatically done as part of \"sdcadm post-setup ha-binder\".\\n\u0027\n... usage and options\n\u0027Note: Currently this skips core VMs such as \"nat\" zones that are not on the admin network.\\n\u0027\n```"},{"file":"lib/cli/do_fix_core_vm_resolvers.js","line":87,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/ha-binder.js","line":1221,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be *very* useful to show the old and new values here. We don\u0027t have an \"undo\" for this."},{"file":"lib/post-setup/ha-binder.js","line":1221,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1954,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Timeout \"in seconds\" is not a limit against which you check number of attempts."},{"file":"lib/procedures/shared.js","line":1954,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call. Fixed"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":326,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":101,"deletions":-14},{"file":"lib/steps/binder.js","type":"ADDED","insertions":350,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":890,"sizeDeletions":-109},{"number":"17","revision":"c0c40f111cc247ec6af62160e072f8a8ef2e0c9e","parents":["fb4cadc9cb9813a986650a758657034a10fc4cc1"],"ref":"refs/changes/74/774/17","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517585510,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517585568,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/steps/binder.js","line":335,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Added b/c update of every required VM takes a lot of time, and this way user will see that we\u0027re doing some progress when each machine is updated."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":329,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":96,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":349,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":885,"sizeDeletions":-108},{"number":"18","revision":"68fe26c87dcc51044cc298cd1fc4ea03f2aa409f","parents":["0587a0a0575c2c1e26db8fd60da9c3d26952790d"],"ref":"refs/changes/74/774/18","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1520615560,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517585568,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":329,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":96,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":349,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":885,"sizeDeletions":-108},{"number":"19","revision":"baa78666562d43ccd41ddd71a6d35859f4f92f10","parents":["8b187755d53036bf05dbedb387cefbccbb109913"],"ref":"refs/changes/74/774/19","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1521563974,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517585568,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521824668,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521824668,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":329,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":96,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":349,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":885,"sizeDeletions":-108},{"number":"20","revision":"0cd8c1613f232ed5c8ab9124c449deebbeda48d9","parents":["8b187755d53036bf05dbedb387cefbccbb109913"],"ref":"refs/changes/74/774/20","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1521833825,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521833862,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1521834250,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521833944,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521833944,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_fix_core_vm_resolvers.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/cli/experimental.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/post-setup/ha-binder.js","type":"MODIFIED","insertions":329,"deletions":-88},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":96,"deletions":-13},{"file":"lib/steps/binder.js","type":"ADDED","insertions":349,"deletions":0},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":891,"sizeDeletions":-109}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}