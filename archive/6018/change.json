{"project":"joyent/sdcadm","branch":"master","id":"I290aca37790f73b771d24f38dde144fee1b070bb","number":"6018","subject":"TRITON-1349 Subcommand `sdcadm post-setup kbmapi` using AddServiceProcedure Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Approved by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/6018","commitMessage":"TRITON-1349 Subcommand `sdcadm post-setup kbmapi` using AddServiceProcedure\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nApproved by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e\n","createdOn":1553627455,"lastUpdated":1553789632,"open":false,"status":"MERGED","comments":[{"timestamp":1553627455,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1553627459,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 0c23f25873c8fa481adaf6e8a805d699196b3be2\n    \n    TRITON-1349 Subcommand `sdcadm post-setup kbmapi` using AddServiceProcedure"},{"timestamp":1553628671,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1553628676,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 1857a0e82df902c048a6cf318ce1c3d0b79d07a1\n    \n    TRITON-1349 Subcommand `sdcadm post-setup kbmapi` using AddServiceProcedure"},{"timestamp":1553706010,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1553706014,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit f886f5b467049eeb3afb7b6971ffd2b73f435e5d\n    \n    TRITON-1349 Subcommand `sdcadm post-setup kbmapi` using AddServiceProcedure"},{"timestamp":1553706168,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nJason, testing is good so far, mind to take a look at this?\n\n    [root@headnode (coal) /opt/smartdc/sdcadm]# sdcadm post-setup kbmapi -C experimental -i d979c051-42ed-40d1-81f5-042ee0e5e5a5 -y\n\n    This will make the following changes:\n        create \"kbmapi\" service in SAPI\n        download image d979c051-42ed-40d1-81f5-042ee0e5e5a5 (kbmapi@zfs-crypto-demo-20190320T212949Z-gac70c39)\n            from updates server using channel \"experimental\"\n        create \"kbmapi\" service instance on server \"564d8f75-23af-6bc6-631a-e05bbdeed441\"\n\n    Importing image d979c051-42ed-40d1-81f5-042ee0e5e5a5 (kbmapi@zfs-crypto-demo-20190320T212949Z-gac70c39)\n    Downloading image d979c051-42ed-40d1-81f5-042ee0e5e5a5\n        (kbmapi@zfs-crypto-demo-20190320T212949Z-gac70c39)\n    Imported image d979c051-42ed-40d1-81f5-042ee0e5e5a5\n        (kbmapi@zfs-crypto-demo-20190320T212949Z-gac70c39)\n    Creating \"kbmapi\" service\n    Creating \"kbmapi\" instance on server 564d8f75-23af-6bc6-631a-e05bbdeed441\n    Created VM 7f69f1c3-f1f0-4653-8381-e98957cd756d (kbmapi0)\n    Completed successfully (elapsed 209s)."},{"timestamp":1553706491,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1553706538,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nIn order to be able test the command above:\n\n    sdcadm self-update be14432e-50b2-11e9-96e0-eb346ec70a57 -C experimental"},{"timestamp":1553706648,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n\u003e (1 comment)\n\nThe CNS service is used to register DNS names x-datacenter. If kbmapi is gonna be used just by the local datacenter population, we could perfectly remove it.\n\nAnyway, the modification added to AddServiceProcedure remains handy for other services which have different dependencies so, not a bad idea to implement it in order to be able to remove a lot of duplicated code from other `sdcadm post-setup` commands."},{"timestamp":1553708396,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\nSeems reasonable to keep the generic pieces for dependencies -- we can just remove the one line in lib/post-setup/kbmapi.js since we don\u0027t need that."},{"timestamp":1553712071,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1553715508,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1553715513,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit ad678032a0f0ef109bcef310fa299d3068ef00cc\n    \n    TRITON-1349 Subcommand `sdcadm post-setup kbmapi` using AddServiceProcedure"},{"timestamp":1553715528,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n\u003e Seems reasonable to keep the generic pieces for dependencies -- we\n \u003e can just remove the one line in lib/post-setup/kbmapi.js since we\n \u003e don\u0027t need that.\n\nDone Jason!"},{"timestamp":1553715810,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1553776586,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nTodd, mind to IA+1?"},{"timestamp":1553789568,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1553789615,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1553789632,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"5","revision":"290aca37790f73b771d24f38dde144fee1b070bb","parents":["b2edb6bc6579c480d49f45ba6071fdcd750a7e07"],"ref":"refs/changes/18/6018/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553789615,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553715810,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553789568,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"SUBM","value":"1","grantedOn":1553789632,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/kbmapi.js","type":"ADDED","insertions":118,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":58,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":192,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"b426ba81eac8f050a5bd0510dd9f5e17d53dbd10","parents":["b2edb6bc6579c480d49f45ba6071fdcd750a7e07"],"ref":"refs/changes/18/6018/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553627455,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/post-setup/kbmapi.js","type":"ADDED","insertions":119,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":58,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":182,"sizeDeletions":-1},{"number":"2","revision":"7f876f0c7c658cb7eb8d124391bac29970ffe891","parents":["b2edb6bc6579c480d49f45ba6071fdcd750a7e07"],"ref":"refs/changes/18/6018/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553628671,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/kbmapi.js","type":"ADDED","insertions":119,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":58,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":187,"sizeDeletions":-4},{"number":"3","revision":"b8b3e8212f97790bfe4b369fcf48d73f85b5ee9a","parents":["b2edb6bc6579c480d49f45ba6071fdcd750a7e07"],"ref":"refs/changes/18/6018/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553706010,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553712071,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"comments":[{"file":"lib/post-setup/kbmapi.js","line":40,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"We might be able to remove the cns dependency -- I wasn\u0027t 100% sure doing the prototype so just threw it in -- basically we just need to be able to make sure the service name is registered in dns.  I couldn\u0027t remember if cns was needed for that for Triton services or not.  If not, we can drop it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/kbmapi.js","type":"ADDED","insertions":119,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":58,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":193,"sizeDeletions":-6},{"number":"4","revision":"b55462f47e3a4f685ada9bf0d36f4b7bc21b5659","parents":["b2edb6bc6579c480d49f45ba6071fdcd750a7e07"],"ref":"refs/changes/18/6018/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553715508,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553789568,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553715810,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/kbmapi.js","type":"ADDED","insertions":118,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":58,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":192,"sizeDeletions":-6},{"number":"5","revision":"290aca37790f73b771d24f38dde144fee1b070bb","parents":["b2edb6bc6579c480d49f45ba6071fdcd750a7e07"],"ref":"refs/changes/18/6018/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553789615,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1553789632,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553789568,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553715810,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/kbmapi.js","type":"ADDED","insertions":118,"deletions":0},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":58,"deletions":-1},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":192,"sizeDeletions":-6}],"allReviewers":[{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}