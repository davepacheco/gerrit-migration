From 7fd319762657e767b1d6ea3ab2bbad7bb7ddbbae Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Fri, 10 May 2019 11:40:10 -0600
Subject: [PATCH] MANTA-4259 Update electric-boray to use node-fast 2.7.0

---
 lib/boray_client.js |  1 +
 lib/server.js       | 26 ++++++++++++++++++++++++--
 package.json        |  2 +-
 3 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/lib/boray_client.js b/lib/boray_client.js
index 95f1b4a..bad0a3a 100644
--- a/lib/boray_client.js
+++ b/lib/boray_client.js
@@ -59,6 +59,7 @@ function createClient(options, callback) {
             borayargs.log = options.log.child({
                 component: 'boray-client-' + pnodeUrl.hostname
             });
+            borayargs.crc_mode = options.crc_mode;
 
             var client = boray.createClient(borayargs);
             clientMap[pnode] = client;
diff --git a/lib/server.js b/lib/server.js
index 4a80b68..35c91a9 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -218,6 +218,11 @@ LimitOffsetStream.prototype.getNextRecord =
 
 function createServer(options, callback) {
     assert.object(options, 'options');
+    assert.optionalObject(options.fast, 'options.fast');
+    assert.optionalNumber(options.fast.client_crc_mode,
+        'options.fast.client_crc_mode');
+    assert.optionalNumber(options.fast.server_crc_mode,
+        'options.fast.server_crc_mode');
     assert.func(callback, 'callback');
 
     var log = options.log;
@@ -242,11 +247,17 @@ function createServer(options, callback) {
 
         opts.dataDirector = dataDirector;
 
+        var client_crc_mode = options.fast.client_crc_mode ||
+            fast.FAST_CHECKSUM_V1;
+        var server_crc_mode = options.fast.server_crc_mode ||
+            fast.FAST_CHECKSUM_V1;
+
         log.info('creating moray clients');
         boray_client.createBucketClient({
             pnodes: opts.dataDirector.getPnodes(),
             morayOptions: options.morayOptions,
-            log: options.log
+            log: options.log,
+            crc_mode: client_crc_mode
         }, function (cErr, clients) {
             if (cErr) {
                 throw new verror.VError(cErr, 'unable to create moray clients');
@@ -266,11 +277,22 @@ function createServer(options, callback) {
                 labels: labels
             });
 
+            collector.gauge({
+                name: 'client_crc_mode',
+                help: 'The node-fast CRC compatibilty mode of the Fast client'
+            }).set(client_crc_mode);
+
+            collector.gauge({
+                name: 'server_crc_mode',
+                help: 'The node-fast CRC compatibilty mode of the Fast server'
+            }).set(server_crc_mode);
+
             var socket = net.createServer({ 'allowHalfOpen': true });
             var server = new fast.FastServer({
                 collector: collector,
                 log: log.child({ component: 'fast' }),
-                server: socket
+                server: socket,
+                crc_mode: server_crc_mode
             });
 
             var methods = [
diff --git a/package.json b/package.json
index b378284..eaa1ea5 100644
--- a/package.json
+++ b/package.json
@@ -17,7 +17,7 @@
         "clone": "0.1.9",
         "dtrace-provider": "0.2.8",
         "fash": "2.5.0",
-        "fast": "2.3.2",
+        "fast": "2.7.0",
         "jsprim": "2.0.0",
         "kang": "1.2.0",
         "ldapjs": "0.6.3",
-- 
2.21.0

