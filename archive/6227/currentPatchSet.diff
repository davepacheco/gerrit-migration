From 4585bd7c60b91aed8021d3a87c1659186470bdd4 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Fri, 10 May 2019 15:29:17 -0600
Subject: [PATCH] MANTA-4259 Update electric-boray to use node-fast 2.7.0

---
 lib/boray_client.js |  1 +
 lib/server.js       | 28 +++++++++++++++++++++++++---
 package.json        |  2 +-
 3 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/lib/boray_client.js b/lib/boray_client.js
index 6afce65..12afbf9 100644
--- a/lib/boray_client.js
+++ b/lib/boray_client.js
@@ -53,6 +53,7 @@ function createClient(options, callback) {
         borayargs.log = options.log.child({
             component: 'boray-client-' + pnodeUrl.hostname
         });
+        borayargs.crc_mode = options.crc_mode;
 
         var client = boray.createClient(borayargs);
         clientMap[pnode] = client;
diff --git a/lib/server.js b/lib/server.js
index 9e63438..678b11d 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -219,6 +219,11 @@ LimitOffsetStream.prototype.getNextRecord =
 
 function createServer(options, callback) {
     assert.object(options, 'options');
+    assert.optionalObject(options.fast, 'options.fast');
+    assert.optionalNumber(options.fast.client_crc_mode,
+        'options.fast.client_crc_mode');
+    assert.optionalNumber(options.fast.server_crc_mode,
+        'options.fast.server_crc_mode');
     assert.func(callback, 'callback');
 
     var log = options.log;
@@ -243,11 +248,17 @@ function createServer(options, callback) {
 
         opts.dataDirector = dataDirector;
 
+        var client_crc_mode = options.fast.client_crc_mode ||
+            fast.FAST_CHECKSUM_V1;
+        var server_crc_mode = options.fast.server_crc_mode ||
+            fast.FAST_CHECKSUM_V1;
+
         log.info('creating boray clients');
-        boray_client.createClient({
+        boray_client.createBucketClient({
             pnodes: opts.dataDirector.getPnodes(),
             borayOptions: options.borayOptions,
-            log: options.log
+            log: options.log,
+            crc_mode: client_crc_mode
         }, function (cErr, clients) {
             if (cErr) {
                 throw new verror.VError(cErr, 'unable to create boray clients');
@@ -267,11 +278,22 @@ function createServer(options, callback) {
                 labels: labels
             });
 
+            collector.gauge({
+                name: 'client_crc_mode',
+                help: 'The node-fast CRC compatibilty mode of the Fast client'
+            }).set(client_crc_mode);
+
+            collector.gauge({
+                name: 'server_crc_mode',
+                help: 'The node-fast CRC compatibilty mode of the Fast server'
+            }).set(server_crc_mode);
+
             var socket = net.createServer({ 'allowHalfOpen': true });
             var server = new fast.FastServer({
                 collector: collector,
                 log: log.child({ component: 'fast' }),
-                server: socket
+                server: socket,
+                crc_mode: server_crc_mode
             });
 
             var methods = [
diff --git a/package.json b/package.json
index 6097b7b..9b3a5c0 100644
--- a/package.json
+++ b/package.json
@@ -17,7 +17,7 @@
         "clone": "0.1.9",
         "dtrace-provider": "0.2.8",
         "fash": "2.5.0",
-        "fast": "2.3.2",
+        "fast": "2.7.0",
         "jsprim": "2.0.0",
         "kang": "1.2.0",
         "ldapjs": "0.6.3",
-- 
2.21.0

