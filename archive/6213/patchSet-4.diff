From 7b8b059f248243155a31b16ec625365db81b729d Mon Sep 17 00:00:00 2001
From: bowrocker <jon.anderson@joyent.com>
Date: Wed, 12 Jun 2019 15:04:27 +0000
Subject: [PATCH] MANATEE-415 manatee-sitter spawns excessive zfs recv
 processes when manatee-backupserver isn't running on upstream peer

---
 lib/backupServer.js |  2 +-
 lib/zfsClient.js    | 19 +++++++++++++------
 2 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/lib/backupServer.js b/lib/backupServer.js
index c6c92a6..31a4438 100644
--- a/lib/backupServer.js
+++ b/lib/backupServer.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /**
diff --git a/lib/zfsClient.js b/lib/zfsClient.js
index b1dfc2d..f3f207e 100644
--- a/lib/zfsClient.js
+++ b/lib/zfsClient.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 
@@ -773,6 +773,7 @@ ZfsClient.prototype._receive = function (dataset,
 
     var restoreIntervalId;
     var server;
+    var zfsRecv;
 
     log.info({
         dataset: dataset,
@@ -789,22 +790,22 @@ ZfsClient.prototype._receive = function (dataset,
              *  been changed yet. Otherwise the recv will fail trying to create
              *  the mountpoint
              */
-            _.zfsRecv = spawn(self._zfsPath, ['recv', '-v', '-u',
+            zfsRecv = spawn(self._zfsPath, ['recv', '-v', '-u',
                                               self._dataset]);
 
-            _.zfsRecv.stdout.on('data', function (data) {
+            zfsRecv.stdout.on('data', function (data) {
                 var dataStr = data.toString();
                 log.info('zfs recv stdout: ', dataStr);
             });
 
             var msg = '';
-            _.zfsRecv.stderr.on('data', function (data) {
+            zfsRecv.stderr.on('data', function (data) {
                 var dataStr = data.toString();
                 log.info('zfs recv stderr: ', dataStr);
                 msg += data;
             });
 
-            _.zfsRecv.on('exit', function (code) {
+            zfsRecv.on('exit', function (code) {
                 if (code !== 0) {
                     var err2 = new verror.VError('zfs recv: ' + msg + ' ' +
                                                  code);
@@ -822,7 +823,7 @@ ZfsClient.prototype._receive = function (dataset,
             server = net.createServer();
             server.on('connection', function (socket) {
                 log.info('ZFSClient._receive: got socket, piping to zfs recv');
-                socket.pipe(_.zfsRecv.stdin);
+                socket.pipe(zfsRecv.stdin);
                 cb();
             });
 
@@ -832,6 +833,8 @@ ZfsClient.prototype._receive = function (dataset,
                 if (err) {
                     log.warn({err: err},
                              'ZfsClient._receive: could not start server');
+                    log.info('ZfsClient._receive: killing `zfs recv` proc');
+                    zfsRecv.kill('SIGKILL');
                     err = new verror.VError(err);
                 }
                 cb(err);
@@ -839,6 +842,8 @@ ZfsClient.prototype._receive = function (dataset,
 
             server.on('error', function (err) {
                 log.warn({err: err}, 'ZfsClient._receive: got socket error');
+                log.info('ZfsClient._receive: killing `zfs recv` proc');
+                zfsRecv.kill('SIGKILL');
                 cb(new verror.VError(err));
             });
         },
@@ -870,6 +875,8 @@ ZfsClient.prototype._receive = function (dataset,
                 serverUrl: serverUrl,
                 pollInterval: pollInterval
             }, 'unable to receive snapshot');
+            log.info('ZfsClient._receive: killing `zfs recv` proc');
+            zfsRecv.kill('SIGKILL');
             callback(err);
             return;
         }
-- 
2.21.0

