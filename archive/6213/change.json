{"project":"joyent/manatee","branch":"master","id":"I492303bde87c4cc8b0c941b2bac117b2fae86fb9","number":"6213","subject":"MANATEE-415 manatee-sitter spawns excessive zfs recv processes when manatee-backupserver isn\u0027t running on upstream peer Reviewed by: Kody A Kantor \u003ckody@kkantor.com\u003e","owner":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"url":"https://cr.joyent.us/6213","commitMessage":"MANATEE-415 manatee-sitter spawns excessive zfs recv processes when manatee-backupserver isn\u0027t running on upstream peer\nReviewed by: Kody A Kantor \u003ckody@kkantor.com\u003e\n","createdOn":1557344477,"lastUpdated":1563986540,"open":false,"status":"MERGED","comments":[{"timestamp":1557344477,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Uploaded patch set 1."},{"timestamp":1557344478,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 563dda6bdae353804c12b2cdf0123ed737110fb1\n    \n    Fix logging.\n    \n    commit 6e5ff15d727c090701caf5b4bc174320a92986c3\n    \n    Kill spawned `zfs recv` process in error conditions during restore to avoid accumulating processes\n    when the backserver is down."},{"timestamp":1557344507,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557386901,"reviewer":{"name":"Russell Brown","email":"russell.brown@joyent.com","username":"russelldb"},"message":"Patch Set 1:\n\n\u003e New commits:\n \u003e \n \u003e commit 563dda6bdae353804c12b2cdf0123ed737110fb1\n \u003e \n \u003e Fix logging.\n \u003e \n \u003e commit 6e5ff15d727c090701caf5b4bc174320a92986c3\n \u003e \n \u003e Kill spawned `zfs recv` process in error conditions during restore\n \u003e to avoid accumulating processes\n \u003e when the backserver is down.\n\nThis looks right, but is there anyway I can test it? Even if there isn\u0027t an automated test, are there some steps I can take to show the fix has the desired effect. Is it very laborious to reproduce the issue? (is this the place for that info/question, or is JIRA?)"},{"timestamp":1557406621,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 1:\n\nrdb: I appreciate the offer to test! I am looking in the existing tests for a way to automate it (nothing is immediately obvious at the moment). I will update the Jira with steps I took to reproduce."},{"timestamp":1557508893,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Uploaded patch set 2."},{"timestamp":1557508894,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 4398f5d93f2d2fd50afef415e9a5f57efd19dd8e\n    \n    Kill the `zfs revc` proc if the server listen fails, but not if the restore REST request does."},{"timestamp":1557508923,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558708198,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(2 comments)\n\nLooks good! Just one question about your thoughts around SIGTERM vs SIGKILL."},{"timestamp":1558708676,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1560275806,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Uploaded patch set 3."},{"timestamp":1560275807,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 15c273ed399633985a52e32568d3e566e7be5e19\n    \n    Updated copyright year."},{"timestamp":1560275843,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560351867,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Uploaded patch set 4."},{"timestamp":1560351868,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit fdf364d4b2f1cf7cf27bca9e13bba896602accb9\n    \n    Change signal to kill zfs process to \u0027SIGKILL\u0027; kill proc if receive fails."},{"timestamp":1560351904,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560785210,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1563959397,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(3 comments)\n\nI\u0027ve taken a look at this for CR, and I\u0027ll take a look at doing IA for this as well!"},{"timestamp":1563982743,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Uploaded patch set 5."},{"timestamp":1563982745,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit f09f817f7865d28bd20b662f85ac45d1d9f02756\n    \n    Review feeback incorporated."},{"timestamp":1563982781,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1563984403,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nThanks for incorporating my suggestions! Code and testing notes look good to me.\n\nI\u0027m not sure if you\u0027ve made a change to Manatee before, but once this is integrated we\u0027ll also need to bump the joyent/manatee dependency in joyent/sdc-manatee and joyent/manta-manatee, which tends to be done as part of the same JIRA ticket. An example of that is MANATEE-380 where you can see the commit comments for the separate repos in the ticket, and will result in this change making its way into our \"sdc-manatee\" and \"manta-postgres\" images.\n\nFeel free to add me as a reviewer for those, too."},{"timestamp":1563986540,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jon Anderson"}],"currentPatchSet":{"number":"5","revision":"492303bde87c4cc8b0c941b2bac117b2fae86fb9","parents":["6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9"],"ref":"refs/changes/13/6213/5","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1563982743,"author":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1563982781,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1563984403,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1563984403,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1563986540,"by":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":10,"deletions":-8}],"sizeInsertions":10,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"ba0c20d6a1579386f541372b72b04d7533b77d8c","parents":["6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9"],"ref":"refs/changes/13/6213/1","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1557344477,"author":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557344507,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":10,"deletions":-5}],"sizeInsertions":10,"sizeDeletions":-5},{"number":"2","revision":"00441e75abd6fa610cbb78d7f48ec77f1649dabc","parents":["6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9"],"ref":"refs/changes/13/6213/2","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1557508893,"author":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557508923,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/zfsClient.js","line":8,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"2019!"},{"file":"lib/zfsClient.js","line":837,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"In your testing have you hit any cases where SIGTERM isn\u0027t handled because the process is busy doing something else single-threaded, or another signal handling \u0027gotcha?\u0027 Do you think that\u0027s something we need to worry about?"},{"file":"lib/zfsClient.js","line":837,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Good call out -- I have not seen that. I used SIGTERM thinking it would give the zfs proc a chance to clean up, etc. Perhaps this is not the best approach?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":10,"deletions":-5}],"sizeInsertions":10,"sizeDeletions":-5},{"number":"3","revision":"8b08f116e65fa2c8b119fef5e8458b85b319e8d2","parents":["6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9"],"ref":"refs/changes/13/6213/3","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1560275806,"author":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560275843,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":10,"deletions":-5}],"sizeInsertions":11,"sizeDeletions":-6},{"number":"4","revision":"7b8b059f248243155a31b16ec625365db81b729d","parents":["6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9"],"ref":"refs/changes/13/6213/4","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1560351867,"author":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560351904,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560785210,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"lib/backupServer.js","line":8,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I don\u0027t think this file has changed to warrant this year bump."},{"file":"lib/zfsClient.js","line":878,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think we could probably roll this message into the above log message. Maybe something like:\n\n    zfsClient._receive: unable to receive snapshot; killing `zfs recv` proc\n\nAlso, what do you think of elevating this log message to the level \"warn\"?"},{"file":"lib/zfsClient.js","line":879,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Could we get away with just doing the SIGKILL here?\n\nThe other places (on L837 and L846) (along with their corresponding log messages) I think can be removed, in which case the callback being called with \"err\" will end the pipeline and result in this \"err\" condition being matched anyway.\n\nWhat I think would happen in this change\u0027s case would be duplicate \"killing\" messages, as well as at least 2 attempts to SIGKILL the process. Is that what you\u0027ve observed in testing?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":13,"deletions":-6}],"sizeInsertions":14,"sizeDeletions":-7},{"number":"5","revision":"492303bde87c4cc8b0c941b2bac117b2fae86fb9","parents":["6e802583f517e74f8e6c1ccab26b01ce2bbbf8f9"],"ref":"refs/changes/13/6213/5","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1563982743,"author":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1563982781,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1563984403,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1563984403,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1563986540,"by":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":10,"deletions":-8}],"sizeInsertions":10,"sizeDeletions":-8}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},{"name":"Russell Brown","email":"russell.brown@joyent.com","username":"russelldb"}]}