{"project":"joyent/illumos-joyent","branch":"master","id":"I9b594e849bbdfa2ad089287b5406eaacbf553531","number":"2755","subject":"OS-6368 lxbrand: mlockall struggles with anonymous overcommit","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2755","commitMessage":"OS-6368 lxbrand: mlockall struggles with anonymous overcommit\n","createdOn":1507583600,"lastUpdated":1508344013,"open":false,"status":"ABANDONED","comments":[{"timestamp":1507583600,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1508244838,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nOne of the sub-tests in mlock02 fails with this change. I have disabled this test for now since it will be much simpler to address that after I move the majority of the mmap code in-kernel."},{"timestamp":1508244849,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1508258611,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1508264688,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1508264744,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1508265068,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nI should have been more clear in my previous comment. Obviously not every mapping is overcommited, just the no_reserve ones."},{"timestamp":1508340427,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1508341694,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1508341707,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1508344013,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Abandoned\n\nSetting aside until other work is completed first."}],"currentPatchSet":{"number":"4","revision":"9b594e849bbdfa2ad089287b5406eaacbf553531","parents":["3e8f2de8060a6dc6b5940f6a15c3b444fd288b58"],"ref":"refs/changes/55/2755/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508341707,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/mman.h","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/vm/seg_vn.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":26,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"b5856d0f965980d945ec4fbfb94aa481228a0135","parents":["9793308df96de5fbb991049b785ac9b9f4b23bd7"],"ref":"refs/changes/55/2755/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1507583600,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/mman.h","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/vm/seg_vn.c","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-4},{"number":"2","revision":"ec031febf2417e7b04bbcce204ea1d7fff310de2","parents":["4f660fcf1984e21a5adb8ab350ef579b91a14eea"],"ref":"refs/changes/55/2755/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508244849,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/sys/mman.h","line":102,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"segment"},{"file":"usr/src/uts/common/sys/mman.h","line":102,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"},{"file":"usr/src/uts/common/vm/seg_vn.c","line":7802,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Would it be more appropriate to exclude them from the check entirely?  What if there are a series of OVERCOMMIT segments in the low portion of the address space, followed by normal ones after that?  Would it be unexpected to bail out with the error when a later segment hit the limit?"},{"file":"usr/src/uts/common/vm/seg_vn.c","line":7802,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"The problem is that all of the mappings in lx are overcommit in order to match the Linux model. We don\u0027t really have a way to tell when an app is making one of these big mappings that it will never really use much (if at all) vs. a mapping that is is fully used. I chose this approach so that if we hit a segment that blows the limit, it will not be locked, but future segments can still get locked in if possible. Once I move mmap into the kernel, I can more easily do a little more checking at mmap time WRT to process lock limits, but in general the whole overcommit idea from Linux does not sit well on our OS."},{"file":"usr/src/uts/common/vm/seg_vn.c","line":7802,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"OK.  Perhaps it\u0027s worth describing some or all of that limitation in this comment?"},{"file":"usr/src/uts/common/vm/seg_vn.c","line":7802,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027ve tried to make the comment clearer without explicitly discussing any specific brand behavior. Let me know if this seems better."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/mman.h","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/vm/seg_vn.c","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-4},{"number":"3","revision":"6ca313365cd759921d2da7661e3b9f2dfae80992","parents":["3e8f2de8060a6dc6b5940f6a15c3b444fd288b58"],"ref":"refs/changes/55/2755/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508264744,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/mman.h","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/vm/seg_vn.c","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-4},{"number":"4","revision":"9b594e849bbdfa2ad089287b5406eaacbf553531","parents":["3e8f2de8060a6dc6b5940f6a15c3b444fd288b58"],"ref":"refs/changes/55/2755/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508341707,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/mman.h","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/vm/seg_vn.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":26,"sizeDeletions":-4}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}