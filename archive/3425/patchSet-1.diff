From df63244b8a41770b190cbeffacf6ddb0bb0c3f41 Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Fri, 16 Feb 2018 15:49:44 +0100
Subject: [PATCH] don't panic on PCIe errors from passthru device

---
 usr/src/uts/common/io/pciex/pcie_fault.c | 10 ++++++++++
 usr/src/uts/common/sys/pcie_impl.h       |  1 +
 2 files changed, 11 insertions(+)

diff --git a/usr/src/uts/common/io/pciex/pcie_fault.c b/usr/src/uts/common/io/pciex/pcie_fault.c
index 41c046fe66..14afa5c013 100644
--- a/usr/src/uts/common/io/pciex/pcie_fault.c
+++ b/usr/src/uts/common/io/pciex/pcie_fault.c
@@ -285,6 +285,12 @@ done:
 
 	pf_send_ereport(derr, &impl);
 
+	/*
+	 * Don't panic the system if the device belongs to a virtual machine.
+	 */
+	if (scan_flag & PF_SCAN_PASSTHRU)
+		analyse_flag &= ~PF_ERR_PANIC;
+
 	/*
 	 * Check if any hardened driver's callback reported a panic.
 	 * If so panic.
@@ -918,6 +924,10 @@ pf_default_hdl(dev_info_t *dip, pf_impl_t *impl)
 		goto done;
 	}
 
+	/* Set the passthru flag if the driver is ppt. */
+	if (strcmp(ddi_driver_name(dip), "ppt") != 0)
+		scan_flag |= PF_SCAN_PASSTHRU;
+
 	/*
 	 * Read vendor/device ID and check with cached data; if it doesn't
 	 * match, it could very well mean that the device is no longer
diff --git a/usr/src/uts/common/sys/pcie_impl.h b/usr/src/uts/common/sys/pcie_impl.h
index 54628f195c..404c08cb7f 100644
--- a/usr/src/uts/common/sys/pcie_impl.h
+++ b/usr/src/uts/common/sys/pcie_impl.h
@@ -439,6 +439,7 @@ typedef struct pf_impl {
 #define	PF_SCAN_IN_DQ		(1 << 3) /* already present in the faultq */
 #define	PF_SCAN_DEADLOCK	(1 << 4) /* deadlock detected */
 #define	PF_SCAN_BAD_RESPONSE	(1 << 5) /* Incorrect device response */
+#define	PF_SCAN_PASSTHRU	(1 << 6) /* device belongs to virtual machine */
 
 /* PCIe fabric error handling severity return flags */
 #define	PF_ERR_NO_ERROR		(1 << 0) /* No error seen */
-- 
2.21.0

