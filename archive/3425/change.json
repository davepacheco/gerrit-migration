{"project":"joyent/illumos-joyent","branch":"master","id":"Ib6307203bf06055042d736fce6853c097081997c","number":"3425","subject":"OS-6729 PCIe errors on passthru devices shouldn\u0027t cause a panic Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@j","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/3425","commitMessage":"OS-6729 PCIe errors on passthru devices shouldn\u0027t cause a panic\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1519142643,"lastUpdated":1524679217,"open":false,"status":"MERGED","comments":[{"timestamp":1519142643,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1519142804,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\nThis is a rather simple approach to avoid panicking from PCIe errors that come from a passthru device. It doesn\u0027t deal with injecting the errors into the guest, that may follow in a later change."},{"timestamp":1519143001,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1519217950,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI don\u0027t have any comments, but I am curious about Patrick\u0027s question."},{"timestamp":1519218187,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nNo comments so far.  Like Jerry, I\u0027m awaiting resolution of Patrick\u0027s question."},{"timestamp":1519222714,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1519247877,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1519247940,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1519257444,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1519306405,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4."},{"timestamp":1519307503,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1519310668,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1\n\nI don\u0027t see anything that actually sets DDI_FM_PASSHTRU_FLAG, but I guess that is probably only in code that will land with the dev-bhyve branch.  If it is there, I\u0027m happy with this."},{"timestamp":1519312057,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: -Code-Review\n\n(1 comment)"},{"timestamp":1519318030,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(1 comment)\n\nI really don\u0027t like the overload here on the fm capability for this flag. I\u0027m not sure that this should be a driver wide setting (which is effectively what it turns into here). Should this instead be a pci_.* call to set this for PCI? As that\u0027s what cares about it? What happens when we have SR-IOV and we may or may not want to associate errors on virtual functions on a per-dip basis with this flag. Or you could imagine a driver which is more actively aware of it being passed through then the ppt design is today.\n\nMaybe we can separate this out into a separate call to set this at least? Like ddi_fm_set_flags(dip, flags), since this is only trying to be set on our device and not passed up the inheritance chain."},{"timestamp":1519396129,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n(1 comment)\n\nIt\u0027s not a driver-wide setting, it\u0027s per instance. The driver will call ddi_fm_init() in attach(9e), setting the flag for the instance.\n\nMy understanding of SR-IOV is that it will just give us some extra virtual PCI functions of a device, which will have ppt attached, and it will just work as it does for \"real\" PCI functions.\n\nA special ppt-like driver which knows the device (been thinking about something like that for NVMe recently) would likely want to set the flag for its instances.\n\nA different way to handle this would be to extend the FM callback mechanism to allow a driver to return a value indicating the device is under passthru control, and hence shouldn\u0027t be allowed to cause a host panic. The more I think about it the more I like the idea."},{"timestamp":1519403343,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\nI get that ddi_fm_init() is ultimately called on a per-instance basis, but today it\u0027s hard to imagine how you\u0027re going to have enough information during attach time to know how to modify it and change things. It does still feel like we\u0027re overloading the notion of FM capabilities, and we already see that we have to play games to make sure that it doesn\u0027t go up the inheritance tree, when this is ultimately a rather PCI-specific thing."},{"timestamp":1519403426,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\nI guess the other thing I should add is it feels like in cases like you\u0027re describing with the nvme-ppt hybrid driver, we may in fact want to set this after we\u0027ve initialized the fm capabilities and move it in and out of this mode depending on whether or not a guest is attached.\n\nIt would really help to have an OS ticket written up that talks through this in more detail."},{"timestamp":1520010330,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1520011017,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 6."},{"timestamp":1520022913,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6:\n\n(1 comment)\n\nI\u0027ve tried to look this this carefully, especially given Robert\u0027s earlier comments. I think this looks good, I just had one small nit."},{"timestamp":1520024584,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1520244813,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 8."},{"timestamp":1520244848,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1520255453,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1520260513,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Code-Review+1\n\nLooks good to me, but this isn\u0027t an area that I know well."},{"timestamp":1521481324,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1523867039,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 9: Patch Set 8 was rebased"},{"timestamp":1523884909,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 10."},{"timestamp":1523885296,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1523901256,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1523970176,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1523977401,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1524587619,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 10: Integration-Approval+1"},{"timestamp":1524672840,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 11: Patch Set 10 was rebased"},{"timestamp":1524673590,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 12: Commit message was updated."},{"timestamp":1524679217,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"12","revision":"b6307203bf06055042d736fce6853c097081997c","parents":["afdd5fd8c7565bef583a831e14d8bce41a3bc741"],"ref":"refs/changes/25/3425/12","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524673590,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523901256,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523970176,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523977401,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524587619,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1524679217,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":32,"deletions":-5},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":40,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"df63244b8a41770b190cbeffacf6ddb0bb0c3f41","parents":["57e71e6ae577b3a62adc80688f00a5963bf97264"],"ref":"refs/changes/25/3425/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1519142643,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":929,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is there something we could add to the API to opt-in to this behavior, rather than hard-coding a driver name comparison?"},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":929,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I can add a DDI_FM_PASSTHRU_CAPABLE flag to be passed by the driver when calling ddi_fm_init(), which can be checked here instead. I\u0027m not sure that this is really a \"capability\" in the true sense of that word, but that interface seems like a logical choice for this kind of thing."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":11,"sizeDeletions":0},{"number":"2","revision":"9dae213009f07aababe1e158a69271493b4f304b","parents":["f49f984d73e73b99d7388dfffa647c0d2f406d31"],"ref":"refs/changes/25/3425/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1519247877,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":11,"sizeDeletions":0},{"number":"3","revision":"be9445b059df0238ca9e8c35724f2b27f28e4c91","parents":["f49f984d73e73b99d7388dfffa647c0d2f406d31"],"ref":"refs/changes/25/3425/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1519247940,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519257444,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/os/ddifm.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/ddifm.h","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":21,"sizeDeletions":-3},{"number":"4","revision":"f069ae5bf6e25fc3f72926ecc07c0fc38b244d16","parents":["f49f984d73e73b99d7388dfffa647c0d2f406d31"],"ref":"refs/changes/25/3425/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1519306405,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Need bug number"},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":911,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"PF_SCAN_PASSTHRU should be documented here."},{"file":"usr/src/uts/common/os/ndifm.c","line":686,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Although the code is correct, I found this hard to read. Maybe it\u0027s just me, but it seems like it would be clearer if you split this into another statement, like this:\npcap \u0026\u003d DDI_FM_CAPAB_MASK;\nIf you don\u0027t agree that the current code looks confusing, then you can leave it as-is."},{"file":"usr/src/uts/common/os/ndifm.c","line":686,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Ok, I will do that in the next iteration of this change."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/os/ddifm.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/ndifm.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/ddifm.h","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":22,"sizeDeletions":-4},{"number":"5","revision":"910a18f96467a2947d3332cf8b1116a234a323bf","parents":["7bb94c96d6b670e5ac129648edfd9d3734953514"],"ref":"refs/changes/25/3425/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520010330,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/os/ddifm.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/os/ndifm.c","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/ddifm.h","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":22,"sizeDeletions":-4},{"number":"6","revision":"09b9164ea5b3264998340740b2a1bfae7c4f9072","parents":["7bb94c96d6b670e5ac129648edfd9d3734953514"],"ref":"refs/changes/25/3425/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520011017,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":1007,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Can you add curly braces here, since this conditional has an else clause (as per cstyle)."},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":1007,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":26,"deletions":0},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":32,"sizeDeletions":0},{"number":"7","revision":"d37adfa9a0e496f15e85a3d2c6de57f8dad32186","parents":["7bb94c96d6b670e5ac129648edfd9d3734953514"],"ref":"refs/changes/25/3425/7","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520024584,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":26,"deletions":0},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":32,"sizeDeletions":0},{"number":"8","revision":"3f993fb2c013d8e1ef7436faf8caf3590abc2896","parents":["7bb94c96d6b670e5ac129648edfd9d3734953514"],"ref":"refs/changes/25/3425/8","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520244813,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520255453,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520260513,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":1000,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This is the first flag that\u0027s being set asynchronously from the general initialization path from the device. It feels like there probably are some locking concerns that we\u0027d want to think about given that errors can happen in separate threads from us toggling the pass through flags and having that propagate out. How is synchronization and visibility intended to work here?"},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","line":1000,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I figured that it\u0027s probably easiest to just use atomics here. The flags aren\u0027t (re-)set very often so that should be fine."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":27,"deletions":0},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":33,"sizeDeletions":0},{"number":"9","revision":"ec5467391f07f2518a0cbb811b3acb99ec8ceccc","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/25/3425/9","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523867039,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520255453,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520260513,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":27,"deletions":0},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":33,"sizeDeletions":0},{"number":"10","revision":"a1c7116bad05da0296585aaea459576f3bc9467e","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/25/3425/10","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523884909,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523901256,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524587619,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523970176,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523977401,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":32,"deletions":-5},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":40,"sizeDeletions":-7},{"number":"11","revision":"542e8acce66ed52675b71b164c738018e8ae7335","parents":["afdd5fd8c7565bef583a831e14d8bce41a3bc741"],"ref":"refs/changes/25/3425/11","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524672840,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523901256,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524587619,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523970176,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523977401,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":32,"deletions":-5},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":40,"sizeDeletions":-7},{"number":"12","revision":"b6307203bf06055042d736fce6853c097081997c","parents":["afdd5fd8c7565bef583a831e14d8bce41a3bc741"],"ref":"refs/changes/25/3425/12","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1524673590,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523901256,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524587619,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523970176,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523977401,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1524679217,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/pciex/pcie.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/io/pciex/pcie_fault.c","type":"MODIFIED","insertions":32,"deletions":-5},{"file":"usr/src/uts/common/sys/pcie_impl.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/sun4/io/px/px_fm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":40,"sizeDeletions":-7}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}