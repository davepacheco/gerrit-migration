From 3b4ea961957177d6b30ecd8e2a66ad5f9b3265d9 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Thu, 29 Jun 2017 15:59:17 +0000
Subject: [PATCH] OS-6213 improve LX autofs error handling

---
 usr/src/uts/common/brand/lx/autofs/lx_autofs.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/usr/src/uts/common/brand/lx/autofs/lx_autofs.c b/usr/src/uts/common/brand/lx/autofs/lx_autofs.c
index 2864a6d680..730deae80e 100644
--- a/usr/src/uts/common/brand/lx/autofs/lx_autofs.c
+++ b/usr/src/uts/common/brand/lx/autofs/lx_autofs.c
@@ -2240,12 +2240,23 @@ lx_autofs_lookup(vnode_t *dvp, char *nm, vnode_t **vpp, struct pathname *pnp,
 		 * will also do a rele on the original dvp and that would leave
 		 * us one ref short on our autofs root vnode.
 		 */
+		vnode_t *orig_dvp = dvp;
+
 		VN_HOLD(dvp);
 		if ((error = traverse(&dvp)) != 0) {
 			VN_RELE(dvp);
 			return (error);
 		}
 
+		if (dvp == orig_dvp) {
+			/*
+			 * For some reason the automountd did not actually
+			 * mount the new filesystem. Return an error.
+			 */
+			VN_RELE(dvp);
+			return (ENOENT);
+		}
+
 		error = VOP_LOOKUP(dvp, nm, vpp, pnp, flags, rdir, cr, ctp,
 		    direntflags, realpnp);
 
-- 
2.21.0

