From bb151c8f1472c835986e837dd8e34860d0983519 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Wed, 31 Jan 2018 11:25:21 -0800
Subject: [PATCH] TRITON-96 cn-agent heartbeater crash loading VMs: "vmobjs
 ([object]) is required"

---
 lib/heartbeater.js | 4 ++--
 package.json       | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/lib/heartbeater.js b/lib/heartbeater.js
index fc24431..a9a8da6 100644
--- a/lib/heartbeater.js
+++ b/lib/heartbeater.js
@@ -118,14 +118,14 @@ StatusReporter.prototype.updateSample = function () {
                 }, function onLoadVms(err, vmobjs) {
                     var vmobj;
 
-                    assert.arrayOfObject(vmobjs, 'vmobjs');
-
                     if (err) {
                         self.log.error({err: err}, 'unable update VM list');
                         cb(new Error('unable to update VM list.'));
                         return;
                     }
 
+                    assert.arrayOfObject(vmobjs, 'vmobjs');
+
                     vms = {};
                     newSample.vms = {};
 
diff --git a/package.json b/package.json
index 45e7d28..6c82c46 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cn-agent",
   "description": "Triton Compute Node Agent",
-  "version": "2.0.2",
+  "version": "2.0.3",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

