From 0da99e34680ea71b20f2341aa1a4f07d2fd39af9 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Wed, 21 Feb 2018 09:12:42 -0800
Subject: [PATCH] TRITON-163 Triton should refuse to mix bhyve & kvm and send
 bhyve VMs only to capable nodes

---
 lib/algorithms/calculate-server-unreserved.js |   4 +-
 lib/algorithms/hard-filter-hvm.js             |  84 +++++++++
 lib/algorithms/hard-filter-min-disk.js        |   5 +-
 lib/algorithms/hard-filter-min-ram.js         |   4 +-
 package.json                                  |   2 +-
 test/algorithms/hard-filter-hvm.test.js       | 177 ++++++++++++++++++
 test/allocator.test.js                        |   3 +-
 7 files changed, 271 insertions(+), 8 deletions(-)
 create mode 100644 lib/algorithms/hard-filter-hvm.js
 create mode 100644 test/algorithms/hard-filter-hvm.test.js

diff --git a/lib/algorithms/calculate-server-unreserved.js b/lib/algorithms/calculate-server-unreserved.js
index f0e17b4..4431dbf 100644
--- a/lib/algorithms/calculate-server-unreserved.js
+++ b/lib/algorithms/calculate-server-unreserved.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -99,7 +99,7 @@ calculateServerUnreserved(servers, opts, cb)
 
 			ram = vm.max_physical_memory;
 			if (vm.state !== 'failed') {
-				if (vm.brand !== 'kvm')
+				if (['bhyve', 'kvm'].indexOf(vm.brand) === -1)
 					ram /= overprovisionRam;
 
 				server.unreserved_ram -= ram;
diff --git a/lib/algorithms/hard-filter-hvm.js b/lib/algorithms/hard-filter-hvm.js
new file mode 100644
index 0000000..094eaae
--- /dev/null
+++ b/lib/algorithms/hard-filter-hvm.js
@@ -0,0 +1,84 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2018, Joyent, Inc.
+ */
+
+/*
+ * This filter will:
+ *
+ *	* prevent brand=bhyve VMs from being provisioned to servers that don't
+ *	  have 'Bhyve Capable' set to true in their sysinfo.
+ *	* prevent brand=bhyve VMs from being provisioned to servers that have
+ *	  existing kvm VMs.
+ *	* prevent brand=kvm VMs from being provisioned to servers that have
+ *	  existing bhyve VMs.
+ *
+ * Note that calculate-ticketed-vms.js will have added in-flight VMs to the
+ * server.vms arrays, so we will also refuse to provision bhyve to a system that
+ * has an in-progress kvm provision and vice versa.
+ */
+
+var assert = require('assert-plus');
+
+var HVM_BRANDS = ['bhyve', 'kvm'];
+
+
+function filterHVM(servers, opts, cb) {
+	assert.arrayOfObject(servers, 'servers');
+	assert.object(opts, 'opts');
+	assert.object(opts.vm, 'opts.vm');
+	assert.string(opts.vm.brand, 'opts.vm.brand');
+	assert.func(cb, 'cb');
+
+	var adequateServers;
+	var reasons = {};
+	var newVmBrand = opts.vm.brand;
+
+	if (HVM_BRANDS.indexOf(newVmBrand) === -1) {
+		// We don't care about VMs with brands that are not HVM
+		return (cb(null, servers, reasons));
+	}
+
+	adequateServers = servers.filter(function checkServer(server) {
+		var bhyveSupport = server.sysinfo['Bhyve Capable'];
+		var vms = server.vms;
+		var vmNames = Object.keys(vms);
+
+		if (newVmBrand === 'bhyve' && bhyveSupport !== true) {
+			reasons[server.uuid] =
+			    'Server does not support "bhyve" VMs';
+			return (false);
+		}
+
+		for (var i = 0; i !== vmNames.length; i++) {
+			var vm = vms[vmNames[i]];
+
+			if (HVM_BRANDS.indexOf(vm.brand) === -1) {
+				// Brands other than these won't conflict
+				continue;
+			}
+
+			if (vm.brand !== newVmBrand) {
+				reasons[server.uuid] = 'VM ' + vm.uuid +
+				    ' has brand ' + vm.brand + ' which ' +
+				    'is incompatible with new VMs using ' +
+				    'brand ' + newVmBrand;
+				return (false);
+			}
+		}
+
+		return (true);
+	});
+
+	return (cb(null, adequateServers, reasons));
+}
+
+module.exports = {
+	name: 'Servers which are capable of requested virtualization',
+	run: filterHVM
+};
diff --git a/lib/algorithms/hard-filter-min-disk.js b/lib/algorithms/hard-filter-min-disk.js
index e23e8e4..159b338 100644
--- a/lib/algorithms/hard-filter-min-disk.js
+++ b/lib/algorithms/hard-filter-min-disk.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -54,7 +54,8 @@ filterMinDisk(servers, opts, cb)
 		// GiB, while the latter is in MiB.
 		var quota = vm.quota ? vm.quota * 1024 : pkg.quota;
 
-		if (vm.brand === 'kvm' || img.type === 'zvol') {
+		if (['bhyve', 'kvm'].indexOf(vm.brand) !== -1 ||
+			    img.type === 'zvol') {
 			// image_size applies to disk[0], quota to disk[1]
 			requestedDisk = quota + img.image_size;
 		} else {
diff --git a/lib/algorithms/hard-filter-min-ram.js b/lib/algorithms/hard-filter-min-ram.js
index 8fdada8..4a66e0a 100644
--- a/lib/algorithms/hard-filter-min-ram.js
+++ b/lib/algorithms/hard-filter-min-ram.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -39,7 +39,7 @@ filterMinRam(servers, opts, cb)
 	if (pkg && pkg.overprovision_ram) {
 		var requestedRam = vm.ram || pkg.max_physical_memory;
 
-		if (vm.brand !== 'kvm')
+		if (['bhyve', 'kvm'].indexOf(vm.brand) === -1)
 			requestedRam /= pkg.overprovision_ram;
 
 		filter = function (server) {
diff --git a/package.json b/package.json
index 790948d..e1c9e4c 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "dapi",
   "description": "SmartDataCenter Designation API",
-  "version": "8.1.0",
+  "version": "8.2.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
diff --git a/test/algorithms/hard-filter-hvm.test.js b/test/algorithms/hard-filter-hvm.test.js
new file mode 100644
index 0000000..0a67c4f
--- /dev/null
+++ b/test/algorithms/hard-filter-hvm.test.js
@@ -0,0 +1,177 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2018, Joyent, Inc.
+ */
+
+var test = require('tape');
+var filter = require('../../lib/algorithms/hard-filter-hvm.js');
+var common = require('./common.js');
+
+
+var checkFilter = common.createPluginChecker(filter);
+
+
+test('filterHVM() with joyent', function (t) {
+	var servers = [ {
+		sysinfo: { 'Bhyve Capable': true },
+		uuid: 'f667e0fa-33db-48da-a5d0-9fe837ce93fc',
+		vms: [
+			{ brand: 'bhyve' },
+			{ brand: 'kvm' }
+		]
+	} ];
+
+	var expectServers = servers.slice(0, 1);
+	var expectReasons = {};
+
+	var opts = {
+		vm:  { brand: 'joyent', ram: 512 },
+		pkg: {},
+		defaults: {}
+	};
+
+	// With brand=joyent, it really shouldn't matter which other
+	// instances are on the system.
+
+	checkFilter(t, servers, opts, expectServers, expectReasons);
+});
+
+
+test('filterHVM() with kvm and no existing VMs', function (t) {
+	var servers = [ {
+		sysinfo: {},
+		uuid: 'f667e0fa-33db-48da-a5d0-9fe837ce93fc',
+		vms: []
+	} ];
+
+	var expectServers = servers.slice(0, 1);
+	var expectReasons = {};
+
+	var opts = {
+		vm:  { brand: 'kvm', ram: 512 },
+		pkg: {},
+		defaults: {}
+	};
+
+	// no existing VMs, so kvm should be fine on the only server
+
+	checkFilter(t, servers, opts, expectServers, expectReasons);
+});
+
+
+test('filterHVM() with bhyve and mixed HW support', function (t) {
+	var servers = [ {
+		sysinfo: { 'Bhyve Capable': true },
+		uuid: 'f667e0fa-33db-48da-a5d0-9fe837ce93fc',
+		vms: []
+	}, {
+		sysinfo: {},
+		uuid: '4fe12d99-f013-4983-9e39-6e2f35b37aec',
+		vms: []
+	} ];
+
+	var expectServers = servers.slice(0, 1);
+	var expectReasons = {
+		'4fe12d99-f013-4983-9e39-6e2f35b37aec':
+			'Server does not support "bhyve" VMs'
+	};
+
+	var opts = {
+		vm:  { brand: 'bhyve', ram: 512 },
+		pkg: {},
+		defaults: {}
+	};
+
+	checkFilter(t, servers, opts, expectServers, expectReasons);
+});
+
+
+test('filterHVM() with bhyve and existing kvm', function (t) {
+	var servers = [ {
+		sysinfo: { 'Bhyve Capable': true },
+		uuid: 'f667e0fa-33db-48da-a5d0-9fe837ce93fc',
+		vms: [ {
+			brand: 'kvm',
+			uuid: '3ac37ee8-16a9-11e8-a114-9bd01a859c7f'
+		}]
+	}, {
+		sysinfo: { 'Bhyve Capable': true },
+		uuid: '4fe12d99-f013-4983-9e39-6e2f35b37aec',
+		vms: []
+	} ];
+
+	var expectServers = servers.slice(1, 2);
+	var expectReasons = {
+		'f667e0fa-33db-48da-a5d0-9fe837ce93fc':
+			'VM 3ac37ee8-16a9-11e8-a114-9bd01a859c7f has ' +
+			'brand kvm which is incompatible with new VMs ' +
+			'using brand bhyve'
+	};
+
+	var opts = {
+		vm:  { brand: 'bhyve', ram: 512 },
+		pkg: {},
+		defaults: {}
+	};
+
+	checkFilter(t, servers, opts, expectServers, expectReasons);
+});
+
+
+test('filterHVM() with kvm and existing bhyve', function (t) {
+	var servers = [ {
+		sysinfo: { 'Bhyve Capable': true },
+		uuid: 'f667e0fa-33db-48da-a5d0-9fe837ce93fc',
+		vms: [ {
+			brand: 'bhyve',
+			uuid: '3ac37ee8-16a9-11e8-a114-9bd01a859c7f'
+		} ]
+	}, {
+		sysinfo: { 'Bhyve Capable': true },
+		uuid: '4fe12d99-f013-4983-9e39-6e2f35b37aec',
+		vms: []
+	} ];
+
+	var expectServers = servers.slice(1, 2);
+	var expectReasons = {
+		'f667e0fa-33db-48da-a5d0-9fe837ce93fc':
+			'VM 3ac37ee8-16a9-11e8-a114-9bd01a859c7f has brand ' +
+			'bhyve which is incompatible with new VMs using ' +
+			'brand kvm'
+	};
+
+	var opts = {
+		vm:  { brand: 'kvm', ram: 512 },
+		pkg: {},
+		defaults: {}
+	};
+
+	checkFilter(t, servers, opts, expectServers, expectReasons);
+});
+
+
+test('filterHVM() with no servers', function (t) {
+	var servers = [];
+
+	var expectServers = [];
+	var expectReasons = {};
+
+	var opts = {
+		vm:  { brand: 'joyent', ram: 512 },
+		pkg: {},
+		defaults: {}
+	};
+
+	checkFilter(t, servers, opts, expectServers, expectReasons);
+});
+
+
+test('name', function (t) {
+	t.equal(typeof (filter.name), 'string');
+	t.end();
+});
diff --git a/test/allocator.test.js b/test/allocator.test.js
index 8630cb5..e08518e 100644
--- a/test/allocator.test.js
+++ b/test/allocator.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -795,6 +795,7 @@ test('load available algorithms', function (t) {
 		'hard-filter-capness',
 		'hard-filter-feature-min-platform',
 		'hard-filter-headnode',
+		'hard-filter-hvm',
 		'hard-filter-invalid-servers',
 		'hard-filter-large-servers',
 		'hard-filter-locality-hints',
-- 
2.21.0

