{"project":"joyent/sdc-cn-agent","branch":"master","id":"Ic43be880dc9262737e170678525f0b6021424629","number":"3276","subject":"TRITON-69 cn-agent should not try to update boot time just once, should retry instead Reviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e Approved by: Orlando Vazquez \u003corlando@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/3276","commitMessage":"TRITON-69 cn-agent should not try to update boot time just once, should retry instead\nReviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e\nApproved by: Orlando Vazquez \u003corlando@joyent.com\u003e\n","createdOn":1517256945,"lastUpdated":1517646716,"open":false,"status":"MERGED","comments":[{"timestamp":1517256945,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1517256946,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 188b9e00ca8ab7db43e49818592305b2317fa19b\n    \n    initial work on registering sysinfo on cn-agent startup."},{"timestamp":1517256972,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517272663,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1517293328,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1517293346,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1517293348,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 38f1c336a79d198b9ee3dc6b14a86724341abb82\n    \n    At default log level, we want to see messages about sysinfo"},{"timestamp":1517293375,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517296130,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1517296131,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 8a915608836bd9134b1d6a84888c3b1b78508949\n    \n    Match vm-agent\u0027s user-agent"},{"timestamp":1517296157,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517331954,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1517338292,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1517338302,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1517338304,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 8a7c8724299576cebf770d64478004e5bfc02840\n    \n    updates based on CR discussion"},{"timestamp":1517338334,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1517339347,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1517339349,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit c2da1ea8c55e4054ccc8c22fbc556cfe3c9a867b\n    \n    darn punctuation put me over the line!"},{"timestamp":1517339376,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517357914,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1517386246,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1517434371,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 7."},{"timestamp":1517434373,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 7559300d75341819e49ad4fa8e83987149fa6990\n    \n    darn punctuation put me over the line!\n    \n    commit 23a97da51f499ae05ff01868228d9006bfc895d1\n    \n    updates based on CR discussion\n    \n    commit 5b930c0ca93b1086dfc54b0f5183cc9bdb587859\n    \n    Match vm-agent\u0027s user-agent\n    \n    commit d14e668cb4f889eefd274b6ad17a56f7b722bef5\n    \n    At default log level, we want to see messages about sysinfo\n    \n    commit 7df93b3dab5f85073c9c8a3017946004e78d6093\n    \n    initial work on registering sysinfo on cn-agent startup."},{"timestamp":1517434404,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517444519,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1517513861,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1517513862,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 8a6d698b330cbc2e5b6771e880cb7688181ddb3c\n    \n    darn punctuation put me over the line!\n    \n    commit 86c0a116c06643b0d247fa3b12781ceee0fef4dc\n    \n    updates based on CR discussion\n    \n    commit d017911ab1049159673f10d6a3da591a9bb41827\n    \n    Match vm-agent\u0027s user-agent\n    \n    commit 359f7142a0575b607868e47d54b76ff172c86a54\n    \n    At default log level, we want to see messages about sysinfo\n    \n    commit 5f69e8d6499454e44e4ce467a265106d937192d3\n    \n    initial work on registering sysinfo on cn-agent startup."},{"timestamp":1517513890,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"},{"timestamp":1517646716,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"8","revision":"c43be880dc9262737e170678525f0b6021424629","parents":["b9fa8d4e2a0e73b050e49e0e0173d58413c2eec6"],"ref":"refs/changes/76/3276/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517513861,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517434404,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517444519,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517444519,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1517646716,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":102,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":105,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"676a83b73350fb90b0975ee78e4b4ce4e9d18da4","parents":["ac0fb53fb729e6107cd5920c1623c738965aab70"],"ref":"refs/changes/76/3276/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517256945,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517256972,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":366,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Minor nit, should this have a leading underscore? Not sure if you have a rule of them of when to use them."},{"file":"lib/app.js","line":366,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I don\u0027t have a consistent rule there. Do you have a suggestion for a rule? Or a preference for this function? I don\u0027t mind going either way here."},{"file":"lib/app.js","line":366,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Not really, I\u0027m trying to find a consistent practice myself. Maybe underscores are nice since you can maybe explicitly mark a function as being a callback as opposed to some other kind of \"first class function\"?"},{"file":"lib/app.js","line":366,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I\u0027ll add the _.\n\nPerhaps the _ can be used whenever the function should only ever have one caller (which is true in the callback case for example)? I\u0027ll need to think some more about this."},{"file":"lib/app.js","line":392,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"just a minor nit, you can golf this down a bit:\n\n setTimeout(registerServer, delay, callback);\n\nAll the arguments passed to setTImeout after the delay will be what your `registerServer` will be called with after the timeout fires."},{"file":"lib/app.js","line":392,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I don\u0027t think that will work in this case, since calling:\n\n    self.registerBackoff.duration();\n\nactually gives the *next* duration (the self.registerBackoff has an attempts property that\u0027s modified on each call). So, in order to do what you\u0027re proposing, I think we\u0027d have to change to passing self in?\n\nWe also need self.log and self.userAgent here, so we\u0027d either have to also pass those in, or pass the whole self object. Right? Or am I missing something there too?"},{"file":"lib/app.js","line":392,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Ah good, call. To get \u0027self\u0027 we\u0027d probably need to use bind() like\n\n setTimeout(self.registerServer.bind(self), delay, callback);\n\nMeh :)"},{"file":"lib/app.js","line":392,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I agree with the Meh. :)\n\nWhat I will do though is add a comment here explaining why we need the .call()."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":95,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":98,"sizeDeletions":-2},{"number":"2","revision":"67a0e2950cecc3c675894bd1b2f92390135224fd","parents":["ac0fb53fb729e6107cd5920c1623c738965aab70"],"ref":"refs/changes/76/3276/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517293346,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517293375,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":95,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":98,"sizeDeletions":-2},{"number":"3","revision":"e103a287a43123cebaf81e8cb87039c29691166d","parents":["ac0fb53fb729e6107cd5920c1623c738965aab70"],"ref":"refs/changes/76/3276/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517296130,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517296157,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":98,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":101,"sizeDeletions":-2},{"number":"4","revision":"aa5b4c465620573ad0ae8beef2aff948de365ee4","parents":["ac0fb53fb729e6107cd5920c1623c738965aab70"],"ref":"refs/changes/76/3276/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517338302,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1517338334,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":396,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":101,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":104,"sizeDeletions":-2},{"number":"5","revision":"9b2fd09fc583dc2ce0711d6c5b93a17666355698","parents":["ac0fb53fb729e6107cd5920c1623c738965aab70"],"ref":"refs/changes/76/3276/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517339347,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517339376,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517357914,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517357914,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":102,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":105,"sizeDeletions":-2},{"number":"6","revision":"78a2e6cb18317dde885e7dfddb263b5800e4fac1","parents":["ac0fb53fb729e6107cd5920c1623c738965aab70"],"ref":"refs/changes/76/3276/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517386246,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517339376,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517357914,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517357914,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":102,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":105,"sizeDeletions":-2},{"number":"7","revision":"2ccf763024615502df26c3151cc2e0050fbc007c","parents":["bb151c8f1472c835986e837dd8e34860d0983519"],"ref":"refs/changes/76/3276/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517434371,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517434404,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517444519,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517444519,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":102,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":105,"sizeDeletions":-2},{"number":"8","revision":"c43be880dc9262737e170678525f0b6021424629","parents":["b9fa8d4e2a0e73b050e49e0e0173d58413c2eec6"],"ref":"refs/changes/76/3276/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1517513861,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517434404,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1517646716,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517444519,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517444519,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":102,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":105,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}