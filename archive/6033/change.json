{"project":"joyent/illumos-joyent","branch":"master","id":"I9a8207fa35a4a0b13b30000d6ead058c47c0ccc3","number":"6033","subject":"OS-7409 bhyve does not receive multicast packets Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/6033","commitMessage":"OS-7409 bhyve does not receive multicast packets\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1553909788,"lastUpdated":1554499354,"open":false,"status":"MERGED","comments":[{"timestamp":1553909788,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1554112331,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1554133266,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1554148858,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1554155994,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1554163940,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nI\u0027m good with this.  Happy to provide a kebecloud CN if you\u0027re desperate for HW."},{"timestamp":1554166848,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1554167196,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1554222864,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1554223672,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1554234624,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1554235005,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Code-Review+1\n\nThanks for adding b_next chain handling, and sorry for missing that."},{"timestamp":1554238770,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\nThanks for the additional changes here."},{"timestamp":1554492462,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1554492469,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\nTest notes are in the ticket."},{"timestamp":1554493988,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1554499141,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1554499215,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1554499354,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"9a8207fa35a4a0b13b30000d6ead058c47c0ccc3","parents":["ff1603a29d41ea115360ea42106b5881d604c113"],"ref":"refs/changes/33/6033/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1554499215,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554235005,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554238770,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554493988,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1554499354,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":137,"deletions":-26}],"sizeInsertions":137,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"659cba8777463977860a71430eb326d92c9ed4d5","parents":["583897b77026a5a95bd0c9a9f5c0bc1524da3a9f"],"ref":"refs/changes/33/6033/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1553909788,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2569,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"I\u0027m probably just missing part of how this works, but does this send up all multicast traffic or only the traffic destined for the vlan the vnic is supose to be subscribed on? As I see no filter on the vlan and promisc mode if I am not mistakens will show traffic for all vlans."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2569,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Because this is a MAC_CLIENT_PROMISC_MULTI attachment, MAC should take care of filtering packets so we only get ones destined for the current VLAN."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2569,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Ah yeah that would make sense, perhaps a short comment above were we set that?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":119,"deletions":-26}],"sizeInsertions":119,"sizeDeletions":-26},{"number":"2","revision":"390e7649a5a2c32587715896a6766aa762153f33","parents":["c248e2484c2c0a42913ce48e21031d119c63fe45"],"ref":"refs/changes/33/6033/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1554148858,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554163940,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1134,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why did you move the setting of l_neti after this? The moment that you have called viona_rx_set(), we need to assume that we will receive a call to viona_rx_classified or viona_rx_mcast, which will lead us to viona_rx_common, which assumes that l_neti is valid. I realize that this kind of race is improbable, but it seems potentially bad. As an added note, l_neti is cleared after the rx_set is done, which suggests that maybe it should be the opposite order versus what\u0027s written.\n\nWhat other kind of initialization do you think may be relevant here since we\u0027re now setting the rx function before we do the ring initialization by bhyve that we would have otherwise done."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1134,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Until the RX ring is initialized, any calls to the viona_rx_* functions will short-circuit to the bail-out.  The rings are initialized to the VRS_RESET state, so it should be safe."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1134,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK. Do we need a membar in the setting function since that data isn\u0027t protected by a lock?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1134,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Transitioning the ring from VRS_RESET to VRS_RUN involves taking multiple mutexes and spawning a thread.  There\u0027s probably dozens of membar-inducing instructions executed before it can reach that state."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1199,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Was it erroneous to have called this after doing the viona_ring_reset()?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1199,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yes, it was something I noticed while reworking how rx state changes related to the rings."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1588,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess it was a bug that we weren\u0027t clearing this before?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1588,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Correct, although it didn\u0027t seem to matter in practice."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2541,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do you use freemsgchain above, but not here?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2541,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The current promisc semantics dictate that we get a single mblk at a time (b_next \u003d\u003d NULL, as asserted above).  If that invariant changes, then all the logic here must be updated."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2541,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why don\u0027t we write it assuming we will have a chain, in which case if there are changes or our assumption is incorrect, we\u0027ll be in better shape?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2541,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sure, I can do that."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2573,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Same freemsgchain bit."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":119,"deletions":-26}],"sizeInsertions":119,"sizeDeletions":-26},{"number":"3","revision":"2b79ad82719efe93532a925c32ceb9b7e1b34e8e","parents":["c248e2484c2c0a42913ce48e21031d119c63fe45"],"ref":"refs/changes/33/6033/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1554234624,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554238770,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554235005,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":137,"deletions":-26}],"sizeInsertions":137,"sizeDeletions":-26},{"number":"4","revision":"bdc34a2805859a9d61dc3cf38c88febfe3bc2a42","parents":["6aaf159ea324821122771dc6552e8ed77cc1f8fe"],"ref":"refs/changes/33/6033/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1554492462,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554238770,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554235005,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554493988,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":137,"deletions":-26}],"sizeInsertions":137,"sizeDeletions":-26},{"number":"5","revision":"612105196284ddb8eec2a5c95608a3f4c07dc047","parents":["ff1603a29d41ea115360ea42106b5881d604c113"],"ref":"refs/changes/33/6033/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1554499141,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554238770,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554235005,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554493988,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":137,"deletions":-26}],"sizeInsertions":137,"sizeDeletions":-26},{"number":"6","revision":"9a8207fa35a4a0b13b30000d6ead058c47c0ccc3","parents":["ff1603a29d41ea115360ea42106b5881d604c113"],"ref":"refs/changes/33/6033/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1554499215,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554238770,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1554499354,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554235005,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554493988,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":137,"deletions":-26}],"sizeInsertions":137,"sizeDeletions":-26}],"allReviewers":[{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}