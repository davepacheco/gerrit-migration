From f492aa07593262a31a1f82b1288df5e8be3ecfd9 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Fri, 29 Sep 2017 01:16:16 +0000
Subject: [PATCH] MANTA-3426 Want tool to show shard information on object
 prior to it existing

---
 lib/server.js | 31 +++++++++++++++++++++++++++++++
 package.json  |  2 +-
 2 files changed, 32 insertions(+), 1 deletion(-)

diff --git a/lib/server.js b/lib/server.js
index 51f7ce0..61cadbc 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -87,6 +87,7 @@ function createServer(options) {
             server.rpc('findObjects', findObjects(opts));
             server.rpc('getBucket', getBucket(opts));
             server.rpc('getObject', getObject(opts));
+            server.rpc('getShard', getShard(opts));
             server.rpc('getTokens', getTokens(opts));
             server.rpc('putObject', putObject(opts));
             server.rpc('sql', sql(opts));
@@ -489,6 +490,36 @@ function getObject(options) {
     return _getObject;
 }
 
+function getShard(options) {
+    assert.object(options, 'options');
+    assert.object(options.log, 'options.log');
+    assert.object(options.clients, 'options.clients');
+
+    function _getShard(b, k, opts, res) {
+        var id = opts.req_id || uuid.v1();
+
+        var log = options.log.child({
+            req_id: id
+        });
+
+        log.debug({
+            bucket: b,
+            key: k,
+            opts: opts
+        }, 'getShard: entered');
+
+        options.ring.getNode(b, k, function (err, node) {
+            if (err) {
+                res.end(err);
+                return (undefined);
+            }
+            res.end(node);
+        });
+    }
+
+    return _getShard;
+}
+
 function delObject(options) {
     assert.object(options, 'options');
     assert.object(options.log, 'options.log');
diff --git a/package.json b/package.json
index c7bb04d..0800ee6 100644
--- a/package.json
+++ b/package.json
@@ -18,7 +18,7 @@
         "fast": "0.3.8",
         "ldapjs": "0.6.3",
         "imgapi-cli": "git+https://github.com/joyent/sdc-imgapi-cli.git#db3efc1",
-        "moray": "^3.0.0",
+        "moray": "file:../node-moray",
         "node-uuid": "1.4.0",
         "posix-getopt": "^1.0.0",
         "strsplit": "1.0.0",
-- 
2.21.0

