commit 860cadc8438720f5ec54a0a774faebf3307ee3a3
Author: Todd Whiteman <todd.whiteman@joyent.com>
Date:   2019-08-23T12:58:35-07:00 (6 weeks ago)
    
    TRITON-1814 vm losing all nics within an hour of `sdc-migrate`

diff --git a/lib/net-agent.js b/lib/net-agent.js
index 55e246e..c90f1e3 100644
--- a/lib/net-agent.js
+++ b/lib/net-agent.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -245,14 +245,35 @@ NetAgent.prototype.updateVMs = function (vms) {
 
     self.insts = {};
 
+    self.log.info({num_vms: vms.length}, 'updateVMs');
+
     vms.forEach(function (vm) {
         var vfsm;
 
         if (mod_jsprim.hasKey(prev, vm.uuid)) {
             vfsm = prev[vm.uuid];
-            vfsm.update(vm);
+            /*
+             * TRITON-1814: Ignore network changes for vm's that are migrating.
+             * This is when a vm existed, but is now hidden by the
+             * do_not_inventory flag. Keep the InstanceFSM around in case the
+             * do_not_inventory flag is later removed, but don't call
+             * vfsm.update() nor vfsm.remove() whilst the do_not_inventory flag
+             * is set.
+             */
+            if (vm.do_not_inventory) {
+                self.log.info({vm_uuid: vm.uuid},
+                    'Ignoring vm.update for vm with do_not_inventory set');
+            } else {
+                vfsm.update(vm);
+                self.log.info({vm_uuid: vm.uuid}, 'updated vm');
+            }
 
             delete prev[vm.uuid];
+        } else if (vm.do_not_inventory) {
+            // Ignore first time seeing a vm with do_not_inventory set.
+            self.log.debug({vm_uuid: vm.uuid},
+                'Ignoring vm with do_not_inventory set');
+            return;
         } else {
             vfsm = new InstanceFSM({
                 uuid: vm.uuid,
diff --git a/lib/vmadm-watcher-fsm.js b/lib/vmadm-watcher-fsm.js
index 75690d2..02ae759 100644
--- a/lib/vmadm-watcher-fsm.js
+++ b/lib/vmadm-watcher-fsm.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 'use strict';
@@ -236,10 +236,12 @@ VmadmEventsFSM.prototype.handleEvent = function (ev) {
 VmadmEventsFSM.prototype.getCurrentVMs = function () {
     var self = this;
 
+    /*
+     * Convert the vms hash object into an array. Note that we don't filter
+     * out vms with do_not_inventory set (see TRITON-1814 for reasons).
+     */
     var vms = Object.keys(self.vms).map(function (uuid) {
         return self.vms[uuid];
-    }).filter(function (vm) {
-        return !vm.do_not_inventory;
     });
 
     return vms;
diff --git a/lib/watcher-fsm.js b/lib/watcher-fsm.js
index 3131762..687bdea 100644
--- a/lib/watcher-fsm.js
+++ b/lib/watcher-fsm.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 'use strict';
@@ -28,7 +28,8 @@ var FIELDS = [
     'zone_state',
     'nics',
     'resolvers',
-    'routes'
+    'routes',
+    'do_not_inventory'
 ];
 
 var STATE_WATCHER_TIMEOUT = 5 * 60 * 1000;
@@ -245,7 +246,7 @@ WatcherFSM.prototype.state_refresh = function (S) {
 
     self.vmadm.lookup({}, {
         log: self.log,
-        include_dni: false,
+        include_dni: true,
         fields: FIELDS
     }, S.callback(afterLookup));
 };
diff --git a/package.json b/package.json
index 3cee79c..95362cf 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "net-agent",
     "description": "Triton Network Agent",
-    "version": "2.3.0",
+    "version": "2.3.1",
     "author": "Joyent (joyent.com)",
     "private": true,
     "dependencies": {
