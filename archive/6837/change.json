{"project":"joyent/sdc-net-agent","branch":"master","id":"I90776000441d1973ec908a08f020b342dfd57ac1","number":"6837","subject":"TRITON-1814 vm losing all nics within an hour of `sdc-migrate` Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/6837","commitMessage":"TRITON-1814 vm losing all nics within an hour of `sdc-migrate`\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1566590316,"lastUpdated":1568044303,"open":false,"status":"MERGED","comments":[{"timestamp":1566590316,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1566590317,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit e91fd26e441b78c7ef094dae81310bfa1721c657\n    \n    TRITON-1814 vm losing all nics within an hour of `sdc-migrate`"},{"timestamp":1566590376,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1566590410,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2."},{"timestamp":1566590412,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 5ea3d1e69ae5dd65cd141d871026186615d05bdb\n    \n    remove log line"},{"timestamp":1566590470,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1566598631,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1566601888,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1567029088,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1567808171,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3."},{"timestamp":1567808172,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit f26a69c0954bd691c8309dea639ad150d6d36685\n    \n    move fsm\u0027s to state stopped for DNI instances"},{"timestamp":1567808228,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1567808396,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nTested this on my local datacenter. I could reproduce the disappearing NICs before this change, after this change the NICs were no longer deleted during a migration."},{"timestamp":1568021827,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nI assume it\u0027s safe to IA+1 too given you\u0027ve already tested it."},{"timestamp":1568042797,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1568044303,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"4","revision":"90776000441d1973ec908a08f020b342dfd57ac1","parents":["13bf32aa0dfae15369c7c61478076d2703978431"],"ref":"refs/changes/37/6837/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1568042797,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1567808228,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568021827,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568021827,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1568044303,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":32,"deletions":-1},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":28,"deletions":-1},{"file":"lib/vmadm-watcher-fsm.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/watcher-fsm.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/rsync-to","type":"MODIFIED","insertions":9,"deletions":-3}],"sizeInsertions":98,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"860cadc8438720f5ec54a0a774faebf3307ee3a3","parents":["13bf32aa0dfae15369c7c61478076d2703978431"],"ref":"refs/changes/37/6837/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1566590316,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1566590376,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":23,"deletions":-2},{"file":"lib/vmadm-watcher-fsm.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/watcher-fsm.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-9},{"number":"2","revision":"e6060b03b7f66ab020fcc36c3830694a6bee93ce","parents":["13bf32aa0dfae15369c7c61478076d2703978431"],"ref":"refs/changes/37/6837/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1566590410,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1566590470,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/net-agent.js","line":264,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"In addition to ignoring this when \"do_not_inventory\" goes from false to true, I think we should also stop the instance\u0027s NicFSM, so that the two net-agent\u0027s aren\u0027t both trying to periodically update the \"cn_uuid\".\n\nI think the best way to do this is to add a .stop() method to both InstanceFSM and NicFSM, that causes them to both go to a stopped state. (NicFSM already has one, so it just needs a method, \"stopAsserted\" event, and listeners in the other states that do the transition.)"},{"file":"lib/net-agent.js","line":264,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I\u0027m not sure I grok how the FSM stuff works - do you have a primer for how these S.gotoStateOn() and handling of parallel events work?\n\nE.g. if the nic fsm is in state \u0027update.napi\u0027 - and it\u0027s made the updateNic() PUT to NAPI, which event handler will win if a \u0027stopAsserted\u0027 event is fired, does this \"afterPut\" handler also fire, and if so does \"afterPut\" now need to check if the nic moved to a stopped state?"},{"file":"lib/net-agent.js","line":264,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"The node-mooremachine README goes into this a bit more in depth, but the core idea is that when you move between different states, the event handlers and timeouts get torn down. Whatever event fires first will synchronously trigger a state transition. Any event listeners or timers will be removed, and the code in the target state will be run.\n\nIn the NicFSM for e.g., in state \u0027update.napi\u0027, if \u0027stopAsserted\u0027 fires before the afterPut() handler is called, then we would transition to the \u0027stopped\u0027 state, and afterPut() will never be called (due to the S.callback() wrapper). If afterPut() has run, then we\u0027ll either move into the \u0027remove\u0027 state, or wait 5 seconds before retrying. If a \u0027stopAsserted\u0027 event fires in that 5 second window, then we\u0027d transition to the \u0027stopped\u0027 state."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":22,"deletions":-2},{"file":"lib/vmadm-watcher-fsm.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/watcher-fsm.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":32,"sizeDeletions":-9},{"number":"3","revision":"65f26c13e4637e15771beb82e2956d3dd1ecac03","parents":["13bf32aa0dfae15369c7c61478076d2703978431"],"ref":"refs/changes/37/6837/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1567808171,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1567808228,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568021827,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568021827,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":32,"deletions":-1},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":28,"deletions":-1},{"file":"lib/vmadm-watcher-fsm.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/watcher-fsm.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/rsync-to","type":"MODIFIED","insertions":9,"deletions":-3}],"sizeInsertions":98,"sizeDeletions":-13},{"number":"4","revision":"90776000441d1973ec908a08f020b342dfd57ac1","parents":["13bf32aa0dfae15369c7c61478076d2703978431"],"ref":"refs/changes/37/6837/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1568042797,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1567808228,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568021827,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568021827,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1568044303,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":32,"deletions":-1},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":28,"deletions":-1},{"file":"lib/vmadm-watcher-fsm.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/watcher-fsm.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/rsync-to","type":"MODIFIED","insertions":9,"deletions":-3}],"sizeInsertions":98,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}