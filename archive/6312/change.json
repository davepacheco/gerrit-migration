{"project":"joyent/boray","branch":"master","id":"I0e4764d2fc1a26e515de37200a8876d45d766bda","number":"6312","subject":"MANTA-4169 Add full complement of metrics to boray Reviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e Reviewed by: Michael Zeller \u003cmike.zeller@joyent.com\u003e Approved by: Michael Zeller \u003cmike.zeller@joyent.com\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/6312","commitMessage":"MANTA-4169 Add full complement of metrics to boray\nReviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\nReviewed by: Michael Zeller \u003cmike.zeller@joyent.com\u003e\nApproved by: Michael Zeller \u003cmike.zeller@joyent.com\u003e\n","createdOn":1558107438,"lastUpdated":1559849825,"open":false,"status":"MERGED","comments":[{"timestamp":1558107438,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1558107441,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 890862d9574035ed725f96c746495905500e3716\n    \n    initial commit"},{"timestamp":1558107443,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n deps/eng/tools/mk/Makefile.targ:269: recipe for target \u0027check-rust\u0027 failed\n gmake: *** [check-rust] Error 127"},{"timestamp":1559319138,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1559319141,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 68399edd8da71d6909091fb01147289e4be14f90\n    \n    initial commit"},{"timestamp":1559319142,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n deps/eng/tools/mk/Makefile.targ:269: recipe for target \u0027check-rust\u0027 failed\n gmake: *** [check-rust] Error 127"},{"timestamp":1559319149,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2: Code-Review-1\n\nnot ready"},{"timestamp":1559588380,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1559588383,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit c7ae1cf7f8c8e7663a4f9180a42141e304b0bfb0\n    \n    add postgres metrics"},{"timestamp":1559588384,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:269: check-rust] Error 127"},{"timestamp":1559588391,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3: -Code-Review"},{"timestamp":1559594594,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1559659278,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1559660988,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1559674335,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1559674831,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4."},{"timestamp":1559674834,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 1a18a404be72f42815cf66b87fc553e5485d31af\n    \n    changes based on kelly and mike review"},{"timestamp":1559674835,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:269: check-rust] Error 127"},{"timestamp":1559674907,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1559677349,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1559677388,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1559677448,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1559682673,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1559758717,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5."},{"timestamp":1559758721,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 1b57ea7dead3109df77da8046340faebaae6457d\n    \n    make method an enum"},{"timestamp":1559758722,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:269: check-rust] Error 127"},{"timestamp":1559759211,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1559759711,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 6."},{"timestamp":1559759712,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1559759715,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:269: check-rust] Error 127"},{"timestamp":1559759715,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 40acebb97f1cc9625e807446d469648692da53e6\n    \n    s/Bucket/Object/"},{"timestamp":1559760050,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1559761739,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1559770262,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1559770269,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 7."},{"timestamp":1559770273,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/boray.xml\n cargo check\n gmake: cargo: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:269: check-rust] Error 127"},{"timestamp":1559770273,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 03493048ffa93136de5249b2dd7530b516697c40\n    \n    changes based on zeller review"},{"timestamp":1559848072,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7: Code-Review+1\n\nI\u0027ll built an image with PS7 and deployed it to my lab and it\u0027s looking good."},{"timestamp":1559849587,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1559849788,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1559849825,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"8","revision":"0e4764d2fc1a26e515de37200a8876d45d766bda","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/8","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559849788,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559770273,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559848072,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559849587,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559849587,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"SUBM","value":"1","grantedOn":1559849825,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":42,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"src/sql.rs","type":"ADDED","insertions":118,"deletions":0}],"sizeInsertions":229,"sizeDeletions":-50},"patchSets":[{"number":"1","revision":"9a5a9fea881b63e841fc0456c6769b8eec729b9e","parents":["0f2ae306b67c66417bc760e37c51ea0809ae68e4"],"ref":"refs/changes/12/6312/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1558107438,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1558107443,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/lib.rs","type":"MODIFIED","insertions":38,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":7,"deletions":-1}],"sizeInsertions":45,"sizeDeletions":-16},{"number":"2","revision":"5732c3f3605c886299559dd8ec32a4ac27e95f17","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559319138,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1558107443,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1559319149,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/lib.rs","type":"MODIFIED","insertions":38,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":7,"deletions":-1}],"sizeInsertions":45,"sizeDeletions":-16},{"number":"3","revision":"2d1e890a0f88a3aa984e8f8a907a03f32eaa4cc9","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559588380,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559588384,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/lib.rs","line":62,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"An alternative to the early return here would be to call `and_then` on `res` and that would let you handle the metrics generation only for the success case. This would work since the function return is still a `Result` type so the error would still be returned if the method name didn\u0027t match any cases and the metric logic only run if there was a match. \n\nNot suggesting you change it. I\u0027m just pointing out a different way it could be done for the sake of learning."},{"file":"src/sql.rs","line":16,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"We might consider creating a `Method` `enum` type  to use here instead of `str`. I tend to avoid raw strings as much as possible because the type system can\u0027t do anything to help you when you screw those up whereas if you use something other than a `Method` type the compiler will let you know about it. Then we add a `ToString` instance for the `Method` type and it should work just the same as it does now with the raw strings."},{"file":"src/sql.rs","line":16,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So, this \"method\" variable here is not the same as the RPC method (\"getbucket\", \"deletebucket\", etc.).  It\u0027s a string meant to identify the SQL command this is being run (since a single RPC command could have more than 1 SQL statement run as a result.  The method names look like \"bucket get (get_sql)\".  They are fairly adhoc and meant to identify the SQL statement being run from the perspective of metrics.\n\nDoes it make sense to enum every possible SQL variant?"},{"file":"src/sql.rs","line":16,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I would probably still do it since there\u0027s really only a handful and adding new ones as they came up should be pretty easy, but I can also see the argument for it just being a more free form annotation of a query being run. I\u0027m good with whichever direction you want to go with it."},{"file":"src/sql.rs","line":18,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"The actual `Client` has execute generic over T where `T: ToStatement, ` for the sql arg.  Might be nice to accept the same thing for future flexibility."},{"file":"src/sql.rs","line":18,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"src/sql.rs","line":64,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"These four helpers all look so similar I\u0027d be tempted to factor out the commonality and just pass in a closure to do the actual postgres interaction. It wouldn\u0027t make a huge difference, but my brain can\u0027t help pattern matching."},{"file":"src/sql.rs","line":64,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I think Kelly is suggesting something like the following. \n\nhttps://play.rust-lang.org/?version\u003dstable\u0026mode\u003ddebug\u0026edition\u003d2018\u0026gist\u003db421338a7f74ce4f210aa2c2f1c34719\n\n(Same code below with gerrit messed up formatting)\n\n```\nuse std::fs::File;\nuse std::io::Error; // replace with postgres error\nuse std::time::Instant;\n\nfn req_with_metrics\u003cF, T\u003e(method: \u0026str, f: F) -\u003e Result\u003cT, Error\u003e\nwhere\n    F: FnOnce() -\u003e Result\u003cT, Error\u003e,\n{\n    let now \u003d Instant::now();\n    let res \u003d f();\n    // post_timer_metrics(\u0026method, now, res.is_ok());\n    res\n}\n\nfn main() {\n    let _file \u003d req_with_metrics(\"get\", || File::open(\"/etc/passwd\"));\n}\n```"},{"file":"src/sql.rs","line":64,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"src/sql.rs","line":87,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"You might be able to lean on the `Display` instance for bool here instead of this. \n\n```\nformat!(\"{}\", success);\n```"},{"file":"src/sql.rs","line":87,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Using format with the `Display` trait will cause a `String` allocation.  Might be nicer to keep the match or do something like:\n\nlet success \u003d if success {\"true\"} else {\"false\"};\n\nWhich will result in \"success\" being an `\u0026str`."},{"file":"src/sql.rs","line":87,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Unless either of you feel strongly about this, I\u0027ll leave it as-is with this match statement."},{"file":"src/sql.rs","line":87,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"That\u0027s fine. I was disappointed there was no `ToString` instance for `bool`, but yeah just leaving it is fine by me."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":39,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":36,"deletions":-23},{"file":"src/sql.rs","type":"ADDED","insertions":93,"deletions":0}],"sizeInsertions":200,"sizeDeletions":-49},{"number":"4","revision":"fc0b8f0666e04f685f301aa9bc2f989433e38a55","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559674831,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559674835,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/object.rs","line":456,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This happened automatically on my end (the indentation changes).  Is there a preferred way to ident this?"},{"file":"src/object.rs","line":456,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I wouldn\u0027t worry about it. We should probably just do a rustfmt CR at some point for all the code and it can handle formatting it then."},{"file":"src/sql.rs","line":86,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I may be wrong about this because I am not familiar with the prometheus crate yet but it seems like you could change the `sql_with_metrics` function to:\n\n```\nfn sql_with_metrics\u003cF, T\u003e(method: \u0026str, f: F) -\u003e Result\u003cT, PGError\u003e\nwhere\n    F: FnOnce() -\u003e Result\u003cT, PGError\u003e,\n{\n    let metrics \u003d metrics::POSTGRES_REQUESTS\n        .with_label_values(\u0026[\u0026method, success])\n        .start_timer();\n\n    let res \u003d f();\n    // drop(metrics)\n    // or\n    // metrics.observe_duration();\n    res\n    // or do nothing and let metrics drop and which triggers the observe anyways.\n}\n```"},{"file":"src/sql.rs","line":86,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"For reference: https://docs.rs/prometheus/0.6.1/prometheus/local/struct.LocalHistogram.html#method.start_timer"},{"file":"src/sql.rs","line":86,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"You already mentioned this in the chat but i\u0027ll put it here as well - I use this API because the buckets name (namely, the \"success\" bool) isn\u0027t known at the beginning of the function.  Instead, we must manage the timer ourselves."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":39,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":36,"deletions":-23},{"file":"src/sql.rs","type":"ADDED","insertions":87,"deletions":0}],"sizeInsertions":194,"sizeDeletions":-49},{"number":"5","revision":"09a36fb9345d1e24c96c75d0a8a88d81d52c2585","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559758717,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559758722,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/object.rs","line":542,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Should this be ObjectDeleteMove?"},{"file":"src/object.rs","line":542,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"ha whoops. good catch. yes it should be."},{"file":"src/object.rs","line":547,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Should this be ObjectDelete?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":39,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":36,"deletions":-23},{"file":"src/sql.rs","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":226,"sizeDeletions":-49},{"number":"6","revision":"43abd74752f770cdf012c19e50134a836cc2ff8d","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/6","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559759711,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559759715,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559760050,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"comments":[{"file":"src/lib.rs","line":72,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"This is used in multiple files.  You could just steal the exact function that the prometheus crate uses and reuse it:\n\nfn duration_to_seconds(d: Duration) -\u003e f64 {\n    let nanos \u003d f64::from(d.subsec_nanos()) / 1e9;\n    d.as_secs() as f64 + nanos\n}"},{"file":"src/lib.rs","line":72,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"src/sql.rs","line":107,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Same as the timer comment in other file."},{"file":"src/sql.rs","line":107,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":39,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"src/sql.rs","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":227,"sizeDeletions":-50},{"number":"7","revision":"08041bb4d126958a8068b203f190c9a7202398ab","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/7","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559770269,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559770273,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559849587,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559849587,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559848072,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":42,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"src/sql.rs","type":"ADDED","insertions":118,"deletions":0}],"sizeInsertions":229,"sizeDeletions":-50},{"number":"8","revision":"0e4764d2fc1a26e515de37200a8876d45d766bda","parents":["93823001f47917340e716d5fe6606f38322bd8fd"],"ref":"refs/changes/12/6312/8","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1559849788,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559770273,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1559849825,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559849587,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559849587,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559848072,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"src/lib.rs","type":"MODIFIED","insertions":42,"deletions":-15},{"file":"src/metrics.rs","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"src/object.rs","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"src/sql.rs","type":"ADDED","insertions":118,"deletions":0}],"sizeInsertions":229,"sizeDeletions":-50}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}]}