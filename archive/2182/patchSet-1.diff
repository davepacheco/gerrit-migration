From 4808439a3435a65554ef842f97f054ed7f7b7e33 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 4 Jul 2017 09:01:02 +0200
Subject: [PATCH] TOOLS-1771 Add "--skip-latest-symlink" option to `sdcadm
 experimental update-agents`

---
 lib/cli/do_update_agents.js | 33 +++++++++++++++++++++++++--------
 1 file changed, 25 insertions(+), 8 deletions(-)

diff --git a/lib/cli/do_update_agents.js b/lib/cli/do_update_agents.js
index b04760e..70acb87 100644
--- a/lib/cli/do_update_agents.js
+++ b/lib/cli/do_update_agents.js
@@ -51,6 +51,8 @@ function updateAgents(options, callback) {
     assert.object(options.sdcadm, 'options.sdcadm');
     assert.string(options.agentsshar, 'options.agentsshar');
     assert.optionalBool(options.justDownload, 'options.justDownload');
+    assert.optionalBool(options.skipLatestSymlink,
+        'options.skipLatestSymlink');
     assert.optionalBool(options.yes, 'options.yes');
     assert.optionalBool(options.all, 'options.all');
     assert.optionalArrayOfString(options.servers, 'options.servers');
@@ -72,10 +74,9 @@ function updateAgents(options, callback) {
     var filepath;
     var channel;
     var image;
-    // The file name, to be used by ur:
-    var fname;
     var progress = options.progress;
     var justDownload = options.justDownload;
+    var skipLatestSymlink = options.skipLatestSymlink;
     var hist;
 
     function setImageToLatest(cb) {
@@ -465,8 +466,13 @@ function updateAgents(options, callback) {
             });
         },
 
-        function createLatestSymlink(_, next) {
-            if (justDownload) {
+        function setFileName(ctx, next) {
+            ctx.fname = path.basename(filepath);
+            next();
+        },
+
+        function createLatestSymlink(ctx, next) {
+            if (justDownload ||Â skipLatestSymlink) {
                 next();
                 return;
             }
@@ -478,12 +484,12 @@ function updateAgents(options, callback) {
                         'Unable to remove % symlink', symlink));
                     return;
                 }
-                fname = path.basename(filepath);
-                fs.symlink(fname, symlink, function (symlinkErr) {
+
+                fs.symlink(ctx.fname, symlink, function (symlinkErr) {
                     if (symlinkErr) {
                         next(new VError(symlinkErr,
                             'Unable to create "latest" symlink to "%s"',
-                            fname));
+                            ctx.fname));
                         return;
                     }
                     next();
@@ -500,7 +506,7 @@ function updateAgents(options, callback) {
                 ctx.urServersToUpdate.length);
 
             var ip = sdcadm.config.assets_admin_ip;
-            var f = fname;
+            var f = ctx.fname;
             var ff = '/var/tmp/' + f;
             // Do not override log file if we run installer more than once for
             // the same version.
@@ -851,6 +857,7 @@ function do_update_agents(subcmd, opts, args, cb) {
         agentsshar: agentsshar,
         progress: self.progress,
         justDownload: opts.just_download,
+        skipLatestSymlink: opts.skip_latest_symlink,
         yes: opts.yes,
         servers: servers,
         all: opts.all,
@@ -877,6 +884,10 @@ do_update_agents.help = (
     'UUID or hostname. In a larger datacenter, getting a list of the wanted\n' +
     'servers can be a chore. The "sdc-server lookup ..." tool is useful for this.\n' +
     '\n' +
+    'Symlink to \'/usbkey/extra/agents/latest\' is modified to point to the\n' +
+    'file downloaded unless "--skip-latest-symlink" option is given. (This file \n' +
+    'is used to setup agents into new servers being setup).\n' +
+    '\n' +
     'Examples:\n' +
     '    # Update to the latest agentsshar on all setup servers.\n' +
     '    {{name}} update-agents --latest --all\n' +
@@ -906,6 +917,12 @@ do_update_agents.options = [
         type: 'bool',
         help: 'Download the agents installer for later usage.'
     },
+    {
+        names: ['skip-latest-symlink'],
+        type: 'bool',
+        help: 'Do not modify the file pointed at by ' +
+            '\'/usbkey/extra/agents/latest\' symlink.'
+    },
     {
         names: ['all', 'a'],
         type: 'bool',
-- 
2.21.0

