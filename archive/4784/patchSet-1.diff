commit 4f59e462702cfeaf917cb90fc8039d029b801cdc (refs/changes/84/4784/1)
Author: Josh Wilsdon <josh@wilsdon.ca>
Date:   2018-09-04T15:51:04-07:00 (1 year, 1 month ago)
    
    TRITON-703 NAPI should use latest node-triton-metrics and expose nodejs metrics

diff --git a/lib/napi.js b/lib/napi.js
index 6d1147b..97fbdce 100644
--- a/lib/napi.js
+++ b/lib/napi.js
@@ -108,6 +108,7 @@ function NAPI(opts) {
     });
 
     this.metricsManager.createRestifyMetrics();
+    this.metricsManager.createNodejsMetrics();
     this.metricsManager.listen(function metricsServerStarted() {});
 
     function populateReq(req, res, next) {
@@ -287,6 +288,8 @@ NAPI.prototype.state_init.moray = function (S) {
         level: self.config.moray.logLevel || 'info'
     });
 
+    conf.collector = self.metricsManager.collector;
+
     self.moray = moray.createClient(conf);
 
     S.on(self.moray, 'connect', function onMorayConnect() {
diff --git a/package.json b/package.json
index a86c94b..3acf8c6 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "napi",
   "description": "SmartDataCenter Networking API",
-  "version": "1.3.1",
+  "version": "1.4.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -16,7 +16,7 @@
     "lomstream": "1.1.0",
     "macaddr": "0.0.1",
     "mooremachine": "2.2.0",
-    "moray": "3.4.2",
+    "moray": "3.5.0",
     "node-uuid": "1.4.8",
     "portolan-moray": "git+https://github.com/joyent/sdc-portolan-moray.git#7e2c4ca",
     "restify": "4.3.0",
@@ -24,7 +24,7 @@
     "sdc-clients": "11.1.0",
     "tape": "4.5.1",
     "trace-event": "1.3.0",
-    "triton-metrics": "0.1.1",
+    "triton-metrics": "0.4.0",
     "vasync": "1.6.4",
     "verror": "1.9.0"
   },
