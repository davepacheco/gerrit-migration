{"project":"joyent/sdc-napi","branch":"master","topic":"PUBAPI-1378","id":"I8a1cfbac582a0fe9c0fbdf1e58414c7899eec3a2","number":"3563","subject":"PUBAPI-1378 Provide UpdateFabricNetwork endpoint Reviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e Approved by: Cody Peter Mello \u003cmelloc@writev.io\u003e","owner":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"url":"https://cr.joyent.us/3563","commitMessage":"PUBAPI-1378 Provide UpdateFabricNetwork endpoint\nReviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e\nApproved by: Cody Peter Mello \u003cmelloc@writev.io\u003e\n","createdOn":1520528786,"lastUpdated":1530181840,"open":false,"status":"MERGED","comments":[{"timestamp":1520528786,"reviewer":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"message":"Uploaded patch set 1."},{"timestamp":1520528787,"reviewer":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 198374f46a582b57f1dc8d5532332ba15552d995\n    \n    PUBAPI-1378 Provide UpdateFabricNetwork endpoint"},{"timestamp":1520528854,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520539064,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1520539839,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Topic set to PUBAPI-1378"},{"timestamp":1529505928,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1529505932,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit fed467105131f96cff2c753dcebf214f489962d9\n    \n    PUBAPI-1378 Provide UpdateFabricNetwork endpoint\n    \n    commit b5dbacef76d4bfcc852ca659e8a0d302058e8768\n    \n    TRITON-504 NAPI unit tests broken by TRITON-474\n    Reviewed by: Mike Zeller \u003cmike.zeller@joyent.com\u003e\n    Approved by: Mike Zeller \u003cmike.zeller@joyent.com\u003e"},{"timestamp":1529505990,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529506159,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nCody, I\u0027ll try to go through the previous patchset comments later today. So far everything seems to be working fine together"},{"timestamp":1529593606,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1529941326,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1529941330,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 86752289a94095f7a8468ee699b5d14818289d72\n    \n    PUBAPI-1378 Provide UpdateFabricNetwork endpoint\n    \n    commit b5dbacef76d4bfcc852ca659e8a0d302058e8768\n    \n    TRITON-504 NAPI unit tests broken by TRITON-474\n    Reviewed by: Mike Zeller \u003cmike.zeller@joyent.com\u003e\n    Approved by: Mike Zeller \u003cmike.zeller@joyent.com\u003e"},{"timestamp":1529941393,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529946030,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1529946034,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit a44aa0115ed21b776f9878a7e9d467f9923b10f9\n    \n    PUBAPI-1378 Provide UpdateFabricNetwork endpoint\n    \n    commit b5dbacef76d4bfcc852ca659e8a0d302058e8768\n    \n    TRITON-504 NAPI unit tests broken by TRITON-474\n    Reviewed by: Mike Zeller \u003cmike.zeller@joyent.com\u003e\n    Approved by: Mike Zeller \u003cmike.zeller@joyent.com\u003e"},{"timestamp":1529946102,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530023163,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1530057606,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1530122319,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1530122324,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit e78b6220b863ef80344af8591df5da941a846521\n    \n    PUBAPI-1378 Provide UpdateFabricNetwork endpoint\n    \n    commit b5dbacef76d4bfcc852ca659e8a0d302058e8768\n    \n    TRITON-504 NAPI unit tests broken by TRITON-474\n    Reviewed by: Mike Zeller \u003cmike.zeller@joyent.com\u003e\n    Approved by: Mike Zeller \u003cmike.zeller@joyent.com\u003e"},{"timestamp":1530122377,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(3 comments)\n\nThanks for the CR Cody. Changes made as suggested, tests happily passing now."},{"timestamp":1530122389,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530124112,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1530181814,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1530181840,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"6","revision":"8a1cfbac582a0fe9c0fbdf1e58414c7899eec3a2","parents":["74cfb2f28b74908e44b467eb83049b337a45037d"],"ref":"refs/changes/63/3563/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530181814,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530122389,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530124112,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530124112,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1530181840,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":48,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":109,"deletions":-19},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":172,"sizeDeletions":-27},"patchSets":[{"number":"1","revision":"be21bbaa6fd4203a4227642609aa73f18bf3005c","parents":["1a0b793b3f5a72bdcac08d841b2d1fdd0124e75b"],"ref":"refs/changes/63/3563/1","uploader":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"createdOn":1520528786,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520528854,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":953,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Currently \"gateway\" and \"vlan_id\" are immutable fields. We should probably mention that you can\u0027t currently update them."},{"file":"docs/index.md","line":970,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t know if you were planning on putting an example here or not, but if not we should remove the header here."},{"file":"lib/endpoints/fabrics/networks.js","line":149,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We can remove this disabling comment now. It was here while this endpoint was unused."},{"file":"lib/endpoints/fabrics/networks.js","line":152,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This should remain as reqOpts(req), since that takes care of copying across the owner_uuid."},{"file":"test/integration/fabrics.test.js","line":631,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should also have tests for bad updates like::\n\n- missing fields\n- different owner_uuid\n- bad values for a field\n\nWe don\u0027t currently check that the owner_uuid is correct for the network on update. \n\nWe can fix this in one of two ways: we can update ensureNetworkExists() to pass along the owner_uuid in the options, or we can update the updateNetwork() function in lib/models/network.js to do a getNetwork() and force an owner check similar to deleteNetwork()."},{"file":"test/integration/fabrics.test.js","line":631,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done, but for the test of missing fields: All of the fields are optional here but the network UUID and the Owner used by getNetwork()"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":23,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":80,"deletions":-18},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":122,"sizeDeletions":-28},{"number":"2","revision":"44b9d683924ef9e37af4c4a2ac8ed62113675987","parents":["74cfb2f28b74908e44b467eb83049b337a45037d"],"ref":"refs/changes/63/3563/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529505928,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529505990,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":979,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Cody had some comments on a previous patchset such as:\n- Provide an example\n- Mention that fields like vlan_id and gateway are immutable"},{"file":"test/integration/fabrics.test.js","line":762,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Would be nice to have the tests Cody mentioned in patchset 1\n\nWe should also have tests for bad updates like:\n\n    missing fields\n    different owner_uuid\n    bad values for a field"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":23,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":80,"deletions":-18},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":118,"sizeDeletions":-26},{"number":"3","revision":"4393f03d6baa510c0773e4dab8de1ff82707fb9a","parents":["74cfb2f28b74908e44b467eb83049b337a45037d"],"ref":"refs/changes/63/3563/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529941326,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529941393,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":48,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":80,"deletions":-18},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":143,"sizeDeletions":-26},{"number":"4","revision":"31ac956e1d51d917aea4cde4f7f711945a5f7c2a","parents":["74cfb2f28b74908e44b467eb83049b337a45037d"],"ref":"refs/changes/63/3563/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529946030,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529946102,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530023163,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"comments":[{"file":"docs/index.md","line":971,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Outside of this cr we should look into what would be involved in changing the gateway.  I suspect that its tied to the NAT instance in some way."},{"file":"test/integration/fabrics.test.js","line":694,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s write this as 172.16.0.0/24, since I would like to see this eventually become an error instead of silently truncating."},{"file":"test/integration/fabrics.test.js","line":694,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"test/integration/fabrics.test.js","line":774,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This is failing earlier than the network owner check because the VLAN doesn\u0027t exist for this owner. OWNERS[0] and OWNERS[1] do both have VLAN ID 43 though (VLANS[1] and VLANS[2]). You can do a combination like the following to get the \"network not found\" message:\n\n    t.test(\u0027update NETS[2]: incorrect owner (OWNERS[1])\u0027, function (t2) {\n        mod_fabric_net.update(t2, {\n            params: {\n                vlan_id: VLANS[1].vlan_id,\n                uuid: NETS[2].uuid,\n                owner_uuid: OWNERS[1]\n            },\n            expCode: 404,\n            expErr: {\n                code: \u0027ResourceNotFound\u0027,\n                message: \u0027network not found\u0027\n            }\n        });\n    });"},{"file":"test/integration/fabrics.test.js","line":774,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":48,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":111,"deletions":-19},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":174,"sizeDeletions":-27},{"number":"5","revision":"a15d375901fe2a93ecc8269368ce7e9d602d9f53","parents":["74cfb2f28b74908e44b467eb83049b337a45037d"],"ref":"refs/changes/63/3563/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530122319,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530124112,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530124112,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530122389,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":48,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":109,"deletions":-19},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":172,"sizeDeletions":-27},{"number":"6","revision":"8a1cfbac582a0fe9c0fbdf1e58414c7899eec3a2","parents":["74cfb2f28b74908e44b467eb83049b337a45037d"],"ref":"refs/changes/63/3563/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1530181814,"author":{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530124112,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530124112,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530122389,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1530181840,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":48,"deletions":0},{"file":"lib/endpoints/fabrics/common.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/endpoints/fabrics/networks.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/fabrics.test.js","type":"MODIFIED","insertions":109,"deletions":-19},{"file":"test/lib/fabric-net.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":172,"sizeDeletions":-27}],"allReviewers":[{"name":"Jeff Emershaw","email":"me@jeffemershaw.com","username":"jemershaw"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}