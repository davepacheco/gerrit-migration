From f6e89c660a9cce40ca46b4ad0eb7caa0b9af2b75 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 2 Mar 2018 17:43:02 -0800
Subject: [PATCH] TRITON-163 Triton should refuse to mix bhyve & kvm and send
 bhyve VMs only to capable nodes

---
 config/test.json              | 1 +
 package.json                  | 4 ++--
 sapi_manifests/cnapi/template | 1 +
 test/test-allocator.js        | 8 ++++----
 4 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/config/test.json b/config/test.json
index 521082c..a17cf26 100644
--- a/config/test.json
+++ b/config/test.json
@@ -72,6 +72,7 @@
           "calculate-ticketed-vms",
           "hard-filter-capness",
           "hard-filter-vm-count",
+          "hard-filter-hvm",
           "calculate-server-unreserved",
           "hard-filter-min-ram",
           "hard-filter-min-cpu",
diff --git a/package.json b/package.json
index adc3dba..39ffe24 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.7.1",
+  "version": "1.8.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -9,7 +9,7 @@
     "assert-plus": "1.0.0",
     "async": "1.5.2",
     "bunyan": "1.8.5",
-    "dapi": "git+https://github.com/joyent/sdc-designation.git#1fe6da24fdf1c948713e1857cf6b87e11c021788",
+    "dapi": "git+https://github.com/joyent/sdc-designation.git#af2b13ddc5dbe10a4511936ea46e6655bf6d4aab",
     "deep-equal": "1.0.1",
     "dox": "0.9.0",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
diff --git a/sapi_manifests/cnapi/template b/sapi_manifests/cnapi/template
index 3cc75fc..7ef6cd8 100644
--- a/sapi_manifests/cnapi/template
+++ b/sapi_manifests/cnapi/template
@@ -91,6 +91,7 @@
 			        "calculate-ticketed-vms",
 			        "hard-filter-capness",
 			        "hard-filter-vm-count",
+			        "hard-filter-hvm",
 			        "calculate-server-unreserved",
 			        "hard-filter-min-ram",
 			        "hard-filter-min-cpu",
diff --git a/test/test-allocator.js b/test/test-allocator.js
index 0a7669f..af66b6a 100644
--- a/test/test-allocator.js
+++ b/test/test-allocator.js
@@ -5,14 +5,13 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
  * test-allocator.js: Tests for server-selection endpoint.
  */
 
-var http    = require('http');
 var restify = require('restify');
 
 
@@ -23,9 +22,10 @@ var client;
 
 var allocData = {
     vm: {
-        vm_uuid: '7beee9e1-3488-4696-8a93-6403372bc150',
+        brand: 'joyent',
+        owner_uuid: 'e1f0e74c-9f11-4d80-b6d1-74dcf1f5aafb',
         ram: 128,
-        owner_uuid: 'e1f0e74c-9f11-4d80-b6d1-74dcf1f5aafb'
+        vm_uuid: '7beee9e1-3488-4696-8a93-6403372bc150'
     },
     image: {},
     package: {
-- 
2.21.0

