commit 57d09cabac7e7bf7c2c0d6f37a4408ad49583343 (refs/changes/49/449/2)
Author: Andrey Yatskov <andrey.yatskov@silvertreesystems.com>
Date:   2016-12-07T17:26:06+03:00 (2 years, 10 months ago)
    
    ADMINUI-2348 Upgrade to node v0.10.48

diff --git a/Makefile b/Makefile
index cf21c053..45527d8a 100644
--- a/Makefile
+++ b/Makefile
@@ -39,18 +39,14 @@ JSSTYLE_FLAGS    = -o "indent=2,doxygen,unparenthesized-return=0,line-length=120
 REPO_MODULES	 =
 SMF_MANIFESTS_IN = smf/manifests/adminui.xml.in
 
-NODE_PREBUILT_VERSION=v0.10.48
+
+NODE_PREBUILT_VERSION=v4.6.1
 NODE_PREBUILT_TAG=zone
 NODE_PREBUILT_IMAGE=fd2cc906-8938-11e3-beab-4359c665ac99
 
 
-
 include ./tools/mk/Makefile.defs
-ifeq ($(shell uname -s),SunOS)
-	include ./tools/mk/Makefile.node_prebuilt.defs
-else
-	include ./tools/mk/Makefile.node.defs
-endif
+include ./tools/mk/Makefile.node.defs
 include ./tools/mk/Makefile.smf.defs
 
 ROOT            := $(shell pwd)
@@ -66,7 +62,6 @@ JS_BUNDLE = ./www/app.js
 JS_BUNDLE_FILES	:= $(shell find www/js -name '*.js' -o -name '*.hbs')
 JS_BUNDLE_FILES	+= ./tools/build-js
 
-
 .PHONY: all
 all: $(SMF_MANIFESTS) node_modules js sdc-scripts
 
@@ -127,14 +122,9 @@ publish: release
 	cp $(ROOT)/$(RELEASE_TARBALL) $(BITS_DIR)/adminui/$(RELEASE_TARBALL)
 
 
-
 include ./tools/mk/Makefile.deps
 include ./tools/mk/Makefile.targ
-ifeq ($(shell uname -s),SunOS)
-	include ./tools/mk/Makefile.node_prebuilt.targ
-else
-	include ./tools/mk/Makefile.node.targ
-endif
+include ./tools/mk/Makefile.node.targ
 include ./tools/mk/Makefile.smf.targ
 
 sdc-scripts: deps/sdc-scripts/.git
diff --git a/lib/amon.js b/lib/amon.js
index aeee89e8..45cd59e2 100644
--- a/lib/amon.js
+++ b/lib/amon.js
@@ -9,7 +9,7 @@
  */
 
 var restify = require('restify');
-var fmt = require('sys').format;
+var format = require('util').format;
 
 module.exports = {
     createProbe: createProbe,
@@ -47,7 +47,7 @@ function alarmAction(req, res, next) {
     var act = req.params.action;
     var body = req.body || {};
     req.sdc[req.dc].amon.client.post(
-        fmt('/pub/%s/alarms/%s?action=%s', user, uuid, act),
+        format('/pub/%s/alarms/%s?action=%s', user, uuid, act),
         body,
         function didAmonAction(err, rReq, rRes, obj) {
         if (err) {
diff --git a/lib/api/stats.js b/lib/api/stats.js
index 757885ed..63f06ebe 100644
--- a/lib/api/stats.js
+++ b/lib/api/stats.js
@@ -19,11 +19,12 @@ module.exports = {
             serverMemory.bind(null, req)
         ], function callback(err, stats) {
             var result = {};
-
-            stats.forEach(function (o) {
-                Object.keys(o).forEach(function (k) {
-                    result[k] = o[k];
-                });
+            stats.forEach(function (data) {
+                if (data && typeof (data) === 'object') {
+                    Object.keys(data).forEach(function (key) {
+                        result[key] = data[key];
+                    });
+                }
             });
             req.log.info(result);
             res.send(result);
diff --git a/lib/servers.js b/lib/servers.js
index 735b3e65..cb73326f 100644
--- a/lib/servers.js
+++ b/lib/servers.js
@@ -5,15 +5,14 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2016, Joyent, Inc.
  */
 
 var _ = require('underscore');
-var format = require('sys').format;
 var getRequestHeaders = require('./get-request-headers');
 var utils = require('./utils');
 var async = require('async');
-var sprintf = require('util').format;
+var format = require('util').format;
 var querystring = require('querystring');
 
 function getSetupStatus(req, server, callback) {
@@ -22,7 +21,7 @@ function getSetupStatus(req, server, callback) {
         return callback(null, server);
     }
     req.sdc[req.dc].workflow.get({
-        path: sprintf('/jobs?%s', querystring.stringify({
+        path: format('/jobs?%s', querystring.stringify({
             server_uuid: server.uuid,
             name: req.config.serverSetupJobName,
             limit: 1
diff --git a/package.json b/package.json
index b5921c34..517f7128 100644
--- a/package.json
+++ b/package.json
@@ -8,7 +8,7 @@
     "git": "git@git.github.com:joyent/sdc-adminui.git"
   },
   "engines": {
-    "node": "0.8.x"
+    "node": ">=0.10"
   },
   "browser": "./www/adminui.js",
   "main": "./server.js",
@@ -17,9 +17,8 @@
     "async": "0.2.10",
     "backbone": "1.1.2",
     "backbone.paginator": "2.0.2",
-    "browserify": "3.46.1",
     "browserify-shim": "2.0.10",
-    "bunyan": "1.3.5",
+    "bunyan": "1.8.3",
     "classnames": "1.2.2",
     "clone": "0.1.19",
     "envify": "1.2.0",
@@ -29,15 +28,14 @@
     "kang": "0.0.8",
     "less": "1.7.5",
     "mime": "1.2.11",
-    "moray": "git+ssh://git@github.com:joyent/node-moray.git#b84ef0e",
+    "moray": "git+ssh://git@github.com:joyent/node-moray.git#31c0902",
     "node-uuid": "1.4.3",
     "promise": "6.1.0",
     "react": "0.13.0",
     "reactify": "1.0.0",
-    "restify": "2.8.5",
-    "sdc-clients": "9.2.0",
-    "ufds": "1.1.3",
-    "sdc-events": "git+ssh://git@github.com:joyent/sdc-events.git",
+    "restify": "4.1.1",
+    "sdc-clients": "10.0.1",
+    "ufds": "1.2.0",
     "superagent": "0.21.0",
     "through": "2.3.4",
     "trace-event": "1.3.0",
@@ -47,7 +45,7 @@
     "watchify": "0.10.2"
   },
   "devDependencies": {
-    "node-dev": "^2.3.0",
+    "node-dev": "2.7.1",
     "jest-cli": "^0.1.15",
     "react-tools": "0.13.0"
   },
diff --git a/tools/mk/Makefile.node.defs b/tools/mk/Makefile.node.defs
index 93768417..478de2a5 100644
--- a/tools/mk/Makefile.node.defs
+++ b/tools/mk/Makefile.node.defs
@@ -31,7 +31,7 @@
 #
 # (1) Invoking node, node-waf, or npm as part of the build process, as in "npm
 #     install" and "node-waf configure build".  To facilitate this, this
-#     Makefile defines Make variables NODE, NODE_WAF, and NPM that you can use
+#     Makefile defines Make variables NODE, and NPM that you can use
 #     to invoke these commands during the build process.  You MUST NOT assume
 #     that these variables just evaluate to the filenames themselves, as they
 #     may have environment variable definitions and other things that prevent
@@ -55,7 +55,7 @@
 # (2) Specifying paths for invoking node, node-waf, or npm at RUNTIME, as in
 #     specifying the path to node used for the start method of your service's
 #     SMF manifest.  For this, this Makefile defines variables NODE_EXEC,
-#     NODE_WAF_EXEC, and NPM_EXEC, which represent the relative paths of these
+#     and NPM_EXEC, which represent the relative paths of these
 #     files from the root of the workspace.  You MUST NOT use these variables
 #     to invoke these commands during the build process.  See (1) instead.
 #
@@ -89,16 +89,14 @@ NODE_CONFIG_FLAGS += --prefix=$(TOP)/$(NODE_INSTALL)
 
 ifeq ($(shell uname -s),SunOS)
 	NODE_CONFIG_FLAGS += 	--with-dtrace \
-				--openssl-libpath=/opt/local/lib \
-				--openssl-includes=/opt/local/include
+				--shared-openssl-libpath=/opt/local/lib \
+				--shared-openssl-includes=/opt/local/include
 endif
 
 NODE_EXEC	= $(NODE_INSTALL)/bin/node
-NODE_WAF_EXEC	= $(NODE_INSTALL)/bin/node-waf
 NPM_EXEC	= $(NODE_INSTALL)/bin/npm
 
 # Ensure these use absolute paths to the executables to allow running
 # from a dir other than the project top.
 NODE		:= $(TOP)/$(NODE_EXEC)
-NODE_WAF	:= $(TOP)/$(NODE_WAF_EXEC)
 NPM		:= PATH=$(TOP)/$(NODE_INSTALL)/bin:$(PATH) node $(TOP)/$(NPM_EXEC)
diff --git a/tools/mk/Makefile.node.targ b/tools/mk/Makefile.node.targ
index abdc6166..d9cfbcb9 100644
--- a/tools/mk/Makefile.node.targ
+++ b/tools/mk/Makefile.node.targ
@@ -18,23 +18,12 @@
 # eng.git and then update your repo to use the new version.
 #
 
-ifneq ($(shell uname -s),SunOS)
-NODE_PREBUILT_VERSION ?= $(error You must define NODE_PREBUILT_VERSION to use Makefile.node.targ on non-SunOS)
-endif
-
-ifeq ($(shell uname -s),SunOS)
-$(NODE_EXEC) $(NPM_EXEC) $(NODE_WAF_EXEC): | deps/node/.git
-	(cd deps/node; ./configure $(NODE_CONFIG_FLAGS) && $(MAKE) && $(MAKE) install)
-else
-$(NODE_EXEC) $(NPM_EXEC) $(NODE_WAF_EXEC):
+$(NODE_EXEC) $(NPM_EXEC):
 	(mkdir -p $(BUILD) \
 		&& cd $(BUILD) \
-		&& [[ -d src-node ]] && (cd src-node && git checkout master && git pull) || git clone git://github.com/joyent/node.git src-node \
-		&& cd src-node \
-		&& git checkout $(NODE_PREBUILT_VERSION) \
+		&& mkdir -p src-node && cd src-node && curl -ksS https://codeload.github.com/nodejs/node/tar.gz/$(NODE_PREBUILT_VERSION) | tar --strip-components=1 -xzvf - \
 		&& ./configure $(NODE_CONFIG_FLAGS) \
 		&& $(MAKE) && $(MAKE) install)
-endif
 
 DISTCLEAN_FILES += $(NODE_INSTALL) $(BUILD)/src-node
 
