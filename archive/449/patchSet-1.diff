From b1b502dcfbe24fba3fbd97955500b8fe6dbb4451 Mon Sep 17 00:00:00 2001
From: Andrey Yatskov <andrey.yatskov@silvertreesystems.com>
Date: Thu, 7 Jul 2016 20:41:57 +0400
Subject: [PATCH] ADMINUI-2314 Upgrade Node.js version from 0.10 to 4.x (or
 6.x) before its EOL in Oct 2016

---
 Makefile                    |  2 +-
 lib/amon.js                 |  4 ++--
 lib/api/stats.js            | 11 ++++++-----
 lib/servers.js              |  7 +++----
 package.json                | 12 +++++-------
 tools/mk/Makefile.node.targ |  3 +--
 6 files changed, 18 insertions(+), 21 deletions(-)

diff --git a/Makefile b/Makefile
index 8fff66be..31a88414 100644
--- a/Makefile
+++ b/Makefile
@@ -39,7 +39,7 @@ JSSTYLE_FLAGS    = -o "indent=2,doxygen,unparenthesized-return=0,line-length=120
 REPO_MODULES	 =
 SMF_MANIFESTS_IN = smf/manifests/adminui.xml.in
 
-NODE_PREBUILT_VERSION=v0.10.45
+NODE_PREBUILT_VERSION=v4.4.7
 NODE_PREBUILT_TAG=zone
 NODE_PREBUILT_IMAGE=fd2cc906-8938-11e3-beab-4359c665ac99
 
diff --git a/lib/amon.js b/lib/amon.js
index aeee89e8..45cd59e2 100644
--- a/lib/amon.js
+++ b/lib/amon.js
@@ -9,7 +9,7 @@
  */
 
 var restify = require('restify');
-var fmt = require('sys').format;
+var format = require('util').format;
 
 module.exports = {
     createProbe: createProbe,
@@ -47,7 +47,7 @@ function alarmAction(req, res, next) {
     var act = req.params.action;
     var body = req.body || {};
     req.sdc[req.dc].amon.client.post(
-        fmt('/pub/%s/alarms/%s?action=%s', user, uuid, act),
+        format('/pub/%s/alarms/%s?action=%s', user, uuid, act),
         body,
         function didAmonAction(err, rReq, rRes, obj) {
         if (err) {
diff --git a/lib/api/stats.js b/lib/api/stats.js
index 757885ed..378d7ae4 100644
--- a/lib/api/stats.js
+++ b/lib/api/stats.js
@@ -19,12 +19,13 @@ module.exports = {
             serverMemory.bind(null, req)
         ], function callback(err, stats) {
             var result = {};
-
-            stats.forEach(function (o) {
-                Object.keys(o).forEach(function (k) {
-                    result[k] = o[k];
+            if (!err && stats.length) {
+                stats.forEach(function (data) {
+                    Object.keys(data).forEach(function (key) {
+                        result[key] = data[key];
+                    });
                 });
-            });
+            }
             req.log.info(result);
             res.send(result);
             return next();
diff --git a/lib/servers.js b/lib/servers.js
index 735b3e65..cb73326f 100644
--- a/lib/servers.js
+++ b/lib/servers.js
@@ -5,15 +5,14 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2016, Joyent, Inc.
  */
 
 var _ = require('underscore');
-var format = require('sys').format;
 var getRequestHeaders = require('./get-request-headers');
 var utils = require('./utils');
 var async = require('async');
-var sprintf = require('util').format;
+var format = require('util').format;
 var querystring = require('querystring');
 
 function getSetupStatus(req, server, callback) {
@@ -22,7 +21,7 @@ function getSetupStatus(req, server, callback) {
         return callback(null, server);
     }
     req.sdc[req.dc].workflow.get({
-        path: sprintf('/jobs?%s', querystring.stringify({
+        path: format('/jobs?%s', querystring.stringify({
             server_uuid: server.uuid,
             name: req.config.serverSetupJobName,
             limit: 1
diff --git a/package.json b/package.json
index b5921c34..98d6f971 100644
--- a/package.json
+++ b/package.json
@@ -8,7 +8,7 @@
     "git": "git@git.github.com:joyent/sdc-adminui.git"
   },
   "engines": {
-    "node": "0.8.x"
+    "node": "4.x"
   },
   "browser": "./www/adminui.js",
   "main": "./server.js",
@@ -17,7 +17,6 @@
     "async": "0.2.10",
     "backbone": "1.1.2",
     "backbone.paginator": "2.0.2",
-    "browserify": "3.46.1",
     "browserify-shim": "2.0.10",
     "bunyan": "1.3.5",
     "classnames": "1.2.2",
@@ -29,15 +28,14 @@
     "kang": "0.0.8",
     "less": "1.7.5",
     "mime": "1.2.11",
-    "moray": "git+ssh://git@github.com:joyent/node-moray.git#b84ef0e",
+    "moray": "git+ssh://git@github.com:joyent/node-moray.git#31c0902",
     "node-uuid": "1.4.3",
     "promise": "6.1.0",
     "react": "0.13.0",
     "reactify": "1.0.0",
     "restify": "2.8.5",
-    "sdc-clients": "9.2.0",
-    "ufds": "1.1.3",
-    "sdc-events": "git+ssh://git@github.com:joyent/sdc-events.git",
+    "sdc-clients": "9.5.0",
+    "ufds": "git+ssh://git@github.com:joyent/node-ufds.git#47b980b",
     "superagent": "0.21.0",
     "through": "2.3.4",
     "trace-event": "1.3.0",
@@ -47,7 +45,7 @@
     "watchify": "0.10.2"
   },
   "devDependencies": {
-    "node-dev": "^2.3.0",
+    "node-dev": "2.7.1",
     "jest-cli": "^0.1.15",
     "react-tools": "0.13.0"
   },
diff --git a/tools/mk/Makefile.node.targ b/tools/mk/Makefile.node.targ
index abdc6166..82327f3f 100644
--- a/tools/mk/Makefile.node.targ
+++ b/tools/mk/Makefile.node.targ
@@ -29,9 +29,8 @@ else
 $(NODE_EXEC) $(NPM_EXEC) $(NODE_WAF_EXEC):
 	(mkdir -p $(BUILD) \
 		&& cd $(BUILD) \
-		&& [[ -d src-node ]] && (cd src-node && git checkout master && git pull) || git clone git://github.com/joyent/node.git src-node \
+		&& [[ -d src-node ]] && (cd src-node && git checkout master && git pull) || git clone git@github.com:nodejs/node.git --branch $(NODE_PREBUILT_VERSION) --single-branch src-node  \
 		&& cd src-node \
-		&& git checkout $(NODE_PREBUILT_VERSION) \
 		&& ./configure $(NODE_CONFIG_FLAGS) \
 		&& $(MAKE) && $(MAKE) install)
 endif
-- 
2.21.0

