From 9a38c73c300217b2dd4671f13aca0eba872fc8dd Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Thu, 29 Mar 2018 13:33:49 -0400
Subject: [PATCH] TRITON-287 vmapi tests should use network names explicitly

---
 test/common.js              | 30 +++++++++++++++++++++++--
 test/vms.changefeed.test.js |  6 ++---
 test/vms.full.test.js       | 45 +++++++++++++++++++------------------
 3 files changed, 54 insertions(+), 27 deletions(-)

diff --git a/test/common.js b/test/common.js
index 1c200db..e565266 100644
--- a/test/common.js
+++ b/test/common.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2017 Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -230,6 +230,31 @@ function waitForValue(url, key, value, options, callback) {
     performCheck();
 }
 
+/*
+ * Given an array of networks (most likely returned from napi GET /networks),
+ * find the admin and external network and return them as an object.  This
+ * function will throw if neither network is found, or multiple networks with
+ * the name external or admin are found.
+ */
+function extractNetworks(networks) {
+    assert.arrayOfObject(networks, 'networks');
+
+    var ret = {};
+    networks.forEach(function forEachNetwork(network) {
+        assert.string(network.name, 'network.name');
+
+        if (['admin', 'external'].indexOf(network.name) >= 0) {
+            assert(!ret.hasOwnProperty(network.name), util.format(
+                'network defined more than once: "%s"', network.name));
+            ret[network.name] = network;
+        }
+    });
+    assert.object(ret.admin, 'admin network not found');
+    assert.object(ret.external, 'external network not found');
+
+    return ret;
+}
+
 module.exports = {
     setUp: setUp,
     checkHeaders: checkHeaders,
@@ -238,5 +263,6 @@ module.exports = {
     config: config,
     ifError: ifError,
     VMS_LIST_ENDPOINT: VMS_LIST_ENDPOINT,
-    waitForValue: waitForValue
+    waitForValue: waitForValue,
+    extractNetworks: extractNetworks
 };
diff --git a/test/vms.changefeed.test.js b/test/vms.changefeed.test.js
index 179c6fc..68cc64c 100644
--- a/test/vms.changefeed.test.js
+++ b/test/vms.changefeed.test.js
@@ -211,7 +211,7 @@ exports.napi_networks_ok = function (t) {
         t.ok(networks, 'networks is set');
         t.ok(Array.isArray(networks), 'networks is Array');
         t.ok(networks.length > 1, 'more than 1 network found');
-        NETWORKS = networks;
+        NETWORKS = common.extractNetworks(networks);
         t.done();
     });
 };
@@ -229,7 +229,7 @@ exports.create_vm = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 64,
@@ -432,7 +432,7 @@ exports.listen_for_nics = function (t) {
     t.expect(5);
     var params = {
         action: 'add_nics',
-        networks: [ { uuid: NETWORKS[1].uuid } ]
+        networks: [ { uuid: NETWORKS.external.uuid } ]
     };
 
     var opts = createOpts('/vms/' + VM.uuid + '?action=add_nics', params);
diff --git a/test/vms.full.test.js b/test/vms.full.test.js
index a4534dc..9febef9 100644
--- a/test/vms.full.test.js
+++ b/test/vms.full.test.js
@@ -37,6 +37,7 @@ var nicMac;
 var IMAGE = 'fd2cc906-8938-11e3-beab-4359c665ac99';
 var CUSTOMER = common.config.ufdsAdminUuid;
 var NETWORKS = null;
+var ALL_NETWORKS = null;
 var VALID_NIC; // Create a new NIC with valid parameters for a later test
 var FAKE_NETWORK_UUID = 'caaaf10c-a587-49c6-9cf6-9b0a14ba960b';
 var FAKE_NETWORK_NAME = 'fakeNetworkName';
@@ -159,7 +160,7 @@ function createTestVms(cb) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 128,
@@ -294,7 +295,8 @@ exports.napi_networks_ok = function (t) {
         t.ok(networks, 'networks is set');
         t.ok(Array.isArray(networks), 'networks is Array');
         t.ok(networks.length > 1, 'more than 1 network found');
-        NETWORKS = networks;
+        ALL_NETWORKS = networks;
+        NETWORKS = common.extractNetworks(ALL_NETWORKS);
         t.done();
     });
 };
@@ -628,7 +630,7 @@ exports.create_vm_locality_not_ok = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 64,
@@ -661,7 +663,7 @@ exports.create_vm_tags_not_ok = function (t) {
             owner_uuid: CUSTOMER,
             image_uuid: IMAGE,
             server_uuid: SERVER.uuid,
-            networks: [ { uuid: NETWORKS[0].uuid } ],
+            networks: [ { uuid: NETWORKS.admin.uuid } ],
             brand: 'joyent-minimal',
             billing_id: '00000000-0000-0000-0000-000000000000',
             ram: 64,
@@ -794,7 +796,7 @@ exports.create_vm = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 64,
@@ -1070,9 +1072,8 @@ exports.create_vm_with_already_provisioned_ip = function (t) {
         common.checkHeaders(t, res.headers);
         t.ok(body, 'got provisioned vm');
 
-        // This is depending on NETWORKS[0] being the admin network
         ips = body.nics.filter(function (nic) {
-            return nic.nic_tag === NETWORKS[0].nic_tag;
+            return nic.nic_tag === NETWORKS.admin.nic_tag;
         }).map(function (nic) {
             return nic.ip;
         });
@@ -1094,7 +1095,7 @@ exports.create_vm_with_already_provisioned_ip = function (t) {
 
         vm.networks = [
             {
-                ipv4_uuid: NETWORKS[0].uuid,
+                ipv4_uuid: NETWORKS.admin.uuid,
                 ipv4_ips: [ ips[0] ]
             }
         ];
@@ -1142,7 +1143,7 @@ exports.create_vm_with_already_provisioned_ip = function (t) {
 exports.add_nics_with_networks = function (t) {
     var params = {
         action: 'add_nics',
-        networks: [ { uuid: NETWORKS[1].uuid } ]
+        networks: [ { uuid: NETWORKS.external.uuid } ]
     };
 
     var opts = createOpts(vmLocation, params);
@@ -1174,7 +1175,7 @@ exports.check_add_nics_with_network_nics_running = function (t) {
     var query = {
         belongs_to_uuid: newUuid,
         belongs_to_type: 'zone',
-        nic_tag: NETWORKS[1].nic_tag
+        nic_tag: NETWORKS.external.nic_tag
     };
 
     waitForNicState(t, query, 'running', function (err) {
@@ -1189,8 +1190,8 @@ exports.add_nics_with_macs = function (t) {
         belongs_to_uuid: newUuid,
         belongs_to_type: 'zone',
         owner_uuid: CUSTOMER,
-        network_uuid: NETWORKS[1].uuid,
-        nic_tag: NETWORKS[1].nic_tag,
+        network_uuid: NETWORKS.external.uuid,
+        nic_tag: NETWORKS.external.nic_tag,
         status: 'provisioning'
     };
 
@@ -1235,7 +1236,7 @@ exports.check_add_nics_with_macs_nics_running = function (t) {
     var query = {
         belongs_to_uuid: newUuid,
         belongs_to_type: 'zone',
-        nic_tag: NETWORKS[1].nic_tag
+        nic_tag: NETWORKS.external.nic_tag
     };
 
     waitForNicState(t, query, 'running', function (err) {
@@ -1258,7 +1259,7 @@ exports.remove_nics = function (t) {
         t.equal(body.nics.length, 3, 'body.nics has length 3');
 
         var macs = body.nics.filter(function (nic) {
-            return nic.nic_tag === NETWORKS[1].nic_tag;
+            return nic.nic_tag === NETWORKS.external.nic_tag;
         }).map(function (nic) {
             return nic.mac;
         });
@@ -1301,7 +1302,7 @@ exports.check_remove_nics_removed = function (t) {
         query: {
             belongs_to_uuid: newUuid,
             belongs_to_type: 'zone',
-            nic_tag: NETWORKS[1].nic_tag
+            nic_tag: NETWORKS.external.nic_tag
         }
     }, function (err, req, res, nics) {
         common.ifError(t, err);
@@ -1895,7 +1896,7 @@ exports.create_nonautoboot_vm = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 64,
@@ -2126,7 +2127,7 @@ exports.create_vm_with_package = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: pkgId
     };
@@ -2319,7 +2320,7 @@ exports.provision_network_names = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { name: NETWORKS[0].name } ],
+        networks: [ { name: NETWORKS.admin.name } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 64,
@@ -2413,7 +2414,7 @@ exports.invalid_firewall_rules = function (t) {
             owner_uuid: CUSTOMER,
             image_uuid: IMAGE,
             server_uuid: SERVER.uuid,
-            networks: [ { name: NETWORKS[0].uuid } ],
+            networks: [ { name: NETWORKS.admin.uuid } ],
             brand: 'joyent-minimal',
             billing_id: '00000000-0000-0000-0000-000000000000',
             ram: 64,
@@ -2451,7 +2452,7 @@ exports.create_docker_vm = function (t) {
         owner_uuid: CUSTOMER,
         image_uuid: IMAGE,
         server_uuid: SERVER.uuid,
-        networks: [ { uuid: NETWORKS[0].uuid } ],
+        networks: [ { uuid: NETWORKS.admin.uuid } ],
         brand: 'joyent-minimal',
         billing_id: '00000000-0000-0000-0000-000000000000',
         ram: 64,
@@ -2703,9 +2704,9 @@ exports.destroy_test_vms_final = function (t) {
  */
 
 exports.find_fabric_network = function (t) {
-    assert.arrayOfObject(NETWORKS, 'NETWORKS');
+    assert.arrayOfObject(ALL_NETWORKS, 'ALL_NETWORKS');
 
-    fabricNetwork = NETWORKS.find(function _findFabricNetwork(n) {
+    fabricNetwork = ALL_NETWORKS.find(function _findFabricNetwork(n) {
         return n.fabric === true;
     });
 
-- 
2.21.0

