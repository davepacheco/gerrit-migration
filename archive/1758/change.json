{"project":"joyent/illumos-joyent","branch":"master","id":"I3bec90a705e84f930818a783c3c4b0382f7420ab","number":"1758","subject":"OS-5250 lxbrand populate d_type in sysfs Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1758","commitMessage":"OS-5250 lxbrand populate d_type in sysfs\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1491493688,"lastUpdated":1491589335,"open":false,"status":"MERGED","comments":[{"timestamp":1491493688,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1491503898,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nOverall note: I think it would be wise to have a big-ish theory statement somewhere which details the reasoning behind this change.  It is, after all, a rather specific work-around to solve specific sysfs problems.  I wouldn\u0027t want someone to get the wrong idea about why these mechanisms were put in place."},{"timestamp":1491512737,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(10 comments)"},{"timestamp":1491573996,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1491578867,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1491581055,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1491581089,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1491587156,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1491588594,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1491589268,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1491589321,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1491589335,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"3bec90a705e84f930818a783c3c4b0382f7420ab","parents":["a3c340db5c1c4707d5e6344564f322ed831320cd"],"ref":"refs/changes/58/1758/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1491589321,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491587156,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491588594,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1491589335,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","type":"MODIFIED","insertions":69,"deletions":-7},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysfs.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","type":"MODIFIED","insertions":140,"deletions":-2}],"sizeInsertions":231,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"15903caa2f3bee93c930df628be91d471e1d9739","parents":["59d73dcf2d9b389641c1b420dc1dc2db59257220"],"ref":"refs/changes/58/1758/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1491493688,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":51,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe include \u0027vfs\u0027 in the name?  It would better describe the purpose and the fact that we\u0027re using it for vfs emulation tomfoolery."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":63,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Linux"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":100,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe move these up with the other integer defines at the top of the file."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":248,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This should maybe be an ino_t?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":267,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Does lint not complain about the lack of a default here?  It might not if dtype is defined as \u0027enum vtype\u0027 rather than \u0027int\u0027."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":393,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Great improvement over the \"magic\" zero."},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","line":364,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is this even necessary?  Either we emit a valid vnode_t* due to lxsys_ino_get_node() being successful or we toss an error?"},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","line":516,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It seems like we\u0027re going through an awful lot of work to emit a vnode_t that we _know_ is only being used to communicate the type of the entity at hand.  What do you think about perhaps dialing it down so we don\u0027t need to do work like generating/looking-up the parent vnode?"},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","line":541,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe write a companion function to lxsys_inode that does the reverse to use here?"},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","line":1344,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should we maybe encode this directly in the dirtab?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_types.h","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","type":"MODIFIED","insertions":71,"deletions":-7},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysfs.h","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","type":"MODIFIED","insertions":25,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","type":"MODIFIED","insertions":262,"deletions":-2}],"sizeInsertions":376,"sizeDeletions":-13},{"number":"2","revision":"fee4321082129026b091434234d3d009740cc2d7","parents":["59d73dcf2d9b389641c1b420dc1dc2db59257220"],"ref":"refs/changes/58/1758/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1491573996,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":120,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe stick with the \u0027is_sysfs\u0027 naming of the later-called function?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":147,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is the explicit hold necessary given that the vnode should have one of its own?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","line":259,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since this is sysfs specific, having that somewhere in the name would probably be a good idea."},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","line":118,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Interrogative: There\u0027s no possibility of module unload until all instances are umounted, correct?"},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","line":118,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes. I had the VFS_HOLD in the getdents code but as you pointed out, it was actually unnecessary since we have a hold there on a vnode within the filesystem, so it can\u0027t unload."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","type":"MODIFIED","insertions":75,"deletions":-7},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysfs.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","type":"MODIFIED","insertions":140,"deletions":-2}],"sizeInsertions":237,"sizeDeletions":-12},{"number":"3","revision":"3d55008fcd2b9eb83970bc4093dcbc08c7828e2c","parents":["59d73dcf2d9b389641c1b420dc1dc2db59257220"],"ref":"refs/changes/58/1758/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1491581089,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491587156,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491588594,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","type":"MODIFIED","insertions":69,"deletions":-7},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysfs.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","type":"MODIFIED","insertions":140,"deletions":-2}],"sizeInsertions":231,"sizeDeletions":-12},{"number":"4","revision":"a92840e1ce7d06a11b68f077c5cab69323e632af","parents":["a3c340db5c1c4707d5e6344564f322ed831320cd"],"ref":"refs/changes/58/1758/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1491589268,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491587156,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491588594,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","type":"MODIFIED","insertions":69,"deletions":-7},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysfs.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","type":"MODIFIED","insertions":140,"deletions":-2}],"sizeInsertions":231,"sizeDeletions":-12},{"number":"5","revision":"3bec90a705e84f930818a783c3c4b0382f7420ab","parents":["a3c340db5c1c4707d5e6344564f322ed831320cd"],"ref":"refs/changes/58/1758/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1491589321,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1491589335,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491587156,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491588594,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getdents.c","type":"MODIFIED","insertions":69,"deletions":-7},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysfs.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvfsops.c","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sysfs/lx_sysvnops.c","type":"MODIFIED","insertions":140,"deletions":-2}],"sizeInsertions":231,"sizeDeletions":-12}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}