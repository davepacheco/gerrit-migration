{"project":"joyent/binder","branch":"master","id":"I94a3b4b89779ecd28b60bf516ca33921658086d5","number":"3930","subject":"MANTA-3676 Improve binder observability Reviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e Approved by: Alex Wilson \u003calex.wilson@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/3930","commitMessage":"MANTA-3676 Improve binder observability\nReviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e\nApproved by: Alex Wilson \u003calex.wilson@joyent.com\u003e\n","createdOn":1525919012,"lastUpdated":1526083922,"open":false,"status":"MERGED","comments":[{"timestamp":1525919012,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1525919039,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525963769,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(5 comments)\n\nLooks good!"},{"timestamp":1525976541,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1525977424,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1525977633,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1525986877,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1525986909,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525990147,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1525990174,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525993588,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1525993615,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526062194,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Code-Review+1\n\nGenerally looks good I think. Will just need to wait on the mname release and bump the package.json to get the new bytesSent property."},{"timestamp":1526065373,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5."},{"timestamp":1526065399,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526065682,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 5:\n\n(1 comment)\n\nJust generated a new image on Jenkins where package.json requires mname 1.5.0 and deployed to my nameservice zones.  I\u0027m able to collect all DTrace data and artedi metrics as intended.  This includes `bytesSent\u0027.  Added the patch set (5) with the latest."},{"timestamp":1526081887,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1526083901,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1526083922,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"6","revision":"94a3b4b89779ecd28b60bf516ca33921658086d5","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/6","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1526083901,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526065399,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526081887,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1526081887,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1526083922,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":52,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":85,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"93090f64f81afe878848910f42fdf05e728c15fe","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1525919012,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525919039,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":522,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Is there harm in including the \u0027type\u0027 metadata for the histograms? It might be useful to see the latency and size of requests broken down by type."},{"file":"lib/server.js","line":522,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Can do."},{"file":"lib/server.js","line":522,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"main.js","line":18,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think you\u0027ll need to add restify to the package.json file"},{"file":"main.js","line":18,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Thanks for catching that.  Long story on that that I won\u0027t waste too much of your time on, but I\u0027ve had it in and out of package.json a few times.\n\nRegarding the restify package version: node-triton-metrics has a peer requirement of restify 4.3.x as of now, despite the fact that there are newer versions available.  For the time being are we fine with the binder package.json requiring restify 4.3.x?  The build system apparently doesn\u0027t appreciate the package versions not matching.  I mentioned it to Trent and Dylan when I accidentally stumbled upon it.  I\u0027m welcome to do the node-triton-metrics testing needed to bump the restify version, and I\u0027m happy to take the detour to do it.  I\u0027ll defer to your judgement on the short term course of action."},{"file":"main.js","line":18,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I\u0027m fine with using 4.3.x for now. I don\u0027t know what sort of implications the node-triton-metrics change has. Maybe we can open a GitHub issue for that in the node-triton-metrics repo if it\u0027s something we want to do."},{"file":"main.js","line":193,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"FWIW Moray and electric-moray use port + 1000."},{"file":"main.js","line":193,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I\u0027ll follow that convention then."},{"file":"main.js","line":196,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It might be useful to have one log statement when the callback is invoked. It\u0027s helpful to know when the server starts listening, and on which port."},{"file":"main.js","line":196,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"If I\u0027m understanding metrics-manager.js correctly, that shouldn\u0027t be necessary as they handle it for us:\nhttps://github.com/joyent/node-triton-metrics/blob/b5cf07466ad9927a472aa991ae4caf33c6ae6bc9/lib/metrics-manager.js#L81-L88\n\nFor what it\u0027s worth, this was corroborated in the binder log file when the service started."},{"file":"main.js","line":196,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Great! I didn\u0027t realize that. Looks good."},{"file":"package.json","line":19,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"The latest version of this module is 0.1.1, but it looks like it was a very minor change."},{"file":"package.json","line":19,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I can pull that in."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":51,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":76,"sizeDeletions":-2},{"number":"2","revision":"e18ac84935b0fd47f8400399931781a46616d976","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1525986877,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525986909,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":52,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":0},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":84,"sizeDeletions":-2},{"number":"3","revision":"076dffa89bc3dc21e28613c65397fd42c589a992","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1525990147,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525990174,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":52,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":0},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":84,"sizeDeletions":-2},{"number":"4","revision":"2367a0fdf73751379d404b81959ed80badff2d6b","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1525993588,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526062194,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525993615,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":52,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":0},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":84,"sizeDeletions":-2},{"number":"5","revision":"47a77c0d1a0014d42416fc5a42dfa772dc39b833","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1526065373,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526081887,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1526081887,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526065399,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":52,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":85,"sizeDeletions":-3},{"number":"6","revision":"94a3b4b89779ecd28b60bf516ca33921658086d5","parents":["6b7b54eede5c33e13fba124790c436779b8bc71f"],"ref":"refs/changes/30/3930/6","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1526083901,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526081887,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1526081887,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526065399,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1526083922,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":52,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"sapi_manifests/binder/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":85,"sizeDeletions":-3}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}