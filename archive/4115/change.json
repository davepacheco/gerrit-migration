{"project":"joyent/illumos-joyent","branch":"master","id":"I9ac6d312186d284278e51757d4ed4db0d8679e35","number":"4115","subject":"OS-6949 bhyve should expose clock params like KVM","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/4115","commitMessage":"OS-6949 bhyve should expose clock params like KVM\n","createdOn":1527889754,"lastUpdated":1567520026,"open":false,"status":"ABANDONED","comments":[{"timestamp":1527889754,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1527889789,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Integration-Approval-1"},{"timestamp":1528152273,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(6 comments)\n\nIn general, seems reasonable."},{"timestamp":1528153410,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1528835357,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1529431210,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1529441881,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1529441937,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: -Integration-Approval"},{"timestamp":1529442007,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nWhile I\u0027d like to circle back to consolidate TSC handling in os/timestamp.c at some point, this can probably move forward for normal review now."},{"timestamp":1529686495,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1529686849,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1533582656,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nThe HVM-general portion of this will be covered in OS-7104 in order to speed the integration of OS-7102.  The bhyve specifics will be revisited when those are integrated."},{"timestamp":1535696929,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1535733457,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1535734063,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1535734181,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1535734332,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1567520026,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Abandoned\n\nThis should probably be folded into some sort of hypervisor emulation framework (to support KVM and perhaps eventually hyperv)"}],"currentPatchSet":{"number":"4","revision":"9ac6d312186d284278e51757d4ed4db0d8679e35","parents":["28a4d80723e5da0288e478dae17be1c0474d200e"],"ref":"refs/changes/15/4115/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529441881,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535696929,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Is there a reason not to expose this when we\u0027re not identifying as KVM? IIRC the CPUID stuff is actually designed for this kind of thing, and it seems odd that Linux(?) will depend not only on the CPUID leaf being there, but also on the  hypervisor being KVM."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Linux only goes looking for the leaf if first detects that KVM is the hypervisor."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Can we expose it anyway, regardless of that setting? It\u0027s kinda silly of Linux to only use this CPUID leaf if its KVM. It should be safe to always have it, and perhaps one day we can stop pretending we\u0027re KVM when we really aren\u0027t."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"So bhyve will now look KVM from the guests perspective?"},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Bhyve can optionally \"look like\" KVM, yes.  In the longer term, I\u0027d like a more accessible (hopefully per-VM) setting for this than \"mdb -kw\"."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While the 0x40000000 space is reserved for hypervisors (AFAIK), I\u0027m not sure that formatting for this leaf is well defined outside of KVM.  I don\u0027t expect Linux or other guests to trigger off of this functionality without first checking if they\u0027re running in KVM."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Since you mentioned optionally, am I save to assume it will still default to bhyve?"},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Unclear at this point.  We\u0027ll probably want kvm-clock for our guests in smartos."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":222,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","type":"MODIFIED","insertions":47,"deletions":0},{"file":"usr/src/uts/i86pc/os/timestamp.c","type":"MODIFIED","insertions":53,"deletions":0},{"file":"usr/src/uts/i86pc/sys/machsystm.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":323,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"44aa96f3966d2ff3c3aec075f7fa95385110709c","parents":["85b17c1b93b115432749ebfaec35acd2936881ac"],"ref":"refs/changes/15/4115/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1527889754,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1527889789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1775,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe we should centralize this in the HVM API bits at some point?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1775,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would probably keep this separate from the generic HVM (HMA) api, but a shared header that timestamp.c can use so it can consume the data as a guest seems like a good idea down the road"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1804,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What are the conflicts?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1804,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"CR*_ definitions.  It was kind of a mess"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1838,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Are we supposed to produce the version without updating the data?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":1838,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, the odd version indicates that the fields are being updated"},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":499,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess there\u0027s no way that we can advertise multiple IDs about who we are?"},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":499,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Not one that made sense to me"},{"file":"usr/src/uts/i86pc/os/timestamp.c","line":285,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is this sufficient for KVM as well?"},{"file":"usr/src/uts/i86pc/os/timestamp.c","line":285,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027ll circle back and check KVM.  (It\u0027s something that I forgot to do on the first cut)  This isn\u0027t really what I\u0027d like for a final form of the API, but that can probably wait until more sweeping timestamp.c cleanup"},{"file":"usr/src/uts/i86pc/sys/machsystm.h","line":234,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe we should expose these in the HVM API in the future?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":207,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","type":"MODIFIED","insertions":43,"deletions":0},{"file":"usr/src/uts/i86pc/os/timestamp.c","type":"MODIFIED","insertions":53,"deletions":0},{"file":"usr/src/uts/i86pc/sys/machsystm.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":304,"sizeDeletions":0},{"number":"2","revision":"ca8a29e41cd43c0e116541d88ea8dca8ae04b99b","parents":["2d6c2da33710f0ac11e240fa703d7f072540d9f0"],"ref":"refs/changes/15/4115/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1528835357,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1527889789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":207,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","type":"MODIFIED","insertions":43,"deletions":0},{"file":"usr/src/uts/i86pc/os/timestamp.c","type":"MODIFIED","insertions":53,"deletions":0},{"file":"usr/src/uts/i86pc/sys/machsystm.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":304,"sizeDeletions":0},{"number":"3","revision":"8ac80aaab6adf76553e4199d1bd25dd933ee6c64","parents":["28a4d80723e5da0288e478dae17be1c0474d200e"],"ref":"refs/changes/15/4115/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529431210,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1527889789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":207,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","type":"MODIFIED","insertions":43,"deletions":0},{"file":"usr/src/uts/i86pc/os/timestamp.c","type":"MODIFIED","insertions":53,"deletions":0},{"file":"usr/src/uts/i86pc/sys/machsystm.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":304,"sizeDeletions":0},{"number":"4","revision":"9ac6d312186d284278e51757d4ed4db0d8679e35","parents":["28a4d80723e5da0288e478dae17be1c0474d200e"],"ref":"refs/changes/15/4115/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1529441881,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535696929,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Is there a reason not to expose this when we\u0027re not identifying as KVM? IIRC the CPUID stuff is actually designed for this kind of thing, and it seems odd that Linux(?) will depend not only on the CPUID leaf being there, but also on the  hypervisor being KVM."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Linux only goes looking for the leaf if first detects that KVM is the hypervisor."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Can we expose it anyway, regardless of that setting? It\u0027s kinda silly of Linux to only use this CPUID leaf if its KVM. It should be safe to always have it, and perhaps one day we can stop pretending we\u0027re KVM when we really aren\u0027t."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"So bhyve will now look KVM from the guests perspective?"},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Bhyve can optionally \"look like\" KVM, yes.  In the longer term, I\u0027d like a more accessible (hopefully per-VM) setting for this than \"mdb -kw\"."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While the 0x40000000 space is reserved for hypervisors (AFAIK), I\u0027m not sure that formatting for this leaf is well defined outside of KVM.  I don\u0027t expect Linux or other guests to trigger off of this functionality without first checking if they\u0027re running in KVM."},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Since you mentioned optionally, am I save to assume it will still default to bhyve?"},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","line":532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Unclear at this point.  We\u0027ll probably want kvm-clock for our guests in smartos."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":222,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/x86.c","type":"MODIFIED","insertions":47,"deletions":0},{"file":"usr/src/uts/i86pc/os/timestamp.c","type":"MODIFIED","insertions":53,"deletions":0},{"file":"usr/src/uts/i86pc/sys/machsystm.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":323,"sizeDeletions":0}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}