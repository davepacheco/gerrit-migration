From 7184e55f9765ef306c2f717e67c2aa8d89aef8a5 Mon Sep 17 00:00:00 2001
From: David Pacheco <dap@joyent.com>
Date: Thu, 17 Nov 2016 14:15:52 -0800
Subject: [PATCH] MORAY-377 moray client masks callers' failing to add "error"
 listeners

---
 CHANGES.md     | 5 +++++
 lib/client.js  | 9 +++------
 lib/meta.js    | 2 ++
 lib/objects.js | 2 ++
 package.json   | 2 +-
 5 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 5aa5991..3ee66cb 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,10 @@
 # Changelog
 
+## v2.0.1
+
+* [MORAY-377](http://smartos.org/bugview/MORAY-377) moray client masks callers'
+  failing to add "error" listeners
+
 ## v2.0.0
 
 This is a major rewrite of the guts of this module, primarily to improve
diff --git a/lib/client.js b/lib/client.js
index 80702a6..89c935a 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -728,7 +728,7 @@ MorayClient.prototype.createFastConnection =
  *        If a backend connection is available, a MorayRpcContext will be
  *        returned from ctxCreateForEmitter().  These functions typically use
  *        releaseWhenDone() to release the RPC context when the event emitter
- *        emits 'end' or 'error'.
+ *        emits '_moray_internal_rpc_done'.
  *
  *        If no backend connection is available, then the caller is responsible
  *        for allocating and returning a new EventEmitter that will emit the
@@ -858,14 +858,11 @@ MorayClient.prototype.releaseWhenDone = function releaseOnEnd(rpcctx, emitter) {
     assert.object(emitter);
     assert.ok(emitter instanceof EventEmitter);
 
-    function onEmitterRpcComplete() {
+    emitter.on('_moray_internal_rpc_done', function onEmitterRpcComplete() {
         assert.ok(!done);
         done = true;
         self.ctxRelease(rpcctx);
-    }
-
-    emitter.on('error', onEmitterRpcComplete);
-    emitter.on('end', onEmitterRpcComplete);
+    });
 };
 
 /*
diff --git a/lib/meta.js b/lib/meta.js
index a6c887d..70cc641 100644
--- a/lib/meta.js
+++ b/lib/meta.js
@@ -165,6 +165,8 @@ function sql(rpcctx, statement, values, options) {
         } else {
             res.emit('end');
         }
+
+        res.emit('_moray_internal_rpc_done');
     });
 
     req.on('data', function (msg) {
diff --git a/lib/objects.js b/lib/objects.js
index f4029c4..cd502af 100644
--- a/lib/objects.js
+++ b/lib/objects.js
@@ -141,6 +141,8 @@ function findObjects(rpcctx, bucket, filter, options) {
         } else {
             res.emit('end');
         }
+
+        res.emit('_moray_internal_rpc_done');
     });
 
     req.on('data', function onObject(msg) {
diff --git a/package.json b/package.json
index 9150387..1efe38a 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "moray",
     "description": "Moray client library",
-    "version": "2.0.0",
+    "version": "2.0.1",
     "author": "Joyent (joyent.com)",
     "keywords": [ "moray" ],
     "main": "./lib/index.js",
-- 
2.21.0

