{"project":"joyent/registrar","branch":"master","id":"I4abad89b792eb872a75740181930904afda26a0d","number":"5205","subject":"MANTA-3542 zookeeper reports ephemeral nodes with previous owning sessions MANTA-3544 registrar might be taking a nap","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/5205","commitMessage":"MANTA-3542 zookeeper reports ephemeral nodes with previous owning sessions\nMANTA-3544 registrar might be taking a nap\n","createdOn":1544173675,"lastUpdated":1550255065,"open":true,"status":"NEW","comments":[{"timestamp":1544173675,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1544173702,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548292554,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1548292592,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1550255065,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(19 comments)"}],"currentPatchSet":{"number":"2","revision":"b78310f820d8a3d57b514d8c4ef6174172366256","parents":["f5d5fed79aad40deefa496b52a4c77b407037999"],"ref":"refs/changes/05/5205/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1548292554,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544173702,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":32,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why are we changing the image back to SmartOS 1.6.3 here? Was it a mistake to make the change to multiarch-15.4.1? If it is intentional, the comment above should match the image."},{"file":"README.md","line":327,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Have we taken a look to see if there are any other ZK related parameters that are specified by software?"},{"file":"lib/index.js","line":77,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Comments as to where these numbers came from would be appreciated, otherwise they appear to be magic constants."},{"file":"lib/index.js","line":84,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"indicates"},{"file":"lib/index.js","line":87,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe I\u0027m looking in the wrong place, but I only see register() in register.js+299 taking three arguments. There is no fourth argument. Also the other usage at +138 does not use another argument."},{"file":"lib/index.js","line":206,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe worth a comment that this is only called when shutting down and after using it there\u0027s no way to restart things (if I\u0027m reading this correctly)."},{"file":"lib/register.js","line":75,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think this comment should probably be expanded a little bit. When I next came to the bit where we go ahead and create it, that made me think that this was almost always an erroneous situation that shouldn\u0027t occur. However it\u0027s clear that you\u0027re suggesting that it is valid that it doesn\u0027t exist when we first come up. So maybe worth calling that out as another possibility as otherwise it comes across that the above is the only possibility of hitting this case."},{"file":"lib/register.js","line":92,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Probably worth a brief comment that this covers the NO_NODE case above."},{"file":"lib/register.js","line":104,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Worth a comment as to when this would occur? Perhaps racing with another instance?"},{"file":"lib/register.js","line":141,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is -1 a special version that says to delete all versions of the object? Or why exactly is that our default case? When wouldn\u0027t we expect to have a version?"},{"file":"lib/register.js","line":313,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t see any use of opts.firstRegistration anywhere beyond this assert. Is it used somewhere else?"},{"file":"main.js","line":102,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It feels like we should probably be stripping out the old host properties rather than keeping them in the configuration when we\u0027ve converted them. While node-zkstream probably ignores them we shouldn\u0027t rely on that fact."},{"file":"main.js","line":111,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it expected that in the new configuration that a user would always specify sessionTimeout, as in it\u0027s erroneous to not specify it and rely on the default? It not, then I don\u0027t think we should specify that it uses the old config when it\u0027s missing."},{"file":"main.js","line":113,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably remove cfg.zookeeper.timeout, no?"},{"file":"main.js","line":186,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What are examples of when this would occur? Is the idea that we have received two signals or something else?"},{"file":"main.js","line":205,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we had an unexpected error while unregistering, are we still exiting zero because this is in a teardown path? It feels like we should maybe still communicate that fact."},{"file":"main.js","line":226,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Doesn\u0027t this event only fire when we ourselves actually call .close() on the client? If so, is disconnected the right message here? To me that suggests that we\u0027ll be reconnecting, but my expectation is that this is an event we\u0027ve explicitly triggered, versus a transient underlying socket issue."},{"file":"main.js","line":248,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Are these events meant to purely by informational? It\u0027s not expected that we need to take action on a failed health check of some kind?"},{"file":"main.js","line":282,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason we don\u0027t need to take explicit action on these events?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"README.md","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":163,"deletions":-122},{"file":"lib/register.js","type":"MODIFIED","insertions":191,"deletions":-83},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-135},{"file":"main.js","type":"MODIFIED","insertions":135,"deletions":-50},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":505,"sizeDeletions":-406},"patchSets":[{"number":"1","revision":"4abad89b792eb872a75740181930904afda26a0d","parents":["462748af8326327e5b175c08732970863afc01ad"],"ref":"refs/changes/05/5205/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1544173675,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544173702,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"README.md","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":163,"deletions":-122},{"file":"lib/register.js","type":"MODIFIED","insertions":191,"deletions":-83},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-135},{"file":"main.js","type":"MODIFIED","insertions":135,"deletions":-50},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":505,"sizeDeletions":-406},{"number":"2","revision":"b78310f820d8a3d57b514d8c4ef6174172366256","parents":["f5d5fed79aad40deefa496b52a4c77b407037999"],"ref":"refs/changes/05/5205/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1548292554,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544173702,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":32,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why are we changing the image back to SmartOS 1.6.3 here? Was it a mistake to make the change to multiarch-15.4.1? If it is intentional, the comment above should match the image."},{"file":"README.md","line":327,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Have we taken a look to see if there are any other ZK related parameters that are specified by software?"},{"file":"lib/index.js","line":77,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Comments as to where these numbers came from would be appreciated, otherwise they appear to be magic constants."},{"file":"lib/index.js","line":84,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"indicates"},{"file":"lib/index.js","line":87,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe I\u0027m looking in the wrong place, but I only see register() in register.js+299 taking three arguments. There is no fourth argument. Also the other usage at +138 does not use another argument."},{"file":"lib/index.js","line":206,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe worth a comment that this is only called when shutting down and after using it there\u0027s no way to restart things (if I\u0027m reading this correctly)."},{"file":"lib/register.js","line":75,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think this comment should probably be expanded a little bit. When I next came to the bit where we go ahead and create it, that made me think that this was almost always an erroneous situation that shouldn\u0027t occur. However it\u0027s clear that you\u0027re suggesting that it is valid that it doesn\u0027t exist when we first come up. So maybe worth calling that out as another possibility as otherwise it comes across that the above is the only possibility of hitting this case."},{"file":"lib/register.js","line":92,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Probably worth a brief comment that this covers the NO_NODE case above."},{"file":"lib/register.js","line":104,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Worth a comment as to when this would occur? Perhaps racing with another instance?"},{"file":"lib/register.js","line":141,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is -1 a special version that says to delete all versions of the object? Or why exactly is that our default case? When wouldn\u0027t we expect to have a version?"},{"file":"lib/register.js","line":313,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t see any use of opts.firstRegistration anywhere beyond this assert. Is it used somewhere else?"},{"file":"main.js","line":102,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It feels like we should probably be stripping out the old host properties rather than keeping them in the configuration when we\u0027ve converted them. While node-zkstream probably ignores them we shouldn\u0027t rely on that fact."},{"file":"main.js","line":111,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it expected that in the new configuration that a user would always specify sessionTimeout, as in it\u0027s erroneous to not specify it and rely on the default? It not, then I don\u0027t think we should specify that it uses the old config when it\u0027s missing."},{"file":"main.js","line":113,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably remove cfg.zookeeper.timeout, no?"},{"file":"main.js","line":186,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What are examples of when this would occur? Is the idea that we have received two signals or something else?"},{"file":"main.js","line":205,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we had an unexpected error while unregistering, are we still exiting zero because this is in a teardown path? It feels like we should maybe still communicate that fact."},{"file":"main.js","line":226,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Doesn\u0027t this event only fire when we ourselves actually call .close() on the client? If so, is disconnected the right message here? To me that suggests that we\u0027ll be reconnecting, but my expectation is that this is an event we\u0027ve explicitly triggered, versus a transient underlying socket issue."},{"file":"main.js","line":248,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Are these events meant to purely by informational? It\u0027s not expected that we need to take action on a failed health check of some kind?"},{"file":"main.js","line":282,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason we don\u0027t need to take explicit action on these events?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"README.md","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":163,"deletions":-122},{"file":"lib/register.js","type":"MODIFIED","insertions":191,"deletions":-83},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-135},{"file":"main.js","type":"MODIFIED","insertions":135,"deletions":-50},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":505,"sizeDeletions":-406}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}