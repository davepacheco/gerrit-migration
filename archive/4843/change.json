{"project":"joyent/illumos-joyent","branch":"master","id":"I504b3e4c2ecff2fc5ce62559b4ba11c33e33027c","number":"4843","subject":"OS-6964 Cloud Firewall not affecting bhyve Instances Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/4843","commitMessage":"OS-6964 Cloud Firewall not affecting bhyve Instances\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1536977607,"lastUpdated":1539976720,"open":false,"status":"MERGED","comments":[{"timestamp":1536977607,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1537217081,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(11 comments)"},{"timestamp":1537218021,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1537233169,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(6 comments)\n\nMore to come"},{"timestamp":1537233181,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1537418163,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1537418182,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3."},{"timestamp":1537469581,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1537899826,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1537899844,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4."},{"timestamp":1538539973,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(6 comments)"},{"timestamp":1538542036,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1538542048,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 5."},{"timestamp":1538577265,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 6."},{"timestamp":1538577440,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1538586346,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1538665946,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 6:\n\n(8 comments)"},{"timestamp":1538666420,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1538675780,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 6:\n\n(5 comments)"},{"timestamp":1538675794,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 7."},{"timestamp":1539086885,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1539380639,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1539966700,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 8."},{"timestamp":1539967456,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1539971537,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1539975822,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1539976543,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9: Integration-Approval+1"},{"timestamp":1539976699,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1539976720,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jason King"}],"currentPatchSet":{"number":"10","revision":"504b3e4c2ecff2fc5ce62559b4ba11c33e33027c","parents":["104c53876a87e773ef729efa9419a70fe24933cb"],"ref":"refs/changes/43/4843/10","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1539976699,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539967456,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539971537,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539976543,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1539976720,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":334,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":577,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":944,"sizeDeletions":-15},"patchSets":[{"number":"1","revision":"98134dba705b90047c110c261718d4644e0f7933","parents":["38be33872536bcc6b9b3d97d8ad4b0612822dcec"],"ref":"refs/changes/43/4843/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1536977607,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":313,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"why caps?"},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":313,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Probably because I saw \u0027VND\u0027 in caps above it and it I guess it made me shouty :). I\u0027ll fix."},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":676,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is it acceptable to use __unused in the gate?"},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":676,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"It should be -- it\u0027s defined in sys/ccompile.h and already used a fair amount in illumos-joyent.   I believe where we\u0027ve run into trouble in the past using it is on stuff that may get run on the build machine (e.g. usr/src/tools, proto.strap stuff) where we still support building on older PIs that might be missing the definition."},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":2410,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is this copied from somewhere?  If not, why the odd comment format?"},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":2410,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"It seems to be the style of ipf, so I was trying to be mostly self-consistent."},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":2423,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We should probably ensure this with a VERIFY() on the length"},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":2423,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/common/sys/hook_impl.h","line":214,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Still necessary?"},{"file":"usr/src/uts/common/sys/hook_impl.h","line":214,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Nope."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":491,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason why this is signed?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":491,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Not really.  I\u0027ll change it to unsigned (uint_t)."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2195,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Unless we can be certain of the errors emitted by viona_hook (and it\u0027s underlying callees) then it should probably be filtered down here to prevent it from being ENOSPC.  (Unless the hooks are explicitly designed to provide backpressure like that)"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2195,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"The hook framework itself doesn\u0027t seem to place any restrictions on errors -- it\u0027s really more of a contract between the hook provider (i.e. viona) and any consumers (i.e. ipf).\n\nThough in conjunction with your comment at line 2259, it\u0027d probably be better to just deal with failure here -- even if we get an ENOSPC (it appears packets subject to the \u0027auth\u0027 action could have that happen), there\u0027s no guarantee that any other packets in the chain would also get that (since they could be subject to different actions in ipf that won\u0027t return ENOSPC).\n\nA minor question though -- if we deal with the packets here -- do we still want to include any dropped packets due to the hooks in rx probe drop count (as there\u0027s there are the separate hook drop counters (and hook drop probes)?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2259,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This might be more simple to check at the viona_hook call sight, where we do something like jump to a \u0027hook_freed\u0027 label down at L2283."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2519,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Correct me if I\u0027m wrong, but this will take as many holds on dp as there are data block -- i.e. it will add (n - 1) holds to dp, correct?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2543,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m not sure how well the exiting drop_fail logic behaves if the hook frees the mblk_t.  Are there any guarantees we can make about that happening (or not)."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2543,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Unfortunately no -- though most of the time ipf is probably going to just free it (and set mp_head to NULL).\n\nIt does mean things are a bit clunkier -- we\u0027ll need to take and release some additional references, though I\u0027ve added some question in the review comments in the reference counting, but I will add what I think should work in the update."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2597,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"If dp !\u003d NULL, this will release all the refs taken at line 2519 (n-1 refs), correct?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2604,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"So we\u0027ve taken (n-1), added an additional ref at line 2590, then released (n-1).  That leaves 1 ref left -- where does the second ref this VERIFY is expecting come from?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2672,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Same question about __unused."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2672,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Similar to elsewhere -- it should be fine as long as we\u0027re not trying to do a NATIVE build (i.e. something to run during the build on the build machine) -- the problem is if you\u0027re using the build system headers, __unused might be missing depending on the age of the build instance.  Internal to the gate, it should grab it\u0027s own internal definition from sys/ccompile.h"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2788,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe use an enum with some descriptive names?  Then you could skip the /* # */ comments too."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2788,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2794,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Are any of the cmn_err cases expected to fail in normal operation?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2794,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"They should not -- if we see these, something is fairly amiss with the corresponding net stack instance.  I don\u0027t know if we\u0027d want to go so far as to panic -- other net stack instances might be fine.\n\nWe\u0027d probably still want to create a crash dump if it happens, but we might want the opportunity to defer generating that dump until we\u0027ve taken action with any unaffected instances on the machine."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2999,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The zid comparison can be done outside vni_lock."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2999,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":333,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":556,"deletions":-3},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":923,"sizeDeletions":-18},{"number":"2","revision":"c6d639986882f3c9669edac078bcfc9c9dffcd4f","parents":["38be33872536bcc6b9b3d97d8ad4b0612822dcec"],"ref":"refs/changes/43/4843/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1537233181,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":339,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":563,"deletions":-3},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":935,"sizeDeletions":-18},{"number":"3","revision":"bdd46917fc7d601c322fd9632065e5b8d29a8a63","parents":["38be33872536bcc6b9b3d97d8ad4b0612822dcec"],"ref":"refs/changes/43/4843/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1537418182,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":491,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"uint_t rather than u_int?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":491,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2210,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"\"we\u0027re didn\u0027t\" - Perhaps rephrase since we didn\u0027t have a choice about the deferment?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2210,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2284,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This change isn\u0027t needed now that the error/drop handling is done directly from the hook, right?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2284,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2581,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why not wrap this whole block in an if-stmt that directly checks link-\u003el_neti-\u003evni_nethook.vnh_event_out.he_interested ?  The same could be done for the viona_rx case.  Wrap it in a nice macro if you care."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2581,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2813,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Have you verified that IPF won\u0027t rely on any of these hooks for cloud firewall usage?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2813,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"According to rm and melloc, we don\u0027t generate ipf rules that specify interfaces from the cloud fw rules.  It may be worth implementing these if we decide to start specifying interfaces in rules, though due to timing, I\u0027d prefer to defer that to a separate change.  vnd also does not implement these, so viona would not be at any disadvantage in that respect."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2813,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sounds good"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2819,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This definition could go in the function body, right?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2819,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yes.  Will update."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2848,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Does the spec say that enums must proceed sequentially with their name-\u003evalue assignments?  If not, perhaps make these explicit \u0027progress \u003d \u003cstate\u003e\u0027 statements."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2848,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yes -- 6.7.2.2 of the C standard:\n\nEach subsequent enumerator with no \u003d defines its enumeration constant as the value of the constant expression obtained by adding 1 to the value of the previous enumeration constant. (The use of enumerators with \u003d may produce enumeration constants with values that duplicate other values in the same enumeration.) The enumerators of an enumeration are also known as its members."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":339,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":603,"deletions":-3},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":975,"sizeDeletions":-18},{"number":"4","revision":"9ee01e4382e9bd2a32ff6615918423c2c6bdd97f","parents":["38be33872536bcc6b9b3d97d8ad4b0612822dcec"],"ref":"refs/changes/43/4843/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1537899844,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":790,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Planning to clean this up?"},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":790,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yeah -- A case could be made for ENOENT as well as EPROTONOSUPPORT, but if no one has a preference, I\u0027ll leave it as is.\n\nEither way the caller just cares if the return value is zero or non-zero, so anything beyond that is largely for observability in dtrace."},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":800,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"ret will be uninitialized"},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":800,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Doh!  Nice catch (annoyingly apparently even on DEBUG builds, gcc-4.4.4 doesn\u0027t seem to catch it)."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":525,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Neither possessive nor a contraction, right?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":525,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Arguably this is probably where grammar rules haven\u0027t caught up with technology -- letters and abbreviations can use \u0027s so it is acceptable in at least some circumstances, but I\u0027ve not seen anything for programming language identifiers -- they\u0027re a bit like nouns, but also could be seen like abbreviations.  The original thought was to prevent any potential ambiguity -- \u0027viona_neti_t\u0027 vs. a conceivable (struct) \u0027viona_neti_ts\u0027.\n\nHowever, it\u0027s also not something I feel terribly strongly one way or the other, so I\u0027m fine with changing it."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":525,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Do what you feel"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":738,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I appreciate the comments here and later about VERIFYed failure conditions"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2585,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since this is now enclosed in a block, perhaps use a locally-scoped name for the temporary mblk_t*?  Up to you."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":339,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":618,"deletions":-1},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":990,"sizeDeletions":-16},{"number":"5","revision":"0be9db5200cdbb64f5d1f0b05c224982959062c4","parents":["38be33872536bcc6b9b3d97d8ad4b0612822dcec"],"ref":"refs/changes/43/4843/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1538542048,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":338,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":618,"deletions":-1},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":989,"sizeDeletions":-16},{"number":"6","revision":"8a76315bcfd2c02cdefb039c628106fd031773db","parents":["f5903b691655d2bffd8dfb3bcee76486d7d59240"],"ref":"refs/changes/43/4843/6","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1538577265,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538586346,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":2426,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Obviously remember to remove this comment."},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","line":2426,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":752,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"ourselves"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":752,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"s/failed/fail/"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":752,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":752,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":845,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"nit: Use VERIFY0 since this returns int."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":845,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I\u0027d prefer not to -- I know it\u0027s a strictly personal thing, but I always try to use ASSERT0/VERIFY0 for things where returning 0 denotes success, and the other variants for things where non-zero denotes success."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2949,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I would prefer to see explicit use of the enum symbols here. That way if I ever have to debug this I don\u0027t have to track it in my head."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2949,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Ditto."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2949,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Actually the teardown logic is simple enough let me just put it at the end of the function with a few labels.  That\u0027d be simpler I think."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2990,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"We never actually set progress to this value. It seems like we don\u0027t actually have to consider this case since the \"event out\" step is the last one."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":3125,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Please use VERIFY0 since this returns int."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":3137,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"that is"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":338,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":616,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":987,"sizeDeletions":-15},{"number":"7","revision":"0bd4074fc39d919f69520409bc5074fddfc4afe8","parents":["f5903b691655d2bffd8dfb3bcee76486d7d59240"],"ref":"refs/changes/43/4843/7","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1538675794,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539380639,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539086885,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":334,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":581,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":948,"sizeDeletions":-15},{"number":"8","revision":"b468c1bbab5db53ca1cc89a1ca63d9fc9a4bdb8c","parents":["104c53876a87e773ef729efa9419a70fe24933cb"],"ref":"refs/changes/43/4843/8","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1539966700,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539971537,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539967456,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":334,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":577,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":944,"sizeDeletions":-15},{"number":"9","revision":"cc45edc9951756b00a9ca022c2ef11605b89081c","parents":["104c53876a87e773ef729efa9419a70fe24933cb"],"ref":"refs/changes/43/4843/9","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1539975822,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539971537,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539976543,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539967456,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":334,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":577,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":944,"sizeDeletions":-15},{"number":"10","revision":"504b3e4c2ecff2fc5ce62559b4ba11c33e33027c","parents":["104c53876a87e773ef729efa9419a70fe24933cb"],"ref":"refs/changes/43/4843/10","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1539976699,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539971537,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539976543,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539967456,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1539976720,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ipf/ip_fil_solaris.c","type":"MODIFIED","insertions":334,"deletions":-2},{"file":"usr/src/uts/common/inet/ipf/netinet/ipf_stack.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/sys/hook_impl.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/sys/neti.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":577,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/ipf/ipf.global-objs.debug64","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":944,"sizeDeletions":-15}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}]}