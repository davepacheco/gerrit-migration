From f05c8cbb7283639f700d0f732d3fbfbece6fd9f2 Mon Sep 17 00:00:00 2001
From: Richard Bradley <richard.bradley@joyent.com>
Date: Tue, 26 Sep 2017 10:52:30 +0000
Subject: [PATCH] MANATEE-359 manatee reports primary to sync replication as
 async

---
 lib/postgresMgr.js | 21 +++++++++++++--------
 package.json       |  3 ++-
 2 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/lib/postgresMgr.js b/lib/postgresMgr.js
index be7f693..4580a63 100644
--- a/lib/postgresMgr.js
+++ b/lib/postgresMgr.js
@@ -42,6 +42,7 @@ var url = require('url');
 var util = require('util');
 var vasync = require('vasync');
 var verror = require('verror');
+var xlog = require('xlog');
 
 
 // --- Globals
@@ -2189,7 +2190,8 @@ PostgresMgr.prototype._checkRepl = function (stdby) {
                 replStartTime = Date.now();
                 timeoutId = setTimeout(checkReplication, 1000);
                 return;
-            } else if (!replReplayLoc || replayLoc > replReplayLoc) {
+            } else if (!replReplayLoc ||
+                xlog.xlogCompare(replayLoc, replReplayLoc) > 0) {
                 log.info({
                     oldReplayLoc: replReplayLoc,
                     currReplLoc: replayLoc
@@ -2259,19 +2261,22 @@ PostgresMgr.prototype._checkReplStatus = function (stdby, callback) {
             return callback(err2);
         }
 
-        //TODO: This works by accident.  The format for these is log/offset
-        // It is possible for the offset to be the same in two different logs.
-        var sentLocation = result.sent_location.split('/')[1];
-        sentLocation = parseInt(sentLocation, 16);
-        var flushLocation = result.flush_location.split('/')[1];
-        flushLocation = parseInt(flushLocation, 16);
+        var sentLocation = result.sent_location;
+        var flushLocation = result.flush_location;
 
         log.info({
             primary: sentLocation,
             standby: flushLocation
         }, 'PostgresMgr.checkReplStatus: xlog locations are');
 
-        if (sentLocation === flushLocation) {
+        var xlogComparison = xlog.xlogCompare(sentLocation, flushLocation);
+        /*
+         * There is still the case where we may find that the sync is ahead
+         * of the primary. Manatee doesn't act on this scenario (instead
+         * opting to treat it as the sync not making forward progress), so
+         * we only report whether we've found a match in xlog locations or not.
+         */
+        if (xlogComparison === 0) {
             log.info('exiting checkReplStatus: synchronous standby caught up');
             return callback(null, true, flushLocation);
         } else {
diff --git a/package.json b/package.json
index 1ade043..a4f9a95 100644
--- a/package.json
+++ b/package.json
@@ -28,7 +28,7 @@
         "iniparser": "1.0.5",
         "forkexec": "1.1.0",
         "jsprim": "1.4.0",
-        "manatee-state-machine": "git://github.com/joyent/manatee-state-machine#master",
+        "manatee-state-machine": "git+https://github.com/joyent/manatee-state-machine.git#dev-MANATEE-359",
         "manta": "1.2.6",
         "node-uuid": "1.4.1",
         "joyent-zookeeper-client": "0.2.2",
@@ -43,6 +43,7 @@
         "tab": "0.1.0",
         "vasync": "1.6.2",
         "verror": "1.6.0",
+        "xlog": "git+https://github.com/chudley/node-xlog.git#42d762d84192fd5282b4317f8ba364a14d9a2d64",
         "xtend": "1.0.3"
     },
     "devDependencies": {
-- 
2.21.0

