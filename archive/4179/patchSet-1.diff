From f48d10e4a50187327b4e0438b6d4b79bb4a94a6c Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 11 Jun 2018 20:40:15 +0200
Subject: [PATCH] TOOLS-1776 'sdcadm health' can exit 0 when there are service
 errors

---
 lib/cli/do_check_health.js | 22 +++++++++++++++++-----
 lib/cli/index.js           |  9 ++++++++-
 test/check-health.test.js  | 25 +++++++++++++++++++++----
 3 files changed, 46 insertions(+), 10 deletions(-)

diff --git a/lib/cli/do_check_health.js b/lib/cli/do_check_health.js
index c0f5294..28a7637 100644
--- a/lib/cli/do_check_health.js
+++ b/lib/cli/do_check_health.js
@@ -10,6 +10,7 @@
 
 var tabula = require('tabula');
 var vasync = require('vasync');
+var VError = require('verror').VError;
 
 var common = require('../common');
 var errors = require('../errors');
@@ -175,8 +176,16 @@ function do_check_health(subcmd, opts, args, callback) {
             });
         }
 
-        if (!opts.json && !opts.quiet && errRows.length > 0) {
-            callback(new Error('Some instances appear unhealthy'));
+        if (errRows.length > 0) {
+            var vErr;
+            if (opts.json || opts.quiet) {
+                vErr = new VError({info: {
+                    showErr: false
+                }}, 'Some instances appear unhealthy');
+            } else {
+                vErr = new VError('Some instances appear unhealthy');
+            }
+            callback(vErr);
             return;
         }
 
@@ -200,16 +209,19 @@ function do_check_health(subcmd, opts, args, callback) {
         }
     ]}, function (err) {
         if (err) {
-            return callback(new errors.InternalError(err));
+            callback(new errors.InternalError(err));
+            return;
         }
 
         if (Object.keys(names).length > 0) {
             var msg = 'unrecognized service or instance: ' +
                 Object.keys(names).join(', ');
-            return callback(new errors.UsageError(msg));
+            callback(new errors.UsageError(msg));
+            return;
         }
 
-        return self.sdcadm.checkHealth({ uuids: uuids }, displayResults);
+        self.sdcadm.checkHealth({ uuids: uuids }, displayResults);
+        return;
     });
 }
 
diff --git a/lib/cli/index.js b/lib/cli/index.js
index 4ce888e..821a432 100644
--- a/lib/cli/index.js
+++ b/lib/cli/index.js
@@ -21,6 +21,7 @@ var cmdln = require('cmdln');
 var Cmdln = cmdln.Cmdln;
 var strsplit = require('strsplit');
 var vasync = require('vasync');
+var VError = require('verror').VError;
 var uuid = require('node-uuid');
 var extsprintf = require('extsprintf');
 
@@ -207,6 +208,13 @@ CLI.prototype.fini = function fini(subcmd, err, cb) {
         this.sdcadm.fini();
     }
 
+    // When an error is present, we may want to avoid showing it:
+    if (err && VError.info(err).showErr === false) {
+        this.showErr = false;
+    } else {
+        this.showErr = true;
+    }
+
     if (this.log) {  // On an early error we might not have `log`.
         var exitStatus = (err ? err.exitStatus || 1 : 0);
         var logLevel = 'debug';
@@ -479,7 +487,6 @@ if (require.main === module) {
     cmdln.main(cli, {
         argv: process.argv,
         showCode: true,
-        showErr: true,
         finale: 'softexit'
     });
 }
diff --git a/test/check-health.test.js b/test/check-health.test.js
index e16cfac..2885d60 100644
--- a/test/check-health.test.js
+++ b/test/check-health.test.js
@@ -172,7 +172,6 @@ test('sdcadm check-health --json', function (t) {
 test('sdcadm check-health -q', function (t) {
     exec('sdcadm check-health -q', function (err, stdout, stderr) {
         t.ifError(err);
-
         t.equal(stdout, '');
         t.equal(stderr, '');
 
@@ -216,8 +215,7 @@ test('sdcadm check-health -q with disabled papi', function (t) {
     exec('sdcadm check-health -q', function (err, stdout, stderr) {
         t.equal(err && err.code, 1, 'errcode is 1');
         t.equal('', stdout, 'empty stdout');
-        t.notEqual(stderr.indexOf('Some instances appear unhealthy'), -1,
-            'check-health stderr');
+        t.notEqual('', stderr, 'not empty stderr');
         t.end();
     });
 });
@@ -251,13 +249,32 @@ test('check-health when binder is down', function (t) {
                 exec('sdcadm check-health', function (err, stdout, stderr) {
                     t.equal(err && err.code, 1, 'errcode is 1');
                     t.equal(err.killed, false, 'process not killed');
-                    t.equal(stdout, '');
+                    t.notEqual(stdout, '', 'empty stdout');
                     t.notEqual(
                         stderr.indexOf('Binder service seems to be down'), -1,
                         'binder off stderr');
                     next();
                 });
             },
+            function checkHealthJson(_, next) {
+                exec('sdcadm check-health -j', function (err, stdout, stderr) {
+                    t.equal(err && err.code, 1, 'errcode is 1');
+                    t.equal(err.killed, false, 'process not killed');
+                    t.equal(stderr, '');
+                    var details = common.parseJsonOut(stdout);
+                    if (!details) {
+                        t.ok(false, 'failed to parse JSON');
+                        t.end();
+                        return;
+                    }
+                    var msg = details[0].health_errors[0].message;
+                    t.ok(msg, 'err msg');
+                    t.notEqual(
+                        msg.indexOf('Binder service seems to be down'), -1,
+                        'binder off err');
+                    next();
+                });
+            },
             function enableBinder(_, next) {
                 exec('/usr/sbin/svcadm -z ' +
                     '`/opt/smartdc/bin/sdc-vmname binder` enable binder',
-- 
2.21.0

