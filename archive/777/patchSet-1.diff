From a90d191c9b561b3b58034ed33b524c4e94c95131 Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Fri, 21 Oct 2016 19:02:31 -0700
Subject: [PATCH] IMGAPI-599 IMGAPI client from node-sdc-clients at version
 10.0.2 is not usable

---
 CHANGES.md          |  5 +++++
 lib/imgapi.js       |  4 ++--
 package.json        |  2 +-
 test/imgapi.test.js | 30 ++++++++++++++++++++++++++++++
 4 files changed, 38 insertions(+), 3 deletions(-)
 create mode 100644 test/imgapi.test.js

diff --git a/CHANGES.md b/CHANGES.md
index 216ec15..a8d79c1 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -12,6 +12,11 @@
 
 ## not yet released
 
+## 10.0.3
+
+- IMGAPI-599 IMGAPI client from node-sdc-clients at version 10.0.2 is not
+  usable.
+
 ## 10.0.2
 
 - TOOLS-1584 Ensure 'filters.channel' passed to IMGAPI.listImages wins over a
diff --git a/lib/imgapi.js b/lib/imgapi.js
index 4dbfdd7..375f3d6 100644
--- a/lib/imgapi.js
+++ b/lib/imgapi.js
@@ -65,7 +65,7 @@ var async = require('async');
 var once = require('once');
 var WError = require('verror').WError;
 var assert = require('assert-plus');
-var restify = require('restify');
+var restify = require('restify-clients');
 var mod_url = require('url');
 var backoff = require('backoff');
 var auth = require('smartdc-auth');
@@ -1057,7 +1057,7 @@ function adminImportRemoteImageAndWait(uuid, source, options, callback) {
                 delay: delay
             }, 'retry ready');
 
-            self.client.post(reqOpts, function (err, req, res, obj) {
+            self.client.post(reqOpts, {}, function (err, req, res, obj) {
                 if (err) {
                     theResponse = res;
                     return retry.backoff(err);
diff --git a/package.json b/package.json
index f93cf6d..7854d30 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdc-clients",
   "description": "node.js client libraries for Triton core REST APIs.",
-  "version": "10.0.2",
+  "version": "10.0.3",
   "homepage": "http://www.joyent.com",
   "repository": {
     "type": "git",
diff --git a/test/imgapi.test.js b/test/imgapi.test.js
new file mode 100644
index 0000000..e3c3eee
--- /dev/null
+++ b/test/imgapi.test.js
@@ -0,0 +1,30 @@
+var bunyan = require('bunyan');
+var test = require('tape');
+
+var IMGAPI = require('../lib/index').IMGAPI;
+
+var IMGAPI_URL = 'http://' + (process.env.IMGAPI_IP || '10.99.99.21');
+
+test('imgapi', function (tt) {
+    tt.test(' setup', function (t) {
+        var log = bunyan.createLogger({
+            name: 'imgapi_unit_test',
+            stream: process.stderr,
+            level: (process.env.LOG_LEVEL || 'info'),
+            serializers: bunyan.stdSerializers
+        });
+
+        var imgapi = new IMGAPI({
+            url: IMGAPI_URL,
+            retry: {
+                retries: 1,
+                minTimeout: 1000
+            },
+            log: log
+        });
+
+        imgapi.close();
+
+        t.end();
+    });
+});
-- 
2.21.0

