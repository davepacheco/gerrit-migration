{"project":"joyent/illumos-joyent","branch":"master","id":"I4d9d12261073bfc532764822006c3e7f9643fc75","number":"1788","subject":"OS-5849 SES topology information needs to search STP Bridge ports OS-6058 mpt_sas needs to set bridge-port property for SATA devices OS-6059 mptsas_handle_topo_change() can return without locks held Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Reviewed ","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/1788","commitMessage":"OS-5849 SES topology information needs to search STP Bridge ports\nOS-6058 mpt_sas needs to set bridge-port property for SATA devices\nOS-6059 mptsas_handle_topo_change() can return without locks held\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1492109153,"lastUpdated":1494443130,"open":false,"status":"MERGED","comments":[{"timestamp":1492109153,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1492111371,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1492117907,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1492117915,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1492508474,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1494027265,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(3 comments)"},{"timestamp":1494262460,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1494262478,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1494263097,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1494285263,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1494435740,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1494435842,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1494443130,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"5","revision":"4d9d12261073bfc532764822006c3e7f9643fc75","parents":["67ae4a47f8aa6210fb53c27be828fbbff06598b2"],"ref":"refs/changes/88/1788/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1494435842,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494263097,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1494443130,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":136,"deletions":-2}],"sizeInsertions":238,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"7e207e20bd2b433d604bf9b26d889f14d6c788b3","parents":["3a0b3ce4b0776b70f28ed47f1b86cbea5d59d864"],"ref":"refs/changes/88/1788/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1492109153,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","line":26,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Drop the \"All rights reserved\", as per eng.git example."},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","line":26,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":6168,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"change if a SATA"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":6168,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"How about:\n\nWe have a SATA target that has changed, which means the \"bridge-port\" property must be updated to reflect the SAS WWN of the new attachment point."},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":6168,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":6168,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":6625,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Are you sure an early return is the right answer here?  What about \"\u0026mpt-\u003em_mutex\"?  It looks like we\u0027re asserting it is held on the way into the function, but then we drop it at L6579.   Also, what about all of the subsequent stuff that would previously still have happened below?"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":6625,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027ve opened OS-6059 to handle this as it\u0027s a big problem in this entire function. It\u0027ll be fixed as part of this change."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":129,"deletions":-1}],"sizeInsertions":231,"sizeDeletions":-5},{"number":"2","revision":"d4ed27e3f26f68580b699c4dcf2206648cc5eaa5","parents":["3a0b3ce4b0776b70f28ed47f1b86cbea5d59d864"],"ref":"refs/changes/88/1788/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1492117907,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494027265,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494027265,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1492508474,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","line":510,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: definition could be moved inside the first for-loop, if you felt like it."},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","line":510,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I opted not to move this at this time."},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","line":1142,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: I think this would reads easier with the comma moved after \u0027then\u0027"},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","line":1142,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","line":1143,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: append comma"},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","line":1143,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":136,"deletions":-2}],"sizeInsertions":238,"sizeDeletions":-6},{"number":"3","revision":"4f9d2ee9f6092355e438b2a15e6e055cf3705f99","parents":["3a0b3ce4b0776b70f28ed47f1b86cbea5d59d864"],"ref":"refs/changes/88/1788/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1494262460,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494263097,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":136,"deletions":-2}],"sizeInsertions":238,"sizeDeletions":-6},{"number":"4","revision":"00ecd34dffbabbebff43d67be5c92b2dd16db7f5","parents":["67ae4a47f8aa6210fb53c27be828fbbff06598b2"],"ref":"refs/changes/88/1788/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1494435740,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494263097,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":136,"deletions":-2}],"sizeInsertions":238,"sizeDeletions":-6},{"number":"5","revision":"4d9d12261073bfc532764822006c3e7f9643fc75","parents":["67ae4a47f8aa6210fb53c27be828fbbff06598b2"],"ref":"refs/changes/88/1788/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1494435842,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1494443130,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494285263,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494263097,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":136,"deletions":-2}],"sizeInsertions":238,"sizeDeletions":-6}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}