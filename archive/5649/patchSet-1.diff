From 6cab799e2a2d85a54f7c7b7f549f19012e26c13a Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Wed, 27 Feb 2019 11:20:46 -0800
Subject: [PATCH] TRITON-1267 workflow crashing due to a bad
 wf_job_overhead_seconds calculation

---
 lib/runner.js | 35 ++++++++++++++++++++++++++---------
 package.json  |  2 +-
 2 files changed, 27 insertions(+), 10 deletions(-)

diff --git a/lib/runner.js b/lib/runner.js
index 015ea0a..baf0c83 100644
--- a/lib/runner.js
+++ b/lib/runner.js
@@ -143,21 +143,27 @@ var WorkflowRunner = module.exports = function (opts) {
             metricJobCounter.increment(labels);
 
             function calculateDuration(job) {
-                var durationSeconds;
+                var durationSeconds = 0;
                 if (job.chain_results.length) {
                     var lastTask = job.
                         chain_results[job.chain_results.length - 1];
-                    if (lastTask.finished_at) {
+                    if (lastTask.started_at && lastTask.finished_at) {
                         var endMs = new Date(lastTask.finished_at).getTime();
                         var startMs = new Date(job.created_at).getTime();
                         durationSeconds = (endMs - startMs) / 1000;
                     }
                 }
 
-                if (!durationSeconds) {
+                if (!durationSeconds && job.elapsed) {
                     durationSeconds = job.elapsed;
                 }
 
+                if (durationSeconds < 0) {
+                    log.error({durationSeconds: durationSeconds},
+                        'calculateDuration:: negative duration - using 0');
+                    durationSeconds = 0;
+                }
+
                 return durationSeconds;
             }
 
@@ -170,17 +176,28 @@ var WorkflowRunner = module.exports = function (opts) {
                     jobCreated;
                 var startOverhead = (firstJobStarted - jobCreated) / 1000;
                 var overheadSeconds = job.chain_results.reduce(
-                    function sumOverhead(total, result, idx, chainResults) {
+                        function sumOverhead(total, result, idx, chainResults) {
+
+                    // Skip tasks that do not have a started/finished entry.
+                    if (!result.started_at || !result.finished_at) {
+                        log.warn({result: result},
+                            'calculateOverhead:: invalid result - skipping');
+                        return total;
+                    }
+
                     var nextTask = chainResults[idx + 1];
-                    if (nextTask &&
-                        nextTask.started_at &&
-                        result.finished_at) {
+                    if (nextTask && nextTask.started_at) {
                         var nextTaskStartMs = new Date(nextTask.started_at)
                             .getTime();
                         var currentTaskEndMs = new Date(result.finished_at)
                             .getTime();
-                        total = (nextTaskStartMs - currentTaskEndMs) / 1000
-                            + total;
+                        var deltaMs = nextTaskStartMs - currentTaskEndMs;
+                        if (deltaMs > 0) {
+                            total += deltaMs / 1000;
+                        } else if (deltaMs < 0) {
+                            log.warn({result: result, nextResult: nextTask},
+                                'calculateOverhead:: negative overhead - skip');
+                        }
                     }
 
                     return total;
diff --git a/package.json b/package.json
index 22550ee..2a03686 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "wf",
     "description": "Tasks Workflows orchestration API and runners",
-    "version": "1.2.1",
+    "version": "1.2.2",
     "repository": {
         "type": "git",
         "url": "git://github.com/joyent/node-workflow.git"
-- 
2.21.0

