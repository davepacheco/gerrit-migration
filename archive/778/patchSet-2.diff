From 23635a8f821ae71ce7f9b610fab0e21604c2a47f Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Tue, 25 Oct 2016 16:48:33 +0000
Subject: [PATCH] OS-5743 epoll_create1 should toss EINVAL for invalid flags
 Reviewed by: Jerry Jelinek <jerry.jelinek@joyent.com> Approved by: Jerry
 Jelinek <jerry.jelinek@joyent.com>

---
 usr/src/lib/libc/port/sys/epoll.c             |  9 +++-
 usr/src/test/os-tests/runfiles/default.run    |  2 +
 usr/src/test/os-tests/tests/poll/Makefile     | 10 +---
 usr/src/test/os-tests/tests/poll/epoll_test.c | 51 +++++++++++++++++++
 4 files changed, 63 insertions(+), 9 deletions(-)
 create mode 100644 usr/src/test/os-tests/tests/poll/epoll_test.c

diff --git a/usr/src/lib/libc/port/sys/epoll.c b/usr/src/lib/libc/port/sys/epoll.c
index 543856b2ec..34cb151135 100644
--- a/usr/src/lib/libc/port/sys/epoll.c
+++ b/usr/src/lib/libc/port/sys/epoll.c
@@ -95,8 +95,15 @@ epoll_create1(int flags)
 {
 	int fd, oflags = O_RDWR;
 
-	if (flags & EPOLL_CLOEXEC)
+	if (flags & EPOLL_CLOEXEC) {
 		oflags |= O_CLOEXEC;
+		flags ^= EPOLL_CLOEXEC;
+	}
+	/* Reject unrecognized flags */
+	if (flags != 0) {
+		errno = EINVAL;
+		return (-1);
+	}
 
 	if ((fd = open("/dev/poll", oflags)) == -1)
 		return (-1);
diff --git a/usr/src/test/os-tests/runfiles/default.run b/usr/src/test/os-tests/runfiles/default.run
index c209180fba..9e687d0783 100644
--- a/usr/src/test/os-tests/runfiles/default.run
+++ b/usr/src/test/os-tests/runfiles/default.run
@@ -11,6 +11,7 @@
 
 #
 # Copyright (c) 2012 by Delphix. All rights reserved.
+# Copyright 2016 Joyent, Inc.
 #
 
 [DEFAULT]
@@ -23,6 +24,7 @@ outputdir = /var/tmp/test_results
 
 [/opt/os-tests/tests/poll_test]
 user = root
+tests = ['poll_test', 'epoll_test']
 
 [/opt/os-tests/tests/secflags]
 user = root
diff --git a/usr/src/test/os-tests/tests/poll/Makefile b/usr/src/test/os-tests/tests/poll/Makefile
index 5e2d6e8ad9..66ee75160e 100644
--- a/usr/src/test/os-tests/tests/poll/Makefile
+++ b/usr/src/test/os-tests/tests/poll/Makefile
@@ -11,12 +11,13 @@
 
 #
 # Copyright (c) 2012 by Delphix. All rights reserved.
+# Copyright 2016 Joyent, Inc.
 #
 
 include $(SRC)/cmd/Makefile.cmd
 include $(SRC)/test/Makefile.com
 
-PROG = poll_test
+PROG = poll_test epoll_test
 OBJS = $(PROG:%=%.o)
 SRCS = $(OBJS:%.o=%.c)
 
@@ -31,13 +32,6 @@ $(CMDS) := FILEMODE = 0555
 
 all: $(PROG)
 
-$(PROG): $(OBJS)
-	$(LINK.c) $(OBJS) -o $@ $(LDLIBS)
-	$(POST_PROCESS)
-
-%.o: ../%.c
-	$(COMPILE.c) $<
-
 install: all $(CMDS)
 
 lint: lint_SRCS
diff --git a/usr/src/test/os-tests/tests/poll/epoll_test.c b/usr/src/test/os-tests/tests/poll/epoll_test.c
new file mode 100644
index 0000000000..bcdeef2ccf
--- /dev/null
+++ b/usr/src/test/os-tests/tests/poll/epoll_test.c
@@ -0,0 +1,51 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright 2016 Joyent, Inc.
+ */
+
+
+#include <stdlib.h>
+#include <stdio.h>
+#include <unistd.h>
+#include <fcntl.h>
+#include <sys/epoll.h>
+#include <errno.h>
+#include <assert.h>
+
+int
+main()
+{
+	int fd, flags;
+
+	fd = epoll_create1(0);
+	assert(fd >= 0);
+
+	flags = fcntl(fd, F_GETFD);
+	assert(flags != -1 && (flags & FD_CLOEXEC) == 0);
+	(void) close(fd);
+
+
+	fd = epoll_create1(EPOLL_CLOEXEC);
+	assert(fd >= 0);
+
+	flags = fcntl(fd, F_GETFD);
+	assert(flags != -1 && (flags & FD_CLOEXEC) == FD_CLOEXEC);
+	(void) close(fd);
+
+	fd = epoll_create1(EPOLL_CLOEXEC * 3);
+	assert(fd == -1 && errno == EINVAL);
+	fd = epoll_create1(EPOLL_CLOEXEC * 2);
+	assert(fd == -1 && errno == EINVAL);
+
+	return (0);
+}
-- 
2.21.0

