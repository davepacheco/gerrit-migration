From 212a0ac48ad43c3a4a29dae7f29c813944c3467d Mon Sep 17 00:00:00 2001
From: Christopher Horrell <christopher@joyent.com>
Date: Tue, 23 May 2017 13:58:25 -0400
Subject: [PATCH] IMGAPI-626: Add custom image creation support for OpenBSD

---
 tools/prepare-image/bsd-prepare-image | 98 ++++++++++++++++-----------
 1 file changed, 59 insertions(+), 39 deletions(-)

diff --git a/tools/prepare-image/bsd-prepare-image b/tools/prepare-image/bsd-prepare-image
index a4144ca..a44adf2 100755
--- a/tools/prepare-image/bsd-prepare-image
+++ b/tools/prepare-image/bsd-prepare-image
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
 #
@@ -14,7 +14,7 @@
 # for a *BSD guest of a SmartOS hypervisor. See the "PREPARE IMAGE SCRIPTS"
 # section of `man imgadm`.
 #
-# Intended supported distros: FreeBSD.
+# Intended supported distros: FreeBSD and OpenBSD.
 #
 
 set -o errexit
@@ -69,27 +69,6 @@ function cleanup_tmp() {
     rm -rf /tmp/*
 }
 
-function cleanup_root() {
-    # Cleaning up root account
-    
-    # Delete mail if it exists
-    if [[ -e /var/mail/root ]] ; then
-       rm -rf /var/mail/root
-    fi
-    
-    # Delete history
-    rm -f /root/.history
-    if [[ -e /root/.bash_history ]] ; then
-       rm -f /root/.bash_history
-    fi
-    
-    history -c
-
-    # Removing password for root
-    pw mod user root -w none
-    pw mod user toor -w none
-}
-
 function cleanup_ssh() {
     find /etc/ssh -type f -name "ssh_host_*" | xargs rm -f
     FILELIST='authorized_keys known_hosts id_dsa id_dsa.pub id_rsa id_rsa.pub ssh_config'
@@ -100,40 +79,79 @@ function cleanup_ssh() {
     done
 }
 
-function cleanup_disks() {
-    echo "removing /dev/vtbd1 entries from fstab"
-    sed -i' ' '/^\/dev\/vtbd1/d' /etc/fstab
+# Deleting ssh host keys. In FreeBSD and OpenBSD they will be recreated at
+# boot via `ssh-keygen -A` in /etc/rc
+function cleanup_hostkeys() {
+    rm -rf /etc/ssh/ssh_host_*
 }
 
-function cleanup_hostname() {
-    # Removes the hostname entry from /etc/rc.conf
-    # This gets re-added by /lib/smartdc/set-hostname
-    sed -i' ' '/^hostname=/d' /etc/rc.conf
+# Remove DHCP leases
+function cleanup_dhcp_leases() {
+    find /var/db -type f -name "dhclient.leases.*" | xargs rm -f
 }
 
+function cleanup_root() {
+    # Cleaning up root account
+
+    # Delete mail if it exists
+    if [[ -e /var/mail/root ]] ; then
+       rm -rf /var/mail/root
+    fi
+
+    # clear shell history
+    history -c
+
+    # Delete history
+    rm -f /root/.history
+    if [[ -e /root/.bash_history ]] ; then
+       rm -f /root/.bash_history
+    fi
+}
 
 function prepare_freebsd() {
     # Cleaning up network devices. Network interfaces are added at boot via
     # /lib/smartdc/add-network-interface
     sed -i' ' '/^ifconfig_vtnet/d' /etc/rc.conf
 
-    # Remove DHCP leases
-    find /var/db -type f -name "dhclient.leases.*" | xargs rm -f
-    
     # Clean up entropy files generated by cron
     find /var/db/entropy -type f -name "saved-entropy.*" | xargs rm -f
-    
+
     # Remove hostid file
     rm -rf /etc/hostid
-    
+
     # Clean up local cache of all packages
     pkg clean -a -y
+
+    # Removing /dev/vtbd1 entries from fstab
+    sed -i' ' '/^\/dev\/vtbd1/d' /etc/fstab
+
+    # Removes the hostname entry from /etc/rc.conf
+    # This gets re-added by /lib/smartdc/set-hostname
+    sed -i' ' '/^hostname=/d' /etc/rc.conf
+
+    # Remove password for root
+    pw mod user root -w none
+    pw mod user toor -w none
+}
+
+function prepre_openbsd() {
+    # Cleanup network interfaces
+    rm -rf /etc/hostname.*
+
+    # Removing /dev/vtbd1 entries from fstab
+    sed -i' ' '/\/data/d' /etc/fstab
+
+    # Delete hostname
+    rm -rf /etc/myname
+
+    # Remove root password. The root passord is set at first boot via the
+    # guest tools to the value of `mdata-get root_pw`.
+    # See /lib/smartdc/set-rootpassword
+    usermod -p "*" root
 }
 
 # Makes sure that /lib/smartdc et al are sane.
 function prepare_lib_smartdc() {
-    local DISTRO=$1
-
     # Per IMAGE-446 we need to remove the firstboot guard file for a new image.
     rm -f /lib/smartdc/.firstboot-complete-do-not-delete
 }
@@ -150,6 +168,8 @@ TARGET_OS=$(uname -s)
 
 if [[ "$TARGET_OS" == "FreeBSD" ]]; then
     prepare_freebsd
+elif [[ "$TARGET_OS" == "OpenBSD" ]]; then
+    prepre_openbsd
 else
     echo "OS $TARGET_OS is not supported."
     exit 1
@@ -159,9 +179,9 @@ fi
 prepare_lib_smartdc
 cleanup_logs
 cleanup_tmp
-cleanup_disks
 cleanup_ssh
-cleanup_hostname
+cleanup_hostkeys
+cleanup_dhcp_leases
 cleanup_root
 
 history -c
-- 
2.21.0

