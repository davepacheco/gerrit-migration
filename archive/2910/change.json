{"project":"joyent/illumos-joyent","branch":"master","id":"Ia5d2534e6a7c00d6d07b25a15157bae43148f887","number":"2910","subject":"OS-5423 deadlock between netstack teardown and kstat read Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Ryan Zezeski \u003crpz@joyent.com\u003e","owner":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"url":"https://cr.joyent.us/2910","commitMessage":"OS-5423 deadlock between netstack teardown and kstat read\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Ryan Zezeski \u003crpz@joyent.com\u003e\n","createdOn":1509931241,"lastUpdated":1510344929,"open":false,"status":"MERGED","comments":[{"timestamp":1509931241,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 1."},{"timestamp":1510003545,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(2 comments)\n\nJust a couple of nits for a first pass"},{"timestamp":1510004330,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1510005236,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(6 comments)\n\nThank you for your comments.  Will post fixes late tonight or tomorrow."},{"timestamp":1510015932,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)\n\nIncoming patch after this."},{"timestamp":1510015942,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 2."},{"timestamp":1510077215,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)\n\nIn general, this looks good. There\u0027s one minor issue that I\u0027ve noticed, but otherwise I think the broader pieces look good."},{"timestamp":1510088653,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1510088714,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 3."},{"timestamp":1510089177,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1510119822,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1510167448,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3:\n\nTesting notes updated on bug report."},{"timestamp":1510191878,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1510191947,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 4."},{"timestamp":1510192669,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1510196079,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1510330084,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1510330226,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1510330315,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1510342855,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1510344647,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 7: Integration-Approval+1"},{"timestamp":1510344906,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1510344929,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dan McDonald"}],"currentPatchSet":{"number":"8","revision":"a5d2534e6a7c00d6d07b25a15157bae43148f887","parents":["b164e87ae56fcf64dbfbba90ada71d50466bece5"],"ref":"refs/changes/10/2910/8","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510344906,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510192669,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510196079,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510342855,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510344647,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1510344929,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},"patchSets":[{"number":"1","revision":"74be4f04cc6d7fce263b4aef52f2873c19ea0288","parents":["89c21f67229b51622e167d92b9eb978f9a6ba89c"],"ref":"refs/changes/10/2910/1","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1509931241,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/netstack.c","line":135,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yes, I\u0027m not sure how we really want to change it, since the only real thing we could do is make it an /etc/system tunable."},{"file":"usr/src/uts/common/os/netstack.c","line":135,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Should it be a #define, though?  Or just a number with a comment above it?  I\u0027m fine either way, and will take number-and-comment if nobody cares."},{"file":"usr/src/uts/common/os/netstack.c","line":135,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"/etc/system tunable + comment."},{"file":"usr/src/uts/common/os/netstack.c","line":1160,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"While it\u0027s tempting to focus on the case of kstats, I think it\u0027s better to phrase this from the perspective that this may be called from any arbitrary context from any subsystem and that we want to avoid re-entrant behavior."},{"file":"usr/src/uts/common/os/netstack.c","line":1160,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Will fix."},{"file":"usr/src/uts/common/os/netstack.c","line":1168,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why can\u0027t we? I mean, if we\u0027re in a high-level interrupt context that\u0027s one thing, but otherwise, what stops us from grabbing it and blocking?"},{"file":"usr/src/uts/common/os/netstack.c","line":1168,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"We\u0027ll never be in a high-enough-level interrupt to not stress blocking?!  If so, I\u0027ll just get rid of the is_not_intr check and additonally, use KM_SLEEP per your suggestion below."},{"file":"usr/src/uts/common/os/netstack.c","line":1173,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Nit: typo"},{"file":"usr/src/uts/common/os/netstack.c","line":1173,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Will fix. It\u0027s a KEBE comment so it needs fixing anyway."},{"file":"usr/src/uts/common/os/netstack.c","line":1179,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Nit: typo"},{"file":"usr/src/uts/common/os/netstack.c","line":1179,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Will also fix."},{"file":"usr/src/uts/common/os/netstack.c","line":1194,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why can\u0027t we pass TQ_SLEEP and simplify the taskq dispatch? Given that we should only be here from either user, kernel, or low-level interrupt context, there shouldn\u0027t be any problem blocking here for memory and backpressure. Otherwise we might as well assume that we\u0027re going to take our chance, fail, and hang some part of the system."},{"file":"usr/src/uts/common/os/netstack.c","line":1194,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I wasn\u0027t sure if we\u0027d ever be in sufficiently high enough interrupt context.  As per above, I can both get rid of the is_not_intr check, AND make this TQ_SLEEP."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":105,"deletions":-36}],"sizeInsertions":105,"sizeDeletions":-36},{"number":"2","revision":"42b4778f78e1563a07a34406fefad52aac83bdc4","parents":["89c21f67229b51622e167d92b9eb978f9a6ba89c"],"ref":"refs/changes/10/2910/2","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510015942,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/netstack.c","line":131,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This should be unsigned to match sema_init."},{"file":"usr/src/uts/common/os/netstack.c","line":131,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Oops, will fix."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},{"number":"3","revision":"df1ac0749c1c669aa96f9f421404ca973e9eb1cc","parents":["89c21f67229b51622e167d92b9eb978f9a6ba89c"],"ref":"refs/changes/10/2910/3","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510088714,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510089177,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510119822,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"usr/src/uts/common/os/netstack.c","line":1166,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Oops, it should be hrtime_t not hrtime_t *."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},{"number":"4","revision":"ff543a8a3375fe964e8c204dcd3cb3e9e38c96c9","parents":["5e29c052608c174f3dbe935f06a530ec7b6839f9"],"ref":"refs/changes/10/2910/4","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510191947,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510196079,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510192669,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},{"number":"5","revision":"661f40ec34768baea1f78b84bc9d45b5ef4a0e07","parents":["7dd996f96ad1fff4ba9219b2ff8108c83c73e67e"],"ref":"refs/changes/10/2910/5","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510330084,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510196079,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510192669,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},{"number":"6","revision":"94a5c421dcecc262e789033f2c336ad5bd884b81","parents":["7dd996f96ad1fff4ba9219b2ff8108c83c73e67e"],"ref":"refs/changes/10/2910/6","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510330226,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510196079,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510192669,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},{"number":"7","revision":"38f5123dc5cc89ae20ebc24ebab7b521db4d0f5d","parents":["b164e87ae56fcf64dbfbba90ada71d50466bece5"],"ref":"refs/changes/10/2910/7","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510330315,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510342855,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510196079,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510344647,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510192669,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37},{"number":"8","revision":"a5d2534e6a7c00d6d07b25a15157bae43148f887","parents":["b164e87ae56fcf64dbfbba90ada71d50466bece5"],"ref":"refs/changes/10/2910/8","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1510344906,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510342855,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510196079,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510344647,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510192669,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1510344929,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/netstack.c","type":"MODIFIED","insertions":83,"deletions":-37}],"sizeInsertions":83,"sizeDeletions":-37}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}