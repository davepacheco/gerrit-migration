{"project":"joyent/manta-muskie","branch":"master","topic":"MANTA-2980","id":"I458cb87bf8d9848ce040ebf53713dfd85d145be0","number":"1738","subject":"MANTA-2980 electric-moray should report moray shard for putObject operations MANTA-3123 muskie shark errors should be more explicit Reviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/1738","commitMessage":"MANTA-2980 electric-moray should report moray shard for putObject operations\nMANTA-3123 muskie shark errors should be more explicit\nReviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1491255010,"lastUpdated":1525810034,"open":false,"status":"MERGED","comments":[{"timestamp":1491255010,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1491255035,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491256189,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1:\n\n(1 comment)\n\nI know you\u0027re not finished with this, but it would be good to have some examples of what the output looks like in a comment in the ticket."},{"timestamp":1491256889,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(1 comment)\n\nSample output (note the morayContacted field). This is output from putObject in the muskie logs.\n\n[2017-04-03T19:54:51.184Z]  INFO: muskie/HttpServer/32461 on 50c22e29-e0c5-47c7-9941-9806a9c0e86e: handled: 204 (audit\u003dtrue, _audit\u003dtrue, operation\u003dputobject, billable_operation\u003dPUT, bytesTransferred\u003d531, logicalRemoteAddress\u003d\u003cip\u003e, remoteAddress\u003d127.0.0.1, remotePort\u003d12345, reqHeaderLength\u003d837, resHeaderLength\u003d277, latency\u003d418, latencyToFirstByte\u003d106, req.owner\u003d7dbc1d12-bb60-4627-aa73-a1c04f74b549)\n    PUT /kkantor/stor/env.sh HTTP/1.1\n    accept: application/json\n    content-length: 531\n    content-type: application/x-sh\n    expect: 100-continue\n    x-request-id: 0379dfd4-4817-4503-aa69-fd8bd0ae5351\n    date: Mon, 03 Apr 2017 19:54:51 GMT\n    server: Manta\n    x-request-id: 0379dfd4-4817-4503-aa69-fd8bd0ae5351\n    x-response-time: 418\n    x-server-name: 50c22e29-e0c5-47c7-9941-9806a9c0e86e\n    --\n    sharksContacted: [\n      {\n        \"shark\": \"2.stor.emy-16.joyent.us\",\n        \"result\": \"ok\",\n        \"timeToFirstByte\": 38,\n        \"timeTotal\": 103,\n        \"_startTime\": 1491249290829\n      },\n      {\n        \"shark\": \"3.stor.emy-16.joyent.us\",\n        \"result\": \"ok\",\n        \"timeToFirstByte\": 34,\n        \"timeTotal\": 98,\n        \"_startTime\": 1491249290834\n      }\n    ]\n    --\n    morayContacted: {\n      \"pnode\": \"tcp://2.moray.emy-16.joyent.us:2020\",\n      \"vnode\": 9590275,\n      \"data\": 1\n    }\n    -- ... \n    }"},{"timestamp":1492441511,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1492441537,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492469088,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThanks!\n\nIt seems like this change includes changes for MANTA-3123 as well?\n\nExactly which operations does this change logging for?  It seems like saveMetadata is only used for PUTs, but from the output, this seems to have affected deletes as well?  Does it affect GETs when there was no object found in electric-moray?"},{"timestamp":1492717187,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\nThis will only change logging for putObject operations. I included the others for the sake of documentation - the logging for those operations was added in the past.\n\nThis does include changes for MANTA-3123. The only other case where InternalError is used in the shark logic without providing a cause that I was not able to reproduce (and hasn\u0027t happened recently according to muskie logs).\n\nIf the object is not found in e-moray, the shard will not appear in the log message. I think that depends on MANTA-3152 which in turn depends on MANTA-3223."},{"timestamp":1504218775,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1504218802,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504628586,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(2 comments)\n\nThanks for taking this on (again)!\n\nGiven that the scope of this change is a bit more narrow now -- i.e., only for successful putObjects -- should we clarify the summary of the ticket a bit? I know that the summary for MANTA-3379 refers to failed requests, and is more general than just for `putObject` requests. Maybe the summary for this ticket could reflect its specificity, making it easier to nail down where we have deficiencies in reporting shard information in muskie logs."},{"timestamp":1504634766,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(1 comment)\n\nThanks Jordan!"},{"timestamp":1504733548,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1504903574,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1504903603,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504908478,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1505138351,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1524839777,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5."},{"timestamp":1524866260,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525369629,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1525804481,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1525804512,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1525805029,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1525809807,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1525810034,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"7","revision":"458cb87bf8d9848ce040ebf53713dfd85d145be0","parents":["001ad25d174ab11ba2244b5e8a6cb81eacd4245c"],"ref":"refs/changes/38/1738/7","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1525809807,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524866260,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369629,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525805029,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1525810034,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":14,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"affcf28f23b303949b11e9b420b368676f78c37b","parents":["088593bea07bbe9ac53129da0d452ca25765f24e"],"ref":"refs/changes/38/1738/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1491255010,"author":{"name":"Kody Kantor","email":"Kody.Kantor@gmail.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491255035,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/audit.js","line":236,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is this intended to be different from {entry,parent}Shard?"},{"file":"lib/audit.js","line":236,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Good question. I don\u0027t know off the top of my head where those are used (or if they\u0027re used at the same time as the new code). I may be able to use them instead of a new field."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-1},{"number":"2","revision":"91599e804f9be049a4387f2ca9ff0179fc8b537f","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/38/1738/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1492441511,"author":{"name":"Kody Kantor","email":"Kody.Kantor@gmail.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492441537,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":8,"deletions":-5}],"sizeInsertions":9,"sizeDeletions":-6},{"number":"3","revision":"4cf73923cd4079b460d7a0a440bb410b8f0125d0","parents":["1b6dd87b0d30fa14e046214ab972f87dc57d4cc0"],"ref":"refs/changes/38/1738/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1504218775,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504218802,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":11,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: For consistency\u0027s sake, I think we should still refer to this module as \"assert\", as that\u0027s how we name it in the rest of the repository."},{"file":"lib/errors.js","line":189,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"What\u0027s the advantage of throwing an error here, as opposed to just failing the assert?"},{"file":"lib/errors.js","line":189,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Good question! Since we have to check that \u0027cause\u0027 is an Error it\u0027s not super straightforward to use the \u0027assert\u0027 library. Would you prefer something like \u0027assert.equal(true, cause instanceof Error)\u0027? If we did that, I can get rid of the instanceof check in the \u0027if\u0027 statement. That\u0027s fine with me and would be functionally equivalent."},{"file":"lib/errors.js","line":189,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"What about using `assert.ok()`?\n\ne.g.: assert.ok(!cause || cause instanceof Error)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":6,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":15,"sizeDeletions":-7},{"number":"4","revision":"2e2199b12f8cdbfce160957e46f11b96dc9c2240","parents":["6c8139fc821dfe87ab0a8eec620a81f81e9831d3"],"ref":"refs/changes/38/1738/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1504903574,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504903603,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504908478,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"lib/errors.js","line":187,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"A quick search through muskie leads me to believe you addressed the errors this would break -- namely, the ones passing in strings to the constructor instead of an error. Could we document that the errors in muskie that will be broken from this have been updated in the ticket?"},{"file":"lib/errors.js","line":187,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yep! The only place in Muskie that was passing a string into the InternalError function was in the sharkStreams function, which is being fixed as part of this commit. The other locations that use InternalError call the function with either no argument or an \u0027Error\u0027 object."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-5}],"sizeInsertions":12,"sizeDeletions":-7},{"number":"5","revision":"f863dea44eb397c9923307f4b4bfa56e8ac47f19","parents":["b0bff3202f25949a529a19e5c982e040d0505350"],"ref":"refs/changes/38/1738/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1524839777,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524866260,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369629,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":12,"deletions":-6}],"sizeInsertions":15,"sizeDeletions":-8},{"number":"6","revision":"8e4e0189fcd284cd29ee1a9d8606349ebd8d831a","parents":["001ad25d174ab11ba2244b5e8a6cb81eacd4245c"],"ref":"refs/changes/38/1738/6","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1525804481,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524866260,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369629,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525805029,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":14,"sizeDeletions":-7},{"number":"7","revision":"458cb87bf8d9848ce040ebf53713dfd85d145be0","parents":["001ad25d174ab11ba2244b5e8a6cb81eacd4245c"],"ref":"refs/changes/38/1738/7","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1525809807,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524866260,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369629,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525805029,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1525810034,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":14,"sizeDeletions":-7}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}