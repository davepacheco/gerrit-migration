{"project":"joyent/sdc-cloudapi","branch":"master","id":"I002a3d50133e582dbd69d204dd7a30323da75471","number":"3249","subject":"TRITON-59 check that instances mounting NFS volumes are provisioned on networks on which volumes are reachable PUBAPI-1453 check that a container mounting a NFS volume is provisioned on a network on which that volume is reachable Reviewed by: Marsell Kuku","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/3249","commitMessage":"TRITON-59 check that instances mounting NFS volumes are provisioned on networks on which volumes are reachable\nPUBAPI-1453 check that a container mounting a NFS volume is provisioned on a network on which that volume is reachable\nReviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\nApproved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\n","createdOn":1516677153,"lastUpdated":1516902932,"open":false,"status":"MERGED","comments":[{"timestamp":1516677153,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1516677185,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516677527,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\nI\u0027ll add testing notes shortly."},{"timestamp":1516685265,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\nTesting notes:\n\n1. Ran the newly added test/volumes-mount-network-unreachable.test.js in my COAL and made sure it passed\n\n2. Ran the following command against my COAL environment:\n\n```\ntriton instance create --name test-cloudapi-networks-unreachable --network 029d9fed-514f-4ccd-8d9c-ca846fd457ea -v test-cloudapi-networks:/foo base-64-lts sample-128M\n```\n\nafter creating the volume \"test-cloudapi-networks\" and attaching it to a non-default fabric network. This outputted the following expected message:\n\n```\ntriton instance create: error: error creating instance: Volumes not reachable from machine: Volume test-cloudapi-networks not reachable on networks 029d9fed-514f-4ccd-8d9c-ca846fd457ea\n```\n\n3. Ran the whole sdc-cloudapi tests suite in my COAL environment and made sure all tests passed"},{"timestamp":1516790584,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1516820560,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1516820581,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1516820592,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516842013,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 3."},{"timestamp":1516842047,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516858273,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1516902836,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1516902932,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"4","revision":"5702a346343ac9ce943d5a853b5328c1abddde84","parents":["cb80f4c9c9b06a106cc7cad112c1b9e300691303"],"ref":"refs/changes/49/3249/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516902836,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516842047,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516858273,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516858273,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"SUBM","value":"1","grantedOn":1516902932,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"test/common.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/machines/common.js","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"test/volumes-automount.test.js","type":"MODIFIED","insertions":1,"deletions":-80},{"file":"test/volumes-mount-network-unreachable.test.js","type":"ADDED","insertions":395,"deletions":0}],"sizeInsertions":575,"sizeDeletions":-94},"patchSets":[{"number":"1","revision":"c262891d0bc667ca9ce5c3b44dbbfcc0dcc02cfa","parents":["cb80f4c9c9b06a106cc7cad112c1b9e300691303"],"ref":"refs/changes/49/3249/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516677153,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516677185,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/machines.js","line":43,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This isn\u0027t exported by errors.js, and isn\u0027t used. Delete! Delete!"},{"file":"lib/machines.js","line":43,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sorry, leftover from previous state of this CR. Will remove."},{"file":"lib/machines.js","line":1556,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Superfluous."},{"file":"lib/machines.js","line":1556,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That\u0027s an unfortunate copy/paste from conditions above. I changed that to \"} else if (body \u0026\u0026 body.code \u003d\u003d\u003d ...) {\".\n\nDoes that work for you, should I also change the two other similar conditions above?"},{"file":"lib/machines.js","line":1568,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Eh. Give the fun a name."},{"file":"lib/machines.js","line":1568,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/common.js","line":1053,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Also note what happens if it\u0027s not imported, just for completeness."},{"file":"test/common.js","line":1053,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I reworded this section of the comment a bit, let me know if that looks good to you."},{"file":"test/common.js","line":1067,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I wonder if this perhaps would be better named as \"makeImagePublic\"?"},{"file":"test/common.js","line":1067,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I find the term \"public\" to be unclear personally. In a test where we use some images to provision machines, I find it clearer to call a function named \"makeImageProvisionable\", because that makes the intent clear."},{"file":"test/common.js","line":1074,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"What\u0027s the point of passing this anyway, instead of using it directly in funcs? vasync keeps track of this so it\u0027s easier for debugging? Just curious!"},{"file":"test/common.js","line":1074,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I adopted that style from existing code in other repos. It allows creating less local variables in a higher level scope that are not necessarily used by all functions of a pipeline, but whether it\u0027s an improvement is debatable."},{"file":"test/common.js","line":1078,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Why not just call it \"err\" in the args?\n\nAnd is it okay not to do a conditional on err here? AKA err could potentially be overwritten later, thus losing some details on a deeper error."},{"file":"test/common.js","line":1078,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good catch, fixed it."},{"file":"test/common.js","line":1112,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Hmm. Any concern about images with the same name but different versions?\n\nIt is test code though, so prolly not worth worrying about."},{"file":"test/common.js","line":1112,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In the tests that use this function we only refer to images by name, so this is fine.\n\nThe previous step of the pipeline uses the \"name\u003d\" filter too, so if a test were to not use an image name, \"makeImageProvisionable\" would return an error."},{"file":"test/volumes-mount-network-unreachable.test.js","line":373,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I\u0027m wondering if any OTHER tests can be added to this file. What would an attacker try?"},{"file":"test/volumes-mount-network-unreachable.test.js","line":373,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"We have OTHER tests in volumes-basic.test.js already. Were you thinking of specific different use cases?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":18,"deletions":-10},{"file":"test/common.js","type":"MODIFIED","insertions":87,"deletions":-1},{"file":"test/machines/common.js","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"test/volumes-automount.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/volumes-mount-network-unreachable.test.js","type":"ADDED","insertions":395,"deletions":0}],"sizeInsertions":574,"sizeDeletions":-15},{"number":"2","revision":"f292f40bbc95dc7d865b1572a2e032fd66789c67","parents":["cb80f4c9c9b06a106cc7cad112c1b9e300691303"],"ref":"refs/changes/49/3249/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516820560,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516820592,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"test/common.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/machines/common.js","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"test/volumes-automount.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/volumes-mount-network-unreachable.test.js","type":"ADDED","insertions":395,"deletions":0}],"sizeInsertions":575,"sizeDeletions":-15},{"number":"3","revision":"002a3d50133e582dbd69d204dd7a30323da75471","parents":["cb80f4c9c9b06a106cc7cad112c1b9e300691303"],"ref":"refs/changes/49/3249/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516842013,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516842047,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516858273,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516858273,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"test/common.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/machines/common.js","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"test/volumes-automount.test.js","type":"MODIFIED","insertions":1,"deletions":-80},{"file":"test/volumes-mount-network-unreachable.test.js","type":"ADDED","insertions":395,"deletions":0}],"sizeInsertions":575,"sizeDeletions":-94},{"number":"4","revision":"5702a346343ac9ce943d5a853b5328c1abddde84","parents":["cb80f4c9c9b06a106cc7cad112c1b9e300691303"],"ref":"refs/changes/49/3249/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1516902836,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516842047,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1516902932,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516858273,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516858273,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"test/common.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/machines/common.js","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"test/volumes-automount.test.js","type":"MODIFIED","insertions":1,"deletions":-80},{"file":"test/volumes-mount-network-unreachable.test.js","type":"ADDED","insertions":395,"deletions":0}],"sizeInsertions":575,"sizeDeletions":-94}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}