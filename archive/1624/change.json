{"project":"joyent/sdc-cloudapi","branch":"master","id":"Ie79d6bb1d272100fb78d54ce60e9c5f5e24ea8cd","number":"1624","subject":"PUBAPI-1368 - CloudAPI can die on MethodNotAllowed during start up Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Reviewed by: Pedro P. Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/1624","commitMessage":"PUBAPI-1368 - CloudAPI can die on MethodNotAllowed during start up\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nReviewed by: Pedro P. Candel \u003cpedro@joyent.com\u003e\n","createdOn":1488943666,"lastUpdated":1489533428,"open":false,"status":"MERGED","comments":[{"timestamp":1488943666,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1488943700,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488997518,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1: Code-Review-1\n\n(1 comment)"},{"timestamp":1489006404,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1489008150,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1489008159,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2."},{"timestamp":1489008198,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489010500,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1489490757,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\nLooks fine. Good catch Julien, btw :-)"},{"timestamp":1489533418,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1489533428,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"3","revision":"e79d6bb1d272100fb78d54ce60e9c5f5e24ea8cd","parents":["93fa72519a21dcc18758e31a5408b6f5da325795"],"ref":"refs/changes/24/1624/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1489533418,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489008198,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489010500,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489490757,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489490757,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1489533428,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":5,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"9227144bdc9b3322ef666575ac4c3cdc647d8ca3","parents":["93fa72519a21dcc18758e31a5408b6f5da325795"],"ref":"refs/changes/24/1624/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1488943666,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488943700,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1488997518,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"main.js","line":171,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In the case this function is called when a \u0027MethodNotAllowed\u0027 event is emitted, what would be \"next2\"\u0027s return value? If it would evaluate to a falsy value, wouldn\u0027t \"next1\", which would be an object and not a function, be called and throw an error?\n\nIn the case this function is called when a GET, POST, PUT, DEL or HEAD request is sent, wouldn\u0027t \"next2\" be undefined and thus throw an error when it\u0027s called?\n\nIn general, this pattern seems confusing and error prone to me. I would suggest instead to add an event listener with the proper signature for the \u0027MethodNotAllowed\u0027 event, and this listener could call the original \u0027bootstrapHandler\u0027 function by passing it its \"request\", \"response\" and \"cb\" parameters."},{"file":"main.js","line":171,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Oh geez, you\u0027re right, this logic makes no sense at all.\n\nI wanted to reuse the same handler for everything, but okay, scrap that."},{"file":"main.js","line":171,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Turns out the patch wasn\u0027t applied (I probably forgot to remove the --dry-run flag) in the test cloudapi. No wonder."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":2,"sizeDeletions":-5},{"number":"2","revision":"d3d1ca996b603a401cae115a3e4111635a6bdc19","parents":["93fa72519a21dcc18758e31a5408b6f5da325795"],"ref":"refs/changes/24/1624/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1489008159,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489008198,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489490757,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489490757,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489010500,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":5,"sizeDeletions":-4},{"number":"3","revision":"e79d6bb1d272100fb78d54ce60e9c5f5e24ea8cd","parents":["93fa72519a21dcc18758e31a5408b6f5da325795"],"ref":"refs/changes/24/1624/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1489533418,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489008198,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489490757,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489490757,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489010500,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1489533428,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":5,"sizeDeletions":-4}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}]}