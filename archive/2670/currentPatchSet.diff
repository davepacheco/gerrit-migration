From 5aeaa78c0204df410b3bd33ce3811da9a7cc8c0f Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Wed, 27 Sep 2017 16:59:26 -0700
Subject: [PATCH] PUBAPI-1446 CreateMachine soft affinity handling isn't soft
 Reviewed by: Julien Gilli <julien.gilli@joyent.com> Approved by: Julien Gilli
 <julien.gilli@joyent.com>

---
 lib/triton-affinity.js | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/lib/triton-affinity.js b/lib/triton-affinity.js
index 43478e9..44c5aa3 100644
--- a/lib/triton-affinity.js
+++ b/lib/triton-affinity.js
@@ -957,9 +957,14 @@ function localityFromRulesInfo(opts) {
     var nearServerUuids = null; // Servers that satisfy all near rules.
     nearRules.forEach(function (nearRule) {
         if (nearRule.vms.length === 0) {
-            throw new VError('cannot satisfy affinity rule "%s", '
-                + 'it does not match any instances',
-                exprFromRule(nearRule));
+            if (isSoft) {
+                nearRule.skip = true;
+                return;
+            } else {
+                throw new VError('cannot satisfy affinity rule "%s", '
+                    + 'it does not match any instances',
+                    exprFromRule(nearRule));
+            }
         }
 
         // Eliminate "far" servers from candidacy.
-- 
2.21.0

