{"project":"joyent/illumos-joyent","branch":"master","id":"I08280dbb7d32cb16511f00c4ea7e1902b2412609","number":"153","subject":"OS-5539 tmpfs space accounting needs improvement Reviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/153","commitMessage":"OS-5539 tmpfs space accounting needs improvement\nReviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1469656265,"lastUpdated":1470264001,"open":false,"status":"MERGED","comments":[{"timestamp":1469656265,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1469832566,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1470088246,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1470088297,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1470088796,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1470088818,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1470088853,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1470178370,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1470189475,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1470192117,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1470263085,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4."},{"timestamp":1470263157,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1470263263,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)\n\nTo test this I used the OS tests and we did an LTP run and booted some lx branded zones with this in addition to booting SmartOS itself."},{"timestamp":1470263348,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1470263349,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1470264001,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"5","revision":"08280dbb7d32cb16511f00c4ea7e1902b2412609","parents":["5216f207fca0ab66e4f96f2fdaea9154b1317359"],"ref":"refs/changes/53/153/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1470263157,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470263348,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470263349,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1470263349,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1470264001,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/test/os-tests/runfiles/default.run","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/test/os-tests/tests/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_badmount.ksh","type":"ADDED","insertions":114,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_full.c","type":"ADDED","insertions":94,"deletions":0},{"file":"usr/src/uts/common/fs/tmpfs/tmp_dir.c","type":"MODIFIED","insertions":36,"deletions":-25},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","type":"MODIFIED","insertions":64,"deletions":-14},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","type":"MODIFIED","insertions":58,"deletions":-9},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","type":"MODIFIED","insertions":36,"deletions":-5},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vnops.c","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/tmp.h","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":567,"sizeDeletions":-66},"patchSets":[{"number":"1","revision":"76ac1d28a04dd5339561a4c0e91dd646c3da4529","parents":["3471df2870ffc5f94d4307efde133d0403020de0"],"ref":"refs/changes/53/153/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1469656265,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":true,"kind":"REWORK","comments":[{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","line":13,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"2016?"},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","line":68,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Overflow check needed?"},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","line":68,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Added one, thanks."},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","line":88,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While overflow is mentioned above, it might be worth an explicit comment about why this check is performed.  It\u0027s less than apparent to a casual observer."},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","line":88,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I clarified the comment, let me know if it\u0027s clear."},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","line":94,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should we be worried about overflow on this check as well?"},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","line":94,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027ve added one just to be careful."},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","line":200,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is there a reason behind the NULL assignment?"},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","line":200,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/os-tests/runfiles/default.run","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/test/os-tests/tests/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_badmount.ksh","type":"ADDED","insertions":114,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_full.c","type":"ADDED","insertions":94,"deletions":0},{"file":"usr/src/uts/common/fs/tmpfs/tmp_dir.c","type":"MODIFIED","insertions":36,"deletions":-25},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","type":"MODIFIED","insertions":67,"deletions":-14},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","type":"MODIFIED","insertions":56,"deletions":-9},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","type":"MODIFIED","insertions":36,"deletions":-5},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vnops.c","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/tmp.h","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":568,"sizeDeletions":-66},{"number":"2","revision":"5ad77241672a6f501fbf35775dbc3670f6dc90ff","parents":["8f78817ba2018a5f76ebe78b251e2ad4b5b35457"],"ref":"refs/changes/53/153/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1470088246,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/os-tests/runfiles/default.run","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/test/os-tests/tests/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_badmount.ksh","type":"ADDED","insertions":114,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_full.c","type":"ADDED","insertions":94,"deletions":0},{"file":"usr/src/uts/common/fs/tmpfs/tmp_dir.c","type":"MODIFIED","insertions":36,"deletions":-25},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","type":"MODIFIED","insertions":64,"deletions":-14},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","type":"MODIFIED","insertions":59,"deletions":-9},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","type":"MODIFIED","insertions":36,"deletions":-5},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vnops.c","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/tmp.h","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":568,"sizeDeletions":-66},{"number":"3","revision":"e8a48530efebbe9a4a3f6f9fdddeed8a206a8cdd","parents":["8f78817ba2018a5f76ebe78b251e2ad4b5b35457"],"ref":"refs/changes/53/153/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1470088796,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470178370,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470088853,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","line":45,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Is that trailing space meant to be there?"},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","line":45,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"No. I\u0027ll clean that up."},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","line":45,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","line":365,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Should there be a tmount_cleanup function to encapsulate this logic in one place?\n\nI think that could help if (for example) additional mutexes are added"},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","line":365,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"When I first drafted this I was thinking about trying to leverage a single clean up function with the unmount logic; however, it just didn\u0027t fall out. If someone was adding a lot more here, it might become worth it. But the challenge is always in making sure that all the initialization was done in a such a way that it could be unwound from an arbitrary state and I was trying to minimize my changes for this so I punted on doing it. If someone were doing additional follow up work, it might be worthwhile to add."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/os-tests/runfiles/default.run","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/test/os-tests/tests/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_badmount.ksh","type":"ADDED","insertions":114,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_full.c","type":"ADDED","insertions":94,"deletions":0},{"file":"usr/src/uts/common/fs/tmpfs/tmp_dir.c","type":"MODIFIED","insertions":36,"deletions":-25},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","type":"MODIFIED","insertions":64,"deletions":-14},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","type":"MODIFIED","insertions":58,"deletions":-9},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","type":"MODIFIED","insertions":36,"deletions":-5},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vnops.c","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/tmp.h","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":567,"sizeDeletions":-66},{"number":"4","revision":"0d0f7e6fcfb181cb3d6be1892b464da50377e57f","parents":["5216f207fca0ab66e4f96f2fdaea9154b1317359"],"ref":"refs/changes/53/153/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1470263085,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/os-tests/runfiles/default.run","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/test/os-tests/tests/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_badmount.ksh","type":"ADDED","insertions":114,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_full.c","type":"ADDED","insertions":94,"deletions":0},{"file":"usr/src/uts/common/fs/tmpfs/tmp_dir.c","type":"MODIFIED","insertions":36,"deletions":-25},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","type":"MODIFIED","insertions":64,"deletions":-14},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","type":"MODIFIED","insertions":58,"deletions":-9},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","type":"MODIFIED","insertions":36,"deletions":-5},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vnops.c","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/tmp.h","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":567,"sizeDeletions":-66},{"number":"5","revision":"08280dbb7d32cb16511f00c4ea7e1902b2412609","parents":["5216f207fca0ab66e4f96f2fdaea9154b1317359"],"ref":"refs/changes/53/153/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1470263157,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1470264001,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470263348,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470263349,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1470263349,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/test/os-tests/runfiles/default.run","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/test/os-tests/tests/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/os-tests/tests/tmpfs/Makefile","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_badmount.ksh","type":"ADDED","insertions":114,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_enospc.ksh","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/test/os-tests/tests/tmpfs/tmpfs_full.c","type":"ADDED","insertions":94,"deletions":0},{"file":"usr/src/uts/common/fs/tmpfs/tmp_dir.c","type":"MODIFIED","insertions":36,"deletions":-25},{"file":"usr/src/uts/common/fs/tmpfs/tmp_subr.c","type":"MODIFIED","insertions":64,"deletions":-14},{"file":"usr/src/uts/common/fs/tmpfs/tmp_tnode.c","type":"MODIFIED","insertions":58,"deletions":-9},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vfsops.c","type":"MODIFIED","insertions":36,"deletions":-5},{"file":"usr/src/uts/common/fs/tmpfs/tmp_vnops.c","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"usr/src/uts/common/sys/fs/tmp.h","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":567,"sizeDeletions":-66}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}