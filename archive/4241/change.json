{"project":"joyent/pgstatsmon","branch":"master","id":"Iadf968a850fa1ce3875ce7741fd70b27087a3d5d","number":"4241","subject":"joyent/pgstatsmon#14 Collect metrics about vacuum progress Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/4241","commitMessage":"joyent/pgstatsmon#14 Collect metrics about vacuum progress\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\n","createdOn":1529106647,"lastUpdated":1534260549,"open":false,"status":"MERGED","comments":[{"timestamp":1529106647,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1529106649,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit fd4b03900ab9dcc2034f2d78dd939fa2868b1974\n    \n    Add vacuum progress stats"},{"timestamp":1529106652,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1529106731,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1529106734,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 97712dcd11acd652477d2bd6d2fe5b871150bf09\n    \n    Add vacuum progress stats"},{"timestamp":1529106738,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(7 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1529106927,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1529106929,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 35a3cf9552561f43dec3a445bc536c2ccd753e2e\n    \n    Add vacuum progress stats"},{"timestamp":1529106934,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n(7 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1529339273,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 4."},{"timestamp":1529339275,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit c45d9dc3bcc7efaa44d312c73945a0e86094edd4\n    \n    Add vacuum progress stats"},{"timestamp":1529339280,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n(7 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1529339836,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 5."},{"timestamp":1529339837,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 62c8ad56e557fc29268ec7667de26445ee230538\n    \n    Add vacuum progress stats"},{"timestamp":1529339842,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529918076,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1529939361,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1530218620,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 6."},{"timestamp":1530218622,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit c4f877d1999802d86df3156d1ec416efc24b5e17\n    \n    Add vacuum progress stats"},{"timestamp":1530218627,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530289710,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6:\n\nThe latest patchset makes changes to pass the configuration data into the getQueries function. That way if we need to use other data in the future from the config to populate some of the query fields we have it available.\n\nI set the expiry period to be the configured postgres query interval + 30 seconds. I think this will let us quickly detect expired metrics, but also avoid false positives. \n\nI\u0027ve deployed and test the latest patchset changes on the test system and verified that the expiry is still working to catch the end of a vacuum.\n\nHere\u0027s a screenshot of a vacuum I manually started after deploying the changes this morning: https://us-east.manta.joyent.com/kelly.mclaughlin/public/vacuum-phase-graph-06-29-2018.png"},{"timestamp":1531215716,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1531239698,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1531241098,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 7."},{"timestamp":1531241100,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 343058bb54db3d0318d149053c0b72231ea4ccae\n    \n    Add vacuum progress stats"},{"timestamp":1531241105,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531241129,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1531309416,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1531935576,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 5:\n\n(1 comment)\n\nLooks good! Were you able to get the pgstatsmon test suite to run? I usually run it against a standalone Postgres instance (i.e. not one deployed w/ Triton or Manta)."},{"timestamp":1531936737,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(1 comment)\n\n\u003e (1 comment)\n \u003e \n \u003e Looks good! Were you able to get the pgstatsmon test suite to run?\n \u003e I usually run it against a standalone Postgres instance (i.e. not\n \u003e one deployed w/ Triton or Manta).\n\nI did not even pay attention to the fact that there were tests, but I\u0027ll try it and report back."},{"timestamp":1531944501,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 7:\n\nThere are a couple tests. They\u0027re pretty basic and don\u0027t really work very reliably if they\u0027re run against a PG instance that\u0027s being used by something else. They pretty much just make sure that nothing is horribly broken."},{"timestamp":1531949102,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 8."},{"timestamp":1531949104,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 22d006c409392fa429a4b721ceb5e5285fd56ae0\n    \n    Add help text for vacuum progress metrics"},{"timestamp":1531949110,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531951757,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 9."},{"timestamp":1531951758,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 1ef2eec950e99607b6762c115a28917b73812927\n    \n    Update overview data source table\n    \n    commit 8619f052f36053fec649c30f0f632281ae207ee1\n    \n    Add help text for vacuum progress metrics\n    \n    commit 51353d0c97cb99840cb10e8f3ea5b83e7c36a3a1\n    \n    Add vacuum progress stats"},{"timestamp":1531951764,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532071867,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1532123038,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 10."},{"timestamp":1532123040,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit ffe17644c7ab46eaa0cfa7b4de3e87c21ed926c8\n    \n    Create custom data type to receive results of get_stat_progress_vacuum function"},{"timestamp":1532123045,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532123304,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 9:\n\nI found from trying to run the tests with these changes that I had left out the creation of the user-defined return type needed to capture the results from the `get_stat_progress_vacuum` function. This would cause the setup of the postgres backend in pgstatsmon to fail and the metrics would never be registered. I\u0027ve added a couple of additional functions to drop and create this type. Unfortunately there is no `CREATE IF NOT EXISTS` for types in postgres so it has to be done with two statements."},{"timestamp":1532343719,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1532355889,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1532357006,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1532357588,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1532361782,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 11."},{"timestamp":1532361784,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit 0a29e3cec0bb29900f10125c96f90777ccc499af\n    \n    Better formatting for vacuum_progress_stats statement"},{"timestamp":1532361788,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532363715,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 11: Code-Review+1"},{"timestamp":1532364783,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1533140765,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 12."},{"timestamp":1533140767,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 12:\n\nNew commits:\n    \n    commit 0f467f1aecfab232ee7390e3bda59664cfad6b2d\n    \n    Remove need for custom return type for vacuum progress stats"},{"timestamp":1533140773,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533141454,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 11:\n\nOk, so the latest patch set removes the need for the custom return type for collecting the vacuum progress stats. It\u0027s a bit cleaner this way and we avoid any pesky issues with having to drop the type when pgstatsmon starts. The tests also pass with this latest change."},{"timestamp":1533897637,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1534258328,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 12: Integration-Approval+1"},{"timestamp":1534260549,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"12","revision":"adf968a850fa1ce3875ce7741fd70b27087a3d5d","parents":["c8f1c38ee55a037ca947cafa9cf7cbb95654c610"],"ref":"refs/changes/41/4241/12","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1533140765,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533140773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533897637,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534258328,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1534260549,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/overview.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":35,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":336,"deletions":-253},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":384,"sizeDeletions":-257},"patchSets":[{"number":"1","revision":"175aaea79d34b63ebf8ca9aae0173a72d6127e36","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529106647,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529106652,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pgstatsmon.js","line":1081,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: expires"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/queries.js","type":"MODIFIED","insertions":31,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-3},{"number":"2","revision":"91250a655d0382f1b78e7f6804e28b6e94ef016e","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529106731,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529106738,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/queries.js","line":273,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":277,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":279,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":281,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":283,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":285,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/queries.js","type":"MODIFIED","insertions":31,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-3},{"number":"3","revision":"42aba6e60e5108b5b15fdd5f69a7bca0af245a5b","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529106927,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529106934,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/queries.js","line":273,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":277,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":279,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":281,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":283,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":285,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/queries.js","type":"MODIFIED","insertions":31,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-3},{"number":"4","revision":"2d57ed21a0caef2ca5da9da7ae5786453337f5f5","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529339273,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529339280,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/queries.js","line":273,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":277,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":279,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":281,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":283,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"},{"file":"lib/queries.js","line":285,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"continuation line not indented by 4 spaces"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/queries.js","type":"MODIFIED","insertions":31,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-3},{"number":"5","revision":"82bd612ddedfcde9d3a1199356fdbea77f5f664f","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/5","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529339836,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529339842,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/queries.js","line":274,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"How did we determine this value is appropriate? \n\nShould/could this be configurable in some way? If that\u0027s not required and the value will always make sense across each row, would we be able to make this a constant instead? Perhaps with a summary on how node-artedi uses this value and why we\u0027ve set it this way?"},{"file":"lib/queries.js","line":274,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"It\u0027s a good question. The scraping period is 60 seconds so I set the timeout for 120 seconds and I think that would work for any metric we collect with pgstatsmon, but maybe we could get away with even less time and maybe it should be configurable. Let me look into making it pull the value from the configuration instead of being hardcoded."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/queries.js","type":"MODIFIED","insertions":31,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-3},{"number":"6","revision":"0a2a636a62a5dcf90c54169d80362e6cb12cab9d","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/6","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1530218620,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530218627,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/queries.js","line":329,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This is super nitty and I\u0027m sorry, but I think the indentation here is a bit off. The rest of the code looks like it\u0027s indented with tabs, and only uses spaces for literals and continuations (though that doesn\u0027t seem to be consistent across the project anyway). This looks like it\u0027s indented with a mix of tabs and spaces."},{"file":"lib/queries.js","line":329,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Hehe, that\u0027s totally fair. I\u0027ve spent the vast majority of my time on this change with formatting this file. Guess it\u0027s time to find or make an emacs indent mode that conforms to this style to handle it for me."},{"file":"lib/queries.js","line":329,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":301,"deletions":-225},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":339,"sizeDeletions":-229},{"number":"7","revision":"beac914f2e1ba493b104bb4bee560cfb81567fb6","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/7","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1531241098,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531241105,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1531309416,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"comments":[{"file":"lib/queries.js","line":306,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Would it be possible to add a short \u0027help\u0027 description to these metrics?"},{"file":"lib/queries.js","line":306,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Definitely, will do that"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":301,"deletions":-225},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":339,"sizeDeletions":-229},{"number":"8","revision":"7b8efb8163a03622659295828d6a0ac728e279a5","parents":["588149d028bc7560d2324c137947163578212e58"],"ref":"refs/changes/41/4241/8","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1531949102,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531949110,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":308,"deletions":-225},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":346,"sizeDeletions":-229},{"number":"9","revision":"6ed22dd3131a3ecefc2a6b0f2b18e50827088b82","parents":["c8f1c38ee55a037ca947cafa9cf7cbb95654c610"],"ref":"refs/changes/41/4241/9","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1531951757,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531951764,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532071867,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/overview.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":336,"deletions":-253},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":375,"sizeDeletions":-257},{"number":"10","revision":"e6c59d70116f474977a0c22aa0b88692f7a4f0a3","parents":["c8f1c38ee55a037ca947cafa9cf7cbb95654c610"],"ref":"refs/changes/41/4241/10","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1532123038,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532123045,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/dbinit.js","line":183,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"As you\u0027ve mentioned, I don\u0027t know if there\u0027s anything else we can do but drop and recreate this, but do you happen to know the impact to any queries that might be using this type that are in flight? Would this cause problems for those queries, or would it cause the bootstrapping process problems?\n\nRealistically I don\u0027t think this matters because only pgstatsmon is using this, and if we\u0027re bootstrapping then that assumes we\u0027ve previously stopped anyway. I wonder if we could get to the point where bootstrap fails though because something else is using this type, and what would happen in that case."},{"file":"lib/dbinit.js","line":183,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"The postgres internal locking ought to protect any in-flight queries from being impacted, but any subsequent queries will fail due to that type missing. If we don\u0027t properly do the type initialization it will cause the pgstatsmon postgres setup to fail and the metrics will not get properly registered and then basically pgstatsmon won\u0027t do it\u0027s job properly.\n\nOne potential safety for this I was thinking about was to move the functions and types needed by pgstatsmon out of the public schema and into a pgstatsmon schema. That way an inadvertent name conflict now or in some future change won\u0027t actually cause any problems and the use of CASCADE becomes a little less scary because it would have to be targeted at the pgstatsmon schema directly. I don\u0027t know that that change should be part of this CR since it\u0027s more general, but it could. What do you think of that idea?"},{"file":"lib/dbinit.js","line":183,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I expect in the latter case we\u0027ll have some leeway with SMF restarting the service for us, and in the event of failing completely then I think we\u0027ll alarm.\n\n\u003e One potential safety for this I was thinking about was to move the functions and types needed by pgstatsmon out of the public schema and into a pgstatsmon schema\n\nWould this also apply to the \"get_stat_replication()\" function that we create, too? I like the idea, and I think that would be fine in a future change. I\u0027m not sure if there are any other examples in Manta that _don\u0027t_ use public for this kind of stuff, so that might be worth scoping out as and when."},{"file":"lib/dbinit.js","line":183,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Exactly, any other functions or types or anything else that pgstatsmon creates just for its own use would go under this schema namespace. I think you are correct, everything in manta is currently in the public schema. I think I\u0027ll go ahead and write up an issue for pgstatsmon to look more into this."},{"file":"lib/dbinit.js","line":183,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I\u0027ve filed joyent/pgstatsmon#16 to look into the schema namespace change."},{"file":"lib/dbinit.js","line":194,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It would be lovely if the columns for this type were broken up onto their own lines for readability (and to make it easier to add new columns/lines in case pg_stat_vacuum_progress adds more columns later on) , but it\u0027s not a big deal.\n\nAlso, it would be swell if we could somehow create a type based on the schema that already exists on the pg_stat_vacuum_progress table, but my quick googling didn\u0027t show anything up."},{"file":"lib/dbinit.js","line":194,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Good suggestion on the formatting of the query. I\u0027ll make that change.\n\nAs for the type, I agree. Since they use text strings for the phase in pg_stat_progress_vacuum we aren\u0027t able to use that and that\u0027s how I ended up with a custom type instead."},{"file":"lib/dbinit.js","line":194,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"\u003e As for the type, I agree. Since they use text strings for the phase in pg_stat_progress_vacuum we aren\u0027t able to use that and that\u0027s how I ended up with a custom type instead.\n\nThat\u0027s a good point! I can agree with this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/overview.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":336,"deletions":-253},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":402,"sizeDeletions":-257},{"number":"11","revision":"3749572fee5c19a3c8e9104901e6d119141ba512","parents":["c8f1c38ee55a037ca947cafa9cf7cbb95654c610"],"ref":"refs/changes/41/4241/11","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1532361782,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532361788,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532363715,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/overview.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":57,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":336,"deletions":-253},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":406,"sizeDeletions":-257},{"number":"12","revision":"adf968a850fa1ce3875ce7741fd70b27087a3d5d","parents":["c8f1c38ee55a037ca947cafa9cf7cbb95654c610"],"ref":"refs/changes/41/4241/12","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1533140765,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533140773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533897637,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534258328,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1534260549,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/overview.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dbinit.js","type":"MODIFIED","insertions":35,"deletions":-1},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/queries.js","type":"MODIFIED","insertions":336,"deletions":-253},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":384,"sizeDeletions":-257}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}