From a074212d3c12bcfc56a957417c07f6b6c615666b Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Wed, 12 Sep 2018 23:54:06 +0000
Subject: [PATCH] MANTA-3945 garbage-collector loads index shard list
 incorrectly

---
 cmd/server.js | 26 +++++++++++++++++++++-----
 1 file changed, 21 insertions(+), 5 deletions(-)

diff --git a/cmd/server.js b/cmd/server.js
index a4599d0..d4b8eb6 100644
--- a/cmd/server.js
+++ b/cmd/server.js
@@ -182,13 +182,29 @@ load_index_shard_range(ctx, done)
 		return;
 	}
 
-	ctx.ctx_cfg.index_shard_lo = parseInt(
-			index_shards[0].host.charAt(0), 10);
+	/*
+	 * While shards in production Manta deployments are numeric by
+	 * convention, they don't have to be. This assumption needs to
+	 * be removed.
+	 */
+	function parse_shard_number(shard) {
+		return (parseInt(shard.substring(0, shard.indexOf('.')), 10));
+	}
+
+	var init = parse_shard_number(index_shards[0].host);
+
+	ctx.ctx_cfg.index_shard_lo = init;
+	ctx.ctx_cfg.index_shard_hi = init;
 
 	index_shards.forEach(function (shard) {
-		if (shard.last) {
-			ctx.ctx_cfg.index_shard_hi = parseInt(
-				shard.host.charAt(0), 10);
+		var shard_num = parse_shard_number(shard.host);
+
+		if (ctx.ctx_cfg.index_shard_lo > shard_num) {
+			ctx.ctx_cfg.index_shard_lo = shard_num;
+		}
+
+		if (ctx.ctx_cfg.index_shard_hi < shard_num) {
+			ctx.ctx_cfg.index_shard_hi = shard_num;
 		}
 	});
 
-- 
2.21.0

