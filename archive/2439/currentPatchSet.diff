commit 965c5aad45708a97d1e6f04aad5992f3317efa23 (refs/changes/39/2439/5)
Author: Todd Whiteman <todd.whiteman@joyent.com>
Date:   2017-08-24T09:57:15-07:00 (2 years, 1 month ago)
    
    DOCKER-1091 Cannot login into Artifactory private docker registry
    Reviewed by: Trent Mick <trentm@gmail.com>
    Approved by: Trent Mick <trentm@gmail.com>

diff --git a/CHANGES.md b/CHANGES.md
index da7d2e2..f936c5d 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -4,6 +4,11 @@
 
 (nothing yet)
 
+## 3.2.8
+
+- DOCKER-1091 Cannot login into Artifactory private docker registry. This change
+  drops authorization headers from the first ping request.
+
 ## 3.2.7
 
 - joyent/node-docker-registry-client#16 Allow a repo name to have a '/', e.g.
diff --git a/lib/registry-client-v2.js b/lib/registry-client-v2.js
index 5c1946f..bdb991f 100644
--- a/lib/registry-client-v2.js
+++ b/lib/registry-client-v2.js
@@ -572,13 +572,6 @@ function _verifyJws(jws) {
  *        used instead of `opts.index`.
  *      --
  *      - opts.log {Bunyan Logger} Optional.
- *      - opts.username {String} Optional. Set this and `opts.password` for
- *        Basic auth.
- *      - opts.password {String} Optional, but required if `opts.username` is
- *        provided.
- *      - opts.authInfo {Object} Optional. This is an auth object result
- *        from the top-level `login` (a.k.a.
- *        `require('docker-registry-client').loginV2()`.)
  *      --
  *      TODO: document other options
  * @param cb {Function} `function (err, body, res, req)`
@@ -598,15 +591,6 @@ function ping(opts, cb) {
     assert.ok(opts.index || opts.indexName,
         'opts.index or opts.indexName is required');
     assert.optionalObject(opts.log, 'opts.log');
-    // Auth options:
-    assert.optionalString(opts.username, 'opts.username');
-    if (opts.username) {
-        assert.string(opts.password,
-            'opts.password required if username given');
-    } else {
-        assert.optionalString(opts.password, 'opts.password');
-    }
-    assert.optionalObject(opts.authInfo, 'opts.authInfo');
     // HTTP client basic options:
     assert.optionalBool(opts.insecure, 'opts.insecure');
     assert.optionalBool(opts.rejectUnauthorized, 'opts.rejectUnauthorized');
@@ -627,9 +611,8 @@ function ping(opts, cb) {
     }
 
     var log = _createLogger(opts.log);
-    log.trace({index: index, username: opts.username,
-        password: (opts.password ? '(censored)' : '(none)'),
-        scope: opts.scope, insecure: opts.insecure}, 'ping');
+    log.trace({index: index, scope: opts.scope, insecure: opts.insecure},
+        'ping');
 
     /*
      * We have to special case usage of the "official" docker.io to
@@ -676,20 +659,8 @@ function ping(opts, cb) {
         proxy: opts.proxy
     });
 
-    var headers = {};
-    if (opts.authInfo) {
-        _setAuthHeaderFromAuthInfo(headers, opts.authInfo);
-        assert.string(headers.authentication, 'headers.authentication');
-    } else if (opts.username) {
-        _setAuthHeaderFromAuthInfo(headers, {
-            username: opts.username,
-            password: opts.password
-        });
-    }
-
     client.get({
         path: '/v2/',
-        headers: headers,
         // Ping should be fast. We don't want 15s of retrying.
         retry: false,
         connectTimeout: 10000
@@ -801,12 +772,7 @@ function login(opts, cb) {
                 if (!err) {
                     assert.equal(res.statusCode, 200,
                         'ping success without 200');
-                    // This means Basic auth worked.
-                    authInfo = {
-                        type: 'basic',
-                        username: opts.username,
-                        password: opts.password
-                    };
+                    // No authorization is necessary.
                     next(true);  // early pipeline abort
                 } else if (res && res.statusCode === 401) {
                     var chalHeader = res.headers['www-authenticate'];
@@ -844,18 +810,17 @@ function login(opts, cb) {
             next();
         },
 
-        function basicAuthFail(ctx, next) {
+        function basicAuth(ctx, next) {
             if (ctx.authChallenge.scheme.toLowerCase() !== 'basic') {
                 return next();
             }
 
-            /*
-             * If the scheme is Basic, then we should already have failed
-             * because username/password would have been in the original Ping.
-             */
-            log.debug('basicAuth fail');
-            assert.ok(ctx.pingErr, 'no pingErr?');
-            next(ctx.pingErr);
+            authInfo = {
+                type: 'basic',
+                username: opts.username,
+                password: opts.password
+            };
+            next(true);
         },
 
         function bearerAuth(ctx, next) {
diff --git a/package.json b/package.json
index dff7144..c3dd33d 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
     "name": "docker-registry-client",
-    "version": "3.2.7",
+    "version": "3.2.8",
     "description": "node.js client for the Docker Registry API",
     "author": "Joyent (joyent.com)",
     "main": "./lib/index.js",
diff --git a/test/v2.amazonecr.test.js b/test/v2.amazonecr.test.js
index 87da276..90dbbf7 100644
--- a/test/v2.amazonecr.test.js
+++ b/test/v2.amazonecr.test.js
@@ -84,7 +84,7 @@ test('v2 amazonecr', function (tt) {
         noauthClient.listTags(function (err) {
             t.ok(err);
             t.equal(err.statusCode, 401, 'Expect a 401 status code');
-            t.equal(String(err.message).trim(), 'Not Authorizied');
+            t.equal(String(err.message).trim(), 'Not Authorized');
             t.end();
         });
     });
@@ -94,6 +94,7 @@ test('v2 amazonecr', function (tt) {
      */
     tt.test('  createClient', function (t) {
         client = drc.createClientV2({
+            maxSchemaVersion: 2,
             name: CONFIG.repo,
             username: CONFIG.username,
             password: CONFIG.password,
@@ -123,18 +124,22 @@ test('v2 amazonecr', function (tt) {
     });
 
     /*
-     *  {
-     *      "name": <name>,
-     *      "tag": <tag>,
-     *      "fsLayers": [
-     *         {
-     *            "blobSum": <tarsum>
-     *         },
-     *         ...
-     *      ],
-     *      "history": <v1 images>,
-     *      "signature": <JWS>
-     *  }
+     * {
+     *   "schemaVersion": 2,
+     *   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
+     *   "config": {
+     *     "mediaType": "application/octet-stream",
+     *     "size": 1459,
+     *     "digest": "sha256:2b8fd9751c4c0f5dd266fc...01"
+     *   },
+     *   "layers": [
+     *     {
+     *       "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
+     *       "size": 667590,
+     *       "digest": "sha256:8ddc19f16526912237dd8af...a9"
+     *     }
+     *   ]
+     * }
      */
     var manifest;
     var manifestDigest;
@@ -147,13 +152,12 @@ test('v2 amazonecr', function (tt) {
             manifestDigest = res.headers['docker-content-digest'];
             t.equal(manifestDigest, undefined, 'no docker-content-digest');
             t.ok(manifest);
-            t.equal(manifest.schemaVersion, 1);
-            t.equal(manifest.name, repo.remoteName);
-            t.equal(manifest.tag, CONFIG.tag);
-            t.ok(manifest.architecture);
-            t.ok(manifest.fsLayers);
-            t.ok(manifest.history[0].v1Compatibility);
-            t.ok(manifest.signatures[0].signature);
+            t.equal(manifest.schemaVersion, 2);
+            t.ok(manifest.config);
+            t.ok(manifest.config.digest, manifest.config.digest);
+            t.ok(manifest.layers);
+            t.ok(manifest.layers.length > 0);
+            t.ok(manifest.layers[0].digest);
             t.end();
         });
     });
@@ -168,7 +172,7 @@ test('v2 amazonecr', function (tt) {
     });
 
     tt.test('  headBlob', function (t) {
-        var digest = manifest.fsLayers[0].blobSum;
+        var digest = manifest.layers[0].digest;
         client.headBlob({digest: digest}, function (err, ress) {
             t.ifErr(err);
             t.ok(ress);
@@ -196,10 +200,9 @@ test('v2 amazonecr', function (tt) {
             t.equal(last.statusCode, 200);
 
             // Content-Type:
-            // - docker.io gives 'application/octet-stream', but amazon isn't so
-            //   nice for a HEAD request, it just returns text/plain.
+            // - Note that docker.io gives 'application/octet-stream'
             t.equal(last.headers['content-type'],
-                'text/plain; charset=utf-8');
+                'application/vnd.docker.image.rootfs.diff.tar.gzip');
 
             t.ok(last.headers['content-length']);
             t.end();
@@ -230,7 +233,7 @@ test('v2 amazonecr', function (tt) {
     });
 
     tt.test('  createBlobReadStream', function (t) {
-        var digest = manifest.fsLayers[0].blobSum;
+        var digest = manifest.layers[0].digest;
         client.createBlobReadStream({digest: digest},
                 function (err, stream, ress) {
             t.ifErr(err);
diff --git a/test/v2.dockerioprivate.test.js b/test/v2.dockerioprivate.test.js
index 5ef090d..f93e1e7 100644
--- a/test/v2.dockerioprivate.test.js
+++ b/test/v2.dockerioprivate.test.js
@@ -62,6 +62,7 @@ test('v2 docker.io private repo (' + CONFIG.repo + ')', function (tt) {
 
     tt.test('  createClient', function (t) {
         client = drc.createClientV2({
+            maxSchemaVersion: 2,
             name: CONFIG.repo,
             username: CONFIG.username,
             password: CONFIG.password,
@@ -142,18 +143,22 @@ test('v2 docker.io private repo (' + CONFIG.repo + ')', function (tt) {
     });
 
     /*
-     *  {
-     *      "name": <name>,
-     *      "tag": <tag>,
-     *      "fsLayers": [
-     *         {
-     *            "blobSum": <tarsum>
-     *         },
-     *         ...
-     *      ],
-     *      "history": <v1 images>,
-     *      "signature": <JWS>
-     *  }
+     * {
+     *   "schemaVersion": 2,
+     *   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
+     *   "config": {
+     *     "mediaType": "application/octet-stream",
+     *     "size": 1459,
+     *     "digest": "sha256:2b8fd9751c4c0f5dd266fc...01"
+     *   },
+     *   "layers": [
+     *     {
+     *       "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
+     *       "size": 667590,
+     *       "digest": "sha256:8ddc19f16526912237dd8af...a9"
+     *     }
+     *   ]
+     * }
      */
     var manifest;
     var manifestDigest;
@@ -163,13 +168,12 @@ test('v2 docker.io private repo (' + CONFIG.repo + ')', function (tt) {
             manifest = manifest_;
             manifestDigest = res.headers['docker-content-digest'];
             t.ok(manifest);
-            t.equal(manifest.schemaVersion, 1);
-            t.equal(manifest.name, repo.remoteName);
-            t.equal(manifest.tag, CONFIG.tag);
-            t.ok(manifest.architecture);
-            t.ok(manifest.fsLayers);
-            t.ok(manifest.history[0].v1Compatibility);
-            t.ok(manifest.signatures[0].signature);
+            t.equal(manifest.schemaVersion, 2);
+            t.ok(manifest.config);
+            t.ok(manifest.config.digest, manifest.config.digest);
+            t.ok(manifest.layers);
+            t.ok(manifest.layers.length > 0);
+            t.ok(manifest.layers[0].digest);
             t.end();
         });
     });
@@ -179,10 +183,9 @@ test('v2 docker.io private repo (' + CONFIG.repo + ')', function (tt) {
             t.ifErr(err);
             t.ok(manifest);
             ['schemaVersion',
-             'name',
-             'tag',
-             'architecture'].forEach(function (k) {
-                t.equal(manifest_[k], manifest[k], k);
+             'config',
+             'layers'].forEach(function (k) {
+               t.deepEqual(manifest_[k], manifest[k], k);
             });
             t.end();
         });
@@ -198,7 +201,7 @@ test('v2 docker.io private repo (' + CONFIG.repo + ')', function (tt) {
     });
 
     tt.test('  headBlob', function (t) {
-        var digest = manifest.fsLayers[0].blobSum;
+        var digest = manifest.layers[0].digest;
         client.headBlob({digest: digest}, function (err, ress) {
             t.ifErr(err, 'no headBlob err');
             t.ok(ress, 'got a "ress"');
@@ -240,7 +243,7 @@ test('v2 docker.io private repo (' + CONFIG.repo + ')', function (tt) {
     });
 
     tt.test('  createBlobReadStream', function (t) {
-        var digest = manifest.fsLayers[0].blobSum;
+        var digest = manifest.layers[0].digest;
         client.createBlobReadStream({digest: digest},
                 function (err, stream, ress) {
             t.ifErr(err, 'createBlobReadStream err');
diff --git a/test/v2.jfrogartifactory.test.js b/test/v2.jfrogartifactory.test.js
index 8991abb..c3af2b3 100644
--- a/test/v2.jfrogartifactory.test.js
+++ b/test/v2.jfrogartifactory.test.js
@@ -19,8 +19,7 @@
  *              "repo": "trentm.artifactoryonline.com/busybox",
  *              "username": "admin",
  *              "password": "(your password)",
- *              "tag": "latest",
- *              "searchTerm": "busy"
+ *              "tag": "latest"
  *          }
  *      }
  *
@@ -68,6 +67,7 @@ test('v2 jfrog artifactory private repo (' + CONFIG.repo + ')', function (tt) {
 
     tt.test('  createClient', function (t) {
         client = drc.createClientV2({
+            maxSchemaVersion: 2,
             name: CONFIG.repo,
             username: CONFIG.username,
             password: CONFIG.password,
@@ -88,12 +88,11 @@ test('v2 jfrog artifactory private repo (' + CONFIG.repo + ')', function (tt) {
 
     tt.test('  ping', function (t) {
         client.ping(function (err, body, res) {
-            // With JFrog Artifactory, we actually get a successful ping,
-            // because (I guess) only basic auth is required here.
-            t.ifErr(err);
+            // Expect a 401 (Not Authorized) error here.
+            t.ok(err);
             t.ok(res, 'have a response');
             if (res) {
-                t.equal(res.statusCode, 200);
+                t.equal(res.statusCode, 401);
                 t.equal(res.headers['docker-distribution-api-version'],
                     'registry/2.0');
             }
@@ -159,18 +158,22 @@ test('v2 jfrog artifactory private repo (' + CONFIG.repo + ')', function (tt) {
     });
 
     /*
-     *  {
-     *      "name": <name>,
-     *      "tag": <tag>,
-     *      "fsLayers": [
-     *         {
-     *            "blobSum": <tarsum>
-     *         },
-     *         ...
-     *      ],
-     *      "history": <v1 images>,
-     *      "signature": <JWS>
-     *  }
+     * {
+     *   "schemaVersion": 2,
+     *   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
+     *   "config": {
+     *     "mediaType": "application/octet-stream",
+     *     "size": 1459,
+     *     "digest": "sha256:2b8fd9751c4c0f5dd266fc...01"
+     *   },
+     *   "layers": [
+     *     {
+     *       "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
+     *       "size": 667590,
+     *       "digest": "sha256:8ddc19f16526912237dd8af...a9"
+     *     }
+     *   ]
+     * }
      */
     var manifest;
     var manifestDigest;
@@ -180,13 +183,12 @@ test('v2 jfrog artifactory private repo (' + CONFIG.repo + ')', function (tt) {
             manifest = manifest_;
             manifestDigest = res.headers['docker-content-digest'];
             t.ok(manifest);
-            t.equal(manifest.schemaVersion, 1);
-            t.equal(manifest.name, repo.remoteName);
-            t.equal(manifest.tag, CONFIG.tag);
-            t.ok(manifest.architecture);
-            t.ok(manifest.fsLayers);
-            t.ok(manifest.history[0].v1Compatibility);
-            t.ok(manifest.signatures[0].signature);
+            t.equal(manifest.schemaVersion, 2);
+            t.ok(manifest.config);
+            t.ok(manifest.config.digest, manifest.config.digest);
+            t.ok(manifest.layers);
+            t.ok(manifest.layers.length > 0);
+            t.ok(manifest.layers[0].digest);
             t.end();
         });
     });
@@ -215,7 +217,7 @@ test('v2 jfrog artifactory private repo (' + CONFIG.repo + ')', function (tt) {
     });
 
     tt.test('  headBlob', function (t) {
-        var digest = manifest.fsLayers[0].blobSum;
+        var digest = manifest.layers[0].digest;
         client.headBlob({digest: digest}, function (err, ress) {
             t.ifErr(err);
             t.ok(ress);
@@ -261,7 +263,7 @@ test('v2 jfrog artifactory private repo (' + CONFIG.repo + ')', function (tt) {
     });
 
     tt.test('  createBlobReadStream', function (t) {
-        var digest = manifest.fsLayers[0].blobSum;
+        var digest = manifest.layers[0].digest;
         client.createBlobReadStream({digest: digest},
                 function (err, stream, ress) {
             t.ifErr(err);
