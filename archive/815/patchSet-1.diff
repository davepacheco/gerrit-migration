From f93815d3d419a78d65f7dc78be5cb8334510327e Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Fri, 28 Oct 2016 12:14:29 -0700
Subject: [PATCH] ZAPI-754 use cueball for talking to other SDC services

---
 lib/apis/cnapi.js             |  3 ++-
 lib/apis/imgapi.js            |  6 +++++-
 lib/apis/napi.js              |  3 ++-
 lib/apis/papi.js              |  6 +++++-
 lib/vmapi.js                  | 24 ++++++++++++++++++++++++
 package.json                  |  2 ++
 sapi_manifests/vmapi/template | 20 ++++++++++++++++++++
 7 files changed, 60 insertions(+), 4 deletions(-)

diff --git a/lib/apis/cnapi.js b/lib/apis/cnapi.js
index 19afd42..67be9ad 100644
--- a/lib/apis/cnapi.js
+++ b/lib/apis/cnapi.js
@@ -26,7 +26,8 @@ function Cnapi(options) {
         url: options.url,
         version: '*',
         log: options.log,
-        retry: { retries: 2 }
+        retry: { retries: 2 },
+        agent: options.agent
     });
 }
 
diff --git a/lib/apis/imgapi.js b/lib/apis/imgapi.js
index 7854dbc..18a5672 100644
--- a/lib/apis/imgapi.js
+++ b/lib/apis/imgapi.js
@@ -21,7 +21,11 @@ var sdc = require('sdc-clients');
  */
 function Imgapi(options) {
     this.log = options.log;
-    this.client = new sdc.IMGAPI({ url: options.url, log: options.log });
+    this.client = new sdc.IMGAPI({
+        url: options.url,
+        log: options.log,
+        agent: options.agent
+    });
 }
 
 
diff --git a/lib/apis/napi.js b/lib/apis/napi.js
index 1441b15..041a9f2 100644
--- a/lib/apis/napi.js
+++ b/lib/apis/napi.js
@@ -27,7 +27,8 @@ function Napi(options) {
     this.client = restify.createJsonClient({
         url: options.url,
         version: '*',
-        log: options.log
+        log: options.log,
+        agent: options.agent
     });
 }
 
diff --git a/lib/apis/papi.js b/lib/apis/papi.js
index bd5006e..284fc7a 100644
--- a/lib/apis/papi.js
+++ b/lib/apis/papi.js
@@ -21,7 +21,11 @@ var sdc = require('sdc-clients');
  */
 function Papi(options) {
     this.log = options.log;
-    this.client = sdc.PAPI({ url: options.url, log: options.log });
+    this.client = sdc.PAPI({
+        url: options.url,
+        log: options.log,
+        agent: options.agent
+    });
 }
 
 
diff --git a/lib/vmapi.js b/lib/vmapi.js
index e3da883..b4521ca 100644
--- a/lib/vmapi.js
+++ b/lib/vmapi.js
@@ -19,6 +19,8 @@ var assert = require('assert-plus');
 var async = require('async');
 var trace_event = require('trace-event');
 var changefeed = require('changefeed');
+var cueball = require('cueball');
+var kang = require('kang');
 
 var EffluentLogger = require('effluent-logger');
 
@@ -236,12 +238,24 @@ VMAPI.prototype._initApis = function () {
         res.send(new restify.InternalError('Internal Server Error'));
     });
 
+    var agent;
+    if (config.cueballHttpAgent) {
+        agent = new cueball.HttpAgent(config.cueballHttpAgent);
+    }
+
     config.napi.log = log.child({ component: 'napi' }, true);
     config.cnapi.log = log.child({ component: 'cnapi' }, true);
     config.wfapi.log = log.child({ component: 'wfapi' }, true);
     config.moray.log = log.child({ component: 'moray' }, true);
+    config.imgapi.log = log.child({ component: 'imgapi' }, true);
+    config.papi.log = log.child({ component: 'papi' }, true);
     config.changefeed.log = log.child({ component: 'changefeed' }, true);
 
+    config.napi.agent = agent;
+    config.cnapi.agent = agent;
+    config.imgapi.agent = agent;
+    config.papi.agent = agent;
+
     // Init Moray
 
     this.moray = new MORAY(config.moray);
@@ -249,6 +263,16 @@ VMAPI.prototype._initApis = function () {
     // Add restify server to changefeed config so that it can add routes
     config.changefeed.restifyServer = this.server;
 
+    // Make a separate localhost-only server for kang
+    var kangOpts = cueball.poolMonitor.toKangOptions();
+    kangOpts.port = (this.config.api.port || 80) + 1010;
+
+    var kangServer = restify.createServer({ serverName: 'Kang' });
+    kangServer.get(new RegExp('.*'), kang.knRestifyHandler(kangOpts));
+    kangServer.listen(kangOpts.port, '127.0.0.1', function () {
+        log.info('cueball kang monitor started on port %d', kangOpts.port);
+    });
+
     // Init APIs
 
     this.cnapi = new CNAPI(config.cnapi);
diff --git a/package.json b/package.json
index 6d996de..4cf2da6 100644
--- a/package.json
+++ b/package.json
@@ -9,10 +9,12 @@
     "async": "0.2.6",
     "bunyan": "1.3.4",
     "changefeed": "1.1.8",
+    "cueball": "1.1.4",
     "deep-diff": "0.3.3",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
     "filed": "0.0.5",
     "jsprim": "^1.2.2",
+    "kang": "1.1.0",
     "ldapjs": "^1.0.0",
     "libuuid": "0.1.2",
     "moray": "git+https://github.com/joyent/node-moray.git#b84ef0e",
diff --git a/sapi_manifests/vmapi/template b/sapi_manifests/vmapi/template
index 8af9d37..c75e020 100644
--- a/sapi_manifests/vmapi/template
+++ b/sapi_manifests/vmapi/template
@@ -54,6 +54,26 @@
     "papi": {
         "url": "http://{{{PAPI_SERVICE}}}"
     },
+    "cueballHttpAgent": {
+        "resolvers": ["{{{BINDER_SERVICE}}}"],
+        "initialDomains": [
+            "{{{CNAPI_SERVICE}}}",
+            "{{{IMGAPI_SERVICE}}}",
+            "{{{NAPI_SERVICE}}}",
+            "{{{PAPI_SERVICE}}}"
+        ],
+        "spares": 2,
+        "maximum": 20,
+        "recovery": {
+            "default": {
+                "timeout": 2000,
+                "maxTimeout": 8000,
+                "retries": 5,
+                "delay": 250,
+                "maxDelay": 1000
+            }
+        }
+    },
     "moray": {
         "host": "{{{MORAY_SERVICE}}}",
         "port": 2020,
-- 
2.21.0

