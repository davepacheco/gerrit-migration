commit 56e8e293dd433d28db313d35e71d7f9acdf47d97 (refs/changes/17/5317/2)
Author: Patrick Mooney <pmooney@pfmooney.com>
Date:   2019-01-08T01:02:26+00:00 (9 months ago)
    
    OS-7483 excessive page destruction caused by 6602

diff --git a/usr/src/uts/common/io/lofi.c b/usr/src/uts/common/io/lofi.c
index 95f4cd7254..1169f3fdfc 100644
--- a/usr/src/uts/common/io/lofi.c
+++ b/usr/src/uts/common/io/lofi.c
@@ -24,6 +24,7 @@
  * Copyright 2013 Nexenta Systems, Inc. All rights reserved.
  * Copyright (c) 2016 Andrey Sokolov
  * Copyright 2016 Toomas Soome <tsoome@me.com>
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -173,7 +174,7 @@
 #define	SIZE_PROP_NAME		"Size"
 #define	ZONE_PROP_NAME		"zone"
 
-#define	SETUP_C_DATA(cd, buf, len) 		\
+#define	SETUP_C_DATA(cd, buf, len)		\
 	(cd).cd_format = CRYPTO_DATA_RAW;	\
 	(cd).cd_offset = 0;			\
 	(cd).cd_miscdata = NULL;		\
@@ -553,7 +554,7 @@ lofi_destroy(struct lofi_state *lsp, cred_t *credp)
 	}
 
 	if (lsp->ls_vp != NULL) {
-		(void) VOP_PUTPAGE(lsp->ls_vp, 0, 0, B_INVAL, credp, NULL);
+		(void) VOP_PUTPAGE(lsp->ls_vp, 0, 0, B_FREE, credp, NULL);
 		(void) VOP_CLOSE(lsp->ls_vp, lsp->ls_openflag,
 		    1, 0, credp, NULL);
 		VN_RELE(lsp->ls_vp);
@@ -2934,7 +2935,7 @@ err:
 		lofi_destroy(lsp, credp);
 	} else {
 		if (vp != NULL) {
-			(void) VOP_PUTPAGE(vp, 0, 0, B_INVAL, credp, NULL);
+			(void) VOP_PUTPAGE(vp, 0, 0, B_FREE, credp, NULL);
 			(void) VOP_CLOSE(vp, flag, 1, 0, credp, NULL);
 			VN_RELE(vp);
 		}
