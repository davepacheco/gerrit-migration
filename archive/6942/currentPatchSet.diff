From 102f4d2c606e1a72f1fec4f3d70bb21e4f750373 Mon Sep 17 00:00:00 2001
From: sjorge <sjorge@blackdot.be>
Date: Fri, 27 Sep 2019 21:18:23 +0200
Subject: [PATCH] OS-XXXX Attempt to remount the datasets

---
 usr/src/lib/brand/jcommon/libhooks.ksh | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/usr/src/lib/brand/jcommon/libhooks.ksh b/usr/src/lib/brand/jcommon/libhooks.ksh
index add9827a66..f84a51ed13 100644
--- a/usr/src/lib/brand/jcommon/libhooks.ksh
+++ b/usr/src/lib/brand/jcommon/libhooks.ksh
@@ -87,10 +87,16 @@ jattach_zone_final_setup()
 
 function juninstall_delegated_dataset
 {
-	# Reset the zoned property for any delegated datasets. Redirect to /dev/null in case they
-	# any were destroyed when we removed the zonepath dataset.
+	# Reset the zoned property for any delegated datasets. Also try and remount them
+	# in the global zone.Redirect to /dev/null in case they any were destroyed when 
+	# we removed the zonepath dataset.
 	DD=`zonecfg -z $ZONENAME info dataset | nawk '{if ($1 == "name:") print $2}'`
 	for i in $DD; do
 		zfs inherit zoned -r $i >/dev/null 2>&1
+		REMOUNT=`zfs list -o name,canmount,mounted,zoned -H -p -r $i | nawk '{if ($2 == "on" && $3 == "no" && $4 == "off") print $1 }'`
+		for j in $REMOUNT; do
+			zfs mount $j >/dev/null 2>&1
+		done
 	done
+
 }
-- 
2.21.0

