From a3a2628cbf820839d7edd7e3cdb2460ba908be58 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 22 Sep 2017 20:14:22 +0200
Subject: [PATCH] TOOLS-1865 sdcadm update gets 'SDCClientError: sapi client
 error: no active connections' after updating moray if moray is not HA

---
 lib/procedures/update-moray-v2.js | 39 +++++++++++++++++++++++++++----
 1 file changed, 35 insertions(+), 4 deletions(-)

diff --git a/lib/procedures/update-moray-v2.js b/lib/procedures/update-moray-v2.js
index 980070e..0b189fb 100644
--- a/lib/procedures/update-moray-v2.js
+++ b/lib/procedures/update-moray-v2.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -71,10 +71,11 @@ UpdateMorayV2.prototype.execute = function morayv2Execute(opts, cb) {
 
     var self = this;
     var progress = opts.progress;
-    var rollback = opts.plan.rollback ||Â false;
+    var rollback = opts.plan.rollback || false;
 
     function updateMoray(change, nextSvc) {
         var inst = change.inst;
+        var sapiVms;
 
         var arg = {
             change: change,
@@ -197,6 +198,20 @@ UpdateMorayV2.prototype.execute = function morayv2Execute(opts, cb) {
                         return next();
                     });
                 },
+                function getSapiVms(_, next) {
+                    progress('Getting SDC\'s SAPI vms from VMAPI');
+                    opts.sdcadm.vmapi.listVms({
+                        'tag.smartdc_role': 'sapi',
+                        state: 'running'
+                    }, function (vmsErr, vms_) {
+                        if (vmsErr) {
+                            next(vmsErr);
+                            return;
+                        }
+                        sapiVms = vms_;
+                        next();
+                    });
+                },
                 /**
                  * Create a temporary "morayXtmp" instance when no HA
                  */
@@ -261,7 +276,23 @@ UpdateMorayV2.prototype.execute = function morayv2Execute(opts, cb) {
                     }, next);
                 },
                 s.stopTmpVm,
-                s.destroyTmpVM
+                s.destroyTmpVM,
+                // TOOLS-1865 No-HA setup only: force a restart of the SAPI
+                // service since it doesn't hanlde too well moray restarts:
+                function restartSapiSvc(_, next) {
+                    progress('Restarting SAPI services');
+                    vasync.forEachParallel({
+                        inputs: sapiVms,
+                        func: function restartSapi(vm, next_) {
+                            s.restartRemoteSvc({
+                                server: vm.server_uuid,
+                                zone: vm.uuid,
+                                fmri: 'sapi',
+                                log: opts.log
+                            }, next_);
+                        }
+                    }, next);
+                }
             ]);
         }
         vasync.pipeline({funcs: funcs, arg: arg}, nextSvc);
@@ -291,7 +322,7 @@ UpdateMorayV2.prototype.execute = function morayv2Execute(opts, cb) {
         func: checkServiceHA
     }, cb);
 };
-//---- exports
+// --- exports
 
 module.exports = {
     UpdateMorayV2: UpdateMorayV2
-- 
2.21.0

