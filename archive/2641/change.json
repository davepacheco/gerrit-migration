{"project":"joyent/sdcadm","branch":"master","id":"Ia3a2628cbf820839d7edd7e3cdb2460ba908be58","number":"2641","subject":"TOOLS-1865 sdcadm update gets \u0027SDCClientError: sapi client error: no active connections\u0027 after updating moray if moray is not HA","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/2641","commitMessage":"TOOLS-1865 sdcadm update gets \u0027SDCClientError: sapi client error: no active connections\u0027 after updating moray if moray is not HA\n","createdOn":1506104064,"lastUpdated":1507041576,"open":false,"status":"ABANDONED","comments":[{"timestamp":1506104064,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1506104070,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 9f5c31c28a591d8ed5ae4b1d13be2bb65c5efb00\n    \n    TOOLS-1865 sdcadm update gets \u0027SDCClientError: sapi client error: no active connections\u0027 after updating moray if moray is not HA"},{"timestamp":1506104103,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506104299,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nUpdate seems to be working so far:\n\n        [root@headnode (coal) /var/sdcadm/updates]# sdcadm up moray sapi -y --force-data-path --force-same-image\n        Finding candidate update images for the \"moray\" service.\n        Finding candidate update images for the \"sapi\" service.\n        Using channel dev\n\n        This update will make the following changes:\n            update \"moray\" service to image fbe4c794-9eef-11e7-aa44-ebec6a23f515\n                (manta-moray@master-20170921T170631Z-gcb5bc63)\n            update \"sapi\" service to image 33782192-6b15-11e7-828b-bb49b1a170bc\n                (sapi@master-20170717T172226Z-g645d525)\n\n        Create work dir: /var/sdcadm/updates/20170922T180336Z\n\n        --- Updating moray ...\n        Updating image for SAPI service \"moray\"\n            service uuid: a0b42e21-1826-421a-ad95-9a7694b6c7c8\n        Installing image fbe4c794-9eef-11e7-aa44-ebec6a23f515\n            (manta-moray@master-20170921T170631Z-gcb5bc63)\n        Getting SDC\u0027s SAPI vms from VMAPI\n        Provisioning Temporary moray VM moray0tmp\n        Waiting for moray instance 6de58acb-3f4a-4a41-8ad6-8f6a6e23ff9b to come up\n        Running vmadm lookup to get tmp instance UUID\n        Checking for service errors in temporary instance 6e0f7467-6029-4752-8439-124b269ad14f\n        Waiting until 6e0f7467-6029-4752-8439-124b269ad14f instance is in DNS\n        Disabling registrar on VM 6de58acb-3f4a-4a41-8ad6-8f6a6e23ff9b\n        Wait until VM 6de58acb-3f4a-4a41-8ad6-8f6a6e23ff9b is out of DNS\n        Reprovisioning moray VM 6de58acb-3f4a-4a41-8ad6-8f6a6e23ff9b\n        Waiting for moray instance 6de58acb-3f4a-4a41-8ad6-8f6a6e23ff9b to come up\n        Waiting until 6de58acb-3f4a-4a41-8ad6-8f6a6e23ff9b instance is in DNS\n        Disabling registrar on VM 6e0f7467-6029-4752-8439-124b269ad14f\n        Wait until VM 6e0f7467-6029-4752-8439-124b269ad14f is out of DNS\n        Stop tmp VM 6e0f7467-6029-4752-8439-124b269ad14f\n        Destroying tmp VM 6e0f7467-6029-4752-8439-124b269ad14f (moray0tmp)\n        Restarting SAPI services\n\n        --- Updating sapi ...\n        Get SAPI current mode\n        Updating image for SAPI service \"sapi\"\n            service uuid: 107ef9e6-cd58-4bd5-8fa4-750397f440b1\n        Installing image 33782192-6b15-11e7-828b-bb49b1a170bc\n            (sapi@master-20170717T172226Z-g645d525)\n        Updating \u0027sapi-url\u0027 in SAPI\n        Updating \u0027sapi-url\u0027 in VM 31f5819c-6349-4d44-925d-674d0062e5c4\n        Verifying if we are on an HA setup\n        Provisioning Temporary sapi VM sapi0tmp\n        Waiting for sapi instance 31f5819c-6349-4d44-925d-674d0062e5c4 to come up\n        Running vmadm lookup to get tmp instance UUID\n        Checking for service errors in temporary instance 103dc420-19ad-438e-9fb0-9ebb0296152d\n        Waiting until 103dc420-19ad-438e-9fb0-9ebb0296152d instance is in DNS\n        Disabling registrar on VM 31f5819c-6349-4d44-925d-674d0062e5c4\n        Wait until VM 31f5819c-6349-4d44-925d-674d0062e5c4 is out of DNS\n        Reprovisioning sapi VM 31f5819c-6349-4d44-925d-674d0062e5c4\n        Waiting for sapi instance 31f5819c-6349-4d44-925d-674d0062e5c4 to come up\n        Waiting until 31f5819c-6349-4d44-925d-674d0062e5c4 instance is in DNS\n        Disabling registrar on VM 103dc420-19ad-438e-9fb0-9ebb0296152d\n        Wait until VM 103dc420-19ad-438e-9fb0-9ebb0296152d is out of DNS\n        Stop tmp VM 103dc420-19ad-438e-9fb0-9ebb0296152d\n        Destroying tmp VM 103dc420-19ad-438e-9fb0-9ebb0296152d (sapi0tmp)\n        Updated successfully (elapsed 494s)."},{"timestamp":1506115860,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1506196877,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1506615727,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nLet\u0027s forget this one and just fix SAPI to do the right thing."},{"timestamp":1507041576,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Abandoned\n\nSee SAPI-291 instead"}],"currentPatchSet":{"number":"1","revision":"a3a2628cbf820839d7edd7e3cdb2460ba908be58","parents":["8ec9ab10a047556dd9c198d8b3c4c77270bf1180"],"ref":"refs/changes/41/2641/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1506104064,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506104103,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/update-moray-v2.js","line":282,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This seems like it would be coupling Moray updates with SAPI restarts, which seems like it\u0027s unnecessary.\n\nThe root cause of the problem seems to be that SAPI cannot reconnect to Moray after Moray is restarted. Maybe a better approach to fix this would be to:\n\n1. handle the error client side in \"updateSapiSvc\" and retry periodically on a \"no active connections\" error until a maximum number of retries is reached\n\n2. have sdc-sapi be able to reconnect to moray in a more timely and reliable manner (maybe by upgrading to a more recent version of the node-moray client?)"},{"file":"lib/procedures/update-moray-v2.js","line":282,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, it\u0027s definitely a \"dirty\" take. The right thing to do is definitely #2. The #1 approach is, like this one, a temporary patch until we have the source of the problem (sdc-sapi) fixed, since this error message comes from an old node-moray client version. That\u0027s the main reason for this approach: provide a temporary sdcadm workaround until we got SAPI fixed.\n\nGetting SAPI updated to a new node-moray client version requires \"somebody\" taking care of SAPI, which is more or less what I plan to do as part of https://github.com/joyent/rfd/tree/master/rfd/0082 implementation.\n\nFinally, note that this is a \"developers only\" fix. The recommended configuration for moray is HA, and the update procedure in that case works fine. Also, that it\u0027s recommended in sdcadm update documentation that upgrades of moray, manatee and binder services shouldn\u0027t be done as part of \"sdcadm update all\".\n\n\nSo, my take would be:\n\n1. Create an \"update sdc-sapi\u0027s node-moray client\" issue and link from this one.\n2. Add this temporary patch to sdcadm with a legend of \"to be removed\" once previous SAPI issue is fixed\n3. Remember on issue resolution that non-HA moray is a devs only thing, and that recommendations on sdcadm update document should, at least, be considered.\n\nThoughts?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":35,"deletions":-4}],"sizeInsertions":35,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"a3a2628cbf820839d7edd7e3cdb2460ba908be58","parents":["8ec9ab10a047556dd9c198d8b3c4c77270bf1180"],"ref":"refs/changes/41/2641/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1506104064,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506104103,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/update-moray-v2.js","line":282,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This seems like it would be coupling Moray updates with SAPI restarts, which seems like it\u0027s unnecessary.\n\nThe root cause of the problem seems to be that SAPI cannot reconnect to Moray after Moray is restarted. Maybe a better approach to fix this would be to:\n\n1. handle the error client side in \"updateSapiSvc\" and retry periodically on a \"no active connections\" error until a maximum number of retries is reached\n\n2. have sdc-sapi be able to reconnect to moray in a more timely and reliable manner (maybe by upgrading to a more recent version of the node-moray client?)"},{"file":"lib/procedures/update-moray-v2.js","line":282,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, it\u0027s definitely a \"dirty\" take. The right thing to do is definitely #2. The #1 approach is, like this one, a temporary patch until we have the source of the problem (sdc-sapi) fixed, since this error message comes from an old node-moray client version. That\u0027s the main reason for this approach: provide a temporary sdcadm workaround until we got SAPI fixed.\n\nGetting SAPI updated to a new node-moray client version requires \"somebody\" taking care of SAPI, which is more or less what I plan to do as part of https://github.com/joyent/rfd/tree/master/rfd/0082 implementation.\n\nFinally, note that this is a \"developers only\" fix. The recommended configuration for moray is HA, and the update procedure in that case works fine. Also, that it\u0027s recommended in sdcadm update documentation that upgrades of moray, manatee and binder services shouldn\u0027t be done as part of \"sdcadm update all\".\n\n\nSo, my take would be:\n\n1. Create an \"update sdc-sapi\u0027s node-moray client\" issue and link from this one.\n2. Add this temporary patch to sdcadm with a legend of \"to be removed\" once previous SAPI issue is fixed\n3. Remember on issue resolution that non-HA moray is a devs only thing, and that recommendations on sdcadm update document should, at least, be considered.\n\nThoughts?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":35,"deletions":-4}],"sizeInsertions":35,"sizeDeletions":-4}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}