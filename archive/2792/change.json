{"project":"joyent/node-sdc-clients","branch":"master","id":"I355734de9f222430d4621ec6a8efe398a439054d","number":"2792","subject":"TOOLS-1867 sdc-clients: add paging to napi.listIPs","owner":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"url":"https://cr.joyent.us/2792","commitMessage":"TOOLS-1867 sdc-clients: add paging to napi.listIPs\n","createdOn":1508186396,"lastUpdated":1513649523,"open":true,"status":"NEW","comments":[{"timestamp":1508186396,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 1."},{"timestamp":1508186398,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 92eb845e7aadb4b3bb1d89e732dcfbca8f6174d0\n    \n    first pass"},{"timestamp":1508186432,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508187066,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1508201128,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1508257694,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1508282065,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1508774798,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 2."},{"timestamp":1508774800,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit c26e8b9bece6d38f55d66ef4e924e5708d0fe606\n    \n    TOOLS-1867"},{"timestamp":1508774828,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508774983,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1508785481,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1508884160,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1513649523,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\n(2 comments)"}],"currentPatchSet":{"number":"2","revision":"355734de9f222430d4621ec6a8efe398a439054d","parents":["6b5ff7af7a197397ac60afd89cf9efcaa80ef965"],"ref":"refs/changes/92/2792/2","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1508774798,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508774828,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508785481,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"lib/napi.js","line":536,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps:\n\n```\n    if (params.hasOwnProperty(\u0027limit\u0027) || params.hasOwnProperty(\u0027offset\u0027)) {\n\n```\n\nWhile `limit: 0` seems broken, passing in an explicit `offset: 0` could be reasonable to manually get a single page with the default limit."},{"file":"lib/napi.js","line":536,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Agreed - if the parameters are set (even as garbage values) we can say it\u0027s the intent of the caller to manually get a page of data and not have automatic paging."},{"file":"lib/napi.js","line":548,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"available in node-vasync v2.2.0"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/napi.js","type":"MODIFIED","insertions":59,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/napi.test.js","type":"MODIFIED","insertions":41,"deletions":-4}],"sizeInsertions":106,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"b9b7d615f886a8d4fa1d07d2260c493fe6a3ff73","parents":["6b5ff7af7a197397ac60afd89cf9efcaa80ef965"],"ref":"refs/changes/92/2792/1","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1508186396,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508186432,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/napi.js","line":8,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Copyright (c) 2017, Joyent, Inc."},{"file":"lib/napi.js","line":8,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/napi.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patchset with this is still coming?"},{"file":"lib/napi.js","line":511,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This seems a bit verbose.  Perhaps just \"Pagination is handled by this function unless params.limit or params.offset is set\""},{"file":"lib/napi.js","line":511,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"As a newbie, I prefer the verbose version. :)"},{"file":"lib/napi.js","line":511,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I took this from another one of the listing endpoints.  \nIf you find it useful I will leave it as is."},{"file":"lib/napi.js","line":543,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Thanks for bearing with me here if you knew all this already.\n\nLooks like you started with VMAPI.listVms. Note that it starts with `limit\u003dundefined` because it doesn\u0027t assume it knows what VMAPI\u0027s default \"limit\" is.  The downside of this is that it always needs to make at least two requests to VMAPI.listVms (one with offset\u003d0 and a second with offset\u003dvmsFromFirstResponse.length).\n\n\nSince VMAPI.listVms was last updated in node-sdc-clients I believe VMAPI docs have been updated to guarantee the default and max limit\u003d\u003d\u003d1000 (https://mo.joyent.com/docs/vmapi/master/#limit). That mean that the VMAPI.listVms implementation here *could* change to avoid always needing a second request.\n\nFor NAPI ListIPs you know the max and default limit is 1000:  https://mo.joyent.com/docs/napi/master/#pagination\nBecause of that you are fine with starting with limit\u003d1000.\n\nIf you like you could switch to copying the implementation for CNAPI.listServers (in lib/cnapi.js). \n\nPros:\n- it avoids adding usage of the \"async\" module\n- it maintains compat with the simple `self.get(...)` in that the first request and response objects are returned in the callback\n\nCon:\n- It is recursive (instead of using async or vasync) so technically you could hit a max stack depth error if there are many 1000s of IPs."},{"file":"lib/napi.js","line":543,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I can go back and adjust VMAPI.listVms if you want, but I rather that be a separate ticket.\n\nI think it makes sense to stick with the higher level abstractions we have built such as vasync.whilst especially because the vasync module is already pulled in and used elsewhere.\n\nCan you explain or point me to a ticket about the compat with the first req and res?  I am not familiar with whats going on there."},{"file":"lib/napi.js","line":543,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\u003e I can go back and adjust VMAPI.listVms if you want, but I rather that be a separate ticket.\n\nSure, if you like. Not required. And, yes, definitely a separate ticket.\n\n\n\n\u003e Can you explain or point me to a ticket about the compat with the first req and res? I am not familiar with whats going on there.\n\nOriginally the code was:\n\n```\nreturn this.get(opts, callback);\n```\n\nWhich resulted in the callback being called like this:\nhttps://github.com/joyent/node-sdc-clients/blob/6b5ff7af7a197397ac60afd89cf9efcaa80ef965/lib/restifyclient.js#L108-L113\n\n```\ncallback(err, obj, req, res);\n```\n\nWith the new impl we are calling back with:\n\n```\ncallback(err, obj);\n```\n\nFirst, we are potentially doing multiple requests so it is a little weird to be returning just one of the req/res pairs. So it is question of whether returning the first req/res is sufficient to call it compatible.\n\nAlso, FWIW, my guess it is unlikely any callers are using those req/res values.\n\nFor CNAPI.listServers I chose to save firstReq/firstRes and return those in the callback."},{"file":"lib/napi.js","line":548,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t have a spec to stand on, but perhaps use \"TODO\" rather than \"XXX\" here? Granted this is total personal pref: I try to never commit/ship code with \"XXX\", but don\u0027t mind \"TODO\". Some others in eng will tend to insist a TODO is removed in favour of logging a ticket."},{"file":"lib/napi.js","line":548,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/napi.js","line":568,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027d prefer if this check was made to be explicit.  Ie.\n\n    if (someIps.length \u003d\u003d\u003d 0) {\n        ...\n    }"},{"file":"lib/napi.js","line":568,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/napi.test.js","line":144,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027m not sure who this comment is directed towards.  Why are you bumping this from 0 to 1?"},{"file":"test/napi.test.js","line":144,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"That was a comment to myself I forgot to remove.\nThe intent was that since the other tests are looking to return a limit: 1, or an offset ip, then this should test that \u003e1 ips should be returned."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/napi.js","type":"MODIFIED","insertions":58,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/napi.test.js","type":"MODIFIED","insertions":34,"deletions":-4}],"sizeInsertions":98,"sizeDeletions":-8},{"number":"2","revision":"355734de9f222430d4621ec6a8efe398a439054d","parents":["6b5ff7af7a197397ac60afd89cf9efcaa80ef965"],"ref":"refs/changes/92/2792/2","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1508774798,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508774828,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508785481,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"lib/napi.js","line":536,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps:\n\n```\n    if (params.hasOwnProperty(\u0027limit\u0027) || params.hasOwnProperty(\u0027offset\u0027)) {\n\n```\n\nWhile `limit: 0` seems broken, passing in an explicit `offset: 0` could be reasonable to manually get a single page with the default limit."},{"file":"lib/napi.js","line":536,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Agreed - if the parameters are set (even as garbage values) we can say it\u0027s the intent of the caller to manually get a page of data and not have automatic paging."},{"file":"lib/napi.js","line":548,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"available in node-vasync v2.2.0"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/napi.js","type":"MODIFIED","insertions":59,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/napi.test.js","type":"MODIFIED","insertions":41,"deletions":-4}],"sizeInsertions":106,"sizeDeletions":-9}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}]}