From 66accc06ae8d203154c3f7bc742541c91c05dd69 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 16 Feb 2018 14:28:39 -0800
Subject: [PATCH] TRITON-124 add node-triton support for bhyve

---
 CHANGES.md                               |  7 +++++++
 lib/do_fwrule/do_instances.js            |  4 +++-
 lib/do_instance/do_create.js             | 12 +++++++++++-
 lib/do_instance/do_list.js               |  4 +++-
 lib/do_instance/do_snapshot/do_create.js |  4 ++--
 package.json                             |  2 +-
 6 files changed, 27 insertions(+), 6 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 609b4df..92e075a 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -6,6 +6,13 @@ Known issues:
 
 ## not yet released
 
+## 5.8.0
+
+- [TRITON-124] add node-triton support for bhyve. This adds a `triton instance
+  create --brand=bhyve ...` option that can be used for zvol images that support
+  it. Note that bhyve support is alpha in TritonDC -- most datacenters won't yet
+  support this option.
+
 ## 5.7.0
 
 - [TRITON-116] node-triton image sharing. Adds `triton image share` and
diff --git a/lib/do_fwrule/do_instances.js b/lib/do_fwrule/do_instances.js
index 53bc6bf..b549f16 100644
--- a/lib/do_fwrule/do_instances.js
+++ b/lib/do_fwrule/do_instances.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  *
  * `triton fwrule instances ...`
  */
@@ -111,6 +111,7 @@ function do_instances(subcmd, opts, args, cb) {
                     common.uuidToShortId(inst.image);
                 inst.shortid = inst.id.split('-', 1)[0];
                 var flags = [];
+                if (inst.brand === 'bhyve') flags.push('B');
                 if (inst.docker) flags.push('D');
                 if (inst.firewall_enabled) flags.push('F');
                 if (inst.brand === 'kvm') flags.push('K');
@@ -159,6 +160,7 @@ do_instances.help = [
     'for convenience):',
     '    shortid*           A short ID prefix.',
     '    flags*             Single letter flags summarizing some fields:',
+    '                           "B" the brand is "bhyve"',
     '                           "D" docker instance',
     '                           "F" firewall is enabled',
     '                           "K" the brand is "kvm"',
diff --git a/lib/do_instance/do_create.js b/lib/do_instance/do_create.js
index 47b7e18..886bebb 100644
--- a/lib/do_instance/do_create.js
+++ b/lib/do_instance/do_create.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2017 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  *
  * `triton instance create ...`
  */
@@ -376,6 +376,9 @@ function do_create(subcmd, opts, args, cb) {
                     function (net) { return net.id; })
             };
 
+            if (opts.brand) {
+                createOpts.brand = opts.brand;
+            }
             if (ctx.volMounts) {
                 createOpts.volumes = ctx.volMounts;
             }
@@ -492,6 +495,13 @@ do_create.options = [
     {
         group: 'Create options'
     },
+    {
+        names: ['brand'],
+        helpArg: 'BRAND',
+        type: 'string',
+        help: 'Override the default brand for this instance. Most users will ' +
+            'not need this option.'
+    },
     {
         names: ['name', 'n'],
         helpArg: 'NAME',
diff --git a/lib/do_instance/do_list.js b/lib/do_instance/do_list.js
index 2619a3a..3892efc 100644
--- a/lib/do_instance/do_list.js
+++ b/lib/do_instance/do_list.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  *
  * `triton instance list ...`
  */
@@ -150,6 +150,7 @@ function do_list(subcmd, opts, args, callback) {
                     common.uuidToShortId(inst.image);
                 inst.shortid = inst.id.split('-', 1)[0];
                 var flags = [];
+                if (inst.brand === 'bhyve') flags.push('B');
                 if (inst.docker) flags.push('D');
                 if (inst.firewall_enabled) flags.push('F');
                 if (inst.brand === 'kvm') flags.push('K');
@@ -208,6 +209,7 @@ do_list.help = [
     'for convenience):',
     '    shortid*           A short ID prefix.',
     '    flags*             Single letter flags summarizing some fields:',
+    '                           "B" the brand is "bhyve"',
     '                           "D" docker instance',
     '                           "F" firewall is enabled',
     '                           "K" the brand is "kvm"',
diff --git a/lib/do_instance/do_snapshot/do_create.js b/lib/do_instance/do_snapshot/do_create.js
index de7b5cf..62df2f6 100644
--- a/lib/do_instance/do_snapshot/do_create.js
+++ b/lib/do_instance/do_snapshot/do_create.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  *
  * `triton snapshot create ...`
  */
@@ -133,7 +133,7 @@ do_create.help = [
     '{{usage}}',
     '',
     '{{options}}',
-    'Snapshot do not work for instances of type "kvm".'
+    'Snapshots do not work for instances of type "bhyve" or "kvm".'
 ].join('\n');
 
 do_create.completionArgtypes = ['tritoninstance', 'none'];
diff --git a/package.json b/package.json
index 03cc0eb..3516090 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "triton",
   "description": "Joyent Triton CLI and client (https://www.joyent.com/triton)",
-  "version": "5.7.0",
+  "version": "5.8.0",
   "author": "Joyent (joyent.com)",
   "homepage": "https://github.com/joyent/node-triton",
   "dependencies": {
-- 
2.21.0

