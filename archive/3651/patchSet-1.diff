From c857d74c09a1ac374302449417f2245628d9b6a8 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Thu, 15 Mar 2018 20:10:17 +0000
Subject: [PATCH] OS-6726 bhyve program should be in /usr/sbin, not
 /usr/sbin/amd64

---
 manifest                            |   8 +-
 usr/src/cmd/bhyve/Makefile          | 101 ++++++++++++++++++++----
 usr/src/cmd/bhyve/Makefile.com      | 118 ----------------------------
 usr/src/cmd/bhyve/amd64/Makefile    |  21 -----
 usr/src/cmd/bhyvectl/Makefile       |  46 ++++++++---
 usr/src/cmd/bhyvectl/Makefile.com   |  55 -------------
 usr/src/cmd/bhyvectl/amd64/Makefile |  21 -----
 7 files changed, 123 insertions(+), 247 deletions(-)
 delete mode 100644 usr/src/cmd/bhyve/Makefile.com
 delete mode 100644 usr/src/cmd/bhyve/amd64/Makefile
 delete mode 100644 usr/src/cmd/bhyvectl/Makefile.com
 delete mode 100644 usr/src/cmd/bhyvectl/amd64/Makefile

diff --git a/manifest b/manifest
index 5262bdb261..ace9001d6e 100644
--- a/manifest
+++ b/manifest
@@ -5107,7 +5107,7 @@ f usr/lib/brand/bhyve/uninstall 0555 root sys
 f usr/lib/brand/bhyve/config.xml 0444 root sys
 f usr/lib/brand/bhyve/platform.xml 0444 root sys
 f usr/lib/brand/bhyve/statechange 0555 root sys
-h usr/lib/brand/bhyve/zhyve=usr/sbin/amd64/bhyve
+h usr/lib/brand/bhyve/zhyve=usr/sbin/bhyve
 d usr/lib/brand/lx 0755 root bin
 s usr/lib/brand/lx/64=amd64
 d usr/lib/brand/lx/amd64 0755 root bin
@@ -10273,8 +10273,6 @@ f usr/sbin/acpixtract 0555 root bin
 f usr/sbin/add_drv 0555 root bin
 f usr/sbin/allocate 4555 root bin
 d usr/sbin/amd64 0755 root bin
-f usr/sbin/amd64/bhyve 0555 root sys
-f usr/sbin/amd64/bhyvectl 0555 root sys
 f usr/sbin/amd64/dtrace 0555 root bin
 f usr/sbin/amd64/intrstat 0555 root bin
 f usr/sbin/amd64/ipf 0555 root bin
@@ -10296,8 +10294,8 @@ f usr/sbin/auditstat 0555 root bin
 h usr/sbin/audlinks=usr/sbin/devfsadm
 s usr/sbin/automount=../lib/fs/autofs/automount
 s usr/sbin/autopush=../../sbin/autopush
-h usr/sbin/bhyve=usr/lib/isaexec
-h usr/sbin/bhyvectl=usr/lib/isaexec
+f usr/sbin/bhyve 0555 root sys
+f usr/sbin/bhyvectl 0555 root sys
 f usr/sbin/cfgadm 0555 root bin
 f usr/sbin/check-hostname 0555 root mail
 f usr/sbin/check-permissions 0555 root mail
diff --git a/usr/src/cmd/bhyve/Makefile b/usr/src/cmd/bhyve/Makefile
index 0ffbff6b6f..7975589c66 100644
--- a/usr/src/cmd/bhyve/Makefile
+++ b/usr/src/cmd/bhyve/Makefile
@@ -18,28 +18,101 @@ PROG =		bhyve
 ZHYVE =		$(ROOT)/usr/lib/brand/bhyve/zhyve
 
 include ../Makefile.cmd
+include ../Makefile.cmd.64
+include ../Makefile.ctf
 
-$(BUILD64)SUBDIRS += $(MACH64)
+SRCS =	acpi.c			\
+	atkbdc.c		\
+	bhyvegc.c		\
+	bhyverun.c		\
+	block_if.c		\
+	bootrom.c		\
+	console.c		\
+	consport.c		\
+	dbgport.c		\
+	fwctl.c			\
+	inout.c			\
+	ioapic.c		\
+	mem.c			\
+	mptbl.c			\
+	pci_ahci.c		\
+	pci_e82545.c		\
+	pci_emul.c		\
+	pci_fbuf.c		\
+	pci_hostbridge.c	\
+	pci_irq.c		\
+	pci_lpc.c		\
+	pci_passthru.c		\
+	pci_uart.c		\
+	pci_virtio_block.c	\
+	pci_virtio_net.c	\
+	pci_virtio_rnd.c	\
+	pci_virtio_viona.c	\
+	pci_xhci.c		\
+	pm.c			\
+	post.c			\
+	ps2kbd.c		\
+	ps2mouse.c		\
+	rfb.c			\
+	rtc.c			\
+	smbiostbl.c		\
+	sockstream.c		\
+	task_switch.c		\
+	uart_emul.c		\
+	usb_emul.c		\
+	usb_mouse.c		\
+	vga.c			\
+	virtio.c		\
+	vmm_instruction_emul.c	\
+	xmsr.c			\
+	spinup_ap.c		\
+	bhyve_sol_glue.c	\
+	zhyve.c
 
-all	:=	TARGET = all
-install	:=	TARGET = install
-clean	:=	TARGET = clean
-clobber	:=	TARGET = clobber
-lint	:=	TARGET = lint
+OBJS = $(SRCS:.c=.o)
+
+CLEANFILES =	$(PROG)
+CLOBBERFILES =	$(ROOTUSRSBINPROG) $(ZHYVE)
+
+CFLAGS +=	$(CCVERBOSE) -_gcc=-Wimplicit-function-declaration -_gcc=-Wno-parentheses
+CPPFLAGS =	-I$(COMPAT)/freebsd -I$(CONTRIB)/freebsd \
+		-I$(COMPAT)/freebsd/amd64 -I$(CONTRIB)/freebsd/amd64 \
+		-I$(CONTRIB)/freebsd/dev/usb/controller \
+		-I$(CONTRIB)/freebsd/dev/mii \
+		-I$(SRC)/uts/common/io/e1000api \
+		$(CPPFLAGS.master) \
+		-I$(ROOT)/usr/platform/i86pc/include \
+		-I$(SRC)/uts/i86pc/io/vmm \
+		-I$(SRC)/uts/common \
+		-I$(SRC)/uts/i86pc \
+		-I$(SRC)/lib/libdladm/common \
+		-DWITHOUT_CAPSICUM
+LDLIBS +=	-lsocket -lnsl -ldlpi -ldladm -lmd -luuid -lvmmapi -lz -lnvpair
+
+POST_PROCESS += ; $(GENSETDEFS) $@
 
 .KEEP_STATE:
 
-all clean clobber lint:	$(SUBDIRS)
+# Real main is in zhyve.c
+bhyverun.o :=	CPPFLAGS += -Dmain=bhyve_main
 
-install: $(SUBDIRS) $(USRSHAREFILES)
-	$(RM) $(ROOTUSRSBINPROG)
-	$(LN) $(ISAEXEC) $(ROOTUSRSBINPROG)
+all: $(PROG)
+
+$(PROG): $(OBJS)
+	$(LINK.c) -o $@ $(OBJS) $(LDFLAGS) $(LDLIBS)
+	$(POST_PROCESS)
+
+install: all $(ROOTUSRSBINPROG)
 	$(RM) $(ZHYVE)
-	$(LN) $(ROOTUSRSBIN64)/$(PROG) $(ZHYVE)
+	$(LN) $(ROOTUSRSBIN)/$(PROG) $(ZHYVE)
 
-$(SUBDIRS):	FRC
-	@cd $@; pwd; $(MAKE) CW_NO_SHADOW=true __GNUC= $(TARGET)
+clean:
+	$(RM) $(OBJS) $(CLEANFILES)
 
-FRC:
+lint:	lint_SRCS
 
 include ../Makefile.targ
+
+%.o: $(SRC)/uts/i86pc/io/vmm/%.c
+	$(COMPILE.c) $<
+	$(POST_PROCESS_O)
diff --git a/usr/src/cmd/bhyve/Makefile.com b/usr/src/cmd/bhyve/Makefile.com
deleted file mode 100644
index 1f7e87e074..0000000000
--- a/usr/src/cmd/bhyve/Makefile.com
+++ /dev/null
@@ -1,118 +0,0 @@
-#
-# This file and its contents are supplied under the terms of the
-# Common Development and Distribution License ("CDDL"), version 1.0.
-# You may only use this file in accordance with the terms of version
-# 1.0 of the CDDL.
-#
-# A full copy of the text of the CDDL should have accompanied this
-# source.  A copy of the CDDL is also available via the Internet at
-# http://www.illumos.org/license/CDDL.
-#
-
-#
-# Copyright 2015 Pluribus Networks Inc.
-# Copyright 2018 Joyent, Inc.
-#
-
-PROG= bhyve
-
-SRCS =	acpi.c			\
-	atkbdc.c		\
-	bhyvegc.c		\
-	bhyverun.c		\
-	block_if.c		\
-	bootrom.c		\
-	console.c		\
-	consport.c		\
-	dbgport.c		\
-	fwctl.c			\
-	inout.c			\
-	ioapic.c		\
-	mem.c			\
-	mptbl.c			\
-	pci_ahci.c		\
-	pci_e82545.c		\
-	pci_emul.c		\
-	pci_fbuf.c		\
-	pci_hostbridge.c	\
-	pci_irq.c		\
-	pci_lpc.c		\
-	pci_passthru.c		\
-	pci_uart.c		\
-	pci_virtio_block.c	\
-	pci_virtio_net.c	\
-	pci_virtio_rnd.c	\
-	pci_virtio_viona.c	\
-	pci_xhci.c		\
-	pm.c			\
-	post.c			\
-	ps2kbd.c		\
-	ps2mouse.c		\
-	rfb.c			\
-	rtc.c			\
-	smbiostbl.c		\
-	sockstream.c		\
-	task_switch.c		\
-	uart_emul.c		\
-	usb_emul.c		\
-	usb_mouse.c		\
-	vga.c			\
-	virtio.c		\
-	vmm_instruction_emul.c	\
-	xmsr.c			\
-	spinup_ap.c		\
-	bhyve_sol_glue.c	\
-	zhyve.c
-
-OBJS = $(SRCS:.c=.o)
-
-include ../../Makefile.cmd
-include ../../Makefile.ctf
-
-.KEEP_STATE:
-
-CFLAGS +=	$(CCVERBOSE) -_gcc=-Wimplicit-function-declaration -_gcc=-Wno-parentheses
-CFLAGS64 +=	$(CCVERBOSE) -_gcc=-Wimplicit-function-declaration -_gcc=-Wno-parentheses
-CPPFLAGS =	-I$(COMPAT)/freebsd -I$(CONTRIB)/freebsd \
-		-I$(CONTRIB)/freebsd/dev/usb/controller \
-		-I$(CONTRIB)/freebsd/dev/mii \
-		-I$(SRC)/uts/common/io/e1000api \
-		$(CPPFLAGS.master) \
-		-I$(ROOT)/usr/platform/i86pc/include \
-		-I$(SRC)/uts/i86pc/io/vmm \
-		-I$(SRC)/uts/common \
-		-I$(SRC)/uts/i86pc \
-		-I$(SRC)/lib/libdladm/common \
-		-DWITHOUT_CAPSICUM
-LDLIBS +=	-lsocket -lnsl -ldlpi -ldladm -lmd -luuid -lvmmapi -lz -lnvpair
-
-POST_PROCESS += ; $(GENSETDEFS) $@
-
-# Real main is in zhyve.c
-bhyverun.o :=	CPPFLAGS += -Dmain=bhyve_main
-
-all: $(PROG)
-
-$(PROG): $(OBJS)
-	$(LINK.c) -o $@ $(OBJS) $(LDFLAGS) $(LDLIBS)
-	$(POST_PROCESS)
-
-install: all $(ROOTUSRSBINPROG)
-
-clean:
-	$(RM) $(OBJS)
-
-lint:	lint_SRCS
-
-include ../../Makefile.targ
-
-%.o: ../%.c
-	$(COMPILE.c) $<
-	$(POST_PROCESS_O)
-
-%.o: $(SRC)/uts/i86pc/io/vmm/%.c
-	$(COMPILE.c) $<
-	$(POST_PROCESS_O)
-
-%.o: ../%.s
-	$(COMPILE.s) $<
diff --git a/usr/src/cmd/bhyve/amd64/Makefile b/usr/src/cmd/bhyve/amd64/Makefile
deleted file mode 100644
index 13cdae6663..0000000000
--- a/usr/src/cmd/bhyve/amd64/Makefile
+++ /dev/null
@@ -1,21 +0,0 @@
-#
-# This file and its contents are supplied under the terms of the
-# Common Development and Distribution License ("CDDL"), version 1.0.
-# You may only use this file in accordance with the terms of version
-# 1.0 of the CDDL.
-#
-# A full copy of the text of the CDDL should have accompanied this
-# source.  A copy of the CDDL is also available via the Internet at
-# http://www.illumos.org/license/CDDL.
-#
-
-#
-# Copyright 2015 Pluribus Networks Inc.
-#
-
-include ../Makefile.com
-include ../../Makefile.cmd.64
-
-CPPFLAGS += -I$(COMPAT)/freebsd/amd64 -I$(CONTRIB)/freebsd/amd64
-
-install: all $(ROOTUSRSBINPROG64)
diff --git a/usr/src/cmd/bhyvectl/Makefile b/usr/src/cmd/bhyvectl/Makefile
index fe98204056..c412725fb3 100644
--- a/usr/src/cmd/bhyvectl/Makefile
+++ b/usr/src/cmd/bhyvectl/Makefile
@@ -11,31 +11,51 @@
 
 #
 # Copyright 2013 Pluribus Networks Inc.
+# Copyright 2018 Joyent, Inc.
 #
 
 PROG =		bhyvectl
 
 include ../Makefile.cmd
+include ../Makefile.cmd.64
 
-$(BUILD64)SUBDIRS += $(MACH64)
+SRCS =		bhyvectl.c
+OBJS =		$(SRCS:.c=.o) humanize_number.o
 
-all	:=	TARGET = all
-install	:=	TARGET = install
-clean	:=	TARGET = clean
-clobber	:=	TARGET = clobber
-lint	:=	TARGET = lint
+CLEANFILES =	$(PROG)
+CLOBBERFILES +=	$(ROOTUSRSBINPROG)
 
 .KEEP_STATE:
 
-all clean clobber lint:	$(SUBDIRS)
+CFLAGS +=	$(CCVERBOSE)
+CPPFLAGS =	-I$(COMPAT)/freebsd -I$(CONTRIB)/freebsd \
+		-I$(COMPAT)/freebsd/amd64 -I$(CONTRIB)/freebsd/amd64 \
+		$(CPPFLAGS.master) \
+		-I$(ROOT)/usr/platform/i86pc/include \
+		-I$(SRC)/uts/i86pc/io/vmm
+LDLIBS +=	-lvmmapi
 
-install: $(SUBDIRS)
-	-$(RM) $(ROOTUSRSBINPROG)
-	-$(LN) $(ISAEXEC) $(ROOTUSRSBINPROG)
+CERRWARN +=	-_gcc=-Wno-uninitialized
 
-$(SUBDIRS):	FRC
-	@cd $@; pwd; $(MAKE) CW_NO_SHADOW=true __GNUC= $(TARGET)
+all: $(PROG)
 
-FRC:
+$(PROG): $(OBJS)
+	$(LINK.c) -o $@ $(OBJS) $(LDFLAGS) $(LDLIBS)
+	$(POST_PROCESS)
+
+install: all $(ROOTUSRSBINPROG)
+
+clean:
+	$(RM) $(OBJS) $(CLEANFILES)
+
+lint:	lint_SRCS
 
 include ../Makefile.targ
+
+%.o: $(CONTRIB)/freebsd/lib/libutil/%.c
+	$(COMPILE.c) -o $@ $<
+	$(POST_PROCESS_O)
+
+%.o: ../%.c
+	$(COMPILE.c) -I$(SRC)/common $<
+	$(POST_PROCESS_O)
diff --git a/usr/src/cmd/bhyvectl/Makefile.com b/usr/src/cmd/bhyvectl/Makefile.com
deleted file mode 100644
index 450ba6709e..0000000000
--- a/usr/src/cmd/bhyvectl/Makefile.com
+++ /dev/null
@@ -1,55 +0,0 @@
-#
-# This file and its contents are supplied under the terms of the
-# Common Development and Distribution License ("CDDL"), version 1.0.
-# You may only use this file in accordance with the terms of version
-# 1.0 of the CDDL.
-#
-# A full copy of the text of the CDDL should have accompanied this
-# source.  A copy of the CDDL is also available via the Internet at
-# http://www.illumos.org/license/CDDL.
-#
-
-#
-# Copyright 2013 Pluribus Networks Inc.
-# Copyright 2017 Joyent, Inc.
-#
-
-PROG= bhyvectl
-
-SRCS = bhyvectl.c
-OBJS = $(SRCS:.c=.o) humanize_number.o
-
-include ../../Makefile.cmd
-
-.KEEP_STATE:
-
-CFLAGS +=	$(CCVERBOSE)
-CPPFLAGS =	-I$(COMPAT)/freebsd -I$(CONTRIB)/freebsd $(CPPFLAGS.master) \
-	-I$(ROOT)/usr/platform/i86pc/include \
-	-I$(SRC)/uts/i86pc/io/vmm
-LDLIBS +=	-lvmmapi
-
-CERRWARN +=	-_gcc=-Wno-uninitialized
-
-all: $(PROG)
-
-$(PROG): $(OBJS)
-	$(LINK.c) -o $@ $(OBJS) $(LDFLAGS) $(LDLIBS)
-	$(POST_PROCESS)
-
-install: all $(ROOTUSRSBINPROG)
-
-clean:
-	$(RM) $(OBJS)
-
-lint:	lint_SRCS
-
-include ../../Makefile.targ
-
-%.o: $(CONTRIB)/freebsd/lib/libutil/%.c
-	$(COMPILE.c) -o $@ $<
-	$(POST_PROCESS_O)
-
-%.o: ../%.c
-	$(COMPILE.c) -I$(SRC)/common $<
-	$(POST_PROCESS_O)
diff --git a/usr/src/cmd/bhyvectl/amd64/Makefile b/usr/src/cmd/bhyvectl/amd64/Makefile
deleted file mode 100644
index b602c50d05..0000000000
--- a/usr/src/cmd/bhyvectl/amd64/Makefile
+++ /dev/null
@@ -1,21 +0,0 @@
-#
-# This file and its contents are supplied under the terms of the
-# Common Development and Distribution License ("CDDL"), version 1.0.
-# You may only use this file in accordance with the terms of version
-# 1.0 of the CDDL.
-#
-# A full copy of the text of the CDDL should have accompanied this
-# source.  A copy of the CDDL is also available via the Internet at
-# http://www.illumos.org/license/CDDL.
-#
-
-#
-# Copyright 2013 Pluribus Networks Inc.
-#
-
-include ../Makefile.com
-include ../../Makefile.cmd.64
-
-CPPFLAGS += -I$(COMPAT)/freebsd/amd64 -I$(CONTRIB)/freebsd/amd64
-
-install: all $(ROOTUSRSBINPROG64)
-- 
2.21.0

