commit b6a6d44d939b3f49ab572251a080dbb3beb1162c (refs/changes/01/2001/1)
Author: Trent Mick <trentm@gmail.com>
Date:   2017-05-24T17:56:19-07:00 (2 years, 5 months ago)
    
    IMGAPI-627 switch standalone IMGAPI to using ECDSA keys

diff --git a/CHANGES.md b/CHANGES.md
index 8445b24..7079fac 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,7 +1,10 @@
 # IMGAPI changelog
 
-## 3.1.3
+## 3.2.0
 
+- IMGAPI-627 With this change, a standalone IMGAPI will use an ECDSA key for
+  auth to its Manta storage (if any). Before this a 4k RSA key was used, which,
+  for node at least, is slow so put a significant limit on req/s.
 
 ## 3.1.2
 
diff --git a/boot/standalone/setup.sh b/boot/standalone/setup.sh
index 8ff28aa..f0c8c4a 100755
--- a/boot/standalone/setup.sh
+++ b/boot/standalone/setup.sh
@@ -60,13 +60,13 @@ echo 'if [ "$PS1" ]; then eval $(/opt/smartdc/imgapi/bin/manta-env 2>/dev/null |
 if [[ ! -d /data/imgapi ]]; then
     # etc/ and instance ssh key
     mkdir -p /data/imgapi/etc
-    [[ ! -f /data/imgapi/etc/imgapi-*.id_rsa ]] \
-        || fatal "unexpected existing IMGAPI instance key files: /data/imgapi/etc/imgapi-*.id_rsa"
+    [[ ! -f /data/imgapi/etc/imgapi-*.id_ecdsa ]] \
+        || fatal "unexpected existing IMGAPI instance key files: /data/imgapi/etc/imgapi-*.id_ecdsa"
     keyName=$NODENAME-$(date -u '+%Y%m%d')
-    ssh-keygen -t rsa -b 4096 -N "" \
-        -C "$keyName" -f /data/imgapi/etc/$keyName.id_rsa
+    ssh-keygen -t ecdsa -b 256 -N "" \
+        -C "$keyName" -f /data/imgapi/etc/$keyName.id_ecdsa
     # Write pubkey to mdata so outside tooling can use it for setup.
-    mdata-put instPubKey < /data/imgapi/etc/$keyName.id_rsa.pub
+    mdata-put instPubKey < /data/imgapi/etc/$keyName.id_ecdsa.pub
 
     # Self-signed cert
     /opt/local/bin/openssl req -x509 -nodes -subj '/CN=*' -newkey rsa:2048 \
@@ -85,7 +85,7 @@ if [[ ! -d /data/imgapi ]]; then
     # imgapi SMF service runs as 'nobody'
     chown nobody:nobody /data/imgapi
     chown nobody:nobody /data/imgapi/etc
-    chown nobody:nobody /data/imgapi/etc/$keyName.id_rsa{,.pub}
+    chown nobody:nobody /data/imgapi/etc/$keyName.id_ecdsa{,.pub}
     chown nobody:nobody /data/imgapi/etc/cert.pem
     chown nobody:nobody /data/imgapi/etc/imgapi.config.json
     chown nobody:nobody /data/imgapi/etc/authkeys
@@ -95,8 +95,8 @@ else
 fi
 
 # Manta CLI tools require that key be in ~/.ssh
-ln -s /data/imgapi/etc/$keyName.id_rsa ~/.ssh/
-ln -s /data/imgapi/etc/$keyName.id_rsa.pub ~/.ssh/
+ln -s /data/imgapi/etc/$keyName.id_ecdsa ~/.ssh/
+ln -s /data/imgapi/etc/$keyName.id_ecdsa.pub ~/.ssh/
 
 # Log rotation
 mkdir -p /var/log/triton/upload
diff --git a/docs/operator-guide.md b/docs/operator-guide.md
index cd5c78f..44939fa 100644
--- a/docs/operator-guide.md
+++ b/docs/operator-guide.md
@@ -20,7 +20,7 @@ There are two main types of IMGAPI:
 2. `standalone`: A standalone IMGAPI, that runs independent of a Triton
    DataCenter. These are configured with `mode === "public"` (for public images,
    example "images.joyent.com") or `mode === "private"` (for repos with private
-   images, example "updates.joyent.com"). These server HTTPS over a public
+   images, example "updates.joyent.com"). These serve HTTPS over a public
    network (via stud for SSL termination, to HAproxy for possible load
    balancing, to one or more node.js IMGAPI processes). They are typically
    configured to use HTTP Signature auth (like Triton's CloudAPI and Manta's web
@@ -125,18 +125,21 @@ For example:
 
     cd /var/tmp
     curl -kO https://raw.githubusercontent.com/joyent/sdc-imgapi/master/bin/imgapi-standalone-create
+    chmod +x imgapi-standalone-create
 
     # A play IMGAPI in COAL using a local 'trentm' COAL account and
     # /trent.mick/stor/tmp/images in Manta:
-    bash ./imgapi-standalone-create \
+    ./imgapi-standalone-create \
         -m mantaUrl=https://us-east.manta.joyent.com \
-        -m mantaUser=trent.mick -m mantaBaseDir=tmp/images \
+        -m mantaUser=trent.mick \
+        -m mantaBaseDir=tmp/images \
         trentm latest sample-2G myimages0
 
     # An deployment of images.joyent.com might look like this:
-    bash ./imgapi-standalone-create \
+    ./imgapi-standalone-create \
         -m mantaUrl=https://us-east.manta.joyent.com \
-        -m mantaUser=joyops -m mantaBaseDir=images.joyent.com \
+        -m mantaUser=joyops \
+        -m mantaBaseDir=images.joyent.com \
         -t triton.cns.services=imagesjo \
         joyops latest g4-highcpu-2G imagesjo0
 
@@ -148,7 +151,7 @@ below). The `-t` option adds an instance tag -- in this case to use
 
 ## Standalone Setup Step 2: edit config
 
-After creation one may edit the generated config file at
+After creation, one may edit the generated config file at
 "/data/imgapi/etc/imgapi.config.json" manually. Afterwards, remember to
 restart the imgapi service:
 
diff --git a/package.json b/package.json
index a00ca10..068bc18 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgapi",
   "description": "Image API to manage images for SDC 7",
-  "version": "3.2.2",
+  "version": "3.2.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -23,7 +23,7 @@
     "uuid": "2.0.2",
     "manta": "3.1.2",
     "manta-dir-watcher": "1.1.0",
-    "manta-sync": "0.4.0",
+    "manta-sync": "0.4.2",
     "memorystream": "0.2.0",
     "mkdirp": "0.3.5",
     "moray": "git+https://github.com/joyent/node-moray.git#fd5781bc25a9bfe2ba82167664639753fb9f0ca5",
@@ -36,7 +36,7 @@
     "rimraf": "2.2.6",
     "sdc-clients": "10.0.4",
     "semver": "3.0.1",
-    "sshpk": "1.10.0",
+    "sshpk": "1.13.0",
     "trace-event": "1.2.0",
     "ufds": "1.2.0",
     "vasync": "1.6.3",
diff --git a/tools/standalone/tritonlogupload.sh b/tools/standalone/tritonlogupload.sh
index 39e4e11..b8e17af 100755
--- a/tools/standalone/tritonlogupload.sh
+++ b/tools/standalone/tritonlogupload.sh
@@ -17,7 +17,7 @@
 # This is to allow log rotation to complete.
 #
 #       0 * * * * /usr/sbin/logadm -v >>/var/log/logadm.log 2>&1
-#       1 * * * * /.../tritonlogupload.sh -a 5 >>/var/log/tritonlogupload.log 2>&1
+#       1 * * * * /opt/smartdc/imgapi/bin/tritonlogupload.sh -a 5 >>/var/log/tritonlogupload.log 2>&1
 #
 # Currently this is hardcoded for standalone IMGAPI usage, getting
 # manta config info from $CONFIG. TODO: generalize this.
