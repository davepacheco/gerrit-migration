{"project":"joyent/illumos-joyent","branch":"master","id":"Ie8607df599b64684fa1e6d992bb2bd2a78ad329d","number":"4001","subject":"OS-6912 bhyve virtio-blk should sync when needed Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/4001","commitMessage":"OS-6912 bhyve virtio-blk should sync when needed\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1527176692,"lastUpdated":1528529401,"open":false,"status":"MERGED","comments":[{"timestamp":1527176692,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1527179887,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1527180072,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527262341,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1527262984,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1527271362,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1527284637,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1527504262,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1527504454,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1527897201,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)\n\nLooks good, modulo the one small nit"},{"timestamp":1528122321,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1528123097,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5."},{"timestamp":1528123624,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1528137295,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1528276006,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\nRe testing: isn\u0027t it worth doing a quick few block IO / guest file IO performance tests?"},{"timestamp":1528485430,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Integration-Approval+1\n\nI agree with jlevon about doing some I/O perf tests, but it\u0027s probably not required before this specific wad goes back."},{"timestamp":1528527880,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1528528811,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1528529401,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"7","revision":"e8607df599b64684fa1e6d992bb2bd2a78ad329d","parents":["e2369459ab12f803d44f6b49c6f48b06f28c7f9f"],"ref":"refs/changes/01/4001/7","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528528811,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528123624,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528137295,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528485430,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1528529401,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":50,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"86a27399126ee20e768d4a0b070d93ad743e7723","parents":["b64971bdda5ebae57056a4d21f436426ccab8f25"],"ref":"refs/changes/01/4001/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1527176692,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/bhyve/block_if.c","line":305,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I don\u0027t think this change does anything.  Am I missing something?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":305,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"It does something :)\n\nPreviously we wouldn\u0027t do anything for character devices as we didn\u0027t port that code to issue the proper ioctl. Now we just call fsync() on character devices, too, which will just work for us."},{"file":"usr/src/cmd/bhyve/block_if.c","line":305,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":292,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Won\u0027t this cause the sync write to return prior the flush?  It seems as though the callback needs to signal a cv that is waited on after calling blockif_flush()."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":292,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Yes, there is a pretty big problem here with reordering that I completely missed. :-(\n\nAfter spending a lot of time today wrapping my head around this code and the virtio spec I concluded that it would be best if I could just toggle O_SYNC on the opened file, but it seems we don\u0027t support that on zvols and don\u0027t even support fcntl() F_SETFL on specfs.\n\nAs a correct implementation using a separate blockif_flush() would likely be too complex I decided to add an argument \"sync\" to blockif_write() and handle it directly when executing the write."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":293,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I don\u0027t think we can ignore the return here.  If E2BIG is returned, it should probably be retried."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":293,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"In the rewrite I also ignore any errors from fsync(). I\u0027m not sure what a good way to handle an fsync() error would be, and under what circumstances it could arrive. Should I fail the (already succeeded) write?"},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":293,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"write() succeeded, but it doesn\u0027t mean with certainty that the write is on disk.  Because of that, I think that a successful fsync() means it is certainly on disk.  A failed fsync() means it may or may not be there and as such we must return an error that is a valid write(2) error."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":293,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done. According to fsync(3c) and write(2) all possible errors returned by fsync() can also be returned by write(). ETIMEDOUT might be the only exception, but that could be an oversight in the manpage. This error seems to be limited to a specific NFS use case and I don\u0027t see why it couldn\u0027t occur in write(), too."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":16,"sizeDeletions":-2},{"number":"2","revision":"65070403a3fdba9a2256f7e2f0ade2cac7bc66a6","parents":["b64971bdda5ebae57056a4d21f436426ccab8f25"],"ref":"refs/changes/01/4001/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1527262341,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/bhyve/block_if.c","line":324,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should this change persist, given the restructuring?  If not, it would probably be nice to see the whole freebsd block in the ifdef, with our own in the #else."},{"file":"usr/src/cmd/bhyve/block_if.c","line":324,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/cmd/bhyve/block_if.c","line":352,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Could just move this up under the BOP_WRITE code and check be_op, rather than carrying \u0027sync\u0027 through the whole function.  Should we report a failed write if the sync fails?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":352,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Due to the (IMHO) weird structure of the BOP_WRITE code I\u0027d prefer to leave it down here for now. If it wasn\u0027t for that reason I would have made it a fallthrough into the BOP_FLUSH code, but this will need some restructuring that I don\u0027t want to conflate with this bug.\n\nRegarding errors, I changed it to return the error from fsync() if it failed. As Mike pointed out we can consider that  to be the same as \"the write didn\u0027t complete\"."},{"file":"usr/src/cmd/bhyve/pci_ahci.c","line":744,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"What does the AHCI standard say about this?  If we\u0027re punting on it, perhaps say so in a comment?"},{"file":"usr/src/cmd/bhyve/pci_ahci.c","line":744,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I couldn\u0027t find anything in the AHCI standard, and I don\u0027t have access to the SATA standard. But I found the ATA8 standard, which I assume still applies.\n\nThe AHCI emulation always reports a write cache to be present and enabled, and there is no code to disable it. The commands to enable/disable the caches always complete successfully without doing anything.\n\nFor now I\u0027ll add a short comment and file a bug to revisit the AHCI cache handling at a later time."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":28,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":42,"sizeDeletions":-2},{"number":"3","revision":"6d6b6c8888ab751b816df0ede34e9e701f385fbd","parents":["b64971bdda5ebae57056a4d21f436426ccab8f25"],"ref":"refs/changes/01/4001/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1527504262,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/bhyve/block_if.c","line":285,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Unneeded extra newline, now (diff from base)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":51,"sizeDeletions":-2},{"number":"4","revision":"fc6a3ebedbe803d26ee92fb2c193d05d98603e71","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/01/4001/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528122321,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":51,"sizeDeletions":-2},{"number":"5","revision":"81091e92795e64371694644741e7af660cdf7619","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/01/4001/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528123097,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528137295,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528485430,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528123624,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":50,"sizeDeletions":-2},{"number":"6","revision":"f785a58b96bf4b6cb66ed5ee98f78291947786aa","parents":["e2369459ab12f803d44f6b49c6f48b06f28c7f9f"],"ref":"refs/changes/01/4001/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528527880,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528137295,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528485430,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528123624,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":50,"sizeDeletions":-2},{"number":"7","revision":"e8607df599b64684fa1e6d992bb2bd2a78ad329d","parents":["e2369459ab12f803d44f6b49c6f48b06f28c7f9f"],"ref":"refs/changes/01/4001/7","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528528811,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528137295,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528485430,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1528529401,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528123624,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":31,"deletions":-2},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":50,"sizeDeletions":-2}],"allReviewers":[{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}