From 4ed2b1e5a3a41169b25b871f0ebd9ca16db248bc Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 6 Mar 2017 15:23:51 -0800
Subject: [PATCH] DOCKER-165 why does 'docker info' hit IMGAPI ListImages so
 much?

---
 lib/backends/sdc/images.js  | 12 ++++++++++++
 lib/backends/sdc/index.js   |  1 +
 lib/backends/sdc/sysinfo.js |  6 ++----
 lib/models/image.js         | 35 ++++++++++++++++++++++++++++++++++-
 4 files changed, 49 insertions(+), 5 deletions(-)

diff --git a/lib/backends/sdc/images.js b/lib/backends/sdc/images.js
index 4c92e9e..b2b70fe 100644
--- a/lib/backends/sdc/images.js
+++ b/lib/backends/sdc/images.js
@@ -1789,6 +1789,17 @@ function tagImage(opts, callback) {
 }
 
 
+function getImageCount(opts, callback) {
+    assert.object(opts, 'opts');
+    assert.object(opts.app, 'opts.app');
+    assert.optionalObject(opts.log, 'opts.log');
+    assert.object(opts.account, 'opts.account');
+
+    Image.imageCount(opts.app, opts.log, {owner_uuid: opts.account.uuid},
+        callback);
+}
+
+
 // ---- exports
 
 module.exports = {
@@ -1796,6 +1807,7 @@ module.exports = {
     createImage: createImage,
     deleteImage: deleteImage,
     dockerImageJsonToModel: dockerImageJsonToModel,
+    getImageCount: getImageCount,
     getDockerImageForUuid: getDockerImageForUuid,
     getImageHistory: getImageHistory,
     getScratchImage: getScratchImage,
diff --git a/lib/backends/sdc/index.js b/lib/backends/sdc/index.js
index ca536d0..6cf17d9 100644
--- a/lib/backends/sdc/index.js
+++ b/lib/backends/sdc/index.js
@@ -67,6 +67,7 @@ SdcBackend.prototype.containerArchiveStat =
 SdcBackend.prototype.addImageHeads = images.addImageHeads;
 SdcBackend.prototype.createImage = images.createImage;
 SdcBackend.prototype.deleteImage = images.deleteImage;
+SdcBackend.prototype.getImageCount = images.getImageCount;
 SdcBackend.prototype.getImageHistory = images.getImageHistory;
 SdcBackend.prototype.getScratchImage = images.getScratchImage;
 SdcBackend.prototype.listImages = images.listImages;
diff --git a/lib/backends/sdc/sysinfo.js b/lib/backends/sdc/sysinfo.js
index 25f56cc..ba002df 100644
--- a/lib/backends/sdc/sysinfo.js
+++ b/lib/backends/sdc/sysinfo.js
@@ -105,14 +105,12 @@ function getInfo(opts, callback) {
     };
 
     var countImages = function (cb) {
-        opts.skip_smartos = true;
-        opts.all = true;
-        self.listImages(opts, function (iErr, imgs) {
+        self.getImageCount(opts, function (iErr, num) {
             if (iErr) {
                 log.warn(iErr, 'error listing images for Info');
                 // Stumble on.
             } else {
-                info.Images = imgs.length;
+                info.Images = num;
             }
             cb();
         });
diff --git a/lib/models/image.js b/lib/models/image.js
index 87d7146..b0dab77 100644
--- a/lib/models/image.js
+++ b/lib/models/image.js
@@ -348,6 +348,38 @@ function datacenterRefcount(app, log, params, callback) {
 }
 
 
+/**
+ * Returns the number of docker image layers owned by the given owner uuid.
+ */
+function imageCount(app, log, params, callback) {
+    assert.object(params, 'image params');
+    assert.string(params.owner_uuid, 'params.owner_uuid');
+
+    var query = format(
+        'select count(*) from %s where owner_uuid = \'%s\'',
+        BUCKET.name, params.owner_uuid
+    );
+
+    var client = app.moray;
+    var count = 0;
+    var req = client.sql(query);
+    var oncecb = once(callback);
+
+    req.on('record', function (rec) {
+        count = Number(rec.count);
+    });
+
+    req.on('error', function (err) {
+        oncecb(err);
+    });
+
+    req.on('end', function () {
+        log.debug({owner_uuid: params.owner_uuid, count: count}, 'imageCount');
+        oncecb(null, count);
+    });
+}
+
+
 /**
  * Every funtion should just take care of replacing the column with a new
  * value, or just return if it doesn't apply. When an updated object needs
@@ -484,5 +516,6 @@ module.exports = {
     list: listImages,
     Image: Image,
     update: updateImage,
-    datacenterRefcount: datacenterRefcount
+    datacenterRefcount: datacenterRefcount,
+    imageCount: imageCount
 };
-- 
2.21.0

