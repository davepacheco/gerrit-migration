From 4a5c55d2fef94c12b423bdf67d3a6931f0d6346e Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 6 Jun 2017 19:33:56 +0200
Subject: [PATCH] ZAPI-754 use cueball for talking to other SDC services

---
 lib/apis/cnapi.js             |  5 +++--
 lib/apis/imgapi.js            |  8 ++++++--
 lib/apis/napi.js              |  5 +++--
 lib/apis/papi.js              |  8 ++++++--
 package.json                  |  1 +
 sapi_manifests/vmapi/template | 30 ++++++++++++++++++++++++------
 server.js                     | 13 +++++++++++--
 7 files changed, 54 insertions(+), 16 deletions(-)

diff --git a/lib/apis/cnapi.js b/lib/apis/cnapi.js
index 19afd42..4260a91 100644
--- a/lib/apis/cnapi.js
+++ b/lib/apis/cnapi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -26,7 +26,8 @@ function Cnapi(options) {
         url: options.url,
         version: '*',
         log: options.log,
-        retry: { retries: 2 }
+        retry: { retries: 2 },
+        agent: options.agent
     });
 }
 
diff --git a/lib/apis/imgapi.js b/lib/apis/imgapi.js
index 7854dbc..c9d7d6b 100644
--- a/lib/apis/imgapi.js
+++ b/lib/apis/imgapi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -21,7 +21,11 @@ var sdc = require('sdc-clients');
  */
 function Imgapi(options) {
     this.log = options.log;
-    this.client = new sdc.IMGAPI({ url: options.url, log: options.log });
+    this.client = new sdc.IMGAPI({
+        url: options.url,
+        log: options.log,
+        agent: options.agent
+    });
 }
 
 
diff --git a/lib/apis/napi.js b/lib/apis/napi.js
index 1441b15..1906804 100644
--- a/lib/apis/napi.js
+++ b/lib/apis/napi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -27,7 +27,8 @@ function Napi(options) {
     this.client = restify.createJsonClient({
         url: options.url,
         version: '*',
-        log: options.log
+        log: options.log,
+        agent: options.agent
     });
 }
 
diff --git a/lib/apis/papi.js b/lib/apis/papi.js
index bd5006e..7dad134 100644
--- a/lib/apis/papi.js
+++ b/lib/apis/papi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -21,7 +21,11 @@ var sdc = require('sdc-clients');
  */
 function Papi(options) {
     this.log = options.log;
-    this.client = sdc.PAPI({ url: options.url, log: options.log });
+    this.client = sdc.PAPI({
+        url: options.url,
+        log: options.log,
+        agent: options.agent
+    });
 }
 
 
diff --git a/package.json b/package.json
index 39fe63b..8b9609c 100644
--- a/package.json
+++ b/package.json
@@ -10,6 +10,7 @@
     "backoff": "2.5.0",
     "bunyan": "1.8.1",
     "changefeed": "1.3.0",
+    "cueball": "2.2.7",
     "dashdash": "1.14.1",
     "deep-diff": "0.3.3",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
diff --git a/sapi_manifests/vmapi/template b/sapi_manifests/vmapi/template
index ecad82c..f80562f 100644
--- a/sapi_manifests/vmapi/template
+++ b/sapi_manifests/vmapi/template
@@ -64,6 +64,27 @@
             "resolvers": ["{{{BINDER_SERVICE}}}"]
         }
     },
+    "cueballHttpAgent": {
+        "resolvers": ["{{{BINDER_SERVICE}}}"],
+        "initialDomains": [
+            "{{{cnapi_domain}}}",
+            "{{{napi_domain}}}",
+            "{{{wfapi_domain}}}",
+            "{{{imgapi_domain}}}",
+            "{{{papi_domain}}}"
+        ],
+        "spares": 4,
+        "maximum": 100,
+        "recovery": {
+            "default": {
+                "timeout": 2000,
+                "maxTimeout": 8000,
+                "retries": 5,
+                "delay": 250,
+                "maxDelay": 1000
+            }
+        }
+    },
     "changefeed": {
         "resources": [
             {
@@ -84,12 +105,9 @@
         ],
         "moray": {
             "bucketName": "vmapi_changefeed",
-            "host": "{{{MORAY_SERVICE}}}",
-            "port": 2020,
-            "connectTimeout": 200,
-            "retry": {
-                "retries": 2,
-                "minTimeout": 500
+            "srvDomain": "{{MORAY_SERVICE}}",
+            "cueballOptions": {
+                "resolvers": ["{{{BINDER_SERVICE}}}"]
             }
         },
         "maxAge": 120
diff --git a/server.js b/server.js
index 7645456..75754c9 100644
--- a/server.js
+++ b/server.js
@@ -14,6 +14,7 @@
 
 var assert = require('assert-plus');
 var changefeed = require('changefeed');
+var cueball = require('cueball');
 var fs = require('fs');
 var http = require('http');
 var https = require('https');
@@ -67,29 +68,39 @@ function createApiClients(config, parentLog) {
     assert.object(config, 'config');
     assert.object(parentLog, 'parentLog');
 
+    var agent;
+    if (config.cueballHttpAgent) {
+        agent = new cueball.HttpAgent(config.cueballHttpAgent);
+    }
+
     assert.object(config.cnapi, 'config.cnapi');
     var cnapiClientOpts = jsprim.deepCopy(config.cnapi);
     cnapiClientOpts.log = parentLog.child({ component: 'cnapi' }, true);
+    cnapiClientOpts.agent = agent;
     var cnapiClient = new CNAPI(cnapiClientOpts);
 
     assert.object(config.imgapi, 'config.imgapi');
     var imgapiClientOpts = jsprim.deepCopy(config.imgapi);
     imgapiClientOpts.log = parentLog.child({ component: 'imgapi' }, true);
+    imgapiClientOpts.agent = agent;
     var imgapiClient = new IMGAPI(imgapiClientOpts);
 
     assert.object(config.napi, 'config.napi');
     var napiClientOpts = jsprim.deepCopy(config.napi);
     napiClientOpts.log = parentLog.child({ component: 'napi' }, true);
+    napiClientOpts.agent = agent;
     var napiClient = new NAPI(napiClientOpts);
 
     assert.object(config.papi, 'config.papi');
     var papiClientOpts = jsprim.deepCopy(config.papi);
     papiClientOpts.log = parentLog.child({ component: 'papi' }, true);
+    papiClientOpts.agent = agent;
     var papiClient = new PAPI(papiClientOpts);
 
     assert.object(config.wfapi, 'config.wfapi');
     var wfapiClientOpts = jsprim.deepCopy(config.wfapi);
     wfapiClientOpts.log = parentLog.child({ component: 'wfapi' }, true);
+    wfapiClientOpts.agent = agent;
     var wfapiClient = new WFAPI(wfapiClientOpts);
 
     return {
@@ -122,8 +133,6 @@ function startVmapiService() {
     http.globalAgent.maxSockets = config.maxSockets || 100;
     https.globalAgent.maxSockets = config.maxSockets || 100;
 
-    apiClients = createApiClients(config, vmapiLog);
-
     vasync.parallel({funcs: [
         function initChangefeedPublisher(done) {
             var changefeedOptions = jsprim.deepCopy(config.changefeed);
-- 
2.21.0

