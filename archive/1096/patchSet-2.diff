From f46bb3a343e2005199e06450dded9de91b06dbe3 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 9 Dec 2016 00:14:51 +0000
Subject: [PATCH] OS-5814 chromium fails on pid namespace, even with the
 --disable-namespace-sandbox option

---
 usr/src/common/brand/lx/lx_syscall.h         | 13 +++++++++++++
 usr/src/lib/brand/lx/lx_brand/common/clone.c | 10 ++++++++++
 2 files changed, 23 insertions(+)

diff --git a/usr/src/common/brand/lx/lx_syscall.h b/usr/src/common/brand/lx/lx_syscall.h
index a0292023a0..ab179d3705 100644
--- a/usr/src/common/brand/lx/lx_syscall.h
+++ b/usr/src/common/brand/lx/lx_syscall.h
@@ -86,7 +86,15 @@ extern "C" {
 #define	LX_CLONE_PARENT_SETTID	0x00100000
 #define	LX_CLONE_CHILD_CLEARTID	0x00200000
 #define	LX_CLONE_DETACH		0x00400000
+#define	LX_CLONE_UNTRACED	0x00800000
 #define	LX_CLONE_CHILD_SETTID	0x01000000
+#define	LX_CLONE_NEWCGROUP	0x02000000
+#define	LX_CLONE_NEWUTS		0x04000000
+#define	LX_CLONE_NEWIPC		0x08000000
+#define	LX_CLONE_NEWUSER	0x10000000
+#define	LX_CLONE_NEWPID		0x20000000
+#define	LX_CLONE_NEWNET		0x40000000
+#define	LX_CLONE_IO		0x80000000
 
 #define	SHARED_AS \
 	(LX_CLONE_VM | LX_CLONE_FS | LX_CLONE_FILES | LX_CLONE_SIGHAND | \
@@ -102,6 +110,11 @@ extern "C" {
 				(X & SHARED_AS) != SHARED_AS && \
 				((X & SHARED_AS) & ~LX_CLONE_GRP_SUBSET) == 0)
 
+#define	LX_CLONE_NS_UNSUP	(LX_CLONE_NEWCGROUP | LX_CLONE_NEWUTS | \
+				LX_CLONE_NEWIPC | LX_CLONE_NEWUSER | \
+				LX_CLONE_NEWPID | LX_CLONE_NEWNET | \
+				LX_CLONE_IO)
+
 #ifdef	__cplusplus
 }
 #endif
diff --git a/usr/src/lib/brand/lx/lx_brand/common/clone.c b/usr/src/lib/brand/lx/lx_brand/common/clone.c
index 698d13f9d1..b04ee953a3 100644
--- a/usr/src/lib/brand/lx/lx_brand/common/clone.c
+++ b/usr/src/lib/brand/lx/lx_brand/common/clone.c
@@ -338,6 +338,16 @@ lx_clone(uintptr_t p1, uintptr_t p2, uintptr_t p3, uintptr_t p4, uintptr_t p5)
 			return (-EINVAL);
 	}
 
+	if ((flags & LX_CLONE_NS_UNSUP) != 0) {
+		lx_unsupported("clone(2) no namespace support "
+		    "(flags:0x%08X)\n", flags);
+		/*
+		 * When the "kernel" does not support namespaces, applications
+		 * (e.g. chromium) expect EINVAL, not ENOTSUP.
+		 */
+		return (-EINVAL);
+	}
+
 	ucp = lx_syscall_regs();
 
 	/* test if pointer passed by user are writable */
-- 
2.21.0

