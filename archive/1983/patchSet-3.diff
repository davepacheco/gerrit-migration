From 1fef83708b266a3e5b340587478069ca859e26b6 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Mon, 22 May 2017 16:14:40 +0200
Subject: [PATCH] =?UTF-8?q?TOOLS-1784=20sdcadm=20up=20moray=20in=20a=20set?=
 =?UTF-8?q?up=20with=20non-HA=20moray=20fails=20to=20bring=20moray=20up=20?=
 =?UTF-8?q?Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.?=
 =?UTF-8?q?com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@?=
 =?UTF-8?q?joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/procedures/index.js | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/lib/procedures/index.js b/lib/procedures/index.js
index b40e7d8..0b3599f 100644
--- a/lib/procedures/index.js
+++ b/lib/procedures/index.js
@@ -26,17 +26,22 @@ var errors = require('../errors'),
     UsageError = errors.UsageError;
 
 // --- HA ready services
-var HA_READY_SVCS = [
+
+// Here "SIMPLE" means those that can be upgraded with the
+// UpdateStatelessServices.
+var HA_READY_SIMPLE_SVCS = [
     'adminui',
     'cloudapi',
     'cmon',
     'mahi',
-    'moray',
     'nat',
     'papi',
     'portolan',
     'workflow'
 ];
+var ALL_HA_READY_SVCS = HA_READY_SIMPLE_SVCS.concat([
+    'moray'
+]);
 
 // --- Disallowed agents
 var DISALLOWED_AGENTS = ['provisioner', 'heartbeater', 'zonetracker'];
@@ -172,10 +177,10 @@ function coordinatePlan(opts, cb) {
          */
         function updateSimpleServices(_, next) {
             var simpleServices = [
-                'adminui', 'amon', 'amonredis', 'assets', 'ca',
+                'amon', 'amonredis', 'assets', 'ca',
                 'cnapi', 'cns', 'dhcpd', 'docker', 'fwapi', 'manta',
                 'napi', 'rabbitmq', 'redis', 'sdc', 'vmapi'
-            ].concat(HA_READY_SVCS);
+            ].concat(HA_READY_SIMPLE_SVCS);
             var handle = [];
             var remaining = [];
             var errs = [];
@@ -217,7 +222,8 @@ function coordinatePlan(opts, cb) {
                             change.insts = svcInsts;
                             handle.push(change);
                         } else {
-                            if (~HA_READY_SVCS.indexOf(change.service.name)) {
+                            if (~HA_READY_SIMPLE_SVCS.indexOf(
+                                change.service.name)) {
                                 var chInsts = forceSameImage ? svcInsts :
                                         svcInsts.filter(function (ins) {
                                             return (ins.image !==
@@ -628,7 +634,8 @@ function coordinatePlan(opts, cb) {
 
                     var sName = change.service.name;
                     var allowed = ((avoid.indexOf(sName) === -1) &&
-                        (HA_READY_SVCS.indexOf(sName) !== -1 || change.force));
+                        (ALL_HA_READY_SVCS.indexOf(sName) !== -1 ||
+                            change.force));
 
                     if (allowed) {
                         log.debug({
-- 
2.21.0

