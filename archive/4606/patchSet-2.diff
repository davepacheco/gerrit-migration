From 0f8e8f1ad3908008ffdb711589bd467949f279f6 Mon Sep 17 00:00:00 2001
From: Jared Morrow <jm@joyent.com>
Date: Tue, 31 Jul 2018 07:24:09 -0600
Subject: [PATCH] MANTA-1387 libmanta should log and ignore BucketVersionError

---
 lib/moray.js | 6 +++++-
 package.json | 2 +-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/lib/moray.js b/lib/moray.js
index e89b7b6..2cadd37 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -403,7 +403,11 @@ function createBucket(opts, cb) {
     var client = opts.client;
 
     client.putBucket(bucket, opts.opts, function (err) {
-        if (err) {
+        if (err && VError.findCauseByName(err, 'BucketVersionError') !== null) {
+            opts.log.warn(err, 'bucket schema out of date');
+            opts.log.debug(opts.opts, 'Moray.createBucket done');
+            cb();
+        } else if (err) {
             err.bucket = opts.bucket;
             err.opts = opts.opts;
             cb(err);
diff --git a/package.json b/package.json
index 82e16e9..28805e6 100644
--- a/package.json
+++ b/package.json
@@ -20,7 +20,7 @@
         "restify": "2.6.3",
         "redis": "0.10.1",
         "vasync": "1.6.3",
-        "verror": "1.6.0",
+        "verror": "^1.8.1",
         "xtend": "2.1.2"
     },
     "devDependencies": {
-- 
2.21.0

