From 49a8650fdd2368876e6e167cf076aaa0102f79be Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Tue, 26 Jun 2018 12:56:05 +0000
Subject: [PATCH] TRITON-551 sdcadm build fails as non-root, trying to create
 log dir

---
 lib/logging.js | 3 +--
 tools/mk-shar  | 8 ++++----
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/lib/logging.js b/lib/logging.js
index dddbd42..72ebdd6 100644
--- a/lib/logging.js
+++ b/lib/logging.js
@@ -196,6 +196,7 @@ function createLogger(opts) {
             level: 'trace',
             path: logFile
         });
+	mkdirp.sync(LOG_DIR);
     } else {
         logStreams.push({
             type: 'raw',
@@ -207,8 +208,6 @@ function createLogger(opts) {
         });
     }
 
-    mkdirp.sync(LOG_DIR);
-
     return bunyan.createLogger({
         name: opts.name,
         component: opts.component,
diff --git a/tools/mk-shar b/tools/mk-shar
index 97fa44e..9cd0d4c 100755
--- a/tools/mk-shar
+++ b/tools/mk-shar
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
@@ -73,7 +73,7 @@ trap 'errexit $?' EXIT
 
 rm -rf $PROTO
 mkdir -p $PROTO
-cp -PR \
+/opt/local/bin/cp -PR \
     $TOP/bin \
     $TOP/lib \
     $TOP/etc \
@@ -84,11 +84,11 @@ cp -PR \
     $TOP/tools/install-sdcadm.sh \
     $TOP/package.json \
     $PROTO
-cp -PR \
+/opt/local/bin/cp -PR \
     $TOP/build/node \
     $PROTO/node
 mkdir -p $PROTO/tools
-cp -P $TOP/tools/rotate-logs.sh $PROTO/tools/
+/opt/local/bin/cp -P $TOP/tools/rotate-logs.sh $PROTO/tools/
 
 # Trim out cruft for smaller package.
 rm -rf $PROTO/node/bin/npm
-- 
2.21.0

