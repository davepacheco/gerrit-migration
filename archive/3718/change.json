{"project":"joyent/illumos-joyent","branch":"master","id":"I6c405e7d1f82b6361a0b8d378fedf830fe4dded6","number":"3718","subject":"OS-6821 kmdb should stash %cr3 in kdiregs Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/3718","commitMessage":"OS-6821 kmdb should stash %cr3 in kdiregs\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1521855423,"lastUpdated":1522283175,"open":false,"status":"MERGED","comments":[{"timestamp":1521855423,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1522081445,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(3 comments)\n\nAlso, might be nice: now that ::crregs %cr3 output is of very limited use, could we fix that to dig out the saved kreg instead the direct %cr3 contents?"},{"timestamp":1522096787,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1522190678,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1522231223,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nGreat, thanks."},{"timestamp":1522241222,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1522282863,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1522283001,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1522283077,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1522283175,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"4","revision":"2949a1032201150f88cbdd0caa1c59564b68345c","parents":["c71361021aefa698da0636af512389499353e02d"],"ref":"refs/changes/18/3718/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1522283077,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522231223,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522241222,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522282863,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1522283175,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_amd64util.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_kreg.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","type":"MODIFIED","insertions":36,"deletions":0},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/intel/amd64/sys/kdi_regs.h","type":"MODIFIED","insertions":12,"deletions":-11},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","type":"MODIFIED","insertions":41,"deletions":-5}],"sizeInsertions":96,"sizeDeletions":-18},"patchSets":[{"number":"1","revision":"ecd19d66aae50a64834677153f1ce66b53c662d4","parents":["d5eb108ff4a94b03a014e90e6213bf7bf4faa374"],"ref":"refs/changes/18/3718/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1521855423,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","line":547,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"It might be worth commenting why we don\u0027t worry about swapgs, and maybe be more explicit that we\u0027re on the kpti_dbg stack space?"},{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","line":547,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, will add comment about the %gs state here. We\u0027re not on the kpti_dbg stack space at entry, we\u0027re in wherever the KDI regs struct was put (often the kthread stack, but when we resume from some contexts it can be  different). The point of the first part of the function is to pivot to the kpti_dbg space so we can change cr3 :)"},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","line":545,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"why isn\u0027t this %gs:CPU_KPTI_DBG directly?"},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","line":545,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We\u0027re after its address (we have to put the address of the kpti_dbg into %r13 when we call the trampoline). You can\u0027t leaq %gs:BLAH. So we have to figure out what address the %gs descriptor is pointing at. This seemed easier than reading it out of GSBASE."},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","line":545,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Yep, seems fine"},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","line":565,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Nit, why not tr_iret_kdi to match all the other trampoline names?"},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","line":565,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, will change."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_amd64util.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_kreg.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","type":"MODIFIED","insertions":27,"deletions":0},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/intel/amd64/sys/kdi_regs.h","type":"MODIFIED","insertions":12,"deletions":-11},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","type":"MODIFIED","insertions":41,"deletions":-5}],"sizeInsertions":87,"sizeDeletions":-18},{"number":"2","revision":"6c405e7d1f82b6361a0b8d378fedf830fe4dded6","parents":["d5eb108ff4a94b03a014e90e6213bf7bf4faa374"],"ref":"refs/changes/18/3718/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1522190678,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522241222,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522231223,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522282863,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_amd64util.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_kreg.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","type":"MODIFIED","insertions":36,"deletions":0},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/intel/amd64/sys/kdi_regs.h","type":"MODIFIED","insertions":12,"deletions":-11},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","type":"MODIFIED","insertions":41,"deletions":-5}],"sizeInsertions":96,"sizeDeletions":-18},{"number":"3","revision":"65b5f1f172bfa5f95686688fac50d4abe0e8cff1","parents":["c71361021aefa698da0636af512389499353e02d"],"ref":"refs/changes/18/3718/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1522283001,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522241222,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522231223,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522282863,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_amd64util.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_kreg.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","type":"MODIFIED","insertions":36,"deletions":0},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/intel/amd64/sys/kdi_regs.h","type":"MODIFIED","insertions":12,"deletions":-11},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","type":"MODIFIED","insertions":41,"deletions":-5}],"sizeInsertions":96,"sizeDeletions":-18},{"number":"4","revision":"2949a1032201150f88cbdd0caa1c59564b68345c","parents":["c71361021aefa698da0636af512389499353e02d"],"ref":"refs/changes/18/3718/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1522283077,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1522283175,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522241222,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522231223,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522282863,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_amd64util.c","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/mdb/mdb_kreg.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/ml/kpti_trampolines.s","type":"MODIFIED","insertions":36,"deletions":0},{"file":"usr/src/uts/i86pc/ml/offsets.in","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/intel/amd64/sys/kdi_regs.h","type":"MODIFIED","insertions":12,"deletions":-11},{"file":"usr/src/uts/intel/kdi/kdi_asm.s","type":"MODIFIED","insertions":41,"deletions":-5}],"sizeInsertions":96,"sizeDeletions":-18}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}