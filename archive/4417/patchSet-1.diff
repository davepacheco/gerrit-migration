From 30f119008a99f1b833f68bbd09ae4ce526190630 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 22 Jun 2018 12:40:23 -0700
Subject: [PATCH] TRITON-539 improve sdcnode README and provide command to list
 Triton/Manta usage of sdcnode

---
 Makefile         |  11 ++---
 README.md        | 125 ++++++++++++++++++++++++++++++-----------------
 nodeconfigs.json |   1 +
 3 files changed, 86 insertions(+), 51 deletions(-)

diff --git a/Makefile b/Makefile
index a8f5b41..02ccd9b 100644
--- a/Makefile
+++ b/Makefile
@@ -5,11 +5,11 @@
 #
 
 #
-# Copyright (c) 2017, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
-# SDC Node makefile.
+# sdcnode makefile
 #
 
 include ./tools/mk/Makefile.defs
@@ -21,10 +21,6 @@ include ./tools/mk/Makefile.defs
 CLEAN_FILES += build/nodes bits
 DISTCLEAN_FILES += build
 
-ifeq ($(UPLOAD_LOCATION),)
-	UPLOAD_LOCATION=bits@bits.joyent.us:builds
-endif
-
 HOST_IMAGE=$(shell mdata-get sdc:image_uuid)
 
 
@@ -52,9 +48,10 @@ bits:
 	mkdir -p $(TOP)/bits/sdcnode
 	cp $(TOP)/build/nodes/*/sdcnode-*.tgz $(TOP)/bits/sdcnode
 
-# Upload bits to stuff
+# Upload bits to $UPLOAD_LOCATION/...
 .PHONY: upload
 upload:
+	[[ -n "$(UPLOAD_LOCATION)" ]] || (echo "error: UPLOAD_LOCATION is not defined" >&2 ; exit 1)
 	./tools/upload-bits "$(BRANCH)" "" "$(TIMESTAMP)" $(UPLOAD_LOCATION)/sdcnode/$(HOST_IMAGE)
 
 .PHONY: dumpvar
diff --git a/README.md b/README.md
index 735b57b..82ee778 100644
--- a/README.md
+++ b/README.md
@@ -1,63 +1,100 @@
-<!--
-    This Source Code Form is subject to the terms of the Mozilla Public
-    License, v. 2.0. If a copy of the MPL was not distributed with this
-    file, You can obtain one at http://mozilla.org/MPL/2.0/.
--->
-
-<!--
-    Copyright (c) 2014, Joyent, Inc.
--->
+This repository is part of the Joyent Triton project. See the [contribution
+guidelines](https://github.com/joyent/triton/blob/master/CONTRIBUTING.md) --
+*Triton does not use GitHub PRs* -- and general documentation at the main
+[Triton project](https://github.com/joyent/triton) page.
 
 # sdcnode
 
-This repository is part of the Joyent SmartDataCenter project (SDC).  For
-contribution guidelines, issues, and general documentation, visit the main
-[SDC](http://github.com/joyent/sdc) project page.
+Custom SmartOS builds of Node.js for use by Triton and Manta components.
 
-SmartOS builds of Node for SDC.
+All Triton/Manta services should bundle their own node for independence (with
+the exception of node.js code that ships with the platform and use the
+platform's node build). These services need a node (and npm) build. They can
+either build it themselves or get a pre-built one. Having node/npm as a git
+submodule for every repo and re-building node/npm for every build of each
+service is crazy. Hence, we need a distro. This is it.
 
-All SmartDataCenter services should carry their own node with then for
-independence. (The exception is those that are part of the platform: for
-which using the platform node is fine.) These services need a node (and npm)
-build. They can either build it themselves or get a pre-built one. Having
-node/npm as a git submodule for every repo and re-building node/npm for every
-build of each service is crazy. Hence, we need a distro. This is it.
+## Building
 
+To build the sdcnodes for the matching image as the building machine:
 
-# Development
+    make all
 
-Building is only supported on smartos. Builds of "sdcnode" only target
-smartos.
+## CI
 
-To build all sdcnode distro configurations:
+Typically sdcnode builds for all targetted images are built for each commit
+via Joyent Engineering's internal Jenkins CI system. See
+<https://jenkins.joyent.us/view/sdcnode/> (internal access). They are published
+to <https://download.joyent.com/pub/build/sdcnode/> (public).
 
-    git clone git@github.com:joyent/sdcnode.git
-    make all
+## Build configurations
+
+[nodeconfigs.json](./nodeconfigs.json) specifies all the flavours of node that
+are built. There are configurations for a matrix of the following variables:
+
+- node.js version
+
+- origin image, e.g. [minimal-multiarch](https://docs.joyent.com/public-cloud/instances/infrastructure/images/smartos/minimal), which implies a pkgsrc generation and sometimes the `gcc` version used
+
+- "build tag" for different build/configuration paramters:
+
+    | Build Tag | Description |
+    | --------- | ----------- |
+    | gz        | Intended for services running in the global zone or those that cannot otherwise depend on any pkgsrc libs (which are not available in the global zone). |
+    | zone      | Intended for services running in a zone. It dynamically links to some pkgsrc libs in "/opt/local". |
+    | zone64    | Intended for node.js services that require a 64-bit build of node. |
+
+
+The requirement is that the set of sdcnode configurations built cover the
+usage by all current and maintained (for release-branches getting maintenance
+work) Triton and Manta components.
+
+Here are some commands to see a breakdown of current sdcnode configs:
+
+    # by build_tag
+    json -f nodeconfigs.json -a build_tag | sort | uniq -c | sort
+
+    # by version
+    json -f nodeconfigs.json -a version | sort | uniq -c | sort
+
+    # by image
+    json -f nodeconfigs.json -a image "// image" | sort | uniq -c | sort
+
+
+## Determining sdcnode usage by Triton and Manta
+
+Here is a *start* at commands to list current usage of sdcnode configs by
+Triton and Manta components.
 
-Before commiting/pushing run `make prepush` and, if possible, get a code
-review.
+1. Setup `jr` per <https://github.com/joyent/joyent-repos#jr>.
 
+2. Get and update a clone of all top-level Triton/Manta release repos:
 
-# Dev Notes
+    ```
+    mkdir release-repos
+    cd release-repos
+    jr clone -y -l release,triton
+    jr clone -y -l release,manta
+    jr up -c 5  # currently needed once to get submodules
+    ```
 
-The configuration for builds is controlled by "nodeconfig.json".  We are not
-currently using builds that statically link in openssl, but here is how you
-would do one:
+    If you already have those clones, you just need to do this to update:
 
-    {
-        "comment": "Statically links OpenSSL.",
-        "version": "v0.7.10",
-        "configure_flags": "--with-dtrace",
-        "build_tag": "simple"
-    },
+    ```
+    cd release-repos
+    jr up -c 5
+    ```
 
+3. List the used node.js versions:
 
-# Build configurations
+    ```
+    find . -name Makefile | grep -v deps/eng/Makefile \
+        | xargs grep NODE_PREBUILT_VERSION \
+        | awk -F '(:=|=|:)' '{print $1 " " $3}' \
+        | awk '{printf("%-10s %s\n", $2, $1)}' | sort
+    ```
 
-The authority is <https://github.com/joyent/sdcnode/blob/master/nodeconfigs.json>.
-Currently sdcnode only includes node build configurations required by
-core SmartDataCenter services.
+Note: Just listing the *versions* used isn't the full story. It would be good
+to list the full (version, image, build_tag) usage set so we could further
+trim the built sdcnode configs.
 
-||**Build Tag**||**Description**||
-||gz||Intended for services running in the global zone. Currently this statically links in OpenSSL and zlib, but the intention is to dynamically link with platform libs.||
-||zone||Intended for services running in a zone. It dynamically links to pkgsrc's OpenSSL and zlib in /opt/local.||
diff --git a/nodeconfigs.json b/nodeconfigs.json
index 49ea20e..517eff7 100644
--- a/nodeconfigs.json
+++ b/nodeconfigs.json
@@ -737,6 +737,7 @@
         "build_tag": "gz"
     },
     {
+        "// image": "sdc-smartos 1.6.3",
         "image": "fd2cc906-8938-11e3-beab-4359c665ac99",
         "comment": "For use by agents in the GZ. Statically link to OpenSSL and zlib *for now* until OS-1294/TOOLS-130.",
         "version": "v0.8.28",
-- 
2.21.0

