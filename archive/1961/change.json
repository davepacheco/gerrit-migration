{"project":"joyent/illumos-joyent","branch":"master","id":"I66f992fb40fa29149392c5c81e1ae091ddf84dbd","number":"1961","subject":"OS-6119 kfpu_t union kfpu_u memory consumption could be improved OS-6121 cleanup x86 .byte asm Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1961","commitMessage":"OS-6119 kfpu_t union kfpu_u memory consumption could be improved\nOS-6121 cleanup x86 .byte asm\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1494948535,"lastUpdated":1495124771,"open":false,"status":"MERGED","comments":[{"timestamp":1494948535,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1494948725,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1494967162,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(8 comments)"},{"timestamp":1494974574,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(3 comments)\n\nI\u0027ve fixed the other issues. I\u0027ll wait to see if there is any more feedback from Robert before uploading a new rev."},{"timestamp":1494978481,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(3 comments)\n\nIn general, I think this looks good. I guess the struct aliasing in the fpu union is kind of par for the course, I\u0027m not sure if we need to worry there or not."},{"timestamp":1495027834,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1495027854,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1495036172,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nPatrick had a good suggestion for simplifying the handling of FPU_CTX_FPU_REGS in float.s. I tested that and updated the CR."},{"timestamp":1495036205,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1495040549,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1495120019,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1495124065,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1495124690,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1495124758,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1495124771,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"6","revision":"66f992fb40fa29149392c5c81e1ae091ddf84dbd","parents":["718c1fe74ece33e1052bc917ddb2b5dc2d5dd582"],"ref":"refs/changes/61/1961/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495124758,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495040549,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495120019,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495124065,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1495124771,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":35,"deletions":-44},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-103},"patchSets":[{"number":"1","revision":"3fa8c42b277507974f57da73f630237489ecea58","parents":["d7b3c0f0f9f6c7bd9fbafc475db0d96a54372712"],"ref":"refs/changes/61/1961/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1494948535,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":31,"deletions":-33},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":127,"sizeDeletions":-92},{"number":"2","revision":"979b8b97f60d9847dec98a8632696ea4dd7c83fc","parents":["d7b3c0f0f9f6c7bd9fbafc475db0d96a54372712"],"ref":"refs/changes/61/1961/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1494948725,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","comments":[{"file":"usr/src/uts/i86pc/os/fpu_subr.c","line":179,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I have mixed feelings about this kmem_cache receiving a different name based on fp_save_mech, despite the fact that only the one variable name is used."},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","line":179,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I actually think it is useful for kstat handling to know what you are dealing with, especially since they have different chunk sizes and alignments."},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","line":179,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yeah, I think it\u0027s useful to have them use different kmem cache names, given that different things are going on."},{"file":"usr/src/uts/intel/ia32/ml/exception.s","line":669,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we get a comment explaining what this is used for now and why the nops were replaced with this? The same is true for most of the other call sites changed in this file."},{"file":"usr/src/uts/intel/ia32/ml/exception.s","line":669,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I added a comment but I don\u0027t think I need to say anything about the nops. I just added those on the previous xsave commit from the other day to account for the mov instruction, which is now moved to be common, but since that was so recent, it doesn\u0027t seem worth cluttering the code with a comment."},{"file":"usr/src/uts/intel/ia32/ml/exception.s","line":669,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I wasn\u0027t very clear. I was more so just looking for an explanation for the nops here, which you provided. The updated comments on what the dereference is for is helpful. Thanks."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":251,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Nuke trailing spaces?"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":261,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why not a \u0027nop\u0027 rather than the unnecessary prefix?"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":261,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I kept the exact byte sequence we had originally, but I can change this."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":339,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"trailing spaces"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":378,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is the FPU_CTX_FPU_REGS offset such that this needs to be two instructions rather than just one \u0027movl\u0027?  (same goes for the above cases, I guess)"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":378,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Not at this time, but if that ever changes then this might be hard to track down. This is why we normally use the genassym constants."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":378,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we\u0027re really worried, then we can do what others bits of code do and make the instruction present on an #ifdef as in exception.s +735. I\u0027m not sure if it\u0027s worth it or not."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":396,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"trailing spaces"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":403,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"trailing spaces"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":463,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"trailing spaces"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":31,"deletions":-33},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":127,"sizeDeletions":-92},{"number":"3","revision":"37e3b099431d51b47d02b03dd80b35155b3b36ea","parents":["d7b3c0f0f9f6c7bd9fbafc475db0d96a54372712"],"ref":"refs/changes/61/1961/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495027854,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":42,"deletions":-40},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":138,"sizeDeletions":-99},{"number":"4","revision":"f7c16efd711db18451983a765b05a96ecf429494","parents":["d7b3c0f0f9f6c7bd9fbafc475db0d96a54372712"],"ref":"refs/changes/61/1961/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495036205,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495040549,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495120019,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495124065,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":35,"deletions":-44},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-103},{"number":"5","revision":"7a80fbd73867899a420d38f24a9b651a444d3c6f","parents":["718c1fe74ece33e1052bc917ddb2b5dc2d5dd582"],"ref":"refs/changes/61/1961/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495124690,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495040549,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495120019,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495124065,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":35,"deletions":-44},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-103},{"number":"6","revision":"66f992fb40fa29149392c5c81e1ae091ddf84dbd","parents":["718c1fe74ece33e1052bc917ddb2b5dc2d5dd582"],"ref":"refs/changes/61/1961/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495124758,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495040549,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1495124771,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495120019,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495124065,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":27,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":3,"deletions":-9},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":35,"deletions":-44},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":56,"deletions":-39},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-103}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}