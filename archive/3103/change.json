{"project":"joyent/sdc-vmapi","branch":"master","id":"I6cc90e2ccb949bfafd34fb4272acb54ed1e910ff","number":"3103","subject":"ZAPI-816 vmapi should pre provision nics ZAPI-765 Adding a fabric NIC to a VM doesn\u0027t provision a fabric NAT Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"url":"https://cr.joyent.us/3103","commitMessage":"ZAPI-816 vmapi should pre provision nics\nZAPI-765 Adding a fabric NIC to a VM doesn\u0027t provision a fabric NAT\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1513122875,"lastUpdated":1514566258,"open":false,"status":"MERGED","comments":[{"timestamp":1513122875,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 1."},{"timestamp":1513122905,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513187343,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1513192514,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(15 comments)"},{"timestamp":1513203944,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\n(20 comments)"},{"timestamp":1513204084,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 2."},{"timestamp":1513204113,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513205221,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1513315997,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 3."},{"timestamp":1513316004,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1513316027,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513362546,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(7 comments)\n\nSo, one thing that we don\u0027t necessarily need to do in this change, but we will need to do for the PUBAPI-1216 ticket at some point, is also provision the network pools ahead of the workflow for AddNics. Because we\u0027ll already know the CN when we go to do the AddNics, we\u0027ll be able to provide an accurate cn_uuid and nic_tags_available."},{"timestamp":1513614882,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1513614891,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 4."},{"timestamp":1513614920,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513619323,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(5 comments)"},{"timestamp":1513620688,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1513622302,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 4:\n\n(7 comments)"},{"timestamp":1513622312,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 5."},{"timestamp":1513622342,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513622596,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 6."},{"timestamp":1513622626,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513635190,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1513644800,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 7."},{"timestamp":1513644830,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513660595,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 8."},{"timestamp":1513660625,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513712362,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 8:\n\n(3 comments)"},{"timestamp":1513792138,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1513977138,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 9."},{"timestamp":1513977167,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513980209,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 9:\n\n(4 comments)"},{"timestamp":1513984515,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1514004239,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1514005012,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 10."},{"timestamp":1514005041,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514400506,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1514486620,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 10: Integration-Approval+1"},{"timestamp":1514566200,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 11: Commit message was updated."},{"timestamp":1514566258,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Michael Zeller"}],"currentPatchSet":{"number":"11","revision":"6cc90e2ccb949bfafd34fb4272acb54ed1e910ff","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/11","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514566200,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514005041,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1514400506,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1514486620,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1514566258,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":428,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":127,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":0,"deletions":-112},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":804,"sizeDeletions":-740},"patchSets":[{"number":"1","revision":"90612a3ff305c53b7563b6c15fd01b91a79f1665","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/1","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513122875,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513122905,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/vms.js","line":872,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Document"},{"file":"lib/endpoints/vms.js","line":872,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":875,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"info\""},{"file":"lib/endpoints/vms.js","line":875,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":888,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You can use common.validUUID() instead, which takes care of defining this."},{"file":"lib/endpoints/vms.js","line":888,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":895,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Put the return on its own line."},{"file":"lib/endpoints/vms.js","line":895,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":932,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This line is indented too far"},{"file":"lib/endpoints/vms.js","line":932,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":934,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s use VError.hasCauseWithName() instead."},{"file":"lib/endpoints/vms.js","line":934,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":935,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s wrap this in a verror."},{"file":"lib/endpoints/vms.js","line":935,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":956,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s wrap this with a verror. Something like:\n\n    callback(new VError(err2, \u0027Failed to find pool \"%s\"\u0027, netId));"},{"file":"lib/endpoints/vms.js","line":956,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":990,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Maybe use vasync.forEachPipeline() instead?"},{"file":"lib/endpoints/vms.js","line":990,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":997,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"should `netId` be asserted at this point? if it\u0027s not set will that break `getNetworkInfo` below?"},{"file":"lib/endpoints/vms.js","line":997,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1038,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t think there\u0027s a need to mention the ticket here."},{"file":"lib/endpoints/vms.js","line":1038,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Oops, missed this when I was cleaning stuff up."},{"file":"lib/endpoints/vms.js","line":1076,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"NICs\" here and below."},{"file":"lib/endpoints/vms.js","line":1076,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1100,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You can write this as:\n\n    return (filteredNetworks.pools.indexOf(net.ipv4_uuid) \u003d\u003d\u003d -1);"},{"file":"lib/endpoints/vms.js","line":1100,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1115,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This should be inst_uuid."},{"file":"lib/endpoints/vms.js","line":1115,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"We only have inst_uuid if the createVm payload is called with one, like in the case of Zookeeper instances.\n\nBefore it was \"job.params.uuid || job.params.vm_uuid\", and since this is out of workflow we no longer have the vm_uuid.  What should we do instead?"},{"file":"lib/endpoints/vms.js","line":1115,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If a UUID isn\u0027t specified by the caller, then we generate one in setDefaultValues():\n\nhttps://github.com/joyent/sdc-vmapi/blob/7962daae/lib/common/validation.js#L2410-L2412\n\nThis gets called by validateCreateVmParams() above, before this is run, so we\u0027ll know the UUID by the time this function is run."},{"file":"lib/endpoints/vms.js","line":1115,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1146,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"While we\u0027re moving this over, let\u0027s switch to using vasync.forEachPipeline()."},{"file":"lib/endpoints/vms.js","line":1146,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1194,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This function looks asynchronous but doesn\u0027t take a callback.  It should run the `deleteNic` operations in a vasync queue or vasync forEachParallel"},{"file":"lib/endpoints/vms.js","line":1194,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I already have this change but didn\u0027t push it yet :)"},{"file":"lib/workflows/job-common.js","line":559,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"update"},{"file":"lib/workflows/job-common.js","line":559,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/workflows/job-common.js","line":586,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should keep the bunyan log of the nicTagReqs, and should pass a second argument to print out in the workflow summary. Something like \"NIC Tag requirements retrieved\" would be fine."},{"file":"lib/workflows/job-common.js","line":586,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/workflows/job-common.js","line":787,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should remove the nics.push() from updateExistingNics(), and make this:\n\n    var nics \u003d filteredNetworks.nics.slice();\n\nThat way, if we fail to provision a NIC on a network pool and end the async.series() below before getting to updateExistingNics(), we\u0027ll still clean up the already provisioned NICs."},{"file":"lib/workflows/job-common.js","line":787,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"This makes sense.  Fixed"},{"file":"server.js","line":103,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should pass the cueball agent instantiated above here."},{"file":"server.js","line":103,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Thanks for catching that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":317,"deletions":-11},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":117,"deletions":-188},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":444,"sizeDeletions":-539},{"number":"2","revision":"86b07e9d5b7f0c950b5c4bfe3cc6a489c8d16d87","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/2","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513204084,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513204113,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/workflows/job-common.js","line":899,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This can just be callback."},{"file":"lib/workflows/job-common.js","line":899,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":347,"deletions":-13},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":120,"deletions":-189},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":477,"sizeDeletions":-542},{"number":"3","revision":"713cc837a3c8a1b34e207ef3e70af88e3319124f","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/3","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513315997,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513316027,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/vms.js","line":743,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s make creationArgs an argument of doAddNics() and pass it above."},{"file":"lib/endpoints/vms.js","line":743,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":919,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should add a name so that the error message is a bit more informative:\n\n    assert.uuid(owner_uuid, \u0027owner_uuid\u0027);"},{"file":"lib/endpoints/vms.js","line":919,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1050,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t think it\u0027s necessary to mention the ticket here."},{"file":"lib/endpoints/vms.js","line":1050,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1058,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Add to this part that when and if the server selection  logic is moved out of the workflow we\u0027ll be able to handle network pools here, too."},{"file":"lib/endpoints/vms.js","line":1058,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1085,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Add a comment before here that once the server selection logic is moved out of the workflow we can use the real CN UUID."},{"file":"lib/endpoints/vms.js","line":1085,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1178,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can you make this \"(nics.length \u003d\u003d\u003d 0)\" instead?"},{"file":"lib/endpoints/vms.js","line":1178,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/workflows/job-common.js","line":875,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t think we need any of this since we\u0027ll have already set these properties during the initial NIC provision. We just need to make sure that the cn_uuid gets updated now that it\u0027s known."},{"file":"lib/workflows/job-common.js","line":875,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":380,"deletions":-22},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":157,"deletions":-239},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":7,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":563,"sizeDeletions":-602},{"number":"4","revision":"09d5aeecad8b2954a050d7020ceed1d58763029b","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/4","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513614891,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513614920,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/vms.js","line":1040,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Because of the `return` statement above you don\u0027t need this `else` section.  It can be removed along with a level of indentation.  This also can apply to line 1024 if a return statement is added in the `if` block."},{"file":"lib/endpoints/vms.js","line":1040,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1044,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t know if we want this here. Since this is the same path taken for adding NICs, won\u0027t this cause us to make all newly added NICs the primary? We may want to move this into a separate function, and place it elsewhere in the restify chain for provisions."},{"file":"lib/endpoints/vms.js","line":1044,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"You\u0027re right.  That\u0027s bad, I will move it out into its own handler for the createVm path."},{"file":"lib/endpoints/vms.js","line":1071,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"selection"},{"file":"lib/endpoints/vms.js","line":1071,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1099,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Perhaps this would best be defined at the top of the file as a constant, like:\n\n var FAKE_NIC_UUID \u003d ...;"},{"file":"lib/endpoints/vms.js","line":1099,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If you do move it up, I would suggest FAKE_NIC_CN_UUID as the name."},{"file":"lib/endpoints/vms.js","line":1099,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I am going to leave it here since its only used once.  This way the comment gives better context around where its used and what needs to be changed once server selection is moved out of workflow."},{"file":"lib/endpoints/vms.js","line":1172,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"you don\u0027t need quotes around `func` or `inputs`."},{"file":"lib/endpoints/vms.js","line":1172,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1189,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"add second argument to this assert call\n\n assert.ok(napi, \u0027napi\u0027);"},{"file":"lib/endpoints/vms.js","line":1189,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1191,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"maybe add\n\n assert.arrayOf*(req.filteredNetworks.nics, \u0027req.filteredNetwork.nics\u0027);"},{"file":"lib/endpoints/vms.js","line":1191,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Sure, it just has to be added after we check if the array is length 0."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":399,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":125,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":572,"sizeDeletions":-609},{"number":"5","revision":"d6888d9b5c465e71b5aa4825c4652f7011a18787","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/5","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513622312,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513622342,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":413,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":125,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":586,"sizeDeletions":-609},{"number":"6","revision":"b46b5726d3654846653f4045b241e234cfa0afe7","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/6","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513622596,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513635190,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513622626,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":415,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":125,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":588,"sizeDeletions":-609},{"number":"7","revision":"f83c16a2564380a4eb27a5ede7764bbb220539f6","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/7","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513644800,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513644830,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":415,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":125,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":596,"sizeDeletions":-628},{"number":"8","revision":"00069ae07021d2ab90ebe3d48b62f6eca2c1ca28","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/8","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513660595,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513660625,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/vms.js","line":1068,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: you *could* use Array.prototype.some here to look for a primary nic.  The benefit here is it\u0027ll stop processing the array once one primary nic is found.  For example:\n\n\n var arr \u003d [0, 1, 2, 3, 4, 5];\n arr.some(function (e) { return e \u003e 1; })\n // \u003d\u003e true\n arr.some(function (e) { return e \u003e 10; })\n // \u003d\u003e false\n\n\nYou could do:\n\n\n var primaryFound \u003d networks.some(function (net) {\n     return net.primary;\n });"},{"file":"lib/endpoints/vms.js","line":1068,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1172,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"fix indent"},{"file":"lib/endpoints/vms.js","line":1172,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":1257,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: you can remove the quotes around arg and funcs"},{"file":"lib/endpoints/vms.js","line":1257,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/vms.full.test.js","line":601,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can we also check the message in these tests?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":422,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":125,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":0,"deletions":-112},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":90,"deletions":0}],"sizeInsertions":693,"sizeDeletions":-740},{"number":"9","revision":"8129f23f9b597a6968397589ca188678c60f0717","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/9","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513977138,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513977167,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/vms.full.test.js","line":972,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"What I don\u0027t like about this is that it\u0027s testing an error returned from napi.  However, there\u0027s really not a good way to verify that vmapi returns an error early for an IP that\u0027s in use without this test.  Thoughts?"},{"file":"test/vms.full.test.js","line":972,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We could just test the fields type/id/code/field, i suppose."},{"file":"test/vms.full.test.js","line":972,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I decided to make a duplicate of the body object and delete the message field before comparing."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":428,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":127,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":0,"deletions":-112},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":176,"deletions":0}],"sizeInsertions":788,"sizeDeletions":-740},{"number":"10","revision":"a9d1a9ab22ee2a9f90de293e267ffc7502653202","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/10","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514005012,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1514400506,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1514486620,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514005041,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":428,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":127,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":0,"deletions":-112},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":804,"sizeDeletions":-740},{"number":"11","revision":"6cc90e2ccb949bfafd34fb4272acb54ed1e910ff","parents":["7962daaede38296b95bdf6da54d87bab03c66347"],"ref":"refs/changes/03/3103/11","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514566200,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1514400506,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1514486620,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514005041,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1514566258,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/apis/napi.js","type":"DELETED","insertions":0,"deletions":-335},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":428,"deletions":-24},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":127,"deletions":-239},{"file":"server.js","type":"MODIFIED","insertions":7,"deletions":-5},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":0,"deletions":-112},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":804,"sizeDeletions":-740}],"allReviewers":[{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}]}