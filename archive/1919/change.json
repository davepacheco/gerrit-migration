{"project":"joyent/sdcadm","branch":"master","id":"I0c37c409d75476e7a91aad3978d9404bd3629308","number":"1919","subject":"TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/1919","commitMessage":"TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1494344480,"lastUpdated":1516125278,"open":false,"status":"MERGED","comments":[{"timestamp":1494344480,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1494344486,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 163031e8ea84f7f819e9a4245475b3af9fb4c577\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1494344518,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1494344544,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1494344549,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 9727240af3ebd16dd3eddbb64633d76e54a5f71a\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1494344586,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1494344751,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1494344757,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit dcded94275c05c21c13ec7e36e055b187a3ea934\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1494344784,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1494448710,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1494520193,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1494520198,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit d763ebc3b850b75f45581de8242bbfa09e65c1a4\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1494520225,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1494520243,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(6 comments)\n\nThanks for the review Trent! Pushed more changes for review."},{"timestamp":1494875132,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(5 comments)"},{"timestamp":1495132129,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1495132135,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 7e3567c804a800fc17ce99936241b2bab492726c\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1495132166,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1495207919,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1495207925,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 3d7e7c48ab5f244f2f5786c869495f06f7255d32\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1495207950,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1495462947,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1495462979,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1502791101,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1502791106,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit a40b5c47ce23516b62b14aa14c62e45ed4088fd8\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1502791133,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"},{"timestamp":1506955417,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 9: Patch Set 8 was rebased."},{"timestamp":1506955422,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 8613b828ac68c1318e819fb687aaa6fa51bc8e8a\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1506955459,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9:\n\n\"make check\" passed ok"},{"timestamp":1506985190,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1507041004,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 10: Patch Set 9 was rebased."},{"timestamp":1507041010,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 3007a1e94d361f4203f04b47810220f2fb6c5dca\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1507041044,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1507041045,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10:\n\n\"make check\" passed ok"},{"timestamp":1516044670,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 10:\n\n(3 comments)\n\nA couple of nits. Otherwise this looks good to me. I tested in COAL a bit (with a single and 3 binders) and it is working for me."},{"timestamp":1516117538,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 11."},{"timestamp":1516117543,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit fc76901e7cc04cc3a793a351a7b86b99ccdc4904\n    \n    TOOLS-1762 sdcadm update binder should determine instances to update before executing the update procedure"},{"timestamp":1516117571,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516117588,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11:\n\n(2 comments)\n\nDone, and reset the git dates to todays, btw."},{"timestamp":1516124644,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 11: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1516125259,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 12: Commit message was updated."},{"timestamp":1516125278,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"12","revision":"0c37c409d75476e7a91aad3978d9404bd3629308","parents":["04678262480337462b21f3a48949f4ddd906968d"],"ref":"refs/changes/19/1919/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516125259,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516117571,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516124644,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516124644,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1516125278,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-38},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":166,"deletions":-102}],"sizeInsertions":198,"sizeDeletions":-140},"patchSets":[{"number":"1","revision":"7f4a788d7215bff44848ae14a17eb93e4696d1f0","parents":["c9c32b576d8b031a9990b97fa0b305d478130f16"],"ref":"refs/changes/19/1919/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1494344480,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494344518,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":149,"deletions":-83}],"sizeInsertions":155,"sizeDeletions":-84},{"number":"2","revision":"97cb363b9b7f4569af2f7d363956e383d77c30d2","parents":["ed164c7b0ccf7c0c31442904b42169ab0b46c2a2"],"ref":"refs/changes/19/1919/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1494344544,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494344518,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":149,"deletions":-83}],"sizeInsertions":155,"sizeDeletions":-84},{"number":"3","revision":"a0e20a1a9da52c507e61a2e04f6a3624af1b8cea","parents":["ed164c7b0ccf7c0c31442904b42169ab0b46c2a2"],"ref":"refs/changes/19/1919/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1494344751,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494344784,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/index.js","line":563,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This should be calling `next` instead of `cb` ... and because this is in a `forEach`, it will call cb *twice* if there are two binder instances specified. E.g. this blows up:\n\n```\n[root@headnode0 (coal primary-hn) ~]# sdcadm up binder0@6c3296be-fd17-11e6-9270-bbd43d2f4f00 binder1@6c3296be-fd17-11e6-9270-bbd43d2f4f00\nUsing channel dev\n\n/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:182\n                        throw new mod_verror.VError(\u0027pipeline callback \u0027 +\n                              ^\nVError: pipeline callback invoked after the pipeline has already completed\n...\n```"},{"file":"lib/procedures/index.js","line":563,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not only here, but also on line #521. Good catch."},{"file":"lib/procedures/update-binder-v2.js","line":41,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Pedro, we talked briefly about handling multiple `self.changes` in chat. However, is there a case where that can ever happen currently?  You aren\u0027t allow to have two \"change\" objects to update a binder service. At least not from the CLI:\n\n```\n[root@headnode0 (coal primary-hn) ~]# sdcadm up binder@6c3296be-fd17-11e6-9270-bbd43d2f4f00 binder@6c3296be-fd17-11e6-9270-bbd43d2f4f00\nsdcadm up: error (Update): conflict: cannot make multiple changes to the same service: {\"type\":\"update-service\",\"service\":\"binder\"} and {\"type\":\"update-service\",\"service\":\"binder\"}\n```\n\nI wonder if instead of handling multiple `self.changes`, we could instead have the constructor assert that there is just one. Then save that to `this.change` (singular).\n\nThoughts?"},{"file":"lib/procedures/update-binder-v2.js","line":41,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Honestly, I don\u0027t think we\u0027re using the option for several changes anywhere. If I\u0027m not on a mistake, we create as many instances of each one of our classes as we need to, including instances of update simple service. At least for binder my take would be to move to \"this.change\" instead and also remove the vasync.forEachPipeline call from line #436. Let\u0027s give that a try and think about how the other classes are also used nowadays. Maybe it has sense to just simplify them"},{"file":"lib/procedures/update-binder-v2.js","line":41,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Were you going to do this (move to a single `this.change`)?"},{"file":"lib/procedures/update-binder-v2.js","line":41,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No, no for this issue. My idea is more regarding a global CR across all our procedures and make a call once we\u0027ve got a common pattern.\n\nIf I\u0027m not on a mistake, we\u0027re always having \"change[0]\" despite of the updates we\u0027re trying to perform, and nothing else. But that would require a deeper review and, of course, would affect to all the procedure files so I\u0027d say it\u0027s better to do in a separated change?"},{"file":"lib/procedures/update-binder-v2.js","line":58,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"on"},{"file":"lib/procedures/update-binder-v2.js","line":58,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-binder-v2.js","line":91,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"the"},{"file":"lib/procedures/update-binder-v2.js","line":91,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-binder-v2.js","line":125,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why do we not want to rely on the instances provided by the change? Is that because only a subset of the binder instances might have been specified in the change?  AFAICT that isn\u0027t allowed, at least from the CLI:\n\n```\n[root@headnode0 (coal primary-hn) ~]# sdcadm up binder0@6c3296be-fd17-11e6-9270-bbd43d2f4f00\nUsing channel dev\nsdcadm up: error (Usage): Individual update of binder instances is not allowed\n```\n\nOh, I see. It is because if some of the instances are already at the target image, then `change.insts` could be a subset.\n\nSuggestions:\n- document in the block comment on the *constructor* that UpdateBinderV2 can take (a) only a single `change` (see the note about about singular), (b) `change.insts` can be a subset of the services instances.\n- Update index.js to actually support updating just a particular binder instance via, e.g. `sdcadm up binder0` or `sdcadm up binder0 binder1`. This could be in a separate ticket.\n- Perhaps change this func and var names here to be about \"allInsts\" rather than \"binderVms\". It is the \"all\" part that is relevant.\n- Use sdcadm.listInsts to get all the binder instances instead of \"vmapi.listVms\". Then the \"inst.ip\" field is calculated for you. Note that you\u0027ll have to adjust usage of \"vm.uuid\" below to \"inst.zonename\"."},{"file":"lib/procedures/update-binder-v2.js","line":125,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"on"},{"file":"lib/procedures/update-binder-v2.js","line":125,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Honestly, the only reason to make these changes regarding updating only a subset of binder instances are due to the possibility to have a failed update in the middle of the update process, which would leave a subset of outdated instances.\n\nI don\u0027t think allowing individual binder updates is a good idea on any other scenario, due to the problems that might cause having two binder instances running different zookeeper versions. My take here would be to just re-run the update for the whole set of instances and just avoid updating the already up2date ones.\n\nI think that documenting this behavior would be fine enough. No need to provide support for what I\u0027d say is a risky procedure.\n\n- Will buy the \"allInsts\" variable name change and also the usage of sdcadm.listInsts."},{"file":"lib/procedures/update-binder-v2.js","line":132,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"If doing this, this should limit this to VMs owned by admin, at least."},{"file":"lib/procedures/update-binder-v2.js","line":132,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Moving to listInsts instead, as you suggested."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":149,"deletions":-87}],"sizeInsertions":155,"sizeDeletions":-88},{"number":"4","revision":"d6f07cf55b34b383459318ff953bb3d1ae5772d1","parents":["a3dd3a5ce6f748f48213dca2f8bff56e8d77065a"],"ref":"refs/changes/19/1919/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1494520193,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494520225,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/index.js","line":524,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Likewise, this does NOT fix the \"next called twice\" issue."},{"file":"lib/procedures/index.js","line":567,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Pedro, this doesn\u0027t fix the \"next called twice\" issue."},{"file":"lib/procedures/update-binder-v2.js","line":31,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"In an earlier comment I mentioned: \"Update index.js to actually support updating just a particular binder instance via, e.g. `sdcadm up binder0` or `sdcadm up binder0 binder1`. This could be in a separate ticket.\"\n\nI think it would be fine to eventually support updating a single binder instance. E.g., for canary updates: try a particular new binder image on a single instance to see if things blow up.\nAlso for testability: To be able to test updating a subset of binder instances in the case of an interrupted earlier update, we\u0027d need to update a subset of instances. It would be nice to be able to do that in the test suite by using \u0027sdcadm\u0027 itself to get to that state.\n\nHowever, it would be fine to defer this to another ticket."},{"file":"lib/procedures/update-binder-v2.js","line":36,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think the point to document is that `change.insts` is the set of binder insts to *update* and not necessarily the *complete set of binder instances* -- rather than documenting usage of particular functions like `sdcadm.listInsts`."},{"file":"lib/procedures/update-binder-v2.js","line":36,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-binder-v2.js","line":46,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be cleaner to have this just take a `options.change` (singular) and change the calling code in index.js to:\n\n- assert that there is only one change for the \"binder\" service\n- only pass in a single `change`\n\nThoughts?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":10,"deletions":-3},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":350,"deletions":-294}],"sizeInsertions":360,"sizeDeletions":-297},{"number":"5","revision":"21a5bd224669d2874ee1c666beeb006c01318c29","parents":["bd0dae728cda3a171494d2be37a5cbaf9111b57c"],"ref":"refs/changes/19/1919/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1495132129,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495132166,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-13},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":160,"deletions":-98}],"sizeInsertions":192,"sizeDeletions":-111},{"number":"6","revision":"343dbb84abc727537c25607ee1918972edf45509","parents":["dd8c649210773c2bb117c0f310bf9c21230f35b9"],"ref":"refs/changes/19/1919/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1495207919,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495132166,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-13},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":160,"deletions":-98}],"sizeInsertions":192,"sizeDeletions":-111},{"number":"7","revision":"60ae7cc73957071ccba29c79e531daf87df0cf36","parents":["1fef83708b266a3e5b340587478069ca859e26b6"],"ref":"refs/changes/19/1919/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1495462947,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495132166,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-13},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":160,"deletions":-98}],"sizeInsertions":192,"sizeDeletions":-111},{"number":"8","revision":"5983f956cead52b0e06120af9b4c6a62bf71aabe","parents":["003277077f0006fa698189f39c7f7d48ce4ea049"],"ref":"refs/changes/19/1919/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1502791101,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495132166,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-13},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":160,"deletions":-98}],"sizeInsertions":192,"sizeDeletions":-111},{"number":"9","revision":"e83990b3e7fdfe33175361096262df23400e11f4","parents":["d8cc1075bd81bb0189485bd0ec24c8f57faa9524"],"ref":"refs/changes/19/1919/9","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1506955417,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495132166,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-13},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":160,"deletions":-98}],"sizeInsertions":192,"sizeDeletions":-111},{"number":"10","revision":"5a18a53988f7c0b302b10a4a9e3b1680dd9d7141","parents":["23834ede8ba891c56f609e204bd414b971cc6ca9"],"ref":"refs/changes/19/1919/10","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1507041004,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495132166,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/index.js","line":562,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could consider using https://github.com/joyent/node-verror#verrorerrorfromlisterrors   but doesn\u0027t have to be in this CR. :)"},{"file":"lib/procedures/index.js","line":562,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Are you kidding me? I cannot hold until another issue in a change which basically means deleting code!"},{"file":"lib/procedures/update-binder-v2.js","line":43,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Drop this \u0027\\n\u0027 because it results in an extra blank line:\n\n```\nThis update will make the following changes:\n    download 1 image (105 MiB):\n        image 8d97b188-9d92-11e7-8c45-b76cc44484f0\n            (manta-nameservice@master-20170919T232319Z-gb136622)\n    update instance \"e58e2bb2-fd4a-4891-943b-b8956441c9bf\" (binder0)\n    of service \"binder\" to image 8d97b188-9d92-11e7-8c45-b76cc44484f0\n\n        (manta-nameservice@master-20170919T232319Z-gb136622)\n\nWould you like to continue? [y/N]\n```"},{"file":"lib/procedures/update-binder-v2.js","line":43,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: should have four space indent (via `common.indent` I guess) here"},{"file":"lib/procedures/update-binder-v2.js","line":43,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Do you mean like this?:\n\nUsing channel dev\n\n```\nThis update will make the following changes:\n    download 1 image (105 MiB):\n        image 8d97b188-9d92-11e7-8c45-b76cc44484f0\n            (manta-nameservice@master-20170919T232319Z-gb136622)\n    update instance \"84d048da-d3f9-44ff-b334-e7f6b430fdc1\" (binder0)\n        of service \"binder\" to image 8d97b188-9d92-11e7-8c45-b76cc44484f0\n            (manta-nameservice@master-20170919T232319Z-gb136622)\n```"},{"file":"lib/procedures/update-binder-v2.js","line":87,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"wow, you\u0027d had a unicode NO-BREAK-SPACE in there\n\n```\nU+00A0\t \t\\xc2\\xa0\t\u0026#xA0;\t  \tNO-BREAK SPACE\n```\n\nAny idea how that happened?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-13},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":160,"deletions":-98}],"sizeInsertions":192,"sizeDeletions":-111},{"number":"11","revision":"bd803fe6701a25ccf025104b384756cdb6a5b4be","parents":["04678262480337462b21f3a48949f4ddd906968d"],"ref":"refs/changes/19/1919/11","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516117538,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516117571,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516124644,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516124644,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-38},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":166,"deletions":-102}],"sizeInsertions":198,"sizeDeletions":-140},{"number":"12","revision":"0c37c409d75476e7a91aad3978d9404bd3629308","parents":["04678262480337462b21f3a48949f4ddd906968d"],"ref":"refs/changes/19/1919/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516125259,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516117571,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516124644,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516124644,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1516125278,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":32,"deletions":-38},{"file":"lib/procedures/update-binder-v2.js","type":"MODIFIED","insertions":166,"deletions":-102}],"sizeInsertions":198,"sizeDeletions":-140}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}