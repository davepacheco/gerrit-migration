From 17f6b68505f587964cc4c96a302297a754a20789 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Fri, 29 Sep 2017 01:07:49 +0000
Subject: [PATCH] MANTA-3426 Want tool to show shard information on object
 prior to it existing

---
 lib/moray.js | 48 ++++++++++++++++++++++++++++++++++++++++++++++++
 package.json |  2 +-
 2 files changed, 49 insertions(+), 1 deletion(-)

diff --git a/lib/moray.js b/lib/moray.js
index fe8050c..6f1d1f2 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -793,6 +793,54 @@ Moray.prototype.getMetadata = function getMetadata(options, callback) {
 };
 
 
+Moray.prototype.getShard = function getShard(options, callback) {
+    assert.object(options, 'options');
+    assert.string(options.key, 'options.key');
+    assert.string(options.requestId, 'options.requestId');
+    assert.func(callback, 'callback');
+
+    if (!this.client) {
+        setImmediate(function () {
+            callback(new Error('not connected'));
+        });
+        return;
+    }
+
+    var client = this.client;
+    var key = options.key;
+    var log = this.log;
+    var opts = {
+        req_id: options.requestId,
+        noCache: true
+    };
+
+    log.debug({
+        key: key,
+        requestId: opts.requestId,
+        headers: opts.headers
+    }, 'Moray.getShard: entered');
+
+    client.getShard(BUCKET, key, opts, function (err, node) {
+        if (err) {
+            log.debug({
+                err: err,
+                key: key,
+                shard: node,
+                requestId: opts.requestId
+            }, 'Moray.getShard: error reading shard');
+            callback(err);
+        } else {
+            log.debug({
+                key: key,
+                pnode: node.pnode,
+                vnode: node.vnode,
+                requestId: opts.requestId
+            }, 'Moray.getShard done');
+            callback(null, node);
+        }
+    });
+};
+
 /*
  * Used by the multipart upload API, this function will fetch a
  * finalizing record from the special multipart upload bucket.
diff --git a/package.json b/package.json
index 624b6e3..9ce05f9 100644
--- a/package.json
+++ b/package.json
@@ -15,7 +15,7 @@
         "bunyan": "0.22.1",
         "jsprim": "^1.3.1",
         "lru-cache": "2.3.1",
-        "moray": "3.0.0",
+        "moray": "file:../node-moray",
         "once": "1.3.0",
         "restify": "2.6.3",
         "redis": "0.10.1",
-- 
2.21.0

