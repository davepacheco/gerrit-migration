commit a1984fc43a4a5f4ad8d50dc55eec1ea08bef3f2e (refs/changes/89/3289/3)
Author: Chris Burroughs <chris.burroughs@joyent.com>
Date:   2018-02-07T17:08:20-05:00 (1 year, 8 months ago)
    
    TOOLS-1957 sdcadm updateGzTools should limit the number of backups

diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 0adc4d8..b2cca67 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2017 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  */
 
 /*
@@ -1523,12 +1523,33 @@ SdcAdm.prototype.updateGzTools = function updateGzTools(options, callback) {
                 common.execFilePlus({argv: argv, log: self.log}, next);
             },
 
+            // keep a finite number cn_tools backups on the usb key
+            function removeOldCNToolsTarballs(_, next) {
+                var backupPath = '/usbkey/extra/joysetup/';
+                var tarballs = fs.readdirSync(backupPath).filter(
+                    function isCNTools(p) {
+                        return (p.startsWith('cn_tools.') &&
+                                p.endsWith('tar.gz') &&
+                                p !== 'cn_tools.tar.gz');
+                    });
+                tarballs.sort();
+                var toDelete = tarballs.slice(4);
+                if (toDelete.length) {
+                    progress('Removing old cn backups: ' + toDelete.join(', '));
+                    toDelete.forEach(function rmBall(fname) {
+                        fs.unlinkSync(path.join(backupPath, fname));
+                    });
+                }
+                next();
+            },
+
             function backupCNToolsFile(_, next) {
                 if (!fs.existsSync('/usbkey/extra/joysetup/cn_tools.tar.gz')) {
                     next();
                     return;
                 }
-                var cnToolsTimestamp = new Date().toISOString();
+                var cnToolsTimestamp = new Date().toISOString()
+                    .split('.')[0].replace(/[:.-]/g, '');
                 fs.rename('/usbkey/extra/joysetup/cn_tools.tar.gz',
                       '/usbkey/extra/joysetup/cn_tools.' + cnToolsTimestamp +
                       '.tar.gz', function (err) {
