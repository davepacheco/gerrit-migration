{"project":"joyent/manta-manatee","branch":"master","id":"I420f48b70e051c9ff17ab8e290220cabc8eb24c7","number":"2596","subject":"MANATEE-365 pg_dump backup does not work with PostgreSQL 9.6.3 Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"url":"https://cr.joyent.us/2596","commitMessage":"MANATEE-365 pg_dump backup does not work with PostgreSQL 9.6.3\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1505760779,"lastUpdated":1507828573,"open":false,"status":"MERGED","comments":[{"timestamp":1505760779,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Uploaded patch set 1."},{"timestamp":1505760782,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505926027,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1505926035,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1507250315,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1507253056,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1507254147,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nI think we want to make the resulting code as clean as possible and avoid depending on the PG version if we can.  If we can\u0027t, that\u0027s okay.  But I guess my thought is: if checkpoint_segments is important to specify in 9.2, then for whatever problem that\u0027s solving, how are we solving it with 9.6?"},{"timestamp":1507259730,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2:\n\n\u003e I think we want to make the resulting code as clean as possible and\n \u003e avoid depending on the PG version if we can.  If we can\u0027t, that\u0027s\n \u003e okay.  But I guess my thought is: if checkpoint_segments is\n \u003e important to specify in 9.2, then for whatever problem that\u0027s\n \u003e solving, how are we solving it with 9.6?\n\nwhen the setting was eliminated, it was replaced with max_wal_size; and the default max_wal_size is much larger than the old default\n\nNote that the default setting for max_wal_size is much higher than the default checkpoint_segments used to be, so adjusting it might no longer be necessary.\n\n \u003e I think we want to make the resulting code as clean as possible and\n \u003e avoid depending on the PG version if we can.  If we can\u0027t, that\u0027s\n \u003e okay.  But I guess my thought is: if checkpoint_segments is\n \u003e important to specify in 9.2, then for whatever problem that\u0027s\n \u003e solving, how are we solving it with 9.6?\n\nwhen checkpoint segments was replaced, it was replaced with max_wal_size. The default for max_wal_size is much larger than the default for checkpoint segments had been. See MANATEE-365 for the numbers."},{"timestamp":1507307126,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\n\u003e Note that the default setting for max_wal_size is much higher than\n \u003e the default checkpoint_segments used to be, so adjusting it might\n \u003e no longer be necessary.\n \u003e \n \u003e \u003e I think we want to make the resulting code as clean as possible\n \u003e and\n \u003e \u003e avoid depending on the PG version if we can.  If we can\u0027t, that\u0027s\n \u003e \u003e okay.  But I guess my thought is: if checkpoint_segments is\n \u003e \u003e important to specify in 9.2, then for whatever problem that\u0027s\n \u003e \u003e solving, how are we solving it with 9.6?\n \u003e \n \u003e when checkpoint segments was replaced, it was replaced with\n \u003e max_wal_size. The default for max_wal_size is much larger than the\n \u003e default for checkpoint segments had been. See MANATEE-365 for the\n \u003e numbers.\n\nThanks -- that makes sense.\n\nThe two things I\u0027m hesitant about are the parsing of the version output and the fact that manatee-sitter really owns the current postgres version, and I think it would be best to minimize the extent to which we depend on it elsewhere because all of that stuff needs to be reconsidered if/when we change it again, or if Manatee changes the version dynamically as part of an upgrade.  One way to address that might be to have Manatee deliver a separate postgresql.backup.conf file that we specify here, instead of defining the parameters here.  That way, Manatee still owns the PG-specific options, and we get the right one by virtue of Manatee managing the current symlinks.  But that all does seem like overkill for this change.\n\nWe should make sure this gets fixed for sdc-manatee as well.  (MANATEE-284 is the ticket for the duplication.)"},{"timestamp":1507655549,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1507747916,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1507747924,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1507748186,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1507828573,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Kordas"}],"currentPatchSet":{"number":"4","revision":"420f48b70e051c9ff17ab8e290220cabc8eb24c7","parents":["2bead11562b76d2fe322c49227a5cd12d4732f3e"],"ref":"refs/changes/96/2596/4","uploader":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"createdOn":1507748186,"author":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505760782,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507307126,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655549,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1507828573,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"pg_dump/pg_backup_common.sh","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"b99a0915f9224836d717aa5e860e8e1a48323b85","parents":["0141368bee1615b6a52b19319965702db200af98"],"ref":"refs/changes/96/2596/1","uploader":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"createdOn":1505760779,"author":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505760782,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"pg_dump/pg_backup_common.sh","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"2","revision":"588f06b362068cdb9bbee6f7ba14d525231bc644","parents":["204c3a304f834eefb0e1645e236669e8636ef89c"],"ref":"refs/changes/96/2596/2","uploader":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"createdOn":1505926027,"author":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507307126,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655549,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505760782,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"pg_dump/pg_backup_common.sh","line":115,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we just never provide checkpoint_segments?  Being just for a backup, I don\u0027t think we care about whether we checkpoint at all."},{"file":"pg_dump/pg_backup_common.sh","line":115,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"I was trying to be as conservative as possible with this change."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"pg_dump/pg_backup_common.sh","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"3","revision":"f8c773113b6d9cef51b0fef1e7536748b652baa4","parents":["2bead11562b76d2fe322c49227a5cd12d4732f3e"],"ref":"refs/changes/96/2596/3","uploader":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"createdOn":1507747916,"author":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507307126,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655549,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505760782,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"pg_dump/pg_backup_common.sh","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"4","revision":"420f48b70e051c9ff17ab8e290220cabc8eb24c7","parents":["2bead11562b76d2fe322c49227a5cd12d4732f3e"],"ref":"refs/changes/96/2596/4","uploader":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"createdOn":1507748186,"author":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507307126,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655549,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505760782,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1507828573,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"pg_dump/pg_backup_common.sh","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}]}