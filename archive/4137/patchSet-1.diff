From 7fa0dc015d1aa9986ea4ea78e73f418662cc890b Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Mon, 4 Jun 2018 22:44:07 +0000
Subject: [PATCH] joyent/node-cueball#140 CueBallConnectionPool#getStats()
 returns incorrect "totalConnections" value

---
 CHANGES.adoc | 4 ++++
 lib/pool.js  | 7 ++++++-
 package.json | 2 +-
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/CHANGES.adoc b/CHANGES.adoc
index 0b8d612..ba42b81 100644
--- a/CHANGES.adoc
+++ b/CHANGES.adoc
@@ -6,6 +6,10 @@ toc::[]
 
 ## v2.x
 
+### v2.5.2
+
+Fix bug in pool statistics gathering (#140).
+
 ### v2.5.1
 
 Urgent maintenance release: node-moray, a notable consumer, was broken
diff --git a/lib/pool.js b/lib/pool.js
index b6bd6e1..7d4206f 100644
--- a/lib/pool.js
+++ b/lib/pool.js
@@ -761,9 +761,14 @@ CueBallConnectionPool.prototype.getStats = function () {
 		counters[k] = self.p_counters[k];
 	});
 
+	var tconns = 0;
+	Object.keys(self.p_connections).forEach(function (k) {
+		tconns += self.p_connections[k].length;
+	});
+
 	var stats = {
 		'counters': counters,
-		'totalConnections': Object.keys(self.p_connections).length,
+		'totalConnections': tconns,
 		'idleConnections': self.p_idleq.length,
 		'pendingConnections': self.p_initq.length,
 		'waiterCount': self.p_waiters.length
diff --git a/package.json b/package.json
index 2dea6df..39d78f9 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "2.5.1",
+  "version": "2.5.2",
   "description": "manage a pool of connections to a multi-node service where nodes are listed in DNS",
   "main": "lib/index.js",
   "dependencies": {
-- 
2.21.0

