From cb8d56751be0f926caa2a900f72da81036a7b946 Mon Sep 17 00:00:00 2001
From: June Yi <june.yi@samsung.com>
Date: Thu, 20 Oct 2016 23:59:13 +0900
Subject: [PATCH] joyent/triton#187 setup script update for CoaL on Ubuntu KVM

---
 tools/coal-linux-kvm-setup | 42 +++++++++++++++++---------------------
 1 file changed, 19 insertions(+), 23 deletions(-)

diff --git a/tools/coal-linux-kvm-setup b/tools/coal-linux-kvm-setup
index 1572031..a4b4eb7 100755
--- a/tools/coal-linux-kvm-setup
+++ b/tools/coal-linux-kvm-setup
@@ -21,6 +21,7 @@
 # Joyent). This script has been tested on the following Linux distributions: 
 # * Fedora 23 
 #   * Install required packages: dnf install libvirt virt-manager
+# * Ubuntu 16.04
 #
 # If you have used this script on a distribution not listed above (and maybe modified it to 
 # get it to work) please add your distribution to the list and submit a pull request.
@@ -57,6 +58,15 @@ if [ ! -e "/dev/kvm" ]; then
     exit 1
 fi
 
+if [ -e "/usr/bin/qemu-kvm" ]; then
+    EMULATOR=/usr/bin/qemu-kvm
+elif [ -e "/usr/bin/kvm" ]; then
+    EMULATOR=/usr/bin/kvm
+else
+    echo "KVM cannot be found. Exiting."
+    exit 1
+fi
+
 NESTED_KVM_ENABLED=$(</sys/module/kvm_intel/parameters/nested)
 
 # TODO: Add support for AMD.
@@ -182,26 +192,28 @@ cat > ${VIRSH_DOMAIN_XML} << EOF
     </os>
     <clock sync="localtime"/>
     <devices>
-        <emulator>/usr/bin/qemu-kvm</emulator>
+        <emulator>${EMULATOR}</emulator>
         <disk type='file' device='disk'>
-            <driver name='qemu' type='raw' cache='none' io='native'/>
-            <source file='/var/lib/libvirt/images/sdc-headnode-usb.raw'/>
+            <driver name='qemu' type='qcow2' cache='none' io='native'/>
+            <source file='/var/lib/libvirt/images/sdc-headnode-usb.qcow2'/>
             <target dev='hda' bus='virtio' />
             <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>
         </disk>
         <disk type='file' device='disk'>
-            <driver name='qemu' type='raw' cache='none' io='native'/>
-            <source file='/var/lib/libvirt/images/sdc-headnode-zpool.raw'/>
+            <driver name='qemu' type='qcow2' cache='none' io='native'/>
+            <source file='/var/lib/libvirt/images/sdc-headnode-zpool.qcow2'/>
             <target dev='hdb' bus='virtio' />
             <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>
         </disk>
         <interface type='network'>
             <source network='${EXTERNAL_NAME}'/>
             <mac address='6a:9f:78:a7:0c:2f'/>
+            <model type='e1000'/>
         </interface>
         <interface type='network'>
             <source network='${ADMIN_NAME}'/>
             <mac address='3a:0d:fc:6f:ec:e7'/>
+            <model type='e1000'/>
         </interface>
         <!-- Serial ports are exposed in host OS as /dev/pts/* -->
         <serial type='pty'>
@@ -212,22 +224,6 @@ cat > ${VIRSH_DOMAIN_XML} << EOF
         </serial>
     <graphics type='vnc' port='-1' autoport='yes' keymap='en-us' />
   </devices>
-  <qemu:commandline>
-    <qemu:arg value='-set'/>
-    <qemu:arg value='device.virtio-disk0.scsi=off'/>
-  </qemu:commandline>
-  <qemu:commandline>
-    <qemu:arg value='-set'/>
-    <qemu:arg value='device.virtio-disk0.x-data-plane=on'/>
-   </qemu:commandline>
-  <qemu:commandline>
-    <qemu:arg value='-set'/>
-    <qemu:arg value='device.virtio-disk1.scsi=off'/>
-  </qemu:commandline>
-  <qemu:commandline>
-    <qemu:arg value='-set'/>
-    <qemu:arg value='device.virtio-disk1.x-data-plane=on'/>
-   </qemu:commandline>
 </domain>
 EOF
 
@@ -242,8 +238,8 @@ virsh net-start ${EXTERNAL_NAME}
 
 echo ""
 echo "Prepare the unpacked VMWare CoaL images:"
-echo " # cp 4gb.img /var/lib/libvirt/images/sdc-headnode-usb.raw"
-echo " # qemu-img convert -f vmdk zpool.vmdk -O raw /var/lib/libvirt/images/sdc-headnode-zpool.raw"
+echo " # qemu-img convert -f raw -O qcow2 4gb.img /var/lib/libvirt/images/sdc-headnode-usb.qcow2"
+echo " # qemu-img create -f qcow2 /var/lib/libvirt/images/sdc-headnode-zpool.qcow2 60G"
 echo ""
 echo "When using SELinux make sure the following options are configured:"
 echo " # setsebool -P virt_use_execmem 1"
-- 
2.21.0

