{"project":"joyent/electric-moray","branch":"master","id":"Ic8998df5ee19446b0bf808941b3901d2c8c9a670","number":"2924","subject":"MORAY-445 Update Electric Moray to node-fast v2 Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2924","commitMessage":"MORAY-445 Update Electric Moray to node-fast v2\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1510096353,"lastUpdated":1511229882,"open":false,"status":"MERGED","comments":[{"timestamp":1510096353,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1510096380,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510105240,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(7 comments)"},{"timestamp":1510194537,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1510194562,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510202699,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1510255560,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1510255584,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510268443,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Code-Review+1\n\nThis looks great to me, thanks for doing this! Can you add some testing notes to the ticket for integration approval?"},{"timestamp":1510363146,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(7 comments)\n\nI added the testing notes and also added some sample output from the monitor server."},{"timestamp":1510873204,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1511229873,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1511229882,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"}],"currentPatchSet":{"number":"4","revision":"c5128f07e3697a5845fb4a8b48c9bfd935848581","parents":["bfd1aa572e5a13ba13bbf15f96ab0a036a4945c7"],"ref":"refs/changes/24/2924/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1511229873,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510255584,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510268443,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510873204,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1511229882,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-15},{"file":"lib/server.js","type":"MODIFIED","insertions":469,"deletions":-133},{"file":"main.js","type":"MODIFIED","insertions":31,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":28,"deletions":0},{"file":"test/invalid-fast.test.js","type":"ADDED","insertions":409,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":964,"sizeDeletions":-165},"patchSets":[{"number":"1","revision":"146b2ddab2f4d5ff74bb7c2845e47a0b29bbef08","parents":["bfd1aa572e5a13ba13bbf15f96ab0a036a4945c7"],"ref":"refs/changes/24/2924/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510096353,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510096380,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":199,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"certain RPCs\""},{"file":"lib/server.js","line":199,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/server.js","line":211,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If the type is \"object\", we should also make sure that the value\u0027s not null."},{"file":"lib/server.js","line":211,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/server.js","line":228,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can we make these globals at the top of the file, and name them things like \"CB_ARGS_SCHEMA\" and \"GB_ARGS_SCHEMA\"?"},{"file":"lib/server.js","line":228,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/server.js","line":353,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"While we\u0027re here, can we rename all of the \"_err\" identifiers to instead be things like \"gErr\" or \"pErr\"?"},{"file":"lib/server.js","line":353,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/server.js","line":1244,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This can be turned into an InvocationError."},{"file":"lib/server.js","line":1244,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"main.js","line":104,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should also add a \u0027-k\u0027 option here to match Moray, and update the boot/setup.sh script to generate monitoring ports  from 3021-3024 for each of these, so that each electric-moray process can be monitored separately. We should also fix up the port parsing and options processing while we\u0027re at it (see MORAY-436 for how I did this in Moray)."},{"file":"main.js","line":104,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"tools/jsl.node.conf","line":131,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can you update lib/errors.js to remove the file read bits, and instead export the errors at the bottom like:\n\n    module.exports \u003d {\n        ReadOnlyError: ReadOnlyError,\n        InvocationError: InvocationError\n    };\n\nWe can then import them both at the top of lib/server.js, and remove these custom global additions from the checker."},{"file":"tools/jsl.node.conf","line":131,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":443,"deletions":-119},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/helper.js","type":"MODIFIED","insertions":28,"deletions":0},{"file":"test/invalid-fast.test.js","type":"ADDED","insertions":395,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":883,"sizeDeletions":-125},{"number":"2","revision":"436805dd074c0f00eb7289c8f2c84a3ae03b3306","parents":["bfd1aa572e5a13ba13bbf15f96ab0a036a4945c7"],"ref":"refs/changes/24/2924/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510194537,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510194562,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":77,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You can remove this bit now."},{"file":"lib/server.js","line":411,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This one should be a gErr."},{"file":"tools/jsl.node.conf","line":131,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You can just delete these lines entirely now."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"lib/server.js","type":"MODIFIED","insertions":469,"deletions":-133},{"file":"main.js","type":"MODIFIED","insertions":31,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":28,"deletions":0},{"file":"test/invalid-fast.test.js","type":"ADDED","insertions":409,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":966,"sizeDeletions":-160},{"number":"3","revision":"c8998df5ee19446b0bf808941b3901d2c8c9a670","parents":["bfd1aa572e5a13ba13bbf15f96ab0a036a4945c7"],"ref":"refs/changes/24/2924/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510255560,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510268443,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510873204,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510255584,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-15},{"file":"lib/server.js","type":"MODIFIED","insertions":469,"deletions":-133},{"file":"main.js","type":"MODIFIED","insertions":31,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":28,"deletions":0},{"file":"test/invalid-fast.test.js","type":"ADDED","insertions":409,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":964,"sizeDeletions":-165},{"number":"4","revision":"c5128f07e3697a5845fb4a8b48c9bfd935848581","parents":["bfd1aa572e5a13ba13bbf15f96ab0a036a4945c7"],"ref":"refs/changes/24/2924/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1511229873,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510268443,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510873204,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510255584,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1511229882,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-15},{"file":"lib/server.js","type":"MODIFIED","insertions":469,"deletions":-133},{"file":"main.js","type":"MODIFIED","insertions":31,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":28,"deletions":0},{"file":"test/invalid-fast.test.js","type":"ADDED","insertions":409,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":964,"sizeDeletions":-165}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}