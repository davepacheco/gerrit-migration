From 042f41c16acb24341aca6a7b702591f16cca17b9 Mon Sep 17 00:00:00 2001
From: Brian Bennett <brian.bennett@joyent.com>
Date: Wed, 3 Jan 2018 17:07:08 -0800
Subject: [PATCH] joyent/manta-thoth#167 thoth should be easier to use from the
 headnode

---
 bin/sdc-thoth-install    | 12 ++++++------
 bin/sdc-thoth-update     |  2 +-
 bin/sdc-thoth-update-all |  4 ++--
 3 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/bin/sdc-thoth-install b/bin/sdc-thoth-install
index 15858eb..fe68901 100755
--- a/bin/sdc-thoth-install
+++ b/bin/sdc-thoth-install
@@ -106,7 +106,7 @@ if [ ! -d $base ]; then
 	tarball=/var/tmp/thoth.$$.tar.gz
 	staged=/tmp/thoth.$$.tar.gz
 	echo "Downloading thoth ..."
-	curl -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
+	curl -# -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
 	echo "Downloading thoth to compute nodes ..."
 	sdc-oneachnode -a -g $staged -d /var/tmp 1>&2
 	echo "Installing thoth on compute nodes ..."
@@ -179,21 +179,21 @@ cat > "$runthoth" <<"EOF"
 # actually start uploading.
 #
 
-if [[ $LOGNAME == thoth ]]
+if [[ $LOGNAME == thoth ]]; then
     thoth_home=$HOME
 else
     thoth_home=$(getent passwd thoth | awk -F: '{print $6}')
 fi
 source "${thoth_home:?}/.bashrc"
 
-[[ -z $thoth_home ]]; then
+if [[ -z $thoth_home ]]; then
     printf 'Unable to find thoth $HOME.\n'
     printf 'Is thoth set up properly?\n'
     exit 1
 fi
 
 log=$(date +log/%Y/%m/%d/%H/%M/sdc-thoth.out)
-mkdir -p "${HOME}/$(dirname $log)
+mkdir -p "${HOME}/$(dirname $log)"
 sdc-thoth --dry-run > "$log"
 
 mlog="/${MANTA_USER}/stor/thoth/logs/${THOTH_UUID}/${log}"
@@ -202,7 +202,7 @@ mput -f "$log" "$mlog"
 EOF
 
 chmod +x $runthoth
-ln -s /opt/custom/thoth/bin/run-thoth ../home/thoth/run-thoth
+ln -s ../home/thoth/run-thoth /opt/custom/thoth/bin/run-thoth
 
 cat > $thothwrapper <<EOF
 #!/bin/bash
@@ -295,5 +295,5 @@ while ! chown -R $user $home ; do
 	sleep 1
 done
 
-echo "Done; edit ~/`basename $runthoth` as user $user to enable sdc-thoth"
+echo "Done; edit $runthoth as user $user to enable sdc-thoth"
 
diff --git a/bin/sdc-thoth-update b/bin/sdc-thoth-update
index 65273de..8dc3059 100755
--- a/bin/sdc-thoth-update
+++ b/bin/sdc-thoth-update
@@ -60,7 +60,7 @@ fi
 tarball=/var/tmp/thoth.$$.tar.gz
 staged=/tmp/thoth.$$.tar.gz
 echo "Downloading thoth update ..."
-curl -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
+curl -# -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
 echo "Updating thoth ..."
 cd / ; gzcat $staged | tar xf - ; rm $staged 1>&2
 echo "Done"
diff --git a/bin/sdc-thoth-update-all b/bin/sdc-thoth-update-all
index 415f639..7aaed1b 100755
--- a/bin/sdc-thoth-update-all
+++ b/bin/sdc-thoth-update-all
@@ -67,12 +67,12 @@ fi
 tarball=/var/tmp/thoth.$$.tar.gz
 staged=/tmp/thoth.$$.tar.gz
 echo "Downloading thoth ..."
-curl -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
+curl -# -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
 echo "Downloading thoth to compute nodes ..."
 sdc-oneachnode -a -g $staged -d /var/tmp 1>&2
 echo "Installing thoth on compute nodes ..."
 sdc-oneachnode -a "cd / ; gzcat $tarball | tar xf - ; rm $tarball" 1>&2
-sdc-oneachnode -c -gX /opt/custom/thoth/bin/thoth -d /opt/custom/thoth/bin/
+sdc-oneachnode -c -Xg /opt/custom/thoth/bin/thoth -d /opt/custom/thoth/bin/
 sdc-oneachnode -a 'chmod +x /opt/custom/thoth/bin/thoth'
 rm $staged
 echo "Done"
-- 
2.21.0

