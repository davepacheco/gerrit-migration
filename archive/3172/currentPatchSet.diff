commit 904809fc760e47918f88cd9d48b08dda5d0ee123
Author: Robert Mustacchi <rm@joyent.com>
Date:   2018-02-28T16:05:04-06:00 (1 year, 7 months ago)
    
    librefhash

diff --git a/.gitignore b/.gitignore
index db479b360e..96c336ef0b 100644
--- a/.gitignore
+++ b/.gitignore
@@ -3940,6 +3940,10 @@ usr/src/lib/librcm/i386/lint.out
 usr/src/lib/librcm/i386/llib-lrcm.ln
 usr/src/lib/librdc/i386/lint.out
 usr/src/lib/librdc/i386/llib-lrdc.ln
+usr/src/lib/librefhash/amd64/lint.out
+usr/src/lib/librefhash/amd64/llib-lrefhash.ln
+usr/src/lib/librefhash/i386/lint.out
+usr/src/lib/librefhash/i386/llib-lrefhash.ln
 usr/src/lib/libreparse/amd64/lint.out
 usr/src/lib/libreparse/amd64/llib-lreparse.ln
 usr/src/lib/libreparse/i386/lint.out
diff --git a/manifest b/manifest
index e985ab93fd..ea070b9f02 100644
--- a/manifest
+++ b/manifest
@@ -4929,6 +4929,7 @@ f usr/lib/amd64/libraidcfg.so.1 0755 root bin
 s usr/lib/amd64/libraidcfg.so=libraidcfg.so.1
 s usr/lib/amd64/librcm.so.1=../../../lib/amd64/librcm.so.1
 s usr/lib/amd64/librcm.so=../../../lib/amd64/librcm.so.1
+f usr/lib/amd64/librefhash.so.1 0755 root bin
 f usr/lib/amd64/librename.so.1 0755 root bin
 f usr/lib/amd64/libreparse.so.1 0755 root bin
 s usr/lib/amd64/libreparse.so=libreparse.so.1
@@ -6369,6 +6370,7 @@ s usr/lib/librcm.so.1=../../lib/librcm.so.1
 s usr/lib/librcm.so=../../lib/librcm.so.1
 f usr/lib/librdc.so.1 0755 root bin
 s usr/lib/librdc.so=librdc.so.1
+f usr/lib/librefhash.so.1 0755 root bin
 f usr/lib/librename.so.1 0755 root bin
 f usr/lib/libreparse.so.1 0755 root bin
 s usr/lib/libreparse.so=libreparse.so.1
diff --git a/usr/src/uts/common/refhash/refhash.c b/usr/src/common/refhash/refhash.c
similarity index 87%
rename from usr/src/uts/common/refhash/refhash.c
rename to usr/src/common/refhash/refhash.c
index e2de00597e..02ba869ef9 100644
--- a/usr/src/uts/common/refhash/refhash.c
+++ b/usr/src/common/refhash/refhash.c
@@ -10,15 +10,28 @@
  */
 
 /*
- * Copyright 2015 Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 #include <sys/refhash.h>
-#include <sys/sysmacros.h>
 #include <sys/types.h>
-#include <sys/kmem.h>
 #include <sys/list.h>
+#include <sys/debug.h>
+
+#ifdef _KERNEL
+#include <sys/sysmacros.h>
 #include <sys/ddi.h>
+#include <sys/kmem.h>
+#define	REFHASH_ALLOC	kmem_alloc
+#define	REFHASH_ZALLOC	kmem_zalloc
+#define	REFHASH_FREE	kmem_free
+#else
+#include <stddef.h>
+#include <umem.h>
+#define	REFHASH_ALLOC	umem_alloc
+#define	REFHASH_ZALLOC	umem_zalloc
+#define	REFHASH_FREE	umem_free
+#endif
 
 #define	RHL_F_DEAD	0x01
 
@@ -43,12 +56,13 @@ refhash_create(uint_t bucket_count, refhash_hash_f hash,
 	refhash_t *hp;
 	uint_t i;
 
-	hp = kmem_alloc(sizeof (refhash_t), km_flags);
+	hp = REFHASH_ALLOC(sizeof (refhash_t), km_flags);
 	if (hp == NULL)
 		return (NULL);
-	hp->rh_buckets = kmem_zalloc(bucket_count * sizeof (list_t), km_flags);
+	hp->rh_buckets = REFHASH_ZALLOC(bucket_count * sizeof (list_t),
+	    km_flags);
 	if (hp->rh_buckets == NULL) {
-		kmem_free(hp, sizeof (refhash_t));
+		REFHASH_FREE(hp, sizeof (refhash_t));
 		return (NULL);
 	}
 	hp->rh_bucket_count = bucket_count;
@@ -75,8 +89,8 @@ refhash_destroy(refhash_t *hp)
 {
 	ASSERT(list_is_empty(&hp->rh_objs));
 
-	kmem_free(hp->rh_buckets, hp->rh_bucket_count * sizeof (list_t));
-	kmem_free(hp, sizeof (refhash_t));
+	REFHASH_FREE(hp->rh_buckets, hp->rh_bucket_count * sizeof (list_t));
+	REFHASH_FREE(hp, sizeof (refhash_t));
 }
 
 void
diff --git a/usr/src/lib/Makefile b/usr/src/lib/Makefile
index 7f82981d8c..16882c2141 100644
--- a/usr/src/lib/Makefile
+++ b/usr/src/lib/Makefile
@@ -187,6 +187,7 @@ SUBDIRS +=				\
 	libraidcfg	\
 	librcm		\
 	librdc		\
+	librefhash	\
 	librename	\
 	libreparse	\
 	libresolv	\
@@ -660,6 +661,7 @@ libprtdiag:	libkstat
 libprtdiag_psr:	libprtdiag
 libraidcfg:	libdevinfo
 librdc:		libnsctl libunistat libdscfg
+librefhash:	libumem
 librestart:	libuutil libscf libpool libproject libsecdb libsysevent
 libsasl:	libgss pkcs11
 libsaveargs:	libdisasm
diff --git a/usr/src/lib/librefhash/Makefile b/usr/src/lib/librefhash/Makefile
new file mode 100644
index 0000000000..5d9aabbc68
--- /dev/null
+++ b/usr/src/lib/librefhash/Makefile
@@ -0,0 +1,44 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright 2015 Joyent, Inc.
+#
+
+include ../Makefile.lib
+
+HDRDIR = common
+
+SUBDIRS = $(MACH) 
+$(BUILD64)SUBDIRS += $(MACH64)
+
+all := TARGET = all
+clean := TARGET = clean
+clobber := TARGET = clobber
+install := TARGET = install
+lint := TARGET = lint
+
+.KEEP_STATE:
+
+all clean clobber install lint: $(SUBDIRS)
+
+install: install_h $(SUBDIRS)
+
+install_h: $(ROOTHDRS)
+
+check: $(CHECKHDRS)
+
+$(SUBDIRS): FRC
+	@cd $@; pwd; $(MAKE) $(TARGET)
+
+FRC:
+
+include ../Makefile.targ
diff --git a/usr/src/lib/librefhash/Makefile.com b/usr/src/lib/librefhash/Makefile.com
new file mode 100644
index 0000000000..d602759947
--- /dev/null
+++ b/usr/src/lib/librefhash/Makefile.com
@@ -0,0 +1,47 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+#
+
+LIBRARY =	librefhash.a
+VERS =		.1
+OBJECTS =	list.o \
+		refhash.o
+HASHCOMDIR =	$(SRC)/common/refhash
+LISTCOMDIR =	$(SRC)/common/list
+
+include ../../Makefile.lib
+
+SRCDIR =	../common
+SRCS =		$(HASHCOMDIR)/refhash.c $(LISTCOMDIR)/list.c
+LIBS =		$(DYNLIB) $(LINTLIB)
+
+LDLIBS += 	-lc -lumem
+
+$(LINTLIB) := 	SRCS = $(SRCDIR)/$(LINTSRC)
+
+.KEEP_STATE:
+
+all: $(LIBS)
+
+lint: lintcheck
+
+include ../../Makefile.targ
+
+objs/%.o pics/%.o: $(LISTCOMDIR)/%.c
+	$(COMPILE.c) -o $@ $<
+	$(POST_PROCESS_O)
+
+objs/%.o pics/%.o: $(HASHCOMDIR)/%.c
+	$(COMPILE.c) -o $@ $<
+	$(POST_PROCESS_O)
diff --git a/usr/src/lib/librefhash/amd64/Makefile b/usr/src/lib/librefhash/amd64/Makefile
new file mode 100644
index 0000000000..15d904c616
--- /dev/null
+++ b/usr/src/lib/librefhash/amd64/Makefile
@@ -0,0 +1,19 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+#
+
+include ../Makefile.com
+include ../../Makefile.lib.64
+
+install: all $(ROOTLIBS64) $(ROOTLINKS64) $(ROOTLINT64)
diff --git a/usr/src/lib/librefhash/common/llib-lrefhash b/usr/src/lib/librefhash/common/llib-lrefhash
new file mode 100644
index 0000000000..fd0da128b7
--- /dev/null
+++ b/usr/src/lib/librefhash/common/llib-lrefhash
@@ -0,0 +1,19 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+ */
+
+/* LINTLIBRARY */
+/* PROTOLIB1 */
+
+#include <sys/refhash.h>
diff --git a/usr/src/lib/librefhash/common/mapfile-vers b/usr/src/lib/librefhash/common/mapfile-vers
new file mode 100644
index 0000000000..f7f91ef84f
--- /dev/null
+++ b/usr/src/lib/librefhash/common/mapfile-vers
@@ -0,0 +1,48 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+#
+
+#
+# MAPFILE HEADER START
+#
+# WARNING:  STOP NOW.  DO NOT MODIFY THIS FILE.
+# Object versioning must comply with the rules detailed in
+#
+#	usr/src/lib/README.mapfiles
+#
+# You should not be making modifications here until you've read the most current
+# copy of that file. If you need help, contact a gatekeeper for guidance.
+#
+# MAPFILE HEADER END
+#
+
+$mapfile_version 2
+
+SYMBOL_VERSION ILLUMOSprivate {
+    global:
+	refhash_create;
+	refhash_destroy;
+	refhash_insert;
+	refhash_remove;
+	refhash_lookup;
+	refhash_linear_search;
+	refhash_hold;
+	refhash_rele;
+	refhash_first;
+	refhash_next;
+	refhash_obj_valid;
+    local:
+        *;
+};
+
diff --git a/usr/src/lib/librefhash/i386/Makefile b/usr/src/lib/librefhash/i386/Makefile
new file mode 100644
index 0000000000..41e699e8f8
--- /dev/null
+++ b/usr/src/lib/librefhash/i386/Makefile
@@ -0,0 +1,18 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+#
+
+include ../Makefile.com
+
+install: all $(ROOTLIBS) $(ROOTLINKS) $(ROOTLINT)
diff --git a/usr/src/lib/librefhash/sparc/Makefile b/usr/src/lib/librefhash/sparc/Makefile
new file mode 100644
index 0000000000..41e699e8f8
--- /dev/null
+++ b/usr/src/lib/librefhash/sparc/Makefile
@@ -0,0 +1,18 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+#
+
+include ../Makefile.com
+
+install: all $(ROOTLIBS) $(ROOTLINKS) $(ROOTLINT)
diff --git a/usr/src/lib/librefhash/sparcv9/Makefile b/usr/src/lib/librefhash/sparcv9/Makefile
new file mode 100644
index 0000000000..15d904c616
--- /dev/null
+++ b/usr/src/lib/librefhash/sparcv9/Makefile
@@ -0,0 +1,19 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+#
+
+include ../Makefile.com
+include ../../Makefile.lib.64
+
+install: all $(ROOTLIBS64) $(ROOTLINKS64) $(ROOTLINT64)
diff --git a/usr/src/uts/common/Makefile.rules b/usr/src/uts/common/Makefile.rules
index ec7e26a82f..6350e309bb 100644
--- a/usr/src/uts/common/Makefile.rules
+++ b/usr/src/uts/common/Makefile.rules
@@ -1589,6 +1589,10 @@ $(OBJS_DIR)/%.o:		$(COMMONBASE)/nvpair/%.c
 	$(COMPILE.c) -o $@ $<
 	$(CTFCONVERT_O)
 
+$(OBJS_DIR)/%.o:		$(COMMONBASE)/refhash/%.c
+	$(COMPILE.c) -o $@ $<
+	$(CTFCONVERT_O)
+
 $(OBJS_DIR)/%.o:		$(UTSBASE)/common/os/%.c
 	$(COMPILE.c) -o $@ $<
 	$(CTFCONVERT_O)
@@ -1609,10 +1613,6 @@ $(OBJS_DIR)/%.o:		$(UTSBASE)/common/pcmcia/pcs/%.c
 	$(COMPILE.c) -o $@ $<
 	$(CTFCONVERT_O)
 
-$(OBJS_DIR)/%.o:		$(UTSBASE)/common/refhash/%.c
-	$(COMPILE.c) -o $@ $<
-	$(CTFCONVERT_O)
-
 $(OBJS_DIR)/%.o:		$(UTSBASE)/common/rpc/%.c
 	$(COMPILE.c) -o $@ $<
 	$(CTFCONVERT_O)
@@ -2777,6 +2777,9 @@ $(LINTS_DIR)/%.ln:		$(COMMONBASE)/net/dhcp/%.c
 $(LINTS_DIR)/%.ln:		$(COMMONBASE)/nvpair/%.c
 	@($(LHEAD) $(LINT.c) $< $(LTAIL))
 
+$(LINTS_DIR)/%.ln:		$(COMMONBASE)/refhash/%.c
+	@($(LHEAD) $(LINT.c) $< $(LTAIL))
+
 $(LINTS_DIR)/%.ln:		$(UTSBASE)/common/os/%.c
 	@($(LHEAD) $(LINT.c) $< $(LTAIL))
 
@@ -2795,9 +2798,6 @@ $(LINTS_DIR)/%.ln:		$(UTSBASE)/common/pcmcia/nexus/%.c
 $(LINTS_DIR)/%.ln:		$(UTSBASE)/common/pcmcia/pcs/%.c
 	@($(LHEAD) $(LINT.c) $< $(LTAIL))
 
-$(LINTS_DIR)/%.ln:		$(UTSBASE)/common/refhash/%.c
-	@($(LHEAD) $(LINT.c) $< $(LTAIL))
-
 $(LINTS_DIR)/%.ln:		$(UTSBASE)/common/rpc/%.c
 	@($(LHEAD) $(LINT.c) $< $(LTAIL))
 
diff --git a/usr/src/uts/common/sys/Makefile b/usr/src/uts/common/sys/Makefile
index 0d2076821f..e63ef6d777 100644
--- a/usr/src/uts/common/sys/Makefile
+++ b/usr/src/uts/common/sys/Makefile
@@ -496,6 +496,7 @@ CHKHDRS=			\
 	rctl_impl.h		\
 	rds.h			\
 	reboot.h		\
+	refhash.h		\
 	refstr.h		\
 	refstr_impl.h		\
 	resource.h		\
diff --git a/usr/src/uts/common/sys/refhash.h b/usr/src/uts/common/sys/refhash.h
index b7427a454d..469cb6d686 100644
--- a/usr/src/uts/common/sys/refhash.h
+++ b/usr/src/uts/common/sys/refhash.h
@@ -19,6 +19,10 @@
 #include <sys/types.h>
 #include <sys/list.h>
 
+#ifdef __cplusplus
+extern "C" {
+#endif
+
 #define	RHL_F_DEAD	0x01
 
 typedef struct refhash_link {
@@ -58,4 +62,8 @@ extern void *refhash_first(refhash_t *);
 extern void *refhash_next(refhash_t *, void *);
 extern boolean_t refhash_obj_valid(refhash_t *hp, const void *);
 
+#ifdef __cplusplus
+}
+#endif
+
 #endif	/* _SYS_REFHASH_H */
