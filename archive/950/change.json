{"project":"joyent/sdc-manta","branch":"master","id":"I9760f4af3f0ddd7ae6033360e4f04d69e27c05ab","number":"950","subject":"MANTA-2797 manta-adm could show human-readable image versions Reviewed by: Dave Pacheco \u003cdap@joyent.com\u003e Approved by: Dave Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/950","commitMessage":"MANTA-2797 manta-adm could show human-readable image versions\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1480002308,"lastUpdated":1483971020,"open":false,"status":"MERGED","comments":[{"timestamp":1480002308,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1480002362,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1480002489,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1480002533,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480005283,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(3 comments)\n\nI\u0027ve left some comments highlighting some of my uncertainties here, but otherwise I\u0027m happy this works as intended.\n\nThe result of this change is the option to add \"version\" to `manta-adm show`\u0027s \"-o\" flag to display a human friendly version string. The image list gathered by this change should also be usable for other parts of the code that would benefit from these versions (e.g. MANTA-2796).\n\nTo test this I\u0027ve deployed my changes to emy-14 and run various `manta-adm show` commands that would relate to images. See https://gist.github.com/chudley/0b1de998ac7863868a0aab6c6662d069 for some example output.\n\nThere are 3 things I haven\u0027t done.\n\n* Set the VERSION column to be a default in any `manta-adm show` output; it must be specifically asked for via the \"-o\" flag\n* Implemented Trent\u0027s caching advice from MANTA-2797. My understanding of the caching mechanism in node-triton is that a full (or at least large) image list is pulled at some point and stored in a local file. Because my implementation here reaches out to imgapi multiple times (as opposed to one large pull of images), I don\u0027t feel the work involved in keeping a cache updated is worth it. I like the idea and am open to discussion, though\n* Tested in a multi-AZ deployment. I would like to test this before integrated, but will require updating one of the stating AZs manta deployment zone temporarily\n\nThere is no test suite that I can find that covers manta-adm command line usage (test/tst.adm.js seems to be centred around generatePlan), so I\u0027m open to suggestions on more testing."},{"timestamp":1480456144,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(6 comments)\n\nNice!  This is going to be a real help for usability.  I have a few nits below, and some concern about the amount of data we request from imgapi.  It would be useful to see how this works in staging, especially in terms of performance.  Feel free to update staging to do that.  (You can also consider just creating a dev zone in staging on its \"manta\" and \"admin\" networks and running your bits from there.)\n\nI think you need to update the man page in docs/man/man1/manta-adm.md to add the new column.\n\nI would definitely update the default output to use \"version\" where it currently uses \"image\".  (That\u0027s probably in two places: the default output and the \"-s\" output.)\n\nIt would be great to have some tests for this, along with the rest of \"manta-adm show\", but there doesn\u0027t seem to be any framework for that yet.  We\u0027d probably want to do something similar to what tst.adm.js, which is to use a private API to load a custom view of the world and then verify that the rest of the code does what we expect.  That sounds like future work."},{"timestamp":1480475169,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1480504547,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1480504586,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480504702,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(4 comments)\n\nThanks, Dave; I hadn\u0027t considered spinning up a new zone in staging to test for this (I was going to reprovision the existing one). I\u0027ve created b890d18d-c99a-eebb-babd-c9b55cf9fac6 in staging-1 that currently has my changes (under /root/sdc-manta). staging-1 has ~700 manta images, and the performance feels fine to me. As mentioned in one of my comments, I\u0027d like to do some more thorough testing.\n\nI\u0027ve pushed changes to meet most of your individual comments, but there will be more to follow regarding the defaults and man page.\n\nThis work isn\u0027t considered a blue star (as far as I\u0027m aware), so I\u0027m happy to spend a bit of time on a test suite together."},{"timestamp":1480521192,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1480524396,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n\u003e  This means an operator can deactivate old images where appropriate, and we can possibly build tooling around helping the operator make these decisions (maybe even disable old images for them). That\u0027s what I was planning, but I haven\u0027t filed any tickets on this yet.\n\nI\u0027d suggest *deleting* old images (rather than just disabling them), if/when tooling is built to help the operator with this. \u0027sdcadm\u0027 really should be doing the same for Triton\u0027s images."},{"timestamp":1480691857,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\nI think test coverage is quite easily attainable by calling the 4 maAdm methods that do_show uses with various config objects. Those methods are:\n\n- dumpDeployedZonesByCn\n- dumpDeployedZonesByService\n- dumpDeployedConfigByServiceJson\n- dumpDeployedConfigByService\n\nI think I\u0027m going to try and make use of catest\u0027s \"*.out\" functionality here and just have the calls to the above methods in the test suite write to stdout. I\u0027ll need to be certain that the output is always going to be the same between runs, though."},{"timestamp":1481119303,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1481119451,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1481120436,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1481120482,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1481121562,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6."},{"timestamp":1481121625,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1481121880,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\nPS6 mostly includes changes to the test suite to work with image versions, as well as a new test (test/tst.adm_show.js) for `manta-adm show` functionality. Sorry for the spam of patch sets. \n\nThis new test is similar to test/tst.adm.js in that we generate a fake view of our Manta deployment, but it\u0027s not as complex because we don\u0027t need to make any changes to it once it\u0027s generated. It shares some code, so this has been moved to test/common.js. It also supports multiple AZs, but does not affect existing tests. \n\nI believe this test framework adequately covers the various output that `manta-adm show` can provide, but it does *not* cover CLI usage (such as violation of the assertions here: https://github.com/joyent/sdc-manta/blob/master/cmd/manta-adm.js#L271-L292). \n\nWith these changes the full test suite still completes cleanly. I am open to feedback on the new test coverage, as there is certainly room to expand it to include more edge cases. I believe I have used catests\u0027s *.out functionality correctly.\n\nLastly, jsstyle in this project is killing me in regards to tabs/spaces and line length. The test code it\u0027s the prettiest, but `make check` is just running `deps/jsstyle/jsstyle` with no config (default 8 spaces per tab), and I can see that new projects at least have a config file changing the tab definition to 4 spaces (e.g. https://github.com/joyent/node-triton/blob/master/tools/jsstyle.conf).\n\nWould you be against me adding a configuration file to this project? My concern is that it\u0027s not really related to this change as a whole."},{"timestamp":1481133688,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1\n\n(2 comments)\n\n\u003e PS6 mostly includes changes to the test suite to work with image\n \u003e versions, as well as a new test (test/tst.adm_show.js) for\n \u003e `manta-adm show` functionality. Sorry for the spam of patch sets.\n \u003e \n \u003e This new test is similar to test/tst.adm.js in that we generate a\n \u003e fake view of our Manta deployment, but it\u0027s not as complex because\n \u003e we don\u0027t need to make any changes to it once it\u0027s generated. It\n \u003e shares some code, so this has been moved to test/common.js. It also\n \u003e supports multiple AZs, but does not affect existing tests.\n \u003e \n \u003e I believe this test framework adequately covers the various output\n \u003e that `manta-adm show` can provide, but it does *not* cover CLI\n \u003e usage (such as violation of the assertions here: https://github.com/joyent/sdc-manta/blob/master/cmd/manta-adm.js#L271-L292).\n \u003e \n \u003e With these changes the full test suite still completes cleanly. I\n \u003e am open to feedback on the new test coverage, as there is certainly\n \u003e room to expand it to include more edge cases. I believe I have used\n \u003e catests\u0027s *.out functionality correctly.\n \n\nNice!  This is a great improvement.\n\nWhat do you think about replacing \"image\" with \"version\" in the default output?  Or did I miss that?\n\n\n \u003e Lastly, jsstyle in this project is killing me in regards to\n \u003e tabs/spaces and line length. The test code it\u0027s the prettiest, but\n \u003e `make check` is just running `deps/jsstyle/jsstyle` with no config\n \u003e (default 8 spaces per tab), and I can see that new projects at\n \u003e least have a config file changing the tab definition to 4 spaces\n \u003e (e.g. https://github.com/joyent/node-triton/blob/master/tools/jsstyle.conf).\n \u003e \n \u003e Would you be against me adding a configuration file to this\n \u003e project? My concern is that it\u0027s not really related to this change\n \u003e as a whole.\n\nI think most of the cases that jsstyle is complaining about are object literals.  I\u0027ve generally treated those as continuation lines and used 4-space indents there.  I expect jsstyle will be fine with that here.\n\n8-space hard tabs are still widely used, even for new repos.  Besides preferring them myself, I don\u0027t think it\u0027s worth switching to spaces (which would require re-styling this whole repo) or 4-space hard tabs (which are a little weird, and I don\u0027t think we use them anywhere else)."},{"timestamp":1483460885,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 7."},{"timestamp":1483460931,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483461705,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7:\n\n(1 comment)\n\nThanks for the feedback so far. I\u0027ve pushed a patch set that addresses the failed `make check` including revisions based on your feedback. `make prepush` is still clean after these changes. \n\n\u003e What do you think about replacing \"image\" with \"version\" in the default output?  Or did I miss that?\n\nSorry, I didn\u0027t comment on that for the last patch set (PS6). Here\u0027s an example of the output, where VERSION will be a default column.\n\n```\n[root@b890d18d-c99a-eebb-babd-c9b55cf9fac6 ~/sdc-manta]# ./bin/manta-adm show -s\nSERVICE          SH VERSION                                    COUNT\nauthcache         1 master-20161010T202610Z-g3b91a33               1\nelectric-moray    1 master-20161115T172110Z-g880a419               1\n...\n```\n\nWhen testing this change against staging-1 I\u0027m seeing some occasional terrible performance from the tool (upwards of 20s runtime), both with and without this change. In emy-14 I\u0027m seeing some minor increased runtime due to these changes, so there is some percentage of overhead to pulling down these images, but I\u0027d like to spend some time categorising this to ensure there\u0027s no serious performance degradation in this change."},{"timestamp":1483546362,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7:\n\nAs mentioned in a previous comment, I\u0027m not seeing any major performance hits with this change. The very long runtime in my previous comment appears to be due to LAB-144, which was an issue with binder, and not directly related to this change. \n\nI\u0027ve done a small amount of testing on the performance before/after this change in emy-14 (single node Manta, small number of images) and staging-1 (multi AZ Manta, ~700 images). The following results are the average runtime in seconds across 1000 runs of `manta-adm show -s`. Details on test below.\n\nemy-14\nbefore: 1.3596\nafter: 1.3458\n\nstaging-1\nbefore: 1.1821\nafter: 1.324\n\nstaging-1 showed a maximum runtime of 7.3 after this change (5.2 prior).\n\nThe following commands detail how these results were obtained. \n\n```\n# for i in $(seq 1 1000); do (/usr/bin/time ./build/node/bin/node ./bin/manta-adm show -s) 2\u003e\u00261 | grep real | awk \u0027{print $2}\u0027 \u003e\u003e /var/tmp/timing.out; done\n# wc -l /var/tmp/timing.out\n    1000 /var/tmp/timing.out\n# cat /var/tmp/timing.out | awk \u0027{SUM +\u003d $1; ROWS +\u003d 1} END {print SUM/ROWS}\u0027\n\u003cresult\u003e\n```\n\nThis is by no means a real benchmark, but I believe they serve the purpose of a high level check for major performance degradation. What this doesn\u0027t check for is additional strain on IMGAPI, but I\u0027m not certain how I could properly check for this. \n\nAt this point, so long as there are no concerns with the above tests, I\u0027d consider this CR ready for final review."},{"timestamp":1483633130,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1483633604,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 8."},{"timestamp":1483633632,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1483633648,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483633721,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 8: Code-Review+1 Integration-Approval+1\n\nThanks!"},{"timestamp":1483697197,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 9."},{"timestamp":1483697247,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483697386,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 9:\n\nAs discussed yesterday, a disclaimer has been added to warn against programmatic usage of `manta-adm` unless using subcommands with committed output. This was lifted nearly word for word from the `manatee-adm` man page (https://github.com/joyent/manatee/blob/master/docs/man/manatee-adm.md#description), which I believe reads well, and I\u0027ve included in this list all of the subcommands that have the \"-o\" argument.\n\nShould we also consider output using the \"-j\" option committed? For context, `manatee-adm history` has this option, but is *not* included in the man page as committed output.\n\nThe rendered markdown looks good, and checking the updated manual with `man` after running `make manpages` also looks good."},{"timestamp":1483719877,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 9: Code-Review+1 Integration-Approval+1\n\nYes, I think we can include \"manta-adm show\" output when used with \"-j\" as well."},{"timestamp":1483722844,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 10."},{"timestamp":1483722899,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483722962,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 10:\n\nAgreed. I\u0027ve added \"-j\" to the markdown docs and the man page."},{"timestamp":1483725390,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 10: Code-Review+1 Integration-Approval+1"},{"timestamp":1483970944,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 11: Commit message was updated."},{"timestamp":1483971020,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"11","revision":"9760f4af3f0ddd7ae6033360e4f04d69e27c05ab","parents":["c3a74d5742528a00460cd90853f05d041e9015ef"],"ref":"refs/changes/50/950/11","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1483970944,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483722899,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483725390,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483725390,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1483971019,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":169,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1081,"sizeDeletions":-117},"patchSets":[{"number":"1","revision":"3fe9565fb56a8f201d64a3d50b1d64e45e68cf35","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/50/950/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1480002308,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1480002362,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":100,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/adm.js","line":101,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":63,"deletions":-3}],"sizeInsertions":63,"sizeDeletions":-3},{"number":"2","revision":"7a7d5c3d54f99bbedb98c7398f7d0dc3c3d4b80b","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/50/950/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1480002489,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480002533,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":101,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Our Manta images are currently always on the master image channel, and so my understanding of the naming of our images means we\u0027ll not be longer than this. However, should channels make their way into Manta (e.g. \"release-...\"), this might be too short. \n\nThere might also be other reasons for a longer image version than I\u0027m aware of."},{"file":"lib/adm.js","line":101,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Although we only use \"master\" images today, we would like to get to working with \"release\" images in the future.  Based on the latest \"moray\" image on updates.joyent.com, a release build\u0027s version string looks like:\n\n    release-20140918-20140925T042127Z-g638fcf8\n\nwhich is 42 columns.  I\u0027d lean towards bumping it to 42 columns."},{"file":"lib/adm.js","line":101,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":566,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like this will fetch the versions of all images that have ever been imported for all Manta services.  For deployments that have been upgraded a bunch, couldn\u0027t that be considerably more than needed?  It seems like the size of these requests would grow without bound over time (although slowly).\n\nDoes this API handle pagination if there are a lot of images for a single service?\n\nIt would be interesting to see the performance difference, if any, of running this in staging compared to the existing version."},{"file":"lib/adm.js","line":566,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Just driving by (I haven\u0027t reviewed any of this code): Yes, node-sdc-clients/lib/imgapi.js#listImages *does* handle paging."},{"file":"lib/adm.js","line":566,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thanks for dropping by, Trent. I actually didn\u0027t realise this was the case and had opened MANTA-3015 a couple of days ago to possibly defer here. Checking out node-sdc-clients, though, it does look like pagination is handled for us. Thanks!\n\nDave, you\u0027re right on the growth. It\u0027s done this way so that we have context of all images available to Manta, not just the ones currently in use by deployed zones, to help with situations like MANTA-2796 where we need information on images that are not yet in use. \n\nTo ease this growth issue I\u0027ve added the \"state\" field to our params so that we only pull active images. This means an operator can deactivate old images where appropriate, and we can possibly build tooling around helping the operator make these decisions (maybe even disable old images for them). That\u0027s what I was planning, but I haven\u0027t filed any tickets on this yet.\n\nI\u0027ve not done extensive testing but there appears to be a difference in performance. I\u0027ve not done any significant profiling, but I\u0027ve seen it at most take 3 seconds before these changes and 4 seconds after. These appear to be outliers, where normal usage appears to be between 1 and 2 seconds, even on emy-14 prior to this change (23 images, staging-1 has ~700 Manta images).\n\nI noticed that I omitted the owner_uuid in these list parameters which would mean we\u0027d pull images from *every* user in the datacenter, where a user could create a custom image that matched our list parameters. I\u0027ve added the admin user to these parameters and it appears to have improved the performance here, but it\u0027s more likely that my tests aren\u0027t thorough enough. \n\nI\u0027m going to spend a bit of time getting some solid results around performance."},{"file":"lib/adm.js","line":566,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks for that context. It makes sense that we want to fetch information about both the current images and the latest images.  This approach seems reasonable.  As you say, if the image count got that large, maybe we need to make it easier (or even automated) the have the administrator clean those up."},{"file":"lib/adm.js","line":572,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This should probably be forEach().  It\u0027ll do the same thing, but \"map()\" builds a return value and implies that you\u0027re going to use it."},{"file":"lib/adm.js","line":572,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":579,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The caller passes a bunch of service ids, but I think this function ignores them and reconstructs the list here."},{"file":"lib/adm.js","line":579,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thanks for spotting this. I\u0027ve changed this to use the passed \"svcids\" in this case, which I feel is easier to follow."},{"file":"lib/adm.js","line":583,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"We pick the first error here because of what cmd/manta-adm expects: https://github.com/joyent/sdc-manta/blob/deb5a2a729c2bfeb896c6fd8ccc36f06ad309333/cmd/manta-adm.js#L313\n\nThe diff in gerrit looks confusing, but this is the same pattern as L542 in fetchCnInfo."},{"file":"lib/adm.js","line":583,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"For reference, the VError module has a MultiError class that\u0027s intended for this sort of thing.  It does essentially the same thing, but prepends the message with \"first of $N errors:\" so that the user knows that other things went wrong, too.  The existing code likely predates that becoming a documented interface.  Anyway, it\u0027s not important to use it here, but I figured I\u0027d mention it for future reference."},{"file":"lib/adm.js","line":1278,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"If somehow our image list from imgapi contains an image whose UUID is \"-\" (see L1275 on how \"image\" is set), we\u0027ll use that object. I\u0027m not sure if it\u0027s worth some more hardening here."},{"file":"lib/adm.js","line":1278,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Either way seems fine to me."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":63,"deletions":-3}],"sizeInsertions":63,"sizeDeletions":-3},{"number":"3","revision":"540c6b42f798fe79bbfb21310abd067be9b64239","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/50/950/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1480504547,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480504586,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":64,"deletions":-3}],"sizeInsertions":64,"sizeDeletions":-3},{"number":"4","revision":"61ee247c60bda7df5579837679877ba0f5ee80f6","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/50/950/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481119303,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1481119451,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/common.js","line":131,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":132,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":166,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":170,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":135,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":493,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":876,"sizeDeletions":-117},{"number":"5","revision":"4e88a16b8d769a54e53082cb43a3ea7be44b72e4","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/50/950/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481120436,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1481120482,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/common.js","line":131,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":132,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":166,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":170,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":135,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1057,"sizeDeletions":-117},{"number":"6","revision":"4c26b0e8d9b7b22c8a82cdb52ebf33da8ecf6b7b","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/50/950/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481121562,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481133688,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1481121625,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":100,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sorry I didn\u0027t notice this earlier, but the alignment here looks way off."},{"file":"lib/adm.js","line":100,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"test/common.js","line":93,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we just make this argument required and pass \"1\" in the other case?"},{"file":"test/common.js","line":93,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"test/common.js","line":131,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":132,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":166,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/common.js","line":168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"test/tst.adm_show.js","line":26,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t think you need to use a pipeline here since they\u0027re all synchronous, but it\u0027s not really a problem."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":170,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1054,"sizeDeletions":-117},{"number":"7","revision":"694ad754e211da04fa2f8465fa6b84272cf6f785","parents":["c3a74d5742528a00460cd90853f05d041e9015ef"],"ref":"refs/changes/50/950/7","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1483460885,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483460931,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":169,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1053,"sizeDeletions":-117},{"number":"8","revision":"a462e4ffb5a26202daa20e073544eac64e54f008","parents":["c3a74d5742528a00460cd90853f05d041e9015ef"],"ref":"refs/changes/50/950/8","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1483633604,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483633721,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483633721,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483633648,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":169,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1053,"sizeDeletions":-117},{"number":"9","revision":"c906111b9e0010d1c8bb39e2ca4409866d2723df","parents":["c3a74d5742528a00460cd90853f05d041e9015ef"],"ref":"refs/changes/50/950/9","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1483697197,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483719877,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483719877,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483697247,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":169,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1081,"sizeDeletions":-117},{"number":"10","revision":"4093bde8b9f200abfc0bf0652e520fff952c83ff","parents":["c3a74d5742528a00460cd90853f05d041e9015ef"],"ref":"refs/changes/50/950/10","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1483722844,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483725390,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483725390,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483722899,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":169,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1081,"sizeDeletions":-117},{"number":"11","revision":"9760f4af3f0ddd7ae6033360e4f04d69e27c05ab","parents":["c3a74d5742528a00460cd90853f05d041e9015ef"],"ref":"refs/changes/50/950/11","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1483970944,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483725390,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483725390,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483722899,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1483971019,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":14,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":67,"deletions":-4},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":19,"deletions":-1},{"file":"test/common.js","type":"MODIFIED","insertions":169,"deletions":-1},{"file":"test/tst.adm.js","type":"MODIFIED","insertions":3,"deletions":-110},{"file":"test/tst.adm_show.js","type":"ADDED","insertions":132,"deletions":0},{"file":"test/tst.adm_show.js.out","type":"ADDED","insertions":674,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1081,"sizeDeletions":-117}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}