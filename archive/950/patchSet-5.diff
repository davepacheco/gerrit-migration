From 4e88a16b8d769a54e53082cb43a3ea7be44b72e4 Mon Sep 17 00:00:00 2001
From: Richard Bradley <richard.bradley@joyent.com>
Date: Wed, 7 Dec 2016 14:18:53 +0000
Subject: [PATCH] MANTA-2797 manta-adm could show human-readable image versions

---
 docs/man/man1/manta-adm.md |   3 +-
 lib/adm.js                 |  71 +++-
 man/man1/manta-adm.1       |   4 +-
 test/common.js             | 171 +++++++++-
 test/tst.adm.js            | 113 +------
 test/tst.adm_show.js       | 135 ++++++++
 test/tst.adm_show.js.out   | 674 +++++++++++++++++++++++++++++++++++++
 test/tst.oneach_exec.js    |   2 +
 test/tst.zk.js             |   1 +
 9 files changed, 1057 insertions(+), 117 deletions(-)
 create mode 100644 test/tst.adm_show.js
 create mode 100644 test/tst.adm_show.js.out

diff --git a/docs/man/man1/manta-adm.md b/docs/man/man1/manta-adm.md
index e4207d0..346572c 100644
--- a/docs/man/man1/manta-adm.md
+++ b/docs/man/man1/manta-adm.md
@@ -283,6 +283,7 @@ Available fields for the `-o/--columns` option include:
 
 * `datacenter`: the name of the datacenter in which this zone is deployed
 * `image`: the uuid of the zone's image
+* `version`: the version of the zone's image
 * `primary_ip`: the primary IP address for this zone
 * `service`: the name of the service this zone is part of
 * `shard`: the metadata shard number for this zone.  This is only meaningful
@@ -299,7 +300,7 @@ Available fields for the `-o/--columns` option include:
 
 Note that the "count" field is only meaningful when `-s/--summarize` is
 specified.  The only other fields that are meaningful when `-s/--sumarize` is
-specified are "service", "image", and "shard".
+specified are "service", "image", "version", and "shard".
 
 Example: list all Manta zones in the current DC
 
diff --git a/lib/adm.js b/lib/adm.js
index 39aa96c..b687ead 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -95,6 +95,10 @@ var maColumns = {
     'indent': {
     	'label': '',
 	'width': 4
+    },
+    'version': {
+		'label': 'VERSION',
+		'width' : 42
     }
 };
 
@@ -271,6 +275,11 @@ function maAdm(log)
 	 */
 	this.ma_vms = null;
 
+	/*
+	 * IMGAPI image objects, indexed by image uuid.
+	 */
+	this.ma_images = null;
+
 	/*
 	 * Information about global zones, indexed by server_uuid.  This is
 	 * where we keep useful properties derived non-trivially from the CNAPI
@@ -394,6 +403,7 @@ maAdm.prototype.fetchDeployed = function (callback)
 
 	var self = this;
 	var cns = this.ma_cns = {};
+	this.ma_images = {};
 
 	vasync.pipeline({
 	    'funcs': [
@@ -487,6 +497,11 @@ maAdm.prototype.fetchDeployed = function (callback)
 			self.fetchCnInfo(Object.keys(cns), stepcb);
 		},
 
+		function fetchImagesInfo(_, stepcb) {
+			self.fetchImagesInfo(Object.keys(self.ma_services),
+			    stepcb);
+		},
+
 		function loadFini(_, stepcb) {
 			self.ma_log.info('loaded current deployed state');
 			self.loadCns();
@@ -530,6 +545,48 @@ maAdm.prototype.fetchCnInfo = function (cnids, callback)
 	});
 };
 
+/*
+ * [internal] Fetch image information for the given list of services (specified
+ * by service_uuids).
+ */
+maAdm.prototype.fetchImagesInfo = function (svcids, callback) {
+	var self = this;
+	var errors, queue, svc, params;
+	errors = [];
+	self.ma_log.info('fetching info for images');
+	queue = vasync.queue(function (svcid, subcallback) {
+		svc = self.ma_services[svcid];
+		params = {
+			'name': '~' + svc.name,
+			'state': 'active',
+			'tags.smartdc_service': 'true',
+			'owner_uuid': self.ma_app.owner_uuid
+		};
+		self.ma_log.trace({ 'service': svc.name },
+		    'fetching images for service');
+		self.ma_sdc.IMGAPI.listImages(params, function (err, uimgs) {
+			if (err) {
+				errors.push(new VError(err,
+				    'fetching images for service "%s"',
+				    svc.name));
+			} else if (uimgs.length) {
+				uimgs.forEach(function (img) {
+					self.ma_images[img.uuid] = img;
+				});
+			}
+			subcallback();
+		});
+	}, maMaxConcurrency);
+	queue.push(svcids);
+	queue.close();
+	queue.on('end', function () {
+		if (errors.length > 0)
+			callback(errors[0]);
+		else
+			callback();
+	});
+};
+
 /*
  * [for testing only] Load a fake set of results from the SAPI, VMAPI, and CNAPI
  * services queried by fetchDeployed().
@@ -541,6 +598,7 @@ maAdm.prototype.loadFakeDeployed = function (config)
 	this.ma_instances = config['instances'];
 	this.ma_vms = config['vms'];
 	this.ma_cns = config['cns'];
+	this.ma_images = config['images'];
 
 	this.loadCns();
 	this.loadInstances();
@@ -980,7 +1038,7 @@ maAdm.prototype.dumpDeployedConfigByService = function (sout, conf)
 		return (self.ma_services[s1]['name'].localeCompare(
 		    self.ma_services[s2]['name']));
 	});
-	colnames = conf.columns || [ 'service', 'shard', 'image', 'count' ];
+	colnames = conf.columns || [ 'service', 'shard', 'version', 'count' ];
 	columns = colnames.map(function (colname) {
 		colname = colname.toLowerCase();
 		return (maColumns[colname]);
@@ -1001,7 +1059,8 @@ maAdm.prototype.dumpDeployedConfigByService = function (sout, conf)
 			    'SERVICE': self.ma_services[svcid]['name'],
 			    'IMAGE': row['IMAGE'],
 			    'SH': row['SH'] || '-',
-			    'COUNT': row['count']
+			    'COUNT': row['count'],
+			    'VERSION': row['VERSION']
 			});
 		});
 	});
@@ -1193,9 +1252,10 @@ maAdm.prototype.loadInstances = function ()
 	assert.ok(this.ma_instances_flattened === null);
 	assert.ok(this.ma_config_bycn === null);
 	assert.ok(this.ma_config_bycfg === null);
+	assert.ok(this.ma_images !== null);
 
 	var services, rv, svcid, i, svcname, svckey;
-	var instance, metadata, server, gz, image, row, ip;
+	var instance, metadata, server, gz, image, row, ip, version;
 
 	services = this.ma_services;
 	rv = [];
@@ -1218,6 +1278,8 @@ maAdm.prototype.loadInstances = function ()
 			image = this.ma_vms.hasOwnProperty(instance['uuid']) ?
 			    this.ma_vms[instance['uuid']]['image_uuid'] : '-';
 			ip = this.primaryIpForZone(instance['uuid']) || '-';
+			version = this.ma_images.hasOwnProperty(image) ?
+			    this.ma_images[image]['version'] : '-';
 
 			if (gz && svcname == 'storage') {
 				gz['storage'] = true;
@@ -1243,7 +1305,8 @@ maAdm.prototype.loadInstances = function ()
 			    'PRIMARY IP': ip,
 			    'ZONEABBR': instance['uuid'].substr(0, 8),
 			    'IMAGE': image,
-			    'STORAGE ID': metadata['MANTA_STORAGE_ID'] || '-'
+			    'STORAGE ID': metadata['MANTA_STORAGE_ID'] || '-',
+			    'VERSION': version
 			};
 			rv.push(row);
 
diff --git a/man/man1/manta-adm.1 b/man/man1/manta-adm.1
index 978f165..6625aeb 100644
--- a/man/man1/manta-adm.1
+++ b/man/man1/manta-adm.1
@@ -297,6 +297,8 @@ Available fields for the \fB\fC\-o/\-\-columns\fR option include:
 .IP \(bu 2
 \fB\fCimage\fR: the uuid of the zone's image
 .IP \(bu 2
+\fB\fCversion\fR: the version of the zone's image
+.IP \(bu 2
 \fB\fCprimary_ip\fR: the primary IP address for this zone
 .IP \(bu 2
 \fB\fCservice\fR: the name of the service this zone is part of
@@ -322,7 +324,7 @@ deployed
 .PP
 Note that the "count" field is only meaningful when \fB\fC\-s/\-\-summarize\fR is
 specified.  The only other fields that are meaningful when \fB\fC\-s/\-\-sumarize\fR is
-specified are "service", "image", and "shard".
+specified are "service", "image", "version", and "shard".
 .PP
 Example: list all Manta zones in the current DC
 .PP
diff --git a/test/common.js b/test/common.js
index 9fff11b..b9aed5b 100644
--- a/test/common.js
+++ b/test/common.js
@@ -11,11 +11,12 @@
 /*
  * common.js: common code for various tests
  */
-
+var assertplus = require('assert-plus');
 var sdc = require('../lib/sdc');
 
 /* Public interface */
 exports.defaultCommandExecutorArgs = defaultCommandExecutorArgs;
+exports.generateFakeBase = generateFakeBase;
 
 function defaultCommandExecutorArgs()
 {
@@ -61,3 +62,171 @@ function defaultCommandExecutorArgs()
 	    'multilineMode': 'auto'
 	});
 }
+
+/*
+ * generateFakeBase is used to generate a fake vew of our Manta deployment for
+ * testing purposes.
+ *
+ * It takes a minimal JSON object of the "deployed" services as input and
+ * populates a data structure similar to what would be returned when running in
+ * a real datacenter. Usually these deployed services are gathered entirely by
+ * maAdm using real data from Triton's APIs, but lacking this information we
+ * generate data that is close to what Triton would give us.
+ *
+ * See test/tst.adm.js and test/tst.adm_show.js for examples of the input this
+ * function expects. This is the same as what `manta-adm show -js` would output
+ * in a functional datacenter. It is assumed that this object is the same for
+ * each additional datacenter that is requested.
+ *
+ * The output of this function is an object that can be passed to
+ * maAdm.loadFakeDeployed for use in our test suite.
+ *
+ * Multiple AZs are supported but optional to not interfere with existing test
+ * suites. azCount determines how many AZs are in the deployment, and only the
+ * first AZ will be populated with VMs, CNs, and Images. The lack of this
+ * information is what madm uses to determine if there are other AZs to report
+ * on (that is, any AZ that is not the AZ that we're currently running manta-adm
+ * from).
+ */
+function generateFakeBase(fakeDeployed, azCount) {
+	assertplus.object(fakeDeployed);
+	assertplus.optionalNumber(azCount);
+
+	var ids, svcids, fakeBase, azNum, cnid, azName, cnUuid, cnHostname,
+	    svcname, shardid, next, svcid, imgid;
+
+	if (!azCount) {
+		azCount = 1;
+	}
+
+	ids = {};
+	svcids = {};
+	fakeBase = {
+		'app': { 'name': 'manta' },
+		'services': { /* filled in below */ },
+		'instances': { /* filled in below */ },
+		'vms': { /* filled in below */ },
+		'cns': { /* filled in below */ },
+		'images': { /* filled in below */ }
+	};
+
+	for (azNum = 1; azNum <= azCount; azNum++) {
+		for (cnid in fakeDeployed) {
+			if (azCount > 1) {
+				azName = 'test-' + azNum.toString();
+				cnUuid = azName + '-' + cnid;
+			} else {
+				azName = 'test';
+				cnUuid = cnid;
+			}
+			cnHostname = cnUuid.toUpperCase();
+			if (azNum == 1) {
+				fakeBase['cns'][cnUuid] = {
+					'datacenter': azName,
+					'hostname': cnHostname,
+					'server_uuid': cnUuid,
+					'sysinfo': {
+						'Network Interfaces': {
+							'foo': {
+								'NIC Names': 'admin',
+								'ip4addr': cnUuid + '.example.com'
+							}
+						}
+					}
+				};
+				fakeBase['images'] = {
+					'img001': {
+						'version': 'master001'
+					},
+					'img002': {
+						'version': 'master002'
+					},
+					'img003': {
+						'version': 'master003'
+					}
+				};
+			}
+
+			for (svcname in fakeDeployed[cnid]) {
+				if (!svcids[svcname])
+					svcids[svcname] = nextId('service');
+				svcid = svcids[svcname];
+				next = fakeDeployed[cnid][svcname];
+
+				fakeBase['services'][svcid] = {
+					'name': svcname
+				};
+				if (svcname == 'postgres' ||
+				    svcname == 'moray') {
+					for (shardid in next) {
+						for (imgid in next[shardid]) {
+							populateVms({
+								'cnid': cnUuid,
+								'svcid': svcid,
+								'shardid': shardid,
+								'imgid': imgid,
+								'count': next[shardid][imgid],
+								'az': azName
+							}, (azNum == 1));
+						}
+					}
+				} else {
+					for (imgid in next) {
+						populateVms({
+							'cnid': cnUuid,
+							'svcid': svcid,
+							'shardid': 1,
+							'imgid': imgid,
+							'count': next[imgid],
+							'az': azName
+						}, (azNum == 1));
+					}
+				}
+			}
+		}
+	}
+
+	return (fakeBase);
+
+	function nextId(name)
+	{
+		var rv;
+
+		if (!ids[name])
+			ids[name] = 1;
+
+		rv = ids[name]++;
+		if (rv < 10)
+			return (name + '00' + rv);
+		if (rv < 100)
+			return (name + '0' + rv);
+		return (name + rv);
+	}
+
+	function populateVms(params, masterAz)
+	{
+		var i, id;
+		for (i = 0; i < params['count']; i++) {
+			id = nextId('instance');
+			if (!fakeBase['instances'][params['svcid']])
+				fakeBase['instances'][params['svcid']] = [];
+			fakeBase['instances'][params['svcid']].push({
+				'uuid': id,
+				'params': { 'server_uuid': params['cnid'] },
+				'metadata': {
+				'SHARD': params['shardid'],
+				'DATACENTER': params['az']
+				}
+			});
+			if (masterAz) {
+				fakeBase['vms'][id] = {
+					'image_uuid': params['imgid'],
+					'nics': [ {
+						'primary': true,
+						'ip4addr': '0.0.0.0'
+					} ]
+				};
+			}
+		}
+	}
+}
diff --git a/test/tst.adm.js b/test/tst.adm.js
index 677c1a6..1364331 100644
--- a/test/tst.adm.js
+++ b/test/tst.adm.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2016, Joyent, Inc.
  */
 
 /*
@@ -19,60 +19,16 @@ var vasync = require('vasync');
 var CollectorStream = require('./CollectorStream');
 var VError = require('verror').VError;
 
+var common = require('./common');
 var madm = require('../lib/adm');
 
-/*
- * Helper functions
- */
-
-var ids = {};
-function nextId(name)
-{
-	var rv;
-
-	if (!ids[name])
-		ids[name] = 1;
-
-	rv = ids[name]++;
-	if (rv < 10)
-		return (name + '00' + rv);
-	if (rv < 100)
-		return (name + '0' + rv);
-	return (name + rv);
-}
-
-function populateVms(params)
-{
-	var i, id;
-	for (i = 0; i < params['count']; i++) {
-		id = nextId('instance');
-		if (!fakeBase['instances'][params['svcid']])
-			fakeBase['instances'][params['svcid']] = [];
-		fakeBase['instances'][params['svcid']].push({
-		    'uuid': id,
-		    'params': { 'server_uuid': params['cnid'] },
-		    'metadata': {
-			'SHARD': params['shardid'],
-			'DATACENTER': 'test'
-		    }
-		});
-		fakeBase['vms'][id] = {
-		    'image_uuid': params['imgid'],
-		    'nics': [ {
-		        'primary': true,
-			'ip4addr': '0.0.0.0'
-		    } ]
-		};
-	}
-}
-
 function runTestCase(t, callback)
 {
 	var adm, collector, desired;
 
 	console.log('test case "%s"', t['name']);
 	adm = new madm.MantaAdm(log);
-	adm.loadFakeDeployed(fakeBase);
+	adm.loadFakeDeployed(common.generateFakeBase(fakeDeployed));
 	desired = jsprim.deepCopy(fakeDeployed);
 
 	/* Sanity-check that we created the fake config properly */
@@ -159,69 +115,6 @@ var fakeDeployed = {
     }
 };
 
-/*
- * Populate the detailed fake configuration by making up a bunch of instances to
- * go with the summary configuration defined above.
- */
-var fakeBase = {
-    'app': { 'name': 'manta' },
-    'services': { /* filled in below */ },
-    'instances': { /* filled in below */ },
-    'vms': { /* filled in below */ },
-    'cns': { /* filled in below */ }
-};
-
-var cnid, svcname, svcids, svcid, next, imgid, shardid;
-
-svcids = {};
-for (cnid in fakeDeployed) {
-	fakeBase['cns'][cnid] = {
-	    'datacenter': 'test',
-	    'hostname': cnid.toUpperCase(),
-	    'server_uuid': cnid,
-	    'sysinfo': {
-	        'Network Interfaces': {
-		    'foo': {
-			'NIC Names': 'admin',
-			'ip4addr': cnid + '.example.com'
-		    }
-		}
-	    }
-	};
-
-	for (svcname in fakeDeployed[cnid]) {
-		if (!svcids[svcname])
-			svcids[svcname] = nextId('service');
-		svcid = svcids[svcname];
-		next = fakeDeployed[cnid][svcname];
-
-		fakeBase['services'][svcid] = { 'name': svcname };
-		if (svcname == 'postgres' || svcname == 'moray') {
-			for (shardid in next) {
-				for (imgid in next[shardid]) {
-					populateVms({
-					    'cnid': cnid,
-					    'svcid': svcid,
-					    'shardid': shardid,
-					    'imgid': imgid,
-					    'count': next[shardid][imgid]
-					});
-				}
-			}
-		} else {
-			for (imgid in next) {
-				populateVms({
-				    'cnid': cnid,
-				    'svcid': svcid,
-				    'shardid': 1,
-				    'imgid': imgid,
-				    'count': next[imgid]
-				});
-			}
-		}
-	}
-}
-
 vasync.forEachPipeline({
     'func': runTestCase,
     'inputs': [ {
diff --git a/test/tst.adm_show.js b/test/tst.adm_show.js
new file mode 100644
index 0000000..730f4e3
--- /dev/null
+++ b/test/tst.adm_show.js
@@ -0,0 +1,135 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2016, Joyent, Inc.
+ */
+
+/*
+ * tst.adm_show.js: tests manta-adm show functionality
+ */
+
+var assertplus = require('assert-plus');
+var bunyan = require('bunyan');
+var jsprim = require('jsprim');
+var vasync = require('vasync');
+var CollectorStream = require('./CollectorStream');
+var VError = require('verror').VError;
+
+var common = require('./common');
+var madm = require('../lib/adm');
+
+var nrun = 0;
+var separator = '--------------------------------------------------';
+
+function main() {
+	vasync.forEachPipeline({
+		'func': runTestCase,
+		'inputs': testCases
+	}, function (err) {
+		assertplus.ok(!err);
+		assertplus.equal(nrun, testCases.length);
+		console.error('%d test cases run', nrun);
+	});
+}
+
+function runTestCase(t, callback) {
+	assertplus.string(t.name);
+	assertplus.ok(typeof (t.config) == 'object');
+	assertplus.ok(typeof (t.func) == 'function');
+
+	console.log(separator);
+	console.log('test case "%s"', t.name);
+
+	t.func.call(adm, process.stdout, t.config);
+
+	console.log(separator);
+	nrun++;
+	callback();
+}
+
+var fakeDeployed = {
+    'cn001': {
+	'marlin': { 'img001': 10 },
+	'moray': {
+	    '1': { 'img002': 3 },
+	    '2': { 'img002': 3 },
+	    '3': { 'img002': 3 }
+	},
+	'medusa': { 'img004': 2 }
+    },
+    'cn002': {
+	'marlin': { 'img001': 10 },
+	'moray': {
+	    '1': { 'img002': 3 },
+	    '2': { 'img002': 3 },
+	    '3': { 'img002': 3 }
+	}
+    },
+    'cn003': {
+	'marlin': { 'img001': 10 },
+	'postgres': {
+	    '1': { 'img003': 3 },
+	    '2': { 'img003': 3 },
+	    '3': { 'img003': 3 }
+	}
+    },
+    'cn004': {
+	'marlin': { 'img001': 2 },
+	'postgres': {
+	    '1': { 'img003': 1 },
+	    '2': { 'img003': 1 }
+	}
+    }
+};
+
+var log = new bunyan({
+    'name': 'tst.adm_show.js',
+    'level': process.env['LOG_LEVEL'] || 'warn',
+    'serializers': bunyan.stdSerializers
+});
+
+var adm = new madm.MantaAdm(log);
+adm.loadFakeDeployed(common.generateFakeBase(fakeDeployed, 3));
+
+var testCases = [ {
+	'name': 'manta-adm show',
+	'func': adm.dumpDeployedZonesByService,
+	'config': {}
+}, {
+	'name': 'manta-adm show -c',
+	'func': adm.dumpDeployedZonesByCn,
+	'config': {}
+}, {
+	'name': 'manta-adm show -s',
+	'func': adm.dumpDeployedConfigByService,
+	'config': {}
+}, {
+	'name': 'manta-adm show -a',
+	'func': adm.dumpDeployedZonesByService,
+	'config': {
+	    'doall': true
+	}
+}, {
+	'name': 'manta-adm show -H',
+	'func': adm.dumpDeployedZonesByService,
+	'config': {
+	    'omitHeader': true
+	}
+}, {
+	'name': 'manta-adm show -a -o service,datacenter,shard,version',
+	'func': adm.dumpDeployedZonesByService,
+	'config': {
+	    'doall': true,
+	    'columns': ['service', 'datacenter', 'shard', 'version']
+	}
+}, {
+	'name': 'manta-adm show -js',
+	'func': adm.dumpDeployedConfigByServiceJson,
+	'config': {}
+}];
+
+main();
diff --git a/test/tst.adm_show.js.out b/test/tst.adm_show.js.out
new file mode 100644
index 0000000..37fb057
--- /dev/null
+++ b/test/tst.adm_show.js.out
@@ -0,0 +1,674 @@
+--------------------------------------------------
+test case "manta-adm show"
+SERVICE          SH ZONENAME                             GZ ADMIN IP     
+marlin            1 instance001                          test-1-cn001.example.com
+marlin            1 instance002                          test-1-cn001.example.com
+marlin            1 instance003                          test-1-cn001.example.com
+marlin            1 instance004                          test-1-cn001.example.com
+marlin            1 instance005                          test-1-cn001.example.com
+marlin            1 instance006                          test-1-cn001.example.com
+marlin            1 instance007                          test-1-cn001.example.com
+marlin            1 instance008                          test-1-cn001.example.com
+marlin            1 instance009                          test-1-cn001.example.com
+marlin            1 instance010                          test-1-cn001.example.com
+marlin            1 instance022                          test-1-cn002.example.com
+marlin            1 instance023                          test-1-cn002.example.com
+marlin            1 instance024                          test-1-cn002.example.com
+marlin            1 instance025                          test-1-cn002.example.com
+marlin            1 instance026                          test-1-cn002.example.com
+marlin            1 instance027                          test-1-cn002.example.com
+marlin            1 instance028                          test-1-cn002.example.com
+marlin            1 instance029                          test-1-cn002.example.com
+marlin            1 instance030                          test-1-cn002.example.com
+marlin            1 instance031                          test-1-cn002.example.com
+marlin            1 instance041                          test-1-cn003.example.com
+marlin            1 instance042                          test-1-cn003.example.com
+marlin            1 instance043                          test-1-cn003.example.com
+marlin            1 instance044                          test-1-cn003.example.com
+marlin            1 instance045                          test-1-cn003.example.com
+marlin            1 instance046                          test-1-cn003.example.com
+marlin            1 instance047                          test-1-cn003.example.com
+marlin            1 instance048                          test-1-cn003.example.com
+marlin            1 instance049                          test-1-cn003.example.com
+marlin            1 instance050                          test-1-cn003.example.com
+marlin            1 instance060                          test-1-cn004.example.com
+marlin            1 instance061                          test-1-cn004.example.com
+medusa            1 instance020                          test-1-cn001.example.com
+medusa            1 instance021                          test-1-cn001.example.com
+moray             1 instance011                          test-1-cn001.example.com
+moray             1 instance012                          test-1-cn001.example.com
+moray             1 instance013                          test-1-cn001.example.com
+moray             1 instance032                          test-1-cn002.example.com
+moray             1 instance033                          test-1-cn002.example.com
+moray             1 instance034                          test-1-cn002.example.com
+moray             2 instance014                          test-1-cn001.example.com
+moray             2 instance015                          test-1-cn001.example.com
+moray             2 instance016                          test-1-cn001.example.com
+moray             2 instance035                          test-1-cn002.example.com
+moray             2 instance036                          test-1-cn002.example.com
+moray             2 instance037                          test-1-cn002.example.com
+moray             3 instance017                          test-1-cn001.example.com
+moray             3 instance018                          test-1-cn001.example.com
+moray             3 instance019                          test-1-cn001.example.com
+moray             3 instance038                          test-1-cn002.example.com
+moray             3 instance039                          test-1-cn002.example.com
+moray             3 instance040                          test-1-cn002.example.com
+postgres          1 instance051                          test-1-cn003.example.com
+postgres          1 instance052                          test-1-cn003.example.com
+postgres          1 instance053                          test-1-cn003.example.com
+postgres          1 instance062                          test-1-cn004.example.com
+postgres          2 instance054                          test-1-cn003.example.com
+postgres          2 instance055                          test-1-cn003.example.com
+postgres          2 instance056                          test-1-cn003.example.com
+postgres          2 instance063                          test-1-cn004.example.com
+postgres          3 instance057                          test-1-cn003.example.com
+postgres          3 instance058                          test-1-cn003.example.com
+postgres          3 instance059                          test-1-cn003.example.com
+--------------------------------------------------
+--------------------------------------------------
+test case "manta-adm show -c"
+CN TEST-1-CN001                         test-1-cn001 test-1-cn001.example.com
+     SERVICE          SH ZONENAME                            
+     marlin            1 instance001                         
+     marlin            1 instance007                         
+     marlin            1 instance010                         
+     marlin            1 instance009                         
+     marlin            1 instance008                         
+     marlin            1 instance006                         
+     marlin            1 instance005                         
+     marlin            1 instance004                         
+     marlin            1 instance003                         
+     marlin            1 instance002                         
+     medusa            1 instance020                         
+     medusa            1 instance021                         
+     moray             1 instance011                         
+     moray             2 instance014                         
+     moray             2 instance015                         
+     moray             3 instance019                         
+     moray             3 instance018                         
+     moray             1 instance013                         
+     moray             2 instance016                         
+     moray             3 instance017                         
+     moray             1 instance012                         
+CN TEST-1-CN002                         test-1-cn002 test-1-cn002.example.com
+     SERVICE          SH ZONENAME                            
+     marlin            1 instance022                         
+     marlin            1 instance023                         
+     marlin            1 instance024                         
+     marlin            1 instance025                         
+     marlin            1 instance026                         
+     marlin            1 instance027                         
+     marlin            1 instance028                         
+     marlin            1 instance029                         
+     marlin            1 instance030                         
+     marlin            1 instance031                         
+     moray             3 instance039                         
+     moray             1 instance033                         
+     moray             1 instance032                         
+     moray             3 instance040                         
+     moray             3 instance038                         
+     moray             2 instance037                         
+     moray             2 instance036                         
+     moray             2 instance035                         
+     moray             1 instance034                         
+CN TEST-1-CN003                         test-1-cn003 test-1-cn003.example.com
+     SERVICE          SH ZONENAME                            
+     marlin            1 instance049                         
+     marlin            1 instance044                         
+     marlin            1 instance041                         
+     marlin            1 instance050                         
+     marlin            1 instance043                         
+     marlin            1 instance042                         
+     marlin            1 instance045                         
+     marlin            1 instance046                         
+     marlin            1 instance047                         
+     marlin            1 instance048                         
+     postgres          1 instance052                         
+     postgres          1 instance053                         
+     postgres          1 instance051                         
+     postgres          3 instance059                         
+     postgres          3 instance058                         
+     postgres          3 instance057                         
+     postgres          2 instance056                         
+     postgres          2 instance055                         
+     postgres          2 instance054                         
+CN TEST-1-CN004                         test-1-cn004 test-1-cn004.example.com
+     SERVICE          SH ZONENAME                            
+     marlin            1 instance060                         
+     marlin            1 instance061                         
+     postgres          1 instance062                         
+     postgres          2 instance063                         
+--------------------------------------------------
+--------------------------------------------------
+test case "manta-adm show -s"
+SERVICE          SH VERSION                                    COUNT
+marlin            1 master001                                     32
+medusa            1 -                                              2
+moray             1 master002                                      6
+moray             2 master002                                      6
+moray             3 master002                                      6
+postgres          1 master003                                      4
+postgres          2 master003                                      4
+postgres          3 master003                                      3
+--------------------------------------------------
+--------------------------------------------------
+test case "manta-adm show -a"
+SERVICE          SH DATACENTER ZONENAME                            
+marlin            1 test-1     instance001                         
+marlin            1 test-1     instance002                         
+marlin            1 test-1     instance003                         
+marlin            1 test-1     instance004                         
+marlin            1 test-1     instance005                         
+marlin            1 test-1     instance006                         
+marlin            1 test-1     instance007                         
+marlin            1 test-1     instance008                         
+marlin            1 test-1     instance009                         
+marlin            1 test-1     instance010                         
+marlin            1 test-1     instance022                         
+marlin            1 test-1     instance023                         
+marlin            1 test-1     instance024                         
+marlin            1 test-1     instance025                         
+marlin            1 test-1     instance026                         
+marlin            1 test-1     instance027                         
+marlin            1 test-1     instance028                         
+marlin            1 test-1     instance029                         
+marlin            1 test-1     instance030                         
+marlin            1 test-1     instance031                         
+marlin            1 test-1     instance041                         
+marlin            1 test-1     instance042                         
+marlin            1 test-1     instance043                         
+marlin            1 test-1     instance044                         
+marlin            1 test-1     instance045                         
+marlin            1 test-1     instance046                         
+marlin            1 test-1     instance047                         
+marlin            1 test-1     instance048                         
+marlin            1 test-1     instance049                         
+marlin            1 test-1     instance050                         
+marlin            1 test-1     instance060                         
+marlin            1 test-1     instance061                         
+marlin            1 test-2     instance064                         
+marlin            1 test-2     instance065                         
+marlin            1 test-2     instance066                         
+marlin            1 test-2     instance067                         
+marlin            1 test-2     instance068                         
+marlin            1 test-2     instance069                         
+marlin            1 test-2     instance070                         
+marlin            1 test-2     instance071                         
+marlin            1 test-2     instance072                         
+marlin            1 test-2     instance073                         
+marlin            1 test-2     instance085                         
+marlin            1 test-2     instance086                         
+marlin            1 test-2     instance087                         
+marlin            1 test-2     instance088                         
+marlin            1 test-2     instance089                         
+marlin            1 test-2     instance090                         
+marlin            1 test-2     instance091                         
+marlin            1 test-2     instance092                         
+marlin            1 test-2     instance093                         
+marlin            1 test-2     instance094                         
+marlin            1 test-2     instance104                         
+marlin            1 test-2     instance105                         
+marlin            1 test-2     instance106                         
+marlin            1 test-2     instance107                         
+marlin            1 test-2     instance108                         
+marlin            1 test-2     instance109                         
+marlin            1 test-2     instance110                         
+marlin            1 test-2     instance111                         
+marlin            1 test-2     instance112                         
+marlin            1 test-2     instance113                         
+marlin            1 test-2     instance123                         
+marlin            1 test-2     instance124                         
+marlin            1 test-3     instance127                         
+marlin            1 test-3     instance128                         
+marlin            1 test-3     instance129                         
+marlin            1 test-3     instance130                         
+marlin            1 test-3     instance131                         
+marlin            1 test-3     instance132                         
+marlin            1 test-3     instance133                         
+marlin            1 test-3     instance134                         
+marlin            1 test-3     instance135                         
+marlin            1 test-3     instance136                         
+marlin            1 test-3     instance148                         
+marlin            1 test-3     instance149                         
+marlin            1 test-3     instance150                         
+marlin            1 test-3     instance151                         
+marlin            1 test-3     instance152                         
+marlin            1 test-3     instance153                         
+marlin            1 test-3     instance154                         
+marlin            1 test-3     instance155                         
+marlin            1 test-3     instance156                         
+marlin            1 test-3     instance157                         
+marlin            1 test-3     instance167                         
+marlin            1 test-3     instance168                         
+marlin            1 test-3     instance169                         
+marlin            1 test-3     instance170                         
+marlin            1 test-3     instance171                         
+marlin            1 test-3     instance172                         
+marlin            1 test-3     instance173                         
+marlin            1 test-3     instance174                         
+marlin            1 test-3     instance175                         
+marlin            1 test-3     instance176                         
+marlin            1 test-3     instance186                         
+marlin            1 test-3     instance187                         
+medusa            1 test-1     instance020                         
+medusa            1 test-1     instance021                         
+medusa            1 test-2     instance083                         
+medusa            1 test-2     instance084                         
+medusa            1 test-3     instance146                         
+medusa            1 test-3     instance147                         
+moray             1 test-1     instance011                         
+moray             1 test-1     instance012                         
+moray             1 test-1     instance013                         
+moray             1 test-1     instance032                         
+moray             1 test-1     instance033                         
+moray             1 test-1     instance034                         
+moray             1 test-2     instance074                         
+moray             1 test-2     instance075                         
+moray             1 test-2     instance076                         
+moray             1 test-2     instance095                         
+moray             1 test-2     instance096                         
+moray             1 test-2     instance097                         
+moray             1 test-3     instance137                         
+moray             1 test-3     instance138                         
+moray             1 test-3     instance139                         
+moray             1 test-3     instance158                         
+moray             1 test-3     instance159                         
+moray             1 test-3     instance160                         
+moray             2 test-1     instance014                         
+moray             2 test-1     instance015                         
+moray             2 test-1     instance016                         
+moray             2 test-1     instance035                         
+moray             2 test-1     instance036                         
+moray             2 test-1     instance037                         
+moray             2 test-2     instance077                         
+moray             2 test-2     instance078                         
+moray             2 test-2     instance079                         
+moray             2 test-2     instance098                         
+moray             2 test-2     instance099                         
+moray             2 test-2     instance100                         
+moray             2 test-3     instance140                         
+moray             2 test-3     instance141                         
+moray             2 test-3     instance142                         
+moray             2 test-3     instance161                         
+moray             2 test-3     instance162                         
+moray             2 test-3     instance163                         
+moray             3 test-1     instance017                         
+moray             3 test-1     instance018                         
+moray             3 test-1     instance019                         
+moray             3 test-1     instance038                         
+moray             3 test-1     instance039                         
+moray             3 test-1     instance040                         
+moray             3 test-2     instance080                         
+moray             3 test-2     instance081                         
+moray             3 test-2     instance082                         
+moray             3 test-2     instance101                         
+moray             3 test-2     instance102                         
+moray             3 test-2     instance103                         
+moray             3 test-3     instance143                         
+moray             3 test-3     instance144                         
+moray             3 test-3     instance145                         
+moray             3 test-3     instance164                         
+moray             3 test-3     instance165                         
+moray             3 test-3     instance166                         
+postgres          1 test-1     instance051                         
+postgres          1 test-1     instance052                         
+postgres          1 test-1     instance053                         
+postgres          1 test-1     instance062                         
+postgres          1 test-2     instance114                         
+postgres          1 test-2     instance115                         
+postgres          1 test-2     instance116                         
+postgres          1 test-2     instance125                         
+postgres          1 test-3     instance177                         
+postgres          1 test-3     instance178                         
+postgres          1 test-3     instance179                         
+postgres          1 test-3     instance188                         
+postgres          2 test-1     instance054                         
+postgres          2 test-1     instance055                         
+postgres          2 test-1     instance056                         
+postgres          2 test-1     instance063                         
+postgres          2 test-2     instance117                         
+postgres          2 test-2     instance118                         
+postgres          2 test-2     instance119                         
+postgres          2 test-2     instance126                         
+postgres          2 test-3     instance180                         
+postgres          2 test-3     instance181                         
+postgres          2 test-3     instance182                         
+postgres          2 test-3     instance189                         
+postgres          3 test-1     instance057                         
+postgres          3 test-1     instance058                         
+postgres          3 test-1     instance059                         
+postgres          3 test-2     instance120                         
+postgres          3 test-2     instance121                         
+postgres          3 test-2     instance122                         
+postgres          3 test-3     instance183                         
+postgres          3 test-3     instance184                         
+postgres          3 test-3     instance185                         
+--------------------------------------------------
+--------------------------------------------------
+test case "manta-adm show -H"
+marlin            1 instance001                          test-1-cn001.example.com
+marlin            1 instance002                          test-1-cn001.example.com
+marlin            1 instance003                          test-1-cn001.example.com
+marlin            1 instance004                          test-1-cn001.example.com
+marlin            1 instance005                          test-1-cn001.example.com
+marlin            1 instance006                          test-1-cn001.example.com
+marlin            1 instance007                          test-1-cn001.example.com
+marlin            1 instance008                          test-1-cn001.example.com
+marlin            1 instance009                          test-1-cn001.example.com
+marlin            1 instance010                          test-1-cn001.example.com
+marlin            1 instance022                          test-1-cn002.example.com
+marlin            1 instance023                          test-1-cn002.example.com
+marlin            1 instance024                          test-1-cn002.example.com
+marlin            1 instance025                          test-1-cn002.example.com
+marlin            1 instance026                          test-1-cn002.example.com
+marlin            1 instance027                          test-1-cn002.example.com
+marlin            1 instance028                          test-1-cn002.example.com
+marlin            1 instance029                          test-1-cn002.example.com
+marlin            1 instance030                          test-1-cn002.example.com
+marlin            1 instance031                          test-1-cn002.example.com
+marlin            1 instance041                          test-1-cn003.example.com
+marlin            1 instance042                          test-1-cn003.example.com
+marlin            1 instance043                          test-1-cn003.example.com
+marlin            1 instance044                          test-1-cn003.example.com
+marlin            1 instance045                          test-1-cn003.example.com
+marlin            1 instance046                          test-1-cn003.example.com
+marlin            1 instance047                          test-1-cn003.example.com
+marlin            1 instance048                          test-1-cn003.example.com
+marlin            1 instance049                          test-1-cn003.example.com
+marlin            1 instance050                          test-1-cn003.example.com
+marlin            1 instance060                          test-1-cn004.example.com
+marlin            1 instance061                          test-1-cn004.example.com
+medusa            1 instance020                          test-1-cn001.example.com
+medusa            1 instance021                          test-1-cn001.example.com
+moray             1 instance011                          test-1-cn001.example.com
+moray             1 instance012                          test-1-cn001.example.com
+moray             1 instance013                          test-1-cn001.example.com
+moray             1 instance032                          test-1-cn002.example.com
+moray             1 instance033                          test-1-cn002.example.com
+moray             1 instance034                          test-1-cn002.example.com
+moray             2 instance014                          test-1-cn001.example.com
+moray             2 instance015                          test-1-cn001.example.com
+moray             2 instance016                          test-1-cn001.example.com
+moray             2 instance035                          test-1-cn002.example.com
+moray             2 instance036                          test-1-cn002.example.com
+moray             2 instance037                          test-1-cn002.example.com
+moray             3 instance017                          test-1-cn001.example.com
+moray             3 instance018                          test-1-cn001.example.com
+moray             3 instance019                          test-1-cn001.example.com
+moray             3 instance038                          test-1-cn002.example.com
+moray             3 instance039                          test-1-cn002.example.com
+moray             3 instance040                          test-1-cn002.example.com
+postgres          1 instance051                          test-1-cn003.example.com
+postgres          1 instance052                          test-1-cn003.example.com
+postgres          1 instance053                          test-1-cn003.example.com
+postgres          1 instance062                          test-1-cn004.example.com
+postgres          2 instance054                          test-1-cn003.example.com
+postgres          2 instance055                          test-1-cn003.example.com
+postgres          2 instance056                          test-1-cn003.example.com
+postgres          2 instance063                          test-1-cn004.example.com
+postgres          3 instance057                          test-1-cn003.example.com
+postgres          3 instance058                          test-1-cn003.example.com
+postgres          3 instance059                          test-1-cn003.example.com
+--------------------------------------------------
+--------------------------------------------------
+test case "manta-adm show -a -o service,datacenter,shard,version"
+SERVICE          DATACENTER SH VERSION                                   
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-1      1 master001                                 
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-2      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+marlin           test-3      1 -                                         
+medusa           test-1      1 -                                         
+medusa           test-1      1 -                                         
+medusa           test-2      1 -                                         
+medusa           test-2      1 -                                         
+medusa           test-3      1 -                                         
+medusa           test-3      1 -                                         
+moray            test-1      1 master002                                 
+moray            test-1      1 master002                                 
+moray            test-1      1 master002                                 
+moray            test-1      1 master002                                 
+moray            test-1      1 master002                                 
+moray            test-1      1 master002                                 
+moray            test-2      1 -                                         
+moray            test-2      1 -                                         
+moray            test-2      1 -                                         
+moray            test-2      1 -                                         
+moray            test-2      1 -                                         
+moray            test-2      1 -                                         
+moray            test-3      1 -                                         
+moray            test-3      1 -                                         
+moray            test-3      1 -                                         
+moray            test-3      1 -                                         
+moray            test-3      1 -                                         
+moray            test-3      1 -                                         
+moray            test-1      2 master002                                 
+moray            test-1      2 master002                                 
+moray            test-1      2 master002                                 
+moray            test-1      2 master002                                 
+moray            test-1      2 master002                                 
+moray            test-1      2 master002                                 
+moray            test-2      2 -                                         
+moray            test-2      2 -                                         
+moray            test-2      2 -                                         
+moray            test-2      2 -                                         
+moray            test-2      2 -                                         
+moray            test-2      2 -                                         
+moray            test-3      2 -                                         
+moray            test-3      2 -                                         
+moray            test-3      2 -                                         
+moray            test-3      2 -                                         
+moray            test-3      2 -                                         
+moray            test-3      2 -                                         
+moray            test-1      3 master002                                 
+moray            test-1      3 master002                                 
+moray            test-1      3 master002                                 
+moray            test-1      3 master002                                 
+moray            test-1      3 master002                                 
+moray            test-1      3 master002                                 
+moray            test-2      3 -                                         
+moray            test-2      3 -                                         
+moray            test-2      3 -                                         
+moray            test-2      3 -                                         
+moray            test-2      3 -                                         
+moray            test-2      3 -                                         
+moray            test-3      3 -                                         
+moray            test-3      3 -                                         
+moray            test-3      3 -                                         
+moray            test-3      3 -                                         
+moray            test-3      3 -                                         
+moray            test-3      3 -                                         
+postgres         test-1      1 master003                                 
+postgres         test-1      1 master003                                 
+postgres         test-1      1 master003                                 
+postgres         test-1      1 master003                                 
+postgres         test-2      1 -                                         
+postgres         test-2      1 -                                         
+postgres         test-2      1 -                                         
+postgres         test-2      1 -                                         
+postgres         test-3      1 -                                         
+postgres         test-3      1 -                                         
+postgres         test-3      1 -                                         
+postgres         test-3      1 -                                         
+postgres         test-1      2 master003                                 
+postgres         test-1      2 master003                                 
+postgres         test-1      2 master003                                 
+postgres         test-1      2 master003                                 
+postgres         test-2      2 -                                         
+postgres         test-2      2 -                                         
+postgres         test-2      2 -                                         
+postgres         test-2      2 -                                         
+postgres         test-3      2 -                                         
+postgres         test-3      2 -                                         
+postgres         test-3      2 -                                         
+postgres         test-3      2 -                                         
+postgres         test-1      3 master003                                 
+postgres         test-1      3 master003                                 
+postgres         test-1      3 master003                                 
+postgres         test-2      3 -                                         
+postgres         test-2      3 -                                         
+postgres         test-2      3 -                                         
+postgres         test-3      3 -                                         
+postgres         test-3      3 -                                         
+postgres         test-3      3 -                                         
+--------------------------------------------------
+--------------------------------------------------
+test case "manta-adm show -js"
+{
+    "test-1-cn001": {
+        "marlin": {
+            "img001": 10
+        },
+        "medusa": {
+            "img004": 2
+        },
+        "moray": {
+            "1": {
+                "img002": 3
+            },
+            "2": {
+                "img002": 3
+            },
+            "3": {
+                "img002": 3
+            }
+        }
+    },
+    "test-1-cn002": {
+        "marlin": {
+            "img001": 10
+        },
+        "moray": {
+            "1": {
+                "img002": 3
+            },
+            "2": {
+                "img002": 3
+            },
+            "3": {
+                "img002": 3
+            }
+        }
+    },
+    "test-1-cn003": {
+        "marlin": {
+            "img001": 10
+        },
+        "postgres": {
+            "1": {
+                "img003": 3
+            },
+            "2": {
+                "img003": 3
+            },
+            "3": {
+                "img003": 3
+            }
+        }
+    },
+    "test-1-cn004": {
+        "marlin": {
+            "img001": 2
+        },
+        "postgres": {
+            "1": {
+                "img003": 1
+            },
+            "2": {
+                "img003": 1
+            }
+        }
+    }
+}
+--------------------------------------------------
diff --git a/test/tst.oneach_exec.js b/test/tst.oneach_exec.js
index 00305cc..b130b89 100644
--- a/test/tst.oneach_exec.js
+++ b/test/tst.oneach_exec.js
@@ -447,6 +447,8 @@ function setupMockManta(_, callback)
 	    'svc003': []
 	};
 	fakeDeployedTopology.vms = {};
+	fakeDeployedTopology.images = {};
+
 
 	for (i = 0; i < 9; i++) {
 		zoneid = 'zone' + (i + 1);
diff --git a/test/tst.zk.js b/test/tst.zk.js
index f2a8297..c2caf81 100644
--- a/test/tst.zk.js
+++ b/test/tst.zk.js
@@ -94,6 +94,7 @@ function runTestCase(testcase, callback)
 	});
 
 	deployed.vms = {};
+	deployed.images = {};
 	testcase.instances.forEach(function (instance) {
 		var uuid, server_uuid, islocal;
 
-- 
2.21.0

