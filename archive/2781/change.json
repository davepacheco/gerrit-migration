{"project":"joyent/sdc-vmapi","branch":"master","id":"I537b4b18ca98e88636862313ab903374bfda1546","number":"2781","subject":"ZAPI-808 vms.changefeed.test.js race with changefeed listener Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/2781","commitMessage":"ZAPI-808 vms.changefeed.test.js race with changefeed listener\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1507915763,"lastUpdated":1508350576,"open":false,"status":"MERGED","comments":[{"timestamp":1507915763,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1507915766,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit adf0c5294ba18674d8aebd0f4d4c8a0e79a9b644\n    \n    initial commit"},{"timestamp":1507915798,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508171652,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1508171655,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit d5d82ca3265d167bdd9b54edc6d01dbede25c669\n    \n    docs"},{"timestamp":1508171681,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508276852,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1508277354,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1508343439,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1508343442,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit fc95e7a9cee7a3fe0f22fc775b85ddc123b244b8\n    \n    create uuid first"},{"timestamp":1508343477,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508343504,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4."},{"timestamp":1508343508,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 67946fa8cc88ef9a4aa6afbad363d7623e92b162\n    \n    expect correct assertions"},{"timestamp":1508343561,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508343858,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1508344707,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1508349780,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1508350559,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1508350576,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"5","revision":"537b4b18ca98e88636862313ab903374bfda1546","parents":["e4a103b63811c7042f89e8d608cf47d463cdad57"],"ref":"refs/changes/81/2781/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508350559,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508343561,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508349780,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508349780,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1508350576,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":18,"sizeDeletions":-20},"patchSets":[{"number":"1","revision":"94628470884e40aee529dc9e2d94b122bf74006c","parents":["e4a103b63811c7042f89e8d608cf47d463cdad57"],"ref":"refs/changes/81/2781/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1507915763,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507915798,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":36,"sizeDeletions":-6},{"number":"2","revision":"c4574dc865ab5214a9efe1b91c166320ee68bbd8","parents":["e4a103b63811c7042f89e8d608cf47d463cdad57"],"ref":"refs/changes/81/2781/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508171652,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508171681,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/vms.changefeed.test.js","line":255,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"The CreateVm endpoint supports passing a VM UUID in the payload, maybe that would reduce the amount of things needed to perform that test?"},{"file":"test/vms.changefeed.test.js","line":255,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Do you mean we can generate a UUID first, and then fire off CreateVm? This way we wouldn\u0027t have to `client.get` immediately after, as we would already know the UUID ahead of time?\n\nIf so, I\u0027m torn.  I like reducing the amount of logic needed to GET directly after POST, and having to queue up all of the events seen.  But I also like not having specify a UUID, and instead letting the endpoint handle that logic for us... I imagine this is the more common case for this endpoint."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":41,"deletions":-6}],"sizeInsertions":41,"sizeDeletions":-6},{"number":"3","revision":"437648588a1068d58c174cdaeae7b0d6c97bd7a2","parents":["e4a103b63811c7042f89e8d608cf47d463cdad57"],"ref":"refs/changes/81/2781/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508343439,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508343477,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":18,"deletions":-19}],"sizeInsertions":18,"sizeDeletions":-19},{"number":"4","revision":"dba1bb7d461d5d045a0c5a969ad39f2a31325c82","parents":["e4a103b63811c7042f89e8d608cf47d463cdad57"],"ref":"refs/changes/81/2781/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508343504,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508343561,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508349780,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508349780,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"test/vms.changefeed.test.js","line":261,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I don\u0027t know node.js internals well enough to know if this is strictly required... if it is not I can remove this from the CR to simplify things even further."},{"file":"test/vms.changefeed.test.js","line":261,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Not processing \"changeItem\" when it\u0027s falsy is definitely an improvement. Moving the processing of change items to a separate function doesn\u0027t seem to hurt, so I think that part of the change is worth keeping."},{"file":"test/vms.changefeed.test.js","line":269,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I changed `noStateReceived` to `stateReceived` to avoid checking for a double negative."},{"file":"test/vms.changefeed.test.js","line":269,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That seems like a good idea!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":18,"sizeDeletions":-20},{"number":"5","revision":"537b4b18ca98e88636862313ab903374bfda1546","parents":["e4a103b63811c7042f89e8d608cf47d463cdad57"],"ref":"refs/changes/81/2781/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508350559,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508343561,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508349780,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508349780,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1508350576,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"test/vms.changefeed.test.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":18,"sizeDeletions":-20}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}