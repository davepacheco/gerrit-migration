commit 94628470884e40aee529dc9e2d94b122bf74006c (refs/changes/81/2781/1)
Author: Dave Eddy <dave@daveeddy.com>
Date:   2017-10-13T13:29:21-04:00 (2 years ago)
    
    ZAPI-808 vms.changefeed.test.js race with changefeed listener

diff --git a/test/vms.changefeed.test.js b/test/vms.changefeed.test.js
index a9b0ac9..d3bfe06 100644
--- a/test/vms.changefeed.test.js
+++ b/test/vms.changefeed.test.js
@@ -218,6 +218,9 @@ exports.napi_networks_ok = function (t) {
 
 exports.create_vm = function (t) {
     t.expect(8);
+
+    var changeItems = [];
+
     var md = {
         foo: 'bar',
         credentials: JSON.stringify({ 'user_pw': '12345678' })
@@ -261,24 +264,51 @@ exports.create_vm = function (t) {
                 common.checkHeaders(t, res2.headers);
                 t.ok(body2, 'provisioning vm ok');
                 VM = body2;
+
+                /*
+                 * Now that the VMs UUID is available, we can "replay" all old
+                 * events seen by the listener below through the
+                 * processChangeItem function.
+                 */
+                changeItems.forEach(processChangeItem);
             });
         });
     });
 
-    var noStateReceived = true;
+    /*
+     * If the VMs UUID is not yet available (meaning client.get(vmLocation)
+     * hasn't run sucessfully above yet) store the events in an array to be
+     * processed later, otherwise just process them now.
+     */
     listener.on('readable', function () {
-        var changeItem = listener.read();
+        var changeItem;
+        while ((changeItem = listener.read())) {
+            if (!VM) {
+                changeItems.push(changeItem);
+            } else {
+                processChangeItem(changeItem);
+            }
+        }
+    });
+
+    /*
+     * Process each changeItem seen (must only run after VM.uuid is available)
+     * and finish the test when a "state" change has been seen.
+     */
+    var stateReceived = false;
+    function processChangeItem(changeItem) {
         var changeKind = changeItem.changeKind;
-        if (noStateReceived &&
+        if (!stateReceived &&
             changeItem.changedResourceId === VM.uuid &&
             changeKind.subResources &&
             changeKind.subResources.indexOf('state') !== -1) {
+
             t.ok(true, 'state received');
-            noStateReceived = false;
+            stateReceived = true;
             listener._endSocket();
             t.done();
         }
-    });
+    }
 };
 
 exports.wait_provisioned_job = function (t) {
@@ -752,4 +782,4 @@ exports.create_vm_that_fails_provisioning_workflow = function (t) {
             }
         }
     }
-};
\ No newline at end of file
+};
