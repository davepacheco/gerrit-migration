From 381d7f13f84646183a86eec7b36165df9e390d9b Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 26 Aug 2016 14:44:28 -0700
Subject: [PATCH] DOCKER-920 Docker build shouldn't need to use chown after
 copying files

---
 bin/docker-build.js | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/bin/docker-build.js b/bin/docker-build.js
index 6b7555e..c5f0fa7 100644
--- a/bin/docker-build.js
+++ b/bin/docker-build.js
@@ -273,6 +273,11 @@ function runBuild(opts) {
 
     log.info('%s - started for zone %s', commandType, opts.uuid);
 
+    // Before we start, we want all files created by docker build/commit to use
+    // 'root:root' permissions. The cn-agent process defaults to using
+    // 'root:staff', so just update the group identifier using setgid.
+    process.setgid(0);
+
     sendMessage('Starting ' + commandType, {socket: socket, log: log});
 
     if (commandType === 'commit') {
@@ -745,7 +750,7 @@ function handleExtractTarfileEvent(builder, event) {
     var tarfile = event.tarfile;
 
     // Ensure the holding (parent) directory exists.
-    builder.mkdirpChown(extractDir, function (err) {
+    mkdirp(extractDir, function (err) {
         if (err) {
             callback(err);
             return;
-- 
2.21.0

