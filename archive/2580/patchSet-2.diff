From e0149e9672fa61532bd4e724e9f1e680faf01c6b Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Fri, 15 Sep 2017 06:48:06 +0000
Subject: [PATCH] joyent/node-fast#7 fsr_context isn't always unpiped from
 fsr_encoder, which causes memory leaks

---
 CHANGES.md         |  4 ++++
 lib/fast_server.js | 12 ++++++++++++
 package.json       |  2 +-
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/CHANGES.md b/CHANGES.md
index 6cd84b9..def0764 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -4,6 +4,10 @@
 
 No changes.
 
+## v2.2.4
+
+* #7 fsr_context isn't always unpiped from fsr_encoder, which causes memory leaks
+
 ## v2.2.3
 
 * #5 Server shutdown crashes when a connection had a socket error
diff --git a/lib/fast_server.js b/lib/fast_server.js
index 17b81cb..b4a0f21 100644
--- a/lib/fast_server.js
+++ b/lib/fast_server.js
@@ -768,6 +768,18 @@ FastServer.prototype.requestFail = function (request, error)
 
 	request.fsr_conn.fc_msgencoder.write(requestMakeMessage(
 	    request, mod_protocol.FP_STATUS_ERROR, error));
+
+
+	/*
+	 * In the case of normal termination, the implementor ends the
+	 * context stream, which tears down the pipeline between that
+	 * stream, the request's encoder, and the connection's encoder.
+	 * In this case, though, that pipeline is still set up, and we
+	 * must explicitly tear it off at the connection end of the
+	 * pipeline so the rest can be garbage collected.
+	 */
+	request.fsr_encoder.unpipe(request.fsr_conn.fc_msgencoder);
+
 	this.requestCleanup(request);
 };
 
diff --git a/package.json b/package.json
index 66d7c62..2cc02e8 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
 	"name": "fast",
 	"description": "streaming JSON RPC over TCP",
-	"version": "2.2.3",
+	"version": "2.2.4",
 	"main": "./lib/fast.js",
 	"repository": {
 		"type": "git",
-- 
2.21.0

