{"project":"joyent/sdc-manatee","branch":"master","topic":"MANATEE-312","id":"I8e6e13574f13725021517bd823e8d057bb16b5ea","number":"377","subject":"MANATEE-312 manatee should not set snapdir to visible Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Dave Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"url":"https://cr.joyent.us/377","commitMessage":"MANATEE-312 manatee should not set snapdir to visible\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1472513022,"lastUpdated":1475112421,"open":false,"status":"MERGED","comments":[{"timestamp":1472513022,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 1."},{"timestamp":1472513038,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472514282,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Topic set to MANATEE-312"},{"timestamp":1473217939,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1473873043,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)\n\nIn terms of integration approval: how have these changes been tested?"},{"timestamp":1473873067,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1473957265,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 1:\n\n(1 comment)\n\n."},{"timestamp":1473957792,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 1:\n\nWith regards to how it was tested: First, I built the modified manatee in Jenkins, and used `sdcadm upgrade` to upgrade the manatee on the HN to the candidate manatee. Then I downgraded it to the stock manatee. And did this a few times, checking the snapdir property of the relevant ZFS datasets, and the health of the manatee service itself.\n\nThen, I created an ha-manatee on the HN. All of the manatee zones were running the candidate manatee. I turned off the primary, turned it back on, and did a rebuild. I did this for each new primary as well. This was to test that the rebuild code (which uses snapshots) does not somehow depend on the snapdir being a listable dir (it does not)."},{"timestamp":1473973105,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\nDid you end up testing this in Manta as well?  (Not sure if that\u0027s necessary or not, to be honest.)\n\nThe other cases I could imagine depending on the snapshots being listed would be the snapshotter service and the nightly database backup.  Have we verified that these aren\u0027t affected (either by code inspection or by testing)?"},{"timestamp":1474130721,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 1:\n\nI did not test this independently in manta. My understanding is that you need more than one physical node (i.e. HN plus some CNs) to get Manta running. I could in theory set up a few VMs on my server, but that would require destroying an existing SDC VM because its state is corrupted -- I was keeping it around so that I could diagnose the source of the corruption."},{"timestamp":1474303552,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\nI typically deploy Manta on a single system -- you don\u0027t need any CNs to do that.\n\nWhat about the snapshotter and nightly backups?"},{"timestamp":1474311959,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 1:\n\nSo looking at the manatee repo, we don\u0027t call readdir anywhere, nor do we call shelljs.ls() anywhere. We do exec/spawn a `chown -R` and an `rm -rf` on the dataDir, but those can\u0027t (and shouldn\u0027t try to) operate on the contents of `.zfs`.  Other instances in which we fork a child process are instances where the child is the `zfs` command. Tangentially, FWIW, backupSender.js requires `shelljs` which is not later invoked. backupServer.js requires `backupSender.js` which is _also_ not later invoked... Seems that file is completely vestigial...\n\nAnyway, proceeding to test this on a single-node manta."},{"timestamp":1475016869,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 1:\n\nThis has been tested on a single-node manta, and we do indeed set snapdir to hidden. Running `svcs -Zxv` does not reveal any problems. This looks like it\u0027s good to go."},{"timestamp":1475111969,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1475112323,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 2: Commit message was updated."},{"timestamp":1475112421,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Nick Zivkovic"}],"currentPatchSet":{"number":"2","revision":"978914c52f277dca99b7e6fb48d29b60ffe5ebcb","parents":["b4257999f87085b46519b89a7895d6b03e028e37"],"ref":"refs/changes/77/377/2","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1475112323,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472513038,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473217939,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473873067,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475111969,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1475112421,"by":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":3,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"8e6e13574f13725021517bd823e8d057bb16b5ea","parents":["b4257999f87085b46519b89a7895d6b03e028e37"],"ref":"refs/changes/77/377/1","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1472513022,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473873067,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475111969,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473217939,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472513038,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":93,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It might be useful to mention that this \"zfs inherit\" is necessary in case the dataset already existed before entering this functiong.  (If the dataset did exist, the \"zfs create\" would have created it with \"snapdir\" inherited, so the \"zfs inherit\" operation would be redundant.)"},{"file":"boot/setup.sh","line":93,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":3,"sizeDeletions":-4},{"number":"2","revision":"978914c52f277dca99b7e6fb48d29b60ffe5ebcb","parents":["b4257999f87085b46519b89a7895d6b03e028e37"],"ref":"refs/changes/77/377/2","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1475112323,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473873067,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475111969,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473217939,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472513038,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1475112421,"by":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":3,"sizeDeletions":-4}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}]}