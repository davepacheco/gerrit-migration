From c62095594b99c9dbe439f861f387a62148602ba1 Mon Sep 17 00:00:00 2001
From: Robert Bogart <Robert.bogart@joyent.com>
Date: Tue, 6 Nov 2018 00:38:28 +0000
Subject: [PATCH] MANTA-4015 Add mako datacenter to header information when
 uploading mako manifest

---
 bin/upload_mako_ls.sh | 31 ++++++++++++++++++++++++++-----
 1 file changed, 26 insertions(+), 5 deletions(-)

diff --git a/bin/upload_mako_ls.sh b/bin/upload_mako_ls.sh
index 9ea52bc..4e9a72a 100755
--- a/bin/upload_mako_ls.sh
+++ b/bin/upload_mako_ls.sh
@@ -44,6 +44,9 @@ MAKO_DIR=/opt/smartdc/mako
 TARGET_DIR=/manta
 START_TIME=`date -u +"%Y-%m-%dT%H:%M:%SZ"` # Time that this script started.
 
+TOP=$(cd $(dirname $0)/../.. 2>/dev/null; pwd)
+CONFIG=$TOP/common/etc/config.json
+CURL_OPTS="-4 --connect-timeout 10 -sS -H accept:application/json"
 
 
 # Mutables
@@ -51,8 +54,6 @@ START_TIME=`date -u +"%Y-%m-%dT%H:%M:%SZ"` # Time that this script started.
 NOW=""
 SIGNATURE=""
 
-
-
 ## Functions
 
 function fatal {
@@ -61,12 +62,27 @@ function fatal {
     exit 1
 }
 
-
 function log {
     local LNOW=`date`
     echo "$LNOW: $(basename $0): info: $*" >&2
 }
 
+SAPI_URL=
+function sapi() {
+    local path=$1
+    shift
+    if [[ -z "$SAPI_URL" ]]; then
+        SAPI_URL="$(json -f $CONFIG sapi.url)"
+    fi
+
+    if [[ -z "$SDC_API_VERSION" ]]; then
+        SDC_API_VERSION="~2"
+    fi
+    (curl ${CURL_OPTS} -H "accept-version: ${SDC_API_VERSION}" \
+        --url "${SAPI_URL}${path}" "$@") || return $?
+    echo ""  # sometimes the result is not terminated with a newline
+    return 0
+}
 
 function sign() {
     NOW=$(date -u "+%a, %d %h %Y %H:%M:%S GMT")
@@ -76,7 +92,6 @@ function sign() {
         || fatal "unable to sign data"
 }
 
-
 function manta_put_directory() {
     sign || fatal "unable to sign"
     curl -fsSk \
@@ -88,12 +103,18 @@ function manta_put_directory() {
         $MANTA_URL/$MANTA_USER/stor/${1} 2>&1
 }
 
-
 function manta_put() {
     sign || fatal "unable to sign"
+
+    if [[ -z "$datacenter" ]]; then
+        metadata=$(sapi "/instances/$(hostname)")
+        datacenter=$(echo $metadata |json -ga metadata.DATACENTER)
+    fi
+
     curl -vfsSk \
         -X PUT \
         -H "Date: $NOW" \
+        -H "m-datacenter: $datacenter"\
         -H "Authorization: Signature $AUTHZ_HEADER,signature=\"$SIGNATURE\"" \
         -H "Connection: close" \
         -H "m-mako-dump-time: $START_TIME" \
-- 
2.21.0

