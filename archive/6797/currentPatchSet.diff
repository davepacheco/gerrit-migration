From be4430fe4f88f74c398b9548ad5c4c628f53f8b6 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 15 Aug 2019 11:27:46 -0700
Subject: [PATCH] =?UTF-8?q?TRITON-1871=20vmapi=20migration=20test=20fail?=
 =?UTF-8?q?=20when=20using=20uuid=20override=20Reviewed=20by:=20Pedro=20Pa?=
 =?UTF-8?q?laz=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved=20by:=20Ped?=
 =?UTF-8?q?ro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/workflows/vm-migration/rollback.js | 6 ++----
 package.json                           | 2 +-
 test/lib/migration.js                  | 6 +++---
 3 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/lib/workflows/vm-migration/rollback.js b/lib/workflows/vm-migration/rollback.js
index a9f59b7..864fe47 100644
--- a/lib/workflows/vm-migration/rollback.js
+++ b/lib/workflows/vm-migration/rollback.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 
@@ -50,8 +50,6 @@ function stopTargetVm(job, cb) {
 
     assert.uuid(record.target_server_uuid, 'record.target_server_uuid');
     assert.uuid(record.target_vm_uuid, 'record.target_vm_uuid');
-    assert.equal(job.params.vm_uuid, record.target_vm_uuid,
-        'job.params.vm_uuid should be the same as record.target_vm_uuid');
 
     job.workflow_job_uuid = null;
 
@@ -126,7 +124,7 @@ function stopTargetVm(job, cb) {
                 headers: {'x-request-id': job.params['x-request-id']},
                 url: vmapiUrl
             });
-            vmapi.stopVm({uuid: job.params.vm_uuid}, function (err, body) {
+            vmapi.stopVm({uuid: record.target_vm_uuid}, function (err, body) {
                 if (err) {
                     next(err);
                     return;
diff --git a/package.json b/package.json
index 5f5efe5..d5d1ec1 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.8.15",
+  "version": "9.8.16",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
diff --git a/test/lib/migration.js b/test/lib/migration.js
index 612825e..078cff0 100644
--- a/test/lib/migration.js
+++ b/test/lib/migration.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var stream = require('stream');
@@ -1278,7 +1278,7 @@ function TestMigrationCfg(test, cfg) {
         // migration is finalized.
         client.post({
             path: format('/vms/%s?action=migrate&migration_action=begin',
-                targetVm.uuid)
+                sourceVm.uuid)
         }, function onMigrateBeginFromStateSuccessCb(err) {
             t.ok(err,
                 'expect an error for migration begin when a previous ' +
@@ -1569,7 +1569,7 @@ function TestMigrationCfg(test, cfg) {
 
         client.post({
             path: format('/vms/%s?action=migrate&migration_action=rollback',
-                targetVm.uuid)
+                sourceVm.uuid)
         }, function onMigrateRollbackCb(err, req, res, body) {
             common.ifError(t, err, 'no error from migration rollback call');
             if (!err) {
-- 
2.21.0

