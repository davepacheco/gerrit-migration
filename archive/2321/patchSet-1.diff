From eb2213a48cddedc0d7d5f9e1b472bba2f8d32a23 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 2 Aug 2017 15:05:03 -0700
Subject: [PATCH] joyent/node-mooremachine#15 Want timestamps in fsm state
 history

---
 lib/fsm.js         | 6 ++++--
 package.json       | 2 +-
 test/basic.test.js | 9 +++++----
 3 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/lib/fsm.js b/lib/fsm.js
index ea07260..d2c799a 100644
--- a/lib/fsm.js
+++ b/lib/fsm.js
@@ -47,6 +47,7 @@ function FSMStateHandle(fsm, state, link) {
 	this.fsh_immediates = [];
 	this.fsh_validTransitions = undefined;
 	this.fsh_nextState = undefined;
+	this.fsh_exitedAt = undefined;
 }
 
 FSMStateHandle.prototype.validTransitions = function (states) {
@@ -71,6 +72,7 @@ FSMStateHandle.prototype.gotoState = function (state) {
 	}
 	this.fsh_valid = false;
 	this.fsh_nextState = state;
+	this.fsh_exitedAt = process.hrtime();
 	return (this.fsh_fsm._gotoState(state));
 };
 
@@ -315,7 +317,7 @@ FSM.prototype._gotoState = function (state) {
 
 	this.fsm_handle = new FSMStateHandle(this, state, this.fsm_handle);
 
-	this.fsm_history.push(state);
+	this.fsm_history.push([state, process.hrtime()]);
 	if (this.fsm_history.length >= 8)
 		this.fsm_history.shift();
 
@@ -334,7 +336,7 @@ FSM.prototype._gotoState = function (state) {
 
 	this.fsm_toEmit.push(state);
 	if (this.fsm_toEmit.length === 1) {
-		setImmediate(function () {
+		process.nextTick(function () {
 			var ss = self.fsm_toEmit;
 			self.fsm_toEmit = [];
 			ss.forEach(function (s) {
diff --git a/package.json b/package.json
index ce2b3b0..c17d660 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "mooremachine",
-  "version": "2.1.0",
+  "version": "2.2.0",
   "description": "Moore finite state machines",
   "main": "lib/index.js",
   "scripts": {
diff --git a/test/basic.test.js b/test/basic.test.js
index baed932..bb3cd5c 100644
--- a/test/basic.test.js
+++ b/test/basic.test.js
@@ -59,12 +59,12 @@ test('S.on works, emits stateChanged', function (t) {
 	});
 	t.ok(c.isInState('initial'));
 	t.strictEqual(e.listeners('foo').length, 1);
-	setImmediate(function () {
+	setTimeout(function () {
 		t.ok(c.isInState('next'));
 		t.strictEqual(e.listeners('foo').length, 0);
 		t.deepEqual(history, ['initial', 'next']);
 		t.end();
-	});
+	}, 100);
 });
 
 test('double transition', function (t) {
@@ -494,8 +494,9 @@ test('interacting FSMs', function (t) {
 	t.ok(a.isInState('s1'));
 	t.ok(b.isInState('s1'));
 
-	t.deepEqual(a.fsm_history, ['s1', 's2', 's3', 's1']);
-	t.deepEqual(b.fsm_history, ['s1', 's2', 's3', 's1']);
+	function takeFirst(arr) { return (arr[0]); }
+	t.deepEqual(a.fsm_history.map(takeFirst), ['s1', 's2', 's3', 's1']);
+	t.deepEqual(b.fsm_history.map(takeFirst), ['s1', 's2', 's3', 's1']);
 
 	t.end();
 });
-- 
2.21.0

