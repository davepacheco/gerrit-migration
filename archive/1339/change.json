{"project":"joyent/sdc-vmapi","branch":"master","id":"Icc4f891e92c9b4da118e0c440cdb42da6aed442f","number":"1339","subject":"ZAPI-751 add-nics workflow should set the cn_uuid of the new NIC ZAPI-764 Provisioning fabric NATs broken by VMAPI initialization changes Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/1339","commitMessage":"ZAPI-751 add-nics workflow should set the cn_uuid of the new NIC\nZAPI-764 Provisioning fabric NATs broken by VMAPI initialization changes\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e\n","createdOn":1485387672,"lastUpdated":1485806016,"open":false,"status":"MERGED","comments":[{"timestamp":1485387672,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1485387705,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485388352,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\nI tested these changes in my coal by:\n\n- Running all VMAPI tests successfully\n- Provisioning a NIC on a fabric network and checking that the NAT was provisioned\n- Provisioning a VM not on a fabric network, then adding a fabric NIC, and confirming that the new NIC in NAPI had a cn_uuid."},{"timestamp":1485389729,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1: Code-Review+1\n\n(5 comments)\n\nGenerally +1, although I do have questions that are mostly due to my lack of understanding of the nics provisioning code."},{"timestamp":1485398096,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1485398124,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485398281,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1485459869,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1485557820,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1485557848,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485558888,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1485558925,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1485559686,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1485805932,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1485805951,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1485805998,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1485806016,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"5","revision":"69ea66d92bc03387e0c08c4d4fd44afb47bae024","parents":["47bd9f660612c675e8668796b811ccfc9508cc25"],"ref":"refs/changes/39/1339/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485805998,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485557848,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485559686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485805951,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1485806016,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"deps/javascriptlint","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/fabric-common.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":30,"deletions":-13},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-34},"patchSets":[{"number":"1","revision":"4323ac7f9cb4c19e6347f482fe724302aa47fb50","parents":["47bd9f660612c675e8668796b811ccfc9508cc25"],"ref":"refs/changes/39/1339/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485387672,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485387705,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485389729,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"lib/vmapi.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we update the copyright?"},{"file":"lib/vmapi.js","line":8,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/vmapi.js","line":93,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we make the absence of \"options.config.overlay.natPool\" generate an error in \"setDefaultValues\" in case fabrics are enabled? Otherwise I\u0027m concerned that, should a similar issue arise in the future, its root cause is going to be less obvious than it should be.\n\nActually, setDefaultValues might not be the best place to assert for that, maybe \"createVm\" after \"common.setDefaultValues\" was called could check for the presence of a valid \"sdc_nat_pool\" value."},{"file":"lib/vmapi.js","line":93,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve added some additional assertions that should help. The new failure in provisionFabricNics should also help make this more easily debuggable in the future."},{"file":"lib/workflows/job-common.js","line":715,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is \"job.params.server_uuid\" required? If so, can it be be missing and should we error in that case?"},{"file":"lib/workflows/job-common.js","line":715,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"As far as I know, it is always present, since this step comes after a server is determined in the workflow."},{"file":"lib/workflows/job-common.js","line":728,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is this list a duplicate of the list \"antiSpoofParams\" in \"addNics\" below?"},{"file":"lib/workflows/job-common.js","line":728,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Yep. Unfortunately it has to be duplicated in both, since they get sent to workflow separately."},{"file":"lib/workflows/job-common.js","line":728,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Ah right, I always get confused about that constraint when reading/writing workflow tasks :)"},{"file":"lib/workflows/provision.js","line":22,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is the patch bump due to the introduction of a failure mode in \"provisionFabricNats\"? If so, should that be a major bump instead, because it\u0027s a change of behavior that is potentially breaking?"},{"file":"lib/workflows/provision.js","line":22,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I had bumped it because I had changed the normal NIC provision path, but the new failure probably deserves a bump in the minor. It currently fails today without \u0027sdc_nat_pool\u0027, this\u0027ll just make it fail earlier with a better message."},{"file":"lib/workflows/provision.js","line":22,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why a minor bump and not a major? I\u0027m not familiar with how workflow jobs handle versioning. I had interpreted their versioning as following semver, and assumed that such a change in behavior could be backward incompatible and would thus warrant a major bump, but I\u0027m probably missing something."},{"file":"lib/workflows/provision.js","line":22,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"For posterity: Julien and I discussed this elsewhere and decided to keep the minor bump since workflow doesn\u0027t care too much about what versions get used."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"deps/javascriptlint","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/fabric-common.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":30,"deletions":-13},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":39,"sizeDeletions":-21},{"number":"2","revision":"662531dc70110b9f695d3226321b88ab88d38b10","parents":["47bd9f660612c675e8668796b811ccfc9508cc25"],"ref":"refs/changes/39/1339/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485398096,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485398124,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/vmapi.js","line":56,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can we make \"options.overlay\" optional instead? The goal for the \"VMAPI\" constructor with the recent refactoring done by ZAPI-757 was too allow users to pass as few parameters as needed in the \"options\" objects.\n\nMaking \"options.overlay\" required means that tests and other users of the VMAPI constructor need to pass an \"overlay\" option when they shouldn\u0027t need to care about it.\n\nIf \"options.overlay\" is optional, then we could assert that \"options.overlay.natPool\" is a uuid only if \"options.overlay\" is present.\n\nHowever, my initial comment was meant to say that this could be checked only in \"createVm\" after we call \"setDefaultValues\", because that\u0027s really the only place for now where we care about assert that \".sdc_nat_pool\" is a valid UUID. Maybe it is conceivable that we\u0027d want to instantiate a VMAPI application that has overlay enabled but no NAT pool?"},{"file":"lib/vmapi.js","line":56,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done. I\u0027ve changed it to only check the natPool when an overlay object is present on the config."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"deps/javascriptlint","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/fabric-common.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":30,"deletions":-13},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-34},{"number":"3","revision":"2f40b764d67d8f54cef51f3c6c6136c1f3dc3d3e","parents":["47bd9f660612c675e8668796b811ccfc9508cc25"],"ref":"refs/changes/39/1339/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485557820,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485557848,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"deps/javascriptlint","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/fabric-common.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":30,"deletions":-13},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-34},{"number":"4","revision":"cc4f891e92c9b4da118e0c440cdb42da6aed442f","parents":["47bd9f660612c675e8668796b811ccfc9508cc25"],"ref":"refs/changes/39/1339/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485558925,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485557848,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485805951,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485559686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"deps/javascriptlint","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/fabric-common.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":30,"deletions":-13},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-34},{"number":"5","revision":"69ea66d92bc03387e0c08c4d4fd44afb47bae024","parents":["47bd9f660612c675e8668796b811ccfc9508cc25"],"ref":"refs/changes/39/1339/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485805998,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1485806016,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485557848,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485805951,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485559686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"deps/javascriptlint","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"lib/workflows/add-nics.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/workflows/fabric-common.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/workflows/job-common.js","type":"MODIFIED","insertions":30,"deletions":-13},{"file":"lib/workflows/provision.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-34}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}