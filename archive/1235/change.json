{"project":"joyent/node-triton","branch":"master","id":"I8f80c68641f241f8d2cc8c9dc1431b3e065b384c","number":"1235","subject":"ZAPI-757 VMAPI should dump core when an uncaught error is thrown Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/1235","commitMessage":"ZAPI-757 VMAPI should dump core when an uncaught error is thrown\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1484099316,"lastUpdated":1484353715,"open":false,"status":"MERGED","comments":[{"timestamp":1484099316,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1484099354,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484099419,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1484099457,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484158362,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1484158380,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1484163985,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1484261676,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 3."},{"timestamp":1484261709,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484266421,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1484266654,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1484266687,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1484353598,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1484353632,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1484353655,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1484353715,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"6","revision":"d99110553d768226f9fb30765e37738d9a4427b3","parents":["da80542222844002e95daba45171308aa0be03be"],"ref":"refs/changes/35/1235/6","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484353655,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484261709,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1484353714,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/cli.js","type":"MODIFIED","insertions":37,"deletions":-6}],"sizeInsertions":49,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"c68cbcd54d6d2ee0e88c304329133e66cf02d241","parents":["76759e547e67d0c45970bb881f90ae9a82912c77"],"ref":"refs/changes/35/1235/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484099316,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484099354,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":13,"deletions":-9},{"file":"lib/cli.js","type":"MODIFIED","insertions":18,"deletions":-5}],"sizeInsertions":31,"sizeDeletions":-14},{"number":"2","revision":"5e810555f294a369df73f30084f528578d5d1464","parents":["76759e547e67d0c45970bb881f90ae9a82912c77"],"ref":"refs/changes/35/1235/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484099419,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484099457,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"typo"},{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Will fix, thanks!"},{"file":"lib/SaferJsonClient.js","line":128,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"See other comments first: we might not change this code to use \u0027bodyStr\u0027. However, if we *do*, then this could go back to using \"!bodyStr.trim()\"."},{"file":"lib/SaferJsonClient.js","line":128,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sounds good, good catch!"},{"file":"lib/SaferJsonClient.js","line":141,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could the removed \"Special error handling.\" comment come back? That was meant to be for this section of code (up to the about line 178).\n\n\"body sent represents an empty body\" resulting in \"{}\": Is that just the behaviour of a restify server? If so, saying so in the comment might be helpful in case restify server behaviour changes.\n\nActually I wonder if adding these kinds of \"smarts\" really belongs in a generic \"SaferJsonClient\" class. Perhaps there is a client/server API where err.message\u003d\"{}\" is meaningful.\nIn this case we could handle \"{}\" in cli.js. Thoughts?"},{"file":"lib/SaferJsonClient.js","line":141,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e Could the removed \"Special error handling.\" comment come back?\n\nAbsolutely. Initially it wasn\u0027t clear to me that it applied to that whole section of code, and it wasn\u0027t explicit enough for me to understand what it meant. I also thought that if it was just here to mark the beginning of the \"special error handling code\", it wasn\u0027t that useful since it was clear the code was doing error handling.\n\nBut I don\u0027t mind putting it back in.\n\n\u003e \"body sent represents an empty body\" resulting in \"{}\": Is that just the behaviour of a restify server? If so, saying so in the comment might be helpful in case restify server behaviour changes.\n\nI think this is the behavior of restify servers when sending non-restify errors (such as new Error(\u0027foo\u0027)) as a response, but I should dig deeper to confirm and document that. I can definitely mention that in the comment then.\n\n\u003e Actually I wonder if adding these kinds of \"smarts\" really belongs in a generic \"SaferJsonClient\" class. Perhaps there is a client/server API where err.message\u003d\"{}\" is meaningful.\nIn this case we could handle \"{}\" in cli.js. Thoughts?\n\nIf this custom client class was meant to handle other formats, then I would agree, but in this case it seems SaferJsonClient is meant to handle JSON formatted responses only. Thus, shouldn\u0027t the string \u0027{}\u0027 always mean an empty object, and thus an empty body?"},{"file":"lib/SaferJsonClient.js","line":180,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is changing the API a bit. Instead of the raw Buffer bytes of the response body, we are returning a stringified version. See the comment about that in the block comment at the top of the file."},{"file":"lib/SaferJsonClient.js","line":180,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good catch and sorry for overlooking this! Will fix."},{"file":"lib/cli.js","line":701,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"See the comment in SaferJsonClient.js. If we have it NOT handle \u0027{}\u0027 there, then we could handling it here. Something like:\n\n```\n} else if (isEmptyMsg(err.message)) {\n...\n```\n\nwhere \u0027isEmptyMsg\u0027 is true for undefined, empty string, and \u0027{}\u0027."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"lib/cli.js","type":"MODIFIED","insertions":18,"deletions":-5}],"sizeInsertions":30,"sizeDeletions":-14},{"number":"3","revision":"b277289e0e11a8d84a3fe4886f1cfb630fae7f30","parents":["76759e547e67d0c45970bb881f90ae9a82912c77"],"ref":"refs/changes/35/1235/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484261676,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484261709,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/cli.js","type":"MODIFIED","insertions":37,"deletions":-6}],"sizeInsertions":49,"sizeDeletions":-9},{"number":"4","revision":"ca469895dbf0eaf212fd366edcb65de2d28e5222","parents":["37d475ffd95c2552bb7bfe100cf78860f3152a81"],"ref":"refs/changes/35/1235/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484266654,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484261709,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/cli.js","type":"MODIFIED","insertions":37,"deletions":-6}],"sizeInsertions":49,"sizeDeletions":-9},{"number":"5","revision":"8f80c68641f241f8d2cc8c9dc1431b3e065b384c","parents":["da80542222844002e95daba45171308aa0be03be"],"ref":"refs/changes/35/1235/5","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484353598,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484261709,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/cli.js","type":"MODIFIED","insertions":37,"deletions":-6}],"sizeInsertions":49,"sizeDeletions":-9},{"number":"6","revision":"d99110553d768226f9fb30765e37738d9a4427b3","parents":["da80542222844002e95daba45171308aa0be03be"],"ref":"refs/changes/35/1235/6","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1484353655,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484261709,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484266421,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1484353714,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/SaferJsonClient.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/cli.js","type":"MODIFIED","insertions":37,"deletions":-6}],"sizeInsertions":49,"sizeDeletions":-9}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}