From 129a8ab439b5400cad9d5d1f4069316a209e59f3 Mon Sep 17 00:00:00 2001
From: dyep49 <dyep49@gmail.com>
Date: Mon, 11 Jun 2018 12:38:09 -0700
Subject: [PATCH] TRITON-474 Use node-triton-metrics for NAPI metrics
 collection

---
 boot/setup.sh                |  5 ++++-
 docs/index.md                |  6 +++++-
 lib/napi.js                  | 22 +++++++++++++++++++++-
 package.json                 |  4 +++-
 sapi_manifests/napi/template |  4 ++++
 5 files changed, 37 insertions(+), 4 deletions(-)

diff --git a/boot/setup.sh b/boot/setup.sh
index 043aeab..fdb2be2 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -7,7 +7,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
@@ -38,6 +38,9 @@ sdc_log_rotation_add registrar /var/svc/log/*registrar*.log 1g
 sdc_log_rotation_add $role /var/svc/log/*$role*.log 1g
 sdc_log_rotation_setup_end
 
+# Add metricsPorts metadata for cmon-agent discovery
+mdata-put metricPorts 8881
+
 # All done, run boilerplate end-of-setup
 sdc_setup_complete
 
diff --git a/docs/index.md b/docs/index.md
index c40262e..dd5a2ab 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -10,7 +10,7 @@ markdown2extras: tables, code-friendly, fenced-code-blocks
 -->
 
 <!--
-    Copyright 2017, Joyent, Inc.
+    Copyright 2018, Joyent, Inc.
 -->
 
 # Networking API (NAPI)
@@ -1694,6 +1694,10 @@ there is no more need to call the API.
 If an invalid limit or offset is specified, then a 400-series error will
 be generated with a detailed message describing the error.
 
+# Metrics
+
+NAPI exposes metrics via [node-triton-metrics](https://github.com/joyent/node-triton-metrics) on `http://<ADMIN_IP>:8881/metrics.`
+
 # Changelog
 
 ## 2012-07-04
diff --git a/lib/napi.js b/lib/napi.js
index 4eb9b8f..465a301 100644
--- a/lib/napi.js
+++ b/lib/napi.js
@@ -16,6 +16,7 @@
 
 var assert = require('assert-plus');
 var constants = require('./util/constants');
+var createMetricsManager = require('triton-metrics').createMetricsManager;
 var endpoints = require('./endpoints');
 var EffluentLogger = require('effluent-logger');
 var http = require('http');
@@ -38,7 +39,7 @@ var VError = require('verror');
 // --- Globals
 
 
-
+var METRICS_SERVER_PORT = 8881;
 var USAGE_PERIOD = 8 * 60 * 60 * 1000; // 8 hours
 var PKG = require('../package.json');
 var request_seq_id = 0;
@@ -93,6 +94,22 @@ function NAPI(opts) {
     http.globalAgent.maxSockets = maxSockets;
     https.globalAgent.maxSockets = maxSockets;
 
+    var metricsManager = createMetricsManager({
+        address: opts.config.adminIp,
+        log: opts.log.child({component: 'metrics'}),
+        port: METRICS_SERVER_PORT,
+        restify: restify,
+        staticLabels: {
+            datacenter: opts.config.datacenter,
+            instance: opts.config.instanceUuid,
+            server: opts.config.serverUuid,
+            service: opts.config.serviceName
+        }
+    });
+
+    metricsManager.createRestifyMetrics();
+    metricsManager.listen(function metricsServerStarted() {});
+
     function populateReq(req, res, next) {
         req.config = opts.config;
         req.app = self;
@@ -180,6 +197,9 @@ function NAPI(opts) {
         })(req, res, route, err);
     });
 
+    server.on('after', metricsManager.collectRestifyMetrics
+        .bind(metricsManager));
+
     endpoints.registerEndpoints(server, before, this.log);
 
     mod_mooremachine.FSM.call(this, 'waiting');
diff --git a/package.json b/package.json
index afc80e4..6ccbeca 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "napi",
   "description": "SmartDataCenter Networking API",
-  "version": "1.2.1",
+  "version": "1.3.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -13,6 +13,7 @@
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
     "ip6addr": "0.2.2",
     "jsprim": "1.4.0",
+    "libuuid": "^0.2.1",
     "lomstream": "1.1.0",
     "macaddr": "0.0.1",
     "mooremachine": "2.2.0",
@@ -24,6 +25,7 @@
     "sdc-clients": "9.2.0",
     "tape": "4.5.1",
     "trace-event": "1.3.0",
+    "triton-metrics": "0.1.1",
     "vasync": "1.6.4",
     "verror": "1.9.0"
   },
diff --git a/sapi_manifests/napi/template b/sapi_manifests/napi/template
index 8f4d18d..b998f60 100644
--- a/sapi_manifests/napi/template
+++ b/sapi_manifests/napi/template
@@ -1,6 +1,10 @@
 {
   "port": 80,
   "datacenter": "{{{datacenter_name}}}",
+  "serviceName": "{{SERVICE_NAME}}",
+  "instanceUuid": "{{auto.ZONENAME}}",
+  "serverUuid": "{{auto.SERVER_UUID}}",
+  "adminIp": "{{auto.ADMIN_IP}}",
   "logLevel": "{{{NAPI_LOG_LEVEL}}}",
   "autoAllocSubnets": false,
   "useNetAgent": true,
-- 
2.21.0

