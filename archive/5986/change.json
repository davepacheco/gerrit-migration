{"project":"joyent/sdc-agents-core","branch":"master","id":"I55895a61e72ac6c01cf587d05cde38025bc01893","number":"5986","subject":"TRITON-1314 sdc-agents-core does not need sdcnode Reviewed by: Tim Foster \u003ctim.foster@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/5986","commitMessage":"TRITON-1314 sdc-agents-core does not need sdcnode\nReviewed by: Tim Foster \u003ctim.foster@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1553041734,"lastUpdated":1554840092,"open":false,"status":"MERGED","comments":[{"timestamp":1553041734,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1553041735,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit a981a9b2f00459b6ab43e0f60b072dd322fe39f8\n    \n    which npm to use... that is the question\n    \n    commit ab900d9b251fc1456e89485a30ac405ae7221ae0\n    \n    more missing magic\n    \n    commit edf449db1a4b2de4668b86544165f80f16d8400d\n    \n    the sdcnode build here isn\u0027t used and isn\u0027t included in the package, removing"},{"timestamp":1553041780,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1553120259,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1553120260,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 020444a9af8bfd58aaf19b9ef5f01fd01c6bf1d0\n    \n    add comment"},{"timestamp":1553126615,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(3 comments)\n\nWaiting for others\u0027 opinion."},{"timestamp":1553127324,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1553127325,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 7a74fab4fce974833c7c6b23bf5fee144e1d79d1\n    \n    update based on CR comments"},{"timestamp":1553127332,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1553137568,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1553177743,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 4:\n\nI\u0027m not sure I understand what sdc-agents-core does from the one line description.  I see that it at best works accidentally.\n\nThere isn\u0027t (since TOOLS-2036) a default NPM on jenkins-agents.  I guess v0.10.x would be the closest to \"correct\" if it mattered?  I think the comment could have a more explicit warning that any changes to dependencies is likely to blow it all up."},{"timestamp":1553179956,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(1 comment)\n\n\u003e There isn\u0027t (since TOOLS-2036) a default NPM on jenkins-agents.\n\nWell, other than the /opt/tools/bin copy, used only by tools that run during the build - we don\u0027t (and very likely shouldn\u0027t) deliver /opt/tools in any actual components."},{"timestamp":1553718670,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1553718837,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n\u003e I\u0027m not sure I understand what sdc-agents-core does from the one\n \u003e line description.  I see that it at best works accidentally.\n \u003e \n \u003e There isn\u0027t (since TOOLS-2036) a default NPM on jenkins-agents.  I\n \u003e guess v0.10.x would be the closest to \"correct\" if it mattered?  I\n \u003e think the comment could have a more explicit warning that any\n \u003e changes to dependencies is likely to blow it all up.\n\nI\u0027m not sure which one line description you\u0027re talking about since your comment was not tied to a line of my change.\n\nI could add a comment to the Makefile saying that if there is no npm in the path, or the npm in the path is unable to install node packages, this will not work. I\u0027ll do that. Thanks."},{"timestamp":1553718999,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1553719000,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 940d34b2b32c9a33147e7bdcffa43a514e47669c\n    \n    address review comments"},{"timestamp":1553719177,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1553719178,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit b770023c81f58f3257cb1cc268ae8986f73c362f\n    \n    address review comments\n    \n    commit a68f065db9223522cd42b0dd858183a56c360df6\n    \n    update based on CR comments\n    \n    commit cf021e3abaae79254569e0e1c52acac4e9cba420\n    \n    add comment\n    \n    commit 5a733d877605a4ee2cf02ae3f86a17183ccb3caa\n    \n    which npm to use... that is the question\n    \n    commit b6540add8a2947b8e3eee582f1560e0c5f111007\n    \n    more missing magic\n    \n    commit bed7f41eca8fdd151fa976a6a55dffdb28eeb355\n    \n    the sdcnode build here isn\u0027t used and isn\u0027t included in the package, removing"},{"timestamp":1554748010,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6:\n\nIt\u0027d be nice if we had some way to guard against potential future inclusion of binary dependencies such that we would need to start bundling a known version of node again.\nIs there any way to set an $NPM_ENVBLAH to some dummy value such that any attempt to compile a node binary module would blow up?"},{"timestamp":1554752334,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 7."},{"timestamp":1554752335,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 437505c62f60a5d726b2f5c157ce1fa6c5c08ffd\n    \n    should pass now\n    \n    commit cd21552c0dbc69376108c643d47986f163bf0fd3\n    \n    fix logic\n    \n    commit f1910446a460240d8c5d32dea35058750a3cf78d\n    \n    oops\n    \n    commit 1c92578a4ae0a5f419aec39f484b6f7636e74d6c\n    \n    cleaner?\n    \n    commit 38d6b57b9516d63ad9c14647295666dc49ad245e\n    \n    experiment\n    \n    commit 2f8b5d8717a4567b1b0ab79b173d4ffdccd59e52\n    \n    break it for testing\n    \n    commit 92ef143ea4c8ebc69a75be0b855859f33d84a935\n    \n    add guard"},{"timestamp":1554805794,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1554838694,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1554840084,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1554840092,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"8","revision":"55895a61e72ac6c01cf587d05cde38025bc01893","parents":["610caf105f6fbc80ab4b95d476370e1fa92547b5"],"ref":"refs/changes/86/5986/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1554840084,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554805794,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554838694,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554838694,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1554840092,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":17,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":18,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"10d5ce39f8be1c47ff9e3ec8bade541780ba4ef7","parents":["8cfd32cb0a491a2585ceb5a93d3f7422994fbab7"],"ref":"refs/changes/86/5986/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1553041734,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-19},{"number":"2","revision":"eb732875bdf0af18a59af1251fbab17bc12e64c8","parents":["8cfd32cb0a491a2585ceb5a93d3f7422994fbab7"],"ref":"refs/changes/86/5986/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1553041780,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-19},{"number":"3","revision":"6c1671c1386d0f10c35ebb296b91d15d088e7a2a","parents":["8cfd32cb0a491a2585ceb5a93d3f7422994fbab7"],"ref":"refs/changes/86/5986/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1553120259,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"Makefile","line":29,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm... This breaks down if there are any node module version compat issues btwn (a) the version of node used for this `npm install` and the (b) the version of node used to run the scripts distributed by agents_core (assuming they use these agents_core/node_modules.  As you pointed out in the ticket comments: there aren\u0027t any binary modules here... and there won\u0027t be because no way is agents_core getting more work on it.\n\nThis was already the case, however. Wow this is poor -- the dangerous experimental years of SDC\u0027s youth.\n\nI feel like I\u0027d at least want a ticket to show that we\u0027re getting rid of agents_core and point to it on this ticket to show that justification.\n\n*Or* we could continue to use sdcnode here to not have that \"there must be an external `npm` on the path\" dep... but just update to a more current sdcnode. I\u0027m easy, personally."},{"file":"Makefile","line":29,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"That\u0027s why the previous comment said \"should be the same as the platform\u0027s [node]\"... But like you say, that\u0027s been broken for years now since it was updated to 0.12 (AGENT-1015) and then before that because node was *too old* (it was 0.8.20 then). To be correct we should use an sdcnode 0.10.26 since that\u0027s the node on all currently supported platforms.\n\nI\u0027d love to just drop agents_core altogether but we have to wait I think until CA is gone everywhere. So 3-5 years probably.\n\nOtherwise, I don\u0027t really care what the solution is. Let me know what you\u0027d like me to do."},{"file":"Makefile","line":29,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why CA? Because one of the CA agents uses the agents_core/bin/ scripts?  With TRITON-884 in, can we break that... even if the operator of the DC hasn\u0027t yet run \u0027sdcadm experimental remove-ca\u0027?"},{"file":"Makefile","line":29,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Looking at the CA script in some more detail, it seems that it does handle the case where amqp-config is missing. So perhaps we\u0027re actually fine there. At that point the only other things I\u0027m aware of that use agents_core are:\n\n * the shar (which could be changed to use cn-agent instead)\n * sdc-healthcheck (which uses ping-agent to check on Ur)"},{"file":"Makefile","line":31,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Shouldn\u0027t need this. This is for VM components, IIUC."},{"file":"Makefile","line":31,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"We do need this currently. Build fails otherwise complaining that you need either BASE_IMAGE_UUID or NODE_PREBUILT_IMAGE when checking that the environment is ok to do a build. (I tried first without it.)"},{"file":"Makefile","line":31,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Weird. Tim, is that a bug?\n\nAh, from looking at validate-buildenv.sh it is about determining if the current build zone has a compatible pkgsrc. However, for a package that will run in the GZ, pkgsrc compat isn\u0027t relevant. For those agents that use node, their sdcnode (even tho it is of type NODE_PREBUILT_TAG\u003dgz) is used as a proxy for this. Tim, perhaps validate-buildenv.sh could change to be okay with any pkgsrc if the Makefile has neither of these two vars?\n\nThat could be done separately from this change and we could ust add a note that BASE_IIMAGE_UUID is here just to workaround that coming ticket."},{"file":"Makefile","line":31,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I\u0027ll file a bug.\n\nThe more useful thing would be to have component Makefiles declare which pkgsrc version they should build on, because that\u0027d be more generally useful if we had things that did have dependencies on stuff in /opt/local.\n\nWithout that, the only place where the build machine version would be encoded would be the jenkins labels for that component, and I\u0027d much rather components were self-documenting and even if we _think_ there are no dependencies on /opt/local, having everyone build a given component on the same flavoured devzone would be good."},{"file":"Makefile","line":48,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"can drop this one. It won\u0027t be defined."},{"file":"Makefile","line":48,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":5,"deletions":-17},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-18},{"number":"4","revision":"84da0dd598d2299909bb6f250446466e8062ef64","parents":["8cfd32cb0a491a2585ceb5a93d3f7422994fbab7"],"ref":"refs/changes/86/5986/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1553127324,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":7,"sizeDeletions":-19},{"number":"5","revision":"adad18e35ad0181683325437cecd7b9b70736459","parents":["8cfd32cb0a491a2585ceb5a93d3f7422994fbab7"],"ref":"refs/changes/86/5986/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1553718999,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":9,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":10,"sizeDeletions":-19},{"number":"6","revision":"0c790492f47c8da395954ffba0811dd7c383a7fa","parents":["610caf105f6fbc80ab4b95d476370e1fa92547b5"],"ref":"refs/changes/86/5986/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1553719177,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":9,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":10,"sizeDeletions":-19},{"number":"7","revision":"26c7d62e3feb6bfc49918d5c7ac5fe4b7864ed62","parents":["610caf105f6fbc80ab4b95d476370e1fa92547b5"],"ref":"refs/changes/86/5986/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1554752334,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554838694,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554838694,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554805794,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":17,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":18,"sizeDeletions":-19},{"number":"8","revision":"55895a61e72ac6c01cf587d05cde38025bc01893","parents":["610caf105f6fbc80ab4b95d476370e1fa92547b5"],"ref":"refs/changes/86/5986/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1554840084,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554838694,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554838694,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1554840092,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554805794,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":17,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":18,"sizeDeletions":-19}],"allReviewers":[{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}