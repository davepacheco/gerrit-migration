From 71c6b0efaf194a52005ce900c2d7f3877b9bd632 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 13 Dec 2016 16:57:35 +0100
Subject: [PATCH] joyent/node-manta#294 content-length and transfer-encoding
 chunked must not be used together

---
 CHANGES.md    | 3 ++-
 lib/client.js | 4 +++-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 8c4b6ee..e54025e 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -3,7 +3,8 @@
 ## not yet released
 
 - joyent/node-manta#293 '~~/' works, '~~' does now too.
-
+- joyent/node-manta#294 content-length and transfer-encoding chunked must not
+  be used together
 ## 4.1.0
 
 - joyent/node-manta#214 Add basic Bash completion for the `m*` tools.
diff --git a/lib/client.js b/lib/client.js
index 9fa1cea..19d59c3 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -721,7 +721,9 @@ MantaClient.prototype.chattr = function chattr(p, opts, cb) {
      * the Manta object. However a client-side fix is desireable so that
      * 'mchattr' can work with Manta webapis that don't have a fix.
      */
-    options.headers['transfer-encoding'] = 'chunked';
+    if (!options.headers['content-length']) {
+        options.headers['transfer-encoding'] = 'chunked';
+    }
 
     log.debug(options, 'chattr: entered');
     self.signRequest({
-- 
2.21.0

