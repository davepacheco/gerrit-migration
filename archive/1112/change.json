{"project":"joyent/node-manta","branch":"master","id":"I23cee39e13cf3f08bdff749b7a1e9720b23df564","number":"1112","subject":"joyent/node-manta#294 content-length and transfer-encoding chunked must not be used together Reviewed by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/1112","commitMessage":"joyent/node-manta#294 content-length and transfer-encoding chunked must not be used together\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1481644663,"lastUpdated":1482511906,"open":false,"status":"MERGED","comments":[{"timestamp":1481644663,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1481644693,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481740804,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\nIs the only reason for this for testing purposes?  We may want to update the comment accordingly.\n\nWhat if the caller uses \"Content-length\" or some other case?"},{"timestamp":1481803047,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNo, it\u0027s not only for testing purposes. The thing is that the addition of the transfer-encoding: chunked always makes invalid any HTTP request including content-length headers. We should just go through all the projects using node-manta in order to make sure none of them is setting content-length header when calling chattr, which I\u0027d say is more expensive than just wrap the header addition into a little conditional.\n\nOf course, this breaks muskie test case, which we could just remove if we agree that\u0027s the way to proceed if we hit this into any other projects.\n\nThe case question is a good one. I\u0027ll take a look"},{"timestamp":1481822635,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nI took a look at the case sensitivity or not of \u0027content-length\u0027 wording. It\u0027s completely case insensitive at that point, since it goes first through `createOptions - \u003e normalizeHeaders` which calls `toLowerCase()` for all the headers."},{"timestamp":1481918819,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n\u003e No, it\u0027s not only for testing purposes. The thing is that the\n \u003e addition of the transfer-encoding: chunked always makes invalid any\n \u003e HTTP request including content-length headers. We should just go\n \u003e through all the projects using node-manta in order to make sure\n \u003e none of them is setting content-length header when calling chattr,\n \u003e which I\u0027d say is more expensive than just wrap the header addition\n \u003e into a little conditional.\n \u003e \n \u003e Of course, this breaks muskie test case, which we could just remove\n \u003e if we agree that\u0027s the way to proceed if we hit this into any other\n \u003e projects.\n\n\nWhat I meant was: is there any reason a caller would specify content-length with a chattr() call other than for testing what the server does with that?  I\u0027m trying to figure out if that\u0027s a reasonable use case.  If not, it might be better to assert that it\u0027s not specified and then find another way to test it.  On the other hand, if that\u0027s a pain, then we can allow it solely for testing, but I\u0027d suggest adding a comment explaining that.\n\n\u003e I took a look at the case sensitivity or not of \u0027content-length\u0027 wording. It\u0027s completely case insensitive at that point, since it goes first through `createOptions - \u003e normalizeHeaders` which calls `toLowerCase()` for all the headers.\n\nThat makes sense.  Thanks for checking on that."},{"timestamp":1482162886,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nI took a look at our projects using node-manta and none of them is calling chattr with non testing purposes. Not sure about anything else which may be using node-manta as a library.\n\nEither if we pick the current solution (do not add chunked transfer coding if content-length is present) or if we take the one you suggest (fail the method call if somebody calls it with content-length option?) I\u0027m Ok with both. I\u0027d just remove the muskie test case if we take the latest approach, not sure if that would be of much value"},{"timestamp":1482363765,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n\u003e Either if we pick the current solution (do not add chunked transfer\n \u003e coding if content-length is present) or if we take the one you\n \u003e suggest (fail the method call if somebody calls it with\n \u003e content-length option?) I\u0027m Ok with both. I\u0027d just remove the\n \u003e muskie test case if we take the latest approach, not sure if that\n \u003e would be of much value\n\nWell, I do think the muskie test is worthwhile.  If there\u0027s no better way to test that, I\u0027m fine with leaving this in for testing -- with a comment explaining that.  Maybe something like: \"We only do this if content-length wasn\u0027t specified because it\u0027s not legal to specify chunked encoding with content-length.  Callers other than test suites wouldn\u0027t normally specify a content length for this request.\""},{"timestamp":1482420198,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1482420223,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1482420423,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nWell, the only way to test the behavior of the server when content-length header was specified from the client is through this approach so I\u0027ve added the comment as you suggested and pushed the new patch set.\n\nIf you\u0027re OK with that, I\u0027d like to publish a new version of node-manta to npm later so we can use it from muskie and move forward into MANTA-2999"},{"timestamp":1482451474,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1482511906,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"2","revision":"23cee39e13cf3f08bdff749b7a1e9720b23df564","parents":["be679872d17f9ff5405d0351866691788cec2f60"],"ref":"refs/changes/12/1112/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1482420198,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1482420223,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1482451474,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1482451474,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1482511906,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":13,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"71c6b0efaf194a52005ce900c2d7f3877b9bd632","parents":["be679872d17f9ff5405d0351866691788cec2f60"],"ref":"refs/changes/12/1112/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1481644663,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481644693,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":5,"sizeDeletions":-2},{"number":"2","revision":"23cee39e13cf3f08bdff749b7a1e9720b23df564","parents":["be679872d17f9ff5405d0351866691788cec2f60"],"ref":"refs/changes/12/1112/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1482420198,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1482451474,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1482451474,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1482420223,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1482511906,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":13,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}