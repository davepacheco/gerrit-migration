From af42ad1b7626892451745e97611f81877fe510ee Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 6 Oct 2017 10:54:06 -0700
Subject: [PATCH] OS-6383 'imgadm import UUID' crash: "Cannot read property
 'length' of undefined" in loadInstalledImages

---
 src/img/CHANGES.md    | 4 ++++
 src/img/lib/imgadm.js | 9 +++++++--
 src/img/package.json  | 2 +-
 3 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/img/CHANGES.md b/src/img/CHANGES.md
index 12f0f6f9..6c8cea16 100644
--- a/src/img/CHANGES.md
+++ b/src/img/CHANGES.md
@@ -6,6 +6,10 @@ Known issues:
   Docker Registry v1, which is now deprecated.
 
 
+## 3.7.3
+
+- OS-6383 Fix a possible crash in 'imgadm import ...'.
+
 ## 3.7.2
 
 - OS-6177 avoid checking content-md5 on imgadm import when a checksum exists on
diff --git a/src/img/lib/imgadm.js b/src/img/lib/imgadm.js
index 64e7c750..722d0ad5 100644
--- a/src/img/lib/imgadm.js
+++ b/src/img/lib/imgadm.js
@@ -1618,15 +1618,20 @@ IMGADM.prototype._importImage = function _importImage(opts, cb) {
             vasync.parallel({funcs: [
                 function loadInstalledImages(nextGather) {
                     TIME('loadImages');
-                    self._loadImages(function (err, imagesInfo) {
+                    self._loadImages(function onLoadImages(err, imagesInfo) {
                         TIME('loadImages');
+                        if (err) {
+                            nextGather(err);
+                            return;
+                        }
+
                         ctx.installedImageFromName = {};
                         for (var i = 0; i < imagesInfo.length; i++) {
                             var info = imagesInfo[i];
                             var name = info.zpool + '/' + info.manifest.uuid;
                             ctx.installedImageFromName[name] = info;
                         }
-                        nextGather(err);
+                        nextGather();
                     });
                 },
 
diff --git a/src/img/package.json b/src/img/package.json
index c9e0ba5b..02fabf3a 100644
--- a/src/img/package.json
+++ b/src/img/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgadm",
   "description": "Manage SmartOS virtual machine images.",
-  "version": "3.7.2",
+  "version": "3.7.3",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

