{"project":"joyent/node-cueball","branch":"master","id":"I68a79d8623ec1ae6c8572c3d0b2dcfefb40097cf","number":"376","subject":"joyent/node-cueball#5 would like higher-level pool states exposed to consumers joyent/node-cueball#12 constructor should throw when timeout policy could be \u003e 1 day Reviewed by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/376","commitMessage":"joyent/node-cueball#5 would like higher-level pool states exposed to consumers\njoyent/node-cueball#12 constructor should throw when timeout policy could be \u003e 1 day\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1472511261,"lastUpdated":1472756663,"open":false,"status":"MERGED","comments":[{"timestamp":1472511261,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1472511304,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1472511312,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1472511383,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472511473,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1472511568,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472514446,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1472514533,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472518263,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(4 comments)\n\nI haven\u0027t reviewed lib/pool.js, but wanted to get this part out today."},{"timestamp":1472521172,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1472604243,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1472604267,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1472604422,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 6."},{"timestamp":1472604531,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472667600,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\n(6 comments)"},{"timestamp":1472700161,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 7."},{"timestamp":1472700266,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472700412,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 7:\n\nMost of the getState() calls  are now isInState() calls to avoid using .indexOf() directly (to handle sub-states like stopping.backends). The errors given off by async claim() are now done after a setImmediate(). Also, I went and tested this on a bunch of different node 0.10, 0.12, 4.4 and 6.3 builds and it seems to all be working."},{"timestamp":1472747832,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1472756649,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 8: Commit message was updated."},{"timestamp":1472756655,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1472756663,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"8","revision":"2ec1a3180569cb89f06a4fe3330aba4bee634e1f","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472756649,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472700266,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472747832,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472756655,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1472756663,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":48,"deletions":-5},{"file":"lib/agent.js","type":"MODIFIED","insertions":95,"deletions":-18},{"file":"lib/errors.js","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":271,"deletions":-52},{"file":"lib/utils.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":467,"sizeDeletions":-79},"patchSets":[{"number":"1","revision":"84ebe939f864b53716860f481720f8a6ad866303","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472511261,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1472511304,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/agent.js","line":103,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer sock hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":37,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":161,"deletions":-46}],"sizeInsertions":209,"sizeDeletions":-48},{"number":"2","revision":"1dbd762ae7e333b651a3f732efb2a6a8199ab51a","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472511312,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472511383,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":37,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":161,"deletions":-46}],"sizeInsertions":209,"sizeDeletions":-48},{"number":"3","revision":"f35fbfb28a26b3ddd04b85cedf2818a385c3f774","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472511473,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472511568,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":153,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is specifically \"attempting to connect to all backends\", right?"},{"file":"README.md","line":156,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"You can also call .stop() from failed, right?"},{"file":"README.md","line":163,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Since the retry policy for connects has failed, is the only way this could happen if the resolver emitted a new backend?"},{"file":"lib/agent.js","line":110,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"On Node 0.10, it\u0027s a no-op to call setKeepAlive() before the connection is established.  You have to wait for it to become connected:\n\nhttps://github.com/nodejs/node-v0.x-archive/issues/21079\nhttps://github.com/nodejs/node-v0.x-archive/issues/8572\n\nThis may apply to 0.12, too -- I can\u0027t tell from the comments."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":37,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":161,"deletions":-46}],"sizeInsertions":209,"sizeDeletions":-48},{"number":"4","revision":"f34b30b5edd11f3a6414ac0f577a77968f8970db","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472514446,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472514533,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pool.js","line":685,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it possible for us to wind up in \"failed\", then attempt to establish a connection (e.g., because the resolver emitted a new backend), then have the resolver fail, then actually establish that connection?  If so, what state would we wind up in?  Or is the assumption that we\u0027re going to be \u0027failed\u0027 as long as the resolver is \u0027failed\u0027, and if it\u0027s not failed, then it should emit something we can connect to?"},{"file":"lib/pool.js","line":699,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m not sure what the logic around closedSinceLastOpen is trying to do. Can you explain that?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":37,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":161,"deletions":-46}],"sizeInsertions":209,"sizeDeletions":-48},{"number":"5","revision":"59202ef7369d5857b305e4f89beb124e78ab58ff","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472604243,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1472604267,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/utils.js","line":61,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: redeclaration of mult"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/agent.js","type":"MODIFIED","insertions":36,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":246,"deletions":-48},{"file":"lib/utils.js","type":"MODIFIED","insertions":22,"deletions":0}],"sizeInsertions":375,"sizeDeletions":-54},{"number":"6","revision":"34b9ae48a966037199835f981aba66061d898665","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472604422,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472604531,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":200,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we say \"operational\" error so that people don\u0027t think this is illegal (i.e., a programmer error)?  I assume the callback is called asynchronously, not in the context of the call to claim()?"},{"file":"lib/agent.js","line":247,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I suspect this won\u0027t be actionable, but is the interface for this object (namely, a socket as emitted by agents and used by the Node HTTP implementation) well-specified enough to know that we\u0027ve implemented the right set of methods correctly here?\n\nThis makes me nervous because we went through this with streams before those interfaces were well-specified, and there were all kinds of ad-hoc ways of implementing fake streams that worked in some contexts but not others or that broke when upgrading Node.  I suspect these interfaces are not well-specified, but that there\u0027s nothing we can really do about it anyway."},{"file":"lib/pool.js","line":115,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is the \"getState() \u003d\u003d\u003d \u0027closed\u0027 \u0026\u0026\" part of the condition because if this.cf_retriesLeft \u003d\u003d\u003d 0 but the connection is in state \u0027idle\u0027 (for example), we want to consider that _not_ exhausted?"},{"file":"lib/pool.js","line":846,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this just trying to catch both \u0027stopped\u0027 and \u0027stopping\u0027?  I think it would be much clearer to write that out."},{"file":"lib/pool.js","line":1039,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"As I mentioned in the README, I really don\u0027t think we should do this synchronously.  This goes against Node\u0027s recommendations for error handling as well as the ones that we put together.  (The reason is that it\u0027s harder for callers to handle this correctly, and it\u0027s hard to discover that you haven\u0027t until it happens.)"},{"file":"lib/pool.js","line":1059,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I didn\u0027t notice this before, but the above applies here too, and possibly at 1054."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/agent.js","type":"MODIFIED","insertions":36,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":246,"deletions":-48},{"file":"lib/utils.js","type":"MODIFIED","insertions":24,"deletions":0}],"sizeInsertions":377,"sizeDeletions":-54},{"number":"7","revision":"68a79d8623ec1ae6c8572c3d0b2dcfefb40097cf","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472700161,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472747832,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472700266,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":48,"deletions":-5},{"file":"lib/agent.js","type":"MODIFIED","insertions":95,"deletions":-18},{"file":"lib/errors.js","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":271,"deletions":-52},{"file":"lib/utils.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":467,"sizeDeletions":-79},{"number":"8","revision":"2ec1a3180569cb89f06a4fe3330aba4bee634e1f","parents":["2fcd8e84975f860f2011016e3718b5aa1449aa62"],"ref":"refs/changes/76/376/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1472756649,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472747832,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472756655,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1472756663,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472700266,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":48,"deletions":-5},{"file":"lib/agent.js","type":"MODIFIED","insertions":95,"deletions":-18},{"file":"lib/errors.js","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/pool-monitor.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":271,"deletions":-52},{"file":"lib/utils.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":467,"sizeDeletions":-79}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}