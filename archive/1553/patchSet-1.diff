From d1a5591b6902084ffbcf01389b19f051a2966beb Mon Sep 17 00:00:00 2001
From: brittany <brittany.wald@joyent.com>
Date: Wed, 22 Feb 2017 17:53:54 +0000
Subject: [PATCH] MANTA-3057 'manta-adm show' could sort better

---
 cmd/manta-adm.js         |  7 ++---
 lib/adm.js               |  8 ++++--
 test/tst.adm_show.js.out | 56 ++++++++++++++++++++--------------------
 test/tst.adm_show_cli.js | 56 ++++++++++++++++++++++++++++++++++++++++
 4 files changed, 94 insertions(+), 33 deletions(-)
 create mode 100644 test/tst.adm_show_cli.js

diff --git a/cmd/manta-adm.js b/cmd/manta-adm.js
index b4bc330..790d200 100755
--- a/cmd/manta-adm.js
+++ b/cmd/manta-adm.js
@@ -301,9 +301,10 @@ MantaAdm.prototype.do_show = function (subcmd, opts, args, callback)
 		}
 	}
 
-	if (args.length > 1) {
-		callback(new Error('unexpected arguments'));
-		return;
+	if (args.length > 1 || (args.length > 0 &&
+		!(Object.keys(opts).forEach(function (x) { })))) {
+			callback(new Error('unexpected arguments'));
+			return;
 	}
 
 	if (args.length > 0)
diff --git a/lib/adm.js b/lib/adm.js
index d341b93..d5e57ca 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -1086,7 +1086,7 @@ maAdm.prototype.dumpDeployedZonesByCn = function (sout, conf)
 	var self = this;
 	var comparators, rows, colnames, columns, stream, last, gz, hide;
 
-	comparators = [ 'GZ HOST', 'SERVICE', 'SHARD', 'ZONENAME' ];
+	comparators = [ 'GZ HOST', 'SERVICE', 'SH', 'ZONENAME' ];
 	rows = sortObjectsByProps(this.ma_instances_flattened.slice(0),
 	    comparators);
 	colnames = [ 'indent', 'service', 'shard', 'zonename' ];
@@ -1131,6 +1131,8 @@ maAdm.prototype.dumpDeployedConfigByService = function (sout, conf)
 	var colnames, columns;
 
 	self = this;
+	var comparators = ['SH'];
+
 	svcuuids = Object.keys(this.ma_config_bycfg).sort(function (s1, s2) {
 		return (self.ma_services[s1]['name'].localeCompare(
 		    self.ma_services[s2]['name']));
@@ -1148,6 +1150,8 @@ maAdm.prototype.dumpDeployedConfigByService = function (sout, conf)
 
 	svcuuids.forEach(function (svcid) {
 		var s = self.ma_config_bycfg[svcid];
+		sortObjectsByProps(s.sc_counts, comparators);
+
 		s.each(function (row) {
 			if (conf.filter && conf.filter != row['SERVICE'])
 				return;
@@ -2500,7 +2504,7 @@ function sortObjectsByProps(rows, comparators)
 			comp = comparators[c];
 			v1 = i1[comp];
 			v2 = i2[comp];
-			rv = typeof (v1) == 'string' ?
+			rv = ((typeof (v1) == 'string') && isNaN(v1)) ?
 			    v1.localeCompare(v2) : v1 - v2;
 			if (rv !== 0)
 				return (rv);
diff --git a/test/tst.adm_show.js.out b/test/tst.adm_show.js.out
index 37fb057..7b14c50 100644
--- a/test/tst.adm_show.js.out
+++ b/test/tst.adm_show.js.out
@@ -70,26 +70,26 @@ test case "manta-adm show -c"
 CN TEST-1-CN001                         test-1-cn001 test-1-cn001.example.com
      SERVICE          SH ZONENAME                            
      marlin            1 instance001                         
+     marlin            1 instance002                         
+     marlin            1 instance003                         
+     marlin            1 instance004                         
+     marlin            1 instance005                         
+     marlin            1 instance006                         
      marlin            1 instance007                         
-     marlin            1 instance010                         
-     marlin            1 instance009                         
      marlin            1 instance008                         
-     marlin            1 instance006                         
-     marlin            1 instance005                         
-     marlin            1 instance004                         
-     marlin            1 instance003                         
-     marlin            1 instance002                         
+     marlin            1 instance009                         
+     marlin            1 instance010                         
      medusa            1 instance020                         
      medusa            1 instance021                         
      moray             1 instance011                         
+     moray             1 instance012                         
+     moray             1 instance013                         
      moray             2 instance014                         
      moray             2 instance015                         
-     moray             3 instance019                         
-     moray             3 instance018                         
-     moray             1 instance013                         
      moray             2 instance016                         
      moray             3 instance017                         
-     moray             1 instance012                         
+     moray             3 instance018                         
+     moray             3 instance019                         
 CN TEST-1-CN002                         test-1-cn002 test-1-cn002.example.com
      SERVICE          SH ZONENAME                            
      marlin            1 instance022                         
@@ -102,36 +102,36 @@ CN TEST-1-CN002                         test-1-cn002 test-1-cn002.example.com
      marlin            1 instance029                         
      marlin            1 instance030                         
      marlin            1 instance031                         
-     moray             3 instance039                         
-     moray             1 instance033                         
      moray             1 instance032                         
-     moray             3 instance040                         
-     moray             3 instance038                         
-     moray             2 instance037                         
-     moray             2 instance036                         
-     moray             2 instance035                         
+     moray             1 instance033                         
      moray             1 instance034                         
+     moray             2 instance035                         
+     moray             2 instance036                         
+     moray             2 instance037                         
+     moray             3 instance038                         
+     moray             3 instance039                         
+     moray             3 instance040                         
 CN TEST-1-CN003                         test-1-cn003 test-1-cn003.example.com
      SERVICE          SH ZONENAME                            
-     marlin            1 instance049                         
-     marlin            1 instance044                         
      marlin            1 instance041                         
-     marlin            1 instance050                         
-     marlin            1 instance043                         
      marlin            1 instance042                         
+     marlin            1 instance043                         
+     marlin            1 instance044                         
      marlin            1 instance045                         
      marlin            1 instance046                         
      marlin            1 instance047                         
      marlin            1 instance048                         
+     marlin            1 instance049                         
+     marlin            1 instance050                         
+     postgres          1 instance051                         
      postgres          1 instance052                         
      postgres          1 instance053                         
-     postgres          1 instance051                         
-     postgres          3 instance059                         
-     postgres          3 instance058                         
-     postgres          3 instance057                         
-     postgres          2 instance056                         
-     postgres          2 instance055                         
      postgres          2 instance054                         
+     postgres          2 instance055                         
+     postgres          2 instance056                         
+     postgres          3 instance057                         
+     postgres          3 instance058                         
+     postgres          3 instance059                         
 CN TEST-1-CN004                         test-1-cn004 test-1-cn004.example.com
      SERVICE          SH ZONENAME                            
      marlin            1 instance060                         
diff --git a/test/tst.adm_show_cli.js b/test/tst.adm_show_cli.js
new file mode 100644
index 0000000..e354946
--- /dev/null
+++ b/test/tst.adm_show_cli.js
@@ -0,0 +1,56 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2016, Joyent, Inc.
+ */
+
+/*
+ * tst.adm_show_cli.js: tests manta-adm show cli functionality
+ */
+
+var assert = require('assert');
+var cmdutil = require('cmdutil');
+var forkexec = require('forkexec');
+var path = require('path');
+var vasync = require('vasync');
+var VError = require('verror').VError;
+
+var execname = path.join(__dirname, '../bin/manta-adm');
+var argname = 'show';
+
+function main() {
+	runTests();
+}
+
+function runTests() {
+
+	var testCases = [
+		testCaseUnexpectedArgument
+	];
+
+	vasync.waterfall(testCases, function (err) {
+		if (err) {
+			cmdutil.fail(err);
+		}
+	});
+
+}
+
+function testCaseUnexpectedArgument(cb) {
+
+	forkexec.forkExecWait({
+		'argv': [ process.execPath, execname, argname, 'foo' ]
+	}, function (err, info) {
+		assert.ok(err);
+		assert.ok(/^manta-adm show: error: unexpected arguments/.
+			test(info['stderr']));
+		cb();
+	});
+
+}
+
+main();
-- 
2.21.0

