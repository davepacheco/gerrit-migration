commit 7d56fe37c61feb5ebeb3cadc2d4dccc0547636d6 (refs/changes/53/1553/5)
Author: brittany <brittany.wald@joyent.com>
Date:   2017-03-01T22:07:15+00:00 (2 years, 7 months ago)
    
    MANTA-3057 'manta-adm show' could sort better

diff --git a/lib/adm.js b/lib/adm.js
index d341b93..984a7e0 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -213,7 +213,7 @@ function zkColumnNames()
  *     o "genconfig" operation: call loadSdcConfig, then fetchDeployed, then
  *       one of dumpConfigCoal, dumpConfigLab, or genconfigFromFile.
  *
- *     o "show" operation: call loadSdcConfig, then fetchDeployed, then then one
+ *     o "show" operation: call loadSdcConfig, then fetchDeployed, then one
  *       or more of the dumpDeployed* family of functions.
  *
  *     o "update" operation: call loadSdcConfig, then readConfigFromFile, then
@@ -1053,8 +1053,8 @@ maAdm.prototype.dumpDeployedZonesByService = function (sout, conf)
 	var comparators, rows, colnames, columns, stream;
 
 	comparators = [ 'SERVICE', 'SH', 'DATACENTER', 'ZONENAME' ];
-	rows = sortObjectsByProps(this.ma_instances_flattened.slice(0),
-	    comparators);
+	rows = common.sortObjectsByProps(
+		this.ma_instances_flattened.slice(0), comparators);
 
 	if (conf.columns)
 		colnames = conf.columns;
@@ -1086,9 +1086,9 @@ maAdm.prototype.dumpDeployedZonesByCn = function (sout, conf)
 	var self = this;
 	var comparators, rows, colnames, columns, stream, last, gz, hide;
 
-	comparators = [ 'GZ HOST', 'SERVICE', 'SHARD', 'ZONENAME' ];
-	rows = sortObjectsByProps(this.ma_instances_flattened.slice(0),
-	    comparators);
+	comparators = [ 'GZ HOST', 'SERVICE', 'SH', 'ZONENAME' ];
+	rows = common.sortObjectsByProps(
+		this.ma_instances_flattened.slice(0), comparators);
 	colnames = [ 'indent', 'service', 'shard', 'zonename' ];
 	if (conf.doall)
 		colnames.splice(3, 0, 'datacenter');
@@ -1131,6 +1131,8 @@ maAdm.prototype.dumpDeployedConfigByService = function (sout, conf)
 	var colnames, columns;
 
 	self = this;
+	var comparators = ['SH'];
+
 	svcuuids = Object.keys(this.ma_config_bycfg).sort(function (s1, s2) {
 		return (self.ma_services[s1]['name'].localeCompare(
 		    self.ma_services[s2]['name']));
@@ -1148,7 +1150,8 @@ maAdm.prototype.dumpDeployedConfigByService = function (sout, conf)
 
 	svcuuids.forEach(function (svcid) {
 		var s = self.ma_config_bycfg[svcid];
-		s.each(function (row) {
+
+		s.eachSorted(comparators, function (row) {
 			if (conf.filter && conf.filter != row['SERVICE'])
 				return;
 
@@ -2484,28 +2487,3 @@ maAdm.prototype.auditZkServers = function ()
 
 	return (rv);
 };
-
-
-/*
- * Utility functions (which could be moved to a common file)
- */
-
-function sortObjectsByProps(rows, comparators)
-{
-	return (rows.sort(function (i1, i2) {
-		var c, comp;
-		var v1, v2, rv;
-
-		for (c = 0; c < comparators.length; c++) {
-			comp = comparators[c];
-			v1 = i1[comp];
-			v2 = i2[comp];
-			rv = typeof (v1) == 'string' ?
-			    v1.localeCompare(v2) : v1 - v2;
-			if (rv !== 0)
-				return (rv);
-		}
-
-		return (0);
-	}));
-}
diff --git a/lib/common.js b/lib/common.js
index 0ab83b2..2d81d1b 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2015 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 /*
@@ -638,6 +638,28 @@ function stripe(lists)
 	return (rv);
 }
 
+/*
+ * Utility function to sort objects for dumping
+ * by service configuration or compute node
+ */
+function sortObjectsByProps(rows, comparators)
+{
+	return (rows.sort(function (i1, i2) {
+		var c, comp;
+		var v1, v2, rv;
+		for (c = 0; c < comparators.length; c++) {
+			comp = comparators[c];
+			v1 = i1[comp];
+			v2 = i2[comp];
+			assert.ok(typeof (v1) == typeof (v2));
+			rv = (typeof (v1) == 'string' && isNaN(v1)) ?
+			    v1.localeCompare(v2) : v1 - v2;
+			if (rv !== 0)
+				return (rv);
+		}
+	}));
+}
+
 exports.shuffle = shuffle;
 exports.domainToPath = domainToPath;
 exports.initLogger = initLogger;
@@ -651,3 +673,4 @@ exports.getOrCreateComputeId = getOrCreateComputeId;
 exports.commandExecute = commandExecute;
 exports.insert = insert;
 exports.stripe = stripe;
+exports.sortObjectsByProps = sortObjectsByProps;
diff --git a/lib/services.js b/lib/services.js
index 5856e01..7ee7aa3 100644
--- a/lib/services.js
+++ b/lib/services.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -137,6 +137,23 @@ ServiceConfiguration.prototype.each = function (callback)
 	});
 };
 
+/*
+ * Sort configuration by specified column. "c" is an array of comparators
+ * e.g. "SERVICE", "SH", "ZONENAME", "callback" is the same object as in
+ * the `each` function above, called for each configuration -- the
+ * comparators (keys) and their corresponding values.
+ */
+ServiceConfiguration.prototype.eachSorted = function (c, callback)
+{
+	var self = this;
+	var sc_counts_dup = this.sc_counts.slice();
+	common.sortObjectsByProps(sc_counts_dup, config);
+	sc_counts_dup.forEach(function (config) {
+		callback(config, self.sc_keys.map(function (k) {
+			return (config[k]); }));
+	});
+};
+
 /*
  * Get the count of services having the specified configuration.  "config"
  * should be an object with the same fields passed in the constructor.
diff --git a/test/tst.adm_show.js b/test/tst.adm_show.js
index 93fbda5..08fc1ca 100644
--- a/test/tst.adm_show.js
+++ b/test/tst.adm_show.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -63,7 +63,17 @@ var fakeDeployed = {
 	'moray': {
 	    '1': { 'img002': 3 },
 	    '2': { 'img002': 3 },
-	    '3': { 'img002': 3 }
+	    '3': { 'img002': 3 },
+	    '4': { 'img002': 3 },
+	    '5': { 'img002': 3 },
+	    '6': { 'img002': 3 },
+	    '7': { 'img002': 3 },
+	    '8': { 'img002': 3 },
+	    '9': { 'img002': 3 },
+	    '10': { 'img002': 3 },
+	    '11': { 'img002': 3 },
+	    '12': { 'img002': 3 },
+	    '13': { 'img002': 3 }
 	}
     },
     'cn003': {
diff --git a/test/tst.adm_show.js.out b/test/tst.adm_show.js.out
index 37fb057..06687d5 100644
--- a/test/tst.adm_show.js.out
+++ b/test/tst.adm_show.js.out
@@ -21,18 +21,18 @@ marlin            1 instance028                          test-1-cn002.example.co
 marlin            1 instance029                          test-1-cn002.example.com
 marlin            1 instance030                          test-1-cn002.example.com
 marlin            1 instance031                          test-1-cn002.example.com
-marlin            1 instance041                          test-1-cn003.example.com
-marlin            1 instance042                          test-1-cn003.example.com
-marlin            1 instance043                          test-1-cn003.example.com
-marlin            1 instance044                          test-1-cn003.example.com
-marlin            1 instance045                          test-1-cn003.example.com
-marlin            1 instance046                          test-1-cn003.example.com
-marlin            1 instance047                          test-1-cn003.example.com
-marlin            1 instance048                          test-1-cn003.example.com
-marlin            1 instance049                          test-1-cn003.example.com
-marlin            1 instance050                          test-1-cn003.example.com
-marlin            1 instance060                          test-1-cn004.example.com
-marlin            1 instance061                          test-1-cn004.example.com
+marlin            1 instance071                          test-1-cn003.example.com
+marlin            1 instance072                          test-1-cn003.example.com
+marlin            1 instance073                          test-1-cn003.example.com
+marlin            1 instance074                          test-1-cn003.example.com
+marlin            1 instance075                          test-1-cn003.example.com
+marlin            1 instance076                          test-1-cn003.example.com
+marlin            1 instance077                          test-1-cn003.example.com
+marlin            1 instance078                          test-1-cn003.example.com
+marlin            1 instance079                          test-1-cn003.example.com
+marlin            1 instance080                          test-1-cn003.example.com
+marlin            1 instance090                          test-1-cn004.example.com
+marlin            1 instance091                          test-1-cn004.example.com
 medusa            1 instance020                          test-1-cn001.example.com
 medusa            1 instance021                          test-1-cn001.example.com
 moray             1 instance011                          test-1-cn001.example.com
@@ -53,43 +53,73 @@ moray             3 instance019                          test-1-cn001.example.co
 moray             3 instance038                          test-1-cn002.example.com
 moray             3 instance039                          test-1-cn002.example.com
 moray             3 instance040                          test-1-cn002.example.com
-postgres          1 instance051                          test-1-cn003.example.com
-postgres          1 instance052                          test-1-cn003.example.com
-postgres          1 instance053                          test-1-cn003.example.com
-postgres          1 instance062                          test-1-cn004.example.com
-postgres          2 instance054                          test-1-cn003.example.com
-postgres          2 instance055                          test-1-cn003.example.com
-postgres          2 instance056                          test-1-cn003.example.com
-postgres          2 instance063                          test-1-cn004.example.com
-postgres          3 instance057                          test-1-cn003.example.com
-postgres          3 instance058                          test-1-cn003.example.com
-postgres          3 instance059                          test-1-cn003.example.com
+moray             4 instance041                          test-1-cn002.example.com
+moray             4 instance042                          test-1-cn002.example.com
+moray             4 instance043                          test-1-cn002.example.com
+moray             5 instance044                          test-1-cn002.example.com
+moray             5 instance045                          test-1-cn002.example.com
+moray             5 instance046                          test-1-cn002.example.com
+moray             6 instance047                          test-1-cn002.example.com
+moray             6 instance048                          test-1-cn002.example.com
+moray             6 instance049                          test-1-cn002.example.com
+moray             7 instance050                          test-1-cn002.example.com
+moray             7 instance051                          test-1-cn002.example.com
+moray             7 instance052                          test-1-cn002.example.com
+moray             8 instance053                          test-1-cn002.example.com
+moray             8 instance054                          test-1-cn002.example.com
+moray             8 instance055                          test-1-cn002.example.com
+moray             9 instance056                          test-1-cn002.example.com
+moray             9 instance057                          test-1-cn002.example.com
+moray             9 instance058                          test-1-cn002.example.com
+moray            10 instance059                          test-1-cn002.example.com
+moray            10 instance060                          test-1-cn002.example.com
+moray            10 instance061                          test-1-cn002.example.com
+moray            11 instance062                          test-1-cn002.example.com
+moray            11 instance063                          test-1-cn002.example.com
+moray            11 instance064                          test-1-cn002.example.com
+moray            12 instance065                          test-1-cn002.example.com
+moray            12 instance066                          test-1-cn002.example.com
+moray            12 instance067                          test-1-cn002.example.com
+moray            13 instance068                          test-1-cn002.example.com
+moray            13 instance069                          test-1-cn002.example.com
+moray            13 instance070                          test-1-cn002.example.com
+postgres          1 instance081                          test-1-cn003.example.com
+postgres          1 instance082                          test-1-cn003.example.com
+postgres          1 instance083                          test-1-cn003.example.com
+postgres          1 instance092                          test-1-cn004.example.com
+postgres          2 instance084                          test-1-cn003.example.com
+postgres          2 instance085                          test-1-cn003.example.com
+postgres          2 instance086                          test-1-cn003.example.com
+postgres          2 instance093                          test-1-cn004.example.com
+postgres          3 instance087                          test-1-cn003.example.com
+postgres          3 instance088                          test-1-cn003.example.com
+postgres          3 instance089                          test-1-cn003.example.com
 --------------------------------------------------
 --------------------------------------------------
 test case "manta-adm show -c"
 CN TEST-1-CN001                         test-1-cn001 test-1-cn001.example.com
      SERVICE          SH ZONENAME                            
      marlin            1 instance001                         
+     marlin            1 instance002                         
+     marlin            1 instance003                         
+     marlin            1 instance004                         
+     marlin            1 instance005                         
+     marlin            1 instance006                         
      marlin            1 instance007                         
-     marlin            1 instance010                         
-     marlin            1 instance009                         
      marlin            1 instance008                         
-     marlin            1 instance006                         
-     marlin            1 instance005                         
-     marlin            1 instance004                         
-     marlin            1 instance003                         
-     marlin            1 instance002                         
+     marlin            1 instance009                         
+     marlin            1 instance010                         
      medusa            1 instance020                         
      medusa            1 instance021                         
      moray             1 instance011                         
+     moray             1 instance012                         
+     moray             1 instance013                         
      moray             2 instance014                         
      moray             2 instance015                         
-     moray             3 instance019                         
-     moray             3 instance018                         
-     moray             1 instance013                         
      moray             2 instance016                         
      moray             3 instance017                         
-     moray             1 instance012                         
+     moray             3 instance018                         
+     moray             3 instance019                         
 CN TEST-1-CN002                         test-1-cn002 test-1-cn002.example.com
      SERVICE          SH ZONENAME                            
      marlin            1 instance022                         
@@ -102,42 +132,72 @@ CN TEST-1-CN002                         test-1-cn002 test-1-cn002.example.com
      marlin            1 instance029                         
      marlin            1 instance030                         
      marlin            1 instance031                         
-     moray             3 instance039                         
-     moray             1 instance033                         
      moray             1 instance032                         
-     moray             3 instance040                         
-     moray             3 instance038                         
-     moray             2 instance037                         
-     moray             2 instance036                         
-     moray             2 instance035                         
+     moray             1 instance033                         
      moray             1 instance034                         
+     moray             2 instance035                         
+     moray             2 instance036                         
+     moray             2 instance037                         
+     moray             3 instance038                         
+     moray             3 instance039                         
+     moray             3 instance040                         
+     moray             4 instance041                         
+     moray             4 instance042                         
+     moray             4 instance043                         
+     moray             5 instance044                         
+     moray             5 instance045                         
+     moray             5 instance046                         
+     moray             6 instance047                         
+     moray             6 instance048                         
+     moray             6 instance049                         
+     moray             7 instance050                         
+     moray             7 instance051                         
+     moray             7 instance052                         
+     moray             8 instance053                         
+     moray             8 instance054                         
+     moray             8 instance055                         
+     moray             9 instance056                         
+     moray             9 instance057                         
+     moray             9 instance058                         
+     moray            10 instance059                         
+     moray            10 instance060                         
+     moray            10 instance061                         
+     moray            11 instance062                         
+     moray            11 instance063                         
+     moray            11 instance064                         
+     moray            12 instance065                         
+     moray            12 instance066                         
+     moray            12 instance067                         
+     moray            13 instance068                         
+     moray            13 instance069                         
+     moray            13 instance070                         
 CN TEST-1-CN003                         test-1-cn003 test-1-cn003.example.com
      SERVICE          SH ZONENAME                            
-     marlin            1 instance049                         
-     marlin            1 instance044                         
-     marlin            1 instance041                         
-     marlin            1 instance050                         
-     marlin            1 instance043                         
-     marlin            1 instance042                         
-     marlin            1 instance045                         
-     marlin            1 instance046                         
-     marlin            1 instance047                         
-     marlin            1 instance048                         
-     postgres          1 instance052                         
-     postgres          1 instance053                         
-     postgres          1 instance051                         
-     postgres          3 instance059                         
-     postgres          3 instance058                         
-     postgres          3 instance057                         
-     postgres          2 instance056                         
-     postgres          2 instance055                         
-     postgres          2 instance054                         
+     marlin            1 instance071                         
+     marlin            1 instance072                         
+     marlin            1 instance073                         
+     marlin            1 instance074                         
+     marlin            1 instance075                         
+     marlin            1 instance076                         
+     marlin            1 instance077                         
+     marlin            1 instance078                         
+     marlin            1 instance079                         
+     marlin            1 instance080                         
+     postgres          1 instance081                         
+     postgres          1 instance082                         
+     postgres          1 instance083                         
+     postgres          2 instance084                         
+     postgres          2 instance085                         
+     postgres          2 instance086                         
+     postgres          3 instance087                         
+     postgres          3 instance088                         
+     postgres          3 instance089                         
 CN TEST-1-CN004                         test-1-cn004 test-1-cn004.example.com
      SERVICE          SH ZONENAME                            
-     marlin            1 instance060                         
-     marlin            1 instance061                         
-     postgres          1 instance062                         
-     postgres          2 instance063                         
+     marlin            1 instance090                         
+     marlin            1 instance091                         
+     postgres          1 instance092                         
+     postgres          2 instance093                         
 --------------------------------------------------
 --------------------------------------------------
 test case "manta-adm show -s"
@@ -147,6 +207,16 @@ medusa            1 -                                              2
 moray             1 master002                                      6
 moray             2 master002                                      6
 moray             3 master002                                      6
+moray             4 master002                                      3
+moray             5 master002                                      3
+moray             6 master002                                      3
+moray             7 master002                                      3
+moray             8 master002                                      3
+moray             9 master002                                      3
+moray            10 master002                                      3
+moray            11 master002                                      3
+moray            12 master002                                      3
+moray            13 master002                                      3
 postgres          1 master003                                      4
 postgres          2 master003                                      4
 postgres          3 master003                                      3
@@ -174,175 +244,265 @@ marlin            1 test-1     instance028
 marlin            1 test-1     instance029                         
 marlin            1 test-1     instance030                         
 marlin            1 test-1     instance031                         
-marlin            1 test-1     instance041                         
-marlin            1 test-1     instance042                         
-marlin            1 test-1     instance043                         
-marlin            1 test-1     instance044                         
-marlin            1 test-1     instance045                         
-marlin            1 test-1     instance046                         
-marlin            1 test-1     instance047                         
-marlin            1 test-1     instance048                         
-marlin            1 test-1     instance049                         
-marlin            1 test-1     instance050                         
-marlin            1 test-1     instance060                         
-marlin            1 test-1     instance061                         
-marlin            1 test-2     instance064                         
-marlin            1 test-2     instance065                         
-marlin            1 test-2     instance066                         
-marlin            1 test-2     instance067                         
-marlin            1 test-2     instance068                         
-marlin            1 test-2     instance069                         
-marlin            1 test-2     instance070                         
-marlin            1 test-2     instance071                         
-marlin            1 test-2     instance072                         
-marlin            1 test-2     instance073                         
-marlin            1 test-2     instance085                         
-marlin            1 test-2     instance086                         
-marlin            1 test-2     instance087                         
-marlin            1 test-2     instance088                         
-marlin            1 test-2     instance089                         
-marlin            1 test-2     instance090                         
-marlin            1 test-2     instance091                         
-marlin            1 test-2     instance092                         
-marlin            1 test-2     instance093                         
+marlin            1 test-1     instance071                         
+marlin            1 test-1     instance072                         
+marlin            1 test-1     instance073                         
+marlin            1 test-1     instance074                         
+marlin            1 test-1     instance075                         
+marlin            1 test-1     instance076                         
+marlin            1 test-1     instance077                         
+marlin            1 test-1     instance078                         
+marlin            1 test-1     instance079                         
+marlin            1 test-1     instance080                         
+marlin            1 test-1     instance090                         
+marlin            1 test-1     instance091                         
 marlin            1 test-2     instance094                         
-marlin            1 test-2     instance104                         
-marlin            1 test-2     instance105                         
-marlin            1 test-2     instance106                         
-marlin            1 test-2     instance107                         
-marlin            1 test-2     instance108                         
-marlin            1 test-2     instance109                         
-marlin            1 test-2     instance110                         
-marlin            1 test-2     instance111                         
-marlin            1 test-2     instance112                         
-marlin            1 test-2     instance113                         
+marlin            1 test-2     instance095                         
+marlin            1 test-2     instance096                         
+marlin            1 test-2     instance097                         
+marlin            1 test-2     instance098                         
+marlin            1 test-2     instance099                         
+marlin            1 test-2     instance100                         
+marlin            1 test-2     instance101                         
+marlin            1 test-2     instance102                         
+marlin            1 test-2     instance103                         
+marlin            1 test-2     instance115                         
+marlin            1 test-2     instance116                         
+marlin            1 test-2     instance117                         
+marlin            1 test-2     instance118                         
+marlin            1 test-2     instance119                         
+marlin            1 test-2     instance120                         
+marlin            1 test-2     instance121                         
+marlin            1 test-2     instance122                         
 marlin            1 test-2     instance123                         
 marlin            1 test-2     instance124                         
-marlin            1 test-3     instance127                         
-marlin            1 test-3     instance128                         
-marlin            1 test-3     instance129                         
-marlin            1 test-3     instance130                         
-marlin            1 test-3     instance131                         
-marlin            1 test-3     instance132                         
-marlin            1 test-3     instance133                         
-marlin            1 test-3     instance134                         
-marlin            1 test-3     instance135                         
-marlin            1 test-3     instance136                         
-marlin            1 test-3     instance148                         
-marlin            1 test-3     instance149                         
-marlin            1 test-3     instance150                         
-marlin            1 test-3     instance151                         
-marlin            1 test-3     instance152                         
-marlin            1 test-3     instance153                         
-marlin            1 test-3     instance154                         
-marlin            1 test-3     instance155                         
-marlin            1 test-3     instance156                         
-marlin            1 test-3     instance157                         
-marlin            1 test-3     instance167                         
-marlin            1 test-3     instance168                         
-marlin            1 test-3     instance169                         
-marlin            1 test-3     instance170                         
-marlin            1 test-3     instance171                         
-marlin            1 test-3     instance172                         
-marlin            1 test-3     instance173                         
-marlin            1 test-3     instance174                         
-marlin            1 test-3     instance175                         
-marlin            1 test-3     instance176                         
-marlin            1 test-3     instance186                         
+marlin            1 test-2     instance164                         
+marlin            1 test-2     instance165                         
+marlin            1 test-2     instance166                         
+marlin            1 test-2     instance167                         
+marlin            1 test-2     instance168                         
+marlin            1 test-2     instance169                         
+marlin            1 test-2     instance170                         
+marlin            1 test-2     instance171                         
+marlin            1 test-2     instance172                         
+marlin            1 test-2     instance173                         
+marlin            1 test-2     instance183                         
+marlin            1 test-2     instance184                         
 marlin            1 test-3     instance187                         
+marlin            1 test-3     instance188                         
+marlin            1 test-3     instance189                         
+marlin            1 test-3     instance190                         
+marlin            1 test-3     instance191                         
+marlin            1 test-3     instance192                         
+marlin            1 test-3     instance193                         
+marlin            1 test-3     instance194                         
+marlin            1 test-3     instance195                         
+marlin            1 test-3     instance196                         
+marlin            1 test-3     instance208                         
+marlin            1 test-3     instance209                         
+marlin            1 test-3     instance210                         
+marlin            1 test-3     instance211                         
+marlin            1 test-3     instance212                         
+marlin            1 test-3     instance213                         
+marlin            1 test-3     instance214                         
+marlin            1 test-3     instance215                         
+marlin            1 test-3     instance216                         
+marlin            1 test-3     instance217                         
+marlin            1 test-3     instance257                         
+marlin            1 test-3     instance258                         
+marlin            1 test-3     instance259                         
+marlin            1 test-3     instance260                         
+marlin            1 test-3     instance261                         
+marlin            1 test-3     instance262                         
+marlin            1 test-3     instance263                         
+marlin            1 test-3     instance264                         
+marlin            1 test-3     instance265                         
+marlin            1 test-3     instance266                         
+marlin            1 test-3     instance276                         
+marlin            1 test-3     instance277                         
 medusa            1 test-1     instance020                         
 medusa            1 test-1     instance021                         
-medusa            1 test-2     instance083                         
-medusa            1 test-2     instance084                         
-medusa            1 test-3     instance146                         
-medusa            1 test-3     instance147                         
+medusa            1 test-2     instance113                         
+medusa            1 test-2     instance114                         
+medusa            1 test-3     instance206                         
+medusa            1 test-3     instance207                         
 moray             1 test-1     instance011                         
 moray             1 test-1     instance012                         
 moray             1 test-1     instance013                         
 moray             1 test-1     instance032                         
 moray             1 test-1     instance033                         
 moray             1 test-1     instance034                         
-moray             1 test-2     instance074                         
-moray             1 test-2     instance075                         
-moray             1 test-2     instance076                         
-moray             1 test-2     instance095                         
-moray             1 test-2     instance096                         
-moray             1 test-2     instance097                         
-moray             1 test-3     instance137                         
-moray             1 test-3     instance138                         
-moray             1 test-3     instance139                         
-moray             1 test-3     instance158                         
-moray             1 test-3     instance159                         
-moray             1 test-3     instance160                         
+moray             1 test-2     instance104                         
+moray             1 test-2     instance105                         
+moray             1 test-2     instance106                         
+moray             1 test-2     instance125                         
+moray             1 test-2     instance126                         
+moray             1 test-2     instance127                         
+moray             1 test-3     instance197                         
+moray             1 test-3     instance198                         
+moray             1 test-3     instance199                         
+moray             1 test-3     instance218                         
+moray             1 test-3     instance219                         
+moray             1 test-3     instance220                         
 moray             2 test-1     instance014                         
 moray             2 test-1     instance015                         
 moray             2 test-1     instance016                         
 moray             2 test-1     instance035                         
 moray             2 test-1     instance036                         
 moray             2 test-1     instance037                         
-moray             2 test-2     instance077                         
-moray             2 test-2     instance078                         
-moray             2 test-2     instance079                         
-moray             2 test-2     instance098                         
-moray             2 test-2     instance099                         
-moray             2 test-2     instance100                         
-moray             2 test-3     instance140                         
-moray             2 test-3     instance141                         
-moray             2 test-3     instance142                         
-moray             2 test-3     instance161                         
-moray             2 test-3     instance162                         
-moray             2 test-3     instance163                         
+moray             2 test-2     instance107                         
+moray             2 test-2     instance108                         
+moray             2 test-2     instance109                         
+moray             2 test-2     instance128                         
+moray             2 test-2     instance129                         
+moray             2 test-2     instance130                         
+moray             2 test-3     instance200                         
+moray             2 test-3     instance201                         
+moray             2 test-3     instance202                         
+moray             2 test-3     instance221                         
+moray             2 test-3     instance222                         
+moray             2 test-3     instance223                         
 moray             3 test-1     instance017                         
 moray             3 test-1     instance018                         
 moray             3 test-1     instance019                         
 moray             3 test-1     instance038                         
 moray             3 test-1     instance039                         
 moray             3 test-1     instance040                         
-moray             3 test-2     instance080                         
-moray             3 test-2     instance081                         
-moray             3 test-2     instance082                         
-moray             3 test-2     instance101                         
-moray             3 test-2     instance102                         
-moray             3 test-2     instance103                         
-moray             3 test-3     instance143                         
-moray             3 test-3     instance144                         
-moray             3 test-3     instance145                         
-moray             3 test-3     instance164                         
-moray             3 test-3     instance165                         
-moray             3 test-3     instance166                         
-postgres          1 test-1     instance051                         
-postgres          1 test-1     instance052                         
-postgres          1 test-1     instance053                         
-postgres          1 test-1     instance062                         
-postgres          1 test-2     instance114                         
-postgres          1 test-2     instance115                         
-postgres          1 test-2     instance116                         
-postgres          1 test-2     instance125                         
-postgres          1 test-3     instance177                         
-postgres          1 test-3     instance178                         
-postgres          1 test-3     instance179                         
-postgres          1 test-3     instance188                         
-postgres          2 test-1     instance054                         
-postgres          2 test-1     instance055                         
-postgres          2 test-1     instance056                         
-postgres          2 test-1     instance063                         
-postgres          2 test-2     instance117                         
-postgres          2 test-2     instance118                         
-postgres          2 test-2     instance119                         
-postgres          2 test-2     instance126                         
-postgres          2 test-3     instance180                         
-postgres          2 test-3     instance181                         
-postgres          2 test-3     instance182                         
-postgres          2 test-3     instance189                         
-postgres          3 test-1     instance057                         
-postgres          3 test-1     instance058                         
-postgres          3 test-1     instance059                         
-postgres          3 test-2     instance120                         
-postgres          3 test-2     instance121                         
-postgres          3 test-2     instance122                         
-postgres          3 test-3     instance183                         
-postgres          3 test-3     instance184                         
-postgres          3 test-3     instance185                         
+moray             3 test-2     instance110                         
+moray             3 test-2     instance111                         
+moray             3 test-2     instance112                         
+moray             3 test-2     instance131                         
+moray             3 test-2     instance132                         
+moray             3 test-2     instance133                         
+moray             3 test-3     instance203                         
+moray             3 test-3     instance204                         
+moray             3 test-3     instance205                         
+moray             3 test-3     instance224                         
+moray             3 test-3     instance225                         
+moray             3 test-3     instance226                         
+moray             4 test-1     instance041                         
+moray             4 test-1     instance042                         
+moray             4 test-1     instance043                         
+moray             4 test-2     instance134                         
+moray             4 test-2     instance135                         
+moray             4 test-2     instance136                         
+moray             4 test-3     instance227                         
+moray             4 test-3     instance228                         
+moray             4 test-3     instance229                         
+moray             5 test-1     instance044                         
+moray             5 test-1     instance045                         
+moray             5 test-1     instance046                         
+moray             5 test-2     instance137                         
+moray             5 test-2     instance138                         
+moray             5 test-2     instance139                         
+moray             5 test-3     instance230                         
+moray             5 test-3     instance231                         
+moray             5 test-3     instance232                         
+moray             6 test-1     instance047                         
+moray             6 test-1     instance048                         
+moray             6 test-1     instance049                         
+moray             6 test-2     instance140                         
+moray             6 test-2     instance141                         
+moray             6 test-2     instance142                         
+moray             6 test-3     instance233                         
+moray             6 test-3     instance234                         
+moray             6 test-3     instance235                         
+moray             7 test-1     instance050                         
+moray             7 test-1     instance051                         
+moray             7 test-1     instance052                         
+moray             7 test-2     instance143                         
+moray             7 test-2     instance144                         
+moray             7 test-2     instance145                         
+moray             7 test-3     instance236                         
+moray             7 test-3     instance237                         
+moray             7 test-3     instance238                         
+moray             8 test-1     instance053                         
+moray             8 test-1     instance054                         
+moray             8 test-1     instance055                         
+moray             8 test-2     instance146                         
+moray             8 test-2     instance147                         
+moray             8 test-2     instance148                         
+moray             8 test-3     instance239                         
+moray             8 test-3     instance240                         
+moray             8 test-3     instance241                         
+moray             9 test-1     instance056                         
+moray             9 test-1     instance057                         
+moray             9 test-1     instance058                         
+moray             9 test-2     instance149                         
+moray             9 test-2     instance150                         
+moray             9 test-2     instance151                         
+moray             9 test-3     instance242                         
+moray             9 test-3     instance243                         
+moray             9 test-3     instance244                         
+moray            10 test-1     instance059                         
+moray            10 test-1     instance060                         
+moray            10 test-1     instance061                         
+moray            10 test-2     instance152                         
+moray            10 test-2     instance153                         
+moray            10 test-2     instance154                         
+moray            10 test-3     instance245                         
+moray            10 test-3     instance246                         
+moray            10 test-3     instance247                         
+moray            11 test-1     instance062                         
+moray            11 test-1     instance063                         
+moray            11 test-1     instance064                         
+moray            11 test-2     instance155                         
+moray            11 test-2     instance156                         
+moray            11 test-2     instance157                         
+moray            11 test-3     instance248                         
+moray            11 test-3     instance249                         
+moray            11 test-3     instance250                         
+moray            12 test-1     instance065                         
+moray            12 test-1     instance066                         
+moray            12 test-1     instance067                         
+moray            12 test-2     instance158                         
+moray            12 test-2     instance159                         
+moray            12 test-2     instance160                         
+moray            12 test-3     instance251                         
+moray            12 test-3     instance252                         
+moray            12 test-3     instance253                         
+moray            13 test-1     instance068                         
+moray            13 test-1     instance069                         
+moray            13 test-1     instance070                         
+moray            13 test-2     instance161                         
+moray            13 test-2     instance162                         
+moray            13 test-2     instance163                         
+moray            13 test-3     instance254                         
+moray            13 test-3     instance255                         
+moray            13 test-3     instance256                         
+postgres          1 test-1     instance081                         
+postgres          1 test-1     instance082                         
+postgres          1 test-1     instance083                         
+postgres          1 test-1     instance092                         
+postgres          1 test-2     instance174                         
+postgres          1 test-2     instance175                         
+postgres          1 test-2     instance176                         
+postgres          1 test-2     instance185                         
+postgres          1 test-3     instance267                         
+postgres          1 test-3     instance268                         
+postgres          1 test-3     instance269                         
+postgres          1 test-3     instance278                         
+postgres          2 test-1     instance084                         
+postgres          2 test-1     instance085                         
+postgres          2 test-1     instance086                         
+postgres          2 test-1     instance093                         
+postgres          2 test-2     instance177                         
+postgres          2 test-2     instance178                         
+postgres          2 test-2     instance179                         
+postgres          2 test-2     instance186                         
+postgres          2 test-3     instance270                         
+postgres          2 test-3     instance271                         
+postgres          2 test-3     instance272                         
+postgres          2 test-3     instance279                         
+postgres          3 test-1     instance087                         
+postgres          3 test-1     instance088                         
+postgres          3 test-1     instance089                         
+postgres          3 test-2     instance180                         
+postgres          3 test-2     instance181                         
+postgres          3 test-2     instance182                         
+postgres          3 test-3     instance273                         
+postgres          3 test-3     instance274                         
+postgres          3 test-3     instance275                         
 --------------------------------------------------
 --------------------------------------------------
 test case "manta-adm show -H"
@@ -366,18 +526,18 @@ marlin            1 instance028                          test-1-cn002.example.co
 marlin            1 instance029                          test-1-cn002.example.com
 marlin            1 instance030                          test-1-cn002.example.com
 marlin            1 instance031                          test-1-cn002.example.com
-marlin            1 instance041                          test-1-cn003.example.com
-marlin            1 instance042                          test-1-cn003.example.com
-marlin            1 instance043                          test-1-cn003.example.com
-marlin            1 instance044                          test-1-cn003.example.com
-marlin            1 instance045                          test-1-cn003.example.com
-marlin            1 instance046                          test-1-cn003.example.com
-marlin            1 instance047                          test-1-cn003.example.com
-marlin            1 instance048                          test-1-cn003.example.com
-marlin            1 instance049                          test-1-cn003.example.com
-marlin            1 instance050                          test-1-cn003.example.com
-marlin            1 instance060                          test-1-cn004.example.com
-marlin            1 instance061                          test-1-cn004.example.com
+marlin            1 instance071                          test-1-cn003.example.com
+marlin            1 instance072                          test-1-cn003.example.com
+marlin            1 instance073                          test-1-cn003.example.com
+marlin            1 instance074                          test-1-cn003.example.com
+marlin            1 instance075                          test-1-cn003.example.com
+marlin            1 instance076                          test-1-cn003.example.com
+marlin            1 instance077                          test-1-cn003.example.com
+marlin            1 instance078                          test-1-cn003.example.com
+marlin            1 instance079                          test-1-cn003.example.com
+marlin            1 instance080                          test-1-cn003.example.com
+marlin            1 instance090                          test-1-cn004.example.com
+marlin            1 instance091                          test-1-cn004.example.com
 medusa            1 instance020                          test-1-cn001.example.com
 medusa            1 instance021                          test-1-cn001.example.com
 moray             1 instance011                          test-1-cn001.example.com
@@ -398,17 +558,47 @@ moray             3 instance019                          test-1-cn001.example.co
 moray             3 instance038                          test-1-cn002.example.com
 moray             3 instance039                          test-1-cn002.example.com
 moray             3 instance040                          test-1-cn002.example.com
-postgres          1 instance051                          test-1-cn003.example.com
-postgres          1 instance052                          test-1-cn003.example.com
-postgres          1 instance053                          test-1-cn003.example.com
-postgres          1 instance062                          test-1-cn004.example.com
-postgres          2 instance054                          test-1-cn003.example.com
-postgres          2 instance055                          test-1-cn003.example.com
-postgres          2 instance056                          test-1-cn003.example.com
-postgres          2 instance063                          test-1-cn004.example.com
-postgres          3 instance057                          test-1-cn003.example.com
-postgres          3 instance058                          test-1-cn003.example.com
-postgres          3 instance059                          test-1-cn003.example.com
+moray             4 instance041                          test-1-cn002.example.com
+moray             4 instance042                          test-1-cn002.example.com
+moray             4 instance043                          test-1-cn002.example.com
+moray             5 instance044                          test-1-cn002.example.com
+moray             5 instance045                          test-1-cn002.example.com
+moray             5 instance046                          test-1-cn002.example.com
+moray             6 instance047                          test-1-cn002.example.com
+moray             6 instance048                          test-1-cn002.example.com
+moray             6 instance049                          test-1-cn002.example.com
+moray             7 instance050                          test-1-cn002.example.com
+moray             7 instance051                          test-1-cn002.example.com
+moray             7 instance052                          test-1-cn002.example.com
+moray             8 instance053                          test-1-cn002.example.com
+moray             8 instance054                          test-1-cn002.example.com
+moray             8 instance055                          test-1-cn002.example.com
+moray             9 instance056                          test-1-cn002.example.com
+moray             9 instance057                          test-1-cn002.example.com
+moray             9 instance058                          test-1-cn002.example.com
+moray            10 instance059                          test-1-cn002.example.com
+moray            10 instance060                          test-1-cn002.example.com
+moray            10 instance061                          test-1-cn002.example.com
+moray            11 instance062                          test-1-cn002.example.com
+moray            11 instance063                          test-1-cn002.example.com
+moray            11 instance064                          test-1-cn002.example.com
+moray            12 instance065                          test-1-cn002.example.com
+moray            12 instance066                          test-1-cn002.example.com
+moray            12 instance067                          test-1-cn002.example.com
+moray            13 instance068                          test-1-cn002.example.com
+moray            13 instance069                          test-1-cn002.example.com
+moray            13 instance070                          test-1-cn002.example.com
+postgres          1 instance081                          test-1-cn003.example.com
+postgres          1 instance082                          test-1-cn003.example.com
+postgres          1 instance083                          test-1-cn003.example.com
+postgres          1 instance092                          test-1-cn004.example.com
+postgres          2 instance084                          test-1-cn003.example.com
+postgres          2 instance085                          test-1-cn003.example.com
+postgres          2 instance086                          test-1-cn003.example.com
+postgres          2 instance093                          test-1-cn004.example.com
+postgres          3 instance087                          test-1-cn003.example.com
+postgres          3 instance088                          test-1-cn003.example.com
+postgres          3 instance089                          test-1-cn003.example.com
 --------------------------------------------------
 --------------------------------------------------
 test case "manta-adm show -a -o service,datacenter,shard,version"
@@ -569,6 +759,96 @@ moray            test-3      3 -
 moray            test-3      3 -                                         
 moray            test-3      3 -                                         
 moray            test-3      3 -                                         
+moray            test-1      4 master002                                 
+moray            test-1      4 master002                                 
+moray            test-1      4 master002                                 
+moray            test-2      4 -                                         
+moray            test-2      4 -                                         
+moray            test-2      4 -                                         
+moray            test-3      4 -                                         
+moray            test-3      4 -                                         
+moray            test-3      4 -                                         
+moray            test-1      5 master002                                 
+moray            test-1      5 master002                                 
+moray            test-1      5 master002                                 
+moray            test-2      5 -                                         
+moray            test-2      5 -                                         
+moray            test-2      5 -                                         
+moray            test-3      5 -                                         
+moray            test-3      5 -                                         
+moray            test-3      5 -                                         
+moray            test-1      6 master002                                 
+moray            test-1      6 master002                                 
+moray            test-1      6 master002                                 
+moray            test-2      6 -                                         
+moray            test-2      6 -                                         
+moray            test-2      6 -                                         
+moray            test-3      6 -                                         
+moray            test-3      6 -                                         
+moray            test-3      6 -                                         
+moray            test-1      7 master002                                 
+moray            test-1      7 master002                                 
+moray            test-1      7 master002                                 
+moray            test-2      7 -                                         
+moray            test-2      7 -                                         
+moray            test-2      7 -                                         
+moray            test-3      7 -                                         
+moray            test-3      7 -                                         
+moray            test-3      7 -                                         
+moray            test-1      8 master002                                 
+moray            test-1      8 master002                                 
+moray            test-1      8 master002                                 
+moray            test-2      8 -                                         
+moray            test-2      8 -                                         
+moray            test-2      8 -                                         
+moray            test-3      8 -                                         
+moray            test-3      8 -                                         
+moray            test-3      8 -                                         
+moray            test-1      9 master002                                 
+moray            test-1      9 master002                                 
+moray            test-1      9 master002                                 
+moray            test-2      9 -                                         
+moray            test-2      9 -                                         
+moray            test-2      9 -                                         
+moray            test-3      9 -                                         
+moray            test-3      9 -                                         
+moray            test-3      9 -                                         
+moray            test-1     10 master002                                 
+moray            test-1     10 master002                                 
+moray            test-1     10 master002                                 
+moray            test-2     10 -                                         
+moray            test-2     10 -                                         
+moray            test-2     10 -                                         
+moray            test-3     10 -                                         
+moray            test-3     10 -                                         
+moray            test-3     10 -                                         
+moray            test-1     11 master002                                 
+moray            test-1     11 master002                                 
+moray            test-1     11 master002                                 
+moray            test-2     11 -                                         
+moray            test-2     11 -                                         
+moray            test-2     11 -                                         
+moray            test-3     11 -                                         
+moray            test-3     11 -                                         
+moray            test-3     11 -                                         
+moray            test-1     12 master002                                 
+moray            test-1     12 master002                                 
+moray            test-1     12 master002                                 
+moray            test-2     12 -                                         
+moray            test-2     12 -                                         
+moray            test-2     12 -                                         
+moray            test-3     12 -                                         
+moray            test-3     12 -                                         
+moray            test-3     12 -                                         
+moray            test-1     13 master002                                 
+moray            test-1     13 master002                                 
+moray            test-1     13 master002                                 
+moray            test-2     13 -                                         
+moray            test-2     13 -                                         
+moray            test-2     13 -                                         
+moray            test-3     13 -                                         
+moray            test-3     13 -                                         
+moray            test-3     13 -                                         
 postgres         test-1      1 master003                                 
 postgres         test-1      1 master003                                 
 postgres         test-1      1 master003                                 
@@ -638,6 +918,36 @@ test case "manta-adm show -js"
             },
             "3": {
                 "img002": 3
+            },
+            "4": {
+                "img002": 3
+            },
+            "5": {
+                "img002": 3
+            },
+            "6": {
+                "img002": 3
+            },
+            "7": {
+                "img002": 3
+            },
+            "8": {
+                "img002": 3
+            },
+            "9": {
+                "img002": 3
+            },
+            "10": {
+                "img002": 3
+            },
+            "11": {
+                "img002": 3
+            },
+            "12": {
+                "img002": 3
+            },
+            "13": {
+                "img002": 3
             }
         }
     },
