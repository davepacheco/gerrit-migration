{"project":"joyent/manta-muskie","branch":"master","topic":"3475","id":"Icc76d7a6d61344f2bbc707dc7d92568f7480f3a6","number":"2873","subject":"MANTA-3475 muskie should report 503 errors when moray hits its max queue length","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2873","commitMessage":"MANTA-3475 muskie should report 503 errors when moray hits its max queue length\n","createdOn":1508977952,"lastUpdated":1510013106,"open":false,"status":"MERGED","comments":[{"timestamp":1508977952,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1508977990,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508978054,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Topic set to 3475"},{"timestamp":1508979034,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1508979065,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509038731,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2:\n\n(1 comment)\n\nwow, this is so much simpler! nice!"},{"timestamp":1509042829,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1509042861,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509043496,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1509050843,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(2 comments)\n\nI have a couple review comments, but the IA testing from the muskie side of things seems good."},{"timestamp":1509056899,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1509057065,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1509058233,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1509124858,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1509128613,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1509128640,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509129747,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1509129774,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509129811,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1509129838,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509130067,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1509130094,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1509132022,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1509132053,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509132111,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 9."},{"timestamp":1509132138,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509132140,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 10: Patch Set 9 was rebased"},{"timestamp":1509132168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10:\n\n\"make check\" passed ok"},{"timestamp":1509137302,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 11."},{"timestamp":1509137328,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509142197,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 12: Patch Set 11 was rebased"},{"timestamp":1509142208,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 13."},{"timestamp":1509142224,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12:\n\n\"make check\" passed ok"},{"timestamp":1509142235,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509144286,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1509148404,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13:\n\n(2 comments)"},{"timestamp":1509155723,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 14."},{"timestamp":1509155750,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509385311,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 14: Code-Review+1"},{"timestamp":1509493440,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 14:\n\n(2 comments)"},{"timestamp":1509513599,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 15."},{"timestamp":1509513629,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509564151,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 16: Patch Set 15 was rebased"},{"timestamp":1509564178,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16:\n\n\"make check\" passed ok"},{"timestamp":1509570108,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 16:\n\n(4 comments)"},{"timestamp":1509576277,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 17."},{"timestamp":1509576305,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509577412,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 17: Code-Review+1\n\n(1 comment)"},{"timestamp":1509580625,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 18."},{"timestamp":1509580652,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509580686,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 18: Code-Review+1"},{"timestamp":1509641225,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 18:\n\nFor IA: What is the status on the testing on the newest patchset as compared to what\u0027s in the ticket?"},{"timestamp":1509660022,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 18:\n\nI updated the ticket, but the results are pretty much the same as previous working implementations."},{"timestamp":1509660025,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 19: Patch Set 18 was rebased"},{"timestamp":1509660053,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19:\n\n\"make check\" passed ok"},{"timestamp":1509750567,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 19: Integration-Approval+1"},{"timestamp":1509751771,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 19: Integration-Approval-1\n\nReverting until newest patchset passes the Moray test suite."},{"timestamp":1510004400,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 19: Integration-Approval+1"},{"timestamp":1510013079,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 20: Patch Set 19 was rebased"},{"timestamp":1510013085,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"},{"timestamp":1510013106,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"20","revision":"5aabef170d667adb088ee83a5e022fdfe9534405","parents":["e47e15153ea120a02e4db9feebe9906b1fcb1407"],"ref":"refs/changes/73/2873/20","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510013079,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509580652,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509580686,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510004400,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1510013085,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":61,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"7886cbba64f4307609e3c060536431682162d6e1","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508977952,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508977990,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-1}],"sizeInsertions":13,"sizeDeletions":-1},{"number":"2","revision":"224ae734dc9e3c8d6a929be5311173364195493c","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508979034,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508979065,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":577,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"It seems like it might be worth adding a simple test for the mappings performed in this file."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-1}],"sizeInsertions":16,"sizeDeletions":-3},{"number":"3","revision":"7d15f156a60e2e32f25ab3a7a9abc0fbbfe011d6","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509042829,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509042861,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509043496,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"comments":[{"file":"lib/server.js","line":51,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It seems odd to me that the semantics of a particular Moray error are baked into a function that appears to be creating the error body for all errors. Why not move this logic into the code dealing with the Moray error?"},{"file":"lib/server.js","line":51,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"This is the way that I hard original implemented this, but upon Dave\u0027s recommendation I moved it here. The reason is that there isn\u0027t another single point of error translation. Handling moray errors where they happen would require repeating this code block in 6-7 places throughout muskie, basically where the node-moray client is invoked. I think the reasoning is that since this is a relatively basic translation, the complexity cost of introducing it all over the place is too high.\n\nI\u0027m not sure about this, but I also think that the simple moray queue limit was a temporary measure to be replaced in the with more sophisticated queuing/rate-limiting."},{"file":"lib/server.js","line":51,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Okay, that makes sense. Let\u0027s add a comment explaining this? I don\u0027t think we can assume anything about the timeframe on introducing more sophisticated queueing, and given that both of us thought this code might be better-suited somewhere else, I think having the explanation in the source is really important."},{"file":"lib/server.js","line":55,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This seems better, but is there a particular reason that this goes here instead of in translateError() (which we call immediately after this?  It seems like that function has a bunch of cases similar to this (e.g., if we found X on the cause chain, translate that as a Y error for the client)."},{"file":"lib/server.js","line":217,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Now that we have an errors array, why not just check if errors.length \u003e 0 and do away with `ok` all together?"},{"file":"lib/server.js","line":217,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Because we would lose information provided by the last two branches in the block above, where ok reflects whether or not failure is necessary based on the type of request."},{"file":"lib/server.js","line":217,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Ah, I missed that. Thanks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":50,"sizeDeletions":-3},{"number":"4","revision":"303898f4dc59d9f4ec8ce5e4eb75c2f0335f2586","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509128613,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509128640,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-3},{"number":"5","revision":"a02f8d081c3fde8d0f273b83746490fdd24ccef3","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509129747,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509129774,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":15,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-3},{"number":"6","revision":"ce461e67087e926f9de79dc474c0a0421f6b87cc","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509129811,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509129838,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":15,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-3},{"number":"7","revision":"2d955f1413c2426e4b871cc05e0a479d62755d08","parents":["697fa22fbae8bdf61025e16584f3668254cc06d9"],"ref":"refs/changes/73/2873/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509130067,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509129838,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":15,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-3},{"number":"8","revision":"4d7239f19b62b4ac2dc0cb13a2b8a439498fe582","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509132022,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509132053,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":56,"sizeDeletions":-3},{"number":"9","revision":"d21d2fad2c9fbf922695d5aeb88bb3458c90800d","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509132111,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509132138,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-3},{"number":"10","revision":"392c7177947221383ae4b6bf28ba5c0ebd895922","parents":["697fa22fbae8bdf61025e16584f3668254cc06d9"],"ref":"refs/changes/73/2873/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509132140,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509132138,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-3},{"number":"11","revision":"b90cbcedd428437e79abeff2592aacd6e26e571a","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/11","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509137302,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509137328,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-3},{"number":"12","revision":"3d0d6201e675e28d274692116da6c1f35f793d92","parents":["697fa22fbae8bdf61025e16584f3668254cc06d9"],"ref":"refs/changes/73/2873/12","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509142197,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509137328,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-3},{"number":"13","revision":"955e0dce4ab99e3993e6b6226ce03173023ad6f2","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/13","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509142208,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509142235,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509144286,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"comments":[{"file":"lib/errors.js","line":646,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think what\u0027s more important to mention here is that Moray provides the \"overloaded\" property specifically in cases of overload, which we want to report to the client as a 503 (which is a transient availability issue) and not a 500 (which might imply a bug or other problem)."},{"file":"lib/errors.js","line":651,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I mentioned more details in the Moray change, but I think you probably want to construct a VError explicitly out of the properties on this object, because it won\u0027t actually be an instanceof Error by the time it gets here.  (At least, I wouldn\u0027t think so.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":15,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-3},{"number":"14","revision":"3686c029068ccfe3146da2e35ed23cf5c3896a2e","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/14","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509155723,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509155750,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509385311,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"comments":[{"file":"lib/errors.js","line":643,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same feedback as on PS13."},{"file":"lib/errors.js","line":649,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does this work if Moray reports a NoDatabasePeersError that _wasn\u0027t_ the result of an overload?\n\nI think you want to check that the context has a \"name\" and \"cause\" property with the right types.  This code shouldn\u0027t crash if Moray sends an empty context, for example."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-3},{"number":"15","revision":"e477860a48a5bccfda1e31793674fddd261189c5","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/15","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509513599,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509513629,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":59,"sizeDeletions":-3},{"number":"16","revision":"de053ce636816193aef9e1b4074dca4645cee1c7","parents":["697fa22fbae8bdf61025e16584f3668254cc06d9"],"ref":"refs/changes/73/2873/16","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509564151,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509513629,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":644,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"Moray\""},{"file":"lib/errors.js","line":649,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"Manta\""},{"file":"lib/errors.js","line":652,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks -- that comment looks great.\n\nThe indenting is strange on L652.\n\nNow that the comment spells out the semantics: should we also be changing that \"cause.context.name\" is the type of error we expect?  Or is that not worth it?"},{"file":"lib/errors.js","line":653,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027d recommend being a bit more defensive here and explicitly using something like:\n\n    new VError({\n        \"name\": cause.context.name\n    }, \u0027%s\u0027, cause.context.msg)\n\nOtherwise, if Moray later adds some field that a future VError constructor supports (or even one that it already supports), this could start blowing up.\n\nNow that I look at that more closely, I see you\u0027re expecting \"msg\" on the context.  But VError\u0027s constructor doesn\u0027t support that -- it doesn\u0027t even support passing the message as \"message\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":59,"sizeDeletions":-3},{"number":"17","revision":"61d77cc49d7a26a9743e81831d9110dcaa509c01","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/17","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509576277,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509577412,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509576305,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":652,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The indenting is still off here.\n\nSorry if I\u0027m jumping the gun."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":61,"sizeDeletions":-3},{"number":"18","revision":"cc76d7a6d61344f2bbc707dc7d92568f7480f3a6","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/73/2873/18","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509580625,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509580686,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509580652,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":61,"sizeDeletions":-3},{"number":"19","revision":"a0734fc89517bb2634453d17aeb08cda77b6b4f8","parents":["697fa22fbae8bdf61025e16584f3668254cc06d9"],"ref":"refs/changes/73/2873/19","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509660025,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509580686,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509580652,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510004400,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":61,"sizeDeletions":-3},{"number":"20","revision":"5aabef170d667adb088ee83a5e022fdfe9534405","parents":["e47e15153ea120a02e4db9feebe9906b1fcb1407"],"ref":"refs/changes/73/2873/20","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510013079,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509580686,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509580652,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510004400,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1510013085,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"test/errors.test.js","type":"ADDED","insertions":34,"deletions":0}],"sizeInsertions":61,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}