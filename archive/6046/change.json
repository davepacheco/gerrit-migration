{"project":"joyent/illumos-joyent","branch":"master","id":"I20d90778a4ab409186dd4be8c145927b407f79ab","number":"6046","subject":"OS-6731 expose microcode level as property on strand topo nodes","owner":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"url":"https://cr.joyent.us/6046","commitMessage":"OS-6731 expose microcode level as property on strand topo nodes\n","createdOn":1554404005,"lastUpdated":1561412667,"open":true,"status":"NEW","comments":[{"timestamp":1554404005,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 1."},{"timestamp":1554404315,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 2."},{"timestamp":1554409256,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1555694228,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 3."},{"timestamp":1555694323,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1555943123,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1555943475,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1561410627,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 4."},{"timestamp":1561410699,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 4:\n\n(2 comments)\n\nI also reworked the changes to the chip topo module to leverage the UFM stuff."},{"timestamp":1561412667,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(5 comments)\n\nSo I think the xpv handling of the microcode rev is still problematic. What I\u0027d suggest doing is instead change the signature of the cmi_get_ucode_rev to something like:\n\ncmi_errno_t cmi_get_ucode_rev(cmi_hdl_t, uint32_t *);\n\nAnd have cmi_get_ucode_rev return CMIERR_NOTSUP or similar if there is no implementation function like is the case today for xpv. This would get you out of the ifdef games and would make the cmio_ucode_rev be useful."}],"currentPatchSet":{"number":"4","revision":"20d90778a4ab409186dd4be8c145927b407f79ab","parents":["47478dccc69d4ee6c8753bc92430c6143d346300"],"ref":"refs/changes/46/6046/4","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1561410627,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","line":337,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I suspect we may have already hashed it out, but at least for Intel, the microcode exists on a per-core basis and is shared in the case of strands. Does it make sense to create the UFM on the strand and not the core still?"},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","line":339,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This appears to never be freed after creating the UFM. I\u0027d suggest initializing ucode_rev_str to NULL and unconditionally freeing it before the return at +354."},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","line":128,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we have the cmio_ucode_rev and functions if nothing actually calls and uses it now?"},{"file":"usr/src/uts/intel/io/devfm_machdep.c","line":208,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m confused about the most recent version. Right now this function (cmi_hdl_ucode_rev) is only defined under xpv. But there are no ifdefs here at all. How does that work?"},{"file":"usr/src/uts/intel/sys/cpu_module.h","line":169,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why isn\u0027t this under ifdef !xpv?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","type":"MODIFIED","insertions":20,"deletions":0},{"file":"usr/src/uts/common/sys/devfm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","type":"MODIFIED","insertions":20,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/intel/io/devfm_machdep.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/intel/sys/cpu_module.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"55ed56791d6f82aa8f108b20e097075b0ac15e52","parents":["451d765fb45021fb191507bcbe46a507f1ec89d9"],"ref":"refs/changes/46/6046/1","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1554404005,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/devfm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/uts/intel/io/devfm_machdep.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/intel/sys/cpu_module.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":40,"sizeDeletions":-6},{"number":"2","revision":"e13a8161f8ea273dab243994f73520baef9a01d9","parents":["451d765fb45021fb191507bcbe46a507f1ec89d9"],"ref":"refs/changes/46/6046/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1554404315,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/os/cmi_hw.c","line":1651,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m not sure using the CMI_HDL_OPFUNC is safe on xpv, as that will basically cause a NULL dereference as the macro doesn\u0027t check to see if the member is present or not."},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","line":1651,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Not sure if I\u0027m doing the right thing here, but I changed it to manually define the function and placed it inside a preprocessor guard so it doesn\u0027t get defined for xpv.\n\nI did test it and it seems to work."},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","line":1651,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I went through and double checked the cpuid/ucode code and it actually should be valid on XPV. So I think we should just define the same op entry point on both XPV and not and we can use a handle function. That way we don\u0027t need to ifdef it."},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","line":1651,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"I looked at this and the problem is that in the XPV context, we don\u0027t appear to have access to the cpu_t, so - assuming I\u0027m reading the code correctly, the only way to support the function for XPV would be to modify the xen-mca code to plumb the ucode rev up through the xen_mc_logical_cpu_t struct.   I don\u0027t think it\u0027s worth the effort and I\u0027m not certain I could even test it that easily."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5019,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is a pass 1 assert correct here? I thought these were basically orthogonal concepts."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5019,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"I think I just copied this from one of the other functions.  Removed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/devfm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/uts/intel/io/devfm_machdep.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/intel/sys/cpu_module.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":39,"sizeDeletions":-5},{"number":"3","revision":"05515fb6c1889ec84aa4da5edad196b8d021ccd5","parents":["451d765fb45021fb191507bcbe46a507f1ec89d9"],"ref":"refs/changes/46/6046/3","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1555694228,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/intel/io/devfm_machdep.c","line":208,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is this cast necessary? Doesn\u0027t this return a uint32_t?"},{"file":"usr/src/uts/intel/io/devfm_machdep.c","line":208,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/devfm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/intel/io/devfm_machdep.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/intel/sys/cpu_module.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":45,"sizeDeletions":-5},{"number":"4","revision":"20d90778a4ab409186dd4be8c145927b407f79ab","parents":["47478dccc69d4ee6c8753bc92430c6143d346300"],"ref":"refs/changes/46/6046/4","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1561410627,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","line":337,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I suspect we may have already hashed it out, but at least for Intel, the microcode exists on a per-core basis and is shared in the case of strands. Does it make sense to create the UFM on the strand and not the core still?"},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","line":339,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This appears to never be freed after creating the UFM. I\u0027d suggest initializing ucode_rev_str to NULL and unconditionally freeing it before the return at +354."},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","line":128,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we have the cmio_ucode_rev and functions if nothing actually calls and uses it now?"},{"file":"usr/src/uts/intel/io/devfm_machdep.c","line":208,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m confused about the most recent version. Right now this function (cmi_hdl_ucode_rev) is only defined under xpv. But there are no ifdefs here at all. How does that work?"},{"file":"usr/src/uts/intel/sys/cpu_module.h","line":169,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why isn\u0027t this under ifdef !xpv?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/i86pc/chip/chip.c","type":"MODIFIED","insertions":20,"deletions":0},{"file":"usr/src/uts/common/sys/devfm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cmi_hw.c","type":"MODIFIED","insertions":20,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/intel/io/devfm_machdep.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/intel/sys/cpu_module.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-4}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}]}