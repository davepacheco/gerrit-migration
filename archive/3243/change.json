{"project":"joyent/illumos-joyent","branch":"master","id":"Ia8da368ba60a3b5c5d9b4ca9a216514f9a652c8e","number":"3243","subject":"OS-6559 arc_c_min is too large on some configurations Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Jason King \u003cjason.king@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3243","commitMessage":"OS-6559 arc_c_min is too large on some configurations\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1516633771,"lastUpdated":1516808633,"open":false,"status":"MERGED","comments":[{"timestamp":1516633771,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1516634480,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(2 comments)\n\nQuestions about how we got here..."},{"timestamp":1516639487,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1516639894,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)\n\nI\u0027ll need to re-+1 it because of the one suggested comment change, but otherwise ship it."},{"timestamp":1516649243,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1516649271,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1516649418,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1516649471,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1516659008,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI have a basic testing note on the ticket: tested in east-3b on a 128GB box."},{"timestamp":1516659124,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1516808552,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1516808619,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1516808633,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e","parents":["5808b4859ccf0c145e1004228473943ea1fd4535"],"ref":"refs/changes/43/3243/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516808619,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649418,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649471,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516659124,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1516808633,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/arc.c","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":5,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"75bb1a47d0635057ef5de60d5d45aa2217c854c6","parents":["6b5092032142a30ce4cc20f531c421740910f0cd"],"ref":"refs/changes/43/3243/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516633771,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516639894,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6032,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Why not put the 1GB-on-larger-machine check up here?\n\n /*\n  * Set min cache to at least 64MB, at most 1GB, and 1/32\n  * of all memory if it falls in between those two.\n  */\n arc_c_min \u003d MIN(MAX(allmem / 32, 64 \u003c\u003c 20), 1 \u003c\u003c 30);"},{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6032,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes, as you observed below, putting it here would be ineffective."},{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6082,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Oh, is it because of this calculation?  It seems like this calculation, plus the one below, were added incrementally. I wonder if stepping back and looking at these min/max calculations as a whole is worthwhile?"},{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6082,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes, these calculations were added over time. I can\u0027t really say if they are good or not, so I don\u0027t have enough expertise to rewrite this entire thing. Clearly Delphix was happy with this, but it is not so good for our workloads. Since it looks like this change is something we\u0027ll have to carry in SmartOS indefinitely, it seemed like a simpler one-line change at the end would be easier to maintain."},{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6082,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Okay, fair enough. When someone has cycles (HAH!), someone needs to engage OpenZFS about this, however.  No idea who \"someone\" is, however."},{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6085,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"\"larger-memory\""},{"file":"usr/src/uts/common/fs/zfs/arc.c","line":6085,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/arc.c","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":5,"sizeDeletions":-1},{"number":"2","revision":"3ce4365781890a321a01783ffeb8e791d0dfa183","parents":["6b5092032142a30ce4cc20f531c421740910f0cd"],"ref":"refs/changes/43/3243/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516649243,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649471,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516659124,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649418,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/arc.c","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":5,"sizeDeletions":-1},{"number":"3","revision":"c4493d4fa46c1049ea7f9f89107c19024b143d14","parents":["5808b4859ccf0c145e1004228473943ea1fd4535"],"ref":"refs/changes/43/3243/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516808552,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649471,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516659124,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649418,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/arc.c","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":5,"sizeDeletions":-1},{"number":"4","revision":"a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e","parents":["5808b4859ccf0c145e1004228473943ea1fd4535"],"ref":"refs/changes/43/3243/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516808619,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1516808633,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649471,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516659124,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516649418,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/arc.c","type":"MODIFIED","insertions":5,"deletions":-1}],"sizeInsertions":5,"sizeDeletions":-1}],"allReviewers":[{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}