From 43a97304c5cac4dead0f9f0e0d275e141099f67b Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Mon, 19 Nov 2018 20:14:55 -0800
Subject: [PATCH] TRITON-971 CNAPI should not crash when CN has no boot params

---
 lib/models/server.js | 22 ++++++++++++++++------
 package.json         |  2 +-
 2 files changed, 17 insertions(+), 7 deletions(-)

diff --git a/lib/models/server.js b/lib/models/server.js
index ecb351e..a1da652 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -917,7 +917,9 @@ ModelServer.initialValues = function (opts, callback) {
                 function (error, params) {
                     boot_params = params;
 
-                    if (boot_params.kernel_args.rabbitmq_dns) {
+                    if (boot_params && boot_params.kernel_args &&
+                        boot_params.kernel_args.rabbitmq_dns) {
+
                         boot_params.kernel_args.rabbitmq
                             = boot_params.kernel_args.rabbitmq_dns;
                         delete boot_params.kernel_args.rabbitmq_dns;
@@ -946,12 +948,20 @@ ModelServer.initialValues = function (opts, callback) {
         server.reserved = false;
         server.vms = {};
 
-        server.boot_platform = boot_params.platform;
-        server.boot_params = boot_params.kernel_args || {};
-        server.kernel_flags = boot_params.kernel_flags || {};
+        if (boot_params) {
+            server.boot_platform = boot_params.platform;
+            server.boot_params = boot_params.kernel_args;
+            server.kernel_flags = boot_params.kernel_flags;
+            server.default_console = boot_params.default_console;
+            server.serial = boot_params.serial;
+        }
+
+        // set defaults if not set above
+        server.boot_params = server.boot_params || {};
+        server.kernel_flags = server.kernel_flags || {};
+        server.default_console = server.default_console || 'serial';
+        server.serial = server.serial || 'ttyb';
 
-        server.default_console = boot_params.default_console || 'serial';
-        server.serial = boot_params.serial || 'ttyb';
         server.created = (new Date()).toISOString();
 
         callback(null, server);
diff --git a/package.json b/package.json
index 6ed3965..9cfbcb8 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.14.0",
+  "version": "1.14.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

