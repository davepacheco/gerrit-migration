From 0174f3228f25591094e94aa94890399e937edbd0 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Wed, 30 Nov 2016 00:49:46 +0000
Subject: [PATCH] OS-5807 Support IPv6 in ipfilter service

---
 .../lib/svc/manifest/network/ipfilter.xml     | 152 +++++++++++++++++-
 overlay/generic/lib/svc/method/ipfilter       |  20 ++-
 2 files changed, 162 insertions(+), 10 deletions(-)

diff --git a/overlay/generic/lib/svc/manifest/network/ipfilter.xml b/overlay/generic/lib/svc/manifest/network/ipfilter.xml
index b66d5f5e..da42c27d 100644
--- a/overlay/generic/lib/svc/manifest/network/ipfilter.xml
+++ b/overlay/generic/lib/svc/manifest/network/ipfilter.xml
@@ -103,9 +103,18 @@
 		<property_group name='firewall_config_default'
 			type='com.sun,fw_configuration'>
 			<propval name='policy' type='astring' value='custom' />
-      <propval name='custom_policy_file' type='astring' value='/etc/ipf/ipf.conf' />
+			<propval name='block_policy' type='astring'
+				value='none' />
+			<propval name='custom_policy_file' type='astring'
+				value='/etc/ipf/ipf.conf' />
+			<propval name='custom_policy_file_6' type='astring'
+				value='/etc/ipf/ipf6.conf' />
 			<propval name='apply_to' type='astring' value='' />
+			<propval name='apply_to_6' type='astring' value='' />
 			<propval name='exceptions' type='astring' value='' />
+			<propval name='exceptions_6' type='astring' value='' />
+			<propval name='target' type='astring' value='' />
+			<propval name='target_6' type='astring' value='' />
 			<propval name='open_ports' type='astring' value='' />
 			<propval name='version' type='count' value='0' />
 			<propval name='value_authorization' type='astring'
@@ -115,7 +124,10 @@
 		<property_group name='firewall_config_override'
 			type='com.sun,fw_configuration'>
 			<propval name='policy' type='astring' value='none' />
+			<propval name='block_policy' type='astring'
+				value='none' />
 			<propval name='apply_to' type='astring' value='' />
+			<propval name='apply_to_6' type='astring' value='' />
 			<propval name='value_authorization' type='astring'
 				value='solaris.smf.value.firewall.config' />
 		</property_group>
@@ -209,6 +221,47 @@ Apply the custom ipfilter configuration stored in a custom file (custom file pro
 					<include_values type='values'/>
 				</choices>
 			</prop_pattern>
+			<prop_pattern name='block_policy' type='astring'
+			    required='false'>
+				<common_name>
+					<loctext xml:lang='C'>
+Firewall block policy
+					</loctext>
+				</common_name>
+				<description>
+					<loctext xml:lang='C'>
+Service firewall block policy.
+					</loctext>
+				</description>
+				<visibility value='readwrite'/>
+				<cardinality min='1' max='1'/>
+				<values>
+					<value name='use_global'>
+						<description>
+							<loctext xml:lang='C'>
+Apply Global Default block policy, specified in network/ipfilter for the service. This is the default value.
+							</loctext>
+						</description>
+					</value>
+					<value name='none'>
+						<description>
+							<loctext xml:lang='C'>
+Block by dropping packets.
+							</loctext>
+						</description>
+					</value>
+					<value name='return'>
+						<description>
+							<loctext xml:lang='C'>
+Block by returning RST or ICMP messages.
+							</loctext>
+						</description>
+					</value>
+				</values>
+				<choices>
+					<include_values type='values'/>
+				</choices>
+			</prop_pattern>
 			<prop_pattern name="apply_to" type="astring"
 			    required="false">
 				<common_name>
@@ -218,7 +271,20 @@ Apply policy to
 				</common_name>
 				<description>
 					<loctext xml:lang="C">
-The host and network IPs, network interfaces, and ippools to deny if the policy is set to deny, or accept if the policy is set to accept.
+The source host and network IPv4 addresses, incoming network interfaces, and ippools to deny if the policy is set to deny, or accept if the policy is set to accept.
+					</loctext>
+				</description>
+			</prop_pattern>
+			<prop_pattern name="apply_to_6" type="astring"
+			    required="false">
+				<common_name>
+					<loctext xml:lang='C'>
+Apply policy to
+					</loctext>
+				</common_name>
+				<description>
+					<loctext xml:lang="C">
+The source host and network IPv6 addresses, incoming network interfaces, and ippools to deny if the policy is set to deny, or accept if the policy is set to accept.
 					</loctext>
 				</description>
 			</prop_pattern>
@@ -231,7 +297,46 @@ Make exceptions to
 				</common_name>
 				<description>
 					<loctext xml:lang="C">
-The host and network IPs, network interfaces, and ippools which will be exempted from the set policy, accept if the policy is set to deny, or deny if the policy is set to accept.
+The source host and network IPv4 addresses, incoming network interfaces, and ippools which will be exempted from the set policy, accept if the policy is set to deny, or deny if the policy is set to accept.
+					</loctext>
+				</description>
+			</prop_pattern>
+			<prop_pattern name="exceptions_6" type="astring"
+			    required="false">
+				<common_name>
+					<loctext xml:lang='C'>
+Make exceptions to
+					</loctext>
+				</common_name>
+				<description>
+					<loctext xml:lang="C">
+The source host and network IPv6 addressess, incoming network interfaces, and ippools to exempt from the set policy. That is, those to accept if the policy is set to deny, or to deny if the policy is set to accept.
+					</loctext>
+				</description>
+			</prop_pattern>
+			<prop_pattern name="target" type="astring"
+			    required="false">
+				<common_name>
+					<loctext xml:lang='C'>
+Apply policy to
+					</loctext>
+				</common_name>
+				<description>
+					<loctext xml:lang="C">
+The destination host and network IPv4 addresses, and ippools to deny if the policy is set to deny, or accept if the policy is set to accept.
+					</loctext>
+				</description>
+			</prop_pattern>
+			<prop_pattern name="target6" type="astring"
+			    required="false">
+				<common_name>
+					<loctext xml:lang='C'>
+Apply policy to
+					</loctext>
+				</common_name>
+				<description>
+					<loctext xml:lang="C">
+The destination host and network IPv6 addresses, and ippools to deny if the policy is set to deny, or accept if the policy is set to accept.
 					</loctext>
 				</description>
 			</prop_pattern>
@@ -321,6 +426,47 @@ Allow access to entities specified in 'apply_to' property.
 					<include_values type='values'/>
 				</choices>
 			</prop_pattern>
+			<prop_pattern name='block_policy' type='astring'
+			    required='false'>
+				<common_name>
+					<loctext xml:lang='C'>
+Firewall block policy
+					</loctext>
+				</common_name>
+				<description>
+					<loctext xml:lang='C'>
+Service firewall block policy.
+					</loctext>
+				</description>
+				<visibility value='readwrite'/>
+				<cardinality min='1' max='1'/>
+				<values>
+					<value name='use_global'>
+						<description>
+							<loctext xml:lang='C'>
+Apply Global Default block policy, specified in network/ipfilter for the service. This is the default value.
+							</loctext>
+						</description>
+					</value>
+					<value name='none'>
+						<description>
+							<loctext xml:lang='C'>
+Block by dropping packets.
+							</loctext>
+						</description>
+					</value>
+					<value name='return'>
+						<description>
+							<loctext xml:lang='C'>
+Block by returning RST or ICMP messages.
+							</loctext>
+						</description>
+					</value>
+				</values>
+				<choices>
+					<include_values type='values'/>
+				</choices>
+			</prop_pattern>
 			<prop_pattern name="apply_to" type="astring"
 			    required="false">
 				<common_name>
diff --git a/overlay/generic/lib/svc/method/ipfilter b/overlay/generic/lib/svc/method/ipfilter
index 284eac0b..bb25316b 100755
--- a/overlay/generic/lib/svc/method/ipfilter
+++ b/overlay/generic/lib/svc/method/ipfilter
@@ -24,6 +24,7 @@
 # Use is subject to license terms.
 #
 # Copyright (c) 2013, Joyent, Inc. All rights reserved.
+# Copyright 2016 Hans Rosenfeld <rosenfeld@grumpf.hope-2000.org>
 #
 
 set -o xtrace
@@ -52,6 +53,7 @@ logmsg()
 load_ipf() {
 	bad=0
 	ipf -IFa
+	ipf -6IFa
 
 	for file in $IPFILOVRCONF $CONF_FILES $IPFILCONF; do
 		if [ -r ${file} ]; then
@@ -64,13 +66,16 @@ load_ipf() {
 		fi
 	done
 
-	if [ -r ${IP6FILCONF} ]; then
-		ipf -6IFa -f ${IP6FILCONF}
-		if [ $? != 0 ]; then
-			echo "$0: load of ${IP6FILCONF} into alternate set failed"
-			bad=1
+	for file in $IP6FILOVRCONF $CONF6_FILES $IP6FILCONF; do
+		if [ -r ${file} ]; then
+			ipf -6I -f ${file}
+			if [ $? != 0 ]; then
+				echo "$0: load of ${file} into alternate set failed"
+				bad=1
+			fi
 		fi
-	fi
+	done
+
 	if [ $bad -eq 0 ] ; then
 		ipf -s -y
 		return 0
@@ -168,6 +173,7 @@ configure_firewall()
 {
 	symlink_persistent_file ipnat.conf
 	symlink_persistent_file ipf.conf
+	symlink_persistent_file ipf6.conf
 	create_global_rules || exit $SMF_EXIT_ERR_CONFIG
 	create_global_ovr_rules || exit $SMF_EXIT_ERR_CONFIG
 	create_services_rules || exit $SMF_EXIT_ERR_CONFIG
@@ -228,7 +234,7 @@ case "$1" in
 		fi
 
 		ipf -D
-		[ -n "$ipfid" ] && modunload -i $ipfid
+		[ "$zone" = "global" -a -n "$ipfid" ] && modunload -i $ipfid
 		;;
 
 	pause)
-- 
2.21.0

