From 441e5a1e2e329f090fc90d1387cdba103a220bf0 Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Mon, 28 Jan 2019 16:42:32 +0000
Subject: [PATCH] TRITON-1163 cnapi should use agentIpFromSysinfo() for
 mockcloud support

---
 lib/models/server.js | 15 ++++++++-------
 package.json         |  2 +-
 2 files changed, 9 insertions(+), 8 deletions(-)

diff --git a/lib/models/server.js b/lib/models/server.js
index 971bb03..9d17f1d 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -1888,13 +1888,14 @@ function (opts) {
             });
         },
         function getCnapiLocationFromSysinfo(wfcb) {
-            if (sysinfo.hasOwnProperty('CN Agent IP')) {
-                // Allow sysinfo to include an IP that we'll use to connect to
-                // that might be different from the "Admin IP".
-                serverAdminIp = sysinfo['CN Agent IP'];
-            } else {
-                serverAdminIp = netconfig.adminIpFromSysinfo(sysinfo);
-            }
+            /*
+             * agentIpFromSysinfo() is intended for use with mockcloud which
+             * requires the use of a different IP for contacting agents on a
+             * mock CN.  If mockcloud support is not a requirement,
+             * adminIpFromSysinfo() should be used to get the admin IP for a
+             * CN.
+             */
+            serverAdminIp = netconfig.agentIpFromSysinfo(sysinfo);
             if (!serverAdminIp) {
                 wfcb(new VError('parsing server ip address in sendTaskReq '
                     + '(No admin NICs detected.)'));
diff --git a/package.json b/package.json
index 6622817..e47ae5b 100644
--- a/package.json
+++ b/package.json
@@ -26,7 +26,7 @@
     "sprintf": "0.1.5",
     "trace-event": "1.3.0",
     "triton-metrics": "1.0.0",
-    "triton-netconfig": "1.1.0",
+    "triton-netconfig": "1.3.0",
     "vasync": "1.6.4",
     "verror": "1.9.0",
     "wf-client": "0.2.1",
-- 
2.21.0

