{"project":"joyent/node-vmadm","branch":"master","id":"I43ac3f2219aacb974b5e9486c966412b55b8a581","number":"4895","subject":"TRITON-805 node-vmadm should support dummy vminfod Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/4895","commitMessage":"TRITON-805 node-vmadm should support dummy vminfod\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n\n* Fix some defaults to match vmadm\n* Add proper autoboot handling for VMs\n* Add support for dummy vminfod used by triton-mockcloud, allowing actions to delay completion until agents will have seen an event\n* Add support for snapshots and tags\n* Add tests\n","createdOn":1538166874,"lastUpdated":1539369073,"open":false,"status":"MERGED","comments":[{"timestamp":1538166874,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1538166876,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit be6ad5832b1995c02f99c8037a97643a77c1285e\n    \n    add dummy_vminfod"},{"timestamp":1538167447,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n node node_modules/.bin/eslint  lib/index.dummy_vminfod.js lib/index.dummy.js lib/index.sunos.js lib/diff.js lib/index.js test/unit/dummy.test.js test/unit/testutil.js\n \n /tmp/repo/node_modules/eslint/bin/eslint.js:16\n const useStdIn \u003d (process.argv.indexOf(\"--stdin\") \u003e -1),\n ^^^^^\n SyntaxError: Use of const in strict mode.\n     at Module._compile (module.js:439:25)\n     at Object.Module._extensions..js (module.js:474:10)\n     at Module.load (module.js:356:32)\n     at Function.Module._load (module.js:312:12)\n     at Function.Module.runMain (module.js:497:10)\n     at startup (node.js:119:16)\n     at node.js:945:3\n tools/mk/Makefile.targ:201: recipe for target \u0027check-eslint\u0027 failed\n gmake: *** [check-eslint] Error 8"},{"timestamp":1539231023,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1539231024,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit eea4f416dc9d15fb1df7b87dc53824008e20027b\n    \n    add test for reprovision\n    \n    commit 2a291b85d55a0484745e38e364185f3999cb5a1d\n    \n    fix autoboot + image_uuid, initial implementation of reprovision\n    \n    commit 8150ddcc946d643a0aa2c6dece2863d34923480d\n    \n    add initial snapshots implementation, also add support for some more vmadm updates and some tests.\n    \n    commit f095108e86c9bc90ef9991dc0be1207dcbcc6ab1\n    \n    Much simpler, there\u0027s no need to re-load when we\u0027ve already loaded all VMs. More consistent this way too.\n    \n    commit b5d0310261c468a63e0a739e023e8a4d00a8713f\n    \n    bug fixes"},{"timestamp":1539231110,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1539231111,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n node node_modules/.bin/eslint  lib/diff.js lib/index.dummy.js lib/index.sunos.js lib/index.js lib/index.dummy_vminfod.js test/unit/testutil.js test/unit/dummy.test.js\n \n /tmp/repo/node_modules/eslint/bin/eslint.js:16\n const useStdIn \u003d (process.argv.indexOf(\"--stdin\") \u003e -1),\n ^^^^^\n SyntaxError: Use of const in strict mode.\n     at Module._compile (module.js:439:25)\n     at Object.Module._extensions..js (module.js:474:10)\n     at Module.load (module.js:356:32)\n     at Function.Module._load (module.js:312:12)\n     at Function.Module.runMain (module.js:497:10)\n     at startup (node.js:119:16)\n     at node.js:945:3\n tools/mk/Makefile.targ:201: recipe for target \u0027check-eslint\u0027 failed\n gmake: *** [check-eslint] Error 8"},{"timestamp":1539283248,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1539285150,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1539285233,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1539363475,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1539364471,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1539365299,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1539366120,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5: Code-Review+1\n\njoshw: Do you know wassup with the automation check failure? `make check` wfm on my Mac."},{"timestamp":1539368991,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nTrent: Re: automation failure... That has happened on every to node-vmadm for a while. I believe it\u0027s an issue with the CI-Testing environment having an older version of node and eslint expecting a newer one (at least version 4)."},{"timestamp":1539369049,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1539369073,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"6","revision":"7ff16d17d3ebd9b4c8fb0f6232d144cd438b323a","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1539369049,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539231111,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539283248,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539366120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1539369073,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":15,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":480,"deletions":-76},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":430,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/dummy.test.js","type":"MODIFIED","insertions":359,"deletions":0}],"sizeInsertions":1270,"sizeDeletions":-77},"patchSets":[{"number":"1","revision":"2ddf99c43c58c9ee9416ccc6e1ded39c05c30f42","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1538166874,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1538167447,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":74,"deletions":-25},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":421,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":496,"sizeDeletions":-26},{"number":"2","revision":"54ba7b9764e4c125e90f62fed94699992b759548","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1539231023,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539231111,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":480,"deletions":-76},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":430,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/dummy.test.js","type":"MODIFIED","insertions":359,"deletions":0}],"sizeInsertions":1270,"sizeDeletions":-77},{"number":"3","revision":"982b2ff8ab1c9499e1248fb6f34601e55bc22250","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1539231110,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539283248,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":480,"deletions":-76},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":430,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/dummy.test.js","type":"MODIFIED","insertions":359,"deletions":0}],"sizeInsertions":1270,"sizeDeletions":-77},{"number":"4","revision":"43ac3f2219aacb974b5e9486c966412b55b8a581","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1539285150,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539231111,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539283248,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":480,"deletions":-76},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":430,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/dummy.test.js","type":"MODIFIED","insertions":359,"deletions":0}],"sizeInsertions":1270,"sizeDeletions":-77},{"number":"5","revision":"6f7627a13a1ec5d8cf4dbe5851e085eb4486363c","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1539285233,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539231111,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539366120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539283248,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/index.dummy_vminfod.js","line":12,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Side Q: Is there a reason (longer term) to *have* separate index.dummy and index.dummy_vminfod from a usage point of view?\n\n-----\n\nAlso, I feel it would be a tidier interface for node-vmadm to have:\n\n```\nvar vmadm \u003d require(\u0027vmadm\u0027).Vmadm;\n// OR\nvar vmadm \u003d require(\u0027vmadm\u0027).DummyVmadm;  // or .DummyVminfodVmadm\n```\n\nrather than the `require(\u0027vmadm/lib/index.foo\u0027)` usage.  But that\u0027s a chagne for all current users so I understand not wanting to make that breaking change right away.\n\n-----\n\nEventually having a section in the README.md about the dummy vmadm usage would be helpful."},{"file":"lib/index.dummy_vminfod.js","line":12,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I agree that we  should cleanup vanilla vmadm. TRITON-673 came out of the original chat discussion about it\u0027s quirks.\n\nWhen JoshW and I talked we leaned towards not breaking existing callers at this time."},{"file":"lib/index.dummy_vminfod.js","line":12,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"1. The main reasons I kept them separate for now were: a) to handle cases where we had things that for whatever reason need to work when vminfod is off (can\u0027t immediately think of what, so if nothing comes up while implementing the rest of the mocks, this is not an issue), b) for vminfod itself to be able to use. The way it is right now vminfod can use index.dummy while clients of vminfod can use index.dummy_vminfod and the two objects differ only in a few methods.\n\n2. Chris\u0027s original work here had done that but as you point out it\u0027s a major version change. (see https://github.com/joyent/node-vmadm/blob/objects-1/lib/index.js) It was my idea to use the (admittedly gross) hack in order to not need to change everything that uses node-vmadm yet. But I am definitely in favor of eventually having a 2.0 with a cleaned up interface. Part of that could also be to make it so that the non-mockcloud version is an *object* like the mockcloud version. I created TRITON-864 for this work.\n\n3. Yep. I created TRITON-865 for this just so we don\u0027t forget."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":14,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":480,"deletions":-76},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":430,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/dummy.test.js","type":"MODIFIED","insertions":359,"deletions":0}],"sizeInsertions":1270,"sizeDeletions":-77},{"number":"6","revision":"7ff16d17d3ebd9b4c8fb0f6232d144cd438b323a","parents":["5f87a87b2f6f96478e10d00a0197193fb75c48ab"],"ref":"refs/changes/95/4895/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1539369049,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1539231111,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539366120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539283248,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1539369073,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":15,"deletions":0},{"file":"lib/index.dummy.js","type":"MODIFIED","insertions":480,"deletions":-76},{"file":"lib/index.dummy_vminfod.js","type":"ADDED","insertions":430,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/dummy.test.js","type":"MODIFIED","insertions":359,"deletions":0}],"sizeInsertions":1270,"sizeDeletions":-77}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}