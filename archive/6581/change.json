{"project":"joyent/sdc-napi","branch":"master","id":"Ibdad3d4a54783a379bd3ce059302cb66b308711d","number":"6581","subject":"TRITON-1808 NAPI returns \"deadlock detected\" for conflicting requests Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Reviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e Approved by: Dave Eddy \u003cdave.eddy@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/6581","commitMessage":"TRITON-1808 NAPI returns \"deadlock detected\" for conflicting requests\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nReviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\nApproved by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\n","createdOn":1562717279,"lastUpdated":1562797289,"open":false,"status":"MERGED","comments":[{"timestamp":1562717279,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1562717321,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\nThis isn\u0027t completely done yet, since it breaks one of the unit tests for conflicting NIC deletes. I\u0027m going to look into why, and then post an updated version."},{"timestamp":1562717357,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/test/integration/regression-NET-281.test.js\n /tmp/repo/test/integration/aggregations.test.js\n /tmp/repo/test/integration/network-overlap.test.js\n /tmp/repo/test/integration/networks.test.js\n /tmp/repo/test/integration/fabrics-invalid.test.js\n /tmp/repo/test/integration/zz-delete-test-networks.test.js\n /tmp/repo/test/integration/nics.test.js\n /tmp/repo/test/integration/nic-tags.test.js\n /tmp/repo/test/integration/provision.test.js\n /tmp/repo/test/integration/network-pools.test.js\n /tmp/repo/test/integration/fabrics.test.js\n /tmp/repo/test/integration/ips.test.js\n /tmp/repo/test/unit/nic-tags.test.js\n /tmp/repo/test/unit/util-oui.test.js\n /tmp/repo/test/unit/networks-subnet-alloc.test.js\n /tmp/repo/test/unit/nics-list.test.js\n /tmp/repo/test/unit/ips.test.js\n /tmp/repo/test/unit/aggregations.test.js\n /tmp/repo/test/unit/etags.test.js\n /tmp/repo/test/unit/util-intersect.test.js\n /tmp/repo/test/unit/util-alloc.test.js\n /tmp/repo/test/unit/network-pools.test.js\n /tmp/repo/test/unit/networks-list.test.js\n /tmp/repo/test/unit/fabrics.test.js\n /tmp/repo/test/unit/helpers.js\n /tmp/repo/test/unit/run.js\n /tmp/repo/test/unit/changefeed.test.js\n /tmp/repo/test/unit/search-ips.test.js\n /tmp/repo/test/unit/longs.test.js\n /tmp/repo/test/unit/util-ip.test.js\n /tmp/repo/test/unit/networks.test.js\n /tmp/repo/test/unit/available-subnet-stream.test.js\n /tmp/repo/test/unit/migration-1.2.0-networks.test.js\n /tmp/repo/test/unit/nics.test.js\n /tmp/repo/test/unit/network-owner.test.js\n /tmp/repo/bin/ip2num\n /tmp/repo/bin/num2ip\n /tmp/repo/bin/mac2num\n /tmp/repo/bin/num2mac\n json --validate -f package.json\n json --validate -f config.json.sample\n deps/jsstyle/jsstyle -o indent\u003d2,doxygen,unparenthesized-return\u003d0,strict-indent\u003dtrue server.js lib/config.js lib/napi.js lib/napictl.js lib/init.js lib/models/nic/index.js lib/models/nic/list.js lib/models/nic/obj.js lib/models/nic/common.js lib/models/nic/update.js lib/models/nic/create.js lib/models/nic/provision.js lib/models/nic/bucket.js lib/models/nic/get.js lib/models/nic/del.js lib/models/ip/common.js lib/models/ip/provision.js lib/models/ip/index.js lib/models/nic-tag.js lib/models/index.js lib/models/aggregation.js lib/models/network-pool.js lib/models/vlan.js lib/models/network.js lib/models/fabric.js lib/endpoints/search.js lib/endpoints/index.js lib/endpoints/networks/index.js lib/endpoints/networks/nics.js lib/endpoints/networks/common.js lib/endpoints/networks/ips.js lib/endpoints/manage.js lib/endpoints/aggregations.js lib/endpoints/nic-tags.js lib/endpoints/ping.js lib/endpoints/nics.js lib/endpoints/fabrics/vlans.js lib/endpoints/fabrics/common.js lib/endpoints/fabrics/networks.js lib/endpoints/network-pools.js lib/migratectl.js lib/migrate.js lib/apis/moray.js lib/util/ip.js lib/util/common.js lib/util/constants.js lib/util/oui.js lib/util/intersect.js lib/util/autoalloc.js lib/util/validate.js lib/util/subnet-streams.js lib/util/errors.js test/lib/portolan.js test/lib/err.js test/lib/vlan.js test/lib/fabric-net.js test/lib/log.js test/lib/migration.js test/lib/pool.js test/lib/server.js test/lib/client.js test/lib/aggr.js test/lib/net.js test/lib/moray.js test/lib/ip.js test/lib/nic-tag.js test/lib/config.js test/lib/mock-wf.js test/lib/nic.js test/lib/fabrics.js test/lib/common.js test/integration/helpers.js test/integration/network-owner.test.js test/integration/regression-NET-281.test.js test/integration/aggregations.test.js test/integration/network-overlap.test.js test/integration/networks.test.js test/integration/fabrics-invalid.test.js test/integration/zz-delete-test-networks.test.js test/integration/nics.test.js test/integration/nic-tags.test.js test/integration/provision.test.js test/integration/network-pools.test.js test/integration/fabrics.test.js test/integration/ips.test.js test/unit/nic-tags.test.js test/unit/util-oui.test.js test/unit/networks-subnet-alloc.test.js test/unit/nics-list.test.js test/unit/ips.test.js test/unit/aggregations.test.js test/unit/etags.test.js test/unit/util-intersect.test.js test/unit/util-alloc.test.js test/unit/network-pools.test.js test/unit/networks-list.test.js test/unit/fabrics.test.js test/unit/helpers.js test/unit/run.js test/unit/changefeed.test.js test/unit/search-ips.test.js test/unit/longs.test.js test/unit/util-ip.test.js test/unit/networks.test.js test/unit/available-subnet-stream.test.js test/unit/migration-1.2.0-networks.test.js test/unit/nics.test.js test/unit/network-owner.test.js bin/ip2num bin/num2ip bin/mac2num bin/num2mac\n bash -n sbin/napid\n bash -n bin/napictl\n /tmp/repo/build/node/bin/node deps/eng/tools/bashstyle sbin/napid\n /tmp/repo/build/node/bin/node deps/eng/tools/bashstyle bin/napictl\n deps/eng/tools/check-copyright -q\n error: lib/models/nic/common.js: copyright year not updated to 2019: \u0027 * Copyright (c) 2018, Joyent, Inc.\u0027\n gmake: *** [deps/eng/tools/mk/Makefile.targ:292: check-copyright] Error 1"},{"timestamp":1562789250,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1562789321,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/test/integration/regression-NET-281.test.js\n /tmp/repo/test/integration/ips.test.js\n /tmp/repo/test/integration/networks.test.js\n /tmp/repo/test/integration/nics.test.js\n /tmp/repo/test/integration/nic-tags.test.js\n /tmp/repo/test/integration/network-owner.test.js\n /tmp/repo/test/integration/aggregations.test.js\n /tmp/repo/test/integration/fabrics.test.js\n /tmp/repo/test/integration/provision.test.js\n /tmp/repo/test/integration/network-overlap.test.js\n /tmp/repo/test/integration/fabrics-invalid.test.js\n /tmp/repo/test/integration/helpers.js\n /tmp/repo/test/unit/util-intersect.test.js\n /tmp/repo/test/unit/run.js\n /tmp/repo/test/unit/etags.test.js\n /tmp/repo/test/unit/util-alloc.test.js\n /tmp/repo/test/unit/available-subnet-stream.test.js\n /tmp/repo/test/unit/util-ip.test.js\n /tmp/repo/test/unit/networks-subnet-alloc.test.js\n /tmp/repo/test/unit/migration-1.2.0-networks.test.js\n /tmp/repo/test/unit/nic-tags.test.js\n /tmp/repo/test/unit/networks-list.test.js\n /tmp/repo/test/unit/network-pools.test.js\n /tmp/repo/test/unit/nics-list.test.js\n /tmp/repo/test/unit/aggregations.test.js\n /tmp/repo/test/unit/util-oui.test.js\n /tmp/repo/test/unit/networks.test.js\n /tmp/repo/test/unit/nics.test.js\n /tmp/repo/test/unit/helpers.js\n /tmp/repo/test/unit/network-owner.test.js\n /tmp/repo/test/unit/longs.test.js\n /tmp/repo/test/unit/fabrics.test.js\n /tmp/repo/test/unit/changefeed.test.js\n /tmp/repo/test/unit/search-ips.test.js\n /tmp/repo/test/unit/ips.test.js\n /tmp/repo/bin/ip2num\n /tmp/repo/bin/num2ip\n /tmp/repo/bin/mac2num\n /tmp/repo/bin/num2mac\n json --validate -f package.json\n json --validate -f config.json.sample\n deps/jsstyle/jsstyle -o indent\u003d2,doxygen,unparenthesized-return\u003d0,strict-indent\u003dtrue server.js lib/napictl.js lib/endpoints/networks/common.js lib/endpoints/networks/ips.js lib/endpoints/networks/nics.js lib/endpoints/networks/index.js lib/endpoints/search.js lib/endpoints/ping.js lib/endpoints/nics.js lib/endpoints/aggregations.js lib/endpoints/fabrics/common.js lib/endpoints/fabrics/vlans.js lib/endpoints/fabrics/networks.js lib/endpoints/manage.js lib/endpoints/nic-tags.js lib/endpoints/index.js lib/endpoints/network-pools.js lib/init.js lib/migratectl.js lib/config.js lib/napi.js lib/migrate.js lib/util/common.js lib/util/subnet-streams.js lib/util/ip.js lib/util/intersect.js lib/util/constants.js lib/util/autoalloc.js lib/util/errors.js lib/util/validate.js lib/util/oui.js lib/apis/moray.js lib/models/network.js lib/models/fabric.js lib/models/index.js lib/models/ip/provision.js lib/models/ip/index.js lib/models/ip/common.js lib/models/nic-tag.js lib/models/aggregation.js lib/models/network-pool.js lib/models/vlan.js lib/models/nic/provision.js lib/models/nic/list.js lib/models/nic/obj.js lib/models/nic/index.js lib/models/nic/update.js lib/models/nic/common.js lib/models/nic/get.js lib/models/nic/del.js lib/models/nic/create.js lib/models/nic/bucket.js test/lib/nic.js test/lib/fabric-net.js test/lib/moray.js test/lib/client.js test/lib/ip.js test/lib/server.js test/lib/fabrics.js test/lib/config.js test/lib/migration.js test/lib/vlan.js test/lib/portolan.js test/lib/net.js test/lib/pool.js test/lib/err.js test/lib/common.js test/lib/nic-tag.js test/lib/mock-wf.js test/lib/aggr.js test/lib/log.js test/integration/network-pools.test.js test/integration/zz-delete-test-networks.test.js test/integration/regression-NET-281.test.js test/integration/ips.test.js test/integration/networks.test.js test/integration/nics.test.js test/integration/nic-tags.test.js test/integration/network-owner.test.js test/integration/aggregations.test.js test/integration/fabrics.test.js test/integration/provision.test.js test/integration/network-overlap.test.js test/integration/fabrics-invalid.test.js test/integration/helpers.js test/unit/util-intersect.test.js test/unit/run.js test/unit/etags.test.js test/unit/util-alloc.test.js test/unit/available-subnet-stream.test.js test/unit/util-ip.test.js test/unit/networks-subnet-alloc.test.js test/unit/migration-1.2.0-networks.test.js test/unit/nic-tags.test.js test/unit/networks-list.test.js test/unit/network-pools.test.js test/unit/nics-list.test.js test/unit/aggregations.test.js test/unit/util-oui.test.js test/unit/networks.test.js test/unit/nics.test.js test/unit/helpers.js test/unit/network-owner.test.js test/unit/longs.test.js test/unit/fabrics.test.js test/unit/changefeed.test.js test/unit/search-ips.test.js test/unit/ips.test.js bin/ip2num bin/num2ip bin/mac2num bin/num2mac\n bash -n sbin/napid\n bash -n bin/napictl\n /tmp/repo/build/node/bin/node deps/eng/tools/bashstyle sbin/napid\n /tmp/repo/build/node/bin/node deps/eng/tools/bashstyle bin/napictl\n deps/eng/tools/check-copyright -q\n error: lib/models/nic/common.js: copyright year not updated to 2019: \u0027 * Copyright (c) 2018, Joyent, Inc.\u0027\n gmake: *** [deps/eng/tools/mk/Makefile.targ:292: check-copyright] Error 1"},{"timestamp":1562792081,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1562792151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562792897,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1562793980,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4."},{"timestamp":1562794026,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1562794052,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562794075,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1562797179,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1562797277,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1562797289,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"5","revision":"bdad3d4a54783a379bd3ce059302cb66b308711d","parents":["d80c2f54d8e1350c213752f125c26cae5dff692f"],"ref":"refs/changes/81/6581/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562797277,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562794026,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562794052,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562797179,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562797179,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"SUBM","value":"1","grantedOn":1562797289,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/models/nic/common.js","type":"MODIFIED","insertions":62,"deletions":-3}],"sizeInsertions":62,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"ad86e38be4db38e713adb3585bb6df04db7bba83","parents":["d80c2f54d8e1350c213752f125c26cae5dff692f"],"ref":"refs/changes/81/6581/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562717279,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1562717357,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/nic/common.js","type":"MODIFIED","insertions":22,"deletions":0}],"sizeInsertions":22,"sizeDeletions":0},{"number":"2","revision":"8a16aac6498fe450d8cc6ae203ec4a34c311f203","parents":["d80c2f54d8e1350c213752f125c26cae5dff692f"],"ref":"refs/changes/81/6581/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562789250,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1562789321,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/nic/common.js","type":"MODIFIED","insertions":57,"deletions":-2}],"sizeInsertions":57,"sizeDeletions":-2},{"number":"3","revision":"891f0e80aea985214fb31e109948b688c5b01ba2","parents":["d80c2f54d8e1350c213752f125c26cae5dff692f"],"ref":"refs/changes/81/6581/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562792081,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562792151,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/models/nic/common.js","line":58,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"It appears (if I understood the changes further down correctly), that portolan changes are an exception to this -- it looks like they always come last (with the order of the portolan entries amongst themselves preserved) in the resulting batch that\u0027s passed to moray.  Would it be worth nothing that here?"},{"file":"lib/models/nic/common.js","line":58,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/nic/common.js","type":"MODIFIED","insertions":58,"deletions":-3}],"sizeInsertions":58,"sizeDeletions":-3},{"number":"4","revision":"2897a25627f97127c314253eaf7bcae1e161b979","parents":["d80c2f54d8e1350c213752f125c26cae5dff692f"],"ref":"refs/changes/81/6581/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562793980,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562794052,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562797179,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562797179,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562794026,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/nic/common.js","type":"MODIFIED","insertions":62,"deletions":-3}],"sizeInsertions":62,"sizeDeletions":-3},{"number":"5","revision":"bdad3d4a54783a379bd3ce059302cb66b308711d","parents":["d80c2f54d8e1350c213752f125c26cae5dff692f"],"ref":"refs/changes/81/6581/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562797277,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1562797289,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562794052,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562797179,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562797179,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562794026,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/models/nic/common.js","type":"MODIFIED","insertions":62,"deletions":-3}],"sizeInsertions":62,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}