From 3b1b92e9ee130994ce7fabfbf61d0bfc67c9793e Mon Sep 17 00:00:00 2001
From: Jordan Hendricks <jordan.hendricks@joyent.com>
Date: Thu, 12 Jan 2017 20:02:28 +0000
Subject: [PATCH] Add narrow batching support for electric-moray when all items
 in the batch are on the same shard.

---
 lib/server.js | 56 +++++++++++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 54 insertions(+), 2 deletions(-)

diff --git a/lib/server.js b/lib/server.js
index 7975cf5..9045dd0 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -860,7 +860,7 @@ function updateObjects(options) {
     return _updateObjects;
 }
 
-// we don't support batch operations
+// Batch is supported only for operations that all use the same key.
 function batch(options) {
     assert.object(options, 'options');
     assert.object(options.log, 'options.log');
@@ -877,8 +877,60 @@ function batch(options) {
             opts: opts
         }, 'batch: entered');
 
-        res.end(new Error('Operation not supported'));
+        var k = null;
+        for (var i = 0; i < requests.length; i++) {
+            if (k === null) {
+                k = requests[i].key;
+            } else {
+                if (k !== requests[i].key) {
+                    res.end(new Error('Operation not supported'));
+                    return (undefined);
+                }
+            }
+        }
+
+        if (k === null) {
+            log.debug('no requests provided');
+            res.end(new Error('Operation not supported'));
+            return (undefined);
+        }
+
+        dtrace['batch-start'].fire(function () {
+            return ([res.msgid, id, k, requests]);
+        });
+
+        options.ring.getNode('manta', k, function (err, node) {
+            if (err) {
+                res.end(err);
+                return (undefined);
+            }
+            if (node.data && node.data === READ_ONLY) {
+                log.debug({
+                    bucket: 'manta',
+                    key: k,
+                    opts: opts,
+                    node: node
+                }, 'batch: failed vnode is read only');
+                return res.end(new ReadOnlyError());
+            }
+            var pnode = node.pnode;
+            var client = options.clients.map[pnode];
+            client.batch(requests, opts, function (_err, meta) {
+                log.debug({
+                    err: _err,
+                    meta: meta
+                }, 'batch: returned');
+
+                dtrace['batch-done'].fire(function () {
+                    return ([res.msgid]);
+                });
+                res.end(_err ? _err : meta);
+            });
+        });
+
+        return (undefined);
     }
 
     return _batch;
+
 }
-- 
2.21.0

