{"project":"joyent/illumos-joyent","branch":"master","id":"Id09721f7446ca0fcc46a38cae275f18d560585c7","number":"425","subject":"OS-3831 lxbrand /proc/cmdline should reflect zone boot arguments Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/425","commitMessage":"OS-3831 lxbrand /proc/cmdline should reflect zone boot arguments\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1473220241,"lastUpdated":1473446029,"open":false,"status":"MERGED","comments":[{"timestamp":1473220241,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1473252193,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1473267740,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1473434076,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1473434518,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1473434656,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1473437037,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1473444630,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1473444821,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1473445363,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nI tested the /proc/cmdline like so:\n\n[root@testsos ~]# zoneadm -z 710de071-78a4-c369-a8b6-b2414e17d7c6 boot -- -s -m verbose i.can.haz.bootargs\u003dyes\n[root@testsos ~]# zlogin 710de071-78a4-c369-a8b6-b2414e17d7c6\n[Connected to zone \u0027710de071-78a4-c369-a8b6-b2414e17d7c6\u0027 pts/2]\nLast login: Mon Sep  5 03:00:01 from zone:global\n   __        .                   .\n _|  |_      | .-. .  . .-. :--. |-\n|_    _|     ;|   ||  |(.-\u0027 |  | |\n  |__|   `--\u0027  `-\u0027 `;-| `-\u0027 \u0027  \u0027 `-\u0027\n                   /  ;  Instance (CentOS 6.8 20160601)\n                   `-\u0027   https://docs.joyent.com/images/container-native-linux\n\n[root@c66-lx ~]# cat /proc/cmdline\n-s -m verbose i.can.haz.bootargs\u003dyes\n\n\n\nI tested the superfluous space removal via a dtrace script which prints the bootargs before and after the filter_bootargs() function:\n\nBefore:\n\n# dtrace -x switchrate\u003d1000hz -qwn \u0027BEGIN { n[0] \u003d 0; } proc:::create /execname \u003d\u003d \"zoneadmd\" \u0026\u0026 n[pid] \u003d\u003d 0/ { m[pid]++; } proc:::start /execname \u003d\u003d \"zoneadmd\" \u0026\u0026 m[ppid] \u003d\u003d 1/ { n[pid]++; system(\"dtrace -qws /data/d/filter_bootargs.d -p %d\", pid); }\u0027\n\"foo.blah\u003dyes\" \u003d\u003e \" foo.blah\u003dyes\"\n\"-s -m verbose i.can.haz.bootargs\u003dyes\" \u003d\u003e \" -s   -m verbose  i.can.haz.bootargs\u003dyes\"\n\"-s -m verbose i.can.haz.bootargs\u003dyes systemd.is.not.for.me\u003dyes\" \u003d\u003e \" -s   -m verbose  i.can.haz.bootargs\u003dyes systemd.is.not.for.me\u003dyes\"\n\"ro roo\u003d/home/sweet/home bar baz 99\" \u003d\u003e \" ro roo\u003d/home/sweet/home bar baz 99\"\n\nAfter:\n\n# dtrace -x switchrate\u003d1000hz -qwn \u0027BEGIN { n[0] \u003d 0; } proc:::create /execname \u003d\u003d \"zoneadmd\" \u0026\u0026 n[pid] \u003d\u003d 0/ { m[pid]++; } proc:::start /execname \u003d\u003d \"zoneadmd\" \u0026\u0026 m[ppid] \u003d\u003d 1/ { n[pid]++; system(\"dtrace -qws /data/d/filter_bootargs.d -p %d\", pid); }\u0027\n\"foo.blah\u003dyes\" \u003d\u003e \"foo.blah\u003dyes\"\n\"-s -m verbose i.can.haz.bootargs\u003dyes\" \u003d\u003e \"-s -m verbose i.can.haz.bootargs\u003dyes\"\n\"-s -m verbose i.can.haz.bootargs\u003dyes systemd.is.not.for.me\u003dyes\" \u003d\u003e \"-s -m verbose i.can.haz.bootargs\u003dyes systemd.is.not.for.me\u003dyes\"\n\"ro roo\u003d/home/sweet/home bar baz 99\" \u003d\u003e \"ro roo\u003d/home/sweet/home bar baz 99\""},{"timestamp":1473446029,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"4","revision":"d09721f7446ca0fcc46a38cae275f18d560585c7","parents":["c1b73ee5bb95c54a61186efe6f5c720eb56c0065"],"ref":"refs/changes/25/425/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1473444821,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473434656,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1473446029,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":22,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"eca168458ab1c855c4c73841bec4006595cd028e","parents":["12a530b543020dda34973ca16b31b66007141141"],"ref":"refs/changes/25/425/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1473220241,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":271,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The later calls to strnappend can do without the \u0027(void)\u0027 prepended."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":279,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I know you didn\u0027t touch this comment, but since you\u0027re modifying the function it would be a good opportunity to remove the obsolete use of \"Solaris\" and replace it with some better (e.g. illumos as is done in the comment later in this function).\n\nIt might also be worthwhile to expand this comment a bit to point out the use of branded zones."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":279,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Completely agree with s/Solaris/illumos/, will do.\n\nThe comment already mentions \"Non-Solaris\" brands, which I changed to \"Non-native\" since that\u0027s the nomenclature I see more often. I\u0027m not sure what else  to elaborate on."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":398,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I would use sizeof (scratchopt) here instead of this hardcoded constant."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":32,"sizeDeletions":-7},{"number":"2","revision":"ef1dd98680be72f59a7fbacec030f723b375f237","parents":["12a530b543020dda34973ca16b31b66007141141"],"ref":"refs/changes/25/425/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1473434076,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473434656,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":22,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-10},{"number":"3","revision":"24bebb843d1cc965292d4e2525ba7d9c869b1bb3","parents":["c1b73ee5bb95c54a61186efe6f5c720eb56c0065"],"ref":"refs/changes/25/425/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1473444630,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473434656,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":22,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-10},{"number":"4","revision":"d09721f7446ca0fcc46a38cae275f18d560585c7","parents":["c1b73ee5bb95c54a61186efe6f5c720eb56c0065"],"ref":"refs/changes/25/425/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1473444821,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473437037,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473434656,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1473446029,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":22,"deletions":-9},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-10}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}