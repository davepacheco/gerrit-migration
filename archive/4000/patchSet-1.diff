From bd09520cb7c90b2ce7b1253a06c92e749696f252 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Thu, 24 May 2018 15:58:10 +0200
Subject: [PATCH] TRITON-395 Drop sdcadm support for manatee v1.0

---
 etc/defaults.json                   |  2 +-
 lib/procedures/update-manatee-v2.js | 52 +----------------------------
 2 files changed, 2 insertions(+), 52 deletions(-)

diff --git a/etc/defaults.json b/etc/defaults.json
index b49f01e..ae969c2 100644
--- a/etc/defaults.json
+++ b/etc/defaults.json
@@ -65,7 +65,7 @@
         "vmapi": "20140710T171616Z",
         "moray": "20140710T181209Z",
         "adminui": "20140718T210958Z",
-        "manatee": "20140721T221128Z",
+        "manatee": "20141225T181254Z",
         "sdc": "20140725T191132Z",
         "cloudapi": "20140731T175858Z",
         "ufds": "20140728T173339Z"
diff --git a/lib/procedures/update-manatee-v2.js b/lib/procedures/update-manatee-v2.js
index 84cd803..bbf2aa9 100644
--- a/lib/procedures/update-manatee-v2.js
+++ b/lib/procedures/update-manatee-v2.js
@@ -208,7 +208,6 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
         var sapiUUID;
         var morayVms;
         var wfVms;
-        var version;
         var pastSAPI224 = false;
 
         // TOOLS-975: As a workaround for any manatee instance affected by
@@ -351,7 +350,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
         }
 
         function freeze(_, next) {
-            if (!arg.HA || version === '1.0.0' || isFrozen) {
+            if (!arg.HA || isFrozen) {
                 next();
                 return;
             }
@@ -812,28 +811,6 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                 }, next);
             },
 
-            function getManateeAdmVersion(_, next) {
-                progress('Checking manatee-adm version');
-                common.manateeAdmRemote({
-                    server: arg.shard.primary.server_uuid,
-                    vm: arg.shard.primary.zoneId,
-                    cmd: 'version',
-                    log: log
-                }, function (err, stdou, stder) {
-                    if (err) {
-                        next(err);
-                        return;
-                    }
-                    // Not implemented until 2.0.0
-                    if (stder) {
-                        version = '1.0.0';
-                    } else {
-                        version = stdou;
-                    }
-                    next();
-                });
-            },
-
             // --------------- HA only --------------------------------------
             function verifyFullHA(_, next) {
                 if (!arg.HA) {
@@ -905,20 +882,6 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                 }, next);
             },
 
-            function asyncStateBackfill(_, next) {
-                if (!arg.HA || version !== '1.0.0' || arg.async_updated) {
-                    next();
-                    return;
-                }
-                progress('Backfilling cluster state');
-                common.manateeAdmRemote({
-                    server: arg.shard.async.server_uuid,
-                    vm: arg.shard.async.zoneId,
-                    cmd: 'state-backfill -y',
-                    log: log
-                }, next);
-            },
-
             function waitForHA(_, next) {
                 if (!arg.HA || arg.async_updated) {
                     next();
@@ -1047,19 +1010,6 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
             },
 
             // ----------- Again, no-HA only ----------------------------------
-            function noHAStateBackfill(_, next) {
-                if (arg.HA || version !== '1.0.0') {
-                    next();
-                    return;
-                }
-                progress('Backfilling cluster state');
-                common.manateeAdmRemote({
-                    server: arg.shard.primary.server_uuid,
-                    vm: arg.shard.primary.zoneId,
-                    cmd: 'state-backfill -y',
-                    log: log
-                }, next);
-            },
 
             function waitForPrimaryPG(_, next) {
                 if (arg.HA) {
-- 
2.21.0

