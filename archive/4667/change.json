{"project":"joyent/sdc-cnapi","branch":"master","id":"Id86854fef6053910897fc83b0883c5dd1c0876ef","number":"4667","subject":"TRITON-677 CNAPI gets stuck in a loop while trying to expire a ticket which is queued, which is also at the \"top\" of the waitlist queue for thats server/scope/id Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/4667","commitMessage":"TRITON-677 CNAPI gets stuck in a loop while trying to expire a ticket which is queued, which is also at the \"top\" of the waitlist queue for thats server/scope/id\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1534176105,"lastUpdated":1534965380,"open":false,"status":"MERGED","comments":[{"timestamp":1534176105,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1534176106,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 2610e997f6b06b9512d1f5fb8ffcc1b774e2094c\n    \n    first stab"},{"timestamp":1534176137,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1534180261,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1534180290,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1534368793,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1534368824,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1534370260,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(8 comments)\n\nI guess this also needs a package.json version bump?"},{"timestamp":1534790259,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1534790288,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1534881037,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\n(7 comments)"},{"timestamp":1534881051,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 5."},{"timestamp":1534881052,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit af2ccf274f058ab22d5f22a257e221e87bc44a87\n    \n    apply jowsh\u0027s feedback"},{"timestamp":1534881081,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1534959519,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nlgtm"},{"timestamp":1534959600,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1534965380,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"6","revision":"d86854fef6053910897fc83b0883c5dd1c0876ef","parents":["c44d9087f1ccf858a96d718d21233429bade9a6d"],"ref":"refs/changes/67/4667/6","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534959600,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534881081,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959519,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534959519,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1534965380,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":28,"deletions":-22},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":88,"deletions":-2}],"sizeInsertions":116,"sizeDeletions":-24},"patchSets":[{"number":"1","revision":"648c70a418b9da9709b1b69a9341bdfc87779f03","parents":["f926678196b41b64ea76b116fea33fee04e74a81"],"ref":"refs/changes/67/4667/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534176105,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534176137,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":87,"deletions":-1}],"sizeInsertions":125,"sizeDeletions":-26},{"number":"2","revision":"a6e130c41457ea6c599afd7fd0c2ab677859038d","parents":["34db7565a8334d26fcf67756ebe1dc4ca821cb7c"],"ref":"refs/changes/67/4667/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534180261,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534176137,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/models/waitlist.js","line":161,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Wouldn\u0027t we actually want to know if this was called with 0 tickets?"},{"file":"lib/models/waitlist.js","line":161,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"We would, fixed."},{"file":"lib/models/waitlist.js","line":171,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"It seems like this change means that when a ticket.status is expired, we\u0027ll no longer call the callbacks whereas before we would. Is that intentional? Why doesn\u0027t that matter?"},{"file":"lib/models/waitlist.js","line":171,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"I think this part was incorrect to begin with. There is no way that given the query on line 371 we would ever get tickets with status \u003d expired. The expiry callback logic now happens after the ticket is marked as expired on line 176. The new test should in theory cover this case now. (Waiting on a ticket that expires)"},{"file":"lib/models/waitlist.js","line":375,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"To me I think it looks more confusing to have these on separate lines since they\u0027re part of the same sub-statement (the or applies to both)."},{"file":"lib/models/waitlist.js","line":375,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"lib/models/waitlist.js","line":399,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Is this here intentionally?"},{"file":"lib/models/waitlist.js","line":399,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"No, that was something I was trying when I was trying to reason about the same issue you described above re: tickets with status\u003dexpired."},{"file":"lib/models/waitlist.js","line":701,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"How noisy is this going to be?"},{"file":"lib/models/waitlist.js","line":701,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"lib/models/waitlist.js","line":811,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"How noisy is this going to be?"},{"file":"lib/models/waitlist.js","line":811,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"test/waitlist/test-waitlist-expiry.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"2018"},{"file":"test/waitlist/test-waitlist-expiry.js","line":233,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Did you run this test against the old code? Did it fail?"},{"file":"test/waitlist/test-waitlist-expiry.js","line":233,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yeah, I\u0027ll update the JIRA with the before/after test output."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":87,"deletions":-1}],"sizeInsertions":124,"sizeDeletions":-25},{"number":"3","revision":"37e9f5e64c0e4e24ad3b5e9b72b423384d627cea","parents":["432d9da525c292ecb3e2a3954ab3e9bdc8ad177a"],"ref":"refs/changes/67/4667/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534368793,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534176137,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":87,"deletions":-1}],"sizeInsertions":124,"sizeDeletions":-25},{"number":"4","revision":"6c57599c847f07fe4166e1e7f079bd79e455b31c","parents":["c44d9087f1ccf858a96d718d21233429bade9a6d"],"ref":"refs/changes/67/4667/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534790259,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534176137,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":37,"deletions":-24},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":87,"deletions":-1}],"sizeInsertions":124,"sizeDeletions":-25},{"number":"5","revision":"148ce48864886dfe1549b6c23e59aaa1546b7aab","parents":["c44d9087f1ccf858a96d718d21233429bade9a6d"],"ref":"refs/changes/67/4667/5","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534881051,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534881081,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959519,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534959519,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":28,"deletions":-22},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":88,"deletions":-2}],"sizeInsertions":116,"sizeDeletions":-24},{"number":"6","revision":"d86854fef6053910897fc83b0883c5dd1c0876ef","parents":["c44d9087f1ccf858a96d718d21233429bade9a6d"],"ref":"refs/changes/67/4667/6","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1534959600,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534881081,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959519,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534959519,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1534965380,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/models/waitlist.js","type":"MODIFIED","insertions":28,"deletions":-22},{"file":"test/waitlist/test-waitlist-expiry.js","type":"MODIFIED","insertions":88,"deletions":-2}],"sizeInsertions":116,"sizeDeletions":-24}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}