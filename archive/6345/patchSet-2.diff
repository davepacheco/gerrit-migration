From 47416585a6af7b4ade018ba5c6cb0721b95d8d12 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Tue, 21 May 2019 22:34:57 -0500
Subject: [PATCH] =?UTF-8?q?TRITON-1692=20linux-prepare-image=20should=20be?=
 =?UTF-8?q?=20able=20to=20set=20root=20password=20hash=20Reviewed=20by:=20?=
 =?UTF-8?q?Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved?=
 =?UTF-8?q?=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 tools/prepare-image/linux-prepare-image | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index 597134c..6e355ad 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -61,6 +61,13 @@ function errexit
 
 #---- support routines
 
+# A wrapper around mdata-get to get values from the prepare-image namespace.
+function mdata_get_pi() {
+	typeset key=$1
+
+	mdata-get "prepare-image:$key" 2>/dev/null || true
+}
+
 function cleanup_logs() {
     # This ensures we don't delete the following
     # /var/log/wtmp - syslog won't start if this is missin
@@ -91,8 +98,9 @@ function cleanup_root() {
     history -c
     history -w || true
 
-    # Removing password for root
-    passwd -d root
+    # Remove or set password for root.  If root-password-hash is not set, this
+    # is equivalent to "passwd -d root".
+    usermod -p "$(mdata_get_pi root-password-hash)" root
 
     # Clean up history, ssh keys, etc.
     cleanup_homedir /root
@@ -194,7 +202,7 @@ function prepare_ubuntu() {
     # Clean up package cache
     apt-get -y clean
 
-    local fixconsole=$(mdata-get prepare-image:fix-ubuntu-console 2>/dev/null)
+    local fixconsole=$(mdata_get_pi fix-ubuntu-console)
 
     if [[ $fixconsole == true ]]; then
         cat >/etc/default/grub.d/51-smartos-serial-console.cfg <<EOF
-- 
2.21.0

