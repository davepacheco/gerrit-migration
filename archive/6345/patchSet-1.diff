From 54c20d31ca41d47c2bcd5f618a2d6af83822d95e Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Tue, 21 May 2019 22:34:57 -0500
Subject: [PATCH] TRITON-1692 linux-prepare-image should be able to set root
 password hash

---
 tools/prepare-image/linux-prepare-image | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index 597134c..6e355ad 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -61,6 +61,13 @@ function errexit
 
 #---- support routines
 
+# A wrapper around mdata-get to get values from the prepare-image namespace.
+function mdata_get_pi() {
+	typeset key=$1
+
+	mdata-get "prepare-image:$key" 2>/dev/null || true
+}
+
 function cleanup_logs() {
     # This ensures we don't delete the following
     # /var/log/wtmp - syslog won't start if this is missin
@@ -91,8 +98,9 @@ function cleanup_root() {
     history -c
     history -w || true
 
-    # Removing password for root
-    passwd -d root
+    # Remove or set password for root.  If root-password-hash is not set, this
+    # is equivalent to "passwd -d root".
+    usermod -p "$(mdata_get_pi root-password-hash)" root
 
     # Clean up history, ssh keys, etc.
     cleanup_homedir /root
@@ -194,7 +202,7 @@ function prepare_ubuntu() {
     # Clean up package cache
     apt-get -y clean
 
-    local fixconsole=$(mdata-get prepare-image:fix-ubuntu-console 2>/dev/null)
+    local fixconsole=$(mdata_get_pi fix-ubuntu-console)
 
     if [[ $fixconsole == true ]]; then
         cat >/etc/default/grub.d/51-smartos-serial-console.cfg <<EOF
-- 
2.21.0

