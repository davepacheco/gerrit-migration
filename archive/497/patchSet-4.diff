From b1cf12c0f3a2999a74cd6617c2381eac09800a87 Mon Sep 17 00:00:00 2001
From: Ryan Zezeski <rpz@joyent.com>
Date: Fri, 16 Sep 2016 09:52:48 -0400
Subject: [PATCH] OS-5330 zoneadm mounting an lx or joyent branded zone fails

---
 overlay/generic/etc/zones/SUNWdefault.xml | 2 +-
 overlay/generic/lib/svc/method/fs-joyent  | 9 +++++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/overlay/generic/etc/zones/SUNWdefault.xml b/overlay/generic/etc/zones/SUNWdefault.xml
index cfe27a0f..070412f6 100644
--- a/overlay/generic/etc/zones/SUNWdefault.xml
+++ b/overlay/generic/etc/zones/SUNWdefault.xml
@@ -28,5 +28,5 @@
 
 <!DOCTYPE zone PUBLIC "-//Sun Microsystems Inc//DTD Zones//EN" "file:///usr/share/lib/xml/dtd/zonecfg.dtd.1">
 
-<zone name="default" zonepath="" autoboot="false" brand="liveimg">
+<zone name="default" zonepath="" autoboot="false" brand="joyent">
 </zone>
diff --git a/overlay/generic/lib/svc/method/fs-joyent b/overlay/generic/lib/svc/method/fs-joyent
index 69729346..e0ce91c4 100755
--- a/overlay/generic/lib/svc/method/fs-joyent
+++ b/overlay/generic/lib/svc/method/fs-joyent
@@ -121,10 +121,19 @@ if [ $? -ne 0 ]; then
     # For the system zpool, mount and configure all system datasets
     zpool status -v ${SYS_ZPOOL}
     if [ $? -eq 0 ]; then
+        # Stash the SUNWdefault.xml file so we can update the
+        # persistent version after mounting zones/config.
+        cp /etc/zones/SUNWdefault.xml /tmp/
+
         mount_zfs ${SYS_ZPOOL}/var /var
         mount_zfs ${SYS_ZPOOL}/config /etc/zones
         mount_zfs ${SYS_ZPOOL}/opt /opt
 
+        # Update the the persistent SUNWdefault.xml file to match the
+        # contents on ramdisk now that zones/config is mounted.
+        cp /tmp/SUNWdefault.xml /etc/zones/
+        rm -f /tmp/SUNWdefault.xml
+
         if [[ -z $(/bin/bootparams | grep '^smartos=true') ]]; then
             mkdir -p /opt/smartdc/agents/smf
             mount -O -F lofs /var/svc/manifest/site /opt/smartdc/agents/smf
-- 
2.21.0

