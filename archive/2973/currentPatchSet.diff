From e98262be5b0cbdf0f16e521cab08427068e1b281 Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Mon, 20 Nov 2017 14:42:56 -0800
Subject: [PATCH] =?UTF-8?q?VOLAPI-92=20nightly2-020-test-system=20failing?=
 =?UTF-8?q?=20in=20node-sdc-clients=20volapi=20tests=20Reviewed=20by:=20Pe?=
 =?UTF-8?q?dro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>=20Reviewed=20b?=
 =?UTF-8?q?y:=20Trent=20Mick=20<trentm@gmail.com>=20Approved=20by:=20Pedro?=
 =?UTF-8?q?=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved=20by:?=
 =?UTF-8?q?=20Trent=20Mick=20<trentm@gmail.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/cli/do_nfs_volumes.js | 22 ++++++++++++++++++++++
 lib/post-setup/volapi.js  | 13 +++++++++++++
 2 files changed, 35 insertions(+)

diff --git a/lib/cli/do_nfs_volumes.js b/lib/cli/do_nfs_volumes.js
index 4bd8bd0..fcbd9cd 100644
--- a/lib/cli/do_nfs_volumes.js
+++ b/lib/cli/do_nfs_volumes.js
@@ -297,6 +297,28 @@ function do_nfs_volumes(subcmd, opts, args, cb) {
     }
 
     vasync.pipeline({arg: context, funcs: [
+        function checkFabricsEnabled(ctx, next) {
+            var err;
+
+            assert.object(self.sdcadm.sdc.metadata, 'self.sdcadm.sdc.metadata');
+
+            /*
+             * Disabling any NFS volumes feature flag does have any requirement,
+             * let alone on support for fabric networks.
+             */
+            if (opts.disable) {
+                next();
+                return;
+            }
+
+            if (!self.sdcadm.sdc.metadata.fabric_cfg) {
+                err = new Error('cannot enable NFS volumes feature: this DC ' +
+                    'is not setup for fabric networks');
+            }
+
+            next(err);
+        },
+
         function checkFeatureDeps(ctx, next) {
             var err;
             var missingFeatureDeps;
diff --git a/lib/post-setup/volapi.js b/lib/post-setup/volapi.js
index 06ca821..504c996 100644
--- a/lib/post-setup/volapi.js
+++ b/lib/post-setup/volapi.js
@@ -168,6 +168,19 @@ function do_volapi(subcmd, opts, args, cb) {
     vasync.pipeline({arg: context, funcs: [
         steps.sapiAssertFullMode,
 
+        function checkFabricsEnabled(ctx, next) {
+            var err;
+
+            assert.object(self.sdcadm.sdc.metadata, 'self.sdcadm.sdc.metadata');
+
+            if (!self.sdcadm.sdc.metadata.fabric_cfg) {
+                err = new Error('cannot setup volapi: this DC is not setup ' +
+                    'for fabric networks');
+            }
+
+            next(err);
+        },
+
         function getVolApiPkg(ctx, next) {
             var filter = {name: svcData.params.package_name,
                 active: true};
-- 
2.21.0

