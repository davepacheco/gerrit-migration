{"project":"joyent/manta-garbage-collector","branch":"master","id":"Ic0cbd2038d479e5be97dcac121a1e4b5d5c6a097","number":"6158","subject":"MANTA-4238 Implement low water level mark for GC flushing Reviewed by: Rui Loura \u003crui@joyent.com\u003e Reviewed by: Richard Kiene \u003crichard.kiene@joyent.com\u003e Approved by: Richard Kiene \u003crichard.kiene@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/6158","commitMessage":"MANTA-4238 Implement low water level mark for GC flushing\nReviewed by: Rui Loura \u003crui@joyent.com\u003e\nReviewed by: Richard Kiene \u003crichard.kiene@joyent.com\u003e\nApproved by: Richard Kiene \u003crichard.kiene@joyent.com\u003e\n","createdOn":1556141538,"lastUpdated":1556919230,"open":false,"status":"MERGED","comments":[{"timestamp":1556141538,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1556141578,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1556141737,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1556141766,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556144062,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1556144393,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1556144425,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556145205,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1556229315,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1556229344,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556317890,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5."},{"timestamp":1556317920,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556666866,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 6."},{"timestamp":1556666915,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556666989,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 7."},{"timestamp":1556668762,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556750876,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 8."},{"timestamp":1556750911,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556815551,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1556846742,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1556865447,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8:\n\n(5 comments)"},{"timestamp":1556901680,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 8: Code-Review+1\n\n(3 comments)\n\nThe code looks great to me. I think once we address the concerns around logging I\u0027d be happy to give a +1 for IA as well."},{"timestamp":1556902431,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1556902453,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 8:\n\n(5 comments)"},{"timestamp":1556906857,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 8: Integration-Approval+1\n\n(1 comment)"},{"timestamp":1556906863,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 8: -Integration-Approval"},{"timestamp":1556906998,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 8:\n\nSee above...\n\nmoray_delete_record_cleaner.js:263: Should we delete from the cache if the batch failed (e.g. returned err on line 237 above)?"},{"timestamp":1556913308,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1556914133,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 9."},{"timestamp":1556914168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556914335,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1556914413,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 10."},{"timestamp":1556914446,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556917884,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 10: Code-Review+1 Integration-Approval+1"},{"timestamp":1556918947,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1556919213,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 11: Commit message was updated."},{"timestamp":1556919230,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"11","revision":"c0cbd2038d479e5be97dcac121a1e4b5d5c6a097","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/11","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556919213,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556914446,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556917884,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556917884,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556918947,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1556919230,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":50,"deletions":-26},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":166,"sizeDeletions":-40},"patchSets":[{"number":"1","revision":"729da164d92cbe331827167d4e64aec3e8582bc9","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556141538,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1556141578,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/delete_record_transformer.js","line":310,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/delete_record_transformer.js","line":311,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/delete_record_transformer.js","line":312,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":69,"sizeDeletions":-8},{"number":"2","revision":"f853ea44a3bd993855ef186e7e656dc5276d16ee","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556141737,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556141766,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556144062,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"README.md","line":173,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"minimum"},{"file":"README.md","line":173,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":69,"sizeDeletions":-8},{"number":"3","revision":"fbd7a47645c155f39010e7f19ebde9a26e3bafcd","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556144393,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556144425,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556145205,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":69,"sizeDeletions":-8},{"number":"4","revision":"e53127641ded7d591c4b21dad6d76fa51477c51a","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556229315,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556229344,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":47,"deletions":-6},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":71,"sizeDeletions":-12},{"number":"5","revision":"efc2ffbe542d4eed43bc4a7b3be3d9d70255a1a5","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556317890,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556317920,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":60,"deletions":-6},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":48,"deletions":-16},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":132,"sizeDeletions":-28},{"number":"6","revision":"4cc6b2068a21091e3c19e39734d0c8fe8f7c33fb","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/6","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556666866,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556666915,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":60,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":11,"deletions":0},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":47,"deletions":-27},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":167,"sizeDeletions":-40},{"number":"7","revision":"4faabf7de27131f3aa1f4953b89aed6b990e5dc1","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/7","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556666989,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556668762,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":11,"deletions":0},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":25,"deletions":-1},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":47,"deletions":-27},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-40},{"number":"8","revision":"68e98fd92a944ef71bf801771d73f6ca00a6374a","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/8","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556750876,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556750911,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556901680,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}}],"comments":[{"file":"README.md","line":173,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"If I had a small manta, and I were running out of space so I deleted a couple very large files only and then assumed I\u0027d get the space back... Does this mean that I never would? Say there are only 2 files to delete (each on 2 makos) and that\u0027s less than min_batch_size... Won\u0027t those just sit there forever never freeing up space if I don\u0027t delete anything else?"},{"file":"README.md","line":173,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Josh: Just a thought, is a small manta something we want to design for? Maybe that case is an acceptable loss in most deployments? Not sure just offering that viewpoint."},{"file":"README.md","line":173,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I\u0027m not saying we should do anything differently. I just wanted to make sure my understanding here was correct. Specifically that if you only have a small number of deletes, you can get into a situation where you never do GC."},{"file":"README.md","line":173,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Josh, that\u0027s correct.  It will not flush unless it has a minimum number of lines.  At the same time, I\u0027d contend that by making the floor something that\u0027s tunable, I have designed this change for a small config.  Setting the min batch size to 1 essentially disables the low water mark and I *think* that\u0027s reasonable.\n\nAnother addition to the flushing pattern that is being entertained is performing a time-based flush that is granular to the bucket level, so that eventually, even something that does not meet the floor could still have a shot at getting flushed.  The tunable could change depending on how long an operator (or user) is willing to live with.  I\u0027m not doing that inside of this change though.  I would want that to be separate.  It\u0027s easier to test and review that way."},{"file":"lib/delete_record_transformer.js","line":251,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This will potentially be thousands of these log lines per minute correct? Is that volume of additional logging here ok?"},{"file":"lib/delete_record_transformer.js","line":251,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"I wonder if this is a good spot for `trace` instead of `info` unless we actually need this to be put to disk all the time?"},{"file":"lib/delete_record_transformer.js","line":251,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"or even just debug."},{"file":"lib/delete_record_transformer.js","line":251,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"lib/delete_record_transformer.js","line":251,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"This logging will only happen when a mako has reached its batch size.  If all makos really do accumulate equal to or greater than the ceiling on instructions per minute, then I\u0027d be shocked.  At any rate, the kind of volume of logging that you\u0027re talking about (I\u0027d agree) is not ok, but this won\u0027t yield that kind of logging.  In my opinion, this is probably the most important visible event that takes place in GC.  It should be logged."},{"file":"lib/delete_record_transformer.js","line":267,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"extra space?"},{"file":"lib/delete_record_transformer.js","line":267,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"lib/delete_record_transformer.js","line":314,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"How much total data do we expect this will add to the logs? Is that acceptable?"},{"file":"lib/delete_record_transformer.js","line":314,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Trace again maybe?"},{"file":"lib/delete_record_transformer.js","line":314,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Trace seems reasonable to me."},{"file":"lib/delete_record_transformer.js","line":314,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Sorry, forgot about this one.  I\u0027ll take care of it now."},{"file":"lib/moray_delete_record_cleaner.js","line":263,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Should we delete from the cache if the batch failed (e.g. returned err on line 237 above)?"},{"file":"lib/moray_delete_record_cleaner.js","line":263,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Yeah, I think we have to.  If we don\u0027t, the risk is bloat until we run out of memory.  Ultimately, I think we need a more robust way of handling failures in this area (wasn\u0027t intending to address that inside the scope of this cr though).  In my opinion, one of the worst things that can happen is we delete a row from the table before we\u0027ve had a chance to flush it to all relevant makos.  The good news is that if we\u0027re here, we know that all interested parties have the records that they need.  The worst thing that can happen is failure to remove it from the table.  There could be many different causes of failure and should treat them differently.  For example, I can imagine a failure because moray wasn\u0027t available (maybe it\u0027s getting hammered), or a different failure where the row that we\u0027re trying to remove (for some unknown reason) isn\u0027t in the table.  Who really knows.  At any rate, I think you make a cogent point if I\u0027m understanding correctly and that is that GC needs a more graceful way to fail and honestly, that\u0027s not limited to just here.  There are other stages as well.  I think we will pursue a more long term solution of the kind that we discussed earlier in zoom."},{"file":"lib/moray_delete_record_reader.js","line":63,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"This can be removed.  It was an artifact of an earlier change."},{"file":"lib/moray_delete_record_reader.js","line":89,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I will probably update this comment to clarify any records that have not yet been read in and cached are considered new records and those are at the location determined by the basic arithmetic below."},{"file":"lib/moray_delete_record_reader.js","line":181,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Does this belong at \u0027info\u0027 level?"},{"file":"lib/moray_delete_record_reader.js","line":181,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"It can probably go to debug or trace."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":45,"deletions":-24},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":161,"sizeDeletions":-38},{"number":"9","revision":"7f91b5f034419aac2d4a1a432962876e70d1bfa2","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/9","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556914133,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556914168,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/moray_delete_record_reader.js","line":389,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Even though this was originally logging, it could probably go to debug too.  Thoughts?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":50,"deletions":-26},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":166,"sizeDeletions":-40},{"number":"10","revision":"44a823205df408fcaf26486f5c3fa57c9e14571f","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/10","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556914413,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556914446,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556917884,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556917884,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556918947,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":50,"deletions":-26},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":166,"sizeDeletions":-40},{"number":"11","revision":"c0cbd2038d479e5be97dcac121a1e4b5d5c6a097","parents":["12a641a8aa4d70883ae35a6c26648d098b4ada01"],"ref":"refs/changes/58/6158/11","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1556919213,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556914446,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556917884,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556917884,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556918947,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1556919230,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/delete_record_transformer.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"lib/mako_instruction_uploader.js","type":"MODIFIED","insertions":32,"deletions":-2},{"file":"lib/moray_delete_record_cleaner.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/moray_delete_record_reader.js","type":"MODIFIED","insertions":50,"deletions":-26},{"file":"lib/schema.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"sapi_manifests/manta-garbage-collector/template","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":166,"sizeDeletions":-40}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}