From 577a3dad33c9ef511cfb0595d95359e067bd9f0d Mon Sep 17 00:00:00 2001
From: Dan McDonald <danmcd@joyent.com>
Date: Wed, 13 Jun 2018 21:08:21 -0400
Subject: [PATCH] Zero-length looped-back mblk hack

---
 usr/src/uts/common/io/overlay/overlay_mux.c | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/usr/src/uts/common/io/overlay/overlay_mux.c b/usr/src/uts/common/io/overlay/overlay_mux.c
index 9f70e8c83e..3418f5eadd 100644
--- a/usr/src/uts/common/io/overlay/overlay_mux.c
+++ b/usr/src/uts/common/io/overlay/overlay_mux.c
@@ -123,8 +123,19 @@ overlay_mux_recv(ksocket_t ks, mblk_t *mpchain, size_t msgsize, int oob,
 		 */
 		fmp = mp;
 		mp = fmp->b_cont;
-		fmp->b_cont = NULL;
-		freemsg(fmp);
+		freeb(fmp);
+
+		/*
+		 * In cases of looped-back vxlan, that tends to have a
+		 * prepended IP+UDP-only mblk, followed by the data.  Parsing
+		 * would've made that mblk a zero-length one (rptr == wptr).
+		 */
+		if (mp->b_rptr == mp->b_wptr && mp->b_cont != NULL) {
+			/* Ended up with zero-length mblk, lose it! */
+			fmp = mp;
+			mp = fmp->b_cont;
+			freeb(fmp);
+		}
 
 		/*
 		 * Decap and deliver.
@@ -152,10 +163,9 @@ overlay_mux_recv(ksocket_t ks, mblk_t *mpchain, size_t msgsize, int oob,
 				if (rem == blkl) {
 					fmp = mp;
 					mp = fmp->b_cont;
-					fmp->b_cont = NULL;
 					OVERLAY_FREEMSG(mp,
 					    "freed a fmp block");
-					freemsg(fmp);
+					freeb(fmp);
 				}
 			}
 			if (mp == NULL) {
-- 
2.21.0

