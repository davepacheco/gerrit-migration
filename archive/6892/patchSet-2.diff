From e4a934b4452d6d60e83a18e85968e23083679af5 Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Mon, 16 Sep 2019 11:59:49 -0400
Subject: [PATCH] MANTA-4514 incorrect Next-Marker response from
 ListBucketObjects when page ends on a delimiter group

---
 lib/server.js | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/lib/server.js b/lib/server.js
index 2454f13..f35dced 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -882,8 +882,10 @@ function listBuckets(options) {
             assert.string(record.name, 'record.name');
 
             if (record.type === 'group') {
+                assert.optionalString(record.nextMarker, 'record.nextMarker');
                 obj = {
                     name: record.name,
+                    nextMarker: record.nextMarker,
                     type: 'group'
                 };
 
@@ -1356,8 +1358,10 @@ function listObjects(options) {
             assert.string(record.name, 'record.name');
 
             if (record.type === 'group') {
+                assert.optionalString(record.nextMarker, 'record.nextMarker');
                 obj = {
                     name: record.name,
+                    nextMarker: record.nextMarker,
                     type: 'group'
                 };
 
@@ -1533,6 +1537,7 @@ function paginationStream(opts, onRecord, done) {
         // send the group record
         sendRecord({
             name: base + delimiter,
+            nextMarker: nextMarker,
             type: 'group'
         });
 
-- 
2.21.0

