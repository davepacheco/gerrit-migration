From 8d21cd5188179d13c01c76adac5d8766ddd71bcc Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Mon, 27 May 2019 11:14:37 -0700
Subject: [PATCH] TRITON-1706 'sdcadm post-setup dev-sample-data' should ensure
 sample images are public=true

---
 CHANGES.md                        |  5 ++++
 lib/post-setup/dev-sample-data.js | 38 +++++++++++++++++++++++++++----
 package.json                      |  2 +-
 3 files changed, 39 insertions(+), 6 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index a9e9d7a..ad091ac 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,11 @@
 
 # sdcadm Changelog
 
+## 1.27.2
+
+- TRITON-1706 'sdcadm post-setup dev-sample-data' will now ensure that sample
+  images are public.
+
 ## 1.27.1
 
 - TRITON-1670 sdcadm AddAllowTransferProcedure uses incorrect parameter name when listing service
diff --git a/lib/post-setup/dev-sample-data.js b/lib/post-setup/dev-sample-data.js
index 660d00c..7b54159 100644
--- a/lib/post-setup/dev-sample-data.js
+++ b/lib/post-setup/dev-sample-data.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -120,15 +120,27 @@ function addDevSampleImgs(opts, cb) {
                 }
             }, next);
         },
-        function checkIfHaveImgs(ctx, next) {
+        function createImgTodos(ctx, next) {
+            // A list of images we need to import from images.joyent.com.
             ctx.imgsToDownload = [];
+            // A list of images that have already have been imported, but
+            // have `public=false`. This might happen if they were imported
+            // from updates.joyent.com, e.g. if as an origin image for a core
+            // Triton/Manta component. The intent of this sdcadm command is
+            // to get public images (e.g. for use via CloudAPI ListImages).
+            ctx.imgsToMakePublic = [];
+
             vasync.forEachParallel({
                 inputs: ctx.imgs,
                 func: function checkImg(img, nextImg) {
-                    imgapi.getImage(img.uuid, function getImgCb(err, _img) {
+                    imgapi.getImage(img.uuid, function getImgCb(err, localImg) {
                         if (!err) {
-                            opts.progress('Already have image %s (%s@%s).',
-                                img.uuid, img.name, img.version);
+                            if (!localImg['public']) {
+                                ctx.imgsToMakePublic.push(img);
+                            } else {
+                                opts.progress('Already have image %s (%s@%s).',
+                                    img.uuid, img.name, img.version);
+                            }
                             nextImg();
                         } else if (err.restCode === 'ResourceNotFound') {
                             ctx.imgsToDownload.push(img);
@@ -149,6 +161,22 @@ function addDevSampleImgs(opts, cb) {
                 progress: opts.progress,
                 source: imagesJo.url
             }, next);
+        },
+        function makeImgsPublic(ctx, next) {
+            vasync.forEachParallel({
+                inputs: ctx.imgsToMakePublic,
+                func: function makeOneImgPublic(img, nextImg) {
+                    imgapi.updateImage(img.uuid, {'public': true},
+                        function updatedOneImg(err) {
+                            if (!err) {
+                                opts.progress('Made image %s (%s@%s) public.',
+                                    img.uuid, img.name, img.version);
+                            }
+                            nextImg(err);
+                        }
+                    );
+                }
+            }, next);
         }
     ]}, cb);
 }
diff --git a/package.json b/package.json
index 18a5923..7f73718 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a Triton Data Center",
-  "version": "1.27.1",
+  "version": "1.27.2",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

