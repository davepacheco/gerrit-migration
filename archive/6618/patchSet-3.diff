From afd96e910c3825e7b864c1cb82863dcda8c1e537 Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Wed, 17 Jul 2019 22:50:52 +0000
Subject: [PATCH] OS-7893 Early network admin causes network/physical service
 to fatally exit on certain bad configurations

---
 overlay/generic/lib/svc/method/net-physical | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/overlay/generic/lib/svc/method/net-physical b/overlay/generic/lib/svc/method/net-physical
index d4868c6d..9d3231df 100644
--- a/overlay/generic/lib/svc/method/net-physical
+++ b/overlay/generic/lib/svc/method/net-physical
@@ -499,6 +499,16 @@ if smf_is_globalzone; then
 
     [[ -n "$EARLY_ADMIN" ]] || plumb_admin
 
+    # If we performed early configuration of the admin network and
+    # the admin interface is on a link aggregation, the aggregation
+    # has already been configured.  Add it to the list of active aggrs
+    # so the checks in vnic_up[6] are aware of it.
+    if [[ -n "$EARLY_ADMIN" && "${SYSINFO_NIC_admin}" =~ aggr[0-9]+$ ]]; then
+        eval "macs=\${SYSINFO_Aggregation_${SYSINFO_NIC_admin}_MACs}"
+
+        add_active_aggr_links ${SYSINFO_NIC_admin} $macs
+    fi
+
     # Prefer the config file for admin nic values, but use
     # bootparams if present
     admin_ip=${CONFIG_admin_ip}
-- 
2.21.0

