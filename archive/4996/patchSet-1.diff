From 14c3dadfedbba5ffccb368789a55727b6bbe3e71 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Tue, 23 Oct 2018 23:00:47 +0000
Subject: [PATCH] MANTA-3977 improve manta-garbage-collector documentation

---
 README.md | 341 +++++++++---------------------------------------------
 1 file changed, 54 insertions(+), 287 deletions(-)

diff --git a/README.md b/README.md
index f6031cc..ea31feb 100644
--- a/README.md
+++ b/README.md
@@ -14,10 +14,20 @@ This repository is part of the Joyent Manta project.  For contribution
 guidelines, issues, and general documentation, visit the main
 [Manta](http://github.com/joyent/manta) project page.
 
-This is the garbage collection system for Manta. It comprises of a
-service for processing metadata records pointing to deleted objects
-and then ensuring the corresponding backing files are removed from the
-appropriate Mako zones.
+# Overview
+
+The Manta garbage-collector is a new component added as part of [RFD
+143](https://github.com/joyent/rfd/blob/master/rfd/0143/README.md). It is
+responsible for reading delete records added to the `manta_fastdelete_queue` and
+producing instructions to delete backing files from the storage nodes on which the
+objects exists. These instructions are syntactically identical to those
+generated by the backup-based GC pipeline, and they are still processed by a cron job
+that runs on all storage nodes in Manta.
+
+**Garbage-collector processes are intended to be used only in deployments with
+snaplink-disabled accounts**. To avoid any confusion, garbage-collector instances
+will not start (the SMF service will enter the 'maintenance' state) if the Manta
+deployment has no snaplink-disabled accounts.
 
 # Running the Server
 
@@ -29,7 +39,17 @@ root of the repository with `$ LOG_LEVEL=<level> bin/server`.
 
 The garbage-collector uses [catest](https://github.com/joyent/catest) for auto
 tests. Each major component has a corresponding test script in the `test/`
-directory. To run all the tests with the most verbose logging run:
+directory. Running the tests requires that you have a working Triton/Manta
+deployment with a recently updated metadata schema (metadata nodes must have
+`manta_fastdelete_queue`s).
+
+In order to run the test, you'll need to set up a `etc/testconfig.json`
+to match your environment (use `etc/testconfig.json.template` as a guide. This
+file closely mimcs the configuration that is passed to a garbage-collector in
+a real deployment. For further discussion of what these fields mean, see the
+"Configuration" section.
+
+Once you've set up the test configuration, run the tests with:
 ```
 $ LOG_LEVEL=debug make test
 ```
@@ -40,12 +60,6 @@ space-separated list of test files that should be run on each `make test`. Each
 `*.test.js` is a self-contained test that exercises multiple use-cases of that
 component.
 
-Running the auto tests will require a Manta deployment with at a Muskie that has
-picked up the change introduced in
-[this](https://github.com/joyent/node-libmanta/commit/2ab2c0c7596ac003e2169b634924784b8f6a268a)
-commit. Some tests may fail if the `manta_fastdelete_queue`s in your deployment
-have a very large number of entries which are not otherwise being processed.
-
 # Node Version
 
 The garbage collector targets and has been tested with node-4.8.7.
@@ -54,45 +68,27 @@ The garbage collector targets and has been tested with node-4.8.7.
 
 ## Process Level Configuration File Structure
 
-The configuration in `etc/config.json` is an example of how the garbage
-collector is configured. Some chunks of this configuration are described below:
-* `manta`: A JSON object passed to node-manta's `createClient`.
-* `moray`: A JSON object with options passed to node-moray's `createClient`. At
-minimum, this must include a resolver.
-* `shards`: A JSON object describing which shards, and which buckets on each of
-those shards, to process delete records from.
-* `creators`: An array of objects with a single field, `uuid`. Any delete
-records whose `value.creator` field doesn't match the `uuid` field of some
-object in this array will be ignored. This field will be initialized with the
-SAPI value `ACCOUNTS_SNAPLINKS_DISABLED`, introduced
-[here](https://github.com/joyent/manta-muskie/commit/760857dbf5d30f5734b4ac21e097628824bb6569).
-* `params`: A JSON object with two principal sub-objects describing
-how records should be read from Moray shards, and how Mako instruction
-objects should be uploaded to Manta.
-* `address`/`port`: The address and port on which to start the HTTP management
-interface described above.
-* `capacity`: The total cache capacity (readable and configurable via the
-`/cache` endpoint described above). Configuration
-
-The configuration in `etc/config.json` is an example of how the garbage
+The configuration in `etc/config.json.template` is an example of how the garbage
 collector is configured. Some chunks of this configuration are described below:
 * `manta`: A JSON object passed to node-manta's `createClient`.
 * `moray`: A JSON object with options passed to node-moray's `createClient`. At
 minimum, this must include a resolver.
-* `shards`: A JSON object describing which shards, and which buckets on each of
-those shards, to process delete records from.
-* `creators`: An array of objects with a single field, `uuid`. Any delete
+* `shards`: A JSON array of objects. Each object has a "host" field which is the
+SRV domain for a given metadata shard. The last object in this array must have a
+"last" boolean field set to true. This syntax is required by Mustache.
+* `buckets`: A JSON array of objects. Each object must have a "name" field whose
+value is the name of the Moray bucket from which the garbage-collector should
+stream records. This bucket must be present on all shards in the `shards` array.
+* `allowed_creators`: An array of objects with a single field, `uuid`. Any delete
 records whose `value.creator` field doesn't match the `uuid` field of some
 object in this array will be ignored. This field will be initialized with the
-SAPI value `ACCOUNTS_SNAPLINKS_DISABLED`, introduced
-[here](https://github.com/joyent/manta-muskie/commit/760857dbf5d30f5734b4ac21e097628824bb6569).
-* `params`: A JSON object with two principal sub-objects describing
-how records should be read from Moray shards, and how Mako instruction
-objects should be uploaded to Manta.
+SAPI value `ACCOUNTS_SNAPLINKS_DISABLED`, which originates from the Manta SAPI
+application.
+* `tunables`: A JSON object. This object consists of performance-tunables such
+as batch-sizes and various delays. The next section contains more detailed
+descriptions of each of the fields in this object.
 * `address`/`port`: The address and port on which to start the HTTP management
 interface described above.
-* `capacity`: The total cache capacity (readable and configurable via the
-`/cache` endpoint described above).
 
 ## Operating Garbage-Collectors
 
@@ -134,14 +130,9 @@ garbage-collector service object on `manta-init`:
   consumption of a collector on a system experiencing memory pressure.
 * `GC_MANTA_FASTDELETE_QUEUE_CONCURRENCY` - The number of workers to allocate to
   reading processing records from the `manta_fastdelete_queue`.
-* `[GC_SHARD_NUM_LO, GC_SHARD_NUM_HI]` - The inclusive numeric range of shards
-  from which the garbage-collector will read records from.
 
 Each of these SAPI values can be overridden in the instance object of a single
-collector. By default, `[GC_SHARD_NUM_LO, GC_SHARD_NUM_HI] = [0,0]`. When
-collectors start up and find this to be the case, they will print an explanatory
-log message and remain idle. Operators should use SAPI tools to set the ranges
-appropriately and restart the garbage-collectors.
+collector.
 
 # Metrics
 
@@ -158,10 +149,13 @@ to node-fast metrics for the two RPCs it uses: `findObjects`, and `batch`.
 
 # HTTP Management Interface
 
-Each garbage collector process starts a restify http server listening on port
-2020 by default (this is configurable). The server supports the following
-endpoints:
+Each garbage-collector process starts a restify http server listening on port
+2020 by default (this is configurable). **Any configuration changes made through
+this interface will not persist**. This interface is intended for
+one-off experiments with tunable changes. To persist changes, make them via
+SAPI.
 
+The server supports the following endpoints:
 ```
 Request:
 
@@ -179,7 +173,6 @@ Endpoints listed under `/workers` implement worker control. Supported
 actions include **listing**, **pausing**, and **resuming** the
 workers. Newly created workers start in the running phase, even if
 other workers are paused.
-
 ```
 Request:
 
@@ -248,270 +241,44 @@ Response:
 }
 ```
 
-Retrieve tunables relevant to the upload of Mako GC instructions:
+Retrieve performance tunables:
 ```
-GET /mako
+GET /tunables
 
 Response:
 
 {
 	"instr_upload_batch_size": integer,
 	"instr_upload_flush_delay": integer,
-	"instr_upload_path_prefix": string
-}
-```
-
-* `instr_upload_batch_size`:  the target number of lines to include in each
-instruction object.
-* `instr_upload_flush_delay`: number of milliseconds between periodic cached
-  instruction uploads. Used to prevent cache entries from waiting around too
-long if there aren't sufficient enough delete records in the bucket we're
-reading from to reach the batch size.
-* `instr_upload_path_prefix`: The Manta path to which the garbage collector will
-upload Mako GC instruction objects. If the value of this tunable is `$PATH`,
-then the garbage collector will upload objects for shark `$SHARK` in
-`$PATH/$SHARK`, creating the `$SHARK` directory if necessary. In practice, we'll
-set this to `/poseidon/stor/manta_gc/mako`, which is where instruction objects
-are uploaded by the offline GC process.
-
-The following request allows an operator to modify any of the tunables returned
-by the previous endpoint.
-```
-POST /mako
-Content-Type: application/json
-
-{
-	"instr_upload_batch_size": integer,
-	"instr_upload_flush_delay": integer,
-	"instr_upload_path_prefix": string
-}
-
-Response:
-
-{
-	ok: boolean,
-	when: ISO timestamp
-}
-```
-
-Retrieve shard-specific GC configuration. This configuration is used by all GC
-workers that are retrieving records from the shard identified in the url.
-Broadly, the configuration describes what buckets on the shard to read, and how
-to read them. The `:shard` url parameter is a number describing which shards
-configuration to read.
-```
-GET /shards/:shard
-
-Response:
-
-{
-	"buckets": [
-		{
-			"bucket": "manta_fastdelete_queue|manta_delete_log",
-			"concurrency": integer
-		}
-		...
-	],
-	"record_read_batch_size": integer,
-	"record_read_wait_interval": integer (ms),
-	"record_read_sort_attr": "_mtime",
-	"record_read_sort_order": "asc|ASC|desc|DESC",
-	"record_delete_batch_size": integer,
-	"record_delete_delay": integer (ms)
-}
-
-Failure:
-
-{
-	ok: false,
-	err: 'No GC worker for shard ":shard"'
-}
-```
-* `buckets`: An array of objects, each of which describes how many GC workers
-should be allocated to processing records in that bucket. Today, we only support
-reading records from `manta_fastdelete_queue` and `manta_delete_log`.
-* `record_read_batch_size`: The number of records to read with each Moray
-`findObjects` RPC. This is fed into the `limit` option passed to that RPC.
-* `record_read_sort_attr`: Which attribute to sort by when processing records.
-* `record_read_sort_ord`: What order to use when sorting records.
-* `record_delete_batch_size`: How many records to delete with a single Moray
-`batch` RPC.
-* `record_delete_delay`: The threshold amount of time a worker will wait since
-the last successful `batch` RPC before issuing a 'periodic' `batch`.
-
-Modify any of the tunables returned by the previous endpoint by passing a JSON
-object describing the new desired values. This will affect the behavior of all
-workers reading records from shard `:shard`, creating or destroying workers if
-an entry is added to, or removed from, the `buckets` array.
-```
-POST /shards/:shard
-Content-Type: application/json
-
-{
-	"buckets": [
-		{
-			"bucket": "manta_fastdelete_queue|manta_delete_log",
-			"concurrency": integer
-		}
-		...
-	],
+	"instr_upload_path_prefix": string,
 	"record_read_batch_size": integer,
 	"record_read_wait_interval": integer (ms),
 	"record_read_sort_attr": "_mtime",
 	"record_read_sort_order": "asc|ASC|desc|DESC",
 	"record_delete_batch_size": integer,
 	"record_delete_delay": integer (ms)
-
-}
-
-Response:
-
-{
-	ok: boolean,
-	when: ISO timestamp
-}
-
-Failure:
-
-{
-	ok: false,
-	err: 'No GC worker for shard ":shard"'
 }
 ```
 
-The `/shards` endpoint, described below should be used for two purposes:
-1. To modify the configuration of all shards. This is equivalent to applying the
-changes included in the JSON body to all shards the garbage collector is
-processing via the `/shards/:shard` endpoint. Changes applied in this manner
-affect the 'default' shard configuration which is used by any newly created
-workers.
-2. To modify the range of shards that the garbage collector is responsible for
-processing.
-
+The following request allows an operator to modify any of the tunables returned
+by the previous endpoint.
 ```
-POST /shards
+POST /tunables
 Content-Type: application/json
 
 {
-	"interval": [lo, hi],
-	"buckets": [
-		{
-			"bucket": "manta_fastdelete_queue|manta_delete_log",
-			"concurrency": integer
-		}
-		...
-	],
+	"instr_upload_batch_size": integer,
+	"instr_upload_flush_delay": integer,
+	"instr_upload_path_prefix": string
 	"record_read_batch_size": integer,
 	"record_read_wait_interval": integer (ms),
 	"record_read_sort_attr": "_mtime",
 	"record_read_sort_order": "asc|ASC|desc|DESC",
 	"record_delete_batch_size": integer,
 	"record_delete_delay": integer (ms)
-
-}
-
-Response:
-
-{
-	ok: boolean
-	when: ISO timestamp
-}
-```
-As described above, changes to configuration applied via this endpoint are
-applied to all existing and future workers.
-
-* `interval`: specifies a range of shard numbers the garbage collector should
-process delete records from. This endpoint enforces that `lo` is less than or
-equal to `hi`.
-	* If `lo == hi`, then only the one shard identified by `lo` will be
-	  GC'd.
-	* If `lo < hi`, all shards in the range `lo..hi` will be GC'd from.
-
-If the range includes a shard number that does not exist in the Manta
-deployment, or the request triggers the creation of some number of workers for
-shards that are unresponsive, no change to the range of shards processed be the
-GC process will occur.
-
-```
-GET /shards
-
-Response:
-{
-	"interval": [lo, hi],
-	"buckets": [...]
-}
-```
-Note: the configuration returned by this endpoint may differ from the
-configuration returned by `GET /shards/:shard` for a specific `:shard` if the
-operator has overridden configuration for that shard specifically.
-
-The garbage collector supports a global limit on the total number of cache
-entries that garbage collector can hold. The admin interface exposes two
-endpoints for reading and modifying this information.
-
-### Some Examples
-
-For example, if the garbage collector were running on the local host and the
-operator wanted to change the read batch size for all shards the process is
-reading records from, that would look like this:
-```
-$ curl -X POST -H 'content-type: application/json' localhost:2020/shards \
-	-d '{"record_read_batch_size": 10}'
-```
-If the operator wanted the garbage collector to only process records from the
-`manta_fastdelete_queue` on all shards, that would look like this:
-```
-$ curl -X POST -H 'content-type: application/json' localhost:2020/shards \
-	-d '{
-	"buckets":[
-		{"bucket": "manta_fastdelete_queue", "concurrency": 1},
-		{"bucket": "manta_delete_log", "concurrency": 0}
-	]}'
-```
-If the operator wanted to also process `manta_delete_log` records on shard 47,
-that would look like this:
-```
-$ curl -X POST -H 'content-type: application/json' localhost:2020/shards/47 \
-	-d '{
-		"buckets":[
-			{"bucket": "manta_fastdelete_queue", "concurrency": 1},
-			{"bucket": "manta_delete_log", "concurrency": 1}
-		]
-	}'
-```
-
-If the operator wanted to GC objects in the shard range [5-10], that command
-would look like this:
-```
-$ curl -X POST -H 'content-type: application/json' localhost:2020/shards \
-	-d '{"interval": [5, 10]}'
-```
-
-```
-GET /cache
-
-Response:
-
-{
-	"cache": {
-		"capacity": integer,
-		"used": integer
-	}
-}
-```
-* `cache`: number of allowed cache entries
-* `used`: number of cache entries currently used by the collector
-
-```
-POST /cache
-Content-Type: application/json
-
-{
-	"capacity": integer
 }
 
 Response:
-
 {
 	ok: boolean,
 	when: ISO timestamp
-- 
2.21.0

