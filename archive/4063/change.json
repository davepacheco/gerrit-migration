{"project":"joyent/illumos-joyent","branch":"master","topic":"OS-6992","id":"If7d0086cff41f34796511cdbb454eedbaa8ee9c8","number":"4063","subject":"OS-6992 Want hypervisor API for FPU management OS-6999 bhyve should use HMA FPU framework Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/4063","commitMessage":"OS-6992 Want hypervisor API for FPU management\nOS-6999 bhyve should use HMA FPU framework\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1527799937,"lastUpdated":1528837539,"open":false,"status":"MERGED","comments":[{"timestamp":1527799937,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1527799963,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Integration-Approval-1\n\nThis isn\u0027t ready yet. This is being put out to get some initial feedback on the design and idea."},{"timestamp":1527893682,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)\n\nLook good at first glance"},{"timestamp":1528243888,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1528246706,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1528246765,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1528247162,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1528247268,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Topic set to OS-6992"},{"timestamp":1528306415,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4."},{"timestamp":1528306511,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: -Integration-Approval\n\n(1 comment)"},{"timestamp":1528427771,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(8 comments)"},{"timestamp":1528497767,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5."},{"timestamp":1528672683,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 6."},{"timestamp":1528672756,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6:\n\n(8 comments)"},{"timestamp":1528672793,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6:\n\nThe API should have never asked for what the initial xbv state should be, we\u0027re just resetting it to basically the default state."},{"timestamp":1528711376,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6:\n\n(14 comments)"},{"timestamp":1528738001,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6:\n\n(14 comments)\n\nI\u0027m not going to push an update to this until after we get the avx512 bits squared off as that will likely change a few things. John let me know what you think of the naming question."},{"timestamp":1528753005,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1528822487,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 7."},{"timestamp":1528822963,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1528823318,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 8."},{"timestamp":1528823423,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1528823794,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1528827493,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1528831861,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1528836789,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 9: Patch Set 8 was rebased."},{"timestamp":1528837005,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1528837539,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"10","revision":"f7d0086cff41f34796511cdbb454eedbaa8ee9c8","parents":["2d6c2da33710f0ac11e240fa703d7f072540d9f0"],"ref":"refs/changes/63/4063/10","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528837005,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528823794,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528827493,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528831861,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1528837539,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/compat/freebsd/amd64/machine/fpu.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":30,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":224,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":363,"sizeDeletions":-129},"patchSets":[{"number":"1","revision":"e590ce9666c23ed5b64ebb9ef4c98ff16e06b2e5","parents":["799bd0686522010a51353501cca8e00c1246d723"],"ref":"refs/changes/63/4063/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1527799937,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1527799963,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":502,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Instead of having this be a no-op, I would just #ifdef-guard the call in restore_guest_fpustate() and include a comment there about why it\u0027s not needed."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":502,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Hmm. OK, you\u0027d find that clearer? I was just trying to keep it there so it was a bit clearer and less ifdefs. But I\u0027m happy either way."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":502,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Coming back to this when I was trying to write the new comment, I actually think that it makes more sense to keep here. This way we have it clearly commented in the same place as everything else what it does and why we aren\u0027t using it right now."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":13,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"trailing space"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":219,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps we want to consider updating vmm_host_state_init() (via ifdef) to use this logic (fp_save_mech and ...get_xsave_size()) rather than the manual freebsd bits."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":219,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Hmm. Yeah. We should consider exposing more here for this purpose. Would you mind if we came back and cleaned up that part at a future pass?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":31,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":229,"deletions":0}],"sizeInsertions":261,"sizeDeletions":-123},{"number":"2","revision":"57348596ee9e92151489f2fc471cc36b9034143d","parents":["799bd0686522010a51353501cca8e00c1246d723"],"ref":"refs/changes/63/4063/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528246765,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1527799963,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":31,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":233,"deletions":0}],"sizeInsertions":265,"sizeDeletions":-123},{"number":"3","revision":"d9246b07b81e370a1b430e9dbe6a3073935e4689","parents":["799bd0686522010a51353501cca8e00c1246d723"],"ref":"refs/changes/63/4063/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528247162,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1527799963,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":31,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":233,"deletions":0}],"sizeInsertions":265,"sizeDeletions":-123},{"number":"4","revision":"1e70a11c8f1f940a8e67db125af280c70f2fdaa1","parents":["c4c6537e10afdbfcc5221e2f9c3d5d80780235fa"],"ref":"refs/changes/63/4063/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528306415,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":90,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is that an error we really wish to tolerate?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":90,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t consider it an error to pass NULL. Mostly just trying to make it easier for error handling routines."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":162,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Shouldn\u0027t the following check be adequate?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":162,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":200,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"One can set both fxsave and xsave states, but only get the fxsave state.  Is this intended?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":200,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"You can only set fxsave state today. We have to handle the fact that when saving fxsave state that the OS is actually using the xsave information."},{"file":"usr/src/uts/i86pc/sys/hma.h","line":13,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Already fixed (wasn\u0027t in push)."},{"file":"usr/src/uts/i86pc/sys/hma.h","line":65,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sentence fragment, perhaps omit?"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":65,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":67,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"no hyphen"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":67,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":81,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: OS"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":81,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":82,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sentence fragment, perhaps omit?"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":82,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":84,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"no hyphen"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":84,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":31,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":241,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":105,"deletions":0}],"sizeInsertions":378,"sizeDeletions":-123},{"number":"5","revision":"38d9959909b6eff21e73feb457162c2831bb19a8","parents":["788e26d53d698f1ae7fc91da6c1c4cd40d05dfd8"],"ref":"refs/changes/63/4063/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528497767,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":31,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":240,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0}],"sizeInsertions":375,"sizeDeletions":-123},{"number":"6","revision":"c46f45189b9de8ffec83066f866bab15a312e70c","parents":["788e26d53d698f1ae7fc91da6c1c4cd40d05dfd8"],"ref":"refs/changes/63/4063/6","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528672683,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":517,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"While it\u0027s defined in freebsd, we no longer need it in our compat headers, maybe remove the define? (fine if not bothered)"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":517,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, removed."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":551,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, don\u0027t need this line?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":551,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s a void * so I\u0027d rather make the actual type clear and not rely on just implicit casting. But I can change this if others prefer?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":551,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"fine by me"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":564,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, don\u0027t need this line?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","line":564,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s a void * so I\u0027d rather make the actual type clear and not rely on just implicit casting. But I can change this if others prefer?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":32,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"(optional) worth putting in fp.h now we do this from several places?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":32,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":36,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Would this be better named as \"hf_guest_fpu\" or something indicating it always holds guest state?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":36,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":42,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think we inherited the \"reset\" from vmm.c, but I think this is better named \"hma_fpu_init()\" in terms of how it\u0027s used?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":42,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So this does get called every time we need to reset the FPU. So if someone does a reboot, this should get called again to reset the FPU state to the default. I guess I\u0027m not sure what makes more sense then. Thoughts?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":42,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Don\u0027t feel strongly, but I\u0027d expect a \"reset\" to happen outside of an init path, and that\u0027s not the case here. Arguably, all \"init\"s are \"reset\"s if you include reboot."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":56,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"If you do the above, s/Rezero/Zero/"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":56,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":58,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"missing )"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":58,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":63,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"If possible depending on commit ordering, XFEATURE_FP_INITIAL?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":63,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yeah, depending on rebase ordering, will do."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":80,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I agree with line 78, but when could *this* line not be true? An allocated hma_fpu_t with a NULL kfpu_generic pointer seems inconsistent and a programming error"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":80,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Mostly paranoia. But I guess you\u0027re right. I\u0027ll just assert it."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":83,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"What\u0027s the point of this line?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":83,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Mostly paranoia, but I\u0027ve removed it."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":90,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I don\u0027t really see what a client could usefully do in a KM_NOSLEEP context given the alloc could fail, can\u0027t we presume KM_SLEEP here?"},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":90,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I didn\u0027t want to force the assumptions of that onto the clients as I didn\u0027t know all he different cases well enough."},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","line":90,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Well we know the cases: there are two, and they both do KM_SLEEP. Seems like over-generalization; this isn\u0027t an ABI. Having said that, I\u0027m fine if you feel like it should stay."},{"file":"usr/src/uts/i86pc/sys/hma.h","line":43,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"remove param name"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":43,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":89,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"fxsave?"},{"file":"usr/src/uts/i86pc/sys/hma.h","line":89,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Good catch, thanks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":30,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":229,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0}],"sizeInsertions":363,"sizeDeletions":-123},{"number":"7","revision":"2784d94f9269db2038b34fe743c88a14836ac907","parents":["a33f24fd1b0665ec1cb9f57b5e860fed1d393793"],"ref":"refs/changes/63/4063/7","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528822487,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/intel/sys/fp.h","line":348,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"can now also remove from intel/ia32/os/archdep.c"},{"file":"usr/src/uts/intel/sys/fp.h","line":348,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/compat/freebsd/amd64/machine/fpu.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":30,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":224,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":362,"sizeDeletions":-125},{"number":"8","revision":"13c73529d8662faa52ec46d27644d03d836e7759","parents":["a33f24fd1b0665ec1cb9f57b5e860fed1d393793"],"ref":"refs/changes/63/4063/8","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528823318,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528827493,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528831861,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528823794,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/compat/freebsd/amd64/machine/fpu.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":30,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":224,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":363,"sizeDeletions":-129},{"number":"9","revision":"e0d6762ad81a83b86e2d96d6a255661055692a31","parents":["2d6c2da33710f0ac11e240fa703d7f072540d9f0"],"ref":"refs/changes/63/4063/9","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528836789,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528827493,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528831861,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528823794,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/compat/freebsd/amd64/machine/fpu.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":30,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":224,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":363,"sizeDeletions":-129},{"number":"10","revision":"f7d0086cff41f34796511cdbb454eedbaa8ee9c8","parents":["2d6c2da33710f0ac11e240fa703d7f072540d9f0"],"ref":"refs/changes/63/4063/10","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1528837005,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1528837539,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528827493,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528831861,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528823794,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/compat/freebsd/amd64/machine/fpu.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_glue.c","type":"MODIFIED","insertions":30,"deletions":-123},{"file":"usr/src/uts/i86pc/os/hma_fpu.c","type":"ADDED","insertions":224,"deletions":0},{"file":"usr/src/uts/i86pc/sys/hma.h","type":"ADDED","insertions":103,"deletions":0},{"file":"usr/src/uts/intel/ia32/os/archdep.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":363,"sizeDeletions":-129}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}