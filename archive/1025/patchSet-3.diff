commit dbc12098d1f9786785015764a362a8059d03bad4 (refs/changes/25/1025/3)
Author: Chris Burroughs <chris.burroughs@joyent.com>
Date:   2016-12-01T14:20:04-05:00 (2 years, 10 months ago)
    
    joyent/node-triton#108 support passphrase protected keys

diff --git a/CHANGES.md b/CHANGES.md
index a67065a..9ce97ca 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -7,6 +7,61 @@ Known issues:
 
 ## not yet released
 
+- **BREAKING CHANGE for module usage of node-triton.**
+  To implement joyent/node-triton#108, the way a TritonApi client is
+  setup for use has changed from being sync to async. Therefore what
+  used to be:
+
+        var triton = require('triton');
+        var client = triton.createClient({      # No longer works.
+            profile: {
+                url: "<cloudapi url>",
+                account: "<account login for this cloud>",
+                keyId: "<ssh key fingerprint for one of account's keys>"
+            }
+        });
+
+  is now:
+
+        var triton = require('triton');
+        triton.createClient({
+            profile: {
+                url: "<cloudapi url>",
+                account: "<account login for this cloud>",
+                keyId: "<ssh key fingerprint for one of account's keys>"
+            }
+        }, function (initErr, client) {
+            if (initErr) boom(initErr);
+
+            triton.promptPassphraseUnlockKey({
+                tritonapi: client
+            }, function (unlockErr) {
+                if (unlockErr) boom(unlockErr);
+
+                // Use `client`...
+            });
+        });
+
+  First, the initialization done by `createClient` is async as it always should
+  have been, to find a matching SSH key for the given `keyId`. Second, in the
+  case where an encrypted SSH private key is specified (which isn't in an
+  ssh-agent), one needs to manually unlock it with its passphrase. The
+  new `triton.promptPassphraseUnlockKey` is a convenience function for this.
+  See full `TritonApi` setup details in the top comment in
+  [lib/tritonapi.js](lib/tritonapi.js).
+
+- [joyent/node-triton#108] Support for passphrase-protected private keys.
+  Before this work, an encrypted private SSH key (i.e. protected by a
+  passphrase) would have to be loaded in an ssh-agent for the `triton`
+  CLI to use it. Now `triton` will prompt for the passphrase to unlock
+  the private key (in memory), if needed. For example:
+
+        $ triton package list
+        Enter passphrase for id_rsa:
+        SHORTID   NAME             MEMORY  SWAP  DISK  VCPUS
+        14ad9d54  g4-highcpu-128M    128M  512M    3G      -
+        14ae2634  g4-highcpu-256M    256M    1G    5G      -
+        ...
 - [joyent/node-triton#143] Fix duplicate output from 'triton rbac key ...'.
 
 ## 4.15.0
diff --git a/examples/example-list-instances.js b/examples/example-list-instances.js
index 1f8c272..ef28628 100755
--- a/examples/example-list-instances.js
+++ b/examples/example-list-instances.js
@@ -27,20 +27,37 @@ var log = bunyan.createLogger({
  * For example, if you want to use an existing `triton` CLI profile, you can
  * pass that profile name in.
  */
-var client = triton.createClient({
+var tritonapi = triton.createClient({
     log: log,
     profile: {
         url: URL,
         account: ACCOUNT,
         keyId: KEY_ID
+    }}
+);
+tritonapi.init(function (initErr) {
+    if (initErr) {
+        log.fatal(initErr);
+        return;
     }
+
+    triton.promptPassphraseUnlockKey({
+        tritonapi: tritonapi
+    }, function (unlockErr) {
+        if (unlockErr) {
+            log.fatal(unlockErr);
+            return;
+        }
+        // TODO: Eventually the top-level TritonApi will have
+        // `.listInstances()` to use.
+        tritonapi.cloudapi.listMachines(function (err, insts) {
+            // Remember to close the client to close TCP conn.
+            tritonapi.close();
+            if (err) {
+                console.error('listInstances err:', err);
+            } else {
+                console.log(JSON.stringify(insts, null, 4));
+            }
+        });
+    });
 });
-// TODO: Eventually the top-level TritonApi will have `.listInstances()` to use.
-client.cloudapi.listMachines(function (err, insts) {
-    client.close();   // Remember to close the client to close TCP conn.
-    if (err) {
-        console.error('listInstances err:', err);
-    } else {
-        console.log(JSON.stringify(insts, null, 4));
-    }
-});
\ No newline at end of file
diff --git a/lib/cli.js b/lib/cli.js
index 2dcf50a..4df29d9 100644
--- a/lib/cli.js
+++ b/lib/cli.js
@@ -27,7 +27,7 @@ var vasync = require('vasync');
 var common = require('./common');
 var mod_config = require('./config');
 var errors = require('./errors');
-var tritonapi = require('./tritonapi');
+var lib_tritonapi = require('./tritonapi');
 
 
 
@@ -158,7 +158,7 @@ var OPTIONS = [
         help: 'A cloudapi API version, or semver range, to attempt to use. ' +
             'This is passed in the "Accept-Version" header. ' +
             'See `triton cloudapi /--ping` to list supported versions. ' +
-            'The default is "' + tritonapi.CLOUDAPI_ACCEPT_VERSION + '". ' +
+            'The default is "' + lib_tritonapi.CLOUDAPI_ACCEPT_VERSION + '". ' +
             '*This is intended for development use only. It could cause ' +
             '`triton` processing of responses to break.*',
         hidden: true
@@ -302,16 +302,16 @@ CLI.prototype.init = function (opts, args, callback) {
         return self._profile;
     });
 
-    this.__defineGetter__('tritonapi', function getTritonapi() {
-        if (self._tritonapi === undefined) {
-            self._tritonapi = tritonapi.createClient({
-                log: self.log,
-                profile: self.profile,
-                config: self.config
-            });
-        }
-        return self._tritonapi;
-    });
+    try {
+        self.tritonapi = lib_tritonapi.createClient({
+            log: self.log,
+            profile: self.profile,
+            config: self.config
+        });
+    } catch (createErr) {
+        callback(createErr);
+        return;
+    }
 
     if (process.env.TRITON_COMPLETE) {
         /*
@@ -326,21 +326,21 @@ CLI.prototype.init = function (opts, args, callback) {
          * Example usage:
          *      TRITON_COMPLETE=images triton -p my-profile create
          */
-        this._emitCompletions(process.env.TRITON_COMPLETE, function (err) {
+        self._emitCompletions(process.env.TRITON_COMPLETE, function (err) {
             callback(err || false);
         });
     } else {
         // Cmdln class handles `opts.help`.
-        Cmdln.prototype.init.apply(this, arguments);
+        Cmdln.prototype.init.call(self, opts, args, callback);
     }
 };
 
 
 CLI.prototype.fini = function fini(subcmd, err, cb) {
     this.log.trace({err: err, subcmd: subcmd}, 'cli fini');
-    if (this._tritonapi) {
-        this._tritonapi.close();
-        delete this._tritonapi;
+    if (this.tritonapi) {
+        this.tritonapi.close();
+        delete this.tritonapi;
     }
     cb();
 };
@@ -361,7 +361,7 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
 
     var cacheFile = path.join(this.tritonapi.cacheDir, type + '.completions');
     var ttl = 5 * 60 * 1000; // timeout of cache file info (ms)
-    var cloudapi = this.tritonapi.cloudapi;
+    var tritonapi = this.tritonapi;
 
     vasync.pipeline({arg: {}, funcs: [
         function tryCacheFile(arg, next) {
@@ -377,13 +377,25 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                 }
             });
         },
+        function initAuth(args, next) {
+            tritonapi.init(function (initErr) {
+                if (initErr) {
+                    next(initErr);
+                }
+                if (tritonapi.keyPair.isLocked()) {
+                    next(new errors.TritonError(
+                        'cannot unlock keys during completion'));
+                }
+                next();
+            });
+        },
 
         function gather(arg, next) {
             var completions;
 
             switch (type) {
             case 'packages':
-                cloudapi.listPackages({}, function (err, pkgs) {
+                tritonapi.cloudapi.listPackages({}, function (err, pkgs) {
                     if (err) {
                         next(err);
                         return;
@@ -402,7 +414,7 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                 });
                 break;
             case 'images':
-                cloudapi.listImages({}, function (err, imgs) {
+                tritonapi.cloudapi.listImages({}, function (err, imgs) {
                     if (err) {
                         next(err);
                         return;
@@ -424,7 +436,7 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                 });
                 break;
             case 'instances':
-                cloudapi.listMachines({}, function (err, insts) {
+                tritonapi.cloudapi.listMachines({}, function (err, insts) {
                     if (err) {
                         next(err);
                         return;
@@ -449,7 +461,7 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                  * on that is that with the additional prefixes, there would
                  * be too many.
                  */
-                cloudapi.listMachines({}, function (err, insts) {
+                tritonapi.cloudapi.listMachines({}, function (err, insts) {
                     if (err) {
                         next(err);
                         return;
@@ -470,7 +482,7 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                 });
                 break;
             case 'networks':
-                cloudapi.listNetworks({}, function (err, nets) {
+                tritonapi.cloudapi.listNetworks({}, function (err, nets) {
                     if (err) {
                         next(err);
                         return;
@@ -489,7 +501,8 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                 });
                 break;
             case 'fwrules':
-                cloudapi.listFirewallRules({}, function (err, fwrules) {
+                tritonapi.cloudapi.listFirewallRules({}, function (err,
+                                                                   fwrules) {
                     if (err) {
                         next(err);
                         return;
@@ -503,7 +516,7 @@ CLI.prototype._emitCompletions = function _emitCompletions(type, cb) {
                 });
                 break;
             case 'keys':
-                cloudapi.listKeys({}, function (err, keys) {
+                tritonapi.cloudapi.listKeys({}, function (err, keys) {
                     if (err) {
                         next(err);
                         return;
@@ -602,7 +615,7 @@ CLI.prototype.tritonapiFromProfileName =
             'tritonapiFromProfileName: loaded profile');
     }
 
-    return tritonapi.createClient({
+    return lib_tritonapi.createClient({
         log: this.log,
         profile: profile,
         config: this.config
diff --git a/lib/cloudapi2.js b/lib/cloudapi2.js
index eab9822..a347c07 100644
--- a/lib/cloudapi2.js
+++ b/lib/cloudapi2.js
@@ -41,6 +41,7 @@ var os = require('os');
 var querystring = require('querystring');
 var vasync = require('vasync');
 var auth = require('smartdc-auth');
+var EventEmitter = require('events').EventEmitter;
 
 var bunyannoop = require('./bunyannoop');
 var common = require('./common');
@@ -64,10 +65,7 @@ var OS_PLATFORM = os.platform();
  *
  * @param options {Object}
  *      - {String} url (required) Cloud API base url
- *      - {String} account (required) The account login name.
- *      - {Function} sign (required) An http-signature auth signing function
- *      - {String} user (optional) The RBAC user login name.
- *      - {Array of String} roles (optional) RBAC role(s) to take up.
+ *      - Authentication options (see below)
  *      - {String} version (optional) Used for the accept-version header. This
  *        defaults to '*', meaning that over time you could experience breaking
  *        changes. Specifying a value is strongly recommended. E.g. '~7.1'.
@@ -78,6 +76,28 @@ var OS_PLATFORM = os.platform();
  *          {Boolean} agent  Set to `false` to not get KeepAlive. You want
  *              this for CLIs.
  *          TODO doc the backoff/retry available options
+ *
+ *      Authentication options can be given in two ways - either with a
+ *      smartdc-auth KeyPair (the preferred method), or with a signer function
+ *      (deprecated, retained for compatibility).
+ *
+ *      Either (prefered):
+ *      - {String} account (required) The account login name this cloudapi
+ *          client will operate upon.
+ *      - {Object} principal (required)
+ *          - {String} account (required) The account login name for
+ *              authentication.
+ *          - {Object} keyPair (required) A smartdc-auth KeyPair object
+ *          - {String} user (optional) RBAC sub-user login name
+ *          - {Array of String} roles (optional) RBAC role(s) to take up.
+ *
+ *      Or (backwards compatible):
+ *      - {String} account (required) The account login name used both for
+ *          authentication and as the account being operated upon.
+ *      - {Function} sign (required) An http-signature auth signing function.
+ *      - {String} user (optional) The RBAC user login name.
+ *      - {Array of String} roles (optional) RBAC role(s) to take up.
+ *
  * @throws {TypeError} on bad input.
  * @constructor
  *
@@ -90,17 +110,30 @@ function CloudApi(options) {
     assert.object(options, 'options');
     assert.string(options.url, 'options.url');
     assert.string(options.account, 'options.account');
-    assert.func(options.sign, 'options.sign');
-    assert.optionalString(options.user, 'options.user');
+
     assert.optionalArrayOfString(options.roles, 'options.roles');
     assert.optionalString(options.version, 'options.version');
     assert.optionalObject(options.log, 'options.log');
 
+    assert.optionalObject(options.principal, 'options.principal');
+    this.principal = options.principal;
+    if (options.principal === undefined) {
+        this.principal = {};
+        this.principal.account = options.account;
+        assert.optionalString(options.user, 'options.user');
+        if (options.user !== undefined)
+            this.principal.user = options.user;
+        assert.func(options.sign, 'options.sign');
+        this.principal.sign = options.sign;
+    } else {
+        assert.string(this.principal.account, 'principal.account');
+        assert.object(this.principal.keyPair, 'principal.keyPair');
+        assert.optionalString(this.principal.user, 'principal.user');
+    }
+
     this.url = options.url;
     this.account = options.account;
-    this.user = options.user; // optional RBAC subuser
     this.roles = options.roles;
-    this.sign = options.sign;
     this.log = options.log || new bunyannoop.BunyanNoopLogger();
     if (!options.version) {
         options.version = '*';
@@ -128,16 +161,33 @@ CloudApi.prototype.close = function close(callback) {
     this.client.close();
 };
 
+CloudApi.prototype._getAuthHeaders =
+    function _getAuthHeaders(method, path, callback) {
 
-CloudApi.prototype._getAuthHeaders = function _getAuthHeaders(callback) {
+    assert.string(method, 'method');
+    assert.string(path, 'path');
     assert.func(callback, 'callback');
-    var self = this;
 
     var headers = {};
 
-    var rs = auth.requestSigner({
-        sign: self.sign
-    });
+    var rs;
+    if (this.principal.sign !== undefined) {
+        rs = auth.requestSigner({
+            sign: this.principal.sign
+        });
+    } else if (this.principal.keyPair !== undefined) {
+        try {
+            rs = this.principal.keyPair.createRequestSigner({
+                user: this.principal.account,
+                subuser: this.principal.user
+            });
+        } catch (signerErr) {
+            callback(new errors.SigningError(signerErr));
+            return;
+        }
+    }
+
+    rs.writeTarget(method, path);
     headers.date = rs.writeDateHeader();
 
     // TODO: token auth support
@@ -222,14 +272,8 @@ CloudApi.prototype._request = function _request(opts, cb) {
 
     var method = (opts.method || 'GET').toLowerCase();
     assert.ok(['get', 'post', 'put', 'delete', 'head'].indexOf(method) >= 0,
-        'invalid method given');
-    switch (method) {
-    case 'delete':
-        method = 'del';
-        break;
-    default:
-        break;
-    }
+        'invalid HTTP method given');
+    var clientFnName = (method === 'delete' ? 'del' : method);
 
     if (self.roles && self.roles.length > 0) {
         if (opts.path.indexOf('?') !== -1) {
@@ -239,7 +283,7 @@ CloudApi.prototype._request = function _request(opts, cb) {
         }
     }
 
-    self._getAuthHeaders(function (err, headers) {
+    self._getAuthHeaders(method, opts.path, function (err, headers) {
         if (err) {
             cb(err);
             return;
@@ -252,9 +296,9 @@ CloudApi.prototype._request = function _request(opts, cb) {
             headers: headers
         };
         if (opts.data)
-            self.client[method](reqOpts, opts.data, cb);
+            self.client[clientFnName](reqOpts, opts.data, cb);
         else
-            self.client[method](reqOpts, cb);
+            self.client[clientFnName](reqOpts, cb);
     });
 };
 
diff --git a/lib/common.js b/lib/common.js
index 8f0d84a..93f3b68 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -12,6 +12,7 @@ var assert = require('assert-plus');
 var child_process = require('child_process');
 var crypto = require('crypto');
 var fs = require('fs');
+var getpass = require('getpass');
 var os = require('os');
 var path = require('path');
 var read = require('read');
@@ -678,6 +679,99 @@ function promptField(field, cb) {
 }
 
 
+/**
+ * A utility method to unlock a private key on a TritonApi client instance,
+ * if necessary.
+ *
+ * If the client's key is locked, this will prompt for the passphrase on the
+ * TTY (via the `getpass` module) and attempt to unlock.
+ *
+ * @param opts {Object}
+ *      - opts.tritonapi {Object} An `.init()`ialized TritonApi instance.
+ * @param cb {Function} `function (err)`
+ */
+function promptPassphraseUnlockKey(opts, cb) {
+    assert.object(opts.tritonapi, 'opts.tritonapi');
+
+    var kp = opts.tritonapi.keyPair;
+    if (!kp) {
+        cb(new errors.InternalError('TritonApi instance given to '
+            + 'promptPassphraseUnlockKey is not initialized'));
+        return;
+    }
+
+    if (!kp.isLocked()) {
+        cb();
+        return;
+    }
+
+    var keyDesc;
+    if (kp.source !== undefined) {
+        keyDesc = kp.source;
+    } else if (kp.comment !== undefined && kp.comment.length > 1) {
+        keyDesc = kp.getPublicKey().type.toUpperCase() +
+            ' key for ' + kp.comment;
+    } else {
+        keyDesc = kp.getPublicKey().type.toUpperCase() +
+            ' key ' + kp.getKeyId();
+    }
+    var getpassOpts = {
+        prompt: 'Enter passphrase for ' + keyDesc
+    };
+
+    var tryPass = function (err, pass) {
+        if (err) {
+            cb(err);
+            return;
+        }
+
+        try {
+            kp.unlock(pass);
+        } catch (unlockErr) {
+            getpassOpts.prompt = 'Bad passphrase, try again for ' + keyDesc;
+            getpass.getPass(getpassOpts, tryPass);
+            return;
+        }
+
+        cb(null);
+    };
+
+    getpass.getPass(getpassOpts, tryPass);
+}
+
+
+/*
+ * A utility for the `triton` CLI subcommands to `init()`ialize a
+ * `tritonapi` instance and ensure that the profile's key is unlocked
+ * (prompting on a TTY if necessary).  This is typically the CLI's
+ * `tritonapi` instance, but a `tritonapi` can also be passed in
+ * directly.
+ *
+ * @param opts.cli {Object}
+ * @param opts.tritonapi {Object}
+ * @param cb {Function} `function (err)`
+ */
+function cliSetupTritonApi(opts, cb) {
+    assert.optionalObject(opts.cli, 'opts.cli');
+    assert.optionalObject(opts.tritonapi, 'opts.tritonapi');
+    var tritonapi = opts.tritonapi || opts.cli.tritonapi;
+    assert.object(tritonapi, 'tritonapi');
+
+    tritonapi.init(function (initErr) {
+        if (initErr) {
+            cb(initErr);
+            return;
+        }
+
+        promptPassphraseUnlockKey({
+            tritonapi: tritonapi
+        }, function (keyErr) {
+            cb(keyErr);
+        });
+    });
+}
+
+
 /**
  * Edit the given text in $EDITOR (defaulting to `vi`) and return the edited
  * text.
@@ -984,6 +1078,8 @@ module.exports = {
     promptYesNo: promptYesNo,
     promptEnter: promptEnter,
     promptField: promptField,
+    promptPassphraseUnlockKey: promptPassphraseUnlockKey,
+    cliSetupTritonApi: cliSetupTritonApi,
     editInEditor: editInEditor,
     ansiStylize: ansiStylize,
     indent: indent,
diff --git a/lib/do_account/do_get.js b/lib/do_account/do_get.js
index 5901db1..d2619e7 100644
--- a/lib/do_account/do_get.js
+++ b/lib/do_account/do_get.js
@@ -21,28 +21,34 @@ function do_get(subcmd, opts, args, callback) {
         return;
     }
 
-    this.top.tritonapi.cloudapi.getAccount(function (err, account) {
-        if (err) {
-            callback(err);
-            return;
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.cloudapi.getAccount(function (err, account) {
+            if (err) {
+                callback(err);
+                return;
+            }
 
-        if (opts.json) {
-            console.log(JSON.stringify(account));
-        } else {
-            // pretty print
-            var dates = ['updated', 'created'];
-            Object.keys(account).forEach(function (key) {
-                var val = account[key];
-                if (dates.indexOf(key) >= 0) {
-                    console.log('%s: %s (%s)', key, val,
-                        common.longAgo(new Date(val)));
-                } else {
-                    console.log('%s: %s', key, val);
-                }
-            });
-        }
-        callback();
+            if (opts.json) {
+                console.log(JSON.stringify(account));
+            } else {
+                // pretty print
+                var dates = ['updated', 'created'];
+                Object.keys(account).forEach(function (key) {
+                    var val = account[key];
+                    if (dates.indexOf(key) >= 0) {
+                        console.log('%s: %s (%s)', key, val,
+                                    common.longAgo(new Date(val)));
+                    } else {
+                        console.log('%s: %s', key, val);
+                    }
+                });
+            }
+            callback();
+        });
     });
 }
 
diff --git a/lib/do_account/do_update.js b/lib/do_account/do_update.js
index fa0f62f..876debc 100644
--- a/lib/do_account/do_update.js
+++ b/lib/do_account/do_update.js
@@ -30,7 +30,9 @@ function do_update(subcmd, opts, args, callback) {
     var log = this.log;
     var tritonapi = this.top.tritonapi;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
+
         function gatherDataArgs(ctx, next) {
             if (opts.file) {
                 next();
diff --git a/lib/do_datacenters.js b/lib/do_datacenters.js
index afb45b2..e6935fe 100644
--- a/lib/do_datacenters.js
+++ b/lib/do_datacenters.js
@@ -31,36 +31,42 @@ function do_datacenters(subcmd, opts, args, callback) {
 
     var columns = opts.o.split(',');
     var sort = opts.s.split(',');
+    var tritonapi = this.tritonapi;
 
-    this.tritonapi.cloudapi.listDatacenters(function (err, datacenters) {
-        if (err) {
-            callback(err);
-            return;
+    common.cliSetupTritonApi({cli: this}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.cloudapi.listDatacenters(function (err, datacenters) {
+            if (err) {
+                callback(err);
+                return;
+            }
 
-        if (opts.json) {
-            console.log(JSON.stringify(datacenters));
-        } else {
-            /*
-             * datacenters are returned in the form of:
-             * {name: 'url', name2: 'url2', ...}
-             * we "normalize" them for use by tabula by making them an array
-             */
-            var dcs = [];
-            Object.keys(datacenters).forEach(function (key) {
-                dcs.push({
-                    name: key,
-                    url: datacenters[key]
+            if (opts.json) {
+                console.log(JSON.stringify(datacenters));
+            } else {
+                /*
+                 * datacenters are returned in the form of:
+                 * {name: 'url', name2: 'url2', ...}
+                 * we "normalize" them for use by tabula by making them an array
+                 */
+                var dcs = [];
+                Object.keys(datacenters).forEach(function (key) {
+                    dcs.push({
+                        name: key,
+                        url: datacenters[key]
+                    });
                 });
-            });
-            tabula(dcs, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort,
-                dottedLookup: true
-            });
-        }
-        callback();
+                tabula(dcs, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort,
+                    dottedLookup: true
+                });
+            }
+            callback();
+        });
     });
 }
 
diff --git a/lib/do_fwrule/do_create.js b/lib/do_fwrule/do_create.js
index d1ec831..2de8b87 100644
--- a/lib/do_fwrule/do_create.js
+++ b/lib/do_fwrule/do_create.js
@@ -45,15 +45,21 @@ function do_create(subcmd, opts, args, cb) {
         createOpts.description = opts.description;
     }
 
-    this.top.tritonapi.cloudapi.createFirewallRule(createOpts,
-            function (err, fwrule) {
-        if (err) {
-            cb(err);
-            return;
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-        console.log('Created firewall rule %s%s', fwrule.id,
-            (!fwrule.enabled ? ' (disabled)' : ''));
-        cb();
+        tritonapi.cloudapi.createFirewallRule(
+            createOpts, function (err, fwrule) {
+                if (err) {
+                    cb(err);
+                    return;
+                }
+                console.log('Created firewall rule %s%s', fwrule.id,
+                            (!fwrule.enabled ? ' (disabled)' : ''));
+                cb();
+            });
     });
 }
 
diff --git a/lib/do_fwrule/do_delete.js b/lib/do_fwrule/do_delete.js
index b4369d8..a7b0fdd 100644
--- a/lib/do_fwrule/do_delete.js
+++ b/lib/do_fwrule/do_delete.js
@@ -31,10 +31,11 @@ function do_delete(subcmd, opts, args, cb) {
         return;
     }
 
-    var cli = this.top;
+    var tritonapi = this.top.tritonapi;
     var ruleIds = args;
 
-    vasync.pipeline({funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function confirm(_, next) {
             if (opts.force) {
                 return next();
@@ -61,8 +62,8 @@ function do_delete(subcmd, opts, args, cb) {
             vasync.forEachParallel({
                 inputs: ruleIds,
                 func: function deleteOne(id, nextId) {
-                    cli.tritonapi.deleteFirewallRule({
-                            id: id
+                    tritonapi.deleteFirewallRule({
+                        id: id
                     }, function (err) {
                         if (err) {
                             nextId(err);
diff --git a/lib/do_fwrule/do_disable.js b/lib/do_fwrule/do_disable.js
index 7ea887b..7c51b87 100644
--- a/lib/do_fwrule/do_disable.js
+++ b/lib/do_fwrule/do_disable.js
@@ -30,22 +30,26 @@ function do_disable(subcmd, opts, args, cb) {
         return;
     }
 
-    var cli = this.top;
-
-    vasync.forEachParallel({
-        inputs: args,
-        func: function disableOne(id, nextId) {
-            cli.tritonapi.disableFirewallRule({ id: id }, function (err) {
-                if (err) {
-                    nextId(err);
-                    return;
-                }
-
-                console.log('Disabled firewall rule %s', id);
-                nextId();
-            });
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-    }, cb);
+        vasync.forEachParallel({
+            inputs: args,
+            func: function disableOne(id, nextId) {
+                tritonapi.disableFirewallRule({ id: id }, function (err) {
+                    if (err) {
+                        nextId(err);
+                        return;
+                    }
+
+                    console.log('Disabled firewall rule %s', id);
+                    nextId();
+                });
+            }
+        }, cb);
+    });
 }
 
 
diff --git a/lib/do_fwrule/do_enable.js b/lib/do_fwrule/do_enable.js
index 4f22747..c5401e9 100644
--- a/lib/do_fwrule/do_enable.js
+++ b/lib/do_fwrule/do_enable.js
@@ -30,22 +30,26 @@ function do_enable(subcmd, opts, args, cb) {
         return;
     }
 
-    var cli = this.top;
-
-    vasync.forEachParallel({
-        inputs: args,
-        func: function enableOne(id, nextId) {
-            cli.tritonapi.enableFirewallRule({ id: id }, function (err) {
-                if (err) {
-                    nextId(err);
-                    return;
-                }
-
-                console.log('Enabled firewall rule %s', id);
-                nextId();
-            });
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-    }, cb);
+        vasync.forEachParallel({
+            inputs: args,
+            func: function enableOne(id, nextId) {
+                tritonapi.enableFirewallRule({ id: id }, function (err) {
+                    if (err) {
+                        nextId(err);
+                        return;
+                    }
+
+                    console.log('Enabled firewall rule %s', id);
+                    nextId();
+                });
+            }
+        }, cb);
+    });
 }
 
 
diff --git a/lib/do_fwrule/do_get.js b/lib/do_fwrule/do_get.js
index b919036..474c415 100644
--- a/lib/do_fwrule/do_get.js
+++ b/lib/do_fwrule/do_get.js
@@ -33,21 +33,26 @@ function do_get(subcmd, opts, args, cb) {
     }
 
     var id = args[0];
-    var cli = this.top;
+    var tritonapi = this.top.tritonapi;
 
-    cli.tritonapi.getFirewallRule(id, function onRule(err, fwrule) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            console.log(JSON.stringify(fwrule));
-        } else {
-            console.log(JSON.stringify(fwrule, null, 4));
-        }
-
-        cb();
+        tritonapi.getFirewallRule(id, function onRule(err, fwrule) {
+            if (err) {
+                cb(err);
+                return;
+            }
+
+            if (opts.json) {
+                console.log(JSON.stringify(fwrule));
+            } else {
+                console.log(JSON.stringify(fwrule, null, 4));
+            }
+
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_fwrule/do_instances.js b/lib/do_fwrule/do_instances.js
index 65a3c65..e511bae 100644
--- a/lib/do_fwrule/do_instances.js
+++ b/lib/do_fwrule/do_instances.js
@@ -54,75 +54,81 @@ function do_instances(subcmd, opts, args, cb) {
 
     var tritonapi = this.top.tritonapi;
 
-    vasync.parallel({funcs: [
-        function getTheImages(next) {
-            tritonapi.listImages({
-                useCache: true,
-                state: 'all'
-            }, function (err, _imgs) {
-                if (err) {
-                    next(err);
-                } else {
-                    imgs = _imgs;
-                    next();
-                }
-            });
-        },
-        function getTheMachines(next) {
-            tritonapi.listFirewallRuleInstances({
-                id: id
-            }, function (err, _insts) {
-                if (err) {
-                    next(err);
-                } else {
-                    insts = _insts;
-                    next();
-                }
-            });
-        }
-    ]}, function (err, results) {
-        /*
-         * Error handling: vasync.parallel's `err` is always a MultiError. We
-         * want to prefer the `getTheMachines` err, e.g. if both get a
-         * self-signed cert error.
-         */
-        if (err) {
-            err = results.operations[1].err || err;
-            return cb(err);
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
+        vasync.parallel({funcs: [
+            function getTheImages(next) {
+                tritonapi.listImages({
+                    useCache: true,
+                    state: 'all'
+                }, function (err, _imgs) {
+                    if (err) {
+                        next(err);
+                    } else {
+                        imgs = _imgs;
+                        next();
+                    }
+                });
+            },
+            function getTheMachines(next) {
+                tritonapi.listFirewallRuleInstances({
+                    id: id
+                }, function (err, _insts) {
+                    if (err) {
+                        next(err);
+                    } else {
+                        insts = _insts;
+                        next();
+                    }
+                });
+            }
+        ]}, function (err, results) {
+            /*
+             * Error handling: vasync.parallel's `err` is always a
+             * MultiError. We want to prefer the `getTheMachines` err,
+             * e.g. if both get a self-signed cert error.
+             */
+            if (err) {
+                err = results.operations[1].err || err;
+                return cb(err);
+            }
+
+            // map "uuid" => "image_name"
+            var imgmap = {};
+            imgs.forEach(function (img) {
+                imgmap[img.id] = format('%s@%s', img.name, img.version);
+            });
 
-        // map "uuid" => "image_name"
-        var imgmap = {};
-        imgs.forEach(function (img) {
-            imgmap[img.id] = format('%s@%s', img.name, img.version);
-        });
-
-        // Add extra fields for nice output.
-        var now = new Date();
-        insts.forEach(function (inst) {
-            var created = new Date(inst.created);
-            inst.age = common.longAgo(created, now);
-            inst.img = imgmap[inst.image] || common.uuidToShortId(inst.image);
-            inst.shortid = inst.id.split('-', 1)[0];
-            var flags = [];
-            if (inst.docker) flags.push('D');
-            if (inst.firewall_enabled) flags.push('F');
-            if (inst.brand === 'kvm') flags.push('K');
-            inst.flags = flags.length ? flags.join('') : undefined;
-        });
-
-        if (opts.json) {
-            common.jsonStream(insts);
-        } else {
-            tabula(insts, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort,
-                dottedLookup: true
+            // Add extra fields for nice output.
+            var now = new Date();
+            insts.forEach(function (inst) {
+                var created = new Date(inst.created);
+                inst.age = common.longAgo(created, now);
+                inst.img = imgmap[inst.image] ||
+                    common.uuidToShortId(inst.image);
+                inst.shortid = inst.id.split('-', 1)[0];
+                var flags = [];
+                if (inst.docker) flags.push('D');
+                if (inst.firewall_enabled) flags.push('F');
+                if (inst.brand === 'kvm') flags.push('K');
+                inst.flags = flags.length ? flags.join('') : undefined;
             });
-        }
 
-        cb();
+            if (opts.json) {
+                common.jsonStream(insts);
+            } else {
+                tabula(insts, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort,
+                    dottedLookup: true
+                });
+            }
+
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_fwrule/do_list.js b/lib/do_fwrule/do_list.js
index 108d4f0..bf6f7e2 100644
--- a/lib/do_fwrule/do_list.js
+++ b/lib/do_fwrule/do_list.js
@@ -35,40 +35,45 @@ function do_list(subcmd, opts, args, cb) {
         return;
     }
 
-    var cli = this.top;
-    cli.tritonapi.cloudapi.listFirewallRules({}, function onRules(err, rules) {
-        if (err) {
-            cb(err);
-            return;
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            common.jsonStream(rules);
-        } else {
-            var columns = COLUMNS_DEFAULT;
-
-            if (opts.o) {
-                columns = opts.o;
-            } else if (opts.long) {
-                columns = COLUMNS_LONG;
+        tritonapi.cloudapi.listFirewallRules({}, function onRules(err, rules) {
+            if (err) {
+                cb(err);
+                return;
             }
 
-            columns = columns.toLowerCase().split(',');
-            var sort = opts.s.toLowerCase().split(',');
-
-            if (columns.indexOf('shortid') !== -1) {
-                rules.forEach(function (rule) {
-                    rule.shortid = common.uuidToShortId(rule.id);
+            if (opts.json) {
+                common.jsonStream(rules);
+            } else {
+                var columns = COLUMNS_DEFAULT;
+
+                if (opts.o) {
+                    columns = opts.o;
+                } else if (opts.long) {
+                    columns = COLUMNS_LONG;
+                }
+
+                columns = columns.toLowerCase().split(',');
+                var sort = opts.s.toLowerCase().split(',');
+
+                if (columns.indexOf('shortid') !== -1) {
+                    rules.forEach(function (rule) {
+                        rule.shortid = common.uuidToShortId(rule.id);
+                    });
+                }
+
+                tabula(rules, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort
                 });
-            }
-
-            tabula(rules, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort
-            });
         }
-        cb();
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_fwrule/do_update.js b/lib/do_fwrule/do_update.js
index 8238c61..9bad3e4 100644
--- a/lib/do_fwrule/do_update.js
+++ b/lib/do_fwrule/do_update.js
@@ -37,7 +37,9 @@ function do_update(subcmd, opts, args, cb) {
 
     var id = args.shift();
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
+
         function gatherDataArgs(ctx, next) {
             if (opts.file) {
                 next();
diff --git a/lib/do_image/do_create.js b/lib/do_image/do_create.js
index c63634c..30aca85 100644
--- a/lib/do_image/do_create.js
+++ b/lib/do_image/do_create.js
@@ -26,7 +26,6 @@ var mat = require('../metadataandtags');
 // ---- the command
 
 function do_create(subcmd, opts, args, cb) {
-    var self = this;
     if (opts.help) {
         this.do_help('help', {}, [subcmd], cb);
         return;
@@ -37,9 +36,10 @@ function do_create(subcmd, opts, args, cb) {
     }
 
     var log = this.top.log;
-    var cloudapi = this.top.tritonapi.cloudapi;
+    var tritonapi = this.top.tritonapi;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function loadTags(ctx, next) {
             mat.tagsFromCreateOpts(opts, log, function (err, tags) {
                 if (err) {
@@ -76,7 +76,7 @@ function do_create(subcmd, opts, args, cb) {
                 return;
             }
 
-            self.top.tritonapi.getInstance(id, function (err, inst) {
+            tritonapi.getInstance(id, function (err, inst) {
                 if (err) {
                     next(err);
                     return;
@@ -113,20 +113,22 @@ function do_create(subcmd, opts, args, cb) {
                 return;
             }
 
-            cloudapi.createImageFromMachine(createOpts, function (err, img) {
-                if (err) {
-                    next(new errors.TritonError(err, 'error creating image'));
-                    return;
-                }
-                ctx.img = img;
-                if (opts.json) {
-                    console.log(JSON.stringify(img));
-                } else {
-                    console.log('Creating image %s@%s (%s)',
-                        img.name, img.version, img.id);
-                }
-                next();
-            });
+            tritonapi.cloudapi.createImageFromMachine(
+                createOpts, function (err, img) {
+                    if (err) {
+                        next(new errors.TritonError(err,
+                                                    'error creating image'));
+                        return;
+                    }
+                    ctx.img = img;
+                    if (opts.json) {
+                        console.log(JSON.stringify(img));
+                    } else {
+                        console.log('Creating image %s@%s (%s)',
+                                    img.name, img.version, img.id);
+                    }
+                    next();
+                });
         },
         function maybeWait(ctx, next) {
             if (!opts.wait) {
@@ -147,8 +149,8 @@ function do_create(subcmd, opts, args, cb) {
                         ctx.img.state = 'running';
                         waitCb(null, ctx.img);
                     }, 5000);
-                }
-                : cloudapi.waitForImageStates.bind(cloudapi));
+                } : tritonapi.cloudapi.waitForImageStates.bind(
+                    tritonapi.cloudapi));
 
             waiter({
                 id: ctx.img.id,
diff --git a/lib/do_image/do_delete.js b/lib/do_image/do_delete.js
index a11501b..484841e 100644
--- a/lib/do_image/do_delete.js
+++ b/lib/do_image/do_delete.js
@@ -26,7 +26,8 @@ function do_delete(subcmd, opts, args, cb) {
     }
     var ids = args;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         /*
          * Lookup images, if not given UUIDs: we'll need to do it anyway
          * for the DeleteImage call(s), and doing so explicitly here allows
diff --git a/lib/do_image/do_get.js b/lib/do_image/do_get.js
index 4e22268..b09075f 100644
--- a/lib/do_image/do_get.js
+++ b/lib/do_image/do_get.js
@@ -12,6 +12,7 @@
 
 var format = require('util').format;
 
+var common = require('../common');
 var errors = require('../errors');
 
 
@@ -24,17 +25,23 @@ function do_get(subcmd, opts, args, callback) {
             'incorrect number of args (%d)', args.length)));
     }
 
-    this.top.tritonapi.getImage(args[0], function onRes(err, img) {
-        if (err) {
-            return callback(err);
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.getImage(args[0], function onRes(err, img) {
+            if (err) {
+                return callback(err);
+            }
 
-        if (opts.json) {
-            console.log(JSON.stringify(img));
-        } else {
-            console.log(JSON.stringify(img, null, 4));
-        }
-        callback();
+            if (opts.json) {
+                console.log(JSON.stringify(img));
+            } else {
+                console.log(JSON.stringify(img, null, 4));
+            }
+            callback();
+        });
     });
 }
 
diff --git a/lib/do_image/do_list.js b/lib/do_image/do_list.js
index d9b917c..cc00b40 100644
--- a/lib/do_image/do_list.js
+++ b/lib/do_image/do_list.js
@@ -63,42 +63,48 @@ function do_list(subcmd, opts, args, callback) {
         listOpts.state = 'all';
     }
 
-    this.top.tritonapi.listImages(listOpts, function onRes(err, imgs, res) {
-        if (err) {
-            return callback(err);
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.listImages(listOpts, function onRes(err, imgs, res) {
+            if (err) {
+                return callback(err);
+            }
 
-        if (opts.json) {
-            common.jsonStream(imgs);
-        } else {
-            // Add some convenience fields
-            // Added fields taken from imgapi-cli.git.
-            for (var i = 0; i < imgs.length; i++) {
-                var img = imgs[i];
-                img.shortid = img.id.split('-', 1)[0];
-                if (img.published_at) {
-                    // Just the date.
-                    img.pubdate = img.published_at.slice(0, 10);
-                    // Normalize on no milliseconds.
-                    img.pub = img.published_at.replace(/\.\d+Z$/, 'Z');
-                }
-                if (img.files && img.files[0]) {
-                    img.size = img.files[0].size;
+            if (opts.json) {
+                common.jsonStream(imgs);
+            } else {
+                // Add some convenience fields
+                // Added fields taken from imgapi-cli.git.
+                for (var i = 0; i < imgs.length; i++) {
+                    var img = imgs[i];
+                    img.shortid = img.id.split('-', 1)[0];
+                    if (img.published_at) {
+                        // Just the date.
+                        img.pubdate = img.published_at.slice(0, 10);
+                        // Normalize on no milliseconds.
+                        img.pub = img.published_at.replace(/\.\d+Z$/, 'Z');
+                    }
+                    if (img.files && img.files[0]) {
+                        img.size = img.files[0].size;
+                    }
+                    var flags = [];
+                    if (img.origin) flags.push('I');
+                    if (img['public']) flags.push('P');
+                    if (img.state !== 'active') flags.push('X');
+                    img.flags = flags.length ? flags.join('') : undefined;
                 }
-                var flags = [];
-                if (img.origin) flags.push('I');
-                if (img['public']) flags.push('P');
-                if (img.state !== 'active') flags.push('X');
-                img.flags = flags.length ? flags.join('') : undefined;
-            }
 
-            tabula(imgs, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort
-            });
-        }
-        callback();
+                tabula(imgs, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort
+                });
+            }
+            callback();
+        });
     });
 }
 
diff --git a/lib/do_image/do_wait.js b/lib/do_image/do_wait.js
index c887cec..1421ae8 100644
--- a/lib/do_image/do_wait.js
+++ b/lib/do_image/do_wait.js
@@ -12,6 +12,7 @@
 
 var vasync = require('vasync');
 
+var common = require('../common');
 var distractions = require('../distractions');
 var errors = require('../errors');
 
@@ -34,7 +35,8 @@ function do_wait(subcmd, opts, args, cb) {
     var done = 0;
     var imgFromId = {};
 
-    vasync.pipeline({funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function getImgs(_, next) {
             vasync.forEachParallel({
                 inputs: ids,
diff --git a/lib/do_info.js b/lib/do_info.js
index af0f94c..0864366 100644
--- a/lib/do_info.js
+++ b/lib/do_info.js
@@ -28,69 +28,75 @@ function do_info(subcmd, opts, args, callback) {
 
     var out = {};
     var i = 0;
+    var tritonapi = this.tritonapi;
 
-    this.tritonapi.cloudapi.getAccount(cb.bind('account'));    i++;
-    this.tritonapi.cloudapi.listMachines(cb.bind('machines')); i++;
-
-    function cb(err, data) {
-        if (err) {
-            callback(err);
-            return;
+    common.cliSetupTritonApi({cli: this}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
+        }
+        tritonapi.cloudapi.getAccount(cb.bind('account'));    i++;
+        tritonapi.cloudapi.listMachines(cb.bind('machines')); i++;
+
+        function cb(err, data) {
+            if (err) {
+                callback(err);
+                return;
+            }
+            out[this.toString()] = data;
+            if (--i === 0)
+                done();
         }
-        out[this.toString()] = data;
-        if (--i === 0)
-            done();
-    }
 
-    function done() {
-        // parse name
-        var name;
-        if (out.account.firstName && out.account.lastName)
-            name = format('%s %s', out.account.firstName,
-                    out.account.lastName);
-        else if (out.account.firstName)
-            name = out.account.firstName;
-
-        // parse machine states and accounting
-        var states = {};
-        var disk = 0;
-        var memory = 0;
-        out.machines.forEach(function (machine) {
-            var state = machine.state;
-            states[state] = states[state] || 0;
-            states[state]++;
-            memory += machine.memory;
-            disk += machine.disk;
-        });
-        disk *= 1000 * 1000;
-        memory *= 1000 * 1000;
-
-        var data = {};
-        data.login = out.account.login;
-        if (name)
-            data.name = name;
-        data.email = out.account.email;
-        data.url = self.tritonapi.cloudapi.url;
-        data.totalDisk = disk;
-        data.totalMemory = memory;
-
-        if (opts.json) {
-            data.totalInstances = out.machines.length;
-            data.instances = states;
-            console.log(JSON.stringify(data));
-        } else {
-            data.totalDisk = common.humanSizeFromBytes(disk);
-            data.totalMemory = common.humanSizeFromBytes(memory);
-            Object.keys(data).forEach(function (key) {
-                console.log('%s: %s', key, data[key]);
-            });
-            console.log('instances: %d', out.machines.length);
-            Object.keys(states).forEach(function (key) {
-                console.log('    %s: %d', key, states[key]);
+        function done() {
+            // parse name
+            var name;
+            if (out.account.firstName && out.account.lastName)
+                name = format('%s %s', out.account.firstName,
+                              out.account.lastName);
+            else if (out.account.firstName)
+                name = out.account.firstName;
+
+            // parse machine states and accounting
+            var states = {};
+            var disk = 0;
+            var memory = 0;
+            out.machines.forEach(function (machine) {
+                var state = machine.state;
+                states[state] = states[state] || 0;
+                states[state]++;
+                memory += machine.memory;
+                disk += machine.disk;
             });
+            disk *= 1000 * 1000;
+            memory *= 1000 * 1000;
+
+            var data = {};
+            data.login = out.account.login;
+            if (name)
+                data.name = name;
+            data.email = out.account.email;
+            data.url = self.tritonapi.cloudapi.url;
+            data.totalDisk = disk;
+            data.totalMemory = memory;
+
+            if (opts.json) {
+                data.totalInstances = out.machines.length;
+                data.instances = states;
+                console.log(JSON.stringify(data));
+            } else {
+                data.totalDisk = common.humanSizeFromBytes(disk);
+                data.totalMemory = common.humanSizeFromBytes(memory);
+                Object.keys(data).forEach(function (key) {
+                    console.log('%s: %s', key, data[key]);
+                });
+                console.log('instances: %d', out.machines.length);
+                Object.keys(states).forEach(function (key) {
+                    console.log('    %s: %d', key, states[key]);
+                });
+            }
+            callback();
         }
-        callback();
-    }
+    });
 }
 
 do_info.options = [
diff --git a/lib/do_instance/do_audit.js b/lib/do_instance/do_audit.js
index 82b09f8..ce4060f 100644
--- a/lib/do_instance/do_audit.js
+++ b/lib/do_instance/do_audit.js
@@ -27,7 +27,6 @@ var sortDefault = 'id,time';
 
 
 function do_audit(subcmd, opts, args, cb) {
-    var self = this;
     if (opts.help) {
         this.do_help('help', {}, [subcmd], cb);
         return;
@@ -51,23 +50,25 @@ function do_audit(subcmd, opts, args, cb) {
 
     var arg = args[0];
     var uuid;
+    var tritonapi = this.top.tritonapi;
 
-    if (common.isUUID(arg)) {
-        uuid = arg;
-        go1();
-    } else {
-        self.top.tritonapi.getInstance(arg, function (err, inst) {
-            if (err) {
-                cb(err);
-                return;
-            }
-            uuid = inst.id;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (common.isUUID(arg)) {
+            uuid = arg;
             go1();
-        });
-    }
+        } else {
+            tritonapi.getInstance(arg, function (err, inst) {
+                if (err) {
+                    cb(err);
+                    return;
+                }
+                uuid = inst.id;
+                go1();
+            });
+        }});
 
     function go1() {
-        self.top.tritonapi.cloudapi.machineAudit(uuid, function (err, audit) {
+        tritonapi.cloudapi.machineAudit(uuid, function (err, audit) {
             if (err) {
                 cb(err);
                 return;
diff --git a/lib/do_instance/do_create.js b/lib/do_instance/do_create.js
index 0562dc1..cc0c636 100644
--- a/lib/do_instance/do_create.js
+++ b/lib/do_instance/do_create.js
@@ -22,7 +22,6 @@ var mat = require('../metadataandtags');
 
 
 function do_create(subcmd, opts, args, cb) {
-    var self = this;
     if (opts.help) {
         this.do_help('help', {}, [subcmd], cb);
         return;
@@ -31,9 +30,10 @@ function do_create(subcmd, opts, args, cb) {
     }
 
     var log = this.top.log;
-    var cloudapi = this.top.tritonapi.cloudapi;
+    var tritonapi = this.top.tritonapi;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         /* BEGIN JSSTYLED */
         /*
          * Parse --affinity options for validity to `ctx.affinities`.
@@ -158,7 +158,7 @@ function do_create(subcmd, opts, args, cb) {
                         nearFar.push(aff.val);
                         nextAff();
                     } else {
-                        self.top.tritonapi.getInstance({
+                        tritonapi.getInstance({
                             id: aff.val,
                             fields: ['id']
                         }, function (err, inst) {
@@ -222,7 +222,7 @@ function do_create(subcmd, opts, args, cb) {
                 name: args[0],
                 useCache: true
             };
-            self.top.tritonapi.getImage(_opts, function (err, img) {
+            tritonapi.getImage(_opts, function (err, img) {
                 if (err) {
                     return next(err);
                 }
@@ -243,7 +243,7 @@ function do_create(subcmd, opts, args, cb) {
                 return;
             }
 
-            self.top.tritonapi.getPackage(id, function (err, pkg) {
+            tritonapi.getPackage(id, function (err, pkg) {
                 if (err) {
                     return next(err);
                 }
@@ -261,7 +261,7 @@ function do_create(subcmd, opts, args, cb) {
             vasync.forEachPipeline({
                 inputs: opts.network,
                 func: function getOneNetwork(name, nextNet) {
-                    self.top.tritonapi.getNetwork(name, function (err, net) {
+                    tritonapi.getNetwork(name, function (err, net) {
                         if (err) {
                             nextNet(err);
                         } else {
@@ -316,7 +316,7 @@ function do_create(subcmd, opts, args, cb) {
                 return next();
             }
 
-            cloudapi.createMachine(createOpts, function (err, inst) {
+            tritonapi.cloudapi.createMachine(createOpts, function (err, inst) {
                 if (err) {
                     next(new errors.TritonError(err,
                         'error creating instance'));
@@ -352,8 +352,8 @@ function do_create(subcmd, opts, args, cb) {
                         ctx.inst.state = 'running';
                         waitCb(null, ctx.inst);
                     }, 5000);
-                }
-                : cloudapi.waitForMachineStates.bind(cloudapi));
+                } : tritonapi.cloudapi.waitForMachineStates.bind(
+                    tritonapi.cloudapi));
 
             waiter({
                 id: ctx.inst.id,
diff --git a/lib/do_instance/do_disable_firewall.js b/lib/do_instance/do_disable_firewall.js
index 370c542..7f51b39 100644
--- a/lib/do_instance/do_disable_firewall.js
+++ b/lib/do_instance/do_disable_firewall.js
@@ -14,6 +14,7 @@ var assert = require('assert-plus');
 var format = require('util').format;
 var vasync = require('vasync');
 
+var common = require('../common');
 var errors = require('../errors');
 
 
@@ -50,28 +51,33 @@ function do_disable_firewall(subcmd, opts, args, cb) {
         });
     }
 
-    vasync.forEachParallel({
-        inputs: args,
-        func: function disableOne(name, nextInst) {
-            cli.tritonapi.disableInstanceFirewall({
-                id: name
-            }, function (err, fauxInst) {
-                if (err) {
-                    nextInst(err);
-                    return;
-                }
-
-                console.log('Disabling firewall for instance "%s"', name);
-
-                if (opts.wait) {
-                    wait(name, fauxInst.id, nextInst);
-                } else {
-                    nextInst();
-                }
-            });
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-    }, function (err) {
-        cb(err);
+        vasync.forEachParallel({
+            inputs: args,
+            func: function disableOne(name, nextInst) {
+                cli.tritonapi.disableInstanceFirewall({
+                    id: name
+                }, function (err, fauxInst) {
+                    if (err) {
+                        nextInst(err);
+                        return;
+                    }
+
+                    console.log('Disabling firewall for instance "%s"', name);
+
+                    if (opts.wait) {
+                        wait(name, fauxInst.id, nextInst);
+                    } else {
+                        nextInst();
+                    }
+                });
+            }
+        }, function (err) {
+            cb(err);
+        });
     });
 }
 
diff --git a/lib/do_instance/do_enable_firewall.js b/lib/do_instance/do_enable_firewall.js
index ea15610..97f1dfb 100644
--- a/lib/do_instance/do_enable_firewall.js
+++ b/lib/do_instance/do_enable_firewall.js
@@ -14,6 +14,7 @@ var assert = require('assert-plus');
 var format = require('util').format;
 var vasync = require('vasync');
 
+var common = require('../common');
 var errors = require('../errors');
 
 
@@ -50,28 +51,33 @@ function do_enable_firewall(subcmd, opts, args, cb) {
         });
     }
 
-    vasync.forEachParallel({
-        inputs: args,
-        func: function enableOne(name, nextInst) {
-            cli.tritonapi.enableInstanceFirewall({
-                id: name
-            }, function (err, fauxInst) {
-                if (err) {
-                    nextInst(err);
-                    return;
-                }
-
-                console.log('Enabling firewall for instance "%s"', name);
-
-                if (opts.wait) {
-                    wait(name, fauxInst.id, nextInst);
-                } else {
-                    nextInst();
-                }
-            });
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-    }, function (err) {
-        cb(err);
+        vasync.forEachParallel({
+            inputs: args,
+            func: function enableOne(name, nextInst) {
+                cli.tritonapi.enableInstanceFirewall({
+                    id: name
+                }, function (err, fauxInst) {
+                    if (err) {
+                        nextInst(err);
+                        return;
+                    }
+
+                    console.log('Enabling firewall for instance "%s"', name);
+
+                    if (opts.wait) {
+                        wait(name, fauxInst.id, nextInst);
+                    } else {
+                        nextInst();
+                    }
+                });
+            }
+        }, function (err) {
+            cb(err);
+        });
     });
 }
 
diff --git a/lib/do_instance/do_fwrules.js b/lib/do_instance/do_fwrules.js
index bf06fad..00eac1f 100644
--- a/lib/do_instance/do_fwrules.js
+++ b/lib/do_instance/do_fwrules.js
@@ -41,41 +41,46 @@ function do_fwrules(subcmd, opts, args, cb) {
     var id = args[0];
 
     var cli = this.top;
-    cli.tritonapi.listInstanceFirewallRules({
-        id: id
-    }, function onRules(err, rules) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            common.jsonStream(rules);
-        } else {
-            var columns = COLUMNS_DEFAULT;
-
-            if (opts.o) {
-                columns = opts.o;
-            } else if (opts.long) {
-                columns = COLUMNS_LONG;
+        cli.tritonapi.listInstanceFirewallRules({
+            id: id
+        }, function onRules(err, rules) {
+            if (err) {
+                cb(err);
+                return;
             }
 
-            columns = columns.toLowerCase().split(',');
-            var sort = opts.s.toLowerCase().split(',');
-
-            if (columns.indexOf('shortid') !== -1) {
-                rules.forEach(function (rule) {
-                    rule.shortid = common.normShortId(rule.id);
+            if (opts.json) {
+                common.jsonStream(rules);
+            } else {
+                var columns = COLUMNS_DEFAULT;
+
+                if (opts.o) {
+                    columns = opts.o;
+                } else if (opts.long) {
+                    columns = COLUMNS_LONG;
+                }
+
+                columns = columns.toLowerCase().split(',');
+                var sort = opts.s.toLowerCase().split(',');
+
+                if (columns.indexOf('shortid') !== -1) {
+                    rules.forEach(function (rule) {
+                        rule.shortid = common.normShortId(rule.id);
+                    });
+                }
+
+                tabula(rules, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort
                 });
             }
-
-            tabula(rules, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort
-            });
-        }
-        cb();
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_instance/do_get.js b/lib/do_instance/do_get.js
index 18afe2d..3663a22 100644
--- a/lib/do_instance/do_get.js
+++ b/lib/do_instance/do_get.js
@@ -19,15 +19,21 @@ function do_get(subcmd, opts, args, cb) {
         return cb(new Error('invalid args: ' + args));
     }
 
-    this.top.tritonapi.getInstance(args[0], function (err, inst) {
-        if (inst) {
-            if (opts.json) {
-                console.log(JSON.stringify(inst));
-            } else {
-                console.log(JSON.stringify(inst, null, 4));
-            }
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-        cb(err);
+        tritonapi.getInstance(args[0], function (err, inst) {
+            if (inst) {
+                if (opts.json) {
+                    console.log(JSON.stringify(inst));
+                } else {
+                    console.log(JSON.stringify(inst, null, 4));
+                }
+            }
+            cb(err);
+        });
     });
 }
 
diff --git a/lib/do_instance/do_ip.js b/lib/do_instance/do_ip.js
index 9dd5af7..6bfdea7 100644
--- a/lib/do_instance/do_ip.js
+++ b/lib/do_instance/do_ip.js
@@ -12,6 +12,7 @@
 
 var format = require('util').format;
 
+var common = require('../common');
 var errors = require('../errors');
 
 
@@ -29,20 +30,25 @@ function do_ip(subcmd, opts, args, cb) {
 
     var cli = this.top;
 
-    cli.tritonapi.getInstance(args[0], function (err, inst) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
+        cli.tritonapi.getInstance(args[0], function (err, inst) {
+            if (err) {
+                cb(err);
+                return;
+            }
 
-        if (!inst.primaryIp) {
-            cb(new errors.TritonError(format(
-                'primaryIp not found for instance "%s"', args[0])));
-            return;
-        }
+            if (!inst.primaryIp) {
+                cb(new errors.TritonError(format(
+                    'primaryIp not found for instance "%s"', args[0])));
+                return;
+            }
 
-        console.log(inst.primaryIp);
-        cb();
+            console.log(inst.primaryIp);
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_instance/do_list.js b/lib/do_instance/do_list.js
index 79c1b7b..47af52b 100644
--- a/lib/do_instance/do_list.js
+++ b/lib/do_instance/do_list.js
@@ -74,84 +74,93 @@ function do_list(subcmd, opts, args, callback) {
     var imgs = [];
     var insts;
 
-    vasync.parallel({funcs: [
-        function getTheImages(next) {
-            self.top.tritonapi.listImages({
-                state: 'all',
-                useCache: true
-            }, function (err, _imgs) {
-                if (err) {
-                    if (err.statusCode === 403) {
-                        /*
-                         * This could be a authorization error due to RBAC
-                         * on a subuser. We don't want to fail `triton inst ls`
-                         * if the subuser can ListMachines, but not ListImages.
-                         */
-                        log.debug(err,
-                            'authz error listing images for insts info');
-                        next();
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
+        }
+        vasync.parallel({funcs: [
+            function getTheImages(next) {
+                self.top.tritonapi.listImages({
+                    state: 'all',
+                    useCache: true
+                }, function (err, _imgs) {
+                    if (err) {
+                        if (err.statusCode === 403) {
+                            /*
+                             * This could be a authorization error due
+                             * to RBAC on a subuser. We don't want to
+                             * fail `triton inst ls` if the subuser
+                             * can ListMachines, but not ListImages.
+                             */
+                            log.debug(
+                                err,
+                                'authz error listing images for insts info');
+                            next();
+                        } else {
+                            next(err);
+                        }
                     } else {
-                        next(err);
+                        imgs = _imgs;
+                        next();
                     }
-                } else {
-                    imgs = _imgs;
-                    next();
-                }
-            });
-        },
-        function getTheMachines(next) {
-            self.top.tritonapi.cloudapi.listMachines(listOpts,
+                });
+            },
+            function getTheMachines(next) {
+                self.top.tritonapi.cloudapi.listMachines(
+                    listOpts,
                     function (err, _insts) {
-                if (err) {
-                    next(err);
-                } else {
-                    insts = _insts;
-                    next();
-                }
+                        if (err) {
+                            next(err);
+                        } else {
+                            insts = _insts;
+                            next();
+                        }
+                    });
+            }
+        ]}, function (err, results) {
+            /*
+             * Error handling: vasync.parallel's `err` is always a
+             * MultiError. We want to prefer the `getTheMachines` err,
+             * e.g. if both get a self-signed cert error.
+             */
+            if (err) {
+                err = results.operations[1].err || err;
+                return callback(err);
+            }
+
+            // map "uuid" => "image_name"
+            var imgmap = {};
+            imgs.forEach(function (img) {
+                imgmap[img.id] = format('%s@%s', img.name, img.version);
             });
-        }
-    ]}, function (err, results) {
-        /*
-         * Error handling: vasync.parallel's `err` is always a MultiError. We
-         * want to prefer the `getTheMachines` err, e.g. if both get a
-         * self-signed cert error.
-         */
-        if (err) {
-            err = results.operations[1].err || err;
-            return callback(err);
-        }
 
-        // map "uuid" => "image_name"
-        var imgmap = {};
-        imgs.forEach(function (img) {
-            imgmap[img.id] = format('%s@%s', img.name, img.version);
-        });
+            // Add extra fields for nice output.
+            var now = new Date();
+            insts.forEach(function (inst) {
+                var created = new Date(inst.created);
+                inst.age = common.longAgo(created, now);
+                inst.img = imgmap[inst.image] ||
+                    common.uuidToShortId(inst.image);
+                inst.shortid = inst.id.split('-', 1)[0];
+                var flags = [];
+                if (inst.docker) flags.push('D');
+                if (inst.firewall_enabled) flags.push('F');
+                if (inst.brand === 'kvm') flags.push('K');
+                inst.flags = flags.length ? flags.join('') : undefined;
+            });
 
-        // Add extra fields for nice output.
-        var now = new Date();
-        insts.forEach(function (inst) {
-            var created = new Date(inst.created);
-            inst.age = common.longAgo(created, now);
-            inst.img = imgmap[inst.image] || common.uuidToShortId(inst.image);
-            inst.shortid = inst.id.split('-', 1)[0];
-            var flags = [];
-            if (inst.docker) flags.push('D');
-            if (inst.firewall_enabled) flags.push('F');
-            if (inst.brand === 'kvm') flags.push('K');
-            inst.flags = flags.length ? flags.join('') : undefined;
+            if (opts.json) {
+                common.jsonStream(insts);
+            } else {
+                tabula(insts, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort,
+                    dottedLookup: true
+                });
+            }
+            callback();
         });
-
-        if (opts.json) {
-            common.jsonStream(insts);
-        } else {
-            tabula(insts, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort,
-                dottedLookup: true
-            });
-        }
-        callback();
     });
 }
 
diff --git a/lib/do_instance/do_snapshot/do_create.js b/lib/do_instance/do_snapshot/do_create.js
index d8aa522..de7b5cf 100644
--- a/lib/do_instance/do_snapshot/do_create.js
+++ b/lib/do_instance/do_snapshot/do_create.js
@@ -47,7 +47,8 @@ function do_create(subcmd, opts, args, cb) {
         createOpts.name = opts.name;
     }
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function createSnapshot(ctx, next) {
             ctx.start = Date.now();
 
diff --git a/lib/do_instance/do_snapshot/do_delete.js b/lib/do_instance/do_snapshot/do_delete.js
index 99d6c9b..e85237c 100644
--- a/lib/do_instance/do_snapshot/do_delete.js
+++ b/lib/do_instance/do_snapshot/do_delete.js
@@ -61,7 +61,8 @@ function do_delete(subcmd, opts, args, cb) {
         });
     }
 
-    vasync.pipeline({funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function confirm(_, next) {
             if (opts.force) {
                 return next();
diff --git a/lib/do_instance/do_snapshot/do_get.js b/lib/do_instance/do_snapshot/do_get.js
index 437a724..7bf02f3 100644
--- a/lib/do_instance/do_snapshot/do_get.js
+++ b/lib/do_instance/do_snapshot/do_get.js
@@ -36,22 +36,27 @@ function do_get(subcmd, opts, args, cb) {
     var name = args[1];
     var cli = this.top;
 
-    cli.tritonapi.getInstanceSnapshot({
-        id: id,
-        name: name
-    }, function onSnapshot(err, snapshot) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            console.log(JSON.stringify(snapshot));
-        } else {
-            console.log(JSON.stringify(snapshot, null, 4));
-        }
-
-        cb();
+        cli.tritonapi.getInstanceSnapshot({
+            id: id,
+            name: name
+        }, function onSnapshot(err, snapshot) {
+            if (err) {
+                cb(err);
+                return;
+            }
+
+            if (opts.json) {
+                console.log(JSON.stringify(snapshot));
+            } else {
+                console.log(JSON.stringify(snapshot, null, 4));
+            }
+
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_instance/do_snapshot/do_list.js b/lib/do_instance/do_snapshot/do_list.js
index 622f576..162dfc3 100644
--- a/lib/do_instance/do_snapshot/do_list.js
+++ b/lib/do_instance/do_snapshot/do_list.js
@@ -40,35 +40,40 @@ function do_list(subcmd, opts, args, cb) {
     var cli = this.top;
     var machineId = args[0];
 
-    cli.tritonapi.listInstanceSnapshots({
-        id: machineId
-    }, function onSnapshots(err, snapshots) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            common.jsonStream(snapshots);
-        } else {
-            var columns = COLUMNS_DEFAULT;
-
-            if (opts.o) {
-                columns = opts.o;
-            } else if (opts.long) {
-                columns = COLUMNS_DEFAULT;
+        cli.tritonapi.listInstanceSnapshots({
+            id: machineId
+        }, function onSnapshots(err, snapshots) {
+            if (err) {
+                cb(err);
+                return;
             }
 
-            columns = columns.split(',');
-            var sort = opts.s.split(',');
-
-            tabula(snapshots, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort
-            });
-        }
-        cb();
+            if (opts.json) {
+                common.jsonStream(snapshots);
+            } else {
+                var columns = COLUMNS_DEFAULT;
+
+                if (opts.o) {
+                    columns = opts.o;
+                } else if (opts.long) {
+                    columns = COLUMNS_DEFAULT;
+                }
+
+                columns = columns.split(',');
+                var sort = opts.s.split(',');
+
+                tabula(snapshots, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort
+                });
+            }
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_instance/do_ssh.js b/lib/do_instance/do_ssh.js
index bdf8fed..be2da84 100644
--- a/lib/do_instance/do_ssh.js
+++ b/lib/do_instance/do_ssh.js
@@ -38,52 +38,59 @@ function do_ssh(subcmd, opts, args, callback) {
         id = id.substr(i + 1);
     }
 
-    cli.tritonapi.getInstance(id, function (err, inst) {
-        if (err) {
-            callback(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        cli.tritonapi.getInstance(id, function (err, inst) {
+            if (err) {
+                callback(err);
+                return;
+            }
 
-        var ip = inst.primaryIp;
-        if (!ip) {
-            callback(new Error('primaryIp not found for instance'));
-            return;
-        }
-
-        args = ['-l', user, ip].concat(args);
+            var ip = inst.primaryIp;
+            if (!ip) {
+                callback(new Error('primaryIp not found for instance'));
+                return;
+            }
 
-        /*
-         * By default we disable ControlMaster (aka mux, aka SSH connection
-         * multiplexing) because of
-         * https://github.com/joyent/node-triton/issues/52
-         *
-         */
-        if (!opts.no_disable_mux) {
-            /*
-             * A simple `-o ControlMaster=no` doesn't work. With just that
-             * option, a `ControlPath` option (from ~/.ssh/config) will still
-             * be used if it exists. Our hack is to set a ControlPath we
-             * know should not exist. Using '/dev/null' wasn't a good
-             * alternative because `ssh` tries "$ControlPath.$somerandomnum"
-             * and also because Windows.
-             */
-            var nullSshControlPath = path.resolve(
-                cli.tritonapi.config._configDir, 'tmp', 'nullSshControlPath');
-            args = [
-                '-o', 'ControlMaster=no',
-                '-o', 'ControlPath='+nullSshControlPath
-            ].concat(args);
-        }
+            args = ['-l', user, ip].concat(args);
 
-        self.top.log.info({args: args}, 'forking ssh');
-        var child = spawn('ssh', args, {stdio: 'inherit'});
-        child.on('close', function (code) {
             /*
-             * Once node 0.10 support is dropped we could instead:
-             *      process.exitCode = code;
-             *      callback();
+             * By default we disable ControlMaster (aka mux, aka SSH connection
+             * multiplexing) because of
+             * https://github.com/joyent/node-triton/issues/52
+             *
              */
-            process.exit(code);
+            if (!opts.no_disable_mux) {
+                /*
+                 * A simple `-o ControlMaster=no` doesn't work. With
+                 * just that option, a `ControlPath` option (from
+                 * ~/.ssh/config) will still be used if it exists. Our
+                 * hack is to set a ControlPath we know should not
+                 * exist. Using '/dev/null' wasn't a good alternative
+                 * because `ssh` tries "$ControlPath.$somerandomnum"
+                 * and also because Windows.
+                 */
+                var nullSshControlPath = path.resolve(
+                    cli.tritonapi.config._configDir, 'tmp',
+                    'nullSshControlPath');
+                args = [
+                    '-o', 'ControlMaster=no',
+                    '-o', 'ControlPath='+nullSshControlPath
+                ].concat(args);
+            }
+
+            self.top.log.info({args: args}, 'forking ssh');
+            var child = spawn('ssh', args, {stdio: 'inherit'});
+            child.on('close', function (code) {
+                /*
+                 * Once node 0.10 support is dropped we could instead:
+                 *      process.exitCode = code;
+                 *      callback();
+                 */
+                process.exit(code);
+            });
         });
     });
 }
diff --git a/lib/do_instance/do_tag/do_delete.js b/lib/do_instance/do_tag/do_delete.js
index deeb518..261a9bc 100644
--- a/lib/do_instance/do_tag/do_delete.js
+++ b/lib/do_instance/do_tag/do_delete.js
@@ -12,6 +12,7 @@
 
 var vasync = require('vasync');
 
+var common = require('../../common');
 var errors = require('../../errors');
 
 
@@ -29,41 +30,46 @@ function do_delete(subcmd, opts, args, cb) {
     }
     var waitTimeoutMs = opts.wait_timeout * 1000; /* seconds to ms */
 
-    if (opts.all) {
-        self.top.tritonapi.deleteAllInstanceTags({
-            id: args[0],
-            wait: opts.wait,
-            waitTimeout: waitTimeoutMs
-        }, function (err) {
-            console.log('Deleted all tags on instance %s', args[0]);
-            cb(err);
-        });
-    } else {
-        // Uniq'ify the given names.
-        var names = {};
-        args.slice(1).forEach(function (arg) { names[arg] = true; });
-        names = Object.keys(names);
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
+        }
+        if (opts.all) {
+            self.top.tritonapi.deleteAllInstanceTags({
+                id: args[0],
+                wait: opts.wait,
+                waitTimeout: waitTimeoutMs
+            }, function (err) {
+                console.log('Deleted all tags on instance %s', args[0]);
+                cb(err);
+            });
+        } else {
+            // Uniq'ify the given names.
+            var names = {};
+            args.slice(1).forEach(function (arg) { names[arg] = true; });
+            names = Object.keys(names);
 
-        // TODO: Instead of waiting for each delete, let's delete them all then
-        // wait for the set.
-        vasync.forEachPipeline({
-            inputs: names,
-            func: function deleteOne(name, next) {
-                self.top.tritonapi.deleteInstanceTag({
-                    id: args[0],
-                    tag: name,
-                    wait: opts.wait,
-                    waitTimeout: waitTimeoutMs
-                }, function (err) {
-                    if (!err) {
-                        console.log('Deleted tag %s on instance %s',
-                            name, args[0]);
-                    }
-                    next(err);
-                });
-            }
-        }, cb);
-    }
+            // TODO: Instead of waiting for each delete, let's delete
+            // them all then wait for the set.
+            vasync.forEachPipeline({
+                inputs: names,
+                func: function deleteOne(name, next) {
+                    self.top.tritonapi.deleteInstanceTag({
+                        id: args[0],
+                        tag: name,
+                        wait: opts.wait,
+                        waitTimeout: waitTimeoutMs
+                    }, function (err) {
+                        if (!err) {
+                            console.log('Deleted tag %s on instance %s',
+                                        name, args[0]);
+                        }
+                        next(err);
+                    });
+                }
+            }, cb);
+        }
+    });
 }
 
 do_delete.options = [
diff --git a/lib/do_instance/do_tag/do_get.js b/lib/do_instance/do_tag/do_get.js
index 9060300..d78c300 100644
--- a/lib/do_instance/do_tag/do_get.js
+++ b/lib/do_instance/do_tag/do_get.js
@@ -10,6 +10,7 @@
  * `triton instance tag get ...`
  */
 
+var common = require('../../common');
 var errors = require('../../errors');
 
 
@@ -23,20 +24,25 @@ function do_get(subcmd, opts, args, cb) {
         return;
     }
 
-    self.top.tritonapi.getInstanceTag({
-        id: args[0],
-        tag: args[1]
-    }, function (err, value) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-        if (opts.json) {
-            console.log(JSON.stringify(value));
-        } else {
-            console.log(value);
-        }
-        cb();
+        self.top.tritonapi.getInstanceTag({
+            id: args[0],
+            tag: args[1]
+        }, function (err, value) {
+            if (err) {
+                cb(err);
+                return;
+            }
+            if (opts.json) {
+                console.log(JSON.stringify(value));
+            } else {
+                console.log(value);
+            }
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_instance/do_tag/do_list.js b/lib/do_instance/do_tag/do_list.js
index 60023ef..09d7dba 100644
--- a/lib/do_instance/do_tag/do_list.js
+++ b/lib/do_instance/do_tag/do_list.js
@@ -10,6 +10,7 @@
  * `triton instance tag list ...`
  */
 
+var common = require('../../common');
 var errors = require('../../errors');
 
 function do_list(subcmd, opts, args, cb) {
@@ -22,17 +23,23 @@ function do_list(subcmd, opts, args, cb) {
         return;
     }
 
-    self.top.tritonapi.listInstanceTags({id: args[0]}, function (err, tags) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-        if (opts.json) {
-            console.log(JSON.stringify(tags));
-        } else {
-            console.log(JSON.stringify(tags, null, 4));
-        }
-        cb();
+        self.top.tritonapi.listInstanceTags(
+            {id: args[0]}, function (err, tags) {
+            if (err) {
+                cb(err);
+                return;
+            }
+            if (opts.json) {
+                console.log(JSON.stringify(tags));
+            } else {
+                console.log(JSON.stringify(tags, null, 4));
+            }
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_instance/do_tag/do_replace_all.js b/lib/do_instance/do_tag/do_replace_all.js
index fa6f643..97a5dc4 100644
--- a/lib/do_instance/do_tag/do_replace_all.js
+++ b/lib/do_instance/do_tag/do_replace_all.js
@@ -12,6 +12,7 @@
 
 var vasync = require('vasync');
 
+var common = require('../../common');
 var errors = require('../../errors');
 var mat = require('../../metadataandtags');
 
@@ -27,7 +28,8 @@ function do_replace_all(subcmd, opts, args, cb) {
     }
     var log = self.log;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function gatherTags(ctx, next) {
             mat.tagsFromSetArgs(opts, args.slice(1), log, function (err, tags) {
                 if (err) {
diff --git a/lib/do_instance/do_tag/do_set.js b/lib/do_instance/do_tag/do_set.js
index 8040e63..e3e2fbb 100644
--- a/lib/do_instance/do_tag/do_set.js
+++ b/lib/do_instance/do_tag/do_set.js
@@ -12,6 +12,7 @@
 
 var vasync = require('vasync');
 
+var common = require('../../common');
 var errors = require('../../errors');
 var mat = require('../../metadataandtags');
 
@@ -27,7 +28,8 @@ function do_set(subcmd, opts, args, cb) {
     }
     var log = self.log;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function gatherTags(ctx, next) {
             mat.tagsFromSetArgs(opts, args.slice(1), log, function (err, tags) {
                 if (err) {
diff --git a/lib/do_instance/do_wait.js b/lib/do_instance/do_wait.js
index 529acb2..a472238 100644
--- a/lib/do_instance/do_wait.js
+++ b/lib/do_instance/do_wait.js
@@ -12,6 +12,7 @@
 
 var vasync = require('vasync');
 
+var common = require('../common');
 var distractions = require('../distractions');
 var errors = require('../errors');
 
@@ -34,7 +35,8 @@ function do_wait(subcmd, opts, args, cb) {
     var done = 0;
     var instFromId = {};
 
-    vasync.pipeline({funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function getInsts(_, next) {
             vasync.forEachParallel({
                 inputs: ids,
diff --git a/lib/do_instance/gen_do_ACTION.js b/lib/do_instance/gen_do_ACTION.js
index 1e86fc7..d39f254 100644
--- a/lib/do_instance/gen_do_ACTION.js
+++ b/lib/do_instance/gen_do_ACTION.js
@@ -83,8 +83,6 @@ function gen_do_ACTION(opts) {
 function _doTheAction(action, subcmd, opts, args, callback) {
     var self = this;
 
-    var now = Date.now();
-
     var command, state;
     switch (action) {
         case 'start':
@@ -116,7 +114,17 @@ function _doTheAction(action, subcmd, opts, args, callback) {
         callback(new errors.UsageError('missing INST arg(s)'));
         return;
     }
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
+        }
+        _doOnEachInstance(self, action, command, state, args, opts, callback);
+    });
+}
 
+function _doOnEachInstance(self, action, command, state, instances,
+                           opts, callback) {
+    var now = Date.now();
     vasync.forEachParallel({
         func: function (arg, cb) {
             var alias, uuid;
@@ -190,7 +198,7 @@ function _doTheAction(action, subcmd, opts, args, callback) {
                 });
             }
         },
-        inputs: args
+        inputs: instances
     }, function (err, results) {
         var e = err ? (new Error('command failure')) : null;
         callback(e);
diff --git a/lib/do_key/do_add.js b/lib/do_key/do_add.js
index 15b5d5a..b868b53 100644
--- a/lib/do_key/do_add.js
+++ b/lib/do_key/do_add.js
@@ -40,7 +40,8 @@ function do_add(subcmd, opts, args, cb) {
     var filePath = args[0];
     var cli = this.top;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function gatherDataStdin(ctx, next) {
             if (filePath !== '-') {
                 return next();
diff --git a/lib/do_key/do_delete.js b/lib/do_key/do_delete.js
index 69e77d2..d481201 100644
--- a/lib/do_key/do_delete.js
+++ b/lib/do_key/do_delete.js
@@ -35,7 +35,8 @@ function do_delete(subcmd, opts, args, cb) {
 
     var cli = this.top;
 
-    vasync.pipeline({funcs: [
+    vasync.pipeline({arg: {cli: this.top}, funcs: [
+        common.cliSetupTritonApi,
         function confirm(_, next) {
             if (opts.yes) {
                 return next();
diff --git a/lib/do_key/do_get.js b/lib/do_key/do_get.js
index 92fd43a..e519358 100644
--- a/lib/do_key/do_get.js
+++ b/lib/do_key/do_get.js
@@ -35,22 +35,27 @@ function do_get(subcmd, opts, args, cb) {
     var id = args[0];
     var cli = this.top;
 
-    cli.tritonapi.cloudapi.getKey({
-        // Currently `cloudapi.getUserKey` isn't picky about the `name` being
-        // passed in as the `opts.fingerprint` arg.
-        fingerprint: id
-    }, function onKey(err, key) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            console.log(JSON.stringify(key));
-        } else {
-            console.log(common.chomp(key.key));
-        }
-        cb();
+        cli.tritonapi.cloudapi.getKey({
+            // Currently `cloudapi.getUserKey` isn't picky about the
+            // `name` being passed in as the `opts.fingerprint` arg.
+            fingerprint: id
+        }, function onKey(err, key) {
+            if (err) {
+                cb(err);
+                return;
+            }
+
+            if (opts.json) {
+                console.log(JSON.stringify(key));
+            } else {
+                console.log(common.chomp(key.key));
+            }
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_key/do_list.js b/lib/do_key/do_list.js
index 69f9c4b..b09063d 100644
--- a/lib/do_key/do_list.js
+++ b/lib/do_key/do_list.js
@@ -37,37 +37,42 @@ function do_list(subcmd, opts, args, cb) {
 
     var cli = this.top;
 
-    cli.tritonapi.cloudapi.listKeys({}, function onKeys(err, keys) {
-        if (err) {
-            cb(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-
-        if (opts.json) {
-            common.jsonStream(keys);
-        } else if (opts.authorized_keys) {
-            keys.forEach(function (key) {
-                console.log(common.chomp(key.key));
-            });
-        } else {
-            var columns = COLUMNS_DEFAULT;
-
-            if (opts.o) {
-                columns = opts.o;
-            } else if (opts.long) {
-                columns = COLUMNS_LONG;
+        cli.tritonapi.cloudapi.listKeys({}, function onKeys(err, keys) {
+            if (err) {
+                cb(err);
+                return;
             }
 
-            columns = columns.split(',');
-            var sort = opts.s.split(',');
-
-            tabula(keys, {
-                skipHeader: false,
-                columns: columns,
-                sort: sort
-            });
-        }
-        cb();
+            if (opts.json) {
+                common.jsonStream(keys);
+            } else if (opts.authorized_keys) {
+                keys.forEach(function (key) {
+                    console.log(common.chomp(key.key));
+                });
+            } else {
+                var columns = COLUMNS_DEFAULT;
+
+                if (opts.o) {
+                    columns = opts.o;
+                } else if (opts.long) {
+                    columns = COLUMNS_LONG;
+                }
+
+                columns = columns.split(',');
+                var sort = opts.s.split(',');
+
+                tabula(keys, {
+                    skipHeader: false,
+                    columns: columns,
+                    sort: sort
+                });
+            }
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_network/do_get.js b/lib/do_network/do_get.js
index 8d62ed3..02531d2 100644
--- a/lib/do_network/do_get.js
+++ b/lib/do_network/do_get.js
@@ -25,17 +25,24 @@ function do_get(subcmd, opts, args, cb) {
             'incorrect number of args (%d)', args.length)));
     }
 
-    this.top.tritonapi.getNetwork(args[0], function (err, net) {
-        if (err) {
-            return cb(err);
-        }
+    var tritonapi = this.top.tritonapi;
 
-        if (opts.json) {
-            console.log(JSON.stringify(net));
-        } else {
-            console.log(JSON.stringify(net, null, 4));
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            cb(setupErr);
         }
-        cb();
+        tritonapi.getNetwork(args[0], function (err, net) {
+            if (err) {
+                return cb(err);
+            }
+
+            if (opts.json) {
+                console.log(JSON.stringify(net));
+            } else {
+                console.log(JSON.stringify(net, null, 4));
+            }
+            cb();
+        });
     });
 }
 
diff --git a/lib/do_network/do_list.js b/lib/do_network/do_list.js
index b3bd3c9..7cc963c 100644
--- a/lib/do_network/do_list.js
+++ b/lib/do_network/do_list.js
@@ -49,28 +49,34 @@ function do_list(subcmd, opts, args, callback) {
     columns = columns.split(',');
 
     var sort = opts.s.split(',');
+    var tritonapi = this.top.tritonapi;
 
-    this.top.tritonapi.cloudapi.listNetworks(function (err, networks) {
-        if (err) {
-            callback(err);
-            return;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.cloudapi.listNetworks(function (err, networks) {
+            if (err) {
+                callback(err);
+                return;
+            }
 
-        if (opts.json) {
-            common.jsonStream(networks);
-        } else {
-            for (var i = 0; i < networks.length; i++) {
-                var net = networks[i];
-                net.shortid = net.id.split('-', 1)[0];
-                net.vlan = net.vlan_id;
+            if (opts.json) {
+                common.jsonStream(networks);
+            } else {
+                for (var i = 0; i < networks.length; i++) {
+                    var net = networks[i];
+                    net.shortid = net.id.split('-', 1)[0];
+                    net.vlan = net.vlan_id;
+                }
+                tabula(networks, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort
+                });
             }
-            tabula(networks, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort
-            });
-        }
-        callback();
+            callback();
+        });
     });
 }
 
diff --git a/lib/do_package/do_get.js b/lib/do_package/do_get.js
index d02b3a5..4ba4b52 100644
--- a/lib/do_package/do_get.js
+++ b/lib/do_package/do_get.js
@@ -12,6 +12,7 @@
 
 var format = require('util').format;
 
+var common = require('../common');
 var errors = require('../errors');
 
 
@@ -24,17 +25,23 @@ function do_get(subcmd, opts, args, callback) {
             'incorrect number of args (%d)', args.length)));
     }
 
-    this.top.tritonapi.getPackage(args[0], function onRes(err, pkg) {
-        if (err) {
-            return callback(err);
+    var tritonapi = this.top.tritonapi;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.getPackage(args[0], function onRes(err, pkg) {
+            if (err) {
+                return callback(err);
+            }
 
-        if (opts.json) {
-            console.log(JSON.stringify(pkg));
-        } else {
-            console.log(JSON.stringify(pkg, null, 4));
-        }
-        callback();
+            if (opts.json) {
+                console.log(JSON.stringify(pkg));
+            } else {
+                console.log(JSON.stringify(pkg, null, 4));
+            }
+            callback();
+        });
     });
 }
 
@@ -63,7 +70,7 @@ do_get.help = [
     '',
     'Where PACKAGE is a package id (full UUID), exact name, or short id.',
     '',
-    'Note: Currently this dumps prettified JSON by default. That might change',
+    'Note: Currently this dumps perttified JSON by default. That might change',
     'in the future. Use "-j" to explicitly get JSON output.'
     /* END JSSTYLED */
 ].join('\n');
diff --git a/lib/do_package/do_list.js b/lib/do_package/do_list.js
index b7ba5a0..d9166ae 100644
--- a/lib/do_package/do_list.js
+++ b/lib/do_package/do_list.js
@@ -11,6 +11,7 @@
  */
 
 var tabula = require('tabula');
+var vasync = require('vasync');
 
 var common = require('../common');
 
@@ -68,73 +69,89 @@ function do_list(subcmd, opts, args, callback) {
         return;
     }
 
-    this.top.tritonapi.cloudapi.listPackages(listOpts, function (err, pkgs) {
-        if (err) {
-            callback(err);
-            return;
-        }
-        if (opts.json) {
-            common.jsonStream(pkgs);
-        } else {
-            for (i = 0; i < pkgs.length; i++) {
-                var pkg = pkgs[i];
-                pkg.shortid = pkg.id.split('-', 1)[0];
-
-                /*
-                 * We take a slightly "smarter" view of "group" for default
-                 * sorting, to accomodate usage in the JPC. More recent
-                 * common usage is for packages to have "foo-*" naming.
-                 * JPC includes package sets of yore *and* recent that don't
-                 * use the "group" field. We secondarily separate those
-                 * on a possible "foo-" prefix.
-                 */
-                pkg._groupPlus = (pkg.group || (pkg.name.indexOf('-') === -1
-                    ? '' : pkg.name.split('-', 1)[0]));
-
-                if (!opts.p) {
-                    pkg.memoryHuman = common.humanSizeFromBytes({
-                        precision: 1,
-                        narrow: true
-                    }, pkg.memory * 1024 * 1024);
-                    pkg.swapHuman = common.humanSizeFromBytes({
-                        precision: 1,
-                        narrow: true
-                    }, pkg.swap * 1024 * 1024);
-                    pkg.diskHuman = common.humanSizeFromBytes({
-                        precision: 1,
-                        narrow: true
-                    }, pkg.disk * 1024 * 1024);
-                    pkg.vcpusHuman = pkg.vcpus === 0 ? '-' : pkg.vcpus;
+    var context = {
+        cli: this.top
+    };
+    vasync.pipeline({arg: context, funcs: [
+        common.cliSetupTritonApi,
+
+        function getThem(arg, next) {
+            arg.cli.tritonapi.cloudapi.listPackages(listOpts,
+                function (err, pkgs) {
+                    if (err) {
+                        next(err);
+                        return;
+                    }
+                    arg.pkgs = pkgs;
+                    next();
                 }
-            }
-            if (!opts.p) {
-                columns = columns.map(function (c) {
-                    switch (c.lookup || c) {
-                    case 'memory':
-                        return {lookup: 'memoryHuman', name: 'MEMORY',
-                            align: 'right'};
-                    case 'swap':
-                        return {lookup: 'swapHuman', name: 'SWAP',
-                            align: 'right'};
-                    case 'disk':
-                        return {lookup: 'diskHuman', name: 'DISK',
-                            align: 'right'};
-                    case 'vcpus':
-                        return {lookup: 'vcpusHuman', name: 'VCPUS',
-                            align: 'right'};
-                    default:
-                        return c;
+            );
+        },
+
+        function display(arg, next) {
+            if (opts.json) {
+                common.jsonStream(arg.pkgs);
+            } else {
+                for (i = 0; i < arg.pkgs.length; i++) {
+                    var pkg = arg.pkgs[i];
+                    pkg.shortid = pkg.id.split('-', 1)[0];
+
+                    /*
+                     * We take a slightly "smarter" view of "group" for default
+                     * sorting, to accomodate usage in the JPC. More recent
+                     * common usage is for packages to have "foo-*" naming.
+                     * JPC includes package sets of yore *and* recent that don't
+                     * use the "group" field. We secondarily separate those
+                     * on a possible "foo-" prefix.
+                     */
+                    pkg._groupPlus = (pkg.group || (pkg.name.indexOf('-') === -1
+                        ? '' : pkg.name.split('-', 1)[0]));
+
+                    if (!opts.p) {
+                        pkg.memoryHuman = common.humanSizeFromBytes({
+                            precision: 1,
+                            narrow: true
+                        }, pkg.memory * 1024 * 1024);
+                        pkg.swapHuman = common.humanSizeFromBytes({
+                            precision: 1,
+                            narrow: true
+                        }, pkg.swap * 1024 * 1024);
+                        pkg.diskHuman = common.humanSizeFromBytes({
+                            precision: 1,
+                            narrow: true
+                        }, pkg.disk * 1024 * 1024);
+                        pkg.vcpusHuman = pkg.vcpus === 0 ? '-' : pkg.vcpus;
                     }
+                }
+                if (!opts.p) {
+                    columns = columns.map(function (c) {
+                        switch (c.lookup || c) {
+                        case 'memory':
+                            return {lookup: 'memoryHuman', name: 'MEMORY',
+                                align: 'right'};
+                        case 'swap':
+                            return {lookup: 'swapHuman', name: 'SWAP',
+                                align: 'right'};
+                        case 'disk':
+                            return {lookup: 'diskHuman', name: 'DISK',
+                                align: 'right'};
+                        case 'vcpus':
+                            return {lookup: 'vcpusHuman', name: 'VCPUS',
+                                align: 'right'};
+                        default:
+                            return c;
+                        }
+                    });
+                }
+                tabula(arg.pkgs, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort
                 });
             }
-            tabula(pkgs, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort
-            });
+            next();
         }
-        callback();
-    });
+    ]}, callback);
 }
 
 do_list.options = [
diff --git a/lib/do_profile/do_create.js b/lib/do_profile/do_create.js
index f5dcd60..72ae4c6 100644
--- a/lib/do_profile/do_create.js
+++ b/lib/do_profile/do_create.js
@@ -9,6 +9,7 @@ var format = require('util').format;
 var fs = require('fs');
 var sshpk = require('sshpk');
 var vasync = require('vasync');
+var auth = require('smartdc-auth');
 
 var common = require('../common');
 var errors = require('../errors');
@@ -101,17 +102,15 @@ function _createProfile(opts, cb) {
                     'create profile: stdout is not a TTY'));
             }
 
+            var kr = new auth.KeyRing();
+            var keyChoices = {};
+
             var defaults = {};
             if (ctx.copy) {
                 defaults = ctx.copy;
                 delete defaults.name; // we don't copy a profile name
             } else {
                 defaults.url = 'https://us-sw-1.api.joyent.com';
-
-                var possibleDefaultFp = '~/.ssh/id_rsa';
-                if (fs.existsSync(common.tildeSync(possibleDefaultFp))) {
-                    defaults.keyId = possibleDefaultFp;
-                }
             }
 
             var fields = [ {
@@ -156,11 +155,10 @@ function _createProfile(opts, cb) {
                     valCb();
                 }
             }, {
-                desc: 'The fingerprint of the SSH key you have registered ' +
-                    'for your account. Alternatively, You may enter a local ' +
-                    'path to a public or private SSH key to have the ' +
-                    'fingerprint calculated for you.',
-                default: defaults.keyId,
+                desc: 'The fingerprint of the SSH key you want to use, or ' +
+                    'its index in the list above. If the key you want to ' +
+                    'use is not listed, make sure it is either saved in your ' +
+                    'SSH keys directory or loaded into the SSH agent.',
                 key: 'keyId',
                 validate: function validateKeyId(value, valCb) {
                     // First try as a fingerprint.
@@ -170,44 +168,14 @@ function _createProfile(opts, cb) {
                     } catch (fpErr) {
                     }
 
-                    // Try as a local path.
-                    var keyPath = common.tildeSync(value);
-                    fs.stat(keyPath, function (statErr, stats) {
-                        if (statErr || !stats.isFile()) {
-                            return valCb(new Error(format(
-                                '"%s" is neither a valid fingerprint, ' +
-                                'nor an existing file', value)));
-                        }
-                        fs.readFile(keyPath, function (readErr, keyData) {
-                            if (readErr) {
-                                return valCb(readErr);
-                            }
-                            var keyType = (keyPath.slice(-4) === '.pub'
-                                ? 'ssh' : 'pem');
-                            try {
-                                var key = sshpk.parseKey(keyData, keyType);
-                            } catch (keyErr) {
-                                return valCb(keyErr);
-                            }
-
-                            /*
-                             * Save the user's explicit given key path. We will
-                             * using it later for Docker setup. Trying to use
-                             * the same format as node-smartdc's loadSSHKey
-                             * `keyPaths` param.
-                             */
-                            ctx.keyPaths = {};
-                            if (keyType === 'ssh') {
-                                ctx.keyPaths.public = keyPath;
-                            } else {
-                                ctx.keyPaths.private = keyPath;
-                            }
+                    // Try as a list index
+                    if (keyChoices[value] !== undefined) {
+                        return valCb(null, keyChoices[value]);
+                    }
 
-                            var newVal = key.fingerprint('md5').toString();
-                            console.log('Fingerprint: %s', newVal);
-                            valCb(null, newVal);
-                        });
-                    });
+                    valCb(new Error(format(
+                        '"%s" is neither a valid fingerprint, not an index ' +
+                        'from the list of available keys', value)));
                 }
             } ];
 
@@ -234,11 +202,50 @@ function _createProfile(opts, cb) {
             vasync.forEachPipeline({
                 inputs: fields,
                 func: function getField(field, nextField) {
-                    if (field.key !== 'name') console.log();
-                    common.promptField(field, function (err, value) {
-                        data[field.key] = value;
-                        nextField(err);
-                    });
+                    if (field.key !== 'name')
+                        console.log();
+                    if (field.key === 'keyId') {
+                        kr.list(function (err, pairs) {
+                            if (err) {
+                                nextField(err);
+                                return;
+                            }
+                            var choice = 1;
+                            console.log('Available SSH keys:');
+                            Object.keys(pairs).forEach(function (keyId) {
+                                var valid = pairs[keyId].filter(function (kp) {
+                                    return (kp.canSign());
+                                });
+                                if (valid.length < 1)
+                                    return;
+                                var pub = valid[0].getPublicKey();
+                                console.log(
+                                    ' %d. %d-bit %s key with fingerprint %s',
+                                    choice, pub.size, pub.type.toUpperCase(),
+                                    keyId);
+                                pairs[keyId].forEach(function (kp) {
+                                    var comment = kp.comment ||
+                                        kp.getPublicKey().comment;
+                                    console.log('  * [in %s] %s %s %s',
+                                        kp.plugin, comment,
+                                        (kp.source ? kp.source : ''),
+                                        (kp.isLocked() ? '[locked]' : ''));
+                                });
+                                console.log();
+                                keyChoices[choice] = keyId;
+                                ++choice;
+                            });
+                            common.promptField(field, function (err2, value) {
+                                data[field.key] = value;
+                                nextField(err2);
+                            });
+                        });
+                    } else {
+                        common.promptField(field, function (err, value) {
+                            data[field.key] = value;
+                            nextField(err);
+                        });
+                    }
                 }
             }, function (err) {
                 console.log();
diff --git a/lib/do_profile/profilecommon.js b/lib/do_profile/profilecommon.js
index 4d44b82..750d396 100644
--- a/lib/do_profile/profilecommon.js
+++ b/lib/do_profile/profilecommon.js
@@ -8,6 +8,7 @@ var assert = require('assert-plus');
 var auth = require('smartdc-auth');
 var format = require('util').format;
 var fs = require('fs');
+var getpass = require('getpass');
 var https = require('https');
 var mkdirp = require('mkdirp');
 var path = require('path');
@@ -143,14 +144,18 @@ function profileDockerSetup(opts, cb) {
     assert.optionalObject(opts.keyPaths, 'opts.keyPaths');
     assert.func(cb, 'cb');
 
-    var implicit = Boolean(opts.implicit);
     var cli = opts.cli;
-    var log = cli.log;
     var tritonapi = cli.tritonapiFromProfileName({profileName: opts.name});
+
+    var implicit = Boolean(opts.implicit);
+    var log = cli.log;
+
     var profile = tritonapi.profile;
     var dockerHost;
 
-    vasync.pipeline({arg: {}, funcs: [
+    vasync.pipeline({arg: {tritonapi: tritonapi}, funcs: [
+        common.cliSetupTritonApi,
+
         function checkCloudapiStatus(arg, next) {
             tritonapi.cloudapi.ping({}, function (err, pong, res) {
                 if (!res) {
@@ -219,72 +224,35 @@ function profileDockerSetup(opts, cb) {
 
         function mentionSettingUp(arg, next) {
             console.log('Setting up profile "%s" to use Docker.', profile.name);
-            next();
-        },
-
-        function findSshPrivKey_keyPaths(arg, next) {
-            if (!opts.keyPaths) {
-                next();
-                return;
-            }
-
-            var privKeyPath = opts.keyPaths.private;
-            if (!privKeyPath) {
-                assert.string(opts.keyPaths.public);
-                assert.ok(opts.keyPaths.public.slice(-4) === '.pub');
-                privKeyPath = opts.keyPaths.public.slice(0, -4);
-                if (!fs.existsSync(privKeyPath)) {
-                    cb(new errors.SetupError(format('could not find SSH '
-                        + 'private key file from public key file "%s": "%s" '
-                        + 'does not exist', opts.keyPaths.public,
-                        privKeyPath)));
-                    return;
-                }
-            }
-
-            arg.sshKeyPaths = {
-                private: privKeyPath,
-                public: opts.keyPaths.public
-            };
-
-            fs.readFile(privKeyPath, function (readErr, keyData) {
-                if (readErr) {
-                    cb(readErr);
-                    return;
-                }
-                try {
-                    arg.sshPrivKey = sshpk.parseKey(keyData, 'pem');
-                } catch (keyErr) {
-                    cb(keyErr);
-                    return;
+            console.log(wordwrap(
+                '\nWARNING: Docker uses TLS-based authentication with a ' +
+                 'different security model from SSH keys. As a result, the ' +
+                    'Docker client cannot currently support encrypted ' +
+                    '(password protected) keys or SSH agents. If you ' +
+                    'continue, the Triton CLI will attempt to format a copy ' +
+                    'of your SSH *private* key as an unencrypted TLS cert ' +
+                    'and place the copy in ~/.triton/docker for use by the ' +
+                    'Docker client.'));
+            common.promptYesNo({msg: 'Continue? [y/n] '}, function (answer) {
+                if (answer !== 'y') {
+                    console.error('Aborting');
+                    next(true);
+                } else {
+                    next();
                 }
-                log.trace({sshKeyPaths: arg.sshKeyPaths},
-                    'profileDockerSetup: findSshPrivKey_keyPaths');
-                next();
             });
         },
-        function findSshPrivKey_keyId(arg, next) {
-            if (opts.keyPaths) {
-                next();
+
+        function checkSshPrivKey(arg, next) {
+            try {
+                tritonapi.keyPair.getPrivateKey();
+            } catch (e) {
+                next(new errors.SetupError(format('could not obtain SSH ' +
+                    'private key for keypair with fingerprint "%s" ' +
+                    'to create Docker certificate.', profile.keyId)));
                 return;
             }
-
-            // TODO: keyPaths here is using a non-#master of node-smartdc-auth.
-            //      Change back to a smartdc-auth release when
-            //      https://github.com/joyent/node-smartdc-auth/pull/5 is in.
-            auth.loadSSHKey(profile.keyId, function (err, key, keyPaths) {
-                if (err) {
-                    // TODO: better error message here.
-                    next(err);
-                } else {
-                    assert.ok(key, 'key from auth.loadSSHKey');
-                    log.trace({keyId: profile.keyId, sshKeyPaths: keyPaths},
-                        'profileDockerSetup: findSshPrivKey');
-                    arg.sshKeyPaths = keyPaths;
-                    arg.sshPrivKey = key;
-                    next();
-                }
-            });
+            next();
         },
 
         /*
@@ -348,31 +316,32 @@ function profileDockerSetup(opts, cb) {
         },
         function genClientCert_key(arg, next) {
             arg.keyPath = path.resolve(arg.dockerCertPath, 'key.pem');
-            common.execPlus({
-                cmd: format('openssl rsa -in %s -out %s -outform pem',
-                    arg.sshKeyPaths.private, arg.keyPath),
-                log: log
-            }, next);
-        },
-        function genClientCert_csr(arg, next) {
-            arg.csrPath = path.resolve(arg.dockerCertPath, 'csr.pem');
-            common.execPlus({
-                cmd: format('openssl req -new -key %s -out %s -subj "/CN=%s"',
-                    arg.keyPath, arg.csrPath, profile.account),
-                log: log
-            }, next);
+            var data = tritonapi.keyPair.getPrivateKey().toBuffer('pkcs1');
+            fs.writeFile(arg.keyPath, data, function (err) {
+                if (err) {
+                    next(new errors.SetupError(err, format(
+                        'error writing file %s', arg.keyPath)));
+                } else {
+                    next();
+                }
+            });
         },
         function genClientCert_cert(arg, next) {
             arg.certPath = path.resolve(arg.dockerCertPath, 'cert.pem');
-            common.execPlus({
-                cmd: format(
-                    'openssl x509 -req -days 365 -in %s -signkey %s -out %s',
-                    arg.csrPath, arg.keyPath, arg.certPath),
-                log: log
-            }, next);
-        },
-        function genClientCert_deleteCsr(arg, next) {
-            rimraf(arg.csrPath, next);
+
+            var privKey = tritonapi.keyPair.getPrivateKey();
+            var id = sshpk.identityFromDN('CN=' + profile.account);
+            var cert = sshpk.createSelfSignedCertificate(id, privKey);
+            var data = cert.toBuffer('pem');
+
+            fs.writeFile(arg.certPath, data, function (err) {
+                if (err) {
+                    next(new errors.SetupError(err, format(
+                        'error writing file %s', arg.keyPath)));
+                } else {
+                    next();
+                }
+            });
         },
 
         function getServerCa(arg, next) {
diff --git a/lib/do_services.js b/lib/do_services.js
index b8e90be..8850451 100644
--- a/lib/do_services.js
+++ b/lib/do_services.js
@@ -31,38 +31,44 @@ function do_services(subcmd, opts, args, callback) {
 
     var columns = opts.o.split(',');
     var sort = opts.s.split(',');
+    var tritonapi = this.tritonapi;
 
-    this.tritonapi.cloudapi.listServices(function (err, services) {
-        if (err) {
-            callback(err);
-            return;
+    common.cliSetupTritonApi({cli: this}, function onSetup(setupErr) {
+        if (setupErr) {
+            callback(setupErr);
         }
+        tritonapi.cloudapi.listServices(function (err, services) {
+            if (err) {
+                callback(err);
+                return;
+            }
 
-        if (opts.json) {
-            console.log(JSON.stringify(services));
-        } else {
-            /*
-             * services are returned in the form of:
-             * {name: 'endpoint', name2: 'endpoint2', ...}
-             * we "normalize" them for use by tabula and JSON stream
-             * by making them an array
-             */
-            var svcs = [];
-            Object.keys(services).forEach(function (key) {
-                svcs.push({
-                    name: key,
-                    endpoint: services[key]
+            if (opts.json) {
+                console.log(JSON.stringify(services));
+            } else {
+                /*
+                 * services are returned in the form of:
+                 * {name: 'endpoint', name2: 'endpoint2', ...}
+                 * we "normalize" them for use by tabula and JSON stream
+                 * by making them an array
+                 */
+                var svcs = [];
+                Object.keys(services).forEach(function (key) {
+                    svcs.push({
+                        name: key,
+                        endpoint: services[key]
+                    });
                 });
-            });
-            tabula(svcs, {
-                skipHeader: opts.H,
-                columns: columns,
-                sort: sort,
-                dottedLookup: true
-            });
-        }
+                tabula(svcs, {
+                    skipHeader: opts.H,
+                    columns: columns,
+                    sort: sort,
+                    dottedLookup: true
+                });
+            }
 
-        callback();
+            callback();
+        });
     });
 }
 
diff --git a/lib/index.js b/lib/index.js
index c050222..070c43f 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -11,41 +11,75 @@
 var assert = require('assert-plus');
 
 var bunyannoop = require('./bunyannoop');
+var common = require('./common');
 var mod_config = require('./config');
 var tritonapi = require('./tritonapi');
 
 
 /**
- * A convenience wrapper around `tritonapi.createClient` to for simpler usage.
+ * A convenience wrapper around `tritonapi.createClient` for simpler usage.
+ * There are two steps: (1) create and init the TritonApi instance,
+ * (2) unlock the key used for authentication if necessary.
+ *
+ *
+ * # 1. Create and init the TritonApi client instance
  *
  * Minimally this only requires that one of `profileName` or `profile` be
  * specified. Examples:
  *
  *      var triton = require('triton');
- *      var client = triton.createClient({
+ *      triton.createClient({
  *          profile: {
  *              url: "<cloudapi url>",
  *              account: "<account login for this cloud>",
  *              keyId: "<ssh key fingerprint for one of account's keys>"
  *          }
- *      });
+ *      }, function (err, client) { ... });
  *      --
  *      // Loading a profile from the environment (the `TRITON_*` and/or
  *      // `SDC_*` environment variables).
- *      var client = triton.createClient({profileName: 'env'});
+ *      triton.createClient({profileName: 'env'},
+ *          function (err, client) { ... });
  *      --
- *      var client = triton.createClient({
+ *      triton.createClient({
  *          configDir: '~/.triton',     // use the CLI's config dir ...
  *          profileName: 'east1'        // ... to find named profiles
- *      });
+ *      }, function (err, client) { ... });
  *      --
  *      // The same thing using the underlying APIs.
- *      var client = triton.createClient({
- *          config: triton.loadConfig({configDir: '~/.triton'},
+ *      triton.createClient({
+ *          config: triton.loadConfig({configDir: '~/.triton'}),
  *          profile: triton.loadProfile({name: 'east1', configDir: '~/.triton'})
+ *      }, function (err, client) { ... });
+ *
+ * TODO: The story for an app wanting to specify some Triton config but NOT
+ * have to have a triton $configDir/config.json is poor.
+ *
+ *
+ * # 2. Unlock the auth key
+ *
+ * Triton uses HTTP-Signature auth, where an SSH private key is used to
+ * sign requests. The server-side authenticates by verifying that signature
+ * using the previously uploaded public key. For the client to sign a request
+ * it needs an unlocked private key: an SSH private key that (a) has no
+ * passphrase, (b) is loaded in an ssh-agent, or (c) a passphrase to unlock
+ * the key. This step is about case (c).
+ *
+ * The `triton` CLI uses the `mod_triton.promptPassphraseUnlockKey` convenience
+ * function to prompt on a TTY for the passphrase, if necessary. Effectively
+ * like this:
+ *
+ *      triton.promptPassphraseUnlockKey({
+ *          tritonapi: client
+ *      }, function (unlockErr) {
+ *          if (unlockErr) boom(unlockErr);
+ *
+ *          // Now you can finally make an API call.
+ *          // ...
  *      });
  *
- * A more complete example an app using triton internally might want:
+ *
+ * # A more complete example
  *
  *      var triton = require('triton');
  *      var bunyan = require('bunyan');
@@ -54,14 +88,22 @@ var tritonapi = require('./tritonapi');
  *          // However the app handles its config.
  *      };
  *      var log = bunyan.createLogger({name: 'myapp', component: 'triton'});
- *      var client = triton.createClient({
+ *
+ *      triton.createClient({
  *          log: log,
  *          profile: appConfig.tritonProfile
- *      });
+ *      }, function (initErr, client) {
+ *          if (initErr) boom(initErr);
  *
+ *          triton.promptPassphraseUnlockKey({
+ *              tritonapi: client
+ *          }, function (unlockErr) {
+ *              if (unlockErr) boom(unlockErr);
+ *
+ *              // ...
+ *          });
+ *      });
  *
- * TODO: The story for an app wanting to specify some Triton config but NOT
- * have to have a triton $configDir/config.json is poor.
  *
  * @param opts {Object}:
  *      - @param profile {Object} A *Triton profile* object that includes the
@@ -149,6 +191,7 @@ function createClient(opts) {
 
 module.exports = {
     createClient: createClient,
+    promptPassphraseUnlockKey: common.promptPassphraseUnlockKey,
 
     /**
      * `createClient` provides convenience parameters to not *have* to call
diff --git a/lib/tritonapi.js b/lib/tritonapi.js
index 36e39fc..a191498 100644
--- a/lib/tritonapi.js
+++ b/lib/tritonapi.js
@@ -8,6 +8,41 @@
  * Copyright 2016 Joyent, Inc.
  *
  * Core TritonApi client driver class.
+ *
+ * Usage:
+ *      // 1. Create the TritonApi instance.
+ *      var tritonapi = lib_tritonapi.createClient({
+ *          log: self.log,
+ *          profile: self.profile,
+ *          config: self.config
+ *      });
+ *
+ *      // 2. Call `init` to setup the profile. This involves finding the SSH
+ *      //    key identified by the profile's keyId.
+ *      tritonapi.init(function (initErr) {
+ *          if (initErr) boom();
+ *
+ *          // 3a. If/when ready to make a signed request, it is up to the
+ *          //    caller to ensure the signing SSH key is unlocked. Either
+ *          //    like this:
+ *          if (tritonapi.keyPair.isLocked()) {
+ *              // This throws if the passphrase is incorrect.
+ *              tritonapi.keyPair.unlock(passphrase);
+ *          }
+ *
+ *          // 3b. Or via a provided helper that uses `getpass` to prompt
+ *          //    the user on a TTY:
+ *          lib_common.promptPassphraseUnlockKey({
+ *              tritonapi: tritonapi
+ *          }, function (unlockErr) {
+ *              if (unlockErr) boom(unlockErr);
+ *
+ *              // 4. Now you can finally make an API call. For example:
+ *              tritonapi.listImages(function (err, imgs) {
+ *                  // ...
+ *              });
+ *          });
+ *      });
  */
 
 var assert = require('assert-plus');
@@ -24,6 +59,7 @@ var restifyBunyanSerializers =
     require('restify-clients/lib/helpers/bunyan').serializers;
 var tabula = require('tabula');
 var vasync = require('vasync');
+var sshpk = require('sshpk');
 
 var cloudapi = require('./cloudapi2');
 var common = require('./common');
@@ -116,6 +152,14 @@ function _stepFwRuleId(arg, next) {
 /**
  * Create a TritonApi client.
  *
+ * Public properties (TODO: doc all of these):
+ *      - profile
+ *      - config
+ *      - log
+ *      - cacheDir (only available if configured with a configDir)
+ *      - keyPair (available after init)
+ *      - cloudapi (available after init)
+ *
  * @param opts {Object}
  *      - log {Bunyan Logger}
  *      ...
@@ -128,6 +172,7 @@ function TritonApi(opts) {
 
     this.profile = opts.profile;
     this.config = opts.config;
+    this.keyPair = null;
 
     // Make sure a given bunyan logger has reasonable client_re[qs] serializers.
     // Note: This was fixed in restify, then broken again in
@@ -147,29 +192,43 @@ function TritonApi(opts) {
             this.config.cacheDir,
             common.profileSlug(this.profile));
         this.log.trace({cacheDir: this.cacheDir}, 'cache dir');
-        // TODO perhaps move this to an async .init()
-        if (!fs.existsSync(this.cacheDir)) {
-            try {
-                mkdirp.sync(this.cacheDir);
-            } catch (e) {
-                throw e;
-            }
-        }
     }
-
-    this.cloudapi = this._cloudapiFromProfile(this.profile);
 }
 
 
 TritonApi.prototype.close = function close() {
-    this.cloudapi.close();
-    delete this.cloudapi;
+    if (this.cloudapi) {
+        this.cloudapi.close();
+        delete this.cloudapi;
+    }
 };
 
 
-TritonApi.prototype._cloudapiFromProfile =
-    function _cloudapiFromProfile(profile)
-{
+TritonApi.prototype.init = function init(cb) {
+    var self = this;
+    if (this.cacheDir) {
+        fs.exists(this.cacheDir, function (exists) {
+            if (!exists) {
+                mkdirp(self.cacheDir, function (err) {
+                    if (err) {
+                        cb(err);
+                        return;
+                    }
+                    self._setupProfile(cb);
+                });
+            } else {
+                self._setupProfile(cb);
+            }
+        });
+    } else {
+        self._setupProfile(cb);
+    }
+};
+
+TritonApi.prototype._setupProfile = function _setupProfile(cb) {
+    var self = this;
+    var profile = this.profile;
+
     assert.object(profile, 'profile');
     assert.string(profile.account, 'profile.account');
     assert.optionalString(profile.actAsAccount, 'profile.actAsAccount');
@@ -185,32 +244,39 @@ TritonApi.prototype._cloudapiFromProfile =
         ? true : !profile.insecure);
     var acceptVersion = profile.acceptVersion || CLOUDAPI_ACCEPT_VERSION;
 
-    var sign;
-    if (profile.privKey) {
-        sign = auth.privateKeySigner({
-            user: profile.account,
-            subuser: profile.user,
-            keyId: profile.keyId,
-            key: profile.privKey
-        });
-    } else {
-        sign = auth.cliSigner({
-            keyId: profile.keyId,
-            user: profile.account,
-            subuser: profile.user
-        });
-    }
-    var client = cloudapi.createClient({
+    var opts = {
         url: profile.url,
         account: profile.actAsAccount || profile.account,
-        user: profile.user,
+        principal: {
+            account: profile.account,
+            user: profile.user
+        },
         roles: profile.roles,
         version: acceptVersion,
         rejectUnauthorized: rejectUnauthorized,
-        sign: sign,
         log: this.log
-    });
-    return client;
+    };
+
+    if (profile.privKey) {
+        var key = sshpk.parsePrivateKey(profile.privKey);
+        this.keyPair =
+            opts.principal.keyPair =
+            auth.KeyPair.fromPrivateKey(key);
+        this.cloudapi = cloudapi.createClient(opts);
+        cb(null);
+    } else {
+        var kr = new auth.KeyRing();
+        var fp = sshpk.parseFingerprint(profile.keyId);
+        kr.findSigningKeyPair(fp, function (err, kp) {
+            if (err) {
+                cb(err);
+                return;
+            }
+            self.keyPair = opts.principal.keyPair = kp;
+            self.cloudapi = cloudapi.createClient(opts);
+            cb(null);
+        });
+    }
 };
 
 
diff --git a/package.json b/package.json
index 079b53a..d75237c 100644
--- a/package.json
+++ b/package.json
@@ -10,6 +10,7 @@
     "bunyan": "1.5.1",
     "cmdln": "4.1.2",
     "extsprintf": "1.0.2",
+    "getpass":  "0.1.6",
     "lomstream": "1.1.0",
     "mkdirp": "0.5.1",
     "node-uuid": "1.4.3",
@@ -19,8 +20,9 @@
     "restify-errors": "3.0.0",
     "rimraf": "2.4.4",
     "semver": "5.1.0",
-    "smartdc-auth": "git+https://github.com/joyent/node-smartdc-auth.git#05d9077",
-    "sshpk": "1.7.x",
+    "smartdc-auth": "2.5.2",
+    "sshpk": "1.10.1",
+    "sshpk-agent": "1.4.2",
     "strsplit": "1.0.0",
     "tabula": "1.7.0",
     "vasync": "1.6.3",
diff --git a/test/integration/api-images.test.js b/test/integration/api-images.test.js
index 992cc89..77c48c3 100644
--- a/test/integration/api-images.test.js
+++ b/test/integration/api-images.test.js
@@ -30,8 +30,10 @@ test('TritonApi images', function (tt) {
     var client;
     tt.test(' setup: client', function (t) {
         client = h.createClient();
-        t.ok(client, 'client');
-        t.end();
+        client.init(function (err) {
+            t.error(err);
+            t.end();
+        });
     });
 
     var testOpts = {};
diff --git a/test/integration/api-instances.test.js b/test/integration/api-instances.test.js
index 6934123..fb42c96 100644
--- a/test/integration/api-instances.test.js
+++ b/test/integration/api-instances.test.js
@@ -31,17 +31,20 @@ var INST;
 test('TritonApi packages', function (tt) {
     tt.test(' setup', function (t) {
         CLIENT = h.createClient();
-        t.ok(CLIENT, 'client');
 
-        CLIENT.cloudapi.listMachines(function (err, insts) {
-            if (h.ifErr(t, err))
-                return t.end();
+        CLIENT.init(function (initErr) {
+            t.error(initErr);
 
-            t.ok(Array.isArray(insts), 'instances');
+            CLIENT.cloudapi.listMachines(function (err, insts) {
+                if (h.ifErr(t, err))
+                    return t.end();
+
+                t.ok(Array.isArray(insts), 'instances');
 
-            INST = insts[0];
+                INST = insts[0];
 
-            t.end();
+                t.end();
+            });
         });
     });
 
diff --git a/test/integration/api-networks.test.js b/test/integration/api-networks.test.js
index e6d31bf..fb4000c 100644
--- a/test/integration/api-networks.test.js
+++ b/test/integration/api-networks.test.js
@@ -31,21 +31,23 @@ var NET;
 test('TritonApi networks', function (tt) {
     tt.test(' setup', function (t) {
         CLIENT = h.createClient();
-        t.ok(CLIENT, 'client');
 
-        var opts = {
-            account: CLIENT.profile.account
-        };
+        CLIENT.init(function (initErr) {
+            t.error(initErr);
+            var opts = {
+                account: CLIENT.profile.account
+            };
 
-        CLIENT.cloudapi.listNetworks(opts, function (err, nets) {
-            if (h.ifErr(t, err))
-                return t.end();
+            CLIENT.cloudapi.listNetworks(opts, function (err, nets) {
+                if (h.ifErr(t, err))
+                    return t.end();
 
-            t.ok(Array.isArray(nets), 'networks');
+                t.ok(Array.isArray(nets), 'networks');
 
-            NET = nets[0];
+                NET = nets[0];
 
-            t.end();
+                t.end();
+            });
         });
     });
 
diff --git a/test/integration/api-packages.test.js b/test/integration/api-packages.test.js
index 053711e..181b2e9 100644
--- a/test/integration/api-packages.test.js
+++ b/test/integration/api-packages.test.js
@@ -31,17 +31,19 @@ var PKG;
 test('TritonApi packages', function (tt) {
     tt.test(' setup', function (t) {
         CLIENT = h.createClient();
-        t.ok(CLIENT, 'client');
 
-        CLIENT.cloudapi.listPackages(function (err, pkgs) {
-            if (h.ifErr(t, err))
-                return t.end();
+        CLIENT.init(function (initErr) {
+            t.error(initErr);
+            CLIENT.cloudapi.listPackages(function (err, pkgs) {
+                if (h.ifErr(t, err))
+                    return t.end();
 
-            t.ok(Array.isArray(pkgs), 'packages');
+                t.ok(Array.isArray(pkgs), 'packages');
 
-            PKG = pkgs[0];
+                PKG = pkgs[0];
 
-            t.end();
+                t.end();
+            });
         });
     });
 
