From bc49a41e1111b6008e7b17a19e1b47909f19b00a Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Fri, 10 May 2019 16:34:03 -0600
Subject: [PATCH] MANTA-4265 Update node-boray to use node-fast 2.7.0

---
 lib/client.js          | 6 +++++-
 lib/fast_connection.js | 6 ++++--
 package.json           | 2 +-
 3 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/lib/client.js b/lib/client.js
index df2e37f..f8b5d81 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -19,6 +19,7 @@ var util = require('util');
 
 var assert = require('assert-plus');
 var cueball = require('cueball');
+var fast = require('fast');
 var jsprim = require('jsprim');
 var libuuid = require('libuuid');
 var VError = require('verror');
@@ -85,6 +86,7 @@ function BorayClient(options) {
     assert.optionalBool(options.requireIndexes, 'options.requireIndexes');
     assert.optionalBool(options.requireOnlineReindexing,
         'options.requireOnlineReindexing');
+    assert.optionalNumber(options.crc_mode, 'options.crc_mode');
 
     coptions = parseBorayParameters(options);
     cueballOptions = coptions.cueballOptions;
@@ -97,6 +99,7 @@ function BorayClient(options) {
     this.requireIndexes = options.requireIndexes ? true : false;
     this.requireOnlineReindexing =
         options.requireOnlineReindexing ? true : false;
+    this.crc_mode = options.crc_mode || fast.FAST_CHECKSUM_V1;
 
     /* Helper objects. */
     this.log = options.log.child({
@@ -337,7 +340,8 @@ BorayClient.prototype.createFastConnection =
         'log': this.log.child({
             'component': 'FastClient',
             'backendName': backend.name
-        })
+        }),
+        'crc_mode': this.crc_mode
     }));
 };
 
diff --git a/lib/fast_connection.js b/lib/fast_connection.js
index 411812c..7cdef12 100644
--- a/lib/fast_connection.js
+++ b/lib/fast_connection.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -52,6 +52,7 @@ function FastConnection(args) {
     assert.number(args.nRecentRequests, 'args.nRecentRequests');
     assert.number(args.tcpKeepAliveInitialDelay,
         'args.tcpKeepAliveInitialDelay');
+    assert.number(args.crc_mode, 'args.crc_mode');
 
     events.EventEmitter.call(this);
 
@@ -67,7 +68,8 @@ function FastConnection(args) {
         'collector': args.collector, /* Optional: artedi metrics collector */
         'log': args.log,
         'nRecentRequests': args.nRecentRequests,
-        'transport': this.fc_sock
+        'transport': this.fc_sock,
+        'crc_mode': args.crc_mode
     });
 
     /*
diff --git a/package.json b/package.json
index 720c75d..6ebd91b 100644
--- a/package.json
+++ b/package.json
@@ -20,7 +20,7 @@
         "cmdutil": "^1.1.0",
         "cueball": "^2.3.0",
         "extsprintf": "^1.3.0",
-        "fast": "2.6.0",
+        "fast": "2.7.0",
         "libuuid": "0.2.1",
         "jsprim": "^1.3.0",
         "posix-getopt": "^1.0.0",
-- 
2.21.0

