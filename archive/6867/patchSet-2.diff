From 42599e599be0651bad07029b0b49aff0efafcfbf Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Wed, 11 Sep 2019 10:30:59 +0000
Subject: [PATCH] OS-7979 introduce /etc/versions/build

---
 tools/build_live | 16 +++-------------
 1 file changed, 3 insertions(+), 13 deletions(-)

diff --git a/tools/build_live b/tools/build_live
index 927a6ec5..b280ee71 100755
--- a/tools/build_live
+++ b/tools/build_live
@@ -268,7 +268,7 @@ function bi_create_ufs
 function bi_remake_buildversion
 {
 	local artefact="$bi_out_dir/gitstatus.json"
-	local bvfile="$bi_wsroot/projects/illumos/usr/src/buildversion"
+	local bvfile="$bi_mnt_root/etc/versions/build"
 
 	#
 	# We include the JSON-only version of the release information as a
@@ -278,19 +278,9 @@ function bi_remake_buildversion
 		fail "could not generate gitstatus file"
 	fi
 
-	if cmp "$artefact" "$bvfile" >/dev/null 2>&1; then
-		return
+	if ! cmp "$artefact" "$bvfile" >/dev/null 2>&1; then
+		cp "$artefact" "$bvfile"
 	fi
-
-	bi_emit_start 'Updating buildversion kernel module'
-
-	cp "$artefact" "$bvfile"
-
-	(cd $bi_wsroot/projects/illumos && ksh93 \
-	    usr/src/tools/scripts/bldenv.sh illumos.sh \
-	    'cd $CODEMGR_WS/usr/src/uts/intel/buildversion && dmake install')
-
-	bi_emit_done
 }
 
 function bi_copy_files
-- 
2.21.0

