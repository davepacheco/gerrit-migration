From 9bb2ce93062b8405d7da965898188de1769ff7d5 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 10 Oct 2016 16:57:00 +0000
Subject: [PATCH] OS-5683 'db2 create db' hangs in LX branded zone

---
 usr/src/lib/brand/lx/lx_brand/common/aio.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/usr/src/lib/brand/lx/lx_brand/common/aio.c b/usr/src/lib/brand/lx/lx_brand/common/aio.c
index 81dea317f4..5760b9806b 100644
--- a/usr/src/lib/brand/lx/lx_brand/common/aio.c
+++ b/usr/src/lib/brand/lx/lx_brand/common/aio.c
@@ -277,13 +277,21 @@ lx_io_submit(lx_aio_context_t cid, long nr, uintptr_t **bpp)
 	return (processed);
 }
 
+/*
+ * For Linux, the io_getevents() min_nr argument specifies *at least* that
+ * number of events, but for illumos the port_getn() nget argument specifies
+ * the *desired* numbers of events. Some applications pass 0 for min_nr. This
+ * will cause port_getn to short-circuit and return immediately, so we use a
+ * value of 1 in this case. The port_getn() function can still return up to
+ * max events when nget == 1.
+ */
 long
 lx_io_getevents(lx_aio_context_t cid, long min_nr, long nr,
     lx_io_event_t *events, struct timespec *timeout)
 {
 	port_event_t *list;
 	lx_io_event_t *out;
-	unsigned int nget = min_nr;
+	unsigned int nget = (min_nr == 0 && timeout != NULL ? 1 : min_nr);
 	int rval, i, err;
 	uint32_t max = nr;
 	lx_aio_ctxt_t *ctx = (lx_aio_ctxt_t *)cid;
-- 
2.21.0

