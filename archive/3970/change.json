{"project":"joyent/manta-muskie","branch":"master","topic":"MANTA-3672","id":"I1ff174ee7d4b340ea5835ab4ccdef5c3299f6e5f","number":"3970","subject":"MANTA-3672 want support for cross-account RBAC role membership Reviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e Reviewed by: Brittany Wald \u003cbrittany.wald@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/3970","commitMessage":"MANTA-3672 want support for cross-account RBAC role membership\nReviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\nReviewed by: Brittany Wald \u003cbrittany.wald@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1526598306,"lastUpdated":1528160453,"open":false,"status":"MERGED","comments":[{"timestamp":1526598306,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1526598325,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Topic set to MANTA-3672"},{"timestamp":1526598337,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526605906,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1526605937,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527034221,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1527034251,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1527034315,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1527034343,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1527034440,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1527034470,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527196459,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1527631421,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 6."},{"timestamp":1527631452,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527631573,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1527638932,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1527728045,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 7."},{"timestamp":1527728053,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1527728077,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528154603,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1528158977,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7: Integration-Approval+1"},{"timestamp":1528159010,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1528159041,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"},{"timestamp":1528159122,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 9: Commit message was updated."},{"timestamp":1528160453,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"9","revision":"21ac10f134eda4d38f8a0364f3aad837be8080e3","parents":["08239fe9baac6973823444f90e163f101e5fac53"],"ref":"refs/changes/70/3970/9","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1528159122,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527728077,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528154603,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528158977,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1528160453,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":36,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":97,"deletions":-6},{"file":"test/acsetup.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":57,"deletions":-1},{"file":"test/mpu/helper.js","type":"MODIFIED","insertions":2,"deletions":-44}],"sizeInsertions":284,"sizeDeletions":-56},"patchSets":[{"number":"1","revision":"aac066b2f155f1a02f606d80993deac940038258","parents":["001ad25d174ab11ba2244b5e8a6cb81eacd4245c"],"ref":"refs/changes/70/3970/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1526598306,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526598337,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-3},{"number":"2","revision":"17f10a7f87d875dbf07a087ebf050ce3f43461fb","parents":["afd0a3aae1c910298cbf05ef67035216884da92e"],"ref":"refs/changes/70/3970/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1526605906,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526605937,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-3},{"number":"3","revision":"b5044d50f8df2c7e1b69edbb1113a20c38ccb7d9","parents":["afd0a3aae1c910298cbf05ef67035216884da92e"],"ref":"refs/changes/70/3970/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1527034221,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1527034251,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/ac.test.js","line":375,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: roles"},{"file":"test/ac.test.js","line":443,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer info hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":97,"deletions":-5},{"file":"test/acsetup.js","type":"MODIFIED","insertions":81,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":52,"deletions":0}],"sizeInsertions":242,"sizeDeletions":-8},{"number":"4","revision":"9f0fda2b34b1311b30cf1b7ca01aa640a20c56aa","parents":["afd0a3aae1c910298cbf05ef67035216884da92e"],"ref":"refs/changes/70/3970/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1527034315,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1527034343,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/ac.test.js","line":442,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer info hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":96,"deletions":-5},{"file":"test/acsetup.js","type":"MODIFIED","insertions":81,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":52,"deletions":0}],"sizeInsertions":241,"sizeDeletions":-8},{"number":"5","revision":"06c4efdbd236ee9adf05755c9a08fda79b0b4635","parents":["afd0a3aae1c910298cbf05ef67035216884da92e"],"ref":"refs/changes/70/3970/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1527034440,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527034470,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/auth.js","line":820,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is it worth adding a comment here explaining why some roles are filtered out here?\n\nIn addition or as an alternate idea: it might be worth adding a bit more high-level explanation about this change to the header comment of this function."},{"file":"lib/auth.js","line":820,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"},{"file":"test/acsetup.js","line":127,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Do we need a default if that env variable isn\u0027t set? (It looks like some other tests use \u0027admin\u0027 by default.)"},{"file":"test/acsetup.js","line":127,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"},{"file":"test/acsetup.js","line":175,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m assuming this is here to allow mahi sufficient time to update the policies before continuing to add roles. In that case, what happens if that isn\u0027t sufficient time?"},{"file":"test/acsetup.js","line":175,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It\u0027s actually about the subusers, not the policies, but yeah. Insufficient time \u003d acsetup will fail. I\u0027ve added an extra 5 sec and added a comment here."},{"file":"test/helper.js","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I like the idea of having the code creating operator clients for the tester in only this file, as the MPU tests also create an operator client in test/mpu/helper.js.\n\nHow about we modify the function here (https://github.com/joyent/manta-muskie/blob/afd0a3aae1c910298cbf05ef67035216884da92e/test/mpu/helper.js#L207-L236) in test/mpu/helper.js to call into createOperatorClient() in this file? (It might also be more descriptive to call that function createOperatorMantaClient to distinguish it from the SDC client.)"},{"file":"test/helper.js","line":50,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I might leave the name as it is, to match the createUserClient() and others (the convention in the rest of the file is that without \"SDC\" in the name it\u0027s always a manta client)? Or should I change the others as well?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":96,"deletions":-5},{"file":"test/acsetup.js","type":"MODIFIED","insertions":81,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":52,"deletions":0}],"sizeInsertions":241,"sizeDeletions":-8},{"number":"6","revision":"4e64d962d820bd6201d01b978150241b5ac7daa1","parents":["afd0a3aae1c910298cbf05ef67035216884da92e"],"ref":"refs/changes/70/3970/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1527631421,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527631452,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/auth.js","line":8,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"2018 - same comment on all the files"},{"file":"lib/auth.js","line":8,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"},{"file":"lib/auth.js","line":1006,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"So if it does, it means the user is running an old image?"},{"file":"lib/auth.js","line":1006,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"More than that: it means someone didn\u0027t update their deps (e.g. a development zone where someone runs muskie tests, and they did git pull but not npm update or something like that)\n\nThere\u0027s no way to get an image built by jenkins that would have this error occur (since this patch is the same one that updates the dep on node-mahi)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":35,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":96,"deletions":-5},{"file":"test/acsetup.js","type":"MODIFIED","insertions":90,"deletions":0},{"file":"test/helper.js","type":"MODIFIED","insertions":56,"deletions":0},{"file":"test/mpu/helper.js","type":"MODIFIED","insertions":1,"deletions":-43}],"sizeInsertions":279,"sizeDeletions":-51},{"number":"7","revision":"1ff174ee7d4b340ea5835ab4ccdef5c3299f6e5f","parents":["afd0a3aae1c910298cbf05ef67035216884da92e"],"ref":"refs/changes/70/3970/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1527728045,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527728077,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528154603,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528158977,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":36,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":97,"deletions":-6},{"file":"test/acsetup.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":57,"deletions":-1},{"file":"test/mpu/helper.js","type":"MODIFIED","insertions":2,"deletions":-44}],"sizeInsertions":284,"sizeDeletions":-56},{"number":"8","revision":"02ff4a0acb1019aad677a5d0029567490725b715","parents":["08239fe9baac6973823444f90e163f101e5fac53"],"ref":"refs/changes/70/3970/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1528159010,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527728077,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528154603,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528158977,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":36,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":97,"deletions":-6},{"file":"test/acsetup.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":57,"deletions":-1},{"file":"test/mpu/helper.js","type":"MODIFIED","insertions":2,"deletions":-44}],"sizeInsertions":284,"sizeDeletions":-56},{"number":"9","revision":"21ac10f134eda4d38f8a0364f3aad837be8080e3","parents":["08239fe9baac6973823444f90e163f101e5fac53"],"ref":"refs/changes/70/3970/9","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1528159122,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1528160453,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527728077,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528154603,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528158977,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":36,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":97,"deletions":-6},{"file":"test/acsetup.js","type":"MODIFIED","insertions":91,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":57,"deletions":-1},{"file":"test/mpu/helper.js","type":"MODIFIED","insertions":2,"deletions":-44}],"sizeInsertions":284,"sizeDeletions":-56}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}]}