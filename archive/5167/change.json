{"project":"joyent/smartos-live","branch":"master","id":"If20da5297e9f49619eb7b5e01b6c4767ddf72e81","number":"5167","subject":"OS-7413 metadata daemon crashes on bhyve or instance deletion Reviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e Approved by: Dave Eddy \u003cdave.eddy@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/5167","commitMessage":"OS-7413 metadata daemon crashes on bhyve or instance deletion\nReviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\nApproved by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\n","createdOn":1543603174,"lastUpdated":1543866198,"open":false,"status":"MERGED","comments":[{"timestamp":1543603174,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1543603224,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543613611,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)\n\none nit, up to you to implement it since either way the process will crash... otherwise the code looks good!"},{"timestamp":1543617068,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1543617149,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543617734,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\nRepeated testing already noted in the ticket with the same results."},{"timestamp":1543860419,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\nLGTM, ty."},{"timestamp":1543866139,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1543866187,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1543866190,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1543866198,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"4","revision":"d85cced64ee933f884ab9236c76da0dcb46e222e","parents":["2255127725b4cfc2ce39c52288456a0792eb4e90"],"ref":"refs/changes/67/5167/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543866187,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543617149,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"SUBM","value":"1","grantedOn":1543866198,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":7,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"9326b48400066243d911d348516bb9eee5ecee14","parents":["b61f428dbd31b04fc7d5d8d6396cf375d2a17a5d"],"ref":"refs/changes/67/5167/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543603174,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543603224,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543613611,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":648,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: based on the notes in your ticket, is this the line that causes the crash? If so, adding explicit asserts here may be useful to make any future debugging easier.  I\u0027m thinking something like.\n\n assert.object(self.zoneConnections[zopts.zone], ...);\n\nabove this line."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":5,"deletions":-2}],"sizeInsertions":5,"sizeDeletions":-2},{"number":"2","revision":"f20da5297e9f49619eb7b5e01b6c4767ddf72e81","parents":["b61f428dbd31b04fc7d5d8d6396cf375d2a17a5d"],"ref":"refs/changes/67/5167/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543617068,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543617149,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":7,"sizeDeletions":-2},{"number":"3","revision":"b42787a277c5d873abe17d4101cb287257196f6e","parents":["2255127725b4cfc2ce39c52288456a0792eb4e90"],"ref":"refs/changes/67/5167/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543866139,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543617149,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":7,"sizeDeletions":-2},{"number":"4","revision":"d85cced64ee933f884ab9236c76da0dcb46e222e","parents":["2255127725b4cfc2ce39c52288456a0792eb4e90"],"ref":"refs/changes/67/5167/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543866187,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543617149,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543860419,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"SUBM","value":"1","grantedOn":1543866198,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":7,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}