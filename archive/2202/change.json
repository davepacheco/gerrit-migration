{"project":"joyent/manta-scripts","branch":"master","topic":"MANTA-3109","id":"I4b86dd132d68cb177f066a83d90b8fdc9ac2cde9","number":"2202","subject":"MANTA-3109 manta log uploader retries multiple times in parallel Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"url":"https://cr.joyent.us/2202","commitMessage":"MANTA-3109 manta log uploader retries multiple times in parallel\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1499723719,"lastUpdated":1500930374,"open":false,"status":"MERGED","comments":[{"timestamp":1499723719,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 1."},{"timestamp":1499723721,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit d8da3d2731696803a85f16daa95e07aa9758babd\n    \n    MANTA-3109 manta log uploader retries multiple times in parallel\n    * Create a lockfile when the backup script runs so multiple\n      parallel runs will not happen"},{"timestamp":1499987614,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(8 comments)"},{"timestamp":1500054272,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1500064117,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 2."},{"timestamp":1500064118,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit fa276c3d8483a3072c3763a9d5b1c853e70741e0\n    \n    MANTA-3109 manta log uploader retries multiple times in parallel\n    * Create a lockfile when the backup script runs so multiple\n      parallel runs will not happen"},{"timestamp":1500064225,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\n(8 comments)\n\nPatch set 2 pushed with all the changes you asked for.  I went ahead and made other untouched lines consistent with quoted arguments and full path names for system functions (rm/ln/kill)"},{"timestamp":1500069505,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(1 comment)\n\nOther than the Copyright year update, I think this is basically ready to go!  It would be great to outline testing notes in the JIRA ticket -- e.g., see the testing notes in a ticket like MANTA-3295."},{"timestamp":1500069630,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2:\n\nI wondered if we captured the testing notes anywhere.  I\u0027ll update the copyright year and write up the way I tested this.  Thanks."},{"timestamp":1500069734,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 3."},{"timestamp":1500069735,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 24708c8d3568a40328de38d58dc00784f8915b41\n    \n    MANTA-3109 manta log uploader retries multiple times in parallel\n    * Create a lockfile when the backup script runs so multiple\n      parallel runs will not happen"},{"timestamp":1500070819,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2:\n\n(1 comment)\n\nAdded testing notes to https://devhub.joyent.com/jira/browse/MANTA-3109 and updated copyright year."},{"timestamp":1500915172,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nThank you for the comprehensive testing.  I approve!"},{"timestamp":1500915917,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1500915948,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jared Morrow"},{"timestamp":1500930374,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Topic set to MANTA-3109"}],"currentPatchSet":{"number":"4","revision":"4b86dd132d68cb177f066a83d90b8fdc9ac2cde9","parents":["99c31b5ecc12968f36f72790050e230e0619f2f8"],"ref":"refs/changes/02/2202/4","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1500915917,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500915172,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500915172,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1500915948,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"backup.sh","type":"MODIFIED","insertions":68,"deletions":-2}],"sizeInsertions":68,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"5bd09d4ba3915661d3d9d053079386f1dad9a722","parents":["99c31b5ecc12968f36f72790050e230e0619f2f8"],"ref":"refs/changes/02/2202/1","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1499723719,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","comments":[{"file":"backup.sh","line":74,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Move brace up for consistency with the rest of the file."},{"file":"backup.sh","line":74,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":81,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As a general matter of shell style I think we have avoided using ||/\u0026\u0026 plus braces like this.  Instead, I\u0027d recommend...\n\nif ! echo \"$$\" \u003e \"$TEMPFILE\" 2\u003e/dev/null; then\n    echo \"...\" \u003e\u00262\n    return 1\nfi\n\nThis applies to a number of condition blocks below, too, but I\u0027m only going to comment up here."},{"file":"backup.sh","line":81,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":82,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Generally we prefer $() instead of ``.  Also, error messages like this ought to go to stderr; i.e., \u003e\u00262"},{"file":"backup.sh","line":82,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Could we have the error message indicate only that we could not write to that directory (instead of assuming it was a permission issue)?  We\u0027ve seen similar stuff fail when the filesystem was out of space, for example, and incorrect error messages can send people down the wrong path for quite a while."},{"file":"backup.sh","line":82,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":82,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":86,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would probably make explicit the notion that ln(1) will fail if the destination exists; e.g.\n\n    #\n    # Use ln(1) to move the temporary file into place because,\n    # unlike mv(1), it will fail if the destination existed\n    # already.\n    #\n\nI would also explicitly use the system version of \"ln\", \"rm\", \"kill\", etc, by fully qualifying the path; e.g., \"/usr/bin/ln\"."},{"file":"backup.sh","line":86,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":93,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"For this I would instead use the bash [[ builtin; e.g.\n\n    if [[ $STALE_PID -gt 0 ]]; then\n        ..."},{"file":"backup.sh","line":93,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":108,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It\u0027s a shame that this part is still pretty racy.  I guess we\u0027d have to go up to using fcntl(2)/flock(2) locks, probably via C or at least some tool, to avoid that problem."},{"file":"backup.sh","line":161,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Please quote arguments to commands; i.e.,\n\n    rm -f \"$BACKUP_LOCKFILE\"\n\nThe only exception to this is cases where the bash manual makes it explicit that word expansion doesn\u0027t occur (e.g., in the [[ builtin)."},{"file":"backup.sh","line":161,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"backup.sh","line":178,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Should this be happening in a \"trap\" cleanup function?  I think you could use the EXIT trap, to make sure that we always remove the lock file even if the program exits early or in error."},{"file":"backup.sh","line":178,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"backup.sh","type":"MODIFIED","insertions":60,"deletions":0}],"sizeInsertions":60,"sizeDeletions":0},{"number":"2","revision":"8684f9dae99709ba704ed8e4d8a63374101682ee","parents":["99c31b5ecc12968f36f72790050e230e0619f2f8"],"ref":"refs/changes/02/2202/2","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1500064117,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","comments":[{"file":"backup.sh","line":9,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Update to 2017!"},{"file":"backup.sh","line":9,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"backup.sh","type":"MODIFIED","insertions":67,"deletions":-1}],"sizeInsertions":67,"sizeDeletions":-1},{"number":"3","revision":"db4f692f3e372c8193cebb857f76fd0f28fbc921","parents":["99c31b5ecc12968f36f72790050e230e0619f2f8"],"ref":"refs/changes/02/2202/3","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1500069734,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500915172,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500915172,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"backup.sh","type":"MODIFIED","insertions":68,"deletions":-2}],"sizeInsertions":68,"sizeDeletions":-2},{"number":"4","revision":"4b86dd132d68cb177f066a83d90b8fdc9ac2cde9","parents":["99c31b5ecc12968f36f72790050e230e0619f2f8"],"ref":"refs/changes/02/2202/4","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1500915917,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500915172,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500915172,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1500915948,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"backup.sh","type":"MODIFIED","insertions":68,"deletions":-2}],"sizeInsertions":68,"sizeDeletions":-2}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}]}