From 38255d40891328ad912af6f58469797f8e34567a Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 5 Dec 2016 21:19:10 +0000
Subject: [PATCH] OS-5830 improve hyprlofs error checking

---
 .../uts/common/fs/hyprlofs/hyprlofs_vnops.c   | 23 ++++++++++---------
 1 file changed, 12 insertions(+), 11 deletions(-)

diff --git a/usr/src/uts/common/fs/hyprlofs/hyprlofs_vnops.c b/usr/src/uts/common/fs/hyprlofs/hyprlofs_vnops.c
index a2064dfa1f..7f3133020b 100644
--- a/usr/src/uts/common/fs/hyprlofs/hyprlofs_vnops.c
+++ b/usr/src/uts/common/fs/hyprlofs/hyprlofs_vnops.c
@@ -20,7 +20,7 @@
  */
 
 /*
- * Copyright 2015 Joyent, Inc.  All rights reserved.
+ * Copyright 2016 Joyent, Inc.
  */
 
 #include <sys/types.h>
@@ -134,8 +134,8 @@ static int
 hyprlofs_ioctl(vnode_t *vp, int cmd, intptr_t data, int flag,
     cred_t *cr, int *rvalp, caller_context_t *ct)
 {
-	int len, cnt, error;
-	int i;
+	uint_t len, cnt;
+	int i, error;
 	model_t model;
 	char path[MAXPATHLEN];
 	char nm[MAXPATHLEN];
@@ -172,7 +172,7 @@ hyprlofs_ioctl(vnode_t *vp, int cmd, intptr_t data, int flag,
 
 			for (i = 0; i < cnt; i++) {
 				if (e[i].hle_nlen == 0 ||
-				    e[i].hle_nlen > MAXPATHLEN)
+				    e[i].hle_nlen >= sizeof (nm))
 					return (EINVAL);
 
 				if (copyin(e[i].hle_name, nm, e[i].hle_nlen)
@@ -184,7 +184,7 @@ hyprlofs_ioctl(vnode_t *vp, int cmd, intptr_t data, int flag,
 
 				if (cmd == HYPRLOFS_ADD_ENTRIES) {
 					if (e[i].hle_plen == 0 ||
-					    e[i].hle_plen > MAXPATHLEN)
+					    e[i].hle_plen >= sizeof (path))
 						return (EINVAL);
 
 					if (copyin(e[i].hle_path, path,
@@ -232,7 +232,7 @@ hyprlofs_ioctl(vnode_t *vp, int cmd, intptr_t data, int flag,
 
 			for (i = 0; i < cnt; i++) {
 				if (e32[i].hle_nlen == 0 ||
-				    e32[i].hle_nlen > MAXPATHLEN)
+				    e32[i].hle_nlen >= sizeof (nm))
 					return (EINVAL);
 
 				if (copyin((void *)(unsigned long)
@@ -245,7 +245,7 @@ hyprlofs_ioctl(vnode_t *vp, int cmd, intptr_t data, int flag,
 
 				if (cmd == HYPRLOFS_ADD_ENTRIES) {
 					if (e32[i].hle_plen == 0 ||
-					    e32[i].hle_plen > MAXPATHLEN)
+					    e32[i].hle_plen >= sizeof (path))
 						return (EINVAL);
 
 					if (copyin((void *)(unsigned long)
@@ -781,13 +781,13 @@ done:
  */
 static int
 hyprlofs_get_all_entries(vnode_t *dvp, hyprlofs_curr_entry_t *hcp,
-    char *prefix, int *pcnt, int n_max,
+    char *prefix, uint_t *pcnt, uint_t n_max,
     cred_t *cr, caller_context_t *ct, int flags)
 {
 	int error = 0;
 	int too_big = 0;
-	int cnt;
-	int len;
+	uint_t cnt;
+	uint_t len;
 	hlnode_t *hp = (hlnode_t *)VTOHLN(dvp);
 	hldirent_t *hdp;
 	char *path;
@@ -907,7 +907,8 @@ static int
 hyprlofs_get_all(vnode_t *dvp, intptr_t data, cred_t *cr, caller_context_t *ct,
     int flags)
 {
-	int limit, cnt, error;
+	uint_t limit, cnt;
+	int error;
 	model_t model;
 	hyprlofs_curr_entry_t *e;
 
-- 
2.21.0

