{"project":"joyent/illumos-joyent","branch":"master","id":"I1932f584055941bdb546ada1524aa809fe6c9041","number":"3560","subject":"OS-6701 mac_fix_cksum breaks ethernet header Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Approved by: Ryan Zezeski \u003crpz@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/3560","commitMessage":"OS-6701 mac_fix_cksum breaks ethernet header\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nApproved by: Ryan Zezeski \u003crpz@joyent.com\u003e\n","createdOn":1520489299,"lastUpdated":1521489518,"open":false,"status":"MERGED","comments":[{"timestamp":1520489299,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1520513019,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\nI\u0027m not very knowledgeable about this part of the code, but your changes look fine to me."},{"timestamp":1520529553,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1520534229,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review-1\n\nlooping on this again"},{"timestamp":1520541362,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1520541370,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: -Code-Review"},{"timestamp":1520541382,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: -Code-Review"},{"timestamp":1520541521,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1520541579,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1520542905,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1520543254,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1520543431,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1520544665,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1\n\nThanks for the explanation. With the same caveat as before that I\u0027m not super familiar with all of this code, it looks fine to me."},{"timestamp":1521242198,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1521305112,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1521473946,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1521473952,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4: Code-Review+1 -Integration-Approval"},{"timestamp":1521474054,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1521488496,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nTest notes in the ticket."},{"timestamp":1521488547,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1521489362,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1521489455,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1521489518,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"1932f584055941bdb546ada1524aa809fe6c9041","parents":["db3c1a65483dd60a62c0f8389df50979f1b0bf22"],"ref":"refs/changes/60/3560/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521489455,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521305112,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521473952,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521474054,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521489362,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1521489518,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":63,"deletions":-11}],"sizeInsertions":63,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"d758b17c531dafb4e54076b5316421ce3874dcfa","parents":["5367c10ccf59c25a48d868138bd4e511e70b0dcf"],"ref":"refs/changes/60/3560/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1520489299,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520513019,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/io/mac/mac_util.c","line":311,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Shouldn\u0027t we perform this check outside of \u0027old_mp !\u003d NULL\u0027? I\u0027m thinking of the following scenario:\n\n* Packet consists of 2 mblks.\n* We lop off the header.\n* Remaining mblk has NULL b_cont so we don\u0027t pull up.\n* Since old_mp is NULL we don\u0027t reattach the header.\n\nThat said, I think we also need to check inside \u0027old_mp !\u003d NULL\u0027 so account for the fact that skipped_hdr is already in the chain and we don\u0027t need to modify prev/new_chain."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":311,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, that\u0027s completely separate from the PARTIALCKSUM case.  Addressed in the updated."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":324,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Shouldn\u0027t we do this when \u0027skipped_hdr !\u003d NULL\u0027 as well? I\u0027m thinking of the case where we have a packet consisting of 3 or more mblks. We skip the header, do a pull up of the last 2 mblks, reattach the header, and then free old_mp without NULLing the next ptr."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":324,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, good catch.  Fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":40,"deletions":-11}],"sizeInsertions":40,"sizeDeletions":-11},{"number":"2","revision":"8fe4db4d4a14e5da68ba576dbe2a27a3e55079ce","parents":["5367c10ccf59c25a48d868138bd4e511e70b0dcf"],"ref":"refs/changes/60/3560/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1520541362,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":58,"deletions":-11}],"sizeInsertions":58,"sizeDeletions":-11},{"number":"3","revision":"c0bc50df8a5e95d61b5e50febeca16a11fe712d7","parents":["5367c10ccf59c25a48d868138bd4e511e70b0dcf"],"ref":"refs/changes/60/3560/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1520541521,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520544665,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/io/mac/mac_util.c","line":350,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027m having a hard time seeing a flow where skipped_hdr is not NULL here but where we\u0027ve also set b_cont to be mp. Am I just being dense?"},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":350,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we skipped the header, it\u0027s b_cont would be the next piece of data in the chain.  It would have been set before this function was executed. (And if it\u0027s not, we skip the whole packet, see L163)"},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":350,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Say the packet consists of 2 mblks: first is header, second is data. We lop of the header mblk and stash it in skipped_hdr; and then set mp to mp-\u003eb_cont (which is the same as skipped_hdr-\u003eb_cont at this point). Now we have one mblk holding all data; so we don\u0027t do msgpullup() and old_mp is NULL. Then we reach this if-block; and nothing has modified mp or skipped_hdr. So skipped_hdr contains the original mp and it\u0027s b_cont should still point to the current mp.\n\nDoes that make sense? (This function is way too dense if you ask me but I\u0027m guessing we don\u0027t want to go rewriting this right now)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":58,"deletions":-11}],"sizeInsertions":58,"sizeDeletions":-11},{"number":"4","revision":"2b164b23e78f1195332b55f90e1fc30f09d7d3e2","parents":["3c32c786cc014ec9aab1c7cb8f001b57359d506a"],"ref":"refs/changes/60/3560/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521242198,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521305112,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521474054,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521473952,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":63,"deletions":-11}],"sizeInsertions":63,"sizeDeletions":-11},{"number":"5","revision":"57ff3318a8c96b1e45655a7034e028104df6cd2a","parents":["db3c1a65483dd60a62c0f8389df50979f1b0bf22"],"ref":"refs/changes/60/3560/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521488547,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521305112,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521474054,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521489362,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521473952,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":63,"deletions":-11}],"sizeInsertions":63,"sizeDeletions":-11},{"number":"6","revision":"1932f584055941bdb546ada1524aa809fe6c9041","parents":["db3c1a65483dd60a62c0f8389df50979f1b0bf22"],"ref":"refs/changes/60/3560/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521489455,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521305112,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1521489518,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521474054,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521489362,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521473952,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":63,"deletions":-11}],"sizeInsertions":63,"sizeDeletions":-11}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}