From b47d878e9c5c156c2917bb1399ca6c5b19012ffb Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 24 Jun 2019 17:07:25 -0700
Subject: [PATCH] TRITON-1720 migration needs a rollback feature

---
 bin/sdc-migrate | 34 ++++++++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/bin/sdc-migrate b/bin/sdc-migrate
index 08e6b04..ca5870f 100755
--- a/bin/sdc-migrate
+++ b/bin/sdc-migrate
@@ -137,6 +137,7 @@ Sub-commands:
     pause VM_UUID                - pause a migration operation
     abort VM_UUID                - abort the migration attempt
     finalize VM_UUID             - cleanup, removes the original source instance
+    rollback VM_UUID             - revert back to the original source instance
     watch VM_UUID                - watch an ongoing migration operation
 
 EOF
@@ -577,6 +578,35 @@ EOF
 }
 
 
+function migration_rollback() {
+    local job_uuid
+    local url
+    local vm_uuid=$1
+
+   # Handle the help argument.
+    if [[ $vm_uuid == "-h" || $vm_uuid == "--help" ]]; then
+        cat <<EOF
+Usage:
+        $0 rollback vm_uuid
+
+Similar to abort. Reverts back to the original migration instance, deletes the
+target instance and removes the migration record. Any filesystem changes made
+in the target instance since the migration switch will be lost.
+EOF
+        return 1;
+    fi
+
+    [[ -z ${vm_uuid} ]] && fatal "rollback: no instance uuid provided"
+
+    url="/vms/${vm_uuid}?action=migrate&migration_action=rollback"
+
+    job_uuid=$(sdc-vmapi "$url" -X POST | $JSON -H job_uuid message)
+
+    check_job_uuid "${job_uuid}"
+    migration_watch "${vm_uuid}"
+}
+
+
 function migration_watch() {
     local vm_uuid=$1
     local need_newline=
@@ -743,6 +773,10 @@ case ${action} in
         migration_pause "$@"
         exit $?
         ;;
+    rollback)
+        migration_rollback "$@"
+        exit $?
+        ;;
     switch)
         migration_switch "$@"
         exit $?
-- 
2.21.0

