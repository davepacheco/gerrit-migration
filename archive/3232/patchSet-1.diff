From dc02e73330344fcdf8fdea71c65b884372fdd3c2 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Thu, 18 Jan 2018 09:07:09 -0700
Subject: [PATCH] MANTA-3417 long-running query probe does not work with
 PostgreSQL 9.6.3

---
 alarm_metadata/probe_templates/postgres.yaml | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/alarm_metadata/probe_templates/postgres.yaml b/alarm_metadata/probe_templates/postgres.yaml
index 323e5f3..b9f97fa 100644
--- a/alarm_metadata/probe_templates/postgres.yaml
+++ b/alarm_metadata/probe_templates/postgres.yaml
@@ -243,7 +243,9 @@
         -
             type: cmd
             config:
-                cmd: "PATH=/opt/postgresql/current/bin:/opt/local/bin:$PATH psql -U postgres -c \"SELECT pid,usename,client_addr,client_port,waiting,state,NOW() - query_start AS elapsed, query FROM pg_stat_activity WHERE state != 'idle' AND query NOT LIKE 'autovacuum: %' AND NOW() - query_start > interval '120 seconds'\" | tail +3"
+                cmd: "if [ $(psql -V | cut -f 3 -d ' ' | cut -f 1,2 -d '.') = '9.6' ]; then /opt/postgresql/current/bin/psql -U postgres -c \"SELECT pid,usename,client_addr,client_port,wait_event,wait_event_type,state,NOW() - query_start AS elapsed, query FROM pg_stat_activity WHERE state != 'idle' AND query NOT LIKE 'autovacuum: %' AND NOW() - query_start > interval '120 seconds'\" | tail +3; else /opt/postgresql/current/bin/psql -U postgres -c \"SELECT pid,usename,client_addr,client_port,waiting,state,NOW() - query_start AS elapsed, query FROM pg_stat_activity WHERE state != 'idle' AND query NOT LIKE 'autovacuum: %' AND NOW() - query_start > interval '120 seconds'\" | tail +3; fi"
+                env:
+                  PATH: "/opt/postgresql/current/bin:/opt/local/bin:$PATH"
                 interval: 60
                 timeout: 30
                 threshold: 2
-- 
2.21.0

