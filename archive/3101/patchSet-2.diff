From 8b2e3297851573dcb23e0d29badf2dc05efcd17a Mon Sep 17 00:00:00 2001
From: Sam Gwydir <sam.gwydir@joyent.com>
Date: Tue, 12 Dec 2017 21:21:08 +0000
Subject: [PATCH] OS-5927 postmortem DTrace frequently broken under vmware

---
 usr/src/lib/libdtrace/common/dt_consume.c | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/usr/src/lib/libdtrace/common/dt_consume.c b/usr/src/lib/libdtrace/common/dt_consume.c
index 7f8c673dbe..738dcc49dc 100644
--- a/usr/src/lib/libdtrace/common/dt_consume.c
+++ b/usr/src/lib/libdtrace/common/dt_consume.c
@@ -3012,11 +3012,7 @@ dtrace_consume(dtrace_hdl_t *dtp, FILE *fp,
 			if (buf == NULL)
 				break;
 
-			timestamp = dt_buf_oldest(buf, dtp);
-			assert(timestamp >= dtp->dt_last_timestamp);
-			dtp->dt_last_timestamp = timestamp;
-
-			if (timestamp == buf->dtbd_timestamp) {
+			if ((timestamp = dt_buf_oldest(buf, dtp)) == buf->dtbd_timestamp) {
 				/*
 				 * We've reached the end of the time covered
 				 * by this buffer.  If this is the oldest
@@ -3029,6 +3025,8 @@ dtrace_consume(dtrace_hdl_t *dtp, FILE *fp,
 					break;
 				continue;
 			}
+			assert(timestamp >= dtp->dt_last_timestamp);
+			dtp->dt_last_timestamp = timestamp;
 
 			if ((rval = dt_consume_cpu(dtp, fp,
 			    buf->dtbd_cpu, buf, B_TRUE, pf, rf, arg)) != 0)
-- 
2.21.0

