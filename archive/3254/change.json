{"project":"joyent/illumos-joyent","branch":"master","id":"I4851e24d85b063393a08050bc7dcb5262d68c973","number":"3254","subject":"OS-6540 zonehash_lock is hot under a heavy ZFS IO load Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3254","commitMessage":"OS-6540 zonehash_lock is hot under a heavy ZFS IO load\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1516813633,"lastUpdated":1517849094,"open":false,"status":"MERGED","comments":[{"timestamp":1516813633,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1516824904,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1516830507,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(7 comments)\n\nround 2 came in while looking at round 1, so there are comments in each."},{"timestamp":1516899604,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1516899612,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1516904641,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1516906898,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nSorry for the churn on this, but I realized that my previous change just introduced a new hot lock, so I reworked that a bit."},{"timestamp":1516906906,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1516907472,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1516908921,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1516908929,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1516909281,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1516910092,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\nI added testing notes on the ticket."},{"timestamp":1517262214,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1517844625,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1517844964,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1517849094,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"7","revision":"4851e24d85b063393a08050bc7dcb5262d68c973","parents":["bed3cd5ed18e3c029e2d3dcf19584e7e259da5e1"],"ref":"refs/changes/54/3254/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517844964,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516909281,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517262214,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1517849094,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":212,"deletions":-134},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":398,"sizeDeletions":-256},"patchSets":[{"number":"1","revision":"bd97b0986c44d6fc4766241db92157e10f11b330","parents":["a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e"],"ref":"refs/changes/54/3254/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516813633,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":169,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This value is added to zpers_io_delay, which is a uint8_t."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":169,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Changed"},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":241,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Why not just make this uint64_t?  Since the field after it is a 64 bit field, the size of the structure won\u0027t actually change."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":241,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I prefer not to use a different type than necessary. I moved this member to the end of the structure though, so that if we ever add anything else it might just fit into the alignment constraints."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":654,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Please choose a variable name that is bit longer so that wheat and chaff are more easily distinguished while searching.  iop, used later is much nicer."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":654,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I changed this throughout"},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":716,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"short variable name"},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1039,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"short variable name"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":180,"deletions":-127},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":366,"sizeDeletions":-249},{"number":"2","revision":"bcc304e1c3cfc286b6739ce3cff79f2ca175502e","parents":["a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e"],"ref":"refs/changes/54/3254/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516824904,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1029,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"As I was reviewing round 2 vs. round 1, I made this same observation and spent a few minutes trying to convince myself it wasn\u0027t horrible.  Then I compared round 2 to the base and found this comment.  Maybe a good idea to keep the comment."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1029,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Thanks for highlighting this. On reflection, I think the race here is actually a big issue exactly when we are already hot in this stuff, so I decided to close this window altogether. I reworked things a bit within this function to tighten up the locking."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1155,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"short variable name"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":189,"deletions":-127},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":375,"sizeDeletions":-249},{"number":"3","revision":"814306fe9943cb2433cadebe2b85793004f8b60c","parents":["a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e"],"ref":"refs/changes/54/3254/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516899612,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516904641,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1097,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I was going to ask for this in the last round, but couldn\u0027t convince myself that it was the right thing to do.  Since you think it is, yay!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":201,"deletions":-128},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":387,"sizeDeletions":-250},{"number":"4","revision":"056e7107d19a5b8e0ce7422010465cf37d70c387","parents":["a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e"],"ref":"refs/changes/54/3254/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516906906,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1075,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Does this variable serve any purpose?  We now know that zfs_zone_last_checked will only be changed by one thread, so there\u0027s no need to cache a value."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1075,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"yes, we\u0027re using it as a parameter at line 1090"},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1087,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This block should be moved into the body of the previous block."},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","line":1087,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":210,"deletions":-133},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":396,"sizeDeletions":-255},{"number":"5","revision":"59eff7c73bfa6357b1314028278c67afbaaa096c","parents":["a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e"],"ref":"refs/changes/54/3254/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516908929,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516909281,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517262214,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":212,"deletions":-134},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":398,"sizeDeletions":-256},{"number":"6","revision":"15615be71c5c3419ee16a9fc1e6e4fce2d2891a7","parents":["bed3cd5ed18e3c029e2d3dcf19584e7e259da5e1"],"ref":"refs/changes/54/3254/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517844625,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516909281,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517262214,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":212,"deletions":-134},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":398,"sizeDeletions":-256},{"number":"7","revision":"4851e24d85b063393a08050bc7dcb5262d68c973","parents":["bed3cd5ed18e3c029e2d3dcf19584e7e259da5e1"],"ref":"refs/changes/54/3254/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517844964,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1517849094,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516909281,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517262214,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/zfs_zone.c","type":"MODIFIED","insertions":212,"deletions":-134},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":143,"deletions":-87},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":38,"deletions":-30},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":398,"sizeDeletions":-256}],"allReviewers":[{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}