From cba939bdd68c88c80018c83b2ea5d2af2f8d5ef0 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Fri, 19 Oct 2018 14:54:30 +0100
Subject: [PATCH] TRITON-853 cloudapi should allow creation of instances with
 delegated datasets

---
 lib/machines.js                  | 27 +++++++++++++++++++++++++++
 sapi_manifests/cloudapi/template |  6 ++++++
 2 files changed, 33 insertions(+)

diff --git a/lib/machines.js b/lib/machines.js
index 153afd1..0754cc9 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -57,6 +57,8 @@ var DEFAULT_CONTAINER_BRAND = 'joyent';
 var DEFAULT_HVM_BRAND = 'kvm';
 var VALID_BRANDS = ['bhyve', 'joyent', 'joyent-minimal', 'kvm', 'lx'];
 
+var DELEGATE_DATASET_VALUES = ['on', 'off', 'safe'];
+
 var sprintf = util.format;
 
 
@@ -150,6 +152,7 @@ function translate(machine, req)  {
         memory: Number(machine.ram),
         disk: (Number(machine.quota) * 1024) || 0,
         deletion_protection: !!machine.indestructible_zoneroot,
+        delegate_dataset: machine.delegate_dataset || 'off',
         metadata: machine.customer_metadata || {},
         tags: machine.tags,
         credentials: credentials,
@@ -456,6 +459,30 @@ function getCreateOptions(req) {
         opts.indestructible_zoneroot = true;
     }
 
+    var delegateDataset = params.delegate_dataset;
+    if (delegateDataset !== undefined) {
+        if (!req.config.experimental_cloudapi_delegate_dataset) {
+            throw new InvalidArgumentError('Support for delegated ' +
+                'datasets is not enabled ' +
+                '(experimental_cloudapi_delegate_dataset in SAPI)');
+        }
+
+        if (DELEGATE_DATASET_VALUES.indexOf(delegateDataset) === -1) {
+            throw new InvalidArgumentError(sprintf(
+                'Unsupported value "%s" for "delegate_dataset". ' +
+                'Supported values are: %s',
+                delegateDataset, DELEGATE_DATASET_VALUES.join(', ')));
+        }
+        if (delegateDataset === 'on') {
+            opts.delegate_dataset = true;
+        } else if (delegateDataset === 'safe') {
+            opts.delegate_dataset = true;
+            // when vmapi supports it, we may want additional safety here,
+            // perhaps setting limit_snapshots or limit_datasets.
+            opts.limit_priv = 'default,-sys_fs_import';
+        }
+    }
+
     // Starting in version 7.3, CloudAPI supports what we call interface-
     // centric provisioning. Traditionally, CloudAPI accepted provisioning
     // here in the form of:
diff --git a/sapi_manifests/cloudapi/template b/sapi_manifests/cloudapi/template
index fc09b6d..171544d 100644
--- a/sapi_manifests/cloudapi/template
+++ b/sapi_manifests/cloudapi/template
@@ -198,6 +198,12 @@
     {{#experimental_cloudapi_automount_nfs_shared_volumes}}
     "experimental_cloudapi_automount_nfs_shared_volumes": {{{experimental_cloudapi_automount_nfs_shared_volumes}}},
     {{/experimental_cloudapi_automount_nfs_shared_volumes}}
+    {{^experimental_cloudapi_delegate_dataset}}
+    "experimental_cloudapi_delegate_dataset": false,
+    {{/experimental_cloudapi_delegate_dataset}}
+    {{#experimental_cloudapi_delegate_dataset}}
+    "experimental_cloudapi_delegate_dataset": {{{experimental_cloudapi_delegate_dataset}}},
+    {{/experimental_cloudapi_delegate_dataset}}
     {{^CLOUDAPI_TEST_MODE}}
     "test": false,
     {{/CLOUDAPI_TEST_MODE}}
-- 
2.21.0

