commit b6666043f1628526f3fda5ab9e4cc969cc62a23b
Author: Tim Foster <tim.foster@joyent.com>
Date:   2018-10-17T17:11:25+01:00 (12 months ago)
    
    TRITON-853 cloudapi should allow creation of instances with delegated datasets

diff --git a/lib/machines.js b/lib/machines.js
index 153afd155..00dd5d94b 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -150,6 +150,7 @@ function translate(machine, req)  {
         memory: Number(machine.ram),
         disk: (Number(machine.quota) * 1024) || 0,
         deletion_protection: !!machine.indestructible_zoneroot,
+        delegate_dataset: machine.delegate_dataset,
         metadata: machine.customer_metadata || {},
         tags: machine.tags,
         credentials: credentials,
@@ -456,6 +457,25 @@ function getCreateOptions(req) {
         opts.indestructible_zoneroot = true;
     }
 
+    if (params.delegate_dataset !== undefined) {
+        if (!req.config.experimental_cloudapi_delegate_dataset) {
+            throw new InvalidArgumentError('Support for delegated ' +
+                'datasets is not enabled');
+        }
+
+        if (params.delegate_dataset === true) {
+            opts.delegate_dataset = true;
+        } else if (params.delegate_dataset === 'safe') {
+            opts.delegate_dataset = true;
+            // when vmapi supports it, we may want additional safety here,
+            // perhaps setting limit_snapshots or limit_datasets.
+            opts.limit_priv = 'default,-sys_fs_import';
+        } else {
+            throw new InvalidArgumentError('Unsupported value for ' +
+            '"delegate_dataset": ' + params.delegate_dataset);
+        }
+    }
+
     // Starting in version 7.3, CloudAPI supports what we call interface-
     // centric provisioning. Traditionally, CloudAPI accepted provisioning
     // here in the form of:
diff --git a/sapi_manifests/cloudapi/template b/sapi_manifests/cloudapi/template
index fc09b6dd9..171544d1a 100644
--- a/sapi_manifests/cloudapi/template
+++ b/sapi_manifests/cloudapi/template
@@ -198,6 +198,12 @@
     {{#experimental_cloudapi_automount_nfs_shared_volumes}}
     "experimental_cloudapi_automount_nfs_shared_volumes": {{{experimental_cloudapi_automount_nfs_shared_volumes}}},
     {{/experimental_cloudapi_automount_nfs_shared_volumes}}
+    {{^experimental_cloudapi_delegate_dataset}}
+    "experimental_cloudapi_delegate_dataset": false,
+    {{/experimental_cloudapi_delegate_dataset}}
+    {{#experimental_cloudapi_delegate_dataset}}
+    "experimental_cloudapi_delegate_dataset": {{{experimental_cloudapi_delegate_dataset}}},
+    {{/experimental_cloudapi_delegate_dataset}}
     {{^CLOUDAPI_TEST_MODE}}
     "test": false,
     {{/CLOUDAPI_TEST_MODE}}
