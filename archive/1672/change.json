{"project":"joyent/sdc-manta","branch":"master","id":"Ib4abfc8d0002640430e9beabb19f9de6a9b13607","number":"1672","subject":"MANTA-3014 Only distribute manta-nic and xdc-routes SMF services if required MANTA-3036 validate.js should verify this_az exists, and is accounted for in azs and network definitions Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Dave Pacheco \u003c","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/1672","commitMessage":"MANTA-3014 Only distribute manta-nic and xdc-routes SMF services if required\nMANTA-3036 validate.js should verify this_az exists, and is accounted for in azs and network definitions\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1489674617,"lastUpdated":1491927110,"open":false,"status":"MERGED","comments":[{"timestamp":1489674617,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1489674657,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489675604,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1:\n\nI\u0027ve performed some basic testing against this change, but if possible I\u0027d like to get some high-level feedback on the implementation before performing some more in-depth testing and writing up my results in the tickets.\n\nImplementation matches my recent comment in MANTA-3014 in an attempt to not interfere with CoaL/lab usage of the script. For headnodes, when boot-time networking is enabled, I\u0027ve opted to populate the USB key with a networking.json that can be generated by the hn-netfile tool in the dhcp zone.\n\nI\u0027ve not included a SMF service removal tool (as discussed in MANTA-3014) into this change, as with our upcoming SPC deployment I\u0027d like to at least get this in place before adding the additional tooling. I\u0027d like to create a separate ticket for an SMF service removal tool."},{"timestamp":1489762391,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1489762436,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490004418,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\nPS2 ensures we always distribute the SMF services to the headnode if it exists in the node list as opposed to using `hn-netfile` to populate the USB with a networking module. I had to break out some existing code to make the xdc-routes service distribution a bit more granular, but I believe it\u0027s still readable. \n\nI\u0027ve noted my testing in MANTA-3014 and MANTA-3036, and I now consider this ready for review."},{"timestamp":1490640786,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(4 comments)\n\nI have a few minor style notes, otherwise this generally looks good. Thanks for doing this and sorry for the delay in getting to this."},{"timestamp":1490714534,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1490714574,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490714736,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(4 comments)\n\nThanks for the feedback! I\u0027ve done a few run-throughs of the script and watched the output to confirm expected behaviour after this change (including xdc-route distribution)."},{"timestamp":1491266093,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1491578564,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\nThanks for the review, Robert! Is there anything else you\u0027d like to see here for IA, or would you prefer another set of eyes?"},{"timestamp":1491586395,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1491926821,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1491927110,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"4","revision":"b4abfc8d0002640430e9beabb19f9de6a9b13607","parents":["48d0d723bb516d9b793a0cd3c52341b2f5868316"],"ref":"refs/changes/72/1672/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1491926821,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490714574,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491266093,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491586395,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1491927110,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":109,"deletions":-24},{"file":"networking/validate.js","type":"MODIFIED","insertions":14,"deletions":0}],"sizeInsertions":123,"sizeDeletions":-24},"patchSets":[{"number":"1","revision":"9e5ca5ec52ca85a5a10ac5f744a726106bb644bc","parents":["48d0d723bb516d9b793a0cd3c52341b2f5868316"],"ref":"refs/changes/72/1672/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1489674617,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489674657,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"networking/manta-net.sh","line":859,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I would make sure you only get one entry from this."},{"file":"networking/manta-net.sh","line":859,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":105,"deletions":-6},{"file":"networking/validate.js","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":118,"sizeDeletions":-6},{"number":"2","revision":"9624143d99dc5856198049b9a705fc58b54d2608","parents":["48d0d723bb516d9b793a0cd3c52341b2f5868316"],"ref":"refs/changes/72/1672/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1489762391,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489762436,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"networking/manta-net.sh","line":586,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we can, stylistically we try to have the continuation of || before the new line, rather than starting the line with it."},{"file":"networking/manta-net.sh","line":586,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done."},{"file":"networking/manta-net.sh","line":897,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be assuming that the headnode is the current machine that we\u0027re running this on? While that\u0027s true today, I\u0027m not sure if anything else is assuming that or not. Maybe it\u0027s moot given sdc-oneachnode."},{"file":"networking/manta-net.sh","line":897,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"You\u0027re right, we assume that this `uuid` is the UUID of the headnode, and that we\u0027re running this script from a headnode as instructed by our documentation.\n\nI considered the scenario of multiple headnodes and this code should apply in those cases, although I haven\u0027t tested that.\n\nAs for the scenario where the current machine is not a headnode, I haven\u0027t tested this, but my understanding is that we would have already failed by this point due to the lack of `sdc-*` commands available, at least today. If they _were_ available somehow (maybe the product does this someday), then the result should be the distribution of the SMF services to this same node using `sdc-oneachode` via the existing SMF service distribution mechanisms in this script (assuming those tools work as expected on this non-headnode). Any real headnodes would not get the SMF services in this case if they existed in manta_nodes.\n\nPerhaps a more thorough check would be to find all headnodes in the installation via CNAPI and cross check this list with manta_nodes. If a headnode exists in manta_nodes, use `sdc-oneachnode` to deploy the services. This assumes `sdc-oneachnode` will work.\n\nWhat do you think?"},{"file":"networking/manta-net.sh","line":897,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think for the moment, what we have is fine. We\u0027ll need to go back to the broader questions of how these other headnode projects are going to work to get a better sense of what the right answer should be."},{"file":"networking/validate.js","line":151,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor style note, but add a new line before this to match everything else?"},{"file":"networking/validate.js","line":151,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":106,"deletions":-24},{"file":"networking/validate.js","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":119,"sizeDeletions":-24},{"number":"3","revision":"54233f51dd8a9beaf583b2cd06e47acc214b7117","parents":["48d0d723bb516d9b793a0cd3c52341b2f5868316"],"ref":"refs/changes/72/1672/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1490714534,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491586395,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491266093,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490714574,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":109,"deletions":-24},{"file":"networking/validate.js","type":"MODIFIED","insertions":14,"deletions":0}],"sizeInsertions":123,"sizeDeletions":-24},{"number":"4","revision":"b4abfc8d0002640430e9beabb19f9de6a9b13607","parents":["48d0d723bb516d9b793a0cd3c52341b2f5868316"],"ref":"refs/changes/72/1672/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1491926821,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491586395,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491266093,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490714574,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1491927110,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":109,"deletions":-24},{"file":"networking/validate.js","type":"MODIFIED","insertions":14,"deletions":0}],"sizeInsertions":123,"sizeDeletions":-24}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}