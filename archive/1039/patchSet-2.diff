From 30ee865b03b9ae83ea4d0f22eed49d677d697c92 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Thu, 1 Dec 2016 21:05:53 +0000
Subject: [PATCH] OS-5822 Solaris10 branded zones are broken

---
 usr/src/uts/intel/brand/common/brand_asm.h    | 2 +-
 usr/src/uts/sun4/brand/common/brand_solaris.s | 2 +-
 usr/src/uts/sun4/ml/offsets.in                | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/intel/brand/common/brand_asm.h b/usr/src/uts/intel/brand/common/brand_asm.h
index c820d8e187..1d540db2a9 100644
--- a/usr/src/uts/intel/brand/common/brand_asm.h
+++ b/usr/src/uts/intel/brand/common/brand_asm.h
@@ -161,7 +161,7 @@ extern "C" {
 
 #define	GET_P_BRAND_DATA(sp, pcnt, reg)					\
 	GET_PROCP(sp, pcnt, reg);					\
-	mov	__P_BRAND_DATA(reg), reg	/* get p_brand_data */
+	mov	P_BRAND_DATA(reg), reg		/* get p_brand_data */
 
 /*
  * Each of the following macros returns to the standard syscall codepath if
diff --git a/usr/src/uts/sun4/brand/common/brand_solaris.s b/usr/src/uts/sun4/brand/common/brand_solaris.s
index 9097273036..889218bc5f 100644
--- a/usr/src/uts/sun4/brand/common/brand_solaris.s
+++ b/usr/src/uts/sun4/brand/common/brand_solaris.s
@@ -236,7 +236,7 @@ _emulation_check:
 #endif /* sun4v */
 	ldn	[%g2 + CPU_THREAD], %g3;	/* get thread ptr */
 	ldn	[%g3 + T_PROCP], %g4;		/* get proc ptr */
-	ldn	[%g4 + __P_BRAND_DATA], %g5;	/* get brand data ptr */
+	ldn	[%g4 + P_BRAND_DATA], %g5;	/* get brand data ptr */
 	ldn	[%g5 + SPD_HANDLER], %g5;	/* get userland brnd hdlr ptr */
 	brz	%g5, _exit;			/* has it been set? */
 	nop;
diff --git a/usr/src/uts/sun4/ml/offsets.in b/usr/src/uts/sun4/ml/offsets.in
index de214274ee..4f6d19ba01 100644
--- a/usr/src/uts/sun4/ml/offsets.in
+++ b/usr/src/uts/sun4/ml/offsets.in
@@ -109,7 +109,7 @@ proc		PROCSIZE
 	p_utraps
 	p_agenttp
 	p_brand
-	__p_brand_data
+	p_brand_data
 
 \#define	P_UTRAP4	(UT_ILLTRAP_INSTRUCTION * CPTRSIZE)
 \#define	P_UTRAP7	(UT_FP_DISABLED * CPTRSIZE)
-- 
2.21.0

