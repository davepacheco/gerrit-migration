{"project":"joyent/sdc-docker-build","branch":"master","id":"Ia1d1e8f5d9f4f267d5466f4217f34e734edee6e1","number":"534","subject":"DOCKER-939 docker build - symlink outside of build context caused crash Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/534","commitMessage":"DOCKER-939 docker build - symlink outside of build context caused crash\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1474999146,"lastUpdated":1475525089,"open":false,"status":"MERGED","comments":[{"timestamp":1474999146,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1474999209,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474999891,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1475000224,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1475001692,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2."},{"timestamp":1475001733,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475002894,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3."},{"timestamp":1475002928,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1475002935,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475005979,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1475189322,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 4."},{"timestamp":1475189409,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475517847,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1475518432,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1475521614,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 5."},{"timestamp":1475521665,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475522120,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1475525089,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"5","revision":"a1d1e8f5d9f4f267d5466f4217f34e734edee6e1","parents":["f92cec52486d748c35d8d95074cccf33187171e1"],"ref":"refs/changes/34/534/5","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1475521614,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475521665,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1475522120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475522120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1475525089,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":49,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":104,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"d2ffa09803b1db07e161414879094b8b6bf9e820","parents":["f92cec52486d748c35d8d95074cccf33187171e1"],"ref":"refs/changes/34/534/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1474999146,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474999209,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/build.js","line":1269,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What happens if \"src\" doesn\u0027t exist? Would realpathSync throw an error with code \u003d\u003d\u003d \"ENOENT\", and fi so would \"fs.lstatSync(src)\" throw too?"},{"file":"lib/build.js","line":1269,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Src originally comes from a fs.readdir (so we know it exists, and we also know that it couldn\u0027t get deleted) - so worst case if that src now doesn\u0027t exist - something major went wrong and the build should fail."},{"file":"test/test_build.js","line":192,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why do we use \"fs.readlinkSync(fullpath)\" in the conditional expression, and \"fs.readlinkSync(filepath)\" in \"t.equal\"\u0027s first parameter? Why not using the same expressions?"},{"file":"test/test_build.js","line":192,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Cause I made a mistake :) Good catch, will fix."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":34,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/test_build.js","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":87,"sizeDeletions":-6},{"number":"2","revision":"bde0c4d3dd84f0966af45d40bb23382c7cb15ad5","parents":["f92cec52486d748c35d8d95074cccf33187171e1"],"ref":"refs/changes/34/534/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1475001692,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475001733,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/build.js","line":1326,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This will now return false for symlinks to a dir. Do you have a sense whether that will cause potential surprises or breakage?"},{"file":"lib/build.js","line":1326,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"You are right, this will be a problem for the build cache (checking if files have changed), as the symlink directory contents will no longer be cache-checked. I\u0027ll need to think up a different fix."},{"file":"lib/build.js","line":1363,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is what Docker-docker build does?\nPerhaps it doesn\u0027t matter. Only thing comparing it is our docker build, iiuc."},{"file":"lib/build.js","line":1363,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I couldn\u0027t find what it does for broken symlinks, but I suspect that it treats it as a file with \u0027empty\u0027 string. For regular symlinks it follows the symlink path, which is what I\u0027ll need to do for proper caching checks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":34,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/test_build.js","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":87,"sizeDeletions":-7},{"number":"3","revision":"acf41dff38bdc2dc9a7acd661b3f6024507a37c6","parents":["f92cec52486d748c35d8d95074cccf33187171e1"],"ref":"refs/changes/34/534/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1475002894,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475002935,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":34,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":89,"sizeDeletions":-8},{"number":"4","revision":"9686df4e400a7e6127422e4872ee04cd7dafe8c5","parents":["f92cec52486d748c35d8d95074cccf33187171e1"],"ref":"refs/changes/34/534/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1475189322,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475189409,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/build.js","line":1321,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should this property perhaps be \"contextPathIs*Broken*Symlink\" for clarity, as this is the only case where we\u0027ll have `this.stat` be an lstat? Your call tho, I\u0027m pretty new to this code.\n\nLet me know. I\u0027m +1 after answering this Q."},{"file":"lib/build.js","line":1321,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Yes, that is correct and it would be clearer to rename this to *brokenSymlink*."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":46,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":101,"sizeDeletions":-8},{"number":"5","revision":"a1d1e8f5d9f4f267d5466f4217f34e734edee6e1","parents":["f92cec52486d748c35d8d95074cccf33187171e1"],"ref":"refs/changes/34/534/5","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1475521614,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475521665,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1475522120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475522120,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1475525089,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":49,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":104,"sizeDeletions":-8}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}