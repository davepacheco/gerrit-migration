From 97fce4cd2d905be3f74e34a70f856df6ccda484e Mon Sep 17 00:00:00 2001
From: Mike Zeller <mike@mikezeller.net>
Date: Sat, 21 Apr 2018 00:02:35 +0000
Subject: [PATCH] OS-6904 Want validMacAddress for proptable

---
 src/vm/node_modules/VM.js        | 14 ++++++++++++++
 src/vm/node_modules/proptable.js |  7 ++++++-
 src/vm/node_modules/utils.js     | 13 +++++++++++++
 3 files changed, 33 insertions(+), 1 deletion(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 4b04d0ba..b302f0ab 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -614,6 +614,20 @@ function validateProperty(brand, prop, value, action, data, errors, log)
 
                 errors.bad_values.push(prop);
             }
+
+            // if a validator was defined, pass value through that
+            if (PAYLOAD_PROPERTIES[prop]
+                .hasOwnProperty('pr_valueValidator')) {
+
+                if (!PAYLOAD_PROPERTIES[prop]
+                    .pr_valueValidator(value)) {
+
+                    if (errors.bad_values.indexOf(prop) === -1) {
+                        errors.bad_values.push(prop);
+                    }
+                    break;
+                }
+            }
             break;
         case 'integer':
             var nval;
diff --git a/src/vm/node_modules/proptable.js b/src/vm/node_modules/proptable.js
index fd698311..f0e93167 100644
--- a/src/vm/node_modules/proptable.js
+++ b/src/vm/node_modules/proptable.js
@@ -179,6 +179,10 @@ exports.KVM_MEM_OVERHEAD = KVM_MEM_OVERHEAD;
  *      'required': (optional) an object with brand names as keys and a list
  *                  of actions this payload property *must* be specified with
  *      'type': (required) the type of this property (for validation)
+ *      'valueValidator': (optional) validate this property with a function.
+ *                  Currently only string and list types check for the presence
+ *                  of a validator. If you need to validate something else,
+ *                  then the case statement in VM.js needs to be updated.
  *
  *    Valid property types are:
  *
@@ -1286,7 +1290,8 @@ exports.properties = {
                 'kvm': ['add', 'update'],
                 'lx': ['add', 'update']
             },
-            type: 'string'
+            type: 'string',
+            valueValidator: 'utils.validMacAddress'
         },
         updatable: true,
         zonexml: 'zone.network.mac-addr'
diff --git a/src/vm/node_modules/utils.js b/src/vm/node_modules/utils.js
index 7befd9de..3494b758 100644
--- a/src/vm/node_modules/utils.js
+++ b/src/vm/node_modules/utils.js
@@ -27,6 +27,7 @@
 var assert = require('assert');
 var fs = require('fs');
 var ipaddr = require('/usr/vm/node_modules/ip');
+var macaddr = require('/usr/vm/node_modules/macaddr');
 var net = require('net');
 var sprintf = require('/usr/node/node_modules/sprintf').sprintf;
 
@@ -240,6 +241,17 @@ function validResolver(str)
     return Boolean(net.isIP(str));
 }
 
+function validMacAddress(str)
+{
+    try {
+        macaddr.parse(str);
+    } catch (e) {
+        return false;
+    }
+
+    return true;
+}
+
 function ltrim(str, chars)
 {
     chars = chars || '\\s';
@@ -316,5 +328,6 @@ module.exports = {
     unmangleMem: unmangleMem,
     validAttrValue: validAttrValue,
     validResolver: validResolver,
+    validMacAddress: validMacAddress,
     vrrpMAC: vrrpMAC
 };
-- 
2.21.0

