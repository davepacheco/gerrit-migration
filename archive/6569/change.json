{"project":"joyent/electric-boray","branch":"master","id":"I274476ca2c36b68d1588690871022d28f055d09e","number":"6569","subject":"MANTA-4355 Expose pagination for bucket and object listing Reviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e Approved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/6569","commitMessage":"MANTA-4355 Expose pagination for bucket and object listing\nReviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\nApproved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\n","createdOn":1562613931,"lastUpdated":1563922805,"open":false,"status":"MERGED","comments":[{"timestamp":1562613931,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1562613935,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 0f6cb8d1cad82b5aaffbd230822a69beac98258d\n    \n    initial commit"},{"timestamp":1562613964,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562614439,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1562614442,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 4c9378031b2fc2f925cce4001a39192a82650afc\n    \n    fix character checks for delimiter \u003c 1"},{"timestamp":1562614471,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562951459,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1562951464,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit d07e576ba6af0f1c1ebf60bb2233b3bfe18b364d\n    \n    make delimiter, prefix and marker optional"},{"timestamp":1562951491,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562951567,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1562951572,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit cb0612c22a649999d0699c9a42dc472a6dda82ba\n    \n    make delimiter, prefix and marker optional\n    \n    commit 90daeb18d1afd20e8621ad8c05dc17874c8a6b67\n    \n    fix character checks for delimiter \u003c 1\n    \n    commit bffbc632f907a0cdaeef29bd346f76a188d366ac\n    \n    initial commit"},{"timestamp":1562951624,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1562965907,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5."},{"timestamp":1562965912,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit d5ec0d1a133631cdb0b74ec3401af758c429b68b\n    \n    better translate groups to muskie"},{"timestamp":1562965940,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1563207353,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1563297880,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1563375368,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1563381696,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1563827065,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 6."},{"timestamp":1563827067,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit a4ac0038a424a93af1076706e89e4c24971a98d4\n    \n    Next-Marker support"},{"timestamp":1563827099,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1563901615,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1563922628,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1563922805,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"7","revision":"274476ca2c36b68d1588690871022d28f055d09e","parents":["706bff0fe050bdbeba93223da7e350c1c1ae7cd5"],"ref":"refs/changes/69/6569/7","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1563922628,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1563827099,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1563901615,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1563901615,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"SUBM","value":"1","grantedOn":1563922805,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":366,"deletions":-170}],"sizeInsertions":366,"sizeDeletions":-170},"patchSets":[{"number":"1","revision":"0e3c7c599446171799bc1ebe44786ccaea762695","parents":["5fd3c7d6a37abb2ce9103565e3107c255c25d912"],"ref":"refs/changes/69/6569/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1562613931,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562613964,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":227,"deletions":-134}],"sizeInsertions":227,"sizeDeletions":-134},{"number":"2","revision":"1028ddbbc3ca53cd6bdc830b4ee7fda202502b61","parents":["5fd3c7d6a37abb2ce9103565e3107c255c25d912"],"ref":"refs/changes/69/6569/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1562614439,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562614471,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":232,"deletions":-134}],"sizeInsertions":232,"sizeDeletions":-134},{"number":"3","revision":"7a42c556489b631e3c970f5e9d43a5aa91004000","parents":["5fd3c7d6a37abb2ce9103565e3107c255c25d912"],"ref":"refs/changes/69/6569/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1562951459,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562951491,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":250,"deletions":-137}],"sizeInsertions":250,"sizeDeletions":-137},{"number":"4","revision":"968b934cc34e20325edc5b1dd2b49d6592cf72b1","parents":["706bff0fe050bdbeba93223da7e350c1c1ae7cd5"],"ref":"refs/changes/69/6569/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1562951567,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562951491,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":250,"deletions":-137}],"sizeInsertions":250,"sizeDeletions":-137},{"number":"5","revision":"c5632fd3cd6d792d5feb40c6bf50f63078328985","parents":["706bff0fe050bdbeba93223da7e350c1c1ae7cd5"],"ref":"refs/changes/69/6569/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1562965907,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562965940,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":1263,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I think somewhere along the component chain we ought to assemble all the records for a listing request into a single document, but as I think about it the best place for that is probably in muskie. My reasoning for that is that traditionally there are more muskies than electric-[m|b]oray instances so better to have muskie bear that processing burden than to tie up an electric-boray instance. Also muskie is aware of the requested content-type and can assemble the document accordingly without exposing that detail to electric-boray. Of course right now we\u0027ll only provide a JSON content-type, but if we needed to also support an XML format a la S3 in the future then we could easily handle that. What do you think?"},{"file":"lib/server.js","line":1263,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"If we want to do this, muskie is definitely the place for it, I agree with that.\n\nCurrently, muskie gets the record one-by-one in an EventEmitter format, and writes them out to the HTTP stream as they come in.\n\nIf we wanted to format it all into a single JSON object or whatever, we could easily do that in muskie.\n\nFor future expansion, I don\u0027t actually think we need to do anything now (unless we want XML format *now*). We could always have it return data in an EventEmitter format, unless the client specifies a content type that they accept, in which case we can store all the data up and format it."},{"file":"lib/server.js","line":1308,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I\u0027d vote we drop the type and contentType in these records. I don\u0027t think the type conveys much useful information and the I see the content-type as an indication of the type of response document being returned from an HTTP request versus the the type of the things described in the document. Or maybe we leave a type field, but use the content-type value versus just bucketobject."},{"file":"lib/server.js","line":1308,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I think it does convey useful information when coupled with the delimiter option.  For example, listing buckets:\n\n $ manta \"/$MANTA_USER/buckets?limit\u003d1\" | json type contentType\n bucket\n\n`type` is set to \"bucket\", and `contentType` is empty (the field isn\u0027t even present, as to be expected for buckets).\n\nUsing a delimiter however:\n\n $ manta \"/$MANTA_USER/buckets?limit\u003d1\u0026delimiter\u003d-\" | json type contentType\n group\n\nThe `type` field now is set to \"group\".\n\n\nMoving onto objects:\n\n $ manta \"/$MANTA_USER/buckets/full-bucket/objects?limit\u003d1\" | json type contentType\n bucketobject\n application/json; type\u003dbucketobject\n\nWe have both the `type` and `contentType` which I imagine would be valuable for the user.\n\n`type`, again, is useful when supplying a delimiter:\n\n $ manta \"/$MANTA_USER/buckets/full-bucket/objects?limit\u003d1\u0026delimiter\u003d-\" | json type contentType\n group\n\n\n\nWithout the possibility for a delimiter I could understand dropping the `type` field altogether.  However, because it is a possibility, and a single record could be 1 entity, or a group of entities, I think leaving it makes sense."},{"file":"lib/server.js","line":1430,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"From MANTA-3895\n\n\u003e The continuation token value is\ndetermined by adding one to the code point encoding value of the delimiter.\n\nThis is the logic to do that here... I don\u0027t know much about this, but do we need to worry about any potential overflow/wrapping here?"},{"file":"lib/server.js","line":1430,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Just to repeat what I mentioned on this in ~buckets chat:\n\nI think we\u0027ll be ok because 255 doesn\u0027t correspond to any UTF-8 character that we should be able to represent in a user response or that they could provide us. Quoting the wikipedia: \"FE and FF were never defined for any purpose in UTF-8\"."},{"file":"lib/server.js","line":1430,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":":thumbs_up: :)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":257,"deletions":-169}],"sizeInsertions":257,"sizeDeletions":-169},{"number":"6","revision":"d0ffb367e57259893b835039328d88dd2aa8295a","parents":["706bff0fe050bdbeba93223da7e350c1c1ae7cd5"],"ref":"refs/changes/69/6569/6","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1563827065,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1563827099,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1563901615,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1563901615,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":366,"deletions":-170}],"sizeInsertions":366,"sizeDeletions":-170},{"number":"7","revision":"274476ca2c36b68d1588690871022d28f055d09e","parents":["706bff0fe050bdbeba93223da7e350c1c1ae7cd5"],"ref":"refs/changes/69/6569/7","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1563922628,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1563827099,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1563922805,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1563901615,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1563901615,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":366,"deletions":-170}],"sizeInsertions":366,"sizeDeletions":-170}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}