{"project":"joyent/smartos-live","branch":"master","id":"Id4982e056e750e83e4d44e94c41395c75a07b766","number":"5041","subject":"OS-7362 All related datasets should be destroyed on a failed bhyve VM create Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e","owner":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"url":"https://cr.joyent.us/5041","commitMessage":"OS-7362 All related datasets should be destroyed on a failed bhyve VM create\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e\n","createdOn":1541722084,"lastUpdated":1542050080,"open":false,"status":"MERGED","comments":[{"timestamp":1541722084,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 1."},{"timestamp":1541722085,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 90545c10d4f76d6b1aee7cefd4eb4c758aadc2da\n    \n    add test\n    \n    commit 825574f0ab84aa5ad00c9fdd43a940b4c0e40b7c\n    \n    recursive destroy bhyve datasets on vmadm create failure"},{"timestamp":1541722118,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/img/lib/imgadm.js\n /tmp/repo/src/img/lib/magic.js\n /tmp/repo/src/img/lib/upgrade.js\n /tmp/repo/src/img/sbin/imgadm\n /tmp/repo/src/vm/common/nictag.js\n /tmp/repo/src/vm/tests/common.js\n /tmp/repo/src/vm/tests/test-alias.js\n /tmp/repo/src/vm/node_modules/nodeunit-plus/index.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js(21): warning: missing semicolon\n /tmp/repo/src/vm/tests/test-create-filesystems.js\n /tmp/repo/src/vm/tests/test-create.js\n /tmp/repo/src/vm/tests/test-defaults.js\n /tmp/repo/src/vm/tests/test-docker.js\n /tmp/repo/src/vm/tests/test-firewall.js\n /tmp/repo/src/vm/tests/test-fswatcher.js\n /tmp/repo/src/vm/tests/test-hrtime.js\n /tmp/repo/src/vm/tests/test-indestructible.js\n /tmp/repo/src/vm/tests/test-internal_metadata_namespaces.js\n /tmp/repo/src/vm/tests/test-lastexited.js\n /tmp/repo/src/vm/tests/test-openonerrlogger.js\n /tmp/repo/src/vm/tests/test-queue.js\n /tmp/repo/src/vm/tests/test-quota.js\n /tmp/repo/src/vm/tests/test-reboot.js\n /tmp/repo/src/vm/tests/test-reprovision.js\n /tmp/repo/src/vm/tests/test-send-recv.js\n /tmp/repo/src/vm/tests/test-snapshots.js\n /tmp/repo/src/vm/tests/test-spoof-opts.js\n /tmp/repo/src/vm/tests/test-sysinfo.js\n /tmp/repo/src/vm/tests/test-tmpfs.js\n /tmp/repo/src/vm/tests/test-update.js\n /tmp/repo/src/vm/tests/test-vrrp-nics.js\n /tmp/repo/src/vm/tests/test-vminfod-zonewatcher.js\n /tmp/repo/src/vm/tests/test-vminfod-zonewatcher-overflow.js\n /tmp/repo/src/vm/tests/test-vminfod-zpoolwatcher.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 1 warnings(s)\n Makefile:459: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:379: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1541722522,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 2."},{"timestamp":1541722523,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit a6cd19b5ca32dd7f3d6392f6166edc8afba03ab9\n    \n    linting fix"},{"timestamp":1541722568,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/vm/node_modules/vmload/dump-zoneadm.js\n /tmp/repo/src/vm/node_modules/vmload/dump-zoneinfo.js\n /tmp/repo/src/vm/node_modules/vmload/dump-zonexml.js\n /tmp/repo/src/vm/node_modules/vmload/index.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-datasets.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-json.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-utils.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-xml.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneadm.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneinfo.js\n /tmp/repo/src/vm/node_modules/vminfod/client.js\n /tmp/repo/src/vm/node_modules/vminfod/vminfod.js\n /tmp/repo/src/vm/node_modules/vminfod/zonewatcher.js\n /tmp/repo/src/vm/node_modules/vminfod/zpoolwatcher.js\n /tmp/repo/src/vm/node_modules/sysevent-stream.js\n /tmp/repo/src/vm/node_modules/zonecfg.js\n /tmp/repo/src/vm/node_modules/zoneevent.js\n /tmp/repo/src/img/lib/IMG.js\n /tmp/repo/src/img/lib/cli.js\n /tmp/repo/src/img/lib/common.js\n /tmp/repo/src/img/lib/configuration.js\n /tmp/repo/src/img/lib/database.js\n /tmp/repo/src/img/lib/errors.js\n /tmp/repo/src/img/lib/imgadm.js\n /tmp/repo/src/img/lib/magic.js\n /tmp/repo/src/img/lib/upgrade.js\n /tmp/repo/src/img/sbin/imgadm\n /tmp/repo/src/vm/common/nictag.js\n /tmp/repo/src/vm/tests/common.js\n /tmp/repo/src/vm/tests/test-alias.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js\n vm/tests/test-cleanup-on-failure.js: 49: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 50: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 51: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 52: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 53: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 54: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 55: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 56: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 57: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 58: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 59: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 60: indent by tabs instead of spaces\n vm/tests/test-cleanup-on-failure.js: 61: indent by tabs instead of spaces\n Makefile:459: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:379: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1541722842,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 3."},{"timestamp":1541722843,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit d9e28f430b7fdb564889929b546054ea2c10455b\n    \n    bleh another lint fix"},{"timestamp":1541722890,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541730052,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 4."},{"timestamp":1541730053,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 2a191c5bd098d8559279dc381c50d1aff5b3a26d\n    \n    force unmount"},{"timestamp":1541730101,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541739428,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)\n\nThere is one questionable thing in the test, but I\u0027m not convinced it is wrong.  Maybe another reviewer can weigh in.  If someone else is happy with it, I see no reason to stand in the way."},{"timestamp":1541829827,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1542048616,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1542049367,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1542050080,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dylan Yep"}],"currentPatchSet":{"number":"5","revision":"d4982e056e750e83e4d44e94c41395c75a07b766","parents":["6927a12fec8a30bb041d5c79906d884d282c0dfe"],"ref":"refs/changes/41/5041/5","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542048616,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541730101,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541739428,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541829827,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542049367,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1542050080,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-cleanup-on-failure.js","type":"MODIFIED","insertions":59,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"37b7ded45cf28890fb9c9cc04822a6eb6d5d6174","parents":["6927a12fec8a30bb041d5c79906d884d282c0dfe"],"ref":"refs/changes/41/5041/1","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1541722084,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1541722118,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-cleanup-on-failure.js","type":"MODIFIED","insertions":59,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-2},{"number":"2","revision":"67a6d11e191724059a0f10e1b6e76975cf82604b","parents":["6927a12fec8a30bb041d5c79906d884d282c0dfe"],"ref":"refs/changes/41/5041/2","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1541722522,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1541722568,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-cleanup-on-failure.js","type":"MODIFIED","insertions":59,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-2},{"number":"3","revision":"41932b59ecc71e9245a3b79c619f8047d0bbd993","parents":["6927a12fec8a30bb041d5c79906d884d282c0dfe"],"ref":"refs/changes/41/5041/3","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1541722842,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541722890,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-cleanup-on-failure.js","type":"MODIFIED","insertions":59,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-2},{"number":"4","revision":"c3d1da7dd8aa46c4b87850d9ddfd395dbea79a43","parents":["6927a12fec8a30bb041d5c79906d884d282c0dfe"],"ref":"refs/changes/41/5041/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1541730052,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541730101,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541829827,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541739428,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"src/vm/tests/test-cleanup-on-failure.js","line":154,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I\u0027m a little conflicted on this.  At first I was wondering why you are not using t.equal(), then I realized that this is largely copy-n-paste from above.  There\u0027s something to be said for consistency within the file.  I\u0027m not sure which way we typically go on things like this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-cleanup-on-failure.js","type":"MODIFIED","insertions":59,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-2},{"number":"5","revision":"d4982e056e750e83e4d44e94c41395c75a07b766","parents":["6927a12fec8a30bb041d5c79906d884d282c0dfe"],"ref":"refs/changes/41/5041/5","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1542048616,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541730101,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541829827,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541739428,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542049367,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1542050080,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-cleanup-on-failure.js","type":"MODIFIED","insertions":59,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}]}