{"project":"joyent/sdc-amon","branch":"master","topic":"lullaby-phase-1","id":"I67622fe43341b220a774dba51468d754672c62d9","number":"5225","subject":"TOOLS-2043 Lullaby 3: Improving the Manta/Triton build TOOLS-2062 eng.git should be a git submodule of Triton/Manta repositories TOOLS-2063 shared tooling needed to build Manta/Triton agents Reviewed by: Chris Burroughs \u003cchris.burroughs@joyent.com\u003e Review","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/5225","commitMessage":"TOOLS-2043 Lullaby 3: Improving the Manta/Triton build\nTOOLS-2062 eng.git should be a git submodule of Triton/Manta repositories\nTOOLS-2063 shared tooling needed to build Manta/Triton agents\nReviewed by: Chris Burroughs \u003cchris.burroughs@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1544531008,"lastUpdated":1548196948,"open":false,"status":"MERGED","comments":[{"timestamp":1544531008,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1544531357,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547207584,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Topic set to lullaby-phase-1"},{"timestamp":1547502836,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1547502873,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\nTrent could you take a look at this one in particular?  I\u0027m fuzzy on how the multi-module layout works."},{"timestamp":1547552951,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1547552980,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1547552993,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547553005,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nPatch set 2 addresses Chris\u0027s comments on patch set 1."},{"timestamp":1547849493,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1548089723,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\n(3 comments)\n\n(I haven\u0027t yet got changes to address these, but thought getting a\nresponse back would be useful in the meantime)"},{"timestamp":1548181814,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1548181841,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548181919,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1548183098,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1548190902,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4."},{"timestamp":1548190939,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548191159,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1548196948,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"4","revision":"67622fe43341b220a774dba51468d754672c62d9","parents":["0dbe6a80151798d55bd770dfb552d38d902746ca"],"ref":"refs/changes/25/5225/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1548190902,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548190939,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548191159,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548191159,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"SUBM","value":"1","grantedOn":1548196948,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":49,"deletions":-27},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"tools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-54},{"file":"tools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"tools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"tools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"tools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"tools/mk/Makefile.node_prebuilt.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"tools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"tools/mk/Makefile.targ","type":"DELETED","insertions":0,"deletions":-318}],"sizeInsertions":55,"sizeDeletions":-927},"patchSets":[{"number":"1","revision":"4aebec202dd27540b6b902d6e4c8be264a48d614","parents":["0dbe6a80151798d55bd770dfb552d38d902746ca"],"ref":"refs/changes/25/5225/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1544531008,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544531357,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":8,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Channeling JoshW"},{"file":"Makefile","line":8,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"Makefile","line":42,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I\u0027ll also describe the base image in a comment here"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":36,"deletions":-18},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"tools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-54},{"file":"tools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"tools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"tools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"tools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"tools/mk/Makefile.node_prebuilt.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"tools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"tools/mk/Makefile.targ","type":"DELETED","insertions":0,"deletions":-318}],"sizeInsertions":42,"sizeDeletions":-918},{"number":"2","revision":"1d4cee2459a25078705c63dbd30e0174661de982","parents":["0dbe6a80151798d55bd770dfb552d38d902746ca"],"ref":"refs/changes/25/5225/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1547552980,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547552993,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":98,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, I did:\n\n```\n[root@build0:~/joy/sdc-amon]$ make all release\n```\n\nin a test dev zone  (of the wrong origin image) to test this. The result was that all the \"all\" target steps built first and *then* validate-buildenv ran (after a number of minutes of building).\n\nI\u0027m not sure what the issue is there. Ah. A guess is that Makefile.targ is included at the *bottom*. That results in all Amon\u0027s \"all\" deps running before the \"all: validate-buildenv\" dep?\n\nWe don\u0027t have to fix this now, however. Thoughts?\n\n---\n\nThe same thing happens with `make release`."},{"file":"Makefile","line":98,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep, moving the \u0027all\u0027 to beneath the Makefile.targ include\nseems to be one way to fix this for that target, though I\ndon\u0027t quite understand why our\n\n\"all .... : | validate-buildenv\"\n\nisn\u0027t forcing us to build that first.\n\nThe \u0027|\u0027 should be specifying an order-only-prerequisite causing that to be built first.\n\nOne way to get this to work for the all target is to add\na dependency:\n\n$(NPM_EXEC): validate-buildenv\n\nwhich fixes things for \u0027all\u0027, but not \u0027release\u0027, but honestly\nthat feels like a hack, and I\u0027d rather spend a bit more time\nworking out why the initial intent of using an\norder-only-prerequisite isn\u0027t working."},{"file":"Makefile","line":249,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"Effectively\" a no-op, but it will run the \u0027pkg_master\u0027 target again, right? I wonder if we\u0027ll be doing that twice or more now."},{"file":"Makefile","line":249,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Nope, it won\u0027t run it again, but I was adding in the\npkg_master target to release so that muscle memory of \u0027make\nrelease\u0027 would do the right thing.\n\nMake will dedup any targets you specify on the command line\nanyway, so \u0027make all release\u0027 wouldn\u0027t cause us to build\nthings twice. For example, a toy Makefile:\n\ntimf@jenkins-agent-i386-1.6.3 head -6 Makefile\n\nall: this\n\n.PHONY: this\nthis:\n        echo this is this\ntimf@jenkins-agent-i386-1.6.3 make all this\necho this is this\nthis is this\nmake: Nothing to be done for `this\u0027.\ntimf@jenkins-agent-i386-1.6.3"},{"file":"Makefile","line":254,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this dependency change (because all these targets are .PHONY) going to mean that pkg_master (and perhaps pkg_agent and pkg_relay) will get run multiple times when the new jenkins build does `make all release publish ...`?"},{"file":"Makefile","line":254,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Nope, again this is just developer convenience - I felt that\n\u0027make publish\u0027 should do the same thing across all\nrepositories, which it wasn\u0027t here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":38,"deletions":-19},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"tools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-54},{"file":"tools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"tools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"tools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"tools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"tools/mk/Makefile.node_prebuilt.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"tools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"tools/mk/Makefile.targ","type":"DELETED","insertions":0,"deletions":-318}],"sizeInsertions":44,"sizeDeletions":-919},{"number":"3","revision":"49139a4d4f6a21ee9e61a103ffc4a90c5eae0d82","parents":["0dbe6a80151798d55bd770dfb552d38d902746ca"],"ref":"refs/changes/25/5225/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1548181814,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548181841,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548181919,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548181919,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548183098,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548183098,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"tools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-54},{"file":"tools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"tools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"tools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"tools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"tools/mk/Makefile.node_prebuilt.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"tools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"tools/mk/Makefile.targ","type":"DELETED","insertions":0,"deletions":-318}],"sizeInsertions":49,"sizeDeletions":-921},{"number":"4","revision":"67622fe43341b220a774dba51468d754672c62d9","parents":["0dbe6a80151798d55bd770dfb552d38d902746ca"],"ref":"refs/changes/25/5225/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1548190902,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548190939,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548191159,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548191159,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"SUBM","value":"1","grantedOn":1548196948,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":2,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":49,"deletions":-27},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"tools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-54},{"file":"tools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"tools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"tools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"tools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"tools/mk/Makefile.node_prebuilt.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"tools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"tools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"tools/mk/Makefile.targ","type":"DELETED","insertions":0,"deletions":-318}],"sizeInsertions":55,"sizeDeletions":-927}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}