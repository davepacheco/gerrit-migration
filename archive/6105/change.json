{"project":"joyent/electric-boray","branch":"master","id":"Ifb4aca84125cee82cb9c74650a865584c6af6985","number":"6105","subject":"joyent/electric-boray#6 want sort, limit, and prefix support for listing buckets and objects Reviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e Approved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/6105","commitMessage":"joyent/electric-boray#6 want sort, limit, and prefix support for listing buckets and objects\nReviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\nApproved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\n","createdOn":1555025170,"lastUpdated":1556301728,"open":false,"status":"MERGED","comments":[{"timestamp":1555025170,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1555025173,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit d6ddb695fc710dbc8d9ffb609ee01d5d0c43259e\n    \n    initial commit"},{"timestamp":1555025202,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1555027626,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1555027629,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit a726a98bbdd2a61898908b5b043fd4cd29dd5134\n    \n    cleanup from node-boray rebase"},{"timestamp":1555027657,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556046236,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1556046239,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit c8fdfc743d250b62a273cc39430f5d13a0090e22\n    \n    orderby -\u003e order_by"},{"timestamp":1556046264,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556142016,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1556144928,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1556215795,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4."},{"timestamp":1556215798,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit e90d52b117f1174dd787a622f4328ab12fb3b02f\n    \n    changes based on kelly review"},{"timestamp":1556215823,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556232676,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1556300742,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1556301728,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"5","revision":"fb4aca84125cee82cb9c74650a865584c6af6985","parents":["2d94defa24d4be60a93b22acd4d830e377a484eb"],"ref":"refs/changes/05/6105/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1556300742,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556215823,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556232676,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556232676,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"SUBM","value":"1","grantedOn":1556301728,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":26,"deletions":0},{"file":"lib/moray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":442,"deletions":-121},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":471,"sizeDeletions":-124},"patchSets":[{"number":"1","revision":"6f49f7f92c04d4ec60e9e6eac8d0d7805380149b","parents":["2d94defa24d4be60a93b22acd4d830e377a484eb"],"ref":"refs/changes/05/6105/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1555025170,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1555025202,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":433,"deletions":-107},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":435,"sizeDeletions":-109},{"number":"2","revision":"74d28a34f3475d290568cc10a5a84d14aa0aef4e","parents":["2d94defa24d4be60a93b22acd4d830e377a484eb"],"ref":"refs/changes/05/6105/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1555027626,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1555027657,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":433,"deletions":-107},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":436,"sizeDeletions":-110},{"number":"3","revision":"4a8c0ce3621fabc6e7e40e204370eb8e42624963","parents":["2d94defa24d4be60a93b22acd4d830e377a484eb"],"ref":"refs/changes/05/6105/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1556046236,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556046264,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":645,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Seems like we repeat this quite a bit. Probably something we should have the `dataDirector` provide ultimately do you think?"},{"file":"lib/server.js","line":645,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Agreed - at first glance I don\u0027t see why this couldn\u0027t be something that the dataDirectory provides as in interface - i\u0027ll take a look."},{"file":"lib/server.js","line":1121,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"So if I\u0027m reading this correctly, we\u0027re recursing here until we get `totalRecordsSent` at or above `limit`? Do we risk blowing up the call stack if the `limit` value is high? Or does v8 use tail call elimination maybe? I just haven\u0027t seen recursion used much in node code so makes me curious."},{"file":"lib/server.js","line":1121,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So, you are reading this correctly.  In fact, there is definitely a risk of blowing up the call stack with this logic... kind of.\n\nBecause of how the PaginationStream logic is written, `getNextRecord` will periodically be async, or will use setImmediate.  However, from our perspective here, it would probably be best to make this call to `next` be done in a `setImmediate` to clear the stack every time.\n\nAlso, the limit will never exceed 1,000 to boray (can be configured, so we are guaranteed that getNextRecord will be async after the 1000th record... but even then it could be a huge call stack.\n\nI\u0027ll rework this to call next in a setImmediate, and also do some manual testing to ensure PaginationStream works as expected."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":433,"deletions":-107},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":436,"sizeDeletions":-110},{"number":"4","revision":"9a8e78db1015b7cc51bb4548be064488e6a7ab08","parents":["2d94defa24d4be60a93b22acd4d830e377a484eb"],"ref":"refs/changes/05/6105/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1556215795,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556215823,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556232676,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556232676,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":26,"deletions":0},{"file":"lib/moray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":442,"deletions":-121},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":471,"sizeDeletions":-124},{"number":"5","revision":"fb4aca84125cee82cb9c74650a865584c6af6985","parents":["2d94defa24d4be60a93b22acd4d830e377a484eb"],"ref":"refs/changes/05/6105/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1556300742,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556215823,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1556301728,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556232676,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556232676,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":26,"deletions":0},{"file":"lib/moray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":442,"deletions":-121},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":471,"sizeDeletions":-124}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}