{"project":"joyent/illumos-joyent","branch":"master","id":"Ib8dbbcadcb8ae1011af6513302207637e218cb91","number":"4139","subject":"OS-6997 bhyve should error check mutexes","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/4139","commitMessage":"OS-6997 bhyve should error check mutexes\n","createdOn":1528173710,"lastUpdated":1528212319,"open":true,"status":"NEW","comments":[{"timestamp":1528173710,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1528173842,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: Code-Review-1\n\nQuick untested hack"},{"timestamp":1528174280,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1528202905,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1528210420,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 4."},{"timestamp":1528210824,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: -Code-Review\n\nI\u0027m not sure if this is a great idea or not, but would like feedback.\n\nWhen mutexes are initialized with the static initializers, flag.flag1 (lwp_mutex_t) or __pthread_mutex_flags.__pthread_mutex_flag1 (pthread_mutex_t) does not get set to (LOCK_INITED). This is the case with PTHREAD_MUTEX_INITIALIZER and PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP.  Aside from that, mdb shows PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP and _check_mutex_init() leading to the same results.\n\nTo catch issues with future syncs, we may want to add an ASSERT3S() in _check_mutex_lock() to ensure that PTHREAD_MUTEX_ERRORCHECK is set."},{"timestamp":1528212319,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\nSummary of comments at https://chat.joyent.us/joyent/pl/q1r4j3atwpr55cnjc4i6z155wy\n\n- No need to edit all the files, just use -include CFLAG\n- Use mutex_enter() and mutex_exit()\n- Use mutex_init(\u0026mtx, LOCK_ERRORCHECK, NULL)\n- Consider adding a pthread version of mutex_*() to avoid casts"}],"currentPatchSet":{"number":"4","revision":"b8dbbcadcb8ae1011af6513302207637e218cb91","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/39/4139/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1528210420,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/atkbdc.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/cmd/bhyve/gdb.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/mevent.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/cmd/bhyve/mevent_test.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_e82545.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_irq.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/cmd/bhyve/pci_virtio_net.c","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_xhci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pm.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/cmd/bhyve/ps2kbd.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2mouse.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/rfb.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.c","type":"ADDED","insertions":53,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.h","type":"ADDED","insertions":37,"deletions":0},{"file":"usr/src/cmd/bhyve/test/tst/mevent/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/bhyve/uart_emul.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_emul.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_mouse.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/virtio.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":191,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"577eb2cc18d896952cf62bd14ae46efae0e5f747","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/39/4139/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1528173710,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1528173842,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/atkbdc.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/bhyve/gdb.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/mevent.c","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/mevent_test.c","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_e82545.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_irq.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_net.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_xhci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pm.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2kbd.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2mouse.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/rfb.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.c","type":"ADDED","insertions":53,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.h","type":"ADDED","insertions":34,"deletions":0},{"file":"usr/src/cmd/bhyve/test/tst/mevent/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/bhyve/uart_emul.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_emul.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_mouse.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/virtio.c","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":180,"sizeDeletions":-5},{"number":"2","revision":"10b5b740f74763e9dffeb48eb122d76b7432c3e7","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/39/4139/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1528174280,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1528173842,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/atkbdc.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/bhyve/gdb.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/mevent.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/cmd/bhyve/mevent_test.c","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_e82545.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_irq.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_net.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_xhci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pm.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2kbd.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2mouse.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/rfb.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.c","type":"ADDED","insertions":53,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.h","type":"ADDED","insertions":34,"deletions":0},{"file":"usr/src/cmd/bhyve/test/tst/mevent/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/bhyve/uart_emul.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_emul.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_mouse.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/virtio.c","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-7},{"number":"3","revision":"66894236e37be1daa5cb542deb364e827c6d8c71","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/39/4139/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1528202905,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1528173842,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/atkbdc.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/bhyve/gdb.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/mevent.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/cmd/bhyve/mevent_test.c","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_e82545.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_irq.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_net.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_xhci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pm.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2kbd.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2mouse.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/rfb.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.c","type":"ADDED","insertions":53,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.h","type":"ADDED","insertions":34,"deletions":0},{"file":"usr/src/cmd/bhyve/test/tst/mevent/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/bhyve/uart_emul.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_emul.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_mouse.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/virtio.c","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-7},{"number":"4","revision":"b8dbbcadcb8ae1011af6513302207637e218cb91","parents":["2e89f711f976473351ffb54856bc5738de8778aa"],"ref":"refs/changes/39/4139/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1528210420,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/atkbdc.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/cmd/bhyve/gdb.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/mevent.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/cmd/bhyve/mevent_test.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_e82545.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_irq.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/cmd/bhyve/pci_virtio_net.c","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_xhci.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pm.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/cmd/bhyve/ps2kbd.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/ps2mouse.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/rfb.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.c","type":"ADDED","insertions":53,"deletions":0},{"file":"usr/src/cmd/bhyve/sol_lock.h","type":"ADDED","insertions":37,"deletions":0},{"file":"usr/src/cmd/bhyve/test/tst/mevent/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/bhyve/uart_emul.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_emul.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/usb_mouse.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/virtio.c","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":191,"sizeDeletions":-8}],"allReviewers":[{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}