From 0b4f84d85f1ad1b7551aa7fa1523c23410e41192 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 10 Dec 2018 11:30:59 -0800
Subject: [PATCH] TRITON-1024 cns cnapi timeout too short, updater crashes on
 timeout

---
 lib/cn-filter.js | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/lib/cn-filter.js b/lib/cn-filter.js
index 8a96634..02d2a3f 100644
--- a/lib/cn-filter.js
+++ b/lib/cn-filter.js
@@ -21,8 +21,8 @@ var consts = require('./consts');
 
 var FSM = require('mooremachine').FSM;
 
-var UPDATE_INTERVAL = 30000;
-var CNAPI_TIMEOUT = 10000;
+var UPDATE_INTERVAL = 60000;
+var CNAPI_TIMEOUT = 30000;
 var RETRY_INTERVAL = 5000;
 
 /*
@@ -166,7 +166,7 @@ UpdateCNCacheFSM.prototype.state_retry = function (S) {
 UpdateCNCacheFSM.prototype.state_update = function (S) {
 	var self = this;
 	var cnf = this.cnfilter;
-	var creq = cnf.client.get('/servers?setup=true&extras=status',
+	cnf.client.get('/servers?setup=true&extras=status',
 	    S.callback(function (err, req, res, objs) {
 		if (err) {
 			cnf.log.warn(err, 'failed to update server cache');
@@ -202,7 +202,6 @@ UpdateCNCacheFSM.prototype.state_update = function (S) {
 		S.gotoState('fire');
 	}));
 	S.timeout(CNAPI_TIMEOUT, function () {
-		creq.cancel();
 		cnf.log.warn('timed out while updating server cache');
 		S.gotoState('retry');
 	});
@@ -240,7 +239,8 @@ function CNFilter(opts) {
 
 	this.client = restify.createJsonClient(utils.getRestifyClientOptions({
 		url: 'http://' + this.config.address,
-		agent: opts.agent
+		agent: opts.agent,
+		retry: false
 	}));
 
 	this.cache = undefined;
-- 
2.21.0

