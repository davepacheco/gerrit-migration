commit 502755d1233c9ff71867ea4e507bd5e1343933c7 (refs/changes/12/5312/1)
Author: Robert Bogart <Robert.bogart@joyent.com>
Date:   2019-01-04T18:26:02+00:00 (9 months ago)
    
    MANATEE-343 manatee full rebuilds should pull from the primary where possible

diff --git a/lib/postgresMgr.js b/lib/postgresMgr.js
index 5ac122f..12058e1 100644
--- a/lib/postgresMgr.js
+++ b/lib/postgresMgr.js
@@ -934,8 +934,18 @@ PostgresMgr.prototype._reconfigure = function _reconfigure(pgConfig, callback) {
         var pgUrl = pgConfig.downstream ? pgConfig.downstream.pgUrl : null;
         return (self._primary(pgUrl, onReconfigure));
     } else {
+        /*
+         * If this peer is sync or async, then use backupUrl supplied in the
+         * primary peer object.  See MANATEE-343 for the explanation for why
+         * it is necessary to use the primary for zfs-based replication.  For
+         * postgres-based replication, we should continue to use whoever our
+         * upstream-peer would be -- in the case of the sync, that will be the
+         * primary and in the case of an async, the upstream peer will either
+         * be the sync or another async depending on how many peers there are
+         * in the cluster.
+         */
         return (self._standby(pgConfig.upstream.pgUrl,
-                              pgConfig.upstream.backupUrl,
+                              pgConfig.primary.backupUrl,
                               onReconfigure));
     }
 };
