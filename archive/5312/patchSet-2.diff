From ab5f94c843a82f1615cbc8733d532231a22d26de Mon Sep 17 00:00:00 2001
From: Robert Bogart <Robert.bogart@joyent.com>
Date: Fri, 4 Jan 2019 18:26:02 +0000
Subject: [PATCH] MANATEE-343 manatee full rebuilds should pull from the
 primary where possible

---
 lib/postgresMgr.js | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/lib/postgresMgr.js b/lib/postgresMgr.js
index 5ac122f..183bf28 100644
--- a/lib/postgresMgr.js
+++ b/lib/postgresMgr.js
@@ -934,8 +934,19 @@ PostgresMgr.prototype._reconfigure = function _reconfigure(pgConfig, callback) {
         var pgUrl = pgConfig.downstream ? pgConfig.downstream.pgUrl : null;
         return (self._primary(pgUrl, onReconfigure));
     } else {
+        /*
+         * If this peer is sync or async, then use backupUrl supplied in the
+         * object `rebuildPeer`.  Currently, the peer which the sync/async
+         * rebuild from is the primary.  See MANATEE-343 for the explanation
+         * for why it is necessary to use the primary for zfs-based replication.
+         * For postgres-based replication, we should continue to use whoever our
+         * upstream-peer would be -- in the case of the sync, that will be the
+         * primary and in the case of an async, the upstream peer will either
+         * be the sync or another async depending on how many peers there are
+         * in the cluster.
+         */
         return (self._standby(pgConfig.upstream.pgUrl,
-                              pgConfig.upstream.backupUrl,
+                              pgConfig.rebuildPeer.backupUrl,
                               onReconfigure));
     }
 };
-- 
2.21.0

