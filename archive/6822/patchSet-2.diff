From 4afecbbe2d62c134b28cb75df18983ef567d9f6c Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Wed, 21 Aug 2019 11:01:06 +0200
Subject: [PATCH] TRITON-1875 AdminUI errors in package/image validation for VM
 provision

---
 www/js/views/provision-vm.js | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/www/js/views/provision-vm.js b/www/js/views/provision-vm.js
index 534c276e..e6b12e57 100644
--- a/www/js/views/provision-vm.js
+++ b/www/js/views/provision-vm.js
@@ -330,6 +330,7 @@ var View = Backbone.Marionette.Layout.extend({
     },
 
     onSelectImage: function (image) {
+        var self = this;
         if (!image) {
             var imgValue = this.imageInput.$el.val();
             if (!imgValue || imgValue && imgValue.length !== 36) {
@@ -339,6 +340,10 @@ var View = Backbone.Marionette.Layout.extend({
             return;
         }
 
+        if (image) {
+            self.selectedImage = image.attributes;
+        }
+
 /*
  *      Both image and package have an optional brand attribute.
  *      If brand is set in the image, it'll always take precedence.
@@ -407,6 +412,7 @@ var View = Backbone.Marionette.Layout.extend({
     },
 
     checkFields: function () {
+        var self = this;
         this.hideError();
 
         var values = this.extractFormValues();
@@ -470,17 +476,18 @@ var View = Backbone.Marionette.Layout.extend({
     },
 
     extractFormValues: function () {
+        var self = this;
         var formData = this.ui.form.serializeObject();
         var values = {
             image_uuid: formData.image,
             owner_uuid: formData.owner,
             brand: formData.brand
         };
+
         if (formData.delegate_dataset) {
             values.delegate_dataset = true;
         }
 
-
         if (formData.alias && formData.alias.length) {
             values.alias = formData.alias;
         }
@@ -490,7 +497,7 @@ var View = Backbone.Marionette.Layout.extend({
         }
 
         var pkg = this.packages.get(formData['package']);
-        var img = this.images.get(formData['image_uuid']);
+        var img = self.selectedImage;
 
         if (pkg) {
             values['billing_id'] = pkg.get('uuid');
@@ -511,7 +518,7 @@ var View = Backbone.Marionette.Layout.extend({
                     if (disks) {
                         disks[0].image_uuid = values.image_uuid;
                         values['disks'] = disks;
-                    } else {
+                    } else if (img) {
                         values['disks'] = [
                             {'image_uuid': values['image_uuid']},
                             {'size': quotaMib - img.image_size }
-- 
2.21.0

