From c6a06ae5e24017a4e3a3cf03d8d4489a5a01f760 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Tue, 20 Mar 2018 12:19:40 -0700
Subject: [PATCH] TRITON-178 Image creation support for bhyve VM

---
 src/img/CHANGES.md       |  5 +++++
 src/img/lib/imgadm.js    | 36 +++++++++++++++++++++++++++++++++---
 src/img/man/imgadm.1m.md |  7 +++++++
 src/img/package.json     |  2 +-
 4 files changed, 46 insertions(+), 4 deletions(-)

diff --git a/src/img/CHANGES.md b/src/img/CHANGES.md
index 54fbbc3d..3855d6b9 100644
--- a/src/img/CHANGES.md
+++ b/src/img/CHANGES.md
@@ -5,6 +5,11 @@ Known issues:
 - Docker image imports are experimental. Docker image import also only supports
   Docker Registry v2.
 
+## 3.9.0
+
+- TRITON-178 add support for image creation for bhyve VMs. Also includes a
+  change where created images for bhyve, lx and kvm will have requirements.brand
+  set to the brand of the source VM when creating an image.
 
 ## 3.8.0
 
diff --git a/src/img/lib/imgadm.js b/src/img/lib/imgadm.js
index ee81557d..c9f75d94 100644
--- a/src/img/lib/imgadm.js
+++ b/src/img/lib/imgadm.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2017, Joyent, Inc. All rights reserved.
+ * Copyright (c) 2018, Joyent, Inc. All rights reserved.
  *
  * * *
  * The main imgadm functionality. The CLI is a light wrapper around this tool.
@@ -85,6 +85,7 @@ var upgrade = require('./upgrade');
 
 var CONFIG_PATH = DB_DIR + '/imgadm.conf';
 var DEFAULT_CONFIG = {};
+var SET_REQUIREMENTS_BRAND_BRANDS = ['bhyve', 'lx', 'kvm'];
 
 /* BEGIN JSSTYLED */
 var VMADM_FS_NAME_RE = /^([a-zA-Z][a-zA-Z\._-]*)\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(-disk\d+)?$/;
@@ -3310,6 +3311,7 @@ IMGADM.prototype.createImage = function createImage(options, callback) {
     var maxOriginDepth = options.maxOriginDepth;
 
     var vmInfo;
+    var snapname = '@imgadm-create-pre-prepare';
     var sysinfo;
     var vmZfsFilesystemName;
     var vmZfsSnapnames;
@@ -3318,6 +3320,7 @@ IMGADM.prototype.createImage = function createImage(options, callback) {
     var imageInfo = {};
     var finalSnapshot;
     var toCleanup = {};
+
     async.waterfall([
         function validateVm(next) {
             common.vmGet(vmUuid, {log: log}, function (err, vm) {
@@ -3337,7 +3340,7 @@ IMGADM.prototype.createImage = function createImage(options, callback) {
         },
         function getVmInfo(next) {
             var opts;
-            if (vmInfo.brand === 'kvm' || vmInfo.Brand === 'bhyve') {
+            if (vmInfo.brand === 'kvm' || vmInfo.brand === 'bhyve') {
                 if (vmInfo.disks && vmInfo.disks[0]) {
                     var disk = vmInfo.disks[0];
                     vmZfsFilesystemName = disk.zfs_filesystem;
@@ -3476,6 +3479,20 @@ IMGADM.prototype.createImage = function createImage(options, callback) {
                 log.debug({min_platform: m.requirements.min_platform},
                     'set smartos image min_platform to current');
             }
+            if (SET_REQUIREMENTS_BRAND_BRANDS.indexOf(vmInfo.brand) !== -1
+                && !(options.manifest.requirements
+                    && options.manifest.requirements.min_platform))
+            {
+                // Unless an explicit brand is provided (possibly empty)
+                // the brand for an image for one of these brands match the
+                // source VM since brand-specific changes may have been made
+                // and we can't guarantee it's compatible with other brands.
+                if (!m.requirements)
+                    m.requirements = {};
+                m.requirements.brand = vmInfo.brand;
+                log.debug({brand: m.requirements.brand},
+                    'set image requirements.brand to source VM brand');
+            }
             if (incremental) {
                 if (!originInfo) {
                     next(new errors.VmHasNoOriginError(vmUuid));
@@ -3560,7 +3577,6 @@ IMGADM.prototype.createImage = function createImage(options, callback) {
                 }
             }
 
-            var snapname = '@imgadm-create-pre-prepare';
             logCb(format('Snapshotting VM "%s" to %s', vmUuid, snapname));
             toCleanup.autoprepSnapshots = [];
             async.eachSeries(
@@ -4017,6 +4033,20 @@ IMGADM.prototype.createImage = function createImage(options, callback) {
                 async.eachSeries(
                     toCleanup.autoprepSnapshots,
                     function destroyOne(snap, nextSnapshot) {
+                        var re = new RegExp('/disk[0-9]*' + snapname + '$');
+
+                        if (vmInfo.brand === 'bhyve' && snap.match(re)) {
+                            // For bhyve brand, the disk snapshots will be gone
+                            // when the root snapshot is destroyed (because of
+                            // the -r) so, we only need to remove the root
+                            // snapshot here and skip diskX snapshots.
+                            self.log.info({
+                                snapname: snap
+                            }, 'skipping deletion of bhyve disk snapshot');
+                            nextSnapshot();
+                            return;
+                        }
+
                         zfsDestroy(snap, self.log, nextSnapshot);
                     },
                     next);
diff --git a/src/img/man/imgadm.1m.md b/src/img/man/imgadm.1m.md
index b53ecd00..cdf4591a 100644
--- a/src/img/man/imgadm.1m.md
+++ b/src/img/man/imgadm.1m.md
@@ -340,6 +340,13 @@ UUID.
         to a given image repository (IMGAPI) via "-p URL". This can also be
         done separately via "imgadm publish".
 
+        Note: When creating an image from a VM with brand 'bhyve', 'lx' or
+        'kvm', the resulting manifest will have requirements.brand set to match
+        the brand of the source VM. If this is undesirable, the
+        requirements.brand can be set (optionally empty if the resulting image
+        should not have this value set) in the manifest passed with the '-m'
+        option.
+
         Options:
             -h, --help     Print this help and exit.
             -m <manifest>  Path to image manifest data (as JSON) to
diff --git a/src/img/package.json b/src/img/package.json
index 171c2cd9..84e2d61f 100644
--- a/src/img/package.json
+++ b/src/img/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgadm",
   "description": "Manage SmartOS virtual machine images.",
-  "version": "3.8.0",
+  "version": "3.9.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

