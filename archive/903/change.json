{"project":"joyent/node-libmanta","branch":"master","id":"I899046174c97dbe084782f51aea28c4f9baaed26","number":"903","subject":"MANTA-3031 node-libmanta: Upgrade Node.js version from 0.10 to 4.x Reviewed by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/903","commitMessage":"MANTA-3031 node-libmanta: Upgrade Node.js version from 0.10 to 4.x\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1479229128,"lastUpdated":1561495839,"open":true,"status":"NEW","comments":[{"timestamp":1479229128,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1479229156,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479229223,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nDave, can you take a look please. This is part of the required components update to work with node v4 for MANTA-2999"},{"timestamp":1479230175,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1479314274,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1: Integration-Approval-1\n\n(4 comments)\n\nDave, while there are no breaking changes on this update, I think the recent moray update to v2 might have broken the tools under test/trigger/install. Let me confirm what\u0027s going on there before we move forward on this"},{"timestamp":1479320319,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1479324682,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1: -Integration-Approval\n\n(2 comments)"},{"timestamp":1479324753,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1479324787,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479326892,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1479382120,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1479404514,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1479404720,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nAnalysis of \"assert.object\" usage in node-libmanta:\n\nThe module is used by the following projects:\n\n- manta-muskie\n- manta-wrasse\n- manta-mackerel\n- manta-minnow\n\n# wrasse:\n\nHere is the usage list:\n\n    lib/cleanup.js|14| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/cleanup.js|55| var queue \u003d libmanta.createQueue({\n    lib/find.js|14| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/find.js|67| var queue \u003d libmanta.createQueue({\n    lib/takeover.js|14| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/takeover.js|66| var queue \u003d libmanta.createQueue({\n    lib/upload.js|18| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/upload.js|347| var data \u003d JSON.stringify(libmanta.translateJob(opts.job));\n\nCreate queue is always called with an object with properties and we know that\n`translateJob` will throw an exception when not called with a proper object with\na given set of properties (see below).\n\n\n# mackerel:\n\nThe usage list:\n\n    lib/generateLookup.js|13| var mod_libmanta \u003d require(\u0027libmanta\u0027);\n    lib/generateLookup.js|48| var mahi \u003d mod_libmanta.createMahiClient(opts);\n    lib/generateLookup.js|49| var queue \u003d mod_libmanta.createQueue({\n    lib/jobrunner.js|35| var mod_libmanta \u003d require(\u0027libmanta\u0027);\n    lib/jobrunner.js|219| queue \u003d mod_libmanta.createQueue({\n    lib/keygen/FindKeyGenerator.js|51| var mod_libmanta \u003d require(\u0027libmanta\u0027);\n    lib/keygen/FindKeyGenerator.js|86| var queue \u003d new mod_libmanta.Queue({\n\n\nAgain `Queue` constructor is always called properly with an object with\nproperties. `createMahiCLient` is called with the same `opts` argument received\nby `generateLookup`. This function is called once from `main.js` with a proper\nobject which also includes the `opts.log` expected bunyan logger.\n\n# minnow:\n\nTestimonial usage not affecting our search for `assert.object`:\n\n    main.js|18| var libmanta \u003d require(\u0027libmanta\u0027);\n    main.js|31| serializers: libmanta.bunyan.serializers,\n\n# Muskie:\n\nUsage list:\n\n    lib/auth.js|29| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/auth.js|939| libmanta.authorize({\n    lib/common.js|19| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/common.js|31| var ANONYMOUS_USER \u003d libmanta.ANONYMOUS_USER;\n    lib/common.js|880| libmanta.normalizeMantaPath(_opts, function (err, p) {\n    lib/jobs/get.js|11| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/jobs/get.js|21| var j \u003d libmanta.translateJob(req.job);\n    lib/jobs/input.js|15| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/jobs/input.js|52| this._queue \u003d new libmanta.Queue({\n    lib/jobs/list.js|12| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/jobs/list.js|25| var translateJob \u003d libmanta.translateJob;\n    lib/link.js|13| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/link.js|110| libmanta.normalizeMantaPath(_opts, function (err2, p) {\n    lib/link.js|174| libmanta.authorize({\n    lib/obj.js|59| var libmanta \u003d require(\u0027libmanta\u0027);\n    lib/obj.js|784| queue \u003d libmanta.createQueue({\n\n`Queue` and `createQueue` are always called with proper objects. We\u0027ve already\nchecked that `translateJob` will throw an exception when called with `null`\nanyway so it\u0027s also safe to update here. `normalizeMantaPath` is also called\nwith proper objects everywhere.\n\nFinally, authorize is called, at least, with `mahi` and `context` members.\n\nPer file analysis:\n\n# lib/auth:\n\nAll of them obviously objects b/c when called with `null` would result into\nTypeError due to the lookup for sub properties:\n\n        lib/auth.js|110| assert.object(opts);\n        lib/auth.js|111| assert.object(opts.mahi, \u0027mahi\u0027);\n        lib/auth.js|112| assert.object(opts.context, \u0027context\u0027);\n        lib/auth.js|113| assert.object(opts.context.principal, \u0027principal\u0027);\n        lib/auth.js|115| assert.object(opts.context.resource, \u0027resource\u0027);\n\nSub properties called, good to change:\n\n        lib/auth.js|116| assert.object(opts.context.conditions, \u0027conditions\u0027);\n\nIt\u0027s not clear it couldn\u0027t be called with a null object, maybe we could make it\noptional:\n\n        lib/auth.js|118| assert.object(opts.context.principal.account, \u0027principal.account\u0027);\n\nSub property `owner.account.uuid` called, good to go:\n\n        lib/auth.js|121| assert.object(opts.context.resource.owner, \u0027resource.owner\u0027);\n\n# lib/jobs:\n\nAssert object is called as part of the function `translateJob`, which assumes\nthat the given job object will have a set of properties, therefore it\u0027s safe\nto say that on this case we want any invocation with null to throw an\nexception:\n\n        lib/jobs.js|22| assert.object(job, \u0027job\u0027);\n\nThis is part of connect function; `opts` is supposed to have at least `log`,\n`domain`, `host`, `connectTimeout` properties. If it\u0027s called with `null`, the\ninvocation of `opts.domain.add(client);` will throw an exception so it\u0027s safe\nto update assert.object to do not accept `null` here:\n\n        lib/mahi.js|60| assert.object(opts, \u0027options\u0027);\n\nCannot be called with null (`createRedisClient`) or will throw a type error\ngiven we\u0027re checking for sub properties within the code:\n\n        lib/mahi.js|159| assert.object(opts, \u0027options\u0027);\n\nGood to go due to the line below:\n\n        lib/mahi.js|236| assert.object(opts, \u0027options\u0027);\n\nGood to change since it also calls `opts.log.child` and will result into a\nTypeError if called with null:\n\n        lib/mahi.js|238| assert.object(opts.log, \u0027options.log\u0027);\n\nIf called with `null` the call to `opts.log` will result into a TypeError:\n\n        lib/mahi.js|390| assert.object(opts, \u0027options\u0027);\n\nSame than the previous one:\n\n        lib/mahi.js|470| assert.object(opts, \u0027options\u0027);\n\nAnd the same thing applies again:\n\n        lib/mahi.js|540| assert.object(opts, \u0027options\u0027);\n\nThere are assertions for `options` properties right after this one so it\u0027s safe\nto update `assert.object` here:\n\n        lib/moray.js|294| assert.object(options, \u0027options\u0027);\n\nIt looks for a lot of properties of `options.link` right after this one,\ntherefore, if called with `null` this would result into a\n`TypeError: Cannot read property XX of null` so, good to go:\n\n        lib/moray.js|337| assert.object(options.link, \u0027options.link\u0027);\n\nIt also looks for options properties here, safe to change too:\n\n        lib/moray.js|537| assert.object(options, \u0027options\u0027);\n\nThe following is only used in an http header as:\n\n        headers: {\n            \u0027x-muskie-prev-metadata\u0027: options.previousMetadata\n        }\n\nso maybe this one could be modified to become `optionalObject`?:\n\n        lib/moray.js|540| assert.object(options, \u0027options.previousMetadata\u0027);\n\nLooking for options sub properties here too, safe to move forward:\n\n        lib/moray.js|601| assert.object(options, \u0027options\u0027);\n\nSame thing here too:\n\n        lib/moray.js|648| assert.object(options, \u0027options\u0027);\n\nSame reasoning than for the `previousMetadata` instance before:\n\n        lib/moray.js|651| assert.object(options, \u0027options.previousMetadata\u0027);\n\nLooks for options properties, safe to move forward:\n\n        lib/moray.js|707| assert.object(options, \u0027options\u0027);\n\nThis could be called with null, since there\u0027s no check for anything but\nbeing an object until we reach moray\u0027s meta.ping but, then, it would raise\ntype error if not called with a proper object:\n\n        lib/moray.js|755| assert.object(opts, \u0027options\u0027);\n\nLooks for options properties, safe to move forward:\n\n        lib/moray.js|771| assert.object(options, \u0027options\u0027);\n\nLooks for options properties, safe to move forward:\n\n        lib/queue.js|72| assert.object(opts, \u0027options\u0027);\n\nLooks for options properties, safe to move forward:\n\n        lib/utils.js|74| assert.object(opts, \u0027options\u0027);"},{"timestamp":1479405779,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThanks for doing that!\n\nI think you\u0027re right about previousMetadata -- it needs to be optional.  The assertion is also checking the wrong thing.\n\nIn lib/mahi.js: I think the account is probably required, based on the comment and just general understanding of this function.  The principal always involves an account, even in the anonymous case.  I think the code in mahi.authorize() does use it."},{"timestamp":1479407375,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1479407411,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479407719,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1479407764,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479407800,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1479424410,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(1 comment)\n\nI just had one nit about the new trigger change.\n\nIn terms of testing: I expect we\u0027ll want to test this in the context of muskie and marlin?"},{"timestamp":1479742619,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1479742644,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479763830,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1479828231,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nReady for Integration testing from muskie at https://github.com/joyent/node-libmanta/tree/MANTA-3031"},{"timestamp":1483542948,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nDave, tests are passing fine for manta-muskie, including the changes made for this issue, sounds good if we merge this into master and update manta-muskie accordingly?"},{"timestamp":1483633578,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\nIt seems pretty important to run the marlin test suite for this with a marlin agent and jobsupervisor that are using your updated node-libmanta.  Let me know if you want help doing that."},{"timestamp":1483977030,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nWould it just mean to use the test suite from https://cr.joyent.us/949 and follow README instructions in how to run the marlin code before I run marlin test suite?"},{"timestamp":1484011576,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\n\u003e Would it just mean to use the test suite from https://cr.joyent.us/949\n \u003e and follow README instructions in how to run the marlin code before\n \u003e I run marlin test suite?\n\nI\u0027m not positive what you mean, but I think you could build a muskie image, marlin jobsupervisor image, and agent tarball using your node-libmanta, deploy those to your test system, and run the test suite using the README instructions.  Is that what you were figuring?"},{"timestamp":1484235013,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nNo, what I was meaning was to run the supervisor and muskie itself from my devzone, and the agent from the global zone using the code from my devzone as explained by the manta-marlin repo\u0027s README, but if you think that it would be desirable to give this whole thing a final try with fresh images, just let me know.\n\nSo far, same results than for MANTA-3031 regarding that failing marlin test case"},{"timestamp":1484240997,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\n\u003e No, what I was meaning was to run the supervisor and muskie itself\n \u003e from my devzone, and the agent from the global zone using the code\n \u003e from my devzone as explained by the manta-marlin repo\u0027s README, but\n \u003e if you think that it would be desirable to give this whole thing a\n \u003e final try with fresh images, just let me know.\n\n\nThat should work too.  You may want to disable the other jobsupervisors in your deployment to make sure that you\u0027re testing only yours."},{"timestamp":1484321337,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nExactly the same failure mentioned in https://cr.joyent.us/949. Everything else just pass smooth"},{"timestamp":1486063584,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\nSorry that this fell off my radar.  The change still looks good, but there are some other libmanta changes outstanding as well that are fairly urgent for SPC.  I think the thing to do is probably get those merged, then sync this one up, retest it, and get it integrated.  Does that seem reasonable?"},{"timestamp":1486063895,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nSounds perfectly reasonable :-)"},{"timestamp":1496240919,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1496240925,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 05d48877a58d1a1b3e44fe2c163ea85fc74abb9e\n    \n    MANTA-3031 node-libmanta: Upgrade Node.js version from 0.10 to 4.x\n    Reviewed by: David Pacheco \u003cdap@joyent.com\u003e"},{"timestamp":1496240949,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496241391,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nHey Dave,\n\nI\u0027ve just re-applied these changes to a rebased version of node-libmanta. Can you take a look before I start using https://github.com/joyent/node-libmanta/tree/MANTA-3031 for testing of the repos using this one?\n\nIt\u0027s pretty much the same we had before but I\u0027ve also removed a duplicated \"req_id\" key from an object.\n\nAlso, I\u0027ve got a warning of non strict operators used in lib/mahi.js L#108-109 when checking DNS. Do you know if that\u0027s intended?"},{"timestamp":1496267323,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\nUnfortunately, Gerrit did not recognize this as a rebase.  Maybe other changes were included at the same time?  That makes it pretty hard to figure out what\u0027s actually changed here.  I\u0027ll see if I can diff the diffs."},{"timestamp":1496268161,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1559917442,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nDave, I asume that at this point it\u0027s Ok if I abandon these changes?"},{"timestamp":1561495839,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\n\u003e Dave, I asume that at this point it\u0027s Ok if I abandon these\n \u003e changes?\n\n \u003e Dave, I asume that at this point it\u0027s Ok if I abandon these\n \u003e changes?\n\nWell, we still need to do this work.  Of course, we probably need to update these changes and redo a lot of testing since this hasn\u0027t been looked at in 2 years."}],"currentPatchSet":{"number":"6","revision":"899046174c97dbe084782f51aea28c4f9baaed26","parents":["4c001a1f66ee7f93f65319018cd13aa8240415a2"],"ref":"refs/changes/03/903/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1496240919,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496240949,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496268161,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/moray.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"test/trigger/install/common.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":17,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"aaab48fa677485dee45fabc5be1e4e879fa98e54","parents":["c8ce77d48c18b51de5573fdec3e5d0ad13d6967a"],"ref":"refs/changes/03/903/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479229128,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479229156,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/mahi.js","line":176,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this no longer supported or something?"},{"file":"lib/mahi.js","line":176,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Right, the \"getResults()\" method was removed and replaced by \"getLatestResult()\", which doesn\u0027t include any clue regarding how many attempts were performed"},{"file":"lib/mahi.js","line":176,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It looks to me like getResults() was replaced as you said under https://github.com/MathieuTurcotte/node-backoff/commit/248cf477defa997a7b9270f471614b58c4cdbea1.\n\nHowever, then they added getNumRetries():\nhttps://github.com/MathieuTurcotte/node-backoff/commit/616cb04291ca4fbcb9a4fc0ab07767816dfa176d\n\nCould we use that here?"},{"file":"lib/mahi.js","line":176,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Very true, of course!"},{"file":"package.json","line":13,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This was a breaking change.  Did you verify that we\u0027re not going to run afoul of it?"},{"file":"package.json","line":13,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"The breaking changes due to assert version bump are assert.number accepting Infinity (but still accepting numbers, which is what we use it for in L#316 of moray.js and L#73 of queue.js) and then assert.object(null) which should throw an exception. I\u0027d say that\u0027s the desired behavior, since when we don\u0027t want an exception to be thrown we use assert.optionalObject. So I\u0027d say we should be good to go here."},{"file":"package.json","line":13,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I agree that it\u0027s desired behavior, but it can break existing code.  I\u0027ve run into cases where I updated assert-plus and found that there was code using assertplus.object() for something that was allowed to be null, and it needed to be updated to use assertplus.optionalObject() instead.  I would like us to verify that there are no such cases in this repo before making this change."},{"file":"package.json","line":13,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I went through all the instances of assert.object. The following is the current usage of such assertion in libmanta:\n\n        lib/auth.js|110| assert.object(opts);\n        lib/auth.js|111| assert.object(opts.mahi, \u0027mahi\u0027);\n        lib/auth.js|112| assert.object(opts.context, \u0027context\u0027);\n        lib/auth.js|113| assert.object(opts.context.principal, \u0027principal\u0027);\n        lib/auth.js|115| assert.object(opts.context.resource, \u0027resource\u0027);\n        lib/auth.js|116| assert.object(opts.context.conditions, \u0027conditions\u0027);\n        lib/auth.js|118| assert.object(opts.context.principal.account, \u0027principal.account\u0027);\n        lib/auth.js|121| assert.object(opts.context.resource.owner, \u0027resource.owner\u0027);\n        lib/jobs.js|22| assert.object(job, \u0027job\u0027);\n        lib/mahi.js|60| assert.object(opts, \u0027options\u0027);\n        lib/mahi.js|159| assert.object(opts, \u0027options\u0027);\n        lib/mahi.js|236| assert.object(opts, \u0027options\u0027);\n        lib/mahi.js|238| assert.object(opts.log, \u0027options.log\u0027);\n        lib/mahi.js|390| assert.object(opts, \u0027options\u0027);\n        lib/mahi.js|470| assert.object(opts, \u0027options\u0027);\n        lib/mahi.js|540| assert.object(opts, \u0027options\u0027);\n        lib/moray.js|294| assert.object(options, \u0027options\u0027);\n        lib/moray.js|337| assert.object(options.link, \u0027options.link\u0027);\n        lib/moray.js|537| assert.object(options, \u0027options\u0027);\n        lib/moray.js|540| assert.object(options, \u0027options.previousMetadata\u0027);\n        lib/moray.js|601| assert.object(options, \u0027options\u0027);\n        lib/moray.js|648| assert.object(options, \u0027options\u0027);\n        lib/moray.js|651| assert.object(options, \u0027options.previousMetadata\u0027);\n        lib/moray.js|707| assert.object(options, \u0027options\u0027);\n        lib/moray.js|755| assert.object(opts, \u0027options\u0027);\n        lib/moray.js|771| assert.object(options, \u0027options\u0027);\n        lib/queue.js|72| assert.object(opts, \u0027options\u0027);\n        lib/utils.js|74| assert.object(opts, \u0027options\u0027);\n\nApart of taking a look at the expected values - none of them \"null\", I\u0027d say - shall we check the usage of this module from other projects in order to try to figure out if null is being used as \"object\" from any of those projects?"},{"file":"package.json","line":13,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Ugh, that\u0027s a pretty big blast radius.\n\nWe can ignore cases where the code clearly can\u0027t work if the object is null (e.g., lib/auth.js line 110).  For cases where the code may not have crashed if the object was null, I\u0027m afraid we either have to check every caller, or replace it with a call to optionalObject instead.  But it would be better to avoid using optionalObject if the parameter is essentially required."},{"file":"package.json","line":13,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027ll try to get a deep search of everything using this library and how each function is called then. On it!"},{"file":"package.json","line":13,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks!"},{"file":"package.json","line":26,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Were there any breaking changes here?"},{"file":"package.json","line":26,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"None of the changes made here affects the usage of any of the tools under test directory."},{"file":"package.json","line":31,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Were there any relevant breaking changes here?"},{"file":"package.json","line":31,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Most of the changes here are either fixes or additions, nothing which may break compatibility with our usage of the tool"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-10}],"sizeInsertions":13,"sizeDeletions":-15},{"number":"2","revision":"ec5acc2fa808ffdc9ae8e6d94e3884585886cba9","parents":["c8ce77d48c18b51de5573fdec3e5d0ad13d6967a"],"ref":"refs/changes/03/903/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479324753,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479324787,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/trigger/install/common.js","line":276,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What does this do now?\n\nI don\u0027t think the failure mode before was that bad.  It\u0027s a test tool, and throwing a descriptive exception seems okay.  On the other hand, if it now prints the same error more gracefully, that\u0027s fine."},{"file":"test/trigger/install/common.js","line":276,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"The problem is that before it wasn\u0027t raising any exception at all but just hanging forever b/c given the \"error\" event was triggered, the \"end\" even was never emitted"},{"file":"test/trigger/install/common.js","line":276,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Doesn\u0027t emitting \u0027error\u0027 on an EventEmitter with no \u0027error\u0027 listener cause the program to exit with an uncaught exception?"},{"file":"test/trigger/install/common.js","line":276,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Looks like it isn\u0027t hanging anymore once we set unwrapErrors above, getting rid of it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/trigger/install/common.js","type":"MODIFIED","insertions":11,"deletions":-2}],"sizeInsertions":25,"sizeDeletions":-16},{"number":"3","revision":"01357231d2705257f10148ed12021c702ff87498","parents":["c8ce77d48c18b51de5573fdec3e5d0ad13d6967a"],"ref":"refs/changes/03/903/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479407375,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479407411,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/moray.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/trigger/install/common.js","type":"MODIFIED","insertions":11,"deletions":-2}],"sizeInsertions":27,"sizeDeletions":-18},{"number":"4","revision":"3b93aac0152e5f51c6870f1a52a3a81998177e8d","parents":["c8ce77d48c18b51de5573fdec3e5d0ad13d6967a"],"ref":"refs/changes/03/903/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479407719,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479407764,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/trigger/install/common.js","line":70,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sorry I didn\u0027t notice this earlier, but you probably want to remove \"connectTimeout\", \"retry\", and \"reconnect\" and add the \"failfast\" parameter."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/moray.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/trigger/install/common.js","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":19,"sizeDeletions":-18},{"number":"5","revision":"c12703a932a280f4b2eedd814268b27451eb79bd","parents":["c8ce77d48c18b51de5573fdec3e5d0ad13d6967a"],"ref":"refs/changes/03/903/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479742619,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479763830,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479742644,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/moray.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/trigger/install/common.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":19,"sizeDeletions":-20},{"number":"6","revision":"899046174c97dbe084782f51aea28c4f9baaed26","parents":["4c001a1f66ee7f93f65319018cd13aa8240415a2"],"ref":"refs/changes/03/903/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1496240919,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496268161,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496240949,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/bunyan.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/mahi.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/moray.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-9},{"file":"test/trigger/install/common.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":17,"sizeDeletions":-19}],"allReviewers":[{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}