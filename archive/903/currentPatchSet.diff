From 899046174c97dbe084782f51aea28c4f9baaed26 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Wed, 31 May 2017 16:28:36 +0200
Subject: [PATCH] MANTA-3031 node-libmanta: Upgrade Node.js version from 0.10
 to 4.x Reviewed by: David Pacheco <dap@joyent.com>

---
 lib/bunyan.js                  |  4 ++--
 lib/mahi.js                    |  4 ++--
 lib/moray.js                   |  3 +--
 package.json                   | 18 +++++++++---------
 test/trigger/install/common.js |  7 +++----
 5 files changed, 17 insertions(+), 19 deletions(-)

diff --git a/lib/bunyan.js b/lib/bunyan.js
index 22e2935..b2a8491 100644
--- a/lib/bunyan.js
+++ b/lib/bunyan.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var bunyan = require('bunyan');
-var restify = require('restify');
+var restify = require('restify-clients');
 
 
 
diff --git a/lib/mahi.js b/lib/mahi.js
index e45ba7f..69aa1ef 100644
--- a/lib/mahi.js
+++ b/lib/mahi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var dns = require('dns');
@@ -173,7 +173,7 @@ function createRedisClient(opts, cb) {
 
     var retry = backoff.call(connect, _opts, function (err, client) {
         retry.removeAllListeners('backoff');
-        var attempts = retry.getResults().length;
+        var attempts = retry.getNumRetries();
         log.debug('client acquired after %d attempts', attempts);
         cb(err, client);
     });
diff --git a/lib/moray.js b/lib/moray.js
index 3790927..2d47452 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -810,7 +810,7 @@ Moray.prototype.delMetadata = function delMetadata(options, callback) {
     assert.object(options, 'options');
     assert.string(options.key, 'options.key');
     assert.string(options.requestId, 'options.requestId');
-    assert.object(options, 'options.previousMetadata');
+    assert.optionalObject(options.previousMetadata, 'options.previousMetadata');
     assert.func(callback, 'callback');
 
     if (!this.client) {
@@ -997,7 +997,6 @@ Moray.prototype.search = function search(options) {
         offset: options.offset,
         req_id: options.requestId,
         sort: options.sort,
-        req_id: options.requestId,
         hashkey: options.hashkey
     };
 
diff --git a/package.json b/package.json
index 624b6e3..bf57c60 100644
--- a/package.json
+++ b/package.json
@@ -10,25 +10,25 @@
         "url": "git+ssh://git@git.github.com:joyent/node-libmanta.git"
     },
     "dependencies": {
-        "assert-plus": "0.1.5",
-        "backoff": "2.3.0",
-        "bunyan": "0.22.1",
+        "assert-plus": "1.0.0",
+        "backoff": "2.4.1",
+        "bunyan": "1.8.1",
         "jsprim": "^1.3.1",
         "lru-cache": "2.3.1",
         "moray": "3.0.0",
         "once": "1.3.0",
-        "restify": "2.6.3",
+        "restify-clients": "1.3.3",
         "redis": "0.10.1",
-        "vasync": "1.6.3",
-        "verror": "1.6.0",
+        "vasync": "1.6.4",
+        "verror": "1.7.0",
         "xtend": "2.1.2"
     },
     "devDependencies": {
-        "cmdutil": "0.1.0",
+        "cmdutil": "1.1.0",
         "extsprintf": "1.3.0",
-        "libuuid": "0.1.2",
+        "libuuid": "0.2.1",
         "lstream": "0.0.4",
-        "manta": "1.5.2",
+        "manta": "3.1.2",
         "nodeunit": "0.8.4",
         "posix-getopt": "1.2.0"
     },
diff --git a/test/trigger/install/common.js b/test/trigger/install/common.js
index 82c0440..fa691b0 100644
--- a/test/trigger/install/common.js
+++ b/test/trigger/install/common.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -66,9 +66,8 @@ function setup()
         'log': log,
         'host': host,
         'port': port,
-        'connectTimeout': 3000,
-        'retry': null,
-        'reconnect': false
+        'failFast': true,
+        'unwrapErrors': true
     });
 
     return ({
-- 
2.21.0

