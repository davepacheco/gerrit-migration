From 075e3d10e62ec1f833127bccddbe4850ebd72622 Mon Sep 17 00:00:00 2001
From: Brian Bennett <bahamat@digitalelf.net>
Date: Mon, 27 Jun 2016 12:06:09 -0700
Subject: [PATCH] MANTA-2945 SummarizeDaily could run earlier, which will
 significantly help ...

billing
---
 boot/setup.sh        |  2 +-
 docs/system-crons.md | 23 +++++++++++++++++++++--
 2 files changed, 22 insertions(+), 3 deletions(-)
 mode change 100644 => 100755 boot/setup.sh

diff --git a/boot/setup.sh b/boot/setup.sh
old mode 100644
new mode 100755
index f02c15c..00b1181
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -61,7 +61,7 @@ function manta_setup_mola {
     echo '15 08 * * * cd /opt/smartdc/mackerel && ./scripts/cron/meter-storage.sh >>/var/log/mackerel.log 2>&1' >>$crontab
     echo '17 * * * * cd /opt/smartdc/mackerel && ./scripts/cron/meter-compute.sh >>/var/log/mackerel.log 2>&1' >>$crontab
     echo '19 * * * * cd /opt/smartdc/mackerel && ./scripts/cron/meter-request.sh >>/var/log/mackerel.log 2>&1' >>$crontab
-    echo '30 04 * * * cd /opt/smartdc/mackerel && ./scripts/cron/meter-previous-day.sh >>/var/log/mackerel.log 2>&1' >>$crontab
+    echo '30 01 * * * cd /opt/smartdc/mackerel && ./scripts/cron/meter-previous-day.sh >>/var/log/mackerel.log 2>&1' >>$crontab
     echo '55 * * * * cd /opt/smartdc/mackerel && ./scripts/format/rep.sh' >>$crontab
     echo '55 14 * * * cd /opt/smartdc/mackerel && ./scripts/format/daily.sh' >>$crontab
     gsed -i -e "s|REDIS_HOST|$(mdata-get auth_cache_name)|g" /opt/smartdc/mackerel/etc/config.js
diff --git a/docs/system-crons.md b/docs/system-crons.md
index fa11f56..2b33f60 100644
--- a/docs/system-crons.md
+++ b/docs/system-crons.md
@@ -77,7 +77,14 @@ run a few hours after midnight to allow those jobs to finish.
 # Timeline
 
 Each of the processes above is given some fixed time to complete work for the
-day.  This is the "authoritative" timeline:
+day.  This is the "authoritative" timeline.  Jobs listed in parenthesis run on
+the following day.
+
+The job name can be cross referenced to the executed job by cross referencing
+the [cron configuration][cron] and the [manifest file][manifest].
+
+[cron]: ../boot/setup.sh
+[manifest]: https://github.com/joyent/manta-mackerel/blob/master/sapi_manifests/mackerel-jobs/template
 
 ```
 | 00 | 01 | 02 | 03 | 04 | 05 | 06 | 07 | 08 | 09 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 |
@@ -92,9 +99,21 @@ day.  This is the "authoritative" timeline:
 |                                                      |gc-l|inks
 |                                                           |moray-gc
 |                                                           |mako-gc
-|                   |(daily-metering)
+|    |(daily-metering)
 |----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|----|
 | 00 | 01 | 02 | 03 | 04 | 05 | 06 | 07 | 08 | 09 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 |
 ```
 
+| Manta Job Name          | Cron job command         | Type        | Start Time |
+| ----------------------- | ------------------------ | ----------- | ----------:|
+| postgres                | (in manatee zone)        | maintenance |      00:00 |
+| sql-to-json             | kick_off_pg_transform.js | meta        |      02:00 |
+| gc                      | kick_off_gc.js           | maintenance |      08:05 |
+| storage-hourly-metering | meter-storage.sh         | metering    |      08:15 |
+| gc-links                | gc_create_links.js       | maintenance |      11:10 |
+| moray-gc                | moray_gc.js              | maintenance |      12:15 |
+| audit                   | kick_off_audit.js        | maintenance |      14:20 |
+| [none]                  | daily.sh                 | metering    |      14:55 |
+| (daily-metering)        | meter-previous-day.sh    | metering    |      01:00 |
+
 Also see MANTA-2438.
-- 
2.21.0

