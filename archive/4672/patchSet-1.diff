From c2ef418cd268c87a5582fb26a54c05eb64049f70 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Mon, 13 Aug 2018 14:02:53 -0700
Subject: [PATCH] TRITON-689 cn-agent's virtual servers for mockcloud don't set
 "transitional_status" which breaks 'sdcadm post-setup cmon'

---
 CHANGES.md             | 5 +++++
 lib/post-setup/cmon.js | 5 ++---
 package.json           | 2 +-
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index c47e561..8933ab3 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,11 @@
 
 # sdcadm Changelog
 
+## 1.20.4
+
+- TRITON-689 improve `sdcadm post-setup cmon` to not require
+  `<server>.transitional_status` be defined on CNAPI server records.
+
 ## 1.20.3
 
 - TRITON-313 walk back sdcadm steps export sugar
diff --git a/lib/post-setup/cmon.js b/lib/post-setup/cmon.js
index 0fa9e6b..14cfbdb 100644
--- a/lib/post-setup/cmon.js
+++ b/lib/post-setup/cmon.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2018 Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 /*
  * `sdcadm post-setup cmon`
@@ -408,8 +408,7 @@ function do_cmon(subcmd, opts, args, cb) {
                 var notRunning = [];
                 ctx.serversToUpdate.forEach(function (srv) {
                     if (srv.status !== 'running' ||
-                        (srv.status === 'running' &&
-                         srv.transitional_status !== '')) {
+                        (srv.status === 'running' && srv.transitional_status)) {
                         notRunning.push(srv.uuid);
                     }
                 });
diff --git a/package.json b/package.json
index 582b564..a98d7df 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.20.3",
+  "version": "1.20.4",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

