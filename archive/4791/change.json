{"project":"joyent/smartos-live","branch":"master","id":"I034793fb020732c8e3e1a1113c406809883446e6","number":"4791","subject":"OS-7183 Support early configuration of admin network during CN boot Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Reviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joy","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/4791","commitMessage":"OS-7183 Support early configuration of admin network during CN boot\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nReviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1536173408,"lastUpdated":1561665842,"open":false,"status":"MERGED","comments":[{"timestamp":1536173408,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1536173455,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536189055,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1536189101,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536284237,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)\n\nI think we should probably get one of our erstwhile bash experts in the company to look over the new script"},{"timestamp":1536284600,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3."},{"timestamp":1536284623,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1536284646,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536704341,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1536706377,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\n(8 comments)\n\nI don\u0027t know ksh like I know Bash - most of comments leverage what knowledge I have of Bash so they may be completely wrong in this context, in which case feel free to ignore."},{"timestamp":1536716197,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1544658673,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4."},{"timestamp":1544658679,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1544658724,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544670046,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1544670102,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1555705243,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1555946704,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1555946768,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1555966667,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 7."},{"timestamp":1555966676,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 7:\n\n(6 comments)"},{"timestamp":1555966723,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1561402182,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 7:\n\n(10 comments)"},{"timestamp":1561427064,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 8."},{"timestamp":1561427081,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 7:\n\n(10 comments)"},{"timestamp":1561427097,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 9: Patch Set 8 was rebased."},{"timestamp":1561427136,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1561427188,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1561486461,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 9: Code-Review+1\n\n(1 comment)\n\nlooks great :)"},{"timestamp":1561550299,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1561569652,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1561664816,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 9: Integration-Approval+1"},{"timestamp":1561665582,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1561665603,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 11: Patch Set 10 was rebased."},{"timestamp":1561665695,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11:\n\n\"make check\" passed ok"},{"timestamp":1561665842,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jason King"}],"currentPatchSet":{"number":"11","revision":"034793fb020732c8e3e1a1113c406809883446e6","parents":["9e41d1192aa99b8a5820a21c864f565be3b3b724"],"ref":"refs/changes/91/4791/11","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1561665603,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561427188,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561486461,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561550299,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561569652,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561664816,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1561665842,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":73,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":214,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":14,"deletions":-60},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":475,"sizeDeletions":-62},"patchSets":[{"number":"1","revision":"535f2bc5abfa7c69007b7d816d97a9fd2e610c36","parents":["9b9d4cbe67f4271d01339660c285c90570621d22"],"ref":"refs/changes/91/4791/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1536173408,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536173455,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":91,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":282,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":422,"sizeDeletions":-5},{"number":"2","revision":"f1c4ad6a47ccd45cbc8dc64e97f6e22da44a5f26","parents":["9b9d4cbe67f4271d01339660c285c90570621d22"],"ref":"refs/changes/91/4791/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1536189055,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536189101,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","line":37,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Would you mind cleaning up all the indentation in here? This is a mix of 4-space and tabs."},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","line":37,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","line":66,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"The rest of this file uses tabs for indents, but this line and the \u003c/dependency\u003e underneath seem to be 4-space. Probably best to make them tabs."},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","line":66,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":91,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":282,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":422,"sizeDeletions":-5},{"number":"3","revision":"267fe86a8aaafc666c5241e66d4ae403b705898e","parents":["9b9d4cbe67f4271d01339660c285c90570621d22"],"ref":"refs/changes/91/4791/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1536284600,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536284646,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/method/net-early-admin","line":54,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"A Triton installation can boot all of its CNs without networking.json, so this message is a bit misleading. It might be better as:\n\n    echo \"Boot-time networking files not found; exiting\""},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":54,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"How about \u0027Boot-time networking files not present; exiting\u0027 -- it\u0027s a minor point, but make it sound like less of an error since it can be expected in some circumstances."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":65,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s put log_if_state, get_link_state, wait_for_nic_state, valid_mac, and normalize_mac into /lib/sdc/network.sh, and then update net-physical to use them from there. We can update wait_for_admin_nic_state to use wait_for_nic_state."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":65,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":89,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This should be quoted"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":89,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":112,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Should this regex start with `^`?"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":112,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":124,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"In Bash I would quote this but I don\u0027t know if its necessary here."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":142,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"A lot of the later logic in this file overlaps heavily with the net-physical script. It would be nice if we could make them use the same primitives (like calling boot_file_config_init, create_aggrs, setup_mtu, etc.) so that they\u0027re easier to maintain and keep in sync. It might be easier to do that if we do all of the network setup here when we have the boot-time files, instead of just the admin interface.\n\nWe could put this logic into its own function: https://github.com/joyent/smartos-live/blob/53a5d0cc/overlay/generic/lib/svc/method/net-physical#L501-L640\n\nAnd the logic after that could also go into its own. We could then take care of setting the needed SYSINFO_* variables here and after this loop."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":142,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I can probably do most of that -- though there still might be some duplication in the end (I have some updates and I\u0027ll have some more later).\n\nThe problem is the current net-physical depends on a number of things where it\u0027s hard to conclusively determine if they are safe to run before the zones pool is imported (e.g. sysinfo) or even if it would be appropriate to force those restrictions on them, and solving that I think would be outside the scope of what we\u0027re trying to accomplish here."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":196,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I know this is ksh and not bash, so I don\u0027t know if this fully applies, but something to be mindful of:\n\nI would prefer `read -r` here and in almost any case \u0027read\u0027 is used.\n\nhttps://mywiki.wooledge.org/BashFAQ/001\n\n\u003e The -r option to read prevents backslash interpretation (usually used as a backslash newline pair, to continue over multiple lines or to escape the delimiters). Without this option, any unescaped backslashes in the input will be discarded. You should almost always use the -r option with read."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":196,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"We actually don\u0027t want the -r behavior here (I can add a comment) -- you cannot specify a delimiter with dladm -p, so it always uses a colon, which causes it to escape the colons in the MAC address, so each line looks something like:\n\ne1000g0:0\\:1\\:2\\:3\\:44\\:55\\:66\n\nand I\u0027d rather let the shell interpret that."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":199,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You can also write this as:\n\n    done \u003c \u003c(dladm show-phys -mpo link,address)\n\nThis will similarly keep the loop\u0027s body inside the same shell process."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":199,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"That will mask the exit code of `dladm` that is checked above.  Unfortunately (in Bash at least) it\u0027s not possible to use process substitution AND get the exit code :(."},{"file":"overlay/generic/lib/svc/method/net-physical","line":25,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"2018"},{"file":"overlay/generic/lib/svc/method/net-physical","line":461,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"It\u0027s possible that a user could specify EARLY_ADMIN as an env var and then it will be set here regardless of the existence of this file.  If that isn\u0027t intend should declare the variable above this line like:\n\n EARLY_ADMIN\u003d"},{"file":"overlay/generic/lib/svc/method/net-physical","line":461,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/method/net-physical","line":575,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"You sometimes quote variable expansion inside `[[ ... ]]` and sometimes don\u0027t - I would prefer it was consistent either way.  I know in Bash that variable expansion on the LHS of `[[ ... ]]` undergoes no wordsplitting or globbing so its safe to leave variables unquoted."},{"file":"overlay/generic/lib/svc/method/net-physical","line":575,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":91,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":282,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":422,"sizeDeletions":-5},{"number":"4","revision":"548b3daed013f54b0f6be7bea13e11ba9f741d68","parents":["9b9d4cbe67f4271d01339660c285c90570621d22"],"ref":"refs/changes/91/4791/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1544658673,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544658724,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":89,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":91,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":215,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":13,"deletions":-38},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":423,"sizeDeletions":-40},{"number":"5","revision":"168d3ba716a126e9fbcf6f2d3023c985fe91479d","parents":["c7af5452c268ca85c6ee82b7b2ec2761732fbf9f"],"ref":"refs/changes/91/4791/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1544670046,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544658724,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/sdc/network.sh","line":48,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"should probably verify that ip1, ip2, and mask have four octets.  127.1 and 127.0.0.1 are the same place - let\u0027s be sure no one was being clever with their config."},{"file":"overlay/generic/lib/sdc/network.sh","line":84,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Is reliance on a global variable really needed?  Most uses would be more straight-forward as:\n\nif [[ \"$(get_link_state)\" !\u003d \"down\" ]]; then\n...\n\nIn the case of wait_for_nic_state(), it could just use a local variable for the test then log logic."},{"file":"overlay/generic/lib/sdc/network.sh","line":84,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Most of these were copied from net-physical, but no reason we can\u0027t improve them in the process."},{"file":"overlay/generic/lib/sdc/network.sh","line":89,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"seems like a noise generator"},{"file":"overlay/generic/lib/sdc/network.sh","line":89,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Same as above"},{"file":"overlay/generic/lib/sdc/network.sh","line":124,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"or:\n\nprintf \u0027%02x:%02x:%02x:%02x:%02x:%02x\\n\u0027 0x${mac//:/ 0x}"},{"file":"overlay/generic/lib/sdc/network.sh","line":124,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yeah that\u0027s a bit nicer :)"},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","line":6,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"In a recent review, rm told me we don\u0027t need HEADER START/END"},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","line":6,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","line":53,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Since these are grouping\u003d\u0027require_all\u0027 with matching restart_on and type, is there a reason to not just put all of the service_fmris in one dependency?\n\nSee /lib/svc/manifest/network/network-service.xml for an example of this to depend on filesystem/*"},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","line":53,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":88,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Not needed.  Normally I wouldn\u0027t gripe about this nit, but it is inconsistent with a similar situation two lines below."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":88,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":89,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":91,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":215,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":13,"deletions":-38},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":423,"sizeDeletions":-40},{"number":"6","revision":"f02cc25b9ab1170b7e05863a3fbee06f0b0d6892","parents":["e4657af54fdadc8386be883f6cb772def9012d4c"],"ref":"refs/changes/91/4791/6","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1555946704,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544658724,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":89,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":91,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":215,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":13,"deletions":-38},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":423,"sizeDeletions":-40},{"number":"7","revision":"941918324b50ba7cedf3edb425c2272ff89b2f42","parents":["e4657af54fdadc8386be883f6cb772def9012d4c"],"ref":"refs/changes/91/4791/7","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1555966667,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1555966723,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/sdc/network.sh","line":76,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"$1, $2, and $3 should be quoted"},{"file":"overlay/generic/lib/sdc/network.sh","line":76,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/sdc/network.sh","line":144,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"this should be in double-quotes"},{"file":"overlay/generic/lib/sdc/network.sh","line":144,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Actually we want `0x${max//:/ 0x}` to expand into multiple arguments for printf (or else it appears printf treats it as a single argument and you end up with all 0s.  I\u0027ll add a comment calling that out."},{"file":"overlay/generic/lib/sdc/network.sh","line":144,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"ahhhhhh ok cool i see that now.  good idea about the comment."},{"file":"overlay/generic/lib/sdc/network.sh","line":161,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: you can use (( ... ))\n\n if ((mtu \u003e 9000 || mtu \u003c 1500)); then\n  ...\n fi"},{"file":"overlay/generic/lib/sdc/network.sh","line":161,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/sdc/network.sh","line":177,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"should be in double-quotes"},{"file":"overlay/generic/lib/sdc/network.sh","line":177,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/sdc/network.sh","line":179,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"double-quotes"},{"file":"overlay/generic/lib/sdc/network.sh","line":179,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/sdc/network.sh","line":180,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"ditto above... anytime $admin_if is used below should be double-quoted as well"},{"file":"overlay/generic/lib/sdc/network.sh","line":180,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/sdc/network.sh","line":189,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"double-quotes, can drop the { and } as well."},{"file":"overlay/generic/lib/sdc/network.sh","line":189,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","line":7,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"2019"},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","line":7,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"That\u0027s how long this change has been out :)\nI\u0027ll go ahead and update things though while we\u0027re tidying this up."},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":15,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"2019"},{"file":"overlay/generic/lib/svc/method/net-early-admin","line":15,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"overlay/generic/lib/svc/method/net-physical","line":25,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"2019"},{"file":"overlay/generic/lib/svc/method/net-physical","line":25,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":155,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":73,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":214,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":13,"deletions":-59},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":470,"sizeDeletions":-61},{"number":"8","revision":"6b4bef6abe50f2badec5deb13ed0fa7f4f4182f0","parents":["e4657af54fdadc8386be883f6cb772def9012d4c"],"ref":"refs/changes/91/4791/8","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1561427064,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561427136,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":73,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":214,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":14,"deletions":-60},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":475,"sizeDeletions":-62},{"number":"9","revision":"8a6fc116fbf527c7240980615c04dbd4b1b09e86","parents":["8bdeda02682e621c473dd136b3f5572812add518"],"ref":"refs/changes/91/4791/9","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1561427097,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561569652,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561427188,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561486461,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561664816,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561550299,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":73,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":214,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":14,"deletions":-60},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":475,"sizeDeletions":-62},{"number":"10","revision":"aa852620673f905dd756c40a200444f665a00975","parents":["8bdeda02682e621c473dd136b3f5572812add518"],"ref":"refs/changes/91/4791/10","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1561665582,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561569652,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561427188,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561486461,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561664816,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561550299,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":73,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":214,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":14,"deletions":-60},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":475,"sizeDeletions":-62},{"number":"11","revision":"034793fb020732c8e3e1a1113c406809883446e6","parents":["9e41d1192aa99b8a5820a21c864f565be3b3b724"],"ref":"refs/changes/91/4791/11","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1561665603,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561569652,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561427188,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561486461,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"SUBM","value":"1","grantedOn":1561665842,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561664816,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561550299,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"overlay/generic/lib/sdc/network.sh","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"overlay/generic/lib/svc/manifest/network/network-early-admin.xml","type":"ADDED","insertions":73,"deletions":0},{"file":"overlay/generic/lib/svc/manifest/network/network-physical.xml","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"overlay/generic/lib/svc/method/net-early-admin","type":"ADDED","insertions":214,"deletions":0},{"file":"overlay/generic/lib/svc/method/net-physical","type":"MODIFIED","insertions":14,"deletions":-60},{"file":"overlay/generic/manifest","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":475,"sizeDeletions":-62}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}]}