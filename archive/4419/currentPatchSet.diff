From a111ab793a02232ea6323d117ee6e7b53196432b Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Fri, 22 Jun 2018 15:18:17 -0500
Subject: [PATCH] Invalidate VL3 entries when VL2 entries lose route info

---
 usr/src/uts/common/io/overlay/overlay_target.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/usr/src/uts/common/io/overlay/overlay_target.c b/usr/src/uts/common/io/overlay/overlay_target.c
index 5e33d36043..b5230ba72d 100644
--- a/usr/src/uts/common/io/overlay/overlay_target.c
+++ b/usr/src/uts/common/io/overlay/overlay_target.c
@@ -642,6 +642,8 @@ overlay_route_lookup_vl2(overlay_target_t *ott, overlay_target_entry_t *vl3e,
 		sarc_rele(ott->ott_u.ott_dyn.ott_dhash, vl2e);
 		mutex_exit(&ott->ott_lock);
 
+		vl3e->ote_flags &= ~OVERLAY_ENTRY_F_VALID;
+
 		return (overlay_target_try_queue(vl3e, mp));
 	}
 
-- 
2.21.0

