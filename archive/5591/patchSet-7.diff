From 2504ba3e2a659c4e8a79050b56fe1a2b2d534b10 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Thu, 14 Feb 2019 23:06:51 +0000
Subject: [PATCH] joyent/node-lockfd#8 Async shared file locks test fails with
 node v4 Reviewed by: Trent Mick <trentm@gmail.com> Approved by: Trent Mick
 <trentm@gmail.com>

---
 lib/index.js            | 18 ++++++++----------
 package.json            |  4 ++--
 test/unit/flock.test.js |  4 ++--
 3 files changed, 12 insertions(+), 14 deletions(-)

diff --git a/lib/index.js b/lib/index.js
index de2d58b..b00c7c0 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -22,15 +22,14 @@ lockfd(fd, callback)
 	check_arg(2, 'callback', callback, 'function');
 
 	BINDING.lock_fd(fd, 'write', false, function (ret, errmsg, errno) {
+		var err = null;
+
 		if (ret === -1) {
-			var err = new Error('File Locking Error: ' + errmsg);
+			err = new Error('File Locking Error: ' + errmsg);
 			err.code = errno;
-
-			callback(err);
-			return;
 		}
 
-		callback(null);
+		setImmediate(callback, err);
 	});
 }
 
@@ -69,15 +68,14 @@ flock(fd, op, callback)
 	check_arg(3, 'callback', callback, 'function');
 
 	BINDING.flock(fd, op, false, function (ret, errmsg, errno) {
+		var err = null;
+
 		if (ret === -1) {
-			var err = new Error('File Locking Error: ' + errmsg);
+			err = new Error('File Locking Error: ' + errmsg);
 			err.code = errno;
-
-			callback(err);
-			return;
 		}
 
-		callback(null);
+		setImmediate(callback, err);
 	});
 }
 
diff --git a/package.json b/package.json
index 6468bcb..9c4b9c1 100644
--- a/package.json
+++ b/package.json
@@ -1,12 +1,12 @@
 {
   "name": "lockfd",
   "description": "thin wrapper around fcntl(F_SETLK) and flock()",
-  "version": "2.0.1",
+  "version": "2.0.2",
   "author": "Joshua M. Clulow <jmc@joyent.com>",
   "repository": "git://github.com/joyent/node-lockfd.git",
   "main": "./lib/index.js",
   "dependencies": {
-    "v8plus": "~1.0.2"
+    "v8plus": "~1.0.3"
   },
   "scripts": {
     "postinstall": "cd src && gmake $(eval echo ${MAKE_OVERRIDES})",
diff --git a/test/unit/flock.test.js b/test/unit/flock.test.js
index 5c8b7ee..e81713f 100644
--- a/test/unit/flock.test.js
+++ b/test/unit/flock.test.js
@@ -38,13 +38,13 @@ function asyncTestRun(t, path, ltype, callback) {
 
 	function getSecondLock() {
 		mod_lockfd.flock(fd2, ltype, function (err) {
-			t.ifErr(err, 'acquired lock successfully');
+			t.ifErr(err, 'workload 2 acquired lock successfully');
 			doWork(fd2, 'workload 2');
 		});
 	}
 
 	mod_lockfd.flock(fd1, ltype, function (err) {
-		t.ifErr(err, 'acquired lock successfully');
+		t.ifErr(err, 'workload 1 acquired lock successfully');
 		process.nextTick(getSecondLock);
 		setTimeout(doWork, TIMEOUT, fd1, 'workload 1');
 	});
-- 
2.21.0

