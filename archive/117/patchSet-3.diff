commit b953b8c350287e59d70eebe4e9aee3b7e65ece46 (refs/changes/17/117/3)
Author: Pedro P. Candel <pedro@joyent.com>
Date:   2016-07-21T17:55:44+02:00 (3 years, 3 months ago)
    
    TOOLS-1492 `sdcadm insts` exceptions on SAPI instances for removed servers
    Reviewed by: Joshua M. Clulow <jmc@joyent.com>

diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index e261af1..e33c8de 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -815,13 +815,28 @@ SdcAdm.prototype.listInsts = function listInsts(opts, cb) {
                             if (ins.params && ins.params.server_uuid) {
                                 var id = ins.params.server_uuid;
                                 d.server = id;
+                                /*
+                                 * If a compute node has been removed from
+                                 * CNAPI, there may still be a dangling
+                                 * SAPI instance -- if the server no
+                                 * longer exists, skip it.
+                                 */
+                                if (!ctx.serverFromUuid[id]) {
+                                    self.log.warn({
+                                        instance: ins
+                                    }, 'Skipping dockerlogger instance ' +
+                                    'for unknown server');
+                                    return null;
+                                }
                                 d.hostname = ctx.serverFromUuid[id].hostname;
                                 d.server_ip = ctx.serverAdminIpFromUuid[id];
                             }
                             return (d);
+                        }).filter(function (ins) {
+                            return (ins !== null);
                         });
                         ctx.insts = ctx.insts.concat(dlInsts);
-                        return next();
+                        next();
                     });
                 });
             });
