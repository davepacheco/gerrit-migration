{"project":"joyent/sdcadm","branch":"master","id":"Ib834aca07d6f4eb5aac08cb9ae65c002d78f0a06","number":"117","subject":"TOOLS-1492 `sdcadm insts` exceptions on SAPI instances for removed servers Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/117","commitMessage":"TOOLS-1492 `sdcadm insts` exceptions on SAPI instances for removed servers\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1469005276,"lastUpdated":1471515597,"open":false,"status":"MERGED","comments":[{"timestamp":1469005276,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1469088508,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(3 comments)\n\nIs there a follow-up ticket that covers cleaning up the dangling SAPI instances for deleted compute nodes?  It feels a bit like this change is just further hiding the problem."},{"timestamp":1469101333,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1469114651,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(3 comments)\n\n\u003e (3 comments)\n \u003e \n \u003e Is there a follow-up ticket that covers cleaning up the dangling\n \u003e SAPI instances for deleted compute nodes?  It feels a bit like this\n \u003e change is just further hiding the problem.\n\nThere\u0027s already an open discussion for this at https://devhub.joyent.com/jira/browse/TOOLS-1381. I\u0027d say that the issue should really be a TOOLS issue and that we should figure out a way of installing/uninstalling dockerlogger instances using cn-agent. Or, at least, make sure we uninstall them when a CN is removed using cn-agent the same way we do for all the other agents."},{"timestamp":1469116565,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1469133114,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)\n\nI have linked this ticket (and TOOLS-1381) to SAPI-267, which also seems somewhat related to dangling SAPI instance records.\n\nWere you able to reproduce this by creating dangling SAPI instances in the moray bucket?  If not that, how are you testing?"},{"timestamp":1469169956,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n\u003e (2 comments)\n \u003e \n \u003e I have linked this ticket (and TOOLS-1381) to SAPI-267, which also\n \u003e seems somewhat related to dangling SAPI instance records.\n \u003e\nThanks. I\u0027m gonna try to figure out a way of making dockerlogger instances to uninstall themselves on server removal.\n\n \u003e Were you able to reproduce this by creating dangling SAPI instances\n \u003e in the moray bucket?  If not that, how are you testing?\n\nYes, just creating new SAPI instances with a nonexistent server_uuid as param is enough to test the change before and after applying this patch:\n\n      [root@headnode (coal) ~]# sdc-sapi /instances -X POST -d \u0027{\n      \u003e \"uuid\": \"f189fd84-740d-4558-b2ea-36c62570e383\",\n      \u003e \"service_uuid\": \"539d9af7-2649-4de6-bd8d-8c86992ca8b8\",\n      \u003e \"params\": {\n      \u003e \"server_uuid\": \"44454c4c-4400-1057-804e-b5c04f383432\"\n      \u003e },\n      \u003e \"type\": \"agent\"\n      \u003e }\u0027\n      HTTP/1.1 200 OK\n      Content-Type: application/json\n      Content-Length: 180\n      Date: Fri, 22 Jul 2016 06:33:23 GMT\n      Connection: keep-alive\n\n      {\n        \"uuid\": \"f189fd84-740d-4558-b2ea-36c62570e383\",\n        \"service_uuid\": \"539d9af7-2649-4de6-bd8d-8c86992ca8b8\",\n        \"params\": {\n          \"server_uuid\": \"44454c4c-4400-1057-804e-b5c04f383432\"\n        },\n        \"type\": \"agent\"\n      }\n      [root@headnode (coal) ~]# sdcadm insts svc\u003ddockerlogger\n\n      /opt/smartdc/sdcadm/lib/sdcadm.js:818\n                                      d.hostname \u003d ctx.serverFromUuid[id].hostname;\n                                                                         ^\n      TypeError: Cannot read property \u0027hostname\u0027 of undefined\n          at /opt/smartdc/sdcadm/lib/sdcadm.js:818:68\n          at Array.map (native)\n          at /opt/smartdc/sdcadm/lib/sdcadm.js:807:43\n          at /opt/smartdc/sdcadm/node_modules/sdc-clients/lib/restifyclient.js:112:16\n          at parseResponse (/opt/smartdc/sdcadm/node_modules/sdc-clients/node_modules/restify/lib/clients/json_client.js:84:9)\n          at IncomingMessage.done (/opt/smartdc/sdcadm/node_modules/sdc-clients/node_modules/restify/lib/clients/string_client.js:151:17)\n          at IncomingMessage.g (events.js:180:16)\n          at IncomingMessage.EventEmitter.emit (events.js:117:20)\n          at _stream_readable.js:920:16\n          at process._tickCallback (node.js:415:13)\n      [root@headnode (coal) ~]# sdcadm insts svc\u003ddockerlogger\n      INSTANCE                              SERVICE       HOSTNAME  VERSION                                 ALIAS\n      68db8c49-eeda-4641-9935-b3417e5faa44  dockerlogger  headnode  1.0.0-master-20160608T082632Z-g3abcf86  -\n      8c77121c-0a12-4107-afeb-e7747bb3fc84  dockerlogger  zero      1.0.0-master-20160608T082632Z-g3abcf86  -"},{"timestamp":1469172593,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1469574404,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1470050301,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1470050343,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1470050479,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1470050520,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1470138123,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\n\u003e (2 comments)\n \u003e \n \u003e I have linked this ticket (and TOOLS-1381) to SAPI-267, which also\n \u003e seems somewhat related to dangling SAPI instance records.\n \u003e \n \u003e Were you able to reproduce this by creating dangling SAPI instances\n \u003e in the moray bucket?  If not that, how are you testing?\n\nJosh, this is also waiting for you to review (you already did?) and for integration approval since the tests cases were added a week ago or so. Mind to take another look?"},{"timestamp":1470465364,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1470465399,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1471038286,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1471481268,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Integration-Approval+1\n\nThanks for including the testing information here and the new test. I\u0027m happy to be the approver here."},{"timestamp":1471515597,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"7","revision":"b834aca07d6f4eb5aac08cb9ae65c002d78f0a06","parents":["f8833f98d7131670c77da8355257a7cca017c6ea"],"ref":"refs/changes/17/117/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1470465364,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1469574404,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1471038286,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1471481268,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1471515597,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"test/instances.test.js","type":"MODIFIED","insertions":50,"deletions":-2}],"sizeInsertions":66,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"6acf9dfbd4ff23f440aaaa9c34bfaba72f620ae8","parents":["0b6367a90e59810500faa0352f44d28f9f9fb6fb"],"ref":"refs/changes/17/117/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1469005276,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/sdcadm.js","line":820,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think that rather than talking about the ticket, it would be better to explain the root cause here, e.g.:\n\n  /*\n   * Instances of the \"dockerlogger\" SAPI\n   * service were created with the same UUID as\n   * the compute node on which they were\n   * deployed.  If a compute node has been\n   * removed from CNAPI, there may still be a\n   * dangling SAPI instance -- if the server no\n   * longer exists, skip it.\n   */"},{"file":"lib/sdcadm.js","line":820,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No, that\u0027s not exactly the root cause of the issue. On this case, the instance was created properly, using its own UUID and having the server uuid at the expected place:\n\n  {\n    \"uuid\": \"f189fd84-740d-4558-b2ea-36c62570e383\",\n    \"service_uuid\": \"597415f8-81b5-4e55-8831-6cbdeab56d43\",\n    \"params\": {\n      \"server_uuid\": \"44454c4c-4400-1057-804e-b5c04f383432\"\n    },\n    \"type\": \"agent\"\n  },\n\nThe issue here is that the instance still exists in SAPI, but the server doesn\u0027t in CNAPI and when we try to lookup the server by the value given to params.server_uuid we get nothing in return. So, the comment should be something like:\n\n  /*\n   * If a compute node has been\n   * removed from CNAPI, there may still be a\n   * dangling SAPI instance -- if the server no\n   * longer exists, skip it.\n   */"},{"file":"lib/sdcadm.js","line":820,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Ah, now I understand.  Thanks -- and I like the new comment."},{"file":"lib/sdcadm.js","line":822,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"parens here, i.e.:\n\n  return (null);"},{"file":"lib/sdcadm.js","line":822,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Why?, do the parentheses add any value to the return statement here? I understand using them when, for example, we\u0027re returning a expression which would be evaluated, even if that\u0027s some simple arithmetic/logic stuff. But on this case we\u0027re just returning \"null\" value.\n\nNote I\u0027m happy adding those even if they don\u0027t  add any special value on this case, just want to understand better why we want them here ;-)"},{"file":"lib/sdcadm.js","line":822,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It\u0027s part of the cstyle[1] rules we use for some other repositories:\n\n\u003e If the return statement is used to return a value, the expression should always be enclosed in\nparentheses.\n\u003e Functions that return no value should not include a return statement as the last statement in the function\n\nI mentioned it because it seems to be done on, e.g., L834.  I guess it\u0027s not being consistently done so it probably doesn\u0027t matter as much for now.\n\n[1]: https://www.cis.upenn.edu/~lee/06cse480/data/cstyle.ms.pdf"},{"file":"lib/sdcadm.js","line":823,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It feels like we should at least put a WARN level message in the bunyan log when we detect this condition."},{"file":"lib/sdcadm.js","line":823,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":9,"sizeDeletions":-1},{"number":"2","revision":"f42ebb40a8cbee27e04e81113d6fd15964a903b2","parents":["b6a75087b6602152fc900399e87153eba79995b0"],"ref":"refs/changes/17/117/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1469101333,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":9,"sizeDeletions":-1},{"number":"3","revision":"b953b8c350287e59d70eebe4e9aee3b7e65ece46","parents":["b6a75087b6602152fc900399e87153eba79995b0"],"ref":"refs/changes/17/117/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1469116565,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469133114,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":16,"deletions":-1}],"sizeInsertions":16,"sizeDeletions":-1},{"number":"4","revision":"640f041a030e3ece3e77c7697735f9f87f5ab4ef","parents":["b6a75087b6602152fc900399e87153eba79995b0"],"ref":"refs/changes/17/117/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1469172593,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1469574404,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"test/instances.test.js","type":"MODIFIED","insertions":50,"deletions":-2}],"sizeInsertions":66,"sizeDeletions":-3},{"number":"5","revision":"761381b0bedb503e5913cadbc87a71c9bdd40de8","parents":["7b1e650bfb9eef950535ac9ea25e1deb5cfaddd1"],"ref":"refs/changes/17/117/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1470050301,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1469574404,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"test/instances.test.js","type":"MODIFIED","insertions":50,"deletions":-2}],"sizeInsertions":66,"sizeDeletions":-3},{"number":"6","revision":"a26a8b9d1e4df72075c9446c5893b03f2cc4c080","parents":["fde3068854da34d1bf54ac00daab0dbd4d62c66c"],"ref":"refs/changes/17/117/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1470050479,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1469574404,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"test/instances.test.js","type":"MODIFIED","insertions":50,"deletions":-2}],"sizeInsertions":66,"sizeDeletions":-3},{"number":"7","revision":"b834aca07d6f4eb5aac08cb9ae65c002d78f0a06","parents":["f8833f98d7131670c77da8355257a7cca017c6ea"],"ref":"refs/changes/17/117/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1470465364,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1471481268,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1471038286,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1469574404,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1471515597,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"test/instances.test.js","type":"MODIFIED","insertions":50,"deletions":-2}],"sizeInsertions":66,"sizeDeletions":-3}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}