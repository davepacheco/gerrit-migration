commit 6acf9dfbd4ff23f440aaaa9c34bfaba72f620ae8 (refs/changes/17/117/1)
Author: Pedro P. Candel <pedro@joyent.com>
Date:   2016-07-20T11:00:54+02:00 (3 years, 3 months ago)
    
    TOOLS-1492 `sdcadm insts` exceptions on SAPI instances for removed servers

diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 717d84c..21ba686 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -815,13 +815,21 @@ SdcAdm.prototype.listInsts = function listInsts(opts, cb) {
                             if (ins.params && ins.params.server_uuid) {
                                 var id = ins.params.server_uuid;
                                 d.server = id;
+                                // TOOLS-1492: A server may have been deleted
+                                // leaving the SAPI instance present and
+                                // associated to nothing:
+                                if (!ctx.serverFromUuid[id]) {
+                                    return null;
+                                }
                                 d.hostname = ctx.serverFromUuid[id].hostname;
                                 d.server_ip = ctx.serverAdminIpFromUuid[id];
                             }
                             return (d);
+                        }).filter(function (ins) {
+                            return (ins !== null);
                         });
                         ctx.insts = ctx.insts.concat(dlInsts);
-                        return next();
+                        next();
                     });
                 });
             });
