commit cee07154a209bc5a6b3c161a9dad156c9831deee (refs/changes/57/2757/2)
Author: Cody Peter Mello <cody.mello@joyent.com>
Date:   2018-02-24T01:09:32+00:00 (1 year, 7 months ago)
    
    MANATEE-346 Ship both Postgres 9.2 and 9.6 in sdc-manatee images

diff --git a/.gitmodules b/.gitmodules
index 48ab5ca..d8bef2a 100644
--- a/.gitmodules
+++ b/.gitmodules
@@ -1,3 +1,12 @@
 [submodule "deps/sdc-scripts"]
 	path = deps/sdc-scripts
 	url = https://github.com/joyent/sdc-scripts.git
+[submodule "deps/postgresql92"]
+	path = deps/postgresql92
+	url = https://github.com/postgres/postgres.git
+[submodule "deps/postgresql96"]
+	path = deps/postgresql96
+	url = https://github.com/joyent/postgres.git
+[submodule "deps/pg_repack"]
+	path = deps/pg_repack
+	url = https://github.com/reorg/pg_repack.git
diff --git a/Makefile b/Makefile
index 82ad2aa..e0ea01e 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
 #
@@ -57,16 +57,15 @@ all: $(SMF_MANIFESTS) | $(NPM_EXEC) $(REPO_DEPS) sdc-scripts
 DISTCLEAN_FILES = ./node_modules
 
 .PHONY: release
-release: all deps docs $(SMF_MANIFESTS)
+release: all deps docs pg $(SMF_MANIFESTS)
 	@echo "Building $(RELEASE_TARBALL)"
-	@mkdir -p $(RELSTAGEDIR)/root/opt/smartdc/manatee
+	@mkdir -p $(RELSTAGEDIR)/root/opt/smartdc/manatee/deps
 	@mkdir -p $(RELSTAGEDIR)/root/opt/smartdc/boot
 	@mkdir -p $(RELSTAGEDIR)/site
 	@touch $(RELSTAGEDIR)/site/.do-not-delete-me
 	@mkdir -p $(RELSTAGEDIR)/root
 	cp -r   $(ROOT)/build \
 		$(ROOT)/bin \
-		$(ROOT)/deps \
 		$(ROOT)/etc \
 		$(ROOT)/node_modules \
 		$(ROOT)/package.json \
@@ -74,6 +73,8 @@ release: all deps docs $(SMF_MANIFESTS)
 		$(ROOT)/sapi_manifests \
 		$(ROOT)/smf \
 		$(RELSTAGEDIR)/root/opt/smartdc/manatee/
+	cp -r $(ROOT)/deps/sdc-scripts \
+	    $(RELSTAGEDIR)/root/opt/smartdc/manatee/deps
 	mkdir -p $(RELSTAGEDIR)/root/opt/smartdc/boot/scripts
 	cp -R $(ROOT)/boot/* \
 	    $(RELSTAGEDIR)/root/opt/smartdc/boot/
@@ -93,6 +94,12 @@ publish: release
 
 sdc-scripts: deps/sdc-scripts/.git
 
+.PHONY: pg
+pg: all deps/postgresql92/.git deps/postgresql96/.git deps/pg_repack/.git
+	$(MAKE) -C node_modules/manatee -f Makefile.postgres \
+		RELSTAGEDIR="$(RELSTAGEDIR)" \
+		DEPSDIR="$(ROOT)/deps"
+
 include ./tools/mk/Makefile.deps
 include ./tools/mk/Makefile.node_prebuilt.targ
 include ./tools/mk/Makefile.smf.targ
diff --git a/boot/configure.sh b/boot/configure.sh
index 06a87fd..20135ca 100755
--- a/boot/configure.sh
+++ b/boot/configure.sh
@@ -7,27 +7,49 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
-export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
+PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
+export PS4
 set -o xtrace
 
+#
+# Disable the protection against RST reflection denial-of-service attacks.
+# In order for system liveliness when PostgreSQL is not running, we need to
+# be able to send a RST for every inbound connection to a closed port.  This
+# is only safe because we run Manatee on an isolated network.
+#
+# The long-term stability of this interface is not completely clear, so we
+# ignore the exit status of ndd(1M).  To do otherwise may unintentionally
+# create a flag day with future platform versions.
+#
+/usr/sbin/ndd -set /dev/tcp tcp_rst_sent_rate_enabled 0
+
 # set shared_buffers to 1/4 provisoned RSS
 set -o errexit
 set -o pipefail
-# make a backup if non exists.
-if [[ ! -f /opt/smartdc/manatee/etc/postgresql.sdc.conf.in ]]
-then
-    cp /opt/smartdc/manatee/etc/postgresql.sdc.conf /opt/smartdc/manatee/etc/postgresql.sdc.conf.in
-fi
+
 shared_buffers="$(( $(prtconf -m) / 4 ))MB"
-sed -e "s#@@SHARED_BUFFERS@@#$shared_buffers#g" \
-    /opt/smartdc/manatee/etc/postgresql.sdc.conf.in > /opt/smartdc/manatee/etc/postgresql.sdc.conf.in2
 # maintenance_work_mem should be 1/128th of the zone's dram.
 maintenance_work_mem="$(( $(prtconf -m) / 128 ))MB"
-sed -e "s#@@MAINTENANCE_WORK_MEM@@#$maintenance_work_mem#g" \
-    /opt/smartdc/manatee/etc/postgresql.sdc.conf.in2 > /opt/smartdc/manatee/etc/postgresql.sdc.conf
+
+function expandPgConfig() {
+    ETC_DIR=$1
+
+    # Make a backup if one doesn't already exist.
+    if [[ ! -f $ETC_DIR/postgresql.sdc.conf.in ]]; then
+        cp $ETC_DIR/postgresql.sdc.conf $ETC_DIR/postgresql.sdc.conf.in
+    fi
+
+    sed -e "s#@@SHARED_BUFFERS@@#$shared_buffers#g" \
+        -e "s#@@MAINTENANCE_WORK_MEM@@#$maintenance_work_mem#g" \
+        $ETC_DIR/postgresql.sdc.conf.in > $ETC_DIR/postgresql.sdc.conf
+}
+
+expandPgConfig /opt/smartdc/manatee/etc/9.2
+expandPgConfig /opt/smartdc/manatee/etc/9.6
+
 set +o errexit
 set +o pipefail
 
diff --git a/boot/setup.sh b/boot/setup.sh
index 3b8b3c5..75642c8 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -86,6 +86,18 @@ function common_enable_services {
 }
 
 function common_manatee_setup {
+    #
+    # Enable LZ4 compression and set the recordsize to 8KB on the top-level
+    # delegated dataset.  The Manatee dataset is a child dataset, and will
+    # inherit these properties -- even if it is subsequently recreated by a
+    # rebuild operation.
+    #
+    echo "enabling LZ4 compression on manatee dataset"
+    zfs set compress=lz4 "$PARENT_DATASET"
+
+    echo "setting recordsize to 8K on manatee dataset"
+    zfs set recordsize=8k "$PARENT_DATASET"
+
     # create manatee dataset
     echo "creating manatee dataset"
     zfs create -o canmount=noauto $DATASET
@@ -93,9 +105,13 @@ function common_manatee_setup {
     echo "make snapdir property match the ancestor's"
     zfs inherit -r snapdir $DATASET
 
+    # create postgres group
+    echo "creating postgres group (gid=907)"
+    groupadd -g 907 postgres
+
     # create postgres user
-    echo "creating postgres user"
-    useradd postgres
+    echo "creating postgres user (uid=907)"
+    useradd -u 907 -g postgres postgres
 
     # grant postgres user chmod chown privileges with sudo
     echo "postgres    ALL=(ALL) NOPASSWD: /usr/bin/chown, /usr/bin/chmod, /opt/local/bin/chown, /opt/local/bin/chmod" >> /opt/local/etc/sudoers
@@ -131,7 +147,7 @@ function add_manatee_profile_functions {
     ZK_IPS=${BINDER_ADMIN_IPS}
 
     #.bashrc
-    echo "export PATH=\$PATH:/opt/smartdc/manatee/bin/:/opt/smartdc/manatee/pg_dump/:/opt/smartdc/manatee/node_modules/manatee/bin" >>/root/.bashrc
+    echo "export PATH=\$PATH:/opt/smartdc/manatee/bin/:/opt/smartdc/manatee/pg_dump/:/opt/smartdc/manatee/node_modules/manatee/bin:/opt/postgresql/current/bin" >> /root/.bashrc
     echo "export MANPATH=\$MANPATH:/opt/smartdc/manatee/node_modules/manatee/man" >> /root/.bashrc
 
     # get correct ZK_IPS
diff --git a/deps/pg_repack b/deps/pg_repack
new file mode 160000
index 0000000..20f5bf4
--- /dev/null
+++ b/deps/pg_repack
@@ -0,0 +1 @@
+Subproject commit 20f5bf4878317143963f6cbeadbe520b4ef4b195
diff --git a/deps/postgresql92 b/deps/postgresql92
new file mode 160000
index 0000000..73c1227
--- /dev/null
+++ b/deps/postgresql92
@@ -0,0 +1 @@
+Subproject commit 73c122769ca1f49c451e315d476c80fdcf9f20cc
diff --git a/deps/postgresql96 b/deps/postgresql96
new file mode 160000
index 0000000..563881d
--- /dev/null
+++ b/deps/postgresql96
@@ -0,0 +1 @@
+Subproject commit 563881d704954a95174be84330af3e218e30143b
diff --git a/etc/pg_hba.conf b/etc/9.2/pg_hba.conf
similarity index 100%
rename from etc/pg_hba.conf
rename to etc/9.2/pg_hba.conf
diff --git a/etc/postgresql.sdc.conf b/etc/9.2/postgresql.sdc.conf
similarity index 98%
rename from etc/postgresql.sdc.conf
rename to etc/9.2/postgresql.sdc.conf
index ae20e6c..cc02534 100644
--- a/etc/postgresql.sdc.conf
+++ b/etc/9.2/postgresql.sdc.conf
@@ -96,12 +96,12 @@ max_connections = 1000     # (change requires restart)
 # - TCP Keepalives -
 # see "man 7 tcp" for details
 
-#tcp_keepalives_idle = 0    # TCP_KEEPIDLE, in seconds;
-          # 0 selects the system default
-#tcp_keepalives_interval = 0    # TCP_KEEPINTVL, in seconds;
-          # 0 selects the system default
-#tcp_keepalives_count = 0   # TCP_KEEPCNT;
-          # 0 selects the system default
+tcp_keepalives_idle = 15                # TCP_KEEPIDLE, in seconds;
+                                        # 0 selects the system default
+tcp_keepalives_interval = 3             # TCP_KEEPINTVL, in seconds;
+                                        # 0 selects the system default
+tcp_keepalives_count = 5                # TCP_KEEPCNT;
+                                        # 0 selects the system default
 
 
 #------------------------------------------------------------------------------
diff --git a/etc/recovery.conf b/etc/9.2/recovery.conf
similarity index 100%
rename from etc/recovery.conf
rename to etc/9.2/recovery.conf
diff --git a/etc/9.6/pg_hba.conf b/etc/9.6/pg_hba.conf
new file mode 100644
index 0000000..5106bc0
--- /dev/null
+++ b/etc/9.6/pg_hba.conf
@@ -0,0 +1,98 @@
+# PostgreSQL Client Authentication Configuration File
+# ===================================================
+#
+# Refer to the "Client Authentication" section in the PostgreSQL
+# documentation for a complete description of this file.  A short
+# synopsis follows.
+#
+# This file controls: which hosts are allowed to connect, how clients
+# are authenticated, which PostgreSQL user names they can use, which
+# databases they can access.  Records take one of these forms:
+#
+# local      DATABASE  USER  METHOD  [OPTIONS]
+# host       DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
+# hostssl    DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
+# hostnossl  DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
+#
+# (The uppercase items must be replaced by actual values.)
+#
+# The first field is the connection type: "local" is a Unix-domain
+# socket, "host" is either a plain or SSL-encrypted TCP/IP socket,
+# "hostssl" is an SSL-encrypted TCP/IP socket, and "hostnossl" is a
+# plain TCP/IP socket.
+#
+# DATABASE can be "all", "sameuser", "samerole", "replication", a
+# database name, or a comma-separated list thereof. The "all"
+# keyword does not match "replication". Access to replication
+# must be enabled in a separate record (see example below).
+#
+# USER can be "all", a user name, a group name prefixed with "+", or a
+# comma-separated list thereof.  In both the DATABASE and USER fields
+# you can also write a file name prefixed with "@" to include names
+# from a separate file.
+#
+# ADDRESS specifies the set of hosts the record matches.  It can be a
+# host name, or it is made up of an IP address and a CIDR mask that is
+# an integer (between 0 and 32 (IPv4) or 128 (IPv6) inclusive) that
+# specifies the number of significant bits in the mask.  A host name
+# that starts with a dot (.) matches a suffix of the actual host name.
+# Alternatively, you can write an IP address and netmask in separate
+# columns to specify the set of hosts.  Instead of a CIDR-address, you
+# can write "samehost" to match any of the server's own IP addresses,
+# or "samenet" to match any address in any subnet that the server is
+# directly connected to.
+#
+# METHOD can be "trust", "reject", "md5", "password", "gss", "sspi",
+# "krb5", "ident", "peer", "pam", "ldap", "radius" or "cert".  Note that
+# "password" sends passwords in clear text; "md5" is preferred since
+# it sends encrypted passwords.
+#
+# OPTIONS are a set of options for the authentication in the format
+# NAME=VALUE.  The available options depend on the different
+# authentication methods -- refer to the "Client Authentication"
+# section in the documentation for a list of which options are
+# available for which authentication methods.
+#
+# Database and user names containing spaces, commas, quotes and other
+# special characters must be quoted.  Quoting one of the keywords
+# "all", "sameuser", "samerole" or "replication" makes the name lose
+# its special character, and just match a database or username with
+# that name.
+#
+# This file is read on server startup and when the postmaster receives
+# a SIGHUP signal.  If you edit the file on a running system, you have
+# to SIGHUP the postmaster for the changes to take effect.  You can
+# use "pg_ctl reload" to do that.
+
+# Put your actual configuration here
+# ----------------------------------
+#
+# If you want to allow non-local connections, you need to add more
+# "host" records.  In that case you will also need to make PostgreSQL
+# listen on a non-local interface via the listen_addresses
+# configuration parameter, or via the -i or -h command line switches.
+
+# CAUTION: Configuring the system for local "trust" authentication
+# allows any local user to connect as any PostgreSQL user, including
+# the database superuser.  If you do not trust all your local users,
+# use another authentication method.
+
+
+# TYPE  DATABASE        USER            ADDRESS                 METHOD
+
+# "local" is for Unix domain socket connections only
+local   all             all                                     trust
+# IPv4 local connections:
+host    all             all             127.0.0.1/32            trust
+host    all             all             0.0.0.0/0               trust
+# IPv6 local connections:
+host    all             all             ::1/128                 trust
+# Allow replication connections from localhost, by a user with the
+# replication privilege.
+local   replication     admin                                trust
+host    replication     admin        127.0.0.1/32            trust
+host    replication     admin        ::1/128                 trust
+host    replication     admin        all                     trust
+host    replication     all           0.0.0.0/0         trust
+host    replication     all          0.0.0.0/0          trust
+host    replication     all          127.0.0.1/32            trust
diff --git a/etc/9.6/postgresql.sdc.conf b/etc/9.6/postgresql.sdc.conf
new file mode 100644
index 0000000..be27dca
--- /dev/null
+++ b/etc/9.6/postgresql.sdc.conf
@@ -0,0 +1,656 @@
+# -----------------------------
+# PostgreSQL configuration file
+# -----------------------------
+#
+# This file consists of lines of the form:
+#
+#   name = value
+#
+# (The "=" is optional.)  Whitespace may be used.  Comments are introduced with
+# "#" anywhere on a line.  The complete list of parameter names and allowed
+# values can be found in the PostgreSQL documentation.
+#
+# The commented-out settings shown in this file represent the default values.
+# Re-commenting a setting is NOT sufficient to revert it to the default value;
+# you need to reload the server.
+#
+# This file is read on server startup and when the server receives a SIGHUP
+# signal.  If you edit the file on a running system, you have to SIGHUP the
+# server for the changes to take effect, or use "pg_ctl reload".  Some
+# parameters, which are marked below, require a server shutdown and restart to
+# take effect.
+#
+# Any parameter can also be given as a command-line option to the server, e.g.,
+# "postgres -c log_connections=on".  Some parameters can be changed at run time
+# with the "SET" SQL command.
+#
+# Memory units:  kB = kilobytes        Time units:  ms  = milliseconds
+#                MB = megabytes                     s   = seconds
+#                GB = gigabytes                     min = minutes
+#                TB = terabytes                     h   = hours
+#                                                   d   = days
+
+
+#------------------------------------------------------------------------------
+# FILE LOCATIONS
+#------------------------------------------------------------------------------
+
+# The default values of these variables are driven from the -D command-line
+# option or PGDATA environment variable, represented here as ConfigDir.
+
+#data_directory = 'ConfigDir'           # use data in another directory
+                                        # (change requires restart)
+#hba_file = 'ConfigDir/pg_hba.conf'     # host-based authentication file
+                                        # (change requires restart)
+#ident_file = 'ConfigDir/pg_ident.conf' # ident configuration file
+                                        # (change requires restart)
+
+# If external_pid_file is not explicitly set, no extra PID file is written.
+#external_pid_file = ''                 # write an extra PID file
+                                        # (change requires restart)
+
+
+#------------------------------------------------------------------------------
+# CONNECTIONS AND AUTHENTICATION
+#------------------------------------------------------------------------------
+
+# - Connection Settings -
+
+listen_addresses = '0.0.0.0'            # what IP address(es) to listen on;
+                                        # comma-separated list of addresses;
+                                        # defaults to 'localhost'; use '*' for all
+                                        # (change requires restart)
+port = 5432                             # (change requires restart)
+max_connections = 1000                  # (change requires restart)
+# Note:  Increasing max_connections costs ~400 bytes of shared memory per
+# connection slot, plus lock space (see max_locks_per_transaction).
+#superuser_reserved_connections = 3     # (change requires restart)
+#unix_socket_directories = '/tmp'       # comma-separated list of directories
+                                        # (change requires restart)
+#unix_socket_group = ''                 # (change requires restart)
+#unix_socket_permissions = 0777         # begin with 0 to use octal notation
+                                        # (change requires restart)
+#bonjour = off                          # advertise server via Bonjour
+                                        # (change requires restart)
+#bonjour_name = ''                      # defaults to the computer name
+                                        # (change requires restart)
+
+# - Security and Authentication -
+
+#authentication_timeout = 1min          # 1s-600s
+#ssl = off                              # (change requires restart)
+#ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL' # allowed SSL ciphers
+                                        # (change requires restart)
+#ssl_prefer_server_ciphers = on         # (change requires restart)
+#ssl_ecdh_curve = 'prime256v1'          # (change requires restart)
+#ssl_cert_file = 'server.crt'           # (change requires restart)
+#ssl_key_file = 'server.key'            # (change requires restart)
+#ssl_ca_file = ''                       # (change requires restart)
+#ssl_crl_file = ''                      # (change requires restart)
+#password_encryption = on
+#db_user_namespace = off
+#row_security = on
+
+# GSSAPI using Kerberos
+#krb_server_keyfile = ''
+#krb_caseins_users = off
+
+# - TCP Keepalives -
+# see "man 7 tcp" for details
+
+tcp_keepalives_idle = 15                # TCP_KEEPIDLE, in seconds;
+                                        # 0 selects the system default
+tcp_keepalives_interval = 3             # TCP_KEEPINTVL, in seconds;
+                                        # 0 selects the system default
+tcp_keepalives_count = 5                # TCP_KEEPCNT;
+                                        # 0 selects the system default
+
+
+#------------------------------------------------------------------------------
+# RESOURCE USAGE (except WAL)
+#------------------------------------------------------------------------------
+
+# - Memory -
+
+shared_buffers = @@SHARED_BUFFERS@@     # min 128kB
+                                        # (change requires restart)
+#huge_pages = try                       # on, off, or try
+                                        # (change requires restart)
+#temp_buffers = 8MB                     # min 800kB
+#max_prepared_transactions = 0          # zero disables the feature
+                                        # (change requires restart)
+# Caution: it is not advisable to set max_prepared_transactions nonzero unless
+# you actively intend to use prepared transactions.
+#work_mem = 4MB                         # min 64kB
+maintenance_work_mem = @@MAINTENANCE_WORK_MEM@@    # min 1MB
+#replacement_sort_tuples = 150000       # limits use of replacement selection sort
+#autovacuum_work_mem = -1               # min 1MB, or -1 to use maintenance_work_mem
+#max_stack_depth = 2MB                  # min 100kB
+shared_memory_type = sysv               # the default is the first option
+                                        # supported by the operating system:
+                                        #   mmap
+                                        #   sysv
+                                        #   windows
+dynamic_shared_memory_type = sysv       # the default is the first option
+                                        # supported by the operating system:
+                                        #   posix
+                                        #   sysv
+                                        #   windows
+                                        #   mmap
+                                        # use none to disable dynamic shared memory
+
+# - Disk -
+
+#temp_file_limit = -1                   # limits per-process temp file space
+                                        # in kB, or -1 for no limit
+
+# - Kernel Resource Usage -
+
+#max_files_per_process = 1000           # min 25
+                                        # (change requires restart)
+shared_preload_libraries = 'auto_explain,pg_buffercache,pg_freespacemap,pg_stat_statements,pg_visibility,pgstattuple' # (change requires restart)
+
+# - Cost-Based Vacuum Delay -
+
+#vacuum_cost_delay = 0                  # 0-100 milliseconds
+#vacuum_cost_page_hit = 1               # 0-10000 credits
+#vacuum_cost_page_miss = 10             # 0-10000 credits
+#vacuum_cost_page_dirty = 20            # 0-10000 credits
+#vacuum_cost_limit = 200                # 1-10000 credits
+
+# - Background Writer -
+
+#bgwriter_delay = 200ms                 # 10-10000ms between rounds
+#bgwriter_lru_maxpages = 100            # 0-1000 max buffers written/round
+#bgwriter_lru_multiplier = 2.0          # 0-10.0 multiplier on buffers scanned/round
+#bgwriter_flush_after = 0               # measured in pages, 0 disables
+
+# - Asynchronous Behavior -
+
+#effective_io_concurrency = 1           # 1-1000; 0 disables prefetching
+#max_worker_processes = 8               # (change requires restart)
+#max_parallel_workers_per_gather = 0    # taken from max_worker_processes
+#old_snapshot_threshold = -1            # 1min-60d; -1 disables; 0 is immediate
+                                        # (change requires restart)
+#backend_flush_after = 0                # measured in pages, 0 disables
+
+
+#------------------------------------------------------------------------------
+# WRITE AHEAD LOG
+#------------------------------------------------------------------------------
+
+# - Settings -
+
+wal_level = hot_standby                 # minimal, archive, or hot_standby
+                                        # (change requires restart)
+fsync = on                              # turns forced synchronization on or off
+                                                # (turning this off can cause
+                                                # unrecoverable data corruption)
+synchronous_commit = on                 # synchronization level;
+                                        # off, local, remote_write, remote_apply, or on
+#wal_sync_method = fsync                # the default is the first option
+                                        # supported by the operating system:
+                                        #   open_datasync
+                                        #   fdatasync (default on Linux)
+                                        #   fsync
+                                        #   fsync_writethrough
+                                        #   open_sync
+# Not neccessary on ZFS, see http://www.postgresql.org/docs/current/static/wal-reliability.html
+full_page_writes = off                  # recover from partial page writes
+#wal_compression = off                  # enable compression of full-page writes
+#wal_log_hints = off                    # also do full page writes of non-critical updates
+                                        # (change requires restart)
+#wal_buffers = -1                       # min 32kB, -1 sets based on shared_buffers
+                                        # (change requires restart)
+#wal_writer_delay = 200ms               # 1-10000 milliseconds
+#wal_writer_flush_after = 1MB           # measured in pages, 0 disables
+
+#commit_delay = 0                       # range 0-100000, in microseconds
+#commit_siblings = 5                    # range 1-1000
+
+# - Checkpoints -
+
+checkpoint_timeout = 30s                # range 30s-1h
+max_wal_size = 480MB
+#min_wal_size = 80MB
+#checkpoint_completion_target = 0.5     # checkpoint target duration, 0.0 - 1.0
+#checkpoint_flush_after = 0             # measured in pages, 0 disables
+#checkpoint_warning = 30s               # 0 disables
+
+# - Archiving -
+
+#archive_mode = off             # enables archiving; off, on, or always
+                                # (change requires restart)
+#archive_command = ''           # command to use to archive a logfile segment
+                                # placeholders: %p = path of file to archive
+                                #               %f = file name only
+                                # e.g. 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'
+#archive_timeout = 0            # force a logfile segment switch after this
+                                # number of seconds; 0 disables
+
+
+#------------------------------------------------------------------------------
+# REPLICATION
+#------------------------------------------------------------------------------
+
+# - Sending Server(s) -
+
+# Set these on the master and on any standby that will send replication data.
+
+max_wal_senders = 15            # max number of walsender processes
+                                # (change requires restart)
+wal_keep_segments = 1000        # in logfile segments, 16MB each; 0 disables
+#wal_sender_timeout = 60s       # in milliseconds; 0 disables
+
+#max_replication_slots = 0      # max number of replication slots
+                                # (change requires restart)
+#track_commit_timestamp = off   # collect timestamp of transaction commit
+                                # (change requires restart)
+
+# - Master Server -
+
+# These settings are ignored on a standby server.
+
+synchronous_standby_names = ''  # standby servers that provide sync rep
+                                # number of sync standbys and comma-separated list of application_name
+                                # from standby(s); '*' = all
+#vacuum_defer_cleanup_age = 0   # number of xacts by which cleanup is delayed
+
+# - Standby Servers -
+
+# These settings are ignored on a master server.
+
+hot_standby = on                        # "on" allows queries during recovery
+                                        # (change requires restart)
+max_standby_archive_delay = 30s         # max delay before canceling queries
+                                        # when reading WAL from archive;
+                                        # -1 allows indefinite delay
+max_standby_streaming_delay = 30s       # max delay before canceling queries
+                                        # when reading streaming WAL;
+                                        # -1 allows indefinite delay
+wal_receiver_status_interval = 10s      # send replies at least this often
+                                        # 0 disables
+hot_standby_feedback = off              # send info from standby to prevent
+                                        # query conflicts
+#wal_receiver_timeout = 60s             # time that receiver waits for
+                                        # communication from master
+                                        # in milliseconds; 0 disables
+#wal_retrieve_retry_interval = 5s       # time to wait before retrying to
+                                        # retrieve WAL after a failed attempt
+
+
+#------------------------------------------------------------------------------
+# QUERY TUNING
+#------------------------------------------------------------------------------
+
+# - Planner Method Configuration -
+
+#enable_bitmapscan = on
+#enable_hashagg = on
+#enable_hashjoin = on
+#enable_indexscan = on
+#enable_indexonlyscan = on
+#enable_material = on
+#enable_mergejoin = on
+#enable_nestloop = on
+#enable_seqscan = on
+#enable_sort = on
+#enable_tidscan = on
+
+# - Planner Cost Constants -
+
+#seq_page_cost = 1.0                    # measured on an arbitrary scale
+#random_page_cost = 4.0                 # same scale as above
+#cpu_tuple_cost = 0.01                  # same scale as above
+#cpu_index_tuple_cost = 0.005           # same scale as above
+#cpu_operator_cost = 0.0025             # same scale as above
+#parallel_tuple_cost = 0.1              # same scale as above
+#parallel_setup_cost = 1000.0   # same scale as above
+#min_parallel_relation_size = 8MB
+#effective_cache_size = 4GB
+
+# - Genetic Query Optimizer -
+
+#geqo = on
+#geqo_threshold = 12
+#geqo_effort = 5                        # range 1-10
+#geqo_pool_size = 0                     # selects default based on effort
+#geqo_generations = 0                   # selects default based on effort
+#geqo_selection_bias = 2.0              # range 1.5-2.0
+#geqo_seed = 0.0                        # range 0.0-1.0
+
+# - Other Planner Options -
+
+#default_statistics_target = 100        # range 1-10000
+#constraint_exclusion = partition       # on, off, or partition
+#cursor_tuple_fraction = 0.1            # range 0.0-1.0
+#from_collapse_limit = 8
+#join_collapse_limit = 8                # 1 disables collapsing of explicit
+                                        # JOIN clauses
+#force_parallel_mode = off
+
+
+#------------------------------------------------------------------------------
+# ERROR REPORTING AND LOGGING
+#------------------------------------------------------------------------------
+
+# - Where to Log -
+
+log_destination = 'stderr'              # Valid values are combinations of
+                                        # stderr, csvlog, syslog, and eventlog,
+                                        # depending on platform.  csvlog
+                                        # requires logging_collector to be on.
+
+# This is used when logging to stderr:
+logging_collector = on                  # Enable capturing of stderr and csvlog
+                                        # into log files. Required to be on for
+                                        # csvlogs.
+                                        # (change requires restart)
+
+# These are only used if logging_collector is on:
+log_directory = '/var/pg/'              # directory where log files are written,
+                                        # can be absolute or relative to PGDATA
+log_filename = 'postgresql.log'         # log file name pattern,
+                                        # can include strftime() escapes
+log_file_mode = 0600                    # creation mode for log files,
+                                        # begin with 0 to use octal notation
+#log_truncate_on_rotation = off         # If on, an existing log file with the
+                                        # same name as the new log file will be
+                                        # truncated rather than appended to.
+                                        # But such truncation only occurs on
+                                        # time-driven rotation, not on restarts
+                                        # or size-driven rotation.  Default is
+                                        # off, meaning append to existing files
+                                        # in all cases.
+log_rotation_age = 0                    # Automatic rotation of logfiles will
+                                        # happen after that time.  0 disables.
+log_rotation_size = 0                   # Automatic rotation of logfiles will
+                                        # happen after that much log output.
+                                        # 0 disables.
+
+# These are relevant when logging to syslog:
+#syslog_facility = 'LOCAL0'
+#syslog_ident = 'postgres'
+#syslog_sequence_numbers = on
+#syslog_split_messages = on
+
+# This is only relevant when logging to eventlog (win32):
+#event_source = 'PostgreSQL'
+
+# - When to Log -
+
+#client_min_messages = notice           # values in order of decreasing detail:
+                                        #   debug5
+                                        #   debug4
+                                        #   debug3
+                                        #   debug2
+                                        #   debug1
+                                        #   log
+                                        #   notice
+                                        #   warning
+                                        #   error
+
+log_min_messages = error                # values in order of decreasing detail:
+                                        #   debug5
+                                        #   debug4
+                                        #   debug3
+                                        #   debug2
+                                        #   debug1
+                                        #   info
+                                        #   notice
+                                        #   warning
+                                        #   error
+                                        #   log
+                                        #   fatal
+                                        #   panic
+
+#log_min_error_statement = error        # values in order of decreasing detail:
+                                        #   debug5
+                                        #   debug4
+                                        #   debug3
+                                        #   debug2
+                                        #   debug1
+                                        #   info
+                                        #   notice
+                                        #   warning
+                                        #   error
+                                        #   log
+                                        #   fatal
+                                        #   panic (effectively off)
+
+#log_min_duration_statement = -1        # -1 is disabled, 0 logs all statements
+                                        # and their durations, > 0 logs only
+                                        # statements running at least this number
+                                        # of milliseconds
+
+
+# - What to Log -
+
+#debug_print_parse = off
+#debug_print_rewritten = off
+#debug_print_plan = off
+#debug_pretty_print = on
+#log_checkpoints = off
+#log_connections = off
+#log_disconnections = off
+#log_duration = off
+#log_error_verbosity = default          # terse, default, or verbose messages
+#log_hostname = off
+log_line_prefix = '%m'                  # special values:
+                                        #   %a = application name
+                                        #   %u = user name
+                                        #   %d = database name
+                                        #   %r = remote host and port
+                                        #   %h = remote host
+                                        #   %p = process ID
+                                        #   %t = timestamp without milliseconds
+                                        #   %m = timestamp with milliseconds
+                                        #   %n = timestamp with milliseconds (as a Unix epoch)
+                                        #   %i = command tag
+                                        #   %e = SQL state
+                                        #   %c = session ID
+                                        #   %l = session line number
+                                        #   %s = session start timestamp
+                                        #   %v = virtual transaction ID
+                                        #   %x = transaction ID (0 if none)
+                                        #   %q = stop here in non-session
+                                        #        processes
+                                        #   %% = '%'
+                                        # e.g. '<%u%%%d> '
+#log_lock_waits = off                   # log lock waits >= deadlock_timeout
+#log_statement = 'none'                 # none, ddl, mod, all
+#log_replication_commands = off
+#log_temp_files = -1                    # log temporary files equal or larger
+                                        # than the specified size in kilobytes;
+                                        # -1 disables, 0 logs all temp files
+log_timezone = 'UTC'
+
+
+# - Process Title -
+
+#cluster_name = ''                      # added to process titles if nonempty
+                                        # (change requires restart)
+#update_process_title = on
+
+
+#------------------------------------------------------------------------------
+# RUNTIME STATISTICS
+#------------------------------------------------------------------------------
+
+# - Query/Index Statistics Collector -
+
+#track_activities = on
+#track_counts = on
+#track_io_timing = off
+#track_functions = none                 # none, pl, all
+#track_activity_query_size = 1024       # (change requires restart)
+#stats_temp_directory = 'pg_stat_tmp'
+
+
+# - Statistics Monitoring -
+
+#log_parser_stats = off
+#log_planner_stats = off
+#log_executor_stats = off
+#log_statement_stats = off
+
+
+#------------------------------------------------------------------------------
+# AUTOVACUUM PARAMETERS
+#------------------------------------------------------------------------------
+
+#autovacuum = on                        # Enable autovacuum subprocess?  'on'
+                                        # requires track_counts to also be on.
+#log_autovacuum_min_duration = -1       # -1 disables, 0 logs all actions and
+                                        # their durations, > 0 logs only
+                                        # actions running at least this number
+                                        # of milliseconds.
+log_autovacuum_min_duration = 1000
+          # set to 1 second to log any vacuum operations that take longer than
+          # a second. Per Pg High Perf page 163
+#autovacuum_max_workers = 3             # max number of autovacuum subprocesses
+                                        # (change requires restart)
+#autovacuum_naptime = 1min              # time between autovacuum runs
+#autovacuum_vacuum_threshold = 50       # min number of row updates before
+                                        # vacuum
+#autovacuum_analyze_threshold = 50      # min number of row updates before
+                                        # analyze
+#autovacuum_vacuum_scale_factor = 0.2   # fraction of table size before vacuum
+autovacuum_analyze_scale_factor = 0.01  # fraction of table size before analyze
+#autovacuum_freeze_max_age = 200000000  # maximum XID age before forced vacuum
+autovacuum_freeze_max_age = 500000000   # maximum XID age before forced vacuum
+                                        # (change requires restart)
+#autovacuum_multixact_freeze_max_age = 400000000        # maximum multixact age
+                                        # before forced vacuum
+                                        # (change requires restart)
+autovacuum_vacuum_cost_delay = 10ms     # default vacuum cost delay for
+                                        # autovacuum, in milliseconds;
+                                        # -1 means use vacuum_cost_delay
+autovacuum_vacuum_cost_limit = 1000     # default vacuum cost limit for
+                                        # autovacuum, -1 means use
+                                        # vacuum_cost_limit
+
+
+#------------------------------------------------------------------------------
+# CLIENT CONNECTION DEFAULTS
+#------------------------------------------------------------------------------
+
+# - Statement Behavior -
+
+#search_path = '"$user", public'        # schema names
+#default_tablespace = ''                # a tablespace name, '' uses the default
+#temp_tablespaces = ''                  # a list of tablespace names, '' uses
+                                        # only default tablespace
+#check_function_bodies = on
+#default_transaction_isolation = 'read committed'
+#default_transaction_read_only = off
+#default_transaction_deferrable = off
+#session_replication_role = 'origin'
+#statement_timeout = 0                  # in milliseconds, 0 is disabled
+#lock_timeout = 0                       # in milliseconds, 0 is disabled
+#idle_in_transaction_session_timeout = 0                # in milliseconds, 0 is disabled
+#vacuum_freeze_min_age = 50000000
+#vacuum_freeze_table_age = 150000000
+#vacuum_multixact_freeze_min_age = 5000000
+#vacuum_multixact_freeze_table_age = 150000000
+#bytea_output = 'hex'                   # hex, escape
+#xmlbinary = 'base64'
+#xmloption = 'content'
+#gin_fuzzy_search_limit = 0
+#gin_pending_list_limit = 4MB
+
+# - Locale and Formatting -
+
+datestyle = 'iso, mdy'
+#intervalstyle = 'postgres'
+timezone = 'UTC'
+#timezone_abbreviations = 'Default'     # Select the set of available time zone
+                                        # abbreviations.  Currently, there are
+                                        #   Default
+                                        #   Australia (historical usage)
+                                        #   India
+                                        # You can create your own file in
+                                        # share/timezonesets/.
+#extra_float_digits = 0                 # min -15, max 3
+#client_encoding = sql_ascii            # actually, defaults to database
+                                        # encoding
+
+# These settings are initialized by initdb, but they can be changed.
+lc_messages = 'C'                       # locale for system error message
+                                        # strings
+lc_monetary = 'C'                       # locale for monetary formatting
+lc_numeric = 'C'                        # locale for number formatting
+lc_time = 'C'                           # locale for time formatting
+
+# default configuration for text search
+default_text_search_config = 'pg_catalog.english'
+
+# - Other Defaults -
+
+#dynamic_library_path = '$libdir'
+#local_preload_libraries = ''
+#session_preload_libraries = ''
+
+
+#------------------------------------------------------------------------------
+# LOCK MANAGEMENT
+#------------------------------------------------------------------------------
+
+#deadlock_timeout = 1s
+#max_locks_per_transaction = 64         # min 10
+                                        # (change requires restart)
+# Note:  Each lock table slot uses ~270 bytes of shared memory, and there are
+# max_locks_per_transaction * (max_connections + max_prepared_transactions)
+# lock table slots.
+#max_pred_locks_per_transaction = 64    # min 10
+                                        # (change requires restart)
+
+
+#------------------------------------------------------------------------------
+# VERSION/PLATFORM COMPATIBILITY
+#------------------------------------------------------------------------------
+
+# - Previous PostgreSQL Versions -
+
+#array_nulls = on
+#backslash_quote = safe_encoding        # on, off, or safe_encoding
+#default_with_oids = off
+#escape_string_warning = on
+#lo_compat_privileges = off
+#operator_precedence_warning = off
+#quote_all_identifiers = off
+#sql_inheritance = on
+#standard_conforming_strings = on
+#synchronize_seqscans = on
+
+# - Other Platforms and Clients -
+
+#transform_null_equals = off
+
+
+#------------------------------------------------------------------------------
+# ERROR HANDLING
+#------------------------------------------------------------------------------
+
+#exit_on_error = off                    # terminate session on any error?
+#restart_after_crash = on               # reinitialize after backend crash?
+
+
+#------------------------------------------------------------------------------
+# CONFIG FILE INCLUDES
+#------------------------------------------------------------------------------
+
+# These options allow settings to be loaded from files other than the
+# default postgresql.conf.
+
+#include_dir = 'conf.d'                 # include files ending in '.conf' from
+                                        # directory 'conf.d'
+#include_if_exists = 'exists.conf'      # include file only if it exists
+#include = 'special.conf'               # include file
+
+
+#------------------------------------------------------------------------------
+# CUSTOMIZED OPTIONS
+#------------------------------------------------------------------------------
+
+# Add settings for extensions here
diff --git a/etc/9.6/recovery.conf b/etc/9.6/recovery.conf
new file mode 100644
index 0000000..963f523
--- /dev/null
+++ b/etc/9.6/recovery.conf
@@ -0,0 +1,134 @@
+# -------------------------------
+# PostgreSQL recovery config file
+# -------------------------------
+#
+# Edit this file to provide the parameters that PostgreSQL needs to
+# perform an archive recovery of a database, or to act as a replication
+# standby.
+#
+# If "recovery.conf" is present in the PostgreSQL data directory, it is
+# read on postmaster startup.  After successful recovery, it is renamed
+# to "recovery.done" to ensure that we do not accidentally re-enter
+# archive recovery or standby mode.
+#
+# This file consists of lines of the form:
+#
+#   name = value
+#
+# Comments are introduced with '#'.
+#
+# The complete list of option names and allowed values can be found
+# in the PostgreSQL documentation.
+#
+#---------------------------------------------------------------------------
+# ARCHIVE RECOVERY PARAMETERS
+#---------------------------------------------------------------------------
+#
+# restore_command
+#
+# specifies the shell command that is executed to copy log files
+# back from archival storage.  The command string may contain %f,
+# which is replaced by the name of the desired log file, and %p,
+# which is replaced by the absolute path to copy the log file to.
+#
+# This parameter is *required* for an archive recovery, but optional
+# for streaming replication.
+#
+# It is important that the command return nonzero exit status on failure.
+# The command *will* be asked for log files that are not present in the
+# archive; it must return nonzero when so asked.
+#
+# NOTE that the basename of %p will be different from %f; do not
+# expect them to be interchangeable.
+#
+#restore_command = 'cp /opt/postgres/server/archiveddir/%f %p'		# e.g. 'cp /mnt/server/archivedir/%f %p'
+#
+#
+# archive_cleanup_command
+#
+# specifies an optional shell command to execute at every restartpoint.
+# This can be useful for cleaning up the archive of a standby server.
+#
+#TODO: Uncomment this when running on seperate boxes.
+#archive_cleanup_command = 'pg_archivecleanup /opt/postgres/server/archiveddir/%f %r'
+#
+# recovery_end_command
+#
+# specifies an optional shell command to execute at completion of recovery.
+# This can be useful for cleaning up after the restore_command.
+#
+#recovery_end_command = ''
+#
+#---------------------------------------------------------------------------
+# RECOVERY TARGET PARAMETERS
+#---------------------------------------------------------------------------
+#
+# By default, recovery will rollforward to the end of the WAL log.
+# If you want to stop rollforward at a specific point, you
+# must set a recovery target.
+#
+# You may set a recovery target either by transactionId, by name,
+# or by timestamp. Recovery may either include or exclude the
+# transaction(s) with the recovery target value (ie, stop either
+# just after or just before the given target, respectively).
+#
+#
+#recovery_target_name = ''  # e.g. 'daily backup 2011-01-26'
+#
+#recovery_target_time = ''	# e.g. '2004-07-14 22:39:00 EST'
+#
+#recovery_target_xid = ''
+#
+#recovery_target_inclusive = true
+#
+#
+# If you want to recover into a timeline other than the "main line" shown in
+# pg_control, specify the timeline number here, or write 'latest' to get
+# the latest branch for which there's a history file.
+#
+#recovery_target_timeline = 'latest'
+#
+#
+# If pause_at_recovery_target is enabled, recovery will pause when
+# the recovery target is reached. The pause state will continue until
+# pg_xlog_replay_resume() is called. This setting has no effect if
+# hot standby is not enabled, or if no recovery target is set.
+#
+#pause_at_recovery_target = true
+#
+#---------------------------------------------------------------------------
+# STANDBY SERVER PARAMETERS
+#---------------------------------------------------------------------------
+#
+# standby_mode
+#
+# When standby_mode is enabled, the PostgreSQL server will work as a
+# standby. It will continuously wait for the additional XLOG records, using
+# restore_command and/or primary_conninfo.
+#
+standby_mode = on
+#
+# primary_conninfo
+#
+# If set, the PostgreSQL server will try to connect to the primary using this
+# connection string and receive XLOG records continuously.
+#
+primary_conninfo = 'host=0.0.0.0 port=5432 user=postgres application_name=standby'
+		# e.g. 'host=localhost port=5432'
+#
+#
+# By default, a standby server keeps restoring XLOG records from the
+# primary indefinitely. If you want to stop the standby mode, finish recovery
+# and open the system in read/write mode, specify path to a trigger file.
+# The server will poll the trigger file path periodically and start as a
+# primary server when it's found.
+#
+#trigger_file = ''
+#
+#---------------------------------------------------------------------------
+# HOT STANDBY PARAMETERS
+#---------------------------------------------------------------------------
+#
+# Hot Standby related parameters are listed in postgresql.conf
+#
+#---------------------------------------------------------------------------
diff --git a/package.json b/package.json
index bfd162e..e11973f 100644
--- a/package.json
+++ b/package.json
@@ -13,7 +13,7 @@
     },
     "dependencies": {
         "carrier": "0.2.0",
-        "manatee": "git+https://github.com/joyent/manatee.git#5e4ab2c6cc25849cce78c35a4f5cef5a74a26a69"
+        "manatee": "git+https://github.com/joyent/manatee.git#6a769d97"
     },
     "sdcDependencies": {
         "config-agent": ">=1.2.0"
diff --git a/sapi_manifests/pg_overrides/manifest.json b/sapi_manifests/pg_overrides/manifest.json
new file mode 100644
index 0000000..f0ef381
--- /dev/null
+++ b/sapi_manifests/pg_overrides/manifest.json
@@ -0,0 +1,4 @@
+{
+    "name": "pg_overrides",
+    "path": "/opt/smartdc/manatee/etc/pg_overrides.json"
+}
diff --git a/sapi_manifests/pg_overrides/template b/sapi_manifests/pg_overrides/template
new file mode 100644
index 0000000..ce52ae1
--- /dev/null
+++ b/sapi_manifests/pg_overrides/template
@@ -0,0 +1,8 @@
+{{#PG_CONFIG_OVERRIDES}}
+{{{PG_CONFIG_OVERRIDES}}}
+{{/PG_CONFIG_OVERRIDES}}
+{{^PG_CONFIG_OVERRIDES}}
+{
+
+}
+{{/PG_CONFIG_OVERRIDES}}
diff --git a/sapi_manifests/sitter/template b/sapi_manifests/sitter/template
index 60fd1b2..8ee9c6b 100644
--- a/sapi_manifests/sitter/template
+++ b/sapi_manifests/sitter/template
@@ -7,19 +7,29 @@
     "zoneId": "{{auto.ZONENAME}}",
     "postgresMgrCfg": {
         "dataDir": "/manatee/pg/data",
+        "dataConfig": "/manatee/pg/manatee-config.json",
+{{#PG_DEFAULT_VERSION}}
+        "defaultVersion": "{{PG_DEFAULT_VERSION}}",
+{{/PG_DEFAULT_VERSION}}
+{{^PG_DEFAULT_VERSION}}
+        "defaultVersion": "9.2",
+{{/PG_DEFAULT_VERSION}}
+        "pgBaseDir": "/opt/postgresql/",
         "dbUser": "postgres",
-        "hbaConf": "/opt/smartdc/manatee/etc/pg_hba.conf",
         "healthChkInterval": 10000,
         "healthChkTimeout": 60000,
         "oneNodeWriteMode": {{^ONE_NODE_WRITE_MODE}}false{{/ONE_NODE_WRITE_MODE}}{{{ONE_NODE_WRITE_MODE}}},
         "opsTimeout": 300000,
         "pgConnectTimeout": 60,
-        "pgCtlPath": "/opt/local/bin/pg_ctl",
-        "pgInitDbPath": "/opt/local/bin/initdb",
-        "postgresConf": "/opt/smartdc/manatee/etc/postgresql.sdc.conf",
-        "postgresPath": "/opt/local/bin/postgres",
-        "recoveryConf": "/opt/smartdc/manatee/etc/recovery.conf",
+        "postgresConfDir": "/opt/smartdc/manatee/etc/",
+        "postgresConfFile": "postgresql.sdc.conf",
+        "recoveryConfFile": "recovery.conf",
+        "hbaConfFile": "pg_hba.conf",
         "replicationTimeout": 90000,
+        "versions": {
+            "9.2": "9.2.4",
+            "9.6": "9.6.3"
+        },
         "snapShotterCfg": {
             "dataset": "zones/{{{auto.ZONENAME}}}/data/manatee",
             "snapshotDir": "/manatee/pg/.zfs/snapshot/",
