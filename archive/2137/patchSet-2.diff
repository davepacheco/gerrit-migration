From b08ce0a73832e54cd97d3dcf6fc614baa2b150d4 Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Thu, 22 Jun 2017 17:26:34 -0400
Subject: [PATCH] OS-6204 async.forEachSeries RangeError with many inputs
 Reviewed by: Isaac Davis <isaac.davis@joyent.com>

---
 src/vm/sbin/vmadmd.js | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/vm/sbin/vmadmd.js b/src/vm/sbin/vmadmd.js
index 4edae44d..fc36fd68 100755
--- a/src/vm/sbin/vmadmd.js
+++ b/src/vm/sbin/vmadmd.js
@@ -2429,7 +2429,14 @@ function main()
             ];
 
             VM.lookup({}, {fields: lookup_fields}, function (e, vmobjs) {
-                async.forEachSeries(vmobjs, function (obj, upg_cb) {
+                if (e) {
+                    log.error({err: e}, 'VM.lookup failed');
+                    process.exit(2);
+                }
+                vasync.forEachPipeline({
+                    inputs: vmobjs,
+                    func: function (obj, upg_cb) {
+
                     function finishUpgrade(vmobj) {
                         if (!seen_vms.hasOwnProperty(vmobj.zonename)) {
                             seen_vms[vmobj.zonename] = {
@@ -2579,6 +2586,14 @@ function main()
                             });
                         });
                     });
+
+                    }
+                }, function (_err, results) {
+                    if (_err) {
+                        log.error({err: _err}, 'Error processing all VMs');
+                    } else {
+                        log.debug('Finished processing all VMs');
+                    }
                 });
             });
         });
-- 
2.21.0

