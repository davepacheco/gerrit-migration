From 4db1e55c2b64954f899ac3beb768a5d05ecd199b Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Thu, 13 Jun 2019 12:06:18 -0700
Subject: [PATCH] TRITON-1744 'sdcadm experimental remove-ca' crash: "Cannot
 read property 'Symbol(Symbol.iterator)' of undefined"

---
 CHANGES.md                        |  5 +++++
 lib/procedures/remove-services.js | 18 ++++++++++--------
 package.json                      |  2 +-
 3 files changed, 16 insertions(+), 9 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index f2c066e..b6fc9b1 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,11 @@
 
 # sdcadm Changelog
 
+## 1.30.1
+
+- TRITON-1744 Fix a crash in `sdcadm experimental remove-ca` if a given CNAPI
+  server record does not have an "agents" field.
+
 ## 1.30.0
 
 - TRITON-1319 need firewall-logger agent (`sdcadm post-setup firewall-logger-agent`)
diff --git a/lib/procedures/remove-services.js b/lib/procedures/remove-services.js
index ece91c4..49123fb 100644
--- a/lib/procedures/remove-services.js
+++ b/lib/procedures/remove-services.js
@@ -250,14 +250,16 @@ RemoveServicesProcedure.prototype.prepare = function prepare(opts, cb) {
                 let agentsToRemove = [];
                 let cnAgentInfo;
 
-                for (let agent of server.agents) {
-                    if (agent.name === 'cn-agent') {
-                        cnAgentInfo = agent;
-                    }
-                    let sfsn = self.serversFromSvcName[agent.name];
-                    if (sfsn) {
-                        sfsn.push(server);
-                        agentsToRemove.push(agent.name);
+                if (server.agents) {
+                    for (let agent of server.agents) {
+                        if (agent.name === 'cn-agent') {
+                            cnAgentInfo = agent;
+                        }
+                        let sfsn = self.serversFromSvcName[agent.name];
+                        if (sfsn) {
+                            sfsn.push(server);
+                            agentsToRemove.push(agent.name);
+                        }
                     }
                 }
 
diff --git a/package.json b/package.json
index de0d92d..4248235 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a Triton Data Center",
-  "version": "1.30.0",
+  "version": "1.30.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

