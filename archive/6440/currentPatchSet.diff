From 735d265d796dfd1bc25a1c7fa06cfc3907bedbc6 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 14 Jun 2019 10:18:18 -0700
Subject: [PATCH] =?UTF-8?q?TRITON-1744=20'sdcadm=20experimental=20remove-c?=
 =?UTF-8?q?a'=20crash:=20"Cannot=20read=20property=20'Symbol(Symbol.iterat?=
 =?UTF-8?q?or)'=20of=20undefined"=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n?=
 =?UTF-8?q?=20Candel=20<pedro@joyent.com>=20Approved=20by:=20Pedro=20Palaz?=
 =?UTF-8?q?=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.md                        |  4 ++++
 lib/procedures/remove-services.js | 18 ++++++++++--------
 package.json                      |  2 +-
 3 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 3654916..32011b8 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.30.1
+
+- TRITON-1744 Fix a crash in `sdcadm experimental remove-ca` if a given CNAPI
+  server record does not have an "agents" field.
 - TRITON-1748 Ensure 'sdcadm experimental remove-ca' does trace logging to file.
 
 ## 1.30.0
diff --git a/lib/procedures/remove-services.js b/lib/procedures/remove-services.js
index ece91c4..49123fb 100644
--- a/lib/procedures/remove-services.js
+++ b/lib/procedures/remove-services.js
@@ -250,14 +250,16 @@ RemoveServicesProcedure.prototype.prepare = function prepare(opts, cb) {
                 let agentsToRemove = [];
                 let cnAgentInfo;
 
-                for (let agent of server.agents) {
-                    if (agent.name === 'cn-agent') {
-                        cnAgentInfo = agent;
-                    }
-                    let sfsn = self.serversFromSvcName[agent.name];
-                    if (sfsn) {
-                        sfsn.push(server);
-                        agentsToRemove.push(agent.name);
+                if (server.agents) {
+                    for (let agent of server.agents) {
+                        if (agent.name === 'cn-agent') {
+                            cnAgentInfo = agent;
+                        }
+                        let sfsn = self.serversFromSvcName[agent.name];
+                        if (sfsn) {
+                            sfsn.push(server);
+                            agentsToRemove.push(agent.name);
+                        }
                     }
                 }
 
diff --git a/package.json b/package.json
index de0d92d..4248235 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a Triton Data Center",
-  "version": "1.30.0",
+  "version": "1.30.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

