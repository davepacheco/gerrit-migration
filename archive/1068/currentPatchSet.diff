From 14ff49f9ad49dd44009a97ba8de2397859e73d9d Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 5 Dec 2016 15:42:17 -0800
Subject: [PATCH] CNS-182 update to new node-mname and cueball Reviewed by:
 Cody Mello <cody.mello@joyent.com>

---
 lib/dns-server.js | 31 ++++++++++++++++++++++++++-----
 package.json      |  4 ++--
 2 files changed, 28 insertions(+), 7 deletions(-)

diff --git a/lib/dns-server.js b/lib/dns-server.js
index d41443e..5912027 100644
--- a/lib/dns-server.js
+++ b/lib/dns-server.js
@@ -1135,7 +1135,10 @@ DNSServer.prototype.handleTransfer = function (q, z, cb) {
 					    name + '.' + z);
 					pushed += recs.length;
 					if (pushed > MAX_ANS_PER_MSG) {
-						q.send();
+						if (q.send() === false) {
+							finish();
+							return;
+						}
 						pushed = 0;
 					}
 				}
@@ -1154,6 +1157,7 @@ DNSServer.prototype.sendIxfrDiff = function (q, z, from, to, soa, cb) {
 
 	var i;
 	var nsDiff;
+	var pushErr = null;
 	var pushed = q.response.answer.length;
 	var pushRecs = function (recs) {
 		if (typeof (recs[0]) === 'string')
@@ -1166,7 +1170,12 @@ DNSServer.prototype.sendIxfrDiff = function (q, z, from, to, soa, cb) {
 			    recs[i].name ? (recs[i].name + '.' + z) : z);
 			pushed++;
 			if (pushed > MAX_ANS_PER_MSG) {
-				q.send();
+				if (q.send() === false) {
+					pushErr = new Error(
+					    'Failed to send data, ' +
+					    'req cancelled');
+					return;
+				}
 				pushed = 0;
 			}
 		}
@@ -1206,7 +1215,13 @@ DNSServer.prototype.sendIxfrDiff = function (q, z, from, to, soa, cb) {
 			q.addAnswer(z, soa, TTL);
 			pushed++;
 			if (pushed > MAX_ANS_PER_MSG) {
-				q.send();
+				if (q.send() === false) {
+					pushErr = new Error(
+					    'Failed to send data, req ' +
+					    'cancelled');
+					rcb(pushErr);
+					return;
+				}
 				pushed = 0;
 			}
 
@@ -1225,7 +1240,13 @@ DNSServer.prototype.sendIxfrDiff = function (q, z, from, to, soa, cb) {
 				q.addAnswer(z, soa, TTL);
 				pushed++;
 				if (pushed > MAX_ANS_PER_MSG) {
-					q.send();
+					if (q.send() === false) {
+						pushErr = new Error(
+						    'Failed to send data, ' +
+						    'req cancelled');
+						rcb(pushErr);
+						return;
+					}
 					pushed = 0;
 				}
 
@@ -1237,7 +1258,7 @@ DNSServer.prototype.sendIxfrDiff = function (q, z, from, to, soa, cb) {
 				if (!err2 && recs2 !== null)
 					pushRecs(recs2);
 
-				rcb(null);
+				rcb(pushErr);
 			});
 		});
 	}
diff --git a/package.json b/package.json
index 9562f93..afb0571 100644
--- a/package.json
+++ b/package.json
@@ -26,7 +26,7 @@
     "assert-plus": "0.1.5",
     "bunyan": "1.5.1",
     "changefeed": "1.2.0",
-    "cueball": "1.1.7",
+    "cueball": "1.1.8",
     "dashdash": "1.10.1",
     "deep-equal": "1.0.1",
     "ipaddr.js": "1.0.3",
@@ -34,7 +34,7 @@
     "ldapjs": "1.0.0",
     "lru-cache": "2.7.0",
     "mooremachine": "2.0.0",
-    "mname": "1.0.8",
+    "mname": "1.3.1",
     "redis": "2.1.0",
     "restify": "4.0.3",
     "restify-clients": "1.1.1",
-- 
2.21.0

