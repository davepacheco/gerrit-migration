From 0f551754838a4f047aaaa18ee03af15e7ebf499b Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Wed, 8 Mar 2017 20:00:52 +0100
Subject: [PATCH] TOOLS-1690 sdcadm missing urclient.close() call: meaning
 sdcadm can't use softexit

---
 lib/cli/index.js |  2 +-
 lib/ur.js        | 20 +++++++-------------
 2 files changed, 8 insertions(+), 14 deletions(-)

diff --git a/lib/cli/index.js b/lib/cli/index.js
index 4a8f82b..e887624 100644
--- a/lib/cli/index.js
+++ b/lib/cli/index.js
@@ -473,6 +473,6 @@ if (require.main === module) {
         argv: process.argv,
         showCode: true,
         showErr: true,
-        finale: 'exit'
+        finale: 'softexit'
     });
 }
diff --git a/lib/ur.js b/lib/ur.js
index ecfeb93..fbffb94 100644
--- a/lib/ur.js
+++ b/lib/ur.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 /*
@@ -80,18 +80,12 @@ function exec(opts, cb) {
     assert.func(cb, 'cb');
     var cb_ = once(cb);
 
-    // FIXME: modify to use urclient via sdcadm.getUrConnection()
-    var client = urclient.create_ur_client({
-        log: opts.log || opts.sdcadm.log,
-        amqp_config: opts.sdcadm.config.amqp,
-        connect_timeout: (opts.connectTimeout === undefined ?
-            5000 : opts.connectTimeout),
-        enable_http: false
-    });
-
-    client.on('error', cb_);
-    client.on('ready', function () {
-        client.exec({
+    opts.sdcadm.getUrConnection(function (urErr, urClient) {
+        if (urErr) {
+            cb_(urErr);
+            return;
+        }
+        urClient.exec({
             script: opts.cmd,
             server_uuid: opts.server,
             timeout: (opts.execTimeout === undefined ?
-- 
2.21.0

