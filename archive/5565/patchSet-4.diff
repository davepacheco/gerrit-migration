From 029c8faa1b4eb74969330ee28e04e3113b989e55 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Mon, 11 Feb 2019 22:02:20 +0100
Subject: [PATCH] TRITON-1213 VM resize fails when tmpfs is 0 and no tmpfs set
 in package

---
 src/vm/node_modules/VM.js | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 7758ace9..71d40392 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -4606,7 +4606,7 @@ function fixPayloadMemory(payload, vmobj, log)
             // change tmpfs to be the same ratio of ram as before
             payload.tmpfs = ((vmobj.tmpfs / vmobj.max_physical_memory)
                 * payload.max_physical_memory);
-            payload.tmpfs = Number(payload.tmpfs).toFixed();
+            payload.tmpfs = Number(payload.tmpfs);
         } else {
             // tmpfs must be < max_physical_memory, if not: pretend it was
             payload.tmpfs = payload.max_physical_memory;
@@ -16605,6 +16605,11 @@ exports.update = function (uuid, payload, options, callback)
                                 return;
                             }
 
+                            var tmpfs = Number(vmobj.tmpfs);
+                            if (newkey === 'tmpfs' && tmpfs === 0) {
+                                return;
+                            }
+
                             switch (vmobj.brand) {
                             case 'kvm':
                                 v += KVM_MEM_OVERHEAD;
-- 
2.21.0

