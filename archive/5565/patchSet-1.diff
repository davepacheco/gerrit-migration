From 7e7d1c527585fac9a131fa3e03217f54029df485 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Mon, 11 Feb 2019 22:02:20 +0100
Subject: [PATCH] TRITON-1213 VM resize fails when tmpfs is 0 and no tmpfs set
 in package

---
 src/vm/node_modules/VM.js | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 46ee41bf..e9346d0b 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -4433,7 +4433,7 @@ function fixPayloadMemory(payload, vmobj, log)
             // change tmpfs to be the same ratio of ram as before
             payload.tmpfs = ((vmobj.tmpfs / vmobj.max_physical_memory)
                 * payload.max_physical_memory);
-            payload.tmpfs = Number(payload.tmpfs).toFixed();
+            payload.tmpfs = Number(payload.tmpfs);
         } else {
             // tmpfs must be < max_physical_memory, if not: pretend it was
             payload.tmpfs = payload.max_physical_memory;
@@ -15743,6 +15743,12 @@ exports.update = function (uuid, payload, options, callback)
                                 return;
                             }
 
+                            if (newkey === 'tmpfs' &&
+                                Number(vmobj.tmpfs) === 0) {
+
+                                return;
+                            }
+
                             switch (vmobj.brand) {
                             case 'kvm':
                                 v += KVM_MEM_OVERHEAD;
-- 
2.21.0

