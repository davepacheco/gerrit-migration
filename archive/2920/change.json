{"project":"joyent/sdc-manta","branch":"master","id":"Ic2d58598d52d795f292ae830ba357522ebafdba0","number":"2920","subject":"MANTA-3494 Add alarms for MPU GC Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"url":"https://cr.joyent.us/2920","commitMessage":"MANTA-3494 Add alarms for MPU GC\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1510074439,"lastUpdated":1515615276,"open":false,"status":"MERGED","comments":[{"timestamp":1510074439,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 1."},{"timestamp":1510074480,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510095407,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1:\n\nIt may be wise to wait to integrate this until MANTA-3226 is also approved for integration."},{"timestamp":1510095686,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1510183758,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 2."},{"timestamp":1510183778,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1510183799,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510191977,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)"},{"timestamp":1510192087,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Integration-Approval+1\n\n+1 for IA, though I think we want to wait on integration until MPU GC is ready to integrate."},{"timestamp":1510251722,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 3."},{"timestamp":1510251736,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1510251763,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510265467,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1514925602,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1515431661,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 4."},{"timestamp":1515431706,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515432341,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4:\n\nPS 4 updates the upset.manta.ops.gc.mpu_cleanup_instructions_lingering probe to exit 0 if the mfind in the command fails because the directory does not exist. Otherwise, if the mfind fails, the probe will fail.\n\nI repeated the testing notes in the ticket (including the manual testing and `make prepush`) and added some additional testing to verify the change probe works."},{"timestamp":1515614602,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1515615259,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1515615276,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jordan Hendricks"}],"currentPatchSet":{"number":"5","revision":"c2d58598d52d795f292ae830ba357522ebafdba0","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/20/2920/5","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1515615259,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515431706,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515614602,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515614602,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1515615276,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"alarm_metadata/probe_templates/ops.yaml","type":"MODIFIED","insertions":97,"deletions":-3}],"sizeInsertions":97,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"39e5f8808e82b9e1b7dc96b27a592a9e84708f8c","parents":["0635d02aa3323a23aa645a6b0d3e97efda8b7da3"],"ref":"refs/changes/20/2920/1","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1510074439,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510074480,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"alarm_metadata/probe_templates/ops.yaml","line":150,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027d make this a bit more specific (like \"mpu_gc_log_error\") in case you end up adding other types of MPU GC alarms."},{"file":"alarm_metadata/probe_templates/ops.yaml","line":150,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":173,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does this end up wrapping the way you\u0027d expect in the output of \"manta-adm alarm metadata ka upset.manta.ops.gc.mpu_gc\"?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":173,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I just ran `manta-adm alarm metadata ka upset.manta.ops.gc.mpu_gc` and it seems fine. What potential issues were you worried about?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":173,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I haven\u0027t seen this style of wrapping in YAML (but I haven\u0027t seen much YAML), and it\u0027s different from what we use with \"impact\" and \"action\", so I just wasn\u0027t sure.  Thanks for checking."},{"file":"alarm_metadata/probe_templates/ops.yaml","line":173,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Ah, I see. I\u0027ll make the wrapping format the same as \"impact\" and \"action\" so the style is consistent throughout the file."},{"file":"alarm_metadata/probe_templates/ops.yaml","line":184,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same -- maybe add \"log_error\"?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":184,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":376,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Will this script exit non-zero if the mfind fails?  Presumably we want it to?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":376,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It doesn\u0027t. I\u0027m not sure it should.\n\nIf the MPU GC job hasn\u0027t run ever (which is conceivable for a long period of time with SPC), then the cleanup directory wouldn\u0027t exist, and the mfind would fail. This isn\u0027t necessarily a problem -- at least not as proven by this check -- so I don\u0027t think we should alarm on it. \n\nIf the mfind fails because of a 5XX error, perhaps we should alarm on that, but I\u0027m not sure it\u0027s any more informative about the nature of the error than existing alarms (which would hopefully alert us if there was an ongoing problem causing 5XXs responses for lots of requests).\n\nIs there a particular mfind failure you have in mind?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":376,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It\u0027s mostly the 500 case or the case where it failed to fork at all.  Ideally, a probe check would either succeed, fail, or fail to run.  These would be fail-to-run cases.  To my knowledge, Amon doesn\u0027t distinguish between failing and failing to run, so we\u0027ve often just considered that a failure.  In this case, maybe that\u0027s less helpful."},{"file":"alarm_metadata/probe_templates/ops.yaml","line":376,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Makes sense. Is there something you would suggest instead?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":376,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"As I think about it, maybe it is worth trying to handle ResourceNotFound differently from other failures.  If we don\u0027t, one way this could go badly would be if something changed in the future about the environment (e.g., MANTA_ variables weren\u0027t set properly or we were running with an incompatible version of Node).  That\u0027s happened with several other probes, and they stopped working for months or years without us knowing.\n\nThe only way I can think to do this remotely reliably is to capture stderr and explicitly ignore the failure if the stderr contains ResourceNotFoundError.\n\nWhat do you think of that?"},{"file":"alarm_metadata/probe_templates/ops.yaml","line":376,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think that seems reasonable. I\u0027ll implement that and put up a new patchset after testing."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"alarm_metadata/probe_templates/ops.yaml","type":"MODIFIED","insertions":93,"deletions":-2}],"sizeInsertions":93,"sizeDeletions":-2},{"number":"2","revision":"50961b255f20ffbd0a71c47c5f08fb29914f8a76","parents":["0635d02aa3323a23aa645a6b0d3e97efda8b7da3"],"ref":"refs/changes/20/2920/2","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1510183758,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510191977,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510192087,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510183799,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"alarm_metadata/probe_templates/ops.yaml","type":"MODIFIED","insertions":93,"deletions":-2}],"sizeInsertions":93,"sizeDeletions":-2},{"number":"3","revision":"b99c3db9fb00839de3baa14c4fb6994e4dfddf03","parents":["0635d02aa3323a23aa645a6b0d3e97efda8b7da3"],"ref":"refs/changes/20/2920/3","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1510251722,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510251763,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"alarm_metadata/probe_templates/ops.yaml","type":"MODIFIED","insertions":96,"deletions":-2}],"sizeInsertions":96,"sizeDeletions":-2},{"number":"4","revision":"9fe4cb18e120741c54fbedc86b3bff682f1fe788","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/20/2920/4","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1515431661,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515614602,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515614602,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515431706,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"alarm_metadata/probe_templates/ops.yaml","type":"MODIFIED","insertions":97,"deletions":-3}],"sizeInsertions":97,"sizeDeletions":-3},{"number":"5","revision":"c2d58598d52d795f292ae830ba357522ebafdba0","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/20/2920/5","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1515615259,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515614602,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515614602,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515431706,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1515615276,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"alarm_metadata/probe_templates/ops.yaml","type":"MODIFIED","insertions":97,"deletions":-3}],"sizeInsertions":97,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}]}