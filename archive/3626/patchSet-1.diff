From 667726fb57a5a869f7b21220e77627e5ab245f39 Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Wed, 14 Mar 2018 15:31:10 +0000
Subject: [PATCH] ops and types added, unit tests passing

---
 etc/svp-types.json      |  9 ++++++++-
 lib/backend/json.js     | 33 +++++++++++++++++++++++++++++++++
 lib/types.js            | 15 +++++++++------
 test/unit/types.test.js | 19 +++++++++++++++++++
 4 files changed, 69 insertions(+), 7 deletions(-)

diff --git a/etc/svp-types.json b/etc/svp-types.json
index b765749..bf93845 100644
--- a/etc/svp-types.json
+++ b/etc/svp-types.json
@@ -4,7 +4,14 @@
 		"created_at": 1430352621,
 		"derived_from": "src/types",
 		"ctf_version": 2,
-		"requested_types": [ "svp_req_t" , "svp_vl2_req_t" , "svp_vl2_ack_t" , "svp_vl3_req_t" , "svp_vl3_ack_t" , "svp_bulk_req_t" , "svp_bulk_ack_t" , "svp_log_req_t" , "svp_log_vl2_t" , "svp_log_vl3_t" , "svp_log_ack_t" , "svp_lrm_req_t" , "svp_lrm_ack_t" , "svp_shootdown_t" ]
+		"requested_types": [
+            "svp_req_t", "svp_vl2_req_t", "svp_vl2_ack_t",
+            "svp_vl3_req_t", "svp_vl3_ack_t", "svp_bulk_req_t",
+            "svp_bulk_ack_t", "svp_log_req_t", "svp_log_vl2_t",
+            "svp_log_vl3_t", "svp_log_ack_t", "svp_lrm_req_t",
+            "svp_lrm_ack_t", "svp_shootdown_t", "svp_route_req_t",
+            "svp_route_ack_t"
+        ]
 	},
 "data":
 	[
diff --git a/lib/backend/json.js b/lib/backend/json.js
index baaf92e..eeb8d99 100644
--- a/lib/backend/json.js
+++ b/lib/backend/json.js
@@ -177,6 +177,8 @@ JsonStore.prototype._transform = function _dssTransform(msg, _enc, callback) {
         return this.logReq(msg, callback);
     case types.svp_op.SVP_R_LOG_RM:
         return this.logRm(msg, callback);
+    case types.svp_op.SVP_R_ROUTE_REQ:
+        return this.routeReq(msg, callback);
     default:
         this.log.warn({ message: msg }, 'unsupported svp_type');
         // XXX: push some sort of error on here?
@@ -334,6 +336,37 @@ JsonStore.prototype.logRm = function _jsonLogRm(_msg, callback) {
     callback();
 };
 
+JsonStore.prototype.routeReq = function _jsonRouteReq(msg, callback) {
+    var self = this;
+
+    // TODO
+    return;
+
+    loadFile(MAC_IP_FILE, function _afterRouteLoad(err, table) {
+        if (err) {
+            // XXX: what to do here?
+            callback();
+            return;
+        }
+        // TODO: some stuff
+
+        self.push({
+            svp_type: types.svp_op.SVP_R_ROUTE_ACK,
+            svp_id: msg.svp_id,
+            svp_msg: {
+                vnetid: null, // remote vnet id
+                vlan: null, // remote vlan id
+                prefixlen: null, // prefix of the remote vl3 subnet
+                pad: 0, //hummm
+                dcid: null, // remote datacenter id
+                vl2_srcmac: null, //our vl2 source mac 
+            }
+        });
+        callback();
+        return;
+    });
+};
+
 // --- Exports
 
 
diff --git a/lib/types.js b/lib/types.js
index f427fc0..6647b14 100644
--- a/lib/types.js
+++ b/lib/types.js
@@ -32,8 +32,9 @@ var op_types = {
     10: 'svp_log_ack_t',
     11: 'svp_lrm_req_t',
     12: 'svp_lrm_ack_t',
-    13: 'svp_route_req_t',
-    14: 'svp_route_ack_t'
+    13: 'svp_shootdown_t',
+    14: 'svp_route_req_t',
+    15: 'svp_route_ack_t'
 };
 
 var sizeof = {
@@ -51,6 +52,7 @@ var sizeof = {
     SVP_LOG_VL3: 44,
     SVP_R_LOG_RM: 4,
     SVP_R_LOG_RM_ACK: 4,
+    SVP_R_SHOOTDOWN: 12,
     SVP_R_ROUTE_REQ: 40, 
     SVP_R_ROUTE_ACK: 18
 };
@@ -66,8 +68,9 @@ var sizeof_ops = {
     10: sizeof.SVP_R_LOG_ACK,
     11: sizeof.SVP_R_LOG_RM,
     12: sizeof.SVP_R_LOG_RM_ACK,
-    13: sizeof.SVP_R_ROUTE_REQ,
-    14: sizeof.SVP_R_ROUTE_ACK
+    13: sizeof.SVP_R_SHOOTDOWN,
+    14: sizeof.SVP_R_ROUTE_REQ,
+    15: sizeof.SVP_R_ROUTE_ACK
 };
 
 var svp_op = {
@@ -94,8 +97,8 @@ var svp_op_hex = {
     SVP_R_LOG_ACK: '0x0A',
     SVP_R_LOG_RM: '0x0B',
     SVP_R_LOG_RM_ACK: '0x0C',
-    SVP_R_SHOOTDOWN: '0x0D'
-    SVP_R_ROUTE_REQ: '0x0E'
+    SVP_R_SHOOTDOWN: '0x0D',
+    SVP_R_ROUTE_REQ: '0x0E',
     SVP_R_ROUTE_ACK: '0x0F'
 };
 
diff --git a/test/unit/types.test.js b/test/unit/types.test.js
index 315ae21..aa6e879 100644
--- a/test/unit/types.test.js
+++ b/test/unit/types.test.js
@@ -89,6 +89,24 @@ test('opinfo', function (t) {
             op: svp_op.SVP_R_LOG_RM_ACK,
             sizeof: 4,
             type: 'svp_lrm_ack_t'
+        },
+        {
+            name: 'SVP_R_SHOOTDOWN',
+            op: svp_op.SVP_R_SHOOTDOWN,
+            sizeof: 12,
+            type: 'svp_shootdown_t'
+        },
+        {
+            name: 'SVP_R_ROUTE_REQ',
+            op: svp_op.SVP_R_ROUTE_REQ,
+            sizeof: 40,
+            type: 'svp_route_req_t'
+        },
+        {
+            name: 'SVP_R_ROUTE_ACK',
+            op: svp_op.SVP_R_ROUTE_ACK,
+            sizeof: 18,
+            type: 'svp_route_ack_t'
         }
     ];
 
@@ -99,6 +117,7 @@ test('opinfo', function (t) {
         t.equal(Object.keys(type).length, 4, 'keys');
 
         var opinfo = mod_types.opInfo(type.op);
+
         t.equal(opinfo.name, type.name, type.name + ' name');
         t.equal(opinfo.sizeof, type.sizeof, 'sizeof');
         t.equal(opinfo.sizeofReq, type.sizeof + req_size, 'sizeofReq');
-- 
2.21.0

