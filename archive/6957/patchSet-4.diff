From 156df737a6dec6a1eff8b57038a328e1390d3563 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Tue, 8 Oct 2019 15:37:05 +0100
Subject: [PATCH] OS-6146 Update copyright date in /etc/release

---
 src/Makefile                   |  7 +++-
 src/etc/notices/COPYRIGHT      |  3 +-
 tools/build_etcrelease         | 71 ++++++++++++++++++++++------------
 tools/build_live               |  5 +--
 tools/etc_release.template.txt |  4 --
 5 files changed, 54 insertions(+), 36 deletions(-)
 delete mode 100644 tools/etc_release.template.txt

diff --git a/src/Makefile b/src/Makefile
index f1a5b45e..af1469e2 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -351,10 +351,11 @@ LIBSDC_TARGETS = \
 
 ETC_TARGETS = \
 	etc/nodename \
-	etc/notices/COPYRIGHT \
 	etc/rtc_config \
 	etc/ssh/sshd_config
 
+ETC_COPYRIGHT_TARGET = etc/notices/COPYRIGHT
+
 BHYVE_TARGETS = \
 	bhyve/uefi-csm-rom.bin \
 	bhyve/uefi-rom.bin \
@@ -375,7 +376,7 @@ check : TARGET = check
 
 all: $(TARGETS) $(USR_LIB_TARGETS) $(SMARTDC_TARGETS) \
     $(SMARTDC_LIB_TARGETS) $(LIBSDC_TARGETS) $(ETC_TARGETS) \
-    $(SUBDIRS) $(BHYVE_TARGETS)
+    $(SUBDIRS) $(BHYVE_TARGETS) $(ETC_COPYRIGHT_TARGET)
 
 
 $(SUBDIRS): FRC
@@ -499,6 +500,8 @@ install: all $(SUBDIRS)
 	mv $(NOMKNOD_ROOT64)/$(NOMKNOD_64) $(NOMKNOD_ROOT64)/$(NOMKNOD_SO)
 	mkdir -p $(DESTDIR)/usr/share/bhyve
 	cp $(BHYVE_TARGETS) $(DESTDIR)/usr/share/bhyve
+	sed -e "s/%%YEAR%%/$$(date +%Y)/1" $(ETC_COPYRIGHT_TARGET) \
+		> $(DESTDIR)/$(ETC_COPYRIGHT_TARGET)
 
 check: $(JSLINT) $(SUBDIRS)
 	@echo "==> Running cstyle..."
diff --git a/src/etc/notices/COPYRIGHT b/src/etc/notices/COPYRIGHT
index 1834bac7..a98f3199 100644
--- a/src/etc/notices/COPYRIGHT
+++ b/src/etc/notices/COPYRIGHT
@@ -1,5 +1,4 @@
-Copyright © 2011 Joyent, Inc., 345 California Street, Suite 2000
-San Francisco, California 94104 U.S.A. All rights reserved.
+Copyright %%YEAR%% Joyent, Inc.
 
 Copyright © 2010 Oracle, Inc., All rights reserved.
 
diff --git a/tools/build_etcrelease b/tools/build_etcrelease
index e037b0c1..2d019b47 100755
--- a/tools/build_etcrelease
+++ b/tools/build_etcrelease
@@ -27,9 +27,12 @@ export PATH=/opt/local/bin/:$PATH
 ber_arg0=$(basename $0)
 ber_wsroot=$(cd "$(dirname "$0")/.." && pwd)
 ber_first=true
-ber_version=$1
-ber_template=$2
-ber_template_data=
+
+ber_template="                     SmartOS %%VERSION%% x86_64
+                       Copyright %%YEAR%% Joyent, Inc.
+
+  Built with the following components:
+"
 
 function fatal
 {
@@ -112,31 +115,49 @@ function get_status
 	return 0
 }
 
-#
-# We support two modes of operation:
-#
-#	1. Generating the "/etc/release" file which starts with a header and
-#	   includes the JSON manifest underneath.  To use this mode, the
-#	   caller must provide a VERSION and a TEMPLATE_FILE argument.
-#
-#	2. Generating the bare JSON for the "boot_archive.gitstatus" file.
-#	   This mode is active when no arguments are passed.
-#
-if (( $# != 0 && $# != 2 )); then
-	fatal "usage: $ber_arg0 [ VERSION TEMPLATE_FILE ]"
-fi
+function usage {
+	echo "Usage: build_etcrelease <options>"
+	echo "    -g                  emit gitstatus.json content"
+	echo "    -h                  print this message"
+	echo "    -v <version>        emit an etc/release file with <version>,"
+	echo "                        including the gistatus.json content."
+	echo ""
+}
 
-if [[ -n $ber_template ]]; then
-	if [[ ! -f $ber_template ]]; then
-		fatal "could not find template file \"$ber_template\""
-	fi
+while getopts "ghv:" opt; do
+	case "${opt}" in
+		g)
+			do_gitstatus=true
+			;;
+		h)
+			do_help=true
+			;;
+		v)
+			ber_version=$OPTARG
+			;;
+		*)
+			warn "unknown option ${opt}"
+			usage
+	esac
+done
+shift $((OPTIND - 1))
 
-	if ! ber_template_data=$(sed -e "s,%%VERSION%%,$ber_version,g" \
-	    "$ber_template"); then
-		fatal "could not load template file \"$ber_template\""
-	fi
+if [[ -z "$do_help" && -z "$do_gitstatus" && -z "$ber_version" ]]; then
+	usage
+	exit 2
+fi
+
+if [[ -n "$do_help" ]]; then
+	usage
+	exit 2
+fi
 
-	printf '%s\n\n' "$ber_template_data"
+if [[ -n "$ber_version" ]]; then
+	ber_year=$(date +%Y)
+	ber_content=$(echo "$ber_template" | \
+	    sed -e "s,%%VERSION%%,$ber_version,g" \
+		-e "s,%%YEAR%%,$ber_year,g");
+	printf '%s\n\n' "$ber_content"
 fi
 
 ( printf '[\n'
diff --git a/tools/build_live b/tools/build_live
index ed5528d4..d7551492 100755
--- a/tools/build_live
+++ b/tools/build_live
@@ -414,14 +414,13 @@ function bi_create_password
 #
 function bi_gen_version_files
 {
-	local etcrelease_template="$bi_wsroot/tools/etc_release.template.txt"
 	local build_etcrelease="$bi_wsroot/tools/build_etcrelease"
 	local bvfile="$bi_mnt_root/etc/versions/build"
 	local gitstatus="$bi_out_dir/gitstatus.json"
 
 	bi_emit_start 'Building version files'
 
-	"$build_etcrelease" >"$gitstatus" ||
+	"$build_etcrelease" -g >"$gitstatus" ||
 	    fail "could not generate $gitstatus"
 
 	pfexec cp "$gitstatus" "$bi_archive.gitstatus" ||
@@ -437,7 +436,7 @@ function bi_gen_version_files
 	# permission to write in the mounted image using regular shell
 	# redirection.
 	#
-	"$build_etcrelease" "$bi_buildstamp" "$etcrelease_template" |
+	"$build_etcrelease" -v "$bi_buildstamp" |
 	    pfexec /usr/bin/tee "$bi_mnt_root/etc/release" >/dev/null ||
 	     fail 'failed to build "/etc/release" file'
 
diff --git a/tools/etc_release.template.txt b/tools/etc_release.template.txt
deleted file mode 100644
index b4a22139..00000000
--- a/tools/etc_release.template.txt
+++ /dev/null
@@ -1,4 +0,0 @@
-                      SmartOS %%VERSION%% x86_64
-                    Copyright (c) 2010-2017, Joyent, Inc.
-
-   Built with the following components:
-- 
2.21.0

