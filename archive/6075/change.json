{"project":"joyent/illumos-joyent","branch":"master","id":"If45a4a6a71194fb218dc93b77f1d5f597d25cfd3","number":"6075","subject":"OS-7722 mdb crashes on invalid ::walk softstate Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/6075","commitMessage":"OS-7722 mdb crashes on invalid ::walk softstate\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1554830773,"lastUpdated":1555342348,"open":false,"status":"MERGED","comments":[{"timestamp":1554830773,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1554837756,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nI do this all the time, so thanks for fixing this, but could we also have a reasonable upper bound on the nitems? That way if it\u0027s non-zero but clear nonsense there\u0027s some chance of an early error."},{"timestamp":1554908723,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n\u003e I do this all the time, so thanks for fixing this, but could we\n \u003e also have a reasonable upper bound on the nitems? That way if it\u0027s\n \u003e non-zero but clear nonsense there\u0027s some chance of an early error.\n\nWhat values do you consider reasonable here? I could look for a size that\u0027s greater than a gig. Not clear what the right number of nitems is to stop at? I\u0027m not sure that drivers don\u0027t use softstates for cloned opens at which point maybe UINT32_MAX? Maybe UINT32_MAX for both?"},{"timestamp":1554910753,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nA UINT32_MAX softstate array would take up 32Gb wouldn\u0027t it? I think it could be a lot lower - maybe 16,777,216 ? That\u0027s a 128Mb allocation"},{"timestamp":1554910962,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n\u003e A UINT32_MAX softstate array would take up 32Gb wouldn\u0027t it? I\n \u003e think it could be a lot lower - maybe 16,777,216 ? That\u0027s a 128Mb\n \u003e allocation\n\nddi_soft_state_zalloc takes an int as an argument. So I think I\u0027m going to cap that at INT_MAX and the size at about 1 GiB to allow for different possible changes. I don\u0027t want someone to be unable to walk this because we were wrong about our guesses for how large something should be."},{"timestamp":1554911336,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nPersonally I don\u0027t think it\u0027s in any way unusual for dcmds to rely upon the implementation details of what it\u0027s inspecting (i.e. we\u0027re really not going to allocate a 16Gb array), but any limit is better than before, so sure."},{"timestamp":1554920917,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1554921307,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1554922312,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1554933739,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1554933768,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\nWhile testing I found one case where I had a missing \\n on the mdb_warn() argument."},{"timestamp":1554934296,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1554934346,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1554934482,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1555342194,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1555342342,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1555342348,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"5","revision":"f45a4a6a71194fb218dc93b77f1d5f597d25cfd3","parents":["4ee6130795f64dd6ad7ae8abe4750f8235ab8d5c"],"ref":"refs/changes/75/6075/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1555342342,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934296,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934346,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554934482,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1555342348,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/devinfo.c","type":"MODIFIED","insertions":28,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"1a739a5f80eafdf516ab33e23a3ad0ac51293a4f","parents":["bbfd23a6898ffea3d2662c0959d3ca7aa87a5f12"],"ref":"refs/changes/75/6075/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1554830773,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/devinfo.c","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-1},{"number":"2","revision":"5a678fa957e6edb7b6dfd6dadb0b3bb34414f049","parents":["bbfd23a6898ffea3d2662c0959d3ca7aa87a5f12"],"ref":"refs/changes/75/6075/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1554920917,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554922312,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554921307,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/devinfo.c","type":"MODIFIED","insertions":28,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-1},{"number":"3","revision":"475b6e166bae1c9baa0c9262394f3024f9954de8","parents":["bbfd23a6898ffea3d2662c0959d3ca7aa87a5f12"],"ref":"refs/changes/75/6075/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1554933739,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934296,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554934482,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934346,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/devinfo.c","type":"MODIFIED","insertions":28,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-1},{"number":"4","revision":"618d5d3c9d0466c2ae5ca259d9bffef7484c9025","parents":["4ee6130795f64dd6ad7ae8abe4750f8235ab8d5c"],"ref":"refs/changes/75/6075/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1555342194,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934296,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554934482,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934346,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/devinfo.c","type":"MODIFIED","insertions":28,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-1},{"number":"5","revision":"f45a4a6a71194fb218dc93b77f1d5f597d25cfd3","parents":["4ee6130795f64dd6ad7ae8abe4750f8235ab8d5c"],"ref":"refs/changes/75/6075/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1555342342,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1555342348,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934296,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554934482,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554934346,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/devinfo.c","type":"MODIFIED","insertions":28,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-1}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}