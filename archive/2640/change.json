{"project":"joyent/node-jsprim","branch":"master","id":"Ie65bdabbc1abdf83ba1e8d121e5a877ec29e6fe1","number":"2640","subject":"joyent/node-jsprim#24 `deepEqual` is incorrect when there are inherited properties Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"url":"https://cr.joyent.us/2640","commitMessage":"joyent/node-jsprim#24 `deepEqual` is incorrect when there are inherited properties\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1506099838,"lastUpdated":1508977396,"open":false,"status":"MERGED","comments":[{"timestamp":1506099838,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 1."},{"timestamp":1506099848,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506099905,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 2."},{"timestamp":1506099916,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506100176,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 3."},{"timestamp":1506100197,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506112350,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1506112757,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1506113343,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1506115323,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1506116332,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1506116709,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1506119312,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1508511715,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 4."},{"timestamp":1508511726,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508511755,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4:\n\n(1 comment)\n\nPatchset 4 addresses feedback from earlier reviews."},{"timestamp":1508883833,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1508965569,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 5."},{"timestamp":1508965580,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508965798,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1508968611,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5:\n\n(1 comment)\n\nDave, would you mind doing IA for this? I updated the ticket with testing notes."},{"timestamp":1508973145,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1508977378,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1508977396,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jordan Hendricks"}],"currentPatchSet":{"number":"6","revision":"e65bdabbc1abdf83ba1e8d121e5a877ec29e6fe1","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/6","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1508977378,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508965580,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508965798,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508973145,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1508977396,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":19,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"91eb9e2a3bd38b6be8c2b3e47d0819f21a1e75d4","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/1","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1506099838,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506099848,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/basic.js","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-3},{"number":"2","revision":"1c2c80e05075a17e3ebce2c11a7b980044de3f47","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/2","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1506099905,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506099916,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/basic.js","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":14,"sizeDeletions":-3},{"number":"3","revision":"ede80aa7cefe8f96107cb4a824d6fd99153b0f8b","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/3","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1506100176,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506100197,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":7,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think this may need to be a major bump, since this does change the semantics of `deepEqual`.  If someone was legitimately using deepEqual expecting it to fail when properties are in different places on the prototype chain, this would break them.  I think it\u0027s a good change, but I do think we should bump the major for it."},{"file":"lib/jsprim.js","line":100,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think that we should use Object.getPrototypeOf() here instead, in case someone has something like:\n\n    function A() {\n        this.constructor \u003d \"hello\";\n    }\n\n    function B() {\n        this.constructor \u003d \"hello\";\n    }\n\n    mod_assert.ok(jsprim.deepEqual(new A(), new B()));"},{"file":"lib/jsprim.js","line":100,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This wasn\u0027t that clear from the issue discussion (particularly because I think I wrote the opposite of what I meant in the issue), but I think we decided that `deepEqual` would compare the enumerable properties, regardless of whether they are \"own\" properties or not.  In other words, their position on the prototype chain doesn\u0027t matter.  My argument for that is that it shouldn\u0027t generally matter to a consumer of on object which member of the prototype chain contributed each property.  (If it did, I would argue, then the prototype chain is probably the wrong data structure.)\n\nGiven that, I think comparing the result of `getPrototypeOf()` here would give the wrong result."},{"file":"lib/jsprim.js","line":105,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think it would be better to use Object.getOwnPropertyNames() to get what\u0027s in obj1 and obj2, and then use hasKey() here. This would allow deepEqual() to work with regular expressions and Errors (although more work would need to be done to make it work with Dates and not treat them as empty objects)."},{"file":"lib/jsprim.js","line":105,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I generally avoid using patterns that require constructing a list of all of the keys up front, especially in a general-purpose library like this.  For large objects or frequent operations, that might be really undesirable.\n\nWe could add a smarter, more heuristic deepEqual with knowledge about various built-in types, but that\u0027s not really what `deepEqual` was intended to be.  It was really oriented around plain Objects.  (Admittedly, this isn\u0027t that clear from the docs, but it was intended to cover the same domain as `deepCopy`, which is more explicit about it.)\n\nWe don\u0027t want to use `hasKey()` here for the same reason that we don\u0027t want to use `getPrototypeOf` above."},{"file":"lib/jsprim.js","line":105,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Fair enough. In that case I think we should really update the docs to be clear that Errors/Dates/RegExp/etc. aren\u0027t supported for deepCopy() and deepEqual(), and that deepCopy() doesn\u0027t work with anything that isn\u0027t a plain old object."},{"file":"lib/jsprim.js","line":105,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"That sounds good to me."},{"file":"test/basic.js","line":34,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think it would also be useful to have an object in here like:\n\n    { hasOwnProperty: null }\n\nIf you make the getOwnPropertyNames changes, you can also add:\n\n    \tnew Error(\u0027hello\u0027),\n\tnew Error(\u0027world\u0027),\n\t/abcd/,\n\t/abcde/,\n\t/abcde/i,\n\t/abcde/g,\n\t/abcde/gi,\n\nAlthough using those will require also fixing deepCopy() for the loop below, or refactoring how the tests run."},{"file":"test/basic.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like this test is working by coincidence, because we don\u0027t really copy the object at L60/L64 because deepCopy doesn\u0027t copy objects with non-Object, non-Array constructors."},{"file":"test/basic.js","line":52,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This is something I noticed when trying to replace \"clone\" with \"jsprim\" before. I meant to file a ticket for it, but didn\u0027t. I\u0027ll file something now and drop the example fix I put together in there."},{"file":"test/basic.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t think the test was working by coincidence before (at least, not as far as I know).  It\u0027s only the new test case for which that\u0027s true."},{"file":"test/basic.js","line":52,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"It is working by coincidence for the \"new Date()\" line. deepEqual() treats it as an empty object, and deepCopy() just returns the same object for it."},{"file":"test/basic.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Ah, good call.  We may want to add an empty object to the mix, too, then.  That should cause the test to fail as-is."},{"file":"test/basic.js","line":52,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I suppose the .constructor check will prevent it from being confused with {}, but it does mean that new Date(1234) and new Date(1235) will be treated as equivalent."},{"file":"test/basic.js","line":52,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027ve added a test for an empty object here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.js","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":18,"sizeDeletions":-4},{"number":"4","revision":"2690c966bf49a52f5a1ef6dc4433d988c3812cfe","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/4","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1508511715,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508883833,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508511726,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":7,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It may be worth updating the date here."},{"file":"CHANGES.md","line":7,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":19,"sizeDeletions":-4},{"number":"5","revision":"ad18966c847bea5b63f6bf9ae6d566aca2a0d1b0","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/5","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1508965569,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508965798,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508973145,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508965580,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":19,"sizeDeletions":-4},{"number":"6","revision":"e65bdabbc1abdf83ba1e8d121e5a877ec29e6fe1","parents":["f7d80a9e8e3f79c0b76448ad9ceab252fb309b32"],"ref":"refs/changes/40/2640/6","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1508977378,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508965798,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508973145,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508965580,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1508977396,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/jsprim.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":19,"sizeDeletions":-4}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}