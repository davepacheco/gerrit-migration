From c16a5684641aa516d8010eef7166eb386da4a735 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Wed, 6 Feb 2019 01:00:29 -0800
Subject: [PATCH] TRITON-747 concurrent CNAPI ServerUpdate can lose updates,
 use ETags

---
 lib/models/server.js            |  8 ++++
 package.json                    |  2 +-
 test/lib/mock.js                | 18 ++++++--
 test/model/test-model-server.js | 76 +++++++++++++++++++++++++++++++--
 4 files changed, 96 insertions(+), 8 deletions(-)

diff --git a/lib/models/server.js b/lib/models/server.js
index 9d17f1d..37ae113 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -838,6 +838,7 @@ ModelServer.prototype.getRaw = function (extras, callback) {
                 self.exists = true;
                 server = clone(obj.value);
                 self.value = obj.value;
+                self.etag = obj._etag;
 
                 /*
                  * If:
@@ -1071,10 +1072,17 @@ ModelServer.prototype.modify = function (server, callback) {
     self.log.trace({ server: self.value.uuid },
                    'Writing server %s to moray', self.value.uuid);
 
+    var putOpts = {};
+
+    if (self.etag) {
+        putOpts.etag = self.etag;
+    }
+
     ModelServer.getMoray().putObject(
         buckets.servers.name,
         self.uuid,
         self.value,
+        putOpts,
         function (error) {
             if (error) {
                 self.logerror(error, 'modifying server');
diff --git a/package.json b/package.json
index e47ae5b..b6de70c 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.19.0",
+  "version": "1.19.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
diff --git a/test/lib/mock.js b/test/lib/mock.js
index 48c9edc..e5962dc 100644
--- a/test/lib/mock.js
+++ b/test/lib/mock.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var async = require('async');
@@ -93,8 +93,20 @@ MockMoray.prototype.getObject = function (bucket, key, callback) {
 };
 
 
-MockMoray.prototype.putObject = function (bucket, key, value, callback) {
-    this.history.push(['putObject', bucket, key, value]);
+MockMoray.prototype.putObject =
+function (bucket, key, value, opts, callback) {
+    if (!callback) {
+        callback = opts;
+        opts = undefined;
+    }
+
+    var histItem = ['putObject', bucket, key, value];
+
+    if (opts) {
+        histItem.push(opts);
+    }
+
+    this.history.push(histItem);
     callback.apply(null, [ null ]);
     return this;
 };
diff --git a/test/model/test-model-server.js b/test/model/test-model-server.js
index 58f75c5..b806b63 100644
--- a/test/model/test-model-server.js
+++ b/test/model/test-model-server.js
@@ -5,10 +5,11 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var async = require('async');
+var vasync = require('vasync');
 var util = require('util');
 
 var common = require('../../lib/common');
@@ -402,7 +403,8 @@ function testModifyServer(test) {
                     'putObject',
                     'cnapi_servers',
                     uuid,
-                    change
+                    change,
+                    {}
                 ],
             'moray command history');
 
@@ -415,6 +417,69 @@ function testModifyServer(test) {
     });
 }
 
+function testModifyServerWithEtag(test) {
+    test.expect(7);
+
+    var uuid = uuids[0];
+    var etag = 'etag-1234';
+
+    mock.newApp(function (error, app, components) {
+        test.equal(error, null, 'should not encounter an error');
+
+        var moray = components.moray;
+        moray.client.when('getObject', [], { _etag: etag });
+        moray.client.when('putObject', []);
+
+        ModelServer.init(app);
+
+        var server = new ModelServer(uuids[0]);
+        var change = {
+            uuid: uuid,
+            setup: false
+        };
+
+        vasync.pipeline({ funcs: [
+            function doGetServer(_, next) {
+                server.getRaw(function (err) {
+                    test.ifError(err);
+                    test.equal(server.etag, etag);
+                    next();
+                });
+            },
+            function doModifyServer(_, next) {
+                server.modify(change, function (modifyError) {
+                    test.ifError(modifyError);
+                    next();
+                });
+            },
+            function doCheck(_, next) {
+                test.deepEqual(
+                    moray.client.history[0],
+                    [
+                        'getObject',
+                        'cnapi_servers',
+                        uuid
+                    ],
+                    'moray command history');
+                test.deepEqual(
+                    moray.client.history[1],
+                    [
+                        'putObject',
+                        'cnapi_servers',
+                        uuid,
+                        change,
+                        { etag: etag }
+                    ],
+                    'moray command history');
+                next();
+            }
+        ] },
+        function (err) {
+            test.done();
+        });
+    });
+}
+
 function testSetBootParameters(test) {
     test.expect(5);
 
@@ -496,7 +561,8 @@ function testSetBootParameters(test) {
                                     '-k': true,
                                     '-m': 'milestone=none'
                                 }
-                            }
+                            },
+                            {}
                         ],
                         'moray command history');
                         callback();
@@ -643,7 +709,8 @@ function testUpdateBootParameters(test) {
                                 sysinfo: { 'setup': true },
                                 default_console: 'serial',
                                 serial: 'ttyb'
-                            }
+                            },
+                            {}
                         ],
                         'moray command history');
                         callback();
@@ -708,6 +775,7 @@ module.exports = nodeunit.testCase({
     'delete a server':                        testDeleteServer,
     'reboot server':                          testRebootServer,
     'modify server':                          testModifyServer,
+    'modify server with etag':                testModifyServerWithEtag,
     'set server boot parameters':             testSetBootParameters,
     'update server boot parameters':          testUpdateBootParameters
 });
-- 
2.21.0

