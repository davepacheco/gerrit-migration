{"project":"joyent/electric-boray","branch":"master","id":"I583c0b07bd60b4592ba04d50d28ca40762181b0b","number":"6739","subject":"MANTA-4443 Update electric-boray to pull the hash ring image from imgapi Reviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e Reviewed by: Isaac Davis \u003cisaac.davis@joyent.com\u003e Approved by: Isaac Davis \u003cisaac.davis@joyent.com\u003e","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/6739","commitMessage":"MANTA-4443 Update electric-boray to pull the hash ring image from imgapi\nReviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\nReviewed by: Isaac Davis \u003cisaac.davis@joyent.com\u003e\nApproved by: Isaac Davis \u003cisaac.davis@joyent.com\u003e\n","createdOn":1564616062,"lastUpdated":1565044914,"open":false,"status":"MERGED","comments":[{"timestamp":1564616062,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1564616069,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 9e7b1bae186dfc756f88db8bb5abcaf2aa035adf\n    \n    MANTA-4443 Update electric-boray to pull the hash ring image from imgapi"},{"timestamp":1564616095,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1564672269,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1564672271,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 26c2a0c8e1204d65cd9d8bec50947a9789414732\n    \n    MANTA-4443 Update electric-boray to pull the hash ring image from imgapi"},{"timestamp":1564672306,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1564682577,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\n(2 comments)\n\nquestions + nits"},{"timestamp":1564682675,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1564682794,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1564682796,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 05670bd5cd93ad02264f20aba1439eca98829ece\n    \n    Fixes based on review feedback"},{"timestamp":1564682827,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1564682829,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1565024723,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3: Code-Review+1\n\nI can IA if needed, but I\u0027d prefer another set of eyes on this if possible."},{"timestamp":1565027948,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1565040881,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 4."},{"timestamp":1565040883,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 7baf6966fd4292e73a3d015e0eacb60e48e548ba\n    \n    Parse ring file with JSON.parse"},{"timestamp":1565040914,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1565041009,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1565041062,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1565044914,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"4","revision":"583c0b07bd60b4592ba04d50d28ca40762181b0b","parents":["274476ca2c36b68d1588690871022d28f055d09e"],"ref":"refs/changes/39/6739/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1565040881,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1565040914,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565041009,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565041009,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"SUBM","value":"1","grantedOn":1565044914,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":23,"deletions":-37},{"file":"lib/boray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":27,"deletions":-121},{"file":"lib/server.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":51,"sizeDeletions":-160},"patchSets":[{"number":"1","revision":"0a4fd1b9ec8d2daad21d083d84e05bf449cb164a","parents":["274476ca2c36b68d1588690871022d28f055d09e"],"ref":"refs/changes/39/6739/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1564616062,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564616095,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":37,"deletions":-34},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":13,"deletions":-120}],"sizeInsertions":50,"sizeDeletions":-154},{"number":"2","revision":"15bec2a9d06713bfadec252a2b9e8fdd3eab59bf","parents":["274476ca2c36b68d1588690871022d28f055d09e"],"ref":"refs/changes/39/6739/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1564672269,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564672306,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":124,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"should these be here commented out? should they just be removed?"},{"file":"boot/setup.sh","line":124,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"oh yeah, forgot to delete this. thanks for point that out."},{"file":"boot/setup.sh","line":124,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"},{"file":"lib/data_placement.js","line":60,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"nit: double space here... i probably introduced this myself to be honest :p"},{"file":"lib/data_placement.js","line":60,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":37,"deletions":-34},{"file":"lib/boray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":14,"deletions":-120},{"file":"lib/server.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-156},{"number":"3","revision":"e3d6e75720c1e3d6bf27a997aebfbfc2e44dedad","parents":["274476ca2c36b68d1588690871022d28f055d09e"],"ref":"refs/changes/39/6739/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1564682794,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564682827,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565024723,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565027948,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565027948,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"comments":[{"file":"lib/data_placement.js","line":60,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Using \u0027require\u0027 here is odd. I realize that we were using it here before, so I\u0027m not demanding that you change it, but I would rather see JSON.parse used here in a try/catch. Up to you."},{"file":"lib/data_placement.js","line":60,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I made that change and verified both that electric-boray still starts and runs properly under normal circumstances and that it crashes if the ring file cannot be parsed. e.g. I added an unmatched array opening bracket to the ring file and this was the result:\n\n```\n[ Aug  5 21:31:17 Method \"start\" exited with status 0. ]\nUncaught VError: unable to instantiate data director: Failed to parse data placement information: Unexpected end of input\n\nFROM\n/opt/smartdc/electric-boray/lib/server.js:350:19\n/opt/smartdc/electric-boray/lib/data_placement.js:40:21\nnext (/opt/smartdc/electric-boray/node_modules/vasync/lib/vasync.js:843:6)\ngetPlacementData (/opt/smartdc/electric-boray/lib/data_placement.js:71:20)\nObject._onImmediate (/opt/smartdc/electric-boray/node_modules/vasync/lib/vasync.js:875:12)\n```"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":23,"deletions":-37},{"file":"lib/boray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":14,"deletions":-120},{"file":"lib/server.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":38,"sizeDeletions":-159},{"number":"4","revision":"583c0b07bd60b4592ba04d50d28ca40762181b0b","parents":["274476ca2c36b68d1588690871022d28f055d09e"],"ref":"refs/changes/39/6739/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1565040881,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1565040914,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565041009,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565041009,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"SUBM","value":"1","grantedOn":1565044914,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":23,"deletions":-37},{"file":"lib/boray_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/data_placement.js","type":"MODIFIED","insertions":27,"deletions":-121},{"file":"lib/server.js","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":51,"sizeDeletions":-160}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}