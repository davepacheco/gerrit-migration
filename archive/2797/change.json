{"project":"joyent/moray","branch":"master","id":"I41860776b1b9c6b26f8ef207f32430e69d7b6cc0","number":"2797","subject":"MORAY-446 apply connection limit to \"moray\" role Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2797","commitMessage":"MORAY-446 apply connection limit to \"moray\" role\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1508200674,"lastUpdated":1516261858,"open":false,"status":"MERGED","comments":[{"timestamp":1508200674,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1508200711,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508200749,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1508200776,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508276174,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1508276204,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508882686,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1508981189,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1509036862,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1509124584,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1509578873,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1509578898,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509665508,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(6 comments)"},{"timestamp":1509748751,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1509748776,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509748851,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1509748877,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509750005,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1509750030,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1509752201,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7:\n\n(3 comments)"},{"timestamp":1509752744,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1509752770,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512760652,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 8:\n\n(4 comments)"},{"timestamp":1512784365,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(5 comments)"},{"timestamp":1513017785,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 9."},{"timestamp":1513017812,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513017940,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 10."},{"timestamp":1513017966,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513105948,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 10:\n\n(7 comments)"},{"timestamp":1513302811,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 11."},{"timestamp":1513302837,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513302958,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 12."},{"timestamp":1513302985,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513303113,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 13."},{"timestamp":1513303144,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513303190,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 13:\n\nVerified that the most recent patchset definitely works (inspected the pg_roles table on the primary in the shard in which moray is being replaced to make sure it was set to -1, indicating no limit initially, and then saw it move to 82 after re-provisioning the zone)."},{"timestamp":1513360299,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13:\n\n(3 comments)\n\nThis is looking great. I think there\u0027s still an issue with some of the error paths."},{"timestamp":1513646397,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 14."},{"timestamp":1513646528,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513646530,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 15."},{"timestamp":1513646556,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515190989,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 16."},{"timestamp":1515191014,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515191112,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 17."},{"timestamp":1515191139,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515192285,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 18."},{"timestamp":1515192310,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515192893,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 18:\n\n(1 comment)"},{"timestamp":1515201178,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 19."},{"timestamp":1515201204,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515201502,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 19: Code-Review+1"},{"timestamp":1515286728,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 19: Code-Review+1"},{"timestamp":1515515006,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 19: Integration-Approval+1"},{"timestamp":1516218575,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 20: Patch Set 19 was rebased"},{"timestamp":1516218601,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20:\n\n\"make check\" passed ok"},{"timestamp":1516261839,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 21: Commit message was updated."},{"timestamp":1516261858,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"}],"currentPatchSet":{"number":"21","revision":"76db9a2b1764e740d6fc666c00908fd078f21279","parents":["c468e383efe5dcc35468f0eb8d5743dfd0b621bd"],"ref":"refs/changes/97/2797/21","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516261839,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201204,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201502,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515286728,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515515006,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1516261858,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":67,"deletions":0}],"sizeInsertions":67,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"d3cf14d7a3de87eed1a8503b64935b4a65fc87d2","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508200674,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508200711,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":16,"deletions":0}],"sizeInsertions":16,"sizeDeletions":0},{"number":"2","revision":"700ef93aad710428add4246739e2cdf6b3104aa6","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508200749,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508200776,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":15,"deletions":0}],"sizeInsertions":15,"sizeDeletions":0},{"number":"3","revision":"fbe75be27edab45b73379c4abcb1d21b8e84aff8","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508276174,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508276204,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":208,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Could we add a comment explaining this number?\n\nI have a feeling this value came from something I said, and I do think 32 is fine for production, where we configure 192 moray connections and 1000 at PostgreSQL.  But does this also work for the stock lab and coal setups?  (Specifically, I\u0027m wondering if the number of Morays that are deployed with a stock \"coal\" or \"lab\" deployment would cause us to exceed the stock limit.)  Let me know if you need help figuring that out."},{"file":"boot/setup.sh","line":208,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is that 192 moray connections to the primary per moray instance and 1000 max total postgres connections to the primary (from its perspective)? I\u0027m not sure exactly where to look for these figures, I looked at the moray config files in etc/ but I gather that these aren\u0027t what you\u0027re referring to because they\u0027re way off."},{"file":"boot/setup.sh","line":208,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Okay I actually looked through moray and answered some of my own questions I think. The stock value for max moray postgres connections in coal is 15 (https://github.com/joyent/moray/blob/master/etc/config.coal.json#L21), for lab machines it seems to be 5 (https://github.com/joyent/moray/blob/master/etc/config.lab.json#L14). I\u0027m not sure where the production value is pulled in (is is config.json.in)? If so then the max conns value is also 15.\n\nIt looks like (if I remember correctly how postgres is configured -- from the manta-manatee repo), it has max connections 100, 210, and 1000 for coal, lab, and production deployments. \n\nI\u0027m not sure how to determine how many moray instances are included by default in these deployments. If necessary, is there a way to branch on what type of deployment this is here?"},{"file":"boot/setup.sh","line":208,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The number of connections Moray may create is:\n\n   # of conns per processes * # of processes per zone * # of zones\n\nThe config file for Moray determines how many connections each process uses.  I\u0027m not sure the values you found are used, though.  The sample files in \"etc\" are just templates for developers to use, but the real config files (even for lab and coal) are generated from sapi_manifests/moray/template.  That uses the SAPI variable MORAY_MAX_PG_CONNS, which is configured in sdc-manta.git to 16.\n\nThe number of moray zones probably differs between \"coal\", \"lab\", and \"production\".  You\u0027d have to see what \"manta-adm genconfig lab\" and \"manta-adm genconfig coal\" actually create.\n\nThe number of processes per zone also appears to vary.  It looks like this is determined in boot/setup.sh when we create the SMF services for them.\n\nIn production, it\u0027s typically 16 connections per process * 4 processes per zone * 3 zones \u003d 192 connections at Moray, and 1000 at PostgreSQL."},{"file":"boot/setup.sh","line":209,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think it\u0027s a good idea to quote this here, as well as where it\u0027s used, in case somebody accidentally passes garbage input (e.g., a string that itself contains arguments that \"psql\" would interpret)."},{"file":"boot/setup.sh","line":212,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I wouldn\u0027t expect this to do what you\u0027d think because \"local\" always succeeds:\n\n    $ function testlocal() { local foo\u003d\"$(false)\"; echo $?; }\n    $ testlocal\n    0\n    $\n\nBesides that, I\u0027m not sure this script uses pipefail.  If not, the command itself would succeed even if psql failed:\n\n    [root@52f161c0 (moray) ~]$ psql --bogus | tail +3 | head -1 | tr -d \u0027[:space:]\u0027\n    /opt/local/bin/psql: illegal option -- bogus\n    Try \"psql --help\" for more information.\n    [root@52f161c0 (moray) ~]$ echo $?\n    0\n\nInstead of using \"tail\", \"head\", and \"tr\", it would be more resilient to changes in the psql output format to use \"psql -t -P unaligned\"."},{"file":"boot/setup.sh","line":214,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does this produce a reasonable error message if for some reason pg_max_conns is non-numeric, or if the reserve causes this value to be negative?"},{"file":"boot/setup.sh","line":214,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"In the next patchset I\u0027ll add a change to check for pg_max_conns \u003c reserve_conns."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":12,"sizeDeletions":0},{"number":"4","revision":"e8927c3de6112eb37839d3ac90d1658c873ebac2","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509578873,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509578898,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":209,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"Moray\""},{"file":"boot/setup.sh","line":209,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Needs a rewrap."},{"file":"boot/setup.sh","line":220,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I didn\u0027t quite parse this sentence."},{"file":"boot/setup.sh","line":223,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"rewrap (here and a bunch of places below)"},{"file":"boot/setup.sh","line":233,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This should be impossible to hit, right?  Since reserve_conns is defined above?"},{"file":"boot/setup.sh","line":233,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yes, I figured I\u0027d protect against changes to reserve_conns. I did this because I\u0027ve gotten a lot of feedback related to making sure things don\u0027t break when we tune some parameter or possibly change it to some unexpected value. But if you think it\u0027s better to not do this I can get rid of it."},{"file":"boot/setup.sh","line":239,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you can use $(( )) in bash to do the arithmetic without forking a command (which also means it can\u0027t fail, as far as I know)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":37,"sizeDeletions":0},{"number":"5","revision":"04fb9d6bb87bbd37964872333a6922f7263cdf23","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509748751,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509748776,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":39,"deletions":0}],"sizeInsertions":39,"sizeDeletions":0},{"number":"6","revision":"7b48af774a24a550a05c7b382c5ba4f590b0e6cb","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509748851,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509748877,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":39,"deletions":0}],"sizeInsertions":39,"sizeDeletions":0},{"number":"7","revision":"434170e2efc53e3fad4e3f33fa013edfff692050","parents":["d7f113e02043bfa21e6bfd5e7617973eef2ecf33"],"ref":"refs/changes/97/2797/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509750005,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509748877,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":231,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I would think this would need a backslash at the end of the line."},{"file":"boot/setup.sh","line":236,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same about the backslash."},{"file":"boot/setup.sh","line":240,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I wouldn\u0027t expect this concatenation to work.\n\nI think your best bet might be to use a bash local variable for the new limit, use that in the SQL string, and put that whole string onto the next line."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":39,"deletions":0}],"sizeInsertions":39,"sizeDeletions":0},{"number":"8","revision":"d2ccb2129757543eecbe871a53d5bd9b6625e07c","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509752744,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509752770,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":230,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sorry that I missed this before, but this appears to be undeclared."},{"file":"boot/setup.sh","line":230,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Sorry I think I might not really understand what it means to \"declare\" a variable in bash and when one should declare a variable as opposed to whatever it is I\u0027m doing here."},{"file":"boot/setup.sh","line":230,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"By that, I mean using \"local\", as in:\n\n    local pg_max_conns\n    pg_max_conns \u003d ...\n\nYou don\u0027t generally want to combine these into one line for the reason I mentioned earlier -- the exit status of this:\n\n    local foo\u003d$(bar)\n\nis 0 (success), even if the command `$(bar)` failed, which usually isn\u0027t what you want."},{"file":"boot/setup.sh","line":232,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"My comment on PS7 doesn\u0027t seem to have been addressed here or on line 236.  (Sorry if I\u0027m missing something?)\n\nI also wonder if we want these to be warnings, but not fatal issues.  What do you think?"},{"file":"boot/setup.sh","line":232,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think this is probably a good idea. Particularly because it\u0027s not something that would prevent the database from functioning properly for at least some stretch of time right after setup. It also seems like something that could be reasonably corrected by an admin."},{"file":"boot/setup.sh","line":232,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is good.  In that case, I think it would be worth adding to the warning a note that the connection limit was not applied."},{"file":"boot/setup.sh","line":242,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Do you want to declare `sql` with `local` around the top of this function?"},{"file":"boot/setup.sh","line":242,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"How should I do this? Should it look something like this:\n\nlocal sql\u003d\n\n? The value of the variable depends on rolconnlimit, which is not assigned until later, so I\u0027m not sure how a declaration would look."},{"file":"boot/setup.sh","line":242,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"For example:\n\n    local sql\n    ... # later\n    sql\u003d\"...\""},{"file":"boot/setup.sh","line":243,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m not sure how this could work.  Does this not need to be quoted?\n\n    [root@4f5f5361 (postgres) ~]$ sql\u003d\u0027select 7\u0027\n    [root@4f5f5361 (postgres) ~]$ psql -c $sql\n    psql: FATAL:  database \"7\" does not exist\n    [root@4f5f5361 (postgres) ~]$"},{"file":"boot/setup.sh","line":243,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yes you\u0027re right - I\u0027m not really sure what happened when I ran this. Maybe I had accidentally set the rolconnlimit beforehand and forgot about it."},{"file":"boot/setup.sh","line":243,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Makes sense.  In that case, as part of testing it might be worth looking at the log to make sure it did what you expect."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":41,"deletions":0}],"sizeInsertions":41,"sizeDeletions":0},{"number":"9","revision":"5f7e94879d7f442649365c0a4fdaf4851e7171dd","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513017785,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513017812,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":42,"deletions":0}],"sizeInsertions":42,"sizeDeletions":0},{"number":"10","revision":"e2c273a55ffd80add6f0b24c2926c23c8fb8807e","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513017940,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513017966,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":226,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"See my other comment -- you don\u0027t want to combine `local` with a command like this in the same line."},{"file":"boot/setup.sh","line":234,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you probably want to return after each of these warnings."},{"file":"boot/setup.sh","line":243,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"See above about combining `local` with a command."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":42,"deletions":0}],"sizeInsertions":42,"sizeDeletions":0},{"number":"11","revision":"bb15a7098e574d3ab892dece003554c4f4e3020c","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/11","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513302811,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513302837,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":51,"deletions":0},{"file":"deps/manta-scripts","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-1},{"number":"12","revision":"8b96e59c83ce580f0dfab6f13b56aa65910d5a40","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/12","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513302958,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513302985,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":51,"deletions":0},{"file":"deps/manta-scripts","type":"DELETED","insertions":0,"deletions":-1}],"sizeInsertions":51,"sizeDeletions":-1},{"number":"13","revision":"288d3268bf3a757e0c300ead46a625d7337dffe2","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/13","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513303113,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513303144,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":235,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"We want to return from this function in this case, right?"},{"file":"boot/setup.sh","line":241,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same note about returning."},{"file":"boot/setup.sh","line":247,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same note about returning."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":51,"deletions":0}],"sizeInsertions":51,"sizeDeletions":0},{"number":"14","revision":"89790c449f99168aa0c0c0ec84e0d41e8a12484b","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/14","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513646397,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513646528,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":58,"deletions":0}],"sizeInsertions":58,"sizeDeletions":0},{"number":"15","revision":"2d701e3f78dbecc0afd4b483b28055415ce8f527","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/15","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513646530,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513646556,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":57,"deletions":0}],"sizeInsertions":57,"sizeDeletions":0},{"number":"16","revision":"dc414cfee3dd4692a075d176a11c20350699ebe3","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/16","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515190989,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515191014,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":68,"deletions":0},{"file":"etc/config.lab.json","type":"DELETED","insertions":0,"deletions":-33}],"sizeInsertions":68,"sizeDeletions":-33},{"number":"17","revision":"a3055288d6e54a941900600290d8054f2b61038e","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/17","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515191112,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515191139,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":68,"deletions":0}],"sizeInsertions":68,"sizeDeletions":0},{"number":"18","revision":"4408cecd0fb2d3ac271050053a98c831ce39fe43","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/18","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515192285,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515192310,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":236,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think this variable is now unused in the latest patchset."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":68,"deletions":0}],"sizeInsertions":68,"sizeDeletions":0},{"number":"19","revision":"41860776b1b9c6b26f8ef207f32430e69d7b6cc0","parents":["7594ea98bba375e1e68d63422d49e7bd2f1fff38"],"ref":"refs/changes/97/2797/19","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515201178,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201502,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515286728,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515515006,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201204,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":67,"deletions":0}],"sizeInsertions":67,"sizeDeletions":0},{"number":"20","revision":"bd045ac0ea503da5cc26a2fdf808d15bcb0e1916","parents":["c468e383efe5dcc35468f0eb8d5743dfd0b621bd"],"ref":"refs/changes/97/2797/20","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516218575,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201502,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515286728,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515515006,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201204,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":67,"deletions":0}],"sizeInsertions":67,"sizeDeletions":0},{"number":"21","revision":"76db9a2b1764e740d6fc666c00908fd078f21279","parents":["c468e383efe5dcc35468f0eb8d5743dfd0b621bd"],"ref":"refs/changes/97/2797/21","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516261839,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201502,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515286728,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515515006,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201204,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1516261858,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":67,"deletions":0}],"sizeInsertions":67,"sizeDeletions":0}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}