commit e22e0a78fde5b7667865c4554946bfc9b71508c2 (refs/changes/06/2406/2)
Author: Ryan Zezeski <rpz@joyent.com>
Date:   2017-08-15T15:45:26-06:00 (2 years, 2 months ago)
    
    OS-6285 restrict zone datalink access

diff --git a/usr/src/uts/common/os/zone.c b/usr/src/uts/common/os/zone.c
index a8993524ac..2560bbc95a 100644
--- a/usr/src/uts/common/os/zone.c
+++ b/usr/src/uts/common/os/zone.c
@@ -7645,6 +7645,17 @@ zone_add_datalink(zoneid_t zoneid, datalink_id_t linkid)
 	zone_t *zone;
 	zone_t *thiszone;
 
+	if (secpolicy_zone_config(CRED()) != 0)
+		return (set_errno(EPERM));
+
+	/*
+	 * When links exist in the GZ they aren't added to the GZ's
+	 * zone_dl_list. We must enforce this because link_activate()
+	 * depends on zone_check_datalink() returning only NGZs.
+	 */
+	if (zoneid == GLOBAL_ZONEID)
+		return (set_errno(EINVAL));
+
 	if ((thiszone = zone_find_by_id(zoneid)) == NULL)
 		return (set_errno(ENXIO));
 
@@ -7677,6 +7688,16 @@ zone_remove_datalink(zoneid_t zoneid, datalink_id_t linkid)
 	zone_t *zone;
 	int err = 0;
 
+	if (secpolicy_zone_config(CRED()) != 0)
+		return (set_errno(EPERM));
+
+	/*
+	 * If we can't add a datalink to the GZ's zone_dl_list then we
+	 * certainly can't remove them either.
+	 */
+	if (zoneid == GLOBAL_ZONEID)
+		return (set_errno(EINVAL));
+
 	if ((zone = zone_find_by_id(zoneid)) == NULL)
 		return (set_errno(EINVAL));
 
@@ -7704,6 +7725,9 @@ zone_check_datalink(zoneid_t *zoneidp, datalink_id_t linkid)
 	zone_t *zone;
 	int err = ENXIO;
 
+	if (secpolicy_zone_config(CRED()) != 0)
+		return (set_errno(EPERM));
+
 	if (*zoneidp != ALL_ZONES) {
 		if ((zone = zone_find_by_id(*zoneidp)) != NULL) {
 			if (zone_dl_exists(zone, linkid))
@@ -7743,6 +7767,9 @@ zone_list_datalink(zoneid_t zoneid, int *nump, datalink_id_t *idarray)
 	zone_dl_t *zdl;
 	datalink_id_t *idptr = idarray;
 
+	if (secpolicy_zone_config(CRED()) != 0)
+		return (set_errno(EPERM));
+
 	if (copyin(nump, &dlcount, sizeof (dlcount)) != 0)
 		return (set_errno(EFAULT));
 	if ((zone = zone_find_by_id(zoneid)) == NULL)
@@ -7824,6 +7851,9 @@ zone_datalink_walk(zoneid_t zoneid, int (*cb)(datalink_id_t, void *),
 	uint_t		idcount = 0;
 	int		i, ret = 0;
 
+	if (secpolicy_zone_config(CRED()) != 0)
+		return (set_errno(EPERM));
+
 	if ((zone = zone_find_by_id(zoneid)) == NULL)
 		return (ENOENT);
 
