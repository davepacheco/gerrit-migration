{"project":"joyent/illumos-joyent","branch":"master","id":"Ifc1b3c825992bc27440652673e53f8552575f46a","number":"2406","subject":"OS-6285 restrict zone datalink access Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/2406","commitMessage":"OS-6285 restrict zone datalink access\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1502833469,"lastUpdated":1503416837,"open":false,"status":"MERGED","comments":[{"timestamp":1502833469,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1502833545,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1502833670,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1502837266,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4."},{"timestamp":1502837414,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nSorry about the noise. This is ready for review."},{"timestamp":1502840553,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)\n\nLGTM, modulo the one comment nit"},{"timestamp":1502896620,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1502904969,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4: Code-Review-1\n\nIt turns out this priv is too restrictive and dlmgmtd can\u0027t do its job. This serves as a good reminder as to why I normally test my patch before submitting  a CR. I have another idea. This time I\u0027ll test it first. Sorry for the noise."},{"timestamp":1502942523,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5."},{"timestamp":1502942546,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5: -Code-Review"},{"timestamp":1503017489,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1503018229,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1503080578,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 6."},{"timestamp":1503080665,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5:\n\n(2 comments)\n\nThis function feels much cleaner now. Thanks for the idea."},{"timestamp":1503082413,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1503092013,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 7."},{"timestamp":1503092057,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1503092941,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1503093605,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1503358551,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1503373543,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 7:\n\nTest notes added to ticket."},{"timestamp":1503402979,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 7: Integration-Approval+1"},{"timestamp":1503416640,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1503416827,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1503416837,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"9","revision":"fc1b3c825992bc27440652673e53f8552575f46a","parents":["8327c9afd815b4788a0f0412097b406b17619017"],"ref":"refs/changes/06/2406/9","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1503416827,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503092941,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503093605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503358551,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503402979,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1503416837,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":93,"deletions":-7}],"sizeInsertions":93,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"7821d718df62df1eb0f8342e645593831122129a","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1502833469,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":31,"deletions":0}],"sizeInsertions":31,"sizeDeletions":0},{"number":"2","revision":"e22e0a78fde5b7667865c4554946bfc9b71508c2","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1502833545,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":30,"deletions":0}],"sizeInsertions":30,"sizeDeletions":0},{"number":"3","revision":"6d26ee707b5e00f959d9b0037a00160e1b9e099e","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1502833670,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":31,"deletions":-1}],"sizeInsertions":31,"sizeDeletions":-1},{"number":"4","revision":"fdf8062f0e1b745f1b1f4157a69c33a26037ba94","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1502837266,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502896620,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502840553,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1502904969,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/os/zone.c","line":7652,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":28,"deletions":-1}],"sizeInsertions":28,"sizeDeletions":-1},{"number":"5","revision":"1957ce1e3abb5301b66513a8ba9675bbdb40bfbc","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1502942523,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/zone.c","line":7764,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The use of *zoneidp here should be replaced with zoneid for reasons as mentioned below."},{"file":"usr/src/uts/common/os/zone.c","line":7764,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/os/zone.c","line":7774,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think that we only need to iterate over everything if they\u0027re not allowed to see this link. If they can, then we can break out. So it may be worth making that basically dependent on whether or not we find it or not."},{"file":"usr/src/uts/common/os/zone.c","line":7774,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Actually, looking at this more, we can simplify this and we don\u0027t have to look at timing attacks at all. Before we do the check at +7763 we should just do something like this:\n\nif (zoneid \u003d\u003d ALL_ZONES \u0026\u0026 caller !\u003d GLOBAL_ZONEID)\n        zoneid \u003d caller;\n\nif (zoneid !\u003d caller \u0026\u0026 caller !\u003d GLOBAL_ZONEID)\n        return (ENXIO);\n\nThis ensures two different things:\n\n1. We never even bother checking other zones if we\u0027re a non-global zone. This is valid because the only way this can work is if we\u0027re the zone in question. This means that we can just hit the case at +7763.\n\n2. If we\u0027ve been asked about a zone that\u0027s not us, just return ENXIO and don\u0027t search anything."},{"file":"usr/src/uts/common/os/zone.c","line":7774,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":83,"deletions":-4}],"sizeInsertions":83,"sizeDeletions":-4},{"number":"6","revision":"797e24c3f6c1d243839a79cee321f0b290b479dc","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1503080578,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/zone.c","line":7806,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Don\u0027t we need to communicate the found zoneid out via zoneidp?"},{"file":"usr/src/uts/common/os/zone.c","line":7806,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":94,"deletions":-8}],"sizeInsertions":94,"sizeDeletions":-8},{"number":"7","revision":"4348f408de57978af89fdb50da7692e173be93a9","parents":["aea86460f0918659f2a8637f97b2055272a86c98"],"ref":"refs/changes/06/2406/7","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1503092013,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503093605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503092941,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503402979,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503358551,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":93,"deletions":-7}],"sizeInsertions":93,"sizeDeletions":-7},{"number":"8","revision":"4ccd0250abe9338d817d67b2dcb81c1f354b7f89","parents":["8327c9afd815b4788a0f0412097b406b17619017"],"ref":"refs/changes/06/2406/8","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1503416640,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503093605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503092941,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503402979,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503358551,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":93,"deletions":-7}],"sizeInsertions":93,"sizeDeletions":-7},{"number":"9","revision":"fc1b3c825992bc27440652673e53f8552575f46a","parents":["8327c9afd815b4788a0f0412097b406b17619017"],"ref":"refs/changes/06/2406/9","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1503416827,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503093605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503092941,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503402979,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503358551,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1503416837,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":93,"deletions":-7}],"sizeInsertions":93,"sizeDeletions":-7}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}