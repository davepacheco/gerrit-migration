{"project":"joyent/eng","branch":"master","id":"I221cb144d090e0ab81b915bdea38e5a43b4a5a7f","number":"6443","subject":"TOOLS-2264 buildimage should write a sane etc/motd Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Reviewed by: Chris Burroughs \u003cchris.burroughs@joyent.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Chris Burroughs \u003cchris.burroughs@joyent.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/6443","commitMessage":"TOOLS-2264 buildimage should write a sane etc/motd\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nReviewed by: Chris Burroughs \u003cchris.burroughs@joyent.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Chris Burroughs \u003cchris.burroughs@joyent.com\u003e\n","createdOn":1560511748,"lastUpdated":1561750783,"open":false,"status":"MERGED","comments":[{"timestamp":1560511748,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1560511752,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit ef498471e56d7c0d6cfbe15583e1cb6cef219e98\n    \n    TOOLS-2264 buildimage should write a sane etc/motd"},{"timestamp":1560511780,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n curl: (22) The requested URL returned error: 404 Not Found\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/bapi.xml\n deps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dtools/jsl.node.conf lib/index.js test/api.test.js tools/bashstyle\n /tmp/repo/lib/index.js\n /tmp/repo/test/api.test.js\n /tmp/repo/tools/bashstyle\n json --validate -f package.json\n deps/jsstyle/jsstyle -f tools/jsstyle.conf lib/index.js test/api.test.js tools/bashstyle\n bash -n tools/check-copyright\n /tmp/repo/build/node/bin/node deps/eng/tools/bashstyle tools/check-copyright\n gmake: /tmp/repo/build/node/bin/node: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:245: tools/check-copyright.bashstyle] Error 127"},{"timestamp":1560512502,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n\u003e gmake: /tmp/repo/build/node/bin/node: Command not found\n \u003e gmake: *** [deps/eng/tools/mk/Makefile.targ:245: tools/check-copyright.bashstyle]\n \u003e Error 127\n\nThis is failing because eng.git thinks it has a local copy of node:\n\ntimf@jenkins-agent-i386-1.6.3-2.1.0 (master) make print-NODE\nNODE\u003d/mnt/tank/projects/eng.git/build/node/bin/node\ntimf@jenkins-agent-i386-1.6.3-2.1.0 (master)\n\nwhich is clearly wrong. Both bashstyle and check-copyright are\nbashstyle clean when we run them on it."},{"timestamp":1560512675,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nHere\u0027s that running, for the record:\n\ntimf@jenkins-agent-i386-1.6.3-2.1.0 (grr-TOOLS-2264) make NODE\u003d/opt/tools/bin/node check\nxmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/bapi.xml\ndeps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dtools/jsl.node.conf lib/index.js test/api.test.js tools/bashstyle\n/mnt/tank/projects/motd-work/eng.git/lib/index.js\n/mnt/tank/projects/motd-work/eng.git/test/api.test.js\n/mnt/tank/projects/motd-work/eng.git/tools/bashstyle\njson --validate -f package.json\ndeps/jsstyle/jsstyle -f tools/jsstyle.conf lib/index.js test/api.test.js tools/bashstyle\nbash -n tools/check-copyright\n/opt/tools/bin/node deps/eng/tools/bashstyle tools/check-copyright\ndeps/eng/tools/check-copyright -q\ncheck ok\ntimf@jenkins-agent-i386-1.6.3-2.1.0 (grr-TOOLS-2264)"},{"timestamp":1561143688,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1561462449,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1561726613,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1561726617,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 196b70334b7ed87db2bd53ea16ca9e686a8bd807\n    \n    TOOLS-2264 buildimage should write a sane etc/motd"},{"timestamp":1561726641,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n curl: (22) The requested URL returned error: 404 Not Found\n xmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/bapi.xml\n deps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dtools/jsl.node.conf lib/index.js test/api.test.js tools/bashstyle\n /tmp/repo/lib/index.js\n /tmp/repo/test/api.test.js\n /tmp/repo/tools/bashstyle\n json --validate -f package.json\n deps/jsstyle/jsstyle -f tools/jsstyle.conf lib/index.js test/api.test.js tools/bashstyle\n bash -n tools/check-copyright\n /tmp/repo/build/node/bin/node deps/eng/tools/bashstyle tools/check-copyright\n gmake: /tmp/repo/build/node/bin/node: Command not found\n gmake: *** [deps/eng/tools/mk/Makefile.targ:245: tools/check-copyright.bashstyle] Error 127"},{"timestamp":1561744516,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1561745424,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1561750724,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1561750783,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"3","revision":"221cb144d090e0ab81b915bdea38e5a43b4a5a7f","parents":["940d8fbbef6f4d0e6a9e45409fc4646eda8255e8"],"ref":"refs/changes/43/6443/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1561750724,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1561726641,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561744516,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561744516,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561745424,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561745424,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"SUBM","value":"1","grantedOn":1561750783,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":77,"deletions":0},{"file":"tools/buildimage/package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":89,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"eb5b80ab222dc0bc4e20ff309a5b6896c4cf89b5","parents":["ed10150657b1f3ae4f061c751daf365ed16ca8d5"],"ref":"refs/changes/43/6443/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1560511748,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1560511780,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"tools/buildimage/bin/buildimage","line":572,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I know you have some examples in the ticket, but could you include an example of what this should look like as a comment for those of us who are not quick with the sprintfs in our head?"},{"file":"tools/buildimage/bin/buildimage","line":572,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Sure thing, I\u0027ll add an example."},{"file":"tools/buildimage/bin/buildimage","line":575,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"For existing builds, this will be \u003e 75 characters long in some cases.  Do we need to put a limit here?  \n\nBIKESHED: I know there a handful of components that have a useful fish--\u003ewhat-they-do mapping.  But in the great majority of cases the description is basically the same as the name with inconsistent spacing or capitalization.  I think I\u0027d rather just have the name here and not worry about long descriptions."},{"file":"tools/buildimage/bin/buildimage","line":575,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep, that\u0027s reasonable, I\u0027ll drop the descriptions and\nexpect that we\u0027re not going to blow the character length. Worst case if we do, it\u0027s just a messy terminal.\n\nIt would be nice if our descriptions were more descriptive, but just getting the repo-name-\u003e buildimage_name mapping is probably enough.\n\nFor the record, the current list of \n\n\u003crepo name\u003e \u003cbuildimage_name\u003e \u003cbuildimage_desc\u003e is:\n\nbinder.git manta-nameservice Manta nameservice\nelectric-moray.git manta-electric-moray Manta moray proxy\nmahi.git manta-authcache Manta authcache\nmanta-garbage-collector.git manta-garbage-collector Manta Garbage Collector\nmanta-madtom.git manta-madtom Manta madtom\nmanta-mako.git manta-storage Manta Storage\nmanta-manatee.git manta-postgres Manta manatee\nmanta-marlin.git manta-jobsupervisor Manta jobsupervisor\nmanta-marlin-dashboard.git manta-marlin-dashboard Manta marlin dashboard\nmanta-medusa.git manta-medusa Manta medusa\nmanta-mola.git manta-ops Manta ops\nmanta-muskie.git manta-webapi Manta webapi\nmanta-reshard.git manta-reshard Manta Resharding System\nmanta-wrasse.git manta-jobpuller Manta Job Puller\nmoray.git manta-moray Manta moray\nmuppet.git manta-loadbalancer Manta loadbalancer\npgstatsmon.git manta-pgstatsmon Postgres Monitoring Service\nsdc-adminui.git adminui SDC AdminUI\nsdc-amon.git amon SDC AMON\nsdc-amonredis.git amonredis SDC Amon Redis\nsdc-assets.git assets SDC Assets\nsdc-booter.git dhcpd SDC DHCPD\nsdc-cloudapi.git cloudapi SDC CloudAPI\nsdc-cnapi.git cnapi SDC CNAPI\nsdc-docker.git docker SDC Docker Engine\nsdc-fwapi.git fwapi SDC FWAPI\nsdc-imgapi.git imgapi SDC IMGAPI\nsdc-manatee.git sdc-postgres SDC manatee\nsdc-manta.git manta-deployment Manta deployment tools\nsdc-napi.git napi SDC NAPI\nsdc-nat.git nat SmartDataCenter per-user NAT zone\nsdc-nfsserver.git nfsserver SDC NFS Server\nsdc-papi.git papi SDC PAPI\nsdc-portolan.git portolan SDC Portolan Service\nsdc-rabbitmq.git rabbitmq SDC RabbitMQ\nsdc-sapi.git sapi SDC SAPI\nsdc-sdc.git sdc SDC tools/ops zone\nsdc-ufds.git ufds SDC UFDS\nsdc-vmapi.git vmapi SDC-VMAPI\nsdc-volapi.git volapi SDC Volumes API\nsdc-workflow.git workflow SDC Workflow\nsdcsso.git sdcsso SDC SSO\ntriton-cmon.git cmon Triton Container Monitor\ntriton-cns.git cns Triton Container Naming Service\ntriton-grafana.git grafana SDC Grafana\ntriton-mockcloud.git mockcloud Triton Mockcloud\ntriton-prometheus.git manta-prometheus Triton/Manta Prometheus"},{"file":"tools/buildimage/bin/buildimage","line":576,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"So this means that if we do two builds of the exact same hash, but with a different source repo we will get a different output image file?  Are we going to regret this when we turn our attention to repeatability?"},{"file":"tools/buildimage/bin/buildimage","line":576,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"You\u0027re right, though I\u0027m not too worried about that for now, given where we are with build repeatability today.\n\nAt least to begin with, if we got to the point of being able to do a repeatable build of the same repo origin in the same directory path with the same $TIMESTAMP set in the environment, that\u0027d be awesome.\n\nIf it turns out we then need to drop the source_repo field to get even better repeatability, we can certainly to do that, but the intent of including the value here, is to make life easier for  developers and users wondering where the source for this component might reside. I think developer-ease-of-use might win over build repeatability here.\n\nI\u0027d imagine that in general, we\u0027d want some sort of mechanism to bypass repeatable-build checks files which are known to change from build to build, so that might be another option."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":71,"deletions":0},{"file":"tools/buildimage/package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":83,"sizeDeletions":0},{"number":"2","revision":"8c90f23863083e21445c6ed3a47972060c6edaab","parents":["940d8fbbef6f4d0e6a9e45409fc4646eda8255e8"],"ref":"refs/changes/43/6443/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1561726613,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1561726641,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561744516,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561744516,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561745424,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561745424,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":77,"deletions":0},{"file":"tools/buildimage/package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":89,"sizeDeletions":0},{"number":"3","revision":"221cb144d090e0ab81b915bdea38e5a43b4a5a7f","parents":["940d8fbbef6f4d0e6a9e45409fc4646eda8255e8"],"ref":"refs/changes/43/6443/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1561750724,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1561726641,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561744516,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561744516,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561745424,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561745424,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"SUBM","value":"1","grantedOn":1561750783,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":77,"deletions":0},{"file":"tools/buildimage/package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":89,"sizeDeletions":0}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}