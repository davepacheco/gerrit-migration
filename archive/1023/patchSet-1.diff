From a4e5a1666ac2d62d30db0fb331bf478606e1e06c Mon Sep 17 00:00:00 2001
From: Chris Burroughs <chris.burroughs@joyent.com>
Date: Wed, 30 Nov 2016 13:42:18 -0500
Subject: [PATCH] ./examples/example-list-instances.js

---
 examples/example-list-instances.js | 37 ++++++++++++++++++++++--------
 lib/tritonapi.js                   | 28 ++++++++++++----------
 2 files changed, 43 insertions(+), 22 deletions(-)

diff --git a/examples/example-list-instances.js b/examples/example-list-instances.js
index 1f8c272..ef28628 100755
--- a/examples/example-list-instances.js
+++ b/examples/example-list-instances.js
@@ -27,20 +27,37 @@ var log = bunyan.createLogger({
  * For example, if you want to use an existing `triton` CLI profile, you can
  * pass that profile name in.
  */
-var client = triton.createClient({
+var tritonapi = triton.createClient({
     log: log,
     profile: {
         url: URL,
         account: ACCOUNT,
         keyId: KEY_ID
+    }}
+);
+tritonapi.init(function (initErr) {
+    if (initErr) {
+        log.fatal(initErr);
+        return;
     }
+
+    triton.promptPassphraseUnlockKey({
+        tritonapi: tritonapi
+    }, function (unlockErr) {
+        if (unlockErr) {
+            log.fatal(unlockErr);
+            return;
+        }
+        // TODO: Eventually the top-level TritonApi will have
+        // `.listInstances()` to use.
+        tritonapi.cloudapi.listMachines(function (err, insts) {
+            // Remember to close the client to close TCP conn.
+            tritonapi.close();
+            if (err) {
+                console.error('listInstances err:', err);
+            } else {
+                console.log(JSON.stringify(insts, null, 4));
+            }
+        });
+    });
 });
-// TODO: Eventually the top-level TritonApi will have `.listInstances()` to use.
-client.cloudapi.listMachines(function (err, insts) {
-    client.close();   // Remember to close the client to close TCP conn.
-    if (err) {
-        console.error('listInstances err:', err);
-    } else {
-        console.log(JSON.stringify(insts, null, 4));
-    }
-});
\ No newline at end of file
diff --git a/lib/tritonapi.js b/lib/tritonapi.js
index 75607dc..6eef297 100644
--- a/lib/tritonapi.js
+++ b/lib/tritonapi.js
@@ -209,19 +209,23 @@ TritonApi.prototype.close = function close() {
 
 TritonApi.prototype.init = function init(cb) {
     var self = this;
-    fs.exists(this.cacheDir, function (exists) {
-        if (!exists) {
-            mkdirp(self.cacheDir, function (err) {
-                if (err) {
-                    cb(err);
-                    return;
-                }
+    if (this.cacheDir) {
+        fs.exists(this.cacheDir, function (exists) {
+            if (!exists) {
+                mkdirp(self.cacheDir, function (err) {
+                    if (err) {
+                        cb(err);
+                        return;
+                    }
+                    self._setupProfile(cb);
+                });
+            } else {
                 self._setupProfile(cb);
-            });
-        } else {
-            self._setupProfile(cb);
-        }
-    });
+            }
+        });
+    } else {
+        self._setupProfile(cb);
+    }
 };
 
 TritonApi.prototype._setupProfile = function _setupProfile(cb) {
-- 
2.21.0

