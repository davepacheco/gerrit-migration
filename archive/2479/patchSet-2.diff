From 41254b156cc5c02a3564eaf62b49f29e30d9aa30 Mon Sep 17 00:00:00 2001
From: Dan McDonald <danmcd@joyent.com>
Date: Wed, 30 Aug 2017 15:33:47 -0400
Subject: [PATCH] OS-6319 Fix for OS-6297 forgot smb_ioc_svcenum_t

---
 usr/src/lib/smbsrv/libsmb/common/smb_kmod.c |  1 -
 usr/src/uts/common/fs/smbsrv/smb_init.c     | 13 ++++++++-----
 usr/src/uts/common/smbsrv/smb_ioctl.h       |  3 +++
 3 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/usr/src/lib/smbsrv/libsmb/common/smb_kmod.c b/usr/src/lib/smbsrv/libsmb/common/smb_kmod.c
index 8c330eeb33..5f795f3444 100644
--- a/usr/src/lib/smbsrv/libsmb/common/smb_kmod.c
+++ b/usr/src/lib/smbsrv/libsmb/common/smb_kmod.c
@@ -42,7 +42,6 @@
 #include <smbsrv/libsmb.h>
 
 #define	SMBDRV_DEVICE_PATH		"/dev/smbsrv"
-#define	SMB_IOC_DATA_SIZE		(256 * 1024)
 
 int smb_kmod_ioctl(int, smb_ioc_header_t *, uint32_t);
 
diff --git a/usr/src/uts/common/fs/smbsrv/smb_init.c b/usr/src/uts/common/fs/smbsrv/smb_init.c
index 26ac1c2a5e..2b39303106 100644
--- a/usr/src/uts/common/fs/smbsrv/smb_init.c
+++ b/usr/src/uts/common/fs/smbsrv/smb_init.c
@@ -260,11 +260,14 @@ smb_drv_ioctl(dev_t drv, int cmd, intptr_t argp, int flags, cred_t *cred,
 	uint32_t	crc;
 	boolean_t	copyout = B_FALSE;
 	int		rc = 0;
+	size_t		ioclen;
 
 	if (ddi_copyin((void *)argp, &ioc_hdr, sizeof (ioc_hdr), flags))
 		return (EFAULT);
+	/* SMB_IOC_SVCENUM can be quite large.  See libsmb's smb_kmod.c. */
+	ioclen = MAX(ioc_hdr.len, sizeof (*ioc));
 	if (ioc_hdr.version != SMB_IOC_VERSION ||
-	    ioc_hdr.len > sizeof (smb_ioc_t))
+	    ioclen > sizeof (smb_ioc_svcenum_t) + SMB_IOC_DATA_SIZE)
 		return (EINVAL);
 
 	crc = ioc_hdr.crc;
@@ -272,8 +275,8 @@ smb_drv_ioctl(dev_t drv, int cmd, intptr_t argp, int flags, cred_t *cred,
 	if (smb_crc_gen((uint8_t *)&ioc_hdr, sizeof (ioc_hdr)) != crc)
 		return (EINVAL);
 
-	ioc = kmem_zalloc(sizeof (*ioc), KM_SLEEP);
-	if (ddi_copyin((void *)argp, ioc, ioc_hdr.len, flags)) {
+	ioc = kmem_zalloc(ioclen, KM_SLEEP);
+	if (ddi_copyin((void *)argp, ioc, ioclen, flags)) {
 		kmem_free(ioc, sizeof (*ioc));
 		return (EFAULT);
 	}
@@ -327,10 +330,10 @@ smb_drv_ioctl(dev_t drv, int cmd, intptr_t argp, int flags, cred_t *cred,
 		break;
 	}
 	if ((rc == 0) && copyout) {
-		if (ddi_copyout(ioc, (void *)argp, ioc_hdr.len, flags))
+		if (ddi_copyout(ioc, (void *)argp, ioclen, flags))
 			rc = EFAULT;
 	}
-	kmem_free(ioc, sizeof (*ioc));
+	kmem_free(ioc, ioclen);
 	return (rc);
 }
 
diff --git a/usr/src/uts/common/smbsrv/smb_ioctl.h b/usr/src/uts/common/smbsrv/smb_ioctl.h
index 29cd803c25..cb92c25dca 100644
--- a/usr/src/uts/common/smbsrv/smb_ioctl.h
+++ b/usr/src/uts/common/smbsrv/smb_ioctl.h
@@ -118,6 +118,9 @@ typedef	struct smb_ioc_opennum {
 #define	SMB_SVCENUM_TYPE_FILE	0x46494C45	/* 'FILE' */
 #define	SMB_SVCENUM_TYPE_SHARE	0x53484152	/* 'SHAR' */
 
+/* The enumeration ioctl needs a LOT of space.  We cap it here. */
+#define	SMB_IOC_DATA_SIZE		(256 * 1024)
+
 typedef struct smb_svcenum {
 	uint32_t	se_type;	/* object type to enumerate */
 	uint32_t	se_level;	/* level of detail being requested */
-- 
2.21.0

