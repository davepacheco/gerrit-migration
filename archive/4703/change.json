{"project":"joyent/eng","branch":"master","id":"I9695b0f832c04a076c95cf9f5d3c04eb1b02f6a5","number":"4703","subject":"TOOLS-1997 common Makefile infrastructure for CTF tools Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Richard Kiene \u003crichard.kiene@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/4703","commitMessage":"TOOLS-1997 common Makefile infrastructure for CTF tools\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Richard Kiene \u003crichard.kiene@joyent.com\u003e\n","createdOn":1534450789,"lastUpdated":1534798341,"open":false,"status":"MERGED","comments":[{"timestamp":1534450789,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1534450821,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1534451081,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1534525607,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1534525631,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1534532770,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(8 comments)\n\nThe overall structure of this is great!  I have a few small adjustments that I think would be prudent.  Thanks for getting this ready for inclusion into \"eng.git\"."},{"timestamp":1534538633,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1534538918,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 4:\n\n(8 comments)"},{"timestamp":1534539851,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1534539994,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534797602,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1534798322,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1534798341,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"5","revision":"9695b0f832c04a076c95cf9f5d3c04eb1b02f6a5","parents":["89393b18261c35d9d5aff4dafffda7eae853fa84"],"ref":"refs/changes/03/4703/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1534798322,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534539994,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534797602,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"SUBM","value":"1","grantedOn":1534798341,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":29,"deletions":-1},{"file":"src/helloctf.c","type":"ADDED","insertions":16,"deletions":0},{"file":"src/testctf.sh","type":"ADDED","insertions":40,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":90,"deletions":0},{"file":"tools/mk/Makefile.ctf.defs","type":"ADDED","insertions":49,"deletions":0},{"file":"tools/mk/Makefile.ctf.targ","type":"ADDED","insertions":29,"deletions":0}],"sizeInsertions":253,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"36c7576a69d5ad9e4826e9f95f74e894d7946a02","parents":["89393b18261c35d9d5aff4dafffda7eae853fa84"],"ref":"refs/changes/03/4703/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1534450789,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534450821,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"src/helloctf.c","type":"ADDED","insertions":16,"deletions":0},{"file":"src/testctf.sh","type":"ADDED","insertions":15,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":90,"deletions":0},{"file":"tools/mk/Makefile.ctf.defs","type":"ADDED","insertions":50,"deletions":0},{"file":"tools/mk/Makefile.ctf.targ","type":"ADDED","insertions":29,"deletions":0}],"sizeInsertions":230,"sizeDeletions":-1},{"number":"2","revision":"6c6c5bc5457ad36795d0caa64267fec48f8737f3","parents":["89393b18261c35d9d5aff4dafffda7eae853fa84"],"ref":"refs/changes/03/4703/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1534451081,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534450821,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"src/helloctf.c","type":"ADDED","insertions":16,"deletions":0},{"file":"src/testctf.sh","type":"ADDED","insertions":15,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":90,"deletions":0},{"file":"tools/mk/Makefile.ctf.defs","type":"ADDED","insertions":50,"deletions":0},{"file":"tools/mk/Makefile.ctf.targ","type":"ADDED","insertions":29,"deletions":0}],"sizeInsertions":230,"sizeDeletions":-1},{"number":"3","revision":"c6d5cd53130886a2d1e22f9392ebe5ff38b6d128","parents":["89393b18261c35d9d5aff4dafffda7eae853fa84"],"ref":"refs/changes/03/4703/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1534525607,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534525631,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":186,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think this should be a PHONY target.  The output file rule appears to correctly depend on the input objects, so make should be able to tell when to rebuild it."},{"file":"Makefile","line":186,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"Makefile","line":187,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Can you line this up with one more tab"},{"file":"Makefile","line":187,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"Makefile","line":194,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think I would use the pipe here, because if $(STAMP_CTF_TOOLS) is updated (e.g., if new CTF tools are installed) we probably do want to rebuild the binary.  This would probably mean you would need to replace the $^ token in the recipe with $(HELLOCTF_OBJS:%\u003d$(HELLOCTF_OBJDIR)/%)"},{"file":"Makefile","line":194,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I\u0027m relatively inexperienced when it comes to more elaborate Makefiles, but if I\u0027m understanding correctly, the removal of the | from the pre-prequisites list will ensure that we rebuild the target if it\u0027s any of it\u0027s pre-reqs are updated?"},{"file":"Makefile","line":194,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"That is correct.  As a side-effect, though, the stamp file will be included in the expansion of \"$^\" within the recipe below -- it expands to include all dependencies."},{"file":"Makefile","line":206,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We should replace this with $(CTFDUMP).  (See comments in other file also)"},{"file":"Makefile","line":206,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"src/testctf.sh","line":35,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think we could actually check for the type you\u0027ve created here; e.g., perhaps:\n\n    if ! out\u003d$(\"$CTFDUMP\" \"$BINARY\"); then\n            fatal \"Unable to dump CTF information from $BINARY\"\n    fi\n\n    if ! grep \u0027\u003e struct ctf_proto (\u0027 \u003c\u003c\u003c \"$out\"; then\n            fatal \"$BINARY\" CTF did not contain expected type\"\n    fi"},{"file":"src/testctf.sh","line":35,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"tools/download_ctftools","line":32,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We should move this above TOP\u003d on L24, and make it a check for [[ -z $1 ]] instead."},{"file":"tools/download_ctftools","line":32,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"tools/mk/Makefile.ctf.defs","line":43,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We should add macros for the other utilities included in the \"ctftools\" archive too; i.e.,\n\n    ctfdiff\n    ctfdump\n    ctfmerge\n    ctfstrip"},{"file":"tools/mk/Makefile.ctf.defs","line":43,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"tools/mk/Makefile.ctf.defs","line":50,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Let\u0027s remove this part.  I think it\u0027d be better to keep the CTF tools in place unless \"make distclean\" is run.  Makefile.defs already adds $(CACHE_DIR) to $(DISTCLEAN_FILES), which will catch all of this and everything else."},{"file":"tools/mk/Makefile.ctf.defs","line":50,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"src/helloctf.c","type":"ADDED","insertions":16,"deletions":0},{"file":"src/testctf.sh","type":"ADDED","insertions":35,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":90,"deletions":0},{"file":"tools/mk/Makefile.ctf.defs","type":"ADDED","insertions":50,"deletions":0},{"file":"tools/mk/Makefile.ctf.targ","type":"ADDED","insertions":29,"deletions":0}],"sizeInsertions":250,"sizeDeletions":-1},{"number":"4","revision":"7858ed6b5d3d2448a759a9827df3bbf1d179fb2b","parents":["89393b18261c35d9d5aff4dafffda7eae853fa84"],"ref":"refs/changes/03/4703/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1534538633,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534539994,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534797602,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":29,"deletions":-1},{"file":"src/helloctf.c","type":"ADDED","insertions":16,"deletions":0},{"file":"src/testctf.sh","type":"ADDED","insertions":40,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":90,"deletions":0},{"file":"tools/mk/Makefile.ctf.defs","type":"ADDED","insertions":49,"deletions":0},{"file":"tools/mk/Makefile.ctf.targ","type":"ADDED","insertions":29,"deletions":0}],"sizeInsertions":253,"sizeDeletions":-1},{"number":"5","revision":"9695b0f832c04a076c95cf9f5d3c04eb1b02f6a5","parents":["89393b18261c35d9d5aff4dafffda7eae853fa84"],"ref":"refs/changes/03/4703/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1534798322,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534539994,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534797602,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"SUBM","value":"1","grantedOn":1534798341,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":29,"deletions":-1},{"file":"src/helloctf.c","type":"ADDED","insertions":16,"deletions":0},{"file":"src/testctf.sh","type":"ADDED","insertions":40,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":90,"deletions":0},{"file":"tools/mk/Makefile.ctf.defs","type":"ADDED","insertions":49,"deletions":0},{"file":"tools/mk/Makefile.ctf.targ","type":"ADDED","insertions":29,"deletions":0}],"sizeInsertions":253,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}