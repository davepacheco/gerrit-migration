From e2c0f436b383c953a58fada31ecb3a20e82e07fc Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Thu, 18 Apr 2019 13:32:55 +0200
Subject: [PATCH] TRITON-1417 cloudapi fails on nightly due to zone without
 cpu_cap

---
 tests/test.FsWatcher.js                | 3 ++-
 tests/test.PeriodicWatcher.js          | 6 ++++--
 tests/test.VmAgentRealVmadm.js         | 9 +++++++--
 tests/test.VmWatcher.js                | 3 ++-
 tests/test.VmadmEventsWatcher.js       | 3 ++-
 tests/test.ZoneeventWatcher.js         | 3 ++-
 tests/test.ZoneeventWatcherOverflow.js | 3 ++-
 7 files changed, 21 insertions(+), 9 deletions(-)

diff --git a/tests/test.FsWatcher.js b/tests/test.FsWatcher.js
index 8897415..03aa1ec 100644
--- a/tests/test.FsWatcher.js
+++ b/tests/test.FsWatcher.js
@@ -87,7 +87,8 @@ test('create VM', function _test(t) {
         alias: 'vm-agent_testvm',
         brand: 'joyent-minimal',
         image_uuid: smartosImageUUID,
-        quota: 10
+        quota: 10,
+        cpu_cap: 100
     };
 
     payload.log = mocks.Logger;
diff --git a/tests/test.PeriodicWatcher.js b/tests/test.PeriodicWatcher.js
index e336465..390a1b3 100644
--- a/tests/test.PeriodicWatcher.js
+++ b/tests/test.PeriodicWatcher.js
@@ -88,7 +88,8 @@ test('create VM', function _test(t) {
         alias: 'vm-agent_testvm',
         brand: 'joyent-minimal',
         image_uuid: smartosImageUUID,
-        quota: 10
+        quota: 10,
+        cpu_cap: 100
     };
 
     payload.log = mocks.Logger;
@@ -288,7 +289,8 @@ test('create KVM VM', function _test(t) {
     var payload = {
         alias: 'vm-agent_testkvm',
         autoboot: false,
-        brand: 'kvm'
+        brand: 'kvm',
+        cpu_cap: 100
     };
 
     // start with an exmpt set of events
diff --git a/tests/test.VmAgentRealVmadm.js b/tests/test.VmAgentRealVmadm.js
index ee7b15e..7d7e2f3 100644
--- a/tests/test.VmAgentRealVmadm.js
+++ b/tests/test.VmAgentRealVmadm.js
@@ -192,6 +192,7 @@ test('Real vmadm, fake VMAPI', function _test(t) {
         alias: 'vm-agent_testvm',
         brand: 'joyent-minimal',
         image_uuid: smartosImageUUID,
+        cpu_cap: 100,
         uuid: node_uuid.v4(),
         log: mocks.Logger
     };
@@ -439,7 +440,8 @@ test('Real vmadm, fake VMAPI: 1 invalid VM', function _test(t) {
     var payload = {
         alias: 'vm-agent_testvm',
         brand: 'joyent-minimal',
-        image_uuid: smartosImageUUID
+        image_uuid: smartosImageUUID,
+        cpu_cap: 100
     };
     var vmAgent;
     var vms = [];
@@ -663,6 +665,7 @@ test('Real vmadm, fake VMAPI: validate DNI', function _test(t) {
         brand: 'joyent-minimal',
         do_not_inventory: true,
         image_uuid: smartosImageUUID,
+        cpu_cap: 100,
         uuid: node_uuid.v4()
     };
     var vmAgent;
@@ -861,7 +864,8 @@ test('Real vmadm, fake VMAPI: new DNI VM', function _test(t) {
         autoboot: true,
         brand: 'joyent-minimal',
         do_not_inventory: true,
-        image_uuid: smartosImageUUID
+        image_uuid: smartosImageUUID,
+        cpu_cap: 100
     };
     var payload1 = JSON.parse(JSON.stringify(payload));
     var payload2 = JSON.parse(JSON.stringify(payload));
@@ -978,6 +982,7 @@ test('VmAgent works after initial errors', function _test(t) {
         autoboot: false,
         brand: 'joyent-minimal',
         image_uuid: smartosImageUUID,
+        cpu_cap: 100,
         uuid: node_uuid.v4()
     };
     var resolveAfter = 3;
diff --git a/tests/test.VmWatcher.js b/tests/test.VmWatcher.js
index 2c1000f..9aa6365 100644
--- a/tests/test.VmWatcher.js
+++ b/tests/test.VmWatcher.js
@@ -122,7 +122,8 @@ test('create VM', function _test(t) {
         alias: 'vm-agent_testvm',
         brand: 'joyent-minimal',
         image_uuid: smartosImageUUID,
-        quota: 10
+        quota: 10,
+        cpu_cap: 100
     };
 
     payload.log = mocks.Logger;
diff --git a/tests/test.VmadmEventsWatcher.js b/tests/test.VmadmEventsWatcher.js
index 49a3356..1e3fe4d 100644
--- a/tests/test.VmadmEventsWatcher.js
+++ b/tests/test.VmadmEventsWatcher.js
@@ -80,7 +80,8 @@ function main() {
             alias: 'vm-agent_testvm',
             brand: 'joyent-minimal',
             image_uuid: smartosImageUUID,
-            quota: 10
+            quota: 10,
+            cpu_cap: 100
         };
 
         payload.log = mocks.Logger;
diff --git a/tests/test.ZoneeventWatcher.js b/tests/test.ZoneeventWatcher.js
index 7f2c186..04d7013 100644
--- a/tests/test.ZoneeventWatcher.js
+++ b/tests/test.ZoneeventWatcher.js
@@ -79,7 +79,8 @@ test('create VM', function _test(t) {
         autoboot: false,
         brand: 'joyent-minimal',
         image_uuid: smartosImageUUID,
-        quota: 10
+        quota: 10,
+        cpu_cap: 100
     };
     var waitAfterCreate = 5000;
 
diff --git a/tests/test.ZoneeventWatcherOverflow.js b/tests/test.ZoneeventWatcherOverflow.js
index f141005..e55e20b 100644
--- a/tests/test.ZoneeventWatcherOverflow.js
+++ b/tests/test.ZoneeventWatcherOverflow.js
@@ -109,7 +109,8 @@ function main() {
                 autoboot: true,
                 brand: 'joyent-minimal',
                 image_uuid: smartosImageUUID,
-                quota: 10
+                quota: 10,
+                cpu_cap: 100
             };
 
             payload.log = mocks.Logger;
-- 
2.21.0

