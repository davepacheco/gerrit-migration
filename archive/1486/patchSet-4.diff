From 1068fa56b4f80a9eb110014a9be428fe9a94df41 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 10 Feb 2017 13:01:36 -0800
Subject: [PATCH] =?UTF-8?q?TOOLS-1691=20'sdcadm=20post-setup=20dev-headnod?=
 =?UTF-8?q?e-prov'=20doesn't=20refresh=20the=20correct=20config-agent=20Re?=
 =?UTF-8?q?viewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.co?=
 =?UTF-8?q?m>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@jo?=
 =?UTF-8?q?yent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.md                          | 5 +++++
 lib/post-setup/dev-headnode-prov.js | 3 ++-
 package.json                        | 2 +-
 3 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index b55cc20..949033d 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,11 @@
 
 # sdcadm Changelog
 
+## 1.15.5
+
+- TOOLS-1689 Fix a problem where `sdcadm` would hang on exit for many commands that
+  used Ur.
+
 ## 1.15.4
 
 - TOOLS-1683 'sdcadm experimental update AGENT' should support updates of
diff --git a/lib/post-setup/dev-headnode-prov.js b/lib/post-setup/dev-headnode-prov.js
index ed6c8a6..64cc6b5 100644
--- a/lib/post-setup/dev-headnode-prov.js
+++ b/lib/post-setup/dev-headnode-prov.js
@@ -53,7 +53,7 @@ function makeHeadnodeProvisionable(opts, cb) {
             }
 
             progress('Configuring CNAPI to allow headnode provisioning' +
-                ' and over-provisioning (allow a minute to propagate)');
+                ' and over-provisioning');
             var update = {
                 metadata: {
                     ALLOC_FILTER_HEADNODE: false,
@@ -90,6 +90,7 @@ function makeHeadnodeProvisionable(opts, cb) {
                     progress('Refreshing instance %s config-agent', inst.alias);
                     svcadm.svcadmRefresh({
                         server_uuid: inst.server,
+                        zone: inst.instance,
                         wait: true,
                         fmri: 'config-agent',
                         sdcadm: sdcadm,
diff --git a/package.json b/package.json
index 1630a4b..86858d7 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.15.4",
+  "version": "1.15.5",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

