From 7411eb1488dcc5c19b666ff2df166e5eba67a25e Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Thu, 14 Sep 2017 22:53:58 +0000
Subject: [PATCH] MORAY-351 moray missing DTrace probes for many RPC operations

---
 lib/buckets/creat.js  |  9 ++++++-
 lib/buckets/del.js    |  9 ++++++-
 lib/buckets/get.js    |  9 ++++++-
 lib/buckets/list.js   |  4 +++
 lib/buckets/update.js |  9 ++++++-
 lib/control.js        | 10 +++++++-
 lib/dtrace.js         | 57 ++++++++++++++++++++++++++++++++++---------
 lib/objects/batch.js  |  2 +-
 8 files changed, 91 insertions(+), 18 deletions(-)

diff --git a/lib/buckets/creat.js b/lib/buckets/creat.js
index 9a4c6b6..aefa463 100644
--- a/lib/buckets/creat.js
+++ b/lib/buckets/creat.js
@@ -14,6 +14,7 @@ var once = require('once');
 
 var common = require('./common');
 var control = require('../control');
+var dtrace = require('../dtrace');
 var BucketConflictError = require('../errors').BucketConflictError;
 var InternalError = require('../errors').InternalError;
 
@@ -242,10 +243,16 @@ function creat(options) {
             cfg: cfg,
             opts: opts
         }, 'createBucket: entered');
+        dtrace['createbucket-start'].fire(function () {
+            return ([req.msgid, req.req_id, req.bucket.name]);
+        });
 
         control.handlerPipeline({
             req: req,
-            funcs: PIPELINE
+            funcs: PIPELINE,
+            cbProbe: function () {
+                return ([req.msgid, req.req_id, req.bucket.name]);
+            }
         });
     }
 
diff --git a/lib/buckets/del.js b/lib/buckets/del.js
index 44e5c14..9405ca9 100644
--- a/lib/buckets/del.js
+++ b/lib/buckets/del.js
@@ -14,6 +14,7 @@ var once = require('once');
 
 var common = require('./common');
 var control = require('../control');
+var dtrace = require('../dtrace');
 
 var mod_errors = require('../errors');
 var InvalidBucketNameError = mod_errors.InvalidBucketNameError;
@@ -208,10 +209,16 @@ function del(options) {
             bucket: bucket,
             opts: opts
         }, 'delBucket: entered');
+        dtrace['delbucket-start'].fire(function () {
+            return ([req.msgid, req.req_id, req.bucket.name]);
+        });
 
         control.handlerPipeline({
             req: req,
-            funcs: PIPELINE
+            funcs: PIPELINE,
+            cbProbe: function () {
+                return ([req.msgid, req.req_id, req.bucket.name]);
+            }
         });
     }
 
diff --git a/lib/buckets/get.js b/lib/buckets/get.js
index 76e79e4..ed6ac35 100644
--- a/lib/buckets/get.js
+++ b/lib/buckets/get.js
@@ -12,6 +12,7 @@ var util = require('util');
 
 var BucketNotFoundError = require('../errors').BucketNotFoundError;
 var control = require('../control');
+var dtrace = require('../dtrace');
 
 
 ///--- Globals
@@ -92,11 +93,17 @@ function get(options) {
             bucket: bucket,
             opts: opts
         }, 'getBucket: entered');
+        dtrace['getbucket-start'].fire(function () {
+            return ([req.msgid, req.req_id, req.bucket.name]);
+        });
 
         control.handlerPipeline({
             req: req,
             funcs: PIPELINE,
-            cbOutput: function () { return req.bucket; }
+            cbOutput: function () { return req.bucket; },
+            cbProbe: function () {
+                return ([req.msgid, req.req_id, req.bucket.name]);
+            }
         });
     }
 
diff --git a/lib/buckets/list.js b/lib/buckets/list.js
index 84cdf70..bde0500 100644
--- a/lib/buckets/list.js
+++ b/lib/buckets/list.js
@@ -9,6 +9,7 @@
  */
 
 var control = require('../control');
+var dtrace = require('../dtrace');
 
 
 ///--- Globals
@@ -72,6 +73,9 @@ function list(options) {
         req.log.debug({
             opts: opts
         }, 'listBuckets: entered');
+        dtrace['listbuckets-start'].fire(function () {
+            return ([req.msgid, req.req_id]);
+        });
 
         control.handlerPipeline({
             req: req,
diff --git a/lib/buckets/update.js b/lib/buckets/update.js
index 65ba175..ab297a2 100644
--- a/lib/buckets/update.js
+++ b/lib/buckets/update.js
@@ -17,6 +17,7 @@ var clone = require('clone');
 
 var common = require('./common');
 var control = require('../control');
+var dtrace = require('../dtrace');
 
 var mod_errors = require('../errors');
 var BucketNotFoundError = mod_errors.BucketNotFoundError;
@@ -499,10 +500,16 @@ function update(options) {
             cfg: cfg,
             opts: opts
         }, 'updateBucket: entered');
+        dtrace['updatebucket-start'].fire(function () {
+            return ([req.msgid, req.req_id, req.bucket.name]);
+        });
 
         control.handlerPipeline({
             req: req,
-            funcs: PIPELINE
+            funcs: PIPELINE,
+            cbProbe: function () {
+                return ([req.msgid, req.req_id, req.bucket.name]);
+            }
         });
     }
 
diff --git a/lib/control.js b/lib/control.js
index fe22eb3..61f9534 100644
--- a/lib/control.js
+++ b/lib/control.js
@@ -88,7 +88,9 @@ function handlerPipeline(options) {
     var log = req.log;
 
     var cbOutput = options.cbOutput || function () { return null; };
-    var cbProbe = options.cbProbe || function () { return ([req.msgid]); };
+    var cbProbe = options.cbProbe || function () {
+        return ([req.msgid, req.req_id]);
+    };
 
     function pipelineCallback(err) {
         var probe = route.toLowerCase() + '-done';
@@ -139,6 +141,12 @@ function handlerPipeline(options) {
                 return [req.msgid, route, handler.name, req.req_id];
             });
             handler(options.req, function (err) {
+                if (err) {
+                    dtrace.fire('handler-error', function () {
+                        return ([req.msgid, req.req_id, route, handler.name,
+                            err.toString]);
+                    });
+                }
                 dtrace.fire('handler-done', function () {
                     return [req.msgid, route, handler.name];
                 });
diff --git a/lib/dtrace.js b/lib/dtrace.js
index c5cec2e..9f70438 100644
--- a/lib/dtrace.js
+++ b/lib/dtrace.js
@@ -21,26 +21,26 @@ var PROBES = {
     'putobject-start': ['int', 'char *', 'char *', 'char *', 'char *'],
 
     // msgid, req_id
-    'putobject-done': ['int'],
+    'putobject-done': ['int', 'char *'],
 
     // msgid, req_id, bucket, fields, filter
     'update-start': ['int', 'char *', 'char *', 'char *', 'char *'],
 
-    // msgid
-    'update-done': ['int'],
+    // msgid, req_id
+    'update-done': ['int', 'char *'],
 
     // msgid, req_id, bucket, filter
     'delmany-start': ['int', 'char *', 'char *', 'char *'],
 
-    // msgid
-    'delmany-done': ['int'],
+    // msgid, req_id
+    'delmany-done': ['int', 'char *'],
 
     // msgid, req_id
     'batch-start': ['int', 'char *'],
     // msgid, req_id, bucket, op, (key || filter)
     'batch-op-start': ['int', 'char *', 'char *', 'char *', 'char *'],
-    'batch-op-done': ['int'],
-    'batch-done': ['int'],
+    'batch-op-done': ['int', 'char *'],
+    'batch-done': ['int', 'char *'],
 
     // msgid, req_id, bucket, key
     'getobject-start': ['int', 'char *', 'char *', 'char *'],
@@ -51,8 +51,8 @@ var PROBES = {
     // msgid, req_id, bucket, key
     'delobject-start': ['int', 'char *', 'char *', 'char *'],
 
-    // msgid
-    'delobject-done': ['int'],
+    // msgid, req_id
+    'delobject-done': ['int', 'char *'],
 
     // msgid, req_id, bucket, filter
     'findobjects-start': ['int', 'char *', 'char *', 'char *'],
@@ -67,8 +67,8 @@ var PROBES = {
     'reindexobjects-start': ['int', 'char *', 'char *', 'char *'],
     // msgid, bucket, key
     'reindexobjects-record': ['int', 'char *', 'char *'],
-    // msgid
-    'reindexobjects-done': ['int'],
+    // msgid, req_id
+    'reindexobjects-done': ['int', 'char *'],
 
     // reqid, sql
     'query-start': ['char *', 'char *'],
@@ -85,8 +85,41 @@ var PROBES = {
     // msgid, request_type, handler_name, req_id
     'handler-start': ['int', 'char *', 'char *', 'char *'],
 
+    // msgid, req_id, route, handler_name, error message
+    'handler-error': ['int', 'char *', 'char *', 'char *', 'char *'],
+
     // msgid, request_type, handler_name
-    'handler-done': ['int', 'char *', 'char *']
+    'handler-done': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket
+    'getbucket-start': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket, found
+    'getbucket-done': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket
+    'createbucket-start': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket
+    'createbucket-done': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket
+    'delbucket-start': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket
+    'delbucket-done': ['int', 'char *', 'char *'],
+
+    // msgid, req_id
+    'listbuckets-start': ['int', 'char *'],
+
+    // msgid, req_id
+    'listbuckets-done': ['int', 'char *'],
+
+    // msgid, req_id, bucket
+    'updatebucket-start': ['int', 'char *', 'char *'],
+
+    // msgid, req_id, bucket
+    'updatebucket-done': ['int', 'char *', 'char *']
 };
 var PROVIDER;
 
diff --git a/lib/objects/batch.js b/lib/objects/batch.js
index 4e72832..1348cb3 100644
--- a/lib/objects/batch.js
+++ b/lib/objects/batch.js
@@ -106,7 +106,7 @@ function processRequests(req, cb) {
                 arg: subReq
             }, function (err) {
                 dtrace['batch-op-done'].fire(function () {
-                    return ([req.msgid]);
+                    return ([req.msgid, req.req_id]);
                 });
 
                 if (err) {
-- 
2.21.0

