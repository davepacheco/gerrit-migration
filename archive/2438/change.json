{"project":"joyent/manta-muskie","branch":"master","id":"I219b114c34a37cecf3acf7b7f38a4e55dee1e0eb","number":"2438","subject":"MANTA-3363 Some MPU operations don\u0027t log shard information in muskie audit entry","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2438","commitMessage":"MANTA-3363 Some MPU operations don\u0027t log shard information in muskie audit entry\n","createdOn":1503352473,"lastUpdated":1507305923,"open":false,"status":"MERGED","comments":[{"timestamp":1503352473,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1503352525,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503416256,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1503434293,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1503434322,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503435928,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1503680894,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\nHey Dave, there is a manual test plan in the ticket, if you could take a look at this change, review the test plan and give IA if it looks good that would be great. Thanks."},{"timestamp":1504197433,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nI think the test notes in the ticket are from patchset 1.  Presumably it looks different with patchset 2 with the field renamed?\n\nIs this still true:\n\n\u003e Commits already reported the contacted shard in the same way as abort and get do with the introduction of the change, prior to this change.\n\nSo, do commit operations log an entryShard, or an uploadRecordShard, or both?"},{"timestamp":1504634243,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\nAs of the latest patchset, commits log the parent shard and the uploadrecord shard."},{"timestamp":1504634258,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\nWill redo the testing notes."},{"timestamp":1504639433,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\nThe jira ticket has been updated with the most recent test notes. I\u0027ve also documented what shard information is reported for each mpu operation, even if it hasn\u0027t been affected by this change."},{"timestamp":1504809108,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 2:\n\nWorking on IA for this, I realized we could also log the shard of the finalizing record contacted when we fetch it for {get,commit,abort}-mpu. (For the putFinalizingMetadata operation, which under the hood of libmanta uses Moray\u0027s putObject, we still have a dependency on MANTA-2980).\n\nI think it would be useful for us to log this information as well. We could add it as a part of this change, or we could file a new ticket to address it. Up to you -- let me know which you want to do."},{"timestamp":1504826881,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\nMight as well include it in this change."},{"timestamp":1505176721,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1505176750,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505923201,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1506127647,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\nOkay - so I\u0027ve included, where possible, logging for the finalizing record shard. The testing notes have been updated to reflect this. Would appreciate if someone considered this for IA!"},{"timestamp":1506440655,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1506451778,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1506451835,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506451930,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1506730232,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1506730261,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1507162994,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1507305879,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1507305888,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"},{"timestamp":1507305923,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"6","revision":"839994735d9ec2f5414b83ab5a863c41ea31d47f","parents":["2e4845c519e1915da9965868d467bd4d1242a2cb"],"ref":"refs/changes/38/2438/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507305879,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506451835,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507162994,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507162994,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1507305888,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"b4581ec2177155baad63322bf1897c4487a0d06d","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/38/2438/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1503352473,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503352525,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/uploads/common.js","line":494,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Since the upload record isn\u0027t necessarily associated with the \"entry\" path in the sense it is used for the remainder of the REST API, which operate on the URL of the request as a Manta path (e.g., PUT /jhendricks/stor/foo.txt), I think it might make more sense to call this something else. Perhaps \"uploadRecordShard\"?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":4,"sizeDeletions":0},{"number":"2","revision":"75320972206e402e70418a3125e628dba3d0b8a2","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/38/2438/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1503434293,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503434322,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503435928,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":5,"sizeDeletions":0},{"number":"3","revision":"f126eb6b0193c8a5179867859313d1d84e90dc33","parents":["4ba953577be8765a90228cc33d7fcc1dd232a23b"],"ref":"refs/changes/38/2438/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1505176721,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505176750,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505923201,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"lib/uploads/common.js","line":518,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Why is this check done before the error check here, but not before the error check in `loadUploadRecord`?"},{"file":"lib/uploads/common.js","line":518,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It doesn\u0027t change any behavior, but looking at getFinalizingMetadata in libmanta - the shard information isn\u0027t passed to the callback if there\u0027s an error. I\u0027ve moved check to happen only when libmanta doesn\u0027t report an error."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":8,"deletions":-1}],"sizeInsertions":10,"sizeDeletions":-1},{"number":"4","revision":"219b114c34a37cecf3acf7b7f38a4e55dee1e0eb","parents":["4ba953577be8765a90228cc33d7fcc1dd232a23b"],"ref":"refs/changes/38/2438/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506451778,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506451835,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-1},{"number":"5","revision":"c987d602176cb06f7d295d57e7f19b8d3dffc6e1","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/38/2438/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506730232,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506451835,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507162994,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507162994,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-1},{"number":"6","revision":"839994735d9ec2f5414b83ab5a863c41ea31d47f","parents":["2e4845c519e1915da9965868d467bd4d1242a2cb"],"ref":"refs/changes/38/2438/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507305879,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506451835,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507162994,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507162994,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1507305888,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}