commit 75320972206e402e70418a3125e628dba3d0b8a2 (refs/changes/38/2438/2)
Author: Jan Wyszynski <jan.wyszynski@joyent.com>
Date:   2017-08-22T18:46:58+00:00 (2 years, 2 months ago)
    
    MANTA-3363 Some MPU operations don't log shard information in muskie audit entry

diff --git a/lib/audit.js b/lib/audit.js
index d352464..6287bd4 100644
--- a/lib/audit.js
+++ b/lib/audit.js
@@ -233,6 +233,7 @@ function auditLogger(options) {
         obj.sharksContacted = req.sharksContacted;
         obj.entryShard = req.entryShard;
         obj.parentShard = req.parentShard;
+        obj.uploadRecordShard = req.uploadRecordShard;
 
         if (req.route) {
             obj.route = req.route.name;
diff --git a/lib/uploads/common.js b/lib/uploads/common.js
index e22ca84..063c837 100644
--- a/lib/uploads/common.js
+++ b/lib/uploads/common.js
@@ -490,6 +490,10 @@ function loadUploadRecord(upload, cb) {
             assert.ok(wrap._etag);
             record.toSave._etag = wrap._etag;
 
+            if (wrap && wrap._node) {
+                upload.req.uploadRecordShard = wrap._node.pnode;
+            }
+
             cb(null, record.loaded.upload);
         }
     });
