{"project":"joyent/manatee","branch":"master","id":"I6b8a22a77a5877f29c84546219cf1a90687a94c9","number":"2765","subject":"MANATEE-334 apply connection limit to \"moray\" role","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2765","commitMessage":"MANATEE-334 apply connection limit to \"moray\" role\n","createdOn":1507680524,"lastUpdated":1508201080,"open":false,"status":"ABANDONED","comments":[{"timestamp":1507680524,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1507680569,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508186498,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1508201080,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Abandoned"}],"currentPatchSet":{"number":"1","revision":"6b8a22a77a5877f29c84546219cf1a90687a94c9","parents":["c6e5e60d202566db1a0b1833f89220dce0d9edc6"],"ref":"refs/changes/65/2765/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507680524,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507680569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/postgresMgr.js","line":155,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"One thing I had not considered when I suggested doing this on PostgreSQL startup is that Manatee doesn\u0027t really know anything about Moray or the \"moray\" role.  The role is created during the Moray zone\u0027s initial setup.  We may want to apply this change there instead, right after we create the \"moray\" role.\n\nIn fact, this might not even work because when you deploy Manta, you deploy Manatee before Moray, and Manatee will come up without having a Moray role at all.  I\u0027d expect this query to fail in that case."},{"file":"lib/postgresMgr.js","line":1751,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"If we fail here, I\u0027m not sure we want to abort the whole operation.  That would leave us data-down just because we couldn\u0027t set this limit."},{"file":"lib/postgresMgr.js","line":1763,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think we want to reserve some number of connections for non-Moray.  (Otherwise, there\u0027s not really a point to this -- PostgreSQL already limits connections to \"max_connections\".)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":39,"deletions":0}],"sizeInsertions":39,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"6b8a22a77a5877f29c84546219cf1a90687a94c9","parents":["c6e5e60d202566db1a0b1833f89220dce0d9edc6"],"ref":"refs/changes/65/2765/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507680524,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507680569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/postgresMgr.js","line":155,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"One thing I had not considered when I suggested doing this on PostgreSQL startup is that Manatee doesn\u0027t really know anything about Moray or the \"moray\" role.  The role is created during the Moray zone\u0027s initial setup.  We may want to apply this change there instead, right after we create the \"moray\" role.\n\nIn fact, this might not even work because when you deploy Manta, you deploy Manatee before Moray, and Manatee will come up without having a Moray role at all.  I\u0027d expect this query to fail in that case."},{"file":"lib/postgresMgr.js","line":1751,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"If we fail here, I\u0027m not sure we want to abort the whole operation.  That would leave us data-down just because we couldn\u0027t set this limit."},{"file":"lib/postgresMgr.js","line":1763,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think we want to reserve some number of connections for non-Moray.  (Otherwise, there\u0027s not really a point to this -- PostgreSQL already limits connections to \"max_connections\".)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":39,"deletions":0}],"sizeInsertions":39,"sizeDeletions":0}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"}]}