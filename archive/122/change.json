{"project":"joyent/illumos-joyent","branch":"master","id":"Icfd7ff8598863061eabc5c8da6accce7d14998d1","number":"122","subject":"OS-5538 eventfd wrongly blocks writers in semaphore mode Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/122","commitMessage":"OS-5538 eventfd wrongly blocks writers in semaphore mode\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1469120810,"lastUpdated":1469146280,"open":false,"status":"MERGED","comments":[{"timestamp":1469120810,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1469128378,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1"},{"timestamp":1469129405,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1469129714,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1469130415,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1469130635,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1469131641,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1469145170,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1469146280,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"2","revision":"cfd7ff8598863061eabc5c8da6accce7d14998d1","parents":["3471df2870ffc5f94d4307efde133d0403020de0"],"ref":"refs/changes/22/122/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1469145170,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469128378,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1469128378,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469129405,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"SUBM","value":"1","grantedOn":1469146280,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/eventfd.c","type":"MODIFIED","insertions":28,"deletions":-4}],"sizeInsertions":28,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"7e25e1639937de1f8e8aa384908c212073e68918","parents":["3471df2870ffc5f94d4307efde133d0403020de0"],"ref":"refs/changes/22/122/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1469120810,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469129405,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469128378,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1469128378,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/io/eventfd.c","line":202,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Was there a reason to pull this out from underneath the clause at L197?"},{"file":"usr/src/uts/common/io/eventfd.c","line":202,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"In order to more closely follow the convention that the mutex associated with the condvar be held when performing the cv_broadcast.\n\nIt should have no functional effect here due to how the conditional is evaluated, but I though it would be appropriate to match the requirements outlined in the man page:\n\n\"mp   A pointer to a mutual exclusion lock (kmutex_t), initialized by mutex_init(9F) and held by the caller.\""},{"file":"usr/src/uts/common/io/eventfd.c","line":202,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Fair enough; though it is not technically true that the lock is required to be held in this case, that is more of an issue of implementation than semantics."},{"file":"usr/src/uts/common/io/eventfd.c","line":202,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, understood.  I try to stick to the rules unless there\u0027s a pressing reason."},{"file":"usr/src/uts/common/io/eventfd.c","line":202,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"But to clarify: what\u0027s in the man page isn\u0027t _actually_ the \"rule\" -- the rule is that the memory that corresponds to the CV must be safe to reference from within the call to cv_broadcast(), which the old code was abiding by (and the new code too).  Just to clarify lest there be an impression that the old code was incorrect. ;)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/eventfd.c","type":"MODIFIED","insertions":28,"deletions":-4}],"sizeInsertions":28,"sizeDeletions":-4},{"number":"2","revision":"cfd7ff8598863061eabc5c8da6accce7d14998d1","parents":["3471df2870ffc5f94d4307efde133d0403020de0"],"ref":"refs/changes/22/122/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1469145170,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469129405,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1469128378,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1469128378,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1469146280,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/eventfd.c","type":"MODIFIED","insertions":28,"deletions":-4}],"sizeInsertions":28,"sizeDeletions":-4}],"allReviewers":[{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}