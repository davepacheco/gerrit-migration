From f60e429d99ab5fc128c3ab7ff650ba2b2ddb07b4 Mon Sep 17 00:00:00 2001
From: Mike Zeller <mike@mikezeller.net>
Date: Wed, 7 Aug 2019 15:27:19 -0400
Subject: [PATCH] XXX - fix get_all_datasets call

---
 usr/src/cmd/zfs/zfs_main.c | 22 ++++++++++------------
 1 file changed, 10 insertions(+), 12 deletions(-)

diff --git a/usr/src/cmd/zfs/zfs_main.c b/usr/src/cmd/zfs/zfs_main.c
index 697bd5abbc..21998a37f6 100644
--- a/usr/src/cmd/zfs/zfs_main.c
+++ b/usr/src/cmd/zfs/zfs_main.c
@@ -6834,22 +6834,20 @@ unshare_unmount(int op, int argc, char **argv)
 		 * per shared dataset downstream.
 		 */
 		if (op == OP_SHARE) {
-			zfs_handle_t **dslist = NULL;
-			size_t count = 0;
-			get_all_datasets(&dslist, &count, B_FALSE);
+			get_all_cb_t dslist = { 0 };
+			get_all_datasets(&dslist, B_FALSE);
 
 			if (count > 0) {
 				sa_init_selective_arg_t sharearg;
-				sharearg.zhandle_arr = dslist;
-				sharearg.zhandle_len = count;
-				if ((ret = zfs_init_libshare_arg(
-				    zfs_get_handle(dslist[0]),
-				    SA_INIT_SHARE_API_SELECTIVE, &sharearg))
-				    != SA_OK) {
+				sharearg.zhandle_arr = dslist.cb_handles;
+				sharearg.zhandle_len = dslist.cb_used;
+				if ((ret = zfs_init_libshare_arg(g_zfs,
+				    SA_INIT_SHARE_API_SELECTIVE, &sharearg)) !=
+				        SA_OK) {
 					(void) fprintf(stderr, gettext(
-					    "Could not initialize libshare,"
-					    "%d"), ret);
-					return (1);
+					    "Could not initialize libshare,
+					        %d"), ret);
+					return (ret);
 				}
 			}
 		}
-- 
2.17.2 (Apple Git-113)

