commit 45b43dbd4539bc56d0b2312266a942df77e2935d (refs/changes/53/2553/3)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2017-09-12T18:35:36-07:00 (2 years, 1 month ago)
    
    MANTA-3421 binder crashes on EHOSTUNREACH

diff --git a/lib/server.js b/lib/server.js
index 38cac7c..eae6ee0 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -351,10 +351,11 @@ function createServer(options) {
         assert.object(options.log, 'options.log');
         assert.optionalObject(options.recursion, 'options.recursion');
         assert.string(options.dnsDomain, 'options.dnsDomain');
+        var log = options.log;
 
         var server = mname.createServer({
                 name: options.name || 'binder',
-                log: options.log
+                log: log
         });
 
         server.on('query', function onQuery(query, cb) {
@@ -451,6 +452,22 @@ function createServer(options) {
                 }, 'DNS query');
         });
 
+        server.on('error', function (err) {
+                /*
+                 * The EHOSTUNREACH error seems to have a numeric errno
+                 * in its .code property instead of a string. We'll check for
+                 * a string instead so we stand a chance of testing this on
+                 * other platforms (instead of depending on the exact errno
+                 * value).
+                 */
+                if (err.toString().indexOf('EHOSTUNREACH') != -1) {
+                        log.error(err, 'cannot reply to DNS traffic: ' +
+                            'is there asymmetric routing?');
+                        return;
+                }
+                throw (err);
+        });
+
         server.start = function start(callback) {
                 var done = 0;
                 server.listenUdp({
