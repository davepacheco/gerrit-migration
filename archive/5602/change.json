{"project":"joyent/illumos-joyent","branch":"master","id":"I0d3f2b61dcfb18edace4fd257054f6fdbe07c99c","number":"5602","subject":"OS-7492 i40e Tx freeze when b_cont chain exceeds 8 descriptors Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Rob Johnston \u003crob.johnston@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/5602","commitMessage":"OS-7492 i40e Tx freeze when b_cont chain exceeds 8 descriptors\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Rob Johnston \u003crob.johnston@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1550281773,"lastUpdated":1551226184,"open":false,"status":"MERGED","comments":[{"timestamp":1550281773,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1550281931,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\nThis isn\u0027t totally finished yet. E.g., I still have to convert all the VERIFY to ASSERT. I\u0027m still in the process of testing but I wanted to get something up as this code seems to work."},{"timestamp":1550334397,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(11 comments)\n\nSeriously, this is great work. I\u0027m really happy with how this turned out. Thanks for all the hard effort to get here."},{"timestamp":1550608058,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(11 comments)"},{"timestamp":1550608070,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1550614319,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\nThis looks great, thanks again for all the hard work here."},{"timestamp":1550948438,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 2: Code-Review+1\n\n\"If header and payload share the first descriptor, then the controller will count the descriptor twice.\"\n\nThis fucking card!   The number of corner cases and non-obvious constraints is bonkers.\n\nThe code is solid and very well commented.  Thanks again fixing this."},{"timestamp":1551218040,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nTesting notes added to ticket."},{"timestamp":1551219593,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1551226042,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1551226158,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1551226184,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"4","revision":"0d3f2b61dcfb18edace4fd257054f6fdbe07c99c","parents":["46c76a4f2a42a132a2957bec5f12b68322f731a7"],"ref":"refs/changes/02/5602/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1551226158,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550614319,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550948438,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551219593,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1551226184,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":581,"deletions":-190}],"sizeInsertions":593,"sizeDeletions":-194},"patchSets":[{"number":"1","revision":"89d5298f307acf32ca9795cf5b0b126028e41d78","parents":["7a899a42e86d8d3e6d7d3eaf31bcacc6411fbb74"],"ref":"refs/changes/02/5602/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1550281773,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2215,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Make soff const?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2215,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2218,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"While it\u0027s fine to start these all as VERIFY\u0027s at some point we may have a high packet rate and the cost will add up. Something to measure in the future, not something we need to change now. This is a general thing here. Again, not asking for anything to change at this point in time."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2218,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yep. This is just a new thing I do: everything starts as VERIFY while I\u0027m developing/testing. Then I convert it to ASSERT (unless it should truly stay VERIFY). I pushed this a little early and that\u0027s why it\u0027s still VERIFY."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2224,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We\u0027re comparing both things on either side of the VERIFY?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2224,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Heh, looks like some botched line during a refactoring. I can no longer tell what I meant to assert here so I\u0027ll remove it."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2346,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor style question: mp isn\u0027t used beyond the assignment here and at the msgsize() below. Any reason not to just use mp and make it the const argument?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2346,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I could certainly just use mp but I still can\u0027t mark it const because msgsize() doesn\u0027t take a const (even though it should) and the compiler will complain."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2386,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Because we duplicate this logic, it may be worth a static inline function that we can use. But since it already seems fine, no need to change this."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2386,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I went ahead and did this anyways since it cleans up the code quite a bit."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2494,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"descriptors?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2494,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2495,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"i40e_lso_num_descs?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2495,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2555,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor note, but I don\u0027t see any use of mp after this assignment."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2555,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Good catch. I\u0027ll get rid of nmp and just use mp."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2557,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Would you mind adding a comment describing what cpoff tacks? I realized that I got a bit confused while reading and eventually worked it out."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2557,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2575,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This seems like a smart call."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2575,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"The code gets pretty brutal otherwise. And with all the additional logic not sure the other way would be faster or slower."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2621,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think I understand why we strictly speaking don\u0027t have to increment cpoff here. However, it threw me off when trying to understand this initially that when we move to the next one at +2611, we do, but here we don\u0027t. I think, even though it\u0027s unnecessary, it\u0027d be useful to zero cpoff to make it clearer that it is the offset into the mblk data and because we changed that it reset (even though in this case because its zero bytes long, cpoff must be zero and therefore there\u0027s nothing to change)."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2621,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, I can see how this is a bit confusing. In one case we have input mblks that are zero-length; in the other we have non-zero-length mblks that we have fully consumed. But both cases look very similar. I\u0027ll add cpoff \u003d 0 here as it doesn\u0027t hurt anything. I also added a comment above the preceding check to make it clear we are checking for a fully consumed header mblk, not zero-length."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":608,"deletions":-190}],"sizeInsertions":620,"sizeDeletions":-194},{"number":"2","revision":"3ca4f783b26ba9e4148bcacde14d489c6b95fef7","parents":["7a899a42e86d8d3e6d7d3eaf31bcacc6411fbb74"],"ref":"refs/changes/02/5602/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1550608070,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550614319,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551219593,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550948438,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":581,"deletions":-190}],"sizeInsertions":593,"sizeDeletions":-194},{"number":"3","revision":"eaf58b147a6326234e24ee09aba216e310d5a59b","parents":["46c76a4f2a42a132a2957bec5f12b68322f731a7"],"ref":"refs/changes/02/5602/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1551226042,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550614319,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551219593,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550948438,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":581,"deletions":-190}],"sizeInsertions":593,"sizeDeletions":-194},{"number":"4","revision":"0d3f2b61dcfb18edace4fd257054f6fdbe07c99c","parents":["46c76a4f2a42a132a2957bec5f12b68322f731a7"],"ref":"refs/changes/02/5602/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1551226158,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550614319,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551219593,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1551226184,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550948438,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":581,"deletions":-190}],"sizeInsertions":593,"sizeDeletions":-194}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}