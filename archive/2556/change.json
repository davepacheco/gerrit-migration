{"project":"joyent/smartos-live","branch":"master","id":"I32d316e5cd22b5994d4e95e0e1216a4fcd9e5be7","number":"2556","subject":"PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/2556","commitMessage":"PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1505320351,"lastUpdated":1506374152,"open":false,"status":"MERGED","comments":[{"timestamp":1505320351,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1505320360,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 288231b5664b86f77c371a419df19ebb4f5f9dba\n    \n    PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint"},{"timestamp":1505320392,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505402423,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(7 comments)"},{"timestamp":1505423240,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1505423242,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit bb60b140e328adbd29b14827fcef140f9af384be\n    \n    updates based on CR"},{"timestamp":1505423250,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1505423280,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505492531,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1505522379,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1505522382,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 7211011c2a448ea6e94106f60508954397a7a535\n    \n    fail mdata-fetch when smf import fails"},{"timestamp":1505522437,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505765148,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nFWIW: I created https://devhub.joyent.com/jira/browse/OS-6353 for the issue julien mentioned where we\u0027d like a mechanism for force-failing a provision."},{"timestamp":1505771407,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1505771409,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 1d0ba6f1da8ed9bec7378c13b402bf9bbf952c3d\n    \n    fail mdata-fetch when smf import fails\n    \n    commit cf298403ca292abc82a158196ed9a956dc6c0700\n    \n    updates based on CR\n    \n    commit 9bd453bacca34226a35bfec39856665949257559\n    \n    PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint"},{"timestamp":1505771449,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1505783868,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1505783870,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 7eab5e8081b428485d3b62a91acbffaf2b7c5131\n    \n    rewrite in attempt to work with newfangled lxinit hook community ecosystem\n    \n    commit 9c91bdbb5c3e5880407f115ac67127803e5795b5\n    \n    rename to lxinit-post-networking-hook"},{"timestamp":1505783909,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505856109,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 6."},{"timestamp":1505856110,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 905b73cf72617856f8b2888b6c0518b462ece75a\n    \n    rename new hook to match OS-6354 prototype"},{"timestamp":1505856149,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505921953,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 7."},{"timestamp":1505921955,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 47ad28968bb40a4ac8e5cfee08e6208345733f8f\n    \n    Add missing install bit"},{"timestamp":1505921994,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505977911,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 8."},{"timestamp":1505977913,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 873a60dc30d5676a7c0488ae02452f19eb3741bc\n    \n    fix issue with mode in mdata-fetch, switch to stderr, initialize variables"},{"timestamp":1505977957,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506028038,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 8:\n\n(5 comments)"},{"timestamp":1506061186,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 9."},{"timestamp":1506061187,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 2189b3fd13acfdf2e39c4fa16ffed303433cce74\n    \n    Check for unexpected nvlist crud, ignoring \u0027decorations\u0027 which might be in the way"},{"timestamp":1506061235,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506061261,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8:\n\n(5 comments)"},{"timestamp":1506083944,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1506097538,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1506105181,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1506105836,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1506107167,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 9:\n\nsure that looks fine"},{"timestamp":1506108897,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 10."},{"timestamp":1506108899,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 3d3f9f20ecb0c7dcc89005822239c7674771989a\n    \n    update to use waitpid instead of wait"},{"timestamp":1506108939,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506119605,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1506373686,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 10: Integration-Approval+1"},{"timestamp":1506374104,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 11: Commit message was updated."},{"timestamp":1506374113,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 12: Patch Set 11 was rebased"},{"timestamp":1506374125,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"},{"timestamp":1506374152,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"12","revision":"f881d616c90f8aadceea775718696e0f4f8d0a34","parents":["aa879239b6ea631bdad8ab48b52b09a262e17da4"],"ref":"refs/changes/56/2556/12","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1506374113,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506108939,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506119605,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506373686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1506374125,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":68,"deletions":-3},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":243,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":467,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"d4a467e8ff122dd4167f9bbb3b8161481030be7b","parents":["84d5cbd190a2601a5deea0758345b2bcdd583ebf"],"ref":"refs/changes/56/2556/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505320351,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505320392,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":214,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should \"smf_exit_err_fatal\" be upper cased?"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":214,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yes. :( Thanks for catching."},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":231,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What is $volumes? Should this be ${volumes_added}?"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":231,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"yes. This was renamed and I missed this one. :/"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":249,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What happens if this fails?"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":249,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"If this fails, we\u0027ll continue on but any NFS volumes won\u0027t be mounted. Do you think we should fail more obviously in this case and put the mdata-fetch service into maint?"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":249,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"For the record, discussed in private:\n\nDiscussed in private:\n\njgilli re: https://cr.joyent.us/#/c/2556/1/overlay/generic/lib/svc/method/mdata-fetch@249\n\n\n[11:56 AM] \nI’m wondering what it means for a user to start a container that mounts one or more volume and have those volumes not mounted\n\n\n[11:56 AM] \nbut I realize I’m not too familiar with how people run non-docker containers on our infrastructure\n\n\n[11:56 AM] \ndo their rely on SMF services in their images to run their applications?\n\n\n[11:57 AM] \nI mean, on custom SMF services\n\n\n[11:57 AM] \nthat run after all the “builtin” ones have started\n\n\n[12:06 PM] \njoshw I think you\u0027re right and in that case we\u0027ll be better off failing.\n\n\n[12:07 PM] \nI can do that.\n\n\n[12:07 PM] \njgilli but then they’d end up with a running instance with a failed service?\n\n\n[12:07 PM] \njoshw when mdata-fetch fails, the user\u0027s user-script will never get run and the provision will fail.\n\n\n[12:07 PM] \nbecause mdata-exec will not run.\n\n\n[12:07 PM] \njgilli so they wouldn’t be able to just use CloudAPI to determine whether their instance should be re-created/restarted or if anything is going wrong\n\n\n[12:07 PM] \nah\n\n\n[12:08 PM] \nwhat makes the provision fail when the user-script doesn’t run?\n\n\n[12:09 PM] \njoshw the thing that makes the provision succeed is this block here: https://github.com/joyent/smartos-live/blob/master/overlay/generic/lib/svc/method/mdata-execute#L32-L36\nGitHub\njoyent/smartos-live\nsmartos-live - For more information, please see http://smartos.org/ For any questions that aren\u0027t answered there, please join the SmartOS discussion list: http://smartos.org/smartos-mailing-list/\n \n\n\n[12:09 PM] \njgilli ah right!\n\n\n[12:09 PM] \njoshw and mdata-exec depends on mdata-fetch.\n\n\n[12:09 PM] \njgilli ok\n\n\n[12:09 PM] \njoshw So if we fail in mdata-fetch, the provision will fail. Which seems reasonable if they wanted volumes.\n\n\n[12:10 PM] \nAnd aren\u0027t going to get those volumes.\n\n\n[12:10 PM] \njgilli would the provision failure happen after a timeout then? If so, how long is that timeout?\n\n\n[12:10 PM] \njoshw I believe 5 minutes.\n\n\n[12:11 PM] \njgilli ok, and provisioning success is determined by periodically polling for the existence of /var/svc/provision_success?\n\n\n[12:11 PM] \nand if so what is doing that?\n\n\n[12:11 PM] \nthe CNAPI task?\n\n\n[12:11 PM] \nor vmadm?\n\n\n[12:11 PM] \njoshw it actually just waits for /var/svc/provisioning to disappear. It doesn\u0027t care what happens to it. :slightly_smiling_face: And yes, both vmadm and vmadmd watch for that.\n\n\n[12:12 PM] \nvmadmd watches just in case vmadm fails.\n\n\n[12:12 PM] \n(i.e. is killed, whatever)\n\n\n[12:12 PM] \nthe vm will get marked \u0027failed\u0027 if we hit the timeout without seeing that file disappear.\n\n\n[12:13 PM] \nAnd if the cn-agent task is still running, that\u0027ll also be failed at that point.\n\n\n[12:13 PM] \njgilli ok, could vmadm be made to watch for /var/svc/provision_failure and mdata-fetch to create that file so that provisioning failures could be detected quicker?\n\n\n[12:13 PM] \njoshw yes.\n\n\n[12:13 PM] \nThat\u0027s something I\u0027ve thought about before, but just never done.\n\n\n[12:13 PM] \njgilli of course that’d be a platform change so usual caveats apply\n\n\n[12:13 PM] \njoshw yeah\n\n\n[12:13 PM] \njgilli ok, thanks for all the context :slightly_smiling_face:\n\n\n[12:14 PM] \nso I think for now it’d be better to fail the provision on timeout, and we can create a ticket to have that provision fail quicker in the future\n\n\n[12:14 PM] \nwhat do you think?\n\n\n[12:16 PM] \njoshw Yep, I can do that.\n\n\n[12:16 PM] \njgilli awesome :slightly_smiling_face:"},{"file":"src/vm/lib/metadata/agent.js","line":1376,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name this callback?"},{"file":"src/vm/lib/metadata/agent.js","line":1376,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"yep, good call."},{"file":"src/volumeinfo/Makefile","line":28,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Just for my own education, why do we build this with -m32? To make sure it works on all types of images, including 32bits images?"},{"file":"src/volumeinfo/Makefile","line":28,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yeah, I\u0027m pretty sure that\u0027s the reason. I just copied what routeinfo was already doing though."},{"file":"src/volumeinfo/Makefile","line":86,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is that intentional?"},{"file":"src/volumeinfo/main.c","line":84,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I would suggest using 10 as the third argument to \"strncmp\", otherwise \"type\" could be a string prefixed but not equal to \"tritonnfs\" and the test would succeed.\n\nI\u0027m actually not sure that using \"strncmp\" here instead of \"strcmp\" is beneficial, since \"tritonnfs\" is null-terminated and not user-provided, so we know strcmp would stop reading memory at some point, regardless of where \"type\" points to."},{"file":"src/volumeinfo/main.c","line":84,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"good point. I\u0027ll change to strcmp."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":60,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/volumeinfo/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/volumeinfo/Makefile","type":"ADDED","insertions":122,"deletions":0},{"file":"src/volumeinfo/main.c","type":"ADDED","insertions":151,"deletions":0}],"sizeInsertions":347,"sizeDeletions":-1},{"number":"2","revision":"bcc6d54178771cc0fb8c48a2ca0260f5d8ba74b9","parents":["84d5cbd190a2601a5deea0758345b2bcdd583ebf"],"ref":"refs/changes/56/2556/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505423240,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505423280,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":60,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/volumeinfo/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/volumeinfo/Makefile","type":"ADDED","insertions":122,"deletions":0},{"file":"src/volumeinfo/main.c","type":"ADDED","insertions":151,"deletions":0}],"sizeInsertions":347,"sizeDeletions":-1},{"number":"3","revision":"29d180693f40e0bcdcb446666f55a99c723d900e","parents":["84d5cbd190a2601a5deea0758345b2bcdd583ebf"],"ref":"refs/changes/56/2556/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505522379,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505522437,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":67,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/volumeinfo/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/volumeinfo/Makefile","type":"ADDED","insertions":122,"deletions":0},{"file":"src/volumeinfo/main.c","type":"ADDED","insertions":151,"deletions":0}],"sizeInsertions":354,"sizeDeletions":-1},{"number":"4","revision":"b4e552a195fac61016e43c90f0d68be8c0c33eb6","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505771407,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505522437,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":67,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/volumeinfo/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/volumeinfo/Makefile","type":"ADDED","insertions":122,"deletions":0},{"file":"src/volumeinfo/main.c","type":"ADDED","insertions":151,"deletions":0}],"sizeInsertions":354,"sizeDeletions":-1},{"number":"5","revision":"ea9611572c651e708af9f5dc010905bfea3f4d3b","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505783868,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505783909,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":67,"deletions":-1},{"file":"src/Makefile","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lxinit-post-networking-hook/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lxinit-post-networking-hook/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lxinit-post-networking-hook/main.c","type":"ADDED","insertions":222,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":444,"sizeDeletions":-4},{"number":"6","revision":"b9e84609a72c8e23b969e9d0ec8f5ad7683962ea","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505856109,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505856149,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":67,"deletions":-1},{"file":"src/Makefile","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":222,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":444,"sizeDeletions":-4},{"number":"7","revision":"37539272c48bb8a85b10c9c58a37fd380231c01a","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505921953,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505921994,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":67,"deletions":-1},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":222,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":445,"sizeDeletions":-4},{"number":"8","revision":"7f1d8f2a2803aa70859cbc78b6c256c9c09c1bc2","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505977911,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505977957,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":106,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does that mean that before the output would go to stdout and now it\u0027s going to stderr? If so does that matter?"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":106,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yes it means going to stderr, and no it doesn\u0027t matter in this case as both will be the SMF service log."},{"file":"src/lx_hook_postnet/Makefile","line":51,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does lx_hook_postnet actually use custr now?"},{"file":"src/lx_hook_postnet/Makefile","line":51,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Sadly it does indirectly through json-nvlist."},{"file":"src/lx_hook_postnet/Makefile","line":60,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"ditto."},{"file":"src/lx_hook_postnet/Makefile","line":60,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"same answer. :)"},{"file":"src/lx_hook_postnet/Makefile","line":95,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is that intentional?"},{"file":"src/lx_hook_postnet/Makefile","line":95,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This is copied from routeinfo. I\u0027m not sure what uses the \"lint\" target, but I assumed it\u0027s used for components that are part of illumos... I could try to dig in if you think this is important."},{"file":"src/lx_hook_postnet/main.c","line":205,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What if this condition is not true? Does it mean the sdc:volumes metadata is malformed and if so, should we error?"},{"file":"src/lx_hook_postnet/main.c","line":205,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":68,"deletions":-3},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":222,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":446,"sizeDeletions":-6},{"number":"9","revision":"7be8ea1050ea8f69e45d43d5ca0a1620578cde52","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/9","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1506061186,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506061235,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":227,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I am not completely sure about all of the interaction with the metadata scripts. Do they only run once or on every boot? If on every boot and the nfs mount metadata is updated, is it ok to leave old NFS entries lying around?"},{"file":"overlay/generic/lib/svc/method/mdata-fetch","line":227,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This runs on every boot, and at this time we don\u0027t support removing or changing nfs volumes. When we do add support for removing, we\u0027ll need some process to actually force the removal.\n\nAt this script, all we can know is the current ones that were requested to be mounted. If there are other NFS mounts, we have no way to know whether those were added by a previous boot, or manually by the user. So we can\u0027t remove anything automatically here I don\u0027t think."},{"file":"src/lx_hook_postnet/main.c","line":131,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"You should probably use waitid here and wait for the specific pid."},{"file":"src/lx_hook_postnet/main.c","line":131,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"good point, I\u0027ll do that. Thanks!"},{"file":"src/lx_hook_postnet/main.c","line":131,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Actually... Did you mean I should do waitid() and then waitpid() or is just doing waitpid() instead of wait sufficient?"},{"file":"src/lx_hook_postnet/main.c","line":131,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Would something like:\n\n    diff --git a/src/lx_hook_postnet/main.c b/src/lx_hook_postnet/main.c\n    index 31dc1023..adc9382d 100644\n    --- a/src/lx_hook_postnet/main.c\n    +++ b/src/lx_hook_postnet/main.c\n    @@ -80,6 +80,7 @@ static void\n     doNfsMount(const char *nfsvolume, const char *mountpoint, const char *mode)\n     {\n         pid_t pid;\n    +    pid_t waitee;\n         int status;\n         int ret;\n         char opts[MAX_MNTOPT_STR];\n    @@ -128,8 +129,11 @@ doNfsMount(const char *nfsvolume, const char *mountpoint, const char *mode)\n\n         /* parent */\n\n    -    while (wait(\u0026status) !\u003d pid) {\n    -        /* EMPTY */;\n    +    while ((waitee \u003d waitpid(pid, \u0026status, 0)) !\u003d pid) {\n    +        if (waitee \u003d\u003d -1 \u0026\u0026 errno !\u003d EINTR) {\n    +            fatal(ERR_EXEC_FAILED, \"failed to get exit status of %d: %s\",\n    +                (int) pid, strerror(errno));\n    +        }\n         }\n\n         if (WIFEXITED(status)) {\n\nbe ok?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":68,"deletions":-3},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":239,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":463,"sizeDeletions":-6},{"number":"10","revision":"d1bd17a110acfc8e455a82aa8ce2e965e7d31976","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/10","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1506108897,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506108939,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506119605,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506373686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":68,"deletions":-3},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":243,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":467,"sizeDeletions":-6},{"number":"11","revision":"32d316e5cd22b5994d4e95e0e1216a4fcd9e5be7","parents":["faa8f38c6c58e2324583d187f8fb89981fba1216"],"ref":"refs/changes/56/2556/11","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1506374104,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506108939,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506119605,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506373686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":68,"deletions":-3},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":243,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":467,"sizeDeletions":-6},{"number":"12","revision":"f881d616c90f8aadceea775718696e0f4f8d0a34","parents":["aa879239b6ea631bdad8ab48b52b09a262e17da4"],"ref":"refs/changes/56/2556/12","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1506374113,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506108939,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506119605,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1506374125,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506373686,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"overlay/generic/lib/svc/method/mdata-fetch","type":"MODIFIED","insertions":68,"deletions":-3},{"file":"src/Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"src/dockerinit/src/docker-common.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/lx_hook_postnet/.gitignore","type":"ADDED","insertions":2,"deletions":0},{"file":"src/lx_hook_postnet/Makefile","type":"ADDED","insertions":135,"deletions":0},{"file":"src/lx_hook_postnet/main.c","type":"ADDED","insertions":243,"deletions":0},{"file":"src/manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":467,"sizeDeletions":-6}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}