From bd7b03999c097df4468dcc31acab7cf5e6fa2056 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Thu, 1 Sep 2016 14:22:12 -0700
Subject: [PATCH] joyent/node-cueball#15 Backends appear without IP addresses
 when using CNAMEs

---
 lib/resolver.js | 29 +++++++++++++++++++++++++++--
 1 file changed, 27 insertions(+), 2 deletions(-)

diff --git a/lib/resolver.js b/lib/resolver.js
index 714bea4..e6d6cea 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -774,12 +774,21 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 		var answers = msg.getAnswers();
 		var minTTL = undefined;
 		if (type === 'A' || type === 'AAAA') {
-			ans = answers.map(function (a) {
+			var ans = [];
+			answers.forEach(function (a) {
+				if (a.type !== type) {
+					if (a.type === 'CNAME' ||
+					    a.type === 'DNAME')
+						return;
+					self.r_log.warn('got unsupported ' +
+					    'answer rrtype: %s', a.type);
+					return;
+				}
 				if (minTTL === undefined ||
 				    a.ttl < minTTL) {
 					minTTL = a.ttl;
 				}
-				return ({
+				ans.push({
 					name: a.name,
 					address: a.target
 				});
@@ -789,6 +798,14 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 			var cache = {};
 			var addns = msg.getAdditionals();
 			addns.forEach(function (rr) {
+				if (rr.type !== type) {
+					if (rr.type === 'CNAME' ||
+					    rr.type === 'DNAME')
+						return;
+					self.r_log.warn('got unsupported ' +
+					    'additional rrtype: %s', rr.type);
+					return;
+				}
 				if (rr.target) {
 					if (minTTL === undefined ||
 					    rr.ttl < minTTL) {
@@ -800,6 +817,14 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 				}
 			});
 			ans = answers.map(function (a) {
+				if (a.type !== type) {
+					if (a.type === 'CNAME' ||
+					    a.type === 'DNAME')
+						return;
+					self.r_log.warn('got unsupported ' +
+					    'answer rrtype: %s', a.type);
+					return;
+				}
 				if (minTTL === undefined ||
 				    a.ttl < minTTL) {
 					minTTL = a.ttl;
-- 
2.21.0

