From 3b1b3eaa36a409377fc34fa6497526b51a5d378e Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Thu, 1 Sep 2016 14:22:12 -0700
Subject: [PATCH] joyent/node-cueball#15 Backends appear without IP addresses
 when using CNAMEs

---
 lib/resolver.js | 34 ++++++++++++++++++++++++++++++----
 1 file changed, 30 insertions(+), 4 deletions(-)

diff --git a/lib/resolver.js b/lib/resolver.js
index 714bea4..ebc004d 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -774,12 +774,21 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 		var answers = msg.getAnswers();
 		var minTTL = undefined;
 		if (type === 'A' || type === 'AAAA') {
-			ans = answers.map(function (a) {
+			ans = [];
+			answers.forEach(function (a) {
+				if (a.type !== type) {
+					if (a.type === 'CNAME' ||
+					    a.type === 'DNAME')
+						return;
+					self.r_log.warn('got unsupported ' +
+					    'answer rrtype: %s', a.type);
+					return;
+				}
 				if (minTTL === undefined ||
 				    a.ttl < minTTL) {
 					minTTL = a.ttl;
 				}
-				return ({
+				ans.push({
 					name: a.name,
 					address: a.target
 				});
@@ -789,6 +798,14 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 			var cache = {};
 			var addns = msg.getAdditionals();
 			addns.forEach(function (rr) {
+				if (rr.type !== type) {
+					if (rr.type === 'CNAME' ||
+					    rr.type === 'DNAME')
+						return;
+					self.r_log.warn('got unsupported ' +
+					    'additional rrtype: %s', rr.type);
+					return;
+				}
 				if (rr.target) {
 					if (minTTL === undefined ||
 					    rr.ttl < minTTL) {
@@ -799,7 +816,16 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 					cache[rr.name].push(rr.target);
 				}
 			});
-			ans = answers.map(function (a) {
+			ans = [];
+			answers.forEach(function (a) {
+				if (a.type !== type) {
+					if (a.type === 'CNAME' ||
+					    a.type === 'DNAME')
+						return;
+					self.r_log.warn('got unsupported ' +
+					    'answer rrtype: %s', a.type);
+					return;
+				}
 				if (minTTL === undefined ||
 				    a.ttl < minTTL) {
 					minTTL = a.ttl;
@@ -807,7 +833,7 @@ CueBallDNSResolver.prototype.resolve = function (domain, type, timeout) {
 				var obj = { name: a.target, port: a.port };
 				if (cache[a.target])
 					obj.additionals = cache[a.target];
-				return (obj);
+				ans.push(obj);
 			});
 
 		} else {
-- 
2.21.0

