From ca1b4d98cce447dc9b9fd586a336958e34fd6057 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Wed, 13 Jul 2016 12:48:32 -0700
Subject: [PATCH] joyent/node-manta#265 `mfind --json,-j`

---
 CHANGES.md   |  8 ++++++++
 bin/mfind    | 14 ++++++++++++--
 package.json |  2 +-
 3 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index ec21871..d9fb049 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -2,6 +2,14 @@
 
 ## not yet released
 
+## 3.1.0
+
+- joyent/node-manta#265 Add `--json, -j` option to `mfind`. E.g.:
+
+        $ mfind -j ~~/stor/tmp
+        {"name":"foo-file.gz","etag":"142ad91b-73d8-6cb4-9cd9-efacf7df7a9a","size":229535627,"type":"object","mtime":"2014-10-08T22:53:25.146Z","durability":2,"parent":"/trent.mick/stor/tmp","depth":0}
+        {"name":"foo.imgmanifest","etag":"88ac47b9-e53f-c065-b446-e2d0455c0c00","size":1052,"type":"object","mtime":"2014-10-08T22:52:44.298Z","durability":2,"parent":"/trent.mick/stor/tmp","depth":0}
+
 ## 3.0.0
 
 - joyent/node-manta#246 Update many dependencies to come up to the modern age.
diff --git a/bin/mfind b/bin/mfind
index 8a6bfad..c213f2a 100755
--- a/bin/mfind
+++ b/bin/mfind
@@ -71,6 +71,11 @@ var OPTIONS_PARSER = dashdash.createParser({
             type: 'positiveInteger',
             help: 'only return items less than this depth',
             helpArg: 'DEPTH'
+        },
+        {
+            names: ['json', 'j'],
+            type: 'bool',
+            help: 'Output a newline-separated JSON stream of find results.'
         }
     ])
 });
@@ -118,9 +123,14 @@ function parseOptions() {
 
 
 function printEntry(opts, obj) {
-    console.log(obj.parent + (obj.name ? ('/' + obj.name) : ''));
-    if (opts.limit && (++TOTAL_ENTRIES >= opts.limit))
+    if (opts.json) {
+        console.log(JSON.stringify(obj));
+    } else {
+        console.log(obj.parent + (obj.name ? ('/' + obj.name) : ''));
+    }
+    if (opts.limit && (++TOTAL_ENTRIES >= opts.limit)) {
         process.exit(0);
+    }
 }
 
 
diff --git a/package.json b/package.json
index 2307d24..5b01a84 100644
--- a/package.json
+++ b/package.json
@@ -7,7 +7,7 @@
         "type": "git",
         "url": "git://github.com/joyent/node-manta.git"
     },
-    "version": "3.0.0",
+    "version": "3.1.0",
     "main": "./lib/index.js",
     "dependencies": {
         "assert-plus": "^1.0.0",
-- 
2.21.0

