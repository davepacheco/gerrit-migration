commit aae6a7c37979a03c3cc841ac0a48d24fdcfe24cb (refs/changes/08/4708/2)
Author: Josh Wilsdon <josh@wilsdon.ca>
Date:   2018-08-17T10:23:45-07:00 (1 year, 2 months ago)
    
    TRITON-703 NAPI should use latest node-triton-metrics and expose nodejs metrics

diff --git a/Makefile b/Makefile
index bacf633..6b3b05b 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright 2017, Joyent, Inc.
+# Copyright 2018, Joyent, Inc.
 #
 
 #
@@ -38,11 +38,11 @@ SMF_MANIFESTS_IN = smf/manifests/napi.xml.in
 BASH_FILES	:= sbin/napid bin/napictl
 JSON_FILES  := package.json config.json.sample
 
+NODE_PREBUILT_VERSION=v6.14.0
+NODE_PREBUILT_TAG=zone
 ifeq ($(shell uname -s),SunOS)
-	# Allow building on a SmartOS image other than sdc-*-multiarch 15.4.1.
-	NODE_PREBUILT_IMAGE=18b094b0-eb01-11e5-80c1-175dac7ddf02
-	NODE_PREBUILT_VERSION=v0.10.48
-	NODE_PREBUILT_TAG := zone
+␉···# Allow building on other than image sdc-minimal-multiarch-lts@15.4.1.
+␉···NODE_PREBUILT_IMAGE=18b094b0-eb01-11e5-80c1-175dac7ddf02
 endif
 
 include ./tools/mk/Makefile.defs
diff --git a/lib/napi.js b/lib/napi.js
index 6d1147b..11bd9ff 100644
--- a/lib/napi.js
+++ b/lib/napi.js
@@ -108,6 +108,7 @@ function NAPI(opts) {
     });
 
     this.metricsManager.createRestifyMetrics();
+    this.metricsManager.createNodejsMetrics();
     this.metricsManager.listen(function metricsServerStarted() {});
 
     function populateReq(req, res, next) {
diff --git a/package.json b/package.json
index 8cb37b7..423f494 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "napi",
   "description": "SmartDataCenter Networking API",
-  "version": "1.3.0",
+  "version": "1.3.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -24,7 +24,7 @@
     "sdc-clients": "11.1.0",
     "tape": "4.5.1",
     "trace-event": "1.3.0",
-    "triton-metrics": "0.1.1",
+    "triton-metrics": "0.4.0",
     "vasync": "1.6.4",
     "verror": "1.9.0"
   },
@@ -40,7 +40,7 @@
     "test": "make test"
   },
   "engines": {
-    "node": ">=0.6"
+    "node": ">=6.0"
   },
   "license": "MPL-2.0"
 }
