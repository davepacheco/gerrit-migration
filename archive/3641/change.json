{"project":"joyent/sdcadm","branch":"master","id":"I0c6fe547da723ad345a8da055dc79a6ee494d8f1","number":"3641","subject":"TOOLS-1387 sdcadm platform install should fail early if there\u0027s not enough free space on the USB Reviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Orlando Vazquez \u003corlando@joyent.com\u003e Approved by: Tr","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/3641","commitMessage":"TOOLS-1387 sdcadm platform install should fail early if there\u0027s not enough free space on the USB\nReviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Orlando Vazquez \u003corlando@joyent.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1521128092,"lastUpdated":1522248537,"open":false,"status":"MERGED","comments":[{"timestamp":1521128092,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1521128097,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 668fd657fb10f1a67b2cb984c2d1caccc396dbfb\n    \n    TOOLS-1387 sdcadm platform install should fail early if there\u0027s not enough free space on the USB"},{"timestamp":1521128126,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1521128849,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nCompared with previous attempt to deal with ENOSPC errors, two improvements:\n- Always check size before attempt setup, not after a failure.\n- Calculate the required size for the uncompressed PI file, which is what we\n  need to setup after all.\n\nThe following is sample failure output:\n\n        [root@headnode (coal) ~]# /usr/bin/df -k /mnt/usbkey/os\n        Filesystem           1024-blocks        Used   Available Capacity  Mounted on\n        /dev/dsk/c1d0p1          3875289     3863007       12282   100%    /mnt/usbkey\n        [root@headnode (coal) ~]# sdcadm platform install 20180205T164750Z\n        Using channel dev\n        Downloading platform 20180205T164750Z\n            image 1b828e77-b4f7-41f9-a1cb-42f01a49e7e8\n            to /var/tmp/platform-master-20180205T164750Z.tgz\n        Available disk space in USB key is 12 MiB\n        Required disk space for PI setup is 269 MiB\n        Error: Not enough disk space available\n        In order not to have to re-download image, /var/tmp/platform-master-20180205T164750Z.tgz has been left behind.\n        After correcting above problem, rerun `sdcadm platform install /var/tmp/platform-master-20180205T164750Z.tgz`.\n        sdcadm platform install: error: Not enough disk space available\n\nObviously, already tested it locally."},{"timestamp":1521563946,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1521563951,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 81b78a3bc675a81b0017ba1d7bb2a91a8c4f8231\n    \n    TOOLS-1387 sdcadm platform install should fail early if there\u0027s not enough free space on the USB"},{"timestamp":1521563981,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1521834474,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1521834479,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 4709e0ecf2fb6d5a600bf41f2782704db6622a6c\n    \n    TOOLS-1387 sdcadm platform install should fail early if there\u0027s not enough free space on the USB"},{"timestamp":1521834511,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1521847932,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3:\n\n(3 comments)\n\nNeeds a package.json version bump too!"},{"timestamp":1522084377,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1522084383,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit a42affdab413484c9106abef3baa9ef2eeee824a\n    \n    TOOLS-1387 sdcadm platform install should fail early if there\u0027s not enough free space on the USB"},{"timestamp":1522084415,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522084426,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n(3 comments)\n\nDone with all the suggested changes + package.json/CHANGES.md update. Mind to take another look?"},{"timestamp":1522180065,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1522190967,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\n(2 comments)"},{"timestamp":1522248451,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1522248474,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"},{"timestamp":1522248537,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(1 comment)\n\nTrent, shall we update jsprim dependency for sdcadm and urclient then? I\u0027d say that would avoid us some headache regarding npm submodule versions handling"}],"currentPatchSet":{"number":"5","revision":"0c6fe547da723ad345a8da055dc79a6ee494d8f1","parents":["e1381054e3766ba6b1d47bc6ddb1b9ccd7813220"],"ref":"refs/changes/41/3641/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1522248451,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522084415,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522180065,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522180065,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522190967,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522190967,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1522248474,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/platform.js","type":"MODIFIED","insertions":100,"deletions":-57},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":108,"sizeDeletions":-59},"patchSets":[{"number":"1","revision":"fbac869afb8babf5713dc552c59ea67393b29774","parents":["c5abf1fe033e3ae312fc8f55293576232af48ff6"],"ref":"refs/changes/41/3641/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1521128092,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521128126,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/platform.js","type":"MODIFIED","insertions":54,"deletions":-2}],"sizeInsertions":54,"sizeDeletions":-2},{"number":"2","revision":"3c4471768af4ac365e6a1332538121b82febaaf6","parents":["8b187755d53036bf05dbedb387cefbccbb109913"],"ref":"refs/changes/41/3641/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1521563946,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521563981,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/platform.js","type":"MODIFIED","insertions":101,"deletions":-57}],"sizeInsertions":101,"sizeDeletions":-57},{"number":"3","revision":"39103b0d04ab64e32b1ad3909ee61404e77c7188","parents":["0cd8c1613f232ed5c8ab9124c449deebbeda48d9"],"ref":"refs/changes/41/3641/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1521834474,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521563981,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/platform.js","line":541,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Just a tiny nitpick but I think this might look nicer if it was all part of one format() call, or made to be two calls to progress()."},{"file":"lib/platform.js","line":541,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/platform.js","line":715,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"This needs to be converted to an Integer: parseInt(stdout[1], 10)"},{"file":"lib/platform.js","line":715,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/platform.js","line":738,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"parseInt"},{"file":"lib/platform.js","line":738,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/platform.js","type":"MODIFIED","insertions":101,"deletions":-57}],"sizeInsertions":101,"sizeDeletions":-57},{"number":"4","revision":"d893f37d03970891645d967f5e22100bb9e2d7a8","parents":["e1381054e3766ba6b1d47bc6ddb1b9ccd7813220"],"ref":"refs/changes/41/3641/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1522084377,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522084415,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522190967,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522190967,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522180065,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522180065,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"comments":[{"file":"lib/platform.js","line":714,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"It\u0027s fine here, but in general I think we should avoid `parseInt` and use `jsprim.parseInteger` instead because:\n\n```\n\u003e parseInt(\u002742blah\u0027, 10)\n42\n\u003e Number(\u0027\u0027)\n0\n```\n\nhttps://github.com/joyent/node-jsprim#parseintegerstr-options"},{"file":"lib/platform.js","line":714,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027d go for it too, but that\u0027s more than a trivial change right now, b/c we need jsprim \u003e 1.2.x for parseInteger to be available, but our `urclient` module is using such version, which may enter compatibility issues if we don\u0027t update dependencies there too."},{"file":"lib/platform.js","line":747,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Again, fine here because this is more of a nit: My pref when there is an error, is to include all the description in the error message rather than splitting it up with preceding progress messages.\n\nCurrently:\n\n```\n[root@headnode (coal) /var/tmp/p]# sdcadm platform install ./platform-20180327T123104Z.tgz\nUsing platform file ./platform-20180327T123104Z.tgz\nAvailable disk space in USB key is 106 MiB\nRequired disk space for PI setup is 273 MiB\nError: Not enough disk space available\nIn order not to have to re-download image, ./platform-20180327T123104Z.tgz has been left behind.\nAfter correcting above problem, rerun `sdcadm platform install ./platform-20180327T123104Z.tgz`.\nsdcadm platform install: error: Not enough disk space available\n```\n\nFor one, I\u0027m not sure why we are printing the error twice (why the earlier \"Error: Not enough ...\"). Second, if the error had all the details, then those details would show up on the last line of output, \"sdcadm platform install: error: ...\", which would be a little easier for the operator to see."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/platform.js","type":"MODIFIED","insertions":100,"deletions":-57},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":108,"sizeDeletions":-59},{"number":"5","revision":"0c6fe547da723ad345a8da055dc79a6ee494d8f1","parents":["e1381054e3766ba6b1d47bc6ddb1b9ccd7813220"],"ref":"refs/changes/41/3641/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1522248451,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522084415,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522190967,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522190967,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1522248474,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522180065,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522180065,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/platform.js","type":"MODIFIED","insertions":100,"deletions":-57},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":108,"sizeDeletions":-59}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}