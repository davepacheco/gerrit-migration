{"project":"joyent/sdcadm","branch":"master","id":"I304c3673c4482d37ccfbdb6f7fe0a8295a7825d7","number":"5988","subject":"TRITON-1313 Random missing package failures running `sdcadm create` tests Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/5988","commitMessage":"TRITON-1313 Random missing package failures running `sdcadm create` tests\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1553103713,"lastUpdated":1553422458,"open":false,"status":"MERGED","comments":[{"timestamp":1553103713,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1553103717,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 3c9403c68b4eb8fa3eaeacb7d382de5bfcf3aa90\n    \n    TRITON-1313 Random missing package failures running `sdcadm create` tests"},{"timestamp":1553181858,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1: Code-Review+1\n\n(3 comments)"},{"timestamp":1553183433,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(3 comments)\n\nGood suggestions. I\u0027m gonna drop some of the output only sdcadm tests if you\u0027re not opposed"},{"timestamp":1553363112,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1553363117,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit b1976a4c262924c499deda4932c214e43d78bda7\n    \n    TRITON-1313 Random missing package failures running `sdcadm create` tests"},{"timestamp":1553363167,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(1 comment)\n\nAfter some changes and some testing, it\u0027s needed to keep the wait for papi backend thing here. See the tests output after the most recent changes:\n\n    # teardown\n    ok 433 Health restored after check-health tests\n    # Waiting for papi service (Backend error: no connections available)\n    # Waiting for papi service (Backend error: no connections available)\n    # Waiting for papi service (Backend error: no connections available)\n    # Waiting for papi service (Backend error: no connections available)\n    # Waiting for papi service (Backend error: no connections available)\n    ok 434 Done waiting for papi service"},{"timestamp":1553398937,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1553422404,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1553422432,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"},{"timestamp":1553422458,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n\u003e (1 comment)\n\nI\u0027m gonna add that comment as part of one of my next sdcadm changes"}],"currentPatchSet":{"number":"3","revision":"304c3673c4482d37ccfbdb6f7fe0a8295a7825d7","parents":["f17347b930d5759eac4c929dadb44287a2e7ad97"],"ref":"refs/changes/88/5988/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553422404,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553398937,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553398937,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1553422432,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"test/check-health.test.js","type":"MODIFIED","insertions":108,"deletions":-39}],"sizeInsertions":108,"sizeDeletions":-39},"patchSets":[{"number":"1","revision":"32e7a63d1508d10310b8426bd6bd3d56122e9e41","parents":["a75f9f88b5553410ef48cfcad02ae764ff8c14a2"],"ref":"refs/changes/88/5988/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553103713,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553181858,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"test/check-health.test.js","line":106,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could also split on the first empty line."},{"file":"test/check-health.test.js","line":106,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Indeed"},{"file":"test/check-health.test.js","line":125,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"It is a separate discussion, but all these tests of the various forms of `sdcadm check-health ...` take a lot of time, just to test output options."},{"file":"test/check-health.test.js","line":125,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Indeed. I\u0027ve been wondering about just ignoring all but the previous one and the ones testing for failures"},{"file":"test/check-health.test.js","line":309,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Disabling binder could break other services in the stack as well. PAPI might not be the slowest to return to normal. What about waiting on a clean \"check-health\", waiting up to a couple minutes or whatever?"},{"file":"test/check-health.test.js","line":309,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sounds good to me too."},{"file":"test/check-health.test.js","line":309,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"The problem is that PAPI may be healthy and not connected to the backend, which will cause the packages to be missing. Therefore, we need to keep the check here. What I\u0027ll do is to check for general health first, then check for papi backend to be Ok."},{"file":"test/check-health.test.js","line":309,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Okay. This is unfortunately a lot of code to just \"wait until things are working again\". Basically \u0027check-health\u0027 doesn\u0027t work well (perhaps PAPI Ping should not return okay in this case). However, that\u0027s not the fault of this code. \n\nIt would be nice at some point (could be later to not hold up this review) to have a comment on this teardown saying why in testing that just doing health-check wasn\u0027t sufficient."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/check-health.test.js","type":"MODIFIED","insertions":75,"deletions":-16}],"sizeInsertions":75,"sizeDeletions":-16},{"number":"2","revision":"54e1f0e5264fd6337d5e7d3b0cfe8bd1d0d3af98","parents":["f17347b930d5759eac4c929dadb44287a2e7ad97"],"ref":"refs/changes/88/5988/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553363112,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553398937,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553398937,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"test/check-health.test.js","type":"MODIFIED","insertions":108,"deletions":-39}],"sizeInsertions":108,"sizeDeletions":-39},{"number":"3","revision":"304c3673c4482d37ccfbdb6f7fe0a8295a7825d7","parents":["f17347b930d5759eac4c929dadb44287a2e7ad97"],"ref":"refs/changes/88/5988/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553422404,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553398937,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553398937,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1553422432,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"test/check-health.test.js","type":"MODIFIED","insertions":108,"deletions":-39}],"sizeInsertions":108,"sizeDeletions":-39}],"allReviewers":[{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}