From 0179ba177d8de82ccc4e600d3a7e53f42207ca8b Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Tue, 12 Jun 2018 15:29:13 +0000
Subject: [PATCH] OS-6717 bhyve brand boot should not succeed until bhyve
 allocates resources

---
 .../generic/usr/lib/brand/jcommon/statechange | 27 ++++++++++++++-----
 src/vm/node_modules/VM.js                     |  6 ++++-
 2 files changed, 25 insertions(+), 8 deletions(-)

diff --git a/overlay/generic/usr/lib/brand/jcommon/statechange b/overlay/generic/usr/lib/brand/jcommon/statechange
index c332716f..b74a8ea3 100644
--- a/overlay/generic/usr/lib/brand/jcommon/statechange
+++ b/overlay/generic/usr/lib/brand/jcommon/statechange
@@ -47,6 +47,9 @@ export PATH
 # forcemount			7
 # unmount			8
 
+set -A cmdname ready boot forecboot reboot halt uninstalling mount forcemount \
+    unmount
+
 subcommand=$1
 ZONENAME=$2
 ZONEPATH=$3
@@ -883,30 +886,30 @@ function fix_forced_attrs {
 
 case $subcommand in
 pre)
-	case $cmd in
-	0)	# pre-ready
+	case ${cmdname[$cmd]} in
+	ready)
 		fix_forced_attrs
 		setup_fs
 		;;
-	4)	# pre-halt
+	halt)
 		[[ -n "$jst_snowsnap" ]] && cleanup_snapshots
 		cleanup_net
 		;;
 	esac
 	;;
 post)
-	case $cmd in
-	0)	# post-ready
+	case ${cmdname[$cmd]} in
+	ready)
 		[[ -n "$jst_showsnap" ]] && setup_snapshots
 		setup_net
 		setup_fw
 		;;
-	1)	# post-boot
+	boot)
 		# We can't set a rctl until we have a process in the zone to
 		# grab
 		setup_cpu_baseline
 		;;
-	8)	# post-unmount
+	unmount)
 		# Zone halt is hung unmounting, try to recover
 		if [[ $state == 6 ]]; then
 			cleanup_mount "$6"
@@ -916,4 +919,14 @@ post)
 	;;
 esac
 
+# Brands may define their own <brand>_<pre|post>_<ready|boot|...> functions.
+# If such a function exists for this state change, execute it.
+# The return value of the brand hook is not propagated as the exit value because
+# vmadm create does not handle non-zero exits from zoneadm gracefully during
+# provisioning.  This should be fixed.
+brandhook=${ps_brand}_${subcommand}_${cmdname[$cmd]}
+if type -f "$brandhook" >/dev/null 2>&1; then
+	$brandhook
+fi
+
 exit 0
diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 5ee8e9a1..11a1860a 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -10751,6 +10751,10 @@ function startZone(vmobj, opts, callback)
                     cancel = VM.waitForZoneState(vmobj, 'running', _opts,
                         function (err, result) {
 
+                        // Prevent failed assertions in vasync.parallel() caused
+                        // by calling this function multiple times.
+                        cancel = undefined;
+
                         if (err) {
                             if (err.code === 'ETIMEOUT') {
                                 log.info({err: err},
@@ -10778,7 +10782,7 @@ function startZone(vmobj, opts, callback)
                                 stderr: boot_fds.stderr},
                                 'zoneadm failed to boot VM');
                             if (cancel) {
-                                cancel();
+                                cancel(err);
                             }
                             cb2(err);
                             return;
-- 
2.21.0

