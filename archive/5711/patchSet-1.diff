From cdd26867c55cf678cd10fc6593e9be193f3db2bd Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Mon, 4 Mar 2019 14:11:56 +0000
Subject: [PATCH] OS-7604 -faggressive-loop-optimizations should be off
 everywhere

---
 Makefile.defs      | 13 ++++++++++++-
 perl/Makefile      |  2 +-
 uefi-edk2/Makefile |  5 ++---
 3 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/Makefile.defs b/Makefile.defs
index 2c37554..92537db 100644
--- a/Makefile.defs
+++ b/Makefile.defs
@@ -10,7 +10,7 @@
 #
 
 #
-# Copyright (c) 2018, Joyent, Inc.
+# Copyright (c) 2019, Joyent, Inc.
 #
 
 BASE =		$(PWD)
@@ -65,6 +65,17 @@ SEPARATE_BUILD =
 
 CPPFLAGS =	$(SYSINCDIRS:%=-isystem $(DESTDIR)/%)
 
+#
+# As we ship some rather downrev software, there's a good chance it might fall
+# foul of newer GCC's undefined-behavior optimizations; skip those. As it's in
+# general painful to ensure that $(CFLAGS) gets passed down correctly, we'll
+# just set it directly as the compiler...
+#
+ifneq ($(PRIMARY_COMPILER_VER),4)
+GCC += -fno-aggressive-loop-optimizations
+GXX += -fno-aggressive-loop-optimizations
+endif
+
 #
 # We ship platform-private perl modules (e.g. from ntp) in this directory,
 # and using this perl interpeter:
diff --git a/perl/Makefile b/perl/Makefile
index 3d3b938..c8100cc 100644
--- a/perl/Makefile
+++ b/perl/Makefile
@@ -149,7 +149,7 @@ $(CONFIG_PL): $(CONFIG_PL).in Makefile
 
 $(VER.32)/cflags: $(VER.32)/config.over $(VER.32)/Configure
 	(cd $(VER.32) && \
-	    ./Configure -des -Dcc=$(GCC) -Duse64bitint)
+	    ./Configure -des -Dcc="$(GCC)" -Duse64bitint)
 
 $(VER.32)/perldtrace.h: $(VER.32)/cflags
 	(cd $(VER.32) && \
diff --git a/uefi-edk2/Makefile b/uefi-edk2/Makefile
index 9d5bee3..b658499 100644
--- a/uefi-edk2/Makefile
+++ b/uefi-edk2/Makefile
@@ -10,7 +10,7 @@
 #
 
 #
-# Copyright 2018 Joyent, Inc.
+# Copyright (c) 2019, Joyent, Inc.
 #
 
 
@@ -28,8 +28,7 @@ MAKE_ARGS+=	AS=$(STRAPPROTO)/usr/gnu/bin/gas \
 		AR=$(STRAPPROTO)/usr/gnu/bin/gar \
 		LD=$(STRAPPROTO)/usr/gnu/bin/gld \
 		OBJCOPY=$(STRAPPROTO)/usr/gnu/bin/gobjcopy \
-		CC=$(STRAPPROTO)/usr/bin/gcc \
-		CXX=$(STRAPPROTO)/usr/bin/g++
+		CC="$(CC)" CXX="$(CXX)"
 
 ARCH=		X64
 UEFI_TARGET=	RELEASE
-- 
2.21.0

