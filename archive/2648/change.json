{"project":"joyent/sdcadm","branch":"master","id":"I37ea3ecce2b2eef36ed792f8d9a8d5536a0f87e4","number":"2648","subject":"TOOLS-1868 sdcadm: update ufds is broken when there isn\u0027t a manatee instance on the headnode Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/2648","commitMessage":"TOOLS-1868 sdcadm: update ufds is broken when there isn\u0027t a manatee instance on the headnode\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1506364693,"lastUpdated":1507128105,"open":false,"status":"MERGED","comments":[{"timestamp":1506364693,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1506364698,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 44eaccd31fc73ef449a84096d78f9b305ecc1f12\n    \n    TOOLS-1868 sdcadm: update ufds is broken when there isn\u0027t a manatee instance on the headnode"},{"timestamp":1506364724,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506451464,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(7 comments)"},{"timestamp":1506613470,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1506613475,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 9bde2058f919ec9888f47ff3cefa92f0c4f8be41\n    \n    TOOLS-1868 sdcadm: update ufds is broken when there isn\u0027t a manatee instance on the headnode"},{"timestamp":1506613502,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(7 comments)\n\nDefensive measures taken!"},{"timestamp":1506613503,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506955325,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1506955330,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 4cecd278dd6397a91c93f38899f57c4d3c25e59c\n    \n    TOOLS-1868 sdcadm: update ufds is broken when there isn\u0027t a manatee instance on the headnode"},{"timestamp":1506955373,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1506980076,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1507041528,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1507041534,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 01453fe8afbd85aebe3273e532edc0c412e69b1b\n    \n    TOOLS-1868 sdcadm: update ufds is broken when there isn\u0027t a manatee instance on the headnode"},{"timestamp":1507041568,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507045085,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1507128105,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"4","revision":"37ea3ecce2b2eef36ed792f8d9a8d5536a0f87e4","parents":["23834ede8ba891c56f609e204bd414b971cc6ca9"],"ref":"refs/changes/48/2648/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1507041528,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507041568,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507045085,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507045085,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1507128105,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":96,"deletions":-85}],"sizeInsertions":96,"sizeDeletions":-85},"patchSets":[{"number":"1","revision":"33eeffa37386c96b39f61e9f47b3e6cd9be5b377","parents":["8ec9ab10a047556dd9c198d8b3c4c77270bf1180"],"ref":"refs/changes/48/2648/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1506364693,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506364724,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/update-ufds-service-v1.js","line":90,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: why is it \"vms_\" and not \"vms\"?\n\nnit: name this callback (for post-mortem debugging)."},{"file":"lib/procedures/update-ufds-service-v1.js","line":90,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I think b/c it used to be a global `vms` variable. Modified. Also added a name to the callback."},{"file":"lib/procedures/update-ufds-service-v1.js","line":96,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we call next with an error if vms_ is not an array with at least one item in it (an empty array, null, undefined, etc.)?"},{"file":"lib/procedures/update-ufds-service-v1.js","line":96,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Well, it shouldn\u0027t be the case if there isn\u0027t an error but, given how few it costs, I\u0027ve just added it."},{"file":"lib/procedures/update-ufds-service-v1.js","line":109,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we check here that arg.manateeVms is an array with at least one item, which is an object with a \"uuid\" property?"},{"file":"lib/procedures/update-ufds-service-v1.js","line":109,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I think this should be definitely handled by VMAPI but, still, I\u0027ve added the check, but to the previous function."},{"file":"lib/procedures/update-ufds-service-v1.js","line":129,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name this callback."},{"file":"lib/procedures/update-ufds-service-v1.js","line":129,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-ufds-service-v1.js","line":130,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we assert or at least test above that manateeCfg.sdc is an object, as well as manateeCfg.sdc.primary, and that manateeCfg.sdc.primary.zoneId is a UUID?\n\nOtherwise this might throw an undefined error."},{"file":"lib/procedures/update-ufds-service-v1.js","line":130,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"In theory we could go ahead as it is. In practice, performing checks now would help in an hypothetical future where `manatee-adm status` output could be modified. Going defensive as you suggested!"},{"file":"lib/procedures/update-ufds-service-v1.js","line":131,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can we rely on the filter function _always_ returning an array with at least one item?\n\nShould we instead be a bit more defensive and store that filter result in a temporary variable and check that there\u0027s one and only one item in it, otherwise error?"},{"file":"lib/procedures/update-ufds-service-v1.js","line":131,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"On this case I think we could rely but ... wondering if it\u0027s possible for a manatee shard to report no primary. Took the defensive approach here too. Thanks!"},{"file":"lib/procedures/update-ufds-service-v1.js","line":142,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we check before that arg.primaryManatee is an object with a \"server_uuid\" and \"uuid\" properties?"},{"file":"lib/procedures/update-ufds-service-v1.js","line":142,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Actually, I went through all the VMs in the function above so, whatever the primary is, it has already been checked at this point."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":51,"deletions":-85}],"sizeInsertions":51,"sizeDeletions":-85},{"number":"2","revision":"7ba569e813dfe86452e4123a6ce2555051a6f929","parents":["8ec9ab10a047556dd9c198d8b3c4c77270bf1180"],"ref":"refs/changes/48/2648/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1506613470,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506613503,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":96,"deletions":-85}],"sizeInsertions":96,"sizeDeletions":-85},{"number":"3","revision":"fec97533820d24ded88a03156f2979dc145aea4a","parents":["d8cc1075bd81bb0189485bd0ec24c8f57faa9524"],"ref":"refs/changes/48/2648/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1506955325,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506613503,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506980076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506980076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":96,"deletions":-85}],"sizeInsertions":96,"sizeDeletions":-85},{"number":"4","revision":"37ea3ecce2b2eef36ed792f8d9a8d5536a0f87e4","parents":["23834ede8ba891c56f609e204bd414b971cc6ca9"],"ref":"refs/changes/48/2648/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1507041528,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507041568,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1507128105,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507045085,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507045085,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/procedures/update-ufds-service-v1.js","type":"MODIFIED","insertions":96,"deletions":-85}],"sizeInsertions":96,"sizeDeletions":-85}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}