From c4aab12e01baf1402e9702916585745ebf1dcee5 Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Fri, 27 Jul 2018 12:18:00 +0000
Subject: [PATCH] OS-7096 installctx needs kpreempt_disable protection

---
 usr/src/uts/common/disp/thread.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/usr/src/uts/common/disp/thread.c b/usr/src/uts/common/disp/thread.c
index 2cd11a0bce..af000bf4f1 100644
--- a/usr/src/uts/common/disp/thread.c
+++ b/usr/src/uts/common/disp/thread.c
@@ -1068,7 +1068,12 @@ installctx(
 	 * form a loop of the ctxops in newest-to-oldest order.  The 'prev'
 	 * pointers form a loop in the reverse direction, where t_ctx->prev is
 	 * the oldest entry associated with the thread.
+	 *
+	 * The protection of kpreempt_disable is required to safely perform the
+	 * list insertion, since there are inconsistent states between some of
+	 * the pointer assignments.
 	 */
+	kpreempt_disable();
 	if (t->t_ctx == NULL) {
 		ctx->next = ctx;
 		ctx->prev = ctx;
@@ -1081,6 +1086,7 @@ installctx(
 		tail->next = ctx;
 	}
 	t->t_ctx = ctx;
+	kpreempt_enable();
 }
 
 /*
-- 
2.21.0

