From fb5df640e5ccb7d0ed9730cfce3b50656f874df1 Mon Sep 17 00:00:00 2001
From: Bryan Cantrill <bryan@joyent.com>
Date: Thu, 21 Feb 2019 19:07:09 +0000
Subject: [PATCH] OS-7605 add mdb format character for jazzed-up binary output

---
 usr/src/cmd/mdb/common/mdb/mdb_fmt.c          |  78 +++++-
 usr/src/cmd/mdb/test/format/tst.format-j.mdb  |   8 +
 .../cmd/mdb/test/format/tst.format-j.mdb.out  | 230 ++++++++++++++++++
 usr/src/man/man1/mdb.1                        |   7 +-
 4 files changed, 318 insertions(+), 5 deletions(-)
 create mode 100644 usr/src/cmd/mdb/test/format/tst.format-j.mdb
 create mode 100644 usr/src/cmd/mdb/test/format/tst.format-j.mdb.out

diff --git a/usr/src/cmd/mdb/common/mdb/mdb_fmt.c b/usr/src/cmd/mdb/common/mdb/mdb_fmt.c
index 471d918ca5..00ea7bb240 100644
--- a/usr/src/cmd/mdb/common/mdb/mdb_fmt.c
+++ b/usr/src/cmd/mdb/common/mdb/mdb_fmt.c
@@ -21,7 +21,7 @@
 /*
  * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  * Copyright (c) 2017 by Delphix. All rights reserved.
  */
 
@@ -120,6 +120,7 @@ static const char help_match64[] = "long long";
 static const char help_match16[] = "short";
 static const char help_uintptr[] = "hexadecimal uintptr_t";
 static const char help_ctf[] = "whose size is inferred by CTF info";
+static const char help_jazzed[] = "jazzed-up binary unsigned long long";
 
 /*ARGSUSED*/
 static mdb_tgt_addr_t
@@ -470,6 +471,79 @@ fmt_binary(mdb_tgt_t *t, mdb_tgt_as_t as, mdb_tgt_addr_t addr, size_t cnt)
 	return (addr);
 }
 
+static mdb_tgt_addr_t
+fmt_jazzed(mdb_tgt_t *t, mdb_tgt_as_t as, mdb_tgt_addr_t addr, size_t cnt)
+{
+	uint64_t x;
+	char buf[256];
+
+	while (cnt-- != 0) {
+		boolean_t header = B_TRUE;
+
+		if (mdb_tgt_aread(t, as, &x, sizeof (x), addr) != sizeof (x)) {
+			warn("failed to read data from target");
+			break;
+		}
+
+		mdb_nv_set_value(mdb.m_rvalue, x);
+		addr += sizeof (x);
+
+		mdb_iob_printf(mdb.m_out, "%s\n",
+		    numtostr(x, 2, NTOS_UNSIGNED));
+
+		while (x != 0) {
+			int b = 63, forearm;
+			int i = 0;
+
+			/*
+			 * Find the high bit...
+			 */
+			while (!(x & (1ULL << b)))
+				b--;
+
+			/*
+			 * ...and iterate over the remaining bits, putting
+			 * the upper arm in our buffer for any set bit (and
+			 * a space otherwise).
+			 */
+			while (x & ((1ULL << b) - 1)) {
+				buf[i++] = x & (1ULL << b) ? '|' : ' ';
+				b--;
+			}
+
+			/*
+			 * If this is the header line, print the upper arm
+			 * for the lowest set bit and continue...
+			 */
+			if (header) {
+				header = B_FALSE;
+				buf[i] = '\0';
+				mdb_iob_printf(mdb.m_out, "%s|\n", buf);
+				continue;
+			}
+
+			/*
+			 * ...otherwise, put the elbow and forearm into our
+			 * buffer, and print it.
+			 */
+			buf[i++] = '+';
+
+			for (forearm = b; forearm > -2; forearm--)
+				buf[i++] = '-';
+
+			buf[i] = '\0';
+			mdb_iob_printf(mdb.m_out, "%s bit %d\n", buf, b);
+
+			/*
+			 * Finally, clear the lowest set bit and continue.
+			 */
+			x &= ~(1ULL << b);
+		}
+	}
+
+	return (addr);
+}
+
 static mdb_tgt_addr_t
 fmt_hex64(mdb_tgt_t *t, mdb_tgt_as_t as, mdb_tgt_addr_t addr, size_t cnt)
 {
@@ -610,7 +684,7 @@ static const mdb_fmt_desc_t fmttab[] = {
 	{ FMT_PRINTF, "%-16llq", NULL, 8 },			/* 103 = g */
 	{ FMT_FUNC, FUNCP(fmt_swapshort), help_swapshort, 2 },	/* 104 = h */
 	{ FMT_FUNC, FUNCP(fmt_instr), help_instr, 0 },		/* 105 = i */
-	{ FMT_NONE, NULL, NULL, 0 },				/* 106 = j */
+	{ FMT_FUNC, FUNCP(fmt_jazzed), help_jazzed, 8 },	/* 106 = j */
 	{ FMT_NONE, NULL, NULL, 0 },				/* 107 = k */
 	{ FMT_MATCH, NULL, help_match16, 2 },			/* 108 = l */
 	{ FMT_NONE, NULL, NULL, 0 },				/* 109 = m */
diff --git a/usr/src/cmd/mdb/test/format/tst.format-j.mdb b/usr/src/cmd/mdb/test/format/tst.format-j.mdb
new file mode 100644
index 0000000000..ebfe3fabbf
--- /dev/null
+++ b/usr/src/cmd/mdb/test/format/tst.format-j.mdb
@@ -0,0 +1,8 @@
+-1=JnRjnn
+0=JnRjnn
+1=JnRjnn
+feedface=JnRjnn
+badfeedcafe=JnRjnn
+deadba11=JnRjnn
+badb100d=JnRjnn
+baddefec8ed=JnRjnn
diff --git a/usr/src/cmd/mdb/test/format/tst.format-j.mdb.out b/usr/src/cmd/mdb/test/format/tst.format-j.mdb.out
new file mode 100644
index 0000000000..7ba29fc1d2
--- /dev/null
+++ b/usr/src/cmd/mdb/test/format/tst.format-j.mdb.out
@@ -0,0 +1,230 @@
+                ffffffffffffffff 
+                11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+                |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||+-- bit 0
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||+--- bit 1
+                |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||+---- bit 2
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||+----- bit 3
+                |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||+------ bit 4
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||+------- bit 5
+                |||||||||||||||||||||||||||||||||||||||||||||||||||||||||+-------- bit 6
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||||||+--------- bit 7
+                |||||||||||||||||||||||||||||||||||||||||||||||||||||||+---------- bit 8
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||||+----------- bit 9
+                |||||||||||||||||||||||||||||||||||||||||||||||||||||+------------ bit 10
+                ||||||||||||||||||||||||||||||||||||||||||||||||||||+------------- bit 11
+                |||||||||||||||||||||||||||||||||||||||||||||||||||+-------------- bit 12
+                ||||||||||||||||||||||||||||||||||||||||||||||||||+--------------- bit 13
+                |||||||||||||||||||||||||||||||||||||||||||||||||+---------------- bit 14
+                ||||||||||||||||||||||||||||||||||||||||||||||||+----------------- bit 15
+                |||||||||||||||||||||||||||||||||||||||||||||||+------------------ bit 16
+                ||||||||||||||||||||||||||||||||||||||||||||||+------------------- bit 17
+                |||||||||||||||||||||||||||||||||||||||||||||+-------------------- bit 18
+                ||||||||||||||||||||||||||||||||||||||||||||+--------------------- bit 19
+                |||||||||||||||||||||||||||||||||||||||||||+---------------------- bit 20
+                ||||||||||||||||||||||||||||||||||||||||||+----------------------- bit 21
+                |||||||||||||||||||||||||||||||||||||||||+------------------------ bit 22
+                ||||||||||||||||||||||||||||||||||||||||+------------------------- bit 23
+                |||||||||||||||||||||||||||||||||||||||+-------------------------- bit 24
+                ||||||||||||||||||||||||||||||||||||||+--------------------------- bit 25
+                |||||||||||||||||||||||||||||||||||||+---------------------------- bit 26
+                ||||||||||||||||||||||||||||||||||||+----------------------------- bit 27
+                |||||||||||||||||||||||||||||||||||+------------------------------ bit 28
+                ||||||||||||||||||||||||||||||||||+------------------------------- bit 29
+                |||||||||||||||||||||||||||||||||+-------------------------------- bit 30
+                ||||||||||||||||||||||||||||||||+--------------------------------- bit 31
+                |||||||||||||||||||||||||||||||+---------------------------------- bit 32
+                ||||||||||||||||||||||||||||||+----------------------------------- bit 33
+                |||||||||||||||||||||||||||||+------------------------------------ bit 34
+                ||||||||||||||||||||||||||||+------------------------------------- bit 35
+                |||||||||||||||||||||||||||+-------------------------------------- bit 36
+                ||||||||||||||||||||||||||+--------------------------------------- bit 37
+                |||||||||||||||||||||||||+---------------------------------------- bit 38
+                ||||||||||||||||||||||||+----------------------------------------- bit 39
+                |||||||||||||||||||||||+------------------------------------------ bit 40
+                ||||||||||||||||||||||+------------------------------------------- bit 41
+                |||||||||||||||||||||+-------------------------------------------- bit 42
+                ||||||||||||||||||||+--------------------------------------------- bit 43
+                |||||||||||||||||||+---------------------------------------------- bit 44
+                ||||||||||||||||||+----------------------------------------------- bit 45
+                |||||||||||||||||+------------------------------------------------ bit 46
+                ||||||||||||||||+------------------------------------------------- bit 47
+                |||||||||||||||+-------------------------------------------------- bit 48
+                ||||||||||||||+--------------------------------------------------- bit 49
+                |||||||||||||+---------------------------------------------------- bit 50
+                ||||||||||||+----------------------------------------------------- bit 51
+                |||||||||||+------------------------------------------------------ bit 52
+                ||||||||||+------------------------------------------------------- bit 53
+                |||||||||+-------------------------------------------------------- bit 54
+                ||||||||+--------------------------------------------------------- bit 55
+                |||||||+---------------------------------------------------------- bit 56
+                ||||||+----------------------------------------------------------- bit 57
+                |||||+------------------------------------------------------------ bit 58
+                ||||+------------------------------------------------------------- bit 59
+                |||+-------------------------------------------------------------- bit 60
+                ||+--------------------------------------------------------------- bit 61
+                |+---------------------------------------------------------------- bit 62
+                +----------------------------------------------------------------- bit 63
+                
+                
+                0               
+                0
+                0
+                
+                
+                1               
+                1
+                1
+                |
+                +-- bit 0
+                
+                
+                feedface        
+                11111110111011011111101011001110
+                11111110111011011111101011001110
+                ||||||| ||| || |||||| | ||  |||
+                ||||||| ||| || |||||| | ||  ||+--- bit 1
+                ||||||| ||| || |||||| | ||  |+---- bit 2
+                ||||||| ||| || |||||| | ||  +----- bit 3
+                ||||||| ||| || |||||| | |+-------- bit 6
+                ||||||| ||| || |||||| | +--------- bit 7
+                ||||||| ||| || |||||| +----------- bit 9
+                ||||||| ||| || |||||+------------- bit 11
+                ||||||| ||| || ||||+-------------- bit 12
+                ||||||| ||| || |||+--------------- bit 13
+                ||||||| ||| || ||+---------------- bit 14
+                ||||||| ||| || |+----------------- bit 15
+                ||||||| ||| || +------------------ bit 16
+                ||||||| ||| |+-------------------- bit 18
+                ||||||| ||| +--------------------- bit 19
+                ||||||| ||+----------------------- bit 21
+                ||||||| |+------------------------ bit 22
+                ||||||| +------------------------- bit 23
+                ||||||+--------------------------- bit 25
+                |||||+---------------------------- bit 26
+                ||||+----------------------------- bit 27
+                |||+------------------------------ bit 28
+                ||+------------------------------- bit 29
+                |+-------------------------------- bit 30
+                +--------------------------------- bit 31
+                
+                
+                badfeedcafe     
+                10111010110111111110111011011100101011111110
+                10111010110111111110111011011100101011111110
+                | ||| | || |||||||| ||| || |||  | | |||||||
+                | ||| | || |||||||| ||| || |||  | | ||||||+--- bit 1
+                | ||| | || |||||||| ||| || |||  | | |||||+---- bit 2
+                | ||| | || |||||||| ||| || |||  | | ||||+----- bit 3
+                | ||| | || |||||||| ||| || |||  | | |||+------ bit 4
+                | ||| | || |||||||| ||| || |||  | | ||+------- bit 5
+                | ||| | || |||||||| ||| || |||  | | |+-------- bit 6
+                | ||| | || |||||||| ||| || |||  | | +--------- bit 7
+                | ||| | || |||||||| ||| || |||  | +----------- bit 9
+                | ||| | || |||||||| ||| || |||  +------------- bit 11
+                | ||| | || |||||||| ||| || ||+---------------- bit 14
+                | ||| | || |||||||| ||| || |+----------------- bit 15
+                | ||| | || |||||||| ||| || +------------------ bit 16
+                | ||| | || |||||||| ||| |+-------------------- bit 18
+                | ||| | || |||||||| ||| +--------------------- bit 19
+                | ||| | || |||||||| ||+----------------------- bit 21
+                | ||| | || |||||||| |+------------------------ bit 22
+                | ||| | || |||||||| +------------------------- bit 23
+                | ||| | || |||||||+--------------------------- bit 25
+                | ||| | || ||||||+---------------------------- bit 26
+                | ||| | || |||||+----------------------------- bit 27
+                | ||| | || ||||+------------------------------ bit 28
+                | ||| | || |||+------------------------------- bit 29
+                | ||| | || ||+-------------------------------- bit 30
+                | ||| | || |+--------------------------------- bit 31
+                | ||| | || +---------------------------------- bit 32
+                | ||| | |+------------------------------------ bit 34
+                | ||| | +------------------------------------- bit 35
+                | ||| +--------------------------------------- bit 37
+                | ||+----------------------------------------- bit 39
+                | |+------------------------------------------ bit 40
+                | +------------------------------------------- bit 41
+                +--------------------------------------------- bit 43
+                
+                
+                deadba11        
+                11011110101011011011101000010001
+                11011110101011011011101000010001
+                || |||| | | || || ||| |    |   |
+                || |||| | | || || ||| |    |   +-- bit 0
+                || |||| | | || || ||| |    +------ bit 4
+                || |||| | | || || ||| +----------- bit 9
+                || |||| | | || || ||+------------- bit 11
+                || |||| | | || || |+-------------- bit 12
+                || |||| | | || || +--------------- bit 13
+                || |||| | | || |+----------------- bit 15
+                || |||| | | || +------------------ bit 16
+                || |||| | | |+-------------------- bit 18
+                || |||| | | +--------------------- bit 19
+                || |||| | +----------------------- bit 21
+                || |||| +------------------------- bit 23
+                || |||+--------------------------- bit 25
+                || ||+---------------------------- bit 26
+                || |+----------------------------- bit 27
+                || +------------------------------ bit 28
+                |+-------------------------------- bit 30
+                +--------------------------------- bit 31
+                
+                
+                badb100d        
+                10111010110110110001000000001101
+                10111010110110110001000000001101
+                | ||| | || || ||   |        || |
+                | ||| | || || ||   |        || +-- bit 0
+                | ||| | || || ||   |        |+---- bit 2
+                | ||| | || || ||   |        +----- bit 3
+                | ||| | || || ||   +-------------- bit 12
+                | ||| | || || |+------------------ bit 16
+                | ||| | || || +------------------- bit 17
+                | ||| | || |+--------------------- bit 19
+                | ||| | || +---------------------- bit 20
+                | ||| | |+------------------------ bit 22
+                | ||| | +------------------------- bit 23
+                | ||| +--------------------------- bit 25
+                | ||+----------------------------- bit 27
+                | |+------------------------------ bit 28
+                | +------------------------------- bit 29
+                +--------------------------------- bit 31
+                
+                
+                baddefec8ed     
+                10111010110111011110111111101100100011101101
+                10111010110111011110111111101100100011101101
+                | ||| | || ||| |||| ||||||| ||  |   ||| || |
+                | ||| | || ||| |||| ||||||| ||  |   ||| || +-- bit 0
+                | ||| | || ||| |||| ||||||| ||  |   ||| |+---- bit 2
+                | ||| | || ||| |||| ||||||| ||  |   ||| +----- bit 3
+                | ||| | || ||| |||| ||||||| ||  |   ||+------- bit 5
+                | ||| | || ||| |||| ||||||| ||  |   |+-------- bit 6
+                | ||| | || ||| |||| ||||||| ||  |   +--------- bit 7
+                | ||| | || ||| |||| ||||||| ||  +------------- bit 11
+                | ||| | || ||| |||| ||||||| |+---------------- bit 14
+                | ||| | || ||| |||| ||||||| +----------------- bit 15
+                | ||| | || ||| |||| ||||||+------------------- bit 17
+                | ||| | || ||| |||| |||||+-------------------- bit 18
+                | ||| | || ||| |||| ||||+--------------------- bit 19
+                | ||| | || ||| |||| |||+---------------------- bit 20
+                | ||| | || ||| |||| ||+----------------------- bit 21
+                | ||| | || ||| |||| |+------------------------ bit 22
+                | ||| | || ||| |||| +------------------------- bit 23
+                | ||| | || ||| |||+--------------------------- bit 25
+                | ||| | || ||| ||+---------------------------- bit 26
+                | ||| | || ||| |+----------------------------- bit 27
+                | ||| | || ||| +------------------------------ bit 28
+                | ||| | || ||+-------------------------------- bit 30
+                | ||| | || |+--------------------------------- bit 31
+                | ||| | || +---------------------------------- bit 32
+                | ||| | |+------------------------------------ bit 34
+                | ||| | +------------------------------------- bit 35
+                | ||| +--------------------------------------- bit 37
+                | ||+----------------------------------------- bit 39
+                | |+------------------------------------------ bit 40
+                | +------------------------------------------- bit 41
+                +--------------------------------------------- bit 43
+                
+                
diff --git a/usr/src/man/man1/mdb.1 b/usr/src/man/man1/mdb.1
index e93f822a81..e197836a1c 100644
--- a/usr/src/man/man1/mdb.1
+++ b/usr/src/man/man1/mdb.1
@@ -1,11 +1,11 @@
 '\" te
 .\" Copyright (c) 2005, Sun Microsystems, Inc. All Rights Reserved.
-.\" Copyright (c) 2017, Joyent, Inc. All Rights Reserved.
+.\" Copyright (c) 2019, Joyent, Inc. All Rights Reserved.
 .\" Copyright (c) 2014, 2017 by Delphix. All rights reserved.
 .\" The contents of this file are subject to the terms of the Common Development and Distribution License (the "License").  You may not use this file except in compliance with the License.
 .\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE or http://www.opensolaris.org/os/licensing.  See the License for the specific language governing permissions and limitations under the License.
 .\" When distributing Covered Code, include this CDDL HEADER in each file and include the License file at usr/src/OPENSOLARIS.LICENSE.  If applicable, add the following below this CDDL HEADER, with the fields enclosed by brackets "[]" replaced with your own identifying information: Portions Copyright [yyyy] [name of copyright owner]
-.TH MDB 1 "Dec 9, 2017"
+.TH MDB 1 "Feb 21, 2019"
 .SH NAME
 mdb \- modular debugger
 .SH SYNOPSIS
@@ -1346,7 +1346,7 @@ N	newline
 O	octal unsigned int (4 bytes)
 P	symbol (4 or 8 bytes)
 Q	octal signed int (4 bytes)
-R	binary int (8 bytes)
+R	binary unsigned long long (8 bytes)
 S	T{
 string using C string notation (variable size)
 T}
@@ -1369,6 +1369,7 @@ f	float (4 bytes)
 g	octal signed long long (8 bytes)
 h	swap bytes (2 bytes)
 i	disassembled instruction (variable size)
+j	jazzed-up binary unsigned long long (8 bytes)
 n	newline
 o	octal unsigned short (2 bytes)
 p	symbol (4 or 8 bytes)
-- 
2.21.0

