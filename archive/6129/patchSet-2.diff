From 1456d3537d83230213acc69d6885f480f3f8b111 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 18 Apr 2019 09:35:13 -0700
Subject: [PATCH] TRITON-1418 TRITON-764 broke uses of "job.ticket" in many
 VMAPI jobs' "oncancel" and "onerror"

---
 lib/workflows/add-nics.js        | 40 +++++++++------------
 lib/workflows/delete-snapshot.js | 34 +++---------------
 lib/workflows/destroy.js         | 62 +++++++++-----------------------
 lib/workflows/job-common.js      |  6 ++--
 lib/workflows/kill.js            | 34 +++---------------
 lib/workflows/reboot.js          | 35 +++---------------
 lib/workflows/remove-nics.js     | 34 +++---------------
 lib/workflows/reprovision.js     | 34 +++---------------
 lib/workflows/rollback.js        | 34 +++---------------
 lib/workflows/snapshot.js        | 34 +++---------------
 lib/workflows/start.js           | 35 +++---------------
 lib/workflows/stop.js            | 35 +++---------------
 lib/workflows/update-nics.js     | 49 +++++++------------------
 lib/workflows/update.js          | 35 +++---------------
 package.json                     |  2 +-
 15 files changed, 91 insertions(+), 412 deletions(-)

diff --git a/lib/workflows/add-nics.js b/lib/workflows/add-nics.js
index f94924d..71c0b1e 100644
--- a/lib/workflows/add-nics.js
+++ b/lib/workflows/add-nics.js
@@ -137,31 +137,25 @@ var workflow = module.exports = {
 
     ]),
     timeout: 300,
-    onerror: [ {
-        name: 'napi.cleanup_nics',
-        timeout: 10,
-        retry: 1,
-        body: common.cleanupNics,
-        modules: { sdcClients: 'sdc-clients', async: 'async' }
-    },
-    {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: common.releaseVMTicket
-    },
-    fabricCommon.releaseTicketTask,
-    {
-        name: 'On error',
-        body: function (job, cb) {
-            return cb('Error executing job');
+    onerror: [
+        {
+            name: 'napi.cleanup_nics',
+            timeout: 10,
+            retry: 1,
+            body: common.cleanupNics,
+            modules: { sdcClients: 'sdc-clients', async: 'async' }
+        },
+        common.tasks.releaseVMTicketIgnoringErr,
+        fabricCommon.releaseTicketTask,
+        {
+            name: 'On error',
+            body: function (job, cb) {
+                return cb('Error executing job');
+            }
         }
-    }],
+    ],
     oncancel: [
-    {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: common.releaseVMTicket
-    },
+        common.tasks.releaseVMTicketIgnoringErr,
         fabricCommon.releaseTicketTask
     ]
 };
diff --git a/lib/workflows/delete-snapshot.js b/lib/workflows/delete-snapshot.js
index d745ba9..4636f76 100644
--- a/lib/workflows/delete-snapshot.js
+++ b/lib/workflows/delete-snapshot.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -13,7 +13,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.3';
+var VERSION = '7.0.4';
 
 
 /*
@@ -110,32 +110,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 180,
-    onerror: [ {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/destroy.js b/lib/workflows/destroy.js
index 5d356b9..bde471b 100644
--- a/lib/workflows/destroy.js
+++ b/lib/workflows/destroy.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -20,7 +20,7 @@ var common = require('./job-common');
 var fabricCommon = require('./fabric-common');
 var nfsVolumes = require('./nfs-volumes');
 
-var VERSION = '7.1.5';
+var VERSION = '7.1.6';
 
 
 /*
@@ -267,52 +267,22 @@ var workflow = module.exports = {
     ].concat(fabricCommon.destroyChain),
 
     timeout: 180,
-    onerror: [ {
-        name: 'vmapi.refresh_vm',
-        modules: { restify: 'restify' },
-        body: common.refreshVm
-    }, {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            if (!job.ticket) {
-                return cb();
-            }
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    },
-
-    /* If there were fabric nics, release the NAT destroy ticket(s). */
-    fabricCommon.releaseFabricNatTickets
-
+    onerror: [
+        {
+            name: 'vmapi.refresh_vm',
+            modules: { restify: 'restify' },
+            body: common.refreshVm
+        },
+        common.tasks.releaseVMTicketIgnoringErr,
+
+        /* If there were fabric nics, release the NAT destroy ticket(s). */
+        fabricCommon.releaseFabricNatTickets
     ],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            if (!job.ticket) {
-                return cb();
-            }
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    },
+    oncancel: [
+        common.tasks.releaseVMTicketIgnoringErr,
 
-    /* If there were fabric nics, release the NAT destroy ticket(s). */
-    fabricCommon.releaseFabricNatTickets
+        /* If there were fabric nics, release the NAT destroy ticket(s). */
+        fabricCommon.releaseFabricNatTickets
 
     ]
 };
diff --git a/lib/workflows/job-common.js b/lib/workflows/job-common.js
index 89df227..48a8e7f 100644
--- a/lib/workflows/job-common.js
+++ b/lib/workflows/job-common.js
@@ -1151,7 +1151,9 @@ function releaseVMTicket(job, cb) {
 
 
 function releaseVMTicketIgnoringErr(job, cb) {
-    if (!job.ticket) {
+    var ticket = job.params.vmTicket;
+
+    if (!ticket) {
         cb();
         return;
     }
@@ -1159,7 +1161,7 @@ function releaseVMTicketIgnoringErr(job, cb) {
         url: cnapiUrl,
         headers: { 'x-request-id': job.params['x-request-id'] }
     });
-    cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
+    cnapi.waitlistTicketRelease(ticket.uuid, function (err) {
         if (err) {
             cb(null, 'OK - ignoring CNAPI ticket release error: ' + err);
             return;
diff --git a/lib/workflows/kill.js b/lib/workflows/kill.js
index 7b07a4d..311bcb3 100644
--- a/lib/workflows/kill.js
+++ b/lib/workflows/kill.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -14,7 +14,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.1';
+var VERSION = '7.0.2';
 
 
 /*
@@ -93,32 +93,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 210,
-    onerror: [ {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/reboot.js b/lib/workflows/reboot.js
index d71fad7..6746145 100644
--- a/lib/workflows/reboot.js
+++ b/lib/workflows/reboot.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -13,7 +13,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.5';
+var VERSION = '7.0.6';
 
 
 /*
@@ -98,33 +98,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     } ],
     timeout: 590,
-    onerror: [ {
-        name: 'On error',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-
-        }
-    } ],
-    oncancel: [ {
-        name: 'On cancel',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/remove-nics.js b/lib/workflows/remove-nics.js
index 032df1c..7c1cc43 100644
--- a/lib/workflows/remove-nics.js
+++ b/lib/workflows/remove-nics.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -15,7 +15,7 @@
 var common = require('./job-common');
 var async = require('async');
 
-var VERSION = '7.0.6';
+var VERSION = '7.0.7';
 
 
 /*
@@ -184,32 +184,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 300,
-    onerror: [ {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/reprovision.js b/lib/workflows/reprovision.js
index 1d279df..cf93c39 100644
--- a/lib/workflows/reprovision.js
+++ b/lib/workflows/reprovision.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -13,7 +13,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.3';
+var VERSION = '7.0.4';
 
 
 /*
@@ -92,32 +92,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 210,
-    onerror: [ {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/rollback.js b/lib/workflows/rollback.js
index 8dff31a..a405b2d 100644
--- a/lib/workflows/rollback.js
+++ b/lib/workflows/rollback.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -13,7 +13,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.4';
+var VERSION = '7.0.5';
 
 
 /*
@@ -181,32 +181,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 300,
-    onerror: [ {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/snapshot.js b/lib/workflows/snapshot.js
index bb730fe..f77e306 100644
--- a/lib/workflows/snapshot.js
+++ b/lib/workflows/snapshot.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -13,7 +13,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.3';
+var VERSION = '7.0.4';
 
 
 /*
@@ -109,32 +109,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 180,
-    onerror: [ {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/start.js b/lib/workflows/start.js
index 83e19c1..979e7d4 100644
--- a/lib/workflows/start.js
+++ b/lib/workflows/start.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -14,7 +14,7 @@
 
 var common = require('./job-common');
 
-var VERSION = '7.0.7';
+var VERSION = '7.0.8';
 
 
 /*
@@ -102,33 +102,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     } ],
     timeout: 410,
-    onerror: [ {
-        name: 'On error',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-
-        }
-    } ],
-    oncancel: [ {
-        name: 'On cancel',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/stop.js b/lib/workflows/stop.js
index 255f41d..4ec5778 100644
--- a/lib/workflows/stop.js
+++ b/lib/workflows/stop.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -13,7 +13,7 @@
  */
 
 var common = require('./job-common');
-var VERSION = '7.0.7';
+var VERSION = '7.0.8';
 
 
 /*
@@ -97,33 +97,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     } ],
     timeout: 530,
-    onerror: [ {
-        name: 'On error',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-
-        }
-    } ],
-    oncancel: [ {
-        name: 'On cancel',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/update-nics.js b/lib/workflows/update-nics.js
index 7b03058..a89b3b5 100644
--- a/lib/workflows/update-nics.js
+++ b/lib/workflows/update-nics.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -14,7 +14,7 @@
 
 var async = require('async');
 var common = require('./job-common');
-var VERSION = '7.0.3';
+var VERSION = '7.0.4';
 
 
 /*
@@ -98,38 +98,15 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     }],
     timeout: 300,
-    onerror: [ {
-        name: 'napi.cleanup_nics',
-        timeout: 10,
-        retry: 1,
-        body: common.cleanupNics,
-        modules: { sdcClients: 'sdc-clients', async: 'async' }
-    }, {
-        name: 'on_error.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-        }
-    }],
-    oncancel: [ {
-        name: 'on_cancel.release_vm_ticket',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [
+        {
+            name: 'napi.cleanup_nics',
+            timeout: 10,
+            retry: 1,
+            body: common.cleanupNics,
+            modules: { sdcClients: 'sdc-clients', async: 'async' }
+        },
+        common.tasks.releaseVMTicketIgnoringErr
+    ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/lib/workflows/update.js b/lib/workflows/update.js
index fd44679..f648726 100644
--- a/lib/workflows/update.js
+++ b/lib/workflows/update.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -15,7 +15,7 @@
 var restify = require('restify');
 var common = require('./job-common');
 
-var VERSION = '7.1.9';
+var VERSION = '7.1.10';
 
 /*
  * Sets up a CNAPI VM action request. Take a look at common.zoneAction. Here you
@@ -106,33 +106,6 @@ var workflow = module.exports = {
         modules: { sdcClients: 'sdc-clients' }
     } ],
     timeout: 300,
-    onerror: [ {
-        name: 'On error',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb('Error executing job');
-                return;
-            });
-
-        }
-    } ],
-    oncancel: [ {
-        name: 'On cancel',
-        modules: { sdcClients: 'sdc-clients' },
-        body: function (job, cb) {
-            var cnapi = new sdcClients.CNAPI({
-                url: cnapiUrl,
-                headers: { 'x-request-id': job.params['x-request-id'] }
-            });
-            cnapi.waitlistTicketRelease(job.ticket.uuid, function (err) {
-                cb();
-                return;
-            });
-        }
-    } ]
+    onerror: [ common.tasks.releaseVMTicketIgnoringErr ],
+    oncancel: [ common.tasks.releaseVMTicketIgnoringErr ]
 };
diff --git a/package.json b/package.json
index c9ad27f..3fe8ffd 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.8.0",
+  "version": "9.8.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

