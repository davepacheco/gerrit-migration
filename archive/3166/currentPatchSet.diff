From 9cc905f3600e69b1c5e8e9ed01fbe9294ca50851 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Sun, 7 Jan 2018 09:18:44 +0000
Subject: [PATCH] MANTA-3536 registrar broken by MANTA-3223

---
 README.md            | 22 ++++++++--------
 etc/config.coal.json |  4 +--
 lib/index.js         |  4 +--
 lib/register.js      | 60 ++++++++++++++++++++++++++++----------------
 main.js              | 43 ++++++++++++++++++++++++++++---
 5 files changed, 93 insertions(+), 40 deletions(-)

diff --git a/README.md b/README.md
index 050e749..f8065af 100644
--- a/README.md
+++ b/README.md
@@ -188,9 +188,9 @@ not recommended.
 **zookeeper:** Service discovery records are maintained in a
 ZooKeeper cluster.  The `"zookeeper"` top-level property describes how to reach
 that cluster.  This should be a configuration block appropriate for
-[node-zkplus](http://github.com/mcavage/node-zkplus).  See that project for
-details, but there's an example below that includes `"timeout"` and `"servers"`
-properties.
+[node-zkstream](http://github.com/joyent/node-zkstream).  See that project for
+details, but there's an example below that includes `"sessionTimeout"` and
+`"servers"` properties.
 
 **registration:** The `"registration"` object describes the service discovery
 records that will be inserted into ZooKeeper.  These control the DNS names that
@@ -320,10 +320,10 @@ record.  This is not common.
         },
         "adminIp": "172.27.10.72",
         "zookeeper": {
-            "timeout": 60000,
-            "servers": [ { "host": "172.27.10.35", "port": 2181 },
-                         { "host": "172.27.10.32", "port": 2181 },
-                         { "host": "172.27.10.33", "port": 2181 } ]
+            "sessionTimeout": 60000,
+            "servers": [ { "address": "172.27.10.35", "port": 2181 },
+                         { "address": "172.27.10.32", "port": 2181 },
+                         { "address": "172.27.10.33", "port": 2181 } ]
         }
     }
 
@@ -392,10 +392,10 @@ Let's augment the configuration above to specify a service record:
         },
         "adminIp": "172.27.10.72",
         "zookeeper": {
-            "timeout": 60000,
-            "servers": [ { "host": "172.27.10.35", "port": 2181 },
-                         { "host": "172.27.10.32", "port": 2181 },
-                         { "host": "172.27.10.33", "port": 2181 } ]
+            "sessionTimeout": 60000,
+            "servers": [ { "address": "172.27.10.35", "port": 2181 },
+                         { "address": "172.27.10.32", "port": 2181 },
+                         { "address": "172.27.10.33", "port": 2181 } ]
         }
     }
 
diff --git a/etc/config.coal.json b/etc/config.coal.json
index 4be4862..e7e3cb8 100644
--- a/etc/config.coal.json
+++ b/etc/config.coal.json
@@ -9,10 +9,10 @@
     "zookeeper": {
         "connectTimeout": 1000,
         "servers": [ {
-            "host": "10.99.99.11",
+            "address": "10.99.99.11",
             "port": 2181
         } ],
-        "timeout": 6000
+        "sessionTimeout": 30000
     },
     "maxAttempts": 10
 }
diff --git a/lib/index.js b/lib/index.js
index e8a9604..101780f 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -108,7 +108,7 @@ Registrar.prototype.createHealthCheck = function () {
                 if (down) {
                     ee.emit('ok');
 
-                    register.register(opts, function (r_err, __znodes) {
+                    register.register(opts, self, function (r_err, __znodes) {
                         if (r_err) {
                             log.debug(r_err, 'register: reregister failed');
                             ee.emit('error', r_err);
@@ -139,7 +139,7 @@ Registrar.prototype.createHealthCheck = function () {
                         log: log,
                         zk: zk,
                     };
-                    register.unregister(u_opts, function (u_err) {
+                    register.unregister(u_opts, self, function (u_err) {
                         if (u_err) {
                             log.debug(u_err, 'healthcheck: unregister failed');
                             ee.emit('error', u_err);
diff --git a/lib/register.js b/lib/register.js
index 539636e..ca4582e 100644
--- a/lib/register.js
+++ b/lib/register.js
@@ -190,29 +190,44 @@ function registerEntries(opts, cb) {
             var data = new Buffer(JSON.stringify(_obj), 'utf8');
 
             /*
-             * It's possible that we're recovering an existing session before
-             * it times out. In this case, the ephemeral nodes we'll want to
-             * create already exist. Since this is likely to happen over a
-             * flappy connection, simply log the error and move on.
+             * Manual testing shows that in cases where the zookeeper server
+             * process has been shut down long enough so that the session
+             * held by this client has expired, it's possible that once the
+             * server comes back up the ephemeral will still exist for a short
+             * time. Syncing the node makes sure that we are up to date on its
+             * latest state before trying to create it. We don't have to worry
+             * about this for service nodes, since they are persistent.
              */
-            zk.createWithEmptyParents(n, data, _opts, once(function (err) {
+            zk.sync(n, function (err) {
                 if (err) {
-                    if (err.code === 'NODE_EXISTS') {
-                        log.warn(err, 'register: ephemeral node ' + n +
-                            ' already exists');
-                        _cb();
-                        return;
-                    }
                     _cb(err);
-                } else {
-                    opts.registrar.ephemerals[n] = {
-                        data: data,
-                        flags: _opts.flags,
-                        path: n
-                    };
-                    _cb();
+                    return;
                 }
-            }));
+                /*
+                 * It's possible that we're recovering an existing session
+                 * before it times out. In this case, the ephemeral nodes we'll
+                 * want to create already exist. Since this is likely to happen
+                 * over a flappy connection, simply log the error and move on.
+                 */
+                zk.createWithEmptyParents(n, data, _opts, function (err) {
+                    if (err) {
+                        if (err.code === 'NODE_EXISTS') {
+                            log.warn(err, 'register: ephemeral node ' + n +
+                                ' already exists');
+                            _cb();
+                            return;
+                        }
+                        _cb(err);
+                    } else {
+                        opts.registrar.ephemerals[n] = {
+                            data: data,
+                            flags: _opts.flags,
+                            path: n
+                        };
+                        _cb();
+                    }
+                });
+            });
         },
         inputs: opts.nodes
     }, function (err) {
@@ -318,10 +333,11 @@ function register(opts, registrar, cb, newSession) {
 }
 
 
-function unregister(opts, cb) {
+function unregister(opts, registrar, cb) {
     assert.object(opts, 'options');
     assert.object(opts.log, 'options.log');
     assert.object(opts.zk, 'options.zk');
+    assert.object(registrar, 'registrar');
     assert.func(cb, 'callback');
 
     cb = once(cb);
@@ -334,8 +350,8 @@ function unregister(opts, cb) {
     log.debug('unregister: entered');
 
     zk.on('close', function () {
-        opts.registrar.ephemerals = {};
-        opts.registrar.zk = null;
+        registrar.ephemerals = {};
+        registrar.zk = null;
         log.debug('unregister: done');
         cb();
     });
diff --git a/main.js b/main.js
index de2da5f..073939a 100644
--- a/main.js
+++ b/main.js
@@ -78,6 +78,44 @@ function configure(argv) {
     assert.object(cfg.zookeeper, 'config.zookeeper');
     assert.optionalObject(cfg.healthCheck, 'config.healthCheck');
 
+    /*
+     * MANTA-3536 - if registrar is passed a config that specifies the ip
+     * address of zookeeper server(s) with the 'host' field, copy the value into
+     * a new 'address' field, which is what node-zkstream expects.
+     */
+    var servers = cfg.zookeeper.servers;
+    var usesOldConfig = false;
+
+    if (servers) {
+        servers.forEach(function (server) {
+            if (!server.address) {
+                usesOldConfig = true;
+                server.address = server.host;
+            }
+        });
+    } else {
+        if (!cfg.zookeeper.address) {
+            usesOldConfig = true;
+            cfg.zookeeper.address = cfg.zookeeper.host;
+        }
+    }
+
+    /*
+     * MANTA-3536 - node-zkstream uses the option 'sessionTimeout' instead of
+     * 'timeout'. Older configs aimed at node-zkplus will specify the timeout
+     * using 'timeout' field, so we translate it here for backwards
+     * compatibility.
+     */
+    if (!cfg.zookeeper.sessionTimeout) {
+        usesOldConfig = true;
+        cfg.zookeeper.sessionTimeout = cfg.zookeeper.timeout;
+    }
+
+    if (usesOldConfig) {
+        LOG.warn('registrar configuration uses old zookeeper options, ' +
+                'converting to new format and continuing');
+    }
+
     cfg.zookeeper.log = LOG;
 
     return (cfg);
@@ -154,10 +192,9 @@ function usage(help, msg) {
                     'ephemeral nodes.');
             var unregisterOpts = {
                 log: LOG,
-                zk: zk,
-                registrar: registrar
+                zk: zk
             };
-            app.unregister(unregisterOpts, function (err) {
+            app.unregister(unregisterOpts, registrar, function (err) {
                 if (err) {
                     LOG.debug(err, 'registrar: unexpected error ' +
                         'unregistering nodes');
-- 
2.21.0

