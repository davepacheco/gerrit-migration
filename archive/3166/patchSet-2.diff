From 54f1f6cefff4527c109debff7209519d2eb18295 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Sun, 7 Jan 2018 09:18:44 +0000
Subject: [PATCH] MANTA-3536 registrar broken by MANTA-3223

---
 etc/config.coal.json |  2 +-
 main.js              | 23 +++++++++++++++++++++++
 2 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/etc/config.coal.json b/etc/config.coal.json
index 4be4862..829504e 100644
--- a/etc/config.coal.json
+++ b/etc/config.coal.json
@@ -9,7 +9,7 @@
     "zookeeper": {
         "connectTimeout": 1000,
         "servers": [ {
-            "host": "10.99.99.11",
+            "address": "10.99.99.11",
             "port": 2181
         } ],
         "timeout": 6000
diff --git a/main.js b/main.js
index de2da5f..4567ea1 100644
--- a/main.js
+++ b/main.js
@@ -78,6 +78,29 @@ function configure(argv) {
     assert.object(cfg.zookeeper, 'config.zookeeper');
     assert.optionalObject(cfg.healthCheck, 'config.healthCheck');
 
+    /*
+     * MANTA-3536 - if registrar is passed a config that specifies the ip
+     * address of zookeeper server(s) with the 'host' field, copy the value into
+     * a new 'address' field, which is what node-zkstream expects.
+     */
+    var servers = cfg.zookeeper.servers;
+
+    if (servers) {
+        servers.forEach(function (server) {
+            if (!server.address) {
+                LOG.warn('read configuration that specifies zookeeper ' +
+                    'servers without an \'address\' field.');
+                server.address = server.host;
+            }
+        });
+    } else {
+        if (!cfg.zookeeper.address) {
+            LOG.warn('read configuration that specifies zookeeper ' +
+                'servers without an \'address\' field.');
+            cfg.zookeeper.address = cfg.zookeeper.host;
+        }
+    }
+
     cfg.zookeeper.log = LOG;
 
     return (cfg);
-- 
2.21.0

