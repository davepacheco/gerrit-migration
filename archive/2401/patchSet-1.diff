From 7217a1be4a79b7322608e30ddee710dbf760e30f Mon Sep 17 00:00:00 2001
From: Brittany Wald <brittany.wald@joyent.com>
Date: Tue, 15 Aug 2017 21:17:27 +0000
Subject: [PATCH] MANTA-3371 triggers cannot be installed with any vnodes in
 read-only mode

---
 lib/moray.js | 5 ++++-
 package.json | 2 +-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/lib/moray.js b/lib/moray.js
index fe8050c..ca89840 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -228,11 +228,14 @@ function setupMantaTrigger(log, client, cb) {
 
         function updateTrigger(callback) {
             var sql, req;
+            var opts = {
+                readOnlyOverride: true
+            };
 
             sql = updatesql + '\n' + funcsql;
             log.info({ 'sql': sql }, 'setupMantaTrigger: apply update');
             callback = once(callback);
-            req = client.sql(sql);
+            req = client.sql(sql, opts);
             req.on('record', function (row) {
                 log.info(row, 'setupMantaTrigger: row');
             });
diff --git a/package.json b/package.json
index 624b6e3..4481b69 100644
--- a/package.json
+++ b/package.json
@@ -15,7 +15,7 @@
         "bunyan": "0.22.1",
         "jsprim": "^1.3.1",
         "lru-cache": "2.3.1",
-        "moray": "3.0.0",
+        "moray": "3.2.2",
         "once": "1.3.0",
         "restify": "2.6.3",
         "redis": "0.10.1",
-- 
2.21.0

