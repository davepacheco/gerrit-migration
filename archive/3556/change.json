{"project":"joyent/illumos-joyent","branch":"master","id":"I2b4767973b92990188a9c1d315634cfcffa6b1bb","number":"3556","subject":"OS-6740 bhyve vtd leaks mapping resources Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/3556","commitMessage":"OS-6740 bhyve vtd leaks mapping resources\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1520442729,"lastUpdated":1528791887,"open":false,"status":"MERGED","comments":[{"timestamp":1520442729,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1520442899,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1520516122,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1520519242,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\nI\u0027ve taken a quick look and don\u0027t see anything that concerns me, but that doesn\u0027t mean much because I don\u0027t know this area well.  Since you have Patrick and Jerry reviewing, I\u0027ll abstain.  If you want more eyes on it, John would likely be a good reviewer."},{"timestamp":1520867728,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1520867901,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4."},{"timestamp":1520868358,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n(2 comments)\n\nI noticed that iommu_cleanup() wasn\u0027t even called, so I fixed this and a couple of bugs that exposed.\n\nRight now iommu_cleanup() takes a few minutes to complete. I haven\u0027t yet investigated why. My guess is that it is related to our implementation of free() in vmm_sol_glue.c."},{"timestamp":1520870245,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1521033848,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5."},{"timestamp":1521033879,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1521035526,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1521476412,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1523888471,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 6:\n\n(5 comments)"},{"timestamp":1523891594,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 7."},{"timestamp":1523891798,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 8."},{"timestamp":1523892111,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 8:\n\n(5 comments)"},{"timestamp":1523892935,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1523969939,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1526488252,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1526568612,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 9."},{"timestamp":1526568673,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1526569677,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1526571397,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1526659432,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 10."},{"timestamp":1527605567,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1527626338,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1527780310,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 11."},{"timestamp":1527780548,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1527858435,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 11: Code-Review+1"},{"timestamp":1527899183,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 11: Code-Review+1"},{"timestamp":1528137456,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 11:\n\nOut of curiosity, did you check \u0027::findleaks\u0027 during any of your testing?"},{"timestamp":1528279932,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 12: Patch Set 11 was rebased"},{"timestamp":1528280047,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 13."},{"timestamp":1528319679,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1528733622,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 13:\n\n\u003e Out of curiosity, did you check \u0027::findleaks\u0027 during any of your\n \u003e testing?\n\nI did so now, and it all it did find where 4 buffers related to LX."},{"timestamp":1528747281,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1528747310,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 13: Integration-Approval+1"},{"timestamp":1528755758,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 14: Patch Set 13 was rebased"},{"timestamp":1528755892,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 15: Patch Set 13 was rebased"},{"timestamp":1528759493,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 16: Commit message was updated."},{"timestamp":1528791865,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 17: Patch Set 16 was rebased"},{"timestamp":1528791887,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"17","revision":"76d673bac97855d00448cd767b6f3439f4be8d12","parents":["a33f24fd1b0665ec1cb9f57b5e860fed1d393793"],"ref":"refs/changes/56/3556/17","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528791865,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528319679,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528747281,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528747310,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1528791886,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":24,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-57},"patchSets":[{"number":"1","revision":"716f606fe115d869469709eaa738ca0d4e6e02c7","parents":["7570433cf8265bc05b2f886601908b42eaff28c0"],"ref":"refs/changes/56/3556/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520442729,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":58,"deletions":-16}],"sizeInsertions":58,"sizeDeletions":-16},{"number":"2","revision":"7227d52b9e04b1d1b875f80236ee06410b2c30ef","parents":["7570433cf8265bc05b2f886601908b42eaff28c0"],"ref":"refs/changes/56/3556/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520442899,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":399,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Is this test necessary? Is the idea that you would come back into this init function sometime later after vtd_cleanup was run, but the dips would still be setup?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":399,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I will remove it as it is no longer necessary.\n\nUnrelated to this, the dips will intentionally still be set up even after vtd_cleanup() and module unload."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":442,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It looks like this code should be wrapped in an ifndef __FreeBSD__. Also, I don\u0027t think you need the \"if (vtddips[i] !\u003d NULL)\" check. As best I can see, the code at line 400 above will always set this to a non-NULL value. Is that correct?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":442,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":58,"deletions":-16}],"sizeInsertions":58,"sizeDeletions":-16},{"number":"3","revision":"638d98b9d610c2a43a286ed9a2e773c3668715b4","parents":["92a39a923b206d3a9b8174d383717e25bddd3f99"],"ref":"refs/changes/56/3556/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520867728,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":58,"deletions":-16}],"sizeInsertions":58,"sizeDeletions":-16},{"number":"4","revision":"204f3dc713b78671ca23b2ab1fb859883af2de3b","parents":["92a39a923b206d3a9b8174d383717e25bddd3f99"],"ref":"refs/changes/56/3556/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520867901,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":275,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this seems like it needs an ifndef __FreeBSD__ guard"},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":275,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":62,"deletions":-16},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":73,"sizeDeletions":-21},{"number":"5","revision":"51fb399e0d228a24ffced11038f72e1fcc123159","parents":["92a39a923b206d3a9b8174d383717e25bddd3f99"],"ref":"refs/changes/56/3556/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1521033848,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521035526,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":62,"deletions":-16},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":77,"sizeDeletions":-21},{"number":"6","revision":"96853be00d0935c83b163631f568d54685d7e893","parents":["9c32aa7f39de039204e372d103eb40360ae0c54d"],"ref":"refs/changes/56/3556/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1521476412,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521035526,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":452,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"#ifdef __FreeBSD__"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":452,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":455,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"#ifdef __FreeBSD__"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":455,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":69,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"#ifdef __FreeBSD__"},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":69,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":275,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This line should be in #else"},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":275,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":468,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"#ifdef __FreeBSD__"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":468,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"This is already in a big #ifndef block."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":62,"deletions":-16},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":77,"sizeDeletions":-21},{"number":"7","revision":"2403731f93c879293037b4ace89c296f66b6001b","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/56/3556/7","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523891594,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":62,"deletions":-16},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":77,"sizeDeletions":-21},{"number":"8","revision":"a05f653dbc9fa1046f3b6e3a17643251b4d4972b","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/56/3556/8","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523891798,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523969939,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523892935,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":460,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"When do we tear down the contents of vtddips[]?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":460,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"We don\u0027t.\n\nThe devinfo nodes are created in the first call to vtd_get_dip(), and they are cached in vtddips[]. As part of the devinfo tree they are persistent and won\u0027t change. As long as vmm stays loaded we can then just use the cached pointers in vtddips[]. If vmm is unloaded and later reloaded, vtddips[] will just be populated again by the calls to vtd_get_dip() with pointers to the existing devinfo nodes."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":460,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is there any reason _not_ to tear them down on unload of \u0027vmm\u0027?  (Or at least spell it out explicitly why a module is leaving persistent resources after unload)"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":460,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I\u0027m sorry I don\u0027t really remember the reason why I decided leave them around. Perhaps there was no other reason than that I consider these devinfo nodes to be system state, not really module state. They are also in no way dependent on anything from vmm, they\u0027re really just translating ACPI info into a form that DDI can handle.\n\nI wanted to experiment with this today, but it turns out vmm is essentially unloadable now (sdev_plugin_unregister() always returns EBUSY).\n\nWill this be ok if I add a comment that they are persistent?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":460,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I think a comment justifying why they are not cleaned up on module unload is necessary at the very least.  Hopefully sdev is fixed at some point in the future, allowing vmm to be unloaded.  When that day comes, it would be nice for vmm to clean up all the resources it allocated on load."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","line":460,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done. I hope by that time I\u0027ll have moved the iommu code in bhyve into its own module, so it won\u0027t matter anymore."},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":194,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: just use a normal if statement and function calls?"},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","line":194,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":64,"deletions":-16},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":82,"sizeDeletions":-21},{"number":"9","revision":"3277d551bee3b7cb0d7a192387768698bda9105c","parents":["1c2625a53ebd46792e9152ddddeb63a52c03b3a2"],"ref":"refs/changes/56/3556/9","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1526568612,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526569677,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":64,"deletions":-16},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":86,"sizeDeletions":-22},{"number":"10","revision":"ab36fea4d9bdc6f4be99e3562b76586faf78ce3f","parents":["1c2625a53ebd46792e9152ddddeb63a52c03b3a2"],"ref":"refs/changes/56/3556/10","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1526659432,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":46,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":77,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":146,"sizeDeletions":-57},{"number":"11","revision":"e8c43bf755b2256d8d665186a438abb672cb3366","parents":["1c2625a53ebd46792e9152ddddeb63a52c03b3a2"],"ref":"refs/changes/56/3556/11","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1527780310,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527858435,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527899183,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":157,"sizeDeletions":-57},{"number":"12","revision":"6feafee98a40eb7b4a79987098f993a97daa8b6d","parents":["c4c6537e10afdbfcc5221e2f9c3d5d80780235fa"],"ref":"refs/changes/56/3556/12","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528279932,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527858435,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527899183,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":157,"sizeDeletions":-57},{"number":"13","revision":"662d4ec67c77cd8b4acce6f5aa6fe2155c172a2a","parents":["c4c6537e10afdbfcc5221e2f9c3d5d80780235fa"],"ref":"refs/changes/56/3556/13","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528280047,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528319679,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528747281,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528747310,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":24,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-57},{"number":"14","revision":"20989c5082fa0e86829dad4b1cdac0975bd1c9c7","parents":["2d24d386afb2debdcfd0eb0aa496b2642ce2e7b7"],"ref":"refs/changes/56/3556/14","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528755758,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528319679,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528747281,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528747310,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":24,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-57},{"number":"15","revision":"bc7b9183b26fdb772d6c253b296a9870686261c7","parents":["2d24d386afb2debdcfd0eb0aa496b2642ce2e7b7"],"ref":"refs/changes/56/3556/15","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528755892,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528319679,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528747281,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528747310,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":24,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-57},{"number":"16","revision":"2b4767973b92990188a9c1d315634cfcffa6b1bb","parents":["2d24d386afb2debdcfd0eb0aa496b2642ce2e7b7"],"ref":"refs/changes/56/3556/16","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528759493,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528319679,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528747281,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528747310,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":24,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-57},{"number":"17","revision":"76d673bac97855d00448cd767b6f3439f4be8d12","parents":["a33f24fd1b0665ec1cb9f57b5e860fed1d393793"],"ref":"refs/changes/56/3556/17","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1528791865,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528319679,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528747281,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528747310,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1528791886,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.files","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd.c","type":"MODIFIED","insertions":51,"deletions":-51},{"file":"usr/src/uts/i86pc/io/vmm/intel/vtd_sol.c","type":"ADDED","insertions":83,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/io/iommu.c","type":"MODIFIED","insertions":24,"deletions":-6},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-57}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}