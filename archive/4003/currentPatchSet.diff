From 6f3ad4ba479157624b82b28ff12ef2d9af6182c8 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Thu, 24 May 2018 23:00:54 +0000
Subject: [PATCH] OS-6796 vmm_zsd_lock not held while element removed from
 vmm_zsd_list

---
 usr/src/uts/i86pc/io/vmm/vmm_zsd.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/usr/src/uts/i86pc/io/vmm/vmm_zsd.c b/usr/src/uts/i86pc/io/vmm/vmm_zsd.c
index 586773ac8e..99a581a9f1 100644
--- a/usr/src/uts/i86pc/io/vmm/vmm_zsd.c
+++ b/usr/src/uts/i86pc/io/vmm/vmm_zsd.c
@@ -171,7 +171,9 @@ vmm_zsd_destroy(zoneid_t zid, void *data)
 	mutex_exit(&zsd->vz_lock);
 	mutex_destroy(&zsd->vz_lock);
 
+	mutex_enter(&vmm_zsd_lock);
 	list_remove(&vmm_zsd_list, zsd);
+	mutex_exit(&vmm_zsd_lock);
 	kmem_free(zsd, sizeof (*zsd));
 }
 
-- 
2.21.0

