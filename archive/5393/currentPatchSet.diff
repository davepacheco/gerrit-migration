commit 825c7bd8a1af29410bd0e6c5aabefd8a7f067bb3
Author: Mike Gerdts <mike.gerdts@joyent.com>
Date:   2019-01-19T07:04:32+00:00 (9 months ago)
    
    OS-7524 dhcp timeout could be tunable

diff --git a/overlay/generic/etc/dhcp/eventhook b/overlay/generic/etc/dhcp/eventhook
new file mode 100644
index 00000000..4a423a9e
--- /dev/null
+++ b/overlay/generic/etc/dhcp/eventhook
@@ -0,0 +1,24 @@
+#! /bin/bash
+
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+# Copyright (c) 2019, Joyent, Inc.
+#
+
+PATH=/usr/bin:/usr/sbin
+
+if (( $# != 2 )); then
+	echo "$0: Usage $0 interface event" 1>&2
+	exit 1
+fi
+interface=$1
+event=$2
+
+# If svc:/network/physical:default timed out waiting for a dhcp response, this
+# will ensure that sysinfo updates its cache.
+if [[ $event == BOUND || $event == BOUND6 ]]; then
+	sysinfo -fu
+fi
diff --git a/overlay/generic/lib/svc/method/net-physical b/overlay/generic/lib/svc/method/net-physical
index 86af5b33..3d18fe4e 100644
--- a/overlay/generic/lib/svc/method/net-physical
+++ b/overlay/generic/lib/svc/method/net-physical
@@ -29,6 +29,8 @@
 . /lib/sdc/config.sh
 . /lib/sdc/network.sh
 
+# Make it easy to see where the time is spent
+PS4='${.sh.file//*\/}:$LINENO start+$SECONDS+ '
 set -o errexit
 set -o xtrace
 
@@ -43,8 +45,6 @@ smf_configure_ip || exit ${SMF_EXIT_OK}
 # Make sure that the libraries essential to this stage of booting can be found.
 LD_LIBRARY_PATH=/lib; export LD_LIBRARY_PATH
 
-# Time (in seconds) to wait for admin NIC to get DHCP address before continuing.
-ADMIN_DHCP_TIMEOUT=300
 ActiveAggrLinks=
 typeset -A ActiveAggrLinks
 
@@ -565,6 +565,7 @@ if smf_is_globalzone; then
         admin_ip6=${BOOT_admin_ip6}
     fi
 
+    ADMIN_NIC_UP=false
     if [[ $admin_ip == 'none' ]]; then
         echo 'INFO: not configuring IP on admin interface (admin_ip=none)'
     elif [[ -n $admin_ip ]] && [[ -n $admin_netmask ]]; then
@@ -590,20 +591,32 @@ if smf_is_globalzone; then
             # Set a flag, but try to plumb the other interfaces anyway
             ADMIN_NIC_MISCONFIGURED=true
         else
+            # Wait for DHCP for up to five minutes.  This is excessively long
+            # while debugging problems.  When feeling impatient, update the boot
+            # loader to append the kernel args "-B admin_dhcp_timeout=10" (or
+            # extend existing -B argument with ",admin_dhcp_timeout=10").
+            typeset -i end
+            (( end = $SECONDS + ${BOOT_admin_dhcp_timeout:-300} ))
+
             # We ignore errors here because the most common one is that DHCP is
-            # already running.
-            /sbin/ifconfig ${SYSINFO_NIC_admin} dhcp || /bin/true
-
-            # Wait for DHCP
-            timeout=${ADMIN_DHCP_TIMEOUT}
-            dhcp_admin_ip=$(/sbin/ifconfig ${SYSINFO_NIC_admin} | grep inet | awk '{ print $2 }')
-            while [[ (-z ${dhcp_admin_ip} || ${dhcp_admin_ip} == "0.0.0.0") && ${timeout} -gt 0 ]]; do
-                dhcp_admin_ip=$(/sbin/ifconfig ${SYSINFO_NIC_admin} | grep inet | awk '{ print $2 }')
-                timeout=$((${timeout} - 1))
+            # already running.  If it bails early, the loop that follows will
+	    # keep waiting.
+            /sbin/ifconfig ${SYSINFO_NIC_admin} dhcp \
+                wait ${BOOT_admin_dhcp_timeout:-300} || /bin/true
+
+            # Finish waiting if ifconfig bailed early.
+            for (( ; ; )); do
+                dhcp_admin_ip=$(/sbin/ifconfig ${SYSINFO_NIC_admin} |
+                    awk '$1 == "inet" { print $2 }')
+                if [[ -n $dhcp_admin_ip && $dhcp_admin_ip != "0.0.0.0" ]]; then
+                    ADMIN_NIC_UP=true
+                    break
+                fi
+                if (( $SECONDS > $end )); then
+                    break
+                fi
                 sleep 1
             done
-
-            ADMIN_NIC_UP=true
         fi
     fi
 
diff --git a/overlay/generic/manifest b/overlay/generic/manifest
index ebc1a35c..4a1a13f6 100644
--- a/overlay/generic/manifest
+++ b/overlay/generic/manifest
@@ -14,6 +14,7 @@ d etc/default 0755 root sys
 f etc/default/init 0644 root sys
 f etc/default/login 0644 root sys
 f etc/default/passwd 0644 root sys
+f etc/dhcp/eventhook 0755 root sys
 f etc/dispadmin.conf 0644 root sys
 f etc/driver_aliases 0644 root sys
 f etc/driver_classes 0644 root sys
