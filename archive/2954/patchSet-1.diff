From 0392e9f3342f9b415828969e04f19c9a4278c8ad Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Thu, 16 Nov 2017 17:55:17 +0100
Subject: [PATCH] OS-XXXX make pcfs great again

---
 usr/src/uts/common/fs/pcfs/pc_vnops.c | 31 ++++++++++++++++++++-------
 1 file changed, 23 insertions(+), 8 deletions(-)

diff --git a/usr/src/uts/common/fs/pcfs/pc_vnops.c b/usr/src/uts/common/fs/pcfs/pc_vnops.c
index b307fe11d7..02a66f0ba1 100644
--- a/usr/src/uts/common/fs/pcfs/pc_vnops.c
+++ b/usr/src/uts/common/fs/pcfs/pc_vnops.c
@@ -1683,8 +1683,6 @@ pcfs_putpage(
 
 	ASSERT(off <= UINT32_MAX);
 
-	flags &= ~B_ASYNC;	/* XXX should fix this later */
-
 	err = pc_lockfs(fsp, 0, 0);
 	if (err)
 		return (err);
@@ -1752,6 +1750,18 @@ pcfs_putpage(
 	return (err);
 }
 
+static int
+pcfs_iodone(buf_t *bp)
+{
+	ASSERT((bp->b_pages->p_vnode != NULL) && !(bp->b_flags & B_READ));
+
+	bp->b_iodone = NULL;
+
+	iodone(bp);
+
+	return (0);
+}
+
 /*
  * Write out a single page, possibly klustering adjacent dirty pages.
  */
@@ -1821,6 +1831,8 @@ pcfs_putapage(
 			goto out;
 		}
 		bp = pageio_setup(pp, xfersize, devvp, B_WRITE | flags);
+		if ((flags & B_ASYNC) != 0)
+			bp->b_iodone = pcfs_iodone;
 		bp->b_edev = devvp->v_rdev;
 		bp->b_dev = cmpdev(devvp->v_rdev);
 		bp->b_blkno = bn + btodt(xferoffset - lbnoff);
@@ -1832,13 +1844,16 @@ pcfs_putapage(
 
 		lwp_stat_update(LWP_STAT_OUBLK, 1);
 
-		if (err == 0)
-			err = biowait(bp);
-		else
-			(void) biowait(bp);
-		pageio_done(bp);
+		if ((flags & B_ASYNC) == 0) {
+			if (err == 0)
+				err = biowait(bp);
+			else
+				(void) biowait(bp);
+			pageio_done(bp);
+		}
 	}
-	pvn_write_done(pp, ((err) ? B_ERROR : 0) | B_WRITE | flags);
+	if ((flags & B_ASYNC) == 0)
+		pvn_write_done(pp, ((err) ? B_ERROR : 0) | B_WRITE | flags);
 	pp = NULL;
 
 out:
-- 
2.21.0

