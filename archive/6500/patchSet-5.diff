From 50b85d0e8580d97d314ad2d5a9b2c8d630c4b3fc Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Fri, 12 Jul 2019 03:26:28 +0000
Subject: [PATCH] joyent/bugview#32 Use node-jiramark for parsing JIRA markup

---
 Makefile               |   4 +-
 jirapub.js             | 205 +++++++++++++++++++++++++++++++----------
 package.json           |   7 +-
 templates/primary.html |  55 +++++++++++
 4 files changed, 215 insertions(+), 56 deletions(-)

diff --git a/Makefile b/Makefile
index 09361aa..9a08594 100644
--- a/Makefile
+++ b/Makefile
@@ -47,10 +47,10 @@ endif
 all: 0-npm-stamp | $(NPM_EXEC)
 
 0-npm-stamp:
-	npm install
+	$(NPM) install
 	touch $@
 
-CLEAN_FILES += ./node_modules/
+CLEAN_FILES += ./node_modules/ 0-npm-stamp
 
 include ./tools/mk/Makefile.deps
 ifeq ($(shell uname -s),SunOS)
diff --git a/jirapub.js b/jirapub.js
index d008663..8ac0f3a 100644
--- a/jirapub.js
+++ b/jirapub.js
@@ -7,6 +7,7 @@ var mod_assert = require('assert-plus');
 var mod_restify = require('restify');
 var mod_bunyan = require('bunyan');
 var mod_fs = require('fs');
+var mod_jiramark = require('jiramark');
 var mod_path = require('path');
 var mod_ent = require('ent');
 var mod_url = require('url');
@@ -28,6 +29,7 @@ var HEADING_LEVELS = [ 1, 2, 3, 4, 5, 6 ].map(function (l) {
 });
 
 var TEMPLATES = {};
+var TEMPLATE_RE = /%%([^%]*)%%/g;
 
 var UNRESTRICTED = false;
 var CONFIG = read_config(LOG);
@@ -38,6 +40,10 @@ var ALLOWED_LABELS = CONFIG.allowed_labels;
 var BACKEND;
 var SERVER; // eslint-disable-line
 
+var JIRA_OPS = {
+	formatLink: format_remote_link
+};
+
 /*
  * Initialisation Routines:
  */
@@ -144,19 +150,51 @@ template(nam)
 	return (TEMPLATES[nam]);
 }
 
+/*
+ * Load a given template and replace the %%KEY%% items with values from
+ * the provided object.
+ */
+function
+format_template(nam, keys)
+{
+	var out = template(nam);
+
+	function replaceKey(orig, key) {
+		if (keys.hasOwnProperty(key)) {
+			return (keys[key]);
+		} else {
+			return (orig);
+		}
+	}
+
+	return (out.replace(TEMPLATE_RE, replaceKey));
+}
+
+/*
+ * Format a page using the primary.html template.
+ */
 function
 format_primary(title, content)
 {
 	mod_assert.string(title, 'title');
 	mod_assert.string(content, 'content');
 
-	var out = template('primary');
+	var keys = {
+		'CONTAINER': content,
+		'HTTP': CONFIG.http_proto,
+		'TITLE': title
+	};
 
-	out = out.replace(/%%CONTAINER%%/g, content);
-	out = out.replace(/%%HTTP%%/g, CONFIG.http_proto);
-	out = out.replace(/%%TITLE%%/g, title);
+	return (format_template('primary', keys));
+}
 
-	return (out);
+/*
+ * Check whether a label is one of the ones we're allowed to display.
+ */
+function
+is_allowed_label(label)
+{
+	return (ALLOWED_LABELS.indexOf(label) !== -1);
 }
 
 
@@ -190,7 +228,7 @@ handle_label_index(req, res, next)
 	});
 	var label = req.params.key;
 
-	if (!UNRESTRICTED && ALLOWED_LABELS.indexOf(label) === -1) {
+	if (!UNRESTRICTED && !is_allowed_label(label)) {
 		log.error({label: label}, 'request for non-public label');
 		res.send(403, 'Sorry, this label does not exist.\n');
 		next(false);
@@ -207,7 +245,7 @@ make_issue_index(log, label, req, res, next)
 	var offset;
 
 	mod_assert.ok(label === CONFIG.label ||
-	    ALLOWED_LABELS.indexOf(label) !== -1 ||
+	    is_allowed_label(label) ||
 	    UNRESTRICTED);
 
 	if (req.query && req.query.offset) {
@@ -262,17 +300,10 @@ make_issue_index(log, label, req, res, next)
 		/*
 		 * Construct Issue Index table:
 		 */
-		var container = template('issue_index');
-		if (ALLOWED_LABELS.indexOf(label) === -1) {
-			container = container.replace(/%%LABEL%%/g, '');
-		} else {
-			container = container.replace(/%%LABEL%%/g,
-			    ': ' + label);
-		}
-		var labelindex = ALLOWED_LABELS.map(function make_link(_label) {
+		var labeltxt = !is_allowed_label(label) ? '' : ': ' + label;
+		var labelidx = ALLOWED_LABELS.map(function make_link(_label) {
 			return make_label_link(_label, label === _label);
 		}).join(', ');
-		container = container.replace(/%%LABEL_INDEX%%/, labelindex);
 		var tbody = '';
 		for (var i = 0; i < results.issues.length; i++) {
 			var issue = results.issues[i];
@@ -295,7 +326,6 @@ make_issue_index(log, label, req, res, next)
 				'</td></tr>'
 			].join('') + '\n';
 		}
-		container = container.replace(/%%TABLE_BODY%%/g, tbody);
 
 		/*
 		 * Construct paginated navigation links:
@@ -316,8 +346,13 @@ make_issue_index(log, label, req, res, next)
 			pagin.push('<a href="index.html?offset=' +
 			    (offset + 50) + '">Next Page</a>');
 		}
-		container = container.replace(/%%PAGINATION%%/g,
-		    pagin.join(' | '));
+
+		var container = format_template('issue_index', {
+			LABEL: labeltxt,
+			LABEL_INDEX: labelidx,
+			PAGINATION: pagin.join(' | '),
+			TABLE_BODY: tbody
+		});
 
 		/*
 		 * Construct page from primary template and our table:
@@ -731,10 +766,8 @@ parse_jira_markup(desc, ps)
 			if (c === '|') {
 				state = 'LINK_URL';
 			} else if (c === ']') {
-				out.push('<a href="' + fix_url(link_title) +
-				    '" target="_new">');
-				out.push(mod_ent.encode(link_title));
-				out.push('</a>');
+				out.push(format_remote_link(link_title,
+				    mod_ent.encode(link_title)));
 
 				state = 'TEXT';
 			} else {
@@ -768,10 +801,8 @@ parse_jira_markup(desc, ps)
 
 		case 'LINK_URL':
 			if (c === ']') {
-				out.push('<a href="' + fix_url(link_url) +
-				    '" target="_new">');
-				out.push(mod_ent.encode(link_title));
-				out.push('</a>');
+				out.push(format_remote_link(link_url,
+				    mod_ent.encode(link_title)));
 
 				state = 'TEXT';
 			} else {
@@ -845,8 +876,43 @@ parse_jira_markup(desc, ps)
 	return (out.join(''));
 }
 
+/*
+ * Remove the leading {block} from a line, and return the remainder.
+ */
 function
-format_markup(desc)
+eat_block(line)
+{
+	return (line.match(/^{[^}]*}?(.*)/)[1]);
+}
+
+/*
+ * Creates two <div> blocks for displaying a JIRA markup panel, with the
+ * appropriate CSS classes set. The consumer needs to handle the closing
+ * tags, "</div></div>".
+ */
+function
+format_panel_open(names)
+{
+	var html = '<div class="';
+	var i;
+
+	for (i = 0; i < names.length; ++i) {
+		html += names[i] + ' ';
+	}
+
+	html += '"><div class="';
+
+	for (i = 0; i < names.length; ++i) {
+		html += names[i] + 'Content ';
+	}
+
+	html += '">';
+
+	return (html);
+}
+
+function
+format_markup_fallback(desc)
 {
 	var out = '';
 	var lines = desc.split(/\r?\n/);
@@ -860,6 +926,7 @@ format_markup(desc)
 		ps_heading: null
 	};
 	var procneeded = true;
+	var closing = null;
 
 	for (var i = 0; i < lines.length; i++) {
 		var line = lines[i];
@@ -875,24 +942,41 @@ format_markup(desc)
 				out += '</ul>\n';
 			}
 			if (fmton) {
+				mod_assert.string(closing, 'closing');
 				parse_markup = true;
-				out += (lt_quote ? '</div>' : '</pre>') + '\n';
+				out += closing;
+				closing = null;
 				line = '';
 			} else if (lt_quote) {
 				newline_br = true;
 				parse_markup = true;
-				out += '<div style="border-left: 2px solid ' +
-				    '#888888; margin-left: 1em; ' +
-				    'padding-left: 1em">\n';
-				line = line.match(/^{[^}]*}?(.*)/)[1];
-			} else {
+				out += '<blockquote>\n';
+				closing = '</blockquote>';
+				line = eat_block(line);
+			} else if (lt_panel) {
 				newline_br = false;
-				parse_markup = !(lt_noformat || lt_code);
-				out += '<pre style="border: 2px solid black;' +
-				    'font-family: Menlo, Courier, ' +
-				    'Lucida Console, Monospace;' +
-				    'background-color: #eeeeee;">\n';
-				line = line.match(/^{[^}]*}?(.*)/)[1];
+				parse_markup = true;
+				out += format_panel_open(
+				    [ 'panel' ]);
+				out += '\n';
+				closing = '</div></div>\n';
+				line = eat_block(line);
+			} else if (lt_noformat) {
+				newline_br = false;
+				parse_markup = false;
+				out += format_panel_open(
+				    [ 'preformatted', 'panel' ]);
+				out += '<pre>\n';
+				closing = '</pre></div></div>\n';
+				line = eat_block(line);
+			} else if (lt_code) {
+				newline_br = false;
+				parse_markup = false;
+				out += format_panel_open(
+				    [ 'code', 'panel' ]);
+				out += '<pre>\n';
+				closing = '</pre></div></div>\n';
+				line = eat_block(line);
 			}
 			fmton = !fmton;
 		}
@@ -913,9 +997,29 @@ format_markup(desc)
 		last_was_heading = (parser_state.ps_heading !== null);
 	}
 
+	if (closing !== null) {
+		out += closing;
+	}
+
 	return (out);
 }
 
+
+function
+format_markup(desc)
+{
+	try {
+		return (mod_jiramark.markupToHTML(desc, JIRA_OPS));
+	} catch (e) {
+		LOG.warn({
+			errmsg: e.message,
+			markup: desc
+		}, 'failed to convert markup to HTML');
+	}
+
+	return (format_markup_fallback(desc));
+}
+
 function
 format_issue_json(issue)
 {
@@ -1232,10 +1336,8 @@ format_issue_finalise(issue, remotelinks, other_issues)
 		out += '</ul></p>\n';
 	}
 
-	var labellinks = issue.fields.labels.filter(
-		function is_label_allowed(label) {
-			return ALLOWED_LABELS.indexOf(label) !== -1;
-		}).map(function label_link(label) {
+	var labellinks = issue.fields.labels.filter(is_allowed_label).map(
+		function label_link(label) {
 			return make_label_link(label, false);
 		});
 	if (labellinks.length > 0) {
@@ -1263,7 +1365,6 @@ format_issue_finalise(issue, remotelinks, other_issues)
 			}, 'comment maxResults and total not equal for issue');
 		}
 
-		var dark = false;
 		for (i = 0; i < c.comments.length; i++) {
 			var com = c.comments[i];
 
@@ -1277,9 +1378,13 @@ format_issue_finalise(issue, remotelinks, other_issues)
 
 			var cdtc = new Date(com.created);
 
-			out += '<div style="background-color: ' +
-			    (dark ? '#DDDDDD' : '#EEEEEE') + ';">\n';
+			if (i !== 0) {
+				out += '<hr>\n';
+			}
+
+			out += '<div>\n';
 			out += '<b>';
+			out += '<a name="comment-' + i + '"></a>';
 			out += 'Comment by ' + com.author.displayName;
 			out += '<br>\n';
 			out += 'Created at ' + cdtc.toISOString();
@@ -1291,9 +1396,7 @@ format_issue_finalise(issue, remotelinks, other_issues)
 			}
 			out += '</b>';
 			out += format_markup(com.body);
-			out += '</div><br>\n';
-
-			dark = !dark;
+			out += '</div>\n';
 		}
 	}
 
@@ -1314,7 +1417,7 @@ function
 format_remote_link(link, text)
 {
 	var anchor = '<a rel="noopener noreferrer" target="_blank" href="' +
-	    link + '">' + text + '</a>';
+	    fix_url(link) + '">' + text + '</a>';
 
 	return (anchor);
 }
diff --git a/package.json b/package.json
index 441ca3b..5102fea 100644
--- a/package.json
+++ b/package.json
@@ -8,14 +8,15 @@
   "private": true,
   "dependencies": {
     "assert-plus": "^1.0.0",
-    "bunyan": "~0.22.1",
+    "bunyan": "~1.8.12",
     "ent": "~2.0.0",
-    "restify": "~2.6.1",
+    "jiramark": "0.4.0",
+    "restify": "~4.3.4",
     "vasync": "^2.2.0",
     "verror": "^1.10.0"
   },
   "devDependencies": {
-    "eslint": "4.13.1",
+    "eslint": "4.19.1",
     "eslint-plugin-joyent": "~2.1.0"
   }
 }
diff --git a/templates/primary.html b/templates/primary.html
index c9a6061..0119e93 100644
--- a/templates/primary.html
+++ b/templates/primary.html
@@ -5,10 +5,65 @@
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <link href="%%HTTP%%://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
   <style>
+    /* Override some default bootstrap CSS. */
     body {
       padding-top: 50px;
       padding-bottom: 20px;
     }
+    p:last-child {
+      padding: 0em;
+      margin: 0em;
+    }
+    blockquote {
+      border-left: 2px solid #888888;
+      margin-left: 1em;
+      margin-right: 1em;
+      padding-left: 1em;
+    }
+    pre {
+      border: none;
+      margin: 0em;
+      padding: 0em;
+    }
+    hr {
+      border-top: 1px solid black;
+    }
+    blockquote > p {
+        font-size: 1em;
+        font-weight: normal;
+        line-height: 1.428571429;
+    }
+
+    /* Style processed JIRA markup. */
+    div.panel {
+      border: 2px solid black;
+      margin-left: 1em;
+      margin-right: 1em;
+    }
+    div.panelContent {
+      max-height: 75em;
+      overflow-y: auto;
+    }
+    div.code, div.preformatted {
+      font-family: Menlo, Courier, Lucida Console, Monospace;
+    }
+    div.panel, pre {
+      background-color: #eeeeee;
+    }
+    div.panel div {
+      padding: 9px 12px;
+    }
+    div.panel div.panelHeader {
+      border-bottom: 2px solid black;
+    }
+    th, tr {
+      border: 1px solid black;
+      padding: 3px 4px;
+    }
+    th {
+      background-color: #eeeeee;
+      text-align: center;
+    }
   </style>
   <title>%%TITLE%%</title>
 </head>
-- 
2.21.0

