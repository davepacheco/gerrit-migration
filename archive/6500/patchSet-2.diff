From b3268ddd535b4a2c793387f9687996248f6163ae Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Wed, 5 Jun 2019 20:11:48 +0000
Subject: [PATCH] joyent/bugview#32 Use node-jiramark for parsing JIRA markup

---
 Makefile               |   4 +-
 jirapub.js             | 138 ++++++++++++++++++++++++++++++++---------
 package.json           |   7 ++-
 templates/primary.html |  51 +++++++++++++++
 4 files changed, 164 insertions(+), 36 deletions(-)

diff --git a/Makefile b/Makefile
index 09361aa..9a08594 100644
--- a/Makefile
+++ b/Makefile
@@ -47,10 +47,10 @@ endif
 all: 0-npm-stamp | $(NPM_EXEC)
 
 0-npm-stamp:
-	npm install
+	$(NPM) install
 	touch $@
 
-CLEAN_FILES += ./node_modules/
+CLEAN_FILES += ./node_modules/ 0-npm-stamp
 
 include ./tools/mk/Makefile.deps
 ifeq ($(shell uname -s),SunOS)
diff --git a/jirapub.js b/jirapub.js
index 8fd3116..d456a6d 100644
--- a/jirapub.js
+++ b/jirapub.js
@@ -7,6 +7,7 @@ var mod_assert = require('assert-plus');
 var mod_restify = require('restify');
 var mod_bunyan = require('bunyan');
 var mod_fs = require('fs');
+var mod_jiramark = require('jiramark');
 var mod_path = require('path');
 var mod_ent = require('ent');
 var mod_url = require('url');
@@ -23,6 +24,8 @@ var HEADING_LEVELS = [ 1, 2, 3, 4, 5, 6 ].map(function (l) {
 
 var TEMPLATES = {};
 
+var TEMPLATE_PRIMARY_KEYS = /%%(CONTAINER|HTTP|TITLE)%%/g;
+
 var CONFIG = read_config(LOG);
 
 var ALLOWED_DOMAINS = CONFIG.allowed_domains;
@@ -31,6 +34,10 @@ var ALLOWED_LABELS = CONFIG.allowed_labels;
 var JIRA;
 var SERVER; // eslint-disable-line
 
+var jiraops = {
+	formatLink: format_remote_link
+};
+
 /*
  * Initialisation Routines:
  */
@@ -143,11 +150,22 @@ format_primary(title, content)
 	mod_assert.string(title, 'title');
 	mod_assert.string(content, 'content');
 
+	function replaceKey(_, key) {
+		switch (key) {
+		case 'CONTAINER':
+			return content;
+		case 'HTTP':
+			return CONFIG.http_proto;
+		case 'TITLE':
+			return title;
+		default:
+			return '';
+		}
+	}
+
 	var out = template('primary');
 
-	out = out.replace(/%%CONTAINER%%/g, content);
-	out = out.replace(/%%HTTP%%/g, CONFIG.http_proto);
-	out = out.replace(/%%TITLE%%/g, title);
+	out = out.replace(TEMPLATE_PRIMARY_KEYS, replaceKey);
 
 	return (out);
 }
@@ -732,10 +750,8 @@ parse_jira_markup(desc, ps)
 			if (c === '|') {
 				state = 'LINK_URL';
 			} else if (c === ']') {
-				out.push('<a href="' + fix_url(link_title) +
-				    '" target="_new">');
-				out.push(mod_ent.encode(link_title));
-				out.push('</a>');
+				out.push(format_remote_link(link_title,
+				    mod_ent.encode(link_title)));
 
 				state = 'TEXT';
 			} else {
@@ -769,10 +785,8 @@ parse_jira_markup(desc, ps)
 
 		case 'LINK_URL':
 			if (c === ']') {
-				out.push('<a href="' + fix_url(link_url) +
-				    '" target="_new">');
-				out.push(mod_ent.encode(link_title));
-				out.push('</a>');
+				out.push(format_remote_link(link_url,
+				    mod_ent.encode(link_title)));
 
 				state = 'TEXT';
 			} else {
@@ -847,7 +861,34 @@ parse_jira_markup(desc, ps)
 }
 
 function
-format_markup(desc)
+eat_block(line)
+{
+	return (line.match(/^{[^}]*}?(.*)/)[1]);
+}
+
+function
+format_panel_open(names)
+{
+	var html = '<div class="';
+	var i;
+
+	for (i = 0; i < names.length; ++i) {
+		html += names[i] + ' ';
+	}
+
+	html += '"><div class="';
+
+	for (i = 0; i < names.length; ++i) {
+		html += names[i] + 'Content ';
+	}
+
+	html += '">';
+
+	return (html);
+}
+
+function
+format_markup_fallback(desc)
 {
 	var out = '';
 	var lines = desc.split(/\r?\n/);
@@ -877,23 +918,41 @@ format_markup(desc)
 			}
 			if (fmton) {
 				parse_markup = true;
-				out += (lt_quote ? '</div>' : '</pre>') + '\n';
+				if (lt_noformat || lt_code) {
+					out += '</pre>';
+				}
+				if (lt_quote) {
+					out += '</blockquote>\n';
+				} else {
+					out += '</div></div>\n';
+				}
 				line = '';
 			} else if (lt_quote) {
 				newline_br = true;
 				parse_markup = true;
-				out += '<div style="border-left: 2px solid ' +
-				    '#888888; margin-left: 1em; ' +
-				    'padding-left: 1em">\n';
-				line = line.match(/^{[^}]*}?(.*)/)[1];
-			} else {
+				out += '<blockquote>\n';
+				line = eat_block(line);
+			} else if (lt_panel) {
+				newline_br = false;
+				parse_markup = true;
+				out += format_panel_open(
+				    [ 'panel' ]);
+				out += '\n';
+				line = eat_block(line);
+			} else if (lt_noformat) {
 				newline_br = false;
-				parse_markup = !(lt_noformat || lt_code);
-				out += '<pre style="border: 2px solid black;' +
-				    'font-family: Menlo, Courier, ' +
-				    'Lucida Console, Monospace;' +
-				    'background-color: #eeeeee;">\n';
-				line = line.match(/^{[^}]*}?(.*)/)[1];
+				parse_markup = false;
+				out += format_panel_open(
+				    [ 'preformatted', 'panel' ]);
+				out += '<pre>\n';
+				line = eat_block(line);
+			} else if (lt_code) {
+				newline_br = false;
+				parse_markup = false;
+				out += format_panel_open(
+				    [ 'code', 'panel' ]);
+				out += '<pre>\n';
+				line = eat_block(line);
 			}
 			fmton = !fmton;
 		}
@@ -917,6 +976,22 @@ format_markup(desc)
 	return (out);
 }
 
+
+function
+format_markup(desc)
+{
+	try {
+		return mod_jiramark.markupToHTML(desc, jiraops);
+	} catch (e) {
+		LOG.warn({
+			errmsg: e.message,
+			markup: desc
+		}, 'failed to convert markup to HTML');
+	}
+
+	return format_markup_fallback(desc);
+}
+
 function
 format_issue_json(issue)
 {
@@ -1180,7 +1255,6 @@ format_issue_finalise(issue, remotelinks, other_issues)
 			}, 'comment maxResults and total not equal for issue');
 		}
 
-		var dark = false;
 		for (i = 0; i < c.comments.length; i++) {
 			var com = c.comments[i];
 
@@ -1194,9 +1268,13 @@ format_issue_finalise(issue, remotelinks, other_issues)
 
 			var cdtc = new Date(com.created);
 
-			out += '<div style="background-color: ' +
-			    (dark ? '#DDDDDD' : '#EEEEEE') + ';">\n';
+			if (i !== 0) {
+				out += '<hr>\n';
+			}
+
+			out += '<div>\n';
 			out += '<b>';
+			out += '<a name="comment-' + i + '"></a>';
 			out += 'Comment by ' + com.author.displayName;
 			out += '<br>\n';
 			out += 'Created at ' + cdtc.toISOString();
@@ -1208,9 +1286,7 @@ format_issue_finalise(issue, remotelinks, other_issues)
 			}
 			out += '</b>';
 			out += format_markup(com.body);
-			out += '</div><br>\n';
-
-			dark = !dark;
+			out += '</div>\n';
 		}
 	}
 
@@ -1231,7 +1307,7 @@ function
 format_remote_link(link, text)
 {
 	var anchor = '<a rel="noopener noreferrer" target="_blank" href="' +
-	    link + '">' + text + '</a>';
+	    fix_url(link) + '">' + text + '</a>';
 
 	return (anchor);
 }
diff --git a/package.json b/package.json
index 3cf033d..df5dd7d 100644
--- a/package.json
+++ b/package.json
@@ -8,13 +8,14 @@
   "private": true,
   "dependencies": {
     "assert-plus": "^1.0.0",
-    "bunyan": "~0.22.1",
+    "bunyan": "~1.8.12",
     "ent": "~2.0.0",
-    "restify": "~2.6.1",
+    "jiramark": "0.4.0",
+    "restify": "~4.3.4",
     "vasync": "^1.6.4"
   },
   "devDependencies": {
-    "eslint": "4.13.1",
+    "eslint": "4.19.1",
     "eslint-plugin-joyent": "~2.1.0"
   }
 }
diff --git a/templates/primary.html b/templates/primary.html
index c9a6061..dcefe94 100644
--- a/templates/primary.html
+++ b/templates/primary.html
@@ -5,10 +5,61 @@
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <link href="%%HTTP%%://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
   <style>
+    /* Override some default bootstrap CSS. */
     body {
       padding-top: 50px;
       padding-bottom: 20px;
     }
+    p:last-child {
+      padding: 0em;
+      margin: 0em;
+    }
+    blockquote {
+      border-left: 2px solid #888888;
+      margin-left: 1em;
+      margin-right: 1em;
+      padding-left: 1em;
+    }
+    pre {
+      border: none;
+      margin: 0em;
+      padding: 0em;
+    }
+    hr {
+      border-top: 1px solid black;
+    }
+    blockquote > p {
+        font-size: 1em;
+        font-weight: normal;
+        line-height: 1.428571429;
+    }
+
+    /* Style processed JIRA markup. */
+    div.panel {
+      border: 2px solid black;
+      margin-left: 1em;
+      margin-right: 1em;
+    }
+    div.code, div.preformatted {
+      font-family: Menlo, Courier, Lucida Console, Monospace;
+    }
+    div.panel, pre {
+      background-color: #eeeeee;
+    }
+    div.panel div {
+      padding: 9px 12px;
+    }
+    div.panel div.panelHeader {
+      border-bottom: 2px solid black;
+    }
+    th, tr {
+      border: 1px solid black;
+      padding: 3px 4px;
+    }
+    th {
+      background-color: #eeeeee;
+      text-align: center;
+    }
   </style>
   <title>%%TITLE%%</title>
 </head>
-- 
2.21.0

