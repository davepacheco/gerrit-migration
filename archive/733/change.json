{"project":"joyent/illumos-joyent","branch":"master","id":"I876676abc35e7852f07c02c7d7fce5ee06dbe110","number":"733","subject":"OS-5721 lx_devfs leaks holds when opening root dir with O_CREAT Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/733","commitMessage":"OS-5721 lx_devfs leaks holds when opening root dir with O_CREAT\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1476886348,"lastUpdated":1477410147,"open":false,"status":"MERGED","comments":[{"timestamp":1476886348,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1476889986,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1476895537,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1477002834,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1477015939,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1477021040,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1477050433,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1477062953,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\ntest program:\n\n    #include \u003csys/types.h\u003e\n    #include \u003csys/stat.h\u003e\n    #include \u003cfcntl.h\u003e\n\n    int\n    main()\n    {\n            open(\"/dev\", O_RDWR | O_CREAT, 0);\n            open(\"/dev\", O_RDWR | O_CREAT, 0);\n            open(\"/dev\", O_RDWR | O_CREAT, 0);\n            open(\"/dev\", O_RDONLY | O_CREAT, 0);\n            open(\"/dev\", O_RDONLY | O_CREAT, 0);\n            open(\"/dev\", O_RDONLY | O_CREAT, 0);\n            open(\"/dev/zvol\", O_RDWR | O_CREAT, 0);\n            open(\"/dev/zvol\", O_RDWR | O_CREAT, 0);\n            open(\"/dev/zvol\", O_RDWR | O_CREAT, 0);\n            open(\"/dev/kstat\", O_RDWR | O_CREAT, 0);\n            open(\"/dev/kstat\", O_RDWR | O_CREAT, 0);\n            open(\"/dev/kstat\", O_RDWR | O_CREAT, 0);\n    }\n\nstop program on exit so I can check vnode holds:\n\n    dtrace -wqn \u0027syscall::rexit:entry /execname \u003d\u003d \"min_open_test\"/ { printf(\"%d\\n\", pid); stop(); }\u0027\n\nstrace output:\n\n    open(\"/dev\", O_RDWR|O_CREAT, 0)         \u003d -1 EISDIR (Is a directory)\n    open(\"/dev\", O_RDWR|O_CREAT, 0)         \u003d -1 EISDIR (Is a directory)\n    open(\"/dev\", O_RDWR|O_CREAT, 0)         \u003d -1 EISDIR (Is a directory)\n    open(\"/dev\", O_RDONLY|O_CREAT, 0)       \u003d 3\n    open(\"/dev\", O_RDONLY|O_CREAT, 0)       \u003d 4\n    open(\"/dev\", O_RDONLY|O_CREAT, 0)       \u003d 5\n    open(\"/dev/zvol\", O_RDWR|O_CREAT, 0)    \u003d 6\n    open(\"/dev/zvol\", O_RDWR|O_CREAT, 0)    \u003d 7\n    open(\"/dev/zvol\", O_RDWR|O_CREAT, 0)    \u003d 8\n    open(\"/dev/kstat\", O_RDWR|O_CREAT, 0)   \u003d 9\n    open(\"/dev/kstat\", O_RDWR|O_CREAT, 0)   \u003d 10\n    open(\"/dev/kstat\", O_RDWR|O_CREAT, 0)   \u003d 11\n\nvnode holds while stopped in process exit:\n\n    \u003e ::walk vn_cache | ::grep \u0027*(.+18) \u003d\u003d 0xffffff01c854c1f0\u0027 | ::printf \"(%d) %s (0x%p)\\n\" vnode_t v_count v_path . ! egrep \u0027/dev |/dev/zvol |/de\n    v/kstat \u0027\n    (4) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/dev (0xffffff01deca3c00)\n    (3) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/dev/kstat (0xffffff0255d36400)\n    (3) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/dev/zvol (0xffffff025cf6d100)\n    \u003e ::walk vn_cache | ::grep \u0027*(.+18) \u003d\u003d 0xffffff01c854cb00\u0027 | ::printf \"(%d) %s (0x%p)\\n\" vnode_t v_count v_path . ! egrep \u0027/dev |/dev/zvol |/de\n    v/kstat \u0027\n    (1) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/native/dev/kstat (0xffffff018fe46a00)\n    (1) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/native/dev/zvol (0xffffff01db59b700)\n    (2) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/native/dev (0xffffff01db59bd00)\n\nvnode holds after process exit:\n\n    \u003e ::walk vn_cache | ::grep \u0027*(.+18) \u003d\u003d 0xffffff01c854c1f0\u0027 | ::printf \"(%d) %s (0x%p)\\n\" vnode_t v_count v_path . ! egrep \u0027/dev |/dev/zvol |/de\n    v/kstat \u0027\n    (1) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/dev (0xffffff01deca3c00)\n    \u003e ::walk vn_cache | ::grep \u0027*(.+18) \u003d\u003d 0xffffff01c854cb00\u0027 | ::printf \"(%d) %s (0x%p)\\n\" vnode_t v_count v_path . ! egrep \u0027/dev |/dev/zvol |/de\n    v/kstat \u0027\n    (0) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/native/dev/zvol (0xffffff01db59b700)\n    (2) /zones/710de071-78a4-c369-a8b6-b2414e17d7c6/root/native/dev (0xffffff01db59bd00)"},{"timestamp":1477407552,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1477407559,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1477410005,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1477410113,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1477410147,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"5","revision":"876676abc35e7852f07c02c7d7fce5ee06dbe110","parents":["f71817add648fc4f52e69697061f7bba9f896931"],"ref":"refs/changes/33/733/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1477410113,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477050433,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477407552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477407559,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1477410147,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","type":"MODIFIED","insertions":22,"deletions":-21}],"sizeInsertions":22,"sizeDeletions":-21},"patchSets":[{"number":"1","revision":"be4dc87ffb901384c4a1df0eb2fd398528683832","parents":["c7de84688dd3b115f0d6e8dc3a0e00d9c79f1ce8"],"ref":"refs/changes/33/733/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1476886348,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","line":610,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since this is the only path that results in a success (error \u003d\u003d 0), I would move it down to L615 and turn the \u0027if\u0027 into a \u0027VERIFY\u0027 to assert the invariant for a creat success on an existing node."},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","line":610,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"To be clear, do you mean this?\n\n\tif (error \u003d\u003d 0) {\n\t\tif (exclusive \u003d\u003d EXCL) {\n\t\t\terror \u003d EEXIST;\n\t\t} else if (LDNTOV(lnp)-\u003ev_type \u003d\u003d VDIR \u0026\u0026\n\t\t    (mode \u0026 S_IWRITE)) {\n\t\t\terror \u003d EISDIR;\n\t\t} else if (lnp-\u003elxdn_type \u003d\u003d LXDNT_FRONT) {\n\t\t\terror \u003d ENOTSUP;\n\t\t}\n\n\t\tif (error !\u003d 0) {\n\t\t\tldnode_rele(lnp);\n\t\t\treturn (error);\n\t\t}\n\n\t\tVERIFY3S(error, \u003d\u003d, 0);\n\t\tVERIFY3S(lnp-\u003elxdn_type, \u003d\u003d, LXDNT_BACK);\n\t\t*vpp \u003d lnp-\u003elxdn_vnode;\n\n\t\treturn (error);\n\t}"},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","line":610,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah.  The VERIFY of error\u003d\u003d0 is probably unnecessary, but the rest looks good."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","type":"MODIFIED","insertions":20,"deletions":-21}],"sizeInsertions":20,"sizeDeletions":-21},{"number":"2","revision":"5d304acb0f72cccd993ecb5167f5ddc7094fbe6a","parents":["c7de84688dd3b115f0d6e8dc3a0e00d9c79f1ce8"],"ref":"refs/changes/33/733/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1477015939,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","type":"MODIFIED","insertions":22,"deletions":-21}],"sizeInsertions":22,"sizeDeletions":-21},{"number":"3","revision":"5e15c4fa926c66f7dccee47546db929670e11933","parents":["5373bfca1478d6f817b11a8735b557503f35e7a8"],"ref":"refs/changes/33/733/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1477021040,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477050433,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477407552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477407559,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","type":"MODIFIED","insertions":22,"deletions":-21}],"sizeInsertions":22,"sizeDeletions":-21},{"number":"4","revision":"7928194fe54765721f195e839172e8cce1124f22","parents":["f71817add648fc4f52e69697061f7bba9f896931"],"ref":"refs/changes/33/733/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1477410005,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477050433,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477407552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477407559,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","type":"MODIFIED","insertions":22,"deletions":-21}],"sizeInsertions":22,"sizeDeletions":-21},{"number":"5","revision":"876676abc35e7852f07c02c7d7fce5ee06dbe110","parents":["f71817add648fc4f52e69697061f7bba9f896931"],"ref":"refs/changes/33/733/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1477410113,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477050433,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477407552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477407559,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1477410147,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/devfs/lxd_vnops.c","type":"MODIFIED","insertions":22,"deletions":-21}],"sizeInsertions":22,"sizeDeletions":-21}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}