{"project":"joyent/sdc-manta","branch":"master","id":"I73046c3d0bbf8974cfe46070cc42d211486ada1f","number":"4862","subject":"MANTA-3943 add \u0027accel-gc\u0027 subcommand to manta-adm MANTA-4046 add manta-adm accel-gc migrate-config subcommand","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/4862","commitMessage":"MANTA-3943 add \u0027accel-gc\u0027 subcommand to manta-adm\nMANTA-4046 add manta-adm accel-gc migrate-config subcommand\n","createdOn":1537573478,"lastUpdated":1547166470,"open":false,"status":"MERGED","comments":[{"timestamp":1537573478,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1537573529,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1537573619,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1537573670,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1537840265,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1537840323,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538163523,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1538166039,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1538166893,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538167136,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538174284,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1538174347,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1538175074,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 7."},{"timestamp":1538176004,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538508462,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 7:\n\n(16 comments)\n\nThanks! Just a few questions in the comments."},{"timestamp":1539902076,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1539902114,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(16 comments)"},{"timestamp":1539902131,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539982994,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 7:\n\n(13 comments)\n\nI\u0027m curious what your thoughts are about moving/removing the disable-snaplinks code! Thanks for the updates."},{"timestamp":1539994186,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 9."},{"timestamp":1539994247,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539994330,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 10."},{"timestamp":1539994386,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539995164,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 11."},{"timestamp":1539995227,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540245888,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 11:\n\n(13 comments)"},{"timestamp":1540245897,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 12."},{"timestamp":1540245961,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540416651,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 12:\n\n(6 comments)\n\nThanks! Sorry for the delay on getting comments back."},{"timestamp":1540505383,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 12:\n\n(5 comments)"},{"timestamp":1540505395,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 13."},{"timestamp":1540505445,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540510943,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 14."},{"timestamp":1540510987,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540515388,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 15."},{"timestamp":1540515431,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540567902,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 7:\n\n(3 comments)\n\nNice! Looking good!"},{"timestamp":1540581442,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 15:\n\n(3 comments)\n\nI have changed the name of the \u0027gc\u0027 subcommand to \u0027accel-gc\u0027 to distinguish it from the work we plan to do in RFD-123."},{"timestamp":1540581455,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 16."},{"timestamp":1540581500,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540581520,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 17: Commit message was updated."},{"timestamp":1540590586,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 17: Code-Review+1\n\nGreat!"},{"timestamp":1540599834,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 18."},{"timestamp":1540599888,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1540828158,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 18: Code-Review+1"},{"timestamp":1541706467,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 19."},{"timestamp":1541706512,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541724990,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 20."},{"timestamp":1541725038,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542039047,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 20:\n\n(1 comment)\n\nJust curious about the sdc-script change and then I\u0027ll give this a +1."},{"timestamp":1542066714,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 21."},{"timestamp":1542066749,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 21:\n\n(1 comment)"},{"timestamp":1542066765,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 21: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542127687,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 21: Code-Review+1"},{"timestamp":1542191686,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 21:\n\n(8 comments)\n\nThanks for putting this together!  I haven\u0027t looked _too_ hard at CR for this, but have added some notes for the things I noticed.  I took a look at this more from the perspective of IA.\n\nI don\u0027t see many failure scenarios noted in the ticket.  Can you think of any that are worth explicitly outlining?  Bad user input leading to corrupt SAPI metadata?  Incorrect svcnames passed to the CLI or update.json?  Does (should?) updating metadata work if run on the non-master AZ?\n\nIt would be great to see some testing done on a multi-AZ setup, but if you\u0027re happy that this has been addressed with the production deployment then I\u0027m happy.\n\nHas this been tested in an installation that has never seen accel-gc?  I think your notes cover this with regards to deploying this to production, but I wasn\u0027t sure how much of that was tested given the un-deploy steps in your notes.\n\nIf I\u0027m reading this correctly, it looks like some of this is not safe to run concurrently across separate runs of the tool or different AZs, because we pull SAPI metadata and then put it back with modifications.  I think this is true for a lot of manta commands, but I\u0027m not sure I recall where this is documented.  Do you know of anywhere this is described?  If not, can we add a note about this somewhere?  If this is included in the operator guide changes then I think that\u0027s probably fine, too.\n\nThere don\u0027t appear to be manpage changes here.  Personally, I\u0027m happy for that to follow in another change so long as we get it filed in JIRA.\n\nLastly, please don\u0027t worry about a new PS if it\u0027s only to address the nits I\u0027ve raised!  They are minor."},{"timestamp":1542241159,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 21:\n\n(8 comments)\n\nI will do some failure case testing (bad input). There are some deployment-related edge cases documented in QA-319. \n\nI\u0027ll need to test sapi metadata updates in a non-master AZ somehow. Our plan in production has been to deploy all garbage-coillectors in the master AZ so that it\u0027s easy to do manta-oneach stuff.\n\nThis has been tested on an installation that has never seen accel-gc (QA-319) and my own testing (I re-deployed Manta with this sdc-manta image in my lab environment -- I should note that in the ticket). I was able to successfully un-deploy the garbage-collectors and manta with these changes.\n\nRe: multiple manta-adm command running concurrently: It\u0027s documented in the operator guide. I\u0027ll add some more emphasis in the GC sections I added in MANTA-3977.\n\nI\u0027ll add some man page information in the next patchset!\n\nThanks for this review!"},{"timestamp":1542243136,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 22."},{"timestamp":1542243182,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 22: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542249584,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 23."},{"timestamp":1542249629,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 23: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542262969,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 24."},{"timestamp":1542263018,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 24: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542294363,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 24: Code-Review+1"},{"timestamp":1542323913,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 24:\n\nRichard Bradley: I think I addressed all of your IA notes in the comments of the MANTA-3943 ticket. \n\nUnforunately, we don\u0027t have a multi-AZ deployment that I am able to test on, but I did try setting a metadata field on an  electric-moray in staging from a non-master AZ and that seemed to work. I don\u0027t think there\u0027s reason to believe that doing this for garbage-collectors would be any different, but it\u0027s something that we can highlight in the deployment to staging when it happens.\n\nI should note that I also rendered the man page changes I added."},{"timestamp":1542324348,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 24:\n\nRichard Bradley: Also, no pressure or anything but if you had a moment to take a look at MANTA-3948 for IA, I think you probably have some context for it from this CR."},{"timestamp":1542382196,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 24:\n\n(8 comments)"},{"timestamp":1542397641,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 24:\n\n(7 comments)"},{"timestamp":1542397675,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 25."},{"timestamp":1542397722,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 25: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542399712,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 26."},{"timestamp":1542399759,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 26: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542400483,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 27."},{"timestamp":1542400502,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 27:\n\n(1 comment)"},{"timestamp":1542400530,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 27: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542402164,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 27: Code-Review+1"},{"timestamp":1542403295,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 28."},{"timestamp":1542403345,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 28: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542403386,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 27:\n\nIn the most recent patchset I\u0027ve abstracted out the check for whether a service config exists in SAPI into a separate function and also differentiated this check from the one that tells us whether the service is known. \n\nThere are some updated tests with this change in the ticket comments."},{"timestamp":1542620910,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 28: Code-Review+1 Integration-Approval+1\n\n(1 comment)\n\nTesting notes look good. Thanks for including those failure scenarios! From the ticket I can see that each of the errors are quite actionable by someone running the tool that perhaps doesn\u0027t know its innards.\n\nI\u0027ve hit CR/IA+1 for this on the presumption that you\u0027re happy with the rendered manpages (I know you added a note about this previously, but just wanted to confirm you\u0027re happy with them after rendering them from markdown)."},{"timestamp":1542655529,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 28: Code-Review+1\n\nLooks good. Thanks."},{"timestamp":1543882262,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 29: Patch Set 28 was rebased"},{"timestamp":1543882318,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 29:\n\n\"make check\" passed ok"},{"timestamp":1544756469,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 30."},{"timestamp":1544756478,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 31: Patch Set 30 was rebased"},{"timestamp":1544756522,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 30: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544756646,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 31: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544761676,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 32."},{"timestamp":1544761727,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 32: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544775465,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 33."},{"timestamp":1544775516,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 33: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545042403,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 33:\n\n(2 comments)"},{"timestamp":1545075884,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 33:\n\n(16 comments)"},{"timestamp":1545102742,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 34."},{"timestamp":1545102750,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 33:\n\n(18 comments)"},{"timestamp":1545102794,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 34: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545102911,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 33:\n\nKody brings up a good point, which is that the migration tools might be better suited for it\u0027s own file since it will probably be deprecated after we run it in SPC. My plan for the next patchset will be to move the migrate_config subcommand into it\u0027s own file under cmd/ (and symlink it into bin/). It will be pretty much the same logic I\u0027ve got here."},{"timestamp":1545257258,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 35."},{"timestamp":1545257310,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 35: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545257560,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 36."},{"timestamp":1545257609,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 36: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546874984,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 36: Code-Review+1\n\nCR+1 from me. I think Kody\u0027s comments have also been addressed, but once we have his CR+1 it would be great if you could make a note if the testing notes in the tickets are still applicable, then I\u0027ll take another look over them for IA."},{"timestamp":1546876408,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 36:\n\n(5 comments)\n\nGreat! Looks good. Sorry for the delay, and thanks for doing that big refactor to pull the migration tool into a separate file.\n\nI just added a few small things. Additionally the copyrights could be updated to 2019 now."},{"timestamp":1546996423,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 36:\n\n(4 comments)"},{"timestamp":1546996438,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 37."},{"timestamp":1546996489,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 37: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547050819,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 37: Code-Review+1\n\n(1 comment)"},{"timestamp":1547062652,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 37: Code-Review+1\n\n(1 comment)\n\nIt would be nice if we had a man page for the manta-gc-configadm tool, but it\u0027s not a huge deal if the command\u0027s help output is decent."},{"timestamp":1547115593,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 37:\n\n(1 comment)\n\nSince PS28 (when I last gave IA+1) I\u0027m happy that there are decent testing notes regarding the major changes. Is `make prepush` clean?"},{"timestamp":1547150036,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 37:\n\n(2 comments)\n\nRichardB: The change is `make prepush` clean.\nKody: I was thinking about adding a manpage, but I thought that since the command shouldn\u0027t normally be necessary in typical deployments, I wanted to minimize its visibility. I\u0027m happy to add a manpage if you think it\u0027s a good idea, but would you be fine with moving that to another change? The help message of the command states that it performs special case operations and that one should consult `manta-adm accel-gc` before using the tool."},{"timestamp":1547154696,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 37: Integration-Approval+1"},{"timestamp":1547166470,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"}],"currentPatchSet":{"number":"37","revision":"73046c3d0bbf8974cfe46070cc42d211486ada1f","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/37","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1546996438,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546996489,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547050819,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547062652,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547154696,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1547166470,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manta-gc-configadm","type":"ADDED","insertions":1,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":390,"deletions":-1},{"file":"cmd/manta-gc-configadm.js","type":"ADDED","insertions":570,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":102,"deletions":-2},{"file":"lib/adm.js","type":"MODIFIED","insertions":780,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":109,"deletions":-3}],"sizeInsertions":1994,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"4d8b3e60c1df2bf163bc5c72e673f98586b8392c","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1537573478,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537573529,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":122,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":194,"deletions":0}],"sizeInsertions":348,"sizeDeletions":-4},{"number":"2","revision":"e4f61da51a591e4b8693782581422be20ba253de","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1537573619,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537573670,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":121,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":194,"deletions":0}],"sizeInsertions":347,"sizeDeletions":-4},{"number":"3","revision":"81f1f6b8e315701bd89cd1d6b02742e4d6d05cb5","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1537840265,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537840323,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":129,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":248,"deletions":0}],"sizeInsertions":409,"sizeDeletions":-4},{"number":"4","revision":"be8fc8067a8b429777d4160955d8ef49d59c2ef0","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1538163523,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538166893,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":194,"deletions":-1},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":373,"deletions":-1}],"sizeInsertions":599,"sizeDeletions":-6},{"number":"5","revision":"ab8b40a6857acb1366a13ebf071d50d6db40756f","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1538166039,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538167136,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":193,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":383,"deletions":-1}],"sizeInsertions":608,"sizeDeletions":-5},{"number":"6","revision":"c354183d471a9e990f7059b159ceb5dec5023546","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1538174284,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1538174347,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-adm.js","line":361,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":193,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":383,"deletions":-1}],"sizeInsertions":608,"sizeDeletions":-5},{"number":"7","revision":"9e628940e3e224cb838f42a4c6162a5d159566ad","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1538175074,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538176004,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-adm.js","line":0,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It would be great if we had sub-command help output for the GC subcommands, like we do for other manta-adm commands. That would help to explain which arguments are required and optional for \u0027genconfig\u0027 and others.\n\n# manta-adm help update\nUpdate deployment to match a JSON configuration.\n\nOptions:\n    -l ARG, --log_file\u003dARG, --log-file\u003dARG\n                                        Dump logs to this file (or \"stdout\").\n    -n, --dryrun                        Print what would be done without\n                                        actually doing it.\n    -y, --confirm                       Bypass all confirmations (be careful!).\n    --config-file\u003dARG                   Path to configuration.\n    --no-reprovision                    When upgrading a zone, always provision\n                                        and deprovision rather than reprovision."},{"file":"cmd/manta-adm.js","line":0,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":320,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should line continuations be four-space indents?"},{"file":"cmd/manta-adm.js","line":320,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":329,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"can you provide an example of what this file would look like? I just want to know for CR to help me understand what the operator will be providing here. It doesn\u0027t need to be in a code comment."},{"file":"cmd/manta-adm.js","line":329,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"manta-adm gc update gc.json,\n\nwhere gc.json is \n\n{\n    \"garbage-collector-instance-uuid\": {\n        \"GC_ASSIGNED_SHARDS\": [\n            {\n                \"host\": \"1.moray.example.com\"\n            },\n            ...\n        ]\n    },\n    ...\n}\n\nshow/update manage the mapping from shards to garbage-collector instances, genconfig layers garbage-collector instances on an existing deployment."},{"file":"cmd/manta-adm.js","line":329,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Great, thanks."},{"file":"cmd/manta-adm.js","line":329,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":403,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"My bias is to use jsprim.parseInteger(), to forgo the try/catch, and to instead return the (possibly wrapped) error that jsprim returns."},{"file":"cmd/manta-adm.js","line":403,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":437,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I downloaded this patch and couldn\u0027t reach this code or the code from MantaAdmGc.prototype.do_show.options. Am I doing something wrong?\n\n# ./build/node/bin/node ./bin/manta-adm gc help genconfig\nmanta-adm gc: error: no help for \"genconfig\"\n\n# ./build/node/bin/node ./bin/manta-adm gc help show\nmanta-adm gc: error: no help for \"show\"\n\nDo we need to implement do_help functions for .options to be referenced?"},{"file":"cmd/manta-adm.js","line":437,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"What do you mean by couldn\u0027t reach? I think some of the other help messages reference the options array with some templating syntax. Does that address your point here? \n\nI think you can use these options with the current patchset."},{"file":"cmd/manta-adm.js","line":437,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"yeah, I think it\u0027s fixed now. I think we just had to add the \u003coperation\u003e.help code"},{"file":"cmd/manta-adm.js","line":437,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":447,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"The word \u0027typically\u0027 here makes me wonder which circumstances lead to co-location w/ LBs and nameservice instances despite providing this flag."},{"file":"cmd/manta-adm.js","line":447,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah this is not good phrasing. What I meant to express is that, in production deployments, you\u0027d typically want to _not_ ignore the criteria. In some deployments, it\u0027s not possible to avoid co-locating collectors with loadbalancers/nameservice zones."},{"file":"cmd/manta-adm.js","line":450,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"What about storage nodes? Should we make this a comma-separated list with loadbalancer and nameservice (and storage?) being the defaults?"},{"file":"cmd/manta-adm.js","line":450,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Good point. Do you mean replace this switch with: --avoid-zones\u003dloadbalancer,nameservice,storage? I think that\u0027s reasonable."},{"file":"cmd/manta-adm.js","line":450,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Cool. And I guess I don\u0027t understand why we\u0027d like to avoid colocating with loadbalancer and nameservice zones. Is there a particular reason why?"},{"file":"cmd/manta-adm.js","line":450,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"When I was planning deployment in us-east with Dave he thought this would be a good idea - it could have just been an extra precaution, but I think it makes sense to avoid putting potentially really CPU/memory heavy zones on the same CNs as nameservice at least. The amount of work they do will scale with the number of shards assigned to them, and since we\u0027re allowing operators to change that assignment it might be good to ensure that any unintended noisy-neighbor consequences don\u0027t have a disastrous impact. This could all be production paranoia though."},{"file":"config/services/garbage-collector/service.json","line":17,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Are these fields still necessary after this change?"},{"file":"config/services/garbage-collector/service.json","line":17,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2407,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"If the user doesn\u0027t use the include_all arg, will all of the INDEX_MORAY_SHARDS be split between the GC zones in only the current datacenter?"},{"file":"lib/adm.js","line":2407,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"This tool will always distribute index shards to only garbage-collectors in the current datacenter. The \u0027include_all\u0027 flag determines whether or not the `getDeployedInstanceMetadataJson` below will include all fields in the SAPI instance\u0027s \"metadata\" field, or just \"GC_ASSIGNED_SHARDS\". \n\nMy thinking was that getDeployedInstanceMetadataJson would be service-agnostic, and we might use it in the future to set multiple SAPI instance metadata fields across multiple instances of a different service in the future. \n\nPerhaps the switch could be renamed to \u0027all_metadata\u0027 to make this clearer and not confuse it with the semantics of other \u0027include_all\u0027 options."},{"file":"lib/adm.js","line":2407,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, okay that makes more sense. So let me run through an example here.\n\nOur Manta deployment has three index shards. We deploy three garbage-collector zones to DC1. Each garbage-collector zone is assigned one of the three index shards. Now we deploy three garbage-collector zones to DC2. Those three zones now _also_ each get assigned one index shard?"},{"file":"lib/adm.js","line":2407,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"That\u0027s right."},{"file":"lib/adm.js","line":2417,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks like there\u0027s a lot of use of vasync.pipeline and vasync.forEachPipeline here, but it doesn\u0027t look like these operations are asynchronous. Is there a benefit to using and nesting vasync pipelines here?"},{"file":"lib/adm.js","line":2417,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2424,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Maybe we should make this a local variable since we use it a few times."},{"file":"lib/adm.js","line":2424,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2434,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Could we use jsprim.deepCopy instead? It would be a little more clear."},{"file":"lib/adm.js","line":2434,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2436,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Maybe a small comment that this is a mustache-ism would be helpful here."},{"file":"lib/adm.js","line":2436,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2554,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"The way it is here is fine, but sometimes it makes sense to filter _before_ sorting. It makes the big-O N value smaller."},{"file":"lib/adm.js","line":2554,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2925,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do we want to invoke the callback here too?"},{"file":"lib/adm.js","line":2925,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I guess I don\u0027t understand why we hide this behind the include_all flag. Couldn\u0027t we forgo checking the on-disk config files for services and always use what metadata fields SAPI knows about? It seems like SAPI is likely to be more accurate than the config files that are checked in to this repo."},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"SAPI will include fields like the \"user-script\" which make the output of `manta-adm gc show` output less readable and likely not relevant in the service-specific context. My thought is this function will be used to extend `manta-adm` with modes that are used to manage instance-specific metadata for a pool of instances that belong to a service. It would make sense to me that the set of metadata fields that are manageable by such a mode form a subset of the fields that are required for first-time deployment.\n\nFor example in the context of garbage-collectors, what we really care about are fields like \"GC_ASSIGNED_SHARDS\" and \"GC_ASSIGNED_BUCKETS\", and not \"SDC_NAMESERVERS\" (for example). You can still manage the other metadata with the usual SAPI tools.\n\nIf you think it makes more sense to always include all the metadata I\u0027m willing to remove the filter."},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"yeah, I seem to have misunderstood the include_all flag. I think the question still remains about reading a local config file instead of reaching out to SAPI.\n\nIt looks like maAdm.prototype.loadServiceSpecificSAPIMetadata actually reads the service.json file in /opt/smartdc/manta-deployment/config/\u003cservice\u003e/service.json instead of reaching out to SAPI. Maybe I\u0027m not understanding this code though."},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah - I\u0027m not sure what the best way to do this is. What I really want is a way to filter metadata fields that are unrelated to the specific service that this instance is part of. Right now it seems like the best way to do that is to have a hard-coded list of default fields that are ignored unless \"all_metadata\" is passed."},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, I misunderstood this until now.\n\nMaybe we should have \u0027manta-adm gc show\u0027 act like \u0027manta-adm show\u0027 and output human readable data by default. We could provide a -j flag to output the JSON data for use with reconfiguring the GC instances. (Sorry for potentially adding more work so late in the CR cycle).\n\nAnd as for picking which pieces of metadata to display/not display, how about having the user provide a whitelist instead of using a global blacklist?\n\nIt looks like now the user calls this like adm.dumpDeployedInstanceMetadataJson({ \u0027svcname\u0027: \u0027gc\u0027, \u0027all_metadata\u0027: false });\n\nBut what if they could do this:\nadm.dumpDeployedInstanceMetadataJson({ \u0027svcname\u0027: \u0027gc\u0027, \u0027fields\u0027: [\u0027GC_ASSIGNED_SHARDS\u0027] });\n\nThat would make it easier for callers to know exactly what would be dumped out."},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I agree with you on the metadata point.\n\nI thought a bit about a human readable form, but `manta-adm gc show` is a bit different than `manta-adm show`. In general, I don\u0027t think there\u0027s a nice way to put garbage-collector metadata in a tabular format (and operators can already use manta-adm show to view the layout of garbage-collectors in the DC). Would you want something like:\n\n\u003cinstance-uuid\u003e\n   shards:\n       - \u003cshard url\u003e\n       - \u003cshard url\u003e\n   buckets:\n       - manta_fastdelete_queue\n   ...\n\n\u003cinstance-uuid\u003e\n   shards:\n       - \u003cshard url\u003e\n       - \u003cshard url\u003e\n    buckets:\n        - manta_fastdelete_queue\n\n...? \n\nI was thinking of doing that, but wasn\u0027t really sure whether it was much easier to look at than json. Do you think it\u0027s worth doing/have a different suggestion for a human-readable format?"},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think it would be great if we could mirror the CLI feel of \u0027manta-adm show [-j]\u0027 here, just to remain consistent. Even if we just implement a stub for the human readable output that says it\u0027s not implemented and the user should use -j.\n\nI was sort of thinking it would be cool to have something ilke:\n\n INSTANCE            SHARDS                   BUCKETS\n \u003cinstance_uuid\u003e     1, 3, 5, 7, and 30 more  manta_fastdelete_queue\n \u003cinstance_uuid\u003e     2, 4, 6, 8, and 30 more  manta_fastdelete_queue\n Use -j to see full output.\n\nBut maybe that\u0027s not useful enough to implement, and it might not look good on a terminal."},{"file":"lib/adm.js","line":2945,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think for now I\u0027l leave the human-readable format bit stubbed out and put the json printing functionality behind the `-j` flag."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":194,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":383,"deletions":-1}],"sizeInsertions":609,"sizeDeletions":-5},{"number":"8","revision":"dcd5997dd63ac130255808fa40520aae49fa94a6","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1539902076,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539902131,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-adm.js","line":315,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"it seems like this should use a \u0027-\u0027 instead of a \u0027_\u0027 to match other options."},{"file":"cmd/manta-adm.js","line":315,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":318,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks like this is one object in an array when it should be two separate objects in this array (one for -a and one for -A)."},{"file":"cmd/manta-adm.js","line":318,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":429,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do we need to parse this into an array somehow? Maybe the \u0027help\u0027 output could specify how the user should enter this information (comma-delimited, space-delimited, -a loadbalancer -a nameservice, something else...)."},{"file":"cmd/manta-adm.js","line":429,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It\u0027s \"-a loadbalancer -a nameservice\", I updated the genconfig help to include this."},{"file":"cmd/manta-adm.js","line":460,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks like there are a pair of positional arguments that we should list here too:\n\n./build/node/bin/node ./bin/manta-adm gc genconfig ploop\nmanta-adm gc: error: missing arguments: IMAGE_UUID NCOLLECTORS"},{"file":"cmd/manta-adm.js","line":460,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":480,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"In my opinion enabling/disabling snaplinks shouldn\u0027t be part of the \u0027manta-adm gc\u0027 subcommand.\n\nLike if we wanted to disable snaplinks on an account for a reason _other_ than GC it would feel weird to use `manta-adm gc disable-snaplinks kkantor`.\n\nThis sort of feels like an abstraction leak to me. It seems like we\u0027re modifying data that belongs to Triton (user accounts). But maybe we do this other places already.\n\nI would prefer to leave this as something an operator has to do separately with Triton. e.g. \u0027sdc-useradm add-attr kkantor disable_snaplinks true\u0027 or whatever it would be. That\u0027s syntactically not that much different than what\u0027s proposed here."},{"file":"cmd/manta-adm.js","line":480,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think part of the reason we decided to store this information in the Manta SAPI application was that disabling snaplinks was something we would do sparingly until we implement the full online garbage-collection described in RFD 123. At that point, we\u0027d no longer need to disable snaplinks for any account.\n\nIt\u0027s also a switch that enables/disables accelerated GC and, judging by the output of `sdc-useradm get`, it doesn\u0027t seem like any of the options in ufds are as Manta-specific as a `snaplinks_disabled` flag would be. These two points make me hesitant to let this switch stand separate from the GC mode in manta-adm.  Separating the switch out would hide the major side-effect of enabling/disabling gc that this flag has. \n\nIt\u0027s really not something intended to be used in contexts other than gc, so I\u0027m biased to keeping it in the gc mode."},{"file":"cmd/manta-adm.js","line":480,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yes, I misunderstood how we were storing the snaplinks_disabled information. It seems like we store that sort of information in UFDS usually (triton_cns_enabled, approved_for_provisioning).\n\nIf we have to keep it the way it is now I would suggest that we change the name of the flag/function to be something that describes the function rather than the implementation. So maybe `manta-adm gc enable \u003clogin\u003e` which disables snaplinks behind the scenes."},{"file":"cmd/manta-adm.js","line":480,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think that if we do store the snaplink-disabled flag I\u0027d want to do that work in a separate ticket as it will require a muskie change. I think that even if we do move the option to UFDS, I\u0027d still want to have a switch for enabling/disabling it as part of this manta-adm subcommand because of the side-effects that has on manta.\n\nIs it okay with you if I pursue the latter option you mentioned in this comment?"},{"file":"cmd/manta-adm.js","line":480,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yep, that works for me."},{"file":"cmd/manta-adm.js","line":480,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2448,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"So IIUC we store the information about accounts with snaplinks disabled in two places (SAPI and UFDS)? Would it be possible to only store this information in one place so we don\u0027t have to worry about things getting out of sync?"},{"file":"lib/adm.js","line":2448,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"We only store the snaplink toggle in SAPI."},{"file":"lib/adm.js","line":2448,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, great. Thanks. I misunderstood how this works. Thanks."},{"file":"lib/adm.js","line":2573,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Can we hoist this up to the beginning of the file?"},{"file":"lib/adm.js","line":2573,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Sorry this shouldn\u0027t have made it in."},{"file":"lib/adm.js","line":2581,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"My personal preference is to only declare variables together on the same line when they\u0027re all of the same type."},{"file":"lib/adm.js","line":2581,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":355,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":535,"deletions":-1}],"sizeInsertions":922,"sizeDeletions":-13},{"number":"9","revision":"06bd637d6f254c85dcca6d3f9918f564c8fc8370","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1539994186,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539994247,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":361,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":535,"deletions":-1}],"sizeInsertions":928,"sizeDeletions":-13},{"number":"10","revision":"2750cd676bce37fe0e21f89c3a02514bf8fa52a8","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1539994330,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539994386,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":361,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":535,"deletions":-1}],"sizeInsertions":928,"sizeDeletions":-13},{"number":"11","revision":"141d4e4e9f953322ad7e5674264640d583e54db4","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/11","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1539995164,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539995227,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":361,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":535,"deletions":-1}],"sizeInsertions":928,"sizeDeletions":-13},{"number":"12","revision":"5c538cf658d22737b9da81ca735ef48efe2fb76f","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/12","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540245897,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540245961,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-adm.js","line":314,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Is this functionality wired up?"},{"file":"cmd/manta-adm.js","line":314,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"No but will be in the next patchset."},{"file":"cmd/manta-adm.js","line":486,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"and storage zones"},{"file":"cmd/manta-adm.js","line":486,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":3098,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"We should probably also assert that sout is provided and at least that conf is an object."},{"file":"lib/adm.js","line":3098,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":374,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":522,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":940,"sizeDeletions":-14},{"number":"13","revision":"6c3f7da67d7a1d695c311267633e47b51ba4d118","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/13","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540505395,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540505445,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":377,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":527,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":948,"sizeDeletions":-14},{"number":"14","revision":"a1e9c3acb4d0f7930364aa41c4dbb000e574d298","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/14","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540510943,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540510987,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":378,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"lib/adm.js","type":"MODIFIED","insertions":521,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":936,"sizeDeletions":-14},{"number":"15","revision":"e86f23e34d21aa9231aff5862be63cea2a760d1d","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/15","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540515388,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540515431,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-adm.js","line":296,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think this is unused now that the caller passes in the fields that they\u0027d like to show."},{"file":"cmd/manta-adm.js","line":296,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":378,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":521,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":940,"sizeDeletions":-18},{"number":"16","revision":"c5692193f29d8c4e5bb14db3112f9e3d4c74d841","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/16","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540581455,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540581500,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":381,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":521,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":943,"sizeDeletions":-18},{"number":"17","revision":"3ebd9dada06af600b3419b2758baeea189a72c1c","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/17","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540581520,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540581500,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540590586,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":381,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":521,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":943,"sizeDeletions":-18},{"number":"18","revision":"041bae152e626977da7662298142e3391247ab55","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/18","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1540599834,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540599888,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540828158,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":381,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":527,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":949,"sizeDeletions":-18},{"number":"19","revision":"3cfd76b31a0fde4a34b41f0c97fdd7a5249d4a8b","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/19","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1541706467,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541706512,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":381,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":529,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":951,"sizeDeletions":-18},{"number":"20","revision":"0a4de015127cf1aebc60f9a046404fa5edc1acce","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/20","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1541724990,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541725038,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"deps/sdc-scripts","line":1,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks like this may be going back in time. The deefaef587 commit is the latest in sdc-script master. Any particular reason for the change?"},{"file":"deps/sdc-scripts","line":1,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"This went in accidentally."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":532,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":956,"sizeDeletions":-19},{"number":"21","revision":"125032bc556a497a1826556a0a9c461d1e30c996","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/21","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542066714,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542066765,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542127687,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"cmd/manta-adm.js","line":276,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Very minor nit: Any reason for \"Error\" and not \"VError\" here (and a few other places)?"},{"file":"cmd/manta-adm.js","line":276,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It seems to be used in most other places outside this change, so I went with consistency on this one. My bias would be to keep it as an Error, particularly because there isn\u0027t a different error to encapsulate here."},{"file":"cmd/manta-adm.js","line":276,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Agreed. Thanks for the explanation."},{"file":"cmd/manta-adm.js","line":276,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":310,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The notes in your ticket show the `manta-adm accel-gc` command, but the help output shows \"manta-adm gc\".  Is this correct?  I\u0027m not sure if there\u0027s a way to get the full command + subcommand from cmdln, but that might help."},{"file":"cmd/manta-adm.js","line":310,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"This should be manta-adm accel-gc, I will correct it everywhere."},{"file":"cmd/manta-adm.js","line":455,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"If I\u0027m reading layerServiceOnDeployedConfig correctly, does this mean we should also add \"garbage-collector\" to this list?  I\u0027m trying to think of the situation where multiple runs of this command would result in trying to re-use the same CN.  It might not due to us filtering on service count, but I\u0027m not sure."},{"file":"cmd/manta-adm.js","line":455,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"My intentions for this function was for it to serve as a boundary between system-critical services and non-critical services. Generally, I don\u0027t think it\u0027s a bad idea for two garbage-collectors to be co-located, which is why it is not included in the list.\n\nThe garbage-collectors are spread out evenly based on overall CN instance count. In the case you\u0027re describing, we might try to re-use a CN if it\u0027s also the least loaded CN in the deployment, which I think is what we\u0027d want.\n\nTo summarize, if you have an N CNs in your deployment with the same set of non-critical instances deployed, then N calls to add a single garbage-collector with layerServiceOnDeployedConfig will result in 1 garbage-collector per CN.\n\nDid I address your concern here?"},{"file":"cmd/manta-adm.js","line":455,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Very much so! Thank you."},{"file":"cmd/manta-adm.js","line":455,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2653,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This is cool!  I wonder if some of this functionality is more suitable to lib/layout.js?  I\u0027m not actually sure if lib/layout.js is able to take an existing set of deployed instances or not (it might only be able to work with generating fresh configs from a blank set of servers), so this is fine if my suggestion doesn\u0027t make sense."},{"file":"lib/adm.js","line":2653,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I could add a function called layout.extendLayout which takes as arguments the current layout and the arguments here and returns the extended layout.\n\nThe difference would be that the current layout argument would be passed directly as a json object (that we get from lib/adm.js) and not a layout.DcConfigLoader. \n\nThe reason for this is that the DcConfigLoader expects a layout object with this schema: https://github.com/joyent/sdc-manta/blob/master/lib/layout.js#L171-L220, and it would feel a little strange to overload it to also be an object for representing a `config.json` programmatically.\n\nWe would also return a json object directly I think because the layout.Layout object expects a DcConfigLoader.\n\nThe more I think about this, the more hesitant I am to put this in lib/layout. \n\nAs I was reading code, I also looked at the way that MantaAdm.do_update works. It takes the current state of the world and generates a plan to bring Manta to the new state. Unfortunately, this doesn\u0027t apply here either. \n\nI think the reason I think this function could stand alone is that it serves a different purpose than that of either MantaAdm.do_udpate and MantaAdm.do_genconfig: it\u0027s outputting a _proposed_ configuration based on the state of the world, as opposed to a brand new one based on a DcConfigLoader layout.\n\nLet me know what your thoughts are."},{"file":"lib/adm.js","line":2653,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thank you for explaining this! I can agree with your method here, so I think this is fine."},{"file":"lib/adm.js","line":2653,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":2754,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Does lib/common\u0027s stripe() method provide any help in this case?"},{"file":"lib/adm.js","line":2754,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Maybe...? I\u0027m not really seeing it. Could you explain? \n\nI think I am not trying to build a list here, rather trying to modify objects in place. It\u0027s possible that could be re-cast as a list building operation, I just can\u0027t figure out.\n\nReally what I want to do is take a number of instances and distribute evenly across all the CNs. What I\u0027d want is something that takes 1 list and produces many lists. \n\nLet me know if I\u0027m not understanding."},{"file":"lib/adm.js","line":2754,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This sounds fine! I only mentioned it because it sounded like a similar operation, but I don\u0027t think I really understood the intention of this part at the time."},{"file":"lib/adm.js","line":3075,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is this a reason to return an error, if we don\u0027t find any svcs?  I don\u0027t know what will happen if we try to JSON.stringify undefined on L3117 otherwise."},{"file":"lib/adm.js","line":3075,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah, thanks for catching that. I was intending for this to be a generic function. What do you think of it returning the empty \u0027rv\u0027 object in this case. That way the caller can decide whether it\u0027s an error."},{"file":"lib/adm.js","line":3075,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"\u003e What do you think of it returning the empty \u0027rv\u0027 object in this case\n\nInteresting, I\u0027m not sure. I think it depends on what we\u0027d want the caller of this function to expect.\n\nIs it really an error case if the service name provided isn\u0027t in SAPI yet (which is my understanding of SAPI\u0027s \"/services\" endpoint and where this data comes from), but the svcname is indeed valid? I.e. the sdc-manta image has been updated to work with accel-gc, but the accel-gc service isn\u0027t in SAPI yet (by running manta-init?). I personally don\u0027t think this would be an error, so an empty rv object would be fine.\n\nCome to think of it, should we add lib/services.js\u0027s serviceNameIsValid() somewhere here to return a human-friendly error in the case of an invalid svcname? I\u0027m not sure I\u0027ve followed where \"args.svcname\" could come from.\n\nHopefully I\u0027m following what this function is intended for. Please let me know if I\u0027m on the wrong track!"},{"file":"lib/adm.js","line":3075,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Actually, I think this should be an error. And that error should say that the service hasn\u0027t been added to sapi. I will add this. \n\n\u0027args.svcname\u0027 should only come from functions inside manta-adm.js that are designed to administer instances of a particular service, so it would be hardcoded inside manta-adm (unless we choose to expand the interface to allow batch updating metadata for instances of an arbitrary service).\n\nI\u0027ll add a test the checks trying to call this function from a fresh manta without a garbage-collector to make sure it prints the message I add."},{"file":"lib/adm.js","line":3075,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"After revisiting this I\u0027m realizing that there are two errors here:\n\n1. Checking for a valid service name (one that is included in services.mSvcConfig)\n\n2. Checking that a valid service is included in SAPI.\n\n(1) should never happen for the \"garbage-collector\" service because as of this commit, \"garbage-collector\" is included (statically) in mSvcConfig.\n\n(2) may happen if we deployed accelerated gc in a Manta that doesn\u0027t have a garbage-collector service. We _should_ treat this as an error."},{"file":"lib/adm.js","line":3075,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Nice, thanks for working with me on this one!"},{"file":"lib/adm.js","line":3080,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Super nit: I think this needs to be a 4 space continuation."},{"file":"lib/adm.js","line":3080,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":3562,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is there a reason not to use maAdm.readConfigFromFile here?  I think it\u0027s perhaps because you want to avoid its call to readConfigRaw, but I\u0027m not sure exactly why. Is it because we don\u0027t want to deploy _#instances_, but want to update _metadata_ of these instances instead (and hence populate ma_instance_metadata_updates)?"},{"file":"lib/adm.js","line":3562,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yup, that\u0027s it. The format of the file being read here is different and the contents also mean something different. Are you wanting a re-factor? Should I add a comment explaining the differences between readInstanceMetadataConfigFromFile and readConfigFromFIle?"},{"file":"lib/adm.js","line":3562,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like a comment was added for this. Thanks!"},{"file":"lib/adm.js","line":3562,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":532,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":955,"sizeDeletions":-18},{"number":"22","revision":"1abc5de30bbde20e94ec7ce5e31c808f0790fcd7","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/22","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542243136,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542243182,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":538,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":961,"sizeDeletions":-18},{"number":"23","revision":"db0e38d7c59f84b460c09368ebfc2a71a56a8d41","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/23","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542249584,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542249629,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":538,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":104,"deletions":0}],"sizeInsertions":1065,"sizeDeletions":-18},{"number":"24","revision":"96c9a7c0fc3e944a082d9022a5f4ec5e3efb9056","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/24","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542262969,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542263018,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542294363,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"deps/sdc-scripts","line":1,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This looks to have changed in the delta between PS20 and PS24. Do you know what this is for?"},{"file":"deps/sdc-scripts","line":1,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah I accidentally pulled in a different version of the sdc-scripts submodule when I was testing another change in this repo. I\u0027ve undone that change though. The submodule points to the same commit as the master branch does now."},{"file":"man/man1/manta-adm.1","line":0,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Are there corresponding docs/man/man1/manta-adm.md changes to go along with this? Typically when updating man pages, the markdown version is edited and checked in, and the rendered man page (this file) is also checked in."},{"file":"man/man1/manta-adm.1","line":0,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I didn\u0027t realize that these were rendered from markdown. Will fix!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/adm.js","type":"MODIFIED","insertions":538,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":109,"deletions":0}],"sizeInsertions":1070,"sizeDeletions":-18},{"number":"25","revision":"9cf415e7d9a2299e81d6e86e94d43ca5f3e29a15","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/25","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542397675,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542397722,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":100,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":552,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":107,"deletions":-1}],"sizeInsertions":1182,"sizeDeletions":-19},{"number":"26","revision":"80b7cce3ceda70066d694fdd4a46a9f478286ac1","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/26","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542399712,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542399759,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":100,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":560,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":107,"deletions":-1}],"sizeInsertions":1190,"sizeDeletions":-19},{"number":"27","revision":"d8b3d2d02338b51bf16f3693fcde115b006ba908","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/27","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542400483,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542400530,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542402164,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":382,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":100,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":561,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":107,"deletions":-1}],"sizeInsertions":1191,"sizeDeletions":-19},{"number":"28","revision":"702c49c2b08f23db2d513d3fd6f110864685f0e2","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/28","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542403295,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542403345,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542620910,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542620910,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542655529,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":385,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":100,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":587,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":107,"deletions":-1}],"sizeInsertions":1220,"sizeDeletions":-19},{"number":"29","revision":"59333d16b817c259acaf9ce481ca3e01cfe65b73","parents":["053e465d241931f1bf76c064586619e0cf43df7c"],"ref":"refs/changes/62/4862/29","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1543882262,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542403345,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542620910,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542620910,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542655529,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":385,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":100,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":587,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":107,"deletions":-1}],"sizeInsertions":1220,"sizeDeletions":-19},{"number":"30","revision":"02a6c4b05c993794a645d4825bdd4523a45127cd","parents":["f370b9d86a69071adf4469b9e098f4660dd273be"],"ref":"refs/changes/62/4862/30","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1544756469,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544756522,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":705,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":728,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":1754,"sizeDeletions":-19},{"number":"31","revision":"b16be049afe165eb071e21ca2b930b1683cbf5ad","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/31","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1544756478,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544756646,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":705,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":728,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":1754,"sizeDeletions":-19},{"number":"32","revision":"a5165a16eaec59b013e962d53c7c3ae053cadd87","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/32","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1544761676,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544761727,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":705,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":728,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":1754,"sizeDeletions":-19},{"number":"33","revision":"f13faaa6fc8bc7c0c921fa32103c0dc173da1cfe","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/33","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1544775465,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544775516,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"cmd/manta-adm.js","line":516,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"extra \u0027o\u0027 here"},{"file":"cmd/manta-adm.js","line":516,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":536,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I guess it would be cool if this could verify the changes with the operator before they\u0027re made, like the way \u0027manta-adm update\u0027 does. But if that\u0027s a lot of extra work maybe it\u0027s not worth it."},{"file":"cmd/manta-adm.js","line":536,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah I can look into doing that. It might not be too much work to print out a list of instances/services that will be updated at least."},{"file":"cmd/manta-adm.js","line":537,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Does this need to be run only in one datacenter in a region?\n\nIs the intention that we\u0027d need to run this sort of operation many times in the future, or is it only meant to be run once in each region? I have a feeling that this code will itself be deprecated soon after it\u0027s introduced (once all garbage-collectors are transitioned from the original set of metadata fields to the new).\n\nMy preference would have been to include this code as a separate migration tool. If we have to do this sort of migration again in the future it will make this file more complicated and more laden with technical debt.\n\nThoughts on this? Sorry that I missed the opportunity to provide early feedback."},{"file":"cmd/manta-adm.js","line":537,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yes unfortunately the whole point of this code is to make a one-time migration easier. I think moving this to a separate tool is the right call, but I would like to use the adm library in sdc-manta. What do you think of adding it as a separate file under sdc-manta/cmd?"},{"file":"cmd/manta-adm.js","line":537,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sorry for the delay getting back to this. Your change for this looks good to me."},{"file":"cmd/manta-adm.js","line":555,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"If you wanted to I think you could directly use \u0027adm.fetchDeployed\u0027 in place of the \u0027function (next) { }\u0027 block.\n\nIf that doesn\u0027t work you could use \u0027next\u0027 as the callback for adm.fetchDeployed, like:\n  adm.fetchDeployed(next)\n\nBut what\u0027s already here is fine too."},{"file":"cmd/manta-adm.js","line":555,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"The reason I\u0027ve written things out explicitly like this is that some function pass extra arguments to their callbacks. That will change the arguments in the next function of a vasync.waterfall. I don\u0027t think this is true in the case of adm.fetchDeployed, but since I did this in some of the other functions I wanted to remain consistent."},{"file":"cmd/manta-adm.js","line":559,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do we need this? It looks like this is the only waterfall step with this assert."},{"file":"cmd/manta-adm.js","line":559,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":563,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Is this error populated if there are no garbage collectors deployed?"},{"file":"cmd/manta-adm.js","line":563,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"No, in that case the result is an empty object."},{"file":"cmd/manta-adm.js","line":565,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is this a pattern you\u0027ve seen used elsewhere?\n\nI think the bunyan logging library does some special stuff to error messages so we can just pass the err variable and not check for its existence, but I\u0027m not sure what that might look like with other properties being passed at the same time (perhaps it\u0027s only on the CLI I\u0027ve seen this happen?)."},{"file":"cmd/manta-adm.js","line":565,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"You\u0027re right, will change these to just include the error object."},{"file":"cmd/manta-adm.js","line":599,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should we assert that this is a uuid before we start using it? And I\u0027m guessing that these uuids correspond to each of the deployed garbage collectors?"},{"file":"cmd/manta-adm.js","line":599,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think that would be fine, though I\u0027m not sure it\u0027s necessary. These garbge-collector instance uuid values pulled directly from the results of adm.fetchDeployed.\n\nI\u0027m going to add the check to `validateGcInstanceConfigs` if that\u0027s alright with you."},{"file":"cmd/manta-adm.js","line":668,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"extra space"},{"file":"cmd/manta-adm.js","line":668,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":703,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"What\u0027s the reason that we log the error but don\u0027t return it through the callback (same question for the next two cases (do_disable and do_accounts)?"},{"file":"cmd/manta-adm.js","line":703,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"`fatal` exits the process, so you could never reach the callback with an error in these cases. Though I suppose it couldn\u0027t hurt to add the argument there just in case someone removes the `fatal` call in the future."},{"file":"cmd/manta-adm.js","line":2576,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"You\u0027re using the name \u0027instance\u0027 here and \u0027uuid\u0027 in other parts of the file. Not a big deal at all, but it might make it easier to follow if they\u0027re all using the same variable name."},{"file":"cmd/manta-adm.js","line":2576,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":2579,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"can this fit on the previous line?"},{"file":"cmd/manta-adm.js","line":2579,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":2591,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think you could also do \"missingNew.join(\u0027, \u0027) \" if you wanted, but this works."},{"file":"cmd/manta-adm.js","line":2591,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-adm.js","line":2682,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do you want this to be \u0027updateErr\u0027 or \u0027err\u0027 ?"},{"file":"cmd/manta-adm.js","line":2682,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"docs/man/man1/manta-adm.md","line":182,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"What about \u0027--cleanup\u0027 instead?"},{"file":"docs/man/man1/manta-adm.md","line":182,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":3157,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is this correct? If \"add\" is a function, would that mean callback is undefined at this point, assuming the idea here is to allow partial arguments?\n\nCould you help me understand what the purpose is of hitting the callback at this point?"},{"file":"lib/adm.js","line":3157,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Sorry, this is just wrong. It should assign add to callback and fill in the add and remove names with empty objects."},{"file":"lib/adm.js","line":3173,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Looks like we\u0027re missing the opts.svcname here."},{"file":"lib/adm.js","line":3173,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/adm.js","line":3318,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think you could replace this entire block with just the callback function pointer. e.g.\n\n  vasync.forEachPipeline( { ... }, callback);\n\nIIUC we weren\u0027t able to do that previously because we were wrapping the error using VError."},{"file":"lib/adm.js","line":3318,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yep, I think when I was writing this I had just fixed a bug where I did this exact thing and it bit me because there was an extra argument being supplied to some callback that changed the argument lists for subsequent functions in a vasync.waterfall. So I was being really careful. But in this case I think it\u0027s fine."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":700,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":728,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":1749,"sizeDeletions":-19},{"number":"34","revision":"2e6f0bea47e134562a8f6b967661842de22dc9ad","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/34","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1545102742,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545102794,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":793,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":724,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":1838,"sizeDeletions":-19},{"number":"35","revision":"09e3b2a94d044558c923358c395bbc50d21c05a8","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/35","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1545257258,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545257310,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manta-gc-configadm","type":"ADDED","insertions":1,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":793,"deletions":0},{"file":"cmd/manta-gc-configadm.js","type":"ADDED","insertions":573,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":779,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":2467,"sizeDeletions":-19},{"number":"36","revision":"4d6453f40c74dc8b1d488104e1e8b329d5775613","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/36","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1545257560,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545257609,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546874984,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"comments":[{"file":"cmd/manta-adm.js","line":54,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Is this used in this file?"},{"file":"cmd/manta-adm.js","line":54,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-gc-configadm.js","line":14,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I don\u0027t think I understand what this sentence is saying. Is this invoked by `manta-adm accel-gc [something]`?"},{"file":"cmd/manta-gc-configadm.js","line":14,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Thanks, I meant that this tool make potentially breaking changes to state that `manta-adm accel-gc relies on`."},{"file":"cmd/manta-gc-configadm.js","line":14,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"cmd/manta-gc-configadm.js","line":21,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think this is unused, along with cp, sdc, and sprintf."},{"file":"cmd/manta-gc-configadm.js","line":21,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Thanks. Do you happen to have a tool that checks for unused imports? `make check` doesn\u0027t seem to highlight this stuff."},{"file":"cmd/manta-gc-configadm.js","line":21,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think eslint will do this. I\u0027m not sure if our plugin will do this by default, but I think the definition that would do this is here: https://github.com/joyent/node-eslint-plugin-joyent/blob/c6cfc5bca903af551f823e308e098bd04604d07e/lib/config/lint.js#L18\n\nClearly this doesn\u0027t help in this particular case, but I think as projects adopt eslint then this might be caught in the future. There might also be changes to the current set of makefiles around jslint to check this also and this project is perhaps due an update, but I\u0027ve not checked that."},{"file":"cmd/manta-gc-configadm.js","line":21,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Cool. I didn\u0027t know eslint would do import checking. I was just doing it manually."},{"file":"cmd/manta-gc-configadm.js","line":21,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think this particular scenario comes in the way of checking for unused variables, as opposed to explicitly checking if it\u0027s an import that is never used. Probably enough to catch these cases, though."},{"file":"cmd/manta-gc-configadm.js","line":21,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"docs/man/man1/manta-adm.md","line":182,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Is this still a subcommand of the \u0027manta-adm\u0027 tool?"},{"file":"docs/man/man1/manta-adm.md","line":182,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manta-gc-configadm","type":"ADDED","insertions":1,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":391,"deletions":0},{"file":"cmd/manta-gc-configadm.js","type":"ADDED","insertions":573,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":133,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":779,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":147,"deletions":-1}],"sizeInsertions":2065,"sizeDeletions":-19},{"number":"37","revision":"73046c3d0bbf8974cfe46070cc42d211486ada1f","parents":["b5872a14bcc7643edbbe1da149f99293f5522aaf"],"ref":"refs/changes/62/4862/37","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1546996438,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546996489,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547050819,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547154696,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547062652,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1547166470,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"bin/manta-gc-configadm","type":"ADDED","insertions":1,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":390,"deletions":-1},{"file":"cmd/manta-gc-configadm.js","type":"ADDED","insertions":570,"deletions":0},{"file":"config/services/garbage-collector/service.json","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.coal","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.lab","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"config/services/garbage-collector/service.json.production","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":102,"deletions":-2},{"file":"lib/adm.js","type":"MODIFIED","insertions":780,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":109,"deletions":-3}],"sizeInsertions":1994,"sizeDeletions":-26}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}