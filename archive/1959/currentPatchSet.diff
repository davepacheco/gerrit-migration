From cdf05998c8f1e65e6f3070ed7efdb3abd62935b5 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Wed, 17 May 2017 01:33:55 +1200
Subject: [PATCH] PUBAPI-1394: Role tags are not persistent Reviewed by: Pedro
 P. Candel <pedro@joyent.com>

---
 lib/resources.js         | 12 +++++++-----
 test/machines.72.test.js | 18 ++++++++++++++++++
 2 files changed, 25 insertions(+), 5 deletions(-)

diff --git a/lib/resources.js b/lib/resources.js
index e891118..aa654e2 100644
--- a/lib/resources.js
+++ b/lib/resources.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -303,7 +303,9 @@ function saveResource(req, cb) {
     entry.uuid = req.resource.uuid ? req.resource.uuid :
         libuuid.create();
 
-    if (req.params.machine && req.route.name !== 'createimagefrommachine') {
+    // req.machine can by set by loadMachine() in machine.js, if we are dealing
+    // with a machine resource
+    if (req.machine) {
         pipelineFuncs.push(function _translateMachineRoles(_, _cb) {
             entry.memberrole = entry.roles.map(function (r) {
                 return ((r.uuid) ? r.uuid : null);
@@ -332,11 +334,11 @@ function saveResource(req, cb) {
         req.log.debug({entry: entry}, 'saveResource');
         // Machines will store the role-tag themselves, everything else uses
         // sdcAccountResource, including collections:
-        if (req.params.machine && req.route.name !== 'createimagefrommachine') {
+        if (req.machine) {
             var func = (!entry.memberrole.length) ? 'deleteAllRoleTags' :
                         'setRoleTags';
             var params = {
-                uuid: req.params.machine,
+                uuid: req.machine.id,
                 owner_uuid: req.account.uuid,
                 origin: req.params.origin || 'cloudapi',
                 creator_uuid: req.account.uuid,
@@ -544,7 +546,7 @@ function mount(server, before, config) {
         path: '/:account/:resource_name/:resource_id',
         name: 'ReplaceResourceRoleTags'
     }, before, checkUserExists, putResource);
-    // We need "req.params.machine" for machines:
+    // We need "req.machine" (set by loadMachine in machine.js) for machines:
     server.put({
         path: '/:account/machines/:machine',
         name: 'ReplaceMachineRoleTags'
diff --git a/test/machines.72.test.js b/test/machines.72.test.js
index 83a92dc..ef37bb9 100644
--- a/test/machines.72.test.js
+++ b/test/machines.72.test.js
@@ -388,6 +388,7 @@ test('sub-user tests', function (t) {
     });
 });
 
+
 test('Add submachine role-tag', function (t) {
     CLIENT.put({
         path: '/' + ACCOUNT_NAME + '/machines/' + SUB_MACHINE_UUID,
@@ -407,6 +408,23 @@ test('Add submachine role-tag', function (t) {
 });
 
 
+test('Verify submachine role-tag', function (t) {
+    CLIENT.get({
+        path: '/' + ACCOUNT_NAME + '/machines/' + SUB_MACHINE_UUID,
+        headers: {
+            'accept-version': '~7.2',
+            'role-tag': true
+        }
+    }, function (err, req, res, body) {
+        t.ifError(err);
+        t.equal(res.statusCode, 200);
+        t.ok(res.headers['role-tag'], 'resource role-tag header');
+        t.equal(res.headers['role-tag'], ROLE_NAME, 'resource role-tag');
+        t.end();
+    });
+});
+
+
 test('Add submachine role-tag - other', function (t) {
     OTHER.put({
         path: '/' + ACCOUNT_NAME + '/machines/' + SUB_MACHINE_UUID,
-- 
2.21.0

