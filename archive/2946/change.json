{"project":"joyent/sdcadm","branch":"master","id":"I47704904431d8fb7d1316cffdc6280a082de7893","number":"2946","subject":"TOOLS-1806 sdcadm can erroneously behave as if moray is in HA mode","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/2946","commitMessage":"TOOLS-1806 sdcadm can erroneously behave as if moray is in HA mode\n","createdOn":1510764371,"lastUpdated":1513974458,"open":false,"status":"MERGED","comments":[{"timestamp":1510764371,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1510764376,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 83f432c5dcda9fad29c84d5b475a525ef0a3caab\n    \n    TOOLS-1806 sdcadm can erroneously behave as if moray is in HA mode"},{"timestamp":1510767336,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1511482318,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1511542859,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1511542891,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512119667,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1512119672,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit aa1e327b7b2cf57719aec81979df2b3bdebed32f\n    \n    TOOLS-1806 sdcadm can erroneously behave as if moray is in HA mode"},{"timestamp":1512119707,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512119712,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n(9 comments)\n\nThanks for the review Julien. I think I\u0027ve replied to all the comments + added some of the modifications you suggested. Mind to take another look?"},{"timestamp":1512734674,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(6 comments)\n\nI don\u0027t suppose some tests? \n\nAlso, a comment on the execute() function would really help. I had trouble concentrating on all the moving pieces; I suspect a description of what follows would help."},{"timestamp":1513357424,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n\u003e (6 comments)\n \u003e \n \u003e I don\u0027t suppose some tests?\n \u003e \nRight now sdcadm tests are taking so long that it\u0027s just not operational to run them after every change. Specially, b/c it\u0027s hard if not impossible to reproduce failure scenarios properly.\n\nI\u0027ve been considering tests to use mocks/stubs, specially on the different API calls, so we can easily reproduce those scenarios and, at the same time we speed up tests, force ourselves to move sdcadm code to smaller reusable units - see steps directory - which we should be able to test standalone too.\n\nI may summon you for help on this if you\u0027re on the mood, though!\n \u003e Also, a comment on the execute() function would really help. I had\n \u003e trouble concentrating on all the moving pieces; I suspect a\n \u003e description of what follows would help."},{"timestamp":1513359785,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1513359790,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 41c8ffa532e303ffdeda626fced3d2d30a6f8b5a\n    \n    TOOLS-1806 sdcadm can erroneously behave as if moray is in HA mode"},{"timestamp":1513359817,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n(6 comments)\n\nAll the suggestions accepted Marsell, thanks for taking a look!"},{"timestamp":1513359819,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513641364,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1513699476,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1513699509,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513699512,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(1 comment)\n\nDone adding a check for missing sapi instances, just in case!"},{"timestamp":1513712967,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1513790974,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n\u003e Patch Set 5: Code-Review+1\n\nTest done for IA so far:\n\n- Update single setup moray\n- Update HA moray setup\n- Update moray. Stop when the temporary instance is created. Keep the instance and verify that it\u0027s reused during next update\n- Update moray. Stop when the temporary instance is created. Keep the instance, but destroy the VMAPI VM and verify that SAPI instance is removed before next update.\n\nI think these are all the possible scenarios so it should be good to IA+1, though."},{"timestamp":1513810378,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1513974458,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"5","revision":"47704904431d8fb7d1316cffdc6280a082de7893","parents":["c3b20dc42de36fc7b5b1a3a572e76b034d4d2932"],"ref":"refs/changes/46/2946/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1513699476,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513699509,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513712967,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513810378,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1513974458,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":304,"deletions":-105}],"sizeInsertions":344,"sizeDeletions":-127},"patchSets":[{"number":"1","revision":"3666811e41f90aa61f50802d25f14bcb1f903d1f","parents":["1ff0c70ac430f6f408fe710941470503e0146e50"],"ref":"refs/changes/46/2946/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1510764371,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510767336,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/shared.js","line":331,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What\u0027s the difference between inst.instance and inst.zonename?"},{"file":"lib/procedures/shared.js","line":331,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"In theory we could have a different UUID for an instance in SAPI than for the zone name in VMAPI. Reality is that we pretty much have the same value always for Triton, not sure about manta but, given there isn\u0027t a strict requirement of those values being the same always, better to make sure we point to what we want."},{"file":"lib/procedures/shared.js","line":331,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sounds good, thanks for the clarification! I hadn\u0027t realized instance meant _SAPI_ instance."},{"file":"lib/procedures/shared.js","line":521,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we turn that into:\n\nif (body \u0026\u0026 body.uuid) {\n...\n}\n\nto avoid throwing an exception if body is not an object (e.g null or undefined)?"},{"file":"lib/procedures/shared.js","line":521,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Will definitely not hurt!"},{"file":"lib/procedures/shared.js","line":537,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we also assert.func(next, \u0027next\u0027);?"},{"file":"lib/procedures/shared.js","line":537,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Definitely!"},{"file":"lib/procedures/update-moray-v2.js","line":22,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should this be /^moray\\d+tmp$/, that is:\n\n- no need for the []\n- using ^ and $ to not match aliases like \"my-moray42tmp-test-machine\"\n\n?"},{"file":"lib/procedures/update-moray-v2.js","line":22,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Definitely, good call"},{"file":"lib/procedures/update-moray-v2.js","line":53,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why do we want to ignore tmp instances here?"},{"file":"lib/procedures/update-moray-v2.js","line":53,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Because if a temporary instance exists we\u0027re not gonna update it. Instead, we\u0027re gonna take advantage of its existence in order to update the non-temporary instance or, if it\u0027s not on a state suitable to be used, we\u0027re gonna remove it and create a new temporary instance for our process. So it shouldn\u0027t appear in summary."},{"file":"lib/procedures/update-moray-v2.js","line":90,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: why not just:\n\narg.HA \u003d change.HA\n\nregardless of the value of change.HA?"},{"file":"lib/procedures/update-moray-v2.js","line":90,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"yeah, shouldn\u0027t hurt. Good call"},{"file":"lib/procedures/update-moray-v2.js","line":104,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is it robust to \"take advantage of those temporary instances to speed up the update process otherwise\"?\n\nWhat if these instances are in a state that does not obviously indicate failure but that is not suitable to perform the update (e.g, it\u0027s at a very old version)?"},{"file":"lib/procedures/update-moray-v2.js","line":104,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"There shouldn\u0027t be any problem on that case. Even the more ancient SAPI instances - older version supported by sdcadm - are able to reprovision a instance through the `UpgradeInstance` end-point. No problem at all here."},{"file":"lib/procedures/update-moray-v2.js","line":451,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is it possible to have more than one non-temporary instance and at least one temporary instance? In this case, it seems the current change would not set change.HA to \"true\", but it should?"},{"file":"lib/procedures/update-moray-v2.js","line":451,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No. The only scenario where a temporary instance is present is for non-HA setups where we only have a single instance. Anyway, I\u0027ve modified it to also consider the case where \"insts.length \u003e\u003d tmpInsts.length + 1\" so it will cover the case of \"2 vs. 1\" too"},{"file":"lib/procedures/update-moray-v2.js","line":457,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"How do we know we\u0027re in a HA setup here?"},{"file":"lib/procedures/update-moray-v2.js","line":457,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"We don\u0027t! That comment has no sense. Just need to have the change.insts value set to move along, despite of our scenario"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":36,"deletions":-18},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":280,"deletions":-103}],"sizeInsertions":318,"sizeDeletions":-125},{"number":"2","revision":"4e93463912dfb5141782b542b5ab7fc074d66d37","parents":["e98262be5b0cbdf0f16e521cab08427068e1b281"],"ref":"refs/changes/46/2946/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1511542859,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511542891,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":36,"deletions":-18},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":280,"deletions":-103}],"sizeInsertions":318,"sizeDeletions":-125},{"number":"3","revision":"b414181325b72d15e44046e03ef6f85d00e74409","parents":["c3b20dc42de36fc7b5b1a3a572e76b034d4d2932"],"ref":"refs/changes/46/2946/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1512119667,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512119707,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/shared.js","line":567,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I wonder if perhaps a assert.uuid() could be on this here."},{"file":"lib/procedures/shared.js","line":567,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Cannot see why not, added."},{"file":"lib/procedures/update-moray-v2.js","line":64,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I think this function needs a reasonably large comment describing what\u0027s going on. It\u0027s not easy to follow what\u0027s going on in this function."},{"file":"lib/procedures/update-moray-v2.js","line":64,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. I may forget myself!"},{"file":"lib/procedures/update-moray-v2.js","line":118,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Can be reduced to a single line if so inclined:\n\nctx.tmpInstToRemove \u003d ctx.tmpInstToRemove || [];"},{"file":"lib/procedures/update-moray-v2.js","line":118,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-moray-v2.js","line":167,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Sorry, I don\u0027t grok why this check is here. How does HA make a difference?"},{"file":"lib/procedures/update-moray-v2.js","line":167,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If we\u0027re on HA setup, we will not create any temporary instance. So this function is useless on that case and, therefore, me avoiding adding it to the chain to be executed."},{"file":"lib/procedures/update-moray-v2.js","line":188,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This seems like a useful function to name."},{"file":"lib/procedures/update-moray-v2.js","line":188,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call. Done."},{"file":"lib/procedures/update-moray-v2.js","line":278,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Vmp?"},{"file":"lib/procedures/update-moray-v2.js","line":278,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Vm. Fixed, thanks!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":37,"deletions":-18},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":278,"deletions":-105}],"sizeInsertions":317,"sizeDeletions":-127},{"number":"4","revision":"c1ce0aa57c4e53955967178f18a934d5a12d6818","parents":["c3b20dc42de36fc7b5b1a3a572e76b034d4d2932"],"ref":"refs/changes/46/2946/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1513359785,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513359819,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/update-moray-v2.js","line":442,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can \"insts\" be null or undefined here?"},{"file":"lib/procedures/update-moray-v2.js","line":442,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I don\u0027t think so, but given how much it costs to add a check here, I\u0027ll go for it!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":299,"deletions":-105}],"sizeInsertions":339,"sizeDeletions":-127},{"number":"5","revision":"47704904431d8fb7d1316cffdc6280a082de7893","parents":["c3b20dc42de36fc7b5b1a3a572e76b034d4d2932"],"ref":"refs/changes/46/2946/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1513699476,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513699509,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1513974458,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513712967,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513810378,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"lib/procedures/update-moray-v2.js","type":"MODIFIED","insertions":304,"deletions":-105}],"sizeInsertions":344,"sizeDeletions":-127}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}]}