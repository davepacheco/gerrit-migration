{"project":"joyent/waferlock","branch":"master","id":"Ia90b7cb1b94b6ab96d9cd1c657e36885319c9f75","number":"4420","subject":"MANTA-3785 waferlock allowing destroyed VMs MANTA-3786 waferlock doesn\u0027t deal with old VMs with no \"ips\" property on NICs Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Cody Peter Mello \u003c","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/4420","commitMessage":"MANTA-3785 waferlock allowing destroyed VMs\nMANTA-3786 waferlock doesn\u0027t deal with old VMs with no \"ips\" property on NICs\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1529705096,"lastUpdated":1529710746,"open":false,"status":"MERGED","comments":[{"timestamp":1529705096,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1529705115,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n find: `test\u0027: No such file or directory\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/waferlock.xml\n /tmp/repo/build/node/bin/node node_modules/.bin/eslint  lib/sapi.js lib/ipf.js lib/zk.js server.js\n \n /tmp/repo/lib/sapi.js\n   257:9  error  \u0027ips\u0027 is already declared in the upper scope  no-shadow\n \n âœ– 1 problem (1 error, 0 warnings)\n \n tools/mk/Makefile.targ:201: recipe for target \u0027check-eslint\u0027 failed\n gmake: *** [check-eslint] Error 1"},{"timestamp":1529705202,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1529705222,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529707269,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1529707554,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1529707578,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1529707598,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529708738,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1529709297,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1529710586,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1529710687,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1529710746,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"4","revision":"19de297a4344b21a72772f49bc4a3c9e26e3810f","parents":["d3ea9550b5059e571516b94cbf9f3cd40933b2f7"],"ref":"refs/changes/20/4420/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1529710687,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529707598,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529708738,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529710586,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529710586,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1529710746,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/sapi.js","type":"MODIFIED","insertions":13,"deletions":-2}],"sizeInsertions":13,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"e6c64568bbfdb04aa13f7b7910008624edda44ff","parents":["d3ea9550b5059e571516b94cbf9f3cd40933b2f7"],"ref":"refs/changes/20/4420/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1529705096,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529705115,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sapi.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-1},{"number":"2","revision":"95f14b58f92a672669b41f1e4ce6c02f82155eca","parents":["d3ea9550b5059e571516b94cbf9f3cd40933b2f7"],"ref":"refs/changes/20/4420/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1529705202,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529705222,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/sapi.js","line":252,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would a vm.state\u003d\"failed\" break things here?"},{"file":"lib/sapi.js","line":252,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It shouldn\u0027t crash, since failed VMs generally still have a \"nics\" array, right? I\u0027ll add it though, we shouldn\u0027t add IPs from a failed VM into the firewall."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sapi.js","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":7,"sizeDeletions":-2},{"number":"3","revision":"a90b7cb1b94b6ab96d9cd1c657e36885319c9f75","parents":["d3ea9550b5059e571516b94cbf9f3cd40933b2f7"],"ref":"refs/changes/20/4420/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1529707578,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529710586,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529710586,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529707598,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529708738,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/sapi.js","line":252,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could perhaps whitelist known states, e.g. to avoid state\u003dprovisioning. But I\u0027m not sure."},{"file":"lib/sapi.js","line":252,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We actually definitely want to look at VMs with state\u003dprovisioning, as long as they have NICs on them, because we want to add morays to the firewall while they\u0027re still provisioning.\n\nI think blacklisting destroyed/failed and then anything without NICs should cover what we need here. It\u0027s still a little bit best-effort because if we do see one that\u0027s provisioning and doesn\u0027t have NICs yet we won\u0027t retry it, but... we normally get prompted to check based on a denial, which only happens once the moray zone has NICs.\n\nAnd all of this is basically a workaround until we have time to go fix up moray properly to not do everything in setup.sh."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/sapi.js","type":"MODIFIED","insertions":13,"deletions":-2}],"sizeInsertions":13,"sizeDeletions":-2},{"number":"4","revision":"19de297a4344b21a72772f49bc4a3c9e26e3810f","parents":["d3ea9550b5059e571516b94cbf9f3cd40933b2f7"],"ref":"refs/changes/20/4420/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1529710687,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529710586,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529710586,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1529710746,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529707598,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529708738,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/sapi.js","type":"MODIFIED","insertions":13,"deletions":-2}],"sizeInsertions":13,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}