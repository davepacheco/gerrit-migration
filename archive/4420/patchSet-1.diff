commit e6c64568bbfdb04aa13f7b7910008624edda44ff (refs/changes/20/4420/1)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2018-06-22T15:04:29-07:00 (1 year, 4 months ago)
    
    MANTA-3785 waferlock allowing destroyed VMs
    MANTA-3786 waferlock doesn't deal with old VMs with no "ips" property on NICs

diff --git a/lib/sapi.js b/lib/sapi.js
index c9e4ef2..08b0baf 100644
--- a/lib/sapi.js
+++ b/lib/sapi.js
@@ -249,9 +249,14 @@ SapiPoller.prototype.state_runq_do = function (S) {
 		mod_assert.arrayOfObject(objs);
 
 		objs.forEach(function (vm) {
-			var ips = [];
+			if (vm.state === 'destroyed' || vm.destroyed)
+				return;
 
+			var ips = [];
 			vm.nics.forEach(function (nic) {
+				var ips = nic.ips;
+				if (ips === undefined)
+					ips = [nic.ip];
 				nic.ips.forEach(function (ip) {
 					var parts = ip.split('/');
 					ips.push(parts[0]);
