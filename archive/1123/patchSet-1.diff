From 1c4f98a7afdc778043f8440437c16e13a3c8cfbd Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 14 Dec 2016 14:37:38 -0800
Subject: [PATCH] joyent/node-cueball#59 want Agent stop() method

---
 README.md    |  9 +++++++++
 lib/agent.js | 25 +++++++++++++++++++++++++
 package.json |  2 +-
 3 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/README.md b/README.md
index 5ac364a..a58baa0 100644
--- a/README.md
+++ b/README.md
@@ -84,6 +84,15 @@ Parameters
   - `pingInterval` -- optional Number, interval between health check pings
   - `errorOnEmpty` -- optional Boolean
 
+### HttpAgent#stop([cb])
+
+Stops the pools managed by this agent, calling `cb` (optionally) once all have
+stopped.
+
+Parameters
+
+- `cb` -- optional Function (err)
+
 ## Pool
 
 ### `new mod_cueball.ConnectionPool(options)`
diff --git a/lib/agent.js b/lib/agent.js
index 65a8535..92deca9 100644
--- a/lib/agent.js
+++ b/lib/agent.js
@@ -21,6 +21,7 @@ const mod_assert = require('assert-plus');
 const mod_http = require('http');
 const mod_https = require('https');
 const mod_utils = require('./utils');
+const mod_vasync = require('vasync');
 
 const Pool = mod_pool.ConnectionPool;
 
@@ -159,6 +160,30 @@ CueBallAgent.prototype.addPool = function (host, options) {
 	this.pools[host] = new Pool(poolOpts);
 };
 
+CueBallAgent.prototype.stop = function (cb) {
+	var self = this;
+	mod_vasync.forEachParallel({
+		inputs: Object.keys(this.pools),
+		func: stopPool
+	}, function (err) {
+		if (cb)
+			cb(err);
+	});
+	function stopPool(host, pcb) {
+		var pool = self.pools[host];
+		if (pool.isInState('stopped')) {
+			pcb();
+		} else {
+			pool.on('stateChanged', function (st) {
+				if (st === 'stopped') {
+					pcb();
+				}
+			});
+			pool.stop();
+		}
+	}
+};
+
 /*
  * Sets up a duplex stream to be used for the given HTTP request.
  * Calls req.onSocket(sock) with said stream once it is ready.
diff --git a/package.json b/package.json
index 61a1eb0..9ed38a0 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "1.1.9",
+  "version": "1.2.0",
   "description": "",
   "main": "lib/index.js",
   "dependencies": {
-- 
2.21.0

