{"project":"joyent/node-cueball","branch":"master","id":"I47cc015928db47c3d1fcf1e5cfae0b6cee38fd03","number":"1123","subject":"joyent/node-cueball#59 want Agent stop() method Reviewed by: Dave Pacheco \u003cdap@joyent.com\u003e Reviewed by: Cody Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/1123","commitMessage":"joyent/node-cueball#59 want Agent stop() method\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nReviewed by: Cody Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1481755076,"lastUpdated":1481853272,"open":false,"status":"MERGED","comments":[{"timestamp":1481755076,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1481755165,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481766574,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1481828178,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1481828259,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481848840,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)"},{"timestamp":1481849696,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1481849766,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481850560,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nWhat is the expected behavior around calling it more than once?  It looks like you can call it multiple times and you get a callback for each one when whatever pools were present when you called close() have been stopped.  (There might still be un-stopped pools that are being stopped from a previous invocation.  Is that a problem?)\n\nWhat if you try to make a request with this agent after stopping and removing the pools?  Will it re-add them?  Is that supposed to be a supported sequence?\n\nI\u0027m fine with setting a \"closed\" flag that prevents all future activity and causes future closes to be a no-op or something, but I\u0027m not sure if that\u0027s what we\u0027re going for or not.  Either way, it would be nice to document it and make it so that if someone calls an unsupported sequence of functions, we blow up."},{"timestamp":1481850908,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1481850931,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4:\n\n\u003e What is the expected behavior around calling it more than once?  It\n \u003e looks like you can call it multiple times and you get a callback\n \u003e for each one when whatever pools were present when you called\n \u003e close() have been stopped.  (There might still be un-stopped pools\n \u003e that are being stopped from a previous invocation.  Is that a\n \u003e problem?)\n \u003e \n \u003e What if you try to make a request with this agent after stopping\n \u003e and removing the pools?  Will it re-add them?  Is that supposed to\n \u003e be a supported sequence?\n \u003e \n \u003e I\u0027m fine with setting a \"closed\" flag that prevents all future\n \u003e activity and causes future closes to be a no-op or something, but\n \u003e I\u0027m not sure if that\u0027s what we\u0027re going for or not.  Either way, it\n \u003e would be nice to document it and make it so that if someone calls\n \u003e an unsupported sequence of functions, we blow up.\n\nOk. I\u0027m adding a flag and throwing if you stop twice or try to use the Agent after stop() is called."},{"timestamp":1481850998,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481851485,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Code-Review+1\n\nWhat types of errors can happen while stopping the pool? If there\u0027s an error stopping, what am I supposed to do?"},{"timestamp":1481851556,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4:\n\n\u003e What types of errors can happen while stopping the pool? If there\u0027s\n \u003e an error stopping, what am I supposed to do?\n\nAt the moment there are none that can occur -- either it will stop and succeed or it\u0027ll hang trying. But I put it in there for future use."},{"timestamp":1481851593,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4:\n\n\u003e \u003e What types of errors can happen while stopping the pool? If\n \u003e there\u0027s\n \u003e \u003e an error stopping, what am I supposed to do?\n \u003e \n \u003e At the moment there are none that can occur -- either it will stop\n \u003e and succeed or it\u0027ll hang trying. But I put it in there for future\n \u003e use.\n\nSo.... the correct response is to panic I guess?"},{"timestamp":1481853260,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1481853272,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"4","revision":"47cc015928db47c3d1fcf1e5cfae0b6cee38fd03","parents":["84add0443a3ca76b027b9926c8c6da006b53169d"],"ref":"refs/changes/23/1123/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1481850908,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481850998,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481851485,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481853260,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1481853272,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":13,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":45,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":59,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"1c4f98a7afdc778043f8440437c16e13a3c8cfbd","parents":["84add0443a3ca76b027b9926c8c6da006b53169d"],"ref":"refs/changes/23/1123/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1481755076,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481755165,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/agent.js","line":164,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it worth logging when we do this -- maybe start and end?\n\nWhat happens if we call this more than once?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":35,"sizeDeletions":-1},{"number":"2","revision":"c9453a91a9e9f8a287deec8bf939f687fa0129e4","parents":["84add0443a3ca76b027b9926c8c6da006b53169d"],"ref":"refs/changes/23/1123/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1481828178,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481848840,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481828259,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":89,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I would change this to \"if provided\". While I know it isn\u0027t what\u0027s meant here, \"optionally\" makes it sound like it\u0027s optional whether or not the callback is called."},{"file":"lib/agent.js","line":172,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Perhaps call this with setImmediate() after the log.info(), so that if someone calls .stop() with a callback that calls process.exit(), the log line will still have a chance to make it out?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":29,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1},{"number":"3","revision":"39b011c41732aa3c5a564736c636f45f65a6e226","parents":["84add0443a3ca76b027b9926c8c6da006b53169d"],"ref":"refs/changes/23/1123/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1481849696,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481849766,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":42,"sizeDeletions":-1},{"number":"4","revision":"47cc015928db47c3d1fcf1e5cfae0b6cee38fd03","parents":["84add0443a3ca76b027b9926c8c6da006b53169d"],"ref":"refs/changes/23/1123/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1481850908,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481851485,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481853260,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1481853272,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481850998,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":13,"deletions":0},{"file":"lib/agent.js","type":"MODIFIED","insertions":45,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":59,"sizeDeletions":-1}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}