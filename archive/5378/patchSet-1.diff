From 5d2cca4c8c4d5b36376d6ef901284f9cc19aa813 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Wed, 5 Dec 2018 13:47:00 +0000
Subject: [PATCH] OS-7422 iPXE should be provided directly from joyent/ipxe

---
 Makefile              | 24 ++++++++++++------------
 targets.json.in       | 20 ++++++++++----------
 tools/purge-mg-builds |  2 +-
 3 files changed, 23 insertions(+), 23 deletions(-)

diff --git a/Makefile b/Makefile
index 7042bf7..34caff5 100644
--- a/Makefile
+++ b/Makefile
@@ -2640,25 +2640,25 @@ clean_manta-deployment:
 
 
 
-#---- sdcboot (boot utilities for sdc-headnode)
+#---- ipxe (ipxe fork for sdc-headnode)
 
-_sdcboot_stamp=$(SDCBOOT_BRANCH)-$(TIMESTAMP)-g$(SDCBOOT_SHA)
-SDCBOOT_BITS=$(BITS_DIR)/sdcboot/sdcboot-$(_sdcboot_stamp).tgz
+_ipxe_stamp=$(IPXE_BRANCH)-$(TIMESTAMP)-g$(IPXE_SHA)
+IPXE_BITS=$(BITS_DIR)/ipxe/ipxe-$(_ipxe_stamp).tgz
 
-.PHONY: sdcboot
-sdcboot: $(SDCBOOT_BITS)
+.PHONY: ipxe
+ipxe: $(IPXE_BITS)
 
-$(SDCBOOT_BITS): build/sdcboot
+$(IPXE_BITS): build/ipxe
 	mkdir -p $(BITS_DIR)
-	(cd build/sdcboot && TIMESTAMP=$(TIMESTAMP) BITS_DIR=$(BITS_DIR) \
+	(cd build/ipxe && TIMESTAMP=$(TIMESTAMP) BITS_DIR=$(BITS_DIR) \
 	    gmake pkg release publish)
-	@echo "# Created sdcboot bits (time `date -u +%Y%m%dT%H%M%SZ`):"
-	@ls -l $(SDCBOOT_BITS)
+	@echo "# Created ipxe bits (time `date -u +%Y%m%dT%H%M%SZ`):"
+	@ls -l $(IPXE_BITS)
 	@echo ""
 
-clean_sdcboot:
-	$(RM) -rf $(BITS_DIR)/sdcboot
-	(cd build/sdcboot && gmake clean)
+clean_ipxe:
+	$(RM) -rf $(BITS_DIR)/ipxe
+	(cd build/ipxe && gmake clean)
 
 #---- firmware-tools (Legacy-mode FDUM facilities and firmware for Joyent HW)
 
diff --git a/targets.json.in b/targets.json.in
index 5d69bd5..fba26f2 100644
--- a/targets.json.in
+++ b/targets.json.in
@@ -45,6 +45,7 @@ function build_headnode_target()
       ${firmware}
       "fwapi",
       "imgapi",
+      "ipxe",
       "sdc-manatee",
       "mahi",
       "manta-deployment",
@@ -56,7 +57,6 @@ function build_headnode_target()
       "sapi",
       "sdc",
       "sdcadm",
-      "sdcboot",
       "ufds",
       "vmapi",
       "workflow"
@@ -637,6 +637,15 @@ cat <<EOF
     ]
   },
 
+  "ipxe": {
+    "build_platform": "20151126T062538Z",
+    "repos": [
+        {"url": "$MG_GIT_PREFIX/ipxe.git"}
+    ],
+    "public": true,
+    "deps": []
+  },
+
   "sdc": {
     "appliance": "true",
     "build_platform": "20151126T062538Z",
@@ -1511,15 +1520,6 @@ cat <<EOF
     ]
   },
 
-  "sdcboot": {
-    "build_platform": "20151126T062538Z",
-    "repos": [
-        {"url": "$MG_GIT_PREFIX/sdcboot.git"}
-    ],
-    "public": true,
-    "deps": []
-  },
-
   ${FIRMWARE_TOOLS_ENTRY}
   ${HEADNODE_TARGETS}
 
diff --git a/tools/purge-mg-builds b/tools/purge-mg-builds
index 02d5ccf..827b4fc 100755
--- a/tools/purge-mg-builds
+++ b/tools/purge-mg-builds
@@ -113,6 +113,7 @@ TTL_DAYS_FROM_NAME='{
     "hagfish-watcher": 365,
     "heartbeater": 365,
     "imgapi": 365,
+    "ipxe": 365,
     "mackerel": 365,
     "madtom": 365,
     "mahi": 365,
@@ -147,7 +148,6 @@ TTL_DAYS_FROM_NAME='{
     "sdc-system-tests": 365,
     "sdc-zookeeper": 365,
     "sdcadm": 365,
-    "sdcboot": 365,
     "smartlogin": 365,
     "smartos": 365,
     "ufds": 365,
-- 
2.21.0

