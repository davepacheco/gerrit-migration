{"project":"joyent/sdc-vm-agent","branch":"master","id":"Ie5338dedd3f2c603a1b6ad56d767c1c9b1166a49","number":"4559","subject":"TRITON-628 vm-agent should have vmadm.events retry logic Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Reviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/4559","commitMessage":"TRITON-628 vm-agent should have vmadm.events retry logic\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nReviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1532386879,"lastUpdated":1533062698,"open":false,"status":"MERGED","comments":[{"timestamp":1532386879,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1532386882,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 9388a2862720c3a00d0373ef93d30477f0ffa0ed\n    \n    initial commit"},{"timestamp":1532386953,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532973518,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1532975985,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1532982681,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1532982684,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 75479fdb365ecc8fa7da4a250266d7adc238a7f8\n    \n    changes based on cody review"},{"timestamp":1532982769,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533008000,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1533055102,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1533057690,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1533059445,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1533062631,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1533062680,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1533062698,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"4","revision":"e5338dedd3f2c603a1b6ad56d767c1c9b1166a49","parents":["e552bff1de0948f1356cf3b2e659715f1cd7a426"],"ref":"refs/changes/59/4559/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1533062680,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532982769,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533008000,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533057690,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533062631,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1533062698,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/watchers/vmadm-events-watcher.js","type":"MODIFIED","insertions":95,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":96,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"b9e79e969712e67b9ed3c9f8d6ea90c605aa4ee8","parents":["e552bff1de0948f1356cf3b2e659715f1cd7a426"],"ref":"refs/changes/59/4559/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1532386879,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532386953,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/watchers/vmadm-events-watcher.js","line":133,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Out of curiosity: what warning needs to be disabled here? This line looks fine to me."},{"file":"lib/watchers/vmadm-events-watcher.js","line":133,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"/home/dave/joyent/sdc-vm-agent/lib/watchers/vmadm-events-watcher.js\n  134:50  error  \u0027\u003d\u0027 should be placed at the beginning of the line  operator-linebreak\n âœ– 1 problem (1 error, 0 warnings)\n\n\n\nI can do this however and it works\n\n\n\n VmadmEventsWatcher.prototype._sendMissedUpdates\n \u003d function _sendMissedUpdates(oldVms, newVms) {\n\n\nBut that just seems awkward."},{"file":"lib/watchers/vmadm-events-watcher.js","line":141,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think that using jsprim.hasKey(oldVms|newVms, i) in these three functions would be more efficient than indexOf() when dealing with many VMs."},{"file":"lib/watchers/vmadm-events-watcher.js","line":141,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/watchers/vmadm-events-watcher.js","line":172,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If this is just a simple JSON-like object, then you can use jsprim.deepEqual() instead of this try/catch."},{"file":"lib/watchers/vmadm-events-watcher.js","line":172,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watchers/vmadm-events-watcher.js","type":"MODIFIED","insertions":102,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":103,"sizeDeletions":-3},{"number":"2","revision":"f99121c6e4fa04663419b545b0916ef2dd025bcc","parents":["e552bff1de0948f1356cf3b2e659715f1cd7a426"],"ref":"refs/changes/59/4559/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1532982681,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533057690,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532982769,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533008000,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/watchers/vmadm-events-watcher.js","line":29,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Is it possible for handler() to be called before the ready() function? Or is there some guarantee given by the node-vmadm module that this will never be the case in the future? If it could happen someday, it might be better to have self.vms \u003d {} here instead so things don\u0027t blow up when accessing self.vms[ev.zonename] in the handler?"},{"file":"lib/watchers/vmadm-events-watcher.js","line":29,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This can never happen currently - the `ready` event from vminfod comes the moment the connection is established (with the full set of VMs) before any subsequent update is seen.  `vmadm events` is basically a thin wrapper around that so this *should* never be the case nor be the case in the future.\n\n\nBecause of this, I would prefer that things blow up if the handler was called somehow before the ready event was seen."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watchers/vmadm-events-watcher.js","type":"MODIFIED","insertions":95,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":96,"sizeDeletions":-3},{"number":"3","revision":"262007afd7a648ce202b0f296d5abcf3767c35bd","parents":["e552bff1de0948f1356cf3b2e659715f1cd7a426"],"ref":"refs/changes/59/4559/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1533059445,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533057690,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532982769,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533008000,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533062631,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/watchers/vmadm-events-watcher.js","type":"MODIFIED","insertions":95,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":96,"sizeDeletions":-3},{"number":"4","revision":"e5338dedd3f2c603a1b6ad56d767c1c9b1166a49","parents":["e552bff1de0948f1356cf3b2e659715f1cd7a426"],"ref":"refs/changes/59/4559/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1533062680,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533057690,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532982769,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533008000,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533062631,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1533062698,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/watchers/vmadm-events-watcher.js","type":"MODIFIED","insertions":95,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":96,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}