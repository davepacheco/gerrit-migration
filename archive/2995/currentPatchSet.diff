From 0844eeb5e62d9e09463b1ac28d5b946e1767555b Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Thu, 23 Nov 2017 17:25:36 -0800
Subject: [PATCH] =?UTF-8?q?VOLAPI-94=20sdcadm=20experimental=20nfs-volumes?=
 =?UTF-8?q?=20commands=20error=20on=20some=20core=20services=20using=20rel?=
 =?UTF-8?q?ease=20images=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel?=
 =?UTF-8?q?=20<pedro@joyent.com>=20Reviewed=20by:=20Trent=20Mick=20<trentm?=
 =?UTF-8?q?@gmail.com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20?=
 =?UTF-8?q?<pedro@joyent.com>=20Approved=20by:=20Trent=20Mick=20<trentm@gm?=
 =?UTF-8?q?ail.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/cli/do_nfs_volumes.js | 31 +++++++++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/lib/cli/do_nfs_volumes.js b/lib/cli/do_nfs_volumes.js
index fcbd9cd..75afd09 100644
--- a/lib/cli/do_nfs_volumes.js
+++ b/lib/cli/do_nfs_volumes.js
@@ -230,6 +230,11 @@ function do_nfs_volumes(subcmd, opts, args, cb) {
                     branch: /^master$/,
                     timestamp: '20171110T184239Z',
                     commit: 'a60a380'
+                },
+                {
+                    branch: /^release-\d{8}$/,
+                    timestamp: '20171123T073154Z',
+                    commit: '04b9561'
                 }
             ],
             volapi: [
@@ -264,6 +269,11 @@ function do_nfs_volumes(subcmd, opts, args, cb) {
                     branch: /^master$/,
                     timestamp: '20171110T202313Z',
                     commit: '9d39e1b'
+                },
+                {
+                    branch: /^release-\d{8}$/,
+                    timestamp: '20171123T073050Z',
+                    commit: '8c37b7e'
                 }
             ];
         } else {
@@ -272,6 +282,11 @@ function do_nfs_volumes(subcmd, opts, args, cb) {
                     branch: /^master$/,
                     timestamp: '20171110T191649Z',
                     commit: '788a08f'
+                },
+                {
+                    branch: /^release-\d{8}$/,
+                    timestamp: '20171123T072329Z',
+                    commit: 'aa9022d'
                 }
             ];
         }
@@ -425,6 +440,22 @@ function do_nfs_volumes(subcmd, opts, args, cb) {
 
                     assert.string(vmUuid, 'vmUuid');
 
+                    if (!/^release-\d{8}$/.test(versionBranch) &&
+                        versionBranch !== 'master') {
+                        /*
+                         * This image was built from a feature branch and was
+                         * most likely installed from the experimental channel,
+                         * so there's no way to really know whether it supports
+                         * NFS volumes or not. We'll consider that the operator
+                         * knows what they're doing, and just output a warning.
+                         */
+                        self.progress('Image for service %s at version %s is ' +
+                            'not from a release or master branch, it may not ' +
+                            'support NFS volumes', serviceName,
+                            versionInfo.version);
+                            return;
+                    }
+
                     if (!versionSeemsGreaterOrEqualThan({
                         branch: versionBranch,
                         timestamp: versionTimestamp,
-- 
2.21.0

