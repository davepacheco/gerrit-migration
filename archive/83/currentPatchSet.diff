commit edf5403934afa2734122df9dc61451974b66231c (refs/changes/83/83/2)
Author: Joshua M. Clulow <jmc@joyent.com>
Date:   2016-07-14T17:21:26-07:00 (3 years, 3 months ago)
    
    TOOLS-1486 gerrit signs out users who use multiple tabs

diff --git a/images/appserver/Dockerfile b/images/appserver/Dockerfile
index 0d00b1c..57005f7 100644
--- a/images/appserver/Dockerfile
+++ b/images/appserver/Dockerfile
@@ -11,6 +11,16 @@ FROM java:jre-alpine
 #
 ENV GERRIT_VERSION            2.12.2
 ENV GERRIT_RELEASEURL         https://gerrit-releases.storage.googleapis.com
+#ENV GERRIT_WAR_URL            ${GERRIT_RELEASEURL}/gerrit-${GERRIT_VERSION}.war
+
+#
+# Work around "https://gerrit-review.googlesource.com/#/c/74830/2" by using
+# a custom build of 2.12.2 with the upstream fix for this issue included
+# as well.  Once a release that includes this fix is available, we should
+# switch back to using official Gerrit release artefacts.
+#
+ENV GERRIT_OVERRIDEURL        https://us-east.manta.joyent.com/Joyent_Dev/public/gerrit/custom
+ENV GERRIT_WAR_URL            ${GERRIT_OVERRIDEURL}/gerrit-2.12.2-joyent1.war
 
 ENV PLUGIN_VERSION            stable-2.12
 ENV GERRITFORGE_URL           https://gerrit-ci.gerritforge.com
@@ -57,8 +67,7 @@ RUN  set -o xtrace && \
      mkdir ${GERRIT_HOME}/shipped && \
      mkdir ${GERRIT_HOME}/shipped/plugins && \
      mkdir ${GERRIT_HOME}/shipped/lib && \
-     wget -O $GERRIT_WAR \
-         ${GERRIT_RELEASEURL}/gerrit-${GERRIT_VERSION}.war && \
+     wget -O $GERRIT_WAR "$GERRIT_WAR_URL" && \
      wget -O ${GERRIT_HOME}/shipped/plugins/delete-project.jar \
          ${GERRITFORGE_URL}/job/plugin-delete-project-${PLUGIN_VERSION}/${GERRITFORGE_ARTIFACT_DIR}/delete-project/delete-project.jar && \
      wget -O ${GERRIT_HOME}/shipped/plugins/events-log.jar \
diff --git a/images/appserver/README.md b/images/appserver/README.md
index e840ce1..616bdbd 100644
--- a/images/appserver/README.md
+++ b/images/appserver/README.md
@@ -17,6 +17,11 @@ Important notes about this image:
   the backup, and then deploys this image attached to that container.
 * Due to [DOCKER-774](https://smartos.org/bugview/DOCKER-774), this image cannot
   currently be built on Triton.
+* To work around [TOOLS-1486](https://devhub.joyent.com/jira/browse/TOOLS-1486),
+  this image currently uses a custom Joyent-specific build of Gerrit, rather
+  than a stock release build.  More detail appears below in the
+  [Gerrit Releases and Custom Builds](#gerrit-releases-and-custom-builds)
+  section.
 
 
 ## Gerrit configuration
@@ -67,3 +72,28 @@ As mentioned above, configuration that is not deployment-specific is
 deliberately not supported through environment variables.  You have to modify
 the config in this repository, build a new image, and redeploy that in order to
 change that.
+
+## Gerrit Releases and Custom Builds
+
+Gerrit releases are generally made available through [the Gerrit web site]
+(https://www.gerritcodereview.com/).  The `Dockerfile` uses an internal
+environment variable, `GERRIT_WAR_URL`, to prescribe the location from which the
+`gerrit.war` artefact will be obtained.  Ordinarily, this will point at a stock
+binary release from the Gerrit project itself.  At times, the URL may be
+overridden to a Joyent-specific build that includes fixes that have not yet
+been made available in a full public release.
+
+There is a Joyent fork of Gerrit available in the Github repository
+[joyent/gerrit](https://github.com/joyent/gerrit).  At the time of writing,
+this repository included a `joyent-2.12.2` branch with the fix for
+[an authentication issue primarily seen when using multiple tabs]
+(https://gerrit-review.googlesource.com/#/c/74830/2).  A `v2.12.2-joyent1`
+tag was created, from which the [Gerrit Release WAR file]
+(https://gerrit-documentation.storage.googleapis.com/Documentation/2.12.3/dev-buck.html#release)
+build instructions were followed to produce a WAR file then stored in Manta.
+
+By altering the `GERRIT_WAR_URL` in the `Dockerfile`, either this custom build,
+or any other Gerrit WAR file, can be included in place of the stock release.
+Note that when changing from one version to another, it is important to ensure
+that any included plugins (obtained via `GERRITFORGE_URL` or similar) match the
+custom WAR file in use.
