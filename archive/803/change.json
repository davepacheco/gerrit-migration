{"project":"joyent/illumos-joyent","branch":"master","id":"I7d53bdba409762b912a867a7edc5aa4be0c70c46","number":"803","subject":"OS-5746 mpt_sas sometimes times out sending SEP messages Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Bryan Cantrill \u003cbryan@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/803","commitMessage":"OS-5746 mpt_sas sometimes times out sending SEP messages\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Bryan Cantrill \u003cbryan@joyent.com\u003e\n","createdOn":1477611959,"lastUpdated":1478045756,"open":false,"status":"MERGED","comments":[{"timestamp":1477611959,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1477612099,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1477692648,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(10 comments)\n\nTo make sure I understand correctly: the \"enc\" handle we\u0027re stashing on the per-controller structure is storing the handle of the last enclosure we enumerated so that if we enumerate again, we only see higher (presumably therefore new to us) enclosures in the next walk?  And we reset it to the \"invalid\" handle in order to restart the walk from scratch when we need to do so?"},{"timestamp":1478015589,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1478015628,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4."},{"timestamp":1478015641,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(10 comments)\n\nRegarding the question of the use of \"enc\", that\u0027s basically right. However, we don\u0027t end up using the resume functionality, so I just always reset it now and removed the handle from the mpt_sas."},{"timestamp":1478021037,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\nTo test this, I\u0027ve gone through and booted a couple systems with different versions of mpt_sas (2008/2308 and 3008) to verify that booting and seeing disks still worked. I checked that diskinfo could still see the disks and that we could send still send SES messages on platform where appropriate.\n\nI also checked and verified that the boot hang messages that we used to see are gone."},{"timestamp":1478024649,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1478024653,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1478045048,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1478045511,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 6."},{"timestamp":1478045602,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1478045633,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1478045729,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1478045756,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"7","revision":"7d53bdba409762b912a867a7edc5aa4be0c70c46","parents":["71eae4df251e827c8d207b8ccb808a703740b189"],"ref":"refs/changes/03/803/7","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1478045729,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478045602,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478045633,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"SUBM","value":"1","grantedOn":1478045756,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":134,"deletions":-9},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":19,"deletions":-9}],"sizeInsertions":246,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"bf478d5eb9e472abef4f7e62b65e475b3e5b0526","parents":["ded89250657ad19632743ae1db8aa88c1287fd90"],"ref":"refs/changes/03/803/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1477611959,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":136,"deletions":-7},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":246,"sizeDeletions":-16},{"number":"2","revision":"d9a12f7ed2b7c50633f9aef3f881e042c695a780","parents":["ded89250657ad19632743ae1db8aa88c1287fd90"],"ref":"refs/changes/03/803/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1477612099,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":7727,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Using \"sizeof (*mep)\" seems more likely to be resistant to subsequent change-induced bugs."},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":7727,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14494,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"enclosure"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14494,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14511,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, \"sizeof (*m)\" seems better here."},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14511,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14547,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I understand that you\u0027re being consistent with the style above, but that style is plainly silly.  This should just be a \"while\" loop.  If we need the consistency, you should just change the other loops to be \"while\" loops as well."},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14547,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14554,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Please put braces around the \"if\" arm for a continued expression."},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":14554,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":16564,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We\u0027re doing this in something like three places, now.  I think we should just have a lookup function, e.g.:\n\n    static mptsas_enclosure_t *\n    mptsas_lookup_enclosure(mptsas_t *mpt, uint16_t handle)"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":16564,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":16567,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Is this really (after masking) still \"flags\", or is it more of a type ID at this point?"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":16567,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":16571,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Please put braces around the \"if\" arm for a continued expression."},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","line":16571,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","line":2827,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"enclosure"},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","line":2827,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","line":1385,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I know it\u0027s pretty inconsistent in here already, but I think the return type should go on the same line for a forward declaration like this."},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","line":1385,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I fixed up the few others around this as well."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":131,"deletions":-7},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":241,"sizeDeletions":-16},{"number":"3","revision":"a6470bafd9a48882f03a96b0f43ade210a2b5e4c","parents":["b3e6ba03f521c6890dbb9d6d9bb997834819bf6f"],"ref":"refs/changes/03/803/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1478015589,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":134,"deletions":-9},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":19,"deletions":-9}],"sizeInsertions":246,"sizeDeletions":-26},{"number":"4","revision":"ea89ba69e4f24725874b9d9c636de211acbb1ca5","parents":["b3e6ba03f521c6890dbb9d6d9bb997834819bf6f"],"ref":"refs/changes/03/803/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1478015628,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":134,"deletions":-9},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":19,"deletions":-9}],"sizeInsertions":246,"sizeDeletions":-26},{"number":"5","revision":"b29212a9bf8ee8269a03998df326fd86219c4599","parents":["b3e6ba03f521c6890dbb9d6d9bb997834819bf6f"],"ref":"refs/changes/03/803/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1478024649,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478024653,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478045048,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":134,"deletions":-9},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":19,"deletions":-9}],"sizeInsertions":246,"sizeDeletions":-26},{"number":"6","revision":"d76a42c2711c7f04427bf4f9522e8c9a0f5e311c","parents":["71eae4df251e827c8d207b8ccb808a703740b189"],"ref":"refs/changes/03/803/6","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1478045511,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478045602,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478045633,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":134,"deletions":-9},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":19,"deletions":-9}],"sizeInsertions":246,"sizeDeletions":-26},{"number":"7","revision":"7d53bdba409762b912a867a7edc5aa4be0c70c46","parents":["71eae4df251e827c8d207b8ccb808a703740b189"],"ref":"refs/changes/03/803/7","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1478045729,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1478045756,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478045602,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478045633,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas.c","type":"MODIFIED","insertions":134,"deletions":-9},{"file":"usr/src/uts/common/io/scsi/adapters/mpt_sas/mptsas_impl.c","type":"MODIFIED","insertions":93,"deletions":-8},{"file":"usr/src/uts/common/sys/scsi/adapters/mpt_sas/mptsas_var.h","type":"MODIFIED","insertions":19,"deletions":-9}],"sizeInsertions":246,"sizeDeletions":-26}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}