From 42da0fb109da7221ebbd091583f33adef4704766 Mon Sep 17 00:00:00 2001
From: Angela Fong <angela.fong@joyent.com>
Date: Fri, 8 Jun 2018 21:14:39 -0700
Subject: [PATCH] ADMINUI-2405: Support package brand and default to package
 brand when provisioning VM

---
 less/package.less            |  2 +-
 lib/packages.js              |  4 ++++
 www/js/tpl/package.hbs       |  6 ++++++
 www/js/tpl/packages-form.hbs | 15 ++++++++++++++
 www/js/views/provision-vm.js | 40 +++++++++++++++++++++++++++++++++---
 5 files changed, 63 insertions(+), 4 deletions(-)

diff --git a/less/package.less b/less/package.less
index a140a223..0c4d9a9b 100644
--- a/less/package.less
+++ b/less/package.less
@@ -83,7 +83,7 @@
   form .package-owners .controls { margin-bottom: 1em; }
   form .package-owners .add-owner-entry { clear: both; margin-left: 180px;}
 
-  .owner, .description, .billing-id, .memory, .quota, .vcpus, .swap, .max-processes, .cpu-cap, .io-priority {
+  .owner, .description, .billing-id, .memory, .quota, .vcpus, .swap, .max-processes, .cpu-cap, .io-priority, .brand {
     .widget-content;
 
     strong {
diff --git a/lib/packages.js b/lib/packages.js
index 6b2fcc39..22165612 100644
--- a/lib/packages.js
+++ b/lib/packages.js
@@ -26,6 +26,10 @@ module.exports.add = function (req, res, next) {
         delete params.vcpus;
     }
 
+    if (!params.brand || params.brand.length === 0) {
+        delete params.brand;
+    }
+
     req.log.info(params, 'papi.add');
 
     pkgclient.add(params, {headers: {'x-request-id': req.getId()}}, function (err, pkg) {
diff --git a/www/js/tpl/package.hbs b/www/js/tpl/package.hbs
index dcccef1b..0f9ff4a8 100644
--- a/www/js/tpl/package.hbs
+++ b/www/js/tpl/package.hbs
@@ -96,6 +96,12 @@
     <div class="value">{{zfs_io_priority}}</div>
   </div>
 
+  <h3>Optional Settings</h3>
+  <div class="brand">
+    <strong>Brand</strong>
+    <div class="value">{{brand}}</div>
+  </div>
+
   <section class="networks">
     <h3>Networks</h3>
     <div class="networks-list"></div>
diff --git a/www/js/tpl/packages-form.hbs b/www/js/tpl/packages-form.hbs
index 256e1d35..1cfb905e 100644
--- a/www/js/tpl/packages-form.hbs
+++ b/www/js/tpl/packages-form.hbs
@@ -223,6 +223,21 @@
             </div>
         </div>
 
+        <legend>Optional Settings</legend>
+        <div class="form-group">
+            <label class="control-label col-sm-4" for="package-brand">Brand</label>
+            <div class="col-md-7">
+                <select class="form-control" name="brand">
+                    <option></option>
+                    <option value="joyent">joyent</option>
+                    <option value="joyent-minimal">joyent-minimal</option>
+                    <option value="kvm">kvm</option>
+                    <option value="bhyve">bhyve</option>
+                    <option value="lx">lx</option>
+                </select>
+            </div>
+        </div>
+
       {{/unless}}
 
       <div class="form-group">
diff --git a/www/js/views/provision-vm.js b/www/js/views/provision-vm.js
index 7c425d65..cbb35882 100644
--- a/www/js/views/provision-vm.js
+++ b/www/js/views/provision-vm.js
@@ -7,7 +7,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 'use strict';
@@ -123,6 +123,8 @@ var View = Backbone.Marionette.Layout.extend({
 
         this.packageSelect.on('select', function (pkg) {
             this.selectedPackage.set(pkg.attributes);
+            this.resetImage();
+            this.ui.brandControls.hide();
         }, this);
 
         this.packages.fetchActive();
@@ -323,6 +325,19 @@ var View = Backbone.Marionette.Layout.extend({
             return;
         }
 
+/*
+ *      Both image and package have an optional brand attribute.
+ *      If brand is set in the image, it'll always take precedence.
+ *      If it isn't, use the package brand after checking that it's
+ *      consistent with the image type. If neither the image nor the
+ *      package has a brand defined, default to the more common brand.
+ */
+        var formData = this.ui.form.serializeObject();
+        var pkg = this.packages.get(formData['package']);
+        if (pkg) {
+            var pkgBrand = pkg.get('brand');
+        }
+
         if (image &&
             image.requirements &&
             image.requirements.brand &&
@@ -331,19 +346,28 @@ var View = Backbone.Marionette.Layout.extend({
             this.ui.brandControls.prop('disabled', 'disabled');
         } else {
             if (image.get('type') === 'zvol') {
-                this.setBrand('kvm');
+                if (pkgBrand && pkgBrand === 'bhyve') {
+                    this.setBrand(pkgBrand);
+                } else {
+                    this.setBrand('kvm');
+                }
                 this.disableBrands('joyent', 'joyent-minimal', 'lx', 'sngl');
             } else if (image.get('type') === 'lx-dataset') {
                 this.setBrand('lx');
                 this.disableBrands('joyent', 'joyent-minimal', 'kvm', 'bhyve', 'sngl');
             } else if (image.get('type') === 'zone-dataset') {
-                this.setBrand('joyent');
+                if (pkgBrand && pkgBrand === 'joyent-minimal') {
+                    this.setBrand(pkgBrand);
+                } else {
+                    this.setBrand('joyent');
+                }
                 this.disableBrands('kvm', 'bhyve', 'lx', 'sngl');
             } else {
                 this.disableBrands(false);
             }
         }
         this.ui.brandControls.show();
+        this.checkFields();
     },
 
     disableBrands: function () {
@@ -361,6 +385,10 @@ var View = Backbone.Marionette.Layout.extend({
         this.$('.form-group-brand').find('[name=brand]').val(brand);
     },
 
+    resetImage: function () {
+        this.$('#input-image').val('');
+    },
+
     checkFields: function () {
         this.hideError();
 
@@ -380,6 +408,11 @@ var View = Backbone.Marionette.Layout.extend({
             valid = false;
         }
 
+        if (values.pkgBrand && values.pkgBrand != values.brand) {
+            valid = false;
+            console.log("package brand mismatch: ", values.pkgBrand);
+        }
+
         // if (values.alias && values.alias.length != 0) {
         //     delete values.alias;
         // }
@@ -441,6 +474,7 @@ var View = Backbone.Marionette.Layout.extend({
 
         if (pkg) {
             values['billing_id'] = pkg.get('uuid');
+            values['pkgBrand'] = pkg.get('brand') || '';
 
             // quota value needs to be in GiB
             var quotaMib = pkg.get('quota');
-- 
2.21.0

