{"project":"joyent/illumos-joyent","branch":"master","id":"Ib27a6a9c81b403a39941586ff9613958226267f2","number":"2972","subject":"OS-6461 fac_prov_ipmi should support binding by entity id and instance OS-6464 ipmi topo plugin should automatically enumerate sensors on nodes it enumerates Reviewed by: Robert Mustacchi \u003crobert.mustacchi@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@jo","owner":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"url":"https://cr.joyent.us/2972","commitMessage":"OS-6461 fac_prov_ipmi should support binding by entity id and instance\nOS-6464 ipmi topo plugin should automatically enumerate sensors on nodes it enumerates\nReviewed by: Robert Mustacchi \u003crobert.mustacchi@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1511218202,"lastUpdated":1512004460,"open":false,"status":"MERGED","comments":[{"timestamp":1511218202,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 1."},{"timestamp":1511218547,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1511818441,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1511829432,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(2 comments)\n\nIn general, this looks good and seems like a great improvement to the system."},{"timestamp":1511833173,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 4."},{"timestamp":1511833647,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 5."},{"timestamp":1511893571,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1511896697,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 6."},{"timestamp":1511981122,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1511981687,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1511983307,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6:\n\n(2 comments)\n\nThis looks great!  I have a couple of review nits.  The testing looks right, and I\u0027m otherwise ready to approve!"},{"timestamp":1511990194,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 7."},{"timestamp":1511990316,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 7:\n\n(2 comments)"},{"timestamp":1511990878,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1512003586,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1512004122,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1512004266,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1512004460,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Rob Johnston"}],"currentPatchSet":{"number":"9","revision":"b27a6a9c81b403a39941586ff9613958226267f2","parents":["9cf847e445877b89dda2e814af5af495ec083417"],"ref":"refs/changes/72/2972/9","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1512004266,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511990878,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1512004460,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":103,"sizeDeletions":-22},"patchSets":[{"number":"1","revision":"d788fdcec4a93c39941b4109eb39d4e6efffa420","parents":["3de4744b1b965ad188cb7a92a2461427367e9a12"],"ref":"refs/changes/72/2972/1","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511218202,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":36,"deletions":-1}],"sizeInsertions":87,"sizeDeletions":-21},{"number":"2","revision":"3075c01d26fc1faa0cd7c29bcfdf75710311299f","parents":["2d0998ba9095083be74c87c6dd61bd2d364b00ac"],"ref":"refs/changes/72/2972/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511218547,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":36,"deletions":-1}],"sizeInsertions":87,"sizeDeletions":-21},{"number":"3","revision":"e55eac7137e068b8e5706821736ae6cfccca517e","parents":["2ba2c786fc7f279dff78bdfdb8d6f8c63b445314"],"ref":"refs/changes/72/2972/3","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511818441,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","line":469,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should there be a corresponding unload for the ed_fmod at some point? Won\u0027t topo_mod_load() end up bumping the reference count on that module every time we do an ipmi enumeration?"},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","line":469,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Good point.  What we really probably want to do is take a reference to fac_prov_ipmi in the ipmi module\u0027s init routine and then release it in the fini routine and cache a pointer to the module somewhere.  I\u0027ll rework this code."},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","line":470,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor c-style nit, but IIRC, the \u003d\u003d goes on the previous line or we have to make the continuation elsewhere."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":36,"deletions":-1}],"sizeInsertions":87,"sizeDeletions":-21},{"number":"4","revision":"9e94f91c24b50626036fe01b308b0ecac7cf9203","parents":["2ba2c786fc7f279dff78bdfdb8d6f8c63b445314"],"ref":"refs/changes/72/2972/4","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511833173,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":38,"deletions":0}],"sizeInsertions":89,"sizeDeletions":-20},{"number":"5","revision":"48ac6f08096e7491fead1b2430415b5d9b3ed1bc","parents":["2ba2c786fc7f279dff78bdfdb8d6f8c63b445314"],"ref":"refs/changes/72/2972/5","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511833647,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","line":521,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we need to unload this in _topo_fini?"},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","line":521,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"The catch here is that calling topo_module_unload() in the context of a module\u0027s fini entry point results in us recursively grabbing the topo modhash lock and so we\u0027ll deadlock.\n\nIdeally, libtopo needs a mechanism where we can express dependencies between topo modules, but that doesn\u0027t exist currently.  I\u0027l add a comment in _topo_fini() explaining the above.  And I\u0027ll file an CR to cover libtopo\u0027s inability to properly deal with module dependencies."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":40,"deletions":-2}],"sizeInsertions":91,"sizeDeletions":-22},{"number":"6","revision":"6ff06211e5c14db84135946bf391c1e96dd49646","parents":["d34c3f35352d3d27e8f1c35be3da4cb32b1486db"],"ref":"refs/changes/72/2972/6","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511896697,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511981122,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","line":185,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"All of the other properties (above) seem to use hyphens, rather than underscores, to separate words.  Is it worth being consistent with that here?\n\nAlso, it seems like other properties in this property group (e.g., see \"TOPO_PROP_IPMI_ENTITY_REF\") have the \"TOPO_PROP_IPMI_\" prefix; should we do that for these too?"},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","line":185,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Consistency is good - I\u0027ve made both changes and ran an incremental build as a sanity check."},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","line":1530,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"for consistency, capitalise \"ID\"?"},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","line":1530,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":51,"deletions":-2}],"sizeInsertions":102,"sizeDeletions":-22},{"number":"7","revision":"8ea02a5a4b17620d53ac993d7e52e680eca8e910","parents":["d34c3f35352d3d27e8f1c35be3da4cb32b1486db"],"ref":"refs/changes/72/2972/7","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1511990194,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511990878,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":103,"sizeDeletions":-22},{"number":"8","revision":"7b04eb346d52a65d978cb8eb71f6372ba3e0bc15","parents":["9cf847e445877b89dda2e814af5af495ec083417"],"ref":"refs/changes/72/2972/8","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1512004122,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511990878,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":103,"sizeDeletions":-22},{"number":"9","revision":"b27a6a9c81b403a39941586ff9613958226267f2","parents":["9cf847e445877b89dda2e814af5af495ec083417"],"ref":"refs/changes/72/2972/9","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1512004266,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1511990878,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512003586,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1512004460,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/fac_prov_ipmi/fac_prov_ipmi.c","type":"MODIFIED","insertions":44,"deletions":-20},{"file":"usr/src/lib/fm/topo/modules/common/ipmi/ipmi_enum.c","type":"MODIFIED","insertions":52,"deletions":-2}],"sizeInsertions":103,"sizeDeletions":-22}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}]}