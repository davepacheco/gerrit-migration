From e94184911c6f6bcfd448afc423123bfabe9cf567 Mon Sep 17 00:00:00 2001
From: David Pacheco <dap@joyent.com>
Date: Thu, 8 Jun 2017 14:52:02 -0700
Subject: [PATCH] MANATEE-333 manatee-adm could report sync replay lag

---
 docs/man/manatee-adm.md |  4 ++--
 lib/adm.js              | 11 +++++------
 man/man1/manatee-adm.1  |  4 ++--
 3 files changed, 9 insertions(+), 10 deletions(-)

diff --git a/docs/man/manatee-adm.md b/docs/man/manatee-adm.md
index 781d28f..442afce 100644
--- a/docs/man/manatee-adm.md
+++ b/docs/man/manatee-adm.md
@@ -138,8 +138,8 @@ plus:
   "replay\_location" field in Postgres's "pg\_stat\_replication" view.
 * `pg-lag`: If upstream replication is established, this corresponds to the
   difference between now and "pg\_last\_xact\_replay\_timestamp()".  This is
-  intended to be a measure of how far asynchronous replication is lagging, but
-  it's only useful for that purpose if data is actually being written upstream.
+  intended to be a measure of how far replication is lagging, but it's only
+  useful for that purpose if data is actually being written upstream.
 
 **Example output**
 
diff --git a/lib/adm.js b/lib/adm.js
index 303322e..dd822ef 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -379,7 +379,7 @@ function _addPostgresStatus(_, _cb) {
                 } else {
                     entry.online = true;
                     entry.repl = res.rows[0] ? res.rows[0] : {};
-                    if (peer !== 'primary' && peer !== 'sync') {
+                    if (peer !== 'primary') {
                         queryPg(pgUrl, PG_REPL_LAG,
                                 function (err2, res2) {
                                     if (err2) {
@@ -597,11 +597,10 @@ function _setActiveZkNode(opts, _cb) {
  *                      this peer is the upstream.  This object will contain
  *                      fields from postgres's "pg_stat_replication" view.
  *
- *          pgp_lag     if this peer is the target of async replication,
- *                      indicates how long since data was received from
- *                      upstream.  Note that if no writes are being committed
- *                      upstream, this may grow large, and that's not
- *                      necessarily a problem.
+ *          pgp_lag     if this peer is the target of replication, indicates how
+ *          		long since data was replayed from upstream.  Note that
+ *          		if no writes are being committed upstream, this may grow
+ *          		large, and that's not necessarily a problem.
  *
  *     pgs_generation   current cluster generation number
  *
diff --git a/man/man1/manatee-adm.1 b/man/man1/manatee-adm.1
index 5915e13..fc757dc 100644
--- a/man/man1/manatee-adm.1
+++ b/man/man1/manatee-adm.1
@@ -150,8 +150,8 @@ Postgres's "pg_stat_replication" view.
 .IP \(bu 2
 \fB\fCpg\-lag\fR: If upstream replication is established, this corresponds to the
 difference between now and "pg_last_xact_replay_timestamp()".  This is
-intended to be a measure of how far asynchronous replication is lagging, but
-it's only useful for that purpose if data is actually being written upstream.
+intended to be a measure of how far replication is lagging, but it's only
+useful for that purpose if data is actually being written upstream.
 .RE
 .PP
 \fBExample output\fP
-- 
2.21.0

