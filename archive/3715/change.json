{"project":"joyent/illumos-joyent","branch":"master","id":"I01bb12bc44baa05669007d1fa05dac640d82d1b1","number":"3715","subject":"OS-6799 hvm exclusion failures are silent Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3715","commitMessage":"OS-6799 hvm exclusion failures are silent\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1521840417,"lastUpdated":1522771999,"open":false,"status":"MERGED","comments":[{"timestamp":1521840417,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1521841773,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521842491,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521843076,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1522063125,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522767683,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1522767754,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\nNow:\n\n2018-04-03T14:55:04.205226+00:00 buglets unix: [ID 946633 kern.warning] WARNING: zone \u0027bea9fe7d-2a04-c98f-d469-d35e38d569f4\u0027 cannot take hvm_xcl_lock as SmartOS KVM: held by \u0027bhyve\u0027\n\n2018-04-03T14:55:51.040330+00:00 buglets unix: [ID 946633 kern.warning] WARNING: zone \u0027ffbba7da-2278-60a4-d514-9329b141f8ec\u0027 cannot take hvm_xcl_lock as bhyve: held by \u0027SmartOS KVM\u0027"},{"timestamp":1522767895,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1522767943,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522769174,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1522769694,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1522769753,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1522769777,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)\n\n[root@buglets ~]# grep HVM /var/adm/messages\n2018-04-03T15:26:51.871799+00:00 buglets unix: [ID 141716 kern.warning] WARNING: zone \u0027bea9fe7d-2a04-c98f-d469-d35e38d569f4\u0027 cannot take HVM exclusion lock as \u0027SmartOS KVM\u0027: held by \u0027bhyve\u0027\n2018-04-03T15:27:45.259974+00:00 buglets unix: [ID 141716 kern.warning] WARNING: zone \u0027ffbba7da-2278-60a4-d514-9329b141f8ec\u0027 cannot take HVM exclusion lock as \u0027bhyve\u0027: held by \u0027SmartOS KVM\u0027"},{"timestamp":1522770311,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1522770929,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\nMore extensive testing notes added to OS-6799"},{"timestamp":1522771177,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1522771769,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1522771970,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1522771999,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"5","revision":"8098ab85dc79c5d039404142c4182f341a23ac0c","parents":["d7c531a2a2da0161df2cf044f19dc53e35af2dc1"],"ref":"refs/changes/15/3715/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522771970,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769753,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522770311,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522771177,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1522771998,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"e4225f058549308ad3719634e3159dc0e977b789","parents":["d5eb108ff4a94b03a014e90e6213bf7bf4faa374"],"ref":"refs/changes/15/3715/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1521840417,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521843076,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/i86pc/os/pc_hvm.c","line":49,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason not to make the cmn_err call inside the lock here?  It\u0027s not like the lock or the hvm exclusion resource are highly contended."},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","line":49,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I can\u0027t say that I have a really good reason other than I don\u0027t know if/how cmn_err() could block.  I\u0027ll wait for others to share opinions before changing."},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","line":49,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"From working through cmn_err, it seems pretty non-blocking to me, but I didn\u0027t do an exhaustive check. I\u0027m fine with either approach."},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","line":54,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Agreed it can be under the lock.\n\nAlso, I\u0027m not sure about KVM, but at least for bhyve, printing the zonename and ID would be useful, until we have proper logging at least."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":12,"sizeDeletions":-1},{"number":"2","revision":"b815aa29a7e1ba73b7cdf718e0fdbd5341109d77","parents":["d5eb108ff4a94b03a014e90e6213bf7bf4faa374"],"ref":"refs/changes/15/3715/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522767683,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769174,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522767895,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/i86pc/os/pc_hvm.c","line":48,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"hvm_excl_lock\n\nMaybe just used english here?  \"HVM exclusion lock\"?"},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","line":48,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"3","revision":"01bb12bc44baa05669007d1fa05dac640d82d1b1","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/15/3715/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522769694,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769753,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522771177,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522770311,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"4","revision":"e45aec37279f38794d7513ec850445d68a7a7d85","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/15/3715/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522771769,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769753,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522771177,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522770311,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"5","revision":"8098ab85dc79c5d039404142c4182f341a23ac0c","parents":["d7c531a2a2da0161df2cf044f19dc53e35af2dc1"],"ref":"refs/changes/15/3715/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522771970,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769753,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522771177,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1522771998,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522770311,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}