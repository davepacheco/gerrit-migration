From 3a6ee598f3d7df34d8f198a712b2359862222ec0 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Fri, 29 Jun 2018 17:11:03 -0700
Subject: [PATCH] MANTA-3804 waferlock should retry after getting no NICs on a
 SAPI VM

---
 lib/sapi.js | 40 +++++++++++++++++++++++++++++++++++++++-
 1 file changed, 39 insertions(+), 1 deletion(-)

diff --git a/lib/sapi.js b/lib/sapi.js
index 967579e..14675a3 100644
--- a/lib/sapi.js
+++ b/lib/sapi.js
@@ -60,6 +60,7 @@ function SapiPoller(options) {
 	this.sp_errdelay = options.minPoll;
 
 	this.sp_insts = {};
+	this.sp_instRetries = {};
 	this.sp_lastError = undefined;
 
 	this.sp_agent = options.agent;
@@ -257,13 +258,38 @@ SapiPoller.prototype.state_runq_do = function (S) {
 
 		mod_assert.arrayOfObject(objs);
 
+		var retryEnt = { dc: ent.dc, vms: [] };
+
 		objs.forEach(function (vm) {
 			if (vm.state === 'destroyed' || vm.destroyed)
 				return;
 			if (vm.state === 'failed')
 				return;
-			if (!vm.nics || !Array.isArray(vm.nics))
+
+			/*
+			 * We can race against the provisioning of the new
+			 * VM here, and end up fetching it from VMAPI before
+			 * it has NICs and IPs assigned by NAPI.
+			 */
+			if (!vm.nics || !Array.isArray(vm.nics) ||
+			    vm.nics.length < 1) {
+				self.sp_log.warn({ uuid: vm.uuid }, 'got a ' +
+				    'vmapi VM with no valid NICs');
+				/*
+				 * If we lost the race, retry this VM up to
+				 * 5 times (if it's still got no NICs after
+				 * that, we'll just skip and ignore it, it's
+				 * probably broken).
+				 */
+				if (self.sp_instRetries[vm.uuid] === undefined)
+					self.sp_instRetries[vm.uuid] = 0;
+				var retries = self.sp_instRetries[vm.uuid];
+				if (retries < 5) {
+					++self.sp_instRetries[vm.uuid];
+					retryEnt.vms.push(vm.uuid);
+				}
 				return;
+			}
 
 			var ips = [];
 			vm.nics.forEach(function (nic) {
@@ -281,6 +307,18 @@ SapiPoller.prototype.state_runq_do = function (S) {
 			self.sp_pool.refreshTag('sapi:' + vm.uuid, ips);
 		});
 
+		if (retryEnt.vms.length > 0) {
+			self.sp_vmq.push(retryEnt);
+			/*
+			 * Treat this as an error so that we retry in our
+			 * min poll interval, not max.
+			 */
+			self.sp_lastError = new VError('VMAPI data was ' +
+			    'missing NIC information, retrying some VMs');
+			S.gotoState('error');
+			return;
+		}
+
 		S.gotoState('runq');
 	}));
 };
-- 
2.21.0

