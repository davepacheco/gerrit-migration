{"project":"joyent/smartos-live","branch":"master","id":"I5ceb19e2c56f5673d0d93269fadce77f731e3e83","number":"1637","subject":"OS-5999 When metadata gets ECONNREFUSED connecting to KVM ttyb, it should retry soon to workaround cloud-init bugs Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/1637","commitMessage":"OS-5999 When metadata gets ECONNREFUSED connecting to KVM ttyb, it should retry soon to workaround cloud-init bugs\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1489087249,"lastUpdated":1489103631,"open":false,"status":"MERGED","comments":[{"timestamp":1489087249,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1489087250,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 14a706872c29e75649a6c228a8d36d0161707178\n    \n    bring KVM metadata up asap, but not sooner."},{"timestamp":1489087291,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489091123,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1489092241,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1489098503,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1489098504,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 82d05090eef829136f6e58eb3ebd7ad3e59fa3b2\n    \n    move deletion of zoneConnections entry out of stopKvmReconnTimer() where it didn\u0027t belong"},{"timestamp":1489098533,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/vm/node_modules/vmload/vmload-xml.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneadm.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneinfo.js\n /tmp/repo/src/vm/node_modules/sysevent-stream.js\n /tmp/repo/src/img/lib/IMG.js\n /tmp/repo/src/img/lib/cli.js\n /tmp/repo/src/img/lib/common.js\n /tmp/repo/src/img/lib/configuration.js\n /tmp/repo/src/img/lib/database.js\n /tmp/repo/src/img/lib/errors.js\n /tmp/repo/src/img/lib/imgadm.js\n /tmp/repo/src/img/lib/magic.js\n /tmp/repo/src/img/lib/upgrade.js\n /tmp/repo/src/img/sbin/imgadm\n /tmp/repo/src/vm/common/nictag.js\n /tmp/repo/src/vm/tests/test-alias.js\n /tmp/repo/src/vm/node_modules/nodeunit-plus/index.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js\n /tmp/repo/src/vm/tests/test-create.js\n /tmp/repo/src/vm/tests/test-create-filesystems.js\n /tmp/repo/src/vm/tests/test-docker.js\n /tmp/repo/src/vm/tests/test-defaults.js\n /tmp/repo/src/vm/tests/test-indestructible.js\n /tmp/repo/src/vm/tests/test-internal_metadata_namespaces.js\n /tmp/repo/src/vm/tests/test-lastexited.js\n /tmp/repo/src/vm/tests/test-openonerrlogger.js\n /tmp/repo/src/vm/tests/test-reboot.js\n /tmp/repo/src/vm/tests/test-reprovision.js\n /tmp/repo/src/vm/tests/test-snapshots.js\n /tmp/repo/src/vm/tests/test-spoof-opts.js\n /tmp/repo/src/vm/tests/test-tmpfs.js\n /tmp/repo/src/vm/tests/test-update.js\n /tmp/repo/src/vm/tests/test-vrrp-nics.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/agent.js(759): warning: undeclared identifier: zonename\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/vm/lib/metadata/zwatch.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 1 warnings(s)\n Makefile:538: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:357: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1489100391,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1489100392,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 42dad010fd4091a0699c133e54a640c336b7ab40\n    \n    oops"},{"timestamp":1489100441,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489100938,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1489101503,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1489101504,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 90ccd82842a3b35c97189b265edbebbfdce3f3ad\n    \n    address yet another great comment"},{"timestamp":1489101546,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489101923,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1489101931,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1489103631,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"4","revision":"5ceb19e2c56f5673d0d93269fadce77f731e3e83","parents":["d4a8339ce19d3a30e14d1fe8e8459b42e890d4d3"],"ref":"refs/changes/37/1637/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1489101503,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489101546,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489101923,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489101931,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1489103631,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":138,"deletions":-34}],"sizeInsertions":138,"sizeDeletions":-34},"patchSets":[{"number":"1","revision":"7b1d87555813aa156af0c52f3497753cde379bdd","parents":["d4a8339ce19d3a30e14d1fe8e8459b42e890d4d3"],"ref":"refs/changes/37/1637/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1489087249,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489087291,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489091123,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":528,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Was this done before by another function? Deleting zone connections seems a bit outside of the scope of a function named \"stopKvmReconnTimer\"."},{"file":"src/vm/lib/metadata/agent.js","line":528,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"You raise a tremendous point.\n\nNothing did this before, but that\u0027s because nothing watched for containers to stop before. The rules of zoneConnections (see line 82) say that whenever we want the normal periodic checks to be able to start the metadata socket when we see it go runnning, we should ensure there\u0027s no zoneConnections entry for the zone.\n\nBut you\u0027re right about this not really feeling like it belongs in this function given its name. What I think I\u0027ll do is move the delete on self.zoneConnections out to the two places where we call stopKvmReconnTimer instead, and add a comment in both places as well.\n\nThanks for catching this!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":127,"deletions":-34}],"sizeInsertions":127,"sizeDeletions":-34},{"number":"2","revision":"8ac37768daa23efe3938fa8277239490c56add73","parents":["d4a8339ce19d3a30e14d1fe8e8459b42e890d4d3"],"ref":"refs/changes/37/1637/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1489098503,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1489098533,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":136,"deletions":-34}],"sizeInsertions":136,"sizeDeletions":-34},{"number":"3","revision":"432977d9085b5baa701468c9d570f6945734c05c","parents":["d4a8339ce19d3a30e14d1fe8e8459b42e890d4d3"],"ref":"refs/changes/37/1637/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1489100391,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489100441,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489100938,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":521,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: I would remove the \"KVM zone has stopped\" part, since we might want to call this function in other circumstances."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":136,"deletions":-34}],"sizeInsertions":136,"sizeDeletions":-34},{"number":"4","revision":"5ceb19e2c56f5673d0d93269fadce77f731e3e83","parents":["d4a8339ce19d3a30e14d1fe8e8459b42e890d4d3"],"ref":"refs/changes/37/1637/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1489101503,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489101546,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1489103631,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489101923,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489101931,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":138,"deletions":-34}],"sizeInsertions":138,"sizeDeletions":-34}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}