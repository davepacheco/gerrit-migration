{"project":"joyent/illumos-joyent","branch":"master","id":"I757454db6669c1186f60bc625510c1b67217aae6","number":"4629","subject":"OS-7082 i40e: blown assert in i40e_tx_cleanup_ring() OS-7086 i40e: add mdb dcmd to dump info on tx descriptor rings OS-7101 i40e: add kstat to track TX DMA bind failures Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.c","owner":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"url":"https://cr.joyent.us/4629","commitMessage":"OS-7082 i40e: blown assert in i40e_tx_cleanup_ring()\nOS-7086 i40e: add mdb dcmd to dump info on tx descriptor rings\nOS-7101 i40e: add kstat to track TX DMA bind failures\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1533272235,"lastUpdated":1533666369,"open":false,"status":"MERGED","comments":[{"timestamp":1533272235,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 1."},{"timestamp":1533279307,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1533324981,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)\n\nMinus my one comment, this looks good. The only other thing I would maybe consider is using CTF read for the queue pair structure. But honestly, I don\u0027t expect that to really change. So I\u0027m also fine with the straight read."},{"timestamp":1533571183,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 1:\n\n(2 comments)\n\nThanks for looking at it!"},{"timestamp":1533571719,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 2."},{"timestamp":1533574118,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1533574816,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1533575699,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1533577266,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1533594425,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 4."},{"timestamp":1533594597,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 4:\n\n(7 comments)"},{"timestamp":1533603389,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1533658322,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1533663315,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1533663674,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1533663897,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1533666369,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Rob Johnston"}],"currentPatchSet":{"number":"6","revision":"757454db6669c1186f60bc625510c1b67217aae6","parents":["6ce17ef1e269338b564b10ef91271385757dfc3f"],"ref":"refs/changes/29/4629/6","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533663897,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533603389,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533658322,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533663315,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1533666369,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":174,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":187,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"6c451b6500111fcbef670d945b1899b2b47fa5c0","parents":["14aa584f6d005b787b096ab219055f12a41469bd"],"ref":"refs/changes/29/4629/1","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533272235,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":192,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Shouldn\u0027t this be using a different size since it\u0027s an array of TCB pointers?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":192,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Doh!  Good catch - fixed."},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":557,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"nit: An any reason for using failS while some other failure counters seem to just have fail (no S) e.g. itxs_hck_meoifail ?"},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":557,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"No particular reason.  I\u0027m happy to change it, if you feel strongly about it."},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":557,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"I don\u0027t feel strongly about it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":158,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":169,"sizeDeletions":-6},{"number":"2","revision":"11cdf476401755a3eba8dc91a07a3ada0885ff5b","parents":["14aa584f6d005b787b096ab219055f12a41469bd"],"ref":"refs/changes/29/4629/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533571719,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533574118,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":170,"sizeDeletions":-6},{"number":"3","revision":"bb1e5597dc65edc60ab5f82dfb570ed8d3605833","parents":["d3addfc9b7be14af44b3fc6ffc3941e4ad892356"],"ref":"refs/changes/29/4629/3","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533575699,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533574118,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":43,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we\u0027re going to declare this statically here, shouldn\u0027t it be used in all places? Why isn\u0027t it used for the dcmd definition itself?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":43,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Fixed - I ended up just ditching the variable."},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":130,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we use mdb_ctf_vread to make this more agnostic to changes in the trqpair_t that are almost certainly going to be coming soon?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":130,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yes - done."},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":159,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Shouldn\u0027t we check this all before output is used?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":159,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":164,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason we\u0027re not using MDB_OPT_UINT64 as the option type here?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":164,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Being able to compare opt_b/opt_e to NULL made it easier to distinguish whether the argument had been set."},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":203,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"being and end are uint64_t values. i should not be an int."},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":203,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":240,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please use strlcat, not strcat. How did we figure out the size of the buffer?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":240,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"The max size that the string could every be is if it is:\n\n\"WBHEAD HEAD TAIL\"\n\nwhich is 16 chars + 1 nul\n\nstrlcat is going to ugly up this code - is it really necessary given that we\u0027re dealing with strings of known sizes?"},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":240,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I ultimately will defer to you; however, I find these kind of assumptions are generally things that come back to break us later on. While it is likely provably correct in this instance, if for some reason someone ever modifies it, it will not end up that way."},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":255,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This should only be the usage string. Instead, the main text should be in the dc_help argument."},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","line":255,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":159,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":170,"sizeDeletions":-6},{"number":"4","revision":"bcac28bf419a87e4efafd847f69d8ba8134ec9fb","parents":["d3addfc9b7be14af44b3fc6ffc3941e4ad892356"],"ref":"refs/changes/29/4629/4","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533594425,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533603389,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533663315,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533658322,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":174,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":187,"sizeDeletions":-7},{"number":"5","revision":"7e066eed1376c82a75e3e337fba99379cef76aa3","parents":["6ce17ef1e269338b564b10ef91271385757dfc3f"],"ref":"refs/changes/29/4629/5","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533663674,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533603389,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533663315,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533658322,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":174,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":187,"sizeDeletions":-7},{"number":"6","revision":"757454db6669c1186f60bc625510c1b67217aae6","parents":["6ce17ef1e269338b564b10ef91271385757dfc3f"],"ref":"refs/changes/29/4629/6","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1533663897,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533603389,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533663315,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533658322,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1533666369,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/cmd/mdb/intel/modules/i40e/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/modules/i40e/i40e.c","type":"MODIFIED","insertions":174,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":7,"deletions":-5}],"sizeInsertions":187,"sizeDeletions":-7}],"allReviewers":[{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}]}