From 4d101c831f7aee1c6404970aa7ee2de1dbd49edd Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Tue, 13 Mar 2018 21:09:12 +0000
Subject: [PATCH] x

---
 etc/svp-types.json   | 19 ++++++++++++++++++-
 lib/backend/moray.js |  1 +
 lib/framer.js        |  2 ++
 lib/parser.js        | 12 ++++++++++++
 lib/types.js         | 14 +++++++++++---
 5 files changed, 44 insertions(+), 4 deletions(-)

diff --git a/etc/svp-types.json b/etc/svp-types.json
index 7095730..b765749 100644
--- a/etc/svp-types.json
+++ b/etc/svp-types.json
@@ -95,6 +95,23 @@
 			{ "name": "svl3_vnetid", "type": "uint32_t" }
 		] },
 		{ "name": "svp_log_vl3_t", "typedef": "struct svp_log_vl3" },
-		{ "name": "svp_shootdown_t", "typedef": "struct svp_shootdown" }
+		{ "name": "svp_shootdown_t", "typedef": "struct svp_shootdown" },
+		{ "name": "struct svp_route_req", "struct": [
+			{ "name": "srr_vnetid", "type": "uint32_t" },
+			{ "name": "srr_vlan", "type": "uint16_t" },
+			{ "name": "srr_pad", "type": "uint16_t" },
+			{ "name": "srr_srcip", "type": "uint32_t [4]" },
+			{ "name": "srr_dstip", "type": "uint32_t [4]" }
+		] },
+		{ "name": "struct svp_route_ack", "struct": [
+			{ "name": "sra_vnetid", "type": "uint32_t" },
+			{ "name": "sra_vlan", "type": "uint16_t" },
+			{ "name": "sra_prefixlen", "type": "uint8_t" },
+			{ "name": "sra_pad", "type": "uint8_t" },
+			{ "name": "sra_dcid", "type": "uint32_t" },
+			{ "name": "sra_vl2_srcmac", "type": "uint8_t [6]" }
+		] },
+		{ "name": "svp_route_req_t", "typedef": "struct svp_route_req" },
+		{ "name": "svp_route_ack_t", "typedef": "struct svp_route_ack" }
 	]
 }
diff --git a/lib/backend/moray.js b/lib/backend/moray.js
index aed1a99..9910bad 100644
--- a/lib/backend/moray.js
+++ b/lib/backend/moray.js
@@ -243,6 +243,7 @@ MorayStore.prototype._op_svp_r_vl3_req =
                 svp_msg: {
                     vl3_status: types.svp_status.SVP_S_OK,
                     vl3_mac: mapping.mac,
+                    // rui: should this be ul3_addr?
                     vl3_port: cn.port,
                     vl3_addr: common.stringToIp(cn.ip)
                 },
diff --git a/lib/framer.js b/lib/framer.js
index db04a5c..d428dac 100644
--- a/lib/framer.js
+++ b/lib/framer.js
@@ -96,6 +96,8 @@ SVPFramer.prototype._transform =
         log.debug({ msg_svp_req_hdr: msg.svp_req.hdr, msgCount: msgCount++ },
             'message header');
 
+        // XXX: version check? msg.svp_req.hdr.svp_ver
+ 
         // There is a distinction between what the message indicates as its
         // size, and the expected size of the message derived from ctypes.
         // We check the former here & the latter in the parser.
diff --git a/lib/parser.js b/lib/parser.js
index 65f5f4d..9d36610 100644
--- a/lib/parser.js
+++ b/lib/parser.js
@@ -253,6 +253,18 @@ SVPparser.prototype._transform =
         };
         break;
 
+    case mod_types.svp_op.SVP_R_ROUTE_REQ:
+        rec.svp_msg = {
+            // TODO: rui 
+        };
+        break;
+
+    case mod_types.svp_op.SVP_R_ROUTE_ACK:
+        rec.svp_msg = {
+            // TODO: rui
+        };
+        break;
+
     default:
         log.warn({ hdr: msg.svp_req.hdr, body: payload.body },
             'unknown message svp_op');
diff --git a/lib/types.js b/lib/types.js
index 4733df1..f427fc0 100644
--- a/lib/types.js
+++ b/lib/types.js
@@ -31,7 +31,9 @@ var op_types = {
     9: 'svp_log_req_t',
     10: 'svp_log_ack_t',
     11: 'svp_lrm_req_t',
-    12: 'svp_lrm_ack_t'
+    12: 'svp_lrm_ack_t',
+    13: 'svp_route_req_t',
+    14: 'svp_route_ack_t'
 };
 
 var sizeof = {
@@ -48,7 +50,9 @@ var sizeof = {
     SVP_LOG_VL2: 32,
     SVP_LOG_VL3: 44,
     SVP_R_LOG_RM: 4,
-    SVP_R_LOG_RM_ACK: 4
+    SVP_R_LOG_RM_ACK: 4,
+    SVP_R_ROUTE_REQ: 40, 
+    SVP_R_ROUTE_ACK: 18
 };
 
 var sizeof_ops = {
@@ -61,7 +65,9 @@ var sizeof_ops = {
     9: sizeof.SVP_R_LOG_REQ,
     10: sizeof.SVP_R_LOG_ACK,
     11: sizeof.SVP_R_LOG_RM,
-    12: sizeof.SVP_R_LOG_RM_ACK
+    12: sizeof.SVP_R_LOG_RM_ACK,
+    13: sizeof.SVP_R_ROUTE_REQ,
+    14: sizeof.SVP_R_ROUTE_ACK
 };
 
 var svp_op = {
@@ -89,6 +95,8 @@ var svp_op_hex = {
     SVP_R_LOG_RM: '0x0B',
     SVP_R_LOG_RM_ACK: '0x0C',
     SVP_R_SHOOTDOWN: '0x0D'
+    SVP_R_ROUTE_REQ: '0x0E'
+    SVP_R_ROUTE_ACK: '0x0F'
 };
 
 var svp_status = {
-- 
2.21.0

