commit 4aa4a2f2a65b48f2b83d740e1be21a3db1d59f46 (refs/changes/93/3893/2)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2018-05-02T18:52:00+02:00 (1 year, 5 months ago)
    
    TRITON-351 "sdcadm self-update" dumps core

diff --git a/lib/cli/do_self_update.js b/lib/cli/do_self_update.js
index 0805324..29ba71e 100644
--- a/lib/cli/do_self_update.js
+++ b/lib/cli/do_self_update.js
@@ -28,11 +28,13 @@ function do_self_update(subcmd, opts, args, cb) {
         cb(new errors.UsageError(
         'Please provide an image UUID or use `sdcadm self-update --latest`\n' +
         'in order to update to the latest available image.'));
+        return;
     }
 
     if (image === 'help') {
         cb(new errors.UsageError(
         'Please use `sdcadm help self-update` instead'));
+        return;
     }
 
 
diff --git a/lib/default-fabric.js b/lib/default-fabric.js
index 97027e0..c834349 100644
--- a/lib/default-fabric.js
+++ b/lib/default-fabric.js
@@ -128,7 +128,8 @@ function do_default_fabric(subcmd, opts, args, cb) {
         this.do_help('help', {}, [ subcmd ], cb);
         return;
     } else if (args.length !== 1) {
-        return cb(new errors.UsageError('Must specify account'));
+        cb(new errors.UsageError('Must specify account'));
+        return;
     }
 
     vasync.pipeline({arg: {}, funcs: [
diff --git a/lib/platform.js b/lib/platform.js
index c72d317..284615c 100644
--- a/lib/platform.js
+++ b/lib/platform.js
@@ -1725,6 +1725,7 @@ function do_assign(subcmd, opts, args, cb) {
     if (platform === 'help') {
         cb(new errors.UsageError(
         'Please use `sdcadm platform help assign` instead'));
+        return;
     }
     var server = args.length ? args : null;
     var assignOpts;
@@ -2334,6 +2335,7 @@ function do_set_default(subcmd, opts, args, cb) {
     if (opts.platform === 'help') {
         cb(new errors.UsageError(
         'Please use `sdcadm platform help set-default` instead'));
+        return;
     }
 
 
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 72729ee..47cee2c 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -436,7 +436,7 @@ SdcAdm.prototype.fini = function fini() {
     if (self.sadm_ur !== null) {
         self.sadm_ur.close();
     }
-    if (self._cueballAgent !== undefined) {
+    if (self._cueballAgent !== undefined && !self._cueballAgent.cba_stopped) {
         self.cueballAgent.stop();
     }
 };
