{"project":"joyent/illumos-joyent","branch":"master","id":"I02ba530437bfbfdddf56de010d62a5ff453813ae","number":"2550","subject":"OS-6333 sadb_x_kmc_t\u0027s KM cookie should be 64-bits Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"url":"https://cr.joyent.us/2550","commitMessage":"OS-6333 sadb_x_kmc_t\u0027s KM cookie should be 64-bits\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1505247870,"lastUpdated":1506365015,"open":false,"status":"MERGED","comments":[{"timestamp":1505247870,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 1."},{"timestamp":1505247940,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\nThis is a work in progress.  Building -gate with it now.  Will need to test either under smartos-live or OmniOS."},{"timestamp":1505249630,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 2."},{"timestamp":1505267550,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 3."},{"timestamp":1505348226,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 4."},{"timestamp":1505352626,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 5."},{"timestamp":1505508408,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1505527859,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5:\n\n(1 comment)\n\neverywhere(~/ws/ij-cr)[0]% git diff\ndiff --git a/usr/src/test/os-tests/tests/pf_key/kmc-updater.c b/usr/src/test/os-tests/tests/pf_key/kmc-updater.c\nindex a36525b..9f0ad6d 100644\n--- a/usr/src/test/os-tests/tests/pf_key/kmc-updater.c\n+++ b/usr/src/test/os-tests/tests/pf_key/kmc-updater.c\n@@ -82,6 +82,7 @@ main(int argc, char *argv[])\n        }\n        do_64_test \u003d (argc \u003d\u003d 3);\n \n+       errno \u003d 0;      /* Clear for strtoul() call. */\n        spi \u003d strtoul(argv[1], NULL, 0);\n        if (spi \u003d\u003d 0) {\n                if (errno !\u003d 0) {\neverywhere(~/ws/ij-cr)[0]%"},{"timestamp":1505527948,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 6."},{"timestamp":1505875697,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1505913784,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1505913840,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1505936823,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 8:\n\nTested under my own SmartOS environment both before and after, with the DTrace script in the bug report finding the bug before, and being silent after."},{"timestamp":1505936853,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 8:\n\nOops, wrong CR."},{"timestamp":1505948192,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 8:\n\nThis bug was tested by both the included test tools, and by a running in.iked on OmniOS + this fix. This fix drops easily into upstream-illumos."},{"timestamp":1506045159,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8:\n\n(10 comments)"},{"timestamp":1506089862,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 8:\n\n(10 comments)\n\nWill fix things you pointed out.  Also am going to Just #define It for the -1 vs. 1 exit codes in kmc-updater.c."},{"timestamp":1506104428,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8:\n\n(4 comments)"},{"timestamp":1506104946,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 9."},{"timestamp":1506105251,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1506105544,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 8:\n\n(3 comments)\n\nCan comment better in sadb.c, and will update OS-6333."},{"timestamp":1506105759,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 10."},{"timestamp":1506105864,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1506113474,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 11: Commit message was updated."},{"timestamp":1506113675,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 11: Code-Review+1"},{"timestamp":1506364892,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 11: Integration-Approval+1"},{"timestamp":1506364939,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 12: Patch Set 11 was rebased."},{"timestamp":1506365001,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 13: Commit message was updated."},{"timestamp":1506365015,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dan McDonald"}],"currentPatchSet":{"number":"13","revision":"02ba530437bfbfdddf56de010d62a5ff453813ae","parents":["31db0e37e1dc1c1e15a721732d617c1e429e1a5e"],"ref":"refs/changes/50/2550/13","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1506365001,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506105864,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506113675,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506364892,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1506365015,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":34,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":226,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":34,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":384,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"8adb3ee3adb38b01baceb541654211f49ee42253","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/50/2550/1","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505247870,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-20},{"number":"2","revision":"60645012aa192304144223a44571813f0d76fb91","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/50/2550/2","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505249630,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":27,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":54,"sizeDeletions":-20},{"number":"3","revision":"e55a5545c28699a124841f128799b205ea30e96e","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/50/2550/3","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505267550,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":27,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":20,"deletions":-10},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":54,"sizeDeletions":-20},{"number":"4","revision":"6f9bb9d3ceaa8a1ba1c4d0d42053852500385708","parents":["16ee9a3d03358376b04be02470c63268cabf6bab"],"ref":"refs/changes/50/2550/4","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505348226,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":28,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":221,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":24,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":361,"sizeDeletions":-26},{"number":"5","revision":"e67a58739a51dca2c3a6a984852da85bd75ad8e5","parents":["16ee9a3d03358376b04be02470c63268cabf6bab"],"ref":"refs/changes/50/2550/5","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505352626,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":85,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Paranoia -- but should errno be explicitly set to 0 to guarantee any errors came from strtoul?"},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":85,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Great idea.  Updating..."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":28,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":221,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":24,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":363,"sizeDeletions":-26},{"number":"6","revision":"0de0a72a0f76748df27a895615beacde4f4c2532","parents":["c2aad2852fbec43c0f3b9f3739ecd317811ccd36"],"ref":"refs/changes/50/2550/6","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505527948,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505875697,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":28,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":222,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":24,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":364,"sizeDeletions":-26},{"number":"7","revision":"bba1686ece7ba72deed97b40bb196676c210c440","parents":["97f2cda0aba36f25db5cda594bb8946108b944c7"],"ref":"refs/changes/50/2550/7","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505913784,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505875697,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":28,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":222,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":24,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":364,"sizeDeletions":-26},{"number":"8","revision":"6e2f2c7a7e7b1cc2d871d47e79c9e7c4ec038adb","parents":["97f2cda0aba36f25db5cda594bb8946108b944c7"],"ref":"refs/changes/50/2550/8","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1505913840,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505875697,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","line":2599,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should SADB_X_KMP_KINK be handled here?"},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","line":2599,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Hmmm, assigning at least cookie_label is probably not a bad idea.  Will fix."},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","line":2619,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you clarify this XXX? Is the question whether or not this code should assume this is in host order and print it in network order?"},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","line":2619,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"What the cookie\u0027s semantics are depends on the KM protocol.  For IKEv2, I expect a stored-in-network-order IKE SPI, which then the printing function will ntohll() to print.  I\u0027ll try and be clearer per what I just said."},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","line":18,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think we prefer [[ over ["},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","line":18,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Will fix."},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":36,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"rc should be an ssize_t"},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":36,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Will fix."},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":48,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it possible to get a short read/write on PF_KEY?"},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":48,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Not unless readlen is insufficiently large for read.  PF_KEY is essentially a datagram socket."},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":48,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, makes sense."},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":202,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Elsewhere you use -1 when you exit. Should we standardize on doing an exit(1)?"},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":202,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I use \u00271\u0027 for Actual Test Failed.  I use \u0027-1\u0027 for Setup Failed.  Maybe I should #define these?"},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":202,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"There\u0027s the classic EXIT_FAILURE macro from stdlib.h, which is 1."},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","line":202,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Shoot, updated with my own TEST_FAILURE vs. SETUP_FAILURE numbers.  Can re-re-do if needed."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":2336,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we\u0027re zeroing this member out, shouldn\u0027t we be setting the other uint32_t of it. I assume this is done in part to not assume the alignment/overlap of the 64-bit cookie which is being set down below."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":2336,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"The new 64-bit cookie overlaps the space taken by the old 32-bit cookie + 32-bit reserved.  This is an input scrubber to insure a potentially misbehaving in.iked doesn\u0027t break things because it didn\u0027t set x_kmc_reserved to 0.  (IIRC it always sets this to 0, so this exception may be redundant.)"},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":2336,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Ah, okay. Would you make sure to clarify that? Maybe instead we should just be treating the different types as different types and not necessarily relying on the type overlap?"},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":2336,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Trying to preserve the data structure because we have a closed-source binary (in.iked) depending on it.  This is all about not breaking in.iked.\n\nI can modify the comment to better reflect that, however."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":3143,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Same as above."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":3143,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Same as above as well... this is an input scrubber to guard against possible-but-not-likely in.iked issues."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":4456,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you explain the switch from the or to the and? Was this a bug in the existing code. Same as at +4461."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":4456,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Yes, good catch, this was a bug in the existing code. This case was never really tested until we enabled write-once UPDATE of KMC (see below)."},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":4514,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is this here because we want to make sure that when we pass this down over PF_KEY this is now present, but didn\u0027t previously?"},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":4514,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Yes, adding this flag allows the the update of KMC.  (It exposed the previous bug above too.)"},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":4514,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should there be a separate bug that covers enabling this or at least explaining that this is part of what is required for the 64-bit work?"},{"file":"usr/src/uts/common/inet/ip/sadb.c","line":4514,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I can put required-for-this-work in OS-6333."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":28,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":222,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":24,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":364,"sizeDeletions":-26},{"number":"9","revision":"5d266ae3aa567b5894000553012075a3b3ff57f6","parents":["81eea0cac9755cf17a2531be72cfafd68358db1a"],"ref":"refs/changes/50/2550/9","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1506104946,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506105251,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":34,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":226,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":24,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":374,"sizeDeletions":-26},{"number":"10","revision":"4ed101f558fecd3213de82aaa80615a1211418f7","parents":["81eea0cac9755cf17a2531be72cfafd68358db1a"],"ref":"refs/changes/50/2550/10","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1506105759,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506105864,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":34,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":226,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":34,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":384,"sizeDeletions":-26},{"number":"11","revision":"2ba93cb647b8e6eb59a00402dc2a8d47977985e3","parents":["81eea0cac9755cf17a2531be72cfafd68358db1a"],"ref":"refs/changes/50/2550/11","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1506113474,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506113675,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506364892,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506105864,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":34,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":226,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":34,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":384,"sizeDeletions":-26},{"number":"12","revision":"f8f517847ea88609418c3fb9545e30cbdcc8da2b","parents":["31db0e37e1dc1c1e15a721732d617c1e429e1a5e"],"ref":"refs/changes/50/2550/12","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1506364939,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506113675,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506364892,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506105864,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":34,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":226,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":34,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":384,"sizeDeletions":-26},{"number":"13","revision":"02ba530437bfbfdddf56de010d62a5ff453813ae","parents":["31db0e37e1dc1c1e15a721732d617c1e429e1a5e"],"ref":"refs/changes/50/2550/13","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1506365001,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506113675,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506364892,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1506105864,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1506365015,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.c","type":"MODIFIED","insertions":34,"deletions":-5},{"file":"usr/src/lib/libipsecutil/common/ipsec_util.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/pkg/manifests/system-test-ostest.mf","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/Makefile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-update.sh","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/test/os-tests/tests/pf_key/kmc-updater.c","type":"ADDED","insertions":226,"deletions":0},{"file":"usr/src/uts/common/inet/ip/sadb.c","type":"MODIFIED","insertions":34,"deletions":-13},{"file":"usr/src/uts/common/inet/ipsec_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/inet/sadb.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/net/pfkeyv2.h","type":"MODIFIED","insertions":6,"deletions":-2}],"sizeInsertions":384,"sizeDeletions":-26}],"allReviewers":[{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}