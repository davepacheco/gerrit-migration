From f3e6208da7824bcef75ec49cb893592a99cd04d1 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 7 Sep 2016 18:39:31 +0000
Subject: [PATCH] OS-5642 containerbuddy unable to fork while using syslog
 driver, causing container services to hang

---
 usr/src/man/man4/process.4            |  8 +++++---
 usr/src/uts/common/contract/process.c | 13 ++++++++++++-
 2 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/usr/src/man/man4/process.4 b/usr/src/man/man4/process.4
index 6f44792138..d709decfce 100644
--- a/usr/src/man/man4/process.4
+++ b/usr/src/man/man4/process.4
@@ -1,10 +1,10 @@
 '\" te
 .\" Copyright (c) 2008, Sun Microsystems, Inc. All Rights Reserved.
-.\" Copyright 2015, Joyent, Inc.
+.\" Copyright 2016, Joyent, Inc.
 .\" The contents of this file are subject to the terms of the Common Development and Distribution License (the "License").  You may not use this file except in compliance with the License.
 .\" You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE or http://www.opensolaris.org/os/licensing.  See the License for the specific language governing permissions and limitations under the License.
 .\" When distributing Covered Code, include this CDDL HEADER in each file and include the License file at usr/src/OPENSOLARIS.LICENSE.  If applicable, add the following below this CDDL HEADER, with the fields enclosed by brackets "[]" replaced with your own identifying information: Portions Copyright [yyyy] [name of copyright owner]
-.TH PROCESS 4 "Oct 7, 2015"
+.TH PROCESS 4 "Sept 6, 2016"
 .SH NAME
 process \- process contract type
 .SH SYNOPSIS
@@ -213,7 +213,9 @@ exits.
 If set, the process contract template remains active across \fBexec\fR(2).
 This can be used to setup a contract for children of an application which
 is not contract-aware. If this is not set then the system clears the active
-template when the process execs.
+template when the process execs. Because this option is intended for an
+application which is not contract-aware, new child process contracts will be
+automatically abandoned by the parent.
 .RE
 
 .sp
diff --git a/usr/src/uts/common/contract/process.c b/usr/src/uts/common/contract/process.c
index cad5d7f955..e92f87eecf 100644
--- a/usr/src/uts/common/contract/process.c
+++ b/usr/src/uts/common/contract/process.c
@@ -21,7 +21,7 @@
 /*
  * Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2015 Joyent, Inc.
+ * Copyright 2016 Joyent, Inc.
  */
 
 #include <sys/mutex.h>
@@ -1070,6 +1070,17 @@ contract_process_fork(ctmpl_process_t *rtmpl, proc_t *cp, proc_t *pp,
 		event->cte_type = CT_PR_EV_FORK;
 		(void) cte_publish_all(ct, event, nvl, NULL);
 	}
+
+	/*
+	 * Because the CT_PR_KEEP_EXEC flag is meant to be used by applications
+	 * which are not contract aware, we can assume that these applications
+	 * will never explicitly abandon the child's new contract. Thus, we
+	 * abandon it now.
+	 */
+	if (ctp->conp_params & CT_PR_KEEP_EXEC) {
+		contract_abandon(ct, pp, 1);
+	}
+
 	return (ctp);
 }
 
-- 
2.21.0

