{"project":"joyent/illumos-joyent","branch":"master","id":"I99e0ea6f8add1cf97455a780f409f34b33c9d6d0","number":"2821","subject":"OS-6355 in-kernel zone page invalidation Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Jason King \u003cjason.king@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2821","commitMessage":"OS-6355 in-kernel zone page invalidation\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1508433257,"lastUpdated":1509117684,"open":false,"status":"MERGED","comments":[{"timestamp":1508433257,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1508433341,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nMost of the change here is deletions to remove the user-level memory capper. The key change is in vm_pageout.c, but even there, most of the changes are a big round of comment correction and improvement. Also, changes for better tracing. The actual code changes to support zones are minimal."},{"timestamp":1508900593,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1508947361,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(3 comments)\n\nComment-changes only, I think."},{"timestamp":1509024615,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI have fixed all of the comment issues that were noted. I also decided to add a kstat so we can more easily monitor this new behavior. And, I also added a tunable for the zone pagescan ticks so we can adjust things in production if it turns out to be necessary."},{"timestamp":1509024632,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1509029169,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1509111022,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI have added testing notes to the ticket."},{"timestamp":1509115726,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nShip it."},{"timestamp":1509115823,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1509116238,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1509116301,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1509116416,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Integration-Approval+1\n\nAhhh:  \"I can see that we now have the better behavior of stopping once the zone is under the hysteresis for the cap (whereas the old capper would hit the whole segment and invalidate a lot more pages). \"\n\nThis means your fix did what it was supposed to.  Good!"},{"timestamp":1509117684,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"99e0ea6f8add1cf97455a780f409f34b33c9d6d0","parents":["34c01dd511a167c26a0c616d56577d936040e694"],"ref":"refs/changes/21/2821/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1509116301,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509029169,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509115726,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509115823,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1509117684,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/truss/print.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/mcap.c","type":"DELETED","insertions":0,"deletions":-997},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":3,"deletions":-11},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"usr/src/uts/common/os/kstat_fr.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":299,"deletions":-204},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":6,"deletions":-91},{"file":"usr/src/uts/common/sys/resource.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/sys/vmsystm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":10,"deletions":-19},{"file":"usr/src/uts/common/syscall/rusagesys.c","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"usr/src/uts/common/vm/vm_as.c","type":"MODIFIED","insertions":0,"deletions":-17},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":0,"deletions":-182},{"file":"usr/src/uts/i86pc/sys/vm_machparam.h","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":333,"sizeDeletions":-1554},"patchSets":[{"number":"1","revision":"20d0e0418e2a0b40d69f3a09a87efab95cf5fe57","parents":["797a25a44d0fb15715c40a2b75693d39a547c37c"],"ref":"refs/changes/21/2821/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508433257,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508900593,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"usr/src/uts/common/os/vm_pageout.c","line":123,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"\"Given hz is 1000\" looks like a typo given the prior paragraphs lead with 100.  \"If hz is 1000,\" might be a better choice of words."},{"file":"usr/src/uts/common/os/vm_pageout.c","line":220,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"zone_num_over_cap is mutex-protected in zone.c.  I take it that because of the \"except within schedpaging(), which only runs periodically,\" you really don\u0027t care about accessing zone_num_over_cap sans-mutex?\n\nYou should mention in this comment block, to reduce concern/confusion, that holding the mutex there isn\u0027t required."},{"file":"usr/src/uts/common/os/vm_pageout.c","line":428,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Nit: typo"},{"file":"usr/src/uts/common/os/zone.c","line":474,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"\"allocated\""}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/truss/print.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/mcap.c","type":"DELETED","insertions":0,"deletions":-997},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":3,"deletions":-11},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":289,"deletions":-204},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":5,"deletions":-90},{"file":"usr/src/uts/common/sys/resource.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":10,"deletions":-19},{"file":"usr/src/uts/common/syscall/rusagesys.c","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"usr/src/uts/common/vm/vm_as.c","type":"MODIFIED","insertions":0,"deletions":-17},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":0,"deletions":-182},{"file":"usr/src/uts/i86pc/sys/vm_machparam.h","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":316,"sizeDeletions":-1551},{"number":"2","revision":"46baecd2f90eb838b40ab3138f93131047d76f2e","parents":["e0c6772393ee04366494174e8e95ba7bcc980ed7"],"ref":"refs/changes/21/2821/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1509024632,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509029169,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509115823,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509115726,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509116416,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/truss/print.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/mcap.c","type":"DELETED","insertions":0,"deletions":-997},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":3,"deletions":-11},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"usr/src/uts/common/os/kstat_fr.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":299,"deletions":-204},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":6,"deletions":-91},{"file":"usr/src/uts/common/sys/resource.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/sys/vmsystm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":10,"deletions":-19},{"file":"usr/src/uts/common/syscall/rusagesys.c","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"usr/src/uts/common/vm/vm_as.c","type":"MODIFIED","insertions":0,"deletions":-17},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":0,"deletions":-182},{"file":"usr/src/uts/i86pc/sys/vm_machparam.h","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":333,"sizeDeletions":-1554},{"number":"3","revision":"af15595252640119c6881be148968ff7872a6732","parents":["34c01dd511a167c26a0c616d56577d936040e694"],"ref":"refs/changes/21/2821/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1509116238,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509029169,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509115823,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509115726,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/truss/print.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/mcap.c","type":"DELETED","insertions":0,"deletions":-997},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":3,"deletions":-11},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"usr/src/uts/common/os/kstat_fr.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":299,"deletions":-204},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":6,"deletions":-91},{"file":"usr/src/uts/common/sys/resource.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/sys/vmsystm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":10,"deletions":-19},{"file":"usr/src/uts/common/syscall/rusagesys.c","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"usr/src/uts/common/vm/vm_as.c","type":"MODIFIED","insertions":0,"deletions":-17},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":0,"deletions":-182},{"file":"usr/src/uts/i86pc/sys/vm_machparam.h","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":333,"sizeDeletions":-1554},{"number":"4","revision":"99e0ea6f8add1cf97455a780f409f34b33c9d6d0","parents":["34c01dd511a167c26a0c616d56577d936040e694"],"ref":"refs/changes/21/2821/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1509116301,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1509117684,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509029169,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509115823,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509115726,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/truss/print.c","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/mcap.c","type":"DELETED","insertions":0,"deletions":-997},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":3,"deletions":-11},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"usr/src/uts/common/os/kstat_fr.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/vm_pageout.c","type":"MODIFIED","insertions":299,"deletions":-204},{"file":"usr/src/uts/common/os/zone.c","type":"MODIFIED","insertions":6,"deletions":-91},{"file":"usr/src/uts/common/sys/resource.h","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/sys/vmsystm.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/zone.h","type":"MODIFIED","insertions":10,"deletions":-19},{"file":"usr/src/uts/common/syscall/rusagesys.c","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"usr/src/uts/common/vm/vm_as.c","type":"MODIFIED","insertions":0,"deletions":-17},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":0,"deletions":-182},{"file":"usr/src/uts/i86pc/sys/vm_machparam.h","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":333,"sizeDeletions":-1554}],"allReviewers":[{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}