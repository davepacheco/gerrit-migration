{"project":"joyent/illumos-joyent","branch":"master","id":"I9654b9253bb0e3fe55f164d82f3e5bbd333f4826","number":"3767","subject":"OS-6834 zfd logging needs to be more generic OS-6867 zoneadmd escape_json() modifies byte after input buffer OS-6868 zoneadmd escape_json() mishandles null and incomplete characters OS-6845 zoneadmd wr_log_msg() gets nanoseconds wrong Reviewed by: Josh Wi","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3767","commitMessage":"OS-6834 zfd logging needs to be more generic\nOS-6867 zoneadmd escape_json() modifies byte after input buffer\nOS-6868 zoneadmd escape_json() mishandles null and incomplete characters\nOS-6845 zoneadmd wr_log_msg() gets nanoseconds wrong\nReviewed by: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1522765647,"lastUpdated":1523334281,"open":false,"status":"MERGED","comments":[{"timestamp":1522765647,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1522765986,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nIn addition to the big comment at the start of log.c, there\u0027s also a decent summary in OS-6834."},{"timestamp":1522771536,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(10 comments)"},{"timestamp":1522783965,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1522785157,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(17 comments)"},{"timestamp":1522799534,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1522799633,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(24 comments)\n\nPrior to round 1, I did some self-review as well.  Unfortunately, I didn\u0027t include that in round 1.  Changes that are distant from other comments are likely due to that."},{"timestamp":1522800031,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522834633,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1522929858,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522949689,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1522950043,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(3 comments)\n\nIn addition to addressing comments, I did a bunch of testing and fixed things that fell out of that.   Some of this setting up for recording events, timing, etc. in a way that doesn\u0027t force consumers to parse text in \"log\" elements.\n\nThe eradication of wchar support in escape_json() seems to be no real change from what was present before, as mbsinit() was not previously called."},{"timestamp":1523033002,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1523073479,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 4."},{"timestamp":1523093205,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1\n\nThanks, this is great!"},{"timestamp":1523282290,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1523294518,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 5."},{"timestamp":1523294632,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5:\n\n(3 comments)\n\nI threw more urandom data thrown at escape_json() and found an off-by-one.  This round fixes that."},{"timestamp":1523294741,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1523296886,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1523302698,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 6."},{"timestamp":1523302878,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 6:\n\nSigh, should have waited until all of my re-testing was complete before the last update.  I\u0027ve now completed all of the tests listed in OS-6834, OS-6845.  This includes verifying I didn\u0027t break what was working with OS-6831."},{"timestamp":1523303722,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1523304839,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1523305924,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1523306555,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1523334239,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1523334281,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"8","revision":"ffeb218a004ab13ee967d4cc90f685a3c38035bb","parents":["2caf2627159ba92a36f06f1f664df5b5d8cbbc51"],"ref":"refs/changes/67/3767/8","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1523334239,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523303722,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523304839,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523305924,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1523334280,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":14,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":918,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1052,"sizeDeletions":-289},"patchSets":[{"number":"1","revision":"19d9285be8dbb86c0d1cf736e78a47c6a7e6fa0c","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522765647,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/zoneadmd/log.c","line":39,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"The current consumers in other functions doen\u0027t follow this description for error handling. Since you allow -1 in the other functions, maybe clarify that error handing is optional?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":39,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Yeah, I made the code more forgiving of logs that could not be [re]opened.  Forgot to update this comment."},{"file":"usr/src/cmd/zoneadmd/log.c","line":56,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think you mean zlog-max-size?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":56,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":57,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think you mean zlog-max-size?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":57,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":62,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think you mean zlog-max-size?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":62,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":117,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This should come from sysmacros.h already?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":117,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":118,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Is this really worth it versus just using a local routine that does syslog()?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":198,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"can\u0027t this just be replaced everywhere with MUTEX_HELD() ?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":198,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I missed the one in synch.h.  Fixed."},{"file":"usr/src/cmd/zoneadmd/log.c","line":286,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"can this be static?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":286,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":300,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"given we alloc, shouldn\u0027t we clamp at some reasonable max?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":300,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":360,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"isn\u0027t a regex simpler?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":360,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"moot due to glob."},{"file":"usr/src/cmd/zoneadmd/log.c","line":398,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"do you want to flush the cached buffer when you\u0027re rotating the log (especially if due to a signal where there might be a long delay before the next msg is written)?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":398,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Yeah, I suppose so.  That also allows SIGHUP to be used to flush the log."},{"file":"usr/src/cmd/zoneadmd/log.c","line":436,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"dirname?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":436,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"moot due to glob."},{"file":"usr/src/cmd/zoneadmd/log.c","line":451,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I was going to comment to use libcmdutil\u0027s strarray stuff I added, but :("},{"file":"usr/src/cmd/zoneadmd/log.c","line":451,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Speaking of things that we\u0027ve implemented before..."},{"file":"usr/src/cmd/zoneadmd/log.c","line":479,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think you could simplify this code a fair bit by using glob() to get a sorted list of the directory, and just counting the first rot_keep entries that match the regexp."},{"file":"usr/src/cmd/zoneadmd/log.c","line":479,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":496,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\u0027\\0\u0027 not 0"},{"file":"usr/src/cmd/zoneadmd/log.c","line":496,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"moot due to glob."},{"file":"usr/src/cmd/zoneadmd/log.c","line":652,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"If you refactored escape_json and the write out to a child function (which would also make this function a little less lengthy), seems like this could be much simpler: copy into the buffer char by char until you see a \\n (or you\u0027re full), call your emit function, reset the buffer and loop. Easier with -\u003els_bufleft instead of -\u003els_buflen."},{"file":"usr/src/cmd/zoneadmd/log.c","line":652,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Yeah, that\u0027s a good idea.  I\u0027ll tackle this in round 3."},{"file":"usr/src/cmd/zoneadmd/log.c","line":762,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Worth an assert that ls !\u003d -1?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":762,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":778,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Do you also want to write an error msg here, like you do above at line 757?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":778,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Seems better to just assert at the top of the function"},{"file":"usr/src/cmd/zoneadmd/log.c","line":778,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I like John\u0027s approach more."},{"file":"usr/src/cmd/zoneadmd/log.c","line":801,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"same question"},{"file":"usr/src/cmd/zoneadmd/log.c","line":801,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"And same comment :)"},{"file":"usr/src/cmd/zoneadmd/log.c","line":813,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Since you\u0027re buffering in logstream_write, I assume you should flush the buffer here, but I am not seeing where you do that."},{"file":"usr/src/cmd/zoneadmd/log.c","line":813,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":25,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fix year"},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":84,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Worth a little note about logging?"},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":84,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":750,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this code doesn\u0027t conform to the comment in log.c which describes that the return from logstream_open should be verified"},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":750,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"comment fixed."},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":874,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Is it worth putting events in the log too?"},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":874,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I have a follow-on change were I will be adding things like door calls, subprocess execution duration, etc. I\u0027ll address this then."},{"file":"usr/src/cmd/zoneadmd/zcons.c","line":874,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Cool, thanks."},{"file":"usr/src/cmd/zoneadmd/zfd.c","line":1025,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this code doesn\u0027t conform to the comment in log.c which describes that the return from logstream_open should be verified"},{"file":"usr/src/cmd/zoneadmd/zfd.c","line":1025,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"comment fixed."},{"file":"usr/src/cmd/zoneadmd/zfd.c","line":1200,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"logp no longer used"},{"file":"usr/src/cmd/zoneadmd/zfd.c","line":1200,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I caught this (and other stuff) in a self review, but neglected to add that changeset to the round 1 review."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":2621,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this code doesn\u0027t conform to the comment in log.c which describes that the return from logstream_open should be verified"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":2621,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"comment fixed"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","line":166,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Nit: this comment is even more stale now"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","line":166,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":849,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":30,"deletions":-230},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":15,"deletions":-3}],"sizeInsertions":928,"sizeDeletions":-244},{"number":"2","revision":"a80785f17a170ac73d68da6094cf392cbca0a629","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522799534,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/zoneadmd/log.c","line":160,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Can kill"},{"file":"usr/src/cmd/zoneadmd/log.c","line":160,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":431,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"A comment with the old \".YYY...\" string might make it a little clearer?\n\nI see you\u0027re thinking of becoming a Y3K contractor :)"},{"file":"usr/src/cmd/zoneadmd/log.c","line":431,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":439,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"It looks like a globfree() is required even in the error case. Weird function."},{"file":"usr/src/cmd/zoneadmd/log.c","line":439,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/zfd.c","line":86,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m sure you have it right, but I\u0027m a bit confused about how it\u0027s OK to keep this around when we\u0027re called from zone_bootup() - isn\u0027t that the temporary zlog that corresponds to the door call?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":807,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":21,"deletions":-223},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":35,"deletions":-12},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":15,"deletions":-4}],"sizeInsertions":893,"sizeDeletions":-245},{"number":"3","revision":"562fdf26392f34f2df212e0d8b5471ab43451136","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522949689,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/zoneadmd/log.c","line":483,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think your globfree() should be here, even though it probably doesn\u0027t matter."},{"file":"usr/src/cmd/zoneadmd/log.c","line":483,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":511,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Nit: since this also accounts for a full buffer, can we rename it to \"ready_to_flush\" or something?"},{"file":"usr/src/cmd/zoneadmd/log.c","line":511,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/log.c","line":754,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"You already checked for len \u003d\u003d 0"},{"file":"usr/src/cmd/zoneadmd/log.c","line":754,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":913,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1047,"sizeDeletions":-289},{"number":"4","revision":"826d8d11a1ff20ad0712985295840739d392d0e1","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1523073479,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523282290,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523093205,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":913,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1047,"sizeDeletions":-289},{"number":"5","revision":"d41cd96cec19dc674b12d37bb2f8641254b3b020","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1523294518,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523296886,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523294741,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":910,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1044,"sizeDeletions":-289},{"number":"6","revision":"9654b9253bb0e3fe55f164d82f3e5bbd333f4826","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/6","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1523302698,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523304839,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523305924,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523303722,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":918,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1052,"sizeDeletions":-289},{"number":"7","revision":"1760084e328bb8505087cad49aeb421f73cffffd","parents":["89f28c29187081c8db00a633d949df9b5f2a403d"],"ref":"refs/changes/67/3767/7","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1523306555,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523304839,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523305924,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523303722,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":14,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":918,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1052,"sizeDeletions":-289},{"number":"8","revision":"ffeb218a004ab13ee967d4cc90f685a3c38035bb","parents":["2caf2627159ba92a36f06f1f664df5b5d8cbbc51"],"ref":"refs/changes/67/3767/8","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1523334239,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523304839,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523305924,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1523334280,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523303722,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":14,"deletions":0},{"file":"usr/src/cmd/zoneadmd/Makefile.com","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/cmd/zoneadmd/log.c","type":"ADDED","insertions":918,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zcons.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":49,"deletions":-252},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":50,"deletions":-24},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":17,"deletions":-5}],"sizeInsertions":1052,"sizeDeletions":-289}],"allReviewers":[{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}