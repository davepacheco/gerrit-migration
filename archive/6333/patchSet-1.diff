From 03a39f6cb41938fe293e6e0dd6d8a1779fd0d697 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Thu, 16 May 2019 17:33:19 -0500
Subject: [PATCH] TRITON-1686 linux-prepare-image support for fixing ubuntu
 serial console

---
 tools/prepare-image/linux-prepare-image | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index eb3f06a..570df44 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2018, Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 #
@@ -175,6 +175,18 @@ function prepare_fedora() {
 function prepare_ubuntu() {
     # Clean up package cache
     apt-get -y clean
+
+    local fixconsole=$(mdata-get prepare-image:fix-ubuntu-console 2>/dev/null)
+
+    if [[ $fixconsole == true ]]; then
+        cat >/etc/default/grub.d/51-smartos-serial-console.cfg <<EOF
+GRUB_TERMINAL="serial console"
+GRUB_CMDLINE_LINUX="console=ttyS0,115200n8 console=tty0"
+GRUB_SERIAL_COMMAND="serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1"
+EOF
+
+        update-grub2
+    fi
 }
 
 # Makes sure that /lib/smartdc et al are sane.
-- 
2.21.0

