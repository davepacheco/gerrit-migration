{"project":"joyent/manta-muskie","branch":"master","topic":"3284","id":"I0cbf5f297a47f54f6406a8fc702f0304780e397a","number":"2630","subject":"MANTA-3284 want operator-configurable throttle on muskie requests","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2630","commitMessage":"MANTA-3284 want operator-configurable throttle on muskie requests\n","createdOn":1505947463,"lastUpdated":1516397233,"open":false,"status":"MERGED","comments":[{"timestamp":1505947463,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1505947491,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1505947659,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1505947691,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1505947824,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1505947857,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506103907,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(16 comments)"},{"timestamp":1506118476,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(10 comments)"},{"timestamp":1506120877,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1506124230,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1506373411,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1506373459,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506375998,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1506376031,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506387967,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1506388006,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506389625,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 7."},{"timestamp":1506389664,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506550018,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1506550051,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506563941,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 9."},{"timestamp":1506563971,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506564079,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1506638863,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 9:\n\n(14 comments)"},{"timestamp":1506719815,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 10."},{"timestamp":1506719859,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506720063,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 11."},{"timestamp":1506720099,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508529715,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 12."},{"timestamp":1508529750,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1508529802,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 13."},{"timestamp":1508529832,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508529904,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 13:\n\n(4 comments)\n\nI\u0027ve updated RFD 110 to reflect the latest implementation. I decided that for the basic throttle it\u0027s probably best to just expose concurrency and queue tolerance as parameters. The RFD also reflects the decision to not use dynamic configuration, and also includes more discussion of the tradeoffs for various concurrency/queue tolerance values."},{"timestamp":1508529908,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 14: Patch Set 13 was rebased"},{"timestamp":1508529945,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14:\n\n\"make check\" passed ok"},{"timestamp":1509040164,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 14:\n\n(7 comments)\n\nThis is looking good. Most of my comments this round are pretty minor."},{"timestamp":1509050653,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 14:\n\n(4 comments)"},{"timestamp":1509145890,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 15."},{"timestamp":1509145917,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509152112,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 16."},{"timestamp":1509152139,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509490452,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 16:\n\n(6 comments)"},{"timestamp":1509567705,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 17."},{"timestamp":1509567716,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 18: Patch Set 17 was rebased"},{"timestamp":1509567732,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509567733,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 18:\n\n(2 comments)"},{"timestamp":1509567744,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510185957,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 18:\n\n(6 comments)"},{"timestamp":1510193682,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 19."},{"timestamp":1510193708,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 19:\n\n(6 comments)"},{"timestamp":1510193713,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510243978,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 19:\n\n(1 comment)\n\nThanks for updating the error. For the IA piece of the error testing, I think it would also be good to see a response from the client\u0027s perspective (e.g., run a throttled `mget` or `mput` using `-v`) to show that the error is translated correctly.\n\nWhat are your thoughts on adding some operator documentation for using the throttle? I think a brief section on how to enable and update the throttle in the Manta operator\u0027s guide would be useful. (This can be under a separate ticket, but it would be nice to have these integrate around the same time.)"},{"timestamp":1510281499,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 20."},{"timestamp":1510281527,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1510282655,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 21."},{"timestamp":1510282682,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 21: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510283032,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 21:\n\nSee the ticket for what the client is presented with when requests are throttled. I\u0027ve added output for mget, minfo, and mput which seems sufficient because all of these go through the same path as far as the throttle is concerned. \n\nWith regards to operator documentation, I\u0027m not sure what else there is to say besides \"set these SAPI tunable and restart.\" Where would such documentation go?"},{"timestamp":1510331353,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 21:\n\n\u003e With regards to operator documentation, I\u0027m not sure what else\n \u003e there is to say besides \"set these SAPI tunable and restart.\" Where\n \u003e would such documentation go?\n\nI was thinking the Manta operator\u0027s guide (http://joyent.github.io/manta/)."},{"timestamp":1510337972,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 21:\n\n\u003e \u003e With regards to operator documentation, I\u0027m not sure what else\n \u003e \u003e there is to say besides \"set these SAPI tunable and restart.\"\n \u003e Where\n \u003e \u003e would such documentation go?\n \u003e \n \u003e I was thinking the Manta operator\u0027s guide (http://joyent.github.io/manta/).\n\nTo the earlier point about what else there is to document besides the SAPI tunable: I think you can provide the \"why\" and the tradeoffs of the tunables that operators might care about in the operator\u0027s guide. Basically, as an operator, I want to know: why I might want to use the throttle, how to enable it and configure it, and what tradeoffs I need to consider when tuning its parameters. \n\nSome of the information I described above is redundant with the comments in the code, but the operator\u0027s guide is intended for a different audience than code comments. Our ops team will need these instructions when operating SPC, for instance, and it would be great to have this already written down so they can reference it in a CM.\n\nI don\u0027t think this documentation needs to be very long necessarily -- likely a few sentences explaining the context and tradeoffs, along with the instructions on configuring and enabling the throttle will suffice. And we can definitely do this under another ticket, too, and just aim to integrate them around the same time."},{"timestamp":1510366737,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Topic set to 3284"},{"timestamp":1512785156,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 22."},{"timestamp":1512785184,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 22: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513973938,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 23."},{"timestamp":1513973969,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 23: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514913294,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 23: Code-Review+1\n\n(2 comments)"},{"timestamp":1515012401,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 24."},{"timestamp":1515012429,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 24: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515014408,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 25."},{"timestamp":1515014436,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 25: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515014604,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 26."},{"timestamp":1515014633,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 26: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515086289,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 26:\n\nModulo the copyright on throttlestat.d, this latest patchset (26) looks good!"},{"timestamp":1515107820,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 27."},{"timestamp":1515107848,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 27: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515524201,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 28."},{"timestamp":1515524230,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 28: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515540108,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 28: Code-Review+1"},{"timestamp":1516300818,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 29: Patch Set 28 was rebased"},{"timestamp":1516300847,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 29:\n\n\"make check\" passed ok"},{"timestamp":1516305675,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 29: Integration-Approval+1"},{"timestamp":1516397233,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"}],"currentPatchSet":{"number":"29","revision":"dc4f785c652e76393789d1a65603d81a59c75bbe","parents":["284af58c63c86e2d105e5bf82fd99e01a40e99b7"],"ref":"refs/changes/30/2630/29","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516300818,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515524230,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515540108,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516305675,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1516397233,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"bin/throttlestat.d","type":"ADDED","insertions":60,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":373,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"85e554c3ccd1915f93925ea7047ad4cb888e9a55","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1505947463,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1505947491,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":197,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: ThrottledError"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":222,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":10,"deletions":-24},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":36,"deletions":0}],"sizeInsertions":284,"sizeDeletions":-26},{"number":"2","revision":"8147a3fe96c675218832bad617cd11f73ca13f71","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1505947659,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1505947691,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":197,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: ThrottledError"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":222,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":10,"deletions":-24},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":36,"deletions":0}],"sizeInsertions":284,"sizeDeletions":-26},{"number":"3","revision":"43d2610047fed65adc99e33bde8031f3d3cfd88a","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1505947824,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505947857,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"etc/config.coal.json","line":12,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is this an acceptable value for a vasync queue? I\u0027m not sure I\u0027ve seen a queue with a \u0027concurrency\u0027 parameter this large in the wild, but that doesn\u0027t necessarily mean anything."},{"file":"etc/config.coal.json","line":12,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"The default values pass the muskie test suite both enabled and disabled. Looking at the implementation too, there are no checks done against this value: https://github.com/joyent/node-vasync/blob/master/lib/vasync.js#L371. Unless you meant that it\u0027s not a practical value. It may or may not be, but as I documented in the testing notes, the request latencies that I\u0027m seeing for a muskie with the throttle and without the throttle are roughly the same."},{"file":"etc/config.coal.json","line":12,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I was trying to get a sense of whether this was an acceptable default for a production system. It seems a lot higher than other uses of the vasync.queue I\u0027ve seen is all."},{"file":"etc/config.coal.json","line":12,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I\u0027ll need to test this against a realistic workload to see what concurrency value would make sense by checking how many requests an average muskie is processing at once."},{"file":"etc/config.coal.json","line":12,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I tested against 10, 25, and 50 concurrent mlives hammering the same muskie and saw this value (the number of requests for which callback chains are scheduled concurrently) rise to 30, 50, and 150 respectively. \n\nI also traced the number of concurrent routes running in SPC, and those values (as I documented in the testing notes) hover between 1-15, with averages of 3-5. I think setting this concurrency to 50 is a reasonable conservative value that won\u0027t be to invasive on a per-muskie basis. Of course, the load sensing would be more accurate if this was a globally aware throttle.\n\nThis \u0027concurrency\u0027 value effectively represents a ceiling on the number of requests that muskie can schedule callback handler chains for concurrently. Since there is nothing bounding this number in previous versions of muskie, and because I think we intend for this to be a minimally invasive throttle, it\u0027s better to err on the side of higher default values."},{"file":"lib/errors.js","line":599,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think Kelly raised a good point in the RFD discussion about the semantics of this HTTP response code, as the RFC defines it as indicated a single user is being throttled for sending too many requests. I\u0027m not sure if that\u0027s worth trying to resolve before we land this."},{"file":"lib/errors.js","line":599,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It probably would not be that hard to make this a per-user throttle. I think one consideration would be the number of users though. If it\u0027s high enough - possibly storing all of them in memory might not be feasible (?)"},{"file":"lib/errors.js","line":599,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"To be clear: I wasn\u0027t trying to suggest that we implement the user throttle now, just resolve whether this status code should be different. If it is different, what would it be? If it is a 429, how would we document it to be clear to end users what it means?"},{"file":"lib/errors.js","line":599,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think that, while we don\u0027t have user-specific throttling, we should change this to a status code 503, which the RFC describes as \"the server is currently unavailable (because it is overloaded or down for maintenance).\""},{"file":"lib/throttle.js","line":24,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Nit: Make this to a C-style comment using /* ... */? That\u0027s how most of the multi-line comments in this repo are formatted. Same for the other comments in this file."},{"file":"lib/throttle.js","line":26,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I find this tunable summary a bit challenging to follow. Perhaps break it up into a couple sentences?"},{"file":"lib/throttle.js","line":26,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Will do."},{"file":"lib/throttle.js","line":40,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think we can leave \"vasync\" out here -- it\u0027s an implementation detail that isn\u0027t important to understanding the concept, I think."},{"file":"lib/throttle.js","line":40,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Will do."},{"file":"lib/throttle.js","line":45,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I like that all the tunables are enumerated and described here!\n\nI\u0027m not sure we should punt all of the explanation of this feature to the RFD. RFDs have a much broader scope than code comments, and might encompass features that aren\u0027t yet implemented or implemented in a different way than they are currently.\n\nInstead, I think it would be great to have a high-level summary of this features works today as part of the file block comment. Having an explanation of this feature in a comment allows us to flesh out more specific details of this implementation, as well as allowing the reader of the code to grok this feature without needed docs outside of the repository. In this summary, I would also expand on tradeoffs of using the throttle, as well as tradeoffs for tweaking specific tunables."},{"file":"lib/throttle.js","line":45,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"WIll add a more high-level description here an omit the comment which references the RFD."},{"file":"lib/throttle.js","line":47,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"On a deployment where the throttle is not enabled, do the dtrace probes add additional functionality? I thought we had some similar probes already, but I could be wrong."},{"file":"lib/throttle.js","line":47,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"To be honest I did not check too thoroughly - I also only looked in the muskie repo. Will go back and check again."},{"file":"lib/throttle.js","line":69,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Wrap at 80 characters instead? Same for the comments below."},{"file":"lib/throttle.js","line":128,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Should this use process.hrtime()?"},{"file":"lib/throttle.js","line":128,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Probably - I will change the time-handling to use this api."},{"file":"lib/throttle.js","line":141,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: spaces around \u0027/\u0027 operator"},{"file":"lib/throttle.js","line":151,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This is a good comment."},{"file":"lib/throttle.js","line":168,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/it\u0027s/its"},{"file":"lib/throttle.js","line":203,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Since this is measuring an interval, should be we be using process.hrtime here? (Side note: jsprim has facilities for manipulating hrtimes.)"},{"file":"lib/throttle.js","line":203,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Will change to use process.hrtime."},{"file":"lib/throttle.js","line":206,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Does this do what we want it to? It seems like we are implicitly causing this code to run after everything in the route chain for the request finishes. If that\u0027s the case, it seems more suited to run when the \u0027after\u0027 event is fired on the server. (That\u0027s where we log the request audit entry, for instance.) It would be much clearer from a reader\u0027s perspective, and in general, I think we avoid running code after the callback of a consumer within the same function, but I might be wrong.\n\nOne downside to moving this code to the \u0027after\u0027 handler is that we have some outstanding bugs in which we don\u0027t log an audit entry for every request, which I imagine means we wouldn\u0027t be able to fire the new code either. It\u0027s probably worth exploring what happens in those cases. It seems like we would lose the dtrace probe firing, and a latency measurement, which we already do for the audit entry, anyway, so maybe it\u0027s not that big of a deal."},{"file":"lib/throttle.js","line":206,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I\u0027ll look into this."},{"file":"lib/throttle.js","line":206,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I guess the one concern I have putting this in the \u0027after\u0027 event handler is that it introduces more coupling between the throttle and muskie. Though given that whatever eventual generic solution we arrive at will probably be in cueball so maybe coupling with muskie is not a problem."},{"file":"lib/throttle.js","line":206,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Okay, I think it seems reasonable to decouple it for now. We might want to revisit this if/when the throttle becomes more generic."},{"file":"lib/throttle.js","line":216,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Same thing applies here to what I said above."},{"file":"main.js","line":337,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Since there are so many of these configure functions, I think it would be good to put this one in alphabetical order with the others so they can be found easily."},{"file":"main.js","line":337,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Will do."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":222,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":10,"deletions":-24},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":36,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":293,"sizeDeletions":-26},{"number":"4","revision":"51b78ba21ec56c0036e521627afbe6050b2ca784","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506373411,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506373459,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":272,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-24},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":36,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":337,"sizeDeletions":-26},{"number":"5","revision":"1b746a3f27cf749773d0ad951d4a7ec1aa12e328","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506375998,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506376031,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":277,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":36,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":342,"sizeDeletions":-2},{"number":"6","revision":"124572b8ac368573acfa2e59b7a1290c5f6195d8","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506387967,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506388006,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":277,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":32,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":338,"sizeDeletions":-2},{"number":"7","revision":"06a628d6251718fcde8bdb0c82a33e4055cb6645","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506389625,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506389664,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":277,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":32,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":338,"sizeDeletions":-2},{"number":"8","revision":"c59c56332576f8ea7820c27e2192e6ba1b6ebdd0","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506550018,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506550051,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":277,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":32,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":335,"sizeDeletions":-2},{"number":"9","revision":"54ca9d1f9eaf19adfc8bc35ab2cd305ab07bef5a","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506563941,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506563971,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":599,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should this not be a \"429 Too Many Requests\"?\n\nIf not (e.g., because we feel this is outside the client\u0027s control), then maybe \"ServerTooBusyError\"?  I don\u0027t think we want to convey that this has been throttled so much as that we\u0027re overloaded."},{"file":"lib/errors.js","line":599,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I changed this upon Kelly\u0027s suggestion on the github issue: https://github.com/joyent/rfd/issues/52. However, I\u0027m kind of lost on the exact meaning in the RFC: https://tools.ietf.org/html/rfc6585#page-3. It looks like the code is sent on a per-user basis. So, while a client for a particular MANTA_USER might get 429s, the HTTP spec would suggest that one might expect a different MANTA_USER to not get 429s - provided that the latter user hasn\u0027t reached the request rate capacity. However, in this case, it is expected that if one user gets a 429, all other users will also get a 429 because the system is overloaded.\n\nI don\u0027t know what the right course of action is. But I don\u0027t think we want clients to interpret this as a fatal error, but rather one that should trigger backoff."},{"file":"lib/server.js","line":218,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"How does this show up in `req.timers` in the log message?  It would be nice if it had a clear name, but I think using `bind` will result in an unnamed function."},{"file":"lib/server.js","line":218,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yes, you\u0027re right. I\u0027ve changed this to invoke the throttle.throttleHandler function in throttle.js in the next patchset. This way, the name in `req.timers` shows up as \u0027throttleRequest\u0027."},{"file":"lib/throttle.js","line":25,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This summary is great -- thank you for writing it down and including it in the source!\n\nI have not seen a throttle designed quite in this way (but then, I haven\u0027t looked at a lot of different designs).  I\u0027m more familiar with the design where the only tunables are the concurrency level and the maximum queue length.  The behavior is usually: if less than the concurrency level, proceed.  If more, but there\u0027s room in the queue, then enqueue.  Otherwise, fail.\n\nIs there a particular reason to look at incoming request rate over some recent period instead of, say, the current number of outstanding requests?"},{"file":"lib/throttle.js","line":25,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Well, I sort of consulted with JoshC early on in the process on this. His original suggestion was to a soft and hard request rate limit. If the observed rate goes above the soft limit, requests start getting queued, if the observed rate goes above the hard limit, the server starts sending 429s. I think the scheme that you\u0027re describing is reasonable too and reduces the complexity a bit - I can get rid of the request rate capacity concept."},{"file":"lib/throttle.js","line":32,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Semicolon (or period)?"},{"file":"lib/throttle.js","line":37,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Maybe quote this or use parens (\"wait()\") so it\u0027s clear that you\u0027re referring to the function?"},{"file":"lib/throttle.js","line":49,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"request\"."},{"file":"lib/throttle.js","line":64,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I found the term \"capacity\" here a little confusing because it\u0027s not what the system is capable of, but what we\u0027ve limited it to (if I\u0027m understanding correctly)."},{"file":"lib/throttle.js","line":87,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"tolerance\""},{"file":"lib/throttle.js","line":91,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"tolerance\""},{"file":"lib/throttle.js","line":101,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What does \"currently\" mean here -- is that prior to this change?"},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is there any reason not to just require a bunyan logger?"},{"file":"lib/throttle.js","line":207,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027d suggest pulling this into a constant at the top of the file called NANOSEC."},{"file":"lib/throttle.js","line":221,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This seems to ignore the whole number of seconds that\u0027s part of the latency."},{"file":"lib/throttle.js","line":221,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I definitely misunderstood the meaning of the return value to process.hrtime."},{"file":"lib/throttle.js","line":260,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I thought we did this already elsewhere in Muskie?  (We report request latency over the artedi endpoint.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":277,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":32,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":335,"sizeDeletions":-2},{"number":"10","revision":"77c822cc300c36723f535c95f9b1a195352ca22d","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506719815,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506719859,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"lib/throttle.js","type":"ADDED","insertions":173,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":215,"sizeDeletions":-2},{"number":"11","revision":"3a261d25e412ceb7e81bffcf9840101c943685ec","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/11","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506720063,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506720099,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":173,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":212,"sizeDeletions":0},{"number":"12","revision":"1b32c1f52c3cc5c0655b9dd9ae7550646caa7fd0","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/12","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508529715,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1508529750,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":132,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":175,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":214,"sizeDeletions":0},{"number":"13","revision":"4713ed53eee06f2764fec7ea0a11f4a9658095a1","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/13","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508529802,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508529832,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":175,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":214,"sizeDeletions":0},{"number":"14","revision":"aeb6fbda30383f8700df0b5b48d5c3603a66433d","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/30/2630/14","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508529908,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508529832,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":24,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This is an excellent summary. Thank you for writing it up!"},{"file":"lib/throttle.js","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: SAPI\nnit: A muskie restart isn\u0027t required to modify the values, but for the values to take effect."},{"file":"lib/throttle.js","line":53,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is this a per-queue tolerance level? So the total number of slots is queueTolerance * concurrency?"},{"file":"lib/throttle.js","line":53,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think a vasync queue only has one queue, which work callbacks are put in when all the concurrency slots are filled. So the total number of slots is \u0027concurrency\u0027, and if those slots are filled, the vasync library will queue up to \u0027queueTolerance\u0027 callbacks before sending 503s."},{"file":"lib/throttle.js","line":73,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Would the inverse of this be true as well? i.e., high concurrency, low queueTolerance?"},{"file":"lib/throttle.js","line":73,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yes, higher concurrency values means there\u0027s more on the event loop and it\u0027s less likely that work will be queued. With lower queue tolerance values, in the event that we queue work, we\u0027ll never have a bloated memory footprint due to this queue. Will add this."},{"file":"lib/throttle.js","line":123,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Do these log entries appear in the muskie logs?\n\nOne thing we\u0027ve done for other muskie sub-components, such as the picker, is to log them as a child logger for the main muskie logger. (e.g.: https://github.com/joyent/manta-muskie/blob/a612da71491efd1e926b986741f30f2f2055b685/lib/picker.js#L346). This way, the entries appear in the same stream the parent logger is in, but with an additional field denoting that it is a subcomponent\u0027s log statements."},{"file":"lib/throttle.js","line":123,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I will add a child logger for the throttle."},{"file":"lib/throttle.js","line":126,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Are these probes documented? We might want to add them to the muskie README, or something similar."},{"file":"lib/throttle.js","line":126,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah I just have them in the RFD for now, but the README is probably a better place."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":175,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":214,"sizeDeletions":0},{"number":"15","revision":"a5a6a8c627c21f5ddc010be51aeee0917d18e5ae","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/15","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509145890,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509145917,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":180,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":220,"sizeDeletions":0},{"number":"16","revision":"7142483197d44fd0033d7ee5e9a4f0b073223167","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/16","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509152112,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509152139,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":225,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"OOC, did you source the information about the `muskie` probe from somewhere, or did you write it up from scratch?"},{"file":"README.md","line":225,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I looked directly at the code."},{"file":"README.md","line":240,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Some of the line wrapping here (and a few lines below) goes beyond 80 chars."},{"file":"README.md","line":240,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"README.md","line":241,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It might be nice to put these descriptions alongside their values in the format description. It\u0027s not obvious to me looking at the markdown how readable it is listing out their descriptions in a sentence format."},{"file":"README.md","line":245,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/write/written"},{"file":"README.md","line":266,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think it might be ever clearer to say: \u0027The throttle probes are provided in a separate provider from the \"muskie\u0027 provider to prevent coupling...\u0027"},{"file":"lib/throttle.js","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"SAPI"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":48,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":177,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":265,"sizeDeletions":0},{"number":"17","revision":"16460b3d60c07b74334d08a9dbd6eb66d173de69","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/17","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509567705,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509567732,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":42,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":177,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":259,"sizeDeletions":0},{"number":"18","revision":"a9648e6d0715955f2c34fe0f4d3c28b03828a2da","parents":["697fa22fbae8bdf61025e16584f3668254cc06d9"],"ref":"refs/changes/30/2630/18","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509567716,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509567744,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think I commented on this in a previous review, but I\u0027ve always seen it written as \"SAPI\"."},{"file":"lib/throttle.js","line":50,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":68,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/manta/Manta"},{"file":"lib/throttle.js","line":68,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":93,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"To be consistent with the rest of muskie, let\u0027s move exports to the end of the file."},{"file":"lib/throttle.js","line":93,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":122,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"must be positive\""},{"file":"lib/throttle.js","line":122,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":132,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Should there be a comma after \"number of queued requests\" to indicate both lines are a part of the same list?"},{"file":"lib/throttle.js","line":132,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":164,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I wonder if we should pass the error the length of the queue and the queue tolerance so we can easily see this in the logs, as well as with dtrace probes. (We could log it in the error message of the ThrottledError.)"},{"file":"lib/throttle.js","line":164,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":42,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":177,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":259,"sizeDeletions":0},{"number":"19","revision":"61382589ae6bf500515ef646238e054f67beb4e3","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/19","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510193682,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510193713,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":149,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Just to make the reasoning a bit more explicit, how about:\n\n\"Wrap the ThrottledError in a VError so that the relevant fields appear in the audit entry of the throttled request. We translate the error to its cause before sending the response, as we don\u0027t want to expose the queue length or queue tolerance of the throttle to end users.\""}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":42,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":193,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":281,"sizeDeletions":0},{"number":"20","revision":"a791f55769dd4fb90a042ece8c75ce5058d35797","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/20","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510281499,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1510281527,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/throttle.js","line":151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":42,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":193,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":281,"sizeDeletions":0},{"number":"21","revision":"6307dca06495026c8399aea34084a24822a37a7e","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/21","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510282655,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510282682,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":42,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":194,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":282,"sizeDeletions":0},{"number":"22","revision":"8519f18831d64f8a54d43a438dc7fa73fbd30186","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/22","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512785156,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512785184,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":41,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":14,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":194,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":281,"sizeDeletions":0},{"number":"23","revision":"8d42a669c52107c96fe005064de6be2eebb68b18","parents":["a5f88038c3c740acfe1a205d0925fd909cefdd94"],"ref":"refs/changes/30/2630/23","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513973938,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513973969,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1514913294,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"lib/throttle.js","line":8,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This is annoying, but we should update the copyright year  to 2018 before this integrates (same for other files)."},{"file":"lib/throttle.js","line":80,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"CPU\""}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":52,"deletions":0},{"file":"bin/throttlestat.d","type":"ADDED","insertions":57,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":7,"deletions":0},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":362,"sizeDeletions":0},{"number":"24","revision":"e6d97a3384f2a34805c6c1291ca658136029fb5f","parents":["f0611d48d5a1ed27ef68b927f5c6bfa56b494593"],"ref":"refs/changes/30/2630/24","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515012401,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515012429,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":68,"deletions":-9},{"file":"bin/throttlestat.d","type":"ADDED","insertions":57,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/bluejoy/footer.html.in","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/bluejoy/header.html.in","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/bluejoy/media/css/restdown.css","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/internal/acuserguide.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/internal/jobs.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/auth.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/check_stream.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/dir.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":34,"deletions":-3},{"file":"lib/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/common.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/create.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/error.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/fail.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/get.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/input.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/list.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/output.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/jobs/post.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/link.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/medusa/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/medusa/routes.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/other.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/picker.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":80,"deletions":-36},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/uploads/abort.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/create.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/get.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/index.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/redirect.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/uploads/upload.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/utils.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"main.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":22,"deletions":-1},{"file":"test/ac.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/acsetup.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/auth.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/cors.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/dir.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integ.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/jobs.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/link.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/monitoring.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/abort.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/auth.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/commit.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/create.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/get.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/helper.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/redirect.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/mpu/upload.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.deps","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.node.defs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.node.targ","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.node_modules.defs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.node_modules.targ","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.node_prebuilt.defs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.node_prebuilt.targ","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.smf.defs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.smf.targ","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":547,"sizeDeletions":-124},{"number":"25","revision":"bc3309f5e3e943bbd62b81dde30e585ccb4e3388","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/30/2630/25","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515014408,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515014436,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"bin/throttlestat.d","type":"ADDED","insertions":57,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":18,"deletions":-8},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":375,"sizeDeletions":-10},{"number":"26","revision":"07c3af342f882fc4c6bcbda9d991e1ada5d863ae","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/30/2630/26","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515014604,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515014633,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"bin/throttlestat.d","type":"ADDED","insertions":57,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":18,"deletions":-6},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":375,"sizeDeletions":-8},{"number":"27","revision":"a1581d774509921e24d68f16d711225a974310b9","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/30/2630/27","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515107820,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515107848,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"bin/throttlestat.d","type":"ADDED","insertions":60,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":18,"deletions":-6},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":378,"sizeDeletions":-8},{"number":"28","revision":"0cbf5f297a47f54f6406a8fc702f0304780e397a","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/30/2630/28","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515524201,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515524230,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515540108,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"bin/throttlestat.d","type":"ADDED","insertions":60,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":373,"sizeDeletions":-3},{"number":"29","revision":"dc4f785c652e76393789d1a65603d81a59c75bbe","parents":["284af58c63c86e2d105e5bf82fd99e01a40e99b7"],"ref":"refs/changes/30/2630/29","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516300818,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515524230,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515540108,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516305675,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1516397233,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":53,"deletions":-1},{"file":"bin/throttlestat.d","type":"ADDED","insertions":60,"deletions":0},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"lib/throttle.js","type":"ADDED","insertions":205,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":20,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":373,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}