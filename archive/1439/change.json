{"project":"joyent/sdc-designation","branch":"master","id":"Ia48c7e150380b0edc9c757f3fbf00ca631248744","number":"1439","subject":"DAPI-335: Allow operator to specify a minimum free disk space threshold Reviewed by: Angela Fong \u003cangela.fong@joyent.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/1439","commitMessage":"DAPI-335: Allow operator to specify a minimum free disk space threshold\nReviewed by: Angela Fong \u003cangela.fong@joyent.com\u003e\n","createdOn":1486387946,"lastUpdated":1491292165,"open":false,"status":"MERGED","comments":[{"timestamp":1486387946,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1486387977,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486388544,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2."},{"timestamp":1486388569,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487651833,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1490179357,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1490179387,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1490313134,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 4:\n\nDon\u0027t we need to modify allocator.js as well? We would want to have this new hard filter exercised earlier in the process since the free disk data are readily available (perhaps after hard-filter-traits?)."},{"timestamp":1490590057,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1490590082,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1490590517,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 5:\n\n\u003e Don\u0027t we need to modify allocator.js as well? We would want to have\n \u003e this new hard filter exercised earlier in the process since the\n \u003e free disk data are readily available (perhaps after\n \u003e hard-filter-traits?).\n\nI\u0027m not sure what you\u0027re referring to within allocator.js -- if you\u0027re referring to the default chain, that was remove a while ago since the allocator always accepts it from cnapi. It was just another source of confusion otherwise.\n\nI have the change to cnapi waiting for this to get into master. Here\u0027s the diff: https://gist.github.com/marsell/34595b371c107138c1b28d03ba9e9dbc\n\nAnd yep, the plugin is near the top."},{"timestamp":1490889379,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 5:\n\n(1 comment)\n\n\u003e if you\u0027re referring to the default chain, that was remove a while ago since the allocator always accepts it from cnapi. It was just another source of confusion otherwise.\n\nAh ok, sorry I did misunderstand that being in use. Looking at your upcoming cnapi change clarifies that."},{"timestamp":1491212245,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 6."},{"timestamp":1491212274,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491279163,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1491292165,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"6","revision":"a48c7e150380b0edc9c757f3fbf00ca631248744","parents":["f65f2ec3fcf69b958830dae8c3e465e94e531345"],"ref":"refs/changes/39/1439/6","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1491212245,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491212274,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491279163,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491279163,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"SUBM","value":"1","grantedOn":1491292165,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/calculate-server-unreserved.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":57,"deletions":0},{"file":"lib/algorithms/shared/constants.js","type":"ADDED","insertions":13,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":177,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"f9615ec7ccef27a975f9eda0112e39b76b777c21","parents":["2eee9106262f15b6c9ef04cf68e80a29abe44273"],"ref":"refs/changes/39/1439/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1486387946,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486387977,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":54,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-5},{"number":"2","revision":"c99d2a4ae2874852c44e0dbd9f7c30988fdeaec7","parents":["2eee9106262f15b6c9ef04cf68e80a29abe44273"],"ref":"refs/changes/39/1439/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1486388544,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486388569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":54,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-5},{"number":"3","revision":"43715d3202aa0b1be93c4fe1e5f8d0cd05343bab","parents":["2fbeb8d3ba939ab952c52f389c910a46f44b3094"],"ref":"refs/changes/39/1439/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1487651833,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486388569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":54,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-5},{"number":"4","revision":"41a5307b84dbb26d05d248d3d22bfe26e6337ff3","parents":["cbcf563325b470376a7fe244bfd304763da1de87"],"ref":"refs/changes/39/1439/4","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1490179357,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486388569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":54,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-5},{"number":"5","revision":"0b013f0c7fa21f9891603dc17453ed6f9441f1e7","parents":["f65f2ec3fcf69b958830dae8c3e465e94e531345"],"ref":"refs/changes/39/1439/5","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1490590057,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486388569,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/algorithms/hard-filter-min-free-disk.js","line":36,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"I think we should apply the \"pool usable ratio\" (currently 0.94) as the operator is looking at the minimum buffer required for tenant disk usage growth, not the portion reserved for system usage. This way if we decide to adjust the pool usable ratio, user doesn\u0027t need to know about it, nor try to revise their min free disk setting to account for that, since it is really something they don\u0027t know about intimately."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":54,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-5},{"number":"6","revision":"a48c7e150380b0edc9c757f3fbf00ca631248744","parents":["f65f2ec3fcf69b958830dae8c3e465e94e531345"],"ref":"refs/changes/39/1439/6","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1491212245,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491212274,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1491292165,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491279163,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491279163,"by":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/algorithms/calculate-server-unreserved.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-disk.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/algorithms/hard-filter-min-free-disk.js","type":"ADDED","insertions":57,"deletions":0},{"file":"lib/algorithms/shared/constants.js","type":"ADDED","insertions":13,"deletions":0},{"file":"test/algorithms/hard-filter-min-disk.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-min-free-disk.test.js","type":"ADDED","insertions":98,"deletions":0},{"file":"test/allocator.test.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":177,"sizeDeletions":-6}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}]}