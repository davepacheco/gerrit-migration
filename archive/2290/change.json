{"project":"joyent/moray","branch":"master","topic":"MORAY-403","id":"I25c8aea1f723d0b1572315315c270c4713702c97","number":"2290","subject":"MORAY-403 UpdateObjects generates bad SQL for non-boolean/number/string values MORAY-406 PutObject with a null field rarely does what you expect Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/2290","commitMessage":"MORAY-403 UpdateObjects generates bad SQL for non-boolean/number/string values\nMORAY-406 PutObject with a null field rarely does what you expect\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1501107292,"lastUpdated":1504655950,"open":false,"status":"MERGED","comments":[{"timestamp":1501107292,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1501107384,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Topic set to MORAY-403"},{"timestamp":1501107468,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501777684,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)\n\nI haven\u0027t fully grokked the changes in lib/objects/common.js yet."},{"timestamp":1501779404,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1502400563,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1502400566,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1502400589,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502401475,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1503521850,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1503521929,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1504650131,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1504655877,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1504655950,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"4","revision":"25c8aea1f723d0b1572315315c270c4713702c97","parents":["0e927b03be4ddc4000cedd236dae4eb36971af39"],"ref":"refs/changes/90/2290/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1504650131,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502400589,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502401475,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504655877,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1504655950,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/objects/common.js","type":"MODIFIED","insertions":26,"deletions":-15},{"file":"lib/objects/update.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":72,"sizeDeletions":-35},"patchSets":[{"number":"1","revision":"4216fb985e14ebfa32e160c3cfe2b0c8686f5e49","parents":["d779c6f69f769791d34fbc1029e217fd3953b7d2"],"ref":"refs/changes/90/2290/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1501107292,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501107468,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":765,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This seems odd.  Can you elaborate on that?"},{"file":"docs/index.md","line":765,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve expanded on this. Let me know what you think."},{"file":"docs/index.md","line":765,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks -- that explains a lot."},{"file":"lib/errors.js","line":286,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What do you think of changing this to \"cannot store null values\"?  (It wasn\u0027t obvious to me what it would mean for an index to be nullable.)"},{"file":"lib/errors.js","line":286,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/objects/common.js","line":911,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is the purpose of this to cause us to delete \"false\" or the the empty string when we find null in the PostgreSQL column, and we weren\u0027t before?"},{"file":"lib/objects/common.js","line":911,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I initially did this because I was going to make it so that using UpdateObjects with null would remove the field, and this would make sure that false, the empty string and zero could be removed.\n\nSince after this Moray will disallow updating the field to null (at least until we have a better plan), and since you can\u0027t currently update a field to null for anything but numbers, only zeros that have been updated to null will be affected by this change. I took a look, and the only consumers of UpdateObjects are NAPI and Marlin (through batch operations). Marlin does update numbers (its timestamps) but it doesn\u0027t update them to null."},{"file":"lib/objects/common.js","line":919,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It took me a while to piece through what\u0027s changing here so I want to check my understanding.  I got these cases:\n\n(1) Array:\n   before: does nothing\n   after: if the index type is an array, clobbers value in the object with\n   what\u0027s in the column\n\n(2) Falsey non-array:\n   before: clobbers value in the object with what\u0027s in the column\n   after:  clobbers value in the object with what\u0027s in the column\n\n(3) Non-falsey non-array:\n   before: clobbers value in the object with what\u0027s in the column\n   after:  clobbers value in the object with what\u0027s in the column\n\nSo the main change is for arrays.  Previously, if you had used \u0027update\u0027 to update a column whose object value was an array, then it would always do nothing, but now it works as long as the type of the underlying index is also an array?"},{"file":"lib/objects/common.js","line":919,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Yes, that summary is correct. Before this change you couldn\u0027t update arrays though, and had to use PutObject to change those fields."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/objects/common.js","type":"MODIFIED","insertions":26,"deletions":-15},{"file":"lib/objects/update.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":64,"sizeDeletions":-35},{"number":"2","revision":"67fc83e5ba5e3b656f5009e393c0495f4fc5e28c","parents":["3370bccdbce33c2a0c3cb761511320889624bc1f"],"ref":"refs/changes/90/2290/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1502400563,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502401475,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502400589,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/objects/common.js","type":"MODIFIED","insertions":26,"deletions":-15},{"file":"lib/objects/update.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":72,"sizeDeletions":-35},{"number":"3","revision":"3d0b142c45f241544bf7455665173fcc76eaffd9","parents":["18ac3764c16fc01bbe2018179d7172690db94f18"],"ref":"refs/changes/90/2290/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1503521850,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502401475,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502400589,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/objects/common.js","type":"MODIFIED","insertions":26,"deletions":-15},{"file":"lib/objects/update.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":72,"sizeDeletions":-35},{"number":"4","revision":"25c8aea1f723d0b1572315315c270c4713702c97","parents":["0e927b03be4ddc4000cedd236dae4eb36971af39"],"ref":"refs/changes/90/2290/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1504650131,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502401475,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1504655950,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504655877,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502400589,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/objects/common.js","type":"MODIFIED","insertions":26,"deletions":-15},{"file":"lib/objects/update.js","type":"MODIFIED","insertions":18,"deletions":-20}],"sizeInsertions":72,"sizeDeletions":-35}],"allReviewers":[{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}