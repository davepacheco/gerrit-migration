commit 999cd1d1436af4e341d47e7972f6d8c7ecb4f955 (refs/changes/22/4522/2)
Author: Jason King <jason.king@joyent.com>
Date:   2018-08-07T15:02:49+00:00 (1 year, 2 months ago)
    
    OS-7079 mp_startup_common races itself

diff --git a/usr/src/uts/i86pc/os/mp_startup.c b/usr/src/uts/i86pc/os/mp_startup.c
index a881ddc3c5..fef8f2759d 100644
--- a/usr/src/uts/i86pc/os/mp_startup.c
+++ b/usr/src/uts/i86pc/os/mp_startup.c
@@ -1900,6 +1900,8 @@ mp_startup_common(boolean_t boot)
 	if (boothowto & RB_DEBUG)
 		kdi_cpu_init();
 
+	(void) mach_cpu_create_device_node(cp, NULL);
+
 	/*
 	 * Setting the bit in cpu_ready_set must be the last operation in
 	 * processor initialization; the boot CPU will continue to boot once
@@ -1907,8 +1909,6 @@ mp_startup_common(boolean_t boot)
 	 */
 	CPUSET_ATOMIC_ADD(cpu_ready_set, cp->cpu_id);
 
-	(void) mach_cpu_create_device_node(cp, NULL);
-
 	cmn_err(CE_CONT, "?cpu%d: %s\n", cp->cpu_id, cp->cpu_idstr);
 	cmn_err(CE_CONT, "?cpu%d: %s\n", cp->cpu_id, cp->cpu_brandstr);
 	cmn_err(CE_CONT, "?cpu%d initialization complete - online\n",
