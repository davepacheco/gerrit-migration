From 247ddde9e01cd4f8785e3a80296db1d89e8e858a Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Tue, 21 Aug 2018 01:25:36 -0400
Subject: [PATCH] TRITON-696 sdcadm want info subcommand

---
 CHANGES.md              |  4 +++
 lib/cli/do_info.js      | 80 +++++++++++++++++++++++++++++++++++++++++
 lib/cli/experimental.js |  2 ++
 lib/cli/index.js        |  1 -
 lib/common.js           |  6 ++++
 man/man1/sdcadm.1.ronn  | 10 ++++++
 package.json            |  2 +-
 7 files changed, 103 insertions(+), 2 deletions(-)
 create mode 100644 lib/cli/do_info.js

diff --git a/CHANGES.md b/CHANGES.md
index 8933ab3..6bb98b3 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.21.0
+
+- TRITON-696 sdcadm want info subcommand, adds `sdcadm experimental info`
+
 ## 1.20.4
 
 - TRITON-689 improve `sdcadm post-setup cmon` to not require
diff --git a/lib/cli/do_info.js b/lib/cli/do_info.js
new file mode 100644
index 0000000..24a2bd3
--- /dev/null
+++ b/lib/cli/do_info.js
@@ -0,0 +1,80 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2018, Joyent, Inc.
+ */
+
+var errors = require('../errors');
+
+/*
+ * The 'sdcadm services (svcs)' CLI subcommand.
+ */
+
+function do_info(subcmd, opts, args, callback) {
+    var self = this;
+
+    if (opts.help) {
+        this.do_help('help', {}, [subcmd], callback);
+        return;
+    } else if (args.length !== 0) {
+        callback(new errors.UsageError('too many args: ' + args));
+        return;
+    }
+
+    var cfg = self.sdcadm.config;
+
+    if (opts.json) {
+        console.log(JSON.stringify(cfg, null, 2));
+        callback();
+        return;
+    }
+
+    console.log('Datacenter Company Name: %s',
+        cfg.datacenter_company_name);
+    console.log('Datacenter Name: %s',
+        cfg.datacenter_name);
+    console.log('Datacenter Location: %s',
+        cfg.datacenter_location);
+
+    console.log();
+
+    console.log('Admin IP: %s',
+        cfg.admin_ip);
+    console.log('External IP: %s',
+        cfg.external_ip);
+    console.log('DNS Domain: %s',
+        cfg.dns_domain);
+
+    callback();
+}
+do_info.options = [
+    {
+        names: ['help', 'h'],
+        type: 'bool',
+        help: 'Show this help.'
+    },
+    {
+        names: ['json', 'j'],
+        type: 'bool',
+        help: 'JSON output'
+    }
+];
+do_info.aliases = ['config'];
+do_info.help = (
+    'Get SDC info.\n'
+    + '\n'
+    + 'Usage:\n'
+    + '     {{name}} info [<options>]\n'
+    + '\n'
+    + '{{options}}'
+);
+
+// --- exports
+
+module.exports = {
+    do_info: do_info
+};
diff --git a/lib/cli/experimental.js b/lib/cli/experimental.js
index 335df83..ecfcc5a 100644
--- a/lib/cli/experimental.js
+++ b/lib/cli/experimental.js
@@ -50,6 +50,8 @@ ExperimentalCLI.prototype.init = function init(_opts, _args, _callback) {
     Cmdln.prototype.init.apply(this, arguments);
 };
 
+ExperimentalCLI.prototype.do_info = require('./do_info').do_info;
+
 
 ExperimentalCLI.prototype.do_update_agents =
 require('./do_update_agents').do_update_agents;
diff --git a/lib/cli/index.js b/lib/cli/index.js
index 821a432..cdf896a 100644
--- a/lib/cli/index.js
+++ b/lib/cli/index.js
@@ -230,7 +230,6 @@ CLI.prototype.fini = function fini(subcmd, err, cb) {
     }
 };
 
-
 CLI.prototype.do_self_update = require('./do_self_update').do_self_update;
 
 CLI.prototype.do_instances = require('./do_instances').do_instances;
diff --git a/lib/common.js b/lib/common.js
index 4ab25c1..b495961 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -166,11 +166,17 @@ function loadConfig(options, cb) {
                     }));
                     return;
                 }
+
                 config.dns_domain = sdcConfig.dns_domain;
                 config.datacenter_name = sdcConfig.datacenter_name;
                 config.ufds_admin_uuid = sdcConfig.ufds_admin_uuid;
                 config.coal = sdcConfig.coal;
                 config.assets_admin_ip = sdcConfig.assets_admin_ip;
+                config.datacenter_location = sdcConfig.datacenter_location;
+                config.admin_ip = sdcConfig.admin_ip;
+                config.external_ip = sdcConfig.external_ip;
+                config.datacenter_company_name =
+                    sdcConfig.datacenter_company_name;
 
                 // Calculated config.
                 var dns = config.datacenter_name + '.' + config.dns_domain;
diff --git a/man/man1/sdcadm.1.ronn b/man/man1/sdcadm.1.ronn
index f887080..f353931 100644
--- a/man/man1/sdcadm.1.ronn
+++ b/man/man1/sdcadm.1.ronn
@@ -38,6 +38,16 @@ The runtime `sdcadm` configuration is loaded as follows:
 
 Help on a specific sub-command.
 
+### sdcadm info \[options\]
+
+Show SDC datacenter and node information.
+
+`-h, --help`
+    Show this help.
+
+`-j, --json`
+    JSON Output.
+
 ### sdcadm self-update \[options\]
 
 Update "sdcadm" itself.
diff --git a/package.json b/package.json
index a98d7df..f3fe66d 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.20.4",
+  "version": "1.21.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

