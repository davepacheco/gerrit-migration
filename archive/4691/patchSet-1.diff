From 02ca52dc4f716e9d6046c3d2a1dd6e76e9b5cd88 Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Wed, 15 Aug 2018 13:21:14 -0400
Subject: [PATCH] TRITON-696 sdcadm want info subcommand

---
 lib/cli/do_info.js     | 89 ++++++++++++++++++++++++++++++++++++++++++
 lib/cli/index.js       |  1 +
 lib/common.js          |  1 +
 man/man1/sdcadm.1.ronn | 10 +++++
 4 files changed, 101 insertions(+)
 create mode 100644 lib/cli/do_info.js

diff --git a/lib/cli/do_info.js b/lib/cli/do_info.js
new file mode 100644
index 0000000..3b454d9
--- /dev/null
+++ b/lib/cli/do_info.js
@@ -0,0 +1,89 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2018, Joyent, Inc.
+ */
+
+var common = require('../common');
+var errors = require('../errors');
+
+/*
+ * The 'sdcadm services (svcs)' CLI subcommand.
+ */
+
+function do_info(subcmd, opts, args, callback) {
+    var self = this;
+    var log = self.log;
+
+    if (opts.help) {
+        this.do_help('help', {}, [subcmd], callback);
+        return;
+    } else if (args.length !== 0) {
+        callback(new errors.UsageError('too many args: ' + args));
+        return;
+    }
+
+    common.loadConfig({log: log}, function (err, cfg) {
+        if (err) {
+            callback(err);
+            return;
+        }
+
+        if (opts.json) {
+            console.log(JSON.stringify(cfg, null, 2));
+            callback();
+            return;
+        }
+
+        var sdcConfig = cfg.sdc_config;
+
+        console.log('Datacenter Company Name: %s',
+            sdcConfig.datacenter_company_name);
+        console.log('Datacenter Name: %s',
+            sdcConfig.datacenter_name);
+        console.log('Datacenter Location: %s',
+            sdcConfig.datacenter_location);
+
+        console.log();
+
+        console.log('Admin IP: %s',
+            sdcConfig.admin_ip);
+        console.log('External IP: %s',
+            sdcConfig.external_ip);
+        console.log('DNS Domain: %s',
+            sdcConfig.dns_domain);
+
+        callback();
+    });
+}
+do_info.options = [
+    {
+        names: ['help', 'h'],
+        type: 'bool',
+        help: 'Show this help.'
+    },
+    {
+        names: ['json', 'j'],
+        type: 'bool',
+        help: 'JSON output'
+    }
+];
+do_info.aliases = ['config'];
+do_info.help = (
+    'Get SDC info.\n'
+    + '\n'
+    + 'Usage:\n'
+    + '     {{name}} info [<options>]\n'
+    + '\n'
+    + '{{options}}'
+);
+
+// --- exports
+
+module.exports = {
+    do_info: do_info
+};
diff --git a/lib/cli/index.js b/lib/cli/index.js
index 821a432..13de0ff 100644
--- a/lib/cli/index.js
+++ b/lib/cli/index.js
@@ -230,6 +230,7 @@ CLI.prototype.fini = function fini(subcmd, err, cb) {
     }
 };
 
+CLI.prototype.do_info = require('./do_info').do_info;
 
 CLI.prototype.do_self_update = require('./do_self_update').do_self_update;
 
diff --git a/lib/common.js b/lib/common.js
index 4ab25c1..cbcecd9 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -166,6 +166,7 @@ function loadConfig(options, cb) {
                     }));
                     return;
                 }
+                config.sdc_config = sdcConfig;
                 config.dns_domain = sdcConfig.dns_domain;
                 config.datacenter_name = sdcConfig.datacenter_name;
                 config.ufds_admin_uuid = sdcConfig.ufds_admin_uuid;
diff --git a/man/man1/sdcadm.1.ronn b/man/man1/sdcadm.1.ronn
index f887080..f353931 100644
--- a/man/man1/sdcadm.1.ronn
+++ b/man/man1/sdcadm.1.ronn
@@ -38,6 +38,16 @@ The runtime `sdcadm` configuration is loaded as follows:
 
 Help on a specific sub-command.
 
+### sdcadm info \[options\]
+
+Show SDC datacenter and node information.
+
+`-h, --help`
+    Show this help.
+
+`-j, --json`
+    JSON Output.
+
 ### sdcadm self-update \[options\]
 
 Update "sdcadm" itself.
-- 
2.21.0

