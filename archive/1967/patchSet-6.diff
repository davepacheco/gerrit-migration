From 68a86bf001dcf2ece2ab61cd77c0ca8ac43c807d Mon Sep 17 00:00:00 2001
From: Richard Bradley <richard.bradley@joyent.com>
Date: Wed, 11 Oct 2017 08:47:42 +0000
Subject: [PATCH] MANTA-3273 "manta-adm zk fixup" broken with VMs in remote DCs

---
 deps/jsstyle   | 2 +-
 lib/adm.js     | 3 ++-
 test/tst.zk.js | 2 --
 3 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/deps/jsstyle b/deps/jsstyle
index b9f5092..d75b7ca 160000
--- a/deps/jsstyle
+++ b/deps/jsstyle
@@ -1 +1 @@
-Subproject commit b9f50929ee2df140fd2d111f053b20593e068cdc
+Subproject commit d75b7ca8308be17c80e2b120f2a01d4a0c20d8a8
diff --git a/lib/adm.js b/lib/adm.js
index 9945601..3c2a117 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -3959,7 +3959,8 @@ maAdm.prototype.auditZkServers = function ()
 
 		serverUuid = zkinstance.params['server_uuid'];
 		if (!self.ma_vms.hasOwnProperty(uuid)) {
-			if (self.ma_cns[serverUuid] !== null) {
+			if (self.ma_cns.hasOwnProperty(serverUuid) &&
+			    self.ma_cns[serverUuid] !== null) {
 				validationErrors.push(new VError(
 				    'nameservice instance "%s": VM appears ' +
 				    'to have been provisioned in this ' +
diff --git a/test/tst.zk.js b/test/tst.zk.js
index bbe3d85..ccc8b84 100644
--- a/test/tst.zk.js
+++ b/test/tst.zk.js
@@ -112,8 +112,6 @@ function runTestCase(testcase, callback)
 				    'server_uuid': server_uuid
 				};
 			}
-		} else {
-			deployed.cns[server_uuid] = null;
 		}
 
 		deployed.instances[svcid].push({
-- 
2.21.0

