{"project":"joyent/sdc-manta","branch":"master","id":"I68a86bf001dcf2ece2ab61cd77c0ca8ac43c807d","number":"1967","subject":"MANTA-3273 \"manta-adm zk fixup\" broken with VMs in remote DCs Reviewed by: Dave Pacheco \u003cdap@joyent.com\u003e Approved by: Dave Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/1967","commitMessage":"MANTA-3273 \"manta-adm zk fixup\" broken with VMs in remote DCs\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1495099977,"lastUpdated":1507817354,"open":false,"status":"MERGED","comments":[{"timestamp":1495099977,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1495100032,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1495101756,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1495101801,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496311713,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1496311754,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496312027,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\nPS3 ensures that the tests match what happens in lib/adm.js. That is, ma_cns will only contain keys for servers from the AZ in which `manta-adm` is being run, whereas previously it would contain ALL servers, some of which (other AZs) being null, and in the event of a chassis swap, some of which being stale. \"deployed.cns\" in tst.zk.js now acts similarly, and `make prepush` looks good.\n\nloadCns also has a similar check for a null entry in ma_cns (https://github.com/joyent/sdc-manta/blob/48d0d723bb516d9b793a0cd3c52341b2f5868316/lib/adm.js#L1451). My understanding is that this is no longer required, but I\u0027m reluctant to remove it.\n\nTesting notes from MANTA-3273 still apply as PS3 only makes a change to the test suite, so I consider this ready for review."},{"timestamp":1500477201,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\nNow that MANTA-3275 is highly likely to be a dependency change, I\u0027m happy to put this change through on its own."},{"timestamp":1507655181,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1507655219,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1507709825,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1507709877,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1507709886,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1507709938,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n\"make check\" exited with status 2\n\n json --validate -f config/services/propeller/service.json\n json --validate -f config/services/authcache/service.json.production\n json --validate -f config/services/authcache/service.json\n json --validate -f config/services/postgres/service.json.lab\n json --validate -f config/services/postgres/service.json\n json --validate -f config/services/postgres/service.json.production\n json --validate -f config/services/medusa/service.json.production\n json --validate -f config/services/medusa/service.json\n json --validate -f config/services/marlin-dashboard/service.json\n json --validate -f config/services/marlin-dashboard/service.json.production\n json --validate -f config/services/storage/service.json\n json --validate -f config/services/storage/service.json.production\n json --validate -f config/services/storage/service.json.lab\n json --validate -f config/services/jobsupervisor/service.json.production\n json --validate -f config/services/jobsupervisor/service.json\n json --validate -f config/services/marlin/service.json.production\n json --validate -f config/services/marlin/service.json\n json --validate -f config/services/ops/service.json.production\n json --validate -f config/services/ops/service.json\n json --validate -f config/services/ops/service.json.coal\n json --validate -f config/services/webapi/service.json.production\n json --validate -f config/services/webapi/service.json\n json --validate -f config/services/webapi/service.json.coal\n json --validate -f config/services/webapi/service.json.lab\n json --validate -f config/services/nameservice/service.json\n json --validate -f config/services/nameservice/service.json.production\n json --validate -f config/services/jobpuller/service.json\n json --validate -f config/services/jobpuller/service.json.production\n json --validate -f config/services/electric-moray/service.json.production\n json --validate -f config/services/electric-moray/service.json.lab\n json --validate -f config/services/electric-moray/service.json\n json --validate -f config/services/madtom/service.json.production\n json --validate -f config/services/madtom/service.json.coal\n json --validate -f config/services/madtom/service.json\n json --validate -f manifests/applications/manta/common/manifest.json\n json --validate -f manifests/applications/manta/registrar/manifest.json\n json --validate -f manifests/applications/manta/ssh_private_key/manifest.json\n json --validate -f manifests/applications/manta/ssh_public_key/manifest.json\n json --validate -f manifests/applications/manta/dns_client/manifest.json\n json --validate -f sapi_manifests/manta/manifest.json\n deps/jsstyle/jsstyle -o doxygen cmd/manta-marlin.js cmd/manta-shardadm.js cmd/manta-deploy.js cmd/manta-adm.js cmd/manta-init.js cmd/manta-oneach.js cmd/manta-undeploy.js cmd/manta-factoryreset.js cmd/manta-replace-cert.js cmd/manta-merge-config.js lib/alarms/maint_windows.js lib/alarms/alarms.js lib/alarms/amon_objects.js lib/alarms/index.js lib/alarms/config.js lib/alarms/metadata.js lib/alarms/update.js lib/oneach/oneach.js lib/oneach/cli.js lib/deploy.js lib/services.js lib/instance_info.js lib/ssh.js lib/common.js lib/adm.js lib/ssl.js lib/layout.js lib/sdc.js test/tst.adm.js test/tst.oneach_cli.js test/common.js test/tst.adm_show.js test/tst.oneach_formatters.js test/tst.oneach_cmd.js test/tst.stripe.js test/alarms/tst.amon_objects.js test/alarms/tst.config.js test/alarms/tst.metadata_files.js test/alarms/tst.update.js test/alarms/tst.metadata_basic.js test/alarms/tst.alarms.js test/alarms/tst.maint_windows.js test/alarms/mock_amon.js test/CollectorStream.js test/tst.zk.js test/tst.layout.js test/tst.oneach_exec.js test/tst.services.js networking/validate.js\n Unescaped left brace in regex is deprecated, passed through in regex; marked by \u003c-- HERE in m/\\S{ \u003c-- HERE / at deps/jsstyle/jsstyle line 666.\n test/alarms/tst.maint_windows.js: 120: literal string using double-quote instead of single\n test/alarms/tst.maint_windows.js: 149: literal string using double-quote instead of single\n test/alarms/tst.maint_windows.js: 153: literal string using double-quote instead of single\n test/alarms/tst.maint_windows.js: 157: literal string using double-quote instead of single\n test/alarms/tst.maint_windows.js: 169: literal string using double-quote instead of single\n tools/mk/Makefile.targ:209: recipe for target \u0027check-jsstyle\u0027 failed\n gmake: *** [check-jsstyle] Error 1"},{"timestamp":1507711751,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1507712636,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7: Published edit on patch set 6."},{"timestamp":1507712692,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1507712941,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 8: Commit message was updated."},{"timestamp":1507713210,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 8:\n\nI can\u0027t say I understand how the rebase was clean but the message update saw a change in the jsstyle dependency version. Heading over to github I can see jsstyle is at b9f5092, but somehow I\u0027ve managed to change this to an ancient d75b7ca. Perhaps somehow I had this checked out to the ancient version while working on another project, and a rebase wasn\u0027t enough to push this change?\n\nThe submodule on my machine does in fact appear to be checked out at d75, so I checked that out to b9f and attempted to push again (I had to change something so that gerrit would see a difference, so I changed the message back), but this didn\u0027t seem to fix anything.\n\nIn any case, I\u0027ve used the Gerrit UI to remove that dep change, and I\u0027ve used the UI to change the commit message, too.\n\nDave, sorry for the noise here. I can see this has re-added your +1s and the change looks like it was prior to my mess. I\u0027d appreciate your eyes on this to see if there\u0027s anything I\u0027ve missed, though!"},{"timestamp":1507737349,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 8:\n\nJust based on the diff against \"base\", I think this is probably okay."},{"timestamp":1507817354,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"8","revision":"0635d02aa3323a23aa645a6b0d3e97efda8b7da3","parents":["8bfc42425fbf37ddcd2e6f1dc916d0c58f5b62cc"],"ref":"refs/changes/67/1967/8","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1507712941,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496311754,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507655181,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655219,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1507817354,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":2,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"5d51b051212d62a2588f28563646fdcecc531796","parents":["b4abfc8d0002640430e9beabb19f9de6a9b13607"],"ref":"refs/changes/67/1967/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1495099977,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495100032,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":1,"sizeDeletions":-1},{"number":"2","revision":"7d3a92941994addecd73c17b2ae3d6766324612b","parents":["b4abfc8d0002640430e9beabb19f9de6a9b13607"],"ref":"refs/changes/67/1967/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1495101756,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495101801,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":2,"sizeDeletions":-1},{"number":"3","revision":"897ad34140b8efc65aff9693795fcf5d667525ed","parents":["b4abfc8d0002640430e9beabb19f9de6a9b13607"],"ref":"refs/changes/67/1967/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1496311713,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507655181,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655219,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496311754,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":2,"sizeDeletions":-3},{"number":"4","revision":"0fcba2dc609049b201e84a2998159f20e545e641","parents":["8bfc42425fbf37ddcd2e6f1dc916d0c58f5b62cc"],"ref":"refs/changes/67/1967/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1507709825,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507655181,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655219,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496311754,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":2,"sizeDeletions":-3},{"number":"5","revision":"8ca762fef84f9d205dcb4a94ec74b0831d72fd3e","parents":["8bfc42425fbf37ddcd2e6f1dc916d0c58f5b62cc"],"ref":"refs/changes/67/1967/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1507709886,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1507709938,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":3,"sizeDeletions":-4},{"number":"6","revision":"68a86bf001dcf2ece2ab61cd77c0ca8ac43c807d","parents":["8bfc42425fbf37ddcd2e6f1dc916d0c58f5b62cc"],"ref":"refs/changes/67/1967/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1507711751,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1507709938,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"deps/jsstyle","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":3,"sizeDeletions":-4},{"number":"7","revision":"99fa4128dfcbdfcf901b9ee891f6be27229cf032","parents":["8bfc42425fbf37ddcd2e6f1dc916d0c58f5b62cc"],"ref":"refs/changes/67/1967/7","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1507712636,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507655181,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655219,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496311754,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":2,"sizeDeletions":-3},{"number":"8","revision":"0635d02aa3323a23aa645a6b0d3e97efda8b7da3","parents":["8bfc42425fbf37ddcd2e6f1dc916d0c58f5b62cc"],"ref":"refs/changes/67/1967/8","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1507712941,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507655181,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507655219,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496311754,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1507817354,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":0,"deletions":-2}],"sizeInsertions":2,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}