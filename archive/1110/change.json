{"project":"joyent/node-manta","branch":"master","id":"I730d88e2bfe8d89fd386164afac35ef768decef2","number":"1110","subject":"joyent/node-manta#296 add client encryption support","owner":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"url":"https://cr.joyent.us/1110","commitMessage":"joyent/node-manta#296 add client encryption support\n","createdOn":1481582740,"lastUpdated":1490300797,"open":true,"status":"NEW","comments":[{"timestamp":1481582740,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 1."},{"timestamp":1481582765,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481583804,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1481585461,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1481585492,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1483552815,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 3."},{"timestamp":1483552847,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483564152,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(5 comments)\n\nWyatt,\n\nThanks. That\u0027s just a start. I haven\u0027t read through the actual encryption/decryption code yet, nor run the test suite."},{"timestamp":1483737042,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 4."},{"timestamp":1483737071,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1483737188,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 5."},{"timestamp":1483737224,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483989857,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1483994396,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 7."},{"timestamp":1483994432,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484022056,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 8."},{"timestamp":1484022088,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484042331,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 8:\n\n(21 comments)\n\nI took an initial look at this.  I haven\u0027t really any experience with the crypto stuff, so it\u0027d be good to make sure somebody like Alex Wilson takes a look at that."},{"timestamp":1484069942,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1484070268,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 9."},{"timestamp":1484070315,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484088106,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 10."},{"timestamp":1484088138,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484089913,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 11."},{"timestamp":1484089949,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484095168,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 11:\n\n(11 comments)"},{"timestamp":1484162693,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 12."},{"timestamp":1484162739,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484259680,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 13."},{"timestamp":1484259716,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484259983,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 14."},{"timestamp":1484260013,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484261407,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 15."},{"timestamp":1484261443,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484338591,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 16."},{"timestamp":1484338621,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484349422,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 17."},{"timestamp":1484349454,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484597954,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 17:\n\n(20 comments)\n\nWyatt,\n\nI\u0027m running out of steam on this review round, so I want to get these comments out now. I\u0027ll have another email with some Qs about this code and the RFD as well."},{"timestamp":1484771163,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 18."},{"timestamp":1484771187,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1484774062,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 19."},{"timestamp":1484774091,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1484777430,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 20."},{"timestamp":1484777455,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1484780638,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 21."},{"timestamp":1484780681,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 21: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484863965,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 22."},{"timestamp":1484864007,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 22: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484868041,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 21:\n\n(6 comments)\n\nLooking good. Still waiting for AEAD support, right? Perhaps that is patchset 22 which came in while I was reviewing patchset 21."},{"timestamp":1484870220,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 22:\n\n(3 comments)\n\nIt woudl be good to see some sample code (doesn\u0027t need to be in the regular test suite) that demostrated doing enc/dec of a large file (multi-MB up to 1GB) to/from manta."},{"timestamp":1484871137,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 23."},{"timestamp":1484871168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 23: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484940150,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 24."},{"timestamp":1484940191,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 24: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485271504,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 25."},{"timestamp":1485271530,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 25: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485284874,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 26."},{"timestamp":1485284905,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 26: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485291174,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 27."},{"timestamp":1485291220,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 27: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485291914,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 28."},{"timestamp":1485291950,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 28: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485300330,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 29."},{"timestamp":1485300364,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 29: CI-Testing-1\n\n(5 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1485303580,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 30."},{"timestamp":1485303613,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 30: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485362163,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 31."},{"timestamp":1485362209,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 31: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485375247,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 32."},{"timestamp":1485375288,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 32: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485377712,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 33."},{"timestamp":1485377869,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 33: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485390492,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 34."},{"timestamp":1485390523,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 34: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485451857,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 35."},{"timestamp":1485451888,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 35: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485476950,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 35:\n\n(4 comments)\n\n# play notes\n\n```\nexport MANTA_ENCRYPTION_KEY_BYTES\u003d$(echo -n aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa | base64)\nexport MANTA_CLIENT_ENCRYPTION_KEY_ID\u003da\nexport MANTA_ENCRYPTION_ALGORITHM\u003dAES256/GCM/NoPadding\necho \u0027hi there\u0027 \u003e hello.txt\nmpath\u003d~~/stor/tmp/enc/hello.txt\nmmkdir -p ~~/stor/tmp/enc\n\nmput -f hello.txt $mpath --encrypt\nminfo $mpath\nmget $mpath\n```\n\n# review notes\n\n- It would be nice to have more consistent envvar prefixes. Perhaps use\n  `MANTA_ENCRYPT_` is the prefix for all of them:\n        MANTA_ENCRYPT_KEY   (I dropped the \"_BYTES\")\n        MANTA_ENCRYPT_KEY_ID\n        MANTA_ENCRYPT_ALGORITHM\n\n- Likewise for the CLI options. Perhaps:\n        -E, --encrypt\n        --encrypt-key\n        --encrypt-key-id\n        --encrypt-algorithm\n    \n- I\u0027m unable to mget an encrypted file without all the params to decrypt it:\n\n        $ unset MANTA_ENCRYPTION_ALGORITHM\n        $ unset MANTA_ENCRYPTION_KEY_BYTES\n        $ unset MANTA_CLIENT_ENCRYPTION_KEY_ID\n        $ mget $mpath\n        mget: VError: failed executing options.getKey: --enc_key or MANTA_ENCRYPTION_KEY_BYTES not found\n\n    I wonder if there should be a \u0027-E,--encrypt\u0027 option for \u0027mget\u0027, just as\n    there is for \u0027mput\u0027. There could be a matching MANTA_ENCRYPT\u003d1 envvar\n    to allow turning that on all the time.\n\n- Should have a test case for authMode.\n\n- Should there be a guard on size of metadata to encrypt/decrypt?\n\n- Should enc alg be case-insensitive?\n    $ mput -f hello.txt /trent.mick/stor/tmp/enc/hello.txt --encrypt --enc_alg aes128/gcm/nopadding --enc_key secret --enc_keyid a\n    mput: Error: Unsupported cipher algorithm: aes128/gcm/nopadding\n\n- Error for key length:\n    $ mput -f hello.txt /trent.mick/stor/tmp/enc/hello.txt --encrypt --enc_alg AES128/GCM/NoPadding --enc_key secret --enc_keyid a\n    mput: Error: Invalid key length\n  What is a valid key length? It would be helpful if the error message caught\n  this and gave details for the given alg.\n  \n- Should we have \u0027m-encrypt-metadata*\u0027 headers when no extra \u0027e-*\u0027 metadata\n  is given? Using my play notes below:\n  \n        $ minfo $mpath\n        ...\n        m-encrypt-metadata-iv: +p9UN620NurC/h06D4fuVg\u003d\u003d\n        m-encrypt-metadata-aead-tag-length: 16\n        m-encrypt-metadata: EXDfHe6JKFennviGmq3F7nBxvx0lV2f3chEl3nPsEdAzFTbA/nDuq7Lt\n        ...\n\n  My guess is this has something to do with the e-content-type handling.\n  However, if no content-type is specified with the mput, I think we should\n  have no value there. This shows that mput doesn\u0027t send a content-type\n  header:\n\n        $ mput -v -f hello.txt $mpath --encrypt 2\u003e \u003e(bunyan)\n        [2017-01-27T00:16:41.902Z] DEBUG: mput/MantaClient/27470 on danger0.local (/Users/trentm/joy/node-manta/lib/client.js:1149 in info): info: entered (req_id\u003d740cd83f-3143-4d55-98be-d41fa33ea2bc, path\u003d/trent.mick/stor/tmp/enc/hello.txt, id\u003d740cd83f-3143-4d55-98be-d41fa33ea2bc, query\u003d{}, encrypt\u003d{})\n            headers: {\n              \"accept\": \"application/json, */*\",\n              \"x-request-id\": \"740cd83f-3143-4d55-98be-d41fa33ea2bc\"\n            }\n        [2017-01-27T00:16:41.958Z] TRACE: mput/MantaClient/27470 on danger0.local (/Users/trentm/joy/node-manta/node_modules/restify-clients/lib/HttpClient.js:314 in rawRequest): request sent\n            HEAD /trent.mick/stor/tmp/enc/hello.txt HTTP/1.1\n            Host: us-east.manta.joyent.com\n            accept: application/json, */*\n            x-request-id: 740cd83f-3143-4d55-98be-d41fa33ea2bc\n            date: Fri, 27 Jan 2017 00:16:41 GMT\n            authorization: Signature keyId\u003d\"/trent.mick/keys/...\n            user-agent: restify/1.4.1 (x64-darwin; v8/4.5.103.43; OpenSSL/1.0.2j) node/4.7.0\n            accept-version: ~1.0\n        ...\n    \n- e-content-type isn\u0027t being handled properly. I added the following patch\n  to mget to dump the response headers:\n\n        diff --git a/bin/mget b/bin/mget\n        index 33e3338..c5561a8 100755\n        --- a/bin/mget\n        +++ b/bin/mget\n        @@ -160,6 +160,8 @@ function printEntry(obj) {\n                 client.get(p, function (err, stream, res) {\n                     ifError(err);\n        \n        +           console.log(\u0027XXX res.headers\u0027, res.headers);\n        +\n                     var bar;\n                     var src \u003d stream;\n                     if (opts.progress || drawProgressBar) {\n    \n  and:\n    \n        $ mput -f hello.txt $mpath  -H content-type:foo/bar --encrypt\n        $ mget $mpath\n        XXX res.headers { etag: \u00273fbfc5ba-8a5b-65fb-ec3e-b429dd3322aa\u0027,\n          \u0027last-modified\u0027: \u0027Fri, 27 Jan 2017 00:21:11 GMT\u0027,\n          \u0027m-encrypt-aead-tag-length\u0027: \u002716\u0027,\n          \u0027m-encrypt-plaintext-content-length\u0027: \u00279\u0027,\n          \u0027m-encrypt-type\u0027: \u0027client/1\u0027,\n          \u0027m-encrypt-key-id\u0027: \u0027a\u0027,\n          \u0027m-encrypt-iv\u0027: \u0027wQqitWFDHSw8JX1NvMDcrA\u003d\u003d\u0027,\n          \u0027m-encrypt-cipher\u0027: \u0027AES256/GCM/NoPadding\u0027,\n          \u0027accept-ranges\u0027: \u0027bytes\u0027,\n          \u0027content-type\u0027: \u0027application/octet-stream\u0027,\n          \u0027content-md5\u0027: \u0027F9XUK9Nd14ys4b/Tk/S2ag\u003d\u003d\u0027,\n          \u0027content-length\u0027: \u002725\u0027,\n          \u0027durability-level\u0027: \u00272\u0027,\n          date: \u0027Fri, 27 Jan 2017 00:21:27 GMT\u0027,\n          server: \u0027Manta\u0027,\n          \u0027x-request-id\u0027: \u0027f0b758c1-a820-4bcb-a191-c9bc20d451ac\u0027,\n          \u0027x-response-time\u0027: \u002723\u0027,\n          \u0027x-server-name\u0027: \u002707188c71-5cb5-497c-b5ed-3e82654aa9d0\u0027,\n          connection: \u0027keep-alive\u0027,\n          \u0027x-request-received\u0027: 1485476486721,\n          \u0027x-request-processing-time\u0027: 411,\n          \u0027e-content-type\u0027: \u0027undefined\u0027,\n          \u0027\u0027: undefined }\n        hi there\n  \n  a few things:\n  - The \"content-type: foo/bar\" isn\u0027t restored.\n  - There is the bogus `\u0027\u0027: undefined` entry.\n  - \u0027e-content-type\u0027: \u0027undefined\u0027 shouldn\u0027t be there either."},{"timestamp":1485823656,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 35:\n\nWoudl also be good if the new test files used a self-identifying subdir for test files:\n\n```\n[trent.mick@172.26.1.149 /trent.mick/stor]$ ls\nencrypted\nmetadata\nnode-manta-test-mfind-072df349\ntodecrypt-aead\ntodecrypt-metadata\ntodecrypt-range\ntodecrypt_getKey\n```\n\nNote that the mfind test uses a \u0027node-manta-test-\u0027-prefixed dir for its created files."},{"timestamp":1487718129,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 36."},{"timestamp":1487718154,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 36: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487725366,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 36:\n\nWyatt,\n\nLet me know if/when you\u0027d like me to review again. Given that we are on patchset 36 :) I\u0027ll wait until there is a little bit of a steady state."},{"timestamp":1487788224,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 37."},{"timestamp":1487788264,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 37: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488843177,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 37:\n\n(3 comments)\n\n[RFD 71]\n\u003e m-encrypt-type doesn\u0027t exist or doesn\u0027t have the value \u0027client/VERSION\u0027, in\n\u003e which case the object is assumed not to be encrypted, and the usual processing\n\u003e of the file occurs, without decryption. In the event that the version isn\u0027t\n\u003e supported by the client, it should not try to decrypt the file and should\n\u003e return the encrypted form of the file.\n\nIf there is a file with `m-encrypt-type: client/42`, i.e. that matches the\n\"client/VER\" scheme, but isn\u0027t supported by the client... and the user has\nexplicitly request encryption be done (via whatever option or env)...\nperhaps we want that to fail? I agree that if it is some other scheme\n`m-encrypt-type: foo/42`, then we should ignore it.\n\nThe RFD states that we error out if m-encrypt-cipher isn\u0027t a supported cipher.\nI\u0027d think we want to error for an unsupported client/VER as well.\n\nEither way, the node-manta docs (README and/or man page, and docs) should\nstate the current support \"client/VER\" version supported.\n\n* * *\n\n- Doc additions are necessary to explain CSE usage and options. E.g., hmacType\n  and authMode aren\u0027t documented anywhere.\n\n- It would be nice to have a better error message for encryption key length error:\n\n    $ MANTA_ENCRYPT_KEY\u003dasdf mput -f hello ~~/stor/tmp/enc/hello --encrypt\n    mput: Error: Invalid key length\n\n- \"hmacType\" is not exposed to the CLI.\n\n- \"authMode\" is not exposed to mget.\n\n- Should there be a guard on size of metadata to encrypt/decrypt?\n\n- mget/mput suggested changes: I\u0027ve made a patch, mainly to mget and mput,\n  for some suggested changes:\n  https://gist.github.com/trentm/5c778fe4eead4a58232e2c2dbc6096ed\n    - use the \u0027env\u0027 option to option processing\n    - A *start* at changing from \"--encrypt-algorithm\" to \"--encrypt-cipher\",\n      to match the internal name. Only a \"start\" because I haven\u0027t changed\n      the man page files.\n    - Add \"mget --include\" option (a la curl\u0027s -i/--include) to dump the\n      headers. This allows seeing the decrypted `e-*` headers.\n    - Put CSE options into an option group.\n    - \"-e\" short option for mput\u0027s \"--encrypt\"\n    - Add a \"--decrypt, -e\" option to \"mget\" and make decryption explicit and\n      *off* by default. That then matches \"mput\" behaviour: explicit, off by\n      default.\n    - Rephrase the \"NODE_MAJOR\" stuff in lib/cse.js\n\n\n- mget: content-length is not restored after decryption, nor is the plaintext\n  content-md5 (re)stored. Do we *want* to?\n    RFD says: \"SDKs may overwrite the value of Content-Length returned from the\n    client API with the value of m-encrypt-plaintext-content-length.\"\n    It doesn\u0027t mention content-md5."},{"timestamp":1490030921,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 38."},{"timestamp":1490030953,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 38: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490049548,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 38:\n\n(9 comments)\n\n# from patchset 37\n\n- behaviour for m-encrypt-type:client/42\n\n    [RFD 71]\n    \u003e m-encrypt-type doesn\u0027t exist or doesn\u0027t have the value \u0027client/VERSION\u0027, in\n    \u003e which case the object is assumed not to be encrypted, and the usual processing\n    \u003e of the file occurs, without decryption. In the event that the version isn\u0027t\n    \u003e supported by the client, it should not try to decrypt the file and should\n    \u003e return the encrypted form of the file.\n\n    If there is a file with `m-encrypt-type: client/42`, i.e. that matches the\n    \"client/VER\" scheme, but isn\u0027t supported by the client... and the user has\n    explicitly request encryption be done (via whatever option or env)...\n    perhaps we want that to fail? I agree that if it is some other scheme\n    `m-encrypt-type: foo/42`, then we should ignore it.\n\n    The RFD states that we error out if m-encrypt-cipher isn\u0027t a supported cipher.\n    I\u0027d think we want to error for an unsupported client/VER as well.\n\n    Either way, the node-manta docs (README and/or man page, and docs) should\n    state the current support \"client/VER\" version supported.\n\n- Doc additions are necessary to explain CSE usage and options. E.g., hmacType\n  and authMode aren\u0027t documented anywhere.\n\n- It would be nice to have a better error message for encryption key length error:\n\n        $ MANTA_ENCRYPT_KEY\u003dasdf mput -f hello ~~/stor/tmp/enc/hello --encrypt\n        mput: Error: Invalid key length\n\n- Should there be a guard on size of metadata to encrypt/decrypt?\n\n- mget: content-length is not restored after decryption, nor is the plaintext\n  content-md5 (re)stored. Do we *want* to?\n  RFD says: \"SDKs may overwrite the value of Content-Length returned from the\n  client API with the value of m-encrypt-plaintext-content-length.\"\n  It doesn\u0027t mention content-md5.\n\n# patchset 38\n\n- RFD and java-manta use \"AES128/GCM/NoPadding\" as opposed to\n  \"AES128/GCM/NOPADDING\". It would be nice (for grepping,\n  readability, interop) to stick to that capitalization in the node-manta code\n  instead of all caps.\n\n- java-manta (per its README.md) has a different take on envvars. It would be\n  nice to coordinate those.\n\n    | java-manta                     | node-manta           |\n    | ------------------------------ | -------------------- |\n    | MANTA_CLIENT_ENCRYPTION        | (no equiv)           |\n    | MANTA_CLIENT_ENCRYPTION_KEY_ID | MANTA_ENCRYPT_KEY_ID |\n    | MANTA_ENCRYPTION_ALGORITHM     | MANTA_ENCRYPT_CIPHER |\n    | MANTA_UNENCRYPTED_DOWNLOADS    | (no equiv)           |\n    | MANTA_ENCRYPTION_AUTH_MODE     | MANTA_ENCRYPT_AUTH_MODE |\n    | MANTA_ENCRYPTION_KEY_PATH      | (no equiv)           |\n    | MANTA_ENCRYPTION_KEY_BYTES     | MANTA_ENCRYPT_KEY    |\n    | (no equiv)                     | MANTA_ENCRYPT_HMAC   |\n\n    A few questions here for java-manta:\n\n    1. Does using java-manta as a *library* pick up `MANTA_` environment\n       variables by default? If so, is that avoidable when using java-manta?\n       IMHO, an app that uses a library (like java-manta) as an implementation\n       detail shouldn\u0027t respond to envvars with `MANTA_`.\n    2. Would java-manta consider and would it be possible to change the names\n       of some of these envvars? To (a) get java-manta and node-manta to\n       use the same name for the same thing, (b) get a common prefix for all\n       encryption-related envvars, and (c) possibly switch to the shorter\n       `MANTA_ENCRYPT_` prefix that node-manta is currently using. (a) and\n       (b) are more important than (c).\n    3. `_CIPHER` instead of `_ALGORITHM`? The RFD calls these things \"ciphers\"\n        https://github.com/joyent/rfd/blob/master/rfd/0071/README.md#supported-ciphers\n    4. `MANTA_ENCRYPTION_ALGORITHM` has a default. In my experience that leads\n       to maintenance problems down the road. Admittedly that may be a long\n       road. Specifically, what happens if/when the default (currently\n       \"AES128/CTR/NoPadding\") is considered insecure. We can\u0027t change the\n       default without breaking code, and then we are forced (without a\n       major ver bump) to ship code that is \"insecure\" by default. Is there\n       harm is not having a default? I.e. force the user to learn about the\n       ciphers and choose one.\n\n    Are you able to follow up with whoever is handling the java-manta work\n    (is that ElijahZ)?\n\n- java-manta has `manta.permit_unencrypted_downloads\u003dfalse` by default. The\n  somewhat equivalent for node-manta\u0027s *CLI* is that if `mget -e` is used to\n  explicitly use encryption, then should it error by default if the downloaded\n  file is *not* encrypted?\n\n- I wonder if `mput --encrypt-hmac HMAC ...` should be `--encrypt-hmac-type`\n  to be clearer.\n\n- node-manta authMode input handling could be more strict. Currently:\n\n        $ MANTA_ENCRYPT_AUTH_MODE\u003dasdf mget -e --include $mpath\n        XXX isStrictMode false\n        ...\n\n  Some suggestions in a patch: https://gist.github.com/trentm/dbd0e09a43d6da2bdd2964583bce094d\n\n- There should be tests around authMode\u003dOptionalAuthentication and range GETs.\n  Currently I suspect that isn\u0027t working: it\u0027ll fail on checking the HMAC."},{"timestamp":1490122984,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 39."},{"timestamp":1490123013,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 39: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1490123209,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 40."},{"timestamp":1490123240,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 40: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490215506,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 40:\n\n(2 comments)\n\nLooks like patchset 39-40 only partially worked through comments on patchset 38. Please let me know when you\u0027ve finished working through them all."},{"timestamp":1490299087,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 41."},{"timestamp":1490299118,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 41: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490299128,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Patch Set 41: Code-Review+1\n\n(50 comments)"},{"timestamp":1490300740,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Uploaded patch set 42."},{"timestamp":1490300777,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 42: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490300784,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Patch Set 42: Code-Review+1"},{"timestamp":1490300797,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Patch Set 42: -Code-Review\n\nQuestion\n  mget: content-length is not restored after decryption, nor is the plaintext\n  content-md5 (re)stored. Do we *want* to?\n  RFD says: \"SDKs may overwrite the value of Content-Length returned from the\n  client API with the value of m-encrypt-plaintext-content-length.\"\n  It doesn\u0027t mention content-md5.\n\nAnswer\n  This will require the headers to be displayed after the file contents. \n  The content-type is changed, but after the response body is decrypted. \n  I vote to not break the current behavior.\n\n--------------------------------------------------------------------------------\n\nQuestion\n  java-manta has `manta.permit_unencrypted_downloads\u003dfalse` by default. The\n  somewhat equivalent for node-manta\u0027s *CLI* is that if `mget -e` is used to\n  explicitly use encryption, then should it error by default if the downloaded\n  file is *not* encrypted?\n\nAnswer\n  I vote to keep the current implementation and not error when a file isn\u0027t \n  encrypted. Otherwise, each client/person must make an extra request for anything\n  they aren\u0027t sure is encrypted... currently they can just pass along their key \n  and get back the original file, even if the file isn\u0027t encrypted. \n\n--------------------------------------------------------------------------------\n\nQuestion\n  I wonder if `mput --encrypt-hmac HMAC ...` should be `--encrypt-hmac-type`\n  to be clearer.\n\nAnswer\n  --encrypt-hmac is inline with --encrypt-cipher, as opposed to \n  --encrypt-cipher-algorithm to distinguish it from --encrypt-cipher-text"}],"currentPatchSet":{"number":"42","revision":"730d88e2bfe8d89fd386164afac35ef768decef2","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/42","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1490300740,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490300777,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/mget","type":"MODIFIED","insertions":76,"deletions":-3},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-1},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":26,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":77,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":81,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":641,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":295,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1922,"sizeDeletions":-24},"patchSets":[{"number":"1","revision":"586ee054449cdc1021a583c03175850e098dc2b9","parents":["2462227c5febc83b68a69c7790f7b69c8b9ebc78"],"ref":"refs/changes/10/1110/1","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1481582740,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481582765,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481583804,"by":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":238,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":54,"deletions":-53},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0}],"sizeInsertions":354,"sizeDeletions":-58},{"number":"2","revision":"9337444a1ca382f47d3c94db0b109833ba0dd109","parents":["be679872d17f9ff5405d0351866691788cec2f60"],"ref":"refs/changes/10/1110/2","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1481585461,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481582765,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481583804,"by":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":238,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":54,"deletions":-53},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0}],"sizeInsertions":354,"sizeDeletions":-58},{"number":"3","revision":"35f8462addd8e0d40e5028a6407884ef6428cc98","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/3","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1483552815,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483552847,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"/COMMIT_MSG","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can an issue be added for this work, please?"},{"file":"/COMMIT_MSG","line":8,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Fixed: https://cr.joyent.us/#/c/1110/6//COMMIT_MSG"},{"file":"lib/client.js","line":11,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is there a need for adding this dep?\n\n- \u0027b64.encode\u0027 is just buff.toString(\u0027base64\u0027), which could be used directly\n- \u0027b64.decode\u0027 *does* look like an implementation. Is there a reason to use this implementation vs. node\u0027s own? E.g.,\n\n    \u003e s \u003d \u0027the quick ☃  Лорем ипсум\u0027\n    \u0027the quick ☃  Лорем ипсум\u0027\n    \u003e encoded \u003d new Buffer(s, \u0027utf8\u0027).toString(\u0027base64\u0027)\n    \u0027dGhlIHF1aWNrIOKYgyAg0JvQvtGA0LXQvCDQuNC/0YHRg9C8\u0027\n    \u003e decoded \u003d new Buffer(encoded, \u0027base64\u0027).toString(\u0027utf8\u0027)\n    \u0027the quick ☃  Лорем ипсум\u0027"},{"file":"lib/client.js","line":11,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"I am using this implementation because I maintain it, have full test coverage on it, and it will work well with streams if we get to that point. I am happy to remove though if you think it\u0027s overkill."},{"file":"lib/client.js","line":836,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is it agreed that we want to ignore a m-encrypt-support header that is of a type that we don\u0027t support?"},{"file":"lib/client.js","line":908,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I would love to see all the encryption-specific stuff move to a separate file, e.g. \"cse.js\". Then that file could have a nice top-block-comment that explained the basics of CSE quickly and pointed to RFD 71."},{"file":"lib/client.js","line":993,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"indentation"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":238,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0}],"sizeInsertions":301,"sizeDeletions":-5},{"number":"4","revision":"55ebc7992f31fdb5eb90faf70d63e666f6798147","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/4","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1483737042,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1483737071,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cse.js","line":76,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"},{"file":"lib/cse.js","line":184,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"lib/cse.js","type":"ADDED","insertions":222,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0}],"sizeInsertions":314,"sizeDeletions":-5},{"number":"5","revision":"d528c75b9aa7c69d6337a06a512562794da0e698","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/5","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1483737188,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483737224,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"lib/cse.js","type":"ADDED","insertions":222,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0}],"sizeInsertions":314,"sizeDeletions":-5},{"number":"6","revision":"193a28a8657fa2e37d411b6ac6aee56ef76448cb","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/6","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1483989857,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483737224,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"lib/cse.js","type":"ADDED","insertions":222,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0}],"sizeInsertions":314,"sizeDeletions":-5},{"number":"7","revision":"eac4222b366582966e31d38ec7c19f2681b5ef2f","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/7","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1483994396,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483994432,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":33,"deletions":-5},{"file":"lib/cse.js","type":"ADDED","insertions":237,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0},{"file":"test/cse.test.js","type":"ADDED","insertions":38,"deletions":0}],"sizeInsertions":371,"sizeDeletions":-5},{"number":"8","revision":"b94b8806a579a3eea9dda577032e88c6ec04e731","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/8","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484022056,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484022088,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":179,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think these option names might be a bit confusing.  It seems like \"key\" and \"keyId\" might be confused with the HTTP signature auth (SSH key) options in other places.  The \"cipher\" option might conceivably be confused with a TLS option.\n\nCould we prefix these options with something like \"encrypt\" or perhaps \"cse\"?"},{"file":"lib/client.js","line":179,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d be totally cool blessing the name/prefix \"cse\" in docs and exposed options."},{"file":"lib/client.js","line":1865,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It doesn\u0027t seem like this block changed, except for the added braces.  It\u0027s best (from a \"git blame\" perspective) to minimise diff noise like this."},{"file":"lib/client.js","line":1877,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"First up, the indentation here seems a bit off -- the file looks to be four spaces, but this seems to be two spaces?\n\nAlso, I don\u0027t think this function actually returns a value, so please put the return statements _after_ the callback; e.g.\n\n    if (...) {\n        cse.encrypt(... {\n            if (err) {\n                cb(err);\n                return;\n            }\n            \n            doPut(...);\n        });\n        return;\n    }"},{"file":"lib/client.js","line":1879,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"The \"return\" statement here is superfluous."},{"file":"lib/cse.js","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This file really, really needs some pretty extensive block comments that describe the format of the encrypted object stored in Manta, as well as documentation about all of the headers.  The encrypted metadata format should be described as well."},{"file":"lib/cse.js","line":50,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"With each of these, I think the message string can just be the name of the option; e.g.\n\n    assert.func(options.getKey, \u0027options.getKey\u0027);\n\nThe \"assert-plus\" module formats the message appropriately; e.g. the above will trip with:\n\n    \"options.getKey (function) is required\"\n\nSee also: https://github.com/mcavage/node-assert-plus/blob/30dd5d0/assert.js#L23"},{"file":"lib/cse.js","line":50,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":54,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This function doesn\u0027t appear to be returning a value, so please move the \"return\" statement down after the call to cb().  Ditto for L58, L60, L65, etc.  i.e.,\n\n    if (invalidHeaders) {\n        cb(...);\n        return;\n    }"},{"file":"lib/cse.js","line":54,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":80,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"See comments below about avoiding \"removeAllListeners()\"."},{"file":"lib/cse.js","line":80,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":81,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"See comments below about VError wrapping here."},{"file":"lib/cse.js","line":81,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":89,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"See comments below about avoiding \"removeAllListeners()\"."},{"file":"lib/cse.js","line":89,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":90,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"See comments below about VError wrapping here."},{"file":"lib/cse.js","line":90,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":93,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It seems like we\u0027re waiting for the entire file to finish being decrypted before we return the output stream to the caller.  Is that right?\n\nIf so, where does all of the decrypted data sit?  Is it just building up in the stream buffers?  Why doesn\u0027t backpressure kick in and stop the stream from flowing?  What happens if I download a 2GB encrypted file using this mechanism?"},{"file":"lib/cse.js","line":93,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"That is the current implementation. We will need to make sure that this works with the range header as well, which is to say that the implementation isn\u0027t 100% done.\n\nDo we have any tests for large files that exist? If not, we should also add large file tests for the normal/unencrypted stream methods."},{"file":"lib/cse.js","line":110,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It looks like \"decryptMetadata()\" can potentially call this callback with an error object, but we\u0027re not doing anything with it here.  Should we be?"},{"file":"lib/cse.js","line":110,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":119,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As a global constant, it\u0027d be better to name this: \"REQUIRED_HEADERS\"."},{"file":"lib/cse.js","line":119,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":184,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"See comment above on \"assert-plus\" messages."},{"file":"lib/cse.js","line":184,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":188,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would not use \"assert.ok()\" for this, but rather explicitly throw an error.  If the user has set \"NODE_NDEBUG\" in the environment, many (if not all) versions of \"assert-plus\" will just not check the assertion."},{"file":"lib/cse.js","line":188,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":202,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As a general rule, it\u0027s best to avoid the use of \"removeAllListeners()\", especially without any arguments.  Some Node classes attach internal housekeeping event handlers that are responsible for cleaning up resources like file descriptors, and \"removeAllListeners()\" will remove those too.\n\nInstead, I would remove only the specific listeners you added, or explicitly unpipe/destroy/etc the streams here."},{"file":"lib/cse.js","line":202,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":203,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It would be good to wrap this error in a VError object that includes some context about the operation, e.g.\n\n    cb(new VError(err, \u0027encrypted upload of \"%s\": cipher error\u0027, path));\n\n(You\u0027d need to pass the object path for that to work, but I think it would be worth it.)"},{"file":"lib/cse.js","line":203,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":222,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Consider a VError here with some context as well."},{"file":"lib/cse.js","line":222,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":229,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It seems like in both cases here, we\u0027re encrypting the entire input stream before returning the encrypted output stream to the caller.  Is that true?  If so, I have the same questions about this as for \"decrypt()\"."},{"file":"lib/cse.js","line":229,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Replied above."},{"file":"lib/cse.js","line":272,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This should perhaps use \"hasOwnProperty()\" on \"CIPHERS\" to avoid matching things on the Object prototype, such as \"valueOf\"."},{"file":"lib/cse.js","line":272,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":33,"deletions":-5},{"file":"lib/cse.js","type":"ADDED","insertions":273,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0},{"file":"test/cse.test.js","type":"ADDED","insertions":144,"deletions":0}],"sizeInsertions":513,"sizeDeletions":-5},{"number":"9","revision":"ca1d7b1422e807db1735b56b350abbd056948a46","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/9","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484070268,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484070315,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":34,"deletions":-4},{"file":"lib/cse.js","type":"ADDED","insertions":286,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0},{"file":"test/cse.test.js","type":"ADDED","insertions":144,"deletions":0}],"sizeInsertions":527,"sizeDeletions":-4},{"number":"10","revision":"fd53dbc9fed92f23b828502367b105b16ca8721f","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/10","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484088106,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484088138,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":34,"deletions":-4},{"file":"lib/cse.js","type":"ADDED","insertions":305,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0},{"file":"test/cse.test.js","type":"ADDED","insertions":144,"deletions":0}],"sizeInsertions":546,"sizeDeletions":-4},{"number":"11","revision":"201e7793ac7eff82d6992f94db06abecde5ef5a8","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/11","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484089913,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484089949,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":179,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Apologies for waffling: I\u0027d like to change my opinion w.r.t using the \"cse\" prefix. Given that the headers are \"m-encrypt-*\", I think the exposed options should be:\n\nencryptKeyId\nencryptKey\nencryptGetKey\n\netc."},{"file":"lib/client.js","line":843,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be nice to be able to specify the \"cse_getKey\" on the MantaClient constructor. Then one could:\n\n    client \u003d manta.createClient({\n        user: this.user,\n        // ...\n        cse_getKey: getMyEncryptionKey\n    });\n    \n    // All `client.get\u0027s` would now decrypt without me having to pass around the\n    // ref to `getMyEncryptionKey`.\n\nHere is a (untested) starter patch to the current patchset 11 code to enable that:\n\nhttps://gist.github.com/trentm/ec5a27360ac4b4e913f5e3736fd1090e\n\n\nThe \"!\u003d\u003d undefined\" check would allow one to pass `options.cse_getKey: null` to `client.get` to disable decryption for just that call. There may be better suggestions on how to have that expressed.\n\nIf this sounds reasonable, then I think we could do that same for encryption: allow specifying the encryption options (keyId, key, etc.) in the manta.createClient."},{"file":"lib/client.js","line":843,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Updated in patch 12: https://cr.joyent.us/#/c/1110/12/lib/client.js\n\nI will update the other options to support being set in the constructor of the client"},{"file":"lib/cse.js","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Per earlier comments, this file needs a top block-comment explaining the\nfile\u0027s scope and the basics of CSE, likely referring to the spec. It might\nmake sense to remove the \"Node.js SDK implementation\" section from RFD 71\nand put the implementation spec in this file\u0027s top-comment, and client user\ndocs in the README.md"},{"file":"lib/cse.js","line":9,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is in node 0.10 and that is our min-engine. So we can drop this if-block."},{"file":"lib/cse.js","line":9,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"mind if I fix this in other modules as well? I saw another comment about not adding more churn than we need... but I agree with you that we need to fix issues like this."},{"file":"lib/cse.js","line":13,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Drop \u0027b64\u0027 module usage per earlier comments."},{"file":"lib/cse.js","line":13,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"This will be done in patch 15."},{"file":"lib/cse.js","line":16,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This whole section of requires could be the following (Just get VError directly, don\u0027t need `verror`. Alphabetical order.):\n\n    var assert \u003d require(\u0027assert-plus\u0027);\n    var crypto \u003d require(\u0027crypto\u0027);\n    var PassThrough \u003d require(\u0027stream\u0027).PassThrough;\n    var VError \u003d require(\u0027verror\u0027).VError;"},{"file":"lib/cse.js","line":16,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"What is our standard for require ordering and shortcuts? I was following the style in client.js"},{"file":"lib/cse.js","line":45,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, this accepts \"1blahblahblah\"\n\n    \u003e parseInt(\u00271asdfa\u0027, 10)\n    1\n\nI think it would be nice to have a method in this module that validates the \u0027m-encrypt-type\u0027 header matches a regex, e.g.:\n\n    /^(\\w_-)+\\/(\\d+)\\.(\\d+)$/"},{"file":"lib/cse.js","line":45,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":51,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This function still has the streaming issue that jclulow commented on."},{"file":"lib/cse.js","line":51,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"This is fixed in the most recent patch."},{"file":"lib/cse.js","line":53,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Should there be an assert for \u0027res\u0027?"},{"file":"lib/cse.js","line":53,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":101,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Parens in wrong place here."},{"file":"lib/cse.js","line":101,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":194,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think we shouldn\u0027t set a value on \u0027headers\u0027 until after the MAC check is done."},{"file":"lib/cse.js","line":194,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":34,"deletions":-4},{"file":"lib/cse.js","type":"ADDED","insertions":311,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":62,"deletions":0},{"file":"test/cse.test.js","type":"ADDED","insertions":160,"deletions":0}],"sizeInsertions":568,"sizeDeletions":-4},{"number":"12","revision":"3d91bdba9c0bf43d5a3bd3d1255e8f2c7e7d6edc","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/12","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484162693,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484162739,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":822,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Thoughts on the comment I had that doing an \u0027undefined\u0027 check would allow the caller to disable decryption for a particular call? (Actually, if we do allow this kind of mechanism via `client.get(..., {cse_getKey: null}, ...)` then I think a check using `opts.hasOwnProperty(\u0027cse_getKey\u0027)` would be better.  That same comment I had before about perhaps choosing a more explicit additional boolean option to \"do encryption work or not\" might still be preferred).\n\nAlso, doing a typeof\u003d\u003d\u003dfunction check here will mean that incorrectly passing in some other type of thing (i.e. a programming error) will silently be ignored."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":38,"deletions":-4},{"file":"lib/create_client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":311,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":110,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":160,"deletions":0}],"sizeInsertions":622,"sizeDeletions":-6},{"number":"13","revision":"e7300d49f9b4bbdb37a407cd416c3101c64bb6d5","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/13","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484259680,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484259716,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cipher_stream.js","type":"ADDED","insertions":72,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":38,"deletions":-4},{"file":"lib/create_client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":314,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/cipher_stream.test.js","type":"ADDED","insertions":104,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":114,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":159,"deletions":0}],"sizeInsertions":804,"sizeDeletions":-6},{"number":"14","revision":"9503572c67b8e76831519c8e0a81a1d419393307","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/14","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484259983,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484260013,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cipher_stream.js","type":"ADDED","insertions":72,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":38,"deletions":-4},{"file":"lib/create_client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":315,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/cipher_stream.test.js","type":"ADDED","insertions":104,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":114,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":159,"deletions":0}],"sizeInsertions":805,"sizeDeletions":-6},{"number":"15","revision":"d37e65598fde9e7af215951ba0c38a9e2d5bee8b","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/15","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484261407,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484261443,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cipher_stream.js","type":"ADDED","insertions":72,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":38,"deletions":-4},{"file":"lib/create_client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":317,"deletions":0},{"file":"test/cipher_stream.test.js","type":"ADDED","insertions":104,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":114,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":159,"deletions":0}],"sizeInsertions":806,"sizeDeletions":-6},{"number":"16","revision":"42097fa366228ccaf30e773bbfda094db0a80eeb","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/16","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484338591,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484338621,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cipher_stream.js","type":"ADDED","insertions":72,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":65,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":319,"deletions":0},{"file":"test/cipher_stream.test.js","type":"ADDED","insertions":104,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":122,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":860,"sizeDeletions":-9},{"number":"17","revision":"89727ca565eac15cde7952017806728ecd35acff","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/17","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484349422,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484349454,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cipher_stream.js","line":1,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Apparently from some lawyer-y interaction, jclulow learned there are issues with the \"(c)\" and the \"All rights reserved.\" such that we want the form to be something like:\n\n    Copyright 2017 Joyent, Inc."},{"file":"lib/cipher_stream.js","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: alpha order for imports please."},{"file":"lib/cipher_stream.js","line":7,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps a better name for this class would be something like ParseEncryptThenMacStream or ParseEtMStream\n(https://en.wikipedia.org/wiki/Authenticated_encryption#Encrypt-then-MAC_.28EtM.29)."},{"file":"lib/cipher_stream.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"assert.\u003ctype\u003e calls for the args would be great."},{"file":"lib/client.js","line":174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We shouldn\u0027t be morphing the passed in `opts` and `userOpts` in here. It is just about building the merged `options` and returning that."},{"file":"lib/client.js","line":174,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/client.js","line":186,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"typo\n\nAlso, what is the \u0027hmac\u0027 option used for? I don\u0027t recognize that from earlier patchsets."},{"file":"lib/client.js","line":186,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/client.js","line":515,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should have a comment about options.encrypt here.\nAlso, we want it to effectively default to \"false\" right?"},{"file":"lib/client.js","line":515,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"The default will be to not set encrypt, which won\u0027t disable encryption."},{"file":"lib/client.js","line":528,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This\u0027ll break if options.encrypt isn\u0027t specified, right?"},{"file":"lib/client.js","line":528,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"fixed"},{"file":"lib/client.js","line":548,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This doesn\u0027t default to false if options.encrypt isn\u0027t specified. It *should* though, right?"},{"file":"lib/client.js","line":548,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"false indicates that you want to disable encryption, so it will default to an empty object, meaning use whatever is passed to get/put"},{"file":"lib/client.js","line":553,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think this could be simplified to:\n\nif (options.encrypt) {\n    assert.optionalFunc(options.encrypt.getKey, \u0027options.encrypt.getKey\u0027);\n}\n\nAnd then in that if-block we could add asserts for the other options.encrypt object fields."},{"file":"lib/client.js","line":553,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/client.js","line":860,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be nice to move parsing details of the m-encrypt-type header into the cse.js file."},{"file":"lib/client.js","line":860,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/client.js","line":1896,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Replace with just `options.encrypt`?"},{"file":"lib/client.js","line":1896,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/client.js","line":1897,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be preferable to do assert checking on options.encrypt.keyId at the top of client.put and then here we\u0027d just need to check:\n\n    if (options.encrypt \u0026\u0026 options.encrypt.keyId) {"},{"file":"lib/client.js","line":1897,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/create_client.js","line":122,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The RFD has a m-encrypt-hmac-type header now (it used to be m-encrypt-hmac I believe). Is that what this option is about? If so, I\u0027d suggest it be called \u0027hmacType\u0027 to follow the header naming."},{"file":"lib/create_client.js","line":122,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":95,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be better if these errors were before the async call to options.getKey(). I.e. it is a shame to have some possibly pausing/slow/expensive/prompting action when things are just going to fail for some basic data type/format error afterwards."},{"file":"lib/cse.js","line":95,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":166,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Need a block comment doc\u0027ing the options."},{"file":"lib/cse.js","line":166,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":167,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps the only options to this one should be the \u0027encrypt\u0027 object. Instead of it being \u0027options.encrypt.FOO\u0027 it would be \u0027options.FOO\u0027.\n\nThat would correlate better with cse.decrypt which takes `options.getKey`.  Ah, I see that would be a bit of a pain given other options like \u0027options.contentLength\u0027. Perhaps *cse.decrypt* could change to take `options.encrypt.FOO` to match."},{"file":"lib/cse.js","line":167,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"I simplified this on the encrypt side, see what you think."},{"file":"lib/cse.js","line":174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Missing. assert for options.contentLength used below."},{"file":"lib/cse.js","line":174,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":206,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could this just be an assert? If this test fails, then it is a programming error in this constants in this module."},{"file":"lib/cse.js","line":206,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cipher_stream.js","type":"ADDED","insertions":62,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":66,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":372,"deletions":0},{"file":"test/cipher_stream.test.js","type":"ADDED","insertions":105,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":122,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":906,"sizeDeletions":-9},{"number":"18","revision":"f4245997d39bc6b486e561aedbbf601913076b63","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/18","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484771163,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1484771187,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":555,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"},{"file":"lib/cse.js","line":301,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: empty statement or extra semicolon"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":417,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":69,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":122,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":165,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":103,"deletions":0}],"sizeInsertions":958,"sizeDeletions":-9},{"number":"19","revision":"09bd28b04820bb42f3be7cdf228bbc962947b38d","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/19","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484774062,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1484774091,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":555,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"},{"file":"lib/cse.js","line":301,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: empty statement or extra semicolon"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":71,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":417,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":69,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":122,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":165,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":103,"deletions":0}],"sizeInsertions":956,"sizeDeletions":-9},{"number":"20","revision":"0abb1cf41bc94b34ecc872fa6265b2c5c04f13b1","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/20","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484777430,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1484777455,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":555,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"},{"file":"lib/cse.js","line":331,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: empty statement or extra semicolon"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":71,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":447,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":69,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":122,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":165,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":103,"deletions":0}],"sizeInsertions":986,"sizeDeletions":-9},{"number":"21","revision":"315a97e42a13a97c50b4c4feb16adf584de20bd4","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/21","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484780638,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484780681,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":170,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: this allows null and empty string. Validation of falsey values is such a pain with JS. :)\n\nIt would be nice to assert the types of any userOpts.encrypt fields in this function, assuming that won\u0027t be done in the methods calling `createOptions`."},{"file":"lib/client.js","line":170,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"That is considered not set in this case, which will default the value to an object on line 173."},{"file":"lib/client.js","line":183,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t believe this handles options.encrypt properly yet.\nUsing a test enc.js (https://gist.github.com/trentm/c453ec712d0a8cdb42de93d646681706) which is an extract of createOptions here, the results are:\n\n```\n$ node enc.js\n--\nopts: {}\nuserOpts: {}\nencrypt: { cipher: undefined,\n  keyId: undefined,\n  key: undefined,\n  getKey: undefined,\n  hmacType: undefined }\n--\nopts: { encrypt: false }\nuserOpts: { encrypt: false }\nencrypt: false\n--\nopts: { encrypt: false }\nuserOpts: { encrypt: { cipher: \u0027foo\u0027 } }\nencrypt: false\n```\n\nThe third one is definitely wrong: the userOpts.encrypt should win here.\n\nThe first case is contrived, but it would be nice to not result in an object with undefined properties."},{"file":"lib/client.js","line":183,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"The third case is someone explicitly saying that they don\u0027t want encryption enabled for the entire client instance that they create. Therefore, any attempts to set it with user options will be ignored.\n\nIn the first case what values would you like to see?"},{"file":"lib/client.js","line":528,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Still need to remove this assert. I\u0027d expect this would break some of the test suite, no?"},{"file":"lib/client.js","line":548,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This defaults to {}, not false. I\u0027d be inclined to have it\ndefault to `this.encrypt \u003d false`."},{"file":"lib/client.js","line":548,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"false indicates that you want to disable encryption entirely, in this case not-setting the options mean that you don\u0027t care if encryption is enabled or not."},{"file":"lib/cse.js","line":220,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"There are other supported ciphers, right? If so, I think we should be pointing at whereever the authoritative source of supported ciphers will be. Dunno if that\u0027ll be in node-manta or the RFD or somewhere else."},{"file":"lib/cse.js","line":237,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should be the string \u0027options.headers\u0027."},{"file":"lib/cse.js","line":237,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"good catch! seems like assert needs to assert their arguments"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":71,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":447,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":69,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":122,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":165,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":103,"deletions":0}],"sizeInsertions":986,"sizeDeletions":-9},{"number":"22","revision":"9a33cfd0d02fc68ba4d144aabbe99381a7a15e1c","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/22","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484863965,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484864007,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cse.js","line":169,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"Only called for AEAD ciphers.\""},{"file":"lib/cse.js","line":169,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Done"},{"file":"lib/cse.js","line":172,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Delaying the piping to `output` until we\u0027ve parsed the full ciphertext breaks streaming large files, no?\n\nI haven\u0027t played with this (or with node\u0027s crypto.Decipher), but from the docs is sounds like we want to stream through to the `output` stream, and when we get the auth tag call `setAuthTag` before `decipher.final()` is called. I don\u0027t know if we need to call decipher.final() manually (and in a try/catch to trap an auth tag error).\n\nHave you got this to work for you?"},{"file":"lib/cse.js","line":172,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"Working on this update now. Yesterday was getting it to work in general."},{"file":"lib/cse.js","line":229,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"AEAD"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":71,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":493,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":76,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":171,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":359,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":143,"deletions":0}],"sizeInsertions":1322,"sizeDeletions":-9},{"number":"23","revision":"3595d52ce99c6c76b6114d766a33d5a95da7bad2","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/23","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484871137,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484871168,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":74,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":505,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":76,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":238,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":384,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":143,"deletions":0}],"sizeInsertions":1430,"sizeDeletions":-9},{"number":"24","revision":"c07411fd04156eaff8228833f1b7cd0859931944","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/24","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1484940150,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484940191,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":510,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":91,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":238,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":382,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":143,"deletions":0}],"sizeInsertions":1447,"sizeDeletions":-9},{"number":"25","revision":"51eddc859f7dff96a5ac235f78f4a7de0d708026","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/25","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485271504,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485271530,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":513,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":91,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":266,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":382,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":143,"deletions":0}],"sizeInsertions":1478,"sizeDeletions":-9},{"number":"26","revision":"fe312cdb448ff03909b706aeaeb543028afb0254","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/26","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485284874,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485284905,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":511,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1480,"sizeDeletions":-9},{"number":"27","revision":"43cfd83ec0bef3eb6e1611c29a7e6f5a92dc31e2","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/27","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485291174,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485291220,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":509,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1478,"sizeDeletions":-9},{"number":"28","revision":"11ddb233a177e543c6a69f9874facfdae6d8a2a0","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/28","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485291914,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485291950,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":509,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1478,"sizeDeletions":-9},{"number":"29","revision":"5a38848140a4d2cebbac28db3f219cba1a485077","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/29","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485300330,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1485300364,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/mget","line":176,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"},{"file":"lib/cse.js","line":214,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: handlePassthroughData"},{"file":"lib/cse.js","line":214,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: passthrough"},{"file":"lib/cse.js","line":215,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: handlePassthroughEnd"},{"file":"lib/cse.js","line":215,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: passthrough"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":520,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1504,"sizeDeletions":-9},{"number":"30","revision":"e030ac9733820ed9085e46a3a6bcba9fad1c367f","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/30","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485303580,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485303613,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":520,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1504,"sizeDeletions":-9},{"number":"31","revision":"c708d2d2a8cac294a30490918d46ae2b343ce170","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/31","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485362163,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485362209,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":520,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1504,"sizeDeletions":-9},{"number":"32","revision":"2e960731fee547004358757199e5af8ba2688930","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/32","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485375247,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485375288,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":21,"deletions":0},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-5},{"file":"lib/client.js","type":"MODIFIED","insertions":73,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":529,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1574,"sizeDeletions":-14},{"number":"33","revision":"f4be0d87cf3ed4c4b7d91250de662d6506d253a5","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/33","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485377712,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485377869,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":21,"deletions":0},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-5},{"file":"lib/client.js","type":"MODIFIED","insertions":75,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":529,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":377,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1576,"sizeDeletions":-14},{"number":"34","revision":"68e3fbfeeb9fa7d50ac28163a501f48269c93bf5","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/34","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485390492,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485390523,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":21,"deletions":0},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-5},{"file":"lib/client.js","type":"MODIFIED","insertions":75,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":582,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1684,"sizeDeletions":-14},{"number":"35","revision":"358670baacb38ad1cb31e6d9f5fd6455a1296b08","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/35","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1485451857,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485451888,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":1898,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t think \u0027createOptions\u0027 adds a \u0027options.contentType\u0027."},{"file":"lib/cse.js","line":126,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"is"},{"file":"lib/cse.js","line":494,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"indentation"},{"file":"lib/parse_etm_stream.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"authTag\" or \"tag\""}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":21,"deletions":0},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-5},{"file":"lib/client.js","type":"MODIFIED","insertions":75,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":577,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":286,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1679,"sizeDeletions":-14},{"number":"36","revision":"601c2f831722617cc95378d0101cbaaff9ff19c1","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/36","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1487718129,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487718154,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":21,"deletions":0},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-5},{"file":"lib/client.js","type":"MODIFIED","insertions":76,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":578,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":296,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1692,"sizeDeletions":-14},{"number":"37","revision":"fb27da5013fbbb3e306c3e7e978f1f0ad3052b13","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/37","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1487788224,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487788264,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/mput","line":274,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The changes here are wrong. The `onPut` doesn\u0027t get called until the upload has completed."},{"file":"lib/cse.js","line":398,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This code will accidentally support \u0027client/1/blah\u0027. You could add the strsplit dep (https://github.com/davepacheco/node-strsplit) and use:\n\n    var parts \u003d strsplit(headers[\u0027m-encrypt-type\u0027], \u0027/\u0027, 2);"},{"file":"lib/parse_etm_stream.js","line":1,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"A nit on the name: I wonder if that is no longer about EtM, so my bad on that\nname suggestion. After that, appending authTag for AEAD was added, so really\nthis is now more generically about parsing off a suffix number of bytes from a\nstream."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":20,"deletions":0},{"file":"bin/mput","type":"MODIFIED","insertions":56,"deletions":-5},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":21,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":78,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":585,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":296,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1740,"sizeDeletions":-23},{"number":"38","revision":"87e21864c3067d672f3b390bf302f20547c567cd","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/38","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1490030921,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490030953,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/mget","line":49,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"MODE\" would be fine to keep it shorter, I think.\n\nSee patch."},{"file":"bin/mget","line":50,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is wrong, IIUC. Authenticating is about the authTag (for AEAD) and the separate HMAC (i.e. the \"M\" in \"EtM\") for non-AEAD ciphers.\n\nSee patch."},{"file":"bin/mget","line":52,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This help string should list the other option, \"OptionalAuthentication\", as well.\n\nSee patch."},{"file":"bin/mput","line":53,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We should show valid values for this here."},{"file":"docs/man/mput.md","line":59,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\" CIPHER\""},{"file":"docs/man/mput.md","line":65,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Capitalize \"KEY\""},{"file":"docs/man/mput.md","line":65,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"this is inconsistent with the other options (login, file)"},{"file":"lib/cse.js","line":244,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t think we want to skip this error on authMode\u003dOptionalAuthentication. IIUC, the intent is to allow things like Range requests, where we don\u0027t have the full text with which to do authentication. However, if we *can*, then we should."},{"file":"lib/cse.js","line":254,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ditto for isStrictMode node a few lines earlier."},{"file":"lib/cse.js","line":322,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be nice if this returned valid hmacType values. Perhaps change getHmacType to throw an error with these details (it is the function that knows how to list them)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":61,"deletions":-3},{"file":"bin/mput","type":"MODIFIED","insertions":54,"deletions":-1},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":26,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":75,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":77,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":590,"deletions":0},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":296,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1845,"sizeDeletions":-22},{"number":"39","revision":"603936ab620bb370733696d5b13a7b1701ebe164","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/39","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1490122984,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1490123013,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/mget","line":69,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"},{"file":"lib/cse.js","line":598,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer hmac hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":77,"deletions":-3},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-1},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":26,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":76,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":81,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":635,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":295,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1914,"sizeDeletions":-23},{"number":"40","revision":"f0fa45c9333a5f87ada848390dea37832d3a08a6","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/40","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1490123209,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490123240,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/mget","line":37,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh, obviously this was incomplete."},{"file":"docs/man/mput.md","line":59,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"not answered from previous review."},{"file":"docs/man/mput.md","line":59,"reviewer":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"message":"the other options are lowercase"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":77,"deletions":-3},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-1},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":26,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":76,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":81,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":635,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":295,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1914,"sizeDeletions":-23},{"number":"41","revision":"e7645984ebe130b643183cb1359d7b151bb91529","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/41","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1490299087,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490299118,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1490299128,"by":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"bin/mget","type":"MODIFIED","insertions":76,"deletions":-3},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-1},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":26,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":76,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":81,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":641,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":295,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1920,"sizeDeletions":-23},{"number":"42","revision":"730d88e2bfe8d89fd386164afac35ef768decef2","parents":["23cee39e13cf3f08bdff749b7a1e9720b23df564"],"ref":"refs/changes/10/1110/42","uploader":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"createdOn":1490300740,"author":{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490300777,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/mget","type":"MODIFIED","insertions":76,"deletions":-3},{"file":"bin/mput","type":"MODIFIED","insertions":55,"deletions":-1},{"file":"docs/man/mget.md","type":"MODIFIED","insertions":26,"deletions":-9},{"file":"docs/man/mput.md","type":"MODIFIED","insertions":77,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":81,"deletions":-7},{"file":"lib/create_client.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/cse.js","type":"ADDED","insertions":641,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/parse_etm_stream.js","type":"ADDED","insertions":89,"deletions":0},{"file":"test/client.test.js","type":"MODIFIED","insertions":295,"deletions":-1},{"file":"test/cse.test.js","type":"ADDED","insertions":432,"deletions":0},{"file":"test/parse_etm_stream.test.js","type":"ADDED","insertions":134,"deletions":0}],"sizeInsertions":1922,"sizeDeletions":-24}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Wyatt Preul","email":"wpreul@gmail.com","username":"geek"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}