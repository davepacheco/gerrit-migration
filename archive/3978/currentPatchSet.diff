From f768bf7a5565ab0d9f45b3eeef4f6f83acbcc4f7 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 29 Jun 2018 16:40:25 -0700
Subject: [PATCH] TRITON-52 x-DC image copy Reviewed by: Trent Mick
 <trentm@gmail.com> Approved by: Trent Mick <trentm@gmail.com>

---
 docs/index.md            | 116 +++++++++++++++++++++++++++++++++++++--
 lib/account.js           |   5 ++
 lib/datacenters.js       |   3 +
 lib/datasets.js          |  54 +++++++++++++++++-
 package.json             |   4 +-
 test/datacenters.test.js |   1 +
 6 files changed, 174 insertions(+), 9 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index c50ab7e..d82e469 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -881,24 +881,27 @@ future CloudAPI backward incompatible changes (always done with a *major*
 version bump) don't break your application.
 
 The [`triton` tool](https://github.com/joyent/node-triton) uses
-`Accept-Version: ~8||~7` by default. Users can restrict the API version via the
+`Accept-Version: ~9||~8` by default. Users can restrict the API version via the
 `triton --accept-version=RANGE ...` option. The older `sdc-*` tools from
-node-smartdc similarly use `~8||~7` by default, and users can restrict the API
+node-smartdc use `~8||~7` by default, and users can restrict the API
 version via the `SDC_API_VERSION=RANGE` environment variable or the
 `--api-version=RANGE` option to each command.
 
+# Ping
+
 The set of supported *API versions* is given in the ping endpoint:
 
-    GET /ping
+    GET /--ping
     accept: application/json
     accept-version: ~8
     ...
 
     HTTPS/1.1 200 OK
-    server: cloudapi/8.3.0
+    server: cloudapi/9.2.0
     content-type: application/json
     ...
     api-version: 8.0.0
+    Triton-Datacenter-Name: us-west-1
 
     {
         "ping": "pong",
@@ -913,11 +916,19 @@ The set of supported *API versions* is given in the ping endpoint:
         }
     }
 
+Note that a `Triton-Datacenter-Name` response header was added in 9.2.0.
 
 # Versions
 
 The section describes API changes in CloudAPI versions.
 
+## 9.2.0
+
+- Added new ImportImageFromDatacenter API method to allow an image to be copied
+  to another datacenter in the same cloud.
+- Added a `Triton-Datacenter-Name` response header to [Ping](#Ping) and
+  [ListDatacenters](#ListDatacenters) responses.
+
 ## 9.1.0
 
 - Added [Clone Image](#CloneImage). This can be used to create a your own copy
@@ -3162,6 +3173,8 @@ Provides a list of all datacenters this cloud is aware of.
 An object where the keys are the datacenter name, and the value is the URL
 endpoint of that datacenter's CloudAPI.
 
+Note that a `Triton-Datacenter-Name` response header was added in 9.2.0.
+
 **Field**       | **Type** | **Description**
 --------------- | -------- | ---------------
 $datacentername | URL      | location of the datacenter
@@ -3203,7 +3216,8 @@ or
     Connection: Keep-Alive
     Content-MD5: Ju6/xjora7HcwoGG8a8CyA==
     Date: Thu, 21 Jan 2016 05:29:22 GMT
-    Server: Joyent Triton 8.0.0
+    Server: cloudapi/8.0.0
+    Triton-Datacenter-Name: us-west-1
     Api-Version: 8.0.0
     Request-Id: ec8bd1a0-bfff-11e5-acb9-49a3959d8bb3
     Response-Time: 958
@@ -3837,6 +3851,97 @@ or
     }
 
 
+## ImportImageFromDatacenter (POST /:login/images?action=import-from-datacenter)
+
+This will copy the image with `id` from the source `datacenter` into this
+datacenter. The copied image will retain all fields (e.g. `id`, `published_at`)
+as the original image. All incremental images in the origin chain will also be
+copied.
+
+You can use [triton datacenters](#ListDatacenters) to view the list of
+datacenter names in the current cloud.
+
+### Inputs
+
+The following query parameters are required, these parameters will be used to
+identify the image to be copied.
+
+**Field**  | **Type** | **Description**
+---------  | -------- | ---------------
+datacenter | String   | The datacenter name from where the image will be copied from.
+id         | UUID     | The id of the image to be copied.
+
+### Returns
+
+On success, an Image object is returned. See [GetImage](#GetImage) for the
+fields that are returned in the image object.
+
+### Errors
+
+For general errors, see [CloudAPI HTTP Responses](#cloudapi-http-responses).
+Some typical and specific errors for this endpoint:
+
+**Error Code** | **Description**
+-------------- | ---------------
+ImageUuidAlreadyExistsError | The image with `id` already exists in this datacenter.
+UnauthorizedError | If the source image is owned by the admin.
+OriginIsNotActiveError | If one of the incremental (origin) images is not activated.
+
+
+<!-- TODO: integrate these errors into the general table above -->
+
+### Example CLI Command
+
+    $ triton image copy 7eed8e50-e452-428d-9131-bf056aa911bd us-west-1
+
+#### Example HTTP Request
+
+    POST /my/images?action=import-from-datacenter&datacenter=us-west-1&id=7eed8e50-e452-428d-9131-bf056aa911bd HTTP/1.1
+    Authorization: ...
+    Host: api.example.com
+    Accept: application/json
+    Api-Version: ~9
+
+    {}
+
+#### Example HTTP Response
+
+    HTTP/1.1 201 Created
+    Content-Type: application/json
+    Content-Length: 125
+    Access-Control-Allow-Origin: *
+    Access-Control-Allow-Headers: Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, Api-Version, Response-Time
+    Access-Control-Allow-Methods: GET, HEAD, POST
+    Access-Control-Expose-Headers: Api-Version, Request-Id, Response-Time
+    Connection: Keep-Alive
+    Content-MD5: 2sEZ45LmhRiretMPn5sqVA==
+    Date: Thu, 21 Jan 2018 08:00:09 GMT
+    Server: cloudapi/9.2.0
+    Api-Version: 9.0.0
+    Request-Id: 49af23b0-f952-11e2-8f2c-fff0ec35f4ce
+    Response-Time: 460
+
+    {
+      "id": "7eed8e50-e452-428d-9131-bf056aa911bd",
+      "name": "myimage",
+      "version": "1.4.0",
+      "os": "smartos",
+      "requirements": {},
+      "type": "zone-dataset",
+      "description": "A custom image used to test stuff.",
+      "files": [
+        {
+          "compression": "gzip",
+          "sha1": "3bebb6ae2cdb26eef20cfb30fdc4a00a059a0b7b",
+          "size": 110742036
+        }
+      ],
+      "published_at": "2015-02-28T10:50:42Z",
+      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
+      "public": false,
+      "state": "active"
+    }
+
 ## UpdateImage (POST /:login/images/:id?action=update)
 
 Updates metadata about an image.
@@ -10609,6 +10714,7 @@ Sample code for generating the `Authorization` header (and `Date` header):
 [sdc-updatemachinemetadata](#UpdateMachineMetadata)|-|Allows you to update the metadata for a given instance.
 [sdc-user](#users)|-|Add, update and remove account users and their keys.
 -|trion image clone|Clone a shared image.
+-|[triton image copy](#ImportImageFromDatacenter)|Copy an image into another DC.
 -|triton info|Print an account summary.
 -|triton instance ip|Print the primary IP of the given instance.
 -|triton instance ssh|SSH to the primary IP of an instance.
diff --git a/lib/account.js b/lib/account.js
index fc8b0d0..4428318 100644
--- a/lib/account.js
+++ b/lib/account.js
@@ -19,6 +19,8 @@ var restify = require('restify');
 var InvalidArgumentError = restify.InvalidArgumentError;
 
 function get(req, res, next) {
+    assert.ok(req.config, 'req.config');
+
     if (req.params.account === '--ping') {
         var data = {
             ping: 'pong',
@@ -33,6 +35,9 @@ function get(req, res, next) {
         //    data.eight = true;
         //}
 
+        // Include a header to show the current datacenter name.
+        res.header('Triton-Datacenter-Name', req.config.datacenter_name);
+
         res.send(data);
         return next();
     }
diff --git a/lib/datacenters.js b/lib/datacenters.js
index 895b595..27457fc 100644
--- a/lib/datacenters.js
+++ b/lib/datacenters.js
@@ -43,6 +43,9 @@ function list(req, res, next) {
     var log = req.log,
         datacenters = req.config.datacenters || {};
 
+    // Include a header to show the current datacenter name.
+    res.header('Triton-Datacenter-Name', req.config.datacenter_name);
+
     log.debug('listDatacenters(%s) => %j', req.params.account, datacenters);
     res.send(datacenters);
 
diff --git a/lib/datasets.js b/lib/datasets.js
index 534a838..7053fff 100644
--- a/lib/datasets.js
+++ b/lib/datasets.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 //
@@ -442,6 +442,12 @@ function get(req, res, next) {
 
 function create(req, res, next) {
     var log = req.log;
+    var action = req.params.action;
+
+    if (action) {
+        return next();
+    }
+
     if (!req.params.machine) {
         return next(new MissingParameterError(
                     'machine is a required argument'));
@@ -556,6 +562,50 @@ function update(req, res, next) {
 }
 
 
+function importFromDatacenter(req, res, next) {
+    var datacenter = req.params.datacenter;
+    var imageUUID = req.params.id;
+    var log = req.log;
+
+    if (req.params.action !== 'import-from-datacenter') {
+        next();
+        return;
+    }
+
+    if (!datacenter) {
+        next(new MissingParameterError('datacenter is a required argument'));
+        return;
+    }
+
+    if (!UUID_RE.test(imageUUID)) {
+        next(new InvalidArgumentError('id ' + imageUUID + ' must be a UUID'));
+        return;
+    }
+
+    var importOpts = {
+        datacenter: datacenter,
+        headers: {
+            'x-request-id': req.getId()
+        }
+    };
+
+    req.sdc.imgapi.importImageFromDatacenterAndWait(imageUUID, req.account.uuid,
+            importOpts,
+            function _importImageFromDatacenterAndWaitCb(err, img) {
+        if (err) {
+            next(err);
+            return;
+        }
+
+        var dataset = translate(req, img);
+        log.debug('ImportImageFromDatacenter(%s) => %s %s',
+            req.account.login, imageUUID, datacenter);
+        res.send(dataset);
+        next(false);
+    });
+}
+
+
 function exportImage(req, res, next) {
     var log = req.log;
     var action = req.params.action;
@@ -676,7 +726,7 @@ function mount(server, before, config) {
         path: '/:account/images',
         name: 'CreateImageFromMachine',
         version: ['7.0.0', '7.1.0', '7.2.0', '7.3.0', '8.0.0', '9.0.0']
-    }, before, create, resources.updateResource);
+    }, before, create, importFromDatacenter, resources.updateResource);
 
     server.post({
         path: '/:account/images/:dataset',
diff --git a/package.json b/package.json
index 40d705e..7196e93 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "9.1.0",
+    "version": "9.2.0",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
@@ -35,7 +35,7 @@
         "nodemailer": "0.7.1",
         "nopt": "2.0.0",
         "restify": "4.3.3",
-        "sdc-clients": "11.2.0",
+        "sdc-clients": "11.3.0",
         "semver": "5.4.1",
         "strsplit": "1.0.0",
         "triton-metrics": "0.1.0",
diff --git a/test/datacenters.test.js b/test/datacenters.test.js
index 4094a5b..803a4a2 100644
--- a/test/datacenters.test.js
+++ b/test/datacenters.test.js
@@ -44,6 +44,7 @@ test('ListDatacenters OK', function (t) {
         common.checkHeaders(t, res.headers);
         t.equal(res.statusCode, 200);
         t.ok(body[DC_NAME]);
+        t.equal(res.headers['triton-datacenter-name'], DC_NAME);
         t.end();
     });
 });
-- 
2.21.0

