From 6446325aa31816015cd4c59bfcd227692edb7b17 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 24 Aug 2018 20:25:30 +0200
Subject: [PATCH] TRITON-591 refreservation not set properly on bhyve disks

---
 src/vm/node_modules/VM.js | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index ac43db55..d22dbf7a 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -2074,7 +2074,7 @@ function createVolume(volume, opts, callback)
 
     if (volume.hasOwnProperty('refreservation')) {
         refreserv = volume.refreservation;
-    } else if (volume.hasOwnProperty('image_uuid')) {
+    } else if (volume.hasOwnProperty('image_uuid') && brand !== 'bhyve') {
         // We can't set refreserv > volsize when making a clone, so set it
         // to volsize instead.
         refreserv = size;
@@ -2146,6 +2146,8 @@ function createVolume(volume, opts, callback)
                 }
                 if (refreserv !== 'auto') {
                     args.push('-o', 'refreservation=' + refreserv + 'M');
+                } else if (brand === 'bhyve' && refreserv === 'auto') {
+                    args.push('-o', 'refreservation=auto');
                 }
                 args.push(snapshot, target);
                 zfs(args, log, function (e) {
-- 
2.21.0

