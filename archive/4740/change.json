{"project":"joyent/smartos-live","branch":"master","id":"I9b9d4cbe67f4271d01339660c285c90570621d22","number":"4740","subject":"TRITON-591 refreservation not set properly on bhyve disks Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/4740","commitMessage":"TRITON-591 refreservation not set properly on bhyve disks\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1535135133,"lastUpdated":1535646380,"open":false,"status":"MERGED","comments":[{"timestamp":1535135133,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1535135138,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 8050bd2030b85916d4f1374e2f09798a06b13703\n    \n    TRITON-591 refreservation not set properly on bhyve disks"},{"timestamp":1535135179,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535135306,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nGot the expected results with these changes:\n\n        [root@headnode (coal) ~]# zfs get -r volsize,refreservation zones/2da1c670-b75f-4050-e6ac-9c8be62f871b\n        NAME                                              PROPERTY        VALUE      SOURCE\n        zones/2da1c670-b75f-4050-e6ac-9c8be62f871b        volsize         -          -\n        zones/2da1c670-b75f-4050-e6ac-9c8be62f871b        refreservation  none       default\n        zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/disk0  volsize         10G        local\n        zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/disk0  refreservation  10,3G      local\n        zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/disk1  volsize         100M       local\n        zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/disk1  refreservation  105M       local\n\n\n        2018-08-24.16:43:08 zfs create -o refquota\u003d10G zones/2da1c670-b75f-4050-e6ac-9c8be62f871b\n        2018-08-24.16:43:09 zfs clone -F -o refreservation\u003dauto zones/56b9596c-a3bf-11e8-b5c9-0f79b1e762c5@final zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/disk0\n        2018-08-24.16:43:09 zfs create -V 100M zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/disk1\n        2018-08-24.16:43:14 zfs create -o quota\u003d102400m -o mountpoint\u003d/zones/2da1c670-b75f-4050-e6ac-9c8be62f871b/cores zones/cores/2da1c670-b75f-4050-e6ac-9c8be62f871b\n\nJust need to decide if we want to also set refreservation for main zone dataset and, if so, if we want to do it as part of this issue or would be better to open a new one"},{"timestamp":1535217916,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1535552680,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1535577889,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1535578936,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1535639396,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1535639401,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit a4cac860973fa82f8120b28bfaa2576c12341515\n    \n    TRITON-591 refreservation not set properly on bhyve disks"},{"timestamp":1535639427,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(2 comments)\n\nDone as suggested"},{"timestamp":1535639434,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneadm.js\n /tmp/repo/src/vm/node_modules/vmload/vmload-zoneinfo.js\n /tmp/repo/src/vm/node_modules/sysevent-stream.js\n /tmp/repo/src/vm/node_modules/zonecfg.js\n /tmp/repo/src/img/lib/IMG.js\n /tmp/repo/src/img/lib/cli.js\n /tmp/repo/src/img/lib/common.js\n /tmp/repo/src/img/lib/configuration.js\n /tmp/repo/src/img/lib/database.js\n /tmp/repo/src/img/lib/errors.js\n /tmp/repo/src/img/lib/imgadm.js\n /tmp/repo/src/img/lib/magic.js\n /tmp/repo/src/img/lib/upgrade.js\n /tmp/repo/src/img/sbin/imgadm\n /tmp/repo/src/vm/common/nictag.js\n /tmp/repo/src/vm/tests/test-alias.js\n /tmp/repo/src/vm/node_modules/nodeunit-plus/index.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js\n /tmp/repo/src/vm/tests/test-create.js\n /tmp/repo/src/vm/tests/test-create-filesystems.js\n /tmp/repo/src/vm/tests/test-docker.js\n /tmp/repo/src/vm/tests/test-defaults.js\n /tmp/repo/src/vm/tests/test-hrtime.js\n /tmp/repo/src/vm/tests/test-indestructible.js\n /tmp/repo/src/vm/tests/test-internal_metadata_namespaces.js\n /tmp/repo/src/vm/tests/test-lastexited.js\n /tmp/repo/src/vm/tests/test-openonerrlogger.js\n /tmp/repo/src/vm/tests/test-reboot.js\n /tmp/repo/src/vm/tests/test-reprovision.js\n /tmp/repo/src/vm/tests/test-snapshots.js\n /tmp/repo/src/vm/tests/test-spoof-opts.js\n /tmp/repo/src/vm/tests/test-tmpfs.js\n /tmp/repo/src/vm/tests/test-update.js\n /tmp/repo/src/vm/tests/test-vrrp-nics.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/vm/lib/metadata/zwatch.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 1 warnings(s)\n Makefile:440: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:364: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1535639607,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1535639612,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit cc87efb1f834218d0600898b302d1ad0be4ce82a\n    \n    TRITON-591 refreservation not set properly on bhyve disks"},{"timestamp":1535639685,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535640261,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1535641162,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1535641210,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1535645517,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1535645875,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1535645879,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 98767bd3d37b10809901655cec96f209e1f95de9\n    \n    TRITON-591 refreservation not set properly on bhyve disks"},{"timestamp":1535645923,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535646056,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1535646380,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"5","revision":"9b9d4cbe67f4271d01339660c285c90570621d22","parents":["3aa5ebb0c59f057460518c79959c376bb376e72c"],"ref":"refs/changes/40/4740/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1535645875,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535645923,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535646056,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535646056,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1535646380,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":3,"deletions":-18}],"sizeInsertions":3,"sizeDeletions":-18},"patchSets":[{"number":"1","revision":"6446325aa31816015cd4c59bfcd227692edb7b17","parents":["0e91d09081c00664b9b7ec7040e3fdc68a8c2cc8"],"ref":"refs/changes/40/4740/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1535135133,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535135179,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535217916,"by":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535578936,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":2091,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I think we should just delete all of this.  Both kvm and bhyve suffer the same problem.  Whether it comes from an image or a new creation shouldn\u0027t matter - refreservation\u003dauto should be used on all cases where a refreservation is not explicitly set."},{"file":"src/vm/node_modules/VM.js","line":2091,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Probably deleting these and just leaving the else is fine. It does change the behaviour (breaking compat like the comment here says) which we should make sure to note in the documentation, but defaulting to `auto` when refreservation is not set seems fine to me otherwise."},{"file":"src/vm/node_modules/VM.js","line":2091,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":2149,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"No need to special case bhyve here.  The issue is the same for all zvols."},{"file":"src/vm/node_modules/VM.js","line":2149,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I agree. Changing this to:\n\n    } else if (refreserv \u003d\u003d\u003d \u0027auto\u0027) {\n\nseems fine."},{"file":"src/vm/node_modules/VM.js","line":2149,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-1},{"number":"2","revision":"74b87cc4f5035b91dae2e82527dea9804ae1ce4c","parents":["0e91d09081c00664b9b7ec7040e3fdc68a8c2cc8"],"ref":"refs/changes/40/4740/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1535639396,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1535639434,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":2,"deletions":-16}],"sizeInsertions":2,"sizeDeletions":-16},{"number":"3","revision":"3aff6e13c45afbd06b7c92e6130c6b4339bf5a25","parents":["0e91d09081c00664b9b7ec7040e3fdc68a8c2cc8"],"ref":"refs/changes/40/4740/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1535639607,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535639685,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535640261,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":2,"deletions":-17}],"sizeInsertions":2,"sizeDeletions":-17},{"number":"4","revision":"a7a295a4be076ac6e87485be762cd56dd7adbd2d","parents":["3aa5ebb0c59f057460518c79959c376bb376e72c"],"ref":"refs/changes/40/4740/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1535641162,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535639685,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535645517,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535645517,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535640261,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":2191,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: this could just be:\n\n    } else {\n\nhere since the if condition handles anything that\u0027s not auto. I\u0027d almost think about writing this as:\n\n    if (refreserv \u003d\u003d\u003d \u0027auto\u0027) {\n        args.push(\u0027-o\u0027, \u0027refreservation\u003dauto\u0027);\n    } else {\n        args.push(\u0027-o\u0027, \u0027refreservation\u003d\u0027 + refreserv + \u0027M\u0027);\n    }\n\nto make it a bit more clear what\u0027s going on here. But that\u0027s really just a nit, what\u0027s here will also work."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":2,"deletions":-17}],"sizeInsertions":2,"sizeDeletions":-17},{"number":"5","revision":"9b9d4cbe67f4271d01339660c285c90570621d22","parents":["3aa5ebb0c59f057460518c79959c376bb376e72c"],"ref":"refs/changes/40/4740/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1535645875,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535645923,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535646056,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535646056,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1535646380,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":3,"deletions":-18}],"sizeInsertions":3,"sizeDeletions":-18}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}