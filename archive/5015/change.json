{"project":"joyent/sdcadm","branch":"master","id":"Ic75f9dd1e12cedff8e1c560f58b5b45f94e327ba","number":"5015","subject":"MANTA-3552 create Triton Prometheus image","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/5015","commitMessage":"MANTA-3552 create Triton Prometheus image\n","createdOn":1540934745,"lastUpdated":1554837385,"open":false,"status":"MERGED","comments":[{"timestamp":1540934745,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1540934746,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 12b6fd6bc28eb3b3c8392e5e751daf241d85116f\n    \n    bump sdc-clients ver now that it is published\n    \n    commit f540ac3083e8b33e379dc34d56230cb15997ee92\n    \n    get post-setup prom to add prom key to the admin\n    \n    commit 0f0f9e255bfd46dd6d82a82078f92d72177f4887\n    \n    MANTA-3552 (first cut at sdcadm post-setup prometheus)"},{"timestamp":1540934782,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541205983,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1541433328,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)\n\nLGTM. I think we should do a huge refactoring and extract all the common stuff from `post-setup/service-name.js`, but that\u0027s a matter for another issue and some free time :-)"},{"timestamp":1543618494,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1546902588,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(5 comments)\n\nTo pedro\u0027s general:\n\u003e I think we should do a huge refactoring and extract all the common stuff from `post-setup/service-name.js`, but that\u0027s a matter for another issue and some free time :-)\n\nYup agreed on both. I\u0027d starting thinking about a more general `sdcadm service add ...` command. That is *also* for another issue and free time."},{"timestamp":1546903366,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1554402727,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 2."},{"timestamp":1554402835,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 3."},{"timestamp":1554402996,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 4."},{"timestamp":1554774735,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1554822724,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(3 comments)\n\nOther than some minor things LGTM"},{"timestamp":1554822738,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1554830331,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 5."},{"timestamp":1554830554,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 5:\n\n(3 comments)\n\nThanks for the review, Pedro -- I\u0027ve addressed your comments."},{"timestamp":1554835963,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nThanks for checking Isaac. LGTM!"},{"timestamp":1554837385,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Isaac Davis"}],"currentPatchSet":{"number":"5","revision":"c75f9dd1e12cedff8e1c560f58b5b45f94e327ba","parents":["290aca37790f73b771d24f38dde144fee1b070bb"],"ref":"refs/changes/15/5015/5","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1554830331,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554835963,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554835963,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1554837385,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"ADDED","insertions":139,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/rsync-to","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"d26711cd21beca2712d3f616568b65bb3260590d","parents":["8ed727f0d2dc2e9e7ff35d4441d2be042a48da73"],"ref":"refs/changes/15/5015/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1540934745,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1540934782,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541433328,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"lib/post-setup/prometheus.js","line":95,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Missing whitespace between the two strings separated by the +"},{"file":"lib/post-setup/prometheus.js","line":95,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"This is from the first patchset -- looks like the whitespace got added when this code moved to lib/procedures/add-service.js"},{"file":"lib/post-setup/prometheus.js","line":98,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Another missing whitespace"},{"file":"lib/post-setup/prometheus.js","line":98,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Same here"},{"file":"lib/procedures/download-images.js","line":82,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Does this mean that we don\u0027t support specifying a custom source and channel for that source at the same time?"},{"file":"lib/procedures/download-images.js","line":82,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t understand your Q, or you misread this code block, I think.  If `options.source` is given, it can include a custom channel as well."},{"file":"lib/procedures/download-images.js","line":82,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"yup - my mistake."},{"file":"lib/sdcadm.js","line":3727,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Should the phrasing of this comment be made more explicit? (i.e. \"XXX Prometheus does not have a `/ping` endpoint\")"},{"file":"lib/sdcadm.js","line":3727,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, sorry. \u0027XXX\u0027 is a note I use to myself. I generally try to never *commit* anything with \u0027XXX\u0027 in it.\n\nI\u0027ll update this or create a separate ticket to add \u0027sdcadm check-health\u0027 support for prometheus."},{"file":"lib/steps/index.js","line":33,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"We should probably make the syntax here consistent - either have every export use `get` or none at all"},{"file":"lib/steps/index.js","line":33,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"+1"},{"file":"lib/steps/index.js","line":33,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"K, I\u0027ll look into it."},{"file":"lib/steps/ufds.js","line":49,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Is it worth making these named constants?"},{"file":"lib/steps/ufds.js","line":49,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Not sure. I was copying sdc-useradm (https://github.com/joyent/sdc-sdc/blob/82f51372143f0025b883bbf1398e03265a0a1af7/lib/sdc-useradm.js#L193-L239).\n\nChecking...\n\nYes, it appears that:\n\n1. default retries are (a) infinite and (b) ranging up to 30 seconds between retry attempts (https://github.com/joyent/node-ufds/blob/master/lib/index.js#L454-L457). I don\u0027t want `sdcadm` to hang trying to reach UFDS. It should fail after a reasonable amount of retrying. Arguably it should be faster than this config, but copying sdc-useradm seems fine for now.\n\n2. By default there is *no* connection timeout (https://github.com/joyent/node-ldapjs/blob/ad451edc18d7768c3ddee1a1dd472d2bbafdae5e/lib/client/client.js#L321) which I believe means that if UFDS doesn\u0027t respond to connection attempts that sdcadm would hang.\n\n\n---\n\nOh, I misread your question. Originally I thought you were questioning why having these at all. :)\n\nSure I can make these named constants with some comments justifying their values."},{"file":"lib/steps/ufds.js","line":127,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"If `ufds_remote_ldap_root_pw` does not exist, the client should use `ufds_ldap_root_pw` rather than return an error. This is because, as I understand it, `ufds_remote_ldap_root_pw` is only set if it _differs_ from the local ldap root password. If it is not set, we assume that the remote ufds has the same password. See e.g. the sapi template for cloudapi for a precedent.\n\n(I discovered this when testing `sdcadm post-setup prometheus` in staging-3, where, indeed, `ufds_ldap_root_pw` is not set.)"},{"file":"lib/steps/ufds.js","line":127,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nice catch, thanks!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"ADDED","insertions":547,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":6,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":13,"deletions":-3},{"file":"lib/steps/index.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/steps/instance.js","type":"ADDED","insertions":80,"deletions":0},{"file":"lib/steps/ufds.js","type":"ADDED","insertions":146,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"tools/rsync-to","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":850,"sizeDeletions":-12},{"number":"2","revision":"f099c18026ec76cc4e54d916cb81ec2c09c05a58","parents":["290aca37790f73b771d24f38dde144fee1b070bb"],"ref":"refs/changes/15/5015/2","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1554402727,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"ADDED","insertions":139,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/rsync-to","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-7},{"number":"3","revision":"f47db1f2255f635a00a5a29948a797ad9c15d58e","parents":["290aca37790f73b771d24f38dde144fee1b070bb"],"ref":"refs/changes/15/5015/3","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1554402835,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"ADDED","insertions":139,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/rsync-to","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":160,"sizeDeletions":-7},{"number":"4","revision":"64c796627681f6a9198fb753227ddd0ff980d301","parents":["290aca37790f73b771d24f38dde144fee1b070bb"],"ref":"refs/changes/15/5015/4","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1554402996,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554774735,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554822738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554822738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"lib/procedures/index.js","line":208,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Nit: the list is alphabetically sorted."},{"file":"lib/procedures/index.js","line":208,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"ADDED","insertions":139,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/rsync-to","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-6},{"number":"5","revision":"c75f9dd1e12cedff8e1c560f58b5b45f94e327ba","parents":["290aca37790f73b771d24f38dde144fee1b070bb"],"ref":"refs/changes/15/5015/5","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1554830331,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1554835963,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1554835963,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1554837385,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"ADDED","insertions":139,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/rsync-to","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":159,"sizeDeletions":-6}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}]}