{"project":"joyent/illumos-joyent","branch":"master","id":"Ie5c3f3de12c528e4490dc8f63b602902248fb0eb","number":"4029","subject":"OS-6605 pkcs11 C_Digest() is too restrictive in input Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/4029","commitMessage":"OS-6605 pkcs11 C_Digest() is too restrictive in input\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1527718785,"lastUpdated":1528996874,"open":false,"status":"MERGED","comments":[{"timestamp":1527718785,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1527720318,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527721512,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527723484,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527723489,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1527725492,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1527725496,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1528228495,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1528234085,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2:\n\nThe pkcs11_kernel provider as well as the metaslot had the same issue, so I expanded the scope of the ticket slightly (with a similar fix) just to take care of those."},{"timestamp":1528243171,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nThanks for the updated testing notes too."},{"timestamp":1528489048,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\nSeems OK, but it\u0027s a bit hard to audit all the kernel side modules to make sure that we handle those cases ok. That said if we don\u0027t, this change doesn\u0027t impact the correctness (someone could always just ioctl directly)."},{"timestamp":1528489527,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2:\n\nFWIW, the _kcf tests all use the ioctls, so all the current digest tests work w/o a problem on 0-byte messages using the kernel implementations (as well as MD5 -- I have a test file done, except I seem to have goofed converting the data on one test that I haven\u0027t dug into yet, so I need to figure that out before putting it up for review)."},{"timestamp":1528996665,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1528996765,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1528996845,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1528996874,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jason King"}],"currentPatchSet":{"number":"4","revision":"e5c3f3de12c528e4490dc8f63b602902248fb0eb","parents":["c2d375cdcb04122f97908079581dda41a08c0d07"],"ref":"refs/changes/29/4029/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1528996845,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528243171,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528489048,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528996665,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1528996874,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/pkcs11/libpkcs11/common/metaDigest.c","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/pkcs11/pkcs11_kernel/common/kernelDigest.c","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-5},"patchSets":[{"number":"1","revision":"61ae14bd86c8d5fbc50fee140a9e87d104da5359","parents":["ebeb4e6f47d7570b35e03a12e642a74c926c29b9"],"ref":"refs/changes/29/4029/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1527718785,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527723489,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527725496,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527725492,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","line":124,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Looking at the code it seems that the SHA family routines handle the case where ulDataLen is zero. However, the md5 update that we call through via soft_digest_common() doesn\u0027t seem to necessarily in the same way. Will it correctly handle the update of zero?"},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","line":124,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I think so -- it appears to explicitly special case pData \u003d\u003d NULL by just calling MD5Final().\n\nIf pData !\u003d NULL \u0026\u0026 ulDataLen \u003d\u003d 0, it appears then MD5Update() is called, looking at usr/src/common/crypto/md5/md5.c, it appears the only thing that occurs is a bcopy(.., .., 0); (i.e. a no-op), followed by MD5Final();\n\nHowever, to be sure, I can create an MD5 test program using the NIST test vectors as well."},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","line":124,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think I missed the surrounding if on the conditionality of pData in the different processing routines there somehow. In that case, it doesn\u0027t seem to change anything. Might be good for us to verify at some point, but doesn\u0027t seem to meaningfully impact the current situation."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":2,"sizeDeletions":-1},{"number":"2","revision":"e3f1a7d45fcb9dd0c5c00086a1b2bd668b1736fb","parents":["ebeb4e6f47d7570b35e03a12e642a74c926c29b9"],"ref":"refs/changes/29/4029/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1528228495,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528489048,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528243171,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528996665,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/pkcs11/libpkcs11/common/metaDigest.c","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/pkcs11/pkcs11_kernel/common/kernelDigest.c","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-5},{"number":"3","revision":"7db3fe232dff2497ab125341d5279a29620cb2e4","parents":["c2d375cdcb04122f97908079581dda41a08c0d07"],"ref":"refs/changes/29/4029/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1528996765,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528489048,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528243171,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528996665,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/pkcs11/libpkcs11/common/metaDigest.c","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/pkcs11/pkcs11_kernel/common/kernelDigest.c","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-5},{"number":"4","revision":"e5c3f3de12c528e4490dc8f63b602902248fb0eb","parents":["c2d375cdcb04122f97908079581dda41a08c0d07"],"ref":"refs/changes/29/4029/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1528996845,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528489048,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1528996874,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528243171,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528996665,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/pkcs11/libpkcs11/common/metaDigest.c","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"usr/src/lib/pkcs11/pkcs11_kernel/common/kernelDigest.c","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/pkcs11/pkcs11_softtoken/common/softDigest.c","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-5}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}]}