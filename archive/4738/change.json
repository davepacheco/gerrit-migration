{"project":"joyent/illumos-joyent","branch":"master","id":"I2b41f937aecb3277b76d1d4dd3316f041bd8fc2b","number":"4738","subject":"OS-7172 FPU related cpuid checks shouldn\u0027t be Intel only OS-7171 AMD EPYC doesn\u0027t need *save_ctxt FP exceptions Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/4738","commitMessage":"OS-7172 FPU related cpuid checks shouldn\u0027t be Intel only\nOS-7171 AMD EPYC doesn\u0027t need *save_ctxt FP exceptions\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1535073526,"lastUpdated":1535410695,"open":false,"status":"MERGED","comments":[{"timestamp":1535073526,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1535109438,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1535113184,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1535120562,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1535122890,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1535123203,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1535163166,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1535197340,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1535369322,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1535410630,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1535410689,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1535410695,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"4","revision":"2b41f937aecb3277b76d1d4dd3316f041bd8fc2b","parents":["6cc09d5e5f5ddf4d19751345ff40ef463c3821c2"],"ref":"refs/changes/38/4738/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1535410689,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535197340,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1535410695,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":19,"deletions":-22}],"sizeInsertions":19,"sizeDeletions":-22},"patchSets":[{"number":"1","revision":"4fa1acadace82eb78370e417651c29900755bdd3","parents":["e79c50557fdcaf68635086f55afd817419c78661"],"ref":"refs/changes/38/4738/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1535073526,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1467,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this needs to be intel only"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1467,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I wasn\u0027t sure what made the most sense here and in the MPX/AVX512 case. AMD seems to be making sure that they and Intel coordinate on which bits are used for which features. AMD pretty clearly isn\u0027t reusing them for compats sake. So do we really want to go back and ratchet out which ones are and aren\u0027t? Ultimately, I\u0027m happy to do so, but want to get folks thoughts on this."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1467,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"My preference is to be paranoid over reserved bits. If it\u0027s something that seems unlikely for AMD like PCID, it seems dangerous to presume. And if it *is* something AMD will do, I\u0027d rather we force somebody to check the manuals for any minor differences first, rather than potentially enabling something by \"default\" and then not quite getting it right."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1467,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, sounds fine. I\u0027ll go back and make sure all the things which AMD doesn\u0027t support are under the check. Including AVX512, etc."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1476,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Might want to remove this part of the comment while you\u0027re making changes in here."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1476,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done, along with the ifdef."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1479,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This looks fine, but is your AMD manual buggy too? Listed as reserved in E.3.6, but mentioned in table D-1"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1479,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Looks like we have the same manual and that it is buggy. I\u0027ll follow up with AMD."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1483,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"intel only? Would be good to move these cases down to the bottom of the if clause for clarity."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1483,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"See earlier note."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":3777,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I suppose we don\u0027t yet consider such lacking CPUs old enough to rip out support altogether?"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":3777,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"No, because it\u0027s not clear when such CPUs were fixed. I suspect it\u0027s true for a non-trivial chunk of 64-bit capable CPUs."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":7,"deletions":-10}],"sizeInsertions":7,"sizeDeletions":-10},{"number":"2","revision":"43b8731005653155e792c726a1c89be835f68302","parents":["e79c50557fdcaf68635086f55afd817419c78661"],"ref":"refs/changes/38/4738/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1535163166,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535197340,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":19,"deletions":-22}],"sizeInsertions":19,"sizeDeletions":-22},{"number":"3","revision":"26db007f18fa660cd561a9a760033289ca7b7015","parents":["6cc09d5e5f5ddf4d19751345ff40ef463c3821c2"],"ref":"refs/changes/38/4738/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1535410630,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535197340,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":19,"deletions":-22}],"sizeInsertions":19,"sizeDeletions":-22},{"number":"4","revision":"2b41f937aecb3277b76d1d4dd3316f041bd8fc2b","parents":["6cc09d5e5f5ddf4d19751345ff40ef463c3821c2"],"ref":"refs/changes/38/4738/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1535410689,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1535410695,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535369322,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535197340,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":19,"deletions":-22}],"sizeInsertions":19,"sizeDeletions":-22}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}