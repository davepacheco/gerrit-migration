{"project":"joyent/node-libmanta","branch":"master","id":"I722683709c07503d9516181addd6c0597f8d9d84","number":"4585","subject":"MANTA-3774 Use fastdelete method to delete objects if user account has snaplinks disabled Reviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e Approved by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e","owner":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"url":"https://cr.joyent.us/4585","commitMessage":"MANTA-3774 Use fastdelete method to delete objects if user account has snaplinks disabled\nReviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\nApproved by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\n","createdOn":1532620657,"lastUpdated":1533665093,"open":false,"status":"MERGED","comments":[{"timestamp":1532620657,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 1."},{"timestamp":1532620684,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532627328,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1532628047,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1532628338,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1532641801,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1532651950,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 1: Code-Review-1\n\nLooking at this again, I think we\u0027ll need to bump the version of the \u0027manta\u0027 bucket here, or else the `recordDeleteLog` post-trigger will not be updated: https://github.com/joyent/node-moray/blob/master/lib/buckets.js#L189-L196. I did some preliminary testing with this in my lab environment, and it appeared to be the case that the RPCs were being called with the \u0027x-muskie-snaplinks-disabled\u0027 header, but the triggers were not updated, so all deletes were still generating manta_delete_log records."},{"timestamp":1533042680,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 2."},{"timestamp":1533042706,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533044316,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2: Integration-Approval-1\n\nBefore it is integrated, CR4606 needs to be integrated"},{"timestamp":1533650997,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1533651023,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1533651070,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 3: -Integration-Approval\n\nRebased against master now that CR4606 has landed"},{"timestamp":1533664732,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1533664963,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3: Integration-Approval+1\n\nI\u0027ve been using this change in my lab environment and SPC staging for a while. Things seem to work well."},{"timestamp":1533665063,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1533665093,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jared Morrow"}],"currentPatchSet":{"number":"4","revision":"722683709c07503d9516181addd6c0597f8d9d84","parents":["5d83ce1f80dc3129d4e7168ab1434831486e0a55"],"ref":"refs/changes/85/4585/4","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1533665063,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533042706,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533664732,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533664963,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"SUBM","value":"1","grantedOn":1533665093,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":31,"deletions":-11}],"sizeInsertions":31,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"cf6a0d1dbf053ca3e59c305d3e73687e373e784b","parents":["2ab2c0c7596ac003e2169b634924784b8f6a268a"],"ref":"refs/changes/85/4585/1","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1532620657,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532620684,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1532651950,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"comments":[{"file":"lib/moray.js","line":325,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Do we need an extra indent after this like above?"},{"file":"lib/moray.js","line":325,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Oh yeah, I forgot to fix this up after the if/else indent."},{"file":"lib/moray.js","line":907,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is there a reason this shouldn\u0027t be:\n\nopts.headers \u003d {\n    \u0027x-muskie-prev-metadata\u0027: options.previousMetadata,\n    \u0027x-muskie-snaplinks-disabled\u0027: options.snapLinksDisabled\n}"},{"file":"lib/moray.js","line":907,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"We talked about this in chat: the current structure is preferable because allows us to more easily isolate requests for accounts that have snaplinks disabled by grep\u0027ing logs."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":30,"deletions":-10}],"sizeInsertions":30,"sizeDeletions":-10},{"number":"2","revision":"20830d286ebbffd98594c50fc640ca2bd6e5669f","parents":["2ab2c0c7596ac003e2169b634924784b8f6a268a"],"ref":"refs/changes/85/4585/2","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1533042680,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533042706,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1533044316,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1532651950,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":31,"deletions":-11}],"sizeInsertions":31,"sizeDeletions":-11},{"number":"3","revision":"3f13707ecfd8d9e3dcdca54e6bc1bca17d5776b1","parents":["5d83ce1f80dc3129d4e7168ab1434831486e0a55"],"ref":"refs/changes/85/4585/3","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1533650997,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533042706,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533664732,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533664963,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":31,"deletions":-11}],"sizeInsertions":31,"sizeDeletions":-11},{"number":"4","revision":"722683709c07503d9516181addd6c0597f8d9d84","parents":["5d83ce1f80dc3129d4e7168ab1434831486e0a55"],"ref":"refs/changes/85/4585/4","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1533665063,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533042706,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1533665093,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533664732,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533664963,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":31,"deletions":-11}],"sizeInsertions":31,"sizeDeletions":-11}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}]}