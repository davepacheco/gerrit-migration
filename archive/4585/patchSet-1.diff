From cf6a0d1dbf053ca3e59c305d3e73687e373e784b Mon Sep 17 00:00:00 2001
From: Jared Morrow <jm@joyent.com>
Date: Tue, 24 Jul 2018 16:09:29 -0600
Subject: [PATCH] MANTA-3774 Use fastdelete method to delete objects if user
 account has snaplinks disabled

---
 lib/moray.js | 38 +++++++++++++++++++++++++++++---------
 1 file changed, 29 insertions(+), 9 deletions(-)

diff --git a/lib/moray.js b/lib/moray.js
index e89b7b6..480d8da 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -305,18 +305,28 @@ function recordDeleteLog(req, cb) {
     }
     log.debug('object ' + prevObjectId + ' is candidate for deletion.');
 
-    //now log to the manta_delete_log table...
+    // now log to the manta_delete_log table or the manta_fastdelete_queue...
     var now = Math.round((microtime.now() / 1000));
     var _key = '/' + prevObjectId + '/' + now;
     var _value = JSON.stringify(prevmd);
     var _etag = crc.hex32(crc.crc32(_value));
     var _mtime = now;
-    var objectId = prevObjectId;
-    var sql = 'INSERT INTO manta_delete_log (_key, _value, _etag, ' +
+    var sql = '';
+    var values = [];
+
+    // If snaplinks are disabled use the fastdelete_queue rather than delete_log
+    if (req.headers['x-muskie-snaplinks-disabled']) {
+        log.debug('object ' + prevObjectId + ' being added to fastdelete.');
+        sql = 'INSERT INTO manta_fastdelete_queue (_key, _value, _etag, ' +
+            '_mtime) VALUES ($1, $2, $3, $4)';
+        values = [prevObjectId, _value, _etag, _mtime];
+    } else {
+        sql = 'INSERT INTO manta_delete_log (_key, _value, _etag, ' +
         '_mtime, objectId) VALUES ($1, $2, $3, $4, $5)';
-    var values = [_key, _value, _etag, _mtime, objectId];
+        values = [_key, _value, _etag, _mtime, prevObjectId];
+    }
 
-    //execute
+    // execute
     var q = req.pg.query(sql, values);
     q.once('error', function (err) {
         log.debug(err, 'manta delete log insert: failed');
@@ -865,6 +875,8 @@ Moray.prototype.delMetadata = function delMetadata(options, callback) {
     assert.string(options.key, 'options.key');
     assert.string(options.requestId, 'options.requestId');
     assert.object(options, 'options.previousMetadata');
+    assert.optionalBool(options.snapLinksDisabled,
+        'options.snapLinksDisabled');
     assert.func(callback, 'callback');
 
     if (!this.client) {
@@ -880,12 +892,20 @@ Moray.prototype.delMetadata = function delMetadata(options, callback) {
     var log = this.log;
     var opts = {
         req_id: options.requestId,
-        etag: options._etag,
-        headers: {
-            'x-muskie-prev-metadata': options.previousMetadata
-        }
+        etag: options._etag
     };
 
+    if (options.snapLinksDisabled) {
+        opts.headers = {
+            'x-muskie-prev-metadata': options.previousMetadata,
+            'x-muskie-snaplinks-disabled': true
+        };
+    } else {
+        opts.headers = {
+            'x-muskie-prev-metadata':  options.previousMetadata
+        };
+    }
+
     log.debug({
         key: key,
         etag: opts.etag,
-- 
2.21.0

