From aad24fc306e998bdbfcfc6e11101be4a6fc386d2 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 6 Aug 2018 17:06:07 +0200
Subject: [PATCH] TOOLS-1962 'sdcadm create sdc -s NEW-HEADNODE' should work

---
 lib/procedures/create-service-instance-v1.js | 17 +++++++++++++++++
 lib/procedures/index.js                      |  2 +-
 2 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/lib/procedures/create-service-instance-v1.js b/lib/procedures/create-service-instance-v1.js
index 974d3f5..ff7ec3f 100644
--- a/lib/procedures/create-service-instance-v1.js
+++ b/lib/procedures/create-service-instance-v1.js
@@ -183,6 +183,23 @@ CreateServiceInstanceV1.prototype.execute = function csiv1Execute(opts, cb) {
             }, next);
         });
 
+        if (change.service.name === 'sdc') {
+            funcs.push(function sdcSvcWarning(_, next) {
+                progress(
+                    '\n' +
+                    'Remember that only a single \'sdc\' VM should run the ' +
+                    'hermes and napi-ufds-watcher services.\nThose will not ' +
+                    'be automatically disabled by sdcadm, neither the zone ' +
+                    'tools will be symlinked.\n' +
+                    'This can be done by running (from the Compute Node ' +
+                    'where the sdc zone has been created):\n\n' +
+                    '    ln -s /zones/${new_uuid}/root/opt/smartdc/sdc ' +
+                    '/opt/smartdc/sdc\n'
+                );
+                next();
+            });
+        }
+
         opts.log.info({change: change},
                 'CreateServiceInstanceV1 createSvcInst');
         vasync.pipeline({funcs: funcs, arg: arg}, nextSvc);
diff --git a/lib/procedures/index.js b/lib/procedures/index.js
index 948416d..dfc3bf3 100644
--- a/lib/procedures/index.js
+++ b/lib/procedures/index.js
@@ -639,7 +639,7 @@ function coordinatePlan(opts, cb) {
         function createServiceInstance(_, next) {
             // Any instance which should never be created using
             // this tool should be here:
-            var avoid = ['binder', 'manatee', 'rabbitmq', 'sdc', 'zookeeper'];
+            var avoid = ['binder', 'manatee', 'rabbitmq', 'zookeeper'];
 
             var handle = [];
             var remaining = [];
-- 
2.21.0

