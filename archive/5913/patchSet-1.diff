commit 551c1491060077e5d5a85e5edbd6a329e1a76394
Author: Brian Bennett <brian.bennett@joyent.com>
Date:   2019-03-18T17:48:16-07:00 (7 months ago)
    
    TRITON-599 CNS needs better handling of acme challenges for new instances

diff --git a/lib/vm-to-zones.js b/lib/vm-to-zones.js
index 3ac9507..572512a 100644
--- a/lib/vm-to-zones.js
+++ b/lib/vm-to-zones.js
@@ -36,17 +36,15 @@ function buildZonesFromVm(vm, config, log) {
 						network: nic.network
 					});
 				}
-				if (vm.listServices) {
-					vm.services.forEach(function (svc) {
-						entries.push({
-							type: 'service',
-							ip: ip,
-							zone: zone,
-							service: svc,
-							network: nic.network
-						});
+				vm.services.forEach(function (svc) {
+					entries.push({
+						type: 'service',
+						ip: ip,
+						zone: zone,
+						service: svc,
+						network: nic.network
 					});
-				}
+				});
 			});
 		});
 	});
@@ -270,46 +268,48 @@ function addInstance(zones, vm, ent, config) {
 
 function addService(zones, vm, ent, config) {
 	var svc = ent.service;
-	function addName(name) {
-		if (!zones[ent.zone])
-			zones[ent.zone] = {};
-		if (!zones[ent.zone][name])
-			zones[ent.zone][name] = [];
-		var recs = zones[ent.zone][name];
-		recs.push({
-			constructor: ent.addrType,
-			args: [ent.ip],
-			src: vm.uuid
-		});
-		var hasTxt = false;
-		for (var i = 0; i < recs.length; ++i) {
-			if (recs[i].constructor === 'TXT' &&
-			    recs[i].args[0] === vm.uuid) {
-				hasTxt = true;
-				break;
+	if (vm.listServices) {
+		function addName(name) {
+			if (!zones[ent.zone])
+				zones[ent.zone] = {};
+			if (!zones[ent.zone][name])
+				zones[ent.zone][name] = [];
+			var recs = zones[ent.zone][name];
+			recs.push({
+				constructor: ent.addrType,
+				args: [ent.ip],
+				src: vm.uuid
+			});
+			var hasTxt = false;
+			for (var i = 0; i < recs.length; ++i) {
+				if (recs[i].constructor === 'TXT' &&
+				    recs[i].args[0] === vm.uuid) {
+					hasTxt = true;
+					break;
+				}
+			}
+			if (!hasTxt) {
+				recs.push({
+					constructor: 'TXT',
+					args: [vm.uuid],
+					src: vm.uuid
+				});
 			}
 		}
-		if (!hasTxt) {
+		function addSRV(name, port) {
+			if (!zones[ent.zone])
+				zones[ent.zone] = {};
+			if (!zones[ent.zone][name])
+				zones[ent.zone][name] = [];
+			var recs = zones[ent.zone][name];
+			var target = primaryName(vm, config) + '.' + ent.zone;
 			recs.push({
-				constructor: 'TXT',
-				args: [vm.uuid],
+				constructor: 'SRV',
+				args: [target, port],
 				src: vm.uuid
 			});
 		}
 	}
-	function addSRV(name, port) {
-		if (!zones[ent.zone])
-			zones[ent.zone] = {};
-		if (!zones[ent.zone][name])
-			zones[ent.zone][name] = [];
-		var recs = zones[ent.zone][name];
-		var target = primaryName(vm, config) + '.' + ent.zone;
-		recs.push({
-			constructor: 'SRV',
-			args: [target, port],
-			src: vm.uuid
-		});
-	}
 
 	function addACME(name) {
 		if (vm.customer_metadata === undefined)
@@ -339,7 +339,8 @@ function addService(zones, vm, ent, config) {
 	addName(n);
 	addACME(n);
 	if (vm.owner.login === 'admin') {
-		addName(svc.name);
+		if (vm.listServices)
+			addName(svc.name);
 		addACME(svc.name);
 	}
 	svc.ports.forEach(function (port) {
@@ -348,7 +349,8 @@ function addService(zones, vm, ent, config) {
 
 	if (doNetworkName) {
 		n = dnsify(ent.network.name) + '.' + n;
-		addName(n);
+		if (vm.listServices)
+			addName(n);
 		addACME(n);
 		svc.ports.forEach(function (port) {
 			addSRV(n, port);
@@ -357,7 +359,8 @@ function addService(zones, vm, ent, config) {
 
 	if (config.use_login && vm.owner.login.length < 63) {
 		n = svc.name + '.svc.' + dnsify(vm.owner.login);
-		addName(n);
+		if (vm.listServices)
+			addName(n);
 		addACME(n);
 		svc.ports.forEach(function (port) {
 			addSRV(n, port);
@@ -365,7 +368,8 @@ function addService(zones, vm, ent, config) {
 
 		if (doNetworkName) {
 			n = dnsify(ent.network.name) + '.' + n;
-			addName(n);
+			if (vm.listServices)
+				addName(n);
 			addACME(n);
 			svc.ports.forEach(function (port) {
 				addSRV(n, port);
