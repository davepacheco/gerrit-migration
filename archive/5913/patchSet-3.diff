From 67fb8b5d0da9131d0c19a82ef56fd4d80480d192 Mon Sep 17 00:00:00 2001
From: Brian Bennett <brian.bennett@joyent.com>
Date: Mon, 18 Mar 2019 18:59:07 -0700
Subject: [PATCH] TRITON-599 CNS needs better handling of acme challenges for
 new instances

---
 lib/vm-to-zones.js | 78 +++++++++++++++++++++++++---------------------
 1 file changed, 43 insertions(+), 35 deletions(-)

diff --git a/lib/vm-to-zones.js b/lib/vm-to-zones.js
index 3ac9507..8dcbb6a 100644
--- a/lib/vm-to-zones.js
+++ b/lib/vm-to-zones.js
@@ -36,17 +36,15 @@ function buildZonesFromVm(vm, config, log) {
 						network: nic.network
 					});
 				}
-				if (vm.listServices) {
-					vm.services.forEach(function (svc) {
-						entries.push({
-							type: 'service',
-							ip: ip,
-							zone: zone,
-							service: svc,
-							network: nic.network
-						});
+				vm.services.forEach(function (svc) {
+					entries.push({
+						type: 'service',
+						ip: ip,
+						zone: zone,
+						service: svc,
+						network: nic.network
 					});
-				}
+				});
 			});
 		});
 	});
@@ -276,39 +274,49 @@ function addService(zones, vm, ent, config) {
 		if (!zones[ent.zone][name])
 			zones[ent.zone][name] = [];
 		var recs = zones[ent.zone][name];
-		recs.push({
-			constructor: ent.addrType,
-			args: [ent.ip],
-			src: vm.uuid
-		});
-		var hasTxt = false;
-		for (var i = 0; i < recs.length; ++i) {
-			if (recs[i].constructor === 'TXT' &&
-			    recs[i].args[0] === vm.uuid) {
-				hasTxt = true;
-				break;
+		if (vm.listServices) {
+			recs.push({
+				constructor: ent.addrType,
+				args: [ent.ip],
+				src: vm.uuid
+			});
+			var hasTxt = false;
+			for (var i = 0; i < recs.length; ++i) {
+				if (recs[i].constructor === 'TXT' &&
+				    recs[i].args[0] === vm.uuid) {
+					hasTxt = true;
+					break;
+				}
 			}
-		}
-		if (!hasTxt) {
+			if (!hasTxt) {
+				recs.push({
+					constructor: 'TXT',
+					args: [vm.uuid],
+					src: vm.uuid
+				});
+			}
+		} else {
 			recs.push({
 				constructor: 'TXT',
-				args: [vm.uuid],
+				args: ['verifying:' + vm.uuid],
 				src: vm.uuid
 			});
 		}
 	}
 	function addSRV(name, port) {
-		if (!zones[ent.zone])
-			zones[ent.zone] = {};
-		if (!zones[ent.zone][name])
-			zones[ent.zone][name] = [];
-		var recs = zones[ent.zone][name];
-		var target = primaryName(vm, config) + '.' + ent.zone;
-		recs.push({
-			constructor: 'SRV',
-			args: [target, port],
-			src: vm.uuid
-		});
+		if (vm.listServices) {
+			if (!zones[ent.zone])
+				zones[ent.zone] = {};
+			if (!zones[ent.zone][name])
+				zones[ent.zone][name] = [];
+			var recs = zones[ent.zone][name];
+			var target = primaryName(vm, config) + '.' + ent.zone;
+			recs.push({
+				constructor: 'SRV',
+				args: [target, port],
+				src: vm.uuid
+			});
+		}
 	}
 
 	function addACME(name) {
-- 
2.21.0

