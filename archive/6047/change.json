{"project":"joyent/sdc-agents-installer","branch":"master","id":"If1001d8b81ab5cd1bc53f2fbaa205c8d1f2d100a","number":"6047","subject":"TRITON-1368 agentsshar should store artifacts in paths that reflect its contents Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/6047","commitMessage":"TRITON-1368 agentsshar should store artifacts in paths that reflect its contents\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1554408473,"lastUpdated":1561725635,"open":false,"status":"MERGED","comments":[{"timestamp":1554408473,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1554408478,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1554408481,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit f19312799f3f7c65058e4474a9cba0914fc162b9\n    \n    TRITON-1368 agentsshar should store artifacts in paths that reflect its contents"},{"timestamp":1554720422,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1554720427,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1554720428,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 378ac99606ef5612797c14830ca78de45a5aa64f\n    \n    Update README.md to reflect use of $(BUILDNAME)"},{"timestamp":1554722093,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nI did a build of sdc-agents-installer of these bits on a private branch, specifying a \u0027BUILDNAME\u0027 of \u0027master\u0027.\n\nI then followed up with a timf-headnode build (the lullaby conversion of it) specifying the artifacts this build produced - effectively a build.spec.local file of:\n\n{\n    \"files\": {\n        \"agents\": {\n            \"branch\": \"grr-TRITON-1368-master\"\n        },\n        \"agents_md5\": {\n            \"branch\": \"grr-TRITON-1368-master\"\n        }\n    }\n}\n\nand it seemed to almost the right thing, pulling in our custom agents-shar archive, and generating:\n\n/Joyent_Dev/stor/timf-builds/headnode/master-20190408T104428Z-g0ba2b28-grr-TRITON-1368-master-master/*\n\n[I say, \"almost\" because I think the headnode build should be adding the unique-branches list after the initial \u0027master-\u0027 field of the directory name rather than after the git-hash, but that\u0027s not this specific bug, and creating a \u0027master-latest\u0027 symlink for this headnode build isn\u0027t correct, it should be \u0027master-[unique list of branches]-latest\u0027 ]\n\n\nSee:\nhttps://jenkins.joyent.us/view/lullaby-phase2/job/agentsshar/5262/console\n\nand \n\nhttps://jenkins.joyent.us/view/lullaby-phase4/job/timf-headnode/26/console"},{"timestamp":1559213118,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nI\u0027m just dusting off this change after the remaining lullaby changes integrated. I re-ran the experiment from the beginning of April to make sure it\u0027s still correct.\n\nSpecifically:\n\nhttps://jenkins.joyent.us/job/agentsshar/5346/console is an agents-installer build giving us:\n/Joyent_Dev/public/builds/agentsshar/grr-TRITON-1368-master-20190530T100517Z-g378ac99//agentsshar/agents-grr-TRITON-1368-master-20190530T100542Z-g378ac99.sh\n\nand\n\nhttps://jenkins.joyent.us/job/headnode/3395/console is a headnode build with the CONFIGURE_BRANCHES parameter:\n\n\"agents: grr-TRITON-1368-master\"\n\ngiving us:\n\n/Joyent_Dev/public/builds/headnode/master-grr-TRITON-1368-master-20190530T102118Z-g1e0a1e0//headnode/coal-master-grr-TRITON-1368-master-20190530T102118Z-g1e0a1e0-4gb.tgz"},{"timestamp":1559768183,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1560519936,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1560522274,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1560525431,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1560525435,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560525436,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 696f358341ea7807fc933325fda6c88f375e6fc3\n    \n    TRITON-1368 agentsshar should store artifacts in paths that reflect its contents"},{"timestamp":1560525513,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n\u003e New commits:\n \u003e \n \u003e commit 696f358341ea7807fc933325fda6c88f375e6fc3\n \u003e \n \u003e TRITON-1368 agentsshar should store artifacts in paths that reflect\n \u003e its contents\n\nI built this using a bunch of real and fake branches, giving us:\n\nhttps://jenkins.joyent.us/job/agentsshar/5365/console\n\nwhich wrote artifacts to:\n\n/Joyent_Dev/public/builds/agentsshar/grr-TRITON-1368-nosuchbranch-release-20190523-master-20190614T145019Z-g696f358"},{"timestamp":1561494958,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1\n\nseems fine to me!"},{"timestamp":1561568822,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1561637788,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1561637802,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nThanks for the reviews!"},{"timestamp":1561637822,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n\u003e Thanks for the reviews!\n\nyay, I lost my own +1s. D\u0027oh."},{"timestamp":1561725635,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"4","revision":"f1001d8b81ab5cd1bc53f2fbaa205c8d1f2d100a","parents":["f85758a3b432e9b4b4e83ffe85bbc3684b985e3e"],"ref":"refs/changes/47/6047/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1561637788,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560525435,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561494958,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561568822,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1561725635,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":10,"deletions":-12}],"sizeInsertions":32,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"dd4114b01f32235699246e7cc53d44e5c071e1ac","parents":["f85758a3b432e9b4b4e83ffe85bbc3684b985e3e"],"ref":"refs/changes/47/6047/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554408473,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554408478,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":16,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":9,"deletions":-11}],"sizeInsertions":25,"sizeDeletions":-11},{"number":"2","revision":"21163dda4510d581440a6ff64a9c52bb2847328b","parents":["f85758a3b432e9b4b4e83ffe85bbc3684b985e3e"],"ref":"refs/changes/47/6047/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554720422,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554720427,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"mk-agents-shar","line":211,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Was it intentional the drop the \"$GITDESCRIBE\" here?"},{"file":"mk-agents-shar","line":211,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Good question, I don\u0027t think it was intentional to drop the $GITDESCRIBE, but I\u0027ll re-test to make sure. I\u0027m fairly sure we should keep it, despite $GITDESCRIBE only describing sdc-agents-installer.git."},{"file":"mk-agents-shar","line":286,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"IIUC, `AGENTS_BRANCH_NAMES` will be the empty string if `-b ...` isn\u0027t used. Doesn\u0027t that mean we\u0027ll be getting filenames and strings with double-hyphen in them (here and in other parts of this patch) when `-b ...` isn\u0027t used?"},{"file":"mk-agents-shar","line":286,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"That\u0027s correct, but the way we\u0027re calling this from the Makefile, -b is always set to something non-zero. I\u0027ll verify to make sure, but it\u0027s probably worth having code in this script to blow up if we do have an empty $AGENTS_BRANCH_NAMES."},{"file":"mk-agents-shar","line":286,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"ah, we already have this check on line 335."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":16,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":9,"deletions":-11}],"sizeInsertions":30,"sizeDeletions":-11},{"number":"3","revision":"2f78326ff4e1d19fc62e12146069b7a0cb7fad19","parents":["f85758a3b432e9b4b4e83ffe85bbc3684b985e3e"],"ref":"refs/changes/47/6047/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1560525431,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560525435,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561568822,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561494958,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":10,"deletions":-12}],"sizeInsertions":32,"sizeDeletions":-13},{"number":"4","revision":"f1001d8b81ab5cd1bc53f2fbaa205c8d1f2d100a","parents":["f85758a3b432e9b4b4e83ffe85bbc3684b985e3e"],"ref":"refs/changes/47/6047/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1561637788,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560525435,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561568822,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561494958,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1561725635,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":10,"deletions":-12}],"sizeInsertions":32,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}