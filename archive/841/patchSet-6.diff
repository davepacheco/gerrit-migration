From 4089019acd07614a205eaf823b3988073d130772 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 14 Nov 2016 20:03:04 +0100
Subject: [PATCH] TOOLS-1559 wrap sapiadm and manta-login to avoid RBAC break
 Reviewed by: Trent Mick <trent.mick@joyent.com>

---
 scripts/headnode.sh         | 22 ++++++++++++++--------
 scripts/setup_manta_zone.sh |  9 +++++++--
 2 files changed, 21 insertions(+), 10 deletions(-)

diff --git a/scripts/headnode.sh b/scripts/headnode.sh
index 2c27d7d4..d5fa6345 100755
--- a/scripts/headnode.sh
+++ b/scripts/headnode.sh
@@ -788,14 +788,20 @@ if setup_state_not_seen "sdczones_created"; then
         mv ${file} /opt/smartdc/bin/${tool}
     done
 
-    # Copy sapiadm into the GZ from the SAPI zone.
-    zone_uuid=$(vmadm lookup tags.smartdc_role=sapi | head -n 1)
-    if [[ -n ${zone_uuid} ]]; then
-        from_dir=/zones/${zone_uuid}/root/opt/smartdc/config-agent/cmd
-        to_dir=/opt/smartdc/bin
-        rm -f ${to_dir}/sapiadm
-        ln -s ${from_dir}/sapiadm.js ${to_dir}/sapiadm
-    fi
+    # Create wrapper for sapiadm into the GZ and execute it from
+    # the config agent.
+
+    from_dir=/opt/smartdc/agents/lib/node_modules/config-agent
+    to_dir=/opt/smartdc/bin
+    rm -f ${to_dir}/sapiadm
+
+    # BEGIN BASHSTYLED
+    cat <<EOF > ${to_dir}/sapiadm
+#!/bin/bash
+exec ${from_dir}/build/node/bin/node ${from_dir}/cmd/sapiadm.js "\$@"
+EOF
+    # END BASHSTYLED
+    chmod +x ${to_dir}/sapiadm
 
     setup_state_add "sdczones_created"
 fi
diff --git a/scripts/setup_manta_zone.sh b/scripts/setup_manta_zone.sh
index 90a5ad18..08bf517c 100755
--- a/scripts/setup_manta_zone.sh
+++ b/scripts/setup_manta_zone.sh
@@ -169,9 +169,14 @@ function copy_manta_tools {
         rm -f ${to_dir}/manta-oneach
 
         mkdir -p /opt/smartdc/manta-deployment/log
-        # manta-login is a bash script, so we can link it directly.
-        ln -s ${from_dir}/bin/manta-login ${to_dir}/manta-login
 
+        # While manta-login is a bash script and we could link it directly,
+        # we are using a little wrapper to avoid permission issues on the GZ.
+        cat <<EOF > ${to_dir}/manta-login
+#!/bin/bash
+exec ${from_dir}/bin/manta-login "\$@"
+EOF
+        chmod +x ${to_dir}/manta-login
         #
         # manta-adm and manta-oneach are node programs, so we must write little
         # wrappers that call the real version using the node delivered in the
-- 
2.21.0

