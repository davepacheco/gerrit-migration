{"project":"joyent/sdc-headnode","branch":"master","id":"I4089019acd07614a205eaf823b3988073d130772","number":"841","subject":"TOOLS-1559 wrap sapiadm and manta-login to avoid RBAC break Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/841","commitMessage":"TOOLS-1559 wrap sapiadm and manta-login to avoid RBAC break\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1478175290,"lastUpdated":1479150248,"open":false,"status":"MERGED","comments":[{"timestamp":1478175290,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1478175342,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1478175548,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1478175810,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478291089,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1478511950,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1478512121,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478512147,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(3 comments)\n\nTrent, done with the suggested changes"},{"timestamp":1479147984,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1479148036,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1479148229,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5: Published edit on patch set 4."},{"timestamp":1479148342,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1479150223,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1479150242,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1479150248,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"7","revision":"4fcf5d5465b15953e1492b9fe00232595b905725","parents":["c2d36c4d850a81d2af81f665fe987e67f7dea93b"],"ref":"refs/changes/41/841/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479150242,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1479150248,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"2a731a6951d287b16585a8a1e9a1fc14b6569d04","parents":["26b0feb207919293098a1eba70d41d324642a4f5"],"ref":"refs/changes/41/841/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478175290,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1478175342,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"scripts/headnode.sh","line":799,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line exceeds 80 columns"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":14,"sizeDeletions":-5},{"number":"2","revision":"a8ccc24716130b545f4937d8d02f5c3294e8b2b0","parents":["26b0feb207919293098a1eba70d41d324642a4f5"],"ref":"refs/changes/41/841/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478175548,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478175810,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"scripts/headnode.sh","line":791,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hey, I just realized (a) sapiadm lives in the *config-agent* repo and (b) we have config-agent in the GZ now. So this works:\n\n```\n[root@headnode (coal) ~]# /opt/smartdc/agents/lib/node_modules/config-agent/build/node/bin/node /opt/smartdc/agents/lib/node_modules/config-agent/cmd/sapiadm.js\nAdminister SAPI objects\n\nUsage:\n```\n\nHow about we change the code here to just execute that one. Then we don\u0027t add the artificial dependency on a \u0027sapi\u0027 zone existing on the headnode.\n\nActually if we change https://github.com/joyent/sdc-config-agent/blob/master/cmd/sapiadm.js#L1 to\n\n```\n#!/opt/smartdc/agents/lib/node_modules/config-agent/build/node/bin/node\n```\n\nThen the code here could just add a symlink:\n\n```\nln -s /opt/smartdc/agents/lib/node_modules/config-agent/bin/sapiadm /opt/smartdc/bin/sapiadm\n```\n\nThat shebang line change *would* currently break using /opt/smartdc/config-agent/bin/sapiadm *in a zone*, but (a) I don\u0027t know any code that uses that and (b) it is only working by accident anyway (as long as config-agent *and* the platform node both use the same v0.10)."},{"file":"scripts/headnode.sh","line":791,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027ve just modified it to use config-agent sapiadm instead of SAPI\u0027s zone one.\n\nGiven the wrapper we\u0027re adding is pretty simple I don\u0027t think it\u0027s worth breaking the shebang line into the config-agent zones, at least not to make it point to the GZ setup. We should probably change it to use something like `/usr/bin/env node` and just call it properly from wherever we\u0027re using it.\n\nAnyway, not part of this issue, though"},{"file":"scripts/headnode.sh","line":791,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Sure to not be part of this issue. Given that \u0027using sapiadm in a zone\u0027 only works by accident (if the GZ and the zone\u0027s config-agent are using the same node... I think it *should* explicitly break if not run from the GZ. :)"},{"file":"scripts/setup_manta_zone.sh","line":173,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"W\" and finish with a period pretty please. I like comments with complete sentences."},{"file":"scripts/setup_manta_zone.sh","line":173,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"scripts/setup_manta_zone.sh","line":175,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Don\u0027t use the \u0027-\u0027 if not using the tab-indented trick that the next heredoc is using."},{"file":"scripts/setup_manta_zone.sh","line":175,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":16,"sizeDeletions":-5},{"number":"3","revision":"7bdcbcdb02e6ee9307a610c685549464c0bd3316","parents":["26b0feb207919293098a1eba70d41d324642a4f5"],"ref":"refs/changes/41/841/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478511950,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478512121,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"scripts/setup_manta_zone.sh","line":174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"typo?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-10},{"number":"4","revision":"667e2a6e306a1833420c1d7c1dc1f7231d9be7b7","parents":["c2d36c4d850a81d2af81f665fe987e67f7dea93b"],"ref":"refs/changes/41/841/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479148036,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478512121,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-10},{"number":"5","revision":"2a058fc33379d8f79f430eb4296762e8cbc0dd6c","parents":["c2d36c4d850a81d2af81f665fe987e67f7dea93b"],"ref":"refs/changes/41/841/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479148229,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-10},{"number":"6","revision":"4089019acd07614a205eaf823b3988073d130772","parents":["26b0feb207919293098a1eba70d41d324642a4f5"],"ref":"refs/changes/41/841/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479150223,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-10},{"number":"7","revision":"4fcf5d5465b15953e1492b9fe00232595b905725","parents":["c2d36c4d850a81d2af81f665fe987e67f7dea93b"],"ref":"refs/changes/41/841/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1479150242,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479148342,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1479150248,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"scripts/headnode.sh","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"scripts/setup_manta_zone.sh","type":"MODIFIED","insertions":7,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-10}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}]}