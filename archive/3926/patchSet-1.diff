From 3d5c6598937bb7f2819f1ea081bca8bb1b69980d Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Wed, 9 May 2018 14:28:44 -0700
Subject: [PATCH] TRITON-375 node-moray should expose similar metrics to moray
 server

---
 docs/man/man3/moray.md | 7 ++++++-
 lib/client.js          | 9 ++++++++-
 lib/fast_connection.js | 8 +++++---
 package.json           | 4 ++--
 4 files changed, 21 insertions(+), 7 deletions(-)

diff --git a/docs/man/man3/moray.md b/docs/man/man3/moray.md
index 4ddab86..1e4b95e 100644
--- a/docs/man/man3/moray.md
+++ b/docs/man/man3/moray.md
@@ -1,4 +1,4 @@
-# moray 3 "January 2017" Moray "Moray Client Library"
+# moray 3 "May 2018" Moray "Moray Client Library"
 
 ## NAME
 
@@ -205,6 +205,11 @@ All constructor invocations must also provide one of the following:
 
 Callers may also provide:
 
+`collector` (object)
+  An [artedi](https://github.com/joyent/node-artedi) metrics collector. This
+  will be passed to the underlying node-fast component which will add metrics
+  for count and duration of RPC calls.
+
 `cueballOptions` (object)
   Overrides cueball-related options, including various timeouts and delays.
   For specific options that can be overridden here, see the source.  **NOTE:
diff --git a/lib/client.js b/lib/client.js
index 1a2a6da..c2c08f0 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -81,6 +81,7 @@ function MorayClient(options) {
     EventEmitter.call(this);
 
     assert.object(options, 'options');
+    assert.optionalObject(options.collector, 'options.collector');
     assert.object(options.log, 'options.log');
     assert.optionalBool(options.unwrapErrors, 'options.unwrapErrors');
     assert.optionalBool(options.failFast, 'options.failFast');
@@ -108,6 +109,11 @@ function MorayClient(options) {
 
     this.log.debug(coptions, 'init');
 
+    /* Optional artedi metrics collector that we'll pass to fast, if set. */
+    if (options.collector) {
+        this.collector = options.collector;
+    }
+
     if (coptions.mode == 'srv') {
         resolverInput = cueballOptions.domain;
     } else {
@@ -327,6 +333,7 @@ MorayClient.prototype.createFastConnection =
 
     return (new FastConnection({
         'address': backend.address,
+        'collector': this.collector,
         'port': backend.port,
         'nRecentRequests': fastNRecentRequests,
         'tcpKeepAliveInitialDelay': dflClientTcpKeepAliveIdle,
diff --git a/lib/fast_connection.js b/lib/fast_connection.js
index d9d8781..22d6773 100644
--- a/lib/fast_connection.js
+++ b/lib/fast_connection.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -43,6 +43,7 @@ module.exports = FastConnection;
 function FastConnection(args) {
     assert.object(args, 'args');
     assert.string(args.address, 'args.address');
+    assert.optionalObject(args.collector, 'args.collector');
     assert.number(args.port, 'args.port');
     assert.object(args.log, 'args.log');
     assert.number(args.nRecentRequests, 'args.nRecentRequests');
@@ -60,9 +61,10 @@ function FastConnection(args) {
     this.fc_sock = net.createConnection(args.port, args.address);
     this.fc_destroyed = false;
     this.fc_fast = new fast.FastClient({
+        'collector': args.collector, /* Optional: artedi metrics collector */
+        'log': args.log,
         'nRecentRequests': args.nRecentRequests,
-        'transport': this.fc_sock,
-        'log': args.log
+        'transport': this.fc_sock
     });
 
     /*
diff --git a/package.json b/package.json
index 4f4282c..af7c2a5 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "moray",
     "description": "Moray client library",
-    "version": "3.4.2",
+    "version": "3.5.0",
     "author": "Joyent (joyent.com)",
     "keywords": [ "moray" ],
     "main": "./lib/index.js",
@@ -16,7 +16,7 @@
         "cmdutil": "^1.1.0",
         "cueball": "^2.3.0",
         "extsprintf": "^1.3.0",
-        "fast": "^2.1.0",
+        "fast": "^2.5.0",
         "libuuid": "0.2.1",
         "jsprim": "^1.3.0",
         "posix-getopt": "^1.0.0",
-- 
2.21.0

