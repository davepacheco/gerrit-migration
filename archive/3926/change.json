{"project":"joyent/node-moray","branch":"master","id":"Ibc95560d706f3adfc296dbd599279e80c79aaba6","number":"3926","subject":"TRITON-375 node-moray should expose similar metrics to moray server Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/3926","commitMessage":"TRITON-375 node-moray should expose similar metrics to moray server\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1525901324,"lastUpdated":1527635169,"open":false,"status":"MERGED","comments":[{"timestamp":1525901324,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1525901326,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit f47d50ce8573504346f1a5d42f000fa7bcb656ca\n    \n    TRITON-375 node-moray should expose similar metrics to moray server"},{"timestamp":1525901348,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525902674,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1525903849,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1525907553,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1525907555,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit e2ae9c061962191aacf1395ca0a5c274ffbb5928\n    \n    updates based on CR feedback"},{"timestamp":1525907560,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1525907578,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525908986,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1526080028,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThis looks great.  Is there any way we could exercise it from a CLI?  It may be tough if we don\u0027t have any CLI programs long-lived enough to fetch metrics from it.\n\nWhat about testing?  Even validating that the client can make an RPC both with and without the collector specified seems worthwhile, if it\u0027s possible?"},{"timestamp":1526344764,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n\u003e This looks great.  Is there any way we could exercise it from a\n \u003e CLI?  It may be tough if we don\u0027t have any CLI programs long-lived\n \u003e enough to fetch metrics from it.\n \u003e \n \u003e What about testing?  Even validating that the client can make an\n \u003e RPC both with and without the collector specified seems worthwhile,\n \u003e if it\u0027s possible?\n\nI could add a cmdline option to the bin/* tools such that they\u0027d print the metrics on exit. That would at least show it working with or without the collector and give something to show it\u0027s working at least. What do you think? If you think I should do this, do you have a suggestion for a cmdline flag?"},{"timestamp":1526427347,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1526427348,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 63951306770ee5a629b7685d661939aae0d69e8f\n    \n    allow getobject to dump metrics to stderr for validating functionality"},{"timestamp":1526427370,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1526427534,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nI added an example of what I was thinking to bin/getobject. If you do nothing, it works fine and doesn\u0027t use a collector (showing that still works). If you run like:\n\nDUMP_ARTEDI_METRICS\u003d1\n\nit will dump the artedi metrics to stderr after it has run, looklng like:\n\n    [artedi metrics]\n    # HELP fast_client_requests_completed count of fast client requests completed\n    # TYPE fast_client_requests_completed counter\n    fast_client_requests_completed{rpcMethod\u003d\"getObject\",service\u003d\"getobject\"} 1\n    # HELP fast_client_request_time_ms end-to-end fast client request duration\n    # TYPE fast_client_request_time_ms histogram\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",service\u003d\"getobject\",le\u003d\"76\"} 0\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",service\u003d\"getobject\",le\u003d\"228\"} 1\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",service\u003d\"getobject\",le\u003d\"380\"} 1\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",service\u003d\"getobject\",le\u003d\"532\"} 1\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",service\u003d\"getobject\",le\u003d\"684\"} 1\n    fast_client_request_time_ms{le\u003d\"+Inf\",rpcMethod\u003d\"getObject\",service\u003d\"getobject\"} 1\n    fast_client_request_time_ms_count{rpcMethod\u003d\"getObject\",service\u003d\"getobject\"} 1\n    fast_client_request_time_ms_sum{rpcMethod\u003d\"getObject\",service\u003d\"getobject\"} 84"},{"timestamp":1526427601,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nSomehow gerrit ate my command:\n\n    DUMP_ARTEDI_METRICS\u003d1 ./bin/getobject [...]"},{"timestamp":1526427787,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1526427788,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 707e8db2424558411dc55c17c66d7de80fbe5885\n    \n    fix make check"},{"timestamp":1526427811,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526428119,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nIf the getobject POC I added works to satisfy the requirement that there be a CLI tool for testing, should I do that for all the tools in bin/*?"},{"timestamp":1526496015,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n\u003e If the getobject POC I added works to satisfy the requirement that\n \u003e there be a CLI tool for testing, should I do that for all the tools\n \u003e in bin/*?\n\nI hadn\u0027t thought about just dumping out the metrics at the end -- I like it. \n\nI think you could add this to all of the tools in one go by adding the code to lib/cmd.js.  You\u0027d have to update \"commonUsage\", parseCliOptions (a new switch case), and parseCommonCliOption, but I think the changes would be pretty minimal.  In each of the commands, I think you\u0027d just have to add one line to call a new function like \"cliFinish()\" or something, which would dump the metrics.\n\nI\u0027m not sure it\u0027s strictly required, but I think it would really useful!"},{"timestamp":1526508957,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1526508958,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 7ec455780338c5255a5d6a230abbd8005a0518f2\n    \n    add -A flag to all cli tools"},{"timestamp":1526508980,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526509057,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nWith the latest change I made, all bin/* tools support the -A flag to output artedi metrics to stderr at the completion of execution. For example:\n\n    airhammer:node-moray joshw$ ./bin/morayping -A -h 127.0.0.1 -p 2020\n    [artedi metrics]\n    # HELP fast_client_requests_completed count of fast client requests completed\n    # TYPE fast_client_requests_completed counter\n    fast_client_requests_completed{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\"} 1\n    # HELP fast_client_request_time_ms end-to-end fast client request duration\n    # TYPE fast_client_request_time_ms histogram\n    fast_client_request_time_ms{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\",le\u003d\"8.1\"} 0\n    fast_client_request_time_ms{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\",le\u003d\"25\"} 0\n    fast_client_request_time_ms{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\",le\u003d\"42\"} 0\n    fast_client_request_time_ms{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\",le\u003d\"59\"} 0\n    fast_client_request_time_ms{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\",le\u003d\"76\"} 1\n    fast_client_request_time_ms{le\u003d\"+Inf\",rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\"} 1\n    fast_client_request_time_ms_count{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\"} 1\n    fast_client_request_time_ms_sum{rpcMethod\u003d\"ping\",cmdName\u003d\"morayping\"} 68\n\n    airhammer:node-moray joshw$ ./bin/morayping -h 127.0.0.1 -p 2020\n    airhammer:node-moray joshw$ echo $?\n    0\n    airhammer:node-moray joshw$ ./bin/getobject -A -h 127.0.0.1 -p 2020 vmapi_vms b8c387f3-010e-4ebf-b17b-24b585c60eaf | head\n    {\n      \"bucket\": \"vmapi_vms\",\n      \"key\": \"b8c387f3-010e-4ebf-b17b-24b585c60eaf\",\n      \"value\": {\n        \"uuid\": \"b8c387f3-010e-4ebf-b17b-24b585c60eaf\",\n        \"alias\": \"fwapi0\",\n        \"autoboot\": true,\n        \"brand\": \"joyent-minimal\",\n        \"billing_id\": \"4769a8f9-de51-4c1e-885f-c3920cc68137\",\n        \"cpu_cap\": 300,\n    [artedi metrics]\n    # HELP fast_client_requests_completed count of fast client requests completed\n    # TYPE fast_client_requests_completed counter\n    fast_client_requests_completed{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\"} 1\n    # HELP fast_client_request_time_ms end-to-end fast client request duration\n    # TYPE fast_client_request_time_ms histogram\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\",le\u003d\"76\"} 0\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\",le\u003d\"228\"} 1\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\",le\u003d\"380\"} 1\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\",le\u003d\"532\"} 1\n    fast_client_request_time_ms{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\",le\u003d\"684\"} 1\n    fast_client_request_time_ms{le\u003d\"+Inf\",rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\"} 1\n    fast_client_request_time_ms_count{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\"} 1\n    fast_client_request_time_ms_sum{rpcMethod\u003d\"getObject\",cmdName\u003d\"getobject\"} 80\n\n    airhammer:node-moray joshw$ ./bin/getobject -h 127.0.0.1 -p 2020 vmapi_vms b8c387f3-010e-4ebf-b17b-24b585c60eaf | head\n    {\n      \"bucket\": \"vmapi_vms\",\n      \"key\": \"b8c387f3-010e-4ebf-b17b-24b585c60eaf\",\n      \"value\": {\n        \"uuid\": \"b8c387f3-010e-4ebf-b17b-24b585c60eaf\",\n        \"alias\": \"fwapi0\",\n        \"autoboot\": true,\n        \"brand\": \"joyent-minimal\",\n        \"billing_id\": \"4769a8f9-de51-4c1e-885f-c3920cc68137\",\n        \"cpu_cap\": 300,\n    airhammer:node-moray joshw$"},{"timestamp":1526509239,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nThe only further change that I know that I need to make at this point, is that there\u0027s going to be a new node-fast version to fix joyent/node-fast#19. Once that\u0027s fixed, I\u0027ll need to update the package.json here to point to the new version. Otherwise, please let me know if there\u0027s anything else I need to change while waiting on that."},{"timestamp":1526512409,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1526515117,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1526516493,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 6."},{"timestamp":1526516494,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit e1ee7efdf3266a9b55a8e4bac5af2222c9f0dfd5\n    \n    addres CR feedback"},{"timestamp":1526516518,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526516608,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nTo test the latest changes which address dap\u0027s comments, I manually changed lib/cmd.js to use a bad formatter when calling collector.collect. That resulted in an error as expected and an exit code of 1.\n\nI also tested that with the changes as-is, getobject works with and without the -A option and includes metrics with a label cmdName when using -A."},{"timestamp":1526517291,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1527199088,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6:\n\nanything else blocking IA?"},{"timestamp":1527281998,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\nAssuming you\u0027re looking to me for IA?  I\u0027m happy to take a look, though don\u0027t feel obligated to wait on me if somebody else is comfortable and able to do it.\n\nCould you add testing notes to the ticket?"},{"timestamp":1527282143,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1527526387,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 7."},{"timestamp":1527526388,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit dc567c76edd913a281170ad4e15f94c3fbd61262\n    \n    make manpages"},{"timestamp":1527526412,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527529866,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7:\n\nTesting notes have been added to the ticket."},{"timestamp":1527606841,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7: Code-Review+1\n\nNice!  The screenshot is a reminder of how useful this will be.\n\nI think you probably want to run the Moray test suite as well -- I think that\u0027s standard for all changes to Moray and node-moray.  That will also sanity test each of the commands, too."},{"timestamp":1527626921,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7:\n\n\u003e Nice!  The screenshot is a reminder of how useful this will be.\n \u003e \n \u003e I think you probably want to run the Moray test suite as well -- I\n \u003e think that\u0027s standard for all changes to Moray and node-moray. \n \u003e That will also sanity test each of the commands, too.\n\nI\u0027ve now also run this. Output in the ticket."},{"timestamp":1527627692,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7: Integration-Approval+1"},{"timestamp":1527635102,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1527635169,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"8","revision":"bc95560d706f3adfc296dbd599279e80c79aaba6","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1527635102,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527526412,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527606841,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527627692,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1527635169,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/delbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delmany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/findobjects","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/gettokens","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/listbuckets","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayping","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayversion","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"bin/sql","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/updatemany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/cmd.js","type":"MODIFIED","insertions":71,"deletions":-18},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"man/man3/moray.3","type":"MODIFIED","insertions":22,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":153,"sizeDeletions":-41},"patchSets":[{"number":"1","revision":"3d5c6598937bb7f2819f1ea081bca8bb1b69980d","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1525901324,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525901348,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/fast_connection.js","line":46,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can you add this to the block above?"},{"file":"lib/fast_connection.js","line":46,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"sure. Thanks for catching."},{"file":"lib/fast_connection.js","line":64,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m not sure if this is possible today, but can/should we create a specialized collector with a label that\u0027s specific to this connection (similar to bunyan\u0027s `log.child`)?  It seems like it might be really useful to be able to count RPCs by backend, but I haven\u0027t worked out whether that\u0027s way too many metrics."},{"file":"lib/fast_connection.js","line":64,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This sort of thing isn\u0027t possible with the current node-artedi API. I don\u0027t think it would be terribly difficult to add something like this if we think it would be useful."},{"file":"lib/fast_connection.js","line":64,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think this sounds like it\u0027d be neat, but is it ok if we leave that for a different ticket?"},{"file":"lib/fast_connection.js","line":64,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Yeah, definitely."},{"file":"package.json","line":4,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"You could update the CHANGES.md file too."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":21,"sizeDeletions":-7},{"number":"2","revision":"8e28236f7f3997e263e542ea2aa684a5e89c2bd7","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1525907553,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525907578,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":28,"sizeDeletions":-7},{"number":"3","revision":"89d8346797e106dd52f02c435232b8668e2e0b98","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1526427347,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1526427370,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/getobject","line":89,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/getobject","type":"MODIFIED","insertions":22,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":51,"sizeDeletions":-8},{"number":"4","revision":"d48926a27fec44f2cfbb7ddf42b9d7c95fd1985c","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1526427787,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526427811,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/getobject","type":"MODIFIED","insertions":22,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":51,"sizeDeletions":-8},{"number":"5","revision":"c85e337c8472f190cdd818c54ffcb3dcbead1680","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1526508957,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526508980,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cmd.js","line":63,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Are there any operational errors that can happen here?  If so, can we print them out like a normal error message instead of throwing?  (If they can\u0027t, throwing here is fine.)"},{"file":"lib/cmd.js","line":63,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"The documentation https://github.com/joyent/node-artedi/blob/master/docs/API.md#collectorcollectformat-callbackerr-string mentions only errors \"during the execution of either triggers or collector serialization\". The code here is kinda hard to follow, but it looks like possible errors are actually pretty much anything thanks to the fact that you can pass in your own triggers. So I guess I\u0027ll print the error message if there is one. Thanks."},{"file":"lib/cmd.js","line":165,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This isn\u0027t actually accepted by the Moray client constructor, is it?\n\nIs there no place else we can put this to avoid passing it down to that constructor?"},{"file":"lib/cmd.js","line":165,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Correct, it\u0027s not used by the moray client constructor.\n\nWe could avoid passing it down if we change the parseCommonCliOption() function. Unfortunately the naming there is pretty poor currently so I\u0027ll have to make some changes to make that work. I\u0027ll do that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/delbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delmany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/findobjects","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/gettokens","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/listbuckets","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayping","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayversion","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"bin/sql","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/updatemany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/cmd.js","type":"MODIFIED","insertions":53,"deletions":-7},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":113,"sizeDeletions":-29},{"number":"6","revision":"5551a129dd15aec5b8aee6ad7b3c81d661f05290","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1526516493,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1526517291,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526516518,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/man/man3/moray.md","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you might need to `make manpages` and then add the built file to this change."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/delbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delmany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/findobjects","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/gettokens","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/listbuckets","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayping","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayversion","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"bin/sql","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/updatemany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/cmd.js","type":"MODIFIED","insertions":71,"deletions":-18},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":131,"sizeDeletions":-40},{"number":"7","revision":"62a0f300292c12d2fec412530c9834d4c2826862","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1527526387,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527606841,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527627692,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527526412,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/delbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delmany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/findobjects","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/gettokens","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/listbuckets","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayping","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayversion","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"bin/sql","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/updatemany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/cmd.js","type":"MODIFIED","insertions":71,"deletions":-18},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"man/man3/moray.3","type":"MODIFIED","insertions":22,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":153,"sizeDeletions":-41},{"number":"8","revision":"bc95560d706f3adfc296dbd599279e80c79aaba6","parents":["2a55cc89030dc0c7b488a515147cab4aac6041b0"],"ref":"refs/changes/26/3926/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1527635102,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527606841,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527627692,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527526412,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1527635169,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"bin/delbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delmany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/delobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/findobjects","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/getobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/gettokens","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/listbuckets","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayping","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/morayversion","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putbucket","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/putobject","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"bin/sql","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"bin/updatemany","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"docs/man/man3/moray.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/cmd.js","type":"MODIFIED","insertions":71,"deletions":-18},{"file":"lib/fast_connection.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"man/man3/moray.3","type":"MODIFIED","insertions":22,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":153,"sizeDeletions":-41}],"allReviewers":[{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}