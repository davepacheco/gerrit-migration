From b20cbe55a2aaacd7f33b7bac0df5f497689cd0e4 Mon Sep 17 00:00:00 2001
From: Brian Bennett <brian.bennett@joyent.com>
Date: Thu, 7 Dec 2017 10:09:56 -0800
Subject: [PATCH] joyent/manta-thoth#163 Publish install/update updates
 Reviewed by: Bryan Cantrill <bryan@joyent.com> Approved by: Bryan Cantrill
 <bryan@joyent.com>

---
 bin/sdc-thoth-install    | 2 +-
 bin/sdc-thoth-update     | 2 +-
 bin/sdc-thoth-update-all | 6 +++---
 tools/publish.sh         | 3 +++
 4 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/bin/sdc-thoth-install b/bin/sdc-thoth-install
index 25af95a..d05019c 100755
--- a/bin/sdc-thoth-install
+++ b/bin/sdc-thoth-install
@@ -106,7 +106,7 @@ if [ ! -d $base ]; then
 	tarball=/var/tmp/thoth.$$.tar.gz
 	staged=/tmp/thoth.$$.tar.gz
 	echo "Downloading thoth ..."
-	curl -k $MANTA_URL/thoth/public/thoth.tar.gz > $staged 2>&4
+	curl -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
 	echo "Downloading thoth to compute nodes ..."
 	sdc-oneachnode -a -g $staged -d /var/tmp 1>&2
 	echo "Installing thoth on compute nodes ..."
diff --git a/bin/sdc-thoth-update b/bin/sdc-thoth-update
index c268c23..65273de 100755
--- a/bin/sdc-thoth-update
+++ b/bin/sdc-thoth-update
@@ -60,7 +60,7 @@ fi
 tarball=/var/tmp/thoth.$$.tar.gz
 staged=/tmp/thoth.$$.tar.gz
 echo "Downloading thoth update ..."
-curl -k $MANTA_URL/thoth/public/thoth.tar.gz > $staged 2>&4
+curl -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
 echo "Updating thoth ..."
 cd / ; gzcat $staged | tar xf - ; rm $staged 1>&2
 echo "Done"
diff --git a/bin/sdc-thoth-update-all b/bin/sdc-thoth-update-all
index 8e2e547..d337e68 100755
--- a/bin/sdc-thoth-update-all
+++ b/bin/sdc-thoth-update-all
@@ -21,9 +21,9 @@ function onexit
 {
 	if [[ -f $backup ]]; then
 		cp $backup $hosts
-		rm $backup	
+		rm $backup
 	fi
-	
+
 	[[ $1 -ne 0 ]] || exit 0
 	fatal "error exit status $1"
 }
@@ -67,7 +67,7 @@ fi
 tarball=/var/tmp/thoth.$$.tar.gz
 staged=/tmp/thoth.$$.tar.gz
 echo "Downloading thoth ..."
-curl -k $MANTA_URL/thoth/public/thoth.tar.gz > $staged 2>&4
+curl -k $MANTA_URL/thoth/public/thoth-sunos-latest.tar.gz > $staged 2>&4
 echo "Downloading thoth to compute nodes ..."
 sdc-oneachnode -a -g $staged -d /var/tmp 1>&2
 echo "Installing thoth on compute nodes ..."
diff --git a/tools/publish.sh b/tools/publish.sh
index 09770cb..250a14f 100755
--- a/tools/publish.sh
+++ b/tools/publish.sh
@@ -7,4 +7,7 @@ name="thoth-${uname}-${ver:?}-${commit:?}.tar.gz"
 latest="thoth-${uname}-latest.tar.gz"
 
 mput -f "$name" "/thoth/public/$name"
+for c in install update update-all; do
+    mput -f "bin/sdc-thoth-$c" "/thoth/public/sdc-thoth-$c"
+done
 mln "/thoth/public/$name" "/thoth/public/$latest"
-- 
2.21.0

