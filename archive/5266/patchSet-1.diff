From a2db74ef6c96800f16438898eb3960fef65041f1 Mon Sep 17 00:00:00 2001
From: Ryan Zezeski <rpz@joyent.com>
Date: Tue, 18 Dec 2018 14:07:20 -0700
Subject: [PATCH] OS-7457 i40e Tx freezes on zero descriptors

---
 usr/src/uts/common/io/i40e/i40e_transceiver.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/usr/src/uts/common/io/i40e/i40e_transceiver.c b/usr/src/uts/common/io/i40e/i40e_transceiver.c
index f23cdc0135..0a34c4e2a7 100644
--- a/usr/src/uts/common/io/i40e/i40e_transceiver.c
+++ b/usr/src/uts/common/io/i40e/i40e_transceiver.c
@@ -2469,9 +2469,17 @@ i40e_ring_tx(void *arg, mblk_t *mp)
 		needed_desc++;
 	}
 
+	/*
+	 * The second condition ensures that 'itrq_desc_tail' never
+	 * equals 'itrq_desc_head'. This enforces the rule found in
+	 * section 8.4.3.1.5 (second bullet point) that declares the
+	 * TAIL pointer in I40E_QTX_TAIL should never overlap with the
+	 * head. This means that we only ever have 'itrq_tx_ring_size
+	 * - 1' total available descriptors.
+	 */
 	mutex_enter(&itrq->itrq_tx_lock);
 	if (itrq->itrq_desc_free < i40e->i40e_tx_block_thresh ||
-	    itrq->itrq_desc_free < needed_desc) {
+	    (itrq->itrq_desc_free - 1) < needed_desc) {
 		txs->itxs_err_nodescs.value.ui64++;
 		mutex_exit(&itrq->itrq_tx_lock);
 		goto txfail;
-- 
2.21.0

