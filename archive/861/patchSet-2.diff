From af8c94c7e3c1f535efaf123317425eebc638b6e7 Mon Sep 17 00:00:00 2001
From: Ryan Zezeski <rpz@joyent.com>
Date: Tue, 8 Nov 2016 14:40:11 -0500
Subject: [PATCH] OS-3506 dls and mac lock ordering isn't honored

---
 usr/src/uts/common/io/dls/dls_mgmt.c | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/usr/src/uts/common/io/dls/dls_mgmt.c b/usr/src/uts/common/io/dls/dls_mgmt.c
index 105c55c7ce..4acd20f6cb 100644
--- a/usr/src/uts/common/io/dls/dls_mgmt.c
+++ b/usr/src/uts/common/io/dls/dls_mgmt.c
@@ -1854,14 +1854,16 @@ dls_devnet_destroy(mac_handle_t mh, datalink_id_t *idp, boolean_t wait)
 	mac_perim_handle_t	mph;
 
 	*idp = DATALINK_INVALID_LINKID;
+
+	mac_perim_enter_by_mh(mh, &mph);
+
 	err = dls_devnet_unset(mac_name(mh), idp, wait);
-	if (err != 0 && err != ENOENT)
+	if (err != 0 && err != ENOENT) {
+		mac_perim_exit(mph);
 		return (err);
+	}
 
-	mac_perim_enter_by_mh(mh, &mph);
 	err = dls_link_rele_by_name(mac_name(mh));
-	mac_perim_exit(mph);
-
 	if (err != 0) {
 		/*
 		 * XXX It is a general GLDv3 bug that dls_devnet_set() has to
@@ -1873,6 +1875,8 @@ dls_devnet_destroy(mac_handle_t mh, datalink_id_t *idp, boolean_t wait)
 		(void) dls_devnet_set(mac_name(mh), *idp, crgetzoneid(CRED()),
 		    NULL);
 	}
+
+	mac_perim_exit(mph);
 	return (err);
 }
 
-- 
2.21.0

