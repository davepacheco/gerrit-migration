From 90b6dd81541224d5b406a57e81619ea119b61891 Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody@kkantor.com>
Date: Mon, 8 Apr 2019 17:41:57 +0000
Subject: [PATCH] OS-7709 metaslab load/unload counter kstats leak memory

---
 usr/src/uts/common/fs/zfs/metaslab.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/usr/src/uts/common/fs/zfs/metaslab.c b/usr/src/uts/common/fs/zfs/metaslab.c
index bcc705ac9e..98e1c7b98f 100644
--- a/usr/src/uts/common/fs/zfs/metaslab.c
+++ b/usr/src/uts/common/fs/zfs/metaslab.c
@@ -23,6 +23,7 @@
  * Copyright (c) 2011, 2018 by Delphix. All rights reserved.
  * Copyright (c) 2013 by Saso Kiselkov. All rights reserved.
  * Copyright (c) 2014 Integros [integros.com]
+ * Copyright 2019 Joyent, Inc.
  */
 
 #include <sys/zfs_context.h>
@@ -850,7 +851,10 @@ metaslab_group_passivate(metaslab_group_t *mg)
 	mg->mg_next = NULL;
 
 	if (mg->mg_kstat != NULL) {
+		metaslab_group_kstat_t *data = mg->mg_kstat->ks_data;
+
 		kstat_delete(mg->mg_kstat);
+		kmem_free(data, sizeof (metaslab_group_kstat_t));
 	}
 	mutex_destroy(&mg->mg_kstat_lock);
 }
-- 
2.21.0

