From 0584ab3028bc9206a4ba8c64dd170123b0f1046e Mon Sep 17 00:00:00 2001
From: Robert Mustacchi <rm@joyent.com>
Date: Tue, 15 Jan 2019 00:59:12 +0000
Subject: [PATCH] OS-7487 Prefer use of mwait on AMD Zen

---
 usr/src/uts/i86pc/os/cpuid.c | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/usr/src/uts/i86pc/os/cpuid.c b/usr/src/uts/i86pc/os/cpuid.c
index ddc09a4951..eafbfd45fd 100644
--- a/usr/src/uts/i86pc/os/cpuid.c
+++ b/usr/src/uts/i86pc/os/cpuid.c
@@ -2509,12 +2509,15 @@ cpuid_pass1(cpu_t *cpu, uchar_t *featureset)
 #if !defined(__xpv)
 		/*
 		 * Do not use MONITOR/MWAIT to halt in the idle loop on any AMD
-		 * processors.  AMD does not intend MWAIT to be used in the cpu
-		 * idle loop on current and future processors.  10h and future
-		 * AMD processors use more power in MWAIT than HLT.
-		 * Pre-family-10h Opterons do not have the MWAIT instruction.
+		 * processors.  AMD has not historically used MWAIT in the CPU's
+		 * idle loop. Pre-family-10h Opterons do not have the MWAIT
+		 * instruction. We know for certain that in at least family 17h,
+		 * per AMD, mwait is preferred. Families in-between are less
+		 * certain.
 		 */
-		idle_cpu_prefer_mwait = 0;
+		if (cpi->cpi_family < 0x17) {
+			idle_cpu_prefer_mwait = 0;
+		}
 #endif
 
 		break;
-- 
2.21.0

