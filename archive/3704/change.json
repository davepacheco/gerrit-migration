{"project":"joyent/illumos-joyent","branch":"vpc","id":"I9d3c97c77cbf9c8e7a35c54d93aa937e32458e55","number":"3704","subject":"Overlay fabric router","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/3704","commitMessage":"Overlay fabric router\n","createdOn":1521650223,"lastUpdated":1525883127,"open":false,"status":"ABANDONED","comments":[{"timestamp":1521650223,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1522097481,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1522688020,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3."},{"timestamp":1522788079,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3:\n\n(10 comments)\n\nI may have more later."},{"timestamp":1522800561,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(11 comments)"},{"timestamp":1522801070,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1522805922,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1522810614,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1522814292,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4."},{"timestamp":1522850403,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4:\n\n(4 comments)\n\nTwo small bugs and one comment nit left."},{"timestamp":1522878642,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1522884227,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4:\n\n(1 comment)\n\nThank you."},{"timestamp":1522884829,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 5."},{"timestamp":1522885967,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1525883127,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Abandoned\n\nOlder version, newer CR up with current approach"}],"currentPatchSet":{"number":"5","revision":"9d3c97c77cbf9c8e7a35c54d93aa937e32458e55","parents":["82087c163c56a08b7035398b3bb2f72a5657f703"],"ref":"refs/changes/04/3704/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1522884829,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522885967,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/overlay/overlay.c","type":"MODIFIED","insertions":21,"deletions":-19},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","type":"ADDED","insertions":477,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_target.c","type":"MODIFIED","insertions":178,"deletions":-70},{"file":"usr/src/uts/common/sys/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/overlay_impl.h","type":"MODIFIED","insertions":53,"deletions":-33},{"file":"usr/src/uts/common/sys/overlay_router.h","type":"ADDED","insertions":62,"deletions":0},{"file":"usr/src/uts/common/sys/overlay_target.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":796,"sizeDeletions":-125},"patchSets":[{"number":"1","revision":"9797cda932a36703cbf9647cf08456e534f61374","parents":["18c72eb41876b3accb94af053e84dd48c937b9ba"],"ref":"refs/changes/04/3704/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1521650223,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/overlay/overlay.c","type":"MODIFIED","insertions":2,"deletions":-18},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","type":"ADDED","insertions":317,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_target.c","type":"MODIFIED","insertions":49,"deletions":-38},{"file":"usr/src/uts/common/sys/overlay_impl.h","type":"MODIFIED","insertions":30,"deletions":-32}],"sizeInsertions":400,"sizeDeletions":-90},{"number":"2","revision":"aacc33172bd2e278064f5bcf4865afcc23a9169a","parents":["82087c163c56a08b7035398b3bb2f72a5657f703"],"ref":"refs/changes/04/3704/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1522097481,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/overlay/overlay.c","type":"MODIFIED","insertions":2,"deletions":-18},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","type":"ADDED","insertions":481,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_target.c","type":"MODIFIED","insertions":54,"deletions":-43},{"file":"usr/src/uts/common/sys/overlay_impl.h","type":"MODIFIED","insertions":41,"deletions":-35}],"sizeInsertions":580,"sizeDeletions":-98},{"number":"3","revision":"5d6f76527b0d7c43cf01386b05d13fce4bfafa68","parents":["82087c163c56a08b7035398b3bb2f72a5657f703"],"ref":"refs/changes/04/3704/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1522688020,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":90,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Does this comment reflect reality below?"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":103,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Needed? if {ofb_dst,orte-\u003eort_dest[i]} \u003d\u003d NULL, that\u0027s the same as not-found below, right?"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":103,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Hrm yeah, either ofb_dst will be set to the matching entry or the loop at line 137 will go through all the entries and end with ofb_dst set to NULL."},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":131,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"WHere\u0027s this lock acquired?"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":131,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"An excellent question :) It got missed in the churn, but it should be right before this so that no changes in topology can occur while we traverse the table (it\u0027s a bit of a coarse lock, but the thinking is the prefix checks + hold if found should be pretty quick, and that topology changes should be rare enough that the complexity of more granularity should hopefully not be needed."},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":150,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Same here - where\u0027s otr_lock held?"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":157,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"This same path gets hit for same-DC/cross-VLAN, right?"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":157,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yes"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":178,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"hton/ntoh madness?!?  Seems naive..."},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":178,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Maybe? -- what\u0027s done where isn\u0027t really obvious, so I wasn\u0027t sure what form these are going to be in."},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":374,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"overlay_get_vl3_ips() ?"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":374,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Sounds good to me."},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":97,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"These need comments and/or better names.  Part of my difficulty reading through this originates here.  I *think* I know what the tree is indexed by and what the tables are indexed by, but I\u0027m not 100% sure unless I jump all over."},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":145,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is this used anywhere?"},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":145,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"No, that\u0027s some vestigial bits from an earlier version that can be removed (I wasn\u0027t sure about each fabric having it\u0027s own list of targets vs. having one single hash of everything)."},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":148,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"membar_exit() prior to the atomic_dec...().  Both IPSA_REFRELE and ire_refrele() do this.  (Or does the volatile of ote_refcnt fix this?!)"},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":148,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I\u0027m not sure -- atomic_add(9F) doesn\u0027t indicate it\u0027s necessary, though it wouldn\u0027t be the first time a man page is misleading or wrong."},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":164,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Does this need to be a distinct flag?"},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":164,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I think so, though I\u0027m not 100% sure.  My thought was that overlay_target_entry_t\u0027s can hold either VL2 or VL3 + VL2 entries.  For stuff same DC, different vlan, it would prevent having both a VL2 and then a VL3 + VL2 entry for the same destination.\n\nIf say a CN has instances A \u0026 B on vlan 10 and instances C \u0026 D on vlan 20, we\u0027re going to have the VL2-\u003eUL3 mappings for stuff on vlans 10 \u0026 20 in the target cache.  If we then start to route between vlan 10 and vlan 20, instead of having a whole other set of VL3 + VL2 \u003d\u003e UL3 mappings for things in those two vlans, we can just populate the VL3 IP in the existing entries and use those."},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":164,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Okay."},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":175,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"This disappears with ofe_targ_list, right?"},{"file":"usr/src/uts/common/sys/overlay_impl.h","line":175,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yes"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":26,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"These are remote {vid,dcid,vlan}?"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":26,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yes"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":31,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"The MAC that the inner-packet\u0027s *source* should be set to?"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":31,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Yes"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":31,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Comments or better names, please.  :)"},{"file":"usr/src/uts/common/sys/overlay_target.h","line":205,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"If we go the flag route for a router VL2 Mac entry, it\u0027d need to be somewhere in here (or one of the constituent structures) -- or we could stay with the 0\u0027s /_ANY to flag that."},{"file":"usr/src/uts/common/sys/overlay_target.h","line":305,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"This is the flag to which you were referring earlier, right?"},{"file":"usr/src/uts/common/sys/overlay_target.h","line":305,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Not exactly -- these (overlay_targ_cache_\\*) interfaces aren\u0027t used for the normal lookup/reply routines.  You can apparently (though I\u0027m not 100% sure how, I think maybe through dladm) explicitly set/remove target entries analogous to manually arp entries, so these interfaces are for that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/overlay/overlay.c","type":"MODIFIED","insertions":21,"deletions":-19},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","type":"ADDED","insertions":457,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_target.c","type":"MODIFIED","insertions":178,"deletions":-70},{"file":"usr/src/uts/common/sys/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/overlay_impl.h","type":"MODIFIED","insertions":52,"deletions":-34},{"file":"usr/src/uts/common/sys/overlay_router.h","type":"ADDED","insertions":46,"deletions":0},{"file":"usr/src/uts/common/sys/overlay_target.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":759,"sizeDeletions":-126},{"number":"4","revision":"47956365bef5646ae0fe90c9a36f322cc737837f","parents":["82087c163c56a08b7035398b3bb2f72a5657f703"],"ref":"refs/changes/04/3704/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1522814292,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":151,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Possibly set ofb_dst \u003d NULL here if you don\u0027t break.  See below for why."},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":151,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":154,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"What if you run off the end? ofb_dst is not NULL in that case, it is orte-\u003eort_dest[i - 1].  Either check (orte-\u003eort_dest[i] !\u003d NULL) here or reset ofb_dst to NULL every loop (see above)."},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":154,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":182,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I think this needs an htons() too:\n\n  if (htons(evh-\u003eether_tpid) !\u003d ETHERTYPE_VLAN)"},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","line":182,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":26,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I should\u0027ve been clearer:\n\n /*\n  * A remote fabric network.\n  */\n typedef struct overlay_fabric {\n\n.  .  ."},{"file":"usr/src/uts/common/sys/overlay_router.h","line":26,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"It\u0027s not just \u0027remote\u0027 though -- it\u0027s really any fabric.  There should be entries for the fabrics present on the CN as well as any fabrics that are reachable but those local fabrics (if going between say two different vlans in the same DC, you still need this to determine the vlan id, even if the dcid and vid are the same).\n\nWould adding words to that effect be ok?"},{"file":"usr/src/uts/common/sys/overlay_router.h","line":26,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Yes, add those words!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/overlay/overlay.c","type":"MODIFIED","insertions":21,"deletions":-19},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","type":"ADDED","insertions":478,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_target.c","type":"MODIFIED","insertions":178,"deletions":-70},{"file":"usr/src/uts/common/sys/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/overlay_impl.h","type":"MODIFIED","insertions":53,"deletions":-33},{"file":"usr/src/uts/common/sys/overlay_router.h","type":"ADDED","insertions":52,"deletions":0},{"file":"usr/src/uts/common/sys/overlay_target.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":787,"sizeDeletions":-125},{"number":"5","revision":"9d3c97c77cbf9c8e7a35c54d93aa937e32458e55","parents":["82087c163c56a08b7035398b3bb2f72a5657f703"],"ref":"refs/changes/04/3704/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1522884829,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522885967,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/overlay/overlay.c","type":"MODIFIED","insertions":21,"deletions":-19},{"file":"usr/src/uts/common/io/overlay/overlay_router.c","type":"ADDED","insertions":477,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_target.c","type":"MODIFIED","insertions":178,"deletions":-70},{"file":"usr/src/uts/common/sys/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/overlay_impl.h","type":"MODIFIED","insertions":53,"deletions":-33},{"file":"usr/src/uts/common/sys/overlay_router.h","type":"ADDED","insertions":62,"deletions":0},{"file":"usr/src/uts/common/sys/overlay_target.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":796,"sizeDeletions":-125}],"allReviewers":[{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}