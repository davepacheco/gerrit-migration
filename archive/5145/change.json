{"project":"joyent/illumos-joyent","branch":"master","id":"I5b87e03ada692fb585a6a15a0cccfff5eb39e8ea","number":"5145","subject":"OS-7397 reduce lock contention in bhyve instr emul Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e Approved by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/5145","commitMessage":"OS-7397 reduce lock contention in bhyve instr emul\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\nApproved by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\n","createdOn":1543358885,"lastUpdated":1544038145,"open":false,"status":"MERGED","comments":[{"timestamp":1543358885,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1543591184,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1543592155,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1543592193,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1543592237,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1543592349,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1543838126,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1543865371,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1543869150,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1543869861,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1543869979,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1543870076,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1543870330,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5."},{"timestamp":1543870358,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\nbollocks, I forgot to amend the s/change/changing/ diff"},{"timestamp":1543870378,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1543871293,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Code-Review+1\n\nWell, so did I :)"},{"timestamp":1544028360,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1544028434,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1544037363,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1544037466,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1544038145,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"8","revision":"5b87e03ada692fb585a6a15a0cccfff5eb39e8ea","parents":["35384f5aac82fb54e996c2526a0fc6064466cf05"],"ref":"refs/changes/45/5145/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1544037466,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871293,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544028360,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544028434,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"SUBM","value":"1","grantedOn":1544038145,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":52,"deletions":-21}],"sizeInsertions":59,"sizeDeletions":-24},"patchSets":[{"number":"1","revision":"7f502d28200f9aaddd80b4ac53ac75df9784d746","parents":["6466dea896ec0283655f3eb5820688dd3a3e7ff2"],"ref":"refs/changes/45/5145/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543358885,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543591184,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1047,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Just out of curiosity, is there a specific reason you\u0027re not using our native atomic_dec_uint_nv() here and atomic_add_uint_nv() a few lines down?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1047,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"You\u0027re right, there\u0027s no reason to use the freebsd compat functions."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":54,"deletions":-21}],"sizeInsertions":61,"sizeDeletions":-24},{"number":"2","revision":"ac4b6ef9cb8726ffb17e97bdc77fdb3676af68b4","parents":["6466dea896ec0283655f3eb5820688dd3a3e7ff2"],"ref":"refs/changes/45/5145/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543592155,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":49,"deletions":-21}],"sizeInsertions":56,"sizeDeletions":-24},{"number":"3","revision":"7ee4bcba143244af718b01823eaeb9f54223c085","parents":["0ab0c69ec646299a62509ae4f83cd6fd04829575"],"ref":"refs/changes/45/5145/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543592237,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543592349,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","line":47,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Could this be \"vms_map_changing\" ?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1044,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m curious why you removed the VERIFY()."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1044,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It means less without the lock?  I could verify that we didn\u0027t underflow, I suppose?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1044,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Exactly. Been bitten enough times."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1044,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1096,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think this\u0027d be slightly less confusing if it was \"lock_held\", so we don\u0027t have to play double-negative in our head."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1096,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I can switch it if you feel strongly about it."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1096,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"It took me longer to read than the more common idiom, but it\u0027s of course no big deal."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1096,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m going to leave it this way for now."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1104,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I wonder if it\u0027s worth taking the time to make VIMPLY() ?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1104,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m not worried about it right now."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1158,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"You VERIFY() this elsewhere?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":1158,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Only in that delicate lockless hotpath.  I\u0027m not worried about it here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":49,"deletions":-21}],"sizeInsertions":56,"sizeDeletions":-24},{"number":"4","revision":"0f68a95a133a64773137e63ff786b6c6118e82c3","parents":["0ab0c69ec646299a62509ae4f83cd6fd04829575"],"ref":"refs/changes/45/5145/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543869861,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543870076,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":52,"deletions":-21}],"sizeInsertions":59,"sizeDeletions":-24},{"number":"5","revision":"03984347fe0ac6182eff952adb0828fe05cc5881","parents":["0ab0c69ec646299a62509ae4f83cd6fd04829575"],"ref":"refs/changes/45/5145/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543870330,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":52,"deletions":-21}],"sizeInsertions":59,"sizeDeletions":-24},{"number":"6","revision":"a81282e25b6251ef7bff075002a9bc63c8edc1ee","parents":["a5fdd1b56caa1353ecd2d0ada557c6f8085698c5"],"ref":"refs/changes/45/5145/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543870378,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544028360,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544028434,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871293,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":52,"deletions":-21}],"sizeInsertions":59,"sizeDeletions":-24},{"number":"7","revision":"c605b78798ff3af501f7b6203ffb93b853f800a1","parents":["35384f5aac82fb54e996c2526a0fc6064466cf05"],"ref":"refs/changes/45/5145/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1544037363,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544028360,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544028434,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871293,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":52,"deletions":-21}],"sizeInsertions":59,"sizeDeletions":-24},{"number":"8","revision":"5b87e03ada692fb585a6a15a0cccfff5eb39e8ea","parents":["35384f5aac82fb54e996c2526a0fc6064466cf05"],"ref":"refs/changes/45/5145/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1544037466,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1544038145,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544028360,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544028434,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871293,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_glue.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":52,"deletions":-21}],"sizeInsertions":59,"sizeDeletions":-24}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}