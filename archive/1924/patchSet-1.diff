From 64a0861a58a4732c6f814e58de21e39d5f4c208c Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 9 May 2017 14:47:08 -0700
Subject: [PATCH] TOOLS-1769 add 'make cutarelease' to triton-origin-image.git
 to tag it more easily

---
 CHANGES.md |  2 ++
 Makefile   | 27 ++++++++++++++++++++++++---
 2 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 08c390f..3cac770 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -2,6 +2,8 @@
 
 ## not yet released
 
+(nothing yet)
+
 ## 1.0.1
 
 - Bump the included pkgsrc curl from "curl-7.47.1" to "curl-7.51.0".
diff --git a/Makefile b/Makefile
index 53d4f3c..0e1f74c 100644
--- a/Makefile
+++ b/Makefile
@@ -54,9 +54,6 @@ build/image-0-stamp: build/buildinfo.json images.json
 publish: build/buildinfo.json
 	./tools/publish-images.sh -b build/buildinfo.json
 
-.PHONY: check
-check:
-	@echo "check ok"
 
 .PHONY: clean
 clean:
@@ -65,3 +62,27 @@ clean:
 .PHONY: distclean
 distclean: clean
 	rm -rf node_modules
+
+.PHONY: check
+check:: check-version
+	@echo "check ok"
+
+# Ensure CHANGES.md and package.json have the same version.
+.PHONY: check-version
+check-version:
+	@echo version is: $(shell cat package.json | json version)
+	[[ `cat package.json | json version` == `grep '^## ' CHANGES.md | head -2 | tail -1 | awk '{print $$2}'` ]]
+
+# This repo doesn't publish to npm, so a 'release' is just a tag.
+.PHONY: cutarelease
+cutarelease: check-version
+	[[ -z `git status --short` ]]  # If this fails, the working dir is dirty.
+	@which json 2>/dev/null 1>/dev/null && \
+	    ver=$(shell json -f package.json version) && \
+	    echo "** Are you sure you want to tag v$$ver?" && \
+	    echo "** Enter to continue, Ctrl+C to abort." && \
+	    read
+	ver=$(shell cat package.json | json version) && \
+	    date=$(shell date -u "+%Y-%m-%d") && \
+	    git tag -a "v$$ver" -m "version $$ver ($$date)" && \
+	    git push --tags origin
-- 
2.21.0

