{"project":"joyent/sdc-vmapi","branch":"master","id":"I7624390c21ce15799cfc02c420ed439bc71186aa","number":"6184","subject":"TRITON-1050 Add a guards to CNAPI servers and VMAPI VMs to prevent or allow migrations Reviewed by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e Approved by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/6184","commitMessage":"TRITON-1050 Add a guards to CNAPI servers and VMAPI VMs to prevent or allow migrations\nReviewed by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e\nApproved by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e\n","createdOn":1556726306,"lastUpdated":1558138005,"open":false,"status":"MERGED","comments":[{"timestamp":1556726306,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1556726308,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit f90afa8df2dacc56fda6efdfdea0e36794c99261\n    \n    allow or prevent migrations based on internal_metadata"},{"timestamp":1556726341,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556726550,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1556726552,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 65abf3a26bb17a3d15164f37277efeb9bf76eb58\n    \n    bump version"},{"timestamp":1556726584,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556738500,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1557908574,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 3."},{"timestamp":1557908575,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 5fa384b22fe77a2491859b8ce937c5996a5347c9\n    \n    update"},{"timestamp":1557908610,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557943861,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1558131049,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 4."},{"timestamp":1558131051,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit bdf14cfed8a632011230ad2147373e4858d56843\n    \n    new round of feedback"},{"timestamp":1558131080,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1558132826,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 5."},{"timestamp":1558132827,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 30ae1abb21a330206a8b983ff68fdaa5d17178cb\n    \n    new round of feedback\n    \n    commit 5fa384b22fe77a2491859b8ce937c5996a5347c9\n    \n    update"},{"timestamp":1558132860,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558134072,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nNeeds a rebase, but LGTM."},{"timestamp":1558137694,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1558137965,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1558137968,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"},{"timestamp":1558138005,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"7","revision":"a923542c63aa41b7db50a6859706820e47678866","parents":["f2bb88bcc07e5f233973eaa78cc603a109979c18"],"ref":"refs/changes/84/6184/7","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1558137965,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558132860,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"SUBM","value":"1","grantedOn":1558137968,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":19,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":97,"deletions":0}],"sizeInsertions":117,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"22b76368c885c936e0008533192c933509448d44","parents":["1356d6858058497f222ee43849406e0edc4fa4d1"],"ref":"refs/changes/84/6184/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1556726306,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556726341,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":118,"deletions":0}],"sizeInsertions":126,"sizeDeletions":0},{"number":"2","revision":"a3a1f8a0a6d8f991a910364e2999f55ce12a508c","parents":["1356d6858058497f222ee43849406e0edc4fa4d1"],"ref":"refs/changes/84/6184/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1556726550,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556726584,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/vm-migration/migrate.js","line":50,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"We *always* want to allow operator migrations - you\u0027ll need to add a check against the owner_uuid (i.e. \u0027req.params.owner_uuid\u0027). When that owner_uuid is not set in params it means it\u0027s an operator initiated migration and we can skip this check.\n\nNote - you\u0027ll need to pass the owner_uuid via the \u0027ctx\u0027 object here."},{"file":"lib/vm-migration/migrate.js","line":53,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Drop this part of the error message."},{"file":"sapi_manifests/vmapi/template","line":35,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Not a part of this change/issue."},{"file":"test/lib/migration.js","line":237,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Add \u0027user\u0027 to these test names, e.g. bad_user_migrate_..."},{"file":"test/lib/migration.js","line":241,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Add the owner_uuid to this request (and to the user migration tests below) to indicate it\u0027s a user migration."},{"file":"test/lib/migration.js","line":320,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Probably don\u0027t need these two tests - can leave the user_migration as is, the rest of the tests don\u0027t set owner_uuid, which means they are operator migrations, which should ignore this field."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":6,"deletions":0},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":118,"deletions":0}],"sizeInsertions":133,"sizeDeletions":-1},{"number":"3","revision":"2e2d7fefa57bc9a4678519075e0c9a58172d98af","parents":["ba16cd5582003c3d1ad962957b808038fa3e41da"],"ref":"refs/changes/84/6184/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1557908574,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557908610,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/lib/migration.js","line":227,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Drop \u0027bad_\u0027 - sorry for the confusion, I had just meant that these are testing user migrations and should have \u0027user\u0027 set in the name. I was using the \u0027bad_\u0027 naming as a way of showing that the test was doing something that should not be allowed (i.e. there should be a failure coming back from vmapi)."},{"file":"test/lib/migration.js","line":259,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"drop \u0027bad_\u0027"},{"file":"test/lib/migration.js","line":270,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"drop \u0027bad_\u0027"},{"file":"test/lib/migration.js","line":323,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Drop these two tests - it doesn\u0027t matter what it\u0027s set to (and we don\u0027t need to test vm update here)."},{"file":"test/lib/migration.js","line":1582,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Needed?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":19,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":122,"deletions":0}],"sizeInsertions":142,"sizeDeletions":-1},{"number":"4","revision":"eb494aa5f8e35b3ec71ea774d7893cd283188f82","parents":["ba16cd5582003c3d1ad962957b808038fa3e41da"],"ref":"refs/changes/84/6184/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1558131049,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1558131080,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/vms.migrate.test.js","line":46,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: extra comma is not recommended in array initializers"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":19,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":97,"deletions":0},{"file":"test/vms.migrate.test.js","type":"MODIFIED","insertions":61,"deletions":-61}],"sizeInsertions":178,"sizeDeletions":-62},{"number":"5","revision":"0fb9589c1f1fa9ff3bae54ca0887f1d1523aee00","parents":["ba16cd5582003c3d1ad962957b808038fa3e41da"],"ref":"refs/changes/84/6184/5","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1558132826,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558132860,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":19,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":97,"deletions":0}],"sizeInsertions":117,"sizeDeletions":-1},{"number":"6","revision":"7624390c21ce15799cfc02c420ed439bc71186aa","parents":["ba16cd5582003c3d1ad962957b808038fa3e41da"],"ref":"refs/changes/84/6184/6","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1558137694,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558132860,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":19,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":97,"deletions":0}],"sizeInsertions":117,"sizeDeletions":-1},{"number":"7","revision":"a923542c63aa41b7db50a6859706820e47678866","parents":["f2bb88bcc07e5f233973eaa78cc603a109979c18"],"ref":"refs/changes/84/6184/7","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1558137965,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558132860,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1558137968,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558134072,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/vm-migration/migrate.js","type":"MODIFIED","insertions":19,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":97,"deletions":0}],"sizeInsertions":117,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}