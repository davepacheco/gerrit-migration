From 97ddc996fbb906c6ef66b4b91e8260dbd6fd3209 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 17 Feb 2017 18:02:56 +0000
Subject: [PATCH] OS-5964 deadlock due to as_fault throttling

---
 usr/src/uts/common/vm/vm_as.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/common/vm/vm_as.c b/usr/src/uts/common/vm/vm_as.c
index 0becd0f81c..c91cabd073 100644
--- a/usr/src/uts/common/vm/vm_as.c
+++ b/usr/src/uts/common/vm/vm_as.c
@@ -21,7 +21,7 @@
 /*
  * Copyright 2010 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  * Copyright (c) 2016 by Delphix. All rights reserved.
  */
 
@@ -889,7 +889,13 @@ retry:
 		if (as == &kas)
 			CPU_STATS_ADDQ(CPU, vm, kernel_asflt, 1);
 		CPU_STATS_EXIT_K();
-		if (zonep->zone_pg_flt_delay != 0) {
+		/*
+		 * We don't want to delay if the fault occurs while the thread
+		 * is already locked (e.g. a page fault from within the kernel
+		 * itself).
+		 */
+		if (zonep->zone_pg_flt_delay != 0 &&
+		    !THREAD_LOCK_HELD(curthread)) {
 			/*
 			 * The zone in which this process is running is
 			 * currently over it's physical memory cap. Throttle
-- 
2.21.0

