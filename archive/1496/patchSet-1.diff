commit 6eb5e1a6c29f0a5a8ee4b37671f65cd3d9656a2e (refs/changes/96/1496/1)
Author: David Pacheco <dap@joyent.com>
Date:   2017-02-10T14:57:20-08:00 (2 years, 8 months ago)
    
    MANTA-3160 electric-moray not using bootstrap resolvers

diff --git a/lib/server.js b/lib/server.js
index 1ecf56b..51f7ce0 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -9,6 +9,7 @@
  */
 
 var assert = require('assert-plus');
+var clone = require('clone');
 var fast = require('fast');
 var fs = require('fs');
 var moray_client = require('moray'); // client
@@ -67,6 +68,7 @@ function createServer(options) {
         log.info('creating moray clients');
         createClient({
             ring: opts.ring,
+            morayOptions: options.morayOptions,
             log: options.log
         }, function (_err, clients) {
             if (_err) {
@@ -724,6 +726,7 @@ function createClient(options, callback) {
     assert.object(options, 'options');
     assert.object(options.log, 'options.log');
     assert.object(options.ring, 'options.ring');
+    assert.object(options.morayOptions, 'options.morayOptions');
     assert.func(callback, 'options.callback');
 
     var log = options.log;
@@ -744,17 +747,18 @@ function createClient(options, callback) {
                 url: pnodeUrl
             }, 'creating moray client');
 
-            var client = moray_client.createClient({
-                unwrapErrors: true,
-                log: options.log.child({
-                    component: 'moray-client-' + pnodeUrl.hostname
-                }),
-                srvDomain: pnodeUrl.hostname,
-                cueballOptions: {
-                    defaultPort: parseInt(pnodeUrl.port, 10)
-                }
+            var morayargs = clone(options.morayOptions);
+            if (!morayargs.cueballOptions) {
+                morayargs.cueballOptions = {};
+            }
+            morayargs.unwrapErrors = true;
+            morayargs.srvDomain = pnodeUrl.hostname;
+            morayargs.cueballOptions.defaultPort = parseInt(pnodeUrl.port, 10);
+            morayargs.log = options.log.child({
+                component: 'moray-client-' + pnodeUrl.hostname
             });
 
+            var client = moray_client.createClient(morayargs);
             clientMap[pnode] = client;
             clientArray.push(client);
 
diff --git a/sapi_manifests/electric-moray/template b/sapi_manifests/electric-moray/template
index 11d5294..813eb65 100644
--- a/sapi_manifests/electric-moray/template
+++ b/sapi_manifests/electric-moray/template
@@ -12,6 +12,11 @@
         "size": 5000,
         "expiry": 60
     },
+    "morayOptions": {
+        "cueballOptions": {
+            "resolvers": [ "nameservice.{{DOMAIN_NAME}}" ]
+        }
+    },
     "ringCfg": {
         "leveldbCfg": {
             "errorIfExists": false,
