{"project":"joyent/pgstatsmon","branch":"master","topic":"manta-metricports","id":"Iaa333c020dc3f145dccec85535b0e80985eff67b","number":"5696","subject":"MANTA-4144 Add metricPorts mdata variable to pgstatsmon Reviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e Approved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e","owner":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"url":"https://cr.joyent.us/5696","commitMessage":"MANTA-4144 Add metricPorts mdata variable to pgstatsmon\nReviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\nApproved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1551488955,"lastUpdated":1557194633,"open":false,"status":"MERGED","comments":[{"timestamp":1551488955,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 1."},{"timestamp":1551488962,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1551736071,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(2 comments)\n\nThanks for putting this together, sir."},{"timestamp":1551740473,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1551804089,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1551838364,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 2."},{"timestamp":1551838704,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 2:\n\nSee ticket for additional testing notes re: new service"},{"timestamp":1551886001,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nWhat do you think about testing to make sure that the metric-ports-updater succeeds when the configured port changes (e.g. from 8881 to 8080 or something) without first being deleted?"},{"timestamp":1551898275,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 3."},{"timestamp":1551898340,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 3:\n\n(1 comment)\n\nGood idea - see ticket for new testing notes"},{"timestamp":1551908311,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1551918258,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1551918270,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Isaac Davis"},{"timestamp":1557194633,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Topic set to manta-metricports"}],"currentPatchSet":{"number":"4","revision":"aa333c020dc3f145dccec85535b0e80985eff67b","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/96/5696/4","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1551918258,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551908311,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551908311,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1551918270,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"boot/firstboot.sh","type":"MODIFIED","insertions":15,"deletions":-7},{"file":"smf/manifests/metric-ports-updater.xml","type":"ADDED","insertions":54,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":121,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"02228074b6441f1aa291f5f133b5ce7ac38a26b8","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/96/5696/1","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1551488955,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1551488962,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/firstboot.sh","line":9,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Could update the copyright too!"},{"file":"boot/firstboot.sh","line":88,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"If SAPI isn\u0027t running (because of overload, bugs, a netsplit, or something else) when config-agent starts, will a proper config file still be written?"},{"file":"boot/firstboot.sh","line":88,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Good point - if SAPI isn\u0027t reachable when config-agent starts, a config file won\u0027t be written. I can update the comment to clarify this.\n\nHowever, in this case, pgstatsmon won\u0027t even be able to run, because it expects a config file and exits if it doesn\u0027t find one. Given this behavior, I think it\u0027s reasonable to try to get the port from the config file.\n\nThe alternative is to hard-code the port here. We do this for some other services, but it feels harder to maintain.\n\nWhat option do you think is best?"},{"file":"boot/firstboot.sh","line":88,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"pgstatsmon will definitely fail to start and probably go into maintenance if config-agent isn\u0027t running. I agree that we want to avoid hard-coding the ports.\n\nI think that we want metricPorts to match how pgstatsmon is configured, even if the configuration changes. In practice pgstatsmon reloads its configuration when the pgstatsmon service is restarted. Maybe in the future pgstatsmon will be able to handle SIGHUP / \u0027svcadm refresh\u0027 which config-agent will perform when configs change, IIRC).\n\nSo now I\u0027m wondering if it would be a good idea to re-run this mdata-put whenever the pgstatsmon service starts. I think one way we could accomplish this is by somehow calling mdata-put from within the pgstatsmon SMF service configuration. Thoughts? I haven\u0027t looked at how metricPorts are working for other services, so maybe this is just a dumb idea :)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/firstboot.sh","type":"MODIFIED","insertions":12,"deletions":0}],"sizeInsertions":12,"sizeDeletions":0},{"number":"2","revision":"3c482a09bbf472fcf900783e14db5b972427871a","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/96/5696/2","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1551838364,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551886001,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"smf/methods/metric-ports-updater.sh","line":38,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"We seem to be switching between double and single quotes in a lot of places in this file and in the firstboot.sh file. Maybe we should start to standardize on double quotes wherever possible? You don\u0027t need to change the existing single- or un-quoted code unless you feel like it.\n\n$SAPI_CONFIG in the previous line could be given a set of quotes too."},{"file":"smf/methods/metric-ports-updater.sh","line":38,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"I changed everything to double-quotes, and added quotes in the line you pointed out and elsewhere."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"boot/firstboot.sh","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"smf/manifests/metric-ports-updater.xml","type":"ADDED","insertions":54,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":116,"sizeDeletions":-5},{"number":"3","revision":"9262db25d4282ae0fd90e75347214432927c4348","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/96/5696/3","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1551898275,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551908311,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551908311,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"boot/firstboot.sh","type":"MODIFIED","insertions":15,"deletions":-7},{"file":"smf/manifests/metric-ports-updater.xml","type":"ADDED","insertions":54,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":121,"sizeDeletions":-10},{"number":"4","revision":"aa333c020dc3f145dccec85535b0e80985eff67b","parents":["84c687ce7178f92097929bfff560c470ceefd83a"],"ref":"refs/changes/96/5696/4","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1551918258,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551908311,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551908311,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1551918270,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"boot/firstboot.sh","type":"MODIFIED","insertions":15,"deletions":-7},{"file":"smf/manifests/metric-ports-updater.xml","type":"ADDED","insertions":54,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":121,"sizeDeletions":-10}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}]}