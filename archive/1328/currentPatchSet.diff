From c27d2219f7b21c1938254d6f9c974ca2a9633838 Mon Sep 17 00:00:00 2001
From: Keith M Wesolowski <wesolows@foobazco.org>
Date: Sat, 31 Aug 2013 00:27:41 +0000
Subject: [PATCH] MANTA-1760 object written to Manta with only one good copy

---
 src/http/modules/ngx_http_dav_module.c | 53 +++++++++++++++++++++++++-
 1 file changed, 52 insertions(+), 1 deletion(-)

diff --git a/src/http/modules/ngx_http_dav_module.c b/src/http/modules/ngx_http_dav_module.c
index 69c2e49b..1a51b5c9 100644
--- a/src/http/modules/ngx_http_dav_module.c
+++ b/src/http/modules/ngx_http_dav_module.c
@@ -8,7 +8,7 @@
 #include <ngx_config.h>
 #include <ngx_core.h>
 #include <ngx_http.h>
-
+#include <alloca.h>
 
 #define NGX_HTTP_DAV_OFF             2
 
@@ -166,6 +166,33 @@ ngx_module_t  ngx_http_dav_module = {
     NGX_MODULE_V1_PADDING
 };
 
+#if (NGX_HAVE_FSYNC)
+static ngx_int_t
+ngx_http_dav_rename_sync(const char *src)
+{
+    char *parent;
+    const char *p = strrchr(src, '/');
+    int fd;
+    ngx_int_t rc;
+
+    if (p == NULL) {
+        parent = ".";
+    } else {
+        parent = alloca(p - src + 1);
+        (void) strncpy(parent, src, p - src);
+        parent[p - src] = '\0';
+    }
+
+    fd = open64(parent, O_RDONLY|O_NOCTTY);
+    if (fd < 0)
+        return NGX_ERROR;
+
+    rc = (ngx_file_sync(fd) == 0) ? NGX_OK : NGX_ERROR;
+    (void) close(fd);
+
+    return rc;
+}
+#endif
 
 static ngx_int_t
 ngx_http_dav_handler(ngx_http_request_t *r)
@@ -411,6 +438,15 @@ ngx_http_dav_put_handler(ngx_http_request_t *r)
         return;
     }
 
+#if (NGX_HAVE_FSYNC)
+    if (dlcf->fsync) {
+        if (ngx_http_dav_rename_sync((const char *)temp->data) != NGX_OK) {
+            ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);
+            return;
+        }
+    }
+#endif
+
     if (status == NGX_HTTP_CREATED) {
         if (ngx_http_dav_location(r, path.data) != NGX_OK) {
             ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);
@@ -912,6 +948,14 @@ overwrite_done:
 
         if (r->method == NGX_HTTP_MOVE) {
             if (ngx_rename_file(path.data, copy.path.data) != NGX_FILE_ERROR) {
+#if (NGX_HAVE_FSYNC)
+                dlcf = ngx_http_get_module_loc_conf(r, ngx_http_dav_module);
+                if (dlcf->fsync &&
+                    ngx_http_dav_rename_sync((const char *)path.data) !=
+                    NGX_OK) {
+                    return NGX_HTTP_INTERNAL_SERVER_ERROR;
+                }
+#endif
                 return NGX_HTTP_CREATED;
             }
         }
@@ -962,6 +1006,13 @@ overwrite_done:
             ext.log = r->connection->log;
 
             if (ngx_ext_rename_file(&path, &copy.path, &ext) == NGX_OK) {
+#if (NGX_HAVE_FSYNC)
+                if (dlcf->fsync &&
+                    ngx_http_dav_rename_sync((const char *)path.data) !=
+                    NGX_OK) {
+                    return NGX_HTTP_INTERNAL_SERVER_ERROR;
+                }
+#endif
                 return NGX_HTTP_NO_CONTENT;
             }
 
-- 
2.21.0

