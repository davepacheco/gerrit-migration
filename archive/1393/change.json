{"project":"joyent/electric-moray","branch":"master","id":"I67cc1123f82509d5509c8990dbf69e42f6c66256","number":"1393","subject":"MORAY-394 Add limited support for batch operations to electric-moray Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/1393","commitMessage":"MORAY-394 Add limited support for batch operations to electric-moray\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1485985881,"lastUpdated":1486168530,"open":false,"status":"MERGED","comments":[{"timestamp":1485985881,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1485985906,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485987253,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(6 comments)\n\nNice.  Most of the comments here are pretty nitty."},{"timestamp":1486003820,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1486003839,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1486003865,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486051868,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1486060789,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1486060815,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486060932,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1486061221,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1486062836,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1486062995,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1486168530,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"4","revision":"03dada242934051ff33f2bcec2fbf4be236c5959","parents":["f88800a13a4787fd2d8134607123047f949f407b"],"ref":"refs/changes/93/1393/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1486062995,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486060815,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486061221,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486062836,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1486168530,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/ring.js","type":"MODIFIED","insertions":47,"deletions":-3},{"file":"lib/schema/manta.js","type":"MODIFIED","insertions":56,"deletions":-19},{"file":"lib/server.js","type":"MODIFIED","insertions":86,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/batch.test.js","type":"ADDED","insertions":575,"deletions":0},{"file":"test/objects.test.js","type":"MODIFIED","insertions":1,"deletions":-261},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":777,"sizeDeletions":-288},"patchSets":[{"number":"1","revision":"c15d05041b04a6b6a65b1a6343e11204a1610642","parents":["f88800a13a4787fd2d8134607123047f949f407b"],"ref":"refs/changes/93/1393/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1485985881,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485985906,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/dtrace.js","line":8,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Was there a reason for this format change?  We went through this a few years ago and standardized on the existing format."},{"file":"lib/dtrace.js","line":8,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve been told before that we\u0027ve stopped using the (c) and that I should use \"Copyright \u003cyear\u003e\" when updating the year. My understanding is that the (c) isn\u0027t needed because of the word \"Copyright\"."},{"file":"lib/dtrace.js","line":8,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"eng.git doesn\u0027t reflect that and I never saw a heads-up mail about it.  I don\u0027t care about which format we use but I would like us to be consistent so that we can update our tooling to check for it.  (The existing tooling still checks for \"(c)\", too, although it hasn\u0027t been updated for the year either.)"},{"file":"lib/dtrace.js","line":8,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"For reference: offline discussion decided to keep the \"(c)\" for now."},{"file":"lib/ring.js","line":123,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This should probably be an asynchronous error.\n\nThis is super nitty, but I thought the convention we used was lowercase error messages (similar to traditional Unix commands)."},{"file":"lib/ring.js","line":123,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/schema/manta.js","line":13,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m not sure what \"The keys are transformed so that they end up being hashed to the same value\" means here.  They could be different values."},{"file":"lib/schema/manta.js","line":13,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve updated this comment, so hopefully it makes more sense. Let me know if this needs more work."},{"file":"lib/schema/manta.js","line":57,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why would split.length ever be less than 2?"},{"file":"lib/schema/manta.js","line":57,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"A client or an operator might accidentally send a bad key without a colon. I wasn\u0027t sure if it was really electric-moray\u0027s responsibility to enforce this or not. It currently returns the input key for the \u0027manta\u0027 bucket when it\u0027s not a valid path, so I figured I\u0027d do the same thing here."},{"file":"lib/schema/manta.js","line":57,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"If this shouldn\u0027t happen, it seems like this should be a validation error, though these functions unfortunately don\u0027t seem set up to report those."},{"file":"lib/server.js","line":923,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What do you think of making this a whitelist instead so that it fails safe if we forget to update it for a future operation?"},{"file":"lib/server.js","line":923,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/server.js","line":946,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Wouldn\u0027t this be okay for a \"get\" operation?  Or do we assume people won\u0027t use \"batch\" for gets?"},{"file":"lib/server.js","line":946,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"get\" isn\u0027t a currently supported operation for batch(). If that changes then maybe we can refactor this to behave differently if all of the operations are gets."},{"file":"lib/server.js","line":946,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Okay, thanks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/ring.js","type":"MODIFIED","insertions":46,"deletions":-1},{"file":"lib/schema/manta.js","type":"MODIFIED","insertions":55,"deletions":-19},{"file":"lib/server.js","type":"MODIFIED","insertions":85,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/batch.test.js","type":"ADDED","insertions":575,"deletions":0},{"file":"test/objects.test.js","type":"MODIFIED","insertions":1,"deletions":-58}],"sizeInsertions":773,"sizeDeletions":-83},{"number":"2","revision":"5a6e62cc5f7bc642fbf177758e3b74b3b7ddde3e","parents":["f88800a13a4787fd2d8134607123047f949f407b"],"ref":"refs/changes/93/1393/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1486003839,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486003865,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/ring.js","type":"MODIFIED","insertions":47,"deletions":-3},{"file":"lib/schema/manta.js","type":"MODIFIED","insertions":56,"deletions":-19},{"file":"lib/server.js","type":"MODIFIED","insertions":86,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/batch.test.js","type":"ADDED","insertions":575,"deletions":0},{"file":"test/objects.test.js","type":"MODIFIED","insertions":1,"deletions":-261},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":777,"sizeDeletions":-288},{"number":"3","revision":"67cc1123f82509d5509c8990dbf69e42f6c66256","parents":["f88800a13a4787fd2d8134607123047f949f407b"],"ref":"refs/changes/93/1393/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1486060789,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486061221,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486062836,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486060815,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/ring.js","type":"MODIFIED","insertions":47,"deletions":-3},{"file":"lib/schema/manta.js","type":"MODIFIED","insertions":56,"deletions":-19},{"file":"lib/server.js","type":"MODIFIED","insertions":86,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/batch.test.js","type":"ADDED","insertions":575,"deletions":0},{"file":"test/objects.test.js","type":"MODIFIED","insertions":1,"deletions":-261},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":777,"sizeDeletions":-288},{"number":"4","revision":"03dada242934051ff33f2bcec2fbf4be236c5959","parents":["f88800a13a4787fd2d8134607123047f949f407b"],"ref":"refs/changes/93/1393/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1486062995,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486061221,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486062836,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1486168530,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486060815,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"lib/ring.js","type":"MODIFIED","insertions":47,"deletions":-3},{"file":"lib/schema/manta.js","type":"MODIFIED","insertions":56,"deletions":-19},{"file":"lib/server.js","type":"MODIFIED","insertions":86,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/batch.test.js","type":"ADDED","insertions":575,"deletions":0},{"file":"test/objects.test.js","type":"MODIFIED","insertions":1,"deletions":-261},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":777,"sizeDeletions":-288}],"allReviewers":[{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}