From da89807a45d0f8e724ee2f0fe1a32b07d4ad2c60 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Sat, 19 Aug 2017 00:30:38 +0000
Subject: [PATCH] MANTA-3368 MPU commit does not return the computed MD5

---
 lib/uploads/commit.js   |  1 +
 test/mpu/commit.test.js | 42 +++++++++++++++++++++++++++++++++++++++++
 test/mpu/helper.js      |  6 +++---
 3 files changed, 46 insertions(+), 3 deletions(-)

diff --git a/lib/uploads/commit.js b/lib/uploads/commit.js
index ded74d8..856e1a7 100644
--- a/lib/uploads/commit.js
+++ b/lib/uploads/commit.js
@@ -516,6 +516,7 @@ function commit(req, res, next) {
             }, 'commit: completed');
 
             res.setHeader('Location', p);
+            res.setHeader('Computed-MD5', md5);
             res.send(201);
             next();
         }
diff --git a/test/mpu/commit.test.js b/test/mpu/commit.test.js
index 51f454d..280c883 100644
--- a/test/mpu/commit.test.js
+++ b/test/mpu/commit.test.js
@@ -112,6 +112,48 @@ test('commit upload: one part', function (t) {
     });
 });
 
+test('commit upload: commit content md5 match', function (t) {
+    var self = this;
+    self.createUpload(self.path, null, function (err) {
+        if (ifErr(t, err, 'commit md5')) {
+            t.end();
+            return;
+        }
+        var pn = 0;
+        self.writeTestObject(self.uploadId, pn, function (err2, res) {
+            if (ifErr(t, err2, 'commit md5 upload')) {
+                t.end();
+                return;
+            }
+            t.ok(res);
+            t.checkResponse(res, 204);
+
+            var etag = res.headers.etag;
+            self.commitUpload(self.uploadId, [etag], function (err3, res2) {
+                if (ifErr(t, err3, 'commit upload')) {
+                    t.end();
+                    return;
+                }
+                t.ok(res2);
+                t.ok(res2.headers);
+                t.ok(res2.headers['computed-md5']);
+
+                var commitComputedMD5 = res2.headers['computed-md5'];
+                self.client.info(self.path, function (err4, info) {
+                    t.ifError(err4);
+                    t.ok(info);
+
+                    if (info) {
+                        var headers = info.headers || {};
+                        t.equal(commitComputedMD5, headers['content-md5']);
+                    }
+                    t.end();
+                });
+            });
+        });
+    });
+});
+
 
 test('commit upload: already commited, same set of parts', function (t) {
     var self = this;
diff --git a/test/mpu/helper.js b/test/mpu/helper.js
index 7a71f53..33d3b68 100644
--- a/test/mpu/helper.js
+++ b/test/mpu/helper.js
@@ -337,12 +337,12 @@ function commitUploadHelper(id, etags, subuser, cb) {
         account: self.client.user
     };
 
-    client.commitUpload(id, etags, opts, function (err) {
+    client.commitUpload(id, etags, opts, function (err, res) {
         if (err) {
-            cb(err);
+            cb(err, null);
         } else {
             self.uploadFinalized = true;
-            cb();
+            cb(null, res);
         }
     });
 }
-- 
2.21.0

