{"project":"joyent/manta-muskie","branch":"master","id":"I8ef717e04101ea9bab24e6ebf1350e12fc373dac","number":"655","subject":"MANTA-2737 muskie returned 500 on GET when one CN was down MANTA-2716 muskie behaves poorly when mako is extremely slow Reviewed by: Dave Pacheco \u003cdap@joyent.com\u003e Approved by: Dave Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"url":"https://cr.joyent.us/655","commitMessage":"MANTA-2737 muskie returned 500 on GET when one CN was down\nMANTA-2716 muskie behaves poorly when mako is extremely slow\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1476231783,"lastUpdated":1478567410,"open":false,"status":"MERGED","comments":[{"timestamp":1476231783,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 1."},{"timestamp":1476231866,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1476297141,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 2."},{"timestamp":1476297172,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476298731,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 3."},{"timestamp":1476298762,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476307461,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1476320515,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(4 comments)\n\nIn terms of the timeout: I think using the cueball agent is probably the right long-term answer.  With that agent, it\u0027s likely we\u0027ll have a socket available much of the time anyway, and it will use exponential backoff on the connection establishment, and it will deal with MANTA-2887.  In the meantime, probably the best thing is to make sure this change just doesn\u0027t make any existing cases worse than they were before.\n\nThe main way I could see it being worse with this change is that the time between connection establishment and getting back 100-continue is now covered by the 2-second timeout, but it wasn\u0027t before.  So if connection establishment tends to be fast, but the 100-continue takes a bit longer, this change might cause us to fail some requests that we didn\u0027t before.  Based on your comment in the ticket, 10 seconds may be enough, and I don\u0027t think it\u0027s really worth retrying at all.\n\nOn that note: your comment talks about the time to stream data from the sharks, but if that includes the data transfer for the entire object, that can be much longer than the time we\u0027re interested in here (which is just the time to set up the transfer).  Also, any idea about the same metric for PUTs instead of GETs?"},{"timestamp":1477959034,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4:\n\n(4 comments)\n\n\u003e (4 comments)\n \u003e \n \u003e In terms of the timeout: I think using the cueball agent is\n \u003e probably the right long-term answer.  With that agent, it\u0027s likely\n \u003e we\u0027ll have a socket available much of the time anyway, and it will\n \u003e use exponential backoff on the connection establishment, and it\n \u003e will deal with MANTA-2887.  In the meantime, probably the best\n \u003e thing is to make sure this change just doesn\u0027t make any existing\n \u003e cases worse than they were before.\n \u003e \n \u003e The main way I could see it being worse with this change is that\n \u003e the time between connection establishment and getting back\n \u003e 100-continue is now covered by the 2-second timeout, but it wasn\u0027t\n \u003e before.  So if connection establishment tends to be fast, but the\n \u003e 100-continue takes a bit longer, this change might cause us to fail\n \u003e some requests that we didn\u0027t before.  Based on your comment in the\n \u003e ticket, 10 seconds may be enough, and I don\u0027t think it\u0027s really\n \u003e worth retrying at all.\n \u003e \n \u003e On that note: your comment talks about the time to stream data from\n \u003e the sharks, but if that includes the data transfer for the entire\n \u003e object, that can be much longer than the time we\u0027re interested in\n \u003e here (which is just the time to set up the transfer).  Also, any\n \u003e idea about the same metric for PUTs instead of GETs?\n\n\nThe data gathering I did for GETs was just looking at the time spent in streamFromSharks for all requests, which I tested for the year 2016 in staging Manta and one month in production Manta. This includes the time to stream data for GETs, and also includes HEADS (which will follow this code path as well). I didn\u0027t see a good way using the logs to determine when we first hear back from the shark without including the time to stream data.\n\nFor staging Manta in all 2016, the average time spent in streamFromSharks was 0.24 seconds, with a max value of 516 seconds. For the month of June 2016 production Manta, the average time spent in streamFromSharks was 0.07 seconds with a max value of 263 seconds. There\u0027s obviously a lot of variation there, so I\u0027m open to suggestions for improving this collection mechanism.\n\nFor PUTs, to approximate the time between receiving the 100-continue (which happens during the `startSharkStreams`for each shark), I added up the timers for requests that included the request chain \"startSharkStreams, sharkStreams, saveMetadata\" (which only applies to \"putobject\" calls). I then subtracted the sum of these three timers from the total timer sum, which should encompass the time about when the 100-continue is sent. I tested this for the year 2016 on staging Manta and four separate days on production Manta (6/01/16, 6/15/16, 10/01/16, 10/15/16).\n\nFor staging, the average time was 0.02 seconds, with a max value of 63 seconds. For the four days in production Manta, the average values were 0.05 seconds, 0.023 seconds, 0.02 seconds, and 0.03 seconds. The max values were 51.7 seconds, 25.7 seconds, 1.6 seconds, and 7 seconds.\n\n\nSo in general, the average times for all of these are pretty small (\u003c 1 second). The max values are a bit more varied.\n\nI\u0027m definitely open to further suggestions at this point for tinkering with this data, but at this point I\u0027ve spent a lot of time on it and would like to just pick a reasonable timeout or find a different metric for selecting it."},{"timestamp":1477959100,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 5."},{"timestamp":1477959126,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1477959209,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1477959236,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1478221752,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1478567053,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1478567410,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jordan Hendricks"}],"currentPatchSet":{"number":"7","revision":"8ef717e04101ea9bab24e6ebf1350e12fc373dac","parents":["3e0599ae0391733c19fd2253a27ab932a3d20bd9"],"ref":"refs/changes/55/655/7","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1478567053,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477959126,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478221752,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478221752,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1478567410,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":26,"deletions":-7}],"sizeInsertions":26,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"df78c186bcb733626b3b15467ec56c689d8d241f","parents":["f4ba92a1f91b07069d1236ce47f4859071018436"],"ref":"refs/changes/55/655/1","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1476231783,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1476231866,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/shark_client.js","line":61,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/shark_client.js","line":68,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/shark_client.js","line":71,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":19,"deletions":-6}],"sizeInsertions":19,"sizeDeletions":-6},{"number":"2","revision":"a3b4830ea64108009aa131a45803c9488d25f073","parents":["f4ba92a1f91b07069d1236ce47f4859071018436"],"ref":"refs/changes/55/655/2","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1476297141,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476297172,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":25,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-7},{"number":"3","revision":"12b7fce0c244bc76ac11be2fafc777b91b8f0176","parents":["f4ba92a1f91b07069d1236ce47f4859071018436"],"ref":"refs/changes/55/655/3","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1476298731,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476298762,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":25,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-7},{"number":"4","revision":"3c7cc2d3608c60aaf372f94e013f30d0c167b9b4","parents":["f4ba92a1f91b07069d1236ce47f4859071018436"],"ref":"refs/changes/55/655/4","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1476307461,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476298762,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/shark_client.js","line":62,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"There\u0027s a missing space there: \"request,so\""},{"file":"lib/shark_client.js","line":62,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/shark_client.js","line":65,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is pretty nitty, but personally, I don\u0027t really like describing what code used to do -- the bug tracker and git history are a cleaner way to do that.  If it\u0027s useful to explain to a new reader why we don\u0027t still do things the old way, I usually say something like \"it would be tempting to ...\".  Maybe something like:\n\n\u003e It would be tempting to clear this timer on the \u0027socket\u0027 event, but in the case of reused sockets, we may get a socket whose shark has since disappeared (e.g., behind a network partition).  We really want this timeout to cover the interval up to when we know that shark has started processing the request because if the timeout expires at any time before then, the caller can retry another shark.  After that point, that\u0027s much harder."},{"file":"lib/shark_client.js","line":65,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"That does sound much cleaner. It is included in the ticket information, so that should be fine.\n\nI will update the comment to remove it."},{"file":"lib/shark_client.js","line":71,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I might add to the last sentence: \", at which point it\u0027s likely too late to try this request on another shark\"."},{"file":"lib/shark_client.js","line":71,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/shark_client.js","line":80,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It looks like this was here before, but is there ever a case where \"req\" wouldn\u0027t be truthy?"},{"file":"lib/shark_client.js","line":80,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Great question. As far as I can tell, no. I don\u0027t see anywhere explicitly set to null in the code, and http.request doesn\u0027t look like it could ever return null. I\u0027ll try removing the check and try the muskie test suite and my manual tests at the least.\n\nIs there any other sanity checks you think I should do?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":25,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-7},{"number":"5","revision":"2c7262edc1dc89ab856ff370ebf825a2f2f64f01","parents":["f4ba92a1f91b07069d1236ce47f4859071018436"],"ref":"refs/changes/55/655/5","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1477959100,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477959126,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":26,"deletions":-7}],"sizeInsertions":26,"sizeDeletions":-7},{"number":"6","revision":"10dffe1869557d2e76c4832b891ae55b16be8edf","parents":["3e0599ae0391733c19fd2253a27ab932a3d20bd9"],"ref":"refs/changes/55/655/6","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1477959209,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478221752,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478221752,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477959126,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":26,"deletions":-7}],"sizeInsertions":26,"sizeDeletions":-7},{"number":"7","revision":"8ef717e04101ea9bab24e6ebf1350e12fc373dac","parents":["3e0599ae0391733c19fd2253a27ab932a3d20bd9"],"ref":"refs/changes/55/655/7","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1478567053,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478221752,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478221752,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477959126,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1478567410,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":26,"deletions":-7}],"sizeInsertions":26,"sizeDeletions":-7}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}