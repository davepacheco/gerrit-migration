{"project":"joyent/manta-muskie","branch":"master","id":"If74c61b9c56464dbc9071782d98a1246bcc9a019","number":"3127","subject":"MANTA-2133 Manta object reads should not require shard 1","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/3127","commitMessage":"MANTA-2133 Manta object reads should not require shard 1\n","createdOn":1513720558,"lastUpdated":1568050765,"open":false,"status":"MERGED","comments":[{"timestamp":1513720558,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1513720560,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 9f18d017dc3f2124a10c9bba95aa454466726870\n    \n    MANTA-2133 Manta object reads should not require shard 1"},{"timestamp":1513720621,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515184981,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1515184983,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 71f906b30ff766530f6f45c23532b1ec96739c2b\n    \n    MANTA-2133 Manta object reads should not require shard 1"},{"timestamp":1515185010,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515431922,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1515431923,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 3404a48e72e12910071bbce5c655d7ae9f628de9\n    \n    MANTA-2133 Manta object reads should not require shard 1"},{"timestamp":1515431951,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1521212475,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 4."},{"timestamp":1521212478,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 4f949db550c20ab2b7d049a4038d1774f97c38fc\n    \n    MANTA-2133 Manta object reads should not require shard 1"},{"timestamp":1522428667,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531937950,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 5."},{"timestamp":1531937951,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 9f47a005e9ca569d00eb339287a080134516abde\n    \n    MANTA-2133 Manta object reads should not require shard 1"},{"timestamp":1531937982,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531951527,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5:\n\n(2 comments)\n\nOverall, this looks good!\n\nI have a question about the testing notes in the ticket. You mention disabling shards 1 and 2 in your deployment. I imagine in your deployment shard 1 is also a metadata shard, as most smaller deployments are configured to be. Do you think it\u0027s worth testing in an environment where shard 1 is administrative-only?"},{"timestamp":1533164919,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1533165098,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1533165879,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1533166532,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 6."},{"timestamp":1533166534,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 85054a12b4e723171b0b1f54cfda0764838b0361\n    \n    Report all unavailable client errors for each request"},{"timestamp":1533166576,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1533664340,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533674948,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6: Code-Review+1\n\nI\u0027m not sure if the ball is still in my court with this review, but I have +1\u0027d for CR.\n\nFor IA, I still have my question from before (apologies if I missed your answer here):\n\u003e I have a question about the testing notes in the ticket. You mention disabling shards 1 and 2 in your deployment. I imagine in your deployment shard 1 is also a metadata shard, as most smaller deployments are configured to be. Do you think it\u0027s worth testing in an environment where shard 1 is administrative-only?"},{"timestamp":1546452658,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1554484310,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Uploaded patch set 7."},{"timestamp":1554484343,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1554745012,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 7:\n\nJordan: I have picked up this CR from Kelly. As you mentioned, my testing was on a smaller lab system, so I believe shard was is not \u0027admin\u0027 only. I was chatting with Kelly about this, do you think it might be possible for QA to test that scenario? Otherwise, I am happy to look into it. Thank you."},{"timestamp":1554760657,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7:\n\n\u003e As you mentioned, my testing was on a smaller lab system, so I believe shard was is not \u0027admin\u0027 only. I was chatting with Kelly about this, do you think it might be possible for QA to test that scenario?\n\nI think it\u0027s possible. It might be worth reaching out to Angela about it!\nFor some additional context: in the past engineers have tested some changes in a larger environment by deploying custom image(s) to the engineering staging Manta standup (in the datacenters \"staging-{1,2,3}\"). I am not clued in very much on the QA team\u0027s efforts, but I believe they do use that Manta for testing. In any case, it\u0027s probably worth asking the QA team about it. :)"},{"timestamp":1567783631,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1567785858,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 8: Integration-Approval+1\n\nTested on my lab setup."},{"timestamp":1568050448,"reviewer":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1568050765,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"8","revision":"b78064d491b3b99ea0a7d2d00f984b5c5ad3a0dc","parents":["3434a2e6626dea0e62d631ad60888d0f45593ff8"],"ref":"refs/changes/27/3127/8","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1567783631,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554484343,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567785858,"by":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568050448,"by":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}},{"type":"SUBM","value":"1","grantedOn":1568050765,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-27},{"file":"lib/server.js","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-10}],"sizeInsertions":56,"sizeDeletions":-54},"patchSets":[{"number":"1","revision":"49571a9d11b7006d89df19fbdff11cae4eca867b","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/27/3127/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1513720558,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513720621,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":8,"deletions":-8}],"sizeInsertions":8,"sizeDeletions":-8},{"number":"2","revision":"b1f0c3029cca31cbdbb106b87a01a23cfd5fc06e","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/27/3127/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1515184981,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515185010,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-25},{"file":"lib/server.js","type":"MODIFIED","insertions":19,"deletions":-14},{"file":"main.js","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":55,"sizeDeletions":-46},{"number":"3","revision":"758c54cecdb7b093f3a962c0a7fda75a6bc41a13","parents":["f0bada24a3811e8e435f87664b5be9717c6f2d67"],"ref":"refs/changes/27/3127/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1515431922,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515431951,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-25},{"file":"lib/server.js","type":"MODIFIED","insertions":15,"deletions":-14},{"file":"main.js","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":51,"sizeDeletions":-46},{"number":"4","revision":"d27584fa1dca3eef883a7a0d1ee655f0e5485233","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/27/3127/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1521212475,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522428667,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-25},{"file":"lib/server.js","type":"MODIFIED","insertions":15,"deletions":-19},{"file":"main.js","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":51,"sizeDeletions":-51},{"number":"5","revision":"adae5177022d25d04cc79a5fb35950c3e8ab8fed","parents":["760857dbf5d30f5734b4ac21e097628824bb6569"],"ref":"refs/changes/27/3127/5","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1531937950,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531937982,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":234,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Why do we not need to report all unavailable services now? (Sorry if I am misreading this.)"},{"file":"lib/server.js","line":234,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Sorry for the delay responding to this. The way the code is structured there is only ever one error reported so using an array for errors is not necessary and using `MultiError` isn\u0027t needed. We could rewrite the `if/else` block as a series of `if` statements if we want to accumulate all relevant errors about unavailable services for a particular request if you think that\u0027s a better way to go."},{"file":"lib/server.js","line":234,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I thought we used to keep track of all errors and report them, though I see in the previous structure we would only ever see one error reported. Is having all errors tracked not useful when debugging why muskie won\u0027t start?"},{"file":"lib/server.js","line":234,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I think there is value in collecting them all. That way you can know with a single request what services are not available and caused it to be unsuccessful. I will make a change to make it work this way."},{"file":"lib/server.js","line":234,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"},{"file":"main.js","line":290,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Are these asserts redundant to the asserts in the individual configure* functions? (And if not, should they be moved to their individual config functions for clarity? I do see that they were moved from lib/common.js, which does make sense to me.)"},{"file":"main.js","line":290,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Sorry, I\u0027m not sure I follow what you mean by the individual config functions? Maybe do you mean the functions for setting up the different client connections?"},{"file":"main.js","line":290,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Yes, I was referring to the functions that set up different client connections."},{"file":"main.js","line":290,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Only a subset of these are used by the client connection functions and I think it makes sense here because we have composed the configuration object in this function and before we return it and begin using it we can validate that the object meets the necessary requirements. If we spread that around to multiple functions then we have moved away from the place in the code where the problem occurred."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-27},{"file":"lib/server.js","type":"MODIFIED","insertions":15,"deletions":-19},{"file":"main.js","type":"MODIFIED","insertions":16,"deletions":-7}],"sizeInsertions":53,"sizeDeletions":-53},{"number":"6","revision":"5b186e5d4321346753c90546aabd2fc3158939a7","parents":["760857dbf5d30f5734b4ac21e097628824bb6569"],"ref":"refs/changes/27/3127/6","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1533166532,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533664340,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533674948,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-27},{"file":"lib/server.js","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"main.js","type":"MODIFIED","insertions":16,"deletions":-7}],"sizeInsertions":69,"sizeDeletions":-51},{"number":"7","revision":"f74c61b9c56464dbc9071782d98a1246bcc9a019","parents":["dc7f08045a391c17f52ace1a58232ff0331714de"],"ref":"refs/changes/27/3127/7","uploader":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"},"createdOn":1554484310,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554484343,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-27},{"file":"lib/server.js","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-10}],"sizeInsertions":56,"sizeDeletions":-54},{"number":"8","revision":"b78064d491b3b99ea0a7d2d00f984b5c5ad3a0dc","parents":["3434a2e6626dea0e62d631ad60888d0f45593ff8"],"ref":"refs/changes/27/3127/8","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1567783631,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554484343,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1568050765,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568050448,"by":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567785858,"by":{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":22,"deletions":-27},{"file":"lib/server.js","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-10}],"sizeInsertions":56,"sizeDeletions":-54}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Jon Anderson","email":"jon.anderson@joyent.com","username":"bowrocker"}]}