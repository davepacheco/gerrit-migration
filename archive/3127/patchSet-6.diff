From 5b186e5d4321346753c90546aabd2fc3158939a7 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Wed, 1 Aug 2018 17:35:30 -0600
Subject: [PATCH] MANTA-2133 Manta object reads should not require shard 1

---
 lib/common.js | 49 ++++++++++++++++++++++---------------------------
 lib/server.js | 48 +++++++++++++++++++++++++++++++-----------------
 main.js       | 23 ++++++++++++++++-------
 3 files changed, 69 insertions(+), 51 deletions(-)

diff --git a/lib/common.js b/lib/common.js
index 733004c..d87bae4 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -954,37 +954,20 @@ module.exports = {
 
     setupHandler: function (options, clients) {
         assert.object(options, 'options');
-        assert.object(options.jobCache, 'options.jobCache');
-        assert.object(options.log, 'options.log');
-        assert.object(options.collector, 'options.collector');
-        assert.object(clients.keyapi, 'clients.keyapi');
-        assert.object(clients.mahi, 'clients.mahi');
-        assert.object(clients.marlin, 'clients.marlin');
-        assert.object(clients.picker, 'clients.picker');
-        assert.object(options.moray, 'options.moray');
-        assert.object(clients.medusa, 'clients.medusa');
-        assert.object(options.sharkConfig, 'options.sharkConfig');
-        assert.object(options.storage, 'options.storage');
-        assert.number(options.storage.defaultMaxStreamingSizeMB,
-            'options.storage.defaultMaxStreamingSizeMB');
-        assert.object(options.multipartUpload, 'options.multipartUpload');
-        assert.number(options.multipartUpload.prefixDirLen,
-            'options.multipartUpload.prefixDirLen');
-        assert.arrayOfObject(options.accountsSnaplinksDisabled,
-            'options.accountsSnaplinksDisabled');
+        assert.object(clients, 'clients');
 
         function setup(req, res, next) {
+            // General request setup
             req.config = options;
             req.moray = clients.moray;
 
-            // MANTA-331: while a trailing '/' is ok in HTTP,
-            // this messes with the consistent hashing, so
-            // ensure there isn't one
+            /*
+             * MANTA-331: while a trailing '/' is ok in HTTP, this messes with
+             * the consistent hashing, so ensure there isn't one
+             */
             /* JSSTYLED */
             req._path = req._path.replace(/\/*$/, '');
 
-            req.jobCache = options.jobCache;
-
             req.log = (req.log || options.log).child({
                 method: req.method,
                 path: req.path(),
@@ -994,12 +977,9 @@ module.exports = {
             // Attach an artedi metric collector to each request object.
             req.collector = options.collector;
 
-            req.marlin = clients.marlin;
-            req.picker = clients.picker;
             req.sharks = [];
             req.sharkConfig = options.sharkConfig;
             req.sharkAgent = clients.sharkAgent;
-            req.medusa = clients.medusa;
             req.msk_defaults = {
                 maxStreamingSize: options.storage.defaultMaxStreamingSizeMB *
                     1024 * 1024,
@@ -1007,6 +987,22 @@ module.exports = {
             };
             req.accountsSnaplinksDisabled = options.accountsSnaplinksDisabled;
 
+            // Write request setup
+            if (!req.isReadOnly()) {
+                req.picker = clients.picker;
+            }
+
+            // Job request setup
+            if (req.isMarlinRequest()) {
+                req.marlin = clients.marlin;
+                req.jobCache = options.jobCache;
+            }
+
+            // Medusa request setup
+            if (req.isMedusaRequest()) {
+                req.medusa = clients.medusa;
+            }
+
             var _opts = {
                 account: req.owner.account,
                 path: req.path()
@@ -1036,5 +1032,4 @@ module.exports = {
 
         return (setup);
     }
-
 };
diff --git a/lib/server.js b/lib/server.js
index df6a1d1..9c237b3 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -215,27 +215,41 @@ function createServer(options, clients, name) {
     server.use(function ensureDependencies(req, res, next) {
         var ok = true;
         var errors = [];
+        var error;
 
-        if (!clients.picker) {
-            errors.push(new Error('picker unavailable'));
-            req.log.error('picker unavailable');
+        if (!clients.moray) {
+            error = 'index moray unavailable';
+            errors.push(new Error(error));
+            req.log.error(error);
             ok = false;
-        } else if (!clients.moray) {
-            errors.push(new Error('index moray unavailable'));
-            req.log.error('index moray unavailable');
+        }
+
+        if (!clients.mahi) {
+            error = 'mahi unavailable';
+            errors.push(new Error(error));
+            req.log.error(error);
+            ok = false;
+        }
+
+        if (!clients.picker && !req.isReadOnly()) {
+            error = 'picker unavailable';
+            errors.push(new Error(error));
+            req.log.error(error);
             ok = false;
-        } else if (!clients.mahi) {
-            errors.push(new Error('mahi unavailable'));
-            req.log.error('mahi unavailable');
+        }
+
+        if (!clients.marlin && req.isMarlinRequest()) {
+            error = 'marlin unavailable';
+            errors.push(new Error(error));
+            req.log.error(error);
+            ok = false;
+        }
+
+        if (!clients.medusa && req.isMedusaRequest()) {
+            error = 'medusa unavailable';
+            errors.push(new Error(error));
+            req.log.error(error);
             ok = false;
-        } else if (!clients.marlin) {
-            errors.push(new Error('marlin available'));
-            req.log.error('marlin unavailable');
-            ok = !req.isMarlinRequest();
-        } else if (!clients.medusa) {
-            errors.push(new Error('medusa unavailable'));
-            req.log.error('medusa unavailable');
-            ok = !req.isMedusaRequest();
         }
 
         if (!ok) {
diff --git a/main.js b/main.js
index 2172b3f..81fff49 100644
--- a/main.js
+++ b/main.js
@@ -276,6 +276,19 @@ function configure(appName, opts, dtProbes) {
 
     cfg.dtrace_probes = dtProbes;
 
+    assert.object(cfg.jobCache, 'cfg.jobCache');
+    assert.object(cfg.log, 'cfg.log');
+    assert.object(cfg.collector, 'cfg.collector');
+    assert.object(cfg.sharkConfig, 'cfg.sharkConfig');
+    assert.object(cfg.storage, 'cfg.storage');
+    assert.number(cfg.storage.defaultMaxStreamingSizeMB,
+        'cfg.storage.defaultMaxStreamingSizeMB');
+    assert.object(cfg.multipartUpload, 'cfg.multipartUpload');
+    assert.number(cfg.multipartUpload.prefixDirLen,
+        'cfg.multipartUpload.prefixDirLen');
+    assert.arrayOfObject(cfg.accountsSnaplinksDisabled,
+        'cfg.accountsSnaplinksDisabled');
+
     cfg.log.debug(cfg, 'muskie: config loaded');
 
     return (cfg);
@@ -461,9 +474,8 @@ function createCueballSharkAgent(sharkCfg) {
 }
 
 
-function onPickerConnect(clients, barrier, pickerClient) {
+function onPickerConnect(clients, pickerClient) {
     clients.picker = pickerClient;
-    barrier.done('createPickerClient');
 }
 
 
@@ -717,12 +729,9 @@ function clientsConnected(appName, cfg, clients) {
     barrier.start('createMorayClient');
     createMorayClient(cfg.moray, onMorayConnect.bind(null, clients, barrier));
 
-    barrier.start('createPickerClient');
-    createPickerClient(cfg.storage, cfg.log,
-        onPickerConnect.bind(null, clients, barrier));
-
     // Establish other client connections needed for writes and jobs requests.
-
+    createPickerClient(cfg.storage, cfg.log,
+        onPickerConnect.bind(null, clients));
     createMarlinClient(cfg.marlin, onMarlinConnect.bind(null, clients));
     createMedusaConnector(cfg.medusa, onMedusaConnect.bind(null, clients));
     clients.sharkAgent = createCueballSharkAgent(cfg.sharkConfig);
-- 
2.21.0

