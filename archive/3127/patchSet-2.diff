commit b1f0c3029cca31cbdbb106b87a01a23cfd5fc06e
Author: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date:   2018-01-05T13:43:00-07:00 (1 year, 9 months ago)
    
    MANTA-2133 Manta object reads should not require shard 1

diff --git a/lib/common.js b/lib/common.js
index 864f9dc..c47e3c2 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -901,35 +901,20 @@ module.exports = {
 
     setupHandler: function (options, clients) {
         assert.object(options, 'options');
-        assert.object(options.jobCache, 'options.jobCache');
-        assert.object(options.log, 'options.log');
-        assert.object(options.collector, 'options.collector');
-        assert.object(clients.keyapi, 'clients.keyapi');
-        assert.object(clients.mahi, 'clients.mahi');
-        assert.object(clients.marlin, 'clients.marlin');
-        assert.object(clients.picker, 'clients.picker');
-        assert.object(options.moray, 'options.moray');
-        assert.object(clients.medusa, 'clients.medusa');
-        assert.object(options.sharkConfig, 'options.sharkConfig');
-        assert.object(options.storage, 'options.storage');
-        assert.number(options.storage.defaultMaxStreamingSizeMB,
-            'options.storage.defaultMaxStreamingSizeMB');
-        assert.object(options.multipartUpload, 'options.multipartUpload');
-        assert.number(options.multipartUpload.prefixDirLen,
-            'options.multipartUpload.prefixDirLen');
+        assert.object(clients, 'clients');
 
         function setup(req, res, next) {
+            // General request setup
             req.config = options;
             req.moray = clients.moray;
 
-            // MANTA-331: while a trailing '/' is ok in HTTP,
-            // this messes with the consistent hashing, so
-            // ensure there isn't one
+            /*
+             * MANTA-331: while a trailing '/' is ok in HTTP, this messes with
+             * the consistent hashing, so ensure there isn't one
+             */
             /* JSSTYLED */
             req._path = req._path.replace(/\/*$/, '');
 
-            req.jobCache = options.jobCache;
-
             req.log = (req.log || options.log).child({
                 method: req.method,
                 path: req.path(),
@@ -939,18 +924,31 @@ module.exports = {
             // Attach an artedi metric collector to each request object.
             req.collector = options.collector;
 
-            req.marlin = clients.marlin;
-            req.picker = clients.picker;
             req.sharks = [];
             req.sharkConfig = options.sharkConfig;
             req.sharkAgent = clients.sharkAgent;
-            req.medusa = clients.medusa;
             req.msk_defaults = {
                 maxStreamingSize: options.storage.defaultMaxStreamingSizeMB *
                     1024 * 1024,
                 mpuPrefixDirLen: options.multipartUpload.prefixDirLen
             };
 
+            // Write request setup
+            if (!req.isReadOnly()) {
+                req.picker = clients.picker;
+            }
+
+            // Job request setup
+            if (req.isMarlinRequest()) {
+                req.marlin = clients.marlin;
+                req.jobCache = options.jobCache;
+            }
+
+            // Medusa request setup
+            if (req.isMedusaRequest()) {
+                req.medusa = clients.medusa;
+            }
+
             var _opts = {
                 account: req.owner.account,
                 path: req.path()
@@ -980,5 +978,4 @@ module.exports = {
 
         return (setup);
     }
-
 };
diff --git a/lib/server.js b/lib/server.js
index 3e3622e..83c5835 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -212,28 +212,33 @@ function createServer(options, clients, name) {
 
     server.use(function ensureDependencies(req, res, next) {
         var ok = true;
-        var errors = [];
+        var error;
 
-        if (!clients.picker) {
-            req.log.error('picker unavailable');
-            ok = false;
-        } else if (!clients.moray) {
-            req.log.error('index moray unavailable');
+        if (!clients.moray) {
+            error = 'index moray unavailable';
+            req.log.error(error);
             ok = false;
         } else if (!clients.mahi) {
-            req.log.error('mahi unavailable');
+            error = 'mahi unavailable';
+            req.log.error(error);
+            ok = false;
+        } else if (!clients.picker && !req.isReadOnly()) {
+            error = 'picker unavailable';
+            req.log.error(error);
+            ok = false;
+        } else if (!clients.marlin && req.isMarlinRequest()) {
+            error = 'marlin unavailable';
+            req.log.error(error);
+            ok = false;
+        } else if (!clients.medusa && req.isMedusaRequest()) {
+            error = 'medusa unavailable';
+            req.log.error(error);
             ok = false;
-        } else if (!clients.marlin) {
-            req.log.error('marlin unavailable');
-            ok = !req.isMarlinRequest();
-        } else if (!clients.medusa) {
-            req.log.error('medusa unavailable');
-            ok = !req.isMedusaRequest();
         }
 
         if (!ok) {
             next(new ServiceUnavailableError(req,
-                        new verror.MultiError(errors)));
+                        new verror.VError(error)));
         } else {
             next();
         }
diff --git a/main.js b/main.js
index 2ad6ef4..5d34892 100644
--- a/main.js
+++ b/main.js
@@ -194,6 +194,17 @@ function configure(appName, opts, dtProbes) {
 
     cfg.dtrace_probes = dtProbes;
 
+    assert.object(cfg.jobCache, 'cfg.jobCache');
+    assert.object(cfg.log, 'cfg.log');
+    assert.object(cfg.collector, 'cfg.collector');
+    assert.object(cfg.sharkConfig, 'cfg.sharkConfig');
+    assert.object(cfg.storage, 'cfg.storage');
+    assert.number(cfg.storage.defaultMaxStreamingSizeMB,
+                  'cfg.storage.defaultMaxStreamingSizeMB');
+    assert.object(cfg.multipartUpload, 'cfg.multipartUpload');
+    assert.number(cfg.multipartUpload.prefixDirLen,
+                  'cfg.multipartUpload.prefixDirLen');
+
     cfg.log.debug(cfg, 'muskie: config loaded');
 
     return (cfg);
@@ -379,9 +390,8 @@ function createCueballSharkAgent(sharkCfg) {
 }
 
 
-function onPickerConnect(clients, barrier, pickerClient) {
+function onPickerConnect(clients, pickerClient) {
     clients.picker = pickerClient;
-    barrier.done('createPickerClient');
 }
 
 
@@ -634,12 +644,9 @@ function clientsConnected(appName, cfg, clients) {
     barrier.start('createMorayClient');
     createMorayClient(cfg.moray, onMorayConnect.bind(null, clients, barrier));
 
-    barrier.start('createPickerClient');
-    createPickerClient(cfg.storage, cfg.log,
-        onPickerConnect.bind(null, clients, barrier));
-
     // Establish other client connections needed for writes and jobs requests.
-
+    createPickerClient(cfg.storage, cfg.log,
+        onPickerConnect.bind(null, clients));
     createMarlinClient(cfg.marlin, onMarlinConnect.bind(null, clients));
     createMedusaConnector(cfg.medusa, onMedusaConnect.bind(null, clients));
     clients.sharkAgent = createCueballSharkAgent(cfg.sharkConfig);
