From 3b7c8873d610dbcb22c90a4425d1ef75964b635a Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Mon, 16 Jan 2017 14:51:49 -0800
Subject: [PATCH] DOCKER-944 Docker pull fails with vague error message with
 insecure registries

---
 lib/docker-stdio.js | 23 ++++-------------------
 1 file changed, 4 insertions(+), 19 deletions(-)

diff --git a/lib/docker-stdio.js b/lib/docker-stdio.js
index 784116b..9a2029b 100644
--- a/lib/docker-stdio.js
+++ b/lib/docker-stdio.js
@@ -25,7 +25,6 @@ var http = require('http');
 var net = require('net');
 var path = require('path');
 var pty = require('pty.js');
-var shellescape = require('shell-escape');
 var spawn = child_process.spawn;
 var execFile = child_process.execFile;
 var vmadm = require('vmadm');
@@ -300,13 +299,16 @@ function createDockerFileReadStreamServer(opts, callback) {
         var tar = ['/native/usr/bin/gtar', 'cf', '-'];
 
         tar.push('-C', path.dirname(norm), path.basename(norm));
-        tar = arrayFromShellEscape(tar);
 
         var zloginTarCmd = '/usr/sbin/zlogin';
         var zloginTarArgs = ['-Q', uuid];
 
         Array.prototype.push.apply(zloginTarArgs, tar);
 
+        log.info({ zloginTarArgs: zloginTarArgs },
+                 'createDockerFileReadStreamServer ' +
+                 'onConnectionZoneRunning zloginTarArgs');
+
         var streamProc =
             spawn(zloginTarCmd, zloginTarArgs, { encoding: 'binary' });
 
@@ -495,7 +497,6 @@ function createDockerFileWriteStreamServer(opts, callback) {
             '--no-overwrite-dir' : '--overwrite';
 
         var tar = ['/native/usr/bin/gtar', 'xf', '-', overwrite, '-C', norm];
-        tar = arrayFromShellEscape(tar);
 
         var zloginTarCmd = '/usr/sbin/zlogin';
         var zloginTarArgs = ['-Q', uuid];
@@ -1203,22 +1204,6 @@ function dockerPathStatFromPath(opts) {
 }
 
 
-function arrayFromShellEscape(a) {
-    var ret = [];
-
-    a.forEach(function (s) {
-        if ((new RegExp('[^A-Za-z0-9_/:=-]')).test(s)) {
-            s = '\'' + s.replace(new RegExp('\'', 'g'), '\'\\\'\'') + '\'';
-            s = s.replace(new RegExp('^(?:\'\')+', 'g'), '')
-                 .replace(new RegExp('\\\'\'\'', 'g'), '\\\'');
-        }
-        ret.push(s);
-    });
-
-    return ret;
-}
-
-
 module.exports = {
     setupDockerExecution: setupDockerExecution,
     setupDockerFileStream: setupDockerFileStream
-- 
2.21.0

