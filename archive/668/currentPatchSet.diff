From 6a383d4960e4219a15ff0af00dfe2d6f5127de82 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 13 Oct 2016 10:43:35 -0700
Subject: [PATCH] DOCKER-948 docker build fails with 'Build failed: problem
 starting container' error

---
 lib/backends/sdc/build.js | 48 +++++++++++++++++++--------------------
 1 file changed, 24 insertions(+), 24 deletions(-)

diff --git a/lib/backends/sdc/build.js b/lib/backends/sdc/build.js
index 2253581..cce4519 100644
--- a/lib/backends/sdc/build.js
+++ b/lib/backends/sdc/build.js
@@ -844,11 +844,8 @@ function runBuildCommand(opts, callback) {
     };
 
     /**
-     * This flow is a little strange, so an explanation is warranted:
-     * - attachContainer launches and then it waits for the container to start
-     *   before returning via the callback.
-     * - we synchronously call startContainer and thus this will allow
-     *   attachContainer to return, after which we call waitContainer.
+     * The way `docker run` works is that an `attach` must be made first, and
+     * then the `start` call, and finally the `wait` call.
      */
     req.backend.attachContainer({
         account: req.account,
@@ -866,31 +863,34 @@ function runBuildCommand(opts, callback) {
             callback(err);
             return;
         }
-        // Get return code from the run command.
-        req.backend.waitContainer({
+
+        log.debug('runBuildCommand: startContainer');
+        req.backend.startContainer({
             account: req.account,
             app: req.app,
             log: log,
             req_id: opts.req_id,
             vm: opts.vm
-        }, function (waitErr, exitCode) {
-            log.debug('runBuildCommand: container exit code: %j', exitCode);
-            callback(waitErr, { exitCode: exitCode });
-        });
-    });
+        }, function (startErr) {
+            log.debug('runBuildCommand: startContainer finished, err: %j',
+                startErr);
+            if (startErr) {
+                callback(startErr);
+                return;
+            }
 
-    log.debug('runBuildCommand: startContainer');
-    req.backend.startContainer({
-        account: req.account,
-        app: req.app,
-        log: log,
-        req_id: opts.req_id,
-        vm: opts.vm
-    }, function (err) {
-        log.debug('runBuildCommand: startContainer finished, err: %j', err);
-        if (err) {
-            callback(err);
-        }
+            // Get return code from the run command.
+            req.backend.waitContainer({
+                account: req.account,
+                app: req.app,
+                log: log,
+                req_id: opts.req_id,
+                vm: opts.vm
+            }, function (waitErr, exitCode) {
+                log.debug('runBuildCommand: container exit code: %j', exitCode);
+                callback(waitErr, { exitCode: exitCode });
+            });
+        });
     });
 }
 
-- 
2.21.0

