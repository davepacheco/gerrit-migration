{"project":"joyent/sdcadm","branch":"master","topic":"TRITON-884","id":"I26ef7c9bd43a2b1884cee25b7392e7ab58d3b14f","number":"5780","subject":"TRITON-1305 sdcadm: add Procedure.prepare API, standard runProcs(), convert \u0027sdcadm create\u0027 Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/5780","commitMessage":"TRITON-1305 sdcadm: add Procedure.prepare API, standard runProcs(), convert \u0027sdcadm create\u0027\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1552435131,"lastUpdated":1552584032,"open":false,"status":"MERGED","comments":[{"timestamp":1552435131,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1552435133,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 1e9e445f05f2ebf18a92a3a80ff86db6d0832614\n    \n    do it"},{"timestamp":1552435467,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1552435469,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit d03f70d70d00d750a5a5e3bfeb37c268d6d7b2fb\n    \n    do it"},{"timestamp":1552447064,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Topic set to TRITON-884"},{"timestamp":1552493184,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Code-Review+1\n\n(6 comments)\n\nOther than mostly nits, it looks good to me. Million $ Q: did you run test suite or at least \"create tests\"?"},{"timestamp":1552525455,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1552525781,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1552525783,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit d74055df0c80a3c54ca24542df1dc54e0c47f695\n    \n    minor ver bump instead\n    \n    commit 7e837ced5edefeb4b083bd3835fd54939038545b\n    \n    pedro\u0027s context suggestion\n    \n    commit 29ab88578284840424649c493fdb6ea32588e382\n    \n    first part of pedro feedback\n    \n    commit fa2852c667192d09f93e66dc15cef604d9223ba0\n    \n    do it"},{"timestamp":1552528180,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\ntesting: I\u0027ve done a branch build and updated sdcadm on nightly-3 to that. I\u0027ve started a sdcadm test run: https://jenkins.joyent.us/view/nightly/job/nightly-triton-sdcadm-tests/14/"},{"timestamp":1552537828,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 4."},{"timestamp":1552537830,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit ddc0d5c4daa3f354daa7b5b11b93d1921ab9b694\n    \n    get the sdcadm tests passing: found two real issues"},{"timestamp":1552538242,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nThat ^^ jenkins test run failed... but I\u0027ve worked through each failure and got a pass in nightly-3 for each of those sdcadm test files."},{"timestamp":1552576426,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1552584023,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1552584032,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"5","revision":"26ef7c9bd43a2b1884cee25b7392e7ab58d3b14f","parents":["fb3407a1485c486a1a3dabfea1a6fb9501d51b19"],"ref":"refs/changes/80/5780/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1552584023,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552576426,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1552576426,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1552584032,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/cli/do_create.js","type":"MODIFIED","insertions":172,"deletions":-228},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":165,"deletions":-8},{"file":"lib/procedures/procedure.js","type":"MODIFIED","insertions":100,"deletions":-5},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"test/create.test.js","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/help.test.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":497,"sizeDeletions":-261},"patchSets":[{"number":"1","revision":"aaa507314a29896ae09de5d493145c6e760f5ba9","parents":["1ce5ff6a35342d22aef3261c5d310da9e3e9b186"],"ref":"refs/changes/80/5780/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1552435131,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_create.js","type":"MODIFIED","insertions":177,"deletions":-230},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":165,"deletions":-8},{"file":"lib/procedures/procedure.js","type":"MODIFIED","insertions":100,"deletions":-5},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":493,"sizeDeletions":-251},{"number":"2","revision":"73bffd249a8a44ef395b646a38897affd60087f2","parents":["e30f837117541ae68aef757588786e45a96a6eab"],"ref":"refs/changes/80/5780/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1552435467,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552493184,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"lib/cli/do_create.js","line":88,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Shouldn\u0027t we use \"self\" instead of \"this\" here, just to make sure things don\u0027t get messed up with whatever vasync.pipeline implementation can do internally?"},{"file":"lib/cli/do_create.js","line":88,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Good catch, thanks!"},{"file":"lib/common.js","line":1790,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If you\u0027re going to use latest ECMA features this should be `let` not `var`. It feels strange to have one thing above and the other below when both should be the same."},{"file":"lib/common.js","line":1790,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Will do."},{"file":"lib/procedures/index.js","line":1108,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"On cases like this, shouldn\u0027t we carry this one into the ctx object for the pipeline functions below? Just creating an object at this same level and passing in would make it available during the pipeline execution and after, into the callback function.\n\nI\u0027d also put unlock into that context object."},{"file":"lib/procedures/index.js","line":1108,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m undecided on that pattern. My bias has been that if the variable is used in the \"finish\" callback, then I tend to *not* put it in the context object.  If I make your change the top of the function goes from:\n\n```\n    var execStart;\n    var log \u003d opts.log;\n    var procs \u003d opts.procs;\n    var p \u003d opts.ui.progressFunc();\n    var sdcadm \u003d opts.sdcadm;\n    var ui \u003d opts.ui;\n    var unlock;\n```\n\nto something like:\n\n```\n    var log \u003d opts.log;\n    var p \u003d opts.ui.progressFunc();\n    var sdcadm \u003d opts.sdcadm;\n    var ui \u003d opts.ui;\n    var context \u003d {\n        procs: opts.procs\n    };\n```\n\nIt isn\u0027t quite as clear that `execStart` and `unlock` are variables that are going to exist. I suppose one could do this:\n\n```\n    var log \u003d opts.log;\n    var p \u003d opts.ui.progressFunc();\n    var sdcadm \u003d opts.sdcadm;\n    var ui \u003d opts.ui;\n    var context \u003d {\n        procs: opts.procs,\n        execStart: null,\n        unlock: null\n    };\n```\n\nif that were a concern.\n\nEither way is fine I think. I\u0027ll make the change as you suggest.\n\nWhat is the argument for putting `opts.procs` into `context`, but not `opts.sdcadm`, `opts.log`, `opts.ui`? Or do we do away with *all* function vars other than `var context` if vasync.pipeline is used?"},{"file":"lib/procedures/index.js","line":1211,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027d call this \"finishErr\". It\u0027s very clear below where to look for \"cleanUpErr\". I\u0027d argue it would be the same for this function."},{"file":"lib/procedures/index.js","line":1211,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps runErr? or runProcsErr? It is an error from having done the stuff above, not an error from the finishing up code."},{"file":"lib/procedures/procedure.js","line":101,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Couldn\u0027t we flag this as optional? Not yet maybe?"},{"file":"lib/procedures/procedure.js","line":101,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Not yet. There is still a lot of existing Procedure code in sdcadm that expects `opts.progress` I believe. E.g. https://github.com/joyent/sdcadm/blob/master/lib/procedures/download-images.js#L64"},{"file":"package.json","line":4,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Change huge enough IMO to bump this to 1.25 at least"},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Sure, will do."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_create.js","type":"MODIFIED","insertions":177,"deletions":-230},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":165,"deletions":-8},{"file":"lib/procedures/procedure.js","type":"MODIFIED","insertions":100,"deletions":-5},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":493,"sizeDeletions":-251},{"number":"3","revision":"40f1f38e71cdcfa9a3ce0817a090dc14b63e5ecc","parents":["fb3407a1485c486a1a3dabfea1a6fb9501d51b19"],"ref":"refs/changes/80/5780/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1552525781,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/cli/do_create.js","type":"MODIFIED","insertions":171,"deletions":-228},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":165,"deletions":-8},{"file":"lib/procedures/procedure.js","type":"MODIFIED","insertions":100,"deletions":-5},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":485,"sizeDeletions":-250},{"number":"4","revision":"e5fb4c710ca837f7b5cdc0d38eb1f32e718964f7","parents":["fb3407a1485c486a1a3dabfea1a6fb9501d51b19"],"ref":"refs/changes/80/5780/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1552537828,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552576426,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1552576426,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/cli/do_create.js","type":"MODIFIED","insertions":172,"deletions":-228},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":165,"deletions":-8},{"file":"lib/procedures/procedure.js","type":"MODIFIED","insertions":100,"deletions":-5},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"test/create.test.js","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/help.test.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":497,"sizeDeletions":-261},{"number":"5","revision":"26ef7c9bd43a2b1884cee25b7392e7ab58d3b14f","parents":["fb3407a1485c486a1a3dabfea1a6fb9501d51b19"],"ref":"refs/changes/80/5780/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1552584023,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1552584032,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552576426,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1552576426,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/cli/do_create.js","type":"MODIFIED","insertions":172,"deletions":-228},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":165,"deletions":-8},{"file":"lib/procedures/procedure.js","type":"MODIFIED","insertions":100,"deletions":-5},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"test/create.test.js","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"test/help.test.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":497,"sizeDeletions":-261}],"allReviewers":[{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}