{"project":"joyent/sdc-manta","branch":"master","id":"I102fa82be0ec9fce5f4bc4b33d26346807bd6644","number":"3183","subject":"MANTA-3541 allocation of ZK_IDs is broken Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/3183","commitMessage":"MANTA-3541 allocation of ZK_IDs is broken\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1515595830,"lastUpdated":1516715393,"open":false,"status":"MERGED","comments":[{"timestamp":1515595830,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1515595876,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515626028,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1515626099,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1516276614,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1516276660,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516276789,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(1 comment)\n\nPS2 addresses some concerns I had while thinking about Dave\u0027s comment re: parseInt and is `make prepush` clean. I\u0027ve also re-run the manual testing documented in the ticket with the new variant of also including a float, which resulted in `manta-adm` correctly reporting the error."},{"timestamp":1516294333,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1516368255,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1516368300,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516368434,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(1 comment)\n\nPS3 is `make prepush` clean, and has been tested the same way as previous patch sets. In addition to this, I set \"num\" to null in one of my ZK_SERVERS entries. I also removed this property entirely in another attempt leading to \"servers.num\" being undefined. The tests showed \"manta-adm\" reporting the correct errors."},{"timestamp":1516409640,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1516409775,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\nIn terms of IA: it would be nice to do one more sanity test to make sure it still does what we expect after the validation changes."},{"timestamp":1516621818,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1516621865,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516621925,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\nSorry about this, but while doing the latest round of testing I came across something I had missed.\n\nMy first few rounds of testing were against the ZK_SERVERS list, and I wasn\u0027t properly checking the ZK_ID that each instance was getting. While testing PS3 I added a `manta-adm zk list` in between each provision and it identified that the provisioned servers were getting the wrong ZK_ID. This is because we do the `ZK_SERVERS.length` thing twice: once for ZK_SERVERS (which I was testing for) and again in a separate place for each instance\u0027s ZK_ID (which I overlooked).\n\nPS4 fixes this oversight, and I\u0027ve confirmed that a newly provisioned instance not only appends to ZK_SERVERS properly, but also gets the correct ZK_ID assigned. Full testing notes are in the linked ticket."},{"timestamp":1516642884,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1516643028,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1516712727,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1516712772,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1516712885,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1516715393,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"6","revision":"102fa82be0ec9fce5f4bc4b33d26346807bd6644","parents":["325ac225f0aed800dc61f5b4670e86bdb043b40a"],"ref":"refs/changes/83/3183/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1516712885,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516621865,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516642884,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516643028,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1516715393,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":37,"deletions":-7}],"sizeInsertions":37,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"0395f8ef8cf19658dd04d064e70749dc26f135e3","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/83/3183/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1515595830,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515626028,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515626099,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515595876,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/deploy.js","line":1010,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"May want to use `jsprim.parseInteger` here."},{"file":"lib/deploy.js","line":1010,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Actually, we store this as a number, and `jsprim.parseInteger` asserts on a string on input. I wanted to be careful as to what value we get back, but I think trying to parse it from whatever it\u0027s stored as is the wrong thing to do. For example, if this was a float then our check would be OK and we\u0027d continue, but the intended error state wouldn\u0027t be hit.\n\nI\u0027m really just being paranoid here, but I\u0027ve pushed PS2 which adds an additional check to the following line and checks against the value directly returned from the server entry in ZK_SERVERS."},{"file":"lib/deploy.js","line":1010,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027d never seen the `% 1` construction before, but as far as I know, that does work here.  I don\u0027t think this handles cases like `null` very well, though.  (It technically works because `null \u003c 1` is true, but it\u0027s pretty implicit.  We may want to check that `typeof (server.num) \u003d\u003d \u0027number\u0027`."},{"file":"lib/deploy.js","line":1010,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Man, `isNaN` is awkward. I\u0027ve replaced it with a typeof check, which as far as I can tell is what I wanted `isNaN` to handle initially."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":34,"deletions":-3}],"sizeInsertions":34,"sizeDeletions":-3},{"number":"2","revision":"2f5a2ca34e3aebb3b34f7bc20090346ead296dcc","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/83/3183/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1516276614,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516276660,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":34,"deletions":-3}],"sizeInsertions":34,"sizeDeletions":-3},{"number":"3","revision":"34cb941c0bed414e4a4697bada7c16b785cbe7e4","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/83/3183/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1516368255,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516409640,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516368300,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":34,"deletions":-3}],"sizeInsertions":34,"sizeDeletions":-3},{"number":"4","revision":"5dca99a154fd0b64f4efbb7ca5f7d42d12182ce5","parents":["0630bf87b1a64d4492c2035e56d4cc03c2578f03"],"ref":"refs/changes/83/3183/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1516621818,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516642884,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516643028,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516621865,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":37,"deletions":-7}],"sizeInsertions":37,"sizeDeletions":-7},{"number":"5","revision":"ac9e6d34b92d6e637a08cef0ad650ebe364ac70b","parents":["325ac225f0aed800dc61f5b4670e86bdb043b40a"],"ref":"refs/changes/83/3183/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1516712727,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516642884,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516643028,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516621865,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":37,"deletions":-7}],"sizeInsertions":37,"sizeDeletions":-7},{"number":"6","revision":"102fa82be0ec9fce5f4bc4b33d26346807bd6644","parents":["325ac225f0aed800dc61f5b4670e86bdb043b40a"],"ref":"refs/changes/83/3183/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1516712885,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516642884,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516643028,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516621865,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1516715393,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":37,"deletions":-7}],"sizeInsertions":37,"sizeDeletions":-7}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}