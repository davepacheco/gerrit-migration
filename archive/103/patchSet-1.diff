From 597ac2718d19bd386dc5d45e4fa65965fe0246f7 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Tue, 19 Jul 2016 19:45:07 +0000
Subject: [PATCH] OS-5525 changes to allow the tests to work on SmartOS
 Reviewed by: Robert Mustacchi <rm@joyent.com>

---
 manifest                                   | 15 ++++++++++++
 usr/src/test/os-tests/cmd/ostest.ksh       |  4 ++++
 usr/src/test/os-tests/runfiles/Makefile    |  4 +++-
 usr/src/test/os-tests/runfiles/default.run | 28 ++++++++++++++++++++++
 4 files changed, 50 insertions(+), 1 deletion(-)
 create mode 100644 usr/src/test/os-tests/runfiles/default.run

diff --git a/manifest b/manifest
index 421d0132e2..ab2534cf02 100644
--- a/manifest
+++ b/manifest
@@ -9466,6 +9466,21 @@ d usr/lib/locale/zh_TW.UTF-8/LC_NUMERIC 0755 root bin
 f usr/lib/locale/zh_TW.UTF-8/LC_NUMERIC/LCL_DATA 0755 root bin
 d usr/lib/locale/zh_TW.UTF-8/LC_TIME 0755 root bin
 f usr/lib/locale/zh_TW.UTF-8/LC_TIME/LCL_DATA 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8/LC_COLLATE 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_COLLATE/LCL_DATA 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8/LC_CTYPE 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_CTYPE/LCL_DATA 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8/LC_MESSAGES 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_MESSAGES/LCL_DATA 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_MESSAGES/priv_names 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_MESSAGES/SUNW_OST_OSLIB.mo 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8/LC_MONETARY 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_MONETARY/LCL_DATA 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8/LC_NUMERIC 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_NUMERIC/LCL_DATA 0755 root bin
+d usr/lib/locale/zz_AA.UTF-8/LC_TIME 0755 root bin
+f usr/lib/locale/zz_AA.UTF-8/LC_TIME/LCL_DATA 0755 root bin
 d usr/lib/localedef 0755 root bin
 d usr/lib/localedef/src 0755 root bin
 f usr/lib/lslabels 0555 root bin
diff --git a/usr/src/test/os-tests/cmd/ostest.ksh b/usr/src/test/os-tests/cmd/ostest.ksh
index afa944b613..d404b2aa1a 100644
--- a/usr/src/test/os-tests/cmd/ostest.ksh
+++ b/usr/src/test/os-tests/cmd/ostest.ksh
@@ -14,6 +14,7 @@
 #
 # Copyright (c) 2012 by Delphix. All rights reserved.
 # Copyright 2014, OmniTI Computer Consulting, Inc. All rights reserved.
+# Copyright 2016, Joyent, Inc.
 #
 
 export OS_TESTS="/opt/os-tests"
@@ -34,6 +35,9 @@ function find_runfile
 		distro=openindiana
 	elif [[ 0 -ne $(grep -c OmniOS /etc/release 2>/dev/null) ]]; then
 		distro=omnios
+	elif [[ -f $OS_TESTS/runfiles/default.run ]]; then
+		# optional catch-all
+		distro=default
 	fi
 
 	[[ -n $distro ]] && echo $OS_TESTS/runfiles/$distro.run
diff --git a/usr/src/test/os-tests/runfiles/Makefile b/usr/src/test/os-tests/runfiles/Makefile
index 619c9b812a..03fdd0e540 100644
--- a/usr/src/test/os-tests/runfiles/Makefile
+++ b/usr/src/test/os-tests/runfiles/Makefile
@@ -12,11 +12,13 @@
 #
 # Copyright (c) 2012 by Delphix. All rights reserved.
 # Copyright 2014, OmniTI Computer Consulting, Inc. All rights reserved.
+# Copyright 2016, Joyent, Inc.
 #
 
 include $(SRC)/Makefile.master
 
-SRCS = delphix.run \
+SRCS = default.run \
+	delphix.run \
 	omnios.run \
 	openindiana.run
 
diff --git a/usr/src/test/os-tests/runfiles/default.run b/usr/src/test/os-tests/runfiles/default.run
new file mode 100644
index 0000000000..4e73ebc8b3
--- /dev/null
+++ b/usr/src/test/os-tests/runfiles/default.run
@@ -0,0 +1,28 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright (c) 2012 by Delphix. All rights reserved.
+#
+
+[DEFAULT]
+pre =
+verbose = False
+quiet = False
+timeout = 60
+post =
+outputdir = /var/tmp/test_results
+
+[/opt/os-tests/tests/poll_test]
+user = root
+
+[/opt/os-tests/tests/sigqueue]
+tests = ['sigqueue_queue_size']
-- 
2.21.0

