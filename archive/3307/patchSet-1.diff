commit 593981325b831071fa17ad49e152c845260ef93a (refs/changes/07/3307/1)
Author: Jerry Jelinek <jerry.jelinek@joyent.com>
Date:   2018-02-07T14:59:27+00:00 (1 year, 8 months ago)
    
    OS-6588 zfs_zone IO throttle assertion failure

diff --git a/usr/src/uts/common/fs/zfs/zfs_zone.c b/usr/src/uts/common/fs/zfs/zfs_zone.c
index 59357cbee5..e29de32b2b 100644
--- a/usr/src/uts/common/fs/zfs/zfs_zone.c
+++ b/usr/src/uts/common/fs/zfs/zfs_zone.c
@@ -654,11 +654,12 @@ zfs_zone_wait_adjust_calculate_cb(zone_t *zonep, void *arg)
 	zone_persist_t *zpd = &zone_pdata[zonep->zone_id];
 	zone_zfs_io_t *iop = zpd->zpers_zfsp;
 
-	ASSERT(MUTEX_HELD(&zpd->zpers_zfs_lock));
 	ASSERT3P(iop, !=, NULL);
 
+	mutex_enter(&zpd->zpers_zfs_lock);
 	if (zonep->zone_id == GLOBAL_ZONEID ||
 	    get_zone_io_cnt(sp->zi_now, iop, &rops, &wops, &lwops) == 0) {
+		mutex_exit(&zpd->zpers_zfs_lock);
 		return (0);
 	}
 
@@ -670,6 +671,7 @@ zfs_zone_wait_adjust_calculate_cb(zone_t *zonep, void *arg)
 		sp->zi_active++;
 		sp->zi_totpri += iop->zpers_zfs_io_pri;
 	}
+	mutex_exit(&zpd->zpers_zfs_lock);
 
 	/*
 	 * sdt:::zfs-zone-utilization
@@ -719,9 +721,9 @@ zfs_zone_wait_adjust_delay_cb(zone_t *zonep, void *arg)
 	uint8_t delay;
 	uint_t fairutil = 0;
 
-	ASSERT(MUTEX_HELD(&zpd->zpers_zfs_lock));
 	ASSERT3P(iop, !=, NULL);
 
+	mutex_enter(&zpd->zpers_zfs_lock);
 	delay = iop->zpers_io_delay;
 	iop->zpers_io_util_above_avg = 0;
 
@@ -749,6 +751,7 @@ zfs_zone_wait_adjust_delay_cb(zone_t *zonep, void *arg)
 	    sp->zi_active <= 1) {
 		zfs_zone_delay_dec(iop);
 	}
+	mutex_exit(&zpd->zpers_zfs_lock);
 
 	/*
 	 * sdt:::zfs-zone-throttle
