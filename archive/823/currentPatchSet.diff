From f84a5861c71f7087f5bd5598aa760da072fe3a64 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Thu, 3 Nov 2016 19:02:34 +0000
Subject: [PATCH] OS-5752 incorrect mutex handling for ptrace clone inherit
 Reviewed by: Patrick Mooney <patrick.mooney@joyent.com> Reviewed by: Ryan
 Zezeski <ryan.zeseski@joyent.com> Approved by: Patrick Mooney
 <patrick.mooney@joyent.com>

---
 usr/src/uts/common/brand/lx/os/lx_ptrace.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/os/lx_ptrace.c b/usr/src/uts/common/brand/lx/os/lx_ptrace.c
index 7bc788e79c..bb3d936b26 100644
--- a/usr/src/uts/common/brand/lx/os/lx_ptrace.c
+++ b/usr/src/uts/common/brand/lx/os/lx_ptrace.c
@@ -1116,19 +1116,20 @@ lx_ptrace_set_clone_inherit(int option, boolean_t inherit_flag)
 	proc_t *p = lwptoproc(lwp);
 	lx_lwp_data_t *lwpd = lwptolxlwp(lwp);
 
-	mutex_enter(&p->p_lock);
-
 	switch (option) {
 	case LX_PTRACE_O_TRACEFORK:
 	case LX_PTRACE_O_TRACEVFORK:
 	case LX_PTRACE_O_TRACECLONE:
-		lwpd->br_ptrace_clone_option = option;
 		break;
 
 	default:
 		return (EINVAL);
 	}
 
+	mutex_enter(&p->p_lock);
+
+	lwpd->br_ptrace_clone_option = option;
+
 	if (inherit_flag) {
 		lwpd->br_ptrace_flags |= LX_PTF_INHERIT;
 	} else {
-- 
2.21.0

