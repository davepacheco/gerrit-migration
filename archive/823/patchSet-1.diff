From 9567e51fedf1df0b34cfe330e37021a257de8a2e Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 31 Oct 2016 20:52:57 +0000
Subject: [PATCH] OS-5752 incorrect mutex handling for ptrace clone inherit

---
 usr/src/uts/common/brand/lx/os/lx_ptrace.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/os/lx_ptrace.c b/usr/src/uts/common/brand/lx/os/lx_ptrace.c
index 7bc788e79c..bb3d936b26 100644
--- a/usr/src/uts/common/brand/lx/os/lx_ptrace.c
+++ b/usr/src/uts/common/brand/lx/os/lx_ptrace.c
@@ -1116,19 +1116,20 @@ lx_ptrace_set_clone_inherit(int option, boolean_t inherit_flag)
 	proc_t *p = lwptoproc(lwp);
 	lx_lwp_data_t *lwpd = lwptolxlwp(lwp);
 
-	mutex_enter(&p->p_lock);
-
 	switch (option) {
 	case LX_PTRACE_O_TRACEFORK:
 	case LX_PTRACE_O_TRACEVFORK:
 	case LX_PTRACE_O_TRACECLONE:
-		lwpd->br_ptrace_clone_option = option;
 		break;
 
 	default:
 		return (EINVAL);
 	}
 
+	mutex_enter(&p->p_lock);
+
+	lwpd->br_ptrace_clone_option = option;
+
 	if (inherit_flag) {
 		lwpd->br_ptrace_flags |= LX_PTF_INHERIT;
 	} else {
-- 
2.21.0

