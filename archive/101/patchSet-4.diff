From 5eef34c4b908e140f5667f869b674e06b5d1f5b8 Mon Sep 17 00:00:00 2001
From: "Pedro P. Candel" <pedro@joyent.com>
Date: Wed, 20 Jul 2016 11:00:54 +0200
Subject: [PATCH] TOOLS-1492 `sdcadm insts` exceptions on SAPI instances for
 removed servers Reviewed by: Joshua M. Clulow <jmc@joyent.com>

---
 lib/sdcadm.js | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index e261af1..e33c8de 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -815,13 +815,28 @@ SdcAdm.prototype.listInsts = function listInsts(opts, cb) {
                             if (ins.params && ins.params.server_uuid) {
                                 var id = ins.params.server_uuid;
                                 d.server = id;
+                                /*
+                                 * If a compute node has been removed from
+                                 * CNAPI, there may still be a dangling
+                                 * SAPI instance -- if the server no
+                                 * longer exists, skip it.
+                                 */
+                                if (!ctx.serverFromUuid[id]) {
+                                    self.log.warn({
+                                        instance: ins
+                                    }, 'Skipping dockerlogger instance ' +
+                                    'for unknown server');
+                                    return null;
+                                }
                                 d.hostname = ctx.serverFromUuid[id].hostname;
                                 d.server_ip = ctx.serverAdminIpFromUuid[id];
                             }
                             return (d);
+                        }).filter(function (ins) {
+                            return (ins !== null);
                         });
                         ctx.insts = ctx.insts.concat(dlInsts);
-                        return next();
+                        next();
                     });
                 });
             });
-- 
2.21.0

