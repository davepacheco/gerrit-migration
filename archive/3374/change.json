{"project":"joyent/illumos-joyent","branch":"master","id":"I1ac47fa7f9c6f9d618a41f1f7e8a518cc8ca75cd","number":"3374","subject":"OS-6558 sdev_create_minor_node should allow non-666 Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3374","commitMessage":"OS-6558 sdev_create_minor_node should allow non-666\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1518733261,"lastUpdated":1518798246,"open":false,"status":"MERGED","comments":[{"timestamp":1518733261,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1518733388,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nIn email, Robert suggested that maybe separate arguments for type and mode would be good.  I think that consistency with mknod(2) is better, but am not dead set on that."},{"timestamp":1518734018,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nTesting: ran same code with and without dev-bhyve bits.  dev-bhyve is debug, other is non-debug.  Able to boot smartos, lx, and bhyve zones.  `vndtest -a` passes 47/47."},{"timestamp":1518737196,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(5 comments)\n\nPlease make sure the testing notes end up in the OS ticket."},{"timestamp":1518790607,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1518790758,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1518794347,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)\n\nThanks for the cleanup."},{"timestamp":1518794697,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1518794719,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1518794806,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1518795504,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1518798032,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\nMore testing: Verified that vndtest is still happy.  Also verified that vnd is creating devices with 666 and vmm is creating them with 600."},{"timestamp":1518798101,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1518798136,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1518798238,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1518798246,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"5","revision":"f8d8b6be42cc7c38b4108447aa7169ebbd361979","parents":["6746ed3b77d080c3e97412bd3a094833430ecbc9"],"ref":"refs/changes/74/3374/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518798238,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518794806,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518795504,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518798101,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1518798246,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","type":"MODIFIED","insertions":26,"deletions":-4},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":10,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"b89ac688bcb702b72c5ed49c6a9890007181176f","parents":["284a6e28f3bf022a4b8320b2c2cb8db90b05df1e"],"ref":"refs/changes/74/3374/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518733261,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","line":252,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So, S_IFMT and S_IAMB don\u0027t cover all of the bits in the mode_t. For example, SUID/SGID are outside of this.\n\nI think we probably want to add a check before 262 that looks something like:\n\nif (mode \u0026 ~(S_IFMT | S_IAMB)) !\u003d 0)\n        return (EINVAL);"},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","line":252,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I guess I shouldn\u0027t have put away my octal to hex to octal flash cards so soon."},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","line":262,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This doesn\u0027t check SUID/SGID, see earlier note. Probably worth making sure the comment correctly reflects what we\u0027re checking."},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","line":262,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":5423,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Um, we shouldn\u0027t be putting back things with XXXs. I\u0027m not sure if the dubious is referring to the XXX or the use of 0666. We use privileges (hopefully correctly!)."},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":5423,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Oops, somehow some of my changes didn\u0027t make it over from my dev-bhyve workspace."},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":5425,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This should probably be a macro with a comment explaining it."},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":5425,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Added a macro above to with a comment."},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":5469,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Same XXX comment."},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":5469,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","type":"MODIFIED","insertions":13,"deletions":-4},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":18,"sizeDeletions":-7},{"number":"2","revision":"08668c2ebdc17d0bb0c153cabc068ee7c4177783","parents":["284a6e28f3bf022a4b8320b2c2cb8db90b05df1e"],"ref":"refs/changes/74/3374/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518790607,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/vnd/vnd.c","line":951,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor nit, but mind adding a blank line here?"},{"file":"usr/src/uts/common/io/vnd/vnd.c","line":951,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","type":"MODIFIED","insertions":26,"deletions":-4},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":9,"deletions":-3}],"sizeInsertions":35,"sizeDeletions":-7},{"number":"3","revision":"1ac47fa7f9c6f9d618a41f1f7e8a518cc8ca75cd","parents":["284a6e28f3bf022a4b8320b2c2cb8db90b05df1e"],"ref":"refs/changes/74/3374/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518794697,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518794806,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518795504,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518798101,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","type":"MODIFIED","insertions":26,"deletions":-4},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":10,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-7},{"number":"4","revision":"d15eb1749624974f5d3f9e51c468f5d11955f6fa","parents":["6746ed3b77d080c3e97412bd3a094833430ecbc9"],"ref":"refs/changes/74/3374/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518798136,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518794806,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518795504,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518798101,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","type":"MODIFIED","insertions":26,"deletions":-4},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":10,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-7},{"number":"5","revision":"f8d8b6be42cc7c38b4108447aa7169ebbd361979","parents":["6746ed3b77d080c3e97412bd3a094833430ecbc9"],"ref":"refs/changes/74/3374/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518798238,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518794806,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518795504,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518798101,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1518798246,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/dev/sdev_plugin.c","type":"MODIFIED","insertions":26,"deletions":-4},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":10,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-7}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}