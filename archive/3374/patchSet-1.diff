commit b89ac688bcb702b72c5ed49c6a9890007181176f (refs/changes/74/3374/1)
Author: Mike Gerdts <mike.gerdts@joyent.com>
Date:   2018-02-15T21:45:01+00:00 (1 year, 8 months ago)
    
    OS-6558 sdev_create_minor_node should allow non-666

diff --git a/usr/src/uts/common/fs/dev/sdev_plugin.c b/usr/src/uts/common/fs/dev/sdev_plugin.c
index bca7325bfb..831ba896f1 100644
--- a/usr/src/uts/common/fs/dev/sdev_plugin.c
+++ b/usr/src/uts/common/fs/dev/sdev_plugin.c
@@ -248,28 +248,37 @@ sdev_plugin_mknod(sdev_ctx_t ctx, char *name, mode_t mode, dev_t dev)
 	sdev_node_t *sdvp;
 	timestruc_t now;
 	struct vattr vap;
+	mode_t type = mode & S_IFMT;
+	mode_t access = mode & S_IAMB;
 
 	if (sdev_plugin_name_isvalid(name, SDEV_PLUGIN_NAMELEN) == 0)
 		return (EINVAL);
 
 	sdvp = (sdev_node_t *)ctx;
 	ASSERT(RW_WRITE_HELD(&sdvp->sdev_contents));
-	if (mode != S_IFCHR && mode != S_IFBLK)
+	if (type != S_IFCHR && type != S_IFBLK)
 		return (EINVAL);
 
+	/* There's no reason for a device file to be executable, setuid, etc. */
+	if ((access & 0666) != access)
+		return (EINVAL);
+
+	/* Default to relatively safe access bits if none specified. */
+	if (access & 0666 == 0)
+		access = 0600;
+
 	ASSERT(sdvp->sdev_private != NULL);
 
-	vap = *sdev_getdefault_attr(mode == S_IFCHR ? VCHR : VBLK);
+	vap = *sdev_getdefault_attr(type == S_IFCHR ? VCHR : VBLK);
 	gethrestime(&now);
 	vap.va_atime = now;
 	vap.va_mtime = now;
 	vap.va_ctime = now;
 	vap.va_rdev = dev;
-	vap.va_mode = mode | 0666;
+	vap.va_mode = type | access;
 
 	/* Despite the similar name, this is in fact a different function */
 	return (sdev_plugin_mknode(sdvp->sdev_private, sdvp, name, &vap));
-
 }
 
 static int
diff --git a/usr/src/uts/common/io/vnd/vnd.c b/usr/src/uts/common/io/vnd/vnd.c
index 5766b39692..072f30fdf3 100644
--- a/usr/src/uts/common/io/vnd/vnd.c
+++ b/usr/src/uts/common/io/vnd/vnd.c
@@ -5420,8 +5420,9 @@ vnd_sdev_fillzone(vnd_pnsd_t *nsp, sdev_ctx_t ctx)
 		mutex_enter(&vdp->vdd_lock);
 		if ((vdp->vdd_flags & VND_D_LINKED) &&
 		    !(vdp->vdd_flags & (VND_D_CONDEMNED | VND_D_ZONE_DYING))) {
-			ret = sdev_plugin_mknod(ctx, vdp->vdd_lname, S_IFCHR,
-			    vdp->vdd_devid);
+			/* XXX-mg 0666 added for compatibility.  Dubious. */
+			ret = sdev_plugin_mknod(ctx, vdp->vdd_lname,
+			    S_IFCHR | 0666, vdp->vdd_devid);
 			if (ret != 0 && ret != EEXIST) {
 				mutex_exit(&vdp->vdd_lock);
 				mutex_exit(&nsp->vpnd_lock);
@@ -5465,7 +5466,8 @@ vnd_sdev_filldir_root(sdev_ctx_t ctx)
 	 * Always add a reference to the control node. There's no need to
 	 * reference it since it always exists and is always what we clone from.
 	 */
-	ret = sdev_plugin_mknod(ctx, "ctl", S_IFCHR,
+	/* XXX-mg 0666 added for compatibility.  Dubious. */
+	ret = sdev_plugin_mknod(ctx, "ctl", S_IFCHR | 0666,
 	    makedevice(ddi_driver_major(vnd_dip), 0));
 	if (ret != 0 && ret != EEXIST)
 		return (ret);
