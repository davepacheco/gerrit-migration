{"project":"joyent/illumos-joyent","branch":"master","id":"I2ea16040af9fa1f9853532ff12ee081390c1ed8a","number":"4566","subject":"OS-7089 exec_init() should be able to handle a 64bit init process Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: John Levon \u003cjohn.l","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/4566","commitMessage":"OS-7089 exec_init() should be able to handle a 64bit init process\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1532525245,"lastUpdated":1534506133,"open":false,"status":"MERGED","comments":[{"timestamp":1532525245,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1532525431,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1532700677,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1532702137,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nJohn\u0027s comment about duplicating the code reflects my biggest concern here."},{"timestamp":1532712920,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1533050950,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1533051272,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1533115717,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1533216513,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1533582811,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1534157023,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4."},{"timestamp":1534157060,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1534160406,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534165170,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534169834,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534501697,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1534506000,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1534506101,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1534506133,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"6","revision":"48810110f815c605fe76c7da807dcfc9f4962485","parents":["538cd0175e38e49ca5a8d6ddab4fd0a20bfda9d1"],"ref":"refs/changes/66/4566/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534506101,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534160406,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534165170,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534169834,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534501697,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1534506133,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":40,"deletions":-20}],"sizeInsertions":40,"sizeDeletions":-20},"patchSets":[{"number":"1","revision":"01fc88188348c8ddac9713453fb5e424c57dd7c1","parents":["1821ad2a382112c3a39fc71546b117f6eb90764a"],"ref":"refs/changes/66/4566/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1532525245,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":34,"deletions":-15}],"sizeInsertions":34,"sizeDeletions":-15},{"number":"2","revision":"38f64374d18ab98698fbcb42fd4cf987833fd27a","parents":["1821ad2a382112c3a39fc71546b117f6eb90764a"],"ref":"refs/changes/66/4566/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1532525431,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/main.c","line":240,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Hmm, I\u0027m not a big fan of duplicating all this code; can\u0027t we refactor into a separate function that passes in the pointer width? We\u0027d still need to check explicitly for the cast on line 230 but nothing else I think?"},{"file":"usr/src/uts/common/os/main.c","line":240,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, I\u0027m also not fond of doing both 64-bit and 32-bit conversions throughout the function.  Maybe having something that does the 64-\u003e32b conversion at the end if needed?"},{"file":"usr/src/uts/common/os/main.c","line":240,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/common/os/main.c","line":278,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"why didn\u0027t you remove this unnecessary cast as well?"},{"file":"usr/src/uts/common/os/main.c","line":278,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/common/os/main.c","line":300,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"also these casts"},{"file":"usr/src/uts/common/os/main.c","line":300,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/common/os/main.c","line":342,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m a little confused about this assertion given that /usr/lib/brand/bhyve/zhyve is 64-bit..."},{"file":"usr/src/uts/common/os/main.c","line":342,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"This is still true for this function as it sets up the process from which init is exec\u0027ed as 32bit. The actual exec() of bhyve will turn this into a 64bit process since the bhyve binary is 64bit. \n\nThe difference in the rexec_init() case is that the existing  process is reused, which in the case of bhyve is 64bit."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":34,"deletions":-15}],"sizeInsertions":34,"sizeDeletions":-15},{"number":"3","revision":"3c9e3d9ba40d898ceec413492c6aa061d80286ba","parents":["1821ad2a382112c3a39fc71546b117f6eb90764a"],"ref":"refs/changes/66/4566/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1533050950,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533216513,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533115717,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/uts/common/os/main.c","line":156,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason for this to be signed?  (probably stick with size_t?)"},{"file":"usr/src/uts/common/os/main.c","line":156,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":40,"deletions":-20}],"sizeInsertions":40,"sizeDeletions":-20},{"number":"4","revision":"fcd1365b88776ec9de2a511db0d9d56296abf996","parents":["1821ad2a382112c3a39fc71546b117f6eb90764a"],"ref":"refs/changes/66/4566/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534157023,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534165170,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534169834,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534160406,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534501697,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":40,"deletions":-20}],"sizeInsertions":40,"sizeDeletions":-20},{"number":"5","revision":"2ea16040af9fa1f9853532ff12ee081390c1ed8a","parents":["1821ad2a382112c3a39fc71546b117f6eb90764a"],"ref":"refs/changes/66/4566/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534506000,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534165170,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534169834,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534160406,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534501697,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":40,"deletions":-20}],"sizeInsertions":40,"sizeDeletions":-20},{"number":"6","revision":"48810110f815c605fe76c7da807dcfc9f4962485","parents":["538cd0175e38e49ca5a8d6ddab4fd0a20bfda9d1"],"ref":"refs/changes/66/4566/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534506101,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534165170,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534169834,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1534506133,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534160406,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534501697,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/os/main.c","type":"MODIFIED","insertions":40,"deletions":-20}],"sizeInsertions":40,"sizeDeletions":-20}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}