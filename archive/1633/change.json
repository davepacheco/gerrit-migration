{"project":"joyent/sdc-imgapi","branch":"master","id":"I501e8cc0f2004a74a58464c9f9a003560f5ad6c0","number":"1633","subject":"IMGAPI-616 Cleanup old failed docker image layer downloads","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/1633","commitMessage":"IMGAPI-616 Cleanup old failed docker image layer downloads\n","createdOn":1489007191,"lastUpdated":1512502893,"open":false,"status":"ABANDONED","comments":[{"timestamp":1489007191,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1489007192,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit b37e68d3f331bcccf4e6177f4a904130e37fea29\n    \n    IMGAPI-616 Cleanup old failed docker image layer downloads"},{"timestamp":1489007224,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489089672,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nI\u0027m confident you\u0027ll call BS on this if you feel it is.\n\nSay we move to using SRV records and have multiple IMGAPI processes in the imgapi0 zone? There *have* been a couple cases in prod where the imgapi process was getting swamped parsing/stringifying lots of JSON. Once cueball and registrar are ready for SRV records, we would consider doing so.  If we had that, then one of the imgapi processes restarting would stomp on in-progress uploads from another imgapi process. All processes restarting would potentially hit errors when racing to delete found files.\n\nWhat about:\n1. Add a command to \u0027imgapiadm\u0027 to do this cleanup (perhaps including an option or separate command for doing so in *manta* storage).\n2. A cron job that periodically runs that (say once per day).\n\nThoughts?"},{"timestamp":1489090583,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nAfter writing this up, I did feel that it might be better used as a standalone imgapiadm command, so I\u0027m at least pleased that you see the same. My thoughts are:\n\n1. For a loaded IMGAPI it will add a large delay to startup time (~4 seconds in my testing of us-sw-1).\n\n2. The imgapiadm cleanup command should only cleanup *old* temporary images (i.e. older than a week might suffice). This age could even be a command argument - that way the IMGAPI process does not need to be stopped, nor conflict with any other IMGAPI processes.\n\nNow, two questions:\n\n1. The name - `imgapiadm cleanup-temp-files`?\n\n2. Does imgapiadm check-files notice files that exist on disk, but not in the DB?"},{"timestamp":1489091117,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n+1 to having it only look at images older than a certain amount of time.\n\n1. name: Your suggested name is fine.\n2. No, `check-files` only considers files for manifests in the DB."},{"timestamp":1512502893,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Abandoned"}],"currentPatchSet":{"number":"1","revision":"501e8cc0f2004a74a58464c9f9a003560f5ad6c0","parents":["36d59a79372fc57a0e15841b4acb47995bfa9df0"],"ref":"refs/changes/33/1633/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1489007191,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489007224,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/storage.js","type":"MODIFIED","insertions":64,"deletions":-2}],"sizeInsertions":64,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"501e8cc0f2004a74a58464c9f9a003560f5ad6c0","parents":["36d59a79372fc57a0e15841b4acb47995bfa9df0"],"ref":"refs/changes/33/1633/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1489007191,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489007224,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/storage.js","type":"MODIFIED","insertions":64,"deletions":-2}],"sizeInsertions":64,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}