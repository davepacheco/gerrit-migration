From 9e25a1a31684e0d5b373371ff44a88339d59487d Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 12 Oct 2018 09:50:17 -0700
Subject: [PATCH] TRITON-810 vm-agent should support dummy vminfod Reviewed by:
 Trent Mick <trentm@gmail.com> Approved by: Trent Mick <trentm@gmail.com>

---
 bin/run-dummy-vm-agents.js | 10 ++++++++--
 lib/vm-agent.js            |  4 +---
 package.json               |  4 ++--
 3 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/bin/run-dummy-vm-agents.js b/bin/run-dummy-vm-agents.js
index e692274..166f72f 100644
--- a/bin/run-dummy-vm-agents.js
+++ b/bin/run-dummy-vm-agents.js
@@ -7,6 +7,7 @@
 /*
  * Copyright (c) 2018, Joyent, Inc.
  */
+/* eslint no-console: 0 */  // --> OFF
 'use strict';
 
 const child_process = require('child_process');
@@ -14,9 +15,9 @@ const fs = require('fs');
 const path = require('path');
 const util = require('util');
 
-var assert = require('assert-plus');
-const DummyVmadm = require('vmadm/lib/index.dummy');
+const assert = require('assert-plus');
 const bunyan = require('bunyan');
+const DummyVmadm = require('vmadm/lib/index.dummy_vminfod');
 const vasync = require('vasync');
 
 const VmAgent = require('../lib');
@@ -37,6 +38,7 @@ function mockCloudRoot() {
     } catch (err) {
         // The old default for backward compatibility.
         const oldDefault = '/opt/custom/virtual';
+
         console.warn('warning: dummy backend could not get '
                      + '"mockcloudRoot" dir from mdata, using default %s: %s',
                      oldDefault, err);
@@ -84,21 +86,25 @@ function runAgent(opts, cb) {
 
     console.log(`config skeletop for agent ${opts.serverUuid}`,
                util.inspect(config, {depth: null}));
+
     config.vmadm = new DummyVmadm({serverUuid: opts.serverUuid,
                                    serverRoot: SERVER_ROOT, log: log});
     config.log = log;
 
     const vmagent = new VmAgent(config);
+
     vmagent.start(cb);
 }
 
 
 function main() {
     const dirs = fs.readdirSync(SERVER_ROOT);
+
     console.log('server uuids:', dirs);
 
     const sdcDcName = mdataGetSync('sdc:datacenter_name');
     const dnsDomain = mdataGetSync('dnsDomain');
+
     console.log(`sdc:datacenter_name=${sdcDcName} dnsDomain=${dnsDomain}`);
 
     vasync.forEachPipeline({
diff --git a/lib/vm-agent.js b/lib/vm-agent.js
index afc413d..3c4745b 100644
--- a/lib/vm-agent.js
+++ b/lib/vm-agent.js
@@ -153,9 +153,7 @@ function VmAgent(options) {
     assert.string(options.vmapi_url, 'options.vmapi_url');
     assert.optionalObject(options.cueballHttpAgent, 'options.cueballHttpAgent');
 
-    if (options.vmadm) {
-        self.vmadm = options.vmadm ? options.vmadm : vmadm;
-    }
+    self.vmadm = options.vmadm ? options.vmadm : vmadm;
 
     // Load the list of fields that VmWatcher will be watching, which we'll
     // use when comparing objects. Since VMAPI and vmadm have different default
diff --git a/package.json b/package.json
index 7a58e9c..e909684 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "vm-agent",
     "description": "SmartDC Node VM Agent",
-    "version": "1.7.2",
+    "version": "1.8.0",
     "author": "Joyent (joyent.com)",
     "private": true,
     "dependencies": {
@@ -18,7 +18,7 @@
         "restify-clients": "1.6.0",
         "tape": "4.2.2",
         "vasync": "1.6.3",
-        "vmadm": "1.2.0"
+        "vmadm": "https://github.com/joyent/node-vmadm.git#grr-TRITON-805"
     },
     "devDependencies": {
         "eslint": "4.19.1",
-- 
2.21.0

