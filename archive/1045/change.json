{"project":"joyent/sdc-manta","branch":"master","id":"Ic3a74d5742528a00460cd90853f05d041e9015ef","number":"1045","subject":"MANTA-3037 manta-adm genconfig should support multiple DCs MANTA-3041 manta-adm genconfig policy with uneven racks could use work MANTA-3044 manta-adm genconfig could print summary Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e Approved by: Ric","owner":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"url":"https://cr.joyent.us/1045","commitMessage":"MANTA-3037 manta-adm genconfig should support multiple DCs\nMANTA-3041 manta-adm genconfig policy with uneven racks could use work\nMANTA-3044 manta-adm genconfig could print summary\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\nApproved by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\n","createdOn":1480638077,"lastUpdated":1481131677,"open":false,"status":"MERGED","comments":[{"timestamp":1480638077,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 1."},{"timestamp":1480640431,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 2."},{"timestamp":1480640593,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480640974,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 3."},{"timestamp":1480641065,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480690992,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(2 comments)\n\nI\u0027m still reviewing this one, but other than some very minor nits (some not even worth mentioning, imo) nothing is jumping out here.\n\nI\u0027ve tried to focus on the test suite, which as I understand it doesn\u0027t break existing tests but allows for our extra AZs, if any. This definitely eases my initial concerns that there are so many scenarios to consider with this tool. \n\nI\u0027m continuing to review."},{"timestamp":1480695062,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1480695333,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 4."},{"timestamp":1480939052,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(2 comments)\n\nThis looks good to me, with the exception of some minor pieces (see comments). \n\nThe changes to the man page look good at the source, and the generated output looks OK to me, but I have not run this through `man` to verify. \n\nThe only other thing that I had to do a bit of digging on is the messaging around errors/warnings. My understanding is that we don\u0027t handle these as errors through our callbacks (e.g. L735 in lib/adm.js), but let printIssues handle them through our error stream, presumably so we can print all of our issues in one go. We simply pass back the total amount of errors (not warnings) so that cmd/manta-adm.js knows something went wrong, and the errors and warnings are already printed to our error stream.\n\nThis is very minor (and entirely optional), but cmd/manta-adm.js makes reference to this error count as \"nwarnings\" (https://github.com/joyent/sdc-manta/blob/deb5a2a729c2bfeb896c6fd8ccc36f06ad309333/cmd/manta-adm.js#L231). My understanding is that this return value will never contain warnings and only contain errors so the name is a little confusing. This isn\u0027t a result of your change, however, so I don\u0027t know if it\u0027s worth touching this.\n\nIt looks like there was plenty of testing done in MANTA-3041 and MANTA-3037. If you\u0027d like some extra eyes on some additional edge cases (particularly around the new multi-AZ support) then let me know. Otherwise, I\u0027m happy with the test coverage."},{"timestamp":1480956872,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(2 comments)\n\n\u003e The only other thing that I had to do a bit of digging on is the\n \u003e messaging around errors/warnings. My understanding is that we don\u0027t\n \u003e handle these as errors through our callbacks (e.g. L735 in\n \u003e lib/adm.js), but let printIssues handle them through our error\n \u003e stream, presumably so we can print all of our issues in one go. We\n \u003e simply pass back the total amount of errors (not warnings) so that\n \u003e cmd/manta-adm.js knows something went wrong, and the errors and\n \u003e warnings are already printed to our error stream.\n\n\nThat\u0027s right.  This is basically because I don\u0027t think we have a great abstraction for collecting a combination of warnings and errors that could be emitted later.  (I think it\u0027s beyond the scope of this work, but it could be interesting to add such an abstraction to node-verror: an interface that would you accumulate Errors as either \u0027warning\u0027 or \u0027error\u0027 level, allow you to access all of them, keep track of the counts of each, and maybe have default behavior around the overall success of the operation (e.g., it\u0027s successful if there are no errors, or it\u0027s successful if there are no warnings or errors).\n\n\n \u003e This is very minor (and entirely optional), but cmd/manta-adm.js\n \u003e makes reference to this error count as \"nwarnings\"\n \u003e (https://github.com/joyent/sdc-manta/blob/deb5a2a729c2bfeb896c6fd8ccc36f06ad309333/cmd/manta-adm.js#L231).\n \u003e My understanding is that this return value will never contain\n \u003e warnings and only contain errors so the name is a little confusing.\n \u003e This isn\u0027t a result of your change, however, so I don\u0027t know if\n \u003e it\u0027s worth touching this.\n\nI went ahead and changed this to \"nissues\" to leave open the possibility of having this count include warnings or errors.  I\u0027ve retested \"make prepush\" and a \"manta-adm genconfig --from-file\" case that produces a warning and one that produces an error."},{"timestamp":1480956899,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 5."},{"timestamp":1480957009,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480968562,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nThanks for fleshing these points out. I\u0027m happy with the changes and test coverage."},{"timestamp":1481131547,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1481131677,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by David Pacheco"}],"currentPatchSet":{"number":"6","revision":"c3a74d5742528a00460cd90853f05d041e9015ef","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/6","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1481131547,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480957009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480968562,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480968562,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1481131677,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"lib/adm.js","type":"MODIFIED","insertions":104,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2030,"sizeDeletions":-162},"patchSets":[{"number":"1","revision":"81e95b31f342806e3f430fb09fc5573085052f19","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/1","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1480638077,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":true,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":19,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":26,"deletions":-14},{"file":"lib/adm.js","type":"MODIFIED","insertions":101,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":26,"deletions":-14},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2020,"sizeDeletions":-156},{"number":"2","revision":"4c03c1dcbea42c4dcd4611276414d7962d3fd596","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1480640431,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480640593,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":19,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"lib/adm.js","type":"MODIFIED","insertions":104,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2029,"sizeDeletions":-160},{"number":"3","revision":"3625e158bf22371e2c514e440412812f6190d623","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/3","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1480640974,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480641065,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":704,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is the AND here required? Can \"args.outstream\" ever be null if the `typeof \u003d\u003d object` matches?"},{"file":"lib/adm.js","line":704,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Surprisingly enough, typeof (null) \u003d\u003d \u0027object\u0027."},{"file":"lib/common.js","line":629,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like this is also reinitialised in the for loop at L631."},{"file":"lib/common.js","line":629,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks.  I\u0027ll remove that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":19,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"lib/adm.js","type":"MODIFIED","insertions":104,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2029,"sizeDeletions":-160},{"number":"4","revision":"53ed5ae84482bf6983dc9b95428b9a26cd997ffe","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/4","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1480695333,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/adm.js","line":722,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like \"svclayout\" was removed from these initialisations, but is actually still referred to in the code later on (L724)."},{"file":"lib/adm.js","line":722,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I hoisted the declaration to line 695 because \"svclayout\" is now used in the callback at line 814."},{"file":"lib/layout.js","line":988,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like we\u0027ll only print warnings if there are no errors. \n\nI think this is OK (and is what we to today), and I\u0027m not sure there are scenarios where there could be warnings if there are actual errors, but just wanted to make sure this was intended."},{"file":"lib/layout.js","line":988,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The main difference is that errors prevent the layout from being generated at all, while warnings indicate potential problems with a generated layout.  I\u0027m not sure it would ever make sense to have both present, though I wouldn\u0027t assert it in case we ended up adding a warning check early on.  In that case, I think printing only the errors would make sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":19,"deletions":-4},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"lib/adm.js","type":"MODIFIED","insertions":104,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2028,"sizeDeletions":-160},{"number":"5","revision":"ba004d931a3481d2d91cf8285ccdf2ac6aa646c4","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/5","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1480956899,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480957009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480968562,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480968562,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"lib/adm.js","type":"MODIFIED","insertions":104,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2030,"sizeDeletions":-162},{"number":"6","revision":"c3a74d5742528a00460cd90853f05d041e9015ef","parents":["8e07e20846642c577cbce88a6778c8bb65496b14"],"ref":"refs/changes/45/1045/6","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1481131547,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1481131677,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480957009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480968562,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480968562,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"cmd/manta-adm.js","type":"MODIFIED","insertions":21,"deletions":-6},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"lib/adm.js","type":"MODIFIED","insertions":104,"deletions":-19},{"file":"lib/common.js","type":"MODIFIED","insertions":42,"deletions":0},{"file":"lib/layout.js","type":"MODIFIED","insertions":309,"deletions":-91},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":29,"deletions":-16},{"file":"test/tst.layout.js","type":"MODIFIED","insertions":116,"deletions":-10},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":1300,"deletions":-4},{"file":"test/tst.stripe.js","type":"ADDED","insertions":80,"deletions":0}],"sizeInsertions":2030,"sizeDeletions":-162}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}