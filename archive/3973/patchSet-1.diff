From efbae3505b2a8817e8291468247c5b1f20823a5f Mon Sep 17 00:00:00 2001
From: Mike Zeller <mike.zeller@joyent.com>
Date: Fri, 18 May 2018 08:10:34 -0700
Subject: [PATCH] TRITON-394 cleanupNics can be skipped if the workflow fails
 early enough

---
 lib/workflows/job-common.js | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/lib/workflows/job-common.js b/lib/workflows/job-common.js
index 8ae4dea..c07aefa 100644
--- a/lib/workflows/job-common.js
+++ b/lib/workflows/job-common.js
@@ -970,7 +970,14 @@ function cleanupNics(job, cb) {
     var macs = job.params.macs;
 
     if (!macs) {
-            var nics = job.params['add_nics'] || job.params['nics'];
+            /*
+             * filteredNetworks.nics will contain any pre provisioned NICs. If
+             * the workflow fails early enough the other job.params fields will
+             * not yet have been populated yet, but we still have some NICs that
+             * need to be removed.
+             */
+            var nics = job.params['add_nics'] || job.params['nics'] ||
+                job.params.filteredNetworks.nics;
 
             if (!nics) {
                 return cb(null, 'No MACs given, and no NICs were provisioned');
-- 
2.21.0

