From 506dc39e5077589493b043e8ef0cc2d1fea2e3de Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 5 Nov 2019 14:57:44 +0000
Subject: [PATCH] OS-8022 add os-tests to the tests-archive tarball

---
 manifest                                            |  2 --
 .../os-tests/tests/secflags/secflags_elfdump.sh     | 13 ++++++++++++-
 usr/src/test/smartos-test/smartos-test.sh           |  4 ++++
 .../tests/awk/bugs-fixed/system-status.awk          |  2 +-
 .../tests/awk/bugs-fixed/system-status.ok           |  2 +-
 5 files changed, 18 insertions(+), 5 deletions(-)

diff --git a/manifest b/manifest
index 39e3c26ec4..bd07e59fd1 100644
--- a/manifest
+++ b/manifest
@@ -5342,7 +5342,6 @@ f usr/lib/amd64/libsoftcrypto.so.1 0755 root bin
 s usr/lib/amd64/libsoftcrypto.so=libsoftcrypto.so.1
 f usr/lib/amd64/libsrpt.so.1 0755 root bin
 s usr/lib/amd64/libsrpt.so=libsrpt.so.1
-f usr/lib/amd64/libstanddisasm.so 0644 root bin
 f usr/lib/amd64/libstmf.so.1 0755 root bin
 s usr/lib/amd64/libstmf.so=libstmf.so.1
 f usr/lib/amd64/libstmfproxy.so.1 0755 root bin
@@ -6856,7 +6855,6 @@ f usr/lib/libsoftcrypto.so.1 0755 root bin
 s usr/lib/libsoftcrypto.so=libsoftcrypto.so.1
 f usr/lib/libsrpt.so.1 0755 root bin
 s usr/lib/libsrpt.so=libsrpt.so.1
-f usr/lib/libstanddisasm.so 0644 root bin
 f usr/lib/libstmf.so.1 0755 root bin
 s usr/lib/libstmf.so=libstmf.so.1
 f usr/lib/libstmfproxy.so.1 0755 root bin
diff --git a/usr/src/test/os-tests/tests/secflags/secflags_elfdump.sh b/usr/src/test/os-tests/tests/secflags/secflags_elfdump.sh
index 334ebc16a9..64233ab317 100644
--- a/usr/src/test/os-tests/tests/secflags/secflags_elfdump.sh
+++ b/usr/src/test/os-tests/tests/secflags/secflags_elfdump.sh
@@ -21,12 +21,21 @@ cd /tmp/secflags-test.$$
 
 /usr/bin/psecflags -s aslr -e sleep 100000 &
 pid=$!
-coreadm -p core $pid # We need to be able to reliably find the core
+# Make sure we generate a kernel core we can find
+coreadm -p core $pid
+enabled=$(/usr/bin/svcprop -p config_params/process_enabled coreadm)
+coreadm_restore=""
+if [[ "$enabled" = "false" ]]; then
+    coreadm_restore="/usr/bin/coreadm -d process"
+    coreadm -e process
+fi
 
 cleanup() {
     kill $pid >/dev/null 2>&1
     cd /
     rm -fr /tmp/secflags-test.$$
+
+    $coreadm_restore
 }
 
 trap cleanup EXIT
@@ -54,12 +63,14 @@ EOF
 /usr/bin/elfdump -n core.${pid} | grep -B5 -A5 prsecflags_t > gcore-output.$$
 
 if ! diff -u gcore-expected.$$ gcore-output.$$; then
+    $coreadm_restore
     exit 1;
 fi
 
 ## kernel-produced core
 kill -SEGV $pid
 wait $pid >/dev/null 2>&1
+$coreadm_restore
 
 cat > core-expected.$$ <<EOF
     namesz: 0x5
diff --git a/usr/src/test/smartos-test/smartos-test.sh b/usr/src/test/smartos-test/smartos-test.sh
index 7cc32db76d..d3bc4d1840 100755
--- a/usr/src/test/smartos-test/smartos-test.sh
+++ b/usr/src/test/smartos-test/smartos-test.sh
@@ -264,6 +264,9 @@ function add_test_accounts {
 # By using log_test or log_testrunner, we accumulate the exit codes from each
 # test run to $RESULT.
 #
+# We don't - yet - run net-tests, smbclient-tests, zfs-tests, or the dtrace
+# suite.
+#
 function execute_tests {
 
     log "Starting test runs"
@@ -273,6 +276,7 @@ function execute_tests {
     log_testrunner libc-tests /opt/libc-tests/runfiles/default.run
     log_test vndtest /opt/vndtest/bin/vndtest -a
     log_testrunner util-tests /opt/util-tests/runfiles/default.run
+    log_testrunner os-tests /opt/os-tests/runfiles/default.run
 
     if [[ -n "$FAILED_TESTS" ]]; then
         echo ""
diff --git a/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.awk b/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.awk
index 25b92c0492..8c84ff6cfe 100644
--- a/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.awk
+++ b/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.awk
@@ -9,7 +9,7 @@ BEGIN {
 	status = system("exit 42")
 	print "normal status", status
 
-	status = system("kill -HUP $$")
+	status = system("kill -KILL $$")
 	print "death by signal status", status
 
 	status = system("cd $WORKDIR && kill -ABRT $$")
diff --git a/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.ok b/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.ok
index 737828f5ed..afc0788ce8 100644
--- a/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.ok
+++ b/usr/src/test/util-tests/tests/awk/bugs-fixed/system-status.ok
@@ -1,3 +1,3 @@
 normal status 42
-death by signal status 257
+death by signal status 265
 death by signal with core dump status 518
-- 
2.17.2 (Apple Git-113)

