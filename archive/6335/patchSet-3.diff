From 94b3de0b54053893ff1bd157de737cf9b113ddda Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Thu, 16 May 2019 17:45:35 -0500
Subject: [PATCH] =?UTF-8?q?TRITON-1676=20linux-prepare-image=20should=20re?=
 =?UTF-8?q?move=20fstab=20entries=20added=20by=20cloud-init=20Reviewed=20b?=
 =?UTF-8?q?y:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>=20Appro?=
 =?UTF-8?q?ved=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 tools/prepare-image/linux-prepare-image | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/tools/prepare-image/linux-prepare-image b/tools/prepare-image/linux-prepare-image
index 6d1e91a..4c5da8a 100755
--- a/tools/prepare-image/linux-prepare-image
+++ b/tools/prepare-image/linux-prepare-image
@@ -103,8 +103,9 @@ function cleanup_ssh() {
 }
 
 function cleanup_disks() {
-    echo "removing /dev/vdb entries from fstab"
-    sed -i '/^\/dev\/vdb/d' /etc/fstab
+    echo "removing /dev/vdb and cloud-init entries from fstab"
+    sed -i -e '/^\/dev\/vdb/d' -e '/[\t|,]comment=cloudconfig[,|\t]/d' \
+        /etc/fstab
 }
 
 function cleanup_metadata() {
-- 
2.21.0

