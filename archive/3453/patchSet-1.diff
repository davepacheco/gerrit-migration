From 5919314079f1768d2a57fd3c14efd04560b9ef40 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Thu, 22 Feb 2018 17:07:45 -0800
Subject: [PATCH] TOOLS-1983 How to avoid hard failure of most builds on Feb 22
 from GitHub weak crypto removal (config-agent)

---
 CHANGES.md   |  4 ++++
 Makefile     | 11 +++++++----
 package.json |  2 +-
 3 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 080328c..fcb1699 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,9 @@
 # sdc-config-agent changelog
 
+## 1.6.2
+
+- [TOOLS-1983] Use an sdcnode built for the GZ, and bump to latest node v0.10.
+
 ## 1.6.1
 
 - [TRITON-138] Avoid setInterval in polling in case the process (e.g. calling
diff --git a/Makefile b/Makefile
index 444d76a..57211db 100644
--- a/Makefile
+++ b/Makefile
@@ -22,10 +22,12 @@ JSSTYLE_FILES	 = $(JS_FILES)
 JSSTYLE_FLAGS    = -t 4 -o doxygen
 SMF_MANIFESTS_IN = smf/manifests/config-agent.xml.in
 
-NODE_PREBUILT_VERSION=v0.10.26
+NODE_PREBUILT_VERSION=v0.10.48
 ifeq ($(shell uname -s),SunOS)
-	NODE_PREBUILT_TAG=zone
-	# Allow building on a SmartOS image other than sdc-smartos/1.6.3.
+	NODE_PREBUILT_TAG=gz
+	# For now use an sdcnode built for smartos@1.6.3, even though this
+	# component builds on multiarch@15.4.1. See TRITON-177 to update when
+	# an appropriate sdcnode build is available.
 	NODE_PREBUILT_IMAGE=fd2cc906-8938-11e3-beab-4359c665ac99
 endif
 
@@ -36,6 +38,7 @@ ifeq ($(shell uname -s),SunOS)
 else
 	NPM_EXEC :=
 	NPM = npm
+	NODE = node
 endif
 include ./tools/mk/Makefile.smf.defs
 
@@ -45,7 +48,7 @@ include ./tools/mk/Makefile.smf.defs
 #
 .PHONY: all
 all: $(SMF_MANIFESTS) | $(NPM_EXEC)
-	$(NPM) install && ./node_modules/.bin/kthxbai
+	$(NPM) install && $(NODE) ./node_modules/.bin/kthxbai
 
 DISTCLEAN_FILES+=node_modules
 
diff --git a/package.json b/package.json
index c9856d2..3a45773 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "config-agent",
     "description": "SmartDataCenter Config Agent",
-    "version": "1.6.1",
+    "version": "1.6.2",
     "author": "Joyent (joyent.com)",
     "dependencies": {
         "assert-plus": "0.1.5",
-- 
2.21.0

