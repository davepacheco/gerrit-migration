{"project":"joyent/illumos-joyent","branch":"master","id":"I3e5be4743983eda926f06e02f22dcbf40e17b338","number":"2234","subject":"OS-6239 Simplify SMAP relocations with krtld","owner":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"url":"https://cr.joyent.us/2234","commitMessage":"OS-6239 Simplify SMAP relocations with krtld\n","createdOn":1500489332,"lastUpdated":1507049615,"open":false,"status":"MERGED","comments":[{"timestamp":1500489332,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 1."},{"timestamp":1500503537,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(3 comments)\n\nOverall this looks good to me. There are some remaining TODOs to cleanup and some cstyle issues to fix, along with a few small things I noticed."},{"timestamp":1500506490,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1500506508,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1500509529,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(23 comments)"},{"timestamp":1500918834,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 2."},{"timestamp":1500929789,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 2:\n\n(7 comments)"},{"timestamp":1501022231,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1501536930,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1501820011,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(12 comments)"},{"timestamp":1502138490,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 4."},{"timestamp":1502282180,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(2 comments)\n\nThis looks good, I just a couple of small things I noticed. I\u0027m sorry I didn\u0027t catch the structure naming in the prevous rounds."},{"timestamp":1502301938,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 5."},{"timestamp":1502303749,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1502304176,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1502994234,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 7."},{"timestamp":1502994657,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 8."},{"timestamp":1503423941,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 9."},{"timestamp":1503426689,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9:\n\n(5 comments)"},{"timestamp":1503441438,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 10."},{"timestamp":1503493345,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 10:\n\n(2 comments)\n\nThis is looking good, I just noticed a couple small nits left."},{"timestamp":1503509149,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 11."},{"timestamp":1503515198,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 11:\n\n(1 comment)\n\nA little style nit on your last change"},{"timestamp":1503518351,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 11:\n\n(4 comments)"},{"timestamp":1503523709,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 12."},{"timestamp":1503524563,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1503548958,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 12:\n\n(3 comments)\n\nThis looks pretty good.  I\u0027ve included a few comment nits, but the code looks to be in good shape.  Thanks for working through the various design iterations."},{"timestamp":1503682711,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 13."},{"timestamp":1503684668,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1504200796,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1505257576,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 14."},{"timestamp":1505258058,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 14:\n\n(2 comments)"},{"timestamp":1505259723,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 14:\n\n(8 comments)"},{"timestamp":1505324478,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 15."},{"timestamp":1505324813,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 15:\n\nThis patch set fixes 32-bit builds by adding the same code from amd64/krtld/kobj_reloc.c to ia32/krtld/kobj_reloc.c -- though no ia32 machine will ever support SMAP this code is kept the same so it only needs to be debugged once. This is noted in a comment in the file. I\u0027m not sure if this is a nicer solution, or I should \"gut\" the hot inline creation in the ia32 version of smap_reloc_resolve(). Plesae advise."},{"timestamp":1505326038,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 16."},{"timestamp":1505326503,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 17."},{"timestamp":1505326622,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 17:\n\nDecided to gut the ia32 code so it doesn\u0027t create unneeded hot inlines. Also changed the comment to match. Sorry about the extra updates -- got too push happy."},{"timestamp":1505328574,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 17:\n\n(2 comments)"},{"timestamp":1505341782,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Uploaded patch set 18."},{"timestamp":1505406198,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 18: Code-Review+1"},{"timestamp":1505412476,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 18: Code-Review+1"},{"timestamp":1506009959,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 18: Integration-Approval+1"},{"timestamp":1506992026,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Patch Set 19: Patch Set 18 was rebased"},{"timestamp":1507049615,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Sam Gwydir"}],"currentPatchSet":{"number":"19","revision":"f408efb3f96c6de895719901f007f0bc2c6d795d","parents":["914d7a738527f83b1e811b066563842839f125a7"],"ref":"refs/changes/34/2234/19","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1506992026,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505406198,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505412476,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506009959,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1507049615,"by":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":59,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":42,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":213,"sizeDeletions":-52},"patchSets":[{"number":"1","revision":"ca6f568bc76d721f1ed8a29f2fafb48378794f6e","parents":["3d1b59cfb9c0cf275f1c02d27ca946a66e870afb"],"ref":"refs/changes/34/2234/1","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1500489332,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/krtld/kobj.c","line":3037,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fix comment formatting (including removal of trailing spaces)"},{"file":"usr/src/uts/common/krtld/kobj.c","line":3037,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/common/krtld/kobj.c","line":3041,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe place under an __x86 guard?"},{"file":"usr/src/uts/common/krtld/kobj.c","line":3041,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/common/krtld/kobj.c","line":4702,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"is this comment correct?"},{"file":"usr/src/uts/common/krtld/kobj.c","line":4702,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Edited to reflect the assumption that the call will be a callq."},{"file":"usr/src/uts/common/krtld/kobj.c","line":4707,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Another case of x86 specific code which should probably be moved into the arch-specific section of this module, rather than being compiled in the common portion."},{"file":"usr/src/uts/common/krtld/kobj.c","line":4707,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/common/os/modctl.c","line":79,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Including arch-specific headers in uts/common files is a code-smell to me.  I would suggest perhaps abstracting the SMAP-related stuff below into some sort of arch-specific hotpatch function (which can be empty on SPARC)"},{"file":"usr/src/uts/common/os/modctl.c","line":79,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/common/os/modctl.c","line":3486,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Per comment above, maybe move this into a file compiled under uts/intel or uts/i86pc?  At the very least, an arch-constraining ifdef guard would be prudent."},{"file":"usr/src/uts/common/os/modctl.c","line":3486,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Added a arch specific implementation for each arch -- empty on SPARC. All arches could want to use kobj_reloc_hotline -- this particular replacement is specific to amd64 right now."},{"file":"usr/src/uts/common/sys/kobj.h","line":42,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"They most certainly don\u0027t."},{"file":"usr/src/uts/common/sys/kobj.h","line":45,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It looks like these are already defined in archsystm.h. Can you provisionally include that header? Or should we move both definitions someplace else?"},{"file":"usr/src/uts/common/sys/sdt.h","line":438,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"is this specific to smap? if so, maybe the structure should have a better name"},{"file":"usr/src/uts/common/sys/sdt.h","line":438,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"The idea was that this could be used for something other than smap. I\u0027m currently renaming it to something along the lines of a \"hot inline\"."},{"file":"usr/src/uts/common/sys/sdt.h","line":438,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would be inclined to omit the specific reference to SMAP here"},{"file":"usr/src/uts/i86pc/Makefile.rules","line":332,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Seems as good a place as any?"},{"file":"usr/src/uts/i86pc/Makefile.rules","line":336,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is it worth considering to fold this into the above statement with egrep -e?  I don\u0027t know if there\u0027s any risk with the two-step process for emitting the target in dmake"},{"file":"usr/src/uts/i86pc/os/startup.c","line":728,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Can this not be folded into the krtld stuff?  (Or are you perhaps waiting to do that in a follow-up change?)"},{"file":"usr/src/uts/i86pc/os/startup.c","line":728,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"I will probably do this in a follow up change."},{"file":"usr/src/uts/i86pc/os/startup.c","line":730,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fix comment style"},{"file":"usr/src/uts/i86pc/os/startup.c","line":732,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Move variable definition to top of scope"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":122,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fix comment style.  Maybe note that we\u0027re relying on the compiler to emit E8 call instructions.  (I\u0027m not sure there\u0027s a situation where the far-call instructions would be forced)"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":127,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Make this a uint_t"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":135,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nuke trailing space"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":136,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Conform to illumos continuation style"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":140,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Nuke trailing space"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":142,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"More continuation style"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":147,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"maybe cache this"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":154,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"would memset(instr-1, NOP_INSTR, SMAP_NOPS) be clearer ? (the bcopy call with something that looks non-constant confused me)."},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":154,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Nuke the trailing space if you\u0027re keeping the for-loop"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":154,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"That or perhaps have a statically defined array pre-filled with the nop values so you can do it in one easy bcopy."},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":268,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"extrace space in continuation?"},{"file":"usr/src/uts/intel/sys/archsystm.h","line":188,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Update since they are now \u0027stac, nop\u0027 and \u0027clac, nop\u0027"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":39,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":11,"deletions":-4},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/sys/sdt.h","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":46,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":0,"deletions":-31},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":124,"sizeDeletions":-39},{"number":"2","revision":"4660dc8331c1934550fe68844fd808f8fa1861b6","parents":["2bcd0c2213ad2567e05837f2b5406447e005a44b"],"ref":"refs/changes/34/2234/2","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1500918834,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/krtld/kobj.c","line":3040,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Please capitalize and punctuate"},{"file":"usr/src/uts/common/krtld/kobj.c","line":3044,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would nuke this empty line if the two bits of name comparison are going to share the above comment."},{"file":"usr/src/uts/common/os/modctl.c","line":3495,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This whole piece of logic seems suspect.  The point of dtrace_modload() is to allow provider in dtrace to act upon the module _being loaded_.  It\u0027s true that the dtrace module itself does require the SMAP-related hot-inlines be performed, doing so during the loading of a different module (repeatedly) is very strange.\n\nIt should probably be performed on _every_ module load, including dtrace."},{"file":"usr/src/uts/common/sys/hotinline.h","line":32,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason why this shouldn\u0027t reside in kobj.h?"},{"file":"usr/src/uts/common/sys/sdt.h","line":24,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why the copyright update?"},{"file":"usr/src/uts/common/sys/sdt.h","line":24,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":128,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"s/calq/call/"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":128,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":141,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would suggest the name reflect the fact that this is SMAP-specific"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":150,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Probably unnecessary given how quickly the below comparisons will bail out on all things not-smap_*"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":150,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":171,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps include this offset to target the call opcode in the instr_offset as well, so it need not be calculated later too?"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":409,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Duplicate of above definition"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":409,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":444,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is the trailing NOP necessary, considering the callsite has already been NOPed out by hi_reloc_resolve?"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":444,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","line":27,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why the new Oracle copyright?"},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","line":27,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/sys/hotinline.h","type":"ADDED","insertions":34,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/sdt.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":102,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","type":"MODIFIED","insertions":16,"deletions":0}],"sizeInsertions":219,"sizeDeletions":-54},{"number":"3","revision":"7c1d22dc2f9787c210a33edff23be97c417dde22","parents":["b4a0b694af35d6c41597f45d411541f6f010f650"],"ref":"refs/changes/34/2234/3","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1501022231,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"usr/src/uts/common/os/modctl.c","line":3478,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This comment seems confusing. It sounds redundant so maybe it would be clearer to more explicitly say we\u0027re smap hotinlining on the dtrace module for amd64?"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":167,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"You\u0027re always using \"instr -1\" below and later with instr_offset, so maybe just subtract 1 from instr before you save it?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/sys/hotinline.h","type":"ADDED","insertions":34,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/sdt.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":102,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","type":"MODIFIED","insertions":16,"deletions":0}],"sizeInsertions":219,"sizeDeletions":-54},{"number":"4","revision":"03bf6ee662b72e2a60c7dbbf0f219fbc352a3474","parents":["2bcd0c2213ad2567e05837f2b5406447e005a44b"],"ref":"refs/changes/34/2234/4","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1502138490,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/sys/kobj.h","line":57,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027m sorry I didn\u0027t point this out in my previous reviews, but as a general rule we like to use a common prefix (based on the structure name) on structure members so that they are easier to find when searching then entire code base. So, for example, instead of \"symname\" we would use some like \"hid_symname\", etc."},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","line":49,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Didn\u0027t you drop this header for your work?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":16,"deletions":-4},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":85,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","type":"MODIFIED","insertions":15,"deletions":0}],"sizeInsertions":170,"sizeDeletions":-54},{"number":"5","revision":"616c1e950aea6cc13dd24bf516c8be09375d2391","parents":["2bcd0c2213ad2567e05837f2b5406447e005a44b"],"ref":"refs/changes/34/2234/5","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1502301938,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502303749,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":78,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","type":"MODIFIED","insertions":14,"deletions":0}],"sizeInsertions":157,"sizeDeletions":-50},{"number":"6","revision":"964e48297c81b5633b0830c211e9625e3760a075","parents":["319d158a6ae546c76d12a8fb83951c34d0ebd06a"],"ref":"refs/changes/34/2234/6","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1502304176,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502303749,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":78,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":10,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","type":"MODIFIED","insertions":14,"deletions":0}],"sizeInsertions":157,"sizeDeletions":-50},{"number":"7","revision":"25f58fac5a62661f962c15f783623d91e8eba541","parents":["319d158a6ae546c76d12a8fb83951c34d0ebd06a"],"ref":"refs/changes/34/2234/7","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1502994234,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":26,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":66,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/sparc/krtld/kobj_reloc.c","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":134,"sizeDeletions":-50},{"number":"8","revision":"fc583fa9b9b695048e461cf56943b65850f35313","parents":["319d158a6ae546c76d12a8fb83951c34d0ebd06a"],"ref":"refs/changes/34/2234/8","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1502994657,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":26,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":65,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":0,"deletions":-41},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":129,"sizeDeletions":-49},{"number":"9","revision":"fb82bf712a3c1d0a86ed221b8eb9e8a918d67ea1","parents":["fc1b3c825992bc27440652673e53f8552575f46a"],"ref":"refs/changes/34/2234/9","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1503423941,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/modctl.c","line":3475,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This probably needs an x86 ifdef guard and an empty implementation in i86xpv."},{"file":"usr/src/uts/common/sys/kobj.h","line":111,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I haven\u0027t looked deeply into the module/modctl system, but I assume there\u0027s a step during module unload where structs of this type are freed.  In that case, we would want to make sure that hi_calls is appropriately freed as well so we don\u0027t leak kmem memory for every load/unload cycle."},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1475,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps ASSERT() that our runtime kernel data model is amd64?"},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","line":161,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"A comment about why the \u0027-1\u0027 offset is necessary would be nice for the random passerby."},{"file":"usr/src/uts/intel/sys/archsystm.h","line":195,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps include a comment to noting that smap_disable/smap_enable will be hot-inlined, rather than resolved as a symbol when linked at runtime."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":56,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":144,"sizeDeletions":-50},{"number":"10","revision":"5d088740b4d1253ccac2261387761b501ecb50e7","parents":["fc1b3c825992bc27440652673e53f8552575f46a"],"ref":"refs/changes/34/2234/10","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1503441438,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/os/machdep.c","line":1476,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"illumos"},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1484,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Because you have two sides to this \u0027if\u0027 statement, for cstyle conformance you should use curly braces to bracket each side."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":43,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":60,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":174,"sizeDeletions":-52},{"number":"11","revision":"d4931ab0dd87152f9566adf4833d2e6e704484e0","parents":["fc1b3c825992bc27440652673e53f8552575f46a"],"ref":"refs/changes/34/2234/11","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1503509149,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/modctl.c","line":3560,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe consider moving this logic into free_module_data in kobj.c?  That seems to be the function tasked with most of the duties when it comes to freeing a \u0027struct module\u0027"},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1485,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sorry to keep nitpicking on the cstyle here, but you had the indentation correct before. When I line is too long to fit in 80 chars, we break the line, tab in the continuation to the same depth, then indent by 4 spaces."},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1485,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"FYI: \u0027git pbchk\u0027 should catch many things like this."},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1497,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason not to skip the whole loop on __xpv?"},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1497,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"There\u0027s no reason __xpv cannot use hotinlines, they just don\u0027t make use of SMAP."},{"file":"usr/src/uts/intel/sys/archsystm.h","line":191,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"To match the other path references, this should include \u0027uts/\u0027 (or the \u0027uts/\u0027 should be removed from the others)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":44,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":60,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":175,"sizeDeletions":-52},{"number":"12","revision":"465ec49aedac3aef4fee26e809de15e971b96363","parents":["6ce43f2a6fa2b7afc12a8d8d72313305ff468356"],"ref":"refs/changes/34/2234/12","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1503523709,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503524563,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/krtld/kobj.c","line":29,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Minor nit: Merge these two comment sections together."},{"file":"usr/src/uts/i86pc/os/machdep.c","line":1476,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Minor: maybe include a little comment about how we never expect to hit this since the SMAP feature detection is behind an amd64 guard"},{"file":"usr/src/uts/i86pc/os/startup.c","line":732,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Minor: This is about the only place you refer to them as \"Hot Inlines\" vs \"hotinlines\". Maybe drop the caps and potentially the space?  Up to you, but consistency would be preferred."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":23,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":44,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":60,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":170,"sizeDeletions":-52},{"number":"13","revision":"be0444dc70d77a6e0cb91cfd4dc2578ac09cccea","parents":["6ce43f2a6fa2b7afc12a8d8d72313305ff468356"],"ref":"refs/changes/34/2234/13","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1503682711,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503684668,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504200796,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":60,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":172,"sizeDeletions":-52},{"number":"14","revision":"f3b9a30b082174af1d2478927e6dfcfac9461e27","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/34/2234/14","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1505257576,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/Makefile.rules","line":25,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"why was the Joyent copyright removed?"},{"file":"usr/src/uts/i86pc/Makefile.rules","line":25,"reviewer":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"message":"In this version, I reverted all of my changes to the two files that you commented on. The next version is not done this way -- so these changes will be back."},{"file":"usr/src/uts/intel/ia32/ml/copy.s","line":39,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Why did you reset the copyright date?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":60,"deletions":0},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":168,"sizeDeletions":-9},{"number":"15","revision":"30dd4388b568325571babe98eac13be87bac9642","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/34/2234/15","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1505324478,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":60,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":62,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":0,"deletions":-41},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":232,"sizeDeletions":-51},{"number":"16","revision":"4a78fbb415f3f2e5434547179e6e8c2b00ae2ebb","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/34/2234/16","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1505326038,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":59,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":49,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":0,"deletions":-41},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":218,"sizeDeletions":-51},{"number":"17","revision":"0cedd81e31136a366ac226e6107aab2c6164d63d","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/34/2234/17","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1505326503,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/krtld/kobj.c","line":3056,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Please include the \u0027defined()\u0027 in these to match the #if statement.  This could probably be turned into a check for \u0027defined(__x86)\u0027 btw."},{"file":"usr/src/uts/i86pc/Makefile.rules","line":25,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Your Makefile changes have crept back in.  Was that intended?  If so, the copyright update should be re-inserted as well."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":59,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":42,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":0,"deletions":-41},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":211,"sizeDeletions":-51},{"number":"18","revision":"3e5be4743983eda926f06e02f22dcbf40e17b338","parents":["7bfe322ee94b337d8bc759f81b83d026f599b267"],"ref":"refs/changes/34/2234/18","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1505341782,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506009959,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505412476,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505406198,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":59,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":42,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":213,"sizeDeletions":-52},{"number":"19","revision":"f408efb3f96c6de895719901f007f0bc2c6d795d","parents":["914d7a738527f83b1e811b066563842839f125a7"],"ref":"refs/changes/34/2234/19","uploader":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"createdOn":1506992026,"author":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1506009959,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505412476,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505406198,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1507049615,"by":{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/krtld/kobj.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/os/modctl.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/common/sys/kobj.h","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.rules","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/i86pc/os/machdep.c","type":"MODIFIED","insertions":48,"deletions":0},{"file":"usr/src/uts/i86pc/os/startup.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/intel/amd64/krtld/kobj_reloc.c","type":"MODIFIED","insertions":59,"deletions":0},{"file":"usr/src/uts/intel/ia32/krtld/kobj_reloc.c","type":"MODIFIED","insertions":42,"deletions":0},{"file":"usr/src/uts/intel/ia32/ml/copy.s","type":"MODIFIED","insertions":1,"deletions":-42},{"file":"usr/src/uts/intel/sys/archsystm.h","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":213,"sizeDeletions":-52}],"allReviewers":[{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Sam Gwydir","email":"sam.gwydir@joyent.com","username":"gwydirsam"}]}