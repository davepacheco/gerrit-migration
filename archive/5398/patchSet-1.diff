From 483fdb4ee6df4693d886d311463e2f8d4f466f05 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Mon, 21 Jan 2019 16:36:55 -0800
Subject: [PATCH] TRITON-788 sdc-amonadm breaks with sdc-clients@11.x
 requirement of a version option to SAPI client

---
 Makefile           | 14 ++++++++++++++
 README.md          | 11 ++++++-----
 main.js            |  3 ++-
 package.json       |  4 ++--
 test/probes.tst.js |  3 ++-
 test/topo.tst.js   |  3 ++-
 6 files changed, 28 insertions(+), 10 deletions(-)

diff --git a/Makefile b/Makefile
index 5d9e15e..09cece4 100644
--- a/Makefile
+++ b/Makefile
@@ -70,5 +70,19 @@ docs:
 	ronn -m docs/man/amonadm.md > $(MAN_OUTDIR)/amonadm.1
 	@echo "# test with 'man ./man/man1/amonadm.1'"
 
+# This repo doesn't publish to npm, so a 'release' is just a tag.
+.PHONY: cutarelease
+cutarelease:
+	[[ -z `git status --short` ]]  # If this fails, the working dir is dirty.
+	@which json 2>/dev/null 1>/dev/null && \
+	    ver=$(shell json -f package.json version) && \
+	    echo "** Are you sure you want to tag v$$ver?" && \
+	    echo "** Enter to continue, Ctrl+C to abort." && \
+	    read
+	ver=$(shell cat package.json | json version) && \
+	    date=$(shell date -u "+%Y-%m-%d") && \
+	    git tag -a "v$$ver" -m "version $$ver ($$date)" && \
+	    git push origin "v$$ver"
+
 include ./tools/mk/Makefile.deps
 include ./tools/mk/Makefile.targ
diff --git a/README.md b/README.md
index 43fb8e9..721745a 100644
--- a/README.md
+++ b/README.md
@@ -5,20 +5,21 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright (c) 2019, Joyent, Inc.
 -->
 
 # sdc-amonadm
 
+This repository is part of the Joyent Triton project. See the [contribution
+guidelines](https://github.com/joyent/triton/blob/master/CONTRIBUTING.md) --
+*Triton does not use GitHub PRs* -- and general documentation at the main
+[Triton project](https://github.com/joyent/triton) page.
+
 This repo contains `amonadm`, which is the administrative tool that manages
 probes and alarms for an SDC datacenter. If you are not familiar with Amon
 already, refer to its [documentation](https://github.com/joyent/sdc-amon) for a
 quick overview on it.
 
-This repository is part of the Joyent SmartDataCenter project (SDC).  For
-contribution guidelines, issues, and general documentation, visit the main
-[SDC](http://github.com/joyent/sdc) project page.
-
 There is full documentation installed with it as a manpage, so in an sdc
 deployment zone just do `man amonadm`.
 
diff --git a/main.js b/main.js
index 460bc01..e274b67 100644
--- a/main.js
+++ b/main.js
@@ -6,7 +6,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var fs = require('fs');
@@ -121,6 +121,7 @@ function read_config_file(opts, cb) {
 
         opts.config.amon.log = opts.log.child({component: 'amon'}, true);
         opts.config.sapi.log = opts.log.child({component: 'sapi'}, true);
+        opts.config.sapi.version = '~2';
         opts.config.vmapi.log = opts.log.child({component: 'vmapi'}, true);
 
         cb();
diff --git a/package.json b/package.json
index ffb00af..aaa8df6 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "amonadm",
     "description": "Amon configuration for SAPI applications",
-    "version": "1.0.0",
+    "version": "1.0.1",
     "author": "Joyent (joyent.com)",
     "private": true,
     "dependencies": {
@@ -14,7 +14,7 @@
         "lru-cache": "2.3.0",
         "once": "1.1.1",
         "restify": "2.6.0",
-        "sdc-clients": "~9.1",
+        "sdc-clients": "12.1.1",
         "vasync": "1.3.3",
         "hogan.js": "2.0.0"
     },
diff --git a/test/probes.tst.js b/test/probes.tst.js
index 453dfc4..a60e4c4 100644
--- a/test/probes.tst.js
+++ b/test/probes.tst.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var bunyan = require('bunyan');
@@ -42,6 +42,7 @@ test('setup', function (t) {
     var cfg = JSON.parse(fs.readFileSync(f, 'utf8'));
     cfg.amon.log = LOG;
     cfg.sapi.log = LOG;
+    cfg.sapi.version = '~2';
     cfg.vmapi.log = LOG;
 
     AMON = new sdc.Amon(cfg.amon);
diff --git a/test/topo.tst.js b/test/topo.tst.js
index c5f28ce..3cc1704 100644
--- a/test/topo.tst.js
+++ b/test/topo.tst.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var bunyan = require('bunyan');
@@ -39,6 +39,7 @@ test('setup', function (t) {
         path.resolve(__dirname, '../etc/config.json');
     cfg = JSON.parse(fs.readFileSync(f, 'utf8'));
     cfg.sapi.log = LOG;
+    cfg.sapi.version = '~2';
     cfg.vmapi.log = LOG;
 
     SAPI = new sdc.SAPI(cfg.sapi);
-- 
2.21.0

