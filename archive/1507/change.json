{"project":"joyent/illumos-joyent","branch":"master","id":"I32a07cd9736cfe9dfd28b66798ea439199da43c2","number":"1507","subject":"OS-5892 drv_ioc_prop_common could leak memory and holds Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/1507","commitMessage":"OS-5892 drv_ioc_prop_common could leak memory and holds\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1487122465,"lastUpdated":1487207068,"open":false,"status":"MERGED","comments":[{"timestamp":1487122465,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1487123203,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\nTo test this I wrote a program to send a DLDIOC_GETMACPROP ioctl for\nthe autopush property with a pr_valsize of 0. This induced the bad\ncode path and I was able to verify both the memory leak and the MAC\nhold leak.\n\nBelow is the findleaks report when I ran the test with kmem_flags set.\n\n \u003e ::findleaks\n CACHE             LEAKED           BUFCTL CALLER\n ffffff0185e2a008       1 ffffff01db9f82a8 drv_ioc_prop_common+0xb3\n ------------------------------------------------------------------------\n            Total       1 buffer, 320 bytes\n\nBelow is mdb -k output showing that one thread is blocked trying to\nenter the mac perim while the owner is a thread which has exited.\n\n \u003e 0t17948::pid2proc | ::walk thread | ::stacks\n THREAD           STATE    SOBJ                COUNT\n ffffff019e54e080 SLEEP    CV                      1\n                  swtch+0x141\n                  cv_wait+0x70\n                  i_mac_perim_enter+0x63\n                  mac_perim_enter_by_mh+0x23\n                  mac_perim_enter_by_macname+0x33\n                  drv_ioc_prop_common+0x193\n                  drv_ioc_getprop+0x26\n                  drv_ioctl+0x1e4\n                  cdev_ioctl+0x39\n                  spec_ioctl+0x60\n                  fop_ioctl+0x55\n                  ioctl+0x9b\n\n \u003e ffffff019e54e080::findstack -v\n stack pointer for thread ffffff019e54e080: ffffff000477b9e0\n [ ffffff000477b9e0 _resume_from_idle+0x112() ]\n   ffffff000477ba10 swtch+0x141()\n   ffffff000477ba50 cv_wait+0x70(ffffff01896ed7ac, ffffff01896ed798)\n   ffffff000477ba90 i_mac_perim_enter+0x63(ffffff01896ed6c0)\n   ffffff000477bac0 mac_perim_enter_by_mh+0x23(ffffff01896ed6c0, ffffff000477bb60)\n   ffffff000477bb10 mac_perim_enter_by_macname+0x33(ffffff0189ee5d1c, ffffff000477bb60)\n   ffffff000477bbe0 drv_ioc_prop_common+0x193(ffffff01990e1e40, 412950, 0, ffffff019e5d83e8, 202003)\n   ffffff000477bc20 drv_ioc_getprop+0x26(ffffff01990e1e40, 412950, 202003, ffffff019e5d83e8, ffffff000477bea8)\n   ffffff000477bcc0 drv_ioctl+0x1e4(1200000000, d1d001c, 412950, 202003, ffffff019e5d83e8, ffffff000477bea8)\n   ffffff000477bd00 cdev_ioctl+0x39(1200000000, d1d001c, 412950, 202003, ffffff019e5d83e8, ffffff000477bea8)\n   ffffff000477bd50 spec_ioctl+0x60(ffffff0189235480, d1d001c, 412950, 202003, ffffff019e5d83e8, ffffff000477bea8, 0)\n   ffffff000477bde0 fop_ioctl+0x55(ffffff0189235480, d1d001c, 412950, 202003, ffffff019e5d83e8, ffffff000477bea8, 0)\n   ffffff000477bf00 ioctl+0x9b(3, d1d001c, 412950)\n   ffffff000477bf10 sys_syscall+0x1a2()\n \u003e\n \u003e ffffff01896ed6c0::print mac_impl_t mi_perim_owner | ::findstack -v\n stack pointer for thread ffffff019e4dac20 (TS_FREE): ffffff0006f90e40\n [ ffffff0006f90e40 resume_from_zombie+0x95() ]\n   ffffff0006f90e70 swtch_from_zombie+0x8a()\n   ffffff0006f90ea0 lwp_exit+0x3c2()\n   ffffff0006f90eb0 syslwp_exit+0x22()\n   ffffff0006f90f10 _sys_sysenter_post_swapgs+0x153()\n\nMy patch properly cleans up the resources when pr_valsize is 0 and\nthus doesn\u0027t have either of these symptoms."},{"timestamp":1487165384,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1"},{"timestamp":1487206971,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1487207052,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1487207068,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"3","revision":"32a07cd9736cfe9dfd28b66798ea439199da43c2","parents":["0a0eca7a43c8775a61b7d43f9d878e98de0173fe"],"ref":"refs/changes/07/1507/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1487207052,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1487207068,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/dld/dld_drv.c","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":12,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"26d9bf21284312f40187ac9e29ac2e429cc614d9","parents":["53eadd7bf4ba566c2a2132b48c49fb60fdcfaa19"],"ref":"refs/changes/07/1507/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1487122465,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/dld/dld_drv.c","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":12,"sizeDeletions":-2},{"number":"2","revision":"9164c535774b23e44f5ac9119b1de3f35b48e476","parents":["0a0eca7a43c8775a61b7d43f9d878e98de0173fe"],"ref":"refs/changes/07/1507/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1487206971,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/dld/dld_drv.c","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":12,"sizeDeletions":-2},{"number":"3","revision":"32a07cd9736cfe9dfd28b66798ea439199da43c2","parents":["0a0eca7a43c8775a61b7d43f9d878e98de0173fe"],"ref":"refs/changes/07/1507/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1487207052,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487165384,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1487207068,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/dld/dld_drv.c","type":"MODIFIED","insertions":12,"deletions":-2}],"sizeInsertions":12,"sizeDeletions":-2}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}