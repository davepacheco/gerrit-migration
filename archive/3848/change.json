{"project":"joyent/illumos-joyent","branch":"master","id":"I9e30beee2f0c127bf41868db46257124206e28d6","number":"3848","subject":"OS-5225 Want Fortville TSO support Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"url":"https://cr.joyent.us/3848","commitMessage":"OS-5225 Want Fortville TSO support\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1524186401,"lastUpdated":1527804532,"open":false,"status":"MERGED","comments":[{"timestamp":1524186401,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 1."},{"timestamp":1524691613,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1525369167,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(18 comments)\n\nThanks for all this. This seems like a good starting point for this work."},{"timestamp":1525731097,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(10 comments)"},{"timestamp":1526606144,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 3."},{"timestamp":1526606207,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 3:\n\n(28 comments)\n\nRyan, Robert - Here\u0027s a first swing at addressing your comments"},{"timestamp":1526608690,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1526942903,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 5."},{"timestamp":1526943050,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 5:\n\nFYI - patch set 5 fixes a potential double-free in i40e_tx_bind_fragment(), as the resources were already being freed by i40e_tcb_reset()"},{"timestamp":1527018639,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1527035344,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(5 comments)\n\nThanks for the clean up. I have a few minor follow ups to Ryan\u0027s notes."},{"timestamp":1527108627,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 6."},{"timestamp":1527108763,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 6:\n\n(5 comments)"},{"timestamp":1527205701,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1\n\nThanks, Rob. Great work on this."},{"timestamp":1527215883,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1527629250,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1527629427,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 8."},{"timestamp":1527630134,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 8:\n\none-line change to an error path to fix a bug where we could call freemsg on an mblk that we intend to return to the mac layer."},{"timestamp":1527630828,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1527728728,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1527790936,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1527791482,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 9: Patch Set 8 was rebased."},{"timestamp":1527791682,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1527804532,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Rob Johnston"}],"currentPatchSet":{"number":"10","revision":"9e30beee2f0c127bf41868db46257124206e28d6","parents":["d3cb756c75a7f0c43387251324eaa198e59f60a0"],"ref":"refs/changes/48/3848/10","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1527791682,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527630828,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527728728,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527790936,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1527804532,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":497,"deletions":-162}],"sizeInsertions":572,"sizeDeletions":-174},"patchSets":[{"number":"1","revision":"c26a09f7f6c88a2adb1877e8b656427be0d98cb2","parents":["7c5e4381770bd2b9a10d2fddb545c6883a87abe0"],"ref":"refs/changes/48/3848/1","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1524186401,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":34,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":436,"deletions":-115}],"sizeInsertions":487,"sizeDeletions":-124},{"number":"2","revision":"5fe1f4cb7760978cb1db880f3b5bf99c9a951fa4","parents":["a4e24f29df7daf277f3f81dde72ca89efb7f5ade"],"ref":"refs/changes/48/3848/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1524691613,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_main.c","line":1561,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Probably worth mentioning this in i40e(7D)."},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","line":1561,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":155,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Probably worth mentioning that this is less than what hardware supports, but we\u0027re limiting it based on IP, etc."},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":155,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"It was a awhile ago but I think set this to 64KB because I found conflicting docs from Intel that indicated that the max LSO was actually 64KB - for example see table 6 in:\n\nhttps://www.intel.com/content/dam/www/public/us/en/documents/release-notes/xl710-ethernet-controller-feature-matrix.pdf"},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":155,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"My reading of the X710 guide is that we do indeed have up to 256K to play with. But I think we also have other places up stack that assume 64K. I think it\u0027s fine leaving it at 64K for now."},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":155,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Realistically, we could set it to 256K and the stack would lower the value to 64K. The problem is that a single IP packet can really only be 64K (ignoring IP jumbograms for a moment). So it makes sense given the IP limitations that we end up setting it to 64K. Might be worth adding something like \u0027Hardware claims support for up to 256 KB, but we cap it based on the IP header.\u0027"},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","line":155,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Ok, I reworded the comment accordingly."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":245,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This section shouldb e updated to have a conversation about how LSO fits in and DMA binding."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":245,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":266,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t think this is true (it may never have)."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":266,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yep - removed."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":328,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably update the point here. With the tx context descriptors we may not have an mblk associated."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":328,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"I significantly reworked the \"TX Descriptors and Control Blocks\" section - so hopefully this is better covered this."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":328,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yeah, I think we should still make it clear here that the tcb may correspond to the control block and therefore not be associated with something from MAC."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":328,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Ok, I reworked this section a bit to try and make this more clear."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":863,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We\u0027re missing a ddi_dma_free_handle(\u0026tcb-\u003etcb_lso_dma_handle); here."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":863,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Good catch!  Fixed."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":1935,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027d probably add a kstat for these cases."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":1935,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":1986,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"tcb_bind_ncookies is unsigned. This should probably be unsigned and not signed."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":1986,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2082,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Assigned unsigned value (tcb_bind_ncookies) to a signed value. Probably should be unsigned."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2082,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2130,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s probably worth clarifying that we also have to account for the tx context block whose report bit isn\u0027t set and it is expected to be cleaned up with the whole packet."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2130,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Not sure what to add.  We\u0027re going to recycle everything up to the new head, regardless of the descriptor type, right?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2130,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"On another look, yeah. I think you\u0027re right."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2212,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Given that we only ever need to walk the cookies once and we have the total number of cookies, do we need to actually walk the cookies and store that in an array or can we just do this lazily when we need to use them since we\u0027ll either only use them all once or not and free it on failure. Feels like this is an unneeded allocation. I get that it keeps things simpler, but we should try to avoid allocations in the datapath if we can."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2212,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Agree.  I\u0027ve changed the code to do one large allocation."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2218,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"nit: signed vs unsigned"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2218,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2224,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Since we know the number of cookies in advance and the size, is there a reason that we\u0027re doing allocations on a per-cookie basis? If we\u0027re going to keep the allocation it seems like we should think about having it be one large allocation rather than an allocation for pointers and an allocation for each entry inside."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2224,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"See earlier comment - the per-cookie allocation logic has been removed."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2240,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe use braces around the multi-line if."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2240,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2263,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Since we know this function only deals with data descriptors, how about nixing the type var and just use the symbol below?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2263,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Good call - done!"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2267,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Strictly speaking, HW only needs EOP. We put RS so we get the report for the whole packet."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2267,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yep, I updated the comment accordingly."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2275,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"nit: It seems to me CPU_TO_LEXX is meant to satisfy the Intel core code, and that our own code can just use LE_XX. That\u0027s what I did for OS-6846, at least."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2275,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2308,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027d recommend declaring c in the context of the for loop it\u0027s used so it\u0027s a little bit easier to see the type."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2308,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2358,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Declare this local to the for loop."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2358,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2365,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"nit: If a variable is of type boolean_t we typically don\u0027t perform an explicit comparison."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2365,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2394,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"do"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2394,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2458,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Where have we checked the condition such that this would be true? It\u0027s not clear what causes this to be valid or not."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2458,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"The assert doesn\u0027t make sense here so I removed it.  Instead I modified the conditional a few lines earlier to also verify that the number of free descriptors is \u003e\u003d to the calculated number of needed descriptors.\n\nI don\u0027t know if the tx_block_thresh limit makes sense as-is anymore, as I think it will always be \u003c\u003d needed_descr in the LSO case."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2460,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"nit: Explicit comparison not needed."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2460,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2468,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"It looks like the use of tail is limited to this block. If so, we tend to declare variables in the most limited scope."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2468,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2474,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Shoul we zero everything here or are we basically assuming that it will have been pre-zeroed for us? Specifically I\u0027m thinking of the rsvd uint16_t."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2474,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"If I\u0027m understanding the code correctly, this should have already been zeroed out in i40e_tx_recycle_ring()."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2474,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Makes sense."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2496,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Looks like we could declare this variable local to the if block."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2496,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2510,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably set tcb_dma to NULL in case someone else ever adds an error path to this which would cause us to double free tcb_dma."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2510,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2582,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Don\u0027t we also have to consider the case where we have allocated DMA TCBs but not signaled the hardware? E.g. what happens if we allocate the DMA TCBs but then fail when checking i40e_tx_block_thresh?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2582,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yes - good catch!  I\u0027ve updated this code to reset and free any allocated tcbs in the tcb_dma array."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":34,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":436,"deletions":-115}],"sizeInsertions":487,"sizeDeletions":-124},{"number":"3","revision":"2f6d11b7f36b721b5daba8a2e27189f379b79562","parents":["f9b2546bbcb539268f3a40c8f3e6d32ffb2b469d"],"ref":"refs/changes/48/3848/3","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1526606144,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":273,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"s/which/with/\n\nUsing \"TX\" some places and \"tx\" in others. While we are hardly consistent with this (I used Tx/Rx for all my MAC changes) it would be nice to try to stick to one style in a file."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":273,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Fixed.  I did end up updating the comments in this file to standardize on RX/TX since it was faster to do an automated bulk update in vim rather than editting by hand."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":279,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I\u0027m sure you had some other words in mind here."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":279,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":35,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":460,"deletions":-122}],"sizeInsertions":533,"sizeDeletions":-133},{"number":"4","revision":"8f8c5b191c76d132e9cf3739da2a3a51869326b4","parents":["2df613f7b7aa3978e80f8e63f228b7ed64ea5d5a"],"ref":"refs/changes/48/3848/4","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1526608690,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":35,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":460,"deletions":-122}],"sizeInsertions":533,"sizeDeletions":-133},{"number":"5","revision":"cfc4a4a68e654f09f658f0f70fb8ed67c52f9ab6","parents":["2df613f7b7aa3978e80f8e63f228b7ed64ea5d5a"],"ref":"refs/changes/48/3848/5","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1526942903,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/man/man7d/i40e.7d","line":14,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Date should be updated in the manual page"},{"file":"usr/src/man/man7d/i40e.7d","line":14,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":35,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":450,"deletions":-122}],"sizeInsertions":523,"sizeDeletions":-133},{"number":"6","revision":"735fcccd7733c56d02c7c6e95fc94df060d0b910","parents":["799bd0686522010a51353501cca8e00c1246d723"],"ref":"refs/changes/48/3848/6","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1527108627,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527205701,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527215883,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":496,"deletions":-162}],"sizeInsertions":571,"sizeDeletions":-174},{"number":"7","revision":"37f34c2244b6cb45197eadd7588fb00a1b7d42f5","parents":["a342859e706a48afa2e2dd03a1ab5af9a3a2532c"],"ref":"refs/changes/48/3848/7","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1527629250,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527205701,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527215883,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":496,"deletions":-162}],"sizeInsertions":571,"sizeDeletions":-174},{"number":"8","revision":"1595af9116357c158c6420aff34f0b2ad251b972","parents":["a342859e706a48afa2e2dd03a1ab5af9a3a2532c"],"ref":"refs/changes/48/3848/8","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1527629427,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527728728,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527790936,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527630828,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":497,"deletions":-162}],"sizeInsertions":572,"sizeDeletions":-174},{"number":"9","revision":"88bb7c98b6a9010d29957a005e88ffac706d4c2b","parents":["d3cb756c75a7f0c43387251324eaa198e59f60a0"],"ref":"refs/changes/48/3848/9","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1527791482,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527728728,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527790936,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527630828,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":497,"deletions":-162}],"sizeInsertions":572,"sizeDeletions":-174},{"number":"10","revision":"9e30beee2f0c127bf41868db46257124206e28d6","parents":["d3cb756c75a7f0c43387251324eaa198e59f60a0"],"ref":"refs/changes/48/3848/10","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1527791682,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527728728,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527790936,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527630828,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1527804532,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/man/man7d/i40e.7d","type":"MODIFIED","insertions":18,"deletions":-2},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_main.c","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":36,"deletions":-6},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":497,"deletions":-162}],"sizeInsertions":572,"sizeDeletions":-174}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}]}