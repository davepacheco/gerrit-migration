commit d34b93da026296ff20a48acfddbef292fe90d827 (refs/changes/37/2637/2)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2017-09-22T17:31:31+02:00 (2 years, 1 month ago)
    
    CAPI-537 ufds-master tests failing in nightly-1 b/c certificate/key are provided

diff --git a/lib/ufds.js b/lib/ufds.js
index db423aa..126aa71 100644
--- a/lib/ufds.js
+++ b/lib/ufds.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -180,10 +180,6 @@ function processConfigFile(file) {
     try {
         var config = JSON.parse(fs.readFileSync(file, 'utf8'));
 
-        if (config.certificate && config.key && !config.port) {
-            config.port = 636;
-        }
-
         if (!config.port) {
             config.port = 389;
         }
diff --git a/main.js b/main.js
index 6b26bab..7d89611 100644
--- a/main.js
+++ b/main.js
@@ -5,15 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
-var assert = require('assert');
-var crypto = require('crypto');
-var fs = require('fs');
 var path = require('path');
-var cluster = require('cluster');
-var os = require('os');
 
 var Logger = require('bunyan');
 var nopt = require('nopt');
@@ -34,20 +29,16 @@ var LOG = new Logger({
 });
 
 var OPTS = {
-    'certificate': String,
     'debug': Number,
     'file': String,
-    'key': String,
     'port': Number,
     'help': Boolean,
     'single': Boolean
 };
 
 var SHORT_OPTS = {
-    'c': ['--certificate'],
     'd': ['--debug'],
     'f': ['--file'],
-    'k': ['--key'],
     'p': ['--port'],
     's': ['--single'],
     'h': ['--help']
@@ -57,7 +48,8 @@ var SHORT_OPTS = {
 // --- Helpers
 
 function usage(code, message) {
-    var _opts = '', msg;
+    var _opts = '';
+    var msg;
     Object.keys(SHORT_OPTS).forEach(function (k) {
         var longOpt = SHORT_OPTS[k][0].replace('--', ''),
             type = OPTS[longOpt].name || 'string';
@@ -105,20 +97,6 @@ function processConfig() {
 
     _config.single = (parsed.single) ? true : false;
 
-    if (parsed.certificate) {
-        _config.certificate = parsed.certificate;
-    }
-    if (parsed.key) {
-        _config.key = parsed.key;
-    }
-
-    if (_config.certificate) {
-        _config.certificate = fs.readFileSync(_config.certificate, 'utf8');
-    }
-    if (_config.key) {
-        _config.key = fs.readFileSync(_config.key, 'utf8');
-    }
-
     LOG.debug('config processed: %j', _config);
     _config.log = LOG;
     return _config;
diff --git a/sapi_manifests/ufds/template b/sapi_manifests/ufds/template
index ede90c4..0f91772 100644
--- a/sapi_manifests/ufds/template
+++ b/sapi_manifests/ufds/template
@@ -2,8 +2,6 @@
     "port": 636,
     "rootDN": "{{{ufds_ldap_root_dn}}}",
     "rootPassword": "{{{ufds_ldap_root_pw}}}",
-    "certificate": "/opt/smartdc/ufds/ssl/cert.pem",
-    "key": "/opt/smartdc/ufds/ssl/key.pem",
     "logLevel": "info",
     "use_bcrypt": false,
     "ufds_is_master": {{{ufds_is_master}}},
diff --git a/test/helper.js b/test/helper.js
index 2718a03..5b9e145 100644
--- a/test/helper.js
+++ b/test/helper.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 // Also expose a common logger for all tests.
@@ -14,22 +14,21 @@ var assert = require('assert');
 var fs = require('fs');
 var path = require('path');
 var util = require('util');
-var child_process = require('child_process');
 
 var Logger = require('bunyan');
 var ldapjs = require('ldapjs');
 var moray = require('moray');
 var restify = require('restify');
 
-///--- Globals
+// --- Globals
 var CONFIG;
 var CFG_FILE = process.env.TEST_CONFIG_FILE ||
             path.normalize(__dirname + '/../etc/config.coal.json');
 
 try {
     CONFIG = JSON.parse(fs.readFileSync(CFG_FILE, 'utf8'));
-    CONFIG.host = CONFIG.host || '10.99.99.18';
-    CONFIG.port = CONFIG.port || 636;
+    CONFIG.host = CONFIG.host || '0.0.0.0';
+    CONFIG.port = CONFIG.port || 1389;
 } catch (e) {
     console.error('Unable to parse configuration file: ' + e.message);
     process.exit(1);
@@ -45,9 +44,10 @@ var LOG = new Logger({
 
 
 function get(client, DN, callback) {
-    return client.search(DN, '(objectclass=*)', function (err, res) {
+    client.search(DN, '(objectclass=*)', function (err, res) {
         if (err) {
-            return callback(err);
+            callback(err);
+            return;
         }
 
         var obj;
@@ -57,19 +57,20 @@ function get(client, DN, callback) {
         });
 
         res.once('error', function (err2) {
-            return callback(err2);
+            callback(err2);
+            return;
         });
 
         res.once('end', function (result) {
-            return callback(null, obj);
+            callback(null, obj);
+            return;
         });
 
-        return;
     });
 }
 
 
-///--- Exports
+// --- Exports
 
 module.exports = {
     createClient: function createClient(nobind, callback) {
@@ -130,7 +131,8 @@ module.exports = {
         assert.equal(typeof (cb), 'function');
         // Don't initialize local server if remote is specified.
         if (CONFIG.host !== '127.0.0.1') {
-            return cb(null, {});
+            cb(null, {});
+            return;
         }
         var basePath = path.normalize(__dirname + '/../');
         var ufds = require(basePath + '/lib/ufds');
@@ -145,7 +147,6 @@ module.exports = {
         var server = ufds.createServer(config);
         server.init(function () {
             cb(null, server);
-            return true;
         });
     },
 
@@ -153,7 +154,8 @@ module.exports = {
         assert.equal(typeof (cb), 'function');
         // No cleanup needed for remote server
         if (CONFIG.host !== '127.0.0.1') {
-            return cb();
+            cb();
+            return;
         }
         server.server.close();
         server.moray.close();
@@ -174,7 +176,8 @@ module.exports = {
         var server = capi.createServer(config);
         server.connect(function (err) {
           if (err) {
-            return cb(err);
+            cb(err);
+            return;
           }
           cb(null, server);
         });
@@ -221,7 +224,8 @@ module.exports = {
                 var finished = 0;
                 if (rows.length === 0) {
                     client.close();
-                    return callback();
+                    callback();
+                    return;
                 }
                 rows.forEach(function (r) {
                     client.delObject(r.bucket, r.key, function (err) {
@@ -229,9 +233,8 @@ module.exports = {
                         finished += 1;
                         if (finished === rows.length) {
                             client.close();
-                            return callback();
-                        } else {
-                            return false;
+                            callback();
+                            return;
                         }
                     });
                 });
