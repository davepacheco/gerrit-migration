From f7759ef91b004250c26fe4f8809a7d3048c1aaf9 Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Thu, 18 Aug 2016 19:31:54 +0000
Subject: [PATCH] OS-5601 comm page symbols need ctf augmentation

---
 usr/src/uts/i86pc/ml/comm_page.s |  6 +++---
 usr/src/uts/i86pc/unix/Makefile  | 10 +++++++++-
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/usr/src/uts/i86pc/ml/comm_page.s b/usr/src/uts/i86pc/ml/comm_page.s
index 7ff803ea93..49d39397bf 100644
--- a/usr/src/uts/i86pc/ml/comm_page.s
+++ b/usr/src/uts/i86pc/ml/comm_page.s
@@ -20,7 +20,7 @@
 #include <sys/comm_page.h>
 #include <sys/tsc.h>
 
-#if defined(__lint)
+#if defined(_GENCTF) || defined(__lint)
 
 hrtime_t tsc_last;
 hrtime_t tsc_resume_cap;
@@ -37,7 +37,7 @@ hrtime_t tsc_sync_tick_delta[NCPU];
 
 comm_page_t comm_page;
 
-#else /* defined(__lint) */
+#else /* defined(_GENCTF) || defined(__lint) */
 
 #include "assym.h"
 
@@ -85,4 +85,4 @@ comm_page_t comm_page;
 	/* pad out the rest of the page from the struct end */
 	.fill	_CONST(COMM_PAGE_SIZE - COMM_PAGE_S_SIZE), 1, 0
 
-#endif /* defined(__lint) */
+#endif /* defined(_GENCTF) || defined(__lint) */
diff --git a/usr/src/uts/i86pc/unix/Makefile b/usr/src/uts/i86pc/unix/Makefile
index 6fcd879327..9ae5548e7f 100644
--- a/usr/src/uts/i86pc/unix/Makefile
+++ b/usr/src/uts/i86pc/unix/Makefile
@@ -119,6 +119,8 @@ CLEANFILES	+= \
 	$(ZLIB_OBJS:%.o=$(OBJS_DIR)/%.o) \
 	$(ZLIB_OBJS:%.o=$(OBJS_DIR)/%.ln)
 
+CLEANFILES	+= $(OBJS_DIR)/comm_page_ctf.o
+
 CLOBBERFILES	= $(CLEANFILES) $(UNIX_BIN) $(MULTIBOOT)
 CLEANLINTFILES	+= $(LINT_LIB) $(DBOOT_LINT_LIB) $(DBOOT_LINTS)
 
@@ -128,6 +130,8 @@ $(OBJS_DIR)/instr_size.ln :=	EXTRA_OPTIONS	= -I$(SRC)/common/dis/i386
 
 CFLAGS += -DDIS_MEM
 
+CTFEXTRAOBJS	+= $(OBJS_DIR)/comm_page_ctf.o
+
 #
 # For now, disable these lint checks; maintainers should endeavor
 # to investigate and remove these for maximum lint coverage.
@@ -189,7 +193,7 @@ $(UNIX_BIN):	$(UNIX_O) $(MODSTUBS_O) $(MAPFILE_NAME) \
 	$(CTFMERGE_UNIQUIFY_AGAINST_GENUNIX)
 	$(POST_PROCESS)
 
-$(UNIX_O):	$(OBJECTS) $(OBJS_DIR)/vers.o
+$(UNIX_O):	$(OBJECTS) $(OBJS_DIR)/vers.o $(OBJS_DIR)/comm_page_ctf.o
 	$(LD) -r -o $@ $(OBJECTS) $(OBJS_DIR)/vers.o
 
 $(DBOOT_BIN):	$(DBOOT_OBJS_DIR) $(DBOOT_OBJECTS) dboot/Mapfile.dboot
@@ -206,6 +210,10 @@ $(DBOOT_O):	$(DBOOT_BIN)
 $(DBOOT_OBJS_DIR):
 	-@mkdir -p $@ 2> /dev/null
 
+$(OBJS_DIR)/comm_page_ctf.o:	$(UTSBASE)/i86pc/ml/comm_page.s
+	$(COMPILE.c) -_gcc=-xc -D_GENCTF -o $@ $(UTSBASE)/i86pc/ml/comm_page.s
+	$(CTFCONVERT_O)
+
 #
 # dboot is built as an intermediate target in dboot.o, so just make
 # dboot.o the dependency here.
-- 
2.21.0

