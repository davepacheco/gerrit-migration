From 20972a118119b9d2e15ba25022f8cb15939b617c Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Thu, 18 Aug 2016 19:31:54 +0000
Subject: [PATCH] OS-5601 comm page symbols need ctf augmentation

---
 usr/src/uts/i86pc/ml/comm_page.s |  6 +++---
 usr/src/uts/i86pc/unix/Makefile  | 13 +++++++++----
 2 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/usr/src/uts/i86pc/ml/comm_page.s b/usr/src/uts/i86pc/ml/comm_page.s
index 7ff803ea93..49d39397bf 100644
--- a/usr/src/uts/i86pc/ml/comm_page.s
+++ b/usr/src/uts/i86pc/ml/comm_page.s
@@ -20,7 +20,7 @@
 #include <sys/comm_page.h>
 #include <sys/tsc.h>
 
-#if defined(__lint)
+#if defined(_GENCTF) || defined(__lint)
 
 hrtime_t tsc_last;
 hrtime_t tsc_resume_cap;
@@ -37,7 +37,7 @@ hrtime_t tsc_sync_tick_delta[NCPU];
 
 comm_page_t comm_page;
 
-#else /* defined(__lint) */
+#else /* defined(_GENCTF) || defined(__lint) */
 
 #include "assym.h"
 
@@ -85,4 +85,4 @@ comm_page_t comm_page;
 	/* pad out the rest of the page from the struct end */
 	.fill	_CONST(COMM_PAGE_SIZE - COMM_PAGE_S_SIZE), 1, 0
 
-#endif /* defined(__lint) */
+#endif /* defined(_GENCTF) || defined(__lint) */
diff --git a/usr/src/uts/i86pc/unix/Makefile b/usr/src/uts/i86pc/unix/Makefile
index 6fcd879327..2b3eeb8c8b 100644
--- a/usr/src/uts/i86pc/unix/Makefile
+++ b/usr/src/uts/i86pc/unix/Makefile
@@ -65,7 +65,7 @@ GENUNIX_DIR	= ../../intel/$(GENUNIX)
 
 LIBOPTS		= -L $(GENUNIX_DIR)/$(OBJS_DIR) -l $(GENUNIX)
 
-CTFEXTRAOBJS	= $(OBJS_DIR)/vers.o
+CTFEXTRAOBJS	= $(OBJS_DIR)/vers.o $(OBJS_DIR)/comm_page_ctf.o
 
 DBOOT_OBJS_DIR	= dboot/$(OBJS_DIR)
 DBOOT_OBJECTS	= $(DBOOT_OBJS:%=$(DBOOT_OBJS_DIR)/%)
@@ -98,9 +98,10 @@ UNIX_DIR	= .
 #
 CLEANFILES	+=		\
 	$(UNIX_O) $(MODSTUBS_O)	\
-	$(OBJS_DIR)/vers.c $(OBJS_DIR)/vers.o \
+	$(OBJS_DIR)/vers.c \
 	$(OBJS_DIR)/dtracestubs.s \
-	$(DTRACESTUBS_O) $(DTRACESTUBS)
+	$(DTRACESTUBS_O) $(DTRACESTUBS) \
+	$(CTFEXTRAOBJS)
 
 CLEANFILES	+=		\
 	$(DBOOT_O) $(DBOOT_S)	\
@@ -189,7 +190,7 @@ $(UNIX_BIN):	$(UNIX_O) $(MODSTUBS_O) $(MAPFILE_NAME) \
 	$(CTFMERGE_UNIQUIFY_AGAINST_GENUNIX)
 	$(POST_PROCESS)
 
-$(UNIX_O):	$(OBJECTS) $(OBJS_DIR)/vers.o
+$(UNIX_O):	$(OBJECTS) $(CTFEXTRAOBJS)
 	$(LD) -r -o $@ $(OBJECTS) $(OBJS_DIR)/vers.o
 
 $(DBOOT_BIN):	$(DBOOT_OBJS_DIR) $(DBOOT_OBJECTS) dboot/Mapfile.dboot
@@ -206,6 +207,10 @@ $(DBOOT_O):	$(DBOOT_BIN)
 $(DBOOT_OBJS_DIR):
 	-@mkdir -p $@ 2> /dev/null
 
+$(OBJS_DIR)/comm_page_ctf.o:	$(UTSBASE)/i86pc/ml/comm_page.s
+	$(COMPILE.c) -_gcc=-xc -D_GENCTF -o $@ $(UTSBASE)/i86pc/ml/comm_page.s
+	$(CTFCONVERT_O)
+
 #
 # dboot is built as an intermediate target in dboot.o, so just make
 # dboot.o the dependency here.
-- 
2.21.0

