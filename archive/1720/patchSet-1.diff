commit 86ca966f83835655ba4d2bf1c11c0d9037fd2b06 (refs/changes/20/1720/1)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2017-03-24T17:39:54-07:00 (2 years, 7 months ago)
    
    joyent/node-cueball#106 want INFO logs when backends are shuffled into the top N for pool/set

diff --git a/lib/pool.js b/lib/pool.js
index 528c077..c008e6f 100644
--- a/lib/pool.js
+++ b/lib/pool.js
@@ -458,6 +458,16 @@ CueBallConnectionPool.prototype.reshuffle = function () {
 		return;
 	var taken = this.p_keys.pop();
 	var idx = Math.floor(Math.random() * (this.p_keys.length + 1));
+
+	var conns = 0;
+	Object.keys(this.p_connections).forEach(function (k) {
+		conns += this.p_connections[k].length;
+	});
+	if (this.p_keys.length > conns && idx < conns) {
+		this.p_log.info('random shuffle puts backend "%s" at idx %d',
+		    taken, idx);
+	}
+
 	this.p_keys.splice(idx, 0, taken);
 	this.rebalance();
 };
diff --git a/lib/resolver.js b/lib/resolver.js
index 09e0e6d..a7f456d 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -861,6 +861,11 @@ CueBallDNSResolver.prototype.state_process = function (S) {
 
 	this.r_backends = newBackends;
 
+	if (oldKeys.length !== 0 && (removed.length > 0 || added.length > 0)) {
+		this.r_log.info({ added: added, removed: removed },
+		    'records changed in DNS');
+	}
+
 	removed.forEach(function (k) {
 		self.r_log.trace('host removed: %s', k);
 		self.emit('removed', k);
diff --git a/lib/set.js b/lib/set.js
index 4775484..5e80905 100644
--- a/lib/set.js
+++ b/lib/set.js
@@ -327,6 +327,10 @@ CueBallConnectionSet.prototype.reshuffle = function () {
 		return;
 	var taken = this.cs_keys.pop();
 	var idx = Math.floor(Math.random() * (this.cs_keys.length + 1));
+	if (this.cs_keys.length > this.cs_target && idx < this.cs_target) {
+		this.cs_log.info('random shuffle puts backend "%s" at idx %d',
+		    taken, idx);
+	}
 	this.cs_keys.splice(idx, 0, taken);
 	this.rebalance();
 };
