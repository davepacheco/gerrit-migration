From 958c51c755dffdcbbaeb9cb3c2a1f3653510c475 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 20 Feb 2017 19:47:43 +0100
Subject: [PATCH] TOOLS-1682 `sdcadm create -s SERVER ...` should support
 server hostname Reviewed by: Trent <trent.mick@joyent.com>

---
 lib/cli/do_create.js | 24 ++++++++++++++++++++++--
 1 file changed, 22 insertions(+), 2 deletions(-)

diff --git a/lib/cli/do_create.js b/lib/cli/do_create.js
index 4aa3f85..00e6a54 100644
--- a/lib/cli/do_create.js
+++ b/lib/cli/do_create.js
@@ -9,6 +9,7 @@
  */
 
 var p = console.log;
+var util = require('util');
 
 var assert = require('assert-plus');
 var vasync = require('vasync');
@@ -70,6 +71,25 @@ Create.prototype.execute = function cExecute(opts, args, cb) {
                 next(err);
             });
         },
+        function getServerFromHostname(_, next) {
+            if (!opts.server || common.UUID_RE.test(opts.server)) {
+                next();
+                return;
+            }
+            self.sdcadm.cnapi.listServers({
+                hostname: opts.server
+            }, function (err, servers) {
+                if (err || !servers.length) {
+                    self.sdcadm.log.error({err: err}, 'do_create');
+                    next(new errors.UsageError(util.format(
+                        'Cannot find server "%s"', opts.server)));
+                    return;
+                }
+                opts.server = servers[0].uuid;
+                next();
+            });
+
+        },
         function getChangeFromArgs(_, next) {
             if (args.length === 0) {
                 return next(new errors.UsageError(
@@ -93,7 +113,7 @@ Create.prototype.execute = function cExecute(opts, args, cb) {
 
             if (!opts.server) {
                 return next(new errors.UsageError(
-                    'Must specify server uuid'));
+                    'Must specify server uuid or hostname'));
             }
             change.server = opts.server;
             change.type = 'create-instance';
@@ -238,7 +258,7 @@ do_create.options = [
     {
         names: ['server', 's'],
         type: 'string',
-        help: 'The UUID for the target server.'
+        help: 'The server (UUID or hostname) on which to create the instance.'
     },
     {
         names: ['yes', 'y'],
-- 
2.21.0

