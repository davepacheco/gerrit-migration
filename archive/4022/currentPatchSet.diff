From c83e489932035dd3360ad99cbcf6a811f7e58e84 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Tue, 29 May 2018 17:12:09 -0700
Subject: [PATCH] TRITON-448 CNAPI should expose moray client metrics
 Reviewed-by: Orlando Vazquez <orlando@joyent.com> Approved-by: Orlando
 Vazquez <orlando@joyent.com>

---
 lib/apis/moray.js |  5 +++--
 lib/app.js        | 12 ++++++++----
 package.json      |  2 +-
 3 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/lib/apis/moray.js b/lib/apis/moray.js
index 9fdc7c8..baa4c03 100644
--- a/lib/apis/moray.js
+++ b/lib/apis/moray.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -93,6 +93,7 @@ var BUCKETS = {
 
 function Moray(options) {
     this.log = options.log;
+    this.collector = options.collector;
     this.config = options.config;
     this.connected = false;
 }
@@ -117,6 +118,7 @@ Moray.prototype.connect = function () {
     self.log.info('initializing moray client');
 
     var config = mod_jsprim.deepCopy(self.config.moray);
+    config.collector = self.collector;
     config.log = self.log;
     var client = self._morayClient = mod_moray.createClient(config);
 
@@ -126,7 +128,6 @@ Moray.prototype.connect = function () {
         self.connected = true;
     }
 
-
     client.on('connect', onConnect);
     client.on('error', function (err) {
         // not much more to do because the moray client should take
diff --git a/lib/app.js b/lib/app.js
index 22cf1cb..3edde1c 100644
--- a/lib/app.js
+++ b/lib/app.js
@@ -503,11 +503,15 @@ App.prototype.setupWorkflowClient = function () {
 
 
 App.prototype.setupMorayClient = function () {
-    this.moray = new Moray({
-        log: this.log,
-        config: this.config
+    var self = this;
+
+    self.moray = new Moray({
+        collector: self.metricsManager.collector, // the artedi handle
+        config: self.config,
+        log: self.log
     });
-    this.moray.connect();
+
+    self.moray.connect();
 };
 
 
diff --git a/package.json b/package.json
index 73e8f54..ce250f5 100644
--- a/package.json
+++ b/package.json
@@ -15,7 +15,7 @@
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
     "jsprim": "1.3.1",
     "libuuid": "0.2.1",
-    "moray": "3.4.2",
+    "moray": "3.5.0",
     "nodeunit": "0.11.0",
     "once": "1.4.0",
     "restify": "4.3.0",
-- 
2.21.0

