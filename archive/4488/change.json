{"project":"joyent/sdcadm","branch":"master","id":"Iadf74109268fda3957be551c79eb750481a597d4","number":"4488","subject":"TOOLS-1958 \u0027sdcadm experimental update-agents\u0027 saves the agents shar as \"agent-UUID.sh\" instead of \"agents-UUID.sh\" TOOLS-1959 sdcadm: agent[s]-UUID.sh files build up in /usbkey/extra/agents Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Reviewed by","owner":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"url":"https://cr.joyent.us/4488","commitMessage":"TOOLS-1958 \u0027sdcadm experimental update-agents\u0027 saves the agents shar as \"agent-UUID.sh\" instead of \"agents-UUID.sh\"\nTOOLS-1959 sdcadm: agent[s]-UUID.sh files build up in /usbkey/extra/agents\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1530821806,"lastUpdated":1533132858,"open":false,"status":"MERGED","comments":[{"timestamp":1530821806,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 1."},{"timestamp":1530821843,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n version is: 1.19.0\n Version check ok.\n /tmp/repo/./build/node/bin/node node_modules/.bin/eslint  lib/dc-maint.js lib/channel.js lib/cli/do_instances.js lib/cli/do_check_health.js lib/cli/do_avail.js lib/cli/index.js lib/cli/do_create.js lib/cli/do_fix_core_vm_resolvers.js lib/cli/do_rollback.js lib/cli/do_update_agents.js lib/cli/do_completion.js lib/cli/do_update_gz_tools.js lib/cli/do_check_config.js lib/cli/do_install_docker_cert.js lib/cli/do_self_update.js lib/cli/do_services.js lib/cli/do_add_new_agent_svcs.js lib/cli/do_update_other.js lib/cli/do_nfs_volumes.js lib/cli/do_update_docker.js lib/cli/do_update.js lib/cli/experimental.js lib/default-fabric.js lib/steps/binder.js lib/steps/update_vm_size.js lib/steps/zookeeper.js lib/steps/servers.js lib/steps/index.js lib/steps/dnsdomain.js lib/steps/no-rabbit.js lib/steps/usbkey.js lib/steps/sapi.js lib/sdcadm.js lib/errors.js lib/post-setup/dev-sample-data.js lib/post-setup/fabrics.js lib/post-setup/ha-manatee.js lib/post-setup/common-external-nics.js lib/post-setup/dev-headnode-prov.js lib/post-setup/volapi.js lib/post-setup/docker.js lib/post-setup/cloudapi.js lib/post-setup/ha-binder.js lib/post-setup/index.js lib/post-setup/underlay-nics.js lib/post-setup/cmon.js lib/post-setup/cns.js lib/logging.js lib/vmadm.js lib/locker.js lib/svcadm.js lib/common.js lib/procedures/update-dockerlogger.js lib/procedures/update-sapi-v2.js lib/procedures/index.js lib/procedures/shared.js lib/procedures/update-manatee-v2.js lib/procedures/create-service-instance-v1.js lib/procedures/update-single-headnode-imgapi.js lib/procedures/download-images.js lib/procedures/update-moray-v2.js lib/procedures/update-binder-v2.js lib/procedures/update-stateless-services-v1.js lib/procedures/update-agent-v1.js lib/procedures/update-single-hn-sapi-v1.js lib/procedures/procedure.js lib/platform.js lib/ur.js test/manatee.test.js test/common.js test/available.test.js test/experimental.test.js test/rollback.test.js test/dc-maint.test.js test/services.test.js test/update.test.js test/shared.js test/unit/cli/do_update_agents.test.js test/unit/testutil.js test/unit/steps/usbkey.test.js test/instances.test.js test/post-setup.test.js test/help.test.js test/common.test.js test/create.test.js test/check-health.test.js test/post-setup-ha-binder.test.js test/sdcadm.test.js test/channel.test.js test/update-gz-tools.test.js test/platform.test.js test/self-update.test.js test/check-config.test.js\n \n /tmp/repo/lib/cli/do_update_agents.js\n   584:42  error  A space is required after \u0027,\u0027  comma-spacing\n \n ✖ 1 problem (1 error, 0 warnings)\n   1 error, 0 warnings potentially fixable with the `--fix` option.\n \n tools/mk/Makefile.targ:201: recipe for target \u0027check-eslint\u0027 failed\n gmake: *** [check-eslint] Error 1"},{"timestamp":1530821901,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 2."},{"timestamp":1530821934,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530824016,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\n(11 comments)\n\nI purposefully used a generous definition of \"nearby\" for adding unit tests. In this case I felt that helped me get a handle on how to write testable js.\n\nSince https://github.com/tapjs/node-tap/pull/446 is languishing, you will need to add --coverage-report\u003dhtml to get a pretty report."},{"timestamp":1530890225,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Code-Review+1\n\n(4 comments)\n\nIn general, I like the approach. It\u0027s worth paying the price of carrying a big object if we can test some of its parts, though. Two main concerns:\n1) It\u0027s pretty lame that we are spending a lot of time into exactly this file when our plan is to remove update agents altogether as soon as RFD 82 is done.\n2) I miss having some kind of runtest modification or some addition to the makefile so we can easily run unit tests w/o more researching that just calling `make testunit`, for example.\n\nOther than that, I\u0027m pretty happy with what you just did here Chris. Congrats and HUGE thanks!"},{"timestamp":1531516535,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\n(2 comments)\n\nI\u0027m not sure what you are looking for with regards to the test runner.  You can run `tap test/unit/foo.js` along with any of tap\u0027s \"name\" based regex filters.  I ended up using those while working on this.\n\nIs there somewhere else where we `make target bunch-of-args`?  I do miss other environments that have a bunch of handy \"which tests to run\" commands built in, but I\u0027m not sure how to add that here in a reasonable amount of complexity."},{"timestamp":1531751983,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Integration-Approval+1\n\n(2 comments)\n\n\u003e (2 comments)\n \u003e \n \u003e I\u0027m not sure what you are looking for with regards to the test\n \u003e runner.  You can run `tap test/unit/foo.js` along with any of tap\u0027s\n \u003e \"name\" based regex filters.  I ended up using those while working\n \u003e on this.\n \u003e \n \u003e Is there somewhere else where we `make target bunch-of-args`?  I do\n \u003e miss other environments that have a bunch of handy \"which tests to\n \u003e run\" commands built in, but I\u0027m not sure how to add that here in a\n \u003e reasonable amount of complexity.\n\nI\u0027d just like to keep that shortcut to the call you mention somewhere handy. If not adding to the Makefile b/c that means adding some more complexity, just making a note in the readme would be fine."},{"timestamp":1531774278,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(5 comments)\n\n1. one nit\n2. still want to bump package.json patch level, right?\n3. if the test case passes, then I\u0027m +1 merging this"},{"timestamp":1531836989,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(1 comment)\n\nVerified the \"double name\" for functions as prototype name and name of the function is due to MDB"},{"timestamp":1531852865,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 3."},{"timestamp":1531852883,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\n(4 comments)\n\nI think the latest push covers everything outstanding."},{"timestamp":1531852913,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531853158,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 4."},{"timestamp":1531853205,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531856403,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1532969486,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1532969539,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1532969670,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 6."},{"timestamp":1532969725,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532984222,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1532984724,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1532984731,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 7."},{"timestamp":1532984776,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532993376,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1533035831,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7: Code-Review+1\n\nOther than the version bump Trent already pointed to LGTM"},{"timestamp":1533048860,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 8."},{"timestamp":1533048915,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533049077,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1533080158,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 8: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1533122705,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8: Code-Review+1 Integration-Approval+1\n\n\u003e (1 comment)\n\nI\u0027m obviously of the same opinion of Trent on this. Maybe I\u0027m not cautious enough about the changelog, specially with quick fixes but still, I also think a properly changelog is very helpful."},{"timestamp":1533132831,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 9: Commit message was updated."},{"timestamp":1533132858,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Chris Burroughs"}],"currentPatchSet":{"number":"9","revision":"8bf24cd9831268d461c93e95f46887c74a99776c","parents":["8464a2ecb23c8d0ad54467a1cfe7e9f7f606e3de"],"ref":"refs/changes/88/4488/9","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1533132831,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533048915,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533080158,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533080158,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533122705,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533122705,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1533132858,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":992,"sizeDeletions":-343},"patchSets":[{"number":"1","revision":"731a7b7a84b041bf69f92ebc20f3d2eab3657cc8","parents":["3cac21ad89c6d5874cfddc7a7fb50ae8db3acb96"],"ref":"refs/changes/88/4488/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1530821806,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1530821843,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":357,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":969,"sizeDeletions":-341},{"number":"2","revision":"e934ea36a28db8c92663a07353a9fa12bb8140b2","parents":["3cac21ad89c6d5874cfddc7a7fb50ae8db3acb96"],"ref":"refs/changes/88/4488/2","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1530821901,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530821934,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530890225,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1531751983,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"lib/cli/do_update_agents.js","line":42,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"When used below we do if (err) for the cb of this function, but since we don\u0027t have a handler on the \u0027error\u0027 event here I know see how we would get to that code path."},{"file":"lib/cli/do_update_agents.js","line":62,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"The primary purpose was of making this a \"command object\" was so that the steps could be broken out into bits that were accessible for testing.  With the common idiom of defining them within a giant inline array I don\u0027t see any way to access at them in isolation.\n\nIn a larger object that made use of multiple vasync pipelines I\u0027m not sure what  the right approach would be.  Lots of \"steps\" attached in the object? Each pipeline is an object? I have not needed to cross that bridge yet."},{"file":"lib/cli/do_update_agents.js","line":128,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I see pattern of ObjectName.protype.methodName \u003d function methodName()... in most of our existing code.  What is the duplication needed for? mdb?"},{"file":"lib/cli/do_update_agents.js","line":128,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I think it was an attempt to help the linter avoiding hoisting (https://developer.mozilla.org/en-US/docs/web/JavaScript/Reference/Operators/function). Not sure if it\u0027s related to MDB, worth asking though"},{"file":"lib/cli/do_update_agents.js","line":128,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"My understanding is that it is for mdb. Perhaps that\u0027s a misunderstanding though and is not required for the function object to have a name? Or perhaps that\u0027s changed over node versions.\n\nAlso... if/when the move to eslint rules that require a function name for all functions, then we\u0027ll want it to make that check happy."},{"file":"lib/cli/do_update_agents.js","line":128,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I verified with recent mdb: if we don\u0027t add the function name right after the function we get \"_setImageFromUuid as anonymous\" and, from there, the function is referred as \"anonymous\".\n\nI know it\u0027s a little bit annoying but, given it\u0027s not a huge effort, let\u0027s keep the pattern."},{"file":"lib/cli/do_update_agents.js","line":256,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I\u0027m unsure of these repeitive voluminous asserts.  Since only vasync should ever call this function, is it enough to rely on it to not mess up the args?"},{"file":"lib/cli/do_update_agents.js","line":256,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yah, I\u0027m often conflicted on them as well. Basically I just choose to never be strict on having or not having them in CRs."},{"file":"lib/cli/do_update_agents.js","line":273,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I know we usually have the asserts at the top of the function, but in this case the just justdownload short circuits make  what we need variable.  Should there be a ctx.fname assertion after the self.justDownload || self.skipLatestSymlink check?"},{"file":"lib/cli/do_update_agents.js","line":711,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I think the previous use of rate vs concurrency was a bug of inconsistency."},{"file":"lib/cli/do_update_agents.js","line":913,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"eslint throws an error in strict mode without this, but I have not seen it used before and was unsure of the idiom."},{"file":"lib/cli/do_update_agents.js","line":913,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Whoa, how did you figure that out? I recall hitting a similar error with cmdln-using code that had `function do_foo` in a separate file like this. At the time I gave up and dropped usage of `\u0027use strict\u0027;`."},{"file":"lib/cli/do_update_agents.js","line":913,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"eslint point me towards \u003chttps://eslint.org/docs/rules/no-invalid-this\u003e and I figured a magic comment was worth a try."},{"file":"lib/cli/do_update_agents.js","line":1073,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"There are (of course!) several npm modules that try to provide some sort of special ForTestingOnly export namespace.  In the long email thread that got me down this path with Trent and JoshW the suggestion was to just use the _ convention."},{"file":"lib/steps/usbkey.js","line":67,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"consider\""},{"file":"lib/steps/usbkey.js","line":67,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Done"},{"file":"lib/steps/usbkey.js","line":68,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I couldn\u0027t find some sort of concurrent map function.  I tried vasync.forEachParallel but that was much more code that will only matter the first time this is run in a DC that has been updated many times (just east3b?)"},{"file":"lib/steps/usbkey.js","line":68,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yup, I think this is fine for now. As Pedro mentioned we want to move away from \u0027sdcadm ex update-agents\u0027 anyway, so let\u0027s not over-engineer this."},{"file":"package.json","line":4,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027d bump this. In general, I\u0027d do every time we need a new dependency. On this case also b/c this is a HUGE refactoring of some piece. Also, add the issues to CHANGES.md"},{"file":"package.json","line":4,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Of x.y.z, is the \"this\" to bump, y, or z?"},{"file":"package.json","line":4,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Given this is just for testing and you\u0027re not adding any functionality to sdcadm itself, but just tests, I\u0027d go with z here but whatever it\u0027s fine."},{"file":"package.json","line":4,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Done"},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"bump to .2 now?"},{"file":"test/unit/cli/do_update_agents.test.js","line":25,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Any reason to call require twice instead of just once and then assign the variables?"},{"file":"test/unit/cli/do_update_agents.test.js","line":25,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"No particular reason.  Is the more common reason to do:?\n\nconst foo \u003d require(\u0027foo\u0027);\nconst bar \u003d foo.bar;\nconst bax \u003d foo.bax;"},{"file":"test/unit/cli/do_update_agents.test.js","line":25,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027d say it is, just b/c that avoid two calls to Node\u0027s \"require\" which, even when loading from cache, includes some logic. The other way around just means aliasing two properties of an already loaded object."},{"file":"test/unit/cli/do_update_agents.test.js","line":25,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Done"},{"file":"test/unit/cli/do_update_agents.test.js","line":66,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"For reasons I could not figure out, calling mockfs restore right before t.done when there are several cases caused inscrutable tap errors.  I don\u0027t think grouping together tests that use mockfs is a big deal."},{"file":"test/unit/cli/do_update_agents.test.js","line":66,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sounds perfectly fine"},{"file":"test/unit/testutil.js","line":14,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I tried some too clever file-per-test options, but I think treating all of stdout/stderr/logging at tap comments is the least bad option.  It makes sure those messages are right by the tests (when they fail) while keeping the output of `make test-unit` clean.   The downside is that the raw TAP output becomes even more unwieldy for humans, and you need to deal with the leading # if you want to pass the bunyan lines to something.\n\n I\u0027m not sure if this provides any viable art for code that just calls console.log directly. Maybe that being the Right Thing To Do will be a rare case."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":357,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":969,"sizeDeletions":-341},{"number":"3","revision":"8cd0a860d02f59b1cb2b18bae3b7e2eff42033b3","parents":["3cac21ad89c6d5874cfddc7a7fb50ae8db3acb96"],"ref":"refs/changes/88/4488/3","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1531852865,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531852913,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":992,"sizeDeletions":-343},{"number":"4","revision":"da58e02b0d122971d8adb6d5a4cadd4160f56844","parents":["288e998a415af65109a0cdbe3a8e1b3b28ab01d2"],"ref":"refs/changes/88/4488/4","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1531853158,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531853205,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":988,"sizeDeletions":-342},{"number":"5","revision":"bf6da93b813b028f98978f3b2c4e9845935e165a","parents":["8464a2ecb23c8d0ad54467a1cfe7e9f7f606e3de"],"ref":"refs/changes/88/4488/5","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1532969486,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531853205,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":988,"sizeDeletions":-342},{"number":"6","revision":"eabcd6d57fd1247fe01beedcea6c57e356b1009c","parents":["8464a2ecb23c8d0ad54467a1cfe7e9f7f606e3de"],"ref":"refs/changes/88/4488/6","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1532969670,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532969725,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":79,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"sdcadm"},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"still want to bump this version?"},{"file":"package.json","line":4,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I bumped it today."},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Not according to this CR: https://cr.joyent.us/#/c/4488/7/package.json\n\nPerhaps you bumped to \"1.20.0\" and then rebased on master which had *also* bumped to 1.20.0?"},{"file":"package.json","line":4,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I have bumped it again.  This number has little meaning to developers or users.  I think it would be better to not have, ignore it, or have the release process bump it instead of a make-work ceremony that causes ever diff to conflict with every other."},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027ll let pedro speak to his experience, but I\u0027ve tended to use it to get what version of sdcadm is being used when doing support via `sdcadm --version`. Assuming a well-written changelog in CHANGES.md it can be very helpful to see what has changed in sdcadm from the p.o.v. of the operator. Yes I could use the git sha to work out which commits, but the changelog gives opportunity to describe change for the user of the tool.\n\nYes the rechurn on CR reviews is frustrating. However I respectfully disagree that it is meaningless.\n\nI think having it automated would *somewhat* be good, but I tend to think that a good changelog entry can\u0027t be automated away."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":988,"sizeDeletions":-342},{"number":"7","revision":"47bb300ae27ba112985ad5b8285fa60ecfbe267d","parents":["8464a2ecb23c8d0ad54467a1cfe7e9f7f606e3de"],"ref":"refs/changes/88/4488/7","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1532984731,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532984776,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533035831,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":988,"sizeDeletions":-342},{"number":"8","revision":"adf74109268fda3957be551c79eb750481a597d4","parents":["8464a2ecb23c8d0ad54467a1cfe7e9f7f606e3de"],"ref":"refs/changes/88/4488/8","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1533048860,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533048915,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533080158,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533080158,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533122705,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533122705,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":992,"sizeDeletions":-343},{"number":"9","revision":"8bf24cd9831268d461c93e95f46887c74a99776c","parents":["8464a2ecb23c8d0ad54467a1cfe7e9f7f606e3de"],"ref":"refs/changes/88/4488/9","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1533132831,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533048915,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533080158,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533080158,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533122705,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1533122705,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1533132858,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"README.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":414,"deletions":-333},{"file":"lib/steps/usbkey.js","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/unit/cli/do_update_agents.test.js","type":"ADDED","insertions":358,"deletions":0},{"file":"test/unit/steps/usbkey.test.js","type":"MODIFIED","insertions":116,"deletions":-5},{"file":"test/unit/testutil.js","type":"ADDED","insertions":31,"deletions":0}],"sizeInsertions":992,"sizeDeletions":-343}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}