{"project":"joyent/node-cueball","branch":"master","id":"I8617512b2ea9b5199c1c1c6de10d6f0c26fed30d","number":"597","subject":"joyent/node-cueball#35 backends removed from DNS may have new connections opened in rebalance Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/597","commitMessage":"joyent/node-cueball#35 backends removed from DNS may have new connections opened in rebalance\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1475627273,"lastUpdated":1475702132,"open":false,"status":"MERGED","comments":[{"timestamp":1475627273,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1475627399,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475676183,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)"},{"timestamp":1475691453,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)"},{"timestamp":1475699008,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1475699015,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1475699146,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475699297,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1475702129,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1475702132,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"2","revision":"8617512b2ea9b5199c1c1c6de10d6f0c26fed30d","parents":["5e1433203f71f47bf623011a70d12436d5cff780"],"ref":"refs/changes/97/597/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1475699008,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475699146,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1475699297,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475702129,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1475702132,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/set.js","type":"MODIFIED","insertions":67,"deletions":-14},{"file":"test/cset.test.js","type":"MODIFIED","insertions":153,"deletions":-2},{"file":"test/pool.test.js","type":"MODIFIED","insertions":77,"deletions":-1}],"sizeInsertions":314,"sizeDeletions":-25},"patchSets":[{"number":"1","revision":"e23220e68ad8bb74ba44741cd2c9c6f9969959ff","parents":["5e1433203f71f47bf623011a70d12436d5cff780"],"ref":"refs/changes/97/597/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1475627273,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1475676183,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1475691453,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475627399,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/set.js","line":280,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This will always make it to state \u0027closed\u0027 eventually, right? It may just past through several states first?"},{"file":"lib/set.js","line":280,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes. We did this.cs_backends \u003d {} above, which will cause .shouldRetryBackend() to always return false from now on. We\u0027ve either emitted \u0027removed\u0027 for all of its connections (either here or previously), in which case it\u0027s our expectation that our consumer will now cause them to emit \u0027close\u0027 which will then trigger the FSMs to proceed to \u0027closed\u0027 -- or we explicitly call .close() on it here. In the first case we will proceed to \u0027closed\u0027 state possibly via \u0027error\u0027, in the second directly."},{"file":"test/cset.test.js","line":313,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Add a reason like \u0027ConnectionSet should have moved into the \"stopping\" state\u0027."},{"file":"test/cset.test.js","line":313,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"},{"file":"test/pool.test.js","line":347,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This might be better with a vasync pipeline."},{"file":"test/pool.test.js","line":347,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It would be. So would half the rest of these tests, too... maybe I should redo all of them"},{"file":"test/pool.test.js","line":379,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s this timeout for?"},{"file":"test/pool.test.js","line":379,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"For me when I was debugging this test. Removing it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/set.js","type":"MODIFIED","insertions":67,"deletions":-14},{"file":"test/cset.test.js","type":"MODIFIED","insertions":153,"deletions":-2},{"file":"test/pool.test.js","type":"MODIFIED","insertions":78,"deletions":-1}],"sizeInsertions":315,"sizeDeletions":-25},{"number":"2","revision":"8617512b2ea9b5199c1c1c6de10d6f0c26fed30d","parents":["5e1433203f71f47bf623011a70d12436d5cff780"],"ref":"refs/changes/97/597/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1475699008,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1475699297,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1475702129,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1475702132,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475699146,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/set.js","type":"MODIFIED","insertions":67,"deletions":-14},{"file":"test/cset.test.js","type":"MODIFIED","insertions":153,"deletions":-2},{"file":"test/pool.test.js","type":"MODIFIED","insertions":77,"deletions":-1}],"sizeInsertions":314,"sizeDeletions":-25}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}