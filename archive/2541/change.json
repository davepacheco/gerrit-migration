{"project":"joyent/illumos-joyent","branch":"master","id":"I83f1905cc24370140e0c51011346814bb5f2a31e","number":"2541","subject":"OS-6150 do not sq_wait unnecessarily Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/2541","commitMessage":"OS-6150 do not sq_wait unnecessarily\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1505153847,"lastUpdated":1505403403,"open":false,"status":"MERGED","comments":[{"timestamp":1505153847,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1505154184,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\nOne question needs answering: what motivated sq_wait in the first place?  Clearly you\u0027re removing it, but why was it there to begin with?  It must\u0027ve attempted to solve SOME sort of problem..."},{"timestamp":1505154372,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\ndanmcd: That question was asked at the very beginning of this whole process.  While no concrete conclusion was reached, the fact that its value of 10ms matched the tick rate at the time, everyone in the discussion thought its existence seemed _very_ dubious."},{"timestamp":1505154866,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505155236,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505156983,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1\n\nMake sure some massive-data testing is done in both directions.  This delay may have been a bandwidth/latency tradeoff for some silly reason."},{"timestamp":1505157891,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1505160589,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505161460,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505161827,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505316303,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nSome testing notes added to the Jira ticket."},{"timestamp":1505317452,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Integration-Approval+1\n\n\u003e Some testing notes added to the Jira ticket.\n\nThank you."},{"timestamp":1505319348,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1505322320,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1505329571,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1505398708,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1505403403,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"4","revision":"83f1905cc24370140e0c51011346814bb5f2a31e","parents":["9094e8556e7c00d1961a4dbff4777f615669fba8"],"ref":"refs/changes/41/2541/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505398708,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505156983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505157891,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505317452,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505322320,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1505403403,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_squeue.c","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":41,"deletions":-181},{"file":"usr/src/uts/common/io/gsqueue/gsqueue.c","type":"MODIFIED","insertions":9,"deletions":-12},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/gsqueue.h","type":"MODIFIED","insertions":2,"deletions":-8},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/squeue_impl.h","type":"MODIFIED","insertions":2,"deletions":-6},{"file":"usr/src/uts/intel/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4}],"sizeInsertions":63,"sizeDeletions":-238},"patchSets":[{"number":"1","revision":"d7f754069d0e970302f48b49d50d2e9b7e7245e3","parents":["5f71060f11e463c2446241a60fdd8ad297edcaff"],"ref":"refs/changes/41/2541/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505153847,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505157891,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505156983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505317452,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/inet/squeue.c","line":398,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"This MAY answer what I just asked, but reading this, it makes no sense to me.  I wonder if this helps the inbound side, but makes the outbound side perform as poorly as you\u0027d been seeing?"},{"file":"usr/src/uts/common/inet/squeue.c","line":398,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Well, the kicker is that once any data are queued on the squeue, all further work will queue behind it until the timer fires and the worker thread drains the queue.  10ms is an eternity to wait."},{"file":"usr/src/uts/common/inet/squeue.c","line":445,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It appears that you have removed the other mutex_exit and returns from the different branchs in this complicated if/else statement, so you could do that here too if you wanted."},{"file":"usr/src/uts/common/inet/squeue.c","line":445,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The explicit bail-out here is necessary since there is other logic below that we would \"fall into\"."},{"file":"usr/src/uts/common/inet/squeue.c","line":445,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sorry for the noise. Yes, you\u0027re correct. I thought I was checking everything properly but gerrit kind of fails with such a bug wad of if/else."},{"file":"usr/src/uts/common/inet/squeue.c","line":445,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The \u0027Blame Gerrit\u0027 coupon is always accepted at MooneyMart."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_squeue.c","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":41,"deletions":-181},{"file":"usr/src/uts/common/io/gsqueue/gsqueue.c","type":"MODIFIED","insertions":9,"deletions":-12},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/gsqueue.h","type":"MODIFIED","insertions":2,"deletions":-8},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/squeue_impl.h","type":"MODIFIED","insertions":2,"deletions":-6},{"file":"usr/src/uts/intel/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4}],"sizeInsertions":63,"sizeDeletions":-238},{"number":"2","revision":"44888cbfedd9fb28e1ca1478dd8786b72bb7e2da","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/41/2541/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505319348,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505157891,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505322320,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505156983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505317452,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_squeue.c","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":41,"deletions":-181},{"file":"usr/src/uts/common/io/gsqueue/gsqueue.c","type":"MODIFIED","insertions":9,"deletions":-12},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/gsqueue.h","type":"MODIFIED","insertions":2,"deletions":-8},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/squeue_impl.h","type":"MODIFIED","insertions":2,"deletions":-6},{"file":"usr/src/uts/intel/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4}],"sizeInsertions":63,"sizeDeletions":-238},{"number":"3","revision":"5b5feb5142da3c3dbf0dd8a78c33da7175fe231c","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/41/2541/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505329571,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505157891,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505322320,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505156983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505317452,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_squeue.c","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":41,"deletions":-181},{"file":"usr/src/uts/common/io/gsqueue/gsqueue.c","type":"MODIFIED","insertions":9,"deletions":-12},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/gsqueue.h","type":"MODIFIED","insertions":2,"deletions":-8},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/squeue_impl.h","type":"MODIFIED","insertions":2,"deletions":-6},{"file":"usr/src/uts/intel/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4}],"sizeInsertions":63,"sizeDeletions":-238},{"number":"4","revision":"83f1905cc24370140e0c51011346814bb5f2a31e","parents":["9094e8556e7c00d1961a4dbff4777f615669fba8"],"ref":"refs/changes/41/2541/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505398708,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505157891,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1505403403,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505322320,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505156983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505317452,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip_squeue.c","type":"MODIFIED","insertions":2,"deletions":-12},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":41,"deletions":-181},{"file":"usr/src/uts/common/io/gsqueue/gsqueue.c","type":"MODIFIED","insertions":9,"deletions":-12},{"file":"usr/src/uts/common/io/vnd/vnd.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/common/sys/gsqueue.h","type":"MODIFIED","insertions":2,"deletions":-8},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/sys/squeue_impl.h","type":"MODIFIED","insertions":2,"deletions":-6},{"file":"usr/src/uts/intel/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/intel/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.debug64","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"usr/src/uts/sparc/ip/ip.global-objs.obj64","type":"MODIFIED","insertions":1,"deletions":-4}],"sizeInsertions":63,"sizeDeletions":-238}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}