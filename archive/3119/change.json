{"project":"joyent/illumos-joyent","branch":"master","id":"Ib036e0fd770de1dd266db82dad196891746e92e1","number":"3119","subject":"OS-6467 LX go 1.9 aborts on unexpected signal interpositioning Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3119","commitMessage":"OS-6467 LX go 1.9 aborts on unexpected signal interpositioning\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1513611594,"lastUpdated":1513633501,"open":false,"status":"MERGED","comments":[{"timestamp":1513611594,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1513620067,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\nYou implement this as a stack of sorts (every block-all increments state counter by one, every unblock-all decrements the same by one).  Are there ever cases in your experience where multiple block-alls are issued (looks like the only way that\u0027ll happen is through recursion)?"},{"timestamp":1513620752,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI modeled this on the libc sigon/sigoff handling. Currently this is only used during vfork, so there should not be a way for multiple concurrent threads to disable/enable all signals, but I thought these new brand calls might be useful in other places in the future where we need to handle multiple threads fully disabling signals."},{"timestamp":1513621500,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI suppose in theory, even restricted to vork, two threads could race into vfork and both disable signals, so only the final thread should actually reenable signal deliver."},{"timestamp":1513622007,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(4 comments)\n\nThank you.  I suspect the remaining questions I have are likely related to future plans (e.g. -1 as a failure indicator in unblock-all)."},{"timestamp":1513623100,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1513626096,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review+1\n\nLooks good, modulo the proposed errno change"},{"timestamp":1513627303,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1513627705,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI added testing notes to the ticket."},{"timestamp":1513630549,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1513631426,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1513633404,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1513633489,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1513633501,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"b036e0fd770de1dd266db82dad196891746e92e1","parents":["f72f737f0faf4fabecfa7547c4dbd3d24ce6f33c"],"ref":"refs/changes/19/3119/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1513633489,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513630549,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1513633501,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","type":"MODIFIED","insertions":35,"deletions":-12},{"file":"usr/src/lib/brand/lx/lx_brand/common/fork.c","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_misc.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/os/sig.c","type":"MODIFIED","insertions":11,"deletions":-4}],"sizeInsertions":105,"sizeDeletions":-23},"patchSets":[{"number":"1","revision":"6df1244345c786a9e6201d753242bd9aea7aa67b","parents":["10edab4495ca6c13087d229e2688afdbb323bd1c"],"ref":"refs/changes/19/3119/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1513611594,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513626096,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","line":587,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Inspired me to ask my other lx_brand.c question:  All-signals state copies over to child process?"},{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","line":587,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Pending signals are not copied to a child, but signal handlers and masks will be copied. We also copy the brand-specific process data, which is where the in-kernel state is kept for the block/unblock counter."},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","line":2392,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Given you have -1 as an indicator in lx_brand.c, should you void it out here?"},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","line":2392,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I added the failure return mostly for tracing, but a failure implies a programmatic bug in the brand code. I could certainly add a verify here if that seems better."},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","line":1885,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is there some sort of errno indicator you need to set here? Or is -1 sufficient?"},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","line":1885,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"You\u0027re right, I think I should return an errno here, I\u0027ll fix that."},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","line":367,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Pardon my ignorance of fork internals, but will this value get copied over into the child process?"},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","line":367,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes, this is copied in the lx_copy_procdata brand hook which is called during fork."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","type":"MODIFIED","insertions":35,"deletions":-12},{"file":"usr/src/lib/brand/lx/lx_brand/common/fork.c","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_misc.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/os/sig.c","type":"MODIFIED","insertions":11,"deletions":-4}],"sizeInsertions":105,"sizeDeletions":-23},{"number":"2","revision":"9702197f4faad8a9d85454ddcc7b6651f140791f","parents":["10edab4495ca6c13087d229e2688afdbb323bd1c"],"ref":"refs/changes/19/3119/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1513627303,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513630549,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","type":"MODIFIED","insertions":35,"deletions":-12},{"file":"usr/src/lib/brand/lx/lx_brand/common/fork.c","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_misc.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/os/sig.c","type":"MODIFIED","insertions":11,"deletions":-4}],"sizeInsertions":105,"sizeDeletions":-23},{"number":"3","revision":"d4e5e8e54c3391dcabef6febe815a9914f1eee6a","parents":["f72f737f0faf4fabecfa7547c4dbd3d24ce6f33c"],"ref":"refs/changes/19/3119/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1513633404,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513630549,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","type":"MODIFIED","insertions":35,"deletions":-12},{"file":"usr/src/lib/brand/lx/lx_brand/common/fork.c","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_misc.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/os/sig.c","type":"MODIFIED","insertions":11,"deletions":-4}],"sizeInsertions":105,"sizeDeletions":-23},{"number":"4","revision":"b036e0fd770de1dd266db82dad196891746e92e1","parents":["f72f737f0faf4fabecfa7547c4dbd3d24ce6f33c"],"ref":"refs/changes/19/3119/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1513633489,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1513633501,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513631426,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513630549,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clone.c","type":"MODIFIED","insertions":35,"deletions":-12},{"file":"usr/src/lib/brand/lx/lx_brand/common/fork.c","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/signal.c","type":"MODIFIED","insertions":12,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_misc.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/os/sig.c","type":"MODIFIED","insertions":11,"deletions":-4}],"sizeInsertions":105,"sizeDeletions":-23}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}