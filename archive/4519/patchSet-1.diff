commit c4a152eb1165241a263b1264a239f773117f6ef0 (refs/changes/19/4519/1)
Author: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date:   2018-07-16T18:05:24+02:00 (1 year, 3 months ago)
    
    OS-6966 SmartOS hangs in boot on bhyve

diff --git a/usr/src/cmd/bhyve/virtio.h b/usr/src/cmd/bhyve/virtio.h
index cd28f55738..e300790691 100644
--- a/usr/src/cmd/bhyve/virtio.h
+++ b/usr/src/cmd/bhyve/virtio.h
@@ -438,11 +438,21 @@ vq_interrupt(struct virtio_softc *vs, struct vqueue_info *vq)
 	if (pci_msix_enabled(vs->vs_pi))
 		pci_generate_msix(vs->vs_pi, vq->vq_msix_idx);
 	else {
+#ifndef __FreeBSD__
+		if (vs->vs_mtx && !pthread_mutex_isowned_np(vs->vs_mtx))
+		    pthread_mutex_lock(vs->vs_mtx);
+#else
 		VS_LOCK(vs);
+#endif
 		vs->vs_isr |= VTCFG_ISR_QUEUES;
 		pci_generate_msi(vs->vs_pi, 0);
 		pci_lintr_assert(vs->vs_pi);
+#ifndef __FreeBSD__
+		if (vs->vs_mtx && !pthread_mutex_isowned_np(vs->vs_mtx))
+		    pthread_mutex_unlock(vs->vs_mtx);
+#else
 		VS_UNLOCK(vs);
+#endif
 	}
 }
 
