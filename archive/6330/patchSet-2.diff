From cb5f7a06596c760cd6ef75740e213f77fdd4fb06 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Mon, 19 Aug 2019 14:53:22 -0600
Subject: [PATCH] MANTA-4287 Update node-moray to use node-fast 2.7.0 Reviewed
 by: Rui <rui@joyent.com>

---
 lib/client.js          | 8 ++++++--
 lib/fast_connection.js | 6 ++++--
 package.json           | 2 +-
 3 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/lib/client.js b/lib/client.js
index c2c08f0..49d340f 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -20,6 +20,7 @@ var util = require('util');
 
 var assert = require('assert-plus');
 var cueball = require('cueball');
+var fast = require('fast');
 var jsprim = require('jsprim');
 var libuuid = require('libuuid');
 var VError = require('verror');
@@ -88,6 +89,7 @@ function MorayClient(options) {
     assert.optionalBool(options.requireIndexes, 'options.requireIndexes');
     assert.optionalBool(options.requireOnlineReindexing,
         'options.requireOnlineReindexing');
+    assert.optionalNumber(options.crc_mode, 'options.crc_mode');
 
     coptions = parseMorayParameters(options);
     cueballOptions = coptions.cueballOptions;
@@ -100,6 +102,7 @@ function MorayClient(options) {
     this.requireIndexes = options.requireIndexes ? true : false;
     this.requireOnlineReindexing =
         options.requireOnlineReindexing ? true : false;
+    this.crc_mode = options.crc_mode || fast.FAST_CHECKSUM_V1;
 
     /* Helper objects. */
     this.log = options.log.child({
@@ -340,7 +343,8 @@ MorayClient.prototype.createFastConnection =
         'log': this.log.child({
             'component': 'FastClient',
             'backendName': backend.name
-        })
+        }),
+        'crc_mode': this.crc_mode
     }));
 };
 
diff --git a/lib/fast_connection.js b/lib/fast_connection.js
index 8b57811..885b753 100644
--- a/lib/fast_connection.js
+++ b/lib/fast_connection.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -52,6 +52,7 @@ function FastConnection(args) {
     assert.number(args.nRecentRequests, 'args.nRecentRequests');
     assert.number(args.tcpKeepAliveInitialDelay,
         'args.tcpKeepAliveInitialDelay');
+    assert.number(args.crc_mode, 'args.crc_mode');
 
     events.EventEmitter.call(this);
 
@@ -67,7 +68,8 @@ function FastConnection(args) {
         'collector': args.collector, /* Optional: artedi metrics collector */
         'log': args.log,
         'nRecentRequests': args.nRecentRequests,
-        'transport': this.fc_sock
+        'transport': this.fc_sock,
+        'crc_mode': args.crc_mode
     });
 
     /*
diff --git a/package.json b/package.json
index 72f21c1..04a9591 100644
--- a/package.json
+++ b/package.json
@@ -17,7 +17,7 @@
         "cmdutil": "^1.1.0",
         "cueball": "^2.3.0",
         "extsprintf": "^1.3.0",
-        "fast": "2.6.0",
+        "fast": "2.8.1",
         "libuuid": "0.2.1",
         "jsprim": "^1.3.0",
         "posix-getopt": "^1.0.0",
-- 
2.21.0

