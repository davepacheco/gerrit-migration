From c6549a78249a36341a8efdcccdf0428ada20d511 Mon Sep 17 00:00:00 2001
From: Isaac Davis <isaac.davis@joyent.com>
Date: Mon, 6 May 2019 23:20:57 +0000
Subject: [PATCH] MANTA-4145 Add metricPorts mdata variable to
 manta-garbage-collector

---
 Makefile                               | 10 ++++-
 boot/firstboot.sh                      | 10 ++++-
 smf/manifests/metric-ports-updater.xml | 54 ++++++++++++++++++++++++++
 smf/methods/metric-ports-updater.sh    | 44 +++++++++++++++++++++
 4 files changed, 116 insertions(+), 2 deletions(-)
 create mode 100644 smf/manifests/metric-ports-updater.xml
 create mode 100644 smf/methods/metric-ports-updater.sh

diff --git a/Makefile b/Makefile
index 2102260..0e6d565 100644
--- a/Makefile
+++ b/Makefile
@@ -60,8 +60,11 @@ BOOT_DIR =			/opt/smartdc/boot
 SAPI_MANIFESTS =		manta-garbage-collector
 SAPI_MANIFEST_DIRS =		$(SAPI_MANIFESTS:%=$(PREFIX)/sapi_manifests/%)
 
-SMF_MANIFESTS =			garbage-collector
+SMF_MANIFESTS =			garbage-collector metric-ports-updater
+SMF_METHODS = 			metric-ports-updater
+
 SMF_MANIFESTS_DIR =		$(PREFIX)/smf/manifests
+SMF_METHODS_DIR =		$(PREFIX)/smf/methods
 
 NODE_BITS =			bin/node
 NODE_DIR =			$(PREFIX)/node
@@ -72,6 +75,7 @@ INSTALL_FILES =			$(addprefix $(PROTO), \
 				$(SCRIPTS:%=$(SCRIPTS_DIR)/%) \
 				$(TEMPLATES:%=$(TEMPLATES_DIR)/%) \
 				$(SMF_MANIFESTS:%=$(SMF_MANIFESTS_DIR)/%.xml) \
+				$(SMF_METHODS:%=$(SMF_METHODS_DIR)/%.sh) \
 				$(NODE_BITS:%=$(NODE_DIR)/%) \
 				$(NODE_MODULE_INSTALL) \
 				$(COMMANDS:%=$(PREFIX)/cmd/%.js) \
@@ -87,6 +91,7 @@ INSTALL_DIRS =			$(addprefix $(PROTO), \
 				$(SCRIPTS_DIR) \
 				$(TEMPLATES_DIR) \
 				$(SMF_MANIFESTS_DIR) \
+				$(SMF_METHODS_DIR) \
 				$(BOOT_DIR) \
 				$(NODE_DIR)/bin \
 				$(NODE_DIR)/lib \
@@ -190,6 +195,9 @@ $(PROTO)$(PREFIX)/sapi_manifests/%: sapi_manifests/% | $(INSTALL_DIRS)
 $(PROTO)$(PREFIX)/smf/manifests/%.xml: smf/manifests/%.xml | $(INSTALL_DIRS)
 	$(INSTALL_FILE)
 
+$(PROTO)$(PREFIX)/smf/methods/%: smf/methods/% | $(INSTALL_DIRS)
+	$(INSTALL_FILE)
+
 
 .PHONY: release
 release: install
diff --git a/boot/firstboot.sh b/boot/firstboot.sh
index 48d6740..6f402c2 100644
--- a/boot/firstboot.sh
+++ b/boot/firstboot.sh
@@ -21,6 +21,7 @@ NAME=manta-garbage-collector
 #
 
 SVC_ROOT="/opt/smartdc/$NAME"
+METRICPORTS_SVC='metric-ports-updater'
 
 #
 # Build PATH from this list of directories.  This PATH will be used both in the
@@ -71,12 +72,19 @@ export PATH="$PATH"
 w
 EDSCRIPT
 
+#
+# Import the metric-ports-updater SMF service.
+#
+if ! svccfg import "/opt/smartdc/$NAME/smf/manifests/$METRICPORTS_SVC.xml"; then
+	fatal "could not import $METRICPORTS_SVC SMF service"
+fi
+
 #
 # Import the garbage-collector SMF service.  The manifest file creates the service
 # enabled by default.
 #
 if ! svccfg import "/opt/smartdc/$NAME/smf/manifests/garbage-collector.xml"; then
-	fatal 'could not import SMF service'
+	fatal "could not import $NAME SMF service"
 fi
 
 manta_common_setup_end
diff --git a/smf/manifests/metric-ports-updater.xml b/smf/manifests/metric-ports-updater.xml
new file mode 100644
index 0000000..251d27b
--- /dev/null
+++ b/smf/manifests/metric-ports-updater.xml
@@ -0,0 +1,54 @@
+<?xml version='1.0'?>
+<!DOCTYPE service_bundle SYSTEM '/usr/share/lib/xml/dtd/service_bundle.dtd.1'>
+<!--
+    This Source Code Form is subject to the terms of the Mozilla Public
+    License, v. 2.0. If a copy of the MPL was not distributed with this
+    file, You can obtain one at http://mozilla.org/MPL/2.0/.
+-->
+
+<!--
+    Copyright (c) 2019, Joyent, Inc.
+-->
+
+<service_bundle type='manifest' name='manta-application-metric-ports-updater'>
+    <service name='manta/application/metric-ports-updater'
+             type='service'
+             version='1'>
+        <create_default_instance enabled='true'/>
+        <single_instance/>
+
+        <dependency name='garbage-collector'
+                    grouping='optional_all'
+                    restart_on='refresh'
+                    type='service'>
+            <service_fmri value='svc:/manta/application/garbage-collector'/>
+        </dependency>
+
+        <exec_method type='method'
+                     name='start'
+                     exec='/bin/bash /opt/smartdc/manta-garbage-collector/smf/methods/metric-ports-updater.sh'
+                     timeout_seconds='30'>
+            <method_context working_directory='/opt/smartdc/manta-garbage-collector'>
+                <method_credential user='root' group='root'/>
+            </method_context>
+        </exec_method>
+
+        <exec_method name='stop'
+                     type='method'
+                     exec=':true'
+                     timeout_seconds='300'/>
+
+        <property_group name='startd'
+                        type='framework'>
+            <propval name='duration'
+                     type='astring'
+                     value='transient' />
+        </property_group>
+
+        <template>
+            <common_name>
+                <loctext xml:lang='C'>Set metricPorts mdata variable</loctext>
+            </common_name>
+        </template>
+    </service>
+</service_bundle>
diff --git a/smf/methods/metric-ports-updater.sh b/smf/methods/metric-ports-updater.sh
new file mode 100644
index 0000000..14d2815
--- /dev/null
+++ b/smf/methods/metric-ports-updater.sh
@@ -0,0 +1,44 @@
+#!/usr/bin/env bash
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright (c) 2019, Joyent, Inc.
+#
+
+#
+# This script updates the zone's metricPorts mdata variable based on the current
+# port value from garbage-collector's config file, with the intent of keeping
+# the mdata value in sync with the metric port currently being used by
+# garbage-collector. To this end, this script's SMF manifest is configured to
+# run the script every time the garbage-collector service is refreshed or
+# restarted.
+#
+
+SVC_NAME=manta-garbage-collector
+SVC_ROOT="/opt/smartdc/${SVC_NAME}"
+SAPI_CONFIG="${SVC_ROOT}/etc/config.json"
+
+set -o errexit
+set -o pipefail
+set -o xtrace
+
+if ! source "${SVC_ROOT}/scripts/util.sh"; then
+    exit 1
+fi
+
+#
+# Get the port from the sapi config file, then add 1000 to it to get the
+# metricPort to allow scraping by cmon-agent.
+#
+# Note: If the config file doesn't exist, the script will fail - but so will
+# garbage-collector itself, because it depends on the existence of the config
+# file to run.
+#
+if [[ ! -f "${SAPI_CONFIG}" ]]; then
+    fatal "SAPI config not found"
+fi
+mdata-put metricPorts $(expr $(< "${SAPI_CONFIG}" json 'port') + 1000)
-- 
2.21.0

