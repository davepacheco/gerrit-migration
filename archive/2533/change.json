{"project":"joyent/sdc-cn-agent","branch":"master","id":"I3de192c662bcb5a4e6c00cc58c0bb3011c7d330c","number":"2533","subject":"DOCKER-1064 docker cp client exiting can cause stuck zlogin","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/2533","commitMessage":"DOCKER-1064 docker cp client exiting can cause stuck zlogin\n","createdOn":1504901844,"lastUpdated":1505246215,"open":false,"status":"MERGED","comments":[{"timestamp":1504901844,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1504901846,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 19a080aba92e792c1d4e211b4e50453f2f317a26\n    \n    tweaks"},{"timestamp":1504901885,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504902802,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1504902803,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 39c74fe10b050d64bf7420f8d3ce6d9f579ff186\n    \n    update date"},{"timestamp":1504902828,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504905606,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1504912112,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1504912696,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1505172450,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 3."},{"timestamp":1505172451,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 14a4d61da15e7a7daa8c928f42bff30c5fca87b5\n    \n    DRY; give functions better names\n    \n    commit f62dd75416cd9f078e99813e701778a14692ccdb\n    \n    use stdout.setTimeout rather than rolling our own"},{"timestamp":1505172488,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505231821,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1505240863,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 4."},{"timestamp":1505240865,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit b177714b72f9967b44a767cd58e26860b18c3e2a\n    \n    bump DATA_TIMEOUT_MS to 30s"},{"timestamp":1505240896,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505240996,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1505246215,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"4","revision":"3de192c662bcb5a4e6c00cc58c0bb3011c7d330c","parents":["536e9b972079342705c51240fafc1c43e614717c"],"ref":"refs/changes/33/2533/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1505240863,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505240896,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505240996,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505240996,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"SUBM","value":"1","grantedOn":1505246215,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":26,"deletions":-13}],"sizeInsertions":26,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"89f29ca6641dffebfbb86f69c7f3407ce29bee9d","parents":["536e9b972079342705c51240fafc1c43e614717c"],"ref":"refs/changes/33/2533/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1504901844,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504901885,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":32,"deletions":-6}],"sizeInsertions":32,"sizeDeletions":-6},{"number":"2","revision":"7e020707ef9e496afe4cc8453afc60da2c75b891","parents":["536e9b972079342705c51240fafc1c43e614717c"],"ref":"refs/changes/33/2533/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1504902802,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504902828,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/docker-stdio.js","line":335,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Can\u0027t you just set a timeout for the max length of time the zlogin gtar process can run - then streamProc.kill() it?\n\nsetTimeout(function cleanupIdleProcess() {\n  streamProc.kill();\n}, 60 * 60 * 1000);"},{"file":"lib/docker-stdio.js","line":335,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"If we set a timeout on the process being idle, we\u0027d still hit the issue we\u0027re trying to address where, because we have a tar process running on files in that zone, the zone is prevent from shutting down (except in this case, after an hour)"},{"file":"lib/docker-stdio.js","line":335,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Ah - that is indeed troublesome then.\n\nHow does this handle a long running gtar process, i.e. handling big files? Wouldn\u0027t this trigger the 5 second timeout?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":33,"deletions":-7}],"sizeInsertions":33,"sizeDeletions":-7},{"number":"3","revision":"0eeab53253cb24ab04c262995b2d46681b46e4b0","parents":["536e9b972079342705c51240fafc1c43e614717c"],"ref":"refs/changes/33/2533/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1505172450,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505172488,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/docker-stdio.js","line":35,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I was thinking this value needs to be larger (maybe 30 seconds)?\n\nAs there could be a tar operation (e.g. on a slow CN) where no tar data is sent back in that 5 second period?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":26,"deletions":-13}],"sizeInsertions":26,"sizeDeletions":-13},{"number":"4","revision":"3de192c662bcb5a4e6c00cc58c0bb3011c7d330c","parents":["536e9b972079342705c51240fafc1c43e614717c"],"ref":"refs/changes/33/2533/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1505240863,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505240896,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1505246215,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505240996,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505240996,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":26,"deletions":-13}],"sizeInsertions":26,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}