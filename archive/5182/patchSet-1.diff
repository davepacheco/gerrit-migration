From 5fee5c1b309608c29db70deb9e53ea910dfb7e9a Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Mon, 3 Dec 2018 17:35:15 -0800
Subject: [PATCH] TRITON-1002 apm could avoid moving all data across
 filesystems

---
 bin/apm.js   | 17 +++++++++--------
 package.json |  2 +-
 2 files changed, 10 insertions(+), 9 deletions(-)

diff --git a/bin/apm.js b/bin/apm.js
index 427ff55..7aac7d2 100755
--- a/bin/apm.js
+++ b/bin/apm.js
@@ -6,7 +6,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -21,7 +21,6 @@
 var async = require('async');
 var mkdirp = require('mkdirp');
 var fs = require('fs');
-var createHash = require('crypto').createHash;
 var assert = require('assert');
 var execFile = require('child_process').execFile;
 var exec = require('child_process').exec;
@@ -31,13 +30,14 @@ var log4js = require('log4js');
 var tty = require('tty');
 
 var prefix = '/opt/smartdc/agents';
-var tmp = '/var/tmp';
 var modules = 'lib/node_modules';
-var installdir = prefix + '/' + modules;
+
 var bindir = prefix + '/bin';
-var smfdir = prefix + '/smf';
-var etcdir = prefix + '/etc';
 var dbdir = prefix + '/db';
+var etcdir = prefix + '/etc';
+var installdir = prefix + '/' + modules;
+var smfdir = prefix + '/smf';
+var tmp = prefix + '/tmp';
 
 log4js.clearAppenders();
 var isatty = tty.isatty(process.stdout.fd);
@@ -279,7 +279,7 @@ function installPackage(toInstall, cb) {
     var thingdir;
     var installeddir;
     var packageJson;
-    var packagetmp = localtmp+'/package';
+    var packagetmp = localtmp + '/package';
 
     async.waterfall([
         function (callback) {
@@ -298,6 +298,7 @@ function installPackage(toInstall, cb) {
                 }
 
                 if (stat.isDirectory()) {
+                    log.warn('Installing from a directory is deprecated');
                     execFile(
                         '/usr/bin/cp',
                         [ '-Pr', toInstall, packagetmp + '/pkg' ],
@@ -395,7 +396,7 @@ function installPackage(toInstall, cb) {
         },
         function (callback) {
             process.chdir(installeddir);
-            // Move the unpacked package directory into its final home.
+            // Remove the temp directory.
             execFile('/usr/bin/rm', [ '-fr', localtmp ],
                 function (error, stdout, stderr) {
                     log.info('Deleting temp directory: %s', localtmp);
diff --git a/package.json b/package.json
index f051908..a95d454 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "agents_core",
   "description": "Joyent SmartDC Agent Core",
-  "version": "2.1.0",
+  "version": "2.2.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

