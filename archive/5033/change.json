{"project":"joyent/illumos-joyent","branch":"master","id":"I17834e4dce6dc954b73e7b8ec4a2d6b2688ab322","number":"5033","subject":"OS-7358 Would like a refhash walker Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/5033","commitMessage":"OS-7358 Would like a refhash walker\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1541531132,"lastUpdated":1542056698,"open":false,"status":"MERGED","comments":[{"timestamp":1541531132,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1541786206,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1541788664,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1541792032,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1541795430,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1541795442,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1541798047,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1541801917,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3."},{"timestamp":1541806051,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1542047995,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1542056647,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1542056672,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1542056698,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jason King"}],"currentPatchSet":{"number":"5","revision":"17834e4dce6dc954b73e7b8ec4a2d6b2688ab322","parents":["aa694ffb2f51c06ac16cadc3685f0e847b680409"],"ref":"refs/changes/33/5033/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1542056672,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541806051,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542047995,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1542056698,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/genunix/genunix.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","type":"ADDED","insertions":61,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","type":"ADDED","insertions":35,"deletions":0}],"sizeInsertions":103,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"8366f6fd449f0dd9e4664a6af4eaadb03d09a852","parents":["40fc639cb57bbbbb360437ad5d4934c7635d14a8"],"ref":"refs/changes/33/5033/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1541531132,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":42,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Does this need to be UM_GC to make sure that if someone hits ctrl+c in the middle of the walker that this doesn\u0027t get lost? Or are you gauranteed that in the face of an interrupt that someone will call refhash_walk_fini()?"},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":42,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I\u0027m not sure -- it seems reasonable to think the _fini() callback (if present) should always get invoked, regardless of how the walker is ended.  The mdb docs though aren\u0027t very clear on this.  So probably better to be safe than sorry here."},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":42,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The module programming API says:\n\nUM_GC\n\n    Garbage-collect allocation automatically at the end of this debugger command. The caller should not subsequently call mdb_free on this block, as the debugger will take care of deallocation automatically. All memory allocation from within a dcmd must use UM_GC so that if the dcmd is interrupted by the user, the debugger can garbage-collect the memory.\n\nso I think we probably do need to."},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":42,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I was a bit vague in my response -- sorry about that --  the \u0027better safe than sorry\u0027 was referring to adding the UM_GC flag (and remove the _fini function since it wouldn\u0027t be needed) if only out of caution.   The manual only talks about dcmds, not walkers (I at least consider them two different, but related things).  dcmds don\u0027t have a fini method while walkers do, so dcmds would need an alternate way to clean themselves up if interrupted, while at least in theory walkers would not.\n\nRegardless of that though, even if it\u0027s not actually necessary, it does the right thing, so might as well go the safer route -- I intend to do that."},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":61,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s been a little while since I\u0027ve looked at this, but don\u0027t we need to be doing a layered walk of each list_t entry in the refhash_t? It seems like we\u0027ll walk the first entry, but not subsequent ones. I would have expected us to see rh_bucket_count somewhere here to determine how many of the list_t entries of rh_buckets to walk. Is this happening through some other way?"},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":61,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"There is a global list_t of all objects (rehash_t-\u003erh_objs) in addition to the bucket list_t\u0027s.  This is walking the global list to avoid having to walk all the buckets."},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","line":26,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Any reason we don\u0027t include mdb/mdb_modapi.h?"},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","line":26,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Just out of a habit -- we don\u0027t need the definition or any function prototypes or any CPP symbols, so it avoids a dependency between the header files."},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","line":26,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, fair enough."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/genunix/genunix.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","type":"ADDED","insertions":68,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","type":"ADDED","insertions":36,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-1},{"number":"2","revision":"c9ae1f12e0113cc015aeec014194460a0d227eb1","parents":["40fc639cb57bbbbb360437ad5d4934c7635d14a8"],"ref":"refs/changes/33/5033/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1541795442,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","line":48,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"You shouldn\u0027t call umem_free on something you\u0027ve allocated with UM_GC."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/genunix/genunix.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","type":"ADDED","insertions":62,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","type":"ADDED","insertions":35,"deletions":0}],"sizeInsertions":104,"sizeDeletions":-1},{"number":"3","revision":"b77190c67d92adbeb6a9e04af272c83e09a6872b","parents":["40fc639cb57bbbbb360437ad5d4934c7635d14a8"],"ref":"refs/changes/33/5033/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1541801917,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541806051,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542047995,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/genunix/genunix.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","type":"ADDED","insertions":61,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","type":"ADDED","insertions":35,"deletions":0}],"sizeInsertions":103,"sizeDeletions":-1},{"number":"4","revision":"4952c833a161fe73fc548fe2070f41dcaa8b5549","parents":["40fc639cb57bbbbb360437ad5d4934c7635d14a8"],"ref":"refs/changes/33/5033/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1542056647,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541806051,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542047995,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/genunix/genunix.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","type":"ADDED","insertions":61,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","type":"ADDED","insertions":35,"deletions":0}],"sizeInsertions":103,"sizeDeletions":-1},{"number":"5","revision":"17834e4dce6dc954b73e7b8ec4a2d6b2688ab322","parents":["aa694ffb2f51c06ac16cadc3685f0e847b680409"],"ref":"refs/changes/33/5033/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1542056672,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1541806051,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1542056698,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542047995,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/genunix/genunix.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.c","type":"ADDED","insertions":61,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/refhash.h","type":"ADDED","insertions":35,"deletions":0}],"sizeInsertions":103,"sizeDeletions":-1}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}]}