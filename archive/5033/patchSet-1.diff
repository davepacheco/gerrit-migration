From 8366f6fd449f0dd9e4664a6af4eaadb03d09a852 Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Thu, 12 Jul 2018 22:37:06 +0000
Subject: [PATCH] OS-7358 Would like a refhash walker

---
 .../mdb/common/modules/genunix/Makefile.files |  3 +-
 .../cmd/mdb/common/modules/genunix/genunix.c  |  5 ++
 .../cmd/mdb/common/modules/genunix/refhash.c  | 68 +++++++++++++++++++
 .../cmd/mdb/common/modules/genunix/refhash.h  | 36 ++++++++++
 4 files changed, 111 insertions(+), 1 deletion(-)
 create mode 100644 usr/src/cmd/mdb/common/modules/genunix/refhash.c
 create mode 100644 usr/src/cmd/mdb/common/modules/genunix/refhash.h

diff --git a/usr/src/cmd/mdb/common/modules/genunix/Makefile.files b/usr/src/cmd/mdb/common/modules/genunix/Makefile.files
index 5d9cf9bb8f..07e5c2fa14 100644
--- a/usr/src/cmd/mdb/common/modules/genunix/Makefile.files
+++ b/usr/src/cmd/mdb/common/modules/genunix/Makefile.files
@@ -21,7 +21,7 @@
 #
 # Copyright 2011 Nexenta Systems, Inc.  All rights reserved.
 # Copyright (c) 1999, 2010, Oracle and/or its affiliates. All rights reserved.
-# Copyright 2016 Joyent, Inc.
+# Copyright 2018 Joyent, Inc.
 # Copyright (c) 2013 by Delphix. All rights reserved.
 #
 
@@ -72,6 +72,7 @@ GENUNIX_SRCS =		\
 	nvpair.c	\
 	pg.c		\
 	rctl.c		\
+	refhash.c	\
 	sobj.c		\
 	streams.c	\
 	sysevent.c	\
diff --git a/usr/src/cmd/mdb/common/modules/genunix/genunix.c b/usr/src/cmd/mdb/common/modules/genunix/genunix.c
index b3b8aea9bc..4cc98cd919 100644
--- a/usr/src/cmd/mdb/common/modules/genunix/genunix.c
+++ b/usr/src/cmd/mdb/common/modules/genunix/genunix.c
@@ -97,6 +97,7 @@
 #include "nvpair.h"
 #include "pg.h"
 #include "rctl.h"
+#include "refhash.h"
 #include "sobj.h"
 #include "streams.h"
 #include "sysevent.h"
@@ -4687,6 +4688,10 @@ static const mdb_walker_t walkers[] = {
 	{ "rctl_val", "given a rctl_t, walk all rctl_val entries associated",
 		rctl_val_walk_init, rctl_val_walk_step },
 
+	/* from refhash.c */
+	{ REFHASH_WALK_NAME, REFHASH_WALK_DESC,
+		refhash_walk_init, refhash_walk_step, refhash_walk_fini },
+
 	/* from sobj.c */
 	{ "blocked", "walk threads blocked on a given sobj",
 		blocked_walk_init, blocked_walk_step, NULL },
diff --git a/usr/src/cmd/mdb/common/modules/genunix/refhash.c b/usr/src/cmd/mdb/common/modules/genunix/refhash.c
new file mode 100644
index 0000000000..6a3c442d7b
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/genunix/refhash.c
@@ -0,0 +1,68 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright 2018, Joyent, Inc.
+ */
+
+#include <mdb/mdb_modapi.h>
+#include <mdb/mdb_ctf.h>
+
+#include <inttypes.h>
+#include <sys/refhash.h>
+
+typedef struct refhash_walk_data {
+	size_t	rwd_offset;
+} refhash_walk_data_t;
+
+int
+refhash_walk_init(mdb_walk_state_t *wsp)
+{
+	refhash_t refh = { 0 };
+	refhash_walk_data_t *rwd;
+	int offset;
+
+	/*  mdb_ctf_offsetof_by_name() will print any errors */
+	if ((offset = mdb_ctf_offsetof_by_name("refhash_t", "rh_objs")) == -1)
+		return (WALK_ERR);
+
+	if (mdb_vread(&refh, sizeof (refhash_t), wsp->walk_addr) == -1) {
+		mdb_warn("failed to read refhash_t at %#lx", wsp->walk_addr);
+		return (WALK_ERR);
+	}
+
+	rwd = wsp->walk_data = mdb_zalloc(sizeof (*rwd), UM_SLEEP);
+	rwd->rwd_offset = refh.rh_link_off;
+
+	wsp->walk_addr += offset;
+	if (mdb_layered_walk("list", wsp) == -1) {
+		mdb_warn("can't walk refhash_t");
+		mdb_free(rwd, sizeof (*rwd));
+		return (WALK_ERR);
+	}
+
+	return (WALK_NEXT);
+}
+
+int
+refhash_walk_step(mdb_walk_state_t *wsp)
+{
+	refhash_walk_data_t *rwd = wsp->walk_data;
+	uintptr_t addr = wsp->walk_addr - rwd->rwd_offset;
+
+	return (wsp->walk_callback(addr, wsp->walk_layer, wsp->walk_cbdata));
+}
+
+void
+refhash_walk_fini(mdb_walk_state_t *wsp)
+{
+	mdb_free(wsp->walk_data, sizeof (refhash_walk_data_t));
+}
diff --git a/usr/src/cmd/mdb/common/modules/genunix/refhash.h b/usr/src/cmd/mdb/common/modules/genunix/refhash.h
new file mode 100644
index 0000000000..53f89da568
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/genunix/refhash.h
@@ -0,0 +1,36 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright 2018, Joyent, Inc.
+ */
+
+#ifndef _REFHASH_H
+#define	_REFHASH_H
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+#define	REFHASH_WALK_NAME "refhash"
+#define	REFHASH_WALK_DESC "walk a refhash"
+
+struct mdb_walk_state;
+
+extern int refhash_walk_init(struct mdb_walk_state *);
+extern int refhash_walk_step(struct mdb_walk_state *);
+extern void refhash_walk_fini(struct mdb_walk_state *);
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif /* _REFHASH_H */
-- 
2.21.0

