{"project":"joyent/illumos-joyent","branch":"master","id":"I6bee88732fad06d22bee440ff6f2aeaeae2937a1","number":"6523","subject":"OS-7869 want kstat mdb module","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/6523","commitMessage":"OS-7869 want kstat mdb module\n","createdOn":1561751234,"lastUpdated":1562085812,"open":true,"status":"NEW","comments":[{"timestamp":1561751234,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1561751334,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1561752013,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1561754639,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(18 comments)\n\nThanks for putting this together, it looks like it\u0027ll be pretty useful."},{"timestamp":1561997087,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1561997275,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(6 comments)\n\nThanks for taking a look, Robert! Let me know what you think of the latest changes."},{"timestamp":1561998516,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1562001999,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(8 comments)\n\nOut of interest, are you planning to add some actual ks_data digging later?"},{"timestamp":1562084014,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5."},{"timestamp":1562084633,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 5:\n\n(4 comments)\n\nThanks, John! Yes, I\u0027m planning to add \u0027addr::kstat_named\u0027 or something similar in a later commit. If you have something specific in mind as far as verbiage or output formatting, let me know."},{"timestamp":1562085307,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1\n\n(2 comments)"},{"timestamp":1562085812,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(6 comments)"}],"currentPatchSet":{"number":"5","revision":"6bee88732fad06d22bee440ff6f2aeaeae2937a1","parents":["9f27b084492b24583dbcc44e59ce9eaacd78ed68"],"ref":"refs/changes/23/6523/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1562084014,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562085307,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.c","line":233,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I realize that mdb doesn\u0027t have a signed version of this, but is strict integer truncation what we want here? If someone passes something outside of the range of an integer, shouldn\u0027t we instead warn about that and error rather that continue processing it? I think this would lead to really confusing behavior. For example, this means that if I pass UINT64_MAX or INT64_MAX, I get -1. If I pass (1 \u003c\u003c 33) + 5, I\u0027ll get 5. I think we should probably be rigorous here. It may even be worth having an signed mdb conversion since our goal is a signed value."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.h","line":48,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I suppose this is private to MDB instead of a module API, so this is OK."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_modapi.h","line":252,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I noticed that we\u0027re changing this but not revving the module API in any way. Have you gone through and figured out what will happen with newer modules at different versions of the module API and how that will interact with them using this value and the fact that older MDB will think it\u0027s OK for that to be loaded and run?\n\nAlso, do we really want this to be an arbitrary sized integer? That means we\u0027ll have to change its actual size to match the ABI. Maybe this should be an int32_t if that\u0027s actually what you want?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":75,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we spell out the error message please? Also, if we\u0027re going to constrain it, I\u0027d recommend that we include in parens what the actual value is. So, for example:\n\n\"provided module, class, and name lengths must be less than KSTAT_STRLEN (%u)\\n\""},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":124,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we add an examples section like a manual page?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/mdb/Makefile.common","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.c","type":"MODIFIED","insertions":18,"deletions":-3},{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/cmd/mdb/common/mdb/mdb_modapi.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","type":"ADDED","insertions":191,"deletions":0},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","type":"ADDED","insertions":27,"deletions":0},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","type":"ADDED","insertions":27,"deletions":0}],"sizeInsertions":274,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"7253f266441de20955d07b29f46d36e5cfc13fb7","parents":["9f27b084492b24583dbcc44e59ce9eaacd78ed68"],"ref":"refs/changes/23/6523/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1561751234,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/mdb/Makefile.common","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat","type":"ADDED","insertions":31,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","type":"ADDED","insertions":192,"deletions":0},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","type":"ADDED","insertions":40,"deletions":0},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":306,"sizeDeletions":-1},{"number":"2","revision":"0cc48ed9f75b89d5d027d94891793708b8e3b361","parents":["9f27b084492b24583dbcc44e59ce9eaacd78ed68"],"ref":"refs/changes/23/6523/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1561751334,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/mdb/Makefile.common","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat","type":"ADDED","insertions":31,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","type":"ADDED","insertions":192,"deletions":0},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","type":"ADDED","insertions":40,"deletions":0},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":306,"sizeDeletions":-1},{"number":"3","revision":"91e629951ef0c3fe1e95acf0feaa2a3205cce171","parents":["9f27b084492b24583dbcc44e59ce9eaacd78ed68"],"ref":"refs/changes/23/6523/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1561752013,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat","line":31,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is this really necessary now? Isn\u0027t lint gone? I suspect you don\u0027t need this file at all."},{"file":"usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat","line":31,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Perfect!"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":2,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please use the new CCDL header in usr/src/prototypes/prototype.c."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":2,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Nice. TIL new file prototypes! Thanks."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":21,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor nit, but conventionally there\u0027s a blank line between the two blocks."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":30,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Any reason there isn\u0027t a typedef for this?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":34,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This is unused. Did you intend to use this with the mdb_ekstat_t so that way we weren\u0027t embedding the full kstat structure of the current implementation below? mdb_ctf_vread can go on for nested members, so if all we care about are those members plus ks_class, then there\u0027s no reason to use embed the exact structure size and implementation of the kstat_t in the dmod."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":34,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah. I assumed that the CTF functionality needed this to operate properly. It makes sense that we don\u0027t though. The way that this is written doesn\u0027t really stand to reason anyway."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":34,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Well, there\u0027s still value to having something like this here. As I pointed out, right now you\u0027re embedding the structure and size of the ekstat_t and by implication the kstat_t that is used in the kernel. If this were to change for whatever reason, it would break this module if you were debugging an older/newer dump. If you do have nested types that you define with something like this, then you\u0027ll be able to survive that."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":54,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This warning gag for lint isn\u0027t required any more."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":92,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Minor, but illumos C style asks for this to be on the previous line."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":94,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I feel like we should probably have a warning message printed here for the cases where we can\u0027t read it and indicate that. Otherwise someone might just get no output."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":110,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Since these are all using a strncmp, should we make sure that the user\u0027s requested items aren\u0027t too long here?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":140,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Since we know this symbol is supposed to be in the unix module, should we actually ask it to search everything versus just the one that we want?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":140,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, nice. I\u0027m sure this is a basic question, but is there a way to determine which module a symbol belongs to?\n\nSince you mentioned the unix module I was able to find it by running \u0027::nm unix ! grep kstat_avl_bykid\u0027, but that doesn\u0027t seem optimal."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":140,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"kstat_avl_bykid::nm -f obj"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":141,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"You don\u0027t want the \\n here. mdb_warn uses the presence of the \\n to indicate whether or not it should concatenate the error message that was found (kind of like warn(3C) adds errno)."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":148,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027d nix the\\n so you get the underlying error here as well."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":162,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m not sure if this comment is necessary. But if you find it helpful, no reason to get rid of it."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":169,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there any particular reason you don\u0027t have a filter based on the instance like the kstat command line tool?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":169,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I\u0027ve personally never found it particularly useful, but we should include it to maintain consistency with the CLI tool. Let me know what you think of the argument parsing I added for this in the latest patch set. It feels clunky to me."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":174,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So conventionally just the synopsis of options and arguments should be here. The dcmd structure has an optional usage method. An example of this is prtconf_help(). So you should break this up into just a synopsis and the actual help message. That way when someone runs ::help kstat they\u0027ll get all this detailed information you\u0027ve written up."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":174,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"We had a separate help function for this in an earlier iteration. I was following the zfs \u0027::help spa\u0027 dcmd\u0027s lead here."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":174,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, I understand where you\u0027re coming from. I\u0027m not sure that\u0027s the right lead. Especially as some of the feedback I\u0027ve had is around discoverability, so I think going through and adding more explanations and examples (ala ::help typedef) would be useful. So thanks for adding this as a separate function."},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","line":1,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please use the new prototype file in usr/src/prototypes/prototype.Makefile for the CDDL header."},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","line":40,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why is this required? Is there a reason we can\u0027t actually fix the warning that this is indicating?"},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","line":1,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please see the notes in the x86 version of this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/mdb/Makefile.common","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat","type":"ADDED","insertions":31,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","type":"ADDED","insertions":192,"deletions":0},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","type":"ADDED","insertions":40,"deletions":0},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","type":"ADDED","insertions":40,"deletions":0}],"sizeInsertions":306,"sizeDeletions":-1},{"number":"4","revision":"fb7c32e3cf11d7aadff79fa268ecbfaec9d0dc84","parents":["9f27b084492b24583dbcc44e59ce9eaacd78ed68"],"ref":"refs/changes/23/6523/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1561997087,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":21,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, shouldn\u0027t this be mdb_kstat_flags... and MDB_KSTAT... ?\nOr just drop it, since there\u0027s only one flag?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":21,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sure, I\u0027ll namespace these with mdb/MDB.\n\nI was planning to use this for other flags in the near future, so I\u0027d like to keep this where it is if that\u0027s agreeable."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":42,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Can we make all these const chars?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":57,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We already report the failure (and the errno) as part of the walk, I don\u0027t think this line is necessary."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":69,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"You need a NULL terminator at the end of these options"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":77,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"They must be \u003c KSTAT_STRLEN:\n\n 62 #define KSTAT_STRLEN    31      /* 30 chars + NULL; must be 16 * n - 1 */        \n\nSo we can only fit 30 chars."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":82,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Are you missing an INT version of MDB_OPT_UINTPTR_SET? If so, I\u0027d prefer you to use that, then cast to int as needed. (Or, if you like, add OPT_INT_SET)."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":82,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yes, for this specific case a signed getopt (with a bool so we don\u0027t need the magic number thing) would be ideal.\n\nI added MDB_OPT_INT_SET in the latest patch set. Let me know what you think of that. If that looks good I\u0027ll open a separate ticket (and add it to this commit message) so the change is recorded."},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":163,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Would this be slightly more friendly if we used kstat_avl_byname ?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":163,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It appears so. Using _byname appears to sort alphabetically first by module, then by name."},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","line":25,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think this is dangling"},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","line":25,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It is! Do we have a way to verify sparc builds?"},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","line":25,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Essentially no. We just wait for Peter Tribble to fix it up for us."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/mdb/Makefile.common","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","type":"ADDED","insertions":205,"deletions":0},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","type":"ADDED","insertions":27,"deletions":0},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","type":"ADDED","insertions":28,"deletions":0}],"sizeInsertions":263,"sizeDeletions":-1},{"number":"5","revision":"6bee88732fad06d22bee440ff6f2aeaeae2937a1","parents":["9f27b084492b24583dbcc44e59ce9eaacd78ed68"],"ref":"refs/changes/23/6523/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1562084014,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562085307,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.c","line":233,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I realize that mdb doesn\u0027t have a signed version of this, but is strict integer truncation what we want here? If someone passes something outside of the range of an integer, shouldn\u0027t we instead warn about that and error rather that continue processing it? I think this would lead to really confusing behavior. For example, this means that if I pass UINT64_MAX or INT64_MAX, I get -1. If I pass (1 \u003c\u003c 33) + 5, I\u0027ll get 5. I think we should probably be rigorous here. It may even be worth having an signed mdb conversion since our goal is a signed value."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.h","line":48,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I suppose this is private to MDB instead of a module API, so this is OK."},{"file":"usr/src/cmd/mdb/common/mdb/mdb_modapi.h","line":252,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I noticed that we\u0027re changing this but not revving the module API in any way. Have you gone through and figured out what will happen with newer modules at different versions of the module API and how that will interact with them using this value and the fact that older MDB will think it\u0027s OK for that to be loaded and run?\n\nAlso, do we really want this to be an arbitrary sized integer? That means we\u0027ll have to change its actual size to match the ABI. Maybe this should be an int32_t if that\u0027s actually what you want?"},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":75,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we spell out the error message please? Also, if we\u0027re going to constrain it, I\u0027d recommend that we include in parens what the actual value is. So, for example:\n\n\"provided module, class, and name lengths must be less than KSTAT_STRLEN (%u)\\n\""},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","line":124,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we add an examples section like a manual page?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/mdb/Makefile.common","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.c","type":"MODIFIED","insertions":18,"deletions":-3},{"file":"usr/src/cmd/mdb/common/mdb/mdb_argvec.h","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"usr/src/cmd/mdb/common/mdb/mdb_modapi.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/mdb/common/modules/kstat/kstat.c","type":"ADDED","insertions":191,"deletions":0},{"file":"usr/src/cmd/mdb/intel/amd64/kstat/Makefile","type":"ADDED","insertions":27,"deletions":0},{"file":"usr/src/cmd/mdb/sparc/v9/kstat/Makefile","type":"ADDED","insertions":27,"deletions":0}],"sizeInsertions":274,"sizeDeletions":-9}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}