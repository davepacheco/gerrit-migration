From 7253f266441de20955d07b29f46d36e5cfc13fb7 Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody@kkantor.com>
Date: Fri, 28 Jun 2019 16:24:40 +0000
Subject: [PATCH] OS-7896 want kstat mdb module

---
 manifest                                      |   1 +
 usr/src/cmd/mdb/Makefile.common               |   3 +-
 .../mdb/common/modules/kstat/Makefile.kstat   |  31 +++
 usr/src/cmd/mdb/common/modules/kstat/kstat.c  | 192 ++++++++++++++++++
 usr/src/cmd/mdb/intel/amd64/kstat/Makefile    |  40 ++++
 usr/src/cmd/mdb/sparc/v9/kstat/Makefile       |  40 ++++
 6 files changed, 306 insertions(+), 1 deletion(-)
 create mode 100644 usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat
 create mode 100644 usr/src/cmd/mdb/common/modules/kstat/kstat.c
 create mode 100644 usr/src/cmd/mdb/intel/amd64/kstat/Makefile
 create mode 100644 usr/src/cmd/mdb/sparc/v9/kstat/Makefile

diff --git a/manifest b/manifest
index 73246a034b..b32f1efcde 100644
--- a/manifest
+++ b/manifest
@@ -9836,6 +9836,7 @@ f usr/lib/mdb/kvm/amd64/ip.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/ipc.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/ipp.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/krtld.so 0555 root sys
+f usr/lib/mdb/kvm/amd64/kstat.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/lofs.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/logindmux.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/mac.so 0555 root sys
diff --git a/usr/src/cmd/mdb/Makefile.common b/usr/src/cmd/mdb/Makefile.common
index 4fc3f3d317..2d15fe5896 100644
--- a/usr/src/cmd/mdb/Makefile.common
+++ b/usr/src/cmd/mdb/Makefile.common
@@ -21,7 +21,7 @@
 
 #
 # Copyright (c) 1999, 2010, Oracle and/or its affiliates. All rights reserved.
-# Copyright 2016 Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 # Copyright 2018 Nexenta Systems, Inc.
 #
 
@@ -77,6 +77,7 @@ COMMON_MODULES_KVM = \
 	ipc \
 	ipp \
 	krtld \
+	kstat \
 	lofs \
 	logindmux \
 	mac \
diff --git a/usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat b/usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat
new file mode 100644
index 0000000000..86911c7d42
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/kstat/Makefile.kstat
@@ -0,0 +1,31 @@
+#
+# CDDL HEADER START
+#
+# The contents of this file are subject to the terms of the
+# Common Development and Distribution License, Version 1.0 only
+# (the "License").  You may not use this file except in compliance
+# with the License.
+#
+# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
+# or http://www.opensolaris.org/os/licensing.
+# See the License for the specific language governing permissions
+# and limitations under the License.
+#
+# When distributing Covered Code, include this CDDL HEADER in each
+# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
+# If applicable, add the following below this CDDL HEADER, with the
+# fields enclosed by brackets "[]" replaced with your own identifying
+# information: Portions Copyright [yyyy] [name of copyright owner]
+#
+# CDDL HEADER END
+#
+#
+# Copyright 2019 Joyent, Inc.
+#
+
+# lint complains about unused inline functions, even though
+# they are "inline", not "static inline", with "extern inline"
+# implementations provided where needed in libraries and the
+# kernel.
+LINTFLAGS += -erroff=E_STATIC_UNUSED
+LINTFLAGS64 += -erroff=E_STATIC_UNUSED
diff --git a/usr/src/cmd/mdb/common/modules/kstat/kstat.c b/usr/src/cmd/mdb/common/modules/kstat/kstat.c
new file mode 100644
index 0000000000..e8fdba5e13
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/kstat/kstat.c
@@ -0,0 +1,192 @@
+/*
+ * CDDL HEADER START
+ *
+ * The contents of this file are subject to the terms of the
+ * Common Development and Distribution License (the "License").
+ * You may not use this file except in compliance with the License.
+ *
+ * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
+ * or http://www.opensolaris.org/os/licensing.
+ * See the License for the specific language governing permissions
+ * and limitations under the License.
+ *
+ * When distributing Covered Code, include this CDDL HEADER in each
+ * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
+ * If applicable, add the following below this CDDL HEADER, with the
+ * fields enclosed by brackets "[]" replaced with your own identifying
+ * information: Portions Copyright [yyyy] [name of copyright owner]
+ *
+ * CDDL HEADER END
+ */
+/*
+ * Copyright 2019 Joyent, Inc.
+ */
+
+#include <mdb/mdb_ctf.h>
+#include <sys/mdb_modapi.h>
+
+#include <sys/kstat.h>
+
+enum kstat_flags {
+	KSTAT_FLAG_ADDRESS	= 1 << 0,
+};
+
+typedef struct mdb_kstat {
+	char	ks_module[KSTAT_STRLEN];
+	int	ks_instance;
+	char	ks_name[KSTAT_STRLEN];
+} mdb_kstat_t;
+
+/*
+ * The kstat framework wraps kstat_t in an ekstat_t struct that holds some
+ * internal data.
+ */
+typedef struct mdb_ekstat {
+	kstat_t	e_ks;
+} mdb_ekstat_t;
+
+/*
+ * ::kstat
+ *
+ * Print some relevant fields from kstats on the system.
+ *
+ */
+/* ARGSUSED */
+static int
+kstat_print(uintptr_t addr, uint_t flags, int argc, const mdb_arg_t *argv)
+{
+	char *mod, *name, *class;
+	char *search_mod = NULL;
+	char *search_name = NULL;
+	char *search_class = NULL;
+	int output_flags;
+
+	mdb_ekstat_t ekstat;
+
+	if (!(flags & DCMD_ADDRSPEC)) {
+		if (mdb_walk_dcmd("kstat", "kstat", argc, argv) == -1) {
+			mdb_warn("can't walk kstats");
+			return (DCMD_ERR);
+		}
+
+		return (DCMD_OK);
+	}
+
+	if (mdb_getopts(argc, argv,
+	    'm', MDB_OPT_STR, &search_mod,
+	    'n', MDB_OPT_STR, &search_name,
+	    'c', MDB_OPT_STR, &search_class,
+	    'a', MDB_OPT_SETBITS, KSTAT_FLAG_ADDRESS, &output_flags) != argc) {
+		return (DCMD_USAGE);
+	}
+
+	if (DCMD_HDRSPEC(flags)) {
+		if (output_flags & KSTAT_FLAG_ADDRESS) {
+			mdb_printf("%<u>%-?s %</u>", "ADDRESS");
+		}
+		mdb_printf("%<u>%-10s %-10s %-20s %-15s%</u>\n", "MODULE",
+		    "INSTANCE", "NAME", "CLASS");
+	}
+
+	if (mdb_ctf_vread(&ekstat, "ekstat_t", "mdb_ekstat_t", addr, 0)
+	    == -1) {
+
+		return (DCMD_ERR);
+	}
+
+	mod = ekstat.e_ks.ks_module;
+	name = ekstat.e_ks.ks_name;
+	class = ekstat.e_ks.ks_class;
+
+	/*
+	 * Short circuit if the kstat in question doesn't match the user's
+	 * filter(s).
+	 */
+	if ((search_mod != NULL &&
+	    strncmp(mod, search_mod, KSTAT_STRLEN) != 0) ||
+	    (search_name != NULL &&
+	    strncmp(name, search_name, KSTAT_STRLEN) != 0) ||
+	    (search_class != NULL &&
+	    strncmp(class, search_class, KSTAT_STRLEN) != 0)) {
+
+		return (DCMD_OK);
+	}
+
+	if (output_flags & KSTAT_FLAG_ADDRESS) {
+		mdb_printf("%0?p ", addr);
+	}
+	mdb_printf("%-10s %-10d %-20s %-15s\n", mod,
+	    ekstat.e_ks.ks_instance, name, class);
+
+	return (DCMD_OK);
+}
+
+/*
+ * ::walk kstat
+ *
+ * Walk all ekstat_t structures in the kstat AVL tree. This is nothing more than
+ * a layered avl walk.
+ */
+static int
+kstat_walk_init(mdb_walk_state_t *wsp)
+{
+	GElf_Sym sym;
+
+	if (wsp->walk_addr != 0) {
+		mdb_warn("kstat walk only supports global walks\n");
+		return (WALK_ERR);
+	}
+
+	if (mdb_lookup_by_obj(MDB_OBJ_EVERY, "kstat_avl_bykid", &sym) == -1) {
+		mdb_warn("failed to find symbol 'kstat_avl_bykid'\n");
+		return (WALK_ERR);
+	}
+
+	wsp->walk_addr = (uintptr_t)sym.st_value;
+
+	if (mdb_layered_walk("avl", wsp) == -1) {
+		mdb_warn("failed to walk 'avl'\n");
+		return (WALK_ERR);
+	}
+
+	return (WALK_NEXT);
+}
+
+static int
+kstat_walk_step(mdb_walk_state_t *wsp)
+{
+	return (wsp->walk_callback(wsp->walk_addr, NULL, wsp->walk_cbdata));
+}
+
+/*
+ * MDB module linkage information:
+ *
+ * We declare a list of structures describing our dcmds, and a function
+ * named _mdb_init to return a pointer to our module information.
+ */
+
+static const mdb_dcmd_t dcmds[] = {
+	{ "kstat", "?-a [ -m module ] [ -n name ] [ -c class ]\n"
+	    "\t-a also display an address column for each kstat\n"
+	    "\t-m search for kstats with the given module (e.g. 'zfs')\n"
+	    "\t-n search for kstats with the given name (e.g. 'zfetchstats')\n"
+	    "\t-c search for kstats with the given class (e.g. 'misc')\n",
+	    "kstat summary", kstat_print },
+	{ NULL }
+};
+
+static const mdb_walker_t walkers[] = {
+	{ "kstat", "walk all kstat structures", kstat_walk_init,
+	    kstat_walk_step, NULL },
+	{ NULL }
+};
+
+static const mdb_modinfo_t modinfo = {
+	MDB_API_VERSION, dcmds, walkers
+};
+
+const mdb_modinfo_t *
+_mdb_init(void)
+{
+	return (&modinfo);
+}
diff --git a/usr/src/cmd/mdb/intel/amd64/kstat/Makefile b/usr/src/cmd/mdb/intel/amd64/kstat/Makefile
new file mode 100644
index 0000000000..d30c2001ff
--- /dev/null
+++ b/usr/src/cmd/mdb/intel/amd64/kstat/Makefile
@@ -0,0 +1,40 @@
+#
+# CDDL HEADER START
+#
+# The contents of this file are subject to the terms of the
+# Common Development and Distribution License, Version 1.0 only
+# (the "License").  You may not use this file except in compliance
+# with the License.
+#
+# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
+# or http://www.opensolaris.org/os/licensing.
+# See the License for the specific language governing permissions
+# and limitations under the License.
+#
+# When distributing Covered Code, include this CDDL HEADER in each
+# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
+# If applicable, add the following below this CDDL HEADER, with the
+# fields enclosed by brackets "[]" replaced with your own identifying
+# information: Portions Copyright [yyyy] [name of copyright owner]
+#
+# CDDL HEADER END
+#
+#
+# Copyright 2019 Joyent, Inc.
+#
+
+MODULE = kstat.so
+MDBTGT = kvm
+
+MODSRCS = kstat.c
+
+include ../../../../Makefile.cmd
+include ../../../../Makefile.cmd.64
+include ../../Makefile.amd64
+include ../../../Makefile.module
+include ../../../common/modules/kstat/Makefile.kstat
+
+CSTD=	$(CSTD_GNU99)
+C99LMODE=	-Xc99=%all
+
+CERRWARN	+= -_gcc=-Wno-type-limits
diff --git a/usr/src/cmd/mdb/sparc/v9/kstat/Makefile b/usr/src/cmd/mdb/sparc/v9/kstat/Makefile
new file mode 100644
index 0000000000..4c6bf4dead
--- /dev/null
+++ b/usr/src/cmd/mdb/sparc/v9/kstat/Makefile
@@ -0,0 +1,40 @@
+#
+# CDDL HEADER START
+#
+# The contents of this file are subject to the terms of the
+# Common Development and Distribution License, Version 1.0 only
+# (the "License").  You may not use this file except in compliance
+# with the License.
+#
+# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
+# or http://www.opensolaris.org/os/licensing.
+# See the License for the specific language governing permissions
+# and limitations under the License.
+#
+# When distributing Covered Code, include this CDDL HEADER in each
+# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
+# If applicable, add the following below this CDDL HEADER, with the
+# fields enclosed by brackets "[]" replaced with your own identifying
+# information: Portions Copyright [yyyy] [name of copyright owner]
+#
+# CDDL HEADER END
+#
+#
+# Copyright 2019 Joyent, Inc.
+#
+
+MODULE = kstat.so
+MDBTGT = kvm
+
+MODSRCS = kstat.c
+
+include ../../../../Makefile.cmd
+include ../../../../Makefile.cmd.64
+include ../../Makefile.sparcv9
+include ../../../Makefile.module
+include ../../../common/modules/kstat/Makefile.kstat
+
+CSTD=	$(CSTD_GNU99)
+C99LMODE=	-Xc99=%all
+
+CERRWARN	+= -_gcc=-Wno-type-limits
-- 
2.21.0

