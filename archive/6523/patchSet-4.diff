From fb7c32e3cf11d7aadff79fa268ecbfaec9d0dc84 Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody@kkantor.com>
Date: Fri, 28 Jun 2019 16:24:40 +0000
Subject: [PATCH] OS-7869 want kstat mdb module

---
 manifest                                     |   1 +
 usr/src/cmd/mdb/Makefile.common              |   3 +-
 usr/src/cmd/mdb/common/modules/kstat/kstat.c | 205 +++++++++++++++++++
 usr/src/cmd/mdb/intel/amd64/kstat/Makefile   |  27 +++
 usr/src/cmd/mdb/sparc/v9/kstat/Makefile      |  28 +++
 5 files changed, 263 insertions(+), 1 deletion(-)
 create mode 100644 usr/src/cmd/mdb/common/modules/kstat/kstat.c
 create mode 100644 usr/src/cmd/mdb/intel/amd64/kstat/Makefile
 create mode 100644 usr/src/cmd/mdb/sparc/v9/kstat/Makefile

diff --git a/manifest b/manifest
index 73246a034b..b32f1efcde 100644
--- a/manifest
+++ b/manifest
@@ -9836,6 +9836,7 @@ f usr/lib/mdb/kvm/amd64/ip.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/ipc.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/ipp.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/krtld.so 0555 root sys
+f usr/lib/mdb/kvm/amd64/kstat.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/lofs.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/logindmux.so 0555 root sys
 f usr/lib/mdb/kvm/amd64/mac.so 0555 root sys
diff --git a/usr/src/cmd/mdb/Makefile.common b/usr/src/cmd/mdb/Makefile.common
index 4fc3f3d317..2d15fe5896 100644
--- a/usr/src/cmd/mdb/Makefile.common
+++ b/usr/src/cmd/mdb/Makefile.common
@@ -21,7 +21,7 @@
 
 #
 # Copyright (c) 1999, 2010, Oracle and/or its affiliates. All rights reserved.
-# Copyright 2016 Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 # Copyright 2018 Nexenta Systems, Inc.
 #
 
@@ -77,6 +77,7 @@ COMMON_MODULES_KVM = \
 	ipc \
 	ipp \
 	krtld \
+	kstat \
 	lofs \
 	logindmux \
 	mac \
diff --git a/usr/src/cmd/mdb/common/modules/kstat/kstat.c b/usr/src/cmd/mdb/common/modules/kstat/kstat.c
new file mode 100644
index 0000000000..19edfd761e
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/kstat/kstat.c
@@ -0,0 +1,205 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright 2019 Joyent, Inc.
+ */
+
+#include <mdb/mdb_ctf.h>
+#include <sys/mdb_modapi.h>
+
+#include <sys/kstat.h>
+
+typedef enum kstat_flags {
+	KSTAT_FLAG_ADDRESS	= 1 << 0,
+} kstat_flags_t;
+
+/*
+ * The kstat framework wraps kstat_t in an ekstat_t struct that holds some
+ * internal data.
+ */
+typedef struct mdb_ekstat {
+	kstat_t	e_ks;
+} mdb_ekstat_t;
+
+/*
+ * ::kstat
+ *
+ * Print some relevant fields from kstats on the system.
+ *
+ */
+static int
+kstat_print(uintptr_t addr, uint_t flags, int argc, const mdb_arg_t *argv)
+{
+	char *mod, *name, *class;
+	int inst;
+	int output_flags;
+	char *search_mod = NULL;
+	char *search_name = NULL;
+	char *search_class = NULL;
+	int search_inst = INT_MAX;
+	boolean_t search_inst_set = B_FALSE;
+	uint64_t inst_tmp = UINT64_MAX;
+	uint64_t test_inst = 0xdeadbeef;
+
+	mdb_ekstat_t ekstat;
+
+	if (!(flags & DCMD_ADDRSPEC)) {
+		if (mdb_walk_dcmd("kstat", "kstat", argc, argv) == -1) {
+			mdb_warn("can't walk kstats");
+			return (DCMD_ERR);
+		}
+
+		return (DCMD_OK);
+	}
+
+	if (mdb_getopts(argc, argv,
+	    'm', MDB_OPT_STR, &search_mod,
+	    'i', MDB_OPT_UINT64, &inst_tmp,
+	    'n', MDB_OPT_STR, &search_name,
+	    'c', MDB_OPT_STR, &search_class,
+	    'a', MDB_OPT_SETBITS, KSTAT_FLAG_ADDRESS, &output_flags) != argc) {
+		return (DCMD_USAGE);
+	}
+
+	if ((search_mod != NULL && strlen(search_mod) > KSTAT_STRLEN) ||
+	    (search_name != NULL && strlen(search_name) > KSTAT_STRLEN) ||
+	    (search_class != NULL && strlen(search_class) > KSTAT_STRLEN)) {
+		mdb_warn("provided module, class, and name lengths must be"
+		    " <= KSTAT_STRLEN\n");
+		return (DCMD_ERR);
+	}
+
+	/*
+	 * Convert the inbound uint64_t to an int. Although uncommon, it is
+	 * possible for kstats to have a negative 'instance' value.
+	 */
+	if (inst_tmp != test_inst) {
+		search_inst = (int)inst_tmp;
+		search_inst_set = B_TRUE;
+	} else {
+		mdb_warn("provided instance number (0xdeadbeef) is invalid\n");
+		return (DCMD_ERR);
+	}
+
+	if (DCMD_HDRSPEC(flags)) {
+		if (output_flags & KSTAT_FLAG_ADDRESS) {
+			mdb_printf("%<u>%-?s %</u>", "ADDRESS");
+		}
+		mdb_printf("%<u>%-10s %-10s %-20s %-15s%</u>\n", "MODULE",
+		    "INSTANCE", "NAME", "CLASS");
+	}
+
+	if (mdb_ctf_vread(&ekstat, "ekstat_t", "mdb_ekstat_t", addr, 0) == -1) {
+		mdb_warn("unable to read CTF data for 'ekstat_t'");
+		return (DCMD_ERR);
+	}
+
+	mod = ekstat.e_ks.ks_module;
+	inst = ekstat.e_ks.ks_instance;
+	name = ekstat.e_ks.ks_name;
+	class = ekstat.e_ks.ks_class;
+
+	/*
+	 * Short circuit if the kstat in question doesn't match the user's
+	 * filter(s).
+	 */
+	if ((search_mod != NULL &&
+	    strncmp(mod, search_mod, KSTAT_STRLEN) != 0) ||
+	    (search_name != NULL &&
+	    strncmp(name, search_name, KSTAT_STRLEN) != 0) ||
+	    (search_class != NULL &&
+	    strncmp(class, search_class, KSTAT_STRLEN) != 0) ||
+	    (search_inst_set && search_inst != inst)) {
+
+		return (DCMD_OK);
+	}
+
+	if (output_flags & KSTAT_FLAG_ADDRESS) {
+		mdb_printf("%0?p ", addr);
+	}
+	mdb_printf("%-10s %-10d %-20s %-15s\n", mod,
+	    ekstat.e_ks.ks_instance, name, class);
+
+	return (DCMD_OK);
+}
+
+void
+kstat_help(void)
+{
+	mdb_printf("Display kstat_t summaries.\n"
+	    " -a   also display an address column for each kstat\n"
+	    " -m   search for kstats with the given module (e.g. 'zfs')\n"
+	    " -i   search for kstats with the given instance number"
+	    " (e.g. 0t1)\n"
+	    " -n   search for kstats with the given name (e.g. 'zfetchstats')\n"
+	    " -c   search for kstats with the given class (e.g. 'misc')\n");
+}
+
+/*
+ * ::walk kstat
+ *
+ * Walk all ekstat_t structures in the kstat AVL tree. This is nothing more than
+ * a layered avl walk.
+ */
+static int
+kstat_walk_init(mdb_walk_state_t *wsp)
+{
+	GElf_Sym sym;
+
+	if (wsp->walk_addr != 0) {
+		mdb_warn("kstat walk only supports global walks\n");
+		return (WALK_ERR);
+	}
+
+	if (mdb_lookup_by_obj("unix", "kstat_avl_bykid", &sym) == -1) {
+		mdb_warn("failed to find symbol 'kstat_avl_bykid'");
+		return (WALK_ERR);
+	}
+
+	wsp->walk_addr = (uintptr_t)sym.st_value;
+
+	if (mdb_layered_walk("avl", wsp) == -1) {
+		mdb_warn("failed to walk 'avl'");
+		return (WALK_ERR);
+	}
+
+	return (WALK_NEXT);
+}
+
+static int
+kstat_walk_step(mdb_walk_state_t *wsp)
+{
+	return (wsp->walk_callback(wsp->walk_addr, NULL, wsp->walk_cbdata));
+}
+
+static const mdb_dcmd_t dcmds[] = {
+	{ "kstat", "?[-a] [ -m module ] [ -i instance ] [ -n name ]"
+	    " [ -c class ]\n",
+	    "kstat summary", kstat_print, kstat_help },
+	{ NULL }
+};
+
+static const mdb_walker_t walkers[] = {
+	{ "kstat", "walk all kstat structures", kstat_walk_init,
+	    kstat_walk_step, NULL },
+	{ NULL }
+};
+
+static const mdb_modinfo_t modinfo = {
+	MDB_API_VERSION, dcmds, walkers
+};
+
+const mdb_modinfo_t *
+_mdb_init(void)
+{
+	return (&modinfo);
+}
diff --git a/usr/src/cmd/mdb/intel/amd64/kstat/Makefile b/usr/src/cmd/mdb/intel/amd64/kstat/Makefile
new file mode 100644
index 0000000000..06f554aa58
--- /dev/null
+++ b/usr/src/cmd/mdb/intel/amd64/kstat/Makefile
@@ -0,0 +1,27 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright 2019 Joyent, Inc.
+#
+
+MODULE = kstat.so
+MDBTGT = kvm
+
+MODSRCS = kstat.c
+
+include ../../../../Makefile.cmd
+include ../../../../Makefile.cmd.64
+include ../../Makefile.amd64
+include ../../../Makefile.module
+
+CSTD=	$(CSTD_GNU99)
+C99LMODE=	-Xc99=%all
diff --git a/usr/src/cmd/mdb/sparc/v9/kstat/Makefile b/usr/src/cmd/mdb/sparc/v9/kstat/Makefile
new file mode 100644
index 0000000000..d3e7be5702
--- /dev/null
+++ b/usr/src/cmd/mdb/sparc/v9/kstat/Makefile
@@ -0,0 +1,28 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright 2019 Joyent, Inc.
+#
+
+MODULE = kstat.so
+MDBTGT = kvm
+
+MODSRCS = kstat.c
+
+include ../../../../Makefile.cmd
+include ../../../../Makefile.cmd.64
+include ../../Makefile.sparcv9
+include ../../../Makefile.module
+include ../../../common/modules/kstat/Makefile.kstat
+
+CSTD=	$(CSTD_GNU99)
+C99LMODE=	-Xc99=%all
-- 
2.21.0

