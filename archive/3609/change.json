{"project":"joyent/illumos-joyent","branch":"master","id":"Id8aa9216af8c1d23eaddba43fdd00ffe3f59da7a","number":"3609","subject":"OS-6639 bhyve memory allocations that can\u0027t succeed should fail or at least be interruptible Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3609","commitMessage":"OS-6639 bhyve memory allocations that can\u0027t succeed should fail or at least be interruptible\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1520950450,"lastUpdated":1521126059,"open":false,"status":"MERGED","comments":[{"timestamp":1520950450,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1520950483,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI arbitrarily made smaller allocations blocking, but I can change that if we don\u0027t like it."},{"timestamp":1520952137,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1520956511,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1520958729,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1520958758,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1520971267,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1520975827,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1520976698,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1520977114,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1520977843,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1520978471,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1\n\nI\u0027m in favor of \u0027perfect\u0027 not getting in the way of \u0027good\u0027."},{"timestamp":1520980084,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1\n\nAye"},{"timestamp":1520980141,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1521125938,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1521126034,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1521126059,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"d8aa9216af8c1d23eaddba43fdd00ffe3f59da7a","parents":["670823da472498e267a5aa84a4f71885fa7c175f"],"ref":"refs/changes/09/3609/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1521126034,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520971267,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520978471,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520980084,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520980141,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1521126059,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":21,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"ba9943dbdf7506b261e119536674ce87316e728a","parents":["b13e485c93c36fd37d5470756bc0f7d7bd44d018"],"ref":"refs/changes/09/3609/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1520950450,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1016,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"(void)"},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1016,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1020,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"An unbounded loop seems like it might not be great here.  This is especially true for when we wire up bhyve to the zone memcap, in which case its error would also be ENOMEM."},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1020,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I think this most closely matches what we want. Currently we hang until the system reboots or other (bhyve) zones are shutdown and memory becomes available. With this new approach we can still halt the zone, but otherwise the zone is blocked starting up until memory is available (as we do today). I don\u0027t really think the zone memcap is an issue here. If the memcap won\u0027t allow the zone to boot, then the zone is misconfigured and that sounds like an operator error. Maybe fixing that belongs in some kind of brand validation or code that adjusts the memcap appropriately so that it is valid?"},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1020,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This really comes down to whether we expect a retry to (eventually?) succeed. If we\u0027re never going to boot, it doesn\u0027t seem helpful to stay here - without anything except the log to indicate what the state of the VM is. Although at least provision will time out.\n\nSeems like we should give up after a while - maybe after a last ditch attempt to kmem reap or somesuch. Not sure if there\u0027s any way to report a proper error up the stack."},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1020,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"We already fail out the vmm creation if the memory allocation could never succeed (due to the system itself not having enough memory). If the system was overprovisioned on memory (which we should never do in Triton), then if one or more of the other bhyve zones shutdown, then this VM bootup will succeed. Likewise, it could eventually succeed if we have to trim down the ZFS ARC. This behavior is similar to KVM today where we lock down the memory before the VM can completely startup, but it might take 5-10mins for the ARC to trim down and the VM to then start. Although it is not ideal, this loop seems to mostly closely match our current expectation and still allow us to halt the zone instead of blocking in the kernel and thus not being able to halt it."},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1020,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Well, I agree a literally impossible allocation is something we shouldn\u0027t worry about.\n\nI suppose this isn\u0027t a huge problem right now, but I expect things to get more difficult in the future where we\u0027re not just finding 4k pages but have to worry about larger page sizes. In that case it\u0027s a distinct risk we\u0027ll have \"enough memory\" but be unable to acquire the right set of pages."},{"file":"usr/src/cmd/bhyve/bhyverun.c","line":1020,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yeah, this is almost certainly not the final word on this problem. I view it mostly as an easy fix for now so the zone can be halted, but as we improve the vmm arena and all of this stuff in general, we certainly want to revisit this."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":944,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"If this is really arbitrary, probably best to not do it.  If there\u0027s a method behind the madness, a comment would help."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":944,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Placing it into a define would be a step in the right direction."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":944,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027ve just removed this since there is no compelling case for it."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":944,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":949,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"mutex(9F) says that mutex_destroy() should be called first."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":949,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":11,"deletions":-3}],"sizeInsertions":24,"sizeDeletions":-3},{"number":"2","revision":"2042ccfeacf65d08ba71e453cfdde5436b67f2cd","parents":["b13e485c93c36fd37d5470756bc0f7d7bd44d018"],"ref":"refs/changes/09/3609/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1520958758,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520978471,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520971267,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520980084,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520980141,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":21,"sizeDeletions":-3},{"number":"3","revision":"586aa5e626d4dd1b0f576b76b55dfd00246c4a47","parents":["670823da472498e267a5aa84a4f71885fa7c175f"],"ref":"refs/changes/09/3609/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1521125938,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520978471,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520971267,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520980084,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520980141,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":21,"sizeDeletions":-3},{"number":"4","revision":"d8aa9216af8c1d23eaddba43fdd00ffe3f59da7a","parents":["670823da472498e267a5aa84a4f71885fa7c175f"],"ref":"refs/changes/09/3609/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1521126034,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1521126059,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520978471,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520971267,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520980084,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520980141,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/bhyverun.c","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":21,"sizeDeletions":-3}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}