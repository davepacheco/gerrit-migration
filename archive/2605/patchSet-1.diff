From 733c05d49914d9276618677f5e1711d4b70de231 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Tue, 19 Sep 2017 11:23:15 -0600
Subject: [PATCH] joyent/node-manta#328 Version and Help should not require
 Vars to be Set

---
 lib/options.js    |  4 +++-
 test/mput.test.js | 42 ++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 45 insertions(+), 1 deletion(-)

diff --git a/lib/options.js b/lib/options.js
index 3fbffed..2b7f301 100644
--- a/lib/options.js
+++ b/lib/options.js
@@ -50,7 +50,9 @@ function parseOptions(args) {
         opts = parser.parse(process.argv);
         cc.checkBinEnv(opts);
     } catch (e) {
-        cc.usage(parser, e.message, 'path...');
+        if (!(opts.help || opts.version)) {
+            cc.usage(parser, e.message, 'path...');
+        }
     }
 
     cc.setupLogger(opts, args.log);
diff --git a/test/mput.test.js b/test/mput.test.js
index 4a32f53..0c16bda 100644
--- a/test/mput.test.js
+++ b/test/mput.test.js
@@ -169,6 +169,48 @@ test('mput with custom header value with colons', function (t) {
 });
 
 
+/*
+ * Test that specifying the --help option with no manta URL specified does not
+ * result in a warning about the missing URL. This verifies the fix for
+ * https://github.com/joyent/node-manta/issues/328.
+ */
+test('mput --help with no manta URL specified', function (t) {
+    forkExecWait({
+        argv: [ MPUT,
+                '--help'
+              ],
+        env: { MANTA_URL: '' }
+    }, function (err, info) {
+           t.ifError(err, err);
+
+           const urlArgMsg = 'url is a required argument';
+           t.equal(info.stderr.indexOf(urlArgMsg), -1);
+           t.done();
+    });
+});
+
+
+/*
+ * Test that specifying the --version option with no manta URL specified does
+ * not result in a warning about the missing URL. This verifies the fix for
+ * https://github.com/joyent/node-manta/issues/328.
+ */
+test('mput --version with no manta URL specified', function (t) {
+    forkExecWait({
+        argv: [ MPUT,
+                '--version'
+              ],
+        env: { MANTA_URL: '' }
+    }, function (err, info) {
+           t.ifError(err, err);
+
+           const urlArgMsg = 'url is a required argument';
+           t.equal(info.stderr.indexOf(urlArgMsg), -1);
+           t.done();
+    });
+});
+
+
 test('cleanup: rm test tree ' + TESTDIR, function (t) {
     // Sanity checks that we don't `mrm -r` a non-test dir.
     assert.ok(TESTDIR);
-- 
2.21.0

