From 59d6682f9490f8bef2e461941744b084c9c8885f Mon Sep 17 00:00:00 2001
From: Robert Mustacchi <rm@joyent.com>
Date: Sat, 3 Dec 2016 17:00:03 +0000
Subject: [PATCH] OS-5833 Update gcc for recent illumos patches and backports

---
 gcc4/Makefile         |   6 ++++++
 gcc4/README           |  31 +++++++++++++++++++++++++++++++
 gcc4/gcc-4.4.4.tar.gz | Bin 76779996 -> 74051496 bytes
 gcc4/git_source       |  23 -----------------------
 4 files changed, 37 insertions(+), 23 deletions(-)
 create mode 100644 gcc4/README
 delete mode 100644 gcc4/git_source

diff --git a/gcc4/Makefile b/gcc4/Makefile
index 9e0089f..51332c5 100644
--- a/gcc4/Makefile
+++ b/gcc4/Makefile
@@ -53,6 +53,12 @@ OVERRIDES += \
 	STAGE1_CFLAGS="$(CFLAGS)" \
 	CFLAGS_FOR_TARGET="$(CFLAGS)"
 
+#
+# Because we use a different build directory, we need to make sure we
+# catch that when cleaning.
+#
+CLEANFILES += $(VER)-32.build $(VER)-32strap.build
+
 #
 # The runtime libraries that we build into proto.strap should be made to search
 # for their dependencies there as well, so that programs built to run on the
diff --git a/gcc4/README b/gcc4/README
new file mode 100644
index 0000000..d65ad39
--- /dev/null
+++ b/gcc4/README
@@ -0,0 +1,31 @@
+The gcc used by illumos is patched to add additional functionality and
+to cover historical differences between Sun Studio and gcc.
+
+The current version comes from https://github.com/illumos/gcc on the
+il-4_4_4 branch. The current commit is:
+
+commit 0f5ed4ce0b823f41ea952d40347891b28428a17e
+Author: Yuri Pankov <yuri.pankov@nexenta.com>
+Date:   Sat Nov 5 05:26:47 2016 +0300
+
+    16 update cmn_err format specifier
+    Reviewed by: Richard Lowe <richlowe@richlowe.net>
+    Reviewed by: Robert Mustacchi <rm@joyent.com>
+
+To update gcc, perform the following steps:
+
+1) Do a stock build of smartos-live
+2) Move the proto area aside and clobber the repo
+3) Copy the buildstamp from the set aside proto area into the root of
+   the new porto area.
+4) git clone -b il-4_4_4 https://github.com/illumos/gcc.git new-gcc
+5) Ensure you are on the correct branch (il-4_4_4)
+6) Make sure the differences in files between the clone and the current
+   source match what you expect.
+7) Create a git archive by running something like:
+
+	cd new-gcc; git archive --prefix=gcc-4.4.4/ -o ../gcc-4.4.4.tar.gz HEAD
+
+8) Build the workspace with a new gcc
+9) Use wsdiff to compare chunks of the illumos binaries to gain
+   confidence in the updated compiler.
diff --git a/gcc4/gcc-4.4.4.tar.gz b/gcc4/gcc-4.4.4.tar.gz
index 1abf754..99ad41a 100644
Binary files a/gcc4/gcc-4.4.4.tar.gz and b/gcc4/gcc-4.4.4.tar.gz differ
diff --git a/gcc4/git_source b/gcc4/git_source
deleted file mode 100644
index 0204729..0000000
--- a/gcc4/git_source
+++ /dev/null
@@ -1,23 +0,0 @@
-git://github.com/joyent/gcc
-branch il-4_4_4
-
-HEAD:
-commit 43d517ea3eb78c23ace5f3e6e579fb29d28f71ba
-Author: Richard Lowe <richlowe@richlowe.net>
-Date:   Wed Dec 14 02:32:14 2011 +0000
-
-    config: Do not force runpath entries unless necessary
-    
-    Sun patched their GCC3 to force /lib:/usr/lib:/usr/sfw/lib into the runpath, in
-    that order, such that /usr/sfw libraries did not take precedence over system
-    libraries, but nevertheless libgcc did not need a specific -R entry to be added
-    to the command line when building.
-    
-    This has caused us nothing but trouble when patching it forward, since suddenly
-    we need our _own_ prefix in thre too, and it must beat /usr/sfw, and because
-    it's using -R it means that LD_RUN_PATH doesn't function, and because it's
-    unexpected it causes confusion for 3rd party software.
-    
-    This change only uses -R to force the runpath in the BSD compat environment, as
-    GCC upstream does, leaving the sole artifact of Sun's change being the addition
-    of /lib to the default library search path. (-YP)
-- 
2.21.0

