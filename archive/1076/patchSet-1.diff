From d7781ff7f455054fc3d2843d09a6c1697dd31555 Mon Sep 17 00:00:00 2001
From: Robert Mustacchi <rm@joyent.com>
Date: Tue, 6 Dec 2016 20:05:20 +0000
Subject: [PATCH] OS-5837 cpuid_pass2 can clobber leaf 7

---
 usr/src/uts/i86pc/os/cpuid.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/usr/src/uts/i86pc/os/cpuid.c b/usr/src/uts/i86pc/os/cpuid.c
index 027ed29c3d..8f4f3694a7 100644
--- a/usr/src/uts/i86pc/os/cpuid.c
+++ b/usr/src/uts/i86pc/os/cpuid.c
@@ -1795,8 +1795,10 @@ cpuid_pass2(cpu_t *cpu)
 		 *
 		 * Note: we need to explicitly initialize %ecx here, since
 		 * function 4 may have been previously invoked.
+		 *
+		 * The same is all true for CPUID function 7.
 		 */
-		if (n == 4)
+		if (n == 4 || n == 7)
 			cp->cp_ecx = 0;
 
 		(void) __cpuid_insn(cp);
-- 
2.21.0

