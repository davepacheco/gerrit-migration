From dc0ea1cfa1b37bb6614de288f467ce67dbd39af9 Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Fri, 17 Aug 2018 14:28:21 -0400
Subject: [PATCH] joyent/node-manta#327 completion tests could ignore hidden
 files

---
 test/completion.test.js | 21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/test/completion.test.js b/test/completion.test.js
index 09a8745..9b4035e 100644
--- a/test/completion.test.js
+++ b/test/completion.test.js
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  */
 
 /*
@@ -7,17 +7,17 @@
  * that looks somewhat like Bash completion code.
  */
 
-var exec = require('child_process').exec;
 var fs = require('fs');
 var path = require('path');
 
+var forkExecWait = require('forkexec').forkExecWait;
+
 /*
  * Globals
  */
 
 var binDir = path.resolve(__dirname, '..', 'bin');
 
-
 /*
  * Helper functions
  */
@@ -26,20 +26,25 @@ function test(name, testfunc) {
     module.exports[name] = testfunc;
 }
 
-
 /*
  * Tests
  */
 
 fs.readdirSync(binDir).forEach(function (name) {
-    var cmd = path.join(binDir, name);
+    // node-manta#327 completion tests could ignore hidden files
+    if (name[0] === '.') {
+        return;
+    }
 
+    var cmd = path.join(binDir, name);
     test(name + ' --completion', function (t) {
-        exec(cmd + ' --completion', function (err, stdout, stderr) {
+        forkExecWait({
+            argv: [cmd, '--completion']
+        }, function (err, info) {
             t.ifError(err);
-            t.equal(stderr, '',
+            t.equal(info.stderr, '',
                 'no stderr output from "' + name + ' --completion"');
-            t.ok(/COMPREPLY/.test(stdout), 'stdout from "' + name +
+            t.ok(/COMPREPLY/.test(info.stdout), 'stdout from "' + name +
                 ' --completion" looks like Bash completion code');
             t.done();
         });
-- 
2.21.0

