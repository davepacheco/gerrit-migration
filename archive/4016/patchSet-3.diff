commit 0361e194d2df653da820edcdd4f478fc0b4cbd62 (refs/changes/16/4016/3)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2018-06-01T16:54:55+02:00 (1 year, 4 months ago)
    
    TOOLS-1699 sdcadm health -j should always provide JSON even on exceptions

diff --git a/lib/cli/do_check_health.js b/lib/cli/do_check_health.js
index 38734f1..c0f5294 100644
--- a/lib/cli/do_check_health.js
+++ b/lib/cli/do_check_health.js
@@ -175,7 +175,7 @@ function do_check_health(subcmd, opts, args, callback) {
             });
         }
 
-        if (errRows.length > 0) {
+        if (!opts.json && !opts.quiet && errRows.length > 0) {
             callback(new Error('Some instances appear unhealthy'));
             return;
         }
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 27f3160..6145a7f 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -4087,7 +4087,18 @@ SdcAdm.prototype.checkHealth = function checkHealth(opts, cb) {
     }, function (err) {
         if (err) {
             self.log.error({err: err}, 'checkHealth pipeline cb');
-            cb(err);
+            cb(null, [
+                {
+                    type: 'triton',
+                    hostname: 'headnode',
+                    healthy: false,
+                    health_errors: [
+                        { message: err.message },
+                        { message: 'Triton is experiencing severe errors ' +
+                            'that prevent detailed health checks'}
+                    ]
+                }
+            ]);
             return;
         }
 
@@ -4119,7 +4130,18 @@ SdcAdm.prototype.checkHealth = function checkHealth(opts, cb) {
         }, function (err2, results) {
             if (err2) {
                 self.log.error({err: err2}, 'checkHealth parallel cb');
-                cb(new errors.InternalError(new Error(err2)));
+                cb(null, [
+                    {
+                        type: 'triton',
+                        hostname: 'headnode',
+                        healthy: false,
+                        health_errors: [
+                            { message: err2.message },
+                            { message: 'Triton is experiencing severe errors ' +
+                                'that prevent detailed health checks'}
+                        ]
+                    }
+                ]);
                 return;
             }
 
