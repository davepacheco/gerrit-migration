From 6d2db2a21cd0c3de9f0fa59e794736c6c168a322 Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Mon, 11 Jul 2016 21:52:29 +0000
Subject: [PATCH] OS-5498 lxbrand cp on alpine duplicates data Reviewed by:
 Jerry Jelinek <jerry.jelinek@joyent.com>

---
 .../lib/brand/lx/lx_brand/common/sendfile.c   | 28 +++++++++----------
 1 file changed, 13 insertions(+), 15 deletions(-)

diff --git a/usr/src/lib/brand/lx/lx_brand/common/sendfile.c b/usr/src/lib/brand/lx/lx_brand/common/sendfile.c
index 1d7547b051..c09e8c51dc 100644
--- a/usr/src/lib/brand/lx/lx_brand/common/sendfile.c
+++ b/usr/src/lib/brand/lx/lx_brand/common/sendfile.c
@@ -22,7 +22,7 @@
 /*
  * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2015 Joyent, Inc.  All rights reserved.
+ * Copyright 2016 Joyent, Inc.
  */
 
 /*
@@ -69,26 +69,25 @@ lx_sendfile(uintptr_t p1, uintptr_t p2, uintptr_t p3, uintptr_t p4)
 	error = __systemcall(&rval, SYS_sendfilev, SENDFILEV, p1, &sfv,
 	    1, &xferred);
 
-	/* Suppress EAGAIN errors if we were able to write any data at all. */
-	if (error == EAGAIN && xferred > 0) {
+	/* Suppress errors if we were able to write any data at all. */
+	if (xferred > 0) {
 		error = 0;
-		rval.sys_rval1 = xferred;
 	}
 
-	if (error == 0 && xferred > 0) {
+	if (error == 0) {
+		off += xferred;
 		if (offp == NULL) {
 			/* If no offp, we must adjust current offset */
-			if (lseek((int)p2, xferred, SEEK_CUR) == -1)
+			if (lseek((int)p2, off, SEEK_SET) == -1)
 				return (-errno);
 		} else {
-			off += xferred;
 			if (uucopy(&off, offp, sizeof (off)) != 0) {
 				return (-EFAULT);
 			}
 		}
 	}
 
-	return (error ? -error : (int)rval.sys_rval1);
+	return (error ? -error : xferred);
 }
 #endif
 
@@ -122,24 +121,23 @@ lx_sendfile64(uintptr_t p1, uintptr_t p2, uintptr_t p3, uintptr_t p4)
 	error = __systemcall(&rval, SYS_sendfilev, SENDFILEV64, p1, &sfv,
 	    1, &xferred);
 
-	/* Suppress EAGAIN errors if we were able to write any data at all. */
-	if (error == EAGAIN && xferred > 0) {
+	/* Suppress errors if we were able to write any data at all. */
+	if (xferred > 0) {
 		error = 0;
-		rval.sys_rval1 = xferred;
 	}
 
-	if (error == 0 && xferred > 0) {
+	if (error == 0) {
+		off += xferred;
 		if (offp == NULL) {
 			/* If no offp, we must adjust current offset */
-			if (lseek((int)p2, xferred, SEEK_CUR) == -1)
+			if (lseek((int)p2, off, SEEK_SET) == -1)
 				return (-errno);
 		} else {
-			off += xferred;
 			if (uucopy(&off, offp, sizeof (off)) != 0) {
 				return (-EFAULT);
 			}
 		}
 	}
 
-	return (error ? -error : (int)rval.sys_rval1);
+	return (error ? -error : xferred);
 }
-- 
2.21.0

