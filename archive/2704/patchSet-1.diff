From 3bf0626ce7112e79886ac26373cf00f7588945a9 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 3 Oct 2017 20:33:10 +0200
Subject: [PATCH] CAPI-538 test-ufds: delete customer test randomly failing
 with InvalidArgumentError

---
 test/capi/customers.test.js | 37 ++++++++++++++++++++++++++++++++++---
 1 file changed, 34 insertions(+), 3 deletions(-)

diff --git a/test/capi/customers.test.js b/test/capi/customers.test.js
index 6ba4ca4..44400fe 100644
--- a/test/capi/customers.test.js
+++ b/test/capi/customers.test.js
@@ -793,9 +793,40 @@ test('delete key', function (t) {
 
 test('delete customer', function (t) {
     CAPI.del('/customers/' + CUSTOMER.uuid, function (err, req, res) {
-        t.ifError(err);
-        t.equal(200, res.statusCode);
-        t.end();
+        if (!err) {
+            t.equal(200, res.statusCode);
+            t.end();
+            return;
+        }
+        if (err.name !== 'InvalidArgumentError') {
+            t.ifError(err);
+            t.end();
+            return;
+        }
+        // napi-ufds-watcher could add a dclocalconfig entry to our
+        // customer and we'll have an error trying to delete it w/o removing
+        // every child entry. Let's try to remove it:
+        var localCfgDn = util.format(
+            'dclocalconfig=%s, uuid=%s, ou=users, %s',
+            CONFIG.datacenter_name, CUSTOMER.uuid, SUFFIX);
+
+        helper.createClient(function (clientErr, client) {
+            t.ifError(clientErr);
+            t.ok(client);
+            client.del(localCfgDn, function (err1) {
+                t.ifError(err1);
+                client.unbind(function (err2) {
+                    t.ifError(err2);
+                    CAPI.del('/customers/' + CUSTOMER.uuid,
+                        function (err3, req3, res3) {
+                        t.ifError(err3);
+                        t.equal(200, res3.statusCode);
+                        t.end();
+                    });
+                });
+            });
+        });
+
     });
 });
 
-- 
2.21.0

