From 3905c7c04f7da1c14be0147ec2db2bbc6d23738c Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 30 Apr 2018 13:21:49 -0700
Subject: [PATCH] MANTA-3672 want support for cross-account RBAC role
 membership

---
 lib/client.js | 9 ++++-----
 package.json  | 3 +--
 2 files changed, 5 insertions(+), 7 deletions(-)

diff --git a/lib/client.js b/lib/client.js
index 126c6e5..1ab6cb5 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -447,8 +447,6 @@ MahiClient.prototype.authorize = function authorize(opts) {
             principal.account.isOperator) {
 
             return (true);
-        } else {
-            throw new errors.CrossAccountError();
         }
     }
 
@@ -472,7 +470,8 @@ MahiClient.prototype.authorize = function authorize(opts) {
      */
     for (i = 0; i < activeRoles.length; ++i) {
         // check if the principal is allowed to assume the role
-        if (!principal.roles[activeRoles[i]]) {
+        var role = principal.roles[activeRoles[i]];
+        if (!role) {
             throw new errors.InvalidRoleError(activeRoles[i]);
         }
 
@@ -480,8 +479,8 @@ MahiClient.prototype.authorize = function authorize(opts) {
          * The isOperator check here means that admin users "inherit" operator
          * privileges from the account.
          */
-        if (principal.roles[activeRoles[i]].name === ADMIN_ROLE_NAME) {
-            if (owner.account.uuid === principal.account.uuid ||
+        if (role.name === ADMIN_ROLE_NAME) {
+            if (owner.account.uuid === role.account ||
                 principal.account.isOperator) {
 
                 return (true);
diff --git a/package.json b/package.json
index 9c816c9..9f863ff 100644
--- a/package.json
+++ b/package.json
@@ -1,9 +1,8 @@
 {
     "name": "mahi",
     "description": "Mahi client",
-    "version": "2.0.1",
+    "version": "2.1.0",
     "author": "Joyent (joyent.com)",
-    "private": true,
     "main": "index.js",
     "dependencies": {
         "aperture": "git://github.com/joyent/node-aperture.git#master",
-- 
2.21.0

