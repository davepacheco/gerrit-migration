commit 041273647003987e2694cabbf7f5660a366552d2 (refs/changes/67/3967/2)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2018-05-17T14:50:42-07:00 (1 year, 5 months ago)
    
    MANTA-3672 want support for cross-account RBAC role membership

diff --git a/lib/client.js b/lib/client.js
index 126c6e5..72b4df1 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -447,8 +447,6 @@ MahiClient.prototype.authorize = function authorize(opts) {
             principal.account.isOperator) {
 
             return (true);
-        } else {
-            throw new errors.CrossAccountError();
         }
     }
 
@@ -472,22 +470,39 @@ MahiClient.prototype.authorize = function authorize(opts) {
      */
     for (i = 0; i < activeRoles.length; ++i) {
         // check if the principal is allowed to assume the role
-        if (!principal.roles[activeRoles[i]]) {
+        var role = principal.roles[activeRoles[i]];
+        if (!role) {
             throw new errors.InvalidRoleError(activeRoles[i]);
         }
 
         /*
-         * The isOperator check here means that admin users "inherit" operator
-         * privileges from the account.
+         * Having the "administrator" role on a given account means you can do
+         * anything to objects owned by that account.
          */
-        if (principal.roles[activeRoles[i]].name === ADMIN_ROLE_NAME) {
-            if (owner.account.uuid === principal.account.uuid ||
-                principal.account.isOperator) {
-
+        if (role.name === ADMIN_ROLE_NAME) {
+            if (owner.account.uuid === role.account) {
                 return (true);
             }
+            /*
+             * Sub-users on an operator account that have been added to that
+             * operator's "administrator" rule inherit operator access.
+             *
+             * We have to check the account is the same as the role here so that
+             * being on the admin role of a *different* account doesn't confer
+             * operator access.
+             */
+            if (principal.account.isOperator &&
+                principal.account.uuid === role.account) {
+                return (true);
+            }
+            /*
+             * Otherwise ignore this role membership -- admin roles can't have
+             * any attached policy.
+             */
+
         } else if (resourceTags.indexOf(activeRoles[i]) >= 0) {
-                roles.push(activeRoles[i]);
+            /* Ordinary non-admin roles are processed below. */
+            roles.push(activeRoles[i]);
         }
     }
 
diff --git a/package.json b/package.json
index 9c816c9..9f863ff 100644
--- a/package.json
+++ b/package.json
@@ -1,9 +1,8 @@
 {
     "name": "mahi",
     "description": "Mahi client",
-    "version": "2.0.1",
+    "version": "2.1.0",
     "author": "Joyent (joyent.com)",
-    "private": true,
     "main": "index.js",
     "dependencies": {
         "aperture": "git://github.com/joyent/node-aperture.git#master",
