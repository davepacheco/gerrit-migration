{"project":"joyent/illumos-joyent","branch":"master","id":"I9edb67c309d2e2712a09267be4dea367e37dc545","number":"4600","subject":"OS-7098 bufmod sends corrupted LSO packets Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Jason King \u003cjbk@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/4600","commitMessage":"OS-7098 bufmod sends corrupted LSO packets\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Jason King \u003cjbk@joyent.com\u003e\n","createdOn":1532873027,"lastUpdated":1534794749,"open":false,"status":"MERGED","comments":[{"timestamp":1532873027,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1533576472,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1533673869,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1533674011,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1534357849,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1534357898,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1534358421,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\nI decided to rewrite this slightly. Patch set  2 accidentally included a note to myself in the commit msg, I fixed that in patch set 3.\n\nI found it hard to write a good comment that addressed rm\u0027s concern with patch set #1. Furthermore, I noticed that we could end up wasting lots of chunk space in the case where the mblk would fit on the end of the chunk were it not for the padding. In this case we should place the mblk on the chunk without the padding as the padding is only required to make sure the BEGINNING of a hdr/msg falls on the correct boundary. There is no reason to pad the last hdr/msg.\n\nWith that in mind I saw a way to rewrite the function that makes it more efficient and I think a bit more clear. The new logic is basically this:\n\n1. If the msg (without padding) can\u0027t fit on the chunk then close the current chunk and start a new one.\n\n2. If the msg can fit on the end of the chunk but there isn\u0027t enough room for the requisite padding and the next possible smallest msg, then add the msg to the end of the chunk without the padding and close the chunk.\n\n3. If the msg can fit AND we have enough room for the requisite padding along with the next possible smallest msg, then add the msg to the chunk and add the padding in anticipation of another msg."},{"timestamp":1534376359,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\nThanks, I think this updated form makes sense. Though I have to admit, I\u0027m not 100% clear on all the semantics and expectations of callers below it. The comments were helpful."},{"timestamp":1534793456,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\nTesting notes added to ticket."},{"timestamp":1534793945,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Integration-Approval+1\n\n(1 comment)"},{"timestamp":1534793983,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Code-Review+1 -Integration-Approval\n\nREALLY appreciate the analysis in the bug report.  I noted one nit, but it wasn\u0027t worth stopping.  Also, I accidentally IA\u0027ed it."},{"timestamp":1534794150,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1534794584,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1534794735,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1534794749,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"5","revision":"9edb67c309d2e2712a09267be4dea367e37dc545","parents":["4a3dceb097fceefc13c4471707cd40944dd07ffb"],"ref":"refs/changes/00/4600/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1534794735,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534376359,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534793983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534794150,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1534794749,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/bufmod.c","type":"MODIFIED","insertions":28,"deletions":-25}],"sizeInsertions":28,"sizeDeletions":-25},"patchSets":[{"number":"1","revision":"1dcfaa7888bd337d5e3fd4d4f4745dbeee28ab05","parents":["d9c6fa684883a86a205a069be385ed2e87ac29a2"],"ref":"refs/changes/00/4600/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1532873027,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/bufmod.c","line":1023,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Does it makes sense to actually just move all of this logic down to the else case of +1076 as it seems like that is where all of this is being applied. I\u0027ve tried to briefly audit the paths to make sure we\u0027re not missing something if we move it. Thoughts? Am I right that in the LSO case that\u0027s where we\u0027re returning, but with the inflated size?"},{"file":"usr/src/uts/common/io/bufmod.c","line":1023,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"So, my first inclination was to do just that. However, sbh_totlen is used twice before we ever reach that code, and it\u0027s important that this value is correct. So I added this logic _before_ we make use of sbh_totlen. There are ways I could rewrite this function that _might_ make it a bit clearer, but I wanted to avoid going down that road for the sake of time and risk.\n\nThat said, perhaps I should add a brief comment explaining why the padding is added to sbh_totlen here rather than later in the function?"},{"file":"usr/src/uts/common/io/bufmod.c","line":1023,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think expanding the comment will help a lot. You\u0027re right that we do use the padded length later on, which I had missed in my initial analysis."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/bufmod.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":8,"sizeDeletions":-3},{"number":"2","revision":"4d7d9fb2f4bc417f43a49c3f648b1a07a11120d8","parents":["005d090d5d39829784302a3c8574b81b88fc69d0"],"ref":"refs/changes/00/4600/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1534357849,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":15,"deletions":0},{"file":"usr/src/uts/common/io/bufmod.c","type":"MODIFIED","insertions":28,"deletions":-25}],"sizeInsertions":28,"sizeDeletions":-25},{"number":"3","revision":"8a3e3ca941a953db51c122f2f1abf5f268baed24","parents":["005d090d5d39829784302a3c8574b81b88fc69d0"],"ref":"refs/changes/00/4600/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1534357898,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534376359,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534794150,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534793983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/io/bufmod.c","line":1021,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Cascading change resulting from cstyling or a pre-rev-3 rewrite.  Not enough to reject, however."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/bufmod.c","type":"MODIFIED","insertions":28,"deletions":-25}],"sizeInsertions":28,"sizeDeletions":-25},{"number":"4","revision":"04c1730d5d07ea986f65f29c152ab160234ecf2e","parents":["4a3dceb097fceefc13c4471707cd40944dd07ffb"],"ref":"refs/changes/00/4600/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1534794584,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534376359,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534794150,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534793983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/bufmod.c","type":"MODIFIED","insertions":28,"deletions":-25}],"sizeInsertions":28,"sizeDeletions":-25},{"number":"5","revision":"9edb67c309d2e2712a09267be4dea367e37dc545","parents":["4a3dceb097fceefc13c4471707cd40944dd07ffb"],"ref":"refs/changes/00/4600/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1534794735,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534376359,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1534794749,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534794150,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534793983,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/bufmod.c","type":"MODIFIED","insertions":28,"deletions":-25}],"sizeInsertions":28,"sizeDeletions":-25}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}