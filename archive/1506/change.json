{"project":"joyent/illumos-joyent","branch":"master","id":"I8a54bd0389ef62c7f6b917788261216b299285eb","number":"1506","subject":"OS-5941 epoll should exclude normal files/directories Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/1506","commitMessage":"OS-5941 epoll should exclude normal files/directories\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1487103079,"lastUpdated":1488487903,"open":false,"status":"MERGED","comments":[{"timestamp":1487103079,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1487104335,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\nOne question I have is how did you determine which file systems should have their poll interface updated or more importantly, why they should not?"},{"timestamp":1487106300,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nTo answer your question, Robert: I grepped through the source looking at what filesystems were registering for their VOPNAME_POLL handler.  I wanted to avoid changing the devpoll behavior on pseudo-filesystems like /proc, where polling is much more reasonable than on a regular file or dir.\n\nThe fs_poll handler will apply to any filesystem which opts not to define a VOPNAME_POLL handler, which applies to most \"normal\" filesystems.  UFS is the obvious exception to that rule.  Of the filesystems that defined their own, they were either overriding with fs_error, which gets us out of the loop anyways, or providing their out routine with real polling logic.  The only FS override which caused me a little concern was lofs, but it\u0027s handler just calls that of the underlying VOP_POLL, which will make it to our epoll exclusion logic all the same for fs_poll users."},{"timestamp":1487117146,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1487117577,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1487200825,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\nI\u0027ve taken a longer look at this and I am happy with the fix."},{"timestamp":1487971052,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1487971114,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\nThe tests in the epoll-test-suite which deal with normal file exclusion are passing with this wad applied.  Are there any other things you would like addressed?"},{"timestamp":1488417406,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1488417440,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1488485946,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1488486283,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1488487903,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"4","revision":"8a54bd0389ef62c7f6b917788261216b299285eb","parents":["98533ae6238d8078d6d6ecc80d9b127208124b21"],"ref":"refs/changes/06/1506/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1488486283,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487200825,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488417406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488417440,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1488487903,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/fs_subr.c","type":"MODIFIED","insertions":22,"deletions":-18},{"file":"usr/src/uts/common/fs/fs_subr.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":36,"sizeDeletions":-24},"patchSets":[{"number":"1","revision":"8419147a51a6dcbd8da06c1086c9fac9e4530fa2","parents":["53eadd7bf4ba566c2a2132b48c49fb60fdcfaa19"],"ref":"refs/changes/06/1506/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1487103079,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487200825,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","line":5743,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This comment seems a little confusing to me since the check has nothing to do with regular files (or any vnode)."},{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","line":5743,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sorry, maybe I missed the obvious point that for UFS all of the calls here will be for a regular file."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/fs_subr.c","type":"MODIFIED","insertions":22,"deletions":-18},{"file":"usr/src/uts/common/fs/fs_subr.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":36,"sizeDeletions":-24},{"number":"2","revision":"760da46dbe5ec49e6827206eee0f90a55dc50754","parents":["a20a6014d3b07e04924eb17e4c5ec736d28542e2"],"ref":"refs/changes/06/1506/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1487971052,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488417440,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488417406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487200825,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/fs_subr.c","type":"MODIFIED","insertions":22,"deletions":-18},{"file":"usr/src/uts/common/fs/fs_subr.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":36,"sizeDeletions":-24},{"number":"3","revision":"669e4df94434bc0ff255909602714f3dc8041c04","parents":["98533ae6238d8078d6d6ecc80d9b127208124b21"],"ref":"refs/changes/06/1506/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1488485946,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488417440,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488417406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487200825,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/fs_subr.c","type":"MODIFIED","insertions":22,"deletions":-18},{"file":"usr/src/uts/common/fs/fs_subr.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":36,"sizeDeletions":-24},{"number":"4","revision":"8a54bd0389ef62c7f6b917788261216b299285eb","parents":["98533ae6238d8078d6d6ecc80d9b127208124b21"],"ref":"refs/changes/06/1506/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1488486283,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488417440,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488417406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487200825,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1488487903,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/fs_subr.c","type":"MODIFIED","insertions":22,"deletions":-18},{"file":"usr/src/uts/common/fs/fs_subr.h","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"usr/src/uts/common/fs/ufs/ufs_vnops.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":36,"sizeDeletions":-24}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}