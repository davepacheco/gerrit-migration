{"project":"joyent/sdcadm","branch":"master","id":"Iba692d78ab118dc928fe87416d441402c022f2d9","number":"382","subject":"TOOLS-1537 sdcadm create times out checking instance health Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/382","commitMessage":"TOOLS-1537 sdcadm create times out checking instance health\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1472554012,"lastUpdated":1474309490,"open":false,"status":"MERGED","comments":[{"timestamp":1472554012,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1472554043,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472554508,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1472554539,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472835831,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1472835872,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1474039176,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1474039226,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1474039259,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nI\u0027m blocked on the tests issue due to this one"},{"timestamp":1474048437,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1474286537,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1474286575,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474286645,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(3 comments)\n\nA much better approach, no doubt! thanks for the review!"},{"timestamp":1474308730,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1474309313,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1474309328,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(3 comments)\n\nDone!"},{"timestamp":1474309359,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474309400,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1474309490,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"6","revision":"ba692d78ab118dc928fe87416d441402c022f2d9","parents":["e98ed967f1662f002126cf8e0c996f2255578995"],"ref":"refs/changes/82/382/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1474309313,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474309359,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474309400,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474309400,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1474309490,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":27,"deletions":-7},{"file":"test/create.test.js","type":"MODIFIED","insertions":72,"deletions":-28}],"sizeInsertions":99,"sizeDeletions":-35},"patchSets":[{"number":"1","revision":"70173d2598df8bbdb7add1d765ac737677264f7f","parents":["ae70eb1382c3c613c83d1f51500440b1e932494c"],"ref":"refs/changes/82/382/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472554012,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472554043,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":45,"deletions":-3},{"file":"test/create.test.js","type":"MODIFIED","insertions":73,"deletions":-28}],"sizeInsertions":118,"sizeDeletions":-31},{"number":"2","revision":"693a27c91c6464787eb122936b125747ea386363","parents":["ae70eb1382c3c613c83d1f51500440b1e932494c"],"ref":"refs/changes/82/382/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472554508,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472554539,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":45,"deletions":-3},{"file":"test/create.test.js","type":"MODIFIED","insertions":72,"deletions":-28}],"sizeInsertions":117,"sizeDeletions":-31},{"number":"3","revision":"554d6a7905101bf3ca7725613f90c476875a8ad3","parents":["333d1f70b553e9c5b0fadd5a32b297a76a18748d"],"ref":"refs/changes/82/382/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472835831,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472554539,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":45,"deletions":-3},{"file":"test/create.test.js","type":"MODIFIED","insertions":72,"deletions":-28}],"sizeInsertions":117,"sizeDeletions":-31},{"number":"4","revision":"0c285a8d7769eded6664a04e5346355cc187e0bd","parents":["e98ed967f1662f002126cf8e0c996f2255578995"],"ref":"refs/changes/82/382/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1474039176,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472554539,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/shared.js","line":697,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Let\u0027s *not* add server_ip and hostname to the \"inst\" object. IIUC, they are not needed by checkHealth.\n\nHonestly, I\u0027m not so sure that the sdcadm \"inst\" object should have the burden of determining the server_ip all the time. The only usage of \"server_ip\" is for checkHealth calling an HTTP endpoint on *agent* instances that support an HTTP status endpoint. It might be possible to clean that up."},{"file":"lib/procedures/shared.js","line":697,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":711,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"In general, the IP for the created instance isn\u0027t available yet. IIUC, the SAPI CreateInstance call returns when the job is created. The NIC isn\u0027t assigned for the provision when CreateInstance returns. So this would introduce a race.\n\nI think a better change would be:\n\n1. Change \u0027waitForInstToBeUp\u0027 to be able to take a \u0027inst\u0027 object that doesn\u0027t have \u0027ip\u0027 set. Document this in its block comment. It is the \u0027waitForInstToBeUp\u0027s responsiblity to get that VM IP when it needs it.\n2. This shouldn\u0027t be too hard because before \u0027checkInstSvcs\u0027, in \u0027checkInstIsRunning\u0027 it is checking that the VM is running. It is odd that it is using the *CNAPI* endpoint to check the VM status. IMO it should check *VMAPI*. Then when \"VMAPI GetVm\" has state\u003drunning, it will have the ip information. There could be a block there that sets \"inst.ip\" from that if \"inst\" doesn\u0027t already have an ip."},{"file":"lib/procedures/shared.js","line":711,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. Definitely a much better idea"},{"file":"test/create.test.js","line":26,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I know this isn\u0027t a part of your change here, so as separate work would be fine. A better query here would be:\n\n    vmadm lookup alias\u003d~\u0027^napi\\d$\u0027\n\nAlso... I wonder if this create.test.js could change to using, say, the \u0027amonredis\u0027 or \u0027redis\u0027 services instead. I worry that briefly having an extra napi zone could cause some havoc in Triton operation."},{"file":"test/create.test.js","line":26,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I think the only reason for Marsell to pick NAPI was b/c that was the VM using less resources. Anyway, given those resources will be used only for the life of tests, I\u0027ll change to use amonredis instead. I will also apply the other change (regex) as part of TOOLS-1469"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":45,"deletions":-3},{"file":"test/create.test.js","type":"MODIFIED","insertions":72,"deletions":-28}],"sizeInsertions":117,"sizeDeletions":-31},{"number":"5","revision":"a82306ad0605e8edadc90c6570ef0efc0ae427ae","parents":["e98ed967f1662f002126cf8e0c996f2255578995"],"ref":"refs/changes/82/382/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1474286537,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474286575,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/shared.js","line":323,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is a little misleading. This function isn\u0027t waiting for VMAPI to report \"running\" *only* to get the ip. Waiting for \"state\u003drunning\" is still the first step is waiting for it to be up.\n\nSuggested comment block:\n\nIf this inst was just created (via SAPI CreateInstance), it won\u0027t yet have an IP (`inst.ip`) that is needed by checkHealth. When VMAPI reports state\u003drunning, it will have an IP that we can add to `inst`."},{"file":"lib/procedures/shared.js","line":323,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":324,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"address\""},{"file":"lib/procedures/shared.js","line":324,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":325,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: end sentences with a period. :)"},{"file":"lib/procedures/shared.js","line":325,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":28,"deletions":-7},{"file":"test/create.test.js","type":"MODIFIED","insertions":72,"deletions":-28}],"sizeInsertions":100,"sizeDeletions":-35},{"number":"6","revision":"ba692d78ab118dc928fe87416d441402c022f2d9","parents":["e98ed967f1662f002126cf8e0c996f2255578995"],"ref":"refs/changes/82/382/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1474309313,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474309359,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474309400,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474309400,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1474309490,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":27,"deletions":-7},{"file":"test/create.test.js","type":"MODIFIED","insertions":72,"deletions":-28}],"sizeInsertions":99,"sizeDeletions":-35}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}