From ae589cd522e3a06cfea1266d29e6fa4ac180df0b Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Wed, 10 May 2017 19:13:15 +0200
Subject: [PATCH] TOOLS-1773 sdcadm experimental update-agents should use
 node's fs API instead of fork to use symlink/unlink

---
 lib/sdcadm.js | 30 +++++++++++++-----------------
 1 file changed, 13 insertions(+), 17 deletions(-)

diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 4d1f268..9ed72e5 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -1724,27 +1724,23 @@ SdcAdm.prototype.updateAgents = function updateAgents(options, callback) {
 
         function createLatestSymlink(_, next) {
             if (justDownload) {
-                return next();
+                next();
+                return;
             }
-            // TODO: this should just use `fs.unlink/symlink`.
-            progress('Create /usbkey/extra/agents/latest symlink');
-            common.execFilePlus({
-                argv: [ 'rm', '-f', '/usbkey/extra/agents/latest' ],
-                log: self.log
-            }, function (rmErr) {
-                if (rmErr) {
-                    return next(rmErr);
+            var symlink = '/usbkey/extra/agents/latest';
+            progress('Create %s symlink', symlink);
+            fs.unlink(symlink, function (unlinkErr) {
+                if (unlinkErr) {
+                    next(unlinkErr);
+                    return;
                 }
                 fname = path.basename(filepath);
-                common.execFilePlus({
-                    argv: ['ln', '-s', fname, 'latest'],
-                    cwd: '/usbkey/extra/agents',
-                    log: self.log
-                }, function (lnErr) {
-                    if (lnErr) {
-                        return next(lnErr);
+                fs.symlink(fname, symlink, function (symlinkErr) {
+                    if (symlinkErr) {
+                        next(symlinkErr);
+                        return;
                     }
-                    return next();
+                    next();
                 });
             });
         },
-- 
2.21.0

