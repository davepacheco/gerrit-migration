From 5db34e6b8f95b1f58be1ce248750b5981b1f7b24 Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Tue, 13 Mar 2018 16:02:49 -0700
Subject: [PATCH] VOLAPI-90 UpdateVolume endpoint should return updated
 resource

---
 lib/endpoints/volumes.js                      | 22 +++++----------
 .../nfs-shared-volumes-update.test.js         | 27 ++++++++++++++++---
 2 files changed, 30 insertions(+), 19 deletions(-)

diff --git a/lib/endpoints/volumes.js b/lib/endpoints/volumes.js
index da29abc..d2f1cb2 100644
--- a/lib/endpoints/volumes.js
+++ b/lib/endpoints/volumes.js
@@ -1393,6 +1393,8 @@ function updateVolume(req, res, next) {
                 volumeObject.value.name = newVolumeName;
             }
 
+            req.responseVolume = volumeObject.value;
+
             volumesModel.updateVolumeWithRetry(volumeObject.value.uuid,
                 volumeObject, done);
         }
@@ -1752,22 +1754,10 @@ function mount(config, server, applicationState) {
         version: '1.0.0'
     }, restify.bodyParser(), validateUpdateVolume,
         volumesMiddlewares.loadVolumeObject,
-        /*
-         * We purposedly do _not_ render the volume, as we would need to either:
-         *
-         * 1. render the original volume, which is not useful when we try to
-         * update (change) it.
-         *
-         * 2. render the result of the update, which would require to load the
-         * volume object from moray, adding more latency to the request's
-         * response.
-         *
-         * Instead, we reply with a 204 HTTP status code (no content) and
-         * clients can send a GetVolume request if/when they want to get the
-         * representation of the modified volume.
-         */
-        updateVolume, renderingMiddlewares.makeSendResponseHandler({
-            statusCode: 204
+        updateVolume,
+        renderVolume,
+        renderingMiddlewares.makeSendResponseHandler({
+            statusCode: 200
         }));
 
     server.post({
diff --git a/test/integration/nfs-shared-volumes-update.test.js b/test/integration/nfs-shared-volumes-update.test.js
index d6ab9f1..b75b8f0 100644
--- a/test/integration/nfs-shared-volumes-update.test.js
+++ b/test/integration/nfs-shared-volumes-update.test.js
@@ -99,7 +99,19 @@ test('Updating NFS shared volumes', function (tt) {
                 CLIENTS.volapi.updateVolume({
                     uuid: CREATED_VOLUMES[0],
                     name: UPDATED_VOLUME_NAME
-                }, next);
+                }, function onVolUpdated(volUpdateErr, updatedVol) {
+                    t.ifError(volUpdateErr, 'updating volume should not error');
+                    t.ok(updatedVol,
+                        'volume update response should not be empty');
+
+                    if (updatedVol) {
+                        t.equal(updatedVol.name, UPDATED_VOLUME_NAME,
+                            'volume update should return volume with updated ' +
+                                'name');
+                    }
+
+                    next(volUpdateErr);
+                });
             },
             function checkVolumeUpdated(_, next) {
                 CLIENTS.volapi.getVolume({
@@ -128,8 +140,17 @@ test('Updating NFS shared volumes', function (tt) {
             function updateVol(_, next) {
                 CLIENTS.volapi.updateVolume({
                     uuid: CREATED_VOLUMES[0]
-                }, function onUpdateVol(updateVolErr) {
-                    t.ifError(updateVolErr, 'updating volume should succeed');
+                }, function onUpdateVol(updateVolErr, updatedVol) {
+                    t.ifError(updateVolErr, 'updating volume should not error');
+                    t.ok(updatedVol,
+                        'volume update response should not be empty');
+
+                    if (updatedVol) {
+                        t.equal(updatedVol.name, UPDATED_VOLUME_NAME,
+                            'volume update should return volume with updated ' +
+                                'name');
+                    }
+
                     next(updateVolErr);
                 });
             },
-- 
2.21.0

