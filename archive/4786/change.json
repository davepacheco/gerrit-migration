{"project":"joyent/triton-cns","branch":"master","id":"I6a03175033a2a468fd7d16098c2b109af6b86df1","number":"4786","subject":"TRITON-359 CNS CMON names for CNs causing sadness Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/4786","commitMessage":"TRITON-359 CNS CMON names for CNs causing sadness\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1536110784,"lastUpdated":1536283367,"open":false,"status":"MERGED","comments":[{"timestamp":1536110784,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1536110818,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536170877,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1536193803,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1536193831,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1536194062,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1536194091,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536271080,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1536271466,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1536272351,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)"},{"timestamp":1536283200,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1536283207,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1536283274,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1536283275,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1536283367,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"ea99c689a2c331667fe1ab2a8ba599ef8ba3e2cb","parents":["7212189f1398f2e4c0b5252bd970cdc3e141231e"],"ref":"refs/changes/86/4786/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536283274,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536194091,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536272351,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283200,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1536283275,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cn-filter.js","type":"MODIFIED","insertions":234,"deletions":-69}],"sizeInsertions":234,"sizeDeletions":-69},"patchSets":[{"number":"1","revision":"4185fe98370ded13a6c29096aa91537531ca6b16","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/86/4786/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536110784,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536110818,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cn-filter.js","line":82,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we return from this point, what will make sure that we ever call updateServers on the timer again? It seems like we\u0027ll only end up here if someone calls the transform stream."},{"file":"lib/cn-filter.js","line":90,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"How are items removed from this cache?"},{"file":"lib/cn-filter.js","line":111,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"There are two sources that can call into updateServers(). The first is the timer established here and in CNFilter().\n\nHowever, CNFilter.prototype._transform also can call into setTimeout. What stops the following from happening:\n\n- Timer is set, in CNFilter() constructor.\n- Timer fires and we end up blocked calling self.client.get(). This deletes the timer entry point that was established.\n- The _transform entry point is called. Because no timer is currently set, it does not delete anything and ends up in self.client.get().\n- Both self.client.get() calls return. Both will end up calling setTimeout, potentially clobbering whomever beat them first, as there is no way out."},{"file":"lib/cn-filter.js","line":182,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we only push one fake CN every iteration with a delay? Is there a reason we\u0027re not doing this until it returns false? Is that enforced delay here important?"},{"file":"lib/cn-filter.js","line":191,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"How did you come up with the increase and delay functions? A comment explaining the origins would be good. Perhaps consider a block comment with the \u00272\u0027 and \u00270.8\u0027 as identifiers so they\u0027re not magic numbers."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cn-filter.js","type":"MODIFIED","insertions":51,"deletions":-3}],"sizeInsertions":51,"sizeDeletions":-3},{"number":"2","revision":"9de01f5c854ac59cfa26f1edcdf0fb251a9242f6","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/86/4786/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536193803,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1536193831,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cn-filter.js","line":46,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer stream hides an identifier in a parent scope"},{"file":"lib/cn-filter.js","line":170,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer req hides an identifier in a parent scope"},{"file":"lib/cn-filter.js","line":207,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: err"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cn-filter.js","type":"MODIFIED","insertions":235,"deletions":-69}],"sizeInsertions":235,"sizeDeletions":-69},{"number":"3","revision":"6a03175033a2a468fd7d16098c2b109af6b86df1","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/86/4786/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536194062,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536272351,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283200,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536194091,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cn-filter.js","line":117,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I assume this is a regular warning we want to have in the log? There\u0027s no corresponding log when we return from this state."},{"file":"lib/cn-filter.js","line":117,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yeah, if we\u0027re hitting this condition a lot there\u0027s probably something wrong, so it\u0027d be nice to have it in the logs. The reaper logs something similar when the pipeline is persistently full when it tries to push."},{"file":"lib/cn-filter.js","line":187,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We seem to ignore the dripfeeder\u0027s backpressure. What keeps the drip feeder from accumulating more entries than it can contain?"},{"file":"lib/cn-filter.js","line":187,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"\"More entries than it can contain\" -- heh heh it doesn\u0027t really have a limit. In theory, we can keep adding things to its queue until we run out of memory.\n\nIn practice though the most we could add here is the entire set of CNs, and we only add ones that change after that, so it\u0027s \"fine\". I guess we could be paranoid and make DripFeeder have a limit for how much it will allow in its queue before exploding the process, but idk."},{"file":"lib/cn-filter.js","line":187,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Well, it sounds like it\u0027s being bounded in other ways then at least. Hopefully the memory for 10k CNs isn\u0027t too bad."},{"file":"lib/cn-filter.js","line":218,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why is this based on the waiters length? In theory haven\u0027t you just removed them all? I guess the theory is that we don\u0027t care about waiting any interval to do work because someone else came and asked us to do something? Is that right?"},{"file":"lib/cn-filter.js","line":218,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We\u0027ve just run a bunch of arbitrary callback functions somebody else gave us, and one of those could have gone and called afterUpdate() on us again (requesting another update). If they did, we\u0027ll go straight back around to making another update. Otherwise, to sleep."},{"file":"lib/cn-filter.js","line":218,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, make sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cn-filter.js","type":"MODIFIED","insertions":234,"deletions":-69}],"sizeInsertions":234,"sizeDeletions":-69},{"number":"4","revision":"0695cf9e83d001c793998a5fcfa742c8e84d0e62","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/86/4786/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536283207,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536272351,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283200,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536194091,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cn-filter.js","type":"MODIFIED","insertions":234,"deletions":-69}],"sizeInsertions":234,"sizeDeletions":-69},{"number":"5","revision":"ea99c689a2c331667fe1ab2a8ba599ef8ba3e2cb","parents":["7212189f1398f2e4c0b5252bd970cdc3e141231e"],"ref":"refs/changes/86/4786/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536283274,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536272351,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283200,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1536283275,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536194091,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cn-filter.js","type":"MODIFIED","insertions":234,"deletions":-69}],"sizeInsertions":234,"sizeDeletions":-69}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}