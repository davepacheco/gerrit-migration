{"project":"joyent/illumos-joyent","branch":"master","id":"I08e6479aa08c33355170328482371691f5f34e1a","number":"1986","subject":"OS-6065 add support for xsaveopt or xsavec for improved context switching OS-6136 better handling for AMD-specifc *save_ctxt FP exceptions Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: R","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1986","commitMessage":"OS-6065 add support for xsaveopt or xsavec for improved context switching\nOS-6136 better handling for AMD-specifc *save_ctxt FP exceptions\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1495552616,"lastUpdated":1495717539,"open":false,"status":"MERGED","comments":[{"timestamp":1495552616,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1495552666,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI combined both sets of changes here which might be easier to review overall. I don\u0027t want to integrate until after the release is cut."},{"timestamp":1495579496,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1495602417,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review+1\n\n(5 comments)"},{"timestamp":1495627975,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1495628178,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1495637020,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1495637212,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1495637644,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI\u0027ve tested on my SmartOSVM and confirmed that the xsavep and fpsave_ctxt are using \u0027xsave\u0027. I\u0027ve tested on a skylake and confirmed it\u0027s using \u0027xsaveopt\u0027. Patrick tested on his old AMD box (which has no xsave support) and confirmed that fpsave_ctxt is set to fpxsave_excp_clr_ctxt."},{"timestamp":1495638271,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1495714069,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1495714166,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1495717539,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"08e6479aa08c33355170328482371691f5f34e1a","parents":["84bcaf3e99852f02e418c4603d2c35ac0494a6b9"],"ref":"refs/changes/86/1986/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495714166,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637020,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637212,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495638271,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1495717539,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":32,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"usr/src/uts/i86pc/sys/asm_misc.h","type":"MODIFIED","insertions":1,"deletions":-19},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":184,"deletions":-41},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":43,"deletions":-14},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":338,"sizeDeletions":-81},"patchSets":[{"number":"1","revision":"1f6c29d61259109efcb7c1eccddefe606113d08c","parents":["436974b4ff52a42762168eebf02f0457894b526b"],"ref":"refs/changes/86/1986/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495552616,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495579496,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495602417,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1896,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: Is storing this in an explicit field necessary?  When (if?) we enable this override, we could perform the check in the below need_fp_excp... function."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1896,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"No, its not necessary but it just seemed easier to read this way. If we do get modern AMD HW and revisit this, we can take another look at this at that time."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":3569,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: I think \u0027handling\u0027 is a bit misleading here. Something like \u0027clearing\u0027 might better describe what\u0027s required.  Your call."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":3569,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":311,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Follow-up:  According to recent documentation (the AMD optimization guide for the 16h family), the two (or later suggested three) byte return immediately following a branch is no longer necessary as of the 15h family.  Perhaps at some point we should choose to clean it up.  (It would be nice to know what, if any, impact it has on Intel microprocessors.)"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":311,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I don\u0027t think we\u0027ll use this function on any modern system, so its probably not worth spending time on."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":385,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: \u0027excp\u0027 was used for the abbreviation elsewhere.  It might be prudent to follow that for consistency."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":385,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":461,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you say the comments above fpxsave_excp_clr_ctxt()? Otherwise in isolation it may be hard to figure out what this is referring to."},{"file":"usr/src/uts/intel/ia32/ml/float.s","line":461,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/intel/ia32/os/fpu.c","line":169,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: s/function/function pointer/? (since we aren\u0027t touching the text itself)"},{"file":"usr/src/uts/intel/ia32/os/fpu.c","line":169,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":32,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"usr/src/uts/i86pc/sys/asm_misc.h","type":"MODIFIED","insertions":1,"deletions":-19},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":182,"deletions":-41},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":43,"deletions":-14},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":336,"sizeDeletions":-81},{"number":"2","revision":"e2ada575da62e14c8d8837c9f74c2160b788ff17","parents":["436974b4ff52a42762168eebf02f0457894b526b"],"ref":"refs/changes/86/1986/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495628178,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637020,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495638271,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637212,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":32,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"usr/src/uts/i86pc/sys/asm_misc.h","type":"MODIFIED","insertions":1,"deletions":-19},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":184,"deletions":-41},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":43,"deletions":-14},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":338,"sizeDeletions":-81},{"number":"3","revision":"631fee98291d8cad41a69c2cd86f61cca4fc6550","parents":["84bcaf3e99852f02e418c4603d2c35ac0494a6b9"],"ref":"refs/changes/86/1986/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495714069,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637020,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495638271,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637212,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":32,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"usr/src/uts/i86pc/sys/asm_misc.h","type":"MODIFIED","insertions":1,"deletions":-19},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":184,"deletions":-41},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":43,"deletions":-14},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":338,"sizeDeletions":-81},{"number":"4","revision":"08e6479aa08c33355170328482371691f5f34e1a","parents":["84bcaf3e99852f02e418c4603d2c35ac0494a6b9"],"ref":"refs/changes/86/1986/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1495714166,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637020,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1495638271,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1495717539,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1495637212,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":32,"deletions":0},{"file":"usr/src/uts/i86pc/os/fpu_subr.c","type":"MODIFIED","insertions":63,"deletions":-3},{"file":"usr/src/uts/i86pc/sys/asm_misc.h","type":"MODIFIED","insertions":1,"deletions":-19},{"file":"usr/src/uts/intel/ia32/ml/exception.s","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/intel/ia32/ml/float.s","type":"MODIFIED","insertions":184,"deletions":-41},{"file":"usr/src/uts/intel/ia32/os/fpu.c","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"usr/src/uts/intel/sys/fp.h","type":"MODIFIED","insertions":43,"deletions":-14},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":338,"sizeDeletions":-81}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}