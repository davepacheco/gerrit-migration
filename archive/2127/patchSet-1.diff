From 7e67d8705e690f20e97e8ed90b0d19c2aa69f6df Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 19 Jun 2017 15:32:31 -0700
Subject: [PATCH] OS-6185 use pigz (parallel gunzip uncompression) to speed up
 imgadm import

---
 src/img/sbin/chroot-gtar     |  4 ++--
 src/img/sbin/gtar-unlink-dir | 14 ++++++++------
 2 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/src/img/sbin/chroot-gtar b/src/img/sbin/chroot-gtar
index 15fb1bc1..95959a15 100755
--- a/src/img/sbin/chroot-gtar
+++ b/src/img/sbin/chroot-gtar
@@ -105,8 +105,8 @@ rm -rf $BINDIR
 mkdir $BINDIR
 cp /usr/img/sbin/gtar-unlink-dir $BINDIR/
 CMDS="gtar"
-CMDS="$CMDS cat gzip bzip2 xzcat"
-CMDS="$CMDS bash rm grep sed tee"
+CMDS="$CMDS cat pigz bzip2 xzcat"
+CMDS="$CMDS bash rm grep sed tee nice"
 for cmd in $CMDS; do
     cp $(which $cmd) $BINDIR/
 done
diff --git a/src/img/sbin/gtar-unlink-dir b/src/img/sbin/gtar-unlink-dir
index 64004ebb..5f7d0014 100755
--- a/src/img/sbin/gtar-unlink-dir
+++ b/src/img/sbin/gtar-unlink-dir
@@ -62,21 +62,23 @@ function gtar_unlink_dir
     gtarargs="$4"
 
     local attempts=5
+    local nicecommand="nice -n 5"
     local status=
     local uncompresscat=
-    local uncompressopt=
+    local uncompresscatopts=
+    local uncompressgtaropts=
 
     case $compression in
     none)
         uncompresscat=cat
         ;;
     gzip)
-        uncompresscat=cat
-        uncompressopt=z
+        uncompresscat=pigz
+        uncompresscatopts="-dc -p 2"
         ;;
     bzip2)
         uncompresscat=cat
-        uncompressopt=j
+        uncompressgtaropts=j
         ;;
     xz)
         uncompresscat=xzcat
@@ -93,8 +95,8 @@ function gtar_unlink_dir
         attempts=$(( $attempts - 1 ))
 
         set +o errexit
-        $uncompresscat $tarball \
-            | gtar -C "$subdir" -x${uncompressopt}f - $gtarargs 2>$STDERR_FILE
+        $nicecommand $uncompresscat $uncompresscatopts $tarball \
+            | gtar -C "$subdir" -x${uncompressgtaropts}f - $gtarargs 2>$STDERR_FILE
         status=$?
         set -o errexit
 
-- 
2.21.0

