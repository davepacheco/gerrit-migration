{"project":"joyent/illumos-joyent","branch":"master","id":"I3023586c46cb6a2dd392cf1f47178de7bcca1af8","number":"5992","subject":"OS-7674 i40e LSO panic when sending from bhyve OS-7679 bad assert in i40e_tx_set_data_desc() OS-7730 i40e freeze on exact MSS boundary followed by copy TCB Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.co","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/5992","commitMessage":"OS-7674 i40e LSO panic when sending from bhyve\nOS-7679 bad assert in i40e_tx_set_data_desc()\nOS-7730 i40e freeze on exact MSS boundary followed by copy TCB\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1553116569,"lastUpdated":1555361426,"open":false,"status":"MERGED","comments":[{"timestamp":1553116569,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1553117260,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1553117369,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1553119226,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1553199195,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1553547132,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1554827669,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(2 comments)\n\nI\u0027m testing a new patch set now that fixes another freeze. But wanted to respond now beforehand in case I need to make more mods."},{"timestamp":1554917104,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1555013843,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4."},{"timestamp":1555015715,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1555023588,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1555354560,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nTesting notes added to tickets."},{"timestamp":1555360945,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1555361318,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1555361418,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1555361426,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"6","revision":"3023586c46cb6a2dd392cf1f47178de7bcca1af8","parents":["f45a4a6a71194fb218dc93b77f1d5f597d25cfd3"],"ref":"refs/changes/92/5992/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1555361418,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555015715,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555023588,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555360945,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1555361425,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":41,"deletions":-15}],"sizeInsertions":45,"sizeDeletions":-15},"patchSets":[{"number":"1","revision":"f911a2fd1658f1b47c2ba6b160248aefbb351ea7","parents":["ade6c39b187fff41cf5c7f6bc2b5761c8ee9418a"],"ref":"refs/changes/92/5992/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1553116569,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2551,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since we probably need to do the MBLKL() in your loop below, maybe skip it here?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2590,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: could make this const"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2590,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This is the len for the first mblk, but if we go past that it\u0027ll be stale.  Need to do \u0027mp_len \u003d MBLKL()\u0027 on each loop."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2590,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sorry, I overlooked it being set in the \"make sure we\u0027re not in a zero-length mblk loop.  Would it perhaps make sense to do that at the top of the \u0027hdrcopied \u003c hdrlen\u0027 loop?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2590,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2590,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"That won\u0027t work if we just fulfilled the hdrlen AND we consumed the entire mblk. We would set mp to b_cont, jump to top of while, condition is false, and mp_len would still be set to length of previous mp."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2598,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Probably should check mp !\u003d NULL here too"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2598,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I didn\u0027t check for NULL on purpose (also checking for zero in the header mblks is extremely paranoid but I did it anyways). I don\u0027t think we could ever have a producer building an mblk chain where we can\u0027t meet the header length. That said, if we want to be paranoid then I would want to add the check early in i40e_ring_tx(), so we can assume sanity here."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2598,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I guess I\u0027ll defer to you on the required level of paranoia, but I\u0027m not fond of iterating through b_cont chains w/o a NULL check, even if such a state would violate our assumptions about upstream producers being reasonable."},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2598,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"This seems like defensive programming to me. I would hope we can make certain assumptions at certain levels. For this driver in particular we already have other places making the same assumptions: mac_ether_offload_info() makes calls into the various i40e_meoi_get helpers which assume the b_cont chain is long enough to handle the seek. So we\u0027d want to fix up that as well.\n\nI think if we are going to do this we do it once, as early as possible, in the Tx function; letting the child functions assume non-null versus checking it every time. And if we are going to do that perhaps we do it in a follow up patch so that we can get bhyve + i40e working again."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":18,"deletions":-13}],"sizeInsertions":18,"sizeDeletions":-13},{"number":"2","revision":"1fe0b68798a80c800402bce9d60795371a8adb99","parents":["ade6c39b187fff41cf5c7f6bc2b5761c8ee9418a"],"ref":"refs/changes/92/5992/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1553199195,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2612,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m not sure if this still holds, now that we may have copied 0 or more whole mblks as part of the header?"},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","line":2612,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"We will always copy at least one (or part of one) mblk to get the header copied, but we may need to copy more than one to consume the entire header.\n\nIn any case, if the mblk following the header is going to be copied into the same TCB/descriptor (because it\u0027s below the DMA threshold), then we need to count it as two since that\u0027s how the controller will view it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":19,"deletions":-14}],"sizeInsertions":19,"sizeDeletions":-14},{"number":"3","revision":"890e216a0a0493ecaa2662b3b5021ca894469de1","parents":["ade6c39b187fff41cf5c7f6bc2b5761c8ee9418a"],"ref":"refs/changes/92/5992/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1554917104,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":29,"deletions":-15}],"sizeInsertions":29,"sizeDeletions":-15},{"number":"4","revision":"10da5c9f4f82645e82ade59956c02c1e66f24c61","parents":["ade6c39b187fff41cf5c7f6bc2b5761c8ee9418a"],"ref":"refs/changes/92/5992/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1555013843,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555023588,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555015715,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555360945,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":41,"deletions":-15}],"sizeInsertions":45,"sizeDeletions":-15},{"number":"5","revision":"a1d84cd499f8bb02f5945db2a551b2c734f8fa06","parents":["f45a4a6a71194fb218dc93b77f1d5f597d25cfd3"],"ref":"refs/changes/92/5992/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1555361318,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555023588,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555015715,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555360945,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":41,"deletions":-15}],"sizeInsertions":45,"sizeDeletions":-15},{"number":"6","revision":"3023586c46cb6a2dd392cf1f47178de7bcca1af8","parents":["f45a4a6a71194fb218dc93b77f1d5f597d25cfd3"],"ref":"refs/changes/92/5992/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1555361418,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555023588,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555015715,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555360945,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1555361425,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_stats.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_transceiver.c","type":"MODIFIED","insertions":41,"deletions":-15}],"sizeInsertions":45,"sizeDeletions":-15}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}