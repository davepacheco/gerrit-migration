{"project":"joyent/illumos-joyent","branch":"master","id":"Id995dda41781c812878c84191b0e974aacb0cad0","number":"1558","subject":"OS-5981 move eventfd in-kernel Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1558","commitMessage":"OS-5981 move eventfd in-kernel\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1487866949,"lastUpdated":1487949197,"open":false,"status":"MERGED","comments":[{"timestamp":1487866949,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1487867788,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1487869749,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1487869762,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1487869897,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1487873598,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nre-tested as per the ticket and everything is still good"},{"timestamp":1487875071,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)"},{"timestamp":1487875914,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1487876006,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1487916166,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1487941273,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1487946711,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1487948012,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1487949031,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1487949172,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1487949197,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"6","revision":"d995dda41781c812878c84191b0e974aacb0cad0","parents":["5aec78b7557582a383784efd80c5b2c985099436"],"ref":"refs/changes/58/1558/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487949172,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487876006,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487946711,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487949031,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1487949197,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":126,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":141,"sizeDeletions":-35},"patchSets":[{"number":"1","revision":"e2427e119a009ba42e3dc086b5afa042df1e0f3c","parents":["8c2ed3e9b7805d10816f461c713c63a8363fa61a"],"ref":"refs/changes/58/1558/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487866949,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":29,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would add a comment about this being used by AIO (and friends?)."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":29,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":59,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Have you checked to see if this works in a chroot?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":59,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I have not tested chroot but there should be no difference in behavior from our existing code here."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":70,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If you turn this error case into \u0027VN_RELE(vp); vp \u003d NULL; goto error;\u0027, then you could move the VOP_CLOSE() from all the other error cases down to L115, simplifying the other checks."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":70,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":82,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe skip this if val \u003d\u003d 0?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":82,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":124,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-35},{"number":"2","revision":"c79557a5037a26b3b066e34cfe7c51e921e97d37","parents":["8c2ed3e9b7805d10816f461c713c63a8363fa61a"],"ref":"refs/changes/58/1558/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487869762,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":123,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":138,"sizeDeletions":-35},{"number":"3","revision":"3b6520508ef283f4aa71c5067d34ff3c5cfb05b5","parents":["8c2ed3e9b7805d10816f461c713c63a8363fa61a"],"ref":"refs/changes/58/1558/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487869897,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487875071,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":48,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Minor style nit, if you deem it appropriate: A handful of these variables (val, rv, auio, aiov) could be moved into child scopes.  I\u0027m not sure if there are conventions about that sort of thing or if it falls to pure preference.\n\nYour call."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":58,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We should be able to return (set_errno()) here if the falloc fails."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":124,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-35},{"number":"4","revision":"59302c6589dd14c8604819b390d644ffef1d320c","parents":["8c2ed3e9b7805d10816f461c713c63a8363fa61a"],"ref":"refs/changes/58/1558/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487875914,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487876006,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487946711,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":30,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I don\u0027t see where this is used. I searched with csgrep and grep on master. What am I missing?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","line":30,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It is not used yet but it will be once I integrate the next set of aio changes. The whole point of this change is in support of OS-5944."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":126,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":141,"sizeDeletions":-35},{"number":"5","revision":"092a80df69359e025085d70efecea0a76f2645c9","parents":["5aec78b7557582a383784efd80c5b2c985099436"],"ref":"refs/changes/58/1558/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487948012,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487876006,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487949031,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487946711,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":126,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":141,"sizeDeletions":-35},{"number":"6","revision":"d995dda41781c812878c84191b0e974aacb0cad0","parents":["5aec78b7557582a383784efd80c5b2c985099436"],"ref":"refs/changes/58/1558/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1487949172,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1487949197,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487876006,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487949031,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487946711,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/brand/lx/lx_brand/common/misc.c","type":"MODIFIED","insertions":0,"deletions":-23},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/sys/lx_misc.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_eventfd.c","type":"ADDED","insertions":126,"deletions":0},{"file":"usr/src/uts/intel/Makefile.files","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":141,"sizeDeletions":-35}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}