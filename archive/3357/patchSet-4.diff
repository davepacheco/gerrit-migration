From e84609fec7c2769efad6ca61995fdb5fff387a90 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Wed, 14 Feb 2018 11:33:57 -0800
Subject: [PATCH] TRITON-122 docker tests can end up with a lot of binary data
 in the output process invoked by execPlus function fails

---
 test/integration/cli-copy.test.js |  5 ++++-
 test/integration/helpers.js       |  2 ++
 test/lib/common.js                | 21 ++++++++++++++++++++-
 tools/rsync-to                    |  1 +
 4 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/test/integration/cli-copy.test.js b/test/integration/cli-copy.test.js
index 37ac311..4f8a2e0 100644
--- a/test/integration/cli-copy.test.js
+++ b/test/integration/cli-copy.test.js
@@ -27,6 +27,8 @@ var h = require('./helpers');
 var vm = require('../lib/vm');
 var configLoader = require('../../lib/config-loader.js');
 
+var STDIO_ON_ERROR_SIZE = 0;
+
 var STATE = {
     log: require('../lib/log')
 };
@@ -615,7 +617,8 @@ function copyFileOut(tt, remotefn, localfn, containerName, callback) {
         'cp "%s:%s" - | tar xOf - "%s"',
         containerName, remotefn, localfn);
     var execOpts = { maxBuffer: 1024*1024+1, encoding: 'binary' };
-    cli.docker(args, { execOpts: execOpts }, onDocker);
+    cli.docker(args, {
+        maxStdoutOnError: STDIO_ON_ERROR_SIZE, execOpts: execOpts }, onDocker);
     function onDocker(err, stdout, stderr) {
         tt.ifErr(err);
         var str = stdout.toString();
diff --git a/test/integration/helpers.js b/test/integration/helpers.js
index 8536f23..c4359c9 100644
--- a/test/integration/helpers.js
+++ b/test/integration/helpers.js
@@ -828,6 +828,8 @@ GzDockerEnv.prototype.exec = function denvExec(cmd, opts, cb) {
         // TODO: escaping single-quotes
         command: fmt('zlogin %s \'%s\'', this.clientZone.uuid, cmd),
         log: this.log,
+        maxStdoutOnError: opts.maxStdoutOnError,
+        maxStderrOnError: opts.maxStderrOnError,
         execOpts: opts.execOpts
     }, cb);
 };
diff --git a/test/lib/common.js b/test/lib/common.js
index c6f2e69..21ccf44 100644
--- a/test/lib/common.js
+++ b/test/lib/common.js
@@ -93,6 +93,8 @@ function execPlus(args, cb) {
     assert.string(args.command, 'args.command');
     assert.optionalString(args.errMsg, 'args.errMsg');
     assert.optionalObject(args.execOpts, 'args.execOpts');
+    assert.optionalBool(args.maxStdoutOnError, 'args.maxStdoutOnError');
+    assert.optionalBool(args.maxStderrOnError, 'args.maxStderrOnError');
     assert.object(args.log, 'args.log');
     assert.func(cb);
     var command = args.command;
@@ -104,6 +106,16 @@ function execPlus(args, cb) {
         args.log.trace({exec: true, command: command, execOpts: execOpts,
             err: err, stdout: stdout, stderr: stderr}, 'exec done');
         if (err) {
+
+            // Render stdio as something we can send to the console.
+            var renderedStdout = args.hasOwnProperty('maxStdoutOnError')
+                ? truncateOutput(stdout, args.maxStdoutOnError)
+                : renderedStdout = stdout.trim();
+
+            var renderedStderr = args.hasOwnProperty('maxStderrOnError')
+                ? truncateOutput(stderr, args.maxStderrOnError)
+                : renderedStderr = stderr.trim();
+
             cb(
                 new VError(err,
                     '%s:\n'
@@ -112,12 +124,19 @@ function execPlus(args, cb) {
                     + '\tstdout:\n%s\n'
                     + '\tstderr:\n%s',
                     args.errMsg || 'exec error', command, err.code,
-                    stdout.trim(), stderr.trim()),
+                    renderedStdout, renderedStderr),
                 stdout, stderr);
         } else {
             cb(null, stdout, stderr);
         }
     });
+
+    function truncateOutput(str, size) {
+        assert.optionalString(str, 'str');
+        assert.optionalNumber(size, 'size');
+        return JSON.stringify(str.slice(0, size))
+            .replace(RegExp('^"(.*)"$', 'g'), '$1', 'g');
+    }
 }
 
 var constants = {
diff --git a/tools/rsync-to b/tools/rsync-to
index 8ef8051..c675f27 100755
--- a/tools/rsync-to
+++ b/tools/rsync-to
@@ -36,6 +36,7 @@ rsync -av ${TOP}/ \
     $NODE:/zones/$DOCKER_ZONE/root/opt/smartdc/docker/ \
     $extraOpts \
     --exclude .git/ \
+    --exclude node_modules \
     --exclude /etc/config.json \
     --exclude /deps/ \
     --exclude /doc/ \
-- 
2.21.0

