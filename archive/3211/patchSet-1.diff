commit dcd38cd0d2cfa62e23f2274bf04fa4e54387c6a8 (refs/changes/11/3211/1)
Author: Orlando Vazquez <ovazquez@gmail.com>
Date:   2018-01-12T14:01:40-08:00 (1 year, 9 months ago)
    
    DOCKER-1140 Handle CNAPI error indicating docker cp'ing is not supported on a stopped container

diff --git a/lib/backends/sdc/containers.js b/lib/backends/sdc/containers.js
index 177631e..10c84e5 100644
--- a/lib/backends/sdc/containers.js
+++ b/lib/backends/sdc/containers.js
@@ -4310,6 +4310,7 @@ function containerArchiveReadStream(opts, callback) {
                 return callback(new errors.NotImplementedError(
                     'copy on stopped container'));
             }
+            log.error({ copyErr: copyErr }, 'other error');
             return callback(errors.cnapiErrorWrap(
                 copyErr, 'problem calling docker copy'));
         }
diff --git a/lib/errors.js b/lib/errors.js
index f74ff55..6c56910 100644
--- a/lib/errors.js
+++ b/lib/errors.js
@@ -566,6 +566,21 @@ PathNotDirectoryError.statusCode = 404;
 PathNotDirectoryError.description = 'path was not to a directory';
 
 
+function NotSupportedError(cause, message) {
+    _DockerBaseError.call(this, {
+        restCode: this.constructor.restCode,
+        statusCode: (cause && cause.statusCode) || this.constructor.statusCode,
+        message: message || "operation not supported",
+        cause: cause
+    });
+}
+util.inherits(NotSupportedError, _DockerBaseError);
+NotSupportedError.prototype.name = 'NotSupportedError';
+NotSupportedError.restCode = 'NotSupported';
+NotSupportedError.statusCode = 409;
+NotSupportedError.description = 'operation not supported';
+
+
 // ---- Volume specific errors
 
 function VolumeSizeNotAvailableError(availableSizes) {
@@ -632,6 +647,11 @@ function cnapiErrorWrap(cause, message, extra) {
         case 'PathNotDirectory':
             return new PathNotDirectoryError();
 
+        case 'DockerCopyStoppedContainerNoPlatformSupport':
+            return new NotSupportedError(cause,
+                '\'docker cp\` on stopped container not' +
+                ' supported on this joyent platform version');
+
         case 'VmNotRunning':
             if (extra && extra.id) {
                 message = 'Container ' + extra.id + ' is not running';
@@ -774,6 +794,7 @@ module.exports = {
     FileNotFoundError: FileNotFoundError,
     NetworkNotFoundError: NetworkNotFoundError,
     PathNotDirectoryError: PathNotDirectoryError,
+    NotSupportedError: NotSupportedError,
 
     VolumeSizeNotAvailableError: VolumeSizeNotAvailableError,
 
