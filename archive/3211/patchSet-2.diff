From 47e6629f5ec7cd37c65b58e7aeb203cb477fe878 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Thu, 25 Jan 2018 16:36:02 -0800
Subject: [PATCH] DOCKER-1140 Handle CNAPI error indicating docker cp'ing is
 not supported on a stopped container

---
 lib/backends/sdc/containers.js |  1 +
 lib/errors.js                  | 21 +++++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/lib/backends/sdc/containers.js b/lib/backends/sdc/containers.js
index 177631e..10c84e5 100644
--- a/lib/backends/sdc/containers.js
+++ b/lib/backends/sdc/containers.js
@@ -4310,6 +4310,7 @@ function containerArchiveReadStream(opts, callback) {
                 return callback(new errors.NotImplementedError(
                     'copy on stopped container'));
             }
+            log.error({ copyErr: copyErr }, 'other error');
             return callback(errors.cnapiErrorWrap(
                 copyErr, 'problem calling docker copy'));
         }
diff --git a/lib/errors.js b/lib/errors.js
index 7d2d574..56140ad 100644
--- a/lib/errors.js
+++ b/lib/errors.js
@@ -566,6 +566,21 @@ PathNotDirectoryError.statusCode = 404;
 PathNotDirectoryError.description = 'path was not to a directory';
 
 
+function NotSupportedError(cause, message) {
+    _DockerBaseError.call(this, {
+        restCode: this.constructor.restCode,
+        statusCode: (cause && cause.statusCode) || this.constructor.statusCode,
+        message: message || "operation not supported",
+        cause: cause
+    });
+}
+util.inherits(NotSupportedError, _DockerBaseError);
+NotSupportedError.prototype.name = 'NotSupportedError';
+NotSupportedError.restCode = 'NotSupported';
+NotSupportedError.statusCode = 409;
+NotSupportedError.description = 'operation not supported';
+
+
 // ---- Volume specific errors
 
 function VolumeSizeNotAvailableError(availableSizes) {
@@ -658,6 +673,11 @@ function cnapiErrorWrap(cause, message, extra) {
         case 'PathNotDirectory':
             return new PathNotDirectoryError();
 
+        case 'DockerCopyStoppedContainerNoPlatformSupport':
+            return new NotSupportedError(cause,
+                '\'docker cp\` on stopped container not' +
+                ' supported on this joyent platform version');
+
         case 'VmNotRunning':
             if (extra && extra.id) {
                 message = 'Container ' + extra.id + ' is not running';
@@ -800,6 +820,7 @@ module.exports = {
     FileNotFoundError: FileNotFoundError,
     NetworkNotFoundError: NetworkNotFoundError,
     PathNotDirectoryError: PathNotDirectoryError,
+    NotSupportedError: NotSupportedError,
 
     VolumeSizeNotAvailableError: VolumeSizeNotAvailableError,
     VolumesNotReachableError: VolumesNotReachableError,
-- 
2.21.0

