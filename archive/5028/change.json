{"project":"joyent/illumos-joyent","branch":"master","id":"If4cb444376b6efe8770e521115e58d5df2379c97","number":"5028","subject":"OS-7151 ZFS loading and unloading metaslabs at audible frequency Reviewed by: Joshua Clulow \u003cjmc@joyent.com\u003e Reviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e Approved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/5028","commitMessage":"OS-7151 ZFS loading and unloading metaslabs at audible frequency\nReviewed by: Joshua Clulow \u003cjmc@joyent.com\u003e\nReviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\nApproved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1541462751,"lastUpdated":1545064394,"open":false,"status":"MERGED","comments":[{"timestamp":1541462751,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1543443863,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1543444737,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1543606667,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1543607935,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2: Code-Review+1\n\nThanks for the changes!"},{"timestamp":1544198062,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)\n\nLooks good!"},{"timestamp":1545061701,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Integration-Approval+1\n\nLooks good. Thanks for the thorough testing and observation!"},{"timestamp":1545064192,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1545064375,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1545064394,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"f4cb444376b6efe8770e521115e58d5df2379c97","parents":["4b3d3b0096454cadc8c9c15703aa2dcc9d6675a9"],"ref":"refs/changes/28/5028/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1545064375,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543607935,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544198062,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545061701,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1545064394,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","type":"MODIFIED","insertions":51,"deletions":-20},{"file":"usr/src/uts/common/fs/zfs/sys/metaslab_impl.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-21},"patchSets":[{"number":"1","revision":"ecede535b927023da33c28d92a84315bce19aed9","parents":["7a70cf1aae9b2e74d5a5f7a0ef7cc6f4b2c6e4c5"],"ref":"refs/changes/28/5028/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1541462751,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":3001,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Do we not still want to keep this stat around, even though we\u0027re not using it for things?"},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":3001,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I can leave it (since it unrelated), but it seems unnecessary to me and I thought it might be nice to just repurpose the useless entry in the structure and keep it the same size. The existing ms_selected_txg entry seems to provide the same exact information as ms_alloc_txg, so I am not sure why we\u0027d ever need this for debugging purposes."},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":159,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It might be worth adding a comment up here about the relationship between these quantities and the existing \"metaslab_unload_delay\".\n\nIs it anticipated that a load window of 10 txgs will be good enough to prevent the thrashing we\u0027ve seen so far?"},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":159,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027ll add a comment. The 10 txgs seemed to perform well in the testing I did on the production machine, but I am unsure what a good value might always be, which is why I made it tunable."},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":2097,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Perhaps just make this VERIFY0()?  I don\u0027t think this is really super hot."},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":2097,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Will do."},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":2750,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Have you thought about maybe a linear ramp here instead of exponential?  Incrementing, even just by one, would give us a slightly slower ramp-up, but a tighter fit in the limit."},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":2750,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"That seems like a good experiment. I\u0027ll build a new rev of the code with a linear ramp and coordinate with Angela on testing that new platform on the same storage node in production so we can see how it compares to the current ramp."},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":3205,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"cstyle nit: the operator should be hoisted up onto the end of the continuing line"},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":3205,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027ll fix this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","type":"MODIFIED","insertions":35,"deletions":-16},{"file":"usr/src/uts/common/fs/zfs/sys/metaslab_impl.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":36,"sizeDeletions":-17},{"number":"2","revision":"735bcd0dea5dbcf24634ea0e64887309b2697001","parents":["aa902e5003c88c1040e012da5bac37e8be18323a"],"ref":"refs/changes/28/5028/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1543606667,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543607935,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544198062,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545061701,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":25,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"copyright nit"},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","line":2764,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do you think it would be useful to include the current txg in this probe too? It might help when trying deduce what decisions this algorithm is making.\n\nOtherwise if folks wanted to they could save it off using the fbt probe for this function."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","type":"MODIFIED","insertions":51,"deletions":-20},{"file":"usr/src/uts/common/fs/zfs/sys/metaslab_impl.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-21},{"number":"3","revision":"941a5ef5c55cc3757c05d1720832b14016df249e","parents":["4b3d3b0096454cadc8c9c15703aa2dcc9d6675a9"],"ref":"refs/changes/28/5028/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1545064192,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543607935,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544198062,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545061701,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","type":"MODIFIED","insertions":51,"deletions":-20},{"file":"usr/src/uts/common/fs/zfs/sys/metaslab_impl.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-21},{"number":"4","revision":"f4cb444376b6efe8770e521115e58d5df2379c97","parents":["4b3d3b0096454cadc8c9c15703aa2dcc9d6675a9"],"ref":"refs/changes/28/5028/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1545064375,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543607935,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1545064394,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544198062,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545061701,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/metaslab.c","type":"MODIFIED","insertions":51,"deletions":-20},{"file":"usr/src/uts/common/fs/zfs/sys/metaslab_impl.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-21}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}