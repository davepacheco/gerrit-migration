{"project":"joyent/illumos-joyent","branch":"master","topic":"nawk-update","id":"Ib4acf023dd2b2008c601d706c1ba8f9684bca593","number":"4948","subject":"OS-7304 Change nawk(1) substitution functions to match upstream and gawk(1) Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jason King \u003cjbk@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/4948","commitMessage":"OS-7304 Change nawk(1) substitution functions to match upstream and gawk(1)\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jason King \u003cjbk@joyent.com\u003e\n","createdOn":1539305901,"lastUpdated":1560451887,"open":false,"status":"MERGED","comments":[{"timestamp":1539305901,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1539390184,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1539997641,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1541789338,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(2 comments)\n\nI have to be honest, I have a lot of challenges following this and feeling like it all makes sense."},{"timestamp":1542132559,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1544737223,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1544837449,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1\n\nOK, thanks for the answers. I still don\u0027t feel really confident in this review. But I\u0027ll +1 it for the time being."},{"timestamp":1548269045,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1548269181,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Topic set to nawk-update"},{"timestamp":1548281012,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1549481170,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1560301477,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1560451783,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1560451887,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"8","revision":"b4acf023dd2b2008c601d706c1ba8f9684bca593","parents":["dc71967bb00f2ca084cee5c8efb7ff3751401206"],"ref":"refs/changes/48/4948/8","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1560451783,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544837449,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548281012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1560451887,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},"patchSets":[{"number":"1","revision":"060df2b561c8b2d9c1e9dc57a5c6d409d606d720","parents":["95436ff3314f01abf1dfa2f5b512775cf31e2915"],"ref":"refs/changes/48/4948/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1539305901,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":110,"deletions":-73},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":151,"sizeDeletions":-77},{"number":"2","revision":"b6c5ce479d3236292370d6f8ff6f54dbd9c99734","parents":["5372312b9ee1ca644ca8fbfa40856c2f1b012963"],"ref":"refs/changes/48/4948/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1539390184,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},{"number":"3","revision":"4fd96e59711ed6719fef956aa7ae00f6701bc7b6","parents":["c9686e1a7970f314511ebcfbb883df342da7a089"],"ref":"refs/changes/48/4948/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1539997641,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"usr/src/cmd/awk/run.c","line":2080,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I assume the change from using memcpy to just copying the bytes across is something that upstream did? Here and in the rest of this."},{"file":"usr/src/cmd/awk/run.c","line":2080,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"upstream has always copied the bytes directly, but it was changed to use memcpy() in:\n\nhttps://github.com/joyent/illumos-joyent/commit/1ee2e5fa222f6d33d1ff1c48f155973a5e146434\n\nI changed it back to this way so that backsub() wouldn\u0027t need to be altered and this code would be closer to upstream."},{"file":"usr/src/cmd/awk/run.c","line":2156,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Any idea where 5 comes from?"},{"file":"usr/src/cmd/awk/run.c","line":2156,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"5 seems to be overly conservative. backsub() only writes at most 2 bytes, and then we write \u0027\\0\u0027 below, so this could be 3."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},{"number":"4","revision":"643695e369d9586f238a2727e7649bd1b8144c3b","parents":["8e37dd659e4643614ea549b3b1e88458e3caaef0"],"ref":"refs/changes/48/4948/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1542132559,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544837449,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},{"number":"5","revision":"7105711e89a284fc7fdc3a0b013f9d01534399df","parents":["00cd49cd25e840e74f9ffdc828e7e6dc54e932ac"],"ref":"refs/changes/48/4948/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1548269045,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544837449,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548281012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},{"number":"6","revision":"2ba3620fd779507fc8b2c23e44d06bab27fda1c9","parents":["d41dc8cce3a225200844d4d81fd46870f3caa095"],"ref":"refs/changes/48/4948/6","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1549481170,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544837449,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548281012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},{"number":"7","revision":"31128c5263d572cc4d92ca113b707b075dac9d7f","parents":["8d3558ca687abcad7abfa9e3ce6b4e9a9ffdaec3"],"ref":"refs/changes/48/4948/7","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1560301477,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544837449,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548281012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76},{"number":"8","revision":"b4acf023dd2b2008c601d706c1ba8f9684bca593","parents":["dc71967bb00f2ca084cee5c8efb7ff3751401206"],"ref":"refs/changes/48/4948/8","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1560451783,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544837449,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1560451887,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548281012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/awk/run.c","type":"MODIFIED","insertions":109,"deletions":-72},{"file":"usr/src/pkg/manifests/system-test-utiltest.mf","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.awk","fileOld":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.awk","type":"RENAMED","insertions":0,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/gawksub.ok","type":"ADDED","insertions":2,"deletions":0},{"file":"usr/src/test/util-tests/tests/awk/gnu/posix2008sub.ok","type":"DELETED","insertions":0,"deletions":-2},{"file":"usr/src/test/util-tests/tests/awk/tests/T.gawk","type":"MODIFIED","insertions":37,"deletions":0}],"sizeInsertions":150,"sizeDeletions":-76}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}