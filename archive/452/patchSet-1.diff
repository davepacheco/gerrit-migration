From e7cd48a9126caf72f44296b00c31db2211c93ad3 Mon Sep 17 00:00:00 2001
From: "Pedro P. Candel" <pedro@joyent.com>
Date: Mon, 12 Sep 2016 18:22:12 +0200
Subject: [PATCH] TOOLS-1527 sdcadm history failures should never make a
 command fail

---
 lib/cli/do_history.js |  12 +++--
 lib/history.js        | 100 ++++++++++++++++++++++-------------
 test/history.test.js  | 120 ++++++++++++++++++++++++++----------------
 3 files changed, 145 insertions(+), 87 deletions(-)

diff --git a/lib/cli/do_history.js b/lib/cli/do_history.js
index 8d687a7..1eab205 100644
--- a/lib/cli/do_history.js
+++ b/lib/cli/do_history.js
@@ -5,9 +5,11 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 var errors = require('../errors');
+var common = require('../common');
+
 var tabula = require('tabula');
 
 var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
@@ -35,7 +37,7 @@ function do_history(subcmd, opts, args, cb) {
             if (err) {
                 return cb(err);
             }
-            console.log(JSON.stringify(hist, null, 4));
+            console.log(JSON.stringify(hist, common.safeCycles(), 4));
             return cb();
         });
     }
@@ -70,7 +72,7 @@ function do_history(subcmd, opts, args, cb) {
         }
 
         if (opts.json) {
-            console.log(JSON.stringify(history, null, 4));
+            console.log(JSON.stringify(history, common.safeCycles(), 4));
         } else {
             var validFieldsMap = {};
             if (!history.length) {
@@ -88,7 +90,7 @@ function do_history(subcmd, opts, args, cb) {
                     }).join(',');
                 }
                 var row = {
-                    uuid: hst.uuid,
+                    uuid: hst.uuid || null,
                     changes: chgs,
                     started: (hst.started ?
                         new Date(hst.started).toJSON() : null),
@@ -98,7 +100,7 @@ function do_history(subcmd, opts, args, cb) {
                         (hst.error.message ?
                          hst.error.message.split('\n', 1)[0] :
                          hst.error) : null),
-                    user: hst.username ? hst.username : null
+                    user: hst.username || null
                 };
 
                 if (row.changes.length > 40) {
diff --git a/lib/history.js b/lib/history.js
index 578bc04..a221ab7 100644
--- a/lib/history.js
+++ b/lib/history.js
@@ -33,6 +33,11 @@ var UUID_RE = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;
 
 
 function saveHistoryToFile(fname, history, cb) {
+    // Avoid saving bogus files:
+    if (!history) {
+        cb(null);
+        return;
+    }
     var s;
     try {
         s = JSON.stringify(history, common.safeCycles());
@@ -43,9 +48,10 @@ function saveHistoryToFile(fname, history, cb) {
         encoding: 'utf8'
     }, function (err) {
         if (err) {
-            return cb(err);
+            cb(err);
+            return;
         }
-        return cb(null);
+        cb(null);
     });
 }
 
@@ -54,9 +60,15 @@ function readHistoryFromFile(fname, cb) {
         encoding: 'utf8'
     }, function (err, data) {
         if (err) {
-            return cb(err);
+            cb(err);
+            return;
         }
-        return cb(null, JSON.parse(data));
+        var history;
+        try {
+            history = JSON.parse(data);
+        } catch (e) {}
+
+        cb(null, history);
     });
 }
 
@@ -109,10 +121,12 @@ History.prototype.saveHistory = function (history, cb) {
     if (history.uuid) {
         assert.string(history.uuid, 'history.uuid');
         if (!UUID_RE.test(history.uuid)) {
-            return cb(new errors.ValidationError({
+            self.sdcadm.log.error({err: new errors.ValidationError({
                 message: 'error validating history UUID',
                 cause: history.uuid + ' is not a valid UUID'
-            }));
+            })});
+            cb();
+            return;
         }
     } else {
         history.uuid = uuid();
@@ -121,10 +135,12 @@ History.prototype.saveHistory = function (history, cb) {
     if (history.started) {
         var d  = new Date(history.started);
         if (d.toJSON() === null) {
-            return cb(new errors.ValidationError({
+            self.sdcadm.log.error({err: new errors.ValidationError({
                 message: 'error validating history start time',
                 cause: history.started + ' is not a valid date'
-            }));
+            })});
+            cb();
+            return;
         }
         history.started = d.getTime();
     } else {
@@ -141,12 +157,15 @@ History.prototype.saveHistory = function (history, cb) {
             var fname = path.join(self.wrkDir, history.uuid + '.json');
             return saveHistoryToFile(fname, history, function (err2) {
                 if (err2) {
-                    return cb(new errors.InternalError({
+                    self.sdcadm.log.error({err: new errors.InternalError({
                         message: 'error saving file: ' + fname,
                         cause: err2
-                    }));
+                    })});
+                    cb();
+                    return;
                 }
-                return cb(null, history);
+                cb(null, history);
+                return;
             });
         }
 
@@ -154,7 +173,7 @@ History.prototype.saveHistory = function (history, cb) {
             history: hist
         }, 'History saved to SAPI');
 
-        return cb(null, history);
+        cb(null, history);
     });
 
 };
@@ -189,10 +208,12 @@ History.prototype.updateHistory = function (history, cb) {
     if (history.finished) {
         var d  = new Date(history.finished);
         if (d.toJSON() === null) {
-            return cb(new errors.ValidationError({
+            self.sdcadm.log.error({err: new errors.ValidationError({
                 message: 'error validating history finish time',
                 cause: history.finished + ' is not a valid date'
-            }));
+            })});
+            cb();
+            return;
         }
         history.finished = d.getTime();
     } else {
@@ -208,7 +229,7 @@ History.prototype.updateHistory = function (history, cb) {
 
             var fname = path.join(self.wrkDir, history.uuid + '.json');
 
-            return readHistoryFromFile(fname, function (err2, hist2) {
+            readHistoryFromFile(fname, function (err2, hist2) {
                 if (err2) {
                     self.sdcadm.log.info({
                         err: err2
@@ -223,28 +244,30 @@ History.prototype.updateHistory = function (history, cb) {
                     });
                 }
 
-                return saveHistoryToFile(fname, hist2, function (err3) {
+                saveHistoryToFile(fname, hist2, function (err3) {
                     if (err3) {
-                        return cb(new errors.InternalError({
+                        self.sdcadm.log.error({err: new errors.InternalError({
                             message: 'error saving file: ' + fname,
                             cause: err3
-                        }));
+                        })});
+                        cb();
+                        return;
                     }
-                    return cb(null, hist2);
+                    cb(null, hist2);
+                    return;
                 });
             });
         }
 
         // On success SAPI update, check if is there any pending history file
         // from previous invocations and we need to catch up:
-        return self.catchUp(function (err4) {
+        self.catchUp(function (err4) {
             if (err4) {
                 self.sdcadm.log.info({
                     err: err4
                 }, 'Error adding history to SAPI. Saved to local files.');
-                return cb(err4, hist);
             }
-            return cb(null, hist);
+            cb(null, hist);
         });
     });
 };
@@ -319,7 +342,7 @@ History.prototype.listHistory = function (opts, cb) {
 History.prototype.catchUp = function (cb) {
     var self = this;
 
-    return self._readHistoryDir(function (files) {
+    self._readHistoryDir(function (files) {
         if (files.length) {
             vasync.forEachPipeline({
                 inputs: files,
@@ -327,16 +350,17 @@ History.prototype.catchUp = function (cb) {
                     var f = path.join(self.wrkDir, item);
                     readHistoryFromFile(f, function (er, data) {
                         if (er) {
-                            return next(er);
+                            next(er);
+                            return;
                         }
 
                         // Avoid raising an error b/c no file contents:
                         if (!data) {
-                            return next();
+                            next();
+                            return;
                         }
 
-                        return self._getOrCreateOnSAPI(data,
-                            function (er2, h) {
+                        self._getOrCreateOnSAPI(data, function (er2, h) {
                             if (er2) {
                                 self.sdcadm.log.info({
                                     err: er2
@@ -350,6 +374,7 @@ History.prototype.catchUp = function (cb) {
                                     }, 'Error removing file: %s', f);
                                 }
                                 next();
+                                return;
                             });
                         });
 
@@ -357,15 +382,14 @@ History.prototype.catchUp = function (cb) {
                 }
             }, function catchUpPipeline(err, results) {
                 if (err) {
-                    return cb(new errors.InternalError({
-                        message: 'error saving history to SAPI',
-                        cause: err
-                    }));
+                    self.sdcadm.log.error({
+                        err: err
+                    }, 'error saving history to SAPI');
                 }
-                return cb(null);
+                cb(null);
             });
         } else {
-            return cb(null);
+            cb(null);
         }
     });
 
@@ -374,14 +398,15 @@ History.prototype.catchUp = function (cb) {
 History.prototype._readHistoryDir = function (cb) {
     var self = this;
 
-    return fs.readdir(self.wrkDir, function (err, files) {
+    fs.readdir(self.wrkDir, function (err, files) {
         if (err) {
-            return cb(new errors.InternalError({
+            cb(new errors.InternalError({
                 message: 'error reading directory: ' + self.wrkDir,
                 cause: err
             }));
+            return;
         }
-        return cb(files);
+        cb(files);
     });
 };
 
@@ -396,6 +421,9 @@ History.prototype._getOrCreateOnSAPI = function (history, cb) {
 
     self.sdcadm.sapi.getHistory(history.uuid, function (err2, hist2) {
         if (err2) {
+            if (!history.started) {
+                history.started = new Date().getTime();
+            }
             self.sdcadm.sapi.addHistory(history, function (err, hist) {
                 if (err) {
                     self.sdcadm.log.info({
diff --git a/test/history.test.js b/test/history.test.js
index 9127d17..4fc035a 100644
--- a/test/history.test.js
+++ b/test/history.test.js
@@ -5,11 +5,14 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 
 var test = require('tape').test;
+var vasync = require('vasync');
+
+var fs = require('fs');
 var exec = require('child_process').exec;
 var common = require('./common');
 
@@ -47,59 +50,65 @@ test('sdcadm history', function (t) {
     var beforeUpdate = new Date();
     var afterUpdate;
 
-    function getOldHistory() {
-        exec('sdcadm history', function (err, stdout, stderr) {
-            t.ifError(err);
-            t.equal(stderr, '');
-
-            origHistory = parseHistory(stdout);
-            origHistory.shift(); // remove column titles
+    vasync.pipeline({
+        funcs: [
+            function getOldHistory(_, next) {
+                exec('sdcadm history', function (err, stdout, stderr) {
+                    t.ifError(err);
+                    t.equal(stderr, '');
 
-            updatePapi();
-        });
-    }
+                    origHistory = parseHistory(stdout);
+                    origHistory.shift(); // remove column titles
+                    next();
+                });
+            },
 
-    function updatePapi() {
-        var cmd = 'sdcadm update papi --force-same-image -y';
+            function updateOther(_, next) {
+                // A command that we can re-run as many times as we need
+                var cmd = 'sdcadm experimental update-other';
 
-        exec(cmd, function (err, stdout, stderr) {
-            t.ifError(err);
-            t.equal(stderr, '');
+                exec(cmd, function (err, stdout, stderr) {
+                    t.ifError(err);
+                    t.equal(stderr, '');
 
-            afterUpdate = new Date();
+                    afterUpdate = new Date();
+                    next();
+                });
+            },
 
-            getNewHistory();
-        });
-    }
+            function getNewHistory(_, next) {
+                exec('sdcadm history', function (err, stdout, stderr) {
+                    t.ifError(err);
+                    t.equal(stderr, '');
 
-    function getNewHistory() {
-        exec('sdcadm history', function (err, stdout, stderr) {
-            t.ifError(err);
-            t.equal(stderr, '');
+                    var newHistory = parseHistory(stdout);
+                    newHistory.shift(); // remove column titles
 
-            var newHistory = parseHistory(stdout);
-            newHistory.shift(); // remove column titles
+                    t.equal(origHistory.length + 1, newHistory.length);
 
-            t.equal(origHistory.length + 1, newHistory.length);
+                    var newest = newHistory[0];
+                    t.ok(newest);
 
-            var newest = newHistory[0];
-            t.ok(newest);
+                    HISTORY_UUID = newest[0];
+                    t.equal(newest[1], 'root');
 
-            HISTORY_UUID = newest[0];
-            t.equal(newest[1], 'root');
+                    t.ok(new Date(newest[2]) <= new Date(newest[3]));
+                    t.ok(new Date(newest[2]) >= beforeUpdate);
+                    t.ok(new Date(newest[3]) <= afterUpdate);
 
-            t.ok(new Date(newest[2]) <= new Date(newest[3]));
-            t.ok(new Date(newest[2]) >= beforeUpdate);
-            t.ok(new Date(newest[3]) <= afterUpdate);
+                    t.notEqual(newest[4].indexOf('update-service-cfg'), -1);
+                    t.equal(newest[5], '-');
 
-            t.equal(newest[4], 'update-service(papi)');
-            t.equal(newest[5], '-');
+                    next();
+                });
+            }
 
-            t.end();
-        });
-    }
+        ]
+    }, function (resErr) {
+        t.ifError(resErr);
+        t.end();
+    });
 
-    getOldHistory();
 });
 
 
@@ -116,7 +125,7 @@ test('sdcadm history --json', function (t) {
             t.ok(entry.uuid.match(common.UUID_RE), entry.uuid + ' is a UUID');
             t.ok(Array.isArray(entry.changes), 'changes is an array');
             // TODO: no username?
-            t.ok(entry.username == 'root' || !entry.username);
+            t.ok(entry.username === 'root' || !entry.username);
             t.ok(new Date(entry.started));
             t.ok(new Date(entry.finished));
         });
@@ -143,8 +152,7 @@ test('sdcadm history <uuid>', function (t) {
         t.equal(typeof (entry.started),  'number');
         t.equal(typeof (entry.finished), 'number');
         t.ok(Array.isArray(entry.changes));
-
-        t.equal(entry.changes[0].service.name, 'papi');
+        t.equal(entry.changes[entry.changes.length - 1].service.name, 'assets');
 
         t.end();
     });
@@ -208,9 +216,8 @@ test('sdcadm history --since', function (t) {
 
         var entries = parseHistory(stdout);
         entries.shift(); // remove column titles
-
         entries.forEach(function (entry) {
-            t.ok(entry[3] >= minimumDate);
+            t.ok(entry[2] >= minimumDate);
         });
 
         t.end();
@@ -235,4 +242,25 @@ test('sdcadm history --until', function (t) {
 
         t.end();
     });
-});
\ No newline at end of file
+});
+
+
+test('sdcadm history bogus files', function (t) {
+    // Create bogus file manually
+    var histDir = '/var/sdcadm/history/';
+    var fpath = histDir + '9887ef12-32f9-4a05-9e38-e99ca15a5758.json';
+
+    fs.writeFile(fpath, 'null', {
+        encoding: 'utf8'
+    }, function (ferr) {
+        t.ifError(ferr);
+
+        // Now verify that this will not cause any error:
+        var cmd = 'sdcadm experimental update-other';
+        exec(cmd, function (err, stdout, stderr) {
+            t.ifError(err, 'Execution error');
+            t.equal(stderr, '', 'Empty stderr');
+            t.end();
+        });
+    });
+});
-- 
2.21.0

