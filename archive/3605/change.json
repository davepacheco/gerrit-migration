{"project":"joyent/sdc-vmapi","branch":"master","id":"I10addfd2ec3646299dcff7ceba068567bd05f194","number":"3605","subject":"TRITON-239 VMAPI should use reusable moray buckets initialization/data migrations module","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/3605","commitMessage":"TRITON-239 VMAPI should use reusable moray buckets initialization/data migrations module\n","createdOn":1520917538,"lastUpdated":1524178476,"open":true,"status":"NEW","comments":[{"timestamp":1520917538,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1520917564,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1520917570,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520917595,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520917911,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 3."},{"timestamp":1520917948,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1524178476,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review-1\n\n(1 comment)"}],"currentPatchSet":{"number":"3","revision":"10addfd2ec3646299dcff7ceba068567bd05f194","parents":["b75a06993e820005463d87fec47e7a1b44f9c674"],"ref":"refs/changes/05/3605/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1520917911,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520917948,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1524178476,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/apis/moray.js","line":1795,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Before switching VMAPI to triton-merci-buckets we need a change here in that module:\n\n```\ndiff --git a/lib/data-migrations.js b/lib/data-migrations.js\nindex 2f3e0d1..5592230 100644\n--- a/lib/data-migrations.js\n+++ b/lib/data-migrations.js\n@@ -487,6 +487,10 @@ function _putBatch(bucketName, records, options, callback) {\n         return {\n             bucket: bucketName,\n             operation: \u0027put\u0027,\n+            // XXX This needs to change to just use and require `record.key`.\n+            //     See TRITON-329. As well, I\u0027m not sure we can assume the\n+            //     key is the same as `value.uuid` in all cases. E.g. that\n+            //     isn\u0027t true for some sdc-docker buckets.\n             key: record.value.uuid,\n             value: record.value,\n             etag: record._etag\n\n```\n\nSee TRITON-329 for details."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":28,"deletions":-605},{"file":"lib/data-migrations/controller.js","type":"DELETED","insertions":0,"deletions":-305},{"file":"lib/data-migrations/loader.js","type":"DELETED","insertions":0,"deletions":-257},{"file":"lib/data-migrations/noop-controller.js","type":"DELETED","insertions":0,"deletions":-49},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":43,"deletions":-46},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":14,"deletions":-4},{"file":"lib/moray/moray-buckets-initializer.js","type":"DELETED","insertions":0,"deletions":-276},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":17,"deletions":-15},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-53},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":12,"deletions":-4},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":141,"deletions":-431},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":69,"deletions":-94},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"DELETED","insertions":0,"deletions":-207},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"DELETED","insertions":0,"deletions":-213},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":47,"deletions":-46},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"DELETED","insertions":0,"deletions":-520},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-3165},"patchSets":[{"number":"1","revision":"78b72f6936dc2d12a22c74cefaf403c2841364c5","parents":["5398e92c533b03e738c906f7d8a0ca7d9132ce40"],"ref":"refs/changes/05/3605/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1520917538,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520917570,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":23,"deletions":-604},{"file":"lib/data-migrations/controller.js","type":"DELETED","insertions":0,"deletions":-305},{"file":"lib/data-migrations/loader.js","type":"DELETED","insertions":0,"deletions":-257},{"file":"lib/data-migrations/noop-controller.js","type":"DELETED","insertions":0,"deletions":-49},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":43,"deletions":-46},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":14,"deletions":-4},{"file":"lib/moray/moray-buckets-initializer.js","type":"DELETED","insertions":0,"deletions":-276},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":17,"deletions":-15},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-53},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":12,"deletions":-4},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":141,"deletions":-431},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":69,"deletions":-94},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"DELETED","insertions":0,"deletions":-207},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"DELETED","insertions":0,"deletions":-213},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":47,"deletions":-46},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"DELETED","insertions":0,"deletions":-520},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":400,"sizeDeletions":-3164},{"number":"2","revision":"de1c4fdbdebaea1284131afb440c96dcb0d3f855","parents":["b75a06993e820005463d87fec47e7a1b44f9c674"],"ref":"refs/changes/05/3605/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1520917564,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520917595,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":23,"deletions":-604},{"file":"lib/data-migrations/controller.js","type":"DELETED","insertions":0,"deletions":-305},{"file":"lib/data-migrations/loader.js","type":"DELETED","insertions":0,"deletions":-257},{"file":"lib/data-migrations/noop-controller.js","type":"DELETED","insertions":0,"deletions":-49},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":43,"deletions":-46},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":14,"deletions":-4},{"file":"lib/moray/moray-buckets-initializer.js","type":"DELETED","insertions":0,"deletions":-276},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":17,"deletions":-15},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-53},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":12,"deletions":-4},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":141,"deletions":-431},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":69,"deletions":-94},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"DELETED","insertions":0,"deletions":-207},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"DELETED","insertions":0,"deletions":-213},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":47,"deletions":-46},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"DELETED","insertions":0,"deletions":-520},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":400,"sizeDeletions":-3164},{"number":"3","revision":"10addfd2ec3646299dcff7ceba068567bd05f194","parents":["b75a06993e820005463d87fec47e7a1b44f9c674"],"ref":"refs/changes/05/3605/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1520917911,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520917948,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1524178476,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/apis/moray.js","line":1795,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Before switching VMAPI to triton-merci-buckets we need a change here in that module:\n\n```\ndiff --git a/lib/data-migrations.js b/lib/data-migrations.js\nindex 2f3e0d1..5592230 100644\n--- a/lib/data-migrations.js\n+++ b/lib/data-migrations.js\n@@ -487,6 +487,10 @@ function _putBatch(bucketName, records, options, callback) {\n         return {\n             bucket: bucketName,\n             operation: \u0027put\u0027,\n+            // XXX This needs to change to just use and require `record.key`.\n+            //     See TRITON-329. As well, I\u0027m not sure we can assume the\n+            //     key is the same as `value.uuid` in all cases. E.g. that\n+            //     isn\u0027t true for some sdc-docker buckets.\n             key: record.value.uuid,\n             value: record.value,\n             etag: record._etag\n\n```\n\nSee TRITON-329 for details."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":28,"deletions":-605},{"file":"lib/data-migrations/controller.js","type":"DELETED","insertions":0,"deletions":-305},{"file":"lib/data-migrations/loader.js","type":"DELETED","insertions":0,"deletions":-257},{"file":"lib/data-migrations/noop-controller.js","type":"DELETED","insertions":0,"deletions":-49},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":43,"deletions":-46},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":14,"deletions":-4},{"file":"lib/moray/moray-buckets-initializer.js","type":"DELETED","insertions":0,"deletions":-276},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":19,"deletions":-12},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":17,"deletions":-15},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-53},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"DELETED","insertions":0,"deletions":-9},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":12,"deletions":-4},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":141,"deletions":-431},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":69,"deletions":-94},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"DELETED","insertions":0,"deletions":-207},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"DELETED","insertions":0,"deletions":-213},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":47,"deletions":-46},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"DELETED","insertions":0,"deletions":-520},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-3165}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}