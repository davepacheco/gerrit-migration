commit 7f91509e793e429fac3c7bc5280ee5a522238b71 (refs/changes/86/4586/3)
Author: Jared Morrow <jm@joyent.com>
Date:   2018-08-07T12:13:24-06:00 (1 year, 2 months ago)
    
    MANTA-3774 Use fastdelete method to delete objects if user account has snaplinks disabled
    Reviewed by: Jan Wyszynski <jan.wyszynski@joyent.com>
    Approved by: Jan Wyszynski <jan.wyszynski@joyent.com>

diff --git a/lib/obj.js b/lib/obj.js
index 4a5233a..7d82bb9 100644
--- a/lib/obj.js
+++ b/lib/obj.js
@@ -926,6 +926,22 @@ function deletePointer(req, res, next) {
     };
 
     log.debug(opts, 'deletePointer: entered');
+
+    /*
+     * Let the delete mechanism know that snaplinks are disabled for this
+     * account, so it can treat the object differently
+     */
+    var uuid = req.owner.account.uuid;
+    common.checkAccountSnaplinksEnabled(req, uuid, function (enabled) {
+        // Pass in a special header if they are not enabled
+        if (!enabled) {
+            log.debug({
+                link: req.link,
+                owner: req.owner.account
+            }, 'deletePointer: owner of object has snaplinks disabled');
+            opts.snapLinksDisabled = true;
+        }
+    });
     req.moray.delMetadata(opts, function (err) {
         if (err) {
             next(err);
