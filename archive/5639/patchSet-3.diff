From cfd827a5029c249624efd6fcdee128db2a9d727e Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Tue, 26 Feb 2019 17:09:53 +0000
Subject: [PATCH] TOOLS-2188 bits-upload.sh should pass --compression=none for
 uncompressed image files Reviewed by: Trent Mick <trentm@gmail.com> Approved
 by: Trent Mick <trentm@gmail.com>

---
 tools/bits-upload.sh | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/tools/bits-upload.sh b/tools/bits-upload.sh
index 86f46d2..4c52cdb 100755
--- a/tools/bits-upload.sh
+++ b/tools/bits-upload.sh
@@ -290,6 +290,7 @@ function find_upload_bits {
 function publish_to_updates {
     local manta_path
     local msigned_url
+    local compression_flag
 
     echo "Publishing updates to updates.joyent.com"
     for file in ${FILES}; do
@@ -303,6 +304,7 @@ function publish_to_updates {
 
         MF=${file}
         IMAGEFILE=$(echo ${MF} | sed -e 's/\..*manifest$/.zfs.gz/g')
+        compression_flag=""
 
         # Some payloads are not zfs-based, look for likely alternatives.
         # This assumes that a single directory with <file>.manifest
@@ -310,12 +312,15 @@ function publish_to_updates {
 	# <file>.tar.gz]
         if [[ ! -f "${IMAGEFILE}" ]]; then
             IMAGEFILE=$(echo ${MF} | sed -e 's/\..*manifest$/.sh/g')
+            compression_flag="--compression=none"
         fi
         if [[ ! -f "${IMAGEFILE}" ]]; then
             IMAGEFILE=$(echo ${MF} | sed -e 's/\..*manifest$/.tgz/g')
+            compression_flag=""
         fi
         if [[ ! -f "${IMAGEFILE}" ]]; then
             IMAGEFILE=$(echo ${MF} | sed -e 's/\..*manifest$/.tar.gz/g')
+            compression_flag=""
         fi
 
         if [[ ! -f ${IMAGEFILE} ]]; then
@@ -367,8 +372,8 @@ function publish_to_updates {
         echo "UPDATES_IMGADM_CHANNEL=$UPDATES_IMGADM_CHANNEL"
         echo "UPDATES_IMGADM_USER=$UPDATES_IMGADM_USER"
         echo "UPDATES_IMGADM_IDENTITY=$UPDATES_IMGADM_IDENTITY"
-        echo Running: ${UPDATES_IMGADM} import -m ${MF} -f "${msigned_url}"
-        ${UPDATES_IMGADM} import -m ${MF} -f "${msigned_url}"
+        echo Running: ${UPDATES_IMGADM} import -m ${MF} -f "${msigned_url}" ${compression_flag}
+        ${UPDATES_IMGADM} import -m ${MF} -f "${msigned_url}" ${compression_flag}
     done
 }
 
-- 
2.21.0

