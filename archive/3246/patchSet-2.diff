From 1bac554015e6f9b4450d94297dc98d7f0ba67d51 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Mon, 22 Jan 2018 14:42:48 -0800
Subject: [PATCH] TRITON-65 should merge two copies of smartdc-config.js in
 cn-agent

---
 bin/docker-build.js              |  4 +-
 bin/docker-stats.js              |  4 +-
 lib/smartdc-config.js            | 80 +++++++++++++++++++-------------
 lib/task_agent/common.js         |  4 +-
 lib/task_agent/smartdc-config.js | 74 -----------------------------
 lib/task_agent/task.js           |  4 +-
 lib/tasks/docker_copy.js         |  4 +-
 lib/tasks/docker_exec.js         |  4 +-
 package.json                     |  2 +-
 9 files changed, 60 insertions(+), 120 deletions(-)
 delete mode 100644 lib/task_agent/smartdc-config.js

diff --git a/bin/docker-build.js b/bin/docker-build.js
index 87791e0..089e589 100644
--- a/bin/docker-build.js
+++ b/bin/docker-build.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -35,7 +35,7 @@ var sprintf = require('sprintf').sprintf;
 var zfs = require('zfs').zfs;
 
 var LineStream = require('lstream');
-var smartDcConfig = require('../lib/task_agent/smartdc-config');
+var smartDcConfig = require('../lib/smartdc-config');
 
 
 var SERVER_CLOSE_TIMEOUT = 60 * 1000; // 1 minute
diff --git a/bin/docker-stats.js b/bin/docker-stats.js
index 2f58c76..cf3f1de 100644
--- a/bin/docker-stats.js
+++ b/bin/docker-stats.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -126,7 +126,7 @@
 var net = require('net');
 var assert = require('assert-plus');
 var bunyan = require('bunyan');
-var smartDcConfig = require('../lib/task_agent/smartdc-config');
+var smartDcConfig = require('../lib/smartdc-config');
 var kstat = require('kstat');
 var sprintf = require('sprintf').sprintf;
 
diff --git a/lib/smartdc-config.js b/lib/smartdc-config.js
index bfd85ab..9966b51 100644
--- a/lib/smartdc-config.js
+++ b/lib/smartdc-config.js
@@ -5,53 +5,67 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var execFile = require('child_process').execFile;
 
 function execFileParseJSON(bin, args, callback) {
-    execFile(
-        bin,
-        args,
-        function (error, stdout, stderr) {
-            if (error) {
-                callback(Error(stderr.toString()));
-                return;
-            }
-            var obj = JSON.parse(stdout.toString());
-            callback(null, obj);
-        });
+    execFile(bin, args, function (error, stdout, stderr) {
+        if (error) {
+            callback(Error(stderr.toString()));
+            return;
+        }
+        var obj = JSON.parse(stdout.toString());
+        callback(null, obj);
+    });
 }
 
 function sysinfo(callback) {
-    execFileParseJSON(
-        '/usr/bin/sysinfo',
-        [],
-        function (error, config) {
-            if (error) {
-                callback(error);
-                return;
-            }
-            callback(null, config);
-        });
+    execFileParseJSON('/usr/bin/sysinfo', [], function (error, config) {
+        if (error) {
+            callback(error);
+            return;
+        }
+        callback(null, config);
+    });
 }
 
 function sdcConfig(callback) {
-    execFileParseJSON(
-        '/bin/bash',
-        [ '/lib/sdc/config.sh', '-json' ],
-        function (error, config) {
-            if (error) {
-                callback(error);
-                return;
-            }
-            callback(null, config);
+    var args = ['/lib/sdc/config.sh', '-json'];
+
+    execFileParseJSON('/bin/bash', args, function (error, config) {
+        if (error) {
+            callback(error);
+            return;
+        }
+        callback(null, config);
+    });
+}
+
+function getFirstAdminIp(callback) {
+    sysinfo(function (err, sysinfoObj) {
+        if (err) {
+            callback(err);
+            return;
+        }
+
+        var interfaces = sysinfoObj['Network Interfaces'];
+
+        var adminifaces = Object.keys(interfaces).filter(function (iface) {
+            return interfaces[iface]['NIC Names'].indexOf('admin') !== -1;
         });
+
+        if (adminifaces && adminifaces.length) {
+            callback(null, interfaces[adminifaces[0]]['ip4addr']);
+        } else {
+            callback(new Error('No admin NIC found in compute node sysinfo'));
+        }
+    });
 }
 
 module.exports = {
+    getFirstAdminIp: getFirstAdminIp,
     sdcConfig: sdcConfig,
-    sysinfo: sysinfo,
-    execFileParseJSON: execFileParseJSON
+    sysinfo: sysinfo
 };
diff --git a/lib/task_agent/common.js b/lib/task_agent/common.js
index 7405eaf..c2d652a 100644
--- a/lib/task_agent/common.js
+++ b/lib/task_agent/common.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var smartdc_config = require('./smartdc-config');
+var smartdc_config = require('../smartdc-config');
 
 /**
  * Use /usr/bin/sysinfo and /lib/sdc/config.sh to determine AMQP
diff --git a/lib/task_agent/smartdc-config.js b/lib/task_agent/smartdc-config.js
deleted file mode 100644
index ed1dc60..0000000
--- a/lib/task_agent/smartdc-config.js
+++ /dev/null
@@ -1,74 +0,0 @@
-/*
- * This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/.
- */
-
-/*
- * Copyright (c) 2014, Joyent, Inc.
- */
-
-var execFile = require('child_process').execFile;
-
-function execFileParseJSON(bin, args, callback) {
-    execFile(bin, args, function (error, stdout, stderr) {
-        if (error) {
-            callback(Error(stderr.toString()));
-            return;
-        }
-        var obj = JSON.parse(stdout.toString());
-        callback(null, obj);
-        return;
-    });
-}
-
-function sysinfo(callback) {
-    execFileParseJSON('/usr/bin/sysinfo', [], function (error, config) {
-        if (error) {
-            callback(error);
-            return;
-        }
-        callback(null, config);
-        return;
-    });
-}
-
-function sdcConfig(callback) {
-    var args = ['/lib/sdc/config.sh', '-json'];
-    execFileParseJSON('/bin/bash', args, function (error, config) {
-        if (error) {
-            callback(error);
-            return;
-        }
-        callback(null, config);
-        return;
-    });
-}
-
-function getFirstAdminIp(callback) {
-    sysinfo(function (err, sysinfoObj) {
-        if (err) {
-            callback(err);
-            return;
-        }
-
-        var interfaces = sysinfoObj['Network Interfaces'];
-
-        var adminifaces = Object.keys(interfaces).filter(function (iface) {
-            return interfaces[iface]['NIC Names'].indexOf('admin') !== -1;
-        });
-
-        if (adminifaces && adminifaces.length) {
-            callback(null, interfaces[adminifaces[0]]['ip4addr']);
-        } else {
-            callback(new Error('No admin NIC found in compute node sysinfo'));
-        }
-    });
-}
-
-module.exports = {
-    sdcConfig: sdcConfig,
-    sysinfo: sysinfo,
-    execFileParseJSON: execFileParseJSON,
-    getFirstAdminIp: getFirstAdminIp
-};
diff --git a/lib/task_agent/task.js b/lib/task_agent/task.js
index 5c4a050..ee28488 100644
--- a/lib/task_agent/task.js
+++ b/lib/task_agent/task.js
@@ -5,14 +5,14 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var EventEmitter = require('events').EventEmitter;
 var util = require('util');
 var fs = require('fs');
 var path = require('path');
-var smartdc_config = require('./smartdc-config');
+var smartdc_config = require('../smartdc-config');
 var common = require('./common');
 var spawn = require('child_process').spawn;
 
diff --git a/lib/tasks/docker_copy.js b/lib/tasks/docker_copy.js
index 84f267a..1fd1dca 100644
--- a/lib/tasks/docker_copy.js
+++ b/lib/tasks/docker_copy.js
@@ -5,13 +5,13 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var Task = require('../task_agent/task');
 var common = require('../common');
 var fork = require('child_process').fork;
-var getFirstAdminIp = require('../task_agent/smartdc-config').getFirstAdminIp;
+var getFirstAdminIp = require('../smartdc-config').getFirstAdminIp;
 var once = require('once');
 var util = require('util');
 var vmadm = require('vmadm');
diff --git a/lib/tasks/docker_exec.js b/lib/tasks/docker_exec.js
index 9eae9e6..012f78d 100644
--- a/lib/tasks/docker_exec.js
+++ b/lib/tasks/docker_exec.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var Task = require('../task_agent/task');
-var sysinfo = require('../task_agent/smartdc-config').sysinfo;
+var sysinfo = require('../smartdc-config').sysinfo;
 var vmadm = require('vmadm');
 var async = require('async');
 var common = require('../common');
diff --git a/package.json b/package.json
index 1bcda1b..dcabf67 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cn-agent",
   "description": "Triton Compute Node Agent",
-  "version": "2.0.1",
+  "version": "2.0.2",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

