From be2ef7f503caae9c52fb9beea7d1fced51de8856 Mon Sep 17 00:00:00 2001
From: Robert Bogart <robert.bogart@joyent.com>
Date: Thu, 18 Apr 2019 03:03:20 +0000
Subject: [PATCH] MANTA-4223 Improve logging for accelerated garbage collection

---
 lib/delete_record_transformer.js  | 17 +++++++++++++++++
 lib/mako_instruction_uploader.js  | 10 ++++++++++
 lib/moray_delete_record_reader.js | 10 ++++++++++
 3 files changed, 37 insertions(+)

diff --git a/lib/delete_record_transformer.js b/lib/delete_record_transformer.js
index 379b9cb..4b0dd11 100644
--- a/lib/delete_record_transformer.js
+++ b/lib/delete_record_transformer.js
@@ -268,6 +268,23 @@ _flush(storage_ids, done)
 				return;
 			}
 
+			/*
+			 * It is unfortunate and inefficient that we have to
+			 * micromanage GC like this, but it has been observed
+			 * that account information is occasionally omitted
+			 * from instructions.  If we see that either the
+			 * account (elem.line[0]) or the object (elem.line[1])
+			 * is not present, log the occurance of this atrocity
+			 * for future analysis.
+			 */
+			lines.forEach(function(elem) {
+				if (!elem.line[0] || !elem.line[1]) {
+					self.mt_log.error({elem: elem},
+					    'DeleteRecordTransformer: '+
+					    'missing information.');
+				}
+			});
+
 			self.mt_mako_listener.emit('instruction', {
 				storage_id: storage_id,
 				lines: lines
diff --git a/lib/mako_instruction_uploader.js b/lib/mako_instruction_uploader.js
index a3f0227..7c80f3a 100644
--- a/lib/mako_instruction_uploader.js
+++ b/lib/mako_instruction_uploader.js
@@ -115,7 +115,17 @@ _get_manta_instruction_path(storage_id)
 MakoInstructionUploader.prototype._format_object_lines = function
 _format_object_lines(storage_id, lines)
 {
+	var self = this;
+
 	return (lines.map(function (line) {
+		/*
+		 * If account or object information is not present, log it.
+		 */
+		if (!line[0] || !line[1]) {
+			self.mu_log.error({line: line},
+			    'MakoInstructionUploader: missing information.');
+		}
+
 		return (['mako', storage_id].concat(line)).join('\t');
 	}).join('\n')).concat('\n');
 };
diff --git a/lib/moray_delete_record_reader.js b/lib/moray_delete_record_reader.js
index ae232c0..3e5ac53 100644
--- a/lib/moray_delete_record_reader.js
+++ b/lib/moray_delete_record_reader.js
@@ -309,6 +309,16 @@ state_running(S)
 		 */
 		var creator = record.value.creator || record.value.owner;
 
+		/*
+		 * Despite the that it would be pretty alarming to not have
+		 * account information on an object at this stage, log the
+		 * event but do not alter our current course of action.
+		 */
+		if (!creator) {
+			self.mr_log.error({record: record},
+			    'MorayDeleteRecordReader: missing information');
+		}
+
 		if (self._is_allowed_creator(creator)) {
 			self.mr_listener.emit('record', record);
 			record_keys.push(record.key);
-- 
2.21.0

