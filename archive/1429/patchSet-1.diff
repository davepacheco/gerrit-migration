From 6661a83e3ce081de7c6eec70cfbe1cff3fa16d12 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Fri, 3 Feb 2017 13:33:23 -0800
Subject: [PATCH] CNAPI-690 CNAPI needs to be selective with logging request
 payload

---
 lib/endpoints/vms.js | 2 +-
 lib/models/server.js | 5 ++++-
 lib/models/vm.js     | 3 ++-
 3 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/lib/endpoints/vms.js b/lib/endpoints/vms.js
index 00dfab3..a4b066e 100644
--- a/lib/endpoints/vms.js
+++ b/lib/endpoints/vms.js
@@ -1171,7 +1171,7 @@ VM.dockerBuild = function handlerVmDockerBuild(req, res, next) {
 
 
     req.stash.vm.dockerBuild(
-        { req_id: req.getId(), payload: req.params.payload },
+        { req_id: req.getId(), payload: req.params.payload, log_params: false },
         function (error, result) {
             clearTimeout(timeout);
 
diff --git a/lib/models/server.js b/lib/models/server.js
index b908769..bc4a80c 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -2078,7 +2078,10 @@ function (opts) {
     var self = this;
 
     self.log.info('sending task to %s', self.uuid);
-    self.log.info({ params: arguments[0].params }, 'task params');
+
+    if (opts.log_params !== false) {
+        self.log.info({ params: arguments[0].params }, 'task params');
+    }
 
     assert.string(opts.task, 'opts.task');
     assert.object(opts.params, 'opts.params');
diff --git a/lib/models/vm.js b/lib/models/vm.js
index 7c62c10..62cd629 100644
--- a/lib/models/vm.js
+++ b/lib/models/vm.js
@@ -210,7 +210,8 @@ ModelVM.prototype.dockerBuild = function (opts, callback) {
                 callback(error, result);
             },
             req_id: opts.req_id,
-            params: { uuid: self.uuid, payload: opts.payload }
+            params: { uuid: self.uuid, payload: opts.payload },
+            log_params: opts.log_params
         };
 
         servermodel.sendTaskRequest(request);
-- 
2.21.0

