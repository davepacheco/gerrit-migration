From aad30b560f94909602810a1d2e3d103747990050 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Fri, 3 Feb 2017 15:37:02 -0800
Subject: [PATCH] CNAPI-690 CNAPI needs to be selective with logging request
 payload Reviewed by: Trent Mick <trentm@gmail.com>

---
 config/test.json     | 85 +++++++++++++++++++++++++++-----------------
 lib/endpoints/vms.js |  2 +-
 lib/models/server.js |  7 ++--
 lib/models/vm.js     |  3 +-
 test/lib/mock.js     |  3 +-
 5 files changed, 62 insertions(+), 38 deletions(-)

diff --git a/config/test.json b/config/test.json
index 2efa467..64b0fec 100644
--- a/config/test.json
+++ b/config/test.json
@@ -34,38 +34,57 @@
     "host": "10.99.99.19"
   },
   "dapi": {
-    "changeDefaults": {
-      "server_spread": "",
-      "filter_headnode": "",
-      "filter_min_resources": "",
-      "filter_large_servers": ""
-    },
-    "allocationDescription": [
-       "pipe", "hard-filter-setup",
-               "hard-filter-running",
-               "hard-filter-invalid-servers",
-               "calculate-ticketed-vms",
-               "calculate-locality",
-               "hard-filter-reserved",
-               "hard-filter-headnode",
-               "hard-filter-vlans",
-               "hard-filter-platform-versions",
-               "hard-filter-traits",
-               "hard-filter-sick-servers",
-               "override-overprovisioning",
-               "calculate-server-unreserved",
-               "hard-filter-overprovision-ratios",
-               "hard-filter-min-ram",
-               "hard-filter-min-cpu",
-               ["or", "hard-filter-reservoir",
-                      "identity"],
-               ["or", "hard-filter-large-servers",
-                      "identity"],
-               "soft-filter-locality-hints",
-               "sort-min-ram",
-               "sort-max-ram",
-               "sort-min-owner",
-               "sort-random",
-               "pick-weighted-random"]
+      "useVmapi": true,
+      "changeDefaults": {
+          "server_spread": "",
+          "filter_headnode": "false",
+          "filter_min_resources": "false",
+          "filter_large_servers": "",
+          "filter_docker_min_platform": "",
+          "filter_vm_limit": "",
+          "disable_override_overprovisioning": "",
+          "overprovision_ratio_cpu": "",
+          "overprovision_ratio_ram": "",
+          "overprovision_ratio_disk": "",
+          "weight_current_platform": "",
+          "weight_next_reboot": "",
+          "weight_num_owner_zones": "",
+          "weight_uniform_random": "",
+          "weight_unreserved_disk": "",
+          "weight_unreserved_ram": ""
+      },
+      "allocationDescription": [
+          "pipe", "hard-filter-setup",
+          "hard-filter-running",
+          "hard-filter-invalid-servers",
+          "hard-filter-volumes-from",
+          "hard-filter-reserved",
+          "hard-filter-vlans",
+          "hard-filter-platform-versions",
+          "hard-filter-traits",
+          "hard-filter-headnode",
+          "override-overprovisioning",
+          "hard-filter-overprovision-ratios",
+          "load-server-vms",
+          "calculate-ticketed-vms",
+          "hard-filter-capness",
+          "hard-filter-vm-count",
+          "hard-filter-sick-servers",
+          "calculate-server-unreserved",
+          "hard-filter-min-ram",
+          "hard-filter-min-cpu",
+          "hard-filter-locality-hints",
+          "hard-filter-owners-servers",
+          ["or", "hard-filter-reservoir",
+              "identity"],
+              ["or", "hard-filter-large-servers",
+                  "identity"],
+                  "soft-filter-locality-hints",
+                  "score-unreserved-ram",
+                  "score-unreserved-disk",
+                  "score-num-owner-zones",
+                  "score-current-platform",
+                  "score-next-reboot",
+                  "score-uniform-random"]
   }
 }
diff --git a/lib/endpoints/vms.js b/lib/endpoints/vms.js
index 00dfab3..a4b066e 100644
--- a/lib/endpoints/vms.js
+++ b/lib/endpoints/vms.js
@@ -1171,7 +1171,7 @@ VM.dockerBuild = function handlerVmDockerBuild(req, res, next) {
 
 
     req.stash.vm.dockerBuild(
-        { req_id: req.getId(), payload: req.params.payload },
+        { req_id: req.getId(), payload: req.params.payload, log_params: false },
         function (error, result) {
             clearTimeout(timeout);
 
diff --git a/lib/models/server.js b/lib/models/server.js
index b908769..12716bb 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -2078,7 +2078,10 @@ function (opts) {
     var self = this;
 
     self.log.info('sending task to %s', self.uuid);
-    self.log.info({ params: arguments[0].params }, 'task params');
+
+    if (opts.log_params !== false) {
+        self.log.info({ params: arguments[0].params }, 'task params');
+    }
 
     assert.string(opts.task, 'opts.task');
     assert.object(opts.params, 'opts.params');
diff --git a/lib/models/vm.js b/lib/models/vm.js
index 7c62c10..62cd629 100644
--- a/lib/models/vm.js
+++ b/lib/models/vm.js
@@ -210,7 +210,8 @@ ModelVM.prototype.dockerBuild = function (opts, callback) {
                 callback(error, result);
             },
             req_id: opts.req_id,
-            params: { uuid: self.uuid, payload: opts.payload }
+            params: { uuid: self.uuid, payload: opts.payload },
+            log_params: opts.log_params
         };
 
         servermodel.sendTaskRequest(request);
diff --git a/test/lib/mock.js b/test/lib/mock.js
index 5b68dac..eef3e96 100644
--- a/test/lib/mock.js
+++ b/test/lib/mock.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var async = require('async');
@@ -203,6 +203,7 @@ function newApp(callback) {
                 logLevel: 'info',
                 datacenter: config.datacenter_name,
                 cnapi: config.cnapi,
+                dapi: config.dapi,
                 amqp: {
                     host: 'localhost'
                 }
-- 
2.21.0

