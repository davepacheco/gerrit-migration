From 03082408702bec7c7bd9d2ed3d7d06572fb52a6b Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Tue, 16 Apr 2019 11:55:27 +0000
Subject: [PATCH] OS-7702 add zfs mmp and alloc_class tests to smartos run
 profile

---
 usr/src/test/zfs-tests/include/libtest.shlib     |  9 ++++++++-
 usr/src/test/zfs-tests/runfiles/smartos.run      | 16 ++++++++++++++++
 .../tests/functional/alloc_class/alloc_class.cfg | 14 +++++++-------
 .../alloc_class/alloc_class_009_pos.ksh          |  2 +-
 .../functional/cli_root/zpool_replace/setup.ksh  |  2 +-
 .../test/zfs-tests/tests/functional/mmp/mmp.cfg  |  7 ++++---
 6 files changed, 37 insertions(+), 13 deletions(-)

diff --git a/usr/src/test/zfs-tests/include/libtest.shlib b/usr/src/test/zfs-tests/include/libtest.shlib
index 39a60a0900..85aeab10f4 100644
--- a/usr/src/test/zfs-tests/include/libtest.shlib
+++ b/usr/src/test/zfs-tests/include/libtest.shlib
@@ -307,6 +307,13 @@ function default_mirror_setup
 	log_pass
 }
 
+function default_mirror_2way_setup
+{
+	default_mirror_setup_noexit $1 $2
+
+	log_pass
+}
+
 #
 # Given a pair of disks, set up a storage pool and dataset for the mirror
 # @parameters: $1 the primary side of the mirror
@@ -323,7 +330,7 @@ function default_mirror_setup_noexit
 	[[ -z $secondary ]] && \
 		log_fail "$func: No secondary partition passed"
 	[[ -d /$TESTPOOL ]] && rm -rf /$TESTPOOL
-	log_must zpool create -f $TESTPOOL mirror $primary $secondary
+	log_must zpool create -f $TESTPOOL mirror $@
 	log_must zfs create $TESTPOOL/$TESTFS
 	log_must zfs set mountpoint=$TESTDIR $TESTPOOL/$TESTFS
 }
diff --git a/usr/src/test/zfs-tests/runfiles/smartos.run b/usr/src/test/zfs-tests/runfiles/smartos.run
index 1155c29025..174d4e853f 100644
--- a/usr/src/test/zfs-tests/runfiles/smartos.run
+++ b/usr/src/test/zfs-tests/runfiles/smartos.run
@@ -23,6 +23,17 @@ post_user = root
 post = cleanup
 outputdir = /var/tmp/test_results
 
+[/opt/zfs-tests/tests/functional/alloc_class]
+tests = ['alloc_class_001_pos', 'alloc_class_002_neg', 'alloc_class_003_pos',
+    'alloc_class_004_pos', 'alloc_class_005_pos', 'alloc_class_006_pos',
+    'alloc_class_007_pos', 'alloc_class_008_pos', 'alloc_class_009_pos',
+    'alloc_class_010_pos', 'alloc_class_011_neg', 'alloc_class_012_pos',
+    'alloc_class_013_pos']
+tags = ['functional', 'alloc_class']
+
+[/opt/zfs-tests/tests/functional/cli_root/zpool_add]
+tests = ['zpool_add_010_pos']
+
 [/opt/zfs-tests/tests/functional/cli_root/zpool_get]
 tests = ['zpool_get_001_pos', 'zpool_get_002_pos', 'zpool_get_003_pos',
     'zpool_get_004_neg']
@@ -158,6 +169,11 @@ tests = ['migration_001_pos', 'migration_002_pos', 'migration_003_pos',
 [/opt/zfs-tests/tests/functional/mmap]
 tests = ['mmap_read_001_pos', 'mmap_write_001_pos']
 
+[/opt/zfs-tests/tests/functional/mmp]
+tests = ['mmp_on_thread', 'mmp_on_off', 'mmp_interval',
+    'mmp_active_import', 'mmp_inactive_import', 'mmp_exported_import',
+    'mmp_on_zdb']
+
 [/opt/zfs-tests/tests/functional/mount]
 tests = ['umount_001', 'umountall_001']
 
diff --git a/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg b/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg
index 0bdae47f20..0a61f03cec 100644
--- a/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg
+++ b/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg
@@ -16,15 +16,15 @@
 
 . $STF_SUITE/include/libtest.shlib
 
-export ZPOOL_DISK0="$TEST_BASE_DIR/device-0"
-export ZPOOL_DISK1="$TEST_BASE_DIR/device-1"
-export ZPOOL_DISK2="$TEST_BASE_DIR/device-2"
+export ZPOOL_DISK0="/var/tmp/device-0"
+export ZPOOL_DISK1="/var/tmp/device-1"
+export ZPOOL_DISK2="/var/tmp/device-2"
 export ZPOOL_DISKS="${ZPOOL_DISK0} ${ZPOOL_DISK1} ${ZPOOL_DISK2}"
 
-export CLASS_DISK0="$TEST_BASE_DIR/device-3"
-export CLASS_DISK1="$TEST_BASE_DIR/device-4"
-export CLASS_DISK2="$TEST_BASE_DIR/device-5"
-export CLASS_DISK3="$TEST_BASE_DIR/device-6"
+export CLASS_DISK0="/var/tmp/device-3"
+export CLASS_DISK1="/var/tmp/device-4"
+export CLASS_DISK2="/var/tmp/device-5"
+export CLASS_DISK3="/var/tmp/device-6"
 export CLASS_DISKS="${CLASS_DISK0} ${CLASS_DISK1} ${CLASS_DISK2} ${CLASS_DISK3}"
 
 export ZPOOL_DEVSIZE=1G
diff --git a/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh b/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh
index fb47c78c7a..e06b418e2a 100755
--- a/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh
+++ b/usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh
@@ -57,7 +57,7 @@ do
 	log_must zpool create $TESTPOOL $type $ZPOOL_DISKS \
 	    special $stype $sdisks
 	log_must zpool export $TESTPOOL
-	log_must zpool import -d $TEST_BASE_DIR $imp_opt $TESTPOOL
+	log_must zpool import -d /var/tmp $imp_opt $TESTPOOL
 	log_must display_status $TESTPOOL
 	log_must zpool destroy -f $TESTPOOL
 done
diff --git a/usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh b/usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh
index 83337a8949..9a45a363bf 100644
--- a/usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh
+++ b/usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh
@@ -36,4 +36,4 @@ verify_disk_count "$DISKS" 3
 
 DISK=${DISKS%% *}
 
-default_mirror_setup $DISKS
+default_mirror_2way_setup $DISKS
diff --git a/usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg b/usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg
index 52680c275a..4fd94641f1 100644
--- a/usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg
+++ b/usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg
@@ -15,10 +15,11 @@
 
 #
 # Copyright (c) 2017 by Lawrence Livermore National Security, LLC.
+# Copyright 2019 Joyent, Inc.
 #
 
-export PREV_UBER="$TEST_BASE_DIR/mmp-uber-prev.txt"
-export CURR_UBER="$TEST_BASE_DIR/mmp-uber-curr.txt"
+export PREV_UBER="/var/tmp/zfs-test/mmp-uber-prev.txt"
+export CURR_UBER="/var/tmp/zfs-test/mmp-uber-curr.txt"
 export DISK=${DISKS%% *}
 
 export HOSTID_FILE="/etc/hostid"
@@ -29,7 +30,7 @@ export TXG_TIMEOUT_LONG=5000
 export TXG_TIMEOUT_DEFAULT=5
 
 export MMP_POOL=mmppool
-export MMP_DIR=$TEST_BASE_DIR/mmp
+export MMP_DIR=/var/tmp/zfs-test/mmp
 export MMP_CACHE=$MMP_DIR/zpool.cache
 export MMP_ZTEST_LOG=$MMP_DIR/ztest.log
 export MMP_HISTORY=100
-- 
2.21.0

