{"project":"joyent/illumos-joyent","branch":"master","id":"I6dec4a05385ed1b5f25175e319c87f8e96dd992f","number":"6061","subject":"OS-7702 add zfs mmp and alloc_class tests to smartos run profile Reviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e Approved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/6061","commitMessage":"OS-7702 add zfs mmp and alloc_class tests to smartos run profile\nReviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\nApproved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1554743816,"lastUpdated":1555450958,"open":false,"status":"MERGED","comments":[{"timestamp":1554743816,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1554844910,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1554899090,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1554911987,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1555342379,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1555415767,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1555449378,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1555450877,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1555450950,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1555450958,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"6dec4a05385ed1b5f25175e319c87f8e96dd992f","parents":["38cd105041d3ba59fa4f5ec53d120c0b49f7ae1d"],"ref":"refs/changes/61/6061/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1555450950,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1555450958,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":16,"deletions":0},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":37,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"864f89d45f71874ec97a6e6b1dfad898e89b3f7e","parents":["cf5e484e4a5c4f2d361170e543095ddcc6707af4"],"ref":"refs/changes/61/6061/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1554743816,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/test/zfs-tests/include/libtest.shlib","line":318,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This comment states that this function only handles two-way mirrors, but like you discovered some things rely on this working with N-way mirrors. Should we punt on refactoring this function to properly handle N-way mirrors? Maybe we could at least change the documentation now and refactor later?"},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","line":318,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"My change just brings this function back into the state it is in upstream. If we ever upstream your new work, that would be a good time to refactor things here so all of the upstream code continues to work alongside your new code."},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","line":164,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Does these tests work on smartos? I see the tests reference count_mmp_writes, which relies on the /proc emulation."},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","line":164,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Good catch, I missed this usage of /proc here.. They do all pass on smartos and on other illumos distros as well, but that looks like its not by design. I\u0027ll have to open an illumos bug for this and fix it upstream."},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","line":20,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"FWIW in the not-upstreamed test fixes I have this redefined to /var/tmp. I\u0027ll make note to change this back to $TEST_BASE_DIR in the subsequent smartos-specific testing change commit."},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","line":20,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yeah, we can put this anywhere we want for smartos, as long as it\u0027s not in the root filesystem, since that is not big enough. I just picked this tmp dir here to get these tests to work. If you want, we can wait on getting theses tests enabled until after you integrate your other test fixes, and then I can align the mmp changes with those fixes."},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","line":20,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sounds good. I wrote in my notes to revert these lines when I send smartos-specific test fixes for review."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":19,"sizeDeletions":-5},{"number":"2","revision":"6a092b5e19863f3363b89e16c2796ba8f4ca8bc2","parents":["cf5e484e4a5c4f2d361170e543095ddcc6707af4"],"ref":"refs/changes/61/6061/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1554911987,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555342379,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555342379,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":18,"sizeDeletions":-5},{"number":"3","revision":"03082408702bec7c7bd9d2ed3d7d06572fb52a6b","parents":["4ee6130795f64dd6ad7ae8abe4750f8235ab8d5c"],"ref":"refs/changes/61/6061/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1555415767,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":16,"deletions":0},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":37,"sizeDeletions":-13},{"number":"4","revision":"e0532ad272e60a9e3e815b898cf4c2feb168913d","parents":["38cd105041d3ba59fa4f5ec53d120c0b49f7ae1d"],"ref":"refs/changes/61/6061/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1555450877,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":16,"deletions":0},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":37,"sizeDeletions":-13},{"number":"5","revision":"6dec4a05385ed1b5f25175e319c87f8e96dd992f","parents":["38cd105041d3ba59fa4f5ec53d120c0b49f7ae1d"],"ref":"refs/changes/61/6061/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1555450950,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1555450958,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1555449378,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/test/zfs-tests/include/libtest.shlib","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":16,"deletions":0},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class.cfg","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"usr/src/test/zfs-tests/tests/functional/alloc_class/alloc_class_009_pos.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/cli_root/zpool_replace/setup.ksh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/mmp/mmp.cfg","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":37,"sizeDeletions":-13}],"allReviewers":[{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}