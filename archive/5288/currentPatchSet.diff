commit b2ec9eec6378392f3643c1e115a648149a3e9df3 (refs/changes/88/5288/1)
Author: Robert Mustacchi <rm@joyent.com>
Date:   2018-12-26T22:10:34+00:00 (10 months ago)
    
    OS-7472 grep_xpg4 test Makefile isn't reliable

diff --git a/usr/src/test/util-tests/tests/grep_xpg4/Makefile b/usr/src/test/util-tests/tests/grep_xpg4/Makefile
index 5fa00c0c38..3837db4a6d 100644
--- a/usr/src/test/util-tests/tests/grep_xpg4/Makefile
+++ b/usr/src/test/util-tests/tests/grep_xpg4/Makefile
@@ -12,33 +12,42 @@
 #
 # Copyright (c) 2013 by Delphix. All rights reserved.
 # Copyright 2014 Nexenta Systems, Inc. All rights reserved.
+# Copyright 2018 Joyent, Inc.
 #
 
-.PARALLEL: $(SUBDIRS)
-
 include $(SRC)/cmd/Makefile.cmd
 include $(SRC)/test/Makefile.com
 
 ROOTOPTPKG = $(ROOT)/opt/util-tests
 TESTDIR = $(ROOTOPTPKG)/tests
+TESTFILEDIR = $(TESTDIR)/grep-files
 
 PROGS = grep_test
 
+FILES :sh= (cd files; print *)
+TESTFILES = $(FILES:%=$(TESTFILEDIR)/%)
+$(TESTFILES) := FILEMODE = 0444
 CMDS = $(PROGS:%=$(TESTDIR)/%)
 $(CMDS) := FILEMODE = 0555
 
 all lint clean clobber:
 
-install: $(CMDS)
+install: $(CMDS) $(TESTFILES)
 
 $(CMDS): $(TESTDIR)
 
+$(TESTFILES): $(TESTFILEDIR)
+
 $(TESTDIR):
 	$(INS.dir)
 
+$(TESTFILEDIR):
+	$(INS.dir)
+
 $(TESTDIR)/%: %.ksh
 	$(INS.rename)
 
-SUBDIRS = files
+$(TESTFILEDIR)/%: files/%
+	$(INS.file)
 
 include $(SRC)/test/Makefile.com
diff --git a/usr/src/test/util-tests/tests/grep_xpg4/files/Makefile b/usr/src/test/util-tests/tests/grep_xpg4/files/Makefile
deleted file mode 100644
index cec093b8a1..0000000000
--- a/usr/src/test/util-tests/tests/grep_xpg4/files/Makefile
+++ /dev/null
@@ -1,113 +0,0 @@
-#
-# This file and its contents are supplied under the terms of the
-# Common Development and Distribution License ("CDDL"), version 1.0.
-# You may only use this file in accordance with the terms of version
-# 1.0 of the CDDL.
-#
-# A full copy of the text of the CDDL should have accompanied this
-# source.  A copy of the CDDL is also available via the Internet at
-# http://www.illumos.org/license/CDDL.
-#
-
-#
-# Copyright (c) 2013 by Delphix. All rights reserved.
-# Copyright 2014 Nexenta Systems, Inc. All rights reserved.
-#
-
-include $(SRC)/cmd/Makefile.cmd
-include $(SRC)/test/Makefile.com
-
-ROOTOPTPKG = $(ROOT)/opt/util-tests
-TESTDIR = $(ROOTOPTPKG)/tests/files
-
-PROGS = test0 \
-	test1 \
-	test2 \
-	test3 \
-	test4 \
-	test5 \
-	test6 \
-	test7 \
-	gout0 \
-	gout1 \
-	gout2 \
-	gout3 \
-	gout4 \
-	gout5 \
-	gout6 \
-	gout7 \
-	gout8 \
-	gout9 \
-	gout10 \
-	gout11 \
-	gout12 \
-	gout13 \
-	gout14 \
-	gout15 \
-	gout16 \
-	gout17 \
-	gout18 \
-	gout19 \
-	gout20 \
-	gout21 \
-	gout22 \
-	gout23 \
-	gout24 \
-	gout25 \
-	gout26 \
-	gout27 \
-	gout28 \
-	gout29 \
-	gout30 \
-	gout31 \
-	gout32 \
-	gout33 \
-	gout34 \
-	gout35 \
-	gout36 \
-	gout37 \
-	gout38 \
-	gout39 \
-	gout40 \
-	gout41 \
-	gout42 \
-	gout43 \
-	gout44 \
-	gout45 \
-	gout46 \
-	gout47 \
-	gout48 \
-	gout49 \
-	gout50 \
-	gout51 \
-	gout52 \
-	gout53 \
-	gout54 \
-	gout55 \
-	gout56 \
-	gout57 \
-	gout58 \
-	gout59 \
-	gout60 \
-	gout61 \
-	gout62 \
-	gout63 \
-	gout64 \
-	gout65 \
-	gout66 \
-	testnl
-
-CMDS = $(PROGS:%=$(TESTDIR)/%)
-$(CMDS) := FILEMODE = 0444
-
-all lint clean clobber:
-
-install: $(CMDS)
-
-$(CMDS): $(TESTDIR)
-
-$(TESTDIR):
-	$(INS.dir)
-
-$(TESTDIR)/%: %
-	$(INS.file)
diff --git a/usr/src/test/util-tests/tests/grep_xpg4/grep_test.ksh b/usr/src/test/util-tests/tests/grep_xpg4/grep_test.ksh
index 0df113d490..26900f16f6 100644
--- a/usr/src/test/util-tests/tests/grep_xpg4/grep_test.ksh
+++ b/usr/src/test/util-tests/tests/grep_xpg4/grep_test.ksh
@@ -16,7 +16,7 @@
 #
 
 XGREP=${XGREP:=/usr/bin/grep}
-FILEDIR=$MY_TESTS/tests/files
+FILEDIR=$(dirname $0)/grep-files/
 
 fail() {
 	echo $1
