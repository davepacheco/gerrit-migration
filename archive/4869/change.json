{"project":"joyent/node-mahi","branch":"master","id":"I260d852ac6174ea0ab743c77bfa216aaaa0de423","number":"4869","subject":"MANTA-3962 allow use of aperture resource \u0027*\u0027 or \u0027all\u0027 Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/4869","commitMessage":"MANTA-3962 allow use of aperture resource \u0027*\u0027 or \u0027all\u0027\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1537833416,"lastUpdated":1538172283,"open":false,"status":"MERGED","comments":[{"timestamp":1537833416,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1537833440,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1537915332,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1537915357,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538084405,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\n(3 comments)\n\nThe code change looks fine to me, though I\u0027m certainly not super familiar with this subsystem."},{"timestamp":1538086512,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1538086543,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1538090994,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1538091577,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538172084,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Integration-Approval+1\n\nTesting in the ticket looks good, with the caveat that we\u0027re not going to update CloudAPI to include this change until more extensive testing is done outside of this change."},{"timestamp":1538172145,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1538172283,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"4","revision":"f1ce8c7e68225455c97291777ae1ed575da37eff","parents":["527b7145404220aebde8d5aa4ca352a219c80c88"],"ref":"refs/changes/69/4869/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1538172145,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538090994,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538091577,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1538172084,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1538172283,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":48,"deletions":-17},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":49,"sizeDeletions":-18},"patchSets":[{"number":"1","revision":"cc4ce9d52f9a1ec45f657268b741cea0929b8bb4","parents":["527b7145404220aebde8d5aa4ca352a219c80c88"],"ref":"refs/changes/69/4869/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1537833416,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537833440,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":20,"sizeDeletions":-6},{"number":"2","revision":"5f08dccd153e2a4c6969e69440715eb2c3aa4287","parents":["527b7145404220aebde8d5aa4ca352a219c80c88"],"ref":"refs/changes/69/4869/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1537915332,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538084405,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537915357,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":435,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I asked in person about this change, and I\u0027m writing it here for reference: this change was needed because if `resource` is `undefined`, then (for some reason?) aperture ignores rules that include `\u0027*\u0027`.  This change doesn\u0027t change the case where there were no rules that include `\u0027*\u0027`."},{"file":"lib/client.js","line":438,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be pretty useful to have a comment explaining what each of these is for.  For my own reference, I\u0027m writing it down here:\n- `roles` is the list of roles that are both active and apply to this resource.  Prior to this change, this was the intersection of (user\u0027s active roles) and (roles whose role tags are stored with the resource).  After this change, it also includes any roles on the account that have a rule that includes the resource specifier \u0027*\u0027.\n- `rules` is the list of rules that we\u0027ll have aperture evaluate.  Prior to this change, `rules` was constructed at the end of this function based on the contents of `roles`.  Now that we have roles with rules with resource \u0027*\u0027, that\u0027s not quite correct (as described in the comment at L524), so we build up `rules` in the loop.  As a result, `roles` is only used now to issue an appropriate error if no roles applied.\n\nIt might be clearer to call this `matchingRoles` and `rulesToEvaluate` or something."},{"file":"lib/client.js","line":438,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, taking the naming suggestions, I think they\u0027re useful."},{"file":"lib/client.js","line":526,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Would it be reasonable to make it illegal to mix rules with \u0027*\u0027 and rules without it?  What\u0027s here seems probably correct but potentially confusing."},{"file":"lib/client.js","line":526,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I think while it might make sense to make policy objects all one way or the other, it doesn\u0027t make sense to do it at the level of entire roles (and in either case I think it should be cloudapi\u0027s problem to enforce).\n\nThe only reason we have to be selective about which rules we put into the evaluator here is that we are basically hacking in extra behaviour that the evaluator wasn\u0027t designed to handle (we\u0027ve changed the semantic meaning of \"CAN getobject\" to mean basically \"CAN getobject when roletagged \u003d true\"). If we instead modified things so that we passed this info into the evaluator we wouldn\u0027t have to be selective."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":30,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":31,"sizeDeletions":-12},{"number":"3","revision":"260d852ac6174ea0ab743c77bfa216aaaa0de423","parents":["527b7145404220aebde8d5aa4ca352a219c80c88"],"ref":"refs/changes/69/4869/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1538086543,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538090994,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1538172084,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538091577,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":48,"deletions":-17},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":49,"sizeDeletions":-18},{"number":"4","revision":"f1ce8c7e68225455c97291777ae1ed575da37eff","parents":["527b7145404220aebde8d5aa4ca352a219c80c88"],"ref":"refs/changes/69/4869/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1538172145,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538090994,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1538172283,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1538172084,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538091577,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":48,"deletions":-17},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":49,"sizeDeletions":-18}],"allReviewers":[{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}