{"project":"joyent/smartos-live","branch":"master","id":"Ie8514121145b085c109509232e8aecc51bd61e4a","number":"5271","subject":"OS-7450 VM.load should include snapshot size and free space Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"url":"https://cr.joyent.us/5271","commitMessage":"OS-7450 VM.load should include snapshot size and free space\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1545286512,"lastUpdated":1547148947,"open":false,"status":"MERGED","comments":[{"timestamp":1545286512,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 1."},{"timestamp":1545286513,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 864be81692659a5f8163221fd15cd2b13f88c870\n    \n    add snapshots.size and free_space prop"},{"timestamp":1545286554,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n /tmp/repo/src/img/sbin/imgadm\n /tmp/repo/src/vm/common/nictag.js\n /tmp/repo/src/vm/tests/common.js\n /tmp/repo/src/vm/tests/test-alias.js\n /tmp/repo/src/vm/node_modules/nodeunit-plus/index.js\n /tmp/repo/src/vm/tests/test-bhyve-disk-resize.js\n /tmp/repo/src/vm/tests/test-bhyve-pci.js\n /tmp/repo/src/vm/tests/test-bhyve-pci_slot.js\n /tmp/repo/src/vm/tests/test-cleanup-on-failure.js\n /tmp/repo/src/vm/tests/test-create-filesystems.js\n /tmp/repo/src/vm/tests/test-create.js\n /tmp/repo/src/vm/tests/test-defaults.js\n /tmp/repo/src/vm/tests/test-docker.js\n /tmp/repo/src/vm/tests/test-firewall.js\n /tmp/repo/src/vm/tests/test-fswatcher.js\n /tmp/repo/src/vm/tests/test-hrtime.js\n /tmp/repo/src/vm/tests/test-indestructible.js\n /tmp/repo/src/vm/tests/test-internal_metadata_namespaces.js\n /tmp/repo/src/vm/tests/test-lastexited.js\n /tmp/repo/src/vm/tests/test-openonerrlogger.js\n /tmp/repo/src/vm/tests/test-queue.js\n /tmp/repo/src/vm/tests/test-quota.js\n /tmp/repo/src/vm/tests/test-reboot.js\n /tmp/repo/src/vm/tests/test-reprovision.js\n /tmp/repo/src/vm/tests/test-send-recv.js\n /tmp/repo/src/vm/tests/test-snapshots.js\n /tmp/repo/src/vm/tests/test-spoof-opts.js\n /tmp/repo/src/vm/tests/test-sysinfo.js\n /tmp/repo/src/vm/tests/test-tmpfs.js\n /tmp/repo/src/vm/tests/test-update.js\n /tmp/repo/src/vm/tests/test-vrrp-nics.js\n /tmp/repo/src/vm/tests/test-vminfod.js\n /tmp/repo/src/vm/tests/test-vminfod-zonewatcher.js\n /tmp/repo/src/vm/tests/test-vminfod-zonewatcher-overflow.js\n /tmp/repo/src/vm/tests/test-vminfod-zpoolwatcher.js\n /tmp/repo/src/vm/lib/metadata/agent.js\n /tmp/repo/src/vm/lib/metadata/common.js\n /tmp/repo/src/vm/lib/metadata/crc32.js\n /tmp/repo/src/disklayout.js\n /tmp/repo/src/mkzpool.js\n /tmp/repo/src/ntp_config.js\n /tmp/repo/src/node_modules/disklayout.js\n \n 0 error(s), 1 warnings(s)\n Makefile:463: recipe for target \u0027check\u0027 failed\n make[1]: *** [check] Error 1\n make[1]: Leaving directory \u0027/tmp/repo/src\u0027\n Makefile:387: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 2"},{"timestamp":1545292805,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 2."},{"timestamp":1545292806,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 8451ec9bca186c1590061b44c12e047c3bd95f9e\n    \n    missing semicolon"},{"timestamp":1545292857,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545327257,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(3 comments)\n\nStill looking at tests - may have more feedback."},{"timestamp":1545331745,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(2 comments)\n\nDone with this round"},{"timestamp":1546898883,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 3."},{"timestamp":1546898884,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 65c432645022d8634aae4c968d7b7e07a5fa9166\n    \n    rebase merge\n    \n    commit c5f12c1026cf5e028f814ca6ace9b207f64db9fa\n    \n    respond to cr\n    \n    commit 62c7313e107b4685d6d4c44f0e4154c74ec53630\n    \n    missing semicolon\n    \n    commit 7a0e20704be0bc9c677ddf3c6b9b0bcd06efc498\n    \n    add snapshots.size and free_space prop"},{"timestamp":1546898936,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546899050,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1546922913,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1546964147,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Code-Review+1\n\nLGTM. Can I assume tests are passing so IA is another +1?"},{"timestamp":1546973878,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 4."},{"timestamp":1546973879,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit f612771ad83d62ee9233b80dfa801fd84e8692cb\n    \n    fix typo\n    \n    commit 195f4f897251c480bb2842f5be7052a73a80ac1e\n    \n    rebase merge\n    \n    commit a9aea5a1386daccb1cbb4d39cf4116393082e734\n    \n    respond to cr\n    \n    commit 74ad36b5c730b610c0f6f82da5683e6d7f4ed965\n    \n    missing semicolon\n    \n    commit 40115abb777c80380539b8c7cd48abb307353f80\n    \n    add snapshots.size and free_space prop"},{"timestamp":1546973930,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546979645,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1547133557,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nGiven all tests are green, +1 it!"},{"timestamp":1547147141,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1547147195,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1547148947,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dylan Yep"}],"currentPatchSet":{"number":"5","revision":"efb2a2b70bc3cf99eb82a1a294fc3f223bcac28a","parents":["268fe7827fe4ab4a01a1a037d2799ea883b7390c"],"ref":"refs/changes/71/5271/5","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1547147141,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546973930,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546979645,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547133557,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547133557,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1547148947,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":58,"deletions":-2},{"file":"src/vm/node_modules/vmload/vmload-datasets.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/tests/test-vmload-datasets.js","type":"MODIFIED","insertions":541,"deletions":-490}],"sizeInsertions":628,"sizeDeletions":-498},"patchSets":[{"number":"1","revision":"11293505f2b6e0767f1a0f0970beb3875c796c65","parents":["ab44384df40dbb99df4f0759d1af45dc162b18b2"],"ref":"refs/changes/71/5271/1","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1545286512,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1545286554,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":59,"deletions":-2},{"file":"src/vm/node_modules/vmload/vmload-datasets.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/tests/test-vmload-datasets.js","type":"MODIFIED","insertions":542,"deletions":-491}],"sizeInsertions":629,"sizeDeletions":-498},{"number":"2","revision":"dc94645da087dc66f9e2b0bc42a69484124dbc33","parents":["ab44384df40dbb99df4f0759d1af45dc162b18b2"],"ref":"refs/changes/71/5271/2","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1545292805,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545292857,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/node_modules/vmload/index.js","line":234,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I don\u0027t understand how mountpoints can work with volumes:\n\n# zfs list -t volume -o mountpoint,name\nMOUNTPOINT  NAME\n-           zones/1f11188a-c71c-11e8-83d4-370e2a698b16\n-           zones/45d86edd-8cf4-6c7c-f018-8e27b24c550e\n-           zones/462d1d03-8457-e134-a408-cf9ea2b9be96\n-           zones/62ade7b4-a35c-11e8-a083-73a0170b4eda\n-           zones/71101322-43a5-11e1-8f01-cf2a3031a7f4\n-           zones/ac99517a-72ac-44c0-90e6-c7ce3d944a0a\n-           zones/dump\n-           zones/swap\n\nIf this does work, it deserves a comment."},{"file":"src/vm/node_modules/vmload/index.js","line":234,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Comment added. If you think this behavior is too unintuitive, I can take a look at other ways to handle this."},{"file":"src/vm/node_modules/vmload/index.js","line":234,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Thanks for the comment.  The mountpoint abuse has been around for almost 5 years (joshw, 2014-03-08).  It\u0027s fine now."},{"file":"src/vm/node_modules/vmload/index.js","line":249,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Is there a reason to not just have this code at line 240?"},{"file":"src/vm/node_modules/vmload/index.js","line":249,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/node_modules/vmload/index.js","line":263,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Is listing the free space as a non-integer helpful, given that all of the related *size properties are integers?  It would seem best to return an integer.\n\nI don\u0027t think rounding is the right approach. Since the logical thing to do with the free_space result is to grow the disk by that much, we should ensure this value is not greater than the amount of space that is really available."},{"file":"src/vm/node_modules/vmload/index.js","line":263,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"src/vm/node_modules/vmload/index.js","line":467,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Does this convert bytes to KiB?"},{"file":"src/vm/node_modules/vmload/index.js","line":467,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Good catch"},{"file":"src/vm/tests/test-vmload-datasets.js","line":589,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"`zfs list -p` uses a single tab between fields.  This only works because of a bug in vmload-datasets.js:62 - it should be splitting on single tabs rather than white space.  (zfs create \"pool/foo bar\" will create a file system with a space in its name.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":59,"deletions":-2},{"file":"src/vm/node_modules/vmload/vmload-datasets.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/tests/test-vmload-datasets.js","type":"MODIFIED","insertions":542,"deletions":-491}],"sizeInsertions":629,"sizeDeletions":-498},{"number":"3","revision":"471201b9a6339ad6821d5597bc5b2bde5ecd3c36","parents":["4725c580158d35fb20fcbdb3d5909b9adfde6719"],"ref":"refs/changes/71/5271/3","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1546898883,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546898936,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546964147,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546922913,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":58,"deletions":-2},{"file":"src/vm/node_modules/vmload/vmload-datasets.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/tests/test-vmload-datasets.js","type":"MODIFIED","insertions":541,"deletions":-490}],"sizeInsertions":628,"sizeDeletions":-498},{"number":"4","revision":"e8514121145b085c109509232e8aecc51bd61e4a","parents":["85210364423d5587edca0862b2905db0500ffc8e"],"ref":"refs/changes/71/5271/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1546973878,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546973930,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547133557,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547133557,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546979645,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":58,"deletions":-2},{"file":"src/vm/node_modules/vmload/vmload-datasets.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/tests/test-vmload-datasets.js","type":"MODIFIED","insertions":541,"deletions":-490}],"sizeInsertions":628,"sizeDeletions":-498},{"number":"5","revision":"efb2a2b70bc3cf99eb82a1a294fc3f223bcac28a","parents":["268fe7827fe4ab4a01a1a037d2799ea883b7390c"],"ref":"refs/changes/71/5271/5","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1547147141,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546973930,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547133557,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547133557,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546979645,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1547148947,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":58,"deletions":-2},{"file":"src/vm/node_modules/vmload/vmload-datasets.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/tests/test-vmload-datasets.js","type":"MODIFIED","insertions":541,"deletions":-490}],"sizeInsertions":628,"sizeDeletions":-498}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}]}