From 313a772a609f5647d381a99c80c610a041a507e3 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 30 Nov 2017 13:03:22 -0800
Subject: [PATCH] DOCKER-1131 Unable to login to quay.io

---
 lib/endpoints/auth.js | 15 ++++++++++++---
 package.json          |  2 +-
 2 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/lib/endpoints/auth.js b/lib/endpoints/auth.js
index 547e32a..cfaff5c 100644
--- a/lib/endpoints/auth.js
+++ b/lib/endpoints/auth.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -14,6 +14,7 @@ var fmt = require('util').format;
 var restify = require('restify');
 
 var common = require('../common');
+var constants = require('../constants');
 var errors = require('../errors');
 
 
@@ -53,7 +54,7 @@ function auth(req, res, next) {
         return next(new errors.ValidationError(errs.join(', ')));
     }
 
-    drc.login(common.httpClientOpts({
+    var loginOpts = common.httpClientOpts({
         indexName: req.body.serveraddress,
         log: log,
         insecure: req.app.config.dockerRegistryInsecure,
@@ -62,7 +63,15 @@ function auth(req, res, next) {
         password: req.body.password,
         // `email` is optional (required for *v1* Registry API)
         email: req.body.email
-    }, req), function (err, result) {
+    }, req);
+
+    // Some registries (e.g. quay.io) use the user agent to sniff for the
+    // docker server version, so we need to override the default user agent
+    // that sdc-docker uses, otherwise we will get a 404 error and be unable
+    // to login.
+    loginOpts.userAgent = 'triton/' + constants.SERVER_VERSION;
+
+    drc.login(loginOpts, function (err, result) {
         if (err) {
             next(err);
         } else {
diff --git a/package.json b/package.json
index 3cd95c1..a809285 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "sdc-docker",
-  "version": "0.4.10",
+  "version": "0.4.11",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

