From 45aaeb7b5dbca306ea8aa1e05bd07b754d68c729 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 1 Dec 2017 08:52:47 -0800
Subject: [PATCH] DOCKER-1131 Unable to login to quay.io Reviewed by: Trent
 Mick <trentm@gmail.com> Approved by: Trent Mick <trentm@gmail.com>

---
 lib/endpoints/auth.js | 10 +++++++++-
 package.json          |  2 +-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/lib/endpoints/auth.js b/lib/endpoints/auth.js
index 547e32a..abc70be 100644
--- a/lib/endpoints/auth.js
+++ b/lib/endpoints/auth.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright 2017 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -14,6 +14,7 @@ var fmt = require('util').format;
 var restify = require('restify');
 
 var common = require('../common');
+var constants = require('../constants');
 var errors = require('../errors');
 
 
@@ -53,10 +54,17 @@ function auth(req, res, next) {
         return next(new errors.ValidationError(errs.join(', ')));
     }
 
+    // DOCKER-1131 Some registries (e.g. quay.io) use the user agent to sniff
+    // for the docker server version, so we need to override the default user
+    // agent that sdc-docker uses, otherwise we will get a 404 error and be
+    // unable to login.
+    var userAgent = 'triton/' + constants.SERVER_VERSION;
+
     drc.login(common.httpClientOpts({
         indexName: req.body.serveraddress,
         log: log,
         insecure: req.app.config.dockerRegistryInsecure,
+        userAgent: userAgent,
         // auth info:
         username: req.body.username,
         password: req.body.password,
diff --git a/package.json b/package.json
index 3cd95c1..a809285 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "sdc-docker",
-  "version": "0.4.10",
+  "version": "0.4.11",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

