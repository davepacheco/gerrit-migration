{"project":"joyent/illumos-joyent","branch":"master","id":"If5e9c73fd709c7c523dc38e2d4a575eee08ad131","number":"1734","subject":"OS-5846 procfs should follow VFS rules Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/1734","commitMessage":"OS-5846 procfs should follow VFS rules\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1491248434,"lastUpdated":1491887698,"open":false,"status":"MERGED","comments":[{"timestamp":1491248434,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1491258322,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nCan you add an evaluation into the bug report."},{"timestamp":1491266942,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(3 comments)\n\nI think some of the basics here make sense, though I\u0027m worried that I\u0027ve missed some of the places that the primary file types which are changing have other implications based on how we\u0027re now structuring things. I\u0027m not sure I quite understand when we\u0027re getting proc nodes or not in this new world."},{"timestamp":1491347026,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1491410255,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nIt should be noted that software directly consuming procfs, which depends on the old behavior of these endpoints acting as weird half-link-half-directory entities will be broken by this change.  To date, I haven\u0027t found anything that acts in that manner.  When I discussed it with Bryan, he was on-board with ending this madness."},{"timestamp":1491425416,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\nI\u0027ve gone through this several times and as best I can tell this looks good."},{"timestamp":1491521744,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review-1\n\nRobert brought up some good examples of how the symlink approach may not be acceptable.  In our discussion, a new idea for how to solve the problem came to light, so I\u0027ll follow up with that."},{"timestamp":1491521761,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Integration-Approval-1"},{"timestamp":1491595905,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1491595915,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: -Code-Review -Integration-Approval"},{"timestamp":1491601119,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\nThanks for this iteration on the change Patrick."},{"timestamp":1491823625,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(2 comments)\n\nThis looks fine to me aside from a couple of small comment nits."},{"timestamp":1491838563,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1491838610,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1491839843,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1\n\nThanks for fixing those comments."},{"timestamp":1491845884,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1491852686,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\nI\u0027ve added some testing notes into the ticket."},{"timestamp":1491856216,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1491857641,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1491886609,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1491886633,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1491887698,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"f5e9c73fd709c7c523dc38e2d4a575eee08ad131","parents":["253dd0f6658bd3fa578967c3c4f366cb39442d25"],"ref":"refs/changes/34/1734/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491886633,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491839843,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491845884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491856216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1491887698,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":26,"deletions":-3},{"file":"usr/src/uts/common/fs/vnode.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/uts/common/sys/vnode.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"f7a2c9a4216df49f6c0c84674c9f55daa59678ab","parents":["63314e809a4ae4f2db49dab4dcb75b73c42aa18c"],"ref":"refs/changes/34/1734/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491248434,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491425416,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1491521744,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1491521761,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":444,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"With the other changes, it seems like it\u0027s possible to actually obtain access to the PR_FD node itself, is it not? If so, how does this interact with the changes in prlookup() to no longer return the underlying node? I\u0027ll admit those seemed of dubious value, but it did seem to ensure that we never saw the underlying /proc vnode, IIUC."},{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":444,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m not sure how the changes make this more possible.  Rather than returning a VDIR vnode which perhaps could have been opened, we\u0027re emitting VLNK nodes which would be traversed by lookupnameat() during vn_openat().  (If NOFOLLOW was set, an error would be emitted instead.)\n\nEven if something were to slip past these checks, pr_open() emits a reference to the real underlying vnode, not the one belonging to procfs."},{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":4694,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you explain how we got to 777 for this? Especially when it used to be 0500?"},{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":4694,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I originally had this pegged at 0500, but on further feedback from danmcd to match standard symlink expectations, switched it to 0777.  Proper access checking is performed for anyone actually attempting to perform a readlink(2)."},{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":6044,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What does this mean here? How does this entry correspond to a directory?"},{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":6044,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"For entries in /proc/PID/fd/##, open fds which correspond to directories will be represented as symlinks rather than using the old busted \"fake symlink\" behavior.  Entries which aren\u0027t directories should not tolerate a readlink(2)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man4/proc.4","type":"MODIFIED","insertions":4,"deletions":-10},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":46,"deletions":-39}],"sizeInsertions":50,"sizeDeletions":-49},{"number":"2","revision":"c83ae1ab0e23e9e06c1cf1702c27e46727e4beb9","parents":["3bec90a705e84f930818a783c3c4b0382f7420ab"],"ref":"refs/changes/34/1734/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491595905,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491601119,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":3566,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"duplicated"},{"file":"usr/src/uts/common/fs/proc/prvnops.c","line":3566,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fixed."},{"file":"usr/src/uts/common/sys/vnode.h","line":406,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Does it make sense to explicitly mention proc as an example. Right now this comment isn\u0027t very helpful to explain when to use this."},{"file":"usr/src/uts/common/sys/vnode.h","line":406,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I expanded on this comment, including a reference to procfs."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":26,"deletions":-3},{"file":"usr/src/uts/common/fs/vnode.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/uts/common/sys/vnode.h","type":"MODIFIED","insertions":7,"deletions":-1}],"sizeInsertions":50,"sizeDeletions":-4},{"number":"3","revision":"4b9284f0d395b1d662b8bfc2cae179b125251e32","parents":["02fc1e3e3317deffadcfa4f20cf16d2184036608"],"ref":"refs/changes/34/1734/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491838563,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491845884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491839843,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491856216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":26,"deletions":-3},{"file":"usr/src/uts/common/fs/vnode.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/uts/common/sys/vnode.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-4},{"number":"4","revision":"9b25c7912408a9f7671297c3ad4890c7c0fa8d9e","parents":["217415b79c30c5414f702fe59ef380cdc64b66e0"],"ref":"refs/changes/34/1734/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491857641,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491845884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491839843,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491856216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":26,"deletions":-3},{"file":"usr/src/uts/common/fs/vnode.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/uts/common/sys/vnode.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-4},{"number":"5","revision":"e5d1a4673837c3aba7a8689513c107c4e962b6b2","parents":["217415b79c30c5414f702fe59ef380cdc64b66e0"],"ref":"refs/changes/34/1734/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491886609,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491845884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491839843,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491856216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":26,"deletions":-3},{"file":"usr/src/uts/common/fs/vnode.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/uts/common/sys/vnode.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-4},{"number":"6","revision":"f5e9c73fd709c7c523dc38e2d4a575eee08ad131","parents":["253dd0f6658bd3fa578967c3c4f366cb39442d25"],"ref":"refs/changes/34/1734/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1491886633,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491845884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1491839843,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1491856216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1491887698,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/fs/proc/prvnops.c","type":"MODIFIED","insertions":26,"deletions":-3},{"file":"usr/src/uts/common/fs/vnode.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/uts/common/sys/vnode.h","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":52,"sizeDeletions":-4}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}