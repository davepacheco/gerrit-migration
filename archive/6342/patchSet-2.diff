From b10bb8fe65ccdd604e7e5e390922fd749ab11f34 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 21 May 2019 15:52:19 -0700
Subject: [PATCH] TRITON-1691 want cross-account RBAC in cloudapi

---
 lib/index.js | 21 +++++++++++++++++++++
 package.json |  2 +-
 2 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/lib/index.js b/lib/index.js
index 4d5e1c6..9a1bd47 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -772,6 +772,18 @@ UFDS.prototype._getUser = function _getUser(filter, msg, account, cb, noCache) {
             return self.listRoles(account, filter, callback, noCache);
         };
 
+        /*
+         * The "xOnAccount" versions know how to load roles with cross-account
+         * membership. They take the "owner" account UUID as an argument (the
+         * account the role belongs to, and thus the resource being accessed).
+         */
+        result.rolesOnAccount = function rolesOnAccount(acct, callback) {
+            var filter = sprintf(
+                '(&(objectclass=sdcaccountrole)(uniquemember=%s))',
+                result.dn.toString());
+            return self.listRoles(acct, filter, callback, noCache);
+        };
+
         // Same for default roles:
         result.defaultRoles = function defaultRoles(callback) {
             var filter = sprintf(
@@ -780,6 +792,15 @@ UFDS.prototype._getUser = function _getUser(filter, msg, account, cb, noCache) {
             return self.listRoles(account, filter, callback, noCache);
         };
 
+        result.defaultRolesOnAccount =
+            function defaultRolesOnAccount(acct, callback) {
+
+            var filter = sprintf(
+                '(&(objectclass=sdcaccountrole)(uniquememberdefault=%s))',
+                result.dn.toString());
+            return self.listRoles(acct, filter, callback, noCache);
+        };
+
         vasync.parallel({
             funcs: [
                 function loadGroups(callback) {
diff --git a/package.json b/package.json
index a431941..954f0c1 100644
--- a/package.json
+++ b/package.json
@@ -2,7 +2,7 @@
   "name": "ufds",
   "author": "Joyent (joyent.com)",
   "description": "SmartDataCenter UFDS Client API",
-  "version": "1.5.0",
+  "version": "1.6.0",
   "homepage": "https://github.com/joyent/sdc",
   "repository": {
     "type": "git",
-- 
2.21.0

