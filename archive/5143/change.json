{"project":"joyent/illumos-joyent","branch":"master","id":"I141fbf8a11a456171a5fce773f01ffef4edf0016","number":"5143","subject":"OS-7395 bhyve: VM_{SUSPEND,RESUME}_CPU ioctls ignore vcpu argument Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/5143","commitMessage":"OS-7395 bhyve: VM_{SUSPEND,RESUME}_CPU ioctls ignore vcpu argument\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1543338602,"lastUpdated":1544050828,"open":false,"status":"MERGED","comments":[{"timestamp":1543338602,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1543338933,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1543340204,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1543343600,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1543344256,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1543509711,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1543509945,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1543510333,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1\n\nAnd now you have three places doing almost exactly the same thing... but I won\u0027t insist..."},{"timestamp":1543522261,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1543574721,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1544027899,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1544049867,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1544050788,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1544050828,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"6","revision":"4966850cbd32c33aeed41ff4610b6ac82c195962","parents":["e0f08ef22a20cf816904f0b60a05b9dbe40cb836"],"ref":"refs/changes/43/5143/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1544050788,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543510333,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543522261,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544027899,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1544050828,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"c81e016ce01a4154d600c4caff607b33e65ca63e","parents":["c60c574ce98b74fd23cb02cb9f995ac79790570f"],"ref":"refs/changes/43/5143/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543338602,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":18,"deletions":0}],"sizeInsertions":18,"sizeDeletions":0},{"number":"2","revision":"f7046f1595a467df0901b437117b1eb4d04ab51b","parents":["c60c574ce98b74fd23cb02cb9f995ac79790570f"],"ref":"refs/changes/43/5143/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543338933,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":293,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I don\u0027t think this is the right place to do this, as this prelude is about locking the VCPUs, and you\u0027re not doing that. The comment isn\u0027t even relevant here as there is no other data.\n\nInstead this should be factored out into a copyin_vcpu_nr() function, and then used in the VM_SUSPEND/RESUME_CPU handler further down as well as the existing users."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":293,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Looking at the FreeBSD sources, they rely on the checks inside vm_suspend_cpu() and vm_resume_cpu() to verify that the vCPU ID is valid."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":293,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Yeah, but I\u0027m not really a fan of having our input checking differ in these cases. I\u0027d rather us just check at the point of ingress here in all these cases."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":293,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done, except I didn\u0027t factor it out in a separate function. I don\u0027t think thats necessary, it\u0027s used only in two places."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":18,"deletions":0}],"sizeInsertions":18,"sizeDeletions":0},{"number":"3","revision":"2d856dbb0cb07176cc1b9d8be6e4f7e2686ad4e1","parents":["0607bed40c616a0dcb558a7610dd15393869df9a"],"ref":"refs/changes/43/5143/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543509711,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543522261,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543510333,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},{"number":"4","revision":"bb23618909a4f3abe9ff05f5113046aef8d917a8","parents":["1f964c61cb509eee604f8f7190b9e03c95ca40b3"],"ref":"refs/changes/43/5143/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543574721,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543522261,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543510333,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544027899,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},{"number":"5","revision":"141fbf8a11a456171a5fce773f01ffef4edf0016","parents":["1f964c61cb509eee604f8f7190b9e03c95ca40b3"],"ref":"refs/changes/43/5143/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1544049867,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543522261,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543510333,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544027899,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},{"number":"6","revision":"4966850cbd32c33aeed41ff4610b6ac82c195962","parents":["e0f08ef22a20cf816904f0b60a05b9dbe40cb836"],"ref":"refs/changes/43/5143/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1544050788,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543522261,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1544050828,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543510333,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544027899,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}