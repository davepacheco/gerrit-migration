From f7046f1595a467df0901b437117b1eb4d04ab51b Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Mon, 8 Oct 2018 14:50:31 +0200
Subject: [PATCH] OS-7395 bhyve: VM_{SUSPEND,RESUME}_CPU ioctls ignore vcpu
 argument

---
 usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c b/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c
index 04f5409afa..adb09149e5 100644
--- a/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c
+++ b/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c
@@ -290,6 +290,24 @@ vmmdev_do_ioctl(vmm_softc_t *sc, int cmd, intptr_t arg, int md,
 	 * Some VMM ioctls can operate only on vcpus that are not running.
 	 */
 	switch (cmd) {
+	case VM_SUSPEND_CPU:
+	case VM_RESUME_CPU:
+		/*
+		 * Copy in the ID of the vCPU chosen for this operation.
+		 * Since a nefarious caller could update their struct between
+		 * this locking and when the rest of the ioctl data is copied
+		 * in, it is _critical_ that this local 'vcpu' variable be used
+		 * rather than the in-struct one when performing the ioctl.
+		 */
+		if (ddi_copyin(datap, &vcpu, sizeof (vcpu), md)) {
+			return (EFAULT);
+		}
+		if (vcpu < -1 || vcpu >= VM_MAXCPU) {
+			error = EINVAL;
+			goto done;
+		}
+		break;
+
 	case VM_RUN:
 	case VM_GET_REGISTER:
 	case VM_SET_REGISTER:
-- 
2.21.0

