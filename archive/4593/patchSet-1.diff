From c0a1ad751387329210237f6fed3a3aa91dbe18e2 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Fri, 27 Jul 2018 14:20:47 +0000
Subject: [PATCH] TRITON-639 amon-agent postinstall broken by TRITON-478

---
 agent/pkg/postinstall.sh | 3 ++-
 relay/pkg/postinstall.sh | 3 ++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/agent/pkg/postinstall.sh b/agent/pkg/postinstall.sh
index a6b7f23..5b586b0 100755
--- a/agent/pkg/postinstall.sh
+++ b/agent/pkg/postinstall.sh
@@ -28,7 +28,8 @@ fi
 set -o errexit
 set -o pipefail
 
-if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]]; then
+if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]] && \
+	[[ -z "$SMF_FMRI" ]]; then
     echo "Skipping amon-agent postinstall (assuming build-time install)"
     exit 0
 fi
diff --git a/relay/pkg/postinstall.sh b/relay/pkg/postinstall.sh
index b375032..7e0495e 100755
--- a/relay/pkg/postinstall.sh
+++ b/relay/pkg/postinstall.sh
@@ -18,7 +18,8 @@ fi
 
 set -o xtrace
 
-if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]]; then
+if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]] && \
+	[[ -z "$SMF_FMRI" ]]; then
   echo "Skipping amon-relay postinstall (assuming build-time install)"
   exit 0
 fi
-- 
2.21.0

