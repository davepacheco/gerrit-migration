{"project":"joyent/sdc-amon","branch":"master","id":"I0dbe6a80151798d55bd770dfb552d38d902746ca","number":"4593","subject":"TRITON-639 amon-agent postinstall broken by TRITON-478 Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/4593","commitMessage":"TRITON-639 amon-agent postinstall broken by TRITON-478\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1532701251,"lastUpdated":1533037511,"open":false,"status":"MERGED","comments":[{"timestamp":1532701251,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1532701256,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 70e0e4410acb4e4b08db9db168aab829a5ef627f\n    \n    TRITON-639 amon-agent postinstall broken by TRITON-478"},{"timestamp":1532701283,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532725272,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1532945824,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1532945831,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit c208896955558f99a8d76a730ecde6412b8ef3dc\n    \n    TRITON-639 amon-agent postinstall broken by TRITON-478"},{"timestamp":1532945859,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1532945942,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nYes, I totally agree that $SDC_AGENT_SKIP_LIFECYCLE is cleaner, thanks for suggesting that! I\u0027ve made those changes and tested that they work both for a non-root build, and when running the post-install as part of doing \u0027sdcadm update adminui@\u003cuuid\u003e\u0027, verifying that we have a running amon-agent SMF service after reprovisioning."},{"timestamp":1532994905,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1533037466,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1533037472,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 05abb78075a085b77fc3a3cc31c9e11e7923ce0f\n    \n    TRITON-639 amon-agent postinstall broken by TRITON-478\n    Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n    Approved by: Trent Mick \u003ctrentm@gmail.com\u003e"},{"timestamp":1533037511,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"3","revision":"0dbe6a80151798d55bd770dfb552d38d902746ca","parents":["5008279f7251c34a1c621e4ea616010bfb41d752"],"ref":"refs/changes/93/4593/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1533037466,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532945859,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532994905,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1532994905,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1533037510,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":21,"deletions":-8},{"file":"agent/pkg/postinstall.sh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"relay/pkg/postinstall.sh","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":25,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"c0a1ad751387329210237f6fed3a3aa91dbe18e2","parents":["5008279f7251c34a1c621e4ea616010bfb41d752"],"ref":"refs/changes/93/4593/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1532701251,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532701283,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"agent/pkg/postinstall.sh","line":32,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I worry that that is a little subtle. If I attempt to run https://github.com/joyent/sdc-scripts/blob/master/lib/util.sh#L215 or https://github.com/joyent/manta-scripts/blob/master/services.sh#L131 for dev/testing by manually calling the setup.sh script, then it will subtley work differently.\n\nA few of the other agents flipped the logic a bit: By default the postinstall/postuninstall scripts will run through. If then \"SDC_AGENT_SKIP_LIFECYCLE\u003dyes\" envvar is set, then they will exit early.  To handle *not* running those lifecycle scripts for the build those agents ensure that envvar is set when running the build via:\n\n- https://github.com/joyent/sdc-vm-agent/blob/master/Makefile#L59-L66\n- https://github.com/joyent/triton-cmon-agent/blob/master/Makefile#L67\n- https://github.com/joyent/sdc-cn-agent/blob/master/Makefile#L70\n- ditto for net-agent and triton-mockcloud.git\n\nThoughts on switching to that? It makes it more explicit."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"agent/pkg/postinstall.sh","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"relay/pkg/postinstall.sh","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":4,"sizeDeletions":-2},{"number":"2","revision":"9042ab02ef82773566b7c2675464fc22d46af243","parents":["5008279f7251c34a1c621e4ea616010bfb41d752"],"ref":"refs/changes/93/4593/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1532945824,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532945859,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532994905,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1532994905,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":21,"deletions":-8},{"file":"agent/pkg/postinstall.sh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"relay/pkg/postinstall.sh","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":25,"sizeDeletions":-12},{"number":"3","revision":"0dbe6a80151798d55bd770dfb552d38d902746ca","parents":["5008279f7251c34a1c621e4ea616010bfb41d752"],"ref":"refs/changes/93/4593/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1533037466,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1532945859,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1532994905,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1532994905,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1533037510,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":21,"deletions":-8},{"file":"agent/pkg/postinstall.sh","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"relay/pkg/postinstall.sh","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":25,"sizeDeletions":-12}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}