commit f1de2ea8a36b69ec39b00b7758a26564a1a1091c (refs/changes/99/99/1)
Author: Pedro P. Candel <pedro@joyent.com>
Date:   2016-07-19T12:13:50+02:00 (3 years, 3 months ago)
    
    TOOLS-1487 sdcadm improve function for handling circular references

diff --git a/lib/history.js b/lib/history.js
index ae03cac..337b691 100644
--- a/lib/history.js
+++ b/lib/history.js
@@ -30,17 +30,13 @@ var UUID_RE = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;
 
 // Intended to be used as second argument to JSON.Stringify() in order to
 // prevent 'TypeError: Converting circular structure to JSON'
-function replacer() {
+function safeCycles() {
     var i = 0;
     var objs = [];
     return function (key, value) {
-        // Avoid "RangeError: Maximum call stack size exceeded"
-        // (Note this is an arbitrary number, need to set max depth
-        // at some point)
-        if (i >= 29) {
-            return '[Unknown]';
+        if (!value || typeof (value) !== 'object') {
+            return value;
         }
-        i += 1;
         if (objs.indexOf(value) !== -1) {
             return '[Circular]';
         } else {
@@ -54,7 +50,7 @@ function replacer() {
 function saveHistoryToFile(fname, history, cb) {
     var s;
     try {
-        s = JSON.stringify(history, replacer());
+        s = JSON.stringify(history, safeCycles());
     } catch (e) {
         s = '{}';
     }
