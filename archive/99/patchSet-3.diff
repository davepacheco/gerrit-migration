From 3c6dad723139d6de3b0ce8e15b799690f2ecb4f0 Mon Sep 17 00:00:00 2001
From: "Pedro P. Candel" <pedro@joyent.com>
Date: Tue, 19 Jul 2016 12:13:50 +0200
Subject: [PATCH] TOOLS-1487 sdcadm improve function for handling circular
 references Reviewed by: Trent Mick <trent.mick@joyent.com> Reviewed by:
 Joshua M. Clulow <jmc@joyent.com>

---
 lib/history.js | 13 ++++---------
 1 file changed, 4 insertions(+), 9 deletions(-)

diff --git a/lib/history.js b/lib/history.js
index ae03cac..ae0df76 100644
--- a/lib/history.js
+++ b/lib/history.js
@@ -30,17 +30,12 @@ var UUID_RE = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;
 
 // Intended to be used as second argument to JSON.Stringify() in order to
 // prevent 'TypeError: Converting circular structure to JSON'
-function replacer() {
-    var i = 0;
+function safeCycles() {
     var objs = [];
     return function (key, value) {
-        // Avoid "RangeError: Maximum call stack size exceeded"
-        // (Note this is an arbitrary number, need to set max depth
-        // at some point)
-        if (i >= 29) {
-            return '[Unknown]';
+        if (!value || typeof (value) !== 'object') {
+            return value;
         }
-        i += 1;
         if (objs.indexOf(value) !== -1) {
             return '[Circular]';
         } else {
@@ -54,7 +49,7 @@ function replacer() {
 function saveHistoryToFile(fname, history, cb) {
     var s;
     try {
-        s = JSON.stringify(history, replacer());
+        s = JSON.stringify(history, safeCycles());
     } catch (e) {
         s = '{}';
     }
-- 
2.21.0

