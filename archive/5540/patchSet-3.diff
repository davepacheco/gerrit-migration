From 63ab39de29c5e5f1967300e39c2f905097355e62 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Sun, 24 Feb 2019 19:56:15 +0000
Subject: [PATCH] TRITON-1148 convert sdc-smart-login to engbld framework

---
 .gitmodules               |  3 +++
 Makefile                  | 53 ++++++++++++++++++---------------------
 bamboo/build.sh           | 36 --------------------------
 bamboo/publish.sh         | 17 -------------
 deps/eng                  |  1 +
 package.json              |  2 +-
 tools/mk/Makefile.gitdefs | 21 ----------------
 7 files changed, 30 insertions(+), 103 deletions(-)
 create mode 100644 .gitmodules
 delete mode 100755 bamboo/build.sh
 delete mode 100644 bamboo/publish.sh
 create mode 160000 deps/eng
 delete mode 100644 tools/mk/Makefile.gitdefs

diff --git a/.gitmodules b/.gitmodules
new file mode 100644
index 0000000..06f62d4
--- /dev/null
+++ b/.gitmodules
@@ -0,0 +1,3 @@
+[submodule "deps/eng"]
+	path = deps/eng
+	url = git@github.com:joyent/eng.git
diff --git a/Makefile b/Makefile
index fbd8f92..96a57e4 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2019, Joyent, Inc.
 #
 
 # Smartlogin Makefile
@@ -13,18 +13,20 @@
 NAME=smartlogin
 TOP := $(shell pwd)
 
-# Need GNU awk for multi-char arg to "-F".
-AWK=$(shell (which gawk 2>/dev/null | grep -v "^no ") || which awk)
-BRANCH=$(shell git symbolic-ref HEAD | $(AWK) -F/ '{print $$3}')
-ifeq ($(TIMESTAMP),)
-	TIMESTAMP=$(shell date -u "+%Y%m%dT%H%M%SZ")
-endif
-GITDESCRIBE=g$(shell git describe --all --long --dirty | $(AWK) -F'-g' '{print $$NF}')
-BASE=$(NAME)-$(BRANCH)-$(TIMESTAMP)-$(GITDESCRIBE)
+ENGBLD_REQUIRE := $(shell git submodule update --init deps/eng)
+include ./deps/eng/tools/mk/Makefile.defs
+TOP ?= $(error Unable to access eng.git submodule Makefiles.)
+
+# While this component doesn't require a base image, we set this so
+# that validate-buildenv can determine whether we're building on
+# smartos 1.6.3, currently a requirement.
+BASE_IMAGE_UUID=fd2cc906-8938-11e3-beab-4359c665ac99
+
+
+BASE=$(NAME)-$(STAMP)
 TARBALL=$(BASE).tgz
 MANIFEST=$(BASE).manifest
 
-
 CC	= gcc
 CCFLAGS	= -fPIC -g -Wall -Werror -I$(TOP)/hack-platform-include
 LDFLAGS	= -nodefaultlibs -L/lib -L/usr/lib -lc -lnvpair
@@ -51,11 +53,10 @@ NPM_FILES =		\
 	etc		\
 	npm-scripts
 
-include ./tools/mk/Makefile.gitdefs
+CLEAN_FILES += bin .npm core $~ smartlogin*.tgz smartlogin*.manifest ${AGENT}
 
-.PHONY: all clean distclean npm
-
-all:: npm
+.PHONY: all clean npm
+all: npm
 
 ${AGENT}:
 	mkdir -p bin
@@ -72,6 +73,9 @@ lint:
 		echo "--------------------" ; \
 	done
 
+$(NPM_FILES):
+	mkdir -p $@
+
 $(TARBALL): ${AGENT} $(NPM_FILES) package.json
 	rm -fr .npm
 	mkdir -p .npm/$(NAME)/
@@ -79,7 +83,7 @@ $(TARBALL): ${AGENT} $(NPM_FILES) package.json
 	uuid -v4 > .npm/$(NAME)/image_uuid
 	json -f package.json -e 'this.version += "-$(STAMP)"' \
 	    > .npm/$(NAME)/package.json
-	(cd .npm && gtar zcvf ../$(TARBALL) $(NAME))
+	(cd .npm && gtar -I pigz -cvf ../$(TARBALL) $(NAME))
 	cat $(TOP)/manifest.tmpl | sed \
 		-e "s/UUID/$$(cat .npm/$(NAME)/image_uuid)/" \
 		-e "s/NAME/$$(json name < .npm/$(NAME)/package.json)/" \
@@ -93,19 +97,12 @@ $(TARBALL): ${AGENT} $(NPM_FILES) package.json
 
 npm: $(TARBALL)
 
-# The "publish" target requires that "BITS_DIR" be defined.
-# The target will then publish to "$BITS_DIR/smartlogin/".
-publish: $(BITS_DIR)
-	@if [[ -z "$(BITS_DIR)" ]]; then \
-		echo "error: 'BITS_DIR' must be set for 'publish' target"; \
-		exit 1; \
-	fi
-	mkdir -p $(BITS_DIR)/smartlogin
-	cp $(TARBALL) $(BITS_DIR)/smartlogin/
-	cp $(MANIFEST) $(BITS_DIR)/smartlogin/
+publish:
+	mkdir -p $(ENGBLD_BITS_DIR)/smartlogin
+	cp $(TARBALL) $(ENGBLD_BITS_DIR)/smartlogin/
+	cp $(MANIFEST) $(ENGBLD_BITS_DIR)/smartlogin/
 
-clean:
-	-rm -rf bin .npm core $~ smartlogin*.tgz ${AGENT}
+clean::
 	find . -name *.o | xargs rm -f
 
-distclean: clean
+include ./deps/eng/tools/mk/Makefile.targ
diff --git a/bamboo/build.sh b/bamboo/build.sh
deleted file mode 100755
index 8d06892..0000000
--- a/bamboo/build.sh
+++ /dev/null
@@ -1,36 +0,0 @@
-#!/bin/bash
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-set -e
-
-DIRNAME=$(cd `dirname $0`; pwd)
-gmake clean && gmake lint && gmake
-
-NAME=smartlogin
-BRANCH=$(git symbolic-ref HEAD | cut -d'/' -f3)
-DESCRIBE=$(git describe)
-BUILDSTAMP=`TZ=UTC date "+%Y%m%dT%H%M%SZ"`; export BUILDSTAMP
-PKG=${NAME}-${BRANCH}-${BUILDSTAMP}-${DESCRIBE}.tgz
-
-if [[ $( echo $BRANCH | grep release) && -z $PUBLISH_LOCATION ]]; then
-    releasedate=$(echo $BRANCH | cut -d '-' -f2)
-    RELEASEDIR=${releasedate:0:4}-${releasedate:4:2}-${releasedate:6:2}
-    PUBLISH_LOCATION=/rpool/data/coal/releases/${RELEASEDIR}/deps/agents/smartlogin/${BRANCH}/
-fi
-
-if [[ -z $PUBLISH_LOCATION ]]; then
-    PUBLISH_LOCATION=/rpool/data/coal/live_147/agents/smartlogin/${BRANCH}/
-fi
-if [[ `hostname` = 'bh1-autobuild' ]]; then
-    DO_PUBLISH=1;
-fi
-
-source $DIRNAME/publish.sh
diff --git a/bamboo/publish.sh b/bamboo/publish.sh
deleted file mode 100644
index 13a60e1..0000000
--- a/bamboo/publish.sh
+++ /dev/null
@@ -1,17 +0,0 @@
-#!/bin/bash
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-if [[ $DO_PUBLISH == 1 ]]; then
-  pfexec mkdir -p $PUBLISH_LOCATION
-  pfexec cp smart-login.tgz $PUBLISH_LOCATION/$PKG
-else
-  echo scp
-fi
diff --git a/deps/eng b/deps/eng
new file mode 160000
index 0000000..7c472bc
--- /dev/null
+++ b/deps/eng
@@ -0,0 +1 @@
+Subproject commit 7c472bc495ba44ac4cdde0af50ff627021942524
diff --git a/package.json b/package.json
index e21376a..2f3832f 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "smartlogin",
   "description": "Joyent Zone User Authentication Agent",
-  "version": "0.2.1",
+  "version": "0.2.2",
   "homepage": "http://github.com/joyent/sdc",
   "author": "Joyent (joyent.com)",
   "bin": {
diff --git a/tools/mk/Makefile.gitdefs b/tools/mk/Makefile.gitdefs
deleted file mode 100644
index f5b70dc..0000000
--- a/tools/mk/Makefile.gitdefs
+++ /dev/null
@@ -1,21 +0,0 @@
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-AWK = awk
-
-BRANCH := $(shell git symbolic-ref HEAD | $(AWK) -F/ '{print $$3}')
-
-ifeq ($(TIMESTAMP),)
-TIMESTAMP := $(shell date -u "+%Y%m%dT%H%M%SZ")
-endif
-
-_GITDESCRIBE := g$(shell git describe --all --long --dirty | $(AWK) -F'-g' '{print $$NF}')
-
-STAMP := $(BRANCH)-$(TIMESTAMP)-$(_GITDESCRIBE)
-- 
2.21.0

