{"project":"joyent/smartos-live","branch":"master","id":"I54cda0a5d089dc27fc8bb42d4f3c53289e24516d","number":"1781","subject":"OS-6050 improve platform live image build tool OS-6051 /var/log/manifest is almost certainly not what you wanted Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/1781","commitMessage":"OS-6050 improve platform live image build tool\nOS-6051 /var/log/manifest is almost certainly not what you wanted\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1491948437,"lastUpdated":1494793602,"open":false,"status":"MERGED","comments":[{"timestamp":1491948437,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1491948474,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491948582,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\nThe rendered diff (on Github) of README.md is probably useful to reviewers:\n\nhttps://github.com/joyent/smartos-live/compare/master...OS-6050?short_path\u003d04c6e90#diff-04c6e90faac2675aa89e2176d2eec7d8"},{"timestamp":1491948657,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\nSigh.  A second, hopefully functional, link to the rendered diff: https://goo.gl/YZHZAC"},{"timestamp":1492119357,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(7 comments)"},{"timestamp":1493779795,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1493779804,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(7 comments)"},{"timestamp":1493779834,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1493833893,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1494616578,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1494616624,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1494616634,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1494631096,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1494631137,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1494701908,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5."},{"timestamp":1494701946,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1494743289,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1494793602,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"5","revision":"54cda0a5d089dc27fc8bb42d4f3c53289e24516d","parents":["b7272e9a8d0bc947e9e85b9ebae9237a8024a55d"],"ref":"refs/changes/81/1781/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1494701908,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494701946,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494743289,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494743289,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1494793602,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":115,"deletions":-87},{"file":"overlay/generic/lib/svc/method/fs-joyent","type":"MODIFIED","insertions":25,"deletions":-16},{"file":"src/manifest","type":"MODIFIED","insertions":4,"deletions":0},{"file":"tools/build_etcrelease","type":"MODIFIED","insertions":97,"deletions":-49},{"file":"tools/build_iso","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"tools/build_live","type":"MODIFIED","insertions":816,"deletions":-360},{"file":"tools/customize","type":"DELETED","insertions":0,"deletions":-62},{"file":"tools/etc_release.template.txt","type":"ADDED","insertions":4,"deletions":0},{"file":"tools/lib/build_common.sh","type":"MODIFIED","insertions":115,"deletions":-7},{"file":"tools/smf_import","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":1188,"sizeDeletions":-593},"patchSets":[{"number":"1","revision":"52af6dad61581444dc2d0f362c48bc25ddd8e5e7","parents":["37fa0b13a2503039ea0e9ba785f1951785d941ad"],"ref":"refs/changes/81/1781/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1491948437,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491948474,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/method/fs-joyent","line":141,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should check if this file exists so we don\u0027t clobber something in /var/log with this name."},{"file":"overlay/generic/lib/svc/method/fs-joyent","line":141,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"tools/build_etcrelease","line":52,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Was there something wrong with the previous style here"},{"file":"tools/build_etcrelease","line":52,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Nothing concrete, I just think the if/then style makes it more obvious that there\u0027s a branch here."},{"file":"tools/build_live","line":27,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be checking for failure of these?"},{"file":"tools/build_live","line":27,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, we should!  Good catch."},{"file":"tools/build_live","line":31,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it possible for the . command to fail in any way?"},{"file":"tools/build_live","line":31,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, I dare say that it is.  I\u0027ll check the return."},{"file":"tools/build_live","line":277,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Kind of makes me wish we could have a way to generate and run man without pfexec and instead just have the moving it into place be the thing that does the pfexec."},{"file":"tools/build_live","line":277,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We could file a follow-up to add a flag (or perhaps an environment variable) to override the whatis location?"},{"file":"tools/build_live","line":385,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we use tee here and then redirect the output to /dev/null? Should this just be cat redirected to the file?"},{"file":"tools/build_live","line":385,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Because I want to open the file as root, hence \"pfexec tee\".  If I were to use \"cat\", even with pfexec, the shell redirection would still be performed in the context of the build user -- which almost certainly won\u0027t have permissions where we require."},{"file":"tools/build_live","line":385,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we add a comment explaining that? I don\u0027t think I would have gotten that implication otherwise."},{"file":"tools/build_live","line":385,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"tools/lib/build_common.sh","line":180,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it always the boot archive build that failed? What about the other cases that are mentioned at the top of this (vmware, etc.)?"},{"file":"tools/lib/build_common.sh","line":180,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"You\u0027re right, this is a common file.  I\u0027ll correct it to just say \"BUILD FAILURE\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":115,"deletions":-87},{"file":"overlay/generic/lib/svc/method/fs-joyent","type":"MODIFIED","insertions":24,"deletions":-16},{"file":"src/manifest","type":"MODIFIED","insertions":4,"deletions":0},{"file":"tools/build_etcrelease","type":"MODIFIED","insertions":97,"deletions":-49},{"file":"tools/build_iso","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"tools/build_live","type":"MODIFIED","insertions":797,"deletions":-362},{"file":"tools/customize","type":"DELETED","insertions":0,"deletions":-62},{"file":"tools/etc_release.template.txt","type":"ADDED","insertions":4,"deletions":0},{"file":"tools/lib/build_common.sh","type":"MODIFIED","insertions":115,"deletions":-7},{"file":"tools/smf_import","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":1168,"sizeDeletions":-595},{"number":"2","revision":"21f76aeb26fc49894b36024bd36a646cabadf2d4","parents":["e738ed4c60cc150fbfb5658fabae1ab3d68a17f5"],"ref":"refs/changes/81/1781/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1493779795,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493833893,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493779834,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":115,"deletions":-87},{"file":"overlay/generic/lib/svc/method/fs-joyent","type":"MODIFIED","insertions":25,"deletions":-16},{"file":"src/manifest","type":"MODIFIED","insertions":4,"deletions":0},{"file":"tools/build_etcrelease","type":"MODIFIED","insertions":97,"deletions":-49},{"file":"tools/build_iso","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"tools/build_live","type":"MODIFIED","insertions":801,"deletions":-360},{"file":"tools/customize","type":"DELETED","insertions":0,"deletions":-62},{"file":"tools/etc_release.template.txt","type":"ADDED","insertions":4,"deletions":0},{"file":"tools/lib/build_common.sh","type":"MODIFIED","insertions":115,"deletions":-7},{"file":"tools/smf_import","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":1173,"sizeDeletions":-593},{"number":"3","revision":"01ba8891ae0d41a31ca05c8c93c4731d04f48ff1","parents":["b7272e9a8d0bc947e9e85b9ebae9237a8024a55d"],"ref":"refs/changes/81/1781/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1494616578,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494631096,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494631096,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494616624,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":115,"deletions":-87},{"file":"overlay/generic/lib/svc/method/fs-joyent","type":"MODIFIED","insertions":25,"deletions":-16},{"file":"src/manifest","type":"MODIFIED","insertions":4,"deletions":0},{"file":"tools/build_etcrelease","type":"MODIFIED","insertions":97,"deletions":-49},{"file":"tools/build_iso","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"tools/build_live","type":"MODIFIED","insertions":808,"deletions":-360},{"file":"tools/customize","type":"DELETED","insertions":0,"deletions":-62},{"file":"tools/etc_release.template.txt","type":"ADDED","insertions":4,"deletions":0},{"file":"tools/lib/build_common.sh","type":"MODIFIED","insertions":115,"deletions":-7},{"file":"tools/smf_import","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":1180,"sizeDeletions":-593},{"number":"4","revision":"63a33ee3f9dab8e6f305bae25a7e7e57e634e653","parents":["b7272e9a8d0bc947e9e85b9ebae9237a8024a55d"],"ref":"refs/changes/81/1781/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1494631137,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494631096,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494631096,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494616624,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":115,"deletions":-87},{"file":"overlay/generic/lib/svc/method/fs-joyent","type":"MODIFIED","insertions":25,"deletions":-16},{"file":"src/manifest","type":"MODIFIED","insertions":4,"deletions":0},{"file":"tools/build_etcrelease","type":"MODIFIED","insertions":97,"deletions":-49},{"file":"tools/build_iso","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"tools/build_live","type":"MODIFIED","insertions":808,"deletions":-360},{"file":"tools/customize","type":"DELETED","insertions":0,"deletions":-62},{"file":"tools/etc_release.template.txt","type":"ADDED","insertions":4,"deletions":0},{"file":"tools/lib/build_common.sh","type":"MODIFIED","insertions":115,"deletions":-7},{"file":"tools/smf_import","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":1180,"sizeDeletions":-593},{"number":"5","revision":"54cda0a5d089dc27fc8bb42d4f3c53289e24516d","parents":["b7272e9a8d0bc947e9e85b9ebae9237a8024a55d"],"ref":"refs/changes/81/1781/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1494701908,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1494743289,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1494743289,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1494793602,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1494701946,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"README.md","type":"MODIFIED","insertions":115,"deletions":-87},{"file":"overlay/generic/lib/svc/method/fs-joyent","type":"MODIFIED","insertions":25,"deletions":-16},{"file":"src/manifest","type":"MODIFIED","insertions":4,"deletions":0},{"file":"tools/build_etcrelease","type":"MODIFIED","insertions":97,"deletions":-49},{"file":"tools/build_iso","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"tools/build_live","type":"MODIFIED","insertions":816,"deletions":-360},{"file":"tools/customize","type":"DELETED","insertions":0,"deletions":-62},{"file":"tools/etc_release.template.txt","type":"ADDED","insertions":4,"deletions":0},{"file":"tools/lib/build_common.sh","type":"MODIFIED","insertions":115,"deletions":-7},{"file":"tools/smf_import","type":"MODIFIED","insertions":2,"deletions":-5}],"sizeInsertions":1188,"sizeDeletions":-593}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}