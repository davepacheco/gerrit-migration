{"project":"joyent/illumos-kvm","branch":"master","topic":"OS-7102","id":"I1deeedfd407940627d5607861311776fd9804725","number":"4638","subject":"OS-7102 expose pvclock to KVM guests Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/4638","commitMessage":"OS-7102 expose pvclock to KVM guests\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1533581562,"lastUpdated":1535047409,"open":false,"status":"MERGED","comments":[{"timestamp":1533581562,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1533581629,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Topic set to OS-7102"},{"timestamp":1533586743,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1533588499,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1533588962,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1533588996,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1533603942,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1533638306,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(1 comment)\n\nCan we/should we be implementing PVCLOCK_TSC_STABLE_BIT ?"},{"timestamp":1533662168,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1533678532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1533727607,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(1 comment)\n\nIs it intentional that you\u0027re not actually setting the STABLE_BIT flag?"},{"timestamp":1533748011,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5."},{"timestamp":1533748315,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(1 comment)\n\nJohn: When I originally read through how the flags were used, I missed an interaction between the capability setting and the flag itself.  Addition of the flag now occurs in the write routine."},{"timestamp":1533749967,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1533750533,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1534175267,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1534194505,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1534194510,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1534882665,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6."},{"timestamp":1534882682,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\nMinor conflict during rebasing"},{"timestamp":1534884567,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1534959832,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1534959900,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1\n\n(1 comment)"},{"timestamp":1534969390,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\nAdded some test notes to the jira ticket."},{"timestamp":1534972717,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1535046175,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1535046193,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1535047409,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"8","revision":"1deeedfd407940627d5607861311776fd9804725","parents":["08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735"],"ref":"refs/changes/38/4638/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1535046193,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534884567,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959900,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534972717,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1535047409,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":97,"deletions":-125},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":12,"deletions":-10}],"sizeInsertions":109,"sizeDeletions":-135},"patchSets":[{"number":"1","revision":"114f09f00cab791251eca538fe9b3d60f1fba9d2","parents":["657e3ab2d1aefe7cab92349b884c616b517bf200"],"ref":"refs/changes/38/4638/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1533581562,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"kvm_x86.c","line":796,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This comment was helpful in understanding why version is sometimes incremented by one and other times by two. Perhaps we can keep it around somewhere."},{"file":"kvm_x86.c","line":796,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Supplemented with a comment from upstream, rather than this one which is somewhat inaccurate."},{"file":"kvm_x86.c","line":1150,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Do you know anything about what we were supposed to check in linux while updating this code?  Is this comment still relevant?"},{"file":"kvm_x86.c","line":1150,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Nuked since this feature implementation wasn\u0027t a backport from Linux"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":73,"deletions":-119},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":7,"deletions":-9}],"sizeInsertions":80,"sizeDeletions":-128},{"number":"2","revision":"d59158770ceeeb4cf77d5846c6bb94dc00b77da4","parents":["657e3ab2d1aefe7cab92349b884c616b517bf200"],"ref":"refs/changes/38/4638/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1533588499,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":75,"deletions":-125},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":7,"deletions":-9}],"sizeInsertions":82,"sizeDeletions":-134},{"number":"3","revision":"8ce8a5188412fe84d2dd514610968ff84aae53e5","parents":["657e3ab2d1aefe7cab92349b884c616b517bf200"],"ref":"refs/changes/38/4638/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1533588962,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"kvm_x86.c","line":754,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we need memory barriers around the version modifications here and at the end?"},{"file":"kvm_x86.c","line":754,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Even though Linux guests don\u0027t reach into this across CPUs, it would probably be a good idea.  I\u0027ll add \u0027em."},{"file":"kvm_x86.c","line":772,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"How did we come up with this number?"},{"file":"kvm_x86.c","line":772,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Upstream has a similar rate limit.  I\u0027ll add a comment."},{"file":"kvm_x86.c","line":1156,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Did you explicitly decide we don\u0027t need MSR_KVM_SYSTEM_TIME_NEW? Upstream indicates the old MSR number might go away."},{"file":"kvm_x86.c","line":1156,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I can look into adding that.  I believe the output formats are the same."},{"file":"kvm_x86.c","line":1168,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason we silently ignore this versus injecting a #GP?"},{"file":"kvm_x86.c","line":1168,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"AFAICT, failures when setting this MSR in upstream do not result in any errors visible to the guest.  Practically speaking, consumers dedicate a whole page to this, so it\u0027s not a problem."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":82,"deletions":-123},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":7,"deletions":-9}],"sizeInsertions":89,"sizeDeletions":-132},{"number":"4","revision":"b43ea00ad34df114f87107bce541a0660cc42540","parents":["657e3ab2d1aefe7cab92349b884c616b517bf200"],"ref":"refs/changes/38/4638/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1533678532,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"kvm_x86.c","line":775,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"is this still due a comment about where it\u0027s from?"},{"file":"kvm_x86.c","line":775,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Whoops, added."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":93,"deletions":-126},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":7,"deletions":-9}],"sizeInsertions":100,"sizeDeletions":-135},{"number":"5","revision":"ca09029abb29c1ad730674c02d74418304c3e809","parents":["657e3ab2d1aefe7cab92349b884c616b517bf200"],"ref":"refs/changes/38/4638/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1533748011,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534194510,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533749967,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534175267,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533750533,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"kvm_x86.c","line":4790,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I assume that if we hit a reboot this\u0027ll not get reset. Is that OK? I assume so."},{"file":"kvm_x86.c","line":4790,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I searched for similar logic in upstream KVM and didn\u0027t fine any."},{"file":"kvm_x86.c","line":4790,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK. Make sense. Thanks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":98,"deletions":-126},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":12,"deletions":-10}],"sizeInsertions":110,"sizeDeletions":-136},{"number":"6","revision":"a4a56e051cf01b370f6471359bcd61693b8ce4e7","parents":["08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735"],"ref":"refs/changes/38/4638/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534882665,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959900,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534972717,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534884567,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":97,"deletions":-125},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":12,"deletions":-10}],"sizeInsertions":109,"sizeDeletions":-135},{"number":"7","revision":"070bacb6909cb09aa0165429d102273f3e1ffb7f","parents":["08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735"],"ref":"refs/changes/38/4638/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1535046175,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959900,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534972717,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534884567,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":97,"deletions":-125},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":12,"deletions":-10}],"sizeInsertions":109,"sizeDeletions":-135},{"number":"8","revision":"1deeedfd407940627d5607861311776fd9804725","parents":["08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735"],"ref":"refs/changes/38/4638/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1535046193,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534959900,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534972717,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1535047409,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534884567,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"kvm_x86.c","type":"MODIFIED","insertions":97,"deletions":-125},{"file":"kvm_x86host.h","type":"MODIFIED","insertions":12,"deletions":-10}],"sizeInsertions":109,"sizeDeletions":-135}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}