From 6f7151bd14c0850078d152d669e4d833a33155a8 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 21 Apr 2017 16:31:43 -0700
Subject: [PATCH] SAPI-286 SAPI DeleteInstance should cope with VMAPI DeleteVm
 returning 200 and no job_uuid

---
 lib/server/vmapiplus.js | 18 +++++++++++++++---
 1 file changed, 15 insertions(+), 3 deletions(-)

diff --git a/lib/server/vmapiplus.js b/lib/server/vmapiplus.js
index ca0d18e..bb5bb5f 100644
--- a/lib/server/vmapiplus.js
+++ b/lib/server/vmapiplus.js
@@ -82,17 +82,29 @@ function deleteVm(uuid, cb) {
     var params = {};
     params.uuid = uuid;
 
-    vmapi.deleteVm(params, function (err, res) {
+    vmapi.deleteVm(params, function (err, body) {
         if (err) {
             log.error(err, 'failed to delete VM %s', uuid);
             return (cb(err));
+        } else if (!body.job_uuid) {
+            /*
+             * For a period of time (between ZAPI-685 and ZAPI-???), VMAPI
+             * DeleteVm could return a "200 OK" with a response body that
+             * did not include a "job_uuid" -- because no destroy job was
+             * created.
+             */
+            log.info({body: body}, 'VMAPI DeleteVm response: no job_uuid, ' +
+                'VM was synchronously marked deleted');
+            cb();
+            return;
         }
 
-        log.info({ job: res.job_uuid }, 'destroy job dispatched');
+        log.info({ vm_uuid: body.vm_uuid, job: body.job_uuid },
+            'destroy job dispatched');
 
         var expected_errors = [ 'ResourceNotFoundError' ];
 
-        waitForJob.call(self, res.job_uuid, expected_errors,
+        waitForJob.call(self, body.job_uuid, expected_errors,
             function (suberr) {
             if (suberr) {
                 suberr = new mod_errors.DestroyFailedError(
-- 
2.21.0

