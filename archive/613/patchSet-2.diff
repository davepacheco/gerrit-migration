From f336b20197778f7728b6e0ced14cf9f1c81dd7e3 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Thu, 6 Oct 2016 14:04:59 -0700
Subject: [PATCH] joyent/node-mooremachine#12 want assert in S.on if we've
 already left the state

---
 lib/fsm.js | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/lib/fsm.js b/lib/fsm.js
index 65d519c..9980973 100644
--- a/lib/fsm.js
+++ b/lib/fsm.js
@@ -28,6 +28,8 @@ function FSMStateHandle(fsm, state, link) {
 }
 
 FSMStateHandle.prototype.validTransitions = function (states) {
+	if (this.fsh_validTransitions !== undefined)
+		throw (new Error('FSM validTransitions already set'));
 	assert.arrayOfString(states, 'states');
 	this.fsh_validTransitions = states;
 };
@@ -76,29 +78,54 @@ FSMStateHandle.prototype.disconnect = function () {
 };
 
 FSMStateHandle.prototype.on = function (obj, evt, cb) {
+	if (!this.fsh_valid) {
+		throw (new Error('FSM attempted to set up handler in state ' +
+		    this.fsh_state + ' but already called gotoState() to ' +
+		    'enter state ' + this.fsh_nextState));
+	}
 	obj.on(evt, cb);
 	this.fsh_listeners.push([obj, evt, cb]);
 };
 
 FSMStateHandle.prototype.interval = function (interval, cb) {
+	if (!this.fsh_valid) {
+		throw (new Error('FSM attempted to set up interval in state ' +
+		    this.fsh_state + ' but already called gotoState() to ' +
+		    'enter state ' + this.fsh_nextState));
+	}
 	var timer = setInterval(cb, interval);
 	this.fsh_intervals.push(timer);
 	return (timer);
 };
 
 FSMStateHandle.prototype.timeout = function (timeout, cb) {
+	if (!this.fsh_valid) {
+		throw (new Error('FSM attempted to set up timeout in state ' +
+		    this.fsh_state + ' but already called gotoState() to ' +
+		    'enter state ' + this.fsh_nextState));
+	}
 	var timer = setTimeout(cb, timeout);
 	this.fsh_timeouts.push(timer);
 	return (timer);
 };
 
 FSMStateHandle.prototype.immediate = function (cb) {
+	if (!this.fsh_valid) {
+		throw (new Error('FSM attempted to set up immediate in state ' +
+		    this.fsh_state + ' but already called gotoState() to ' +
+		    'enter state ' + this.fsh_nextState));
+	}
 	var timer = setImmediate(cb);
 	this.fsh_immediates.push(timer);
 	return (timer);
 };
 
 FSMStateHandle.prototype.callback = function (cb) {
+	if (!this.fsh_valid) {
+		throw (new Error('FSM attempted to set up callback in state ' +
+		    this.fsh_state + ' but already called gotoState() to ' +
+		    'enter state ' + this.fsh_nextState));
+	}
 	var s = this;
 	return (function () {
 		var args = arguments;
-- 
2.21.0

