From 2741cf3390575e8c54dd92ea07ef0706273974ea Mon Sep 17 00:00:00 2001
From: Jon Anderson <jon.anderson@joyent.com>
Date: Tue, 19 Mar 2019 10:45:56 -0400
Subject: [PATCH] MANTA-4133 Invalid content-type resulted in 500 response

---
 deps/jsstyle     |  2 +-
 lib/server.js    | 23 ++++++++++++++-----
 test/dir.test.js |  2 +-
 test/obj.test.js | 57 ++++++++++++++++++++++++++++++++++++++++++++++--
 4 files changed, 75 insertions(+), 9 deletions(-)

diff --git a/deps/jsstyle b/deps/jsstyle
index 52dc973..d75b7ca 160000
--- a/deps/jsstyle
+++ b/deps/jsstyle
@@ -1 +1 @@
-Subproject commit 52dc973cf64da11834eca7cf46ebce8518e3ee88
+Subproject commit d75b7ca8308be17c80e2b120f2a01d4a0c20d8a8
diff --git a/lib/server.js b/lib/server.js
index c23229d..de502da 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -40,9 +40,10 @@ require('./errors');
 ///--- Globals
 
 var JOBS_ROOT_RE = /^\/([a-zA-Z][a-zA-Z0-9_\.@%]+)\/jobs\/?$/;
-/* JSSTYLED */
+/* BEGIN JSSTYLED */
 var JOBS_LIVE_RE = /(state|status|name)=/i;
-
+var VALID_CONTENT_TYPE_RE = /\w+\/[-+.\w+]+/;
+/* END JSSTYLED */
 
 ///--- Helpers
 
@@ -192,9 +193,15 @@ function createServer(options, clients, name) {
     server.pre(restify.pre.sanitizePath());
     server.pre(function cleanupContentType(req, res, next) {
         var ct = req.headers['content-type'];
-        /* JSSTYLED */
-        if (ct && !/.*\/.*/.test(ct))
-            req.headers['content-type'] = mime.lookup(ct);
+        /*
+         * MANTA-4133
+         * content-type must have a type, '/' and sub-type
+         * https://www.w3.org/Protocols/rfc1341/4_Content-Type.html
+         */
+        if (ct && !VALID_CONTENT_TYPE_RE.test(ct)) {
+            sendBadRequestStatus(req, res, next);
+        }
+
         next();
     });
 
@@ -498,6 +505,12 @@ function forbiddenHandler(req, res, next) {
     next(false);
 }
 
+function sendBadRequestStatus(req, res, next) {
+    req.log.debug('Bad request.');
+    res.send(400);
+    next(false);
+}
+
 
 
 /*
diff --git a/test/dir.test.js b/test/dir.test.js
index 1545716..7e4534b 100644
--- a/test/dir.test.js
+++ b/test/dir.test.js
@@ -141,7 +141,7 @@ test('mkdir, chattr: content-type (ignore)', function (t) {
     var k = this.key;
     var opts = {
         headers: {
-            'content-type': 'jpg'
+            'content-type': 'image/jpg'
         }
     };
     var self = this;
diff --git a/test/obj.test.js b/test/obj.test.js
index c4863a1..0bb4d0c 100644
--- a/test/obj.test.js
+++ b/test/obj.test.js
@@ -61,6 +61,7 @@ before(function (cb) {
     this.root = '/' + this.client.user + '/stor';
     this.dir = this.root + '/' + uuid.v4();
     this.key = this.dir + '/' + uuid.v4();
+    this.stream = new MemoryStream();
     this.putObject = function putObject(t, opts, _cb) {
         if (typeof (opts) === 'function') {
             _cb = opts;
@@ -321,7 +322,7 @@ test('chattr: m- headers', function (t) {
 test('chattr: content-type', function (t) {
     var opts = {
         headers: {
-            'content-type': 'jpg'
+            'content-type': 'image/jpg'
         }
     };
     var self = this;
@@ -336,7 +337,7 @@ test('chattr: content-type', function (t) {
                 t.ok(info);
                 if (info) {
                     var h = info.headers || {};
-                    t.equal(h['content-type'], 'image/jpeg');
+                    t.equal(h['content-type'], 'image/jpg');
                 }
                 t.end();
             });
@@ -345,6 +346,7 @@ test('chattr: content-type', function (t) {
 });
 
 
+
 test('chattr: durability-level (not ok)', function (t) {
     var opts = {
         headers: {
@@ -1058,3 +1060,54 @@ test('put timeout', function (t) {
         stream.write(TEXT.substr(0, 1));
     });
 });
+
+
+test('MANTA-4133 (malformed content-type)', function (t) {
+    var opts = {
+        headers: {
+            'content-type': '/*'
+        }
+    };
+
+    this.client.put(this.key, this.stream, opts, function (err, res) {
+        t.ok(err);
+        t.ok(res);
+        t.equal(err.name, 'BadRequestError');
+        t.end();
+    });
+});
+
+
+test('MANTA-4133 (malformed content-type)', function (t) {
+    var opts = {
+        headers: {
+            'content-type': 'argle/'
+        }
+    };
+
+    this.client.put(this.key, this.stream, opts, function (err, res) {
+        t.ok(err);
+        t.ok(res);
+        t.equal(err.name, 'BadRequestError');
+        t.end();
+    });
+});
+
+
+test('MANTA-4133 (malformed utf-8 content-type)', function (t) {
+    var encoded = '%EC%95%88%EB%85%95%ED%95%98%EC%84%B8%EC%9A%94';
+    var ct_utf8 = unescape(encoded);
+
+    var opts = {
+        headers: {
+            'content-type': ct_utf8
+        }
+    };
+
+    this.client.put(this.key, this.stream, opts, function (err, res) {
+        t.ok(err);
+        t.ok(res);
+        t.equal(err.name, 'BadRequestError');
+        t.end();
+    });
+});
-- 
2.21.0

