{"project":"joyent/manta-remora","branch":"master","id":"If336205f37ef90f28adf143eab3b769a337929b3","number":"6744","subject":"MANTA-4442 Rebalancer Agent: Worker threads should load their assignments in to memory themselves Reviewed by: Rui Loura \u003crui.loura@joyent.com\u003e Approved by: Rui Loura \u003crui.loura@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/6744","commitMessage":"MANTA-4442 Rebalancer Agent: Worker threads should load their assignments in to memory themselves\nReviewed by: Rui Loura \u003crui.loura@joyent.com\u003e\nApproved by: Rui Loura \u003crui.loura@joyent.com\u003e\n","createdOn":1564775518,"lastUpdated":1565396841,"open":false,"status":"MERGED","comments":[{"timestamp":1564775518,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1564790575,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1565209281,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1565211514,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1565215208,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)\n\nThis looks good.\n\nI\u0027ve found that using expect() instead of unwrap() really helps debugging issues.  You might want to consider doing the same."},{"timestamp":1565231527,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1565233441,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1565233920,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1565268018,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1565383349,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1565396832,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1565396841,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"5","revision":"f336205f37ef90f28adf143eab3b769a337929b3","parents":["199bb7cbf4b88196cd6dd63f7da4f11fbba40735"],"ref":"refs/changes/44/6744/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1565396832,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565268018,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565383349,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1565396841,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":109,"deletions":-95}],"sizeInsertions":109,"sizeDeletions":-95},"patchSets":[{"number":"1","revision":"f692485f7956b27e111a2d87801e6227490f617d","parents":["199bb7cbf4b88196cd6dd63f7da4f11fbba40735"],"ref":"refs/changes/44/6744/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1564775518,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":39,"deletions":-34}],"sizeInsertions":39,"sizeDeletions":-34},{"number":"2","revision":"bc75be6596c1cad9a6a4870e8fca23fabd560e95","parents":["199bb7cbf4b88196cd6dd63f7da4f11fbba40735"],"ref":"refs/changes/44/6744/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1564790575,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":43,"deletions":-34}],"sizeInsertions":43,"sizeDeletions":-34},{"number":"3","revision":"7905055ecc203f62b529d8388d9d7a8e2b5517d5","parents":["199bb7cbf4b88196cd6dd63f7da4f11fbba40735"],"ref":"refs/changes/44/6744/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1565209281,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565215208,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"comments":[{"file":"src/agent.rs","line":125,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Yes, I am still using a lock for the tx portion of the channel despite the fact that it is cloneable.  The Rust compiler seems to require that everything have a mutex that crosses a catch unwind boundary.  Regardless, the research for that will be tracked in MANTA-4453."},{"file":"src/agent.rs","line":147,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I deliberately held off on doing anything tangible aside from logging the issue.  With the given implementation, the file is essentially skipped.  What we do about it though might be a topic for a greater discussion.  I think it could be reasonable to take whatever the desired action is here, but I\u0027m also fine with making it its own ticket/CR."},{"file":"src/agent.rs","line":212,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"We may want to open a bug to look into batching this insert."},{"file":"src/agent.rs","line":212,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Based on everything that I\u0027ve read on the rusqlite website (and sqlite in general), it looks like the way to do it is with the use of a transaction where these operations are all batched up in to one group and committed at the end.  It\u0027s a pretty small addition to what\u0027s here, so I\u0027m fine with adding it."},{"file":"src/agent.rs","line":628,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Can\u0027t we use DNS names directly here.  \n\nNot part of this CR but something I noticed."},{"file":"src/agent.rs","line":628,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Oh wow, we can.  That wasn\u0027t working for me in the past for some strange reason, but it does now.  I\u0027m going to just remove this code then."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":89,"deletions":-60}],"sizeInsertions":89,"sizeDeletions":-60},{"number":"4","revision":"4dfe6319b955661c2dc48b43100cadd7c5391424","parents":["199bb7cbf4b88196cd6dd63f7da4f11fbba40735"],"ref":"refs/changes/44/6744/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1565233441,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565268018,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565383349,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"comments":[{"file":"src/agent.rs","line":170,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I\u0027m not proud of this function.  Frankly, I feel like functions with bodies that are greater than a dozen or so lines are like fish and visitors after 3 days -- they begin to smell.  It\u0027s mostly monotonous boilerplate though, otherwise I\u0027d probably split it up."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":109,"deletions":-95}],"sizeInsertions":109,"sizeDeletions":-95},{"number":"5","revision":"f336205f37ef90f28adf143eab3b769a337929b3","parents":["199bb7cbf4b88196cd6dd63f7da4f11fbba40735"],"ref":"refs/changes/44/6744/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1565396832,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565268018,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565383349,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1565396841,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":109,"deletions":-95}],"sizeInsertions":109,"sizeDeletions":-95}],"allReviewers":[{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}