{"project":"joyent/node-triton","branch":"master","id":"I76759e547e67d0c45970bb881f90ae9a82912c77","number":"1171","subject":"joyent/node-triton#3 triton ssh command not aware of \"ubuntu\" login for ubuntu-certified images","owner":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"url":"https://cr.joyent.us/1171","commitMessage":"joyent/node-triton#3 triton ssh command not aware of \"ubuntu\" login for ubuntu-certified images\n","createdOn":1482442115,"lastUpdated":1483664632,"open":false,"status":"MERGED","comments":[{"timestamp":1482442115,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Uploaded patch set 1."},{"timestamp":1482442388,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1482454415,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483561329,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(8 comments)\n\nThanks for working on this!"},{"timestamp":1483586055,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Patch Set 1:\n\n(8 comments)"},{"timestamp":1483586080,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Uploaded patch set 2."},{"timestamp":1483586114,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483653799,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(7 comments)"},{"timestamp":1483662286,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Patch Set 2:\n\n(7 comments)\n\nThanks for the good feedback!"},{"timestamp":1483662298,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Uploaded patch set 3."},{"timestamp":1483662337,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483662852,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1483663065,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Uploaded patch set 4."},{"timestamp":1483663086,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1483663161,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483664618,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nworks for me:\n\n```\n$ triton ssh trent-docker112\nWelcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-45-generic x86_64)\nCertified Ubuntu Cloud Image\n...\nubuntu@trent-docker112:~$\n```\n\nLovely."},{"timestamp":1483664628,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nThanks!"},{"timestamp":1483664632,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"4","revision":"76759e547e67d0c45970bb881f90ae9a82912c77","parents":["04cc61ee1ddbaf4f229ee36450ec21b486154d6e"],"ref":"refs/changes/71/1171/4","uploader":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"createdOn":1483663065,"author":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483663161,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483664618,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483664618,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1483664632,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/do_instance/do_ssh.js","type":"MODIFIED","insertions":62,"deletions":-25},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":71,"sizeDeletions":-31},"patchSets":[{"number":"1","revision":"6699fcbb4442e7f21c3b11da078032343aa9d930","parents":["3a369e4bb834d0e65a4a030e21c7f9dc9481a7d9"],"ref":"refs/changes/71/1171/1","uploader":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"createdOn":1482442115,"author":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1482454415,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/do_instance/do_ssh.js","line":60,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can we inline that _opts, please?  E.g.:\n\n    cli.tritonapi.getImage({\n        name: inst.image,\n        useCache: true\n    }, function (getImageErr, image) {"},{"file":"lib/do_instance/do_ssh.js","line":60,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":67,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Actually if \"user@\" was parsed out above (around line 36), then that one should win. Also, in that case it would be nice if `getImage` was not called at all. Given that we are three levels of callback deep here, it would be good to refactor this using vasync.pipeline. Then, one of hte steps in that pipeline could be \"getTheImage\" (or whatever name) that only gets it if necessary (i.e. if an explicit user wasn\u0027t already specified)."},{"file":"lib/do_instance/do_ssh.js","line":67,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"I have completed this, and to my eye the new code looks much better.\n\nHowever I am new to node.js, so I would definitely appreciate feedback (especially nits)"},{"file":"lib/do_instance/do_ssh.js","line":76,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"While I\u0027m doing nits :)  could we drop this empty comment block line, please?"},{"file":"lib/do_instance/do_ssh.js","line":76,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":129,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think the help output should get a paragraph describing how the user is determined from the tag, if on the image."},{"file":"lib/do_instance/do_ssh.js","line":129,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/tritonapi.js","line":367,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: add a period here please."},{"file":"lib/tritonapi.js","line":367,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/tritonapi.js","line":377,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Make this required. It is an internal function so there isn\u0027t a burden on users of the lib. \n\nOr if we want it optional, then I\u0027d prefer a `function (opts, cb)` call signature with `opts.key` and `opts.ttl`, and then the comment should state the default value."},{"file":"lib/tritonapi.js","line":377,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/tritonapi.js","line":387,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Add a period for a complete sentence please."},{"file":"lib/tritonapi.js","line":387,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/tritonapi.js","line":532,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"I think this should be changed to cache each image separately (for this function).\n\nThoughts?"},{"file":"lib/tritonapi.js","line":532,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Dillon,\nTo avoid having to parse a potentially large JSON file, you mean? It would mean having to change the caller if _cachePutJson to write out all the separate files. It is worth discussing the trade-offs if you like."},{"file":"lib/tritonapi.js","line":532,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Disregard please"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/do_instance/do_ssh.js","type":"MODIFIED","insertions":46,"deletions":-32},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":10,"deletions":-5}],"sizeInsertions":58,"sizeDeletions":-37},{"number":"2","revision":"0e492e801977c2d0841be3e999cd842179d799b1","parents":["04cc61ee1ddbaf4f229ee36450ec21b486154d6e"],"ref":"refs/changes/71/1171/2","uploader":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"createdOn":1483586080,"author":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483586114,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/do_instance/do_ssh.js","line":43,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could drop these, see usage of \u0027arg\u0027 below."},{"file":"lib/do_instance/do_ssh.js","line":43,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":55,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This can be changed to:\n\n```\n    vasync.pipeline({arg: {cli: cli}, funcs: [\n        common.cliSetupTritonApi,\n```\n\nE.g. see lib/do_image/do_create.js for an example."},{"file":"lib/do_instance/do_ssh.js","line":55,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":57,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"If we use \u0027arg\u0027 here, then we can use that for state in which vasync.pipeline.\n\nThen we can use \u0027inst\u0027 instead of \u0027inst_\u0027 and:\n\n    arg.inst \u003d inst;\n    arg.ip \u003d inst.primaryIp;\n\nThen use \u0027arg.inst\u0027 and \u0027arg.ip\u0027 below in the other pipeline funcs."},{"file":"lib/do_instance/do_ssh.js","line":57,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":77,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Style nit: don\u0027t have the newline before the \u0027{\u0027, please."},{"file":"lib/do_instance/do_ssh.js","line":77,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":78,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Need a \u0027return;\u0027 here to not also run the following code in this function, which would blow up (next would be called twice and vasync guards against that)."},{"file":"lib/do_instance/do_ssh.js","line":78,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"},{"file":"lib/do_instance/do_ssh.js","line":89,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps a comment here that image.tags.default_user is a tag commonly used on Joyent\u0027s \"ubuntu-certified\" images, but it isn\u0027t really documented in any spec (at least that I know of)."},{"file":"lib/do_instance/do_ssh.js","line":89,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done but I didn\u0027t want to say anything about it being undocumented in case that changes before the code does."},{"file":"lib/do_instance/do_ssh.js","line":140,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Style nit: no newline before the closing \u0027);\u0027."},{"file":"lib/do_instance/do_ssh.js","line":140,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/do_instance/do_ssh.js","type":"MODIFIED","insertions":69,"deletions":-20},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":78,"sizeDeletions":-26},{"number":"3","revision":"f4f59f486c8f05d2317bb029665984dd18c0765f","parents":["04cc61ee1ddbaf4f229ee36450ec21b486154d6e"],"ref":"refs/changes/71/1171/3","uploader":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"createdOn":1483662298,"author":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483662337,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/do_instance/do_ssh.js","line":49,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This whole function can still be simplified to just this:\n\n```\n        common.cliSetupTritonApi\n```\n\nThat function is intentionally written to be used in a vasync.pipeline like that."},{"file":"lib/do_instance/do_ssh.js","line":49,"reviewer":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/do_instance/do_ssh.js","type":"MODIFIED","insertions":71,"deletions":-25},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":80,"sizeDeletions":-31},{"number":"4","revision":"76759e547e67d0c45970bb881f90ae9a82912c77","parents":["04cc61ee1ddbaf4f229ee36450ec21b486154d6e"],"ref":"refs/changes/71/1171/4","uploader":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"createdOn":1483663065,"author":{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483663161,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483664618,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483664618,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1483664632,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/do_instance/do_ssh.js","type":"MODIFIED","insertions":62,"deletions":-25},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":71,"sizeDeletions":-31}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Christopher Horrell","email":"christopher@horrell.ca","username":"chorrell"},{"name":"Dillon Amburgey","email":"dillona@dillona.com","username":"dillona"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}