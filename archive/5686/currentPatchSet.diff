From 7d0d32473fe26cfb30354e9596010d7ef400f0ab Mon Sep 17 00:00:00 2001
From: dyep <dyep49@gmail.com>
Date: Mon, 4 Mar 2019 15:00:54 -0800
Subject: [PATCH] TRITON-1268 PAPI should index flexible_disk

---
 etc/config.test.json         |  4 ++--
 package.json                 |  2 +-
 sapi_manifests/papi/template |  4 ++--
 test/api.test.js             | 13 +++++++++++++
 4 files changed, 18 insertions(+), 5 deletions(-)

diff --git a/etc/config.test.json b/etc/config.test.json
index d2db780..0605b45 100644
--- a/etc/config.test.json
+++ b/etc/config.test.json
@@ -3,7 +3,7 @@
     "logLevel": "info",
     "moray": {
         "url": "http://10.99.99.17:2020",
-        "version": 6
+        "version": 8
     },
     "ufds_admin_uuid": "930896af-bf8c-48d4-885c-6573a94b1853",
     "first_boot": true,
@@ -157,7 +157,7 @@
         },
         "flexible_disk": {
             "type": "boolean",
-            "index": false
+            "index": true
         },
         "disks": {
             "type": "[object]",
diff --git a/package.json b/package.json
index c0eddc4..2d80cd4 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdc-papi",
   "description": "Packages API",
-  "version": "7.2.0",
+  "version": "7.2.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "repository": {
diff --git a/sapi_manifests/papi/template b/sapi_manifests/papi/template
index 5df61d6..e04c043 100644
--- a/sapi_manifests/papi/template
+++ b/sapi_manifests/papi/template
@@ -6,7 +6,7 @@
         "cueballOptions": {
             "resolvers": [ "{{{BINDER_SERVICE}}}" ]
         },
-        "version": 7
+        "version": 8
     },
     "ufds_admin_uuid": "{{{ufds_admin_uuid}}}",
     "first_boot": {{{SERVICE_IS_FIRST_BOOT}}},
@@ -166,7 +166,7 @@
         },
         "flexible_disk": {
             "type": "boolean",
-            "index": false
+            "index": true
         },
         "disks": {
             "type": "[object]",
diff --git a/test/api.test.js b/test/api.test.js
index 8835837..1b6dccb 100644
--- a/test/api.test.js
+++ b/test/api.test.js
@@ -109,6 +109,7 @@ var packages = [ {
     active: true,
     brand: 'bhyve',
     cpu_cap: 300,
+    flexible_disk: true,
     max_lwps: 1000,
     max_physical_memory: 512,
     max_swap: 1024,
@@ -676,6 +677,18 @@ test('GET /packages (Search by name)', function (t) {
 
 
 
+test('GET /packages (Search by flexible_disk)', function (t) {
+    var query = '/packages?flexible_disk=true';
+
+    var testFilter = function (p) {
+        return p.flexible_disk === true;
+    };
+
+    searchAndCheckPkgs(t, query, testFilter);
+});
+
+
+
 test('GET /packages (Search by wildcard)', function (t) {
     var name = pkgName('');
     var query = '/packages?name=' + name + '*';
-- 
2.21.0

