{"project":"joyent/sdc-manta","branch":"master","id":"I4df0a8345f75336ba680755be5b6177a7277a8eb","number":"6145","subject":"MANTA-4008 add a core Prometheus service to Manta Reviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e Approved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e","owner":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"url":"https://cr.joyent.us/6145","commitMessage":"MANTA-4008 add a core Prometheus service to Manta\nReviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\nApproved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1555979687,"lastUpdated":1558548923,"open":false,"status":"MERGED","comments":[{"timestamp":1555979687,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 1."},{"timestamp":1555979737,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1555979961,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 1:\n\nSee ticket for testing notes. The first comment on the ticket contains notes specific to the code written here."},{"timestamp":1557948190,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1558388066,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 2."},{"timestamp":1558388101,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 2:\n\n(6 comments)\n\nTesting notes for PS2: I ran through the procedure in the first comment on the ticket, and saw the same results."},{"timestamp":1558388113,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558477072,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(1 comment)\n\nLooks good. I\u0027m just going to look at other CRs for services that we\u0027ve added recently to see if I\u0027m forgetting anything."},{"timestamp":1558477457,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(3 comments)\n\nJust a couple more questions, otherwise this looks good to me."},{"timestamp":1558478249,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1558536645,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Code-Review+1\n\n(3 comments)\n\nThanks!"},{"timestamp":1558548750,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1558548916,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1558548923,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Isaac Davis"}],"currentPatchSet":{"number":"3","revision":"f94a3db3085df4cb23db3cc908ff637cc9d9bebf","parents":["121120c002ada3654b3321667b153041869aab73"],"ref":"refs/changes/45/6145/3","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1558548916,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558388113,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558536645,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558548750,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1558548923,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"config/services/prometheus/service.json","type":"ADDED","insertions":15,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":121,"deletions":-1},{"file":"lib/layout.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"lib/services.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":0},{"file":"manifests/applications/manta/dns_client/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":8,"deletions":0},{"file":"test/tst.services.js","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":171,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"a6d0f42894662539bbbcd102f1de0bbc77f31933","parents":["121120c002ada3654b3321667b153041869aab73"],"ref":"refs/changes/45/6145/1","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1555979687,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1555979737,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"config/services/prometheus/service.json","line":8,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"SAPI doesn\u0027t already have a template variable for getting the application name (sdc/manta), does it?"},{"file":"config/services/prometheus/service.json","line":8,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Correct; it does not. Only the application uuid, to my knowledge."},{"file":"lib/deploy.js","line":8,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"nit: I think we drop this comma nowadays"},{"file":"lib/deploy.js","line":8,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Fixed, here and in the other updated files."},{"file":"lib/deploy.js","line":1130,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Since the \u0027Prometheus\u0027 string isn\u0027t load bearing in this function, do you think we should make this more generic by removing/replacing \u0027Prometheus?\u0027 If we did that we could add a comment that currently Prometheus is the only service that currently supports doing this operation.\n\nThis would be nice in case something else needs to do this sort of routine in the future. If you think this is a good idea and doesn\u0027t muddy the waters too much we can make a similar change to the \u0027configurePrometheusAllowTransfer\u0027 name in the async.waterfall() list above."},{"file":"lib/deploy.js","line":1130,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"lib/deploy.js","line":1145,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Does this work in RAN deployments?"},{"file":"lib/deploy.js","line":1145,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Good catch -- fixed."},{"file":"lib/deploy.js","line":1182,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"For this and the next log statement it may be helpful to provide either/both the IP and instance uuid in case we need to debug a deployment with multiple Prometheus instances."},{"file":"lib/deploy.js","line":1182,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"manifests/applications/manta/dns_client/template","line":1,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Forgive my ignorance, but what is this file used for (in Manta in general)? Does it somehow get used to populate resolv.conf in Manta zones?"},{"file":"manifests/applications/manta/dns_client/template","line":1,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Yup, this file becomes resolv.conf in all Manta zones."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"config/services/prometheus/service.json","type":"ADDED","insertions":15,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":101,"deletions":-1},{"file":"lib/layout.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"lib/services.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":0},{"file":"manifests/applications/manta/dns_client/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/manta/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":8,"deletions":0},{"file":"test/tst.services.js","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":153,"sizeDeletions":-8},{"number":"2","revision":"4df0a8345f75336ba680755be5b6177a7277a8eb","parents":["121120c002ada3654b3321667b153041869aab73"],"ref":"refs/changes/45/6145/2","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1558388066,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558388113,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558536645,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558548750,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"config/services/prometheus/service.json","line":3,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This is okay with other people, right? Because we have the firewall enabled?"},{"file":"config/services/prometheus/service.json","line":3,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"I believe so -- some of us had a meeting back in September where we discussed this:\nhttps://docs.google.com/document/d/1qCzSwmSCJWc39y9r5fsvQHUwPwT_Qu5YmP0HyVUf1Xs/edit#"},{"file":"config/services/prometheus/service.json","line":4,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do you think this is enough? I think we have some pretty beefy Prometheus servers in prod right now. I suppose we can change this after running \u0027manta-init\u0027 or whatever if we need to, but it\u0027s additional operational overhead."},{"file":"config/services/prometheus/service.json","line":4,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"This was totally just a placeholder until we figured out how much ram Prometheus instances will need. I can file a ticket for investigation, or can update it here to whatever you think is best."},{"file":"config/services/prometheus/service.json","line":4,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Okay, sounds good. I think a placeholder ticket would be best."},{"file":"lib/deploy.js","line":741,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Now that I\u0027m thinking about networking things, what if we undeploy one instance and deploy another somewhere else? Would that leave garbage in the CNS config? This is probably out of scope for this review, sorry. Food for thought maybe."},{"file":"lib/deploy.js","line":741,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Yeah, it would leave the old admin IP in the CNS config. This is also an issue when prometheus is deployed using sdcadm.\n\nI\u0027m not sure of the best way to clean this up when an instance is destroyed -- but it\u0027s on my radar.\n\nI remember discussing this with someone (maybe alexw?) earlier and concluding that it will be rare to delete prometheus instances in production, so this isn\u0027t a pressing issue, and cleanup can be done by hand as part of a CM if necessary. With that said, there should eventually be a better way.\n\nOnce the manta prometheus service is sharded, there will be a CLI tool for changing the sharding config, and maybe it can handle cleaning up any old IPs."},{"file":"lib/deploy.js","line":741,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Okay, great. Thanks."},{"file":"package.json","line":4,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"FWIW I don\u0027t know that the version field is useful for this component."},{"file":"package.json","line":4,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Yeah, looks like it hardly ever gets updated. What do you think is best to do here?"},{"file":"package.json","line":4,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think we can just keep the 0.0.4 change. It\u0027s just a no-op."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"config/services/prometheus/service.json","type":"ADDED","insertions":15,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":121,"deletions":-1},{"file":"lib/layout.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"lib/services.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":0},{"file":"manifests/applications/manta/dns_client/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":8,"deletions":0},{"file":"test/tst.services.js","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":171,"sizeDeletions":-8},{"number":"3","revision":"f94a3db3085df4cb23db3cc908ff637cc9d9bebf","parents":["121120c002ada3654b3321667b153041869aab73"],"ref":"refs/changes/45/6145/3","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1558548916,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558388113,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558536645,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558548750,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1558548923,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"config/services/prometheus/service.json","type":"ADDED","insertions":15,"deletions":0},{"file":"docs/man/man1/manta-adm.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/deploy.js","type":"MODIFIED","insertions":121,"deletions":-1},{"file":"lib/layout.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"lib/services.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"man/man1/manta-adm.1","type":"MODIFIED","insertions":3,"deletions":0},{"file":"manifests/applications/manta/dns_client/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/tst.layout.js.out","type":"MODIFIED","insertions":8,"deletions":0},{"file":"test/tst.services.js","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":171,"sizeDeletions":-8}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}]}