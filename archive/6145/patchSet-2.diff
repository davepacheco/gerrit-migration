commit 4df0a8345f75336ba680755be5b6177a7277a8eb
Author: Isaac Davis <isaac.davis@joyent.com>
Date:   2019-05-20T20:28:40+00:00 (5 months ago)
    
    MANTA-4008 add a core Prometheus service to Manta

diff --git a/config/services/prometheus/service.json b/config/services/prometheus/service.json
new file mode 100644
index 0000000..fe492e6
--- /dev/null
+++ b/config/services/prometheus/service.json
@@ -0,0 +1,15 @@
+{
+	"params": {
+		"networks": [ "external", "manta", "admin"],
+		"ram": 1024,
+		"firewall_enabled": true
+	},
+	"metadata": {
+		"is_manta_service": true,
+		"OVERRIDE_RESOLVERS": [
+			{
+				"host": "127.0.0.1"
+			}
+		]
+	}
+}
diff --git a/docs/man/man1/manta-adm.md b/docs/man/man1/manta-adm.md
index 9bfdfa3..65bced0 100644
--- a/docs/man/man1/manta-adm.md
+++ b/docs/man/man1/manta-adm.md
@@ -106,6 +106,9 @@ Services that are part of the Manta application include:
 **pgstatsmon**
   Monitoring system for Postgres
 
+**prometheus**
+  Time-series database that aggregates Manta and Triton metrics
+
 **reshard**
   Automated resharding system for Manta
 
diff --git a/lib/deploy.js b/lib/deploy.js
index c9acfed..59bbc83 100644
--- a/lib/deploy.js
+++ b/lib/deploy.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -15,6 +15,7 @@
 var assert = require('assert-plus');
 var async = require('async');
 var fs = require('fs');
+var netconfig = require('triton-netconfig');
 var node_uuid = require('node-uuid');
 var path = require('path');
 var util = require('util');
@@ -553,6 +554,18 @@ Deployer.prototype.deploy = function (options, svcname, callback)
 					return (cb(null));
 				    });
 			});
+		},
+		function configureAllowTransfer(cb) {
+			/*
+			 * Adds the new instance's admin IP to the cns service's
+			 * allow_transfer list. Currently, this is only
+			 * necessary for prometheus instances.
+			 */
+			if (self.svcname !== 'prometheus') {
+				cb(null);
+				return;
+			}
+			self.addCnsAllowTransfer(cb);
 		}
 	], function (err) {
 		callback(err, self.zone_uuid);
@@ -659,6 +672,113 @@ Deployer.prototype.reprovision = function (instance, image_uuid, callback)
 	this.SAPI.reprovisionInstance(instance, image_uuid, callback);
 };
 
+/*
+ * Adds a vm's admin IP to the CNS service's list of IPs that are allowed to
+ * issue AXFR/IXFR requests, if the IP is not already in the list. Currently
+ * only used for prometheus instances.
+ */
+Deployer.prototype.addCnsAllowTransfer = function addCnsAllowTransfer(cb)
+{
+	var self = this;
+
+	assert.object(self.SAPI, 'self.SAPI');
+	assert.object(self.VMAPI, 'self.VMAPI');
+	assert.object(self.log, 'self.log');
+	assert.object(self.instance, 'self.instance');
+
+	var sapi = self.SAPI;
+	var vmapi = self.VMAPI;
+	var log = self.log;
+	var inst = self.instance;
+
+	function getVmIp(ctx, next) {
+		var params = { 'uuid': inst.uuid };
+		vmapi.getVm(params, function (err, vm) {
+			if (err) {
+				next(new VError(err, 'failed to get instance ' +
+				    '"%s" of service "%s" from VMAPI',
+				    inst.uuid, self.svcname));
+				return;
+			}
+			/*
+			 * Get the admin IP of the vm
+			 */
+			var ip;
+			for (var i = 0; i < vm.nics.length; i++) {
+				var nic = vm.nics[i];
+				if (netconfig.isNicAdmin(nic)) {
+					ip = nic.ip;
+					break;
+				}
+			}
+			if (ip === undefined) {
+				next(new VError('instance "%s" of service ' +
+				    '"%s" has no admin ip', inst.uuid,
+				    self.svcname));
+				return;
+			}
+			ctx.ip = ip;
+			next();
+		});
+	}
+
+	function getCnsSvc(ctx, next) {
+		sapi.listServices({
+			name: 'cns',
+			application: self.sdc_app.uuid
+		}, function gotCnsSvc(err, svcs) {
+			if (err) {
+				next(err);
+				return;
+			}
+			assert.equal(svcs.length, 1, 'svcs.length === 1');
+			ctx.cnsSvc = svcs[0];
+			next();
+		});
+	}
+
+	/*
+	 * Update the cns service with the vm's admin IP, if necessary.
+	 */
+	function updateCnsSvc(ctx, next) {
+		var existingIps = ctx.cnsSvc.metadata.allow_transfer;
+		if (existingIps.indexOf(ctx.ip) > -1) {
+			log.info({
+				svcname: self.svcname,
+				inst: inst.uuid,
+				ip: ctx.ip
+			}, 'IP already in CNS allow_transfer list; not adding');
+			next();
+			return;
+		}
+		existingIps.push(ctx.ip);
+		sapi.updateService(ctx.cnsSvc.uuid, {
+			metadata: {
+				allow_transfer: existingIps
+			}
+		}, function updatedCnsSvc(err, _) {
+			if (err) {
+				next(err);
+				return;
+			}
+			log.info({
+				svcname: self.svcname,
+				inst: inst.uuid,
+				ip: ctx.ip
+			}, 'Added admin IP to CNS allow_transfer list');
+			next();
+		});
+	}
+
+	vasync.pipeline({
+		arg: {}, // ctx
+		funcs: [
+			getVmIp,
+			getCnsSvc,
+			updateCnsSvc
+		]
+	}, cb);
+};
 
 // -- User management
 
diff --git a/lib/layout.js b/lib/layout.js
index e6c2ce2..5d62e8e 100644
--- a/lib/layout.js
+++ b/lib/layout.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -96,7 +96,12 @@ var ML_SERVICES_EXACT = {
 	 * "garbage-collector" is an optional component for processing delete
 	 * records in Postgres.
 	 */
-	'garbage-collector': 0
+	'garbage-collector': 0,
+
+	/*
+	 * "prometheus" is an optional component for aggregating metrics.
+	 */
+	'prometheus': 0
 };
 
 /*
diff --git a/lib/services.js b/lib/services.js
index 07b69ef..e965e92 100644
--- a/lib/services.js
+++ b/lib/services.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -53,7 +53,8 @@ var mSvcNames = [
     'marlin',
     'reshard',
     'pgstatsmon',
-    'garbage-collector'
+    'garbage-collector',
+    'prometheus'
 ];
 
 /*
@@ -78,6 +79,7 @@ var mSvcConfigs = {
     'reshard':		{ 'oneach': true,  'probes': true,  'sharded': false },
     'pgstatsmon':	{ 'oneach': true,  'probes': true,  'sharded': false },
     'garbage-collector': { 'oneach': true, 'probes': true,  'sharded': false },
+    'prometheus':	{ 'oneach': true,  'probes': true,  'sharded': false },
     'marlin':		{ 'oneach': false, 'probes': false, 'sharded': false }
 };
 
diff --git a/man/man1/manta-adm.1 b/man/man1/manta-adm.1
index 805b793..43968fb 100644
--- a/man/man1/manta-adm.1
+++ b/man/man1/manta-adm.1
@@ -102,6 +102,9 @@ PostgreSQL databases used for storing object and job metadata
 \fBpgstatsmon\fP
 Monitoring system for Postgres
 .TP
+\fBprometheus\fP
+Time-series database that aggregates Manta and Triton metrics
+.TP
 \fBreshard\fP
 Automated resharding system for Manta
 .TP
diff --git a/manifests/applications/manta/dns_client/template b/manifests/applications/manta/dns_client/template
index 4bd786e..8d60a97 100644
--- a/manifests/applications/manta/dns_client/template
+++ b/manifests/applications/manta/dns_client/template
@@ -1,7 +1,12 @@
 domain {{REGION}}.{{DNS_DOMAIN}}
+{{#OVERRIDE_RESOLVERS}}
+nameserver {{host}}
+{{/OVERRIDE_RESOLVERS}}
+{{^OVERRIDE_RESOLVERS}}
 {{#ZK_SERVERS}}
 nameserver {{host}}
 {{/ZK_SERVERS}}
 {{#SDC_NAMESERVERS}}
 nameserver {{host}}
 {{/SDC_NAMESERVERS}}
+{{/OVERRIDE_RESOLVERS}}
diff --git a/package.json b/package.json
index c36a67a..078e56e 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "manta-deployment",
     "description": "Manta deployment configuration",
-    "version": "0.0.3",
+    "version": "0.0.4",
     "author": "Joyent (joyent.com)",
     "license": "MPL-2.0",
     "private": true,
@@ -28,6 +28,7 @@
         "sdc-clients": "git+https://github.com/joyent/node-sdc-clients.git#42ea07d3ca",
         "sprintf-js": "0.0.7",
         "tab": "0.1.0",
+        "triton-netconfig": "1.4.0",
         "urclient": "1.0.0",
         "vasync": "1.6.3",
         "verror": "1.10.0",
diff --git a/test/tst.layout.js.out b/test/tst.layout.js.out
index 60c01e7..5bdf498 100644
--- a/test/tst.layout.js.out
+++ b/test/tst.layout.js.out
@@ -231,6 +231,7 @@ summary:
      reshard              -                 
      pgstatsmon           -                 
      garbage-collector     -                 
+     prometheus           -                 
      postgres             1                3
      postgres             2                3
      postgres             3                3
@@ -614,6 +615,7 @@ summary:
      reshard              -                 
      pgstatsmon           -                 
      garbage-collector     -                 
+     prometheus           -                 
      postgres             1                3
      moray                1                3
 --------------------------------------------------
@@ -726,6 +728,7 @@ summary:
      reshard              -                 
      pgstatsmon           -                 
      garbage-collector     -                 
+     prometheus           -                 
      postgres             1                3
      postgres             2                3
      postgres             3                3
@@ -1043,6 +1046,7 @@ summary:
      reshard              -                 
      pgstatsmon           -                 
      garbage-collector     -                 
+     prometheus           -                 
      postgres             1                3
      postgres             2                3
      moray                1                3
@@ -1528,6 +1532,7 @@ summary:
      reshard              -                 
      pgstatsmon           -                 
      garbage-collector     -                 
+     prometheus           -                 
      postgres             1                3
      postgres             2                3
      postgres             3                3
@@ -1742,6 +1747,7 @@ summary:
      reshard              -                                                   
      pgstatsmon           -                                                   
      garbage-collector     -                                                   
+     prometheus           -                                                   
      postgres             1                1                1                1
      moray                1                1                1                1
 --------------------------------------------------
@@ -1969,6 +1975,7 @@ summary:
      reshard              -                                                   
      pgstatsmon           -                                                   
      garbage-collector     -                                                   
+     prometheus           -                                                   
      postgres             1                1                1                1
      postgres             2                1                1                1
      moray                1                1                1                1
@@ -2437,6 +2444,7 @@ summary:
      reshard              -                                                   
      pgstatsmon           -                                                   
      garbage-collector     -                                                   
+     prometheus           -                                                   
      postgres             1                1                1                1
      postgres             2                1                1                1
      postgres             3                1                1                1
diff --git a/test/tst.services.js b/test/tst.services.js
index 83fd2fe..12da351 100644
--- a/test/tst.services.js
+++ b/test/tst.services.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -40,7 +40,8 @@ var knownServices = [
     'marlin',
     'reshard',
     'pgstatsmon',
-    'garbage-collector'
+    'garbage-collector',
+    'prometheus'
 ];
 
 function main()
