{"project":"joyent/manta-muskie","branch":"master","id":"If055bb36389f4db0b2f88864aefc44280a87e669","number":"5080","subject":"MANTA-4028 support for global \"readers\" group Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/5080","commitMessage":"MANTA-4028 support for global \"readers\" group\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1542753924,"lastUpdated":1543619352,"open":false,"status":"MERGED","comments":[{"timestamp":1542753924,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1542753952,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543274092,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1543274136,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1543280991,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\nbuilt as 6df4fc24-f1d7-11e8-b917-2fee5895685f"},{"timestamp":1543353378,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1543431505,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1543431537,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543459884,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1543513321,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1543521884,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)"},{"timestamp":1543617335,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1543619296,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1543619352,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"4","revision":"392a06cae11fb692728a8b844a58fa401040abd7","parents":["d9337f555d1bb12b572651e6bd1af088f0cc6f60"],"ref":"refs/changes/80/5080/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1543619296,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543431537,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543521884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543617335,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1543619352,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":119,"deletions":-34}],"sizeInsertions":119,"sizeDeletions":-34},"patchSets":[{"number":"1","revision":"75aff4aeca6bf991413f03117ff52633fb1a1546","parents":["4d9be47aa0e74267e0211f566c07f6ddad566db6"],"ref":"refs/changes/80/5080/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1542753924,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542753952,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":47,"deletions":0}],"sizeInsertions":47,"sizeDeletions":0},{"number":"2","revision":"ec5821483c9a907e722db4d18f4ef5b92a0bf428","parents":["f610b0aab574106f921c0e2c40fe0df10790ede5"],"ref":"refs/changes/80/5080/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1543274092,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542753952,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/auth.js","line":777,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Where does this uuid come from? Probably deserves a comment."},{"file":"lib/auth.js","line":778,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there something that guarantees that the role won\u0027t be already used in the system?"},{"file":"lib/auth.js","line":932,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is the reason that we\u0027re copying this so that we don\u0027t potentially modify req.caller.*.defaultRoles? Probably worth a comment."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":47,"deletions":0}],"sizeInsertions":47,"sizeDeletions":0},{"number":"3","revision":"f055bb36389f4db0b2f88864aefc44280a87e669","parents":["d9337f555d1bb12b572651e6bd1af088f0cc6f60"],"ref":"refs/changes/80/5080/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1543431505,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543521884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543431537,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543617335,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"lib/auth.js","line":780,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This seems kind of unfortunate. Is there a way to make sure that we\u0027re not actually in this state? Is at least a leading underscore reserved by software? Is there a reason that we can\u0027t construct this role as part of system set up or some other start up / upgrade so it\u0027s not hardcoded?"},{"file":"lib/auth.js","line":780,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"No, we can\u0027t construct this role in any actual database, because we\u0027re making a different role for each owner here, and the role is on the caller not the owner. So it\u0027s impossible to get what we\u0027re constructing from the actual db.\n\nLeading underscores are not reserved -- we\u0027ve been through this with the _operator role for role-operators as well and decided there that since this functionality will only ever affect system operators, they\u0027re big enough kids to sort it out themselves.\n\nThe probability of a UUID collision is extraordinarily small, so that\u0027s not really a problem.\n\nAnd we\u0027ve done our best in the code below to deal with a role having a name collision with this one as well (we at least won\u0027t let them activate this one by name by accident). It shouldn\u0027t cause anything too catastrophic, but the results might be a little confusing."},{"file":"lib/auth.js","line":780,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK. I defer on this."},{"file":"lib/auth.js","line":858,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Shouldn\u0027t we still do a proper deep copy of these to deal with changes here ala a jsprim deepCopy? I get why you\u0027re not for req.caller, but it feels like this will end up being a bit brittle in the face of someone adding some object to caller.account or caller.roles."},{"file":"lib/auth.js","line":858,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"What object are they going to add to these? Roles is an index by uuid, where we\u0027re just setting one of them to a new object, and on account we\u0027re just setting one property, to a boolean. We\u0027re not making any other changes (and it is only changed things that matter here.)"},{"file":"lib/auth.js","line":858,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s just that things will be implicitly shallow copied that someone won\u0027t know about in the future. Ultimately I defer to you here, it just seemed like a weird hygiene thing which is why I pointed it out."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":119,"deletions":-34}],"sizeInsertions":119,"sizeDeletions":-34},{"number":"4","revision":"392a06cae11fb692728a8b844a58fa401040abd7","parents":["d9337f555d1bb12b572651e6bd1af088f0cc6f60"],"ref":"refs/changes/80/5080/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1543619296,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543521884,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1543619352,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543431537,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543617335,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":119,"deletions":-34}],"sizeInsertions":119,"sizeDeletions":-34}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}