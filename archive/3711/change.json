{"project":"joyent/illumos-joyent","branch":"master","id":"I84636c8082b9aee9413dca55149c8d17a373523e","number":"3711","subject":"OS-6812 implement RFD 118 interpretation of HCKSUM_INET_FULL_V4/6","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3711","commitMessage":"OS-6812 implement RFD 118 interpretation of HCKSUM_INET_FULL_V4/6\n","createdOn":1521831316,"lastUpdated":1522863496,"open":false,"status":"MERGED","comments":[{"timestamp":1521831316,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1521832180,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1521833116,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)\n\nAlso, I\u0027ll have at least one more rev of this CR. I want to update at least one of the drivers to advertise HCKSUM_INET_FULL_V4/6 (maybe qede)with this new, narrower interpretation of the capability. I wanted to get the upstack changes out for initial feedback."},{"timestamp":1521834021,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1521835042,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1521835520,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1521837296,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522158980,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522162173,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1522336306,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1522338141,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1522338344,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1522339136,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1522428794,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1522429447,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1522431672,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1522443539,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nTesting notes are in the ticket. I\u0027ve provided Robert with a platform build so he can also try it on a box with qede when he has a chance."},{"timestamp":1522862526,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1522863465,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1522863496,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"84636c8082b9aee9413dca55149c8d17a373523e","parents":["4ac08e240a8b70d239bb2fed6f0d1a09f8da3038"],"ref":"refs/changes/11/3711/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1522863465,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522338344,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522431672,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522862526,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1522863496,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man9e/mac.9e","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/inet/ip/ip_output.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/qede/qede_gld.c","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"usr/src/uts/common/sys/dlpi.h","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":40,"deletions":-3}],"sizeInsertions":84,"sizeDeletions":-24},"patchSets":[{"number":"1","revision":"8f04084c2428bf9cc1eb2ffd7b4fad65023d51fc","parents":["929399046cc464d1c38a4d4facf93476166a5662"],"ref":"refs/changes/11/3711/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1521831316,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1904,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Move these into the scopes where the checks are occurring?  \u0027off\u0027 could definitely be a const in those places too."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1904,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1922,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why add \u0027maclen\u0027 when eth_len contains the exact same value?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1922,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sorry, I completely overlooked that. Fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man9e/mac.9e","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/inet/ip/ip_output.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/sys/dlpi.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":42,"deletions":-4}],"sizeInsertions":75,"sizeDeletions":-15},{"number":"2","revision":"8bf33ee5761d0b0b9843d2f576c0f93350d05e64","parents":["929399046cc464d1c38a4d4facf93476166a5662"],"ref":"refs/changes/11/3711/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1521834021,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/man/man9e/mac.9e","line":551,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably also apply this to INET_PARTIAL."},{"file":"usr/src/man/man9e/mac.9e","line":551,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027m not sure I understand exactly what you mean here. We can discuss that next week after you\u0027re back."},{"file":"usr/src/man/man9e/mac.9e","line":551,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I have updated the RFD to include INET_PARTIAL and I\u0027ll fix the code throughout to handle the new interpretation."},{"file":"usr/src/uts/common/io/qede/qede_gld.c","line":2015,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"You can remove this comment now."},{"file":"usr/src/uts/common/io/qede/qede_gld.c","line":2015,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I thought it would be useful to keep the comment to help guide the future ICMP HW chksum work, which is why I changed the comment instead of simply deleting it. However, if you would prefer it to be removed, that is fine with me."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1881,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Where does the uint16_t come from here? Is this trying to account for the uint8_t? I\u0027m not sure this logic is correct for an overflow check. I know you got this from elsewhere, but I\u0027m now skeptical that past me was right."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1881,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yeah, if you don\u0027t know, then neither do I. :-) I\u0027ll see what I can dig up."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1881,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This is wrong. It should be sizeof (uint8_t). I will fix it. I am almost certain I understand what you did wrong. When you wrote the i40e_meoi_get_uint8 function you did a copy/paste from the i40e_meoi_get_uint16 function and forgot to adjust the sizeof. We can fix the i40e code as part of the netperf wad, or do it in its own ticket."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man9e/mac.9e","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/inet/ip/ip_output.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/qede/qede_gld.c","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"usr/src/uts/common/sys/dlpi.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":42,"deletions":-4}],"sizeInsertions":81,"sizeDeletions":-20},{"number":"3","revision":"b13de52d5b83ce4264de16c20c849a3fdd03c06a","parents":["929399046cc464d1c38a4d4facf93476166a5662"],"ref":"refs/changes/11/3711/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1522162173,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522338344,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522862526,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522431672,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1924,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why is this and the other cases cast to void? If we can\u0027t get it for some reason, shouldn\u0027t we error and/or drop the packet?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1924,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I left the function returning a value since I felt this function might be useful in the future for the upcoming work. The case of not getting the ipproto is already handled since it is set to IPPROTO_NONE."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1924,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Hmm. OK. I guess that\u0027ll mean that we still might send it out, but I guess that\u0027s probably fine, as it\u0027ll end up being a bad value anyways."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1924,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Given the code changes I made below, none of the HW checksum handling here will be enabled if we don\u0027t get ipproto, so whatever the rest of the stack will do in this case, it would do anyway."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1924,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we\u0027re skipping the ipproto check below for HCKSUM_PARTIAL, then this could be moved after it, skipping the lookup work unless it\u0027s needed for HCKSUM_FULL."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1936,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why should we restrict partial checksums to known IP protocols?  If they\u0027ve given us the offsets, we can simply act on those."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1936,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Because most modern hardware that uses the partial checksum mode is because it requires the pseudo-headers, not because it can actually checksum arbitrary partial checksums."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1936,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Robert and I discussed the situation here.  While there\u0027s certainly a lot we can do in the future to improve this, I\u0027m fine with what we have here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man9e/mac.9e","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/inet/ip/ip_output.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/qede/qede_gld.c","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"usr/src/uts/common/sys/dlpi.h","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":40,"deletions":-3}],"sizeInsertions":84,"sizeDeletions":-24},{"number":"4","revision":"84636c8082b9aee9413dca55149c8d17a373523e","parents":["4ac08e240a8b70d239bb2fed6f0d1a09f8da3038"],"ref":"refs/changes/11/3711/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1522863465,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522338344,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522862526,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1522863496,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522431672,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/man/man9e/mac.9e","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/inet/ip/ip_output.c","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/qede/qede_gld.c","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"usr/src/uts/common/sys/dlpi.h","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":40,"deletions":-3}],"sizeInsertions":84,"sizeDeletions":-24}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}