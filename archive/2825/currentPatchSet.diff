From 1a713cce5c39c82fc1ae2e4e9f9e4c6b35e9bc43 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Wed, 1 Nov 2017 09:05:03 -0700
Subject: [PATCH] =?UTF-8?q?TOOLS-1899=20sdcadm:=20move=20to=20node=20v4=20?=
 =?UTF-8?q?Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.?=
 =?UTF-8?q?com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@?=
 =?UTF-8?q?joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.md     |  4 ++++
 Makefile       |  6 +++---
 lib/logging.js |  6 +++---
 lib/sdcadm.js  |  6 ++----
 package.json   | 15 ++++++++-------
 5 files changed, 20 insertions(+), 17 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 1dccc17..b5cb59d 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.16.3
+
+- TOOLS-1899 Update to using node v4.
+
 ## 1.16.2
 
 - TOOLS-1883 Allow 'sdcadm up manatee' to work correctly with newer MANATEE-346
diff --git a/Makefile b/Makefile
index 2dc9162..122f9ca 100644
--- a/Makefile
+++ b/Makefile
@@ -27,11 +27,11 @@ JSSTYLE_FLAGS	 = -f tools/jsstyle.conf
 CLEAN_FILES += ./node_modules ./build/sdcadm-*.sh ./build/sdcadm-*.imgmanifest ./build/shar-image ./man/man1/sdcadm.1 ./etc/sdcadm.completion
 
 
-NODE_PREBUILT_VERSION=v0.10.26
+NODE_PREBUILT_VERSION=v4.8.5
 ifeq ($(shell uname -s),SunOS)
 	NODE_PREBUILT_TAG=gz
-	# sdc-smartos/1.6.3
-	NODE_PREBUILT_IMAGE=fd2cc906-8938-11e3-beab-4359c665ac99
+	# sdc-minimal-multiarch-lts 15.4.1
+	NODE_PREBUILT_IMAGE=18b094b0-eb01-11e5-80c1-175dac7ddf02
 endif
 
 
diff --git a/lib/logging.js b/lib/logging.js
index 93a98f9..a2febfa 100644
--- a/lib/logging.js
+++ b/lib/logging.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright 2016 Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -65,7 +65,7 @@ var events = require('events');
 var fs = require('fs');
 var mkdirp = require('mkdirp');
 var mod_uuid = require('node-uuid');
-var restify = require('sdc-clients/node_modules/restify');
+var restifyClients = require('sdc-clients/node_modules/restify-clients');
 var sprintf = require('extsprintf').sprintf;
 var util = require('util');
 
@@ -213,7 +213,7 @@ function createLogger(opts) {
         name: opts.name,
         component: opts.component,
         // https://github.com/mcavage/node-restify/pull/501 is fixed
-        serializers: restify.bunyan.serializers,
+        serializers: restifyClients.bunyan.serializers,
         src: opts.verbose,
         streams: logStreams,
         req_id: opts.req_id || mod_uuid.v4()
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index d803a36..095ac7e 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -22,7 +22,6 @@ var path = require('path');
 var util = require('util');
 var format = util.format;
 
-
 var assert = require('assert-plus');
 var cueball = require('cueball');
 var mkdirp = require('mkdirp');
@@ -30,14 +29,13 @@ var ProgressBar = require('progbar').ProgressBar;
 var sdcClients = require('sdc-clients');
 var semver = require('semver');
 var sprintf = require('extsprintf').sprintf;
+var UFDS = require('ufds');
 var uuid = require('node-uuid');
 var urclient = require('urclient');
 var vasync = require('vasync');
 var VError = require('verror').VError;
 var WfClient = require('wf-client');
 
-
-
 var common = require('./common');
 var svcadm = require('./svcadm');
 var errors = require('./errors');
@@ -328,7 +326,7 @@ function SdcAdm(options) {
     Object.defineProperty(this, 'ufds', {
         get: function () {
             if (self._ufds === undefined) {
-                self._ufds = new sdcClients.UFDS({
+                self._ufds = new UFDS({
                     url: self.config.ufds.url,
                     bindDN: self.config.ufds.bindDN,
                     bindPassword: self.config.ufds.bindPassword,
diff --git a/package.json b/package.json
index 957a050..1ed7a54 100644
--- a/package.json
+++ b/package.json
@@ -1,35 +1,36 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.16.2",
+  "version": "1.16.3",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
     "async": "0.2.9",
     "assert-plus": "^1.0.0",
     "backoff": "2.5.0",
-    "bunyan": "0.23.1",
+    "bunyan": "1.8.12",
     "cmdln": "4.2.1",
     "cueball": "2.4.0",
     "extsprintf": "^1.3.0",
     "kthxbai": "~0.4.0",
     "joyent-schemas": "git+https://github.com/joyent/schemas.git#385e6eb",
     "jsprim": "1.2.2",
-    "lockfd": "1.0.1",
+    "lockfd": "1.2.1",
     "mkdirp": "0.3.5",
     "node-uuid": "1.4.1",
     "once": "1.3.0",
     "progbar": "1.1.0",
     "read": "1.0.5",
-    "sdc-clients": "9.0.2",
+    "sdc-clients": "10.3.0",
     "semver": "2.2.1",
     "strsplit": "1.0.0",
-    "tabula": "1.2.2",
+    "tabula": "1.9.0",
     "tape": "3.5.0",
-    "urclient": "^1.1.0",
+    "ufds": "1.3.0",
+    "urclient": "1.2.0",
     "vasync": "^1.6.4",
     "verror": "^1.10.0",
-    "wf-client": "git+https://github.com/joyent/sdc-wf-client.git#9bcb3a0ebec7cd5b4052acaacde8fd6e3e2dfcf9"
+    "wf-client": "0.3.0"
   },
   "devDependencies": {
     "marked-man": "0.1.4"
-- 
2.21.0

