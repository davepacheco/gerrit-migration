{"project":"joyent/manta-muskie","branch":"master","id":"Iff417c352911c10b943df8ea91e7c549c2e02ed6","number":"1206","subject":"MANTA-3072 muskie leaks pickers on request failure MANTA-2971 muskie should lose its no-op moray error handlers MANTA-2990 muskie picker problems Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"url":"https://cr.joyent.us/1206","commitMessage":"MANTA-3072 muskie leaks pickers on request failure\nMANTA-2971 muskie should lose its no-op moray error handlers\nMANTA-2990 muskie picker problems\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1483566274,"lastUpdated":1483657118,"open":false,"status":"MERGED","comments":[{"timestamp":1483566274,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 1."},{"timestamp":1483566316,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483566723,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 2."},{"timestamp":1483566754,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483566951,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 3."},{"timestamp":1483567002,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483572430,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1483575340,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 4."},{"timestamp":1483575488,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483577192,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1483577329,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1483656521,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1483656563,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1483656698,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1483657063,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1483657118,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by David Pacheco"}],"currentPatchSet":{"number":"6","revision":"ff417c352911c10b943df8ea91e7c549c2e02ed6","parents":["201b8211b0d9b30cf7793df0a8f724cf99a570bc"],"ref":"refs/changes/06/1206/6","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483657063,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483575488,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483577329,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483656698,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1483657118,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"lib/picker.js","type":"MODIFIED","insertions":28,"deletions":-21},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":32,"sizeDeletions":-63},"patchSets":[{"number":"1","revision":"6f211930a083b25f9f607eec17024248cf66740a","parents":["1967aa4e361998676ccff4f29dcc70a10fd668e1"],"ref":"refs/changes/06/1206/1","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483566274,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483566316,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"lib/picker.js","type":"MODIFIED","insertions":33,"deletions":-18},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":36,"sizeDeletions":-59},{"number":"2","revision":"3f245450da13a159a680d6ca281bbba65066e0d0","parents":["1967aa4e361998676ccff4f29dcc70a10fd668e1"],"ref":"refs/changes/06/1206/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483566723,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483566754,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"lib/picker.js","type":"MODIFIED","insertions":28,"deletions":-21},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":31,"sizeDeletions":-62},{"number":"3","revision":"0e196cdc95992cf7c51133754f576132d2b71052","parents":["1967aa4e361998676ccff4f29dcc70a10fd668e1"],"ref":"refs/changes/06/1206/3","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483566951,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483567002,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/picker.js","line":185,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would put this log message _before_ we clear the timeout."},{"file":"lib/picker.js","line":185,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/picker.js","line":187,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Do we not care to wait until the deferred work (process.nextTick below) is complete before rescheduling?"},{"file":"lib/picker.js","line":187,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I thought it was easier this way to see (and prove to oneself) that poll() was always rescheduled exactly once, no matter the result of fetch(), particularly if the function is extended in the future with additional early returns.  I don\u0027t feel very strongly about this either way.\n\nThe obvious case to consider is if it takes a long time to get from line 187 to line 245.  I don\u0027t believe it\u0027s possible for the timeout to leapfrog the nextTick callback because of the way nextTick is defined.  The only other issue I see is that we might be polling Moray more frequently than expected, but I think it would take extraordinary circumstances for that to amount to even a few percent of the polling interval in practice, and I\u0027m not sure it would be a bug even then.  (We use a 30 second poll interval today.  Even if it took 15 seconds to execute the JavaScript, including any time spent off-CPU because of scheduling contention, it\u0027s not obviously wrong to issue the next poll 15 seconds after that rather than 30 seconds after it.  In a more extreme case, if it takes 45 seconds to execute that code, we won\u0027t issue another request -- we\u0027ll just issue one right away after we do that, which still seems reasonable.)\n\nI think the use of nextTick() itself is specious and would probably rip it out, but I was a little too chicken to make that change.\n\nIf you feel this is brittle as-is, I can re-arrange it as you suggest."},{"file":"lib/picker.js","line":187,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think it\u0027s fine to leave it as-is.  Thanks for explaining.\n\n(I would remove the nextTick(), too, but I guess that can wait for the future.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"lib/picker.js","type":"MODIFIED","insertions":28,"deletions":-21},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":32,"sizeDeletions":-63},{"number":"4","revision":"7581f77486e9692814461796de426a40c6dc70d4","parents":["1967aa4e361998676ccff4f29dcc70a10fd668e1"],"ref":"refs/changes/06/1206/4","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483575340,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483577329,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483575488,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"lib/picker.js","type":"MODIFIED","insertions":28,"deletions":-21},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":32,"sizeDeletions":-63},{"number":"5","revision":"82650e41dc76ee4d3591079165afe5dd1d75886f","parents":["201b8211b0d9b30cf7793df0a8f724cf99a570bc"],"ref":"refs/changes/06/1206/5","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483656521,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483577329,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483575488,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483656698,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"lib/picker.js","type":"MODIFIED","insertions":28,"deletions":-21},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":32,"sizeDeletions":-63},{"number":"6","revision":"ff417c352911c10b943df8ea91e7c549c2e02ed6","parents":["201b8211b0d9b30cf7793df0a8f724cf99a570bc"],"ref":"refs/changes/06/1206/6","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1483657063,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1483657118,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483577329,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483575488,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1483656698,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":1,"deletions":-10},{"file":"lib/picker.js","type":"MODIFIED","insertions":28,"deletions":-21},{"file":"main.js","type":"MODIFIED","insertions":3,"deletions":-32}],"sizeInsertions":32,"sizeDeletions":-63}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}