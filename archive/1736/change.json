{"project":"joyent/node-libmanta","branch":"master","topic":"MANTA-2980","id":"If5a457f684fe3ef41354975864757260270fa22a","number":"1736","subject":"MANTA-2980 electric-moray should report moray shard for operations like \u0027putObject\u0027 Reviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/1736","commitMessage":"MANTA-2980 electric-moray should report moray shard for operations like \u0027putObject\u0027\nReviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1491254830,"lastUpdated":1525810020,"open":false,"status":"MERGED","comments":[{"timestamp":1491254830,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1491254853,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492441655,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1492441689,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492469319,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1492717383,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(1 comment)\n\nSorry, I forgot to finalize my reply. I do agree that this approach is a hack. I can make a copy of the object if you think that\u0027s the proper approach to take :). Another approach could be that moray replies with whatever information it can find about itself (ip address, maybe it could find its dns name somehow)."},{"timestamp":1504220586,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1504220610,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504735169,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1504736366,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1505759508,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1524839984,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1524840009,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1524840029,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1524840055,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1525369604,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1525805035,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1525809830,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1525810020,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"6","revision":"f5a457f684fe3ef41354975864757260270fa22a","parents":["215395a3a10bb392711d4a535bc0ce4bba14e1a9"],"ref":"refs/changes/36/1736/6","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1525809830,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524840009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369604,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525805035,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1525810020,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"5115d04b28b4066e0e02801bc96c9b8970ccfcce","parents":["e6e5be210c3e66ae6990c1e1395e25422a2390de"],"ref":"refs/changes/36/1736/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1491254830,"author":{"name":"Kody Kantor","email":"Kody.Kantor@gmail.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491254853,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":4,"sizeDeletions":-1},{"number":"2","revision":"643b7d1046243a1040e956b72c1fe533c10efdab","parents":["4c001a1f66ee7f93f65319018cd13aa8240415a2"],"ref":"refs/changes/36/1736/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1492441655,"author":{"name":"Kody Kantor","email":"Kody.Kantor@gmail.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492441689,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/moray.js","line":453,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Did electric-moray always supply this, or is this a fallback for versions of electric-moray?\n\nI generally dislike modifying argument objects behind the caller\u0027s back.  It would probably have been better if this function created its own copy upon entry, but I\u0027m not sure if it\u0027s worth doing that now.  What do you think?\n\nIs there any harm in Muskie from supplying this extra property?\n\nIt would be useful to mention that here.  Also, although older code is not always great about this, we try to make sure comments are complete sentences with capitalization and punctuation."},{"file":"lib/moray.js","line":453,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"All good questions! Thanks for the feedback.\n\ne-moray (node-moray specifically) did always supply this, so I can probably get rid of the check. I\u0027ll double check that we can do that, but signs point to yes.\n\nI agree, modifying things being passed up like this is a hack. I\u0027ll see if there\u0027s another approach further down the stack (like in moray itself) that will be better. I could change the existing code for getObject as well in that case.\n\nI\u0027ll think a little on possibly harm to muskie."},{"file":"lib/moray.js","line":453,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Not to harp on this further, but I\u0027m trying to get my head around what it means to attach an additional value on this object passed in the callback of this function.  It seems to represent the metadata the caller wanted to put in Moray, so I\u0027m confused why libmanta would pass it back in the callback.\n\nI don\u0027t see any consumers of it in Muskie, I don\u0027t think. Are there other consumers? If so, how do they use it?"},{"file":"lib/moray.js","line":453,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks to me like the only muskie code to actually use the returned field is what\u0027s proposed for MANTA-2980 in muskie. The only other consumer is actually MPU where the returned field is in a debug log statement.\n\nI haven\u0027t looked at how other services may be using this API."},{"file":"lib/moray.js","line":453,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"What about imitating the semantics of `getMetadata` for the callback here? I.e., https://github.com/joyent/node-libmanta/blob/f9d436c6978c30d48372784f2fe973cc565df24d/lib/moray.js#L790.\n\nThen any services using the first argument will not be affected, and ones wishing to upgrade to get the wrapper object (such as muskie) can opt in to receiving the new object in the callback."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":4,"sizeDeletions":-1},{"number":"3","revision":"599f0e9fb5ad395da509ff8235783cfa6fbda52a","parents":["f9d436c6978c30d48372784f2fe973cc565df24d"],"ref":"refs/changes/36/1736/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1504220586,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504220610,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":5,"deletions":-2}],"sizeInsertions":5,"sizeDeletions":-2},{"number":"4","revision":"f797e273c3b535f22691759692b7894f32c9b69d","parents":["f9d436c6978c30d48372784f2fe973cc565df24d"],"ref":"refs/changes/36/1736/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1524839984,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524840009,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-3},{"number":"5","revision":"4ca7ac744eeb6658f97fe4eb482c17c2fdeca30a","parents":["215395a3a10bb392711d4a535bc0ce4bba14e1a9"],"ref":"refs/changes/36/1736/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1524840029,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524840009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369604,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525805035,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-3},{"number":"6","revision":"f5a457f684fe3ef41354975864757260270fa22a","parents":["215395a3a10bb392711d4a535bc0ce4bba14e1a9"],"ref":"refs/changes/36/1736/6","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1525809830,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524840009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525369604,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525805035,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1525810020,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/moray.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-3}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}