From 599f0e9fb5ad395da509ff8235783cfa6fbda52a Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody.kantor@gmail.com>
Date: Thu, 31 Aug 2017 21:42:48 +0000
Subject: [PATCH] MANTA-2980 electric-moray should report moray shard for
 operations like 'putObject'

---
 lib/moray.js | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/lib/moray.js b/lib/moray.js
index fe8050c..7ae51ef 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -421,7 +421,7 @@ function put(options, cb) {
     var op = options.op;
     var bucket = options.bucket;
     var key = options.key;
-    var md = options.md;
+    var md = jsprim.deepCopy(options.md);
     var opts = options.putOptions;
 
     log.debug({
@@ -433,7 +433,7 @@ function put(options, cb) {
         headers: opts.headers
     }, 'Moray.' + op + ': entered');
 
-    client.putObject(bucket, key, md, opts, function (err) {
+    client.putObject(bucket, key, md, opts, function (err, data) {
         if (err) {
             log.debug({
                 err: err,
@@ -450,6 +450,9 @@ function put(options, cb) {
                 cb(err);
             }
         } else {
+            if (data._node) {
+                md._node = data._node;
+            }
             log.debug({
                 key: key,
                 requestId: opts.requestId
-- 
2.21.0

