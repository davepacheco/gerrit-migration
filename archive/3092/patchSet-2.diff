From ea6e6eea553f78db75ad13e2e6f466c3bbe25c87 Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Mon, 11 Dec 2017 16:15:35 -0800
Subject: [PATCH] MANTA-3233 Undeploy without disruption - moray

---
 lib/server.js              | 82 ++++++++++++++++++++++++++++++++++++++
 smf/manifests/moray.xml.in |  4 +-
 2 files changed, 84 insertions(+), 2 deletions(-)

diff --git a/lib/server.js b/lib/server.js
index c765bb2..b0045a2 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -12,6 +12,7 @@ var util = require('util');
 var EventEmitter = require('events').EventEmitter;
 
 var assert = require('assert-plus');
+var jsprim = require('jsprim');
 var libuuid = require('libuuid');
 var mod_fast = require('fast');
 var mod_kang = require('kang');
@@ -213,6 +214,20 @@ function MorayServer(options) {
     self.fast_socket.on('listening', function () {
         self.log.info({ address: self.fast_socket.address() },
             'Moray listening on port %d', self.port);
+        /*
+         * Register a handler for SIGTERM, which will use to
+         * quiesce ourselves (finish in-flight requests).
+         */
+        process.on('SIGTERM', function () {
+            var args = {
+                server: self.fast_server,
+                monitor: self.monitor_server,
+                log: log.child({ component: 'quiesce' }),
+                options: options
+            };
+            quiesce(args);
+        });
+
         sock_ready = true;
         emitReady();
     });
@@ -315,3 +330,70 @@ function getTokens(options) {
 
     return _getTokens;
 }
+
+/*
+ * This function is called if the process has received a SIGTERM signal. In the
+ * current implementation, this signal is sent in moray's smf stop
+ * method, which means that it will be invoked whenever the zone is brought
+ * down or rebooted and whenever an operator uses smf tools to disable the
+ * moray service. In order to properly execute a quiesce by disabling
+ * individual service, the operator must disable both registrar and
+ * electric-moray.
+ *
+ * Electric-Moray, is the other end of all node-fast connection state created
+ * by the FastServer here. In this function, moray is waiting for the peer
+ * resolver to notice that this zone has dropped out of zookeeper and terminate
+ * any fast-connections it has to this zone. In the interim, electric-moray can
+ * happily serve any pending RPCs that were issued before Muskie noticed the
+ * DNS change. The MorayConnectionPool will take care of draining any requests
+ * that may have been in the pipe once cueball notices this electric-moray
+ * instance is no longer discoverable.
+ */
+function quiesce(args) {
+    assert.object(args.server, 'args.server');
+    assert.object(args.monitor, 'args.monitor');
+    assert.object(args.log, 'args.log');
+    assert.object(args.options, 'args.options');
+
+    var server = args.server;
+    var monitorServer = args.monitor;
+    var log = args.log;
+    var options = args.options;
+
+    log.info('moray-%d entering quiesce state', options.port);
+
+    function checkPendingRequests() {
+        if (!jsprim.isEmpty(server.fs_conns)) {
+            jsprim.forEachKey(server.fs_conns, function (connid, conn) {
+                log.info('moray-%d fast connection %s has %d pending ' +
+                    'requests left.', options.port, connid,
+                    Object.keys(conn.fc_pending).length);
+            });
+            setTimeout(checkPendingRequests, 100);
+            return;
+        }
+
+        log.info('moray-%d pending requests drained, open connections removed.',
+                options.port);
+
+        server.close();
+
+        monitorServer.close(function () {
+            log.info('moray-%d shut down monitorServer', options.port);
+        });
+
+        var socket = server.fs_server;
+        socket.close();
+
+        socket.on('close', function (err) {
+            if (err) {
+                log.warn('moray-%d fast server socket close error: %s',
+                    options.port, err);
+            }
+            log.info('terminating moray-%d process', options.port);
+            process.exit();
+        });
+    }
+
+    setImmediate(checkPendingRequests);
+}
diff --git a/smf/manifests/moray.xml.in b/smf/manifests/moray.xml.in
index 59b254c..ab43305 100644
--- a/smf/manifests/moray.xml.in
+++ b/smf/manifests/moray.xml.in
@@ -62,8 +62,8 @@
 
         <exec_method type="method"
                      name="stop"
-                     exec=":kill"
-                     timeout_seconds="30" />
+                     exec=":kill -TERM"
+                     timeout_seconds="0" />
 
         <property_group name="application" type="application" />
 
-- 
2.21.0

