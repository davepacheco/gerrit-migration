{"project":"joyent/illumos-joyent","branch":"master","id":"I09d9ee89aec409242d50a5e168d8d883fc7539e8","number":"4941","subject":"OS-7300 bhyve should not sync IO unless necessary OS-7416 bhyve BLOCKIF_NUMTHR should keep pace with MAXREQ Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/4941","commitMessage":"OS-7300 bhyve should not sync IO unless necessary\nOS-7416 bhyve BLOCKIF_NUMTHR should keep pace with MAXREQ\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1539203300,"lastUpdated":1543877855,"open":false,"status":"MERGED","comments":[{"timestamp":1539203300,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1539203357,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1539209812,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1539212102,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1539212137,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1539212234,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1539222663,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1539262270,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1539264196,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1539357054,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Integration-Approval-1\n\nHolding until some of the zfs write throttle questions are addressed."},{"timestamp":1539973391,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1541450745,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1541450823,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nThe rebase to bits including OS-7199 meant removing the blockif_write customization in light of our changes here."},{"timestamp":1541543559,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5."},{"timestamp":1542754913,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\nI would like to have this ready to go when the ZIL cache flushing issues are solved.  Can folks take another look when they have a chance?"},{"timestamp":1542825834,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1543249591,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1543530112,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: -Integration-Approval\n\nWith the needed zfs changes approaching the gate, this should be close to ready."},{"timestamp":1543604391,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6:\n\n(16 comments)"},{"timestamp":1543606682,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(13 comments)"},{"timestamp":1543615678,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6:\n\n(8 comments)"},{"timestamp":1543855250,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1543864148,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 8."},{"timestamp":1543864159,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1543871732,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1543872023,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1543873828,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\nretested using the scenarios I used previously"},{"timestamp":1543877219,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1543877568,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 9: Patch Set 8 was rebased."},{"timestamp":1543877644,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1543877855,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"10","revision":"09d9ee89aec409242d50a5e168d8d883fc7539e8","parents":["a5fdd1b56caa1353ecd2d0ada557c6f8085698c5"],"ref":"refs/changes/41/4941/10","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543877644,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871732,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543872023,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543877219,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1543877855,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":129,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":11,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":180,"sizeDeletions":-59},"patchSets":[{"number":"1","revision":"f99f406297ae78301252cab70f4776cbc9adca27","parents":["d42a31d44200e9c79284cfbf3a4889c8518cd77e"],"ref":"refs/changes/41/4941/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1539203300,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/bhyve/block_if.c","line":956,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"All callers cast the return to void.  No return value needed."},{"file":"usr/src/cmd/bhyve/block_if.c","line":956,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027s still a convenient trace point.  (And the return-value-ignorance of virtio_block is still up for discussion)"},{"file":"usr/src/cmd/bhyve/block_if.c","line":956,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If this isn\u0027t going to return, then execution shouldn\u0027t be allowed to continue when it fails. I prefer it returning a value though."},{"file":"usr/src/cmd/bhyve/block_if.c","line":972,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Whoops.  I had these mixed up."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":472,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I could be swayed either way on if we should VERIFY0() this or just let it be."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":472,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"An error message indicating that it didn\u0027t work would be better than nothing.  Writes to stdout/stderr are logged to the platform log.  The right place to log any errors is probably in blockif_set_wce where errno can be reliably read."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":472,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Frankly, I\u0027m much more inclined to VERIFY if we fail this check here rather than spitting out an error message."},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":472,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Either is better than silence"},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","line":472,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I agree, we should probably do something other than silence. Or if we can\u0027t enable it, leaving it disabled and continuing to operate with a note so as not to take down service would probably make sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-44},{"number":"2","revision":"b12c7592b5b18b667c2c02b82f775697ee112f32","parents":["d42a31d44200e9c79284cfbf3a4889c8518cd77e"],"ref":"refs/changes/41/4941/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1539212102,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1539357054,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539264196,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/cmd/bhyve/block_if.c","line":572,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Does this also implement https://github.com/joyent/smartos-live/issues/796 ? or is this just used internally and not exposed to the guest?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-44},{"number":"3","revision":"c97bd7d989bb0a0962ebe7f48c246b27e62aa76f","parents":["104c53876a87e773ef729efa9419a70fe24933cb"],"ref":"refs/changes/41/4941/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1539973391,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1539357054,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539264196,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-44},{"number":"4","revision":"0f84da70a01417a692e45940f9b3dced4434b950","parents":["40fc639cb57bbbbb360437ad5d4934c7635d14a8"],"ref":"refs/changes/41/4941/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1541450745,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1539357054,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-59},{"number":"5","revision":"9ee93a84b5a75f08d4c862db2b9e04e270815c14","parents":["40fc639cb57bbbbb360437ad5d4934c7635d14a8"],"ref":"refs/changes/41/4941/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1541543559,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1539357054,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542825834,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-59},{"number":"6","revision":"970d226fa9d94d4076ac5af15462aaf027e1328a","parents":["bb7f525820fb9ee32d8b59ed1b4c53c0624d8598"],"ref":"refs/changes/41/4941/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543249591,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542825834,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"usr/src/cmd/bhyve/block_if.c","line":80,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"How did we know we need to double this? Probably should have another ticket about this in the changeset with details."},{"file":"usr/src/cmd/bhyve/block_if.c","line":80,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I doubled it because the MAXREQ was also doubled.  This was intended to keep the max queued requests per thread the same."},{"file":"usr/src/cmd/bhyve/block_if.c","line":80,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, I think it\u0027ll be worth writing that up in a ticket."},{"file":"usr/src/cmd/bhyve/block_if.c","line":341,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is issuing an fsync to a character device the right thing to do here? Shouldn\u0027t we be using DKIOCFLUSHWRITECACHE in cases where we\u0027ve used DKIOCSETWCE?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":341,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"In zfs and specfs, there is logic to translate VOP_FLUSH into that ioctl for backends that support it."},{"file":"usr/src/cmd/bhyve/block_if.c","line":341,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, is it worth filing a follow up for the future at some point or do we believe the fsync is sufficient, pretty much forever? If the latter, probably worth a comment about why we don\u0027t, as it stands out a bit in comparison to the FBSD case above."},{"file":"usr/src/cmd/bhyve/block_if.c","line":341,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Added a comment"},{"file":"usr/src/cmd/bhyve/block_if.c","line":575,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we always want to pass through physical size? There\u0027s nothing, for example, that stops a physical size from changing on a firmware upgrade (see the DC S3700 from Intel where this happened in the field), which basically made it more honest about the physical size, while the logical size likely remained the same.\n\nIt\u0027d be worth having another ticket in the changeset with details about what\u0027s going on here and why."},{"file":"usr/src/cmd/bhyve/block_if.c","line":575,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"For us, strictly using zvols, the pbsize represents the volblocksize.  Exposing this rather than the MAXBSIZE default seemed preferable and basically mirrors the existing freebsd-native logic.  If that sounds reasonable, I\u0027ll write up another ticket."},{"file":"usr/src/cmd/bhyve/block_if.c","line":575,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"That seems reasonable for now, yeah."},{"file":"usr/src/cmd/bhyve/block_if.c","line":582,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This seems inconsistent with the way the drivers are wired up today. Notably the ahci drivers which properly support flushing and will issue flush ops when they get the corresponding ATA command never enable the write cache.\n\nOn the other hand the PCI nvme implementation seems incorrect in so far as it never actually issues a blockif_flush() request.\n\nFinally, with the virtio implementation, we explicitly disable the wce.\n\nBased on this are we missing the proper triggering of enabling the wce in the ahci case, which it should be doing by default based on how it\u0027s emulating the drive?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":582,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"virtio has been the primary focus of testing/benchmarking for us, so I\u0027d mostly overlooked the ahci case.  I can add the explicit enable to that driver.\n\nAs for NVME, I think more scrutiny is needed, in general, before we use it."},{"file":"usr/src/cmd/bhyve/block_if.c","line":582,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think just adding the ahci case and ignoring NVME is reasonable."},{"file":"usr/src/cmd/bhyve/block_if.c","line":582,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Added the WCE to ahci"},{"file":"usr/src/cmd/bhyve/block_if.c","line":592,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"For some reason that in the conditional feels like it doesn\u0027t pass my smell test and makes me feel like we\u0027re abusing the assignment in conditional a bit."},{"file":"usr/src/cmd/bhyve/block_if.c","line":592,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we care that this failing leaves WCE enabled? I assume not."},{"file":"usr/src/cmd/bhyve/block_if.c","line":592,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Will fix up with an assert."},{"file":"usr/src/cmd/bhyve/block_if.c","line":592,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027ll refactor.  It was an attempt to avoid going too deep into 80 cols."},{"file":"usr/src/cmd/bhyve/block_if.c","line":602,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is the reason that you\u0027re using O_DSYNC and not O_SYNC here because you don\u0027t care about metadata updates to the file being synchronized?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":602,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we care about the case where O_DSYNC is already set?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":602,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Would we expect it to be set on a freshly opened fd?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":602,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, the metadata updates seemed less important.  (Especially for a zvol)"},{"file":"usr/src/cmd/bhyve/block_if.c","line":602,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess if we opened it, then we shouldn\u0027t. I just don\u0027t know enough about how bhyve will get the fd. If it\u0027s only ever from us opening it, then it seems fine to assume it\u0027s not there."},{"file":"usr/src/cmd/bhyve/block_if.c","line":957,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Perhaps this should be a boolean_t to reflect that it\u0027s actually binary and so we don\u0027t have to think about what happens if someone accidentally sends a negative value and how that propagates through the kernel?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":957,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"For our code, I would agree.  I\u0027ve used \u0027int\u0027 here to match freebsd\u0027s style in anticipation of upstreaming this at some point.  I\u0027ll  change the function to force the value to a 1.  (An aside, I don\u0027t think anything in the kernel cares about \u00271\u0027 vs all-other-nonzero when it comes to this ioctl.)"},{"file":"usr/src/cmd/bhyve/block_if.c","line":957,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, seems like a reasonable way to do it. I know nothing in the kernel cares today, just one of those future proofing kinds of things."},{"file":"usr/src/cmd/bhyve/block_if.c","line":961,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"In the future, this lock should be made an error checking lock and this should be checked and not just ignored. Probably should cast to void to indicate we don\u0027t care."},{"file":"usr/src/cmd/bhyve/block_if.c","line":961,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Hah, I\u0027m too used to failure-proof mutex_enter."},{"file":"usr/src/cmd/bhyve/block_if.c","line":964,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027d recommend we normalize the value of wc_enable to zero or one to reduce cases where a driver doesn\u0027t properly deal with that."},{"file":"usr/src/cmd/bhyve/block_if.c","line":964,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Happy to."},{"file":"usr/src/cmd/bhyve/block_if.c","line":981,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If the case is WCE_NONE, is just returning zero the right semantic thing? I guess you could have it rigged up such that other callers don\u0027t care about it since it\u0027s a no-op. Just not sure how that fits into the broader virtio API, etc."},{"file":"usr/src/cmd/bhyve/block_if.c","line":981,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If we don\u0027t perceive the availability of any write cache, then I think it\u0027s fine to report successes for its state changes."},{"file":"usr/src/cmd/bhyve/block_if.c","line":981,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, seems reasonable."},{"file":"usr/src/cmd/bhyve/block_if.c","line":989,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we hit the default case, res will be zero. If wc_enable is also zero, this will trigger an fsync. Perhaps we shouldn\u0027t be continuing on with execution in the default case of the switch statement."},{"file":"usr/src/cmd/bhyve/block_if.c","line":989,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The fsync() should be extremely cheap for a device/file that isn\u0027t doing caching and WCE state changes from the guest are expected to be seldom.  I\u0027d prefer to keep this simple if that\u0027s alright?"},{"file":"usr/src/cmd/bhyve/block_if.c","line":989,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK. That\u0027s fine."},{"file":"usr/src/cmd/bhyve/block_if.c","line":991,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Unchecked return value, see earlier note."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-59},{"number":"7","revision":"df6c63b68eeaa72957fca5b340bfbfa3a2ce8497","parents":["24342c22e832a4033a4bf0fe798a9219ea591bc9"],"ref":"refs/changes/41/4941/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543855250,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542825834,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":108,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":0,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":148,"sizeDeletions":-59},{"number":"8","revision":"3a1f6ec596167a7cc2c9ba08d272c506441f1818","parents":["24342c22e832a4033a4bf0fe798a9219ea591bc9"],"ref":"refs/changes/41/4941/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543864148,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871732,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543872023,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543877219,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":129,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":11,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":180,"sizeDeletions":-59},{"number":"9","revision":"e382d4b22b3cdc861320b82f27e5c12245517cda","parents":["a5fdd1b56caa1353ecd2d0ada557c6f8085698c5"],"ref":"refs/changes/41/4941/9","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543877568,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871732,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543872023,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543877219,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":129,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":11,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":180,"sizeDeletions":-59},{"number":"10","revision":"09d9ee89aec409242d50a5e168d8d883fc7539e8","parents":["a5fdd1b56caa1353ecd2d0ada557c6f8085698c5"],"ref":"refs/changes/41/4941/10","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1543877644,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543871732,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1543877855,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543872023,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543877219,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/block_if.c","type":"MODIFIED","insertions":129,"deletions":-23},{"file":"usr/src/cmd/bhyve/block_if.h","type":"MODIFIED","insertions":4,"deletions":-6},{"file":"usr/src/cmd/bhyve/pci_ahci.c","type":"MODIFIED","insertions":11,"deletions":-9},{"file":"usr/src/cmd/bhyve/pci_nvme.c","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"usr/src/cmd/bhyve/pci_virtio_block.c","type":"MODIFIED","insertions":36,"deletions":-6}],"sizeInsertions":180,"sizeDeletions":-59}],"allReviewers":[{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}