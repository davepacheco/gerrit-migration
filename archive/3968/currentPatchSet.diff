From 3ea6c9e0b9f007bb949262cf3e63f042202d252d Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 14 Dec 2016 16:30:08 -0800
Subject: [PATCH] MANTA-3052 want mahi to serve allowed_dcs attributes

---
 lib/replicator/transforms/sdcperson.js |  34 ++++++-
 test/sdcperson.test.js                 | 130 ++++++++++++++++++++++++-
 2 files changed, 158 insertions(+), 6 deletions(-)

diff --git a/lib/replicator/transforms/sdcperson.js b/lib/replicator/transforms/sdcperson.js
index 4c3983a..48f94e3 100644
--- a/lib/replicator/transforms/sdcperson.js
+++ b/lib/replicator/transforms/sdcperson.js
@@ -37,13 +37,18 @@ function add(opts, cb) {
         changes.triton_cns_enabled[0] &&
         changes.triton_cns_enabled[0] === 'true';
 
+    var dcs = [];
+    if (Array.isArray(changes.allowed_dcs))
+        dcs = changes.allowed_dcs;
+
     var payload = {
         type: 'account',
         uuid: uuid,
         login: login,
         groups: [],
         approved_for_provisioning: approved,
-        triton_cns_enabled: tcns
+        triton_cns_enabled: tcns,
+        allowed_dcs: dcs
     };
 
     batch.set(sprintf('/uuid/%s', uuid), JSON.stringify(payload));
@@ -137,6 +142,33 @@ function modify(opts, cb) {
                     payload: payload
                 }, 'sdcperson.modify: setting redis payload');
 
+                batch.set(key, JSON.stringify(payload));
+            } else if (type === 'allowed_dcs') {
+                log.debug({
+                    change: change
+                }, 'sdcperson.modify: %s', type);
+                if (!Array.isArray(payload[type]))
+                    payload[type] = [];
+                if (change.operation === 'delete') {
+                    change.modification.vals.forEach(function (v) {
+                        var idx = payload[type].indexOf(v);
+                        if (idx !== -1) {
+                            payload[type].splice(idx, 1);
+                        }
+                    });
+                } else if (change.operation === 'replace') {
+                    payload[type] = change.modification.vals;
+                } else if (change.operation === 'add') {
+                    change.modification.vals.forEach(function (v) {
+                        if (payload[type].indexOf(v) === -1)
+                            payload[type].push(v);
+                    });
+                }
+
+                log.debug({
+                    payload: payload
+                }, 'sdcperson.modify: setting redis payload');
+
                 batch.set(key, JSON.stringify(payload));
             } else if (type === 'login') {
                 log.debug({
diff --git a/test/sdcperson.test.js b/test/sdcperson.test.js
index 410d765..e0fe092 100644
--- a/test/sdcperson.test.js
+++ b/test/sdcperson.test.js
@@ -66,6 +66,9 @@ test('add', function (t) {
             'approved_for_provisioning': [
                 'false'
             ],
+            'allowed_dcs': [
+                'eu-ams-1'
+            ],
             '_salt': [
                 '477ea5c58f134c44598f566f75156c6e790c9be'
             ],
@@ -90,7 +93,8 @@ test('add', function (t) {
         uuid: '1a940615-65e9-4856-95f9-f4c530e86ca4',
         login: 'bcantrill',
         groups: [],
-        approved_for_provisioning: false
+        approved_for_provisioning: false,
+        allowed_dcs: ['eu-ams-1']
     };
 
     transform.add(args, function (err, res) {
@@ -200,7 +204,8 @@ test('modify - irrelevant change', function (t) {
         uuid: '1a940615-65e9-4856-95f9-f4c530e86ca4',
         login: 'bcantrill',
         groups: [],
-        approved_for_provisioning: false
+        approved_for_provisioning: false,
+        allowed_dcs: ['eu-ams-1']
     };
 
     transform.modify(args, function (err, res) {
@@ -294,7 +299,8 @@ test('modify - approved for provisioning', function (t) {
         uuid: '1a940615-65e9-4856-95f9-f4c530e86ca4',
         login: 'bcantrill',
         groups: [],
-        approved_for_provisioning: true
+        approved_for_provisioning: true,
+        allowed_dcs: ['eu-ams-1']
     };
 
     transform.modify(args, function (err, res) {
@@ -391,7 +397,8 @@ test('modify - enable triton cns', function (t) {
         login: 'bcantrill',
         groups: [],
         approved_for_provisioning: true,
-        triton_cns_enabled: true
+        triton_cns_enabled: true,
+        allowed_dcs: ['eu-ams-1']
     };
 
     transform.modify(args, function (err, res) {
@@ -489,7 +496,8 @@ test('modify - rename', function (t) {
         login: 'bmc',
         groups: [],
         approved_for_provisioning: true,
-        triton_cns_enabled: true
+        triton_cns_enabled: true,
+        allowed_dcs: ['eu-ams-1']
     };
 
     transform.modify(args, function (err, res) {
@@ -524,6 +532,118 @@ test('modify - rename', function (t) {
     });
 });
 
+test('modify - changes to allowed_dcs', function (t) {
+    var entry = {
+        'dn': 'changenumber=13, cn=changelog',
+        'controls': [],
+        'targetdn': 'uuid=1a940615-65e9-4856-95f9-f4c530e86ca4, ' +
+            'ou=users, o=smartdc',
+        'changetype': 'modify',
+        'objectclass': 'changeLogEntry',
+        'changetime': '2013-12-11T21:05:03.783Z',
+        'changes': [
+            {
+                'operation': 'add',
+                'modification': {
+                    'type': 'allowed_dcs',
+                    'vals': [
+                        'us-east-3b',
+                        'us-east-3'
+                    ]
+                }
+            },
+            {
+                'operation': 'delete',
+                'modification': {
+                    'type': 'allowed_dcs',
+                    'vals': [
+                        'eu-ams-1'
+                    ]
+                }
+            }
+        ],
+        entry: JSON.stringify({
+            'cn': [
+                'Bryan',
+                'Cantrill'
+            ],
+            'email': [
+                'bcantrill@acm.org'
+            ],
+            'login': [
+                'bcantrill'
+            ],
+            'objectclass': [
+                'sdcperson'
+            ],
+            'userpassword': [
+                '20ce672f319c31eba1cbdea8e5d46b081e1f2506'
+            ],
+            'uuid': [
+                '1a940615-65e9-4856-95f9-f4c530e86ca4'
+            ],
+            '_owner': [
+                '1a940615-65e9-4856-95f9-f4c530e86ca4'
+            ],
+            'pwdchangedtime': [
+                '1386795903462'
+            ],
+            'created_at': [
+                '1386795903462'
+            ],
+            'updated_at': [
+                '1386795903782'
+            ],
+            'approved_for_provisioning': [
+                'true'
+            ],
+            'allowed_dcs': [
+                'us-east-3b',
+                'us-east-3'
+            ],
+            'triton_cns_enabled': [
+                'true'
+            ],
+            '_salt': [
+                '477ea5c58f134c44598f566f75156c6e790c9be'
+            ],
+            '_parent': [
+                'ou=users, o=smartdc'
+            ]
+        }),
+        'changenumber': '13'
+    };
+
+    var args = {
+        changes: entry.changes,
+        entry: entry,
+        modEntry: JSON.parse(entry.entry),
+        log: this.log,
+        redis: REDIS
+    };
+
+    var key = '/uuid/1a940615-65e9-4856-95f9-f4c530e86ca4';
+    var value = {
+        type: 'account',
+        uuid: '1a940615-65e9-4856-95f9-f4c530e86ca4',
+        login: 'bmc',
+        groups: [],
+        approved_for_provisioning: true,
+        allowed_dcs: ['us-east-3b', 'us-east-3'],
+        triton_cns_enabled: true
+    };
+
+    transform.modify(args, function (err, res) {
+        t.strictEqual(3, res.queue.length);
+        res.exec(function () {
+            REDIS.get(key, function (err, res) {
+                t.deepEqual(value, JSON.parse(res));
+                t.done();
+            });
+        });
+    });
+});
+
 test('delete', function (t) {
     var entry = {
         'dn': 'changenumber=14, cn=changelog',
-- 
2.21.0

