From 855466e64239d10643963d520d889d72287f2359 Mon Sep 17 00:00:00 2001
From: Robert Mustacchi <rm@joyent.com>
Date: Fri, 30 Sep 2016 16:44:08 +0000
Subject: [PATCH] OS-5689 illumos#5969 breaks adjuncts build, tools Reviewed
 by: Jerry Jelinek <jerry.jelinek@joyent.com> Reviewed by: Patrick Mooney
 <patrick.mooney@joyent.com> Approved by: Patrick Mooney
 <patrick.mooney@joyent.com>

---
 manifest                                       |  2 ++
 usr/src/Makefile.master                        | 13 ++++++++++---
 usr/src/cmd/mdb/Makefile.common                |  1 +
 usr/src/cmd/mdb/Makefile.module                | 11 ++++++++++-
 usr/src/cmd/mdb/intel/amd64/libpython/Makefile |  2 ++
 usr/src/cmd/mdb/intel/ia32/libpython/Makefile  |  2 +-
 usr/src/cmd/mdb/sparc/v7/libpython/Makefile    |  2 ++
 usr/src/cmd/mdb/sparc/v9/libpython/Makefile    |  2 ++
 8 files changed, 30 insertions(+), 5 deletions(-)

diff --git a/manifest b/manifest
index 5af3b4c715..2ed0ce26c1 100644
--- a/manifest
+++ b/manifest
@@ -9632,6 +9632,7 @@ f usr/lib/mdb/proc/amd64/libc.so 0555 root sys
 f usr/lib/mdb/proc/amd64/libcmdutils.so 0555 root sys
 f usr/lib/mdb/proc/amd64/libnvpair.so 0555 root sys
 f usr/lib/mdb/proc/amd64/libproc.so 0555 root sys
+f usr/lib/mdb/proc/amd64/libpython2.6.so 0555 root sys
 f usr/lib/mdb/proc/amd64/libsysevent.so 0555 root sys
 f usr/lib/mdb/proc/amd64/libtopo.so 0555 root sys
 f usr/lib/mdb/proc/amd64/libumem.so 0555 root sys
@@ -9648,6 +9649,7 @@ f usr/lib/mdb/proc/libc.so 0555 root sys
 f usr/lib/mdb/proc/libcmdutils.so 0555 root sys
 f usr/lib/mdb/proc/libnvpair.so 0555 root sys
 f usr/lib/mdb/proc/libproc.so 0555 root sys
+f usr/lib/mdb/proc/libpython2.6.so 0555 root sys
 f usr/lib/mdb/proc/libsysevent.so 0555 root sys
 f usr/lib/mdb/proc/libtopo.so 0555 root sys
 f usr/lib/mdb/proc/libumem.so 0555 root sys
diff --git a/usr/src/Makefile.master b/usr/src/Makefile.master
index e72c3bfe36..bb137e83f3 100644
--- a/usr/src/Makefile.master
+++ b/usr/src/Makefile.master
@@ -180,7 +180,14 @@ PERL_ARCH =		i86pc-solaris-64int
 $(SPARC_BLD)PERL_ARCH =	sun4-solaris-64int
 PYTHON_VERSION=	2.6
 PYTHON_PKGVERS=	-26
-PYTHON=		/opt/local/bin/python$(PYTHON_VERSION)
+#
+# Until we cross the python flag day, we need to rely on the environment
+# variable to properly help us across. To that end, we purposefully
+# replace this PYTHON definition with the old version, which comes from
+# the environment.
+#
+#PYTHON=		/usr/bin/python$(PYTHON_VERSION)
+PYTHON=		$(PYTHON_26)
 SORT=		/usr/bin/sort
 TOUCH=		/usr/bin/touch
 WC=		/usr/bin/wc
@@ -249,7 +256,7 @@ INS.symlink=	$(RM) $@; $(SYMLINK) $(INSLINKTARGET) $@
 # (.py) file. As a part of this we also go through and change the #!
 # line in the python script to that of the actual python we are using.
 #
-INS.pyfile=	$(RM) $@; $(SED) -e "1s:^\#!@PYTHON@:\#!/usr/bin/python$(PYTHON_VERSION):" < $< > $@; $(CHMOD) $(FILEMODE) $@; $(TOUCH) -r $< $@
+INS.pyfile=	$(RM) $@; $(SED) -e "1s:^\#!@PYTHON@:\#!$(PYTHON):" < $< > $@; $(CHMOD) $(FILEMODE) $@; $(TOUCH) -r $< $@
 
 # MACH must be set in the shell environment per uname -p on the build host
 # More specific architecture variables should be set in lower makefiles.
@@ -1113,7 +1120,7 @@ PKGPUBLISHER_NONREDIST=	on-extra
 	$(CHMOD) +x $@
 
 .py:
-	$(RM) $@; $(SED) -e "1s:^\#!@PYTHON@:\#!/usr/bin/python$(PYTHON_VERSION):" < $< > $@; $(CHMOD) +x $@
+	$(RM) $@; $(SED) -e "1s:^\#!@PYTHON@:\#!$(PYTHON):" < $< > $@; $(CHMOD) +x $@
 
 .py.pyc:
 	$(RM) $@
diff --git a/usr/src/cmd/mdb/Makefile.common b/usr/src/cmd/mdb/Makefile.common
index e77add0c64..142d314b07 100644
--- a/usr/src/cmd/mdb/Makefile.common
+++ b/usr/src/cmd/mdb/Makefile.common
@@ -34,6 +34,7 @@ COMMON_MODULES_PROC = \
 	libfksmbsrv \
 	libnvpair \
 	libproc \
+	libpython \
 	libsysevent \
 	libtopo \
 	libumem \
diff --git a/usr/src/cmd/mdb/Makefile.module b/usr/src/cmd/mdb/Makefile.module
index 0f2b53de37..4478a7ef53 100644
--- a/usr/src/cmd/mdb/Makefile.module
+++ b/usr/src/cmd/mdb/Makefile.module
@@ -101,6 +101,15 @@ LINTFILES_proc		= $(LINTOBJS)
 LINTFILES_raw		= $(LINTOBJS)
 LINTFILES		= $(LINTFILES_$(MDBTGT))
 
+#
+# Python specific flags. To try and make life easier for folks who are
+# building with an LFS python, we attempt to use -isystem when it's
+# available.
+#
+PYCPPFLAGS		= -_gcc=-isystem -_gcc=$(ADJUNCT_PROTO)/usr/include/python$(PYTHON_VERSION)
+PYCPPFLAGS		+= -_cc=-I$(ADJUNCT_PROTO)/usr/include/python$(PYTHON_VERSION)
+
+
 kvm_TGTFLAGS		= -D_KERNEL
 proc_TGTFLAGS		= -D_USER
 
@@ -108,7 +117,7 @@ C99MODE			= $(C99_ENABLE)
 
 CFLAGS			+= $(CCVERBOSE)
 CFLAGS64		+= $(CCVERBOSE)
-CPPFLAGS		+= $($(MDBTGT)_TGTFLAGS) -I../../../common -I/opt/local/include/python$(PYTHON_VERSION)
+CPPFLAGS		+= $($(MDBTGT)_TGTFLAGS) -I../../../common
 LDFLAGS			+= $(ZTEXT)
 LDFLAGS64		+= $(ZTEXT)
 ASFLAGS			+= -P
diff --git a/usr/src/cmd/mdb/intel/amd64/libpython/Makefile b/usr/src/cmd/mdb/intel/amd64/libpython/Makefile
index cd4f4c669f..32191ccfff 100644
--- a/usr/src/cmd/mdb/intel/amd64/libpython/Makefile
+++ b/usr/src/cmd/mdb/intel/amd64/libpython/Makefile
@@ -38,6 +38,8 @@ include ../../../../Makefile.cmd.64
 include ../../Makefile.amd64
 include ../../../Makefile.module
 
+CPPFLAGS += $(PYCPPFLAGS)
+
 dmod/$(MODULE) := LDLIBS += -lproc
 
 %.o: $(MODSRCS_DIR)/%.c
diff --git a/usr/src/cmd/mdb/intel/ia32/libpython/Makefile b/usr/src/cmd/mdb/intel/ia32/libpython/Makefile
index 2abfe7acb6..8aa021ee94 100644
--- a/usr/src/cmd/mdb/intel/ia32/libpython/Makefile
+++ b/usr/src/cmd/mdb/intel/ia32/libpython/Makefile
@@ -37,7 +37,7 @@ include ../../../../Makefile.cmd
 include ../../Makefile.ia32
 include ../../../Makefile.module
 
-%.o := CPPFLAGS +=	-_gcc=-isystem -_gcc=$(ADJUNCT_PROTO)/usr/include
+CPPFLAGS += $(PYCPPFLAGS)
 
 dmod/$(MODULE) := LDLIBS += -lproc
 
diff --git a/usr/src/cmd/mdb/sparc/v7/libpython/Makefile b/usr/src/cmd/mdb/sparc/v7/libpython/Makefile
index f0c2120e4f..c826cb2ca1 100644
--- a/usr/src/cmd/mdb/sparc/v7/libpython/Makefile
+++ b/usr/src/cmd/mdb/sparc/v7/libpython/Makefile
@@ -37,6 +37,8 @@ include ../../../../Makefile.cmd
 include ../../Makefile.sparcv7
 include ../../../Makefile.module
 
+CPPFLAGS += $(PYCPPFLAGS)
+
 dmod/$(MODULE) := LDLIBS += -lproc
 
 %.o: $(MODSRCS_DIR)/%.c
diff --git a/usr/src/cmd/mdb/sparc/v9/libpython/Makefile b/usr/src/cmd/mdb/sparc/v9/libpython/Makefile
index cb3d7a78b8..458053206f 100644
--- a/usr/src/cmd/mdb/sparc/v9/libpython/Makefile
+++ b/usr/src/cmd/mdb/sparc/v9/libpython/Makefile
@@ -38,6 +38,8 @@ include ../../../../Makefile.cmd.64
 include ../../Makefile.sparcv9
 include ../../../Makefile.module
 
+CPPFLAGS += $(PYCPPFLAGS)
+
 dmod/$(MODULE) := LDLIBS += -lproc
 
 %.o: $(MODSRCS_DIR)/%.c
-- 
2.21.0

