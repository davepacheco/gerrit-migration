From fdf0ad0ca30cc1d993cff5f6d4febe8d58f69fef Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 28 Feb 2018 17:16:00 +0000
Subject: [PATCH] OS-6695 bhyve failed to pack nvlist

---
 usr/src/lib/brand/bhyve/zone/boot.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/usr/src/lib/brand/bhyve/zone/boot.c b/usr/src/lib/brand/bhyve/zone/boot.c
index efbff6a32f..88641d567a 100644
--- a/usr/src/lib/brand/bhyve/zone/boot.c
+++ b/usr/src/lib/brand/bhyve/zone/boot.c
@@ -385,7 +385,7 @@ init_debug(void)
 int
 main(int argc, char **argv)
 {
-	int fd;
+	int fd, err;
 	char *zhargv[ZH_MAXARGS] = {
 		"zhyve",	/* Squats on argv[0] */
 		"-H",		/* vmexit on halt isns */
@@ -393,8 +393,8 @@ main(int argc, char **argv)
 		NULL };
 	int zhargc;
 	nvlist_t *nvl;
-	char *nvbuf;
-	size_t nvbuflen;
+	char *nvbuf = NULL;
+	size_t nvbuflen = 0;
 	char zoneroot[MAXPATHLEN];
 	int zrfd;
 	char *zonename;
@@ -441,8 +441,10 @@ main(int argc, char **argv)
 		nvlist_print(stdout, nvl);
 	}
 
-	if (nvlist_pack(nvl, &nvbuf, &nvbuflen, NV_ENCODE_XDR, 0) != 0) {
-		(void) printf("Error: failed to pack nvlist\n");
+	err = nvlist_pack(nvl, &nvbuf, &nvbuflen, NV_ENCODE_XDR, 0);
+	if (err != 0) {
+		(void) printf("Error: failed to pack nvlist: %s\n",
+		    strerror(err));
 		return (1);
 	}
 
-- 
2.21.0

