{"project":"joyent/sdc-vmapi","branch":"master","id":"I64192456fa44660a92661766410d3ff4ed0d5480","number":"6233","subject":"TRITON-1663 vmapi can accidentally return 200 and close the connection on some validation errors (part 1, fix two incorrect uses of invalidParamErr) Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/6233","commitMessage":"TRITON-1663 vmapi can accidentally return 200 and close the connection on some validation errors (part 1, fix two incorrect uses of invalidParamErr)\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1557525377,"lastUpdated":1557529266,"open":false,"status":"MERGED","comments":[{"timestamp":1557525377,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1557525379,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 647ed2c1628926980f28a3209b45fc63140eef8a\n    \n    proposed change 1: just fixing the two problem spots"},{"timestamp":1557525414,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557525538,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1557525931,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(2 comments)\n\nmissing package.json version update?"},{"timestamp":1557527588,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1557527715,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1557527716,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 23932111446c73a4f6cab5c33bc302aac31842d8\n    \n    correct error from CR feedback"},{"timestamp":1557527751,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557528067,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nI don\u0027t really like the pattern of continuing on fatal errors. But I guess in this case it doesn\u0027t cause anything more than possibly extra useless errors until someone changes this code. Then it\u0027ll be their fault. :)\n\n¯\\_(ツ)_/¯"},{"timestamp":1557529242,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1557529266,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"4","revision":"64192456fa44660a92661766410d3ff4ed0d5480","parents":["1adcbdc137e0ad0f8b0e6a7c4d35fdcae83e5778"],"ref":"refs/changes/33/6233/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1557529242,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557527751,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557528067,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557528067,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1557529266,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":15,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"f5194ab333ceef4707d3ae9a65649f324c9b3592","parents":["1adcbdc137e0ad0f8b0e6a7c4d35fdcae83e5778"],"ref":"refs/changes/33/6233/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1557525377,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557525414,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":15,"deletions":-7}],"sizeInsertions":15,"sizeDeletions":-7},{"number":"2","revision":"d5459de299fce144837aa9ed09d07074ef1f0dc1","parents":["1adcbdc137e0ad0f8b0e6a7c4d35fdcae83e5778"],"ref":"refs/changes/33/6233/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1557525538,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557525414,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common/validation.js","line":1088,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Why was the return removed here? It seems like it\u0027s still a good idea to do:\n\n    callback();\n    return;\n\n\n?"},{"file":"lib/common/validation.js","line":1088,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The intent of the validation function is to capture any and all validation errors. There could be more below. By falling through we allow the validation error returned to the client to include details about the brand being bad, perhaps the package cpu_shares being bogus and others."},{"file":"lib/common/validation.js","line":1127,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This is missing a call to callback() before the return."},{"file":"lib/common/validation.js","line":1127,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh, sorry. Thanks for catching. I had intended to drop the return."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":15,"deletions":-7}],"sizeInsertions":15,"sizeDeletions":-7},{"number":"3","revision":"95a540675771ff7a4be6a282cb68a66054383b5c","parents":["1adcbdc137e0ad0f8b0e6a7c4d35fdcae83e5778"],"ref":"refs/changes/33/6233/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1557527715,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557527751,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557528067,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557528067,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":15,"sizeDeletions":-8},{"number":"4","revision":"64192456fa44660a92661766410d3ff4ed0d5480","parents":["1adcbdc137e0ad0f8b0e6a7c4d35fdcae83e5778"],"ref":"refs/changes/33/6233/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1557529242,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557527751,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1557529266,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557528067,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557528067,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":15,"sizeDeletions":-8}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}