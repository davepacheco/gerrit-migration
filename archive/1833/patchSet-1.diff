commit a47741d2fea35f38d010fe6c54188894f4f1e1c7 (refs/changes/33/1833/1)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2017-04-24T15:49:35-07:00 (2 years, 5 months ago)
    
    joyent/node-cueball#109 Agent "health check ok" log msg needs domain name of pool

diff --git a/lib/agent.js b/lib/agent.js
index 74e1d07..d94d972 100644
--- a/lib/agent.js
+++ b/lib/agent.js
@@ -336,6 +336,13 @@ CueBallAgent.prototype.addRequest = function (req, optionsOrHost, port) {
 
 CueBallAgent.prototype.checkSocket = function (host, handle, socket) {
 	var self = this;
+	var t1 = new Date();
+	var log = handle.ch_slot.makeChildLogger({
+		component: 'CueBallAgent',
+		domain: host,
+		localPort: socket.localPort,
+		path: this.cba_ping
+	});
 	var agent = new PingAgent({
 		protocol: this.protocol,
 		socket: socket,
@@ -358,16 +365,29 @@ CueBallAgent.prototype.checkSocket = function (host, handle, socket) {
 		});
 		res.on('end', function () {
 			if (res.statusCode >= 500 && res.statusCode < 600) {
-				self.log.warn('got a 500, closing');
+				var t2 = new Date();
+				log.warn({
+					statusCode: res.statusCode,
+					latency: (t2.getTime() - t1.getTime())
+				}, 'got a 5xx code, closing');
 				handle.close();
 			} else {
-				self.log.debug('health check ok, releasing');
+				log.debug({
+					statusCode: res.statusCode
+				}, 'health check ok, releasing');
 				handle.release();
 			}
 		});
 	});
 	req.once('error', function (e) {
-		self.log.warn(e, 'check failed');
+		var t2 = new Date();
+		log.warn(e, {
+			err: {
+				name: e.name, stack: e.stack,
+				message: e.message
+			},
+			latency: (t2.getTime() - t1.getTime())
+		}, 'check failed');
 		handle.close();
 	});
 	req.end();
