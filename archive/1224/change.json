{"project":"joyent/illumos-joyent","branch":"master","id":"Ib9c647a9c13d987816a1d4cd2f9a21512d559949","number":"1224","subject":"OS-5773 lxbrand wants FUTEX_LOCK_PI Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1224","commitMessage":"OS-5773 lxbrand wants FUTEX_LOCK_PI\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1483749074,"lastUpdated":1484849971,"open":false,"status":"MERGED","comments":[{"timestamp":1483749074,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1483750253,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1483750276,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nRemoved my testing DTrace probes"},{"timestamp":1483818999,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nNote that this is an initial set of code so that I can get high-level feedback on the overall approach. I still have more testing to do."},{"timestamp":1484083567,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1484083608,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nSome minor changes I made for the new tests I wrote. Should be ready for detailed review now."},{"timestamp":1484094748,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1484094777,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nWorkaround for gcc clobber error."},{"timestamp":1484149212,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1484149244,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\nFixed trylock and changed behavior for non-branded process."},{"timestamp":1484155709,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(8 comments)"},{"timestamp":1484162709,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(8 comments)"},{"timestamp":1484164298,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1484176330,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6."},{"timestamp":1484236166,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7."},{"timestamp":1484236217,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 7:\n\nWrote another test for error cleanup and found the previous patch was slightly incorrect. This patch fixes that error."},{"timestamp":1484252958,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 8."},{"timestamp":1484253002,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8:\n\nI was working on my test suite and found a bug in the lock_pi timeout handling."},{"timestamp":1484255301,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8: Code-Review+1\n\n(5 comments)\n\nI\u0027ve attached a few nits.  Overall it looks good."},{"timestamp":1484257129,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1484328218,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 8:\n\n(4 comments)\n\nLooks good, modulo some nits and questions."},{"timestamp":1484329837,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1484331696,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 9."},{"timestamp":1484331841,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1484341133,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1484342978,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 10."},{"timestamp":1484343171,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 10: Code-Review+1\n\nNice work, Jerry."},{"timestamp":1484847180,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 10: Code-Review+1\n\nLooks great -- thanks!"},{"timestamp":1484848296,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 10: Integration-Approval+1\n\nNice job getting this across the line, Jerry."},{"timestamp":1484849774,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 11: Patch Set 10 was rebased."},{"timestamp":1484849906,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 12: Commit message was updated."},{"timestamp":1484849971,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"12","revision":"b9c647a9c13d987816a1d4cd2f9a21512d559949","parents":["4e5e4787d8d8826f2b1ded04508027e9297e003b"],"ref":"refs/changes/24/1224/12","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484849906,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484343171,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484847180,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484848296,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1484849971,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":627,"deletions":-30}],"sizeInsertions":631,"sizeDeletions":-31},"patchSets":[{"number":"1","revision":"dbbea864798f0c39c5567dfc2659d178ba7ffbb7","parents":["3bf32d20a3f6b8bfaabf39e2ef539e46e311e973"],"ref":"refs/changes/24/1224/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1483749074,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":538,"deletions":-29}],"sizeInsertions":542,"sizeDeletions":-30},{"number":"2","revision":"0dc914c43baf2976c539d202241990d2768f87b0","parents":["3bf32d20a3f6b8bfaabf39e2ef539e46e311e973"],"ref":"refs/changes/24/1224/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1483750253,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":535,"deletions":-29}],"sizeInsertions":539,"sizeDeletions":-30},{"number":"3","revision":"3c0db9b2c4ebadb5bbd04e7bb578e073cdc9b3fe","parents":["a20de2b86d0939a58dfb2f51057f86b1cbbdc7e3"],"ref":"refs/changes/24/1224/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484083567,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1155,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"For the un-owned unlock case, I think it might be prudent to pass the ftid value through, rather than just a B_FALSE for must_own.  This prevents a potential race where some thread is able to unlock and acquire the futex between when trylock_pi has queried the value initially and when it goes to attempt the un-owned unlock."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1155,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Good point, I will fix this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":545,"deletions":-29}],"sizeInsertions":549,"sizeDeletions":-30},{"number":"4","revision":"2d435d4a3012287aad202fea3e27752ce70648dc","parents":["a20de2b86d0939a58dfb2f51057f86b1cbbdc7e3"],"ref":"refs/changes/24/1224/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484094748,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":548,"deletions":-29}],"sizeInsertions":552,"sizeDeletions":-30},{"number":"5","revision":"48ac59b2976bfd280e215179a3ab6e27d261e61c","parents":["a20de2b86d0939a58dfb2f51057f86b1cbbdc7e3"],"ref":"refs/changes/24/1224/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484149212,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":308,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"More explanation might be nice here.  If we\u0027re deriving it from FSS_MAXUPRI, it might be nice to perform the calculation here rather than a raw value."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":308,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will add some explanation"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":471,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Instead of returning -1 and doing all the set_errno manipulation here, perhaps this could just return the error and let downstream consumers deal with it?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":471,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I can fix this. It is actually a bug in the existing code which I noticed while working on the PI changes and unrelated to PI."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":599,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"In context, \"invalid waiter\" seems a little confusing as a term to use here.  It\u0027s just a PI waiter queued on the futex which, for the purposes of a WAKE_OP is not valid for consideration, right?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":599,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will reword the comment since it is invalid to mix PI and non-PI usage on the same futex."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":913,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is PRLOCK necessary to acquire here?  I suspect that portion of the lpid_lock can be skipped."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":913,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Good point, fixed throughout."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":925,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m not sure it\u0027s legal from a deadlock-avoidance perspective to acquire another p_lock while already holding the one for fproc.  Perhaps this would be OK if the priority values for curthread/curproc were gathered before looking-up/locking fproc?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":925,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I restructured this to get mypri first."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":966,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Are there much in the way of circumstances where we expect this to loop?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":966,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"No, that is a good point. I will fix this."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":966,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Actually, it looks like I need to keep the loop to handle the spurious wakeup case."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1168,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Like above, is PRLOCK necessary here?  I would assume just a lookup (along with p_lock) would be adequate?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1168,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":563,"deletions":-29}],"sizeInsertions":567,"sizeDeletions":-30},{"number":"6","revision":"a4d53cbd3af4af6d5721d2d1e52033e0e2e679c2","parents":["0c4959f576fd0569de9fb1c72946987be101e7a0"],"ref":"refs/changes/24/1224/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484176330,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":600,"deletions":-27}],"sizeInsertions":604,"sizeDeletions":-28},{"number":"7","revision":"0bdab5865d5d60112579b1dcc540e6d44cbe28e1","parents":["0c4959f576fd0569de9fb1c72946987be101e7a0"],"ref":"refs/changes/24/1224/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484236166,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":608,"deletions":-27}],"sizeInsertions":612,"sizeDeletions":-28},{"number":"8","revision":"d760eb27b680742a0b6d1d2c4c0962b6514097c9","parents":["0c4959f576fd0569de9fb1c72946987be101e7a0"],"ref":"refs/changes/24/1224/8","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484252958,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484255301,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":211,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Omit the \"the\" in user-land?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":314,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe use INT_MIN here?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":924,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"What if the owner has dropped the lock and exited? Don\u0027t we want to not return ESRCH in this case, but rather re-attempt to acquire the lock?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":924,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"No, that would be a violation of the futex usage. Because we already atomically set the waiters bit while the owner held the lock, the owner must call futex_unlock, but that will block because we hold our internal fh_lock mutex. Thus, the owner cannot drop the lock."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":924,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I think what would make sense here is to set the FUTEX_OWNER_DIED bit. Normally we handle that elsewhere in our robust mutex handling code but I punted on non-robust mutexes which exit while holding the futex. Setting the DIED bit will let the caller know that cleanup is needed even for the non-robust case."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":938,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Does this handle the case where the holder of a lock has been bumped by two different waiters?  Or do we simply discard the second bump in this case?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":938,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Yes, it handles multiple bumps. The priority bump happens at line 944. All we do at line 941 is record the original priority so we can reset it back. The fw_pri_up check at 940 ensures we don\u0027t lose track of the original priority."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1014,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why the \u00270 |\u0027? (similarly cited below)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1014,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I just thought it was a little more explicit that we\u0027re setting the tid field to zero here, but its obviously unnecessary, and I can remove this in the two places I did it if it seems jarring instead of helpful."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1134,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: This sentence doesn\u0027t seem to parse very clearly."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1145,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any particular reason for ORing against 0?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1146,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Style nit: I lean toward bracing if-statements which require continuation for the test body"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":1398,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Nit, but I would rather \"break\" on MEMID_EQUAL() and then put the logic below in the main line of the function -- it makes it clearer that the logic to unlock or hashout a futex will only happen once, and not as part of a loop.  I know that the other users of this don\u0027t do it that way, but I didn\u0027t write those. ;)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":617,"deletions":-30}],"sizeInsertions":621,"sizeDeletions":-31},{"number":"9","revision":"d87c68f09c7bda12f6fc2cdb80ba0835e51ab954","parents":["89604c6d5bf9b0d8361322d21c4aa656db64c425"],"ref":"refs/changes/24/1224/9","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484331696,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","line":928,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps just make this \u0027if (!on_fault()) { cas(...); no_fault() }\u0027 instead of duplicating the bail-out."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":630,"deletions":-30}],"sizeInsertions":634,"sizeDeletions":-31},{"number":"10","revision":"4f9a8c79fa734b1bcdc3d62b8cdc5d0da82b34ff","parents":["89604c6d5bf9b0d8361322d21c4aa656db64c425"],"ref":"refs/changes/24/1224/10","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484342978,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484847180,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484343171,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484848296,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":627,"deletions":-30}],"sizeInsertions":631,"sizeDeletions":-31},{"number":"11","revision":"ae5170482bd827ad3cd829e760584a2bd67330d6","parents":["4e5e4787d8d8826f2b1ded04508027e9297e003b"],"ref":"refs/changes/24/1224/11","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484849774,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484847180,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484343171,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484848296,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":627,"deletions":-30}],"sizeInsertions":631,"sizeDeletions":-31},{"number":"12","revision":"b9c647a9c13d987816a1d4cd2f9a21512d559949","parents":["4e5e4787d8d8826f2b1ded04508027e9297e003b"],"ref":"refs/changes/24/1224/12","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484849906,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484847180,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"SUBM","value":"1","grantedOn":1484849971,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484343171,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484848296,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_futex.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/syscall/lx_futex.c","type":"MODIFIED","insertions":627,"deletions":-30}],"sizeInsertions":631,"sizeDeletions":-31}],"allReviewers":[{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}