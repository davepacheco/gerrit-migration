From 33f92765803bccd789066ef73fd13ba9fece61ad Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Thu, 25 Jan 2018 16:35:21 -0800
Subject: [PATCH] CNAPI-733 Add error for when cn-agent indicates docker cp'ing
 is not supported on a stopped container

---
 lib/endpoints/vms.js |  8 ++++++++
 lib/errors.js        | 24 +++++++++++++++++++++++-
 package.json         |  2 +-
 3 files changed, 32 insertions(+), 2 deletions(-)

diff --git a/lib/endpoints/vms.js b/lib/endpoints/vms.js
index 3ba821e..96aa5fd 100644
--- a/lib/endpoints/vms.js
+++ b/lib/endpoints/vms.js
@@ -1053,6 +1053,14 @@ VM.dockerCopy = function handlerVmDockerCopy(req, res, next) {
                 return;
             }
 
+            if (details.restCode ===
+                    'DockerCopyStoppedContainerNoPlatformSupport')
+            {
+                next(new
+                    errors.DockerCopyStoppedContainerNoPlatformSupportError());
+                return;
+            }
+
             next(new restify.InternalError(error.message));
             return;
         }
diff --git a/lib/errors.js b/lib/errors.js
index 0b83716..65a1779 100644
--- a/lib/errors.js
+++ b/lib/errors.js
@@ -210,6 +210,26 @@ FileNotFoundError.restCode = 'FileNotFound';
 FileNotFoundError.statusCode = 404;
 FileNotFoundError.description = 'could not find requested file';
 
+function DockerCopyStoppedContainerNoPlatformSupportError() {
+    _CnapiBaseError.call(this, {
+        restCode: this.constructor.restCode,
+        statusCode: this.constructor.statusCode,
+        message:
+            '"docker copy" on stopped container not supported on this joyent'
+            + ' platform version'});
+}
+
+util.inherits(
+    DockerCopyStoppedContainerNoPlatformSupportError, _CnapiBaseError);
+DockerCopyStoppedContainerNoPlatformSupportError.prototype.name =
+    'DockerCopyStoppedContainerNoPlatformSupportError';
+DockerCopyStoppedContainerNoPlatformSupportError.restCode =
+    'DockerCopyStoppedContainerNoPlatformSupport';
+DockerCopyStoppedContainerNoPlatformSupportError.statusCode = 409;
+DockerCopyStoppedContainerNoPlatformSupportError.description =
+    '"docker copy" on stopped container not supported on this joyent'
+    + ' platform version';
+
 
 function PathNotDirectoryError() {
     _CnapiBaseError.call(this, {
@@ -244,5 +264,7 @@ module.exports = {
     VmNotRunningError: VmNotRunningError,
     ServerNotRunningError: ServerNotRunningError,
     FileNotFoundError: FileNotFoundError,
-    PathNotDirectoryError: PathNotDirectoryError
+    PathNotDirectoryError: PathNotDirectoryError,
+    DockerCopyStoppedContainerNoPlatformSupportError:
+        DockerCopyStoppedContainerNoPlatformSupportError
 };
diff --git a/package.json b/package.json
index ebfc4dd..deadcfe 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.5.1",
+  "version": "1.5.2",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

