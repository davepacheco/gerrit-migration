{"project":"joyent/node-workflow","branch":"master","id":"Ifcbd66058d290fa8284a25bda854ff8743478b4f","number":"4837","subject":"TRITON-769 wf-runner is crashing in metrics calc on jobs that fail with \"workflow timeout\" Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/4837","commitMessage":"TRITON-769 wf-runner is crashing in metrics calc on jobs that fail with \"workflow timeout\"\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1536863539,"lastUpdated":1539613796,"open":false,"status":"MERGED","comments":[{"timestamp":1536863539,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1536863591,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536949526,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)\n\nPedro,\n\nHave you tested this with a workflow that times out?"},{"timestamp":1537378297,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n\u003e (1 comment)\n \u003e \n \u003e Pedro,\n \u003e \n \u003e Have you tested this with a workflow that times out?\n\nYes, I did. But I\u0027m thinking it\u0027ll be much better to add such a timing out workflow to the test suite so we get notified of similar problems in the future"},{"timestamp":1537814718,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1537814749,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1537815638,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nDone as suggested, added new tests, fixed some failing ones:\n\nhearth: node-workflow(grr-TRITON-769) pedropc$ make test\n/usr/local/node/v6.10.3/bin/npm install\nTAP_TIMEOUT\u003d80 TEST_CONFIG_FILE\u003dconfig.nofork.sample ./node_modules/.bin/tap test/runner.test.js\nok test/runner.test.js .............................. 110/110\ntotal ............................................... 110/110\n\nok\nTAP_TIMEOUT\u003d80 ./node_modules/.bin/tap test/*.test.js\nok test/api.test.js ................................. 182/182\nok test/child.test.js ................................. 26/26\nok test/errors.test.js ................................ 23/23\nok test/in-memory-backend.test.js ................... 159/159\nok test/job-runner.test.js .......................... 149/149\nok test/runner.test.js .............................. 110/110\nok test/task-runner.test.js ......................... 147/147\ntotal ............................................... 796/796\n\nok"},{"timestamp":1539217667,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1539613757,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1539613796,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"3","revision":"fcbd66058d290fa8284a25bda854ff8743478b4f","parents":["66094bebac80fe239de82e5b2dd6ad86c1bf7d0a"],"ref":"refs/changes/37/4837/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1539613757,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537814749,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539217667,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539217667,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1539613796,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/job-runner.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/runner.js","type":"MODIFIED","insertions":14,"deletions":-7},{"file":"test/runner.test.js","type":"MODIFIED","insertions":253,"deletions":-160}],"sizeInsertions":273,"sizeDeletions":-171},"patchSets":[{"number":"1","revision":"629d590402b9a6d8ca2eca2a583a165b2e0dbbf1","parents":["66094bebac80fe239de82e5b2dd6ad86c1bf7d0a"],"ref":"refs/changes/37/4837/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1536863539,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536863591,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/runner.js","line":175,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"perhaps also guard against `result.finished_at` being undefined?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/job-runner.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/runner.js","type":"MODIFIED","insertions":12,"deletions":-7}],"sizeInsertions":16,"sizeDeletions":-9},{"number":"2","revision":"ca5923672144ee520f765135e578a5dd6d5fde19","parents":["66094bebac80fe239de82e5b2dd6ad86c1bf7d0a"],"ref":"refs/changes/37/4837/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1537814718,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537814749,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539217667,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539217667,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"test/runner.test.js","line":174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"package.json still says:\n\n```\n    \"engines\": {\n        \"node\": \"\u003e\u003d0.10.0\"\n    }\n```\n\nCan `const` be used with node 0.10?\n\nAnswer: yup, but it doesn\u0027t guard on const. /shrug\n\n```\n\u003e process.version\n\u0027v0.10.48\u0027\n\u003e const foo \u003d 42;\nundefined\n\u003e foo\n42\n\u003e foo +\u003d1\n43\n```"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/job-runner.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/runner.js","type":"MODIFIED","insertions":14,"deletions":-7},{"file":"test/runner.test.js","type":"MODIFIED","insertions":253,"deletions":-160}],"sizeInsertions":273,"sizeDeletions":-171},{"number":"3","revision":"fcbd66058d290fa8284a25bda854ff8743478b4f","parents":["66094bebac80fe239de82e5b2dd6ad86c1bf7d0a"],"ref":"refs/changes/37/4837/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1539613757,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1537814749,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539217667,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539217667,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1539613796,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/job-runner.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/runner.js","type":"MODIFIED","insertions":14,"deletions":-7},{"file":"test/runner.test.js","type":"MODIFIED","insertions":253,"deletions":-160}],"sizeInsertions":273,"sizeDeletions":-171}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}