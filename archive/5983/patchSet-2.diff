From d84112e2e55618bbf791e2db495976a49eee6ff7 Mon Sep 17 00:00:00 2001
From: Chris Burroughs <chris.burroughs@joyent.com>
Date: Wed, 20 Mar 2019 20:03:39 +0000
Subject: [PATCH] TOOLS-2205 sdcnode could be more upfront about gcc versions
 Reviewed by: Trent Mick <trentm@gmail.com> Approved by: Trent Mick
 <trentm@gmail.com>

---
 nodeconfigs.json   | 70 ++++++++++++++++++++++++++++++++++++----------
 tools/build-a-node | 30 ++++++++++++--------
 2 files changed, 74 insertions(+), 26 deletions(-)

diff --git a/nodeconfigs.json b/nodeconfigs.json
index bf8661f..2868b38 100644
--- a/nodeconfigs.json
+++ b/nodeconfigs.json
@@ -8,7 +8,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -23,6 +23,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -35,6 +36,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
 
@@ -47,7 +49,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -62,6 +64,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -74,6 +77,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
 
@@ -87,6 +91,7 @@
             "patches/tls-reload-certs-v8.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
 
@@ -99,7 +104,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -114,6 +119,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -126,6 +132,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -136,7 +143,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -150,6 +157,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -161,6 +169,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -172,7 +181,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -187,6 +196,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -199,6 +209,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -209,7 +220,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -223,6 +234,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -234,6 +246,7 @@
             "patches/tls-reload-certs-v6.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -244,7 +257,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -258,6 +271,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -269,6 +283,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -279,7 +294,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -293,6 +308,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -304,6 +320,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -314,7 +331,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -328,6 +345,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -339,6 +357,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -349,7 +368,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -363,6 +382,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -374,6 +394,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -384,7 +405,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -398,6 +419,7 @@
         ],
         "version": "v4.6.1",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -408,7 +430,7 @@
             "patches/tls-reload-certs-v4.x.patch"
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -422,6 +444,7 @@
         ],
         "version": "v4.6.1",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -430,6 +453,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.12.17",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -438,6 +462,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.12.17",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -446,6 +471,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib.",
         "version": "v0.12.14",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace --shared-zlib --shared-zlib-includes=/opt/local/include --shared-zlib-libpath=/opt/local/lib",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_env": "LDFLAGS=\"-L/opt/local/lib -R/opt/local/lib\"",
         "build_tag": "zone"
     },
@@ -456,6 +482,7 @@
         "version": "v0.12.14",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
         "FUTURE_configure_flags": "--without-snapshot --with-dtrace --openssl-use-sys --openssl-libpath=/lib --openssl-includes=??? --shared-zlib --shared-zlib-libpath=/lib --shared-zlib-includes=???",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "gz"
     },
     {
@@ -464,6 +491,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.12.9",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -472,6 +500,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.12.9",
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -480,6 +509,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib.",
         "version": "v0.12.9",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace --shared-zlib --shared-zlib-includes=/opt/local/include --shared-zlib-libpath=/opt/local/lib",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_env": "LDFLAGS=\"-L/opt/local/lib -R/opt/local/lib\"",
         "build_tag": "zone"
     },
@@ -490,6 +520,7 @@
         "version": "v0.12.9",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
         "FUTURE_configure_flags": "--without-snapshot --with-dtrace --openssl-use-sys --openssl-libpath=/lib --openssl-includes=??? --shared-zlib --shared-zlib-libpath=/lib --shared-zlib-includes=???",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "gz"
     },
     {
@@ -497,7 +528,8 @@
         "image": "1ad363ec-3b83-11e8-8521-2f68a4a34d5d",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -507,7 +539,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
-        "gcc_version_prefix": "4.9.",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -518,6 +550,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -526,6 +559,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -534,6 +568,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -542,6 +577,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=x64 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone64"
     },
     {
@@ -550,6 +586,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib.",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace --shared-zlib --shared-zlib-includes=/opt/local/include --shared-zlib-libpath=/opt/local/lib",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_env": "LDFLAGS=\"-L/opt/local/lib -R/opt/local/lib\"",
         "build_tag": "zone"
     },
@@ -560,6 +597,7 @@
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
         "FUTURE_configure_flags": "--without-snapshot --with-dtrace --openssl-use-sys --openssl-libpath=/lib --openssl-includes=??? --shared-zlib --shared-zlib-libpath=/lib --shared-zlib-includes=???",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "gz"
     },
     {
@@ -568,6 +606,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib.",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace --shared-zlib --shared-zlib-includes=/opt/local/include --shared-zlib-libpath=/opt/local/lib",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_env": "LDFLAGS=\"-L/opt/local/lib -R/opt/local/lib\"",
         "build_tag": "zone"
     },
@@ -577,6 +616,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -585,6 +625,7 @@
         "comment": "For use by services running in zones. Dynamically link to pkgsrc's openssl and zlib?",
         "version": "v0.10.48",
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "zone"
     },
     {
@@ -599,6 +640,7 @@
         ],
         "configure_flags": "--without-snapshot --dest-cpu=ia32 --with-dtrace",
         "FUTURE_configure_flags": "--without-snapshot --with-dtrace --openssl-use-sys --openssl-libpath=/lib --openssl-includes=??? --shared-zlib --shared-zlib-libpath=/lib --shared-zlib-includes=???",
+        "gcc": "/opt/local/gcc49/bin/gcc",
         "build_tag": "gz",
         "// users": "sdc-amon"
     }
diff --git a/tools/build-a-node b/tools/build-a-node
index c7c606a..c663d39 100755
--- a/tools/build-a-node
+++ b/tools/build-a-node
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2017, Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 #
@@ -27,8 +27,7 @@
 # - configure_flags:
 # - build_env: Environment vars to pass to the `make` command to build node
 # - build_tag:
-# - gcc_version_prefix: A string prefix to compare against the GCC version used
-#   to build node
+# - gcc: Path to the gcc binary to use.
 # - rpath: A string to which to set the node RPATH/RUNPATH.
 # - include_gcc_runtime_libs: Include the needed libs from the GCC runtime
 #   (/opt/local/lib/gcc$major$minor/...) that are used by the built node.
@@ -62,15 +61,22 @@ echo ""
 echo "# Build a node in $buildDir with this config:"
 echo "$buildOpts" | json
 
-# Ensure we have a particular gcc version.
-gccVersionPrefix=$(echo "${buildOpts}" | json gcc_version_prefix)
-if [[ -n "${gccVersionPrefix}" ]]; then
-    currGccVer=$(${GCC} --version | head -1 | awk '{print $NF}')
-    if [[ ${currGccVer} != ${gccVersionPrefix}* ]]; then
-        echo "build-a-node: fatal error: gcc version (${currGccVer}) does not" \
-            "match the given prefix: ${gccVersionPrefix}" >&2
-        exit 1
-    fi
+
+GCC=$(echo "${buildOpts}" | json gcc)
+if [[ -z "$GCC" ]]; then
+    echo "build-a-node: path to gcc must be explicit" >&2
+    exit 1
+fi
+GXX="${GCC%/*}/g++"
+
+if [ ! -f ${GCC} ]; then
+    echo "gcc: file ${GCC} not found"
+    exit 1
+fi
+
+if [ ! -f ${GXX} ]; then
+    echo "g++: file ${GXX} not found"
+    exit 1
 fi
 
 if [[ -d $buildDir ]]; then
-- 
2.21.0

