From feefa41eea312c2ef1f039532223749353a22c95 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Mon, 13 Aug 2018 14:57:56 +0000
Subject: [PATCH] OS-7117 deliver uefi-rom.bin for bhyve

---
 uefi-edk2/Makefile | 36 ++++++++++++++++++++++++++++++------
 1 file changed, 30 insertions(+), 6 deletions(-)

diff --git a/uefi-edk2/Makefile b/uefi-edk2/Makefile
index 49af187..9d5bee3 100644
--- a/uefi-edk2/Makefile
+++ b/uefi-edk2/Makefile
@@ -34,8 +34,13 @@ MAKE_ARGS+=	AS=$(STRAPPROTO)/usr/gnu/bin/gas \
 ARCH=		X64
 UEFI_TARGET=	RELEASE
 
+ROMS=		uefi uefi-csm
 
-all: $(VER.64)/$(UNPACK_SENTINEL)
+.NOTPARALLEL: $(ROMS) csm16
+
+all: $(ROMS)
+
+basetools: $(VER.64)/$(UNPACK_SENTINEL)
 	mkdir -p $(VER.64)/Build
 	ln -sf $(STRAPPROTO)/usr/bin/gcc $(VER.64)/Build/gcc
 	ln -sf $(STRAPPROTO)/usr/gnu/bin/gld $(VER.64)/Build/ld
@@ -44,11 +49,30 @@ all: $(VER.64)/$(UNPACK_SENTINEL)
 	ln -sf $(STRAPPROTO)/usr/gnu/bin/gobjcopy $(VER.64)/Build/objcopy
 	ln -sf /opt/local/bin/nasm $(VER.64)/Build/nasm
 	$(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C $(VER.64)/BaseTools
-	bash -c "cd $(VER.64); source edksetup.sh; $(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C BhyvePkg/Csm/BhyveCsm16"
-	bash -c "cd $(VER.64); source edksetup.sh; export ILGCC_BIN=$(PWD)/$(VER.64)/Build/; build -t ILGCC -a $(ARCH) -b $(UEFI_TARGET) -p BhyvePkg/BhyvePkgX64.dsc -DDEBUG_ON_SERIAL_PORT=TRUE -DFD_SIZE_2MB -DCSM_ENABLE=TRUE"
-	mv $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/BHYVE.fd $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/uefi-csm-rom.bin
+
+csm16:
+	bash -c "cd $(VER.64); \
+		source edksetup.sh; \
+		$(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C BhyvePkg/Csm/BhyveCsm16"
+
+uefi-csm: csm16
+
+$(ROMS): basetools
+	rm -rf $(VER.64)/Build/BhyveX64
+	bash -c 'cd $(VER.64); \
+		source edksetup.sh; \
+		export ILGCC_BIN=$(PWD)/$(VER.64)/Build/; \
+		[[ $@ == uefi-csm ]] && extra_cflags=-DCSM_ENABLE=TRUE; \
+		build -t ILGCC -a $(ARCH) -b $(UEFI_TARGET) \
+			-p BhyvePkg/BhyvePkgX64.dsc \
+			-DDEBUG_ON_SERIAL_PORT=TRUE -DFD_SIZE_1MB \
+			$${extra_cflags}'
+	mv $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/BHYVE.fd \
+		$(VER.64)/Build/$@-rom.bin
 
 install: all
 	mkdir -p $(DESTDIR)/usr/share/bhyve
-	/usr/sbin/install -m 0755 -f $(DESTDIR)/usr/share/bhyve $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/uefi-csm-rom.bin
-
+	for rom in $(ROMS); do \
+		/usr/sbin/install -m 0755 -f $(DESTDIR)/usr/share/bhyve \
+		    $(VER.64)/Build/$$rom-rom.bin; \
+	done
-- 
2.21.0

