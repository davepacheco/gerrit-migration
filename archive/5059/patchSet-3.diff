From 07856c2c9b0c07a29e9ef579d69f98dfae99a7da Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 13 Nov 2018 04:35:43 +0000
Subject: [PATCH] OS-7370 smartos-live should support building the strap cache
 OS-7377 measure_terminal.c needs GCC fixes

---
 Makefile               |  8 +++++
 src/measure_terminal.c |  6 ++--
 tools/build_strap      | 71 ++++++++++++++++++++++++++++++++++++++----
 3 files changed, 76 insertions(+), 9 deletions(-)

diff --git a/Makefile b/Makefile
index 99de101d..2fd6b1ca 100644
--- a/Makefile
+++ b/Makefile
@@ -316,6 +316,14 @@ FORCEARG_yes=-f
 	    -a $(ADJUNCT_TARBALL) $(FORCEARG_$(FORCE_STRAP_REBUILD))
 	touch $@
 
+# report the Manta location of the proto.strap cache
+strap-cache-location:
+	@$(ROOT)/tools/build_strap -l
+
+# build a proto.strap cache tarball
+strap-cache:
+	$(ROOT)/tools/build_strap -c -j $(MAX_JOBS) -a $(ADJUNCT_TARBALL)
+
 # additional illumos-extra content for proto itself
 0-extra-stamp: 0-illumos-stamp
 	(cd $(ROOT)/projects/illumos-extra && \
diff --git a/src/measure_terminal.c b/src/measure_terminal.c
index 29b3862b..068f88d8 100644
--- a/src/measure_terminal.c
+++ b/src/measure_terminal.c
@@ -10,7 +10,7 @@
  */
 
 /*
- * Copyright (c) 2013 Joyent Inc., All rights reserved.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -175,7 +175,7 @@ process_size(char *buf)
 int
 main(int argc __UNUSED, char **argv __UNUSED)
 {
-	char *buf0 = NULL, *buf1 = NULL;
+	char *buf0 = NULL;
 	boolean_t is_match = B_FALSE;
 	char *term = getenv("TERM");
 
@@ -246,7 +246,7 @@ main(int argc __UNUSED, char **argv __UNUSED)
 			 * enroute.
 			 */
 			is_match = B_TRUE;
-			buf1 = read_cseq();
+			free(read_cseq());
 		}
 	}
 
diff --git a/tools/build_strap b/tools/build_strap
index 1d6084f0..073c5ec2 100755
--- a/tools/build_strap
+++ b/tools/build_strap
@@ -28,16 +28,20 @@
 # true if the user specified non-default compilers.
 #
 
-usage="$0 -a adjunct.tar -d protodir [-f] [-j maxjobs]"
+usage="$0 [-l | -a adjunct.tar [-f] [-j maxjobs] [-c | -d protodir]]"
 wsroot=$(cd $(dirname $0)/../; pwd)
 pkgin_file="/opt/local/etc/pkgin/repositories.conf"
-manta_base="https://us-east.manta.joyent.com/Joyent_Dev/public/SmartOS/build-cache/proto.strap/"
+manta_host="https://us-east.manta.joyent.com"
+manta_dir="/Joyent_Dev/public/SmartOS/build-cache/proto.strap/"
+manta_base="$manta_host/$manta_dir"
 cache_base="/opt/SmartOS/build-cache/"
 srcdir="$wsroot/projects/illumos-extra"
 adjunct=""
 protodir=""
 max_jobs="128"
 force_build="no"
+report_loc="no"
+create_cache="no"
 
 function fatal
 {
@@ -71,9 +75,16 @@ function identify_srcsha
 
 function build_strap
 {
-	echo "Building illumos-extra bootstrap"
+	echo "Building illumos-extra bootstrap at $protodir"
 
-	verbose gmake STRAP=strap MAX_JOBS=$max_jobs DESTDIR=$protodir \
+	#
+	# Strip any double slashes. Certain pieces of software simply hate you -
+	# yes, YOU - and get very confused given double slashes. Namely
+	# projects/illumos-extra/make
+	#
+	DESTDIR=$(echo $protodir | sed 's+//*+/+g')
+
+	verbose gmake STRAP=strap MAX_JOBS=$max_jobs DESTDIR=$DESTDIR \
 	    -C $wsroot/projects/illumos-extra install_strap ||
 	    fatal "failed to build install_strap"
 
@@ -129,6 +140,35 @@ function download
 	fi
 }
 
+#
+# Do a strap build into the cache directory, then create the tarball for
+# uploading.
+#
+function create_cache
+{
+	local cache_dir="$1"
+
+	if [[ "$force_build" = "no" ]]; then
+		if [[ -d "$cache_dir" ]]; then
+			echo "$cache_dir exists; not building"
+			return
+		fi
+	fi
+
+	mkdir -p "$cache_dir" || fatal "couldn't mkdir $cache_dir"
+
+	protodir="$cache_dir"
+
+	build_strap
+
+	mkdir -p $wsroot/output || fatal "couldn't mkdir $wsroot/output"
+
+	gtar -C "$cache_dir" -czf $wsroot/output/proto.strap.tgz . ||
+	    fatal "failed to create tarball"
+
+	echo "Created $wsroot/output/proto.strap.tgz"
+}
+
 #
 # Populate proto.strap: either we do a local build, or we download and use a
 # cached copy, sym-linking it in.
@@ -143,6 +183,11 @@ function populate_strap
 		fatal "found weird non-directory $cache_dir"
 	fi
 
+	if [[ "$create_cache" = "yes" ]]; then
+		create_cache $cache_dir
+		return
+	fi
+
 	#
 	# First we should clean up: if not a symlink or empty dir, it must be a
 	# local strap build we need.
@@ -173,10 +218,12 @@ function populate_strap
 export PATH=/usr/bin:/usr/sbin:/sbin:/opt/local/bin:/opt/local/sbin
 set -o pipefail
 
-while getopts "a:d:fhj:" arg; do
+while getopts "a:cd:fhlj:" arg; do
 	case $arg in
 	a)
 		adjunct=$OPTARG ;;
+	c)
+		create_cache="yes" ;;
 	d)
 		protodir=$OPTARG ;;
 	f)
@@ -186,17 +233,29 @@ while getopts "a:d:fhj:" arg; do
 		exit 0 ;;
 	j)
 		max_jobs=$OPTARG ;;
+	l)
+		report_loc="yes" ;;
 	?)
 		echo "$usage" >&2
 		exit 1 ;;
 	esac
 done
 
+if [[ "$report_loc" = "yes" ]]; then
+	echo $manta_dir/$(identify_pkgsrc_branch)/$(identify_srcsha)/proto.strap.tgz
+	exit 0
+fi
+
 [[ -n "$adjunct" ]] || fatal "missing -a argument"
-[[ -n "$protodir" ]] || fatal "missing -d argument"
 [[ -d "$srcdir" ]] || fatal "cannot find illumos-extra in $srcdir"
 [[ -d "$srcdir/.git" ]] || fatal "$srcdir is not a git repo"
 
+if [[ "$create_cache" = "yes" ]]; then
+	[[ -z "$protodir" ]] || fatal "can't specify -u and -d"
+else
+	[[ -n "$protodir" ]] || fatal "missing -d argument"
+fi
+
 populate_strap $(identify_pkgsrc_branch) $(identify_srcsha)
 
 exit 0
-- 
2.21.0

