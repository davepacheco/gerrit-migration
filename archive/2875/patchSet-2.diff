From e27a7d36bb043501e739b47d5ba32fd0a0c643b9 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Tue, 31 Oct 2017 18:39:20 +0000
Subject: [PATCH] OS-6420 panic in prgetattr

---
 usr/src/uts/common/fs/proc/prvnops.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/usr/src/uts/common/fs/proc/prvnops.c b/usr/src/uts/common/fs/proc/prvnops.c
index 7d6cb037c1..fa5f637f05 100644
--- a/usr/src/uts/common/fs/proc/prvnops.c
+++ b/usr/src/uts/common/fs/proc/prvnops.c
@@ -1636,6 +1636,11 @@ pr_read_spymaster(prnode_t *pnp, uio_t *uiop)
 	if ((error = prlock(pnp, ZNO)) != 0)
 		return (error);
 
+	if (pnp->pr_common->prc_thread == NULL) {
+		prunlock(pnp);
+		return (0);
+	}
+
 	lwp = pnp->pr_common->prc_thread->t_lwp;
 
 	if (lwp->lwp_spymaster == NULL) {
@@ -2666,6 +2671,11 @@ pr_read_spymaster_32(prnode_t *pnp, uio_t *uiop)
 	if ((error = prlock(pnp, ZNO)) != 0)
 		return (error);
 
+	if (pnp->pr_common->prc_thread == NULL) {
+		prunlock(pnp);
+		return (0);
+	}
+
 	lwp = pnp->pr_common->prc_thread->t_lwp;
 
 	if (lwp->lwp_spymaster == NULL) {
@@ -3299,7 +3309,8 @@ prgetattr(vnode_t *vp, vattr_t *vap, int flags, cred_t *cr,
 			vap->va_size = 0;
 		break;
 	case PR_SPYMASTER:
-		if (pnp->pr_common->prc_thread->t_lwp->lwp_spymaster != NULL) {
+		if (pnp->pr_common->prc_thread != NULL &&
+		    pnp->pr_common->prc_thread->t_lwp->lwp_spymaster != NULL) {
 			vap->va_size = PR_OBJSIZE(psinfo32_t, psinfo_t);
 		} else {
 			vap->va_size = 0;
-- 
2.21.0

