From b552bb1bc9ebb34ad781ff6b4defa8cb2f783f26 Mon Sep 17 00:00:00 2001
From: "Joshua M. Clulow" <jmc@joyent.com>
Date: Tue, 22 Jan 2019 18:39:33 +0000
Subject: [PATCH] MANTA-4067 muskie ensureDirectoryEmpty should be cheaper

---
 lib/common.js | 30 ++++++++++++++++++++++++++----
 lib/dir.js    | 10 +++++++---
 2 files changed, 33 insertions(+), 7 deletions(-)

diff --git a/lib/common.js b/lib/common.js
index b65e6f6..1045c11 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -631,7 +631,14 @@ function addCustomHeaders(req, res) {
 }
 
 
-function readdir(dir, req) {
+function readdir(dir, req, args) {
+    if (args === undefined) {
+        args = { unsorted: false };
+    } else {
+        assert.object(args, 'args');
+        assert.bool(args.unsorted, 'args.unsorted');
+    }
+
     var l = parseInt(req.params.limit || 256, 10);
     if (l <= 0 || l > 1024) {
         var ee = new EventEmitter();
@@ -683,7 +690,14 @@ function readdir(dir, req) {
         no_count: true
     };
 
-    if (tsort) {
+    if (args.unsorted) {
+        /*
+         * Remove the sort object from the options altogether so that Moray
+         * does not generate a potentially expensive ORDER BY clause in the
+         * resultant database query.
+         */
+        delete args.sort;
+    } else if (tsort) {
         opts.sort.attribute = '_mtime';
         if (reverse) {
             opts.sort.order = 'ASC';
@@ -699,7 +713,14 @@ function readdir(dir, req) {
         }
     }
 
-    if (marker) {
+    /*
+     * If a marker was provided with the request, add an appropriate filter so
+     * that this page of results begins at the appropriate position in the full
+     * result set.  If this is a request for unsorted results, as used
+     * internally to check if a directory is empty, it doesn't make sense to
+     * use a marker as there is no consistent total order of the result set.
+     */
+    if (marker && !args.unsorted) {
         if (tsort) {
             var mtime = Date.parse(marker);
             if (Number.isFinite(mtime)) {
@@ -730,7 +751,8 @@ function readdir(dir, req) {
 
     log.debug({
         dir: dir,
-        filter: opts.filter
+        args: args,
+        opts: opts
     }, 'readdir: entered');
     var mreq = client.search(opts);
 
diff --git a/lib/dir.js b/lib/dir.js
index 01f2fd0..c8d909d 100644
--- a/lib/dir.js
+++ b/lib/dir.js
@@ -210,10 +210,14 @@ function ensureDirectoryEmpty(req, res, next) {
     var children = false;
     var mreq;
 
-    // Just override the limit, so we don't ask moray to
-    // do too much work
+    /*
+     * A regular readdir() operation is expensive: it sorts and formats a page
+     * of results from the directory in a form appropriate for clients.  As we
+     * only need to know if the directory has any entries, we'll just ask for
+     * one entry and disable any sorting of the result set.
+     */
     req.params.limit = 1;
-    mreq = common.readdir(req.key, req);
+    mreq = common.readdir(req.key, req, { unsorted: true });
 
     mreq.once('error', next);
 
-- 
2.21.0

