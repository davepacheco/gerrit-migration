{"project":"joyent/illumos-joyent","branch":"master","id":"I1a8b5e84e7fce7cfa38f205cdb03ffd82f019af2","number":"2161","subject":"OS-6151 mac_tx_srs_quiesce() can kill a maxbw link Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jason King \u003cjason.king@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/2161","commitMessage":"OS-6151 mac_tx_srs_quiesce() can kill a maxbw link\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1498629090,"lastUpdated":1498858455,"open":false,"status":"MERGED","comments":[{"timestamp":1498629090,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1498630281,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1498630306,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nForgot to update copyright in first commit."},{"timestamp":1498773767,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1498798381,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1498799811,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1498857393,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1498857510,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\nTest notes are with the issue."},{"timestamp":1498858098,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1498858391,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1498858443,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1498858455,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"5","revision":"1a8b5e84e7fce7cfa38f205cdb03ffd82f019af2","parents":["89349744d610676e04286ab746801f54dd853335"],"ref":"refs/changes/61/2161/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1498858443,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498857393,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498858098,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1498858455,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac_sched.c","type":"MODIFIED","insertions":15,"deletions":-15},{"file":"usr/src/uts/common/io/mac/mac_soft_ring.c","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":27,"sizeDeletions":-23},"patchSets":[{"number":"1","revision":"7ec035bf23518eb110662354d1eb22e07118fb0c","parents":["2b9d6c0c0b0b0ccf908460c4e3a04c0ca3ca07de"],"ref":"refs/changes/61/2161/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1498629090,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_sched.c","type":"MODIFIED","insertions":6,"deletions":-6},{"file":"usr/src/uts/common/io/mac/mac_soft_ring.c","type":"MODIFIED","insertions":6,"deletions":-6}],"sizeInsertions":16,"sizeDeletions":-13},{"number":"2","revision":"de2554fdf1f4396fbee153a9b64dd030d85a618a","parents":["2b9d6c0c0b0b0ccf908460c4e3a04c0ca3ca07de"],"ref":"refs/changes/61/2161/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1498630281,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":3462,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we NULL out s_ring_tid before we call untimeout such that it doesn\u0027t signal the worker in case we hit that once in a tick chance and we have to block to the completion of the timeout function?"},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":3462,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"The order doesn\u0027t matter. The first thing the mac_soft_ring_worker() thread does when it comes out of cv_wait (and breaks out of the while loop) is check for S_RING_PAUSE (which is S_RING_CONDEMNED | S_RING_QUIESCE). If either flag is set it jumps past the drain function and finishes either quiescing the ring or condemning it. Furthermore, mac_srs_soft_rings_queisce() first calls mac_soft_ring_signal() to set the S_RING_QUIESCE state which means all ring workers will be kicked out of the main loop into the \u0027done\u0027 label after that function returns. They will when spin wait on the s_ring_async until the ring is either signaled as restarted or condemned. So even if the timeout fires and we signal it doesn\u0027t matter."},{"file":"usr/src/uts/common/io/mac/mac_sched.c","line":2663,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should this block have the same 0/NULL treatment?"},{"file":"usr/src/uts/common/io/mac/mac_sched.c","line":2663,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac_sched.c","line":2681,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should this block have the same 0/NULL treatment?"},{"file":"usr/src/uts/common/io/mac/mac_sched.c","line":2681,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac_sched.c","line":2961,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should this block have the same 0/NULL treatment?"},{"file":"usr/src/uts/common/io/mac/mac_sched.c","line":2961,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac_sched.c","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"usr/src/uts/common/io/mac/mac_soft_ring.c","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":19,"sizeDeletions":-15},{"number":"3","revision":"0ef801a80fca88ed414bee3a3d7a618503e6dd83","parents":["2b9d6c0c0b0b0ccf908460c4e3a04c0ca3ca07de"],"ref":"refs/changes/61/2161/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1498798381,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498857393,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498858098,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac_sched.c","type":"MODIFIED","insertions":15,"deletions":-15},{"file":"usr/src/uts/common/io/mac/mac_soft_ring.c","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":27,"sizeDeletions":-23},{"number":"4","revision":"96ff6bd76d14e2486a238346c1f5511db035b3cb","parents":["89349744d610676e04286ab746801f54dd853335"],"ref":"refs/changes/61/2161/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1498858391,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498857393,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498858098,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac_sched.c","type":"MODIFIED","insertions":15,"deletions":-15},{"file":"usr/src/uts/common/io/mac/mac_soft_ring.c","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":27,"sizeDeletions":-23},{"number":"5","revision":"1a8b5e84e7fce7cfa38f205cdb03ffd82f019af2","parents":["89349744d610676e04286ab746801f54dd853335"],"ref":"refs/changes/61/2161/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1498858443,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498857393,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1498858455,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498858098,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac_sched.c","type":"MODIFIED","insertions":15,"deletions":-15},{"file":"usr/src/uts/common/io/mac/mac_soft_ring.c","type":"MODIFIED","insertions":7,"deletions":-6}],"sizeInsertions":27,"sizeDeletions":-23}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}