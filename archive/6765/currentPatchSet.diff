From 43da2e58fd20f3c22182a8e0397066eb9d574689 Mon Sep 17 00:00:00 2001
From: Richard Bradley <richard.bradley@joyent.com>
Date: Thu, 8 Aug 2019 08:45:11 +0100
Subject: [PATCH] joyent/node-vmapi-resolver#3 should return the tags of
 VM/backend

---
 lib/resolver.js | 30 +++++++++++++++++++++++++++---
 1 file changed, 27 insertions(+), 3 deletions(-)

diff --git a/lib/resolver.js b/lib/resolver.js
index 38046f0..0564fda 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -3,7 +3,7 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
  *
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 /*
@@ -84,6 +84,20 @@ VmapiResolver.prototype.getBackends = function getBackends(cb) {
 			return;
 		}
 		Object.keys(vms).forEach(function (vm) {
+
+			var matched_tag;
+			if (vms[vm].tags.hasOwnProperty(vm_tag_name)) {
+				matched_tag = {
+				    'name': vm_tag_name,
+				    'value': vms[vm].tags[vm_tag_name]
+				};
+			} else {
+				log.warn({
+				    'vm_tags': vms[vm].tags,
+				    'vm_tag_name': vm_tag_name
+				}, 'tag name ambiguous; not returning');
+			}
+
 			vms[vm].nics.forEach(function (nic) {
 				/*
 				 * nic tags are matched by the caller-provided
@@ -92,12 +106,17 @@ VmapiResolver.prototype.getBackends = function getBackends(cb) {
 				if (nic_tag_regexp.test(nic.nic_tag)) {
 					backends.push({
 						'name': vms[vm].alias,
-						'address': nic.ip
+						'address': nic.ip,
+						'tag': matched_tag
 					});
 				}
 			});
 		});
-		log.info(backends, 'discovered backends');
+
+		log.info({
+		    'backends': backends
+		}, 'discovered backends');
+
 		cb(null, backends);
 	});
 };
@@ -117,6 +136,11 @@ VmapiResolver.prototype.diffAndEmit = function diffAndEmit() {
 			'address': backend.address,
 			'port': self.vmr_backend_port
 		};
+
+		if (backend.tag) {
+			be['tag'] = backend.tag;
+		}
+
 		Object.keys(self.vmr_backends).forEach(function (key) {
 			old_backend = self.vmr_backends[key];
 			if (old_backend.address === be.address &&
-- 
2.21.0

