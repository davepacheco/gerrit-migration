From df21da67a20f461ef3c46e83590c3d7358fe838c Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Mon, 17 Apr 2017 21:06:44 +1200
Subject: [PATCH] PUBAPI-1380: Cloudapi should support wildcards in
 ListPackages

---
 docs/index.md         | 11 +++++++++++
 lib/packages.js       |  2 +-
 package.json          |  4 ++--
 test/packages.test.js |  8 ++++++++
 4 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index f3e1a08..3b12340 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -860,6 +860,12 @@ variable or the `--api-version=RANGE` option to each command.
 The rest of this section describes API changes in each version.
 
 
+## 8.1.1
+
+- It's now possible to query packages using wildcards. See the
+[ListPackages](#ListPackages) section.
+
+
 ## 8.1.0
 
 - This version should have no visible API changes, but updates a lot of
@@ -3702,6 +3708,11 @@ group      | String   | The group this package belongs to
 When any values are provided for one or more of the aforementioned inputs, the
 retrieved packages will match all of them.
 
+When querying, wildcards (i.e. '*') are allowed for string fields. For example,
+to list all packages with a name that starts with "foo", give "foo*" as the
+package name.
+
+
 ### Returns
 
 An array of objects, of the form:
diff --git a/lib/packages.js b/lib/packages.js
index 9c8fa06..98d1fc4 100644
--- a/lib/packages.js
+++ b/lib/packages.js
@@ -238,7 +238,7 @@ function list(req, res, next) {
     opts.active = true;
     opts.owner_uuids = req.account.uuid;
 
-    return req.sdc.papi.list(opts, {}, function (err, pkgs) {
+    return req.sdc.papi.list(opts, { escape: false }, function (err, pkgs) {
         if (err) {
             return next(err);
         }
diff --git a/package.json b/package.json
index 0a4405a..3cf0868 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "8.1.0",
+    "version": "8.1.1",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
@@ -23,7 +23,7 @@
         "bunyan": "1.8.1",
         "cueball": "2.1.1",
         "kang": "1.1.0",
-        "sdc-clients": "10.0.4",
+        "sdc-clients": "git+https://github.com/joyent/node-sdc-clients.git#ac1c2f44a7857c1864173d37984817be2ce081f0",
         "ufds": "1.2.0",
         "semver": "2.2.1",
         "nodemailer": "0.3.29",
diff --git a/test/packages.test.js b/test/packages.test.js
index be801be..94ed0a9 100644
--- a/test/packages.test.js
+++ b/test/packages.test.js
@@ -163,6 +163,14 @@ test('search packages by name', function (t) {
 });
 
 
+test('search packages by name with wildcard', function (t) {
+    var name = SDC_512.name.slice(0, -4) + '*';
+    searchAndCheck('name=' + name, t, function (pkg) {
+        t.equal(pkg.name, SDC_512.name);
+    });
+});
+
+
 test('search packages by memory', function (t) {
     searchAndCheck('memory=128', t, function (pkg) {
         t.equal(pkg.memory, 128);
-- 
2.21.0

