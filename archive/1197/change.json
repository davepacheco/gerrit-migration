{"project":"joyent/smartos-live","branch":"master","id":"Id7a890514240ff00bf92194bd9186dc4fb68a367","number":"1197","subject":"OS-5919 remove zone lock file Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/1197","commitMessage":"OS-5919 remove zone lock file\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1483470535,"lastUpdated":1485796952,"open":false,"status":"MERGED","comments":[{"timestamp":1483470535,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1483470585,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483474705,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1483509666,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\nThis looks good, but please make sure the bug is updated with a new analysis."},{"timestamp":1485286989,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1485296515,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI assume this is being tested as part of the other changes. I can IA whenever you\u0027re done with testing."},{"timestamp":1485297435,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nYes, this has been tested as part of the OS-3506 and OS-5363 patches. When I add the test notes I\u0027ll add it to all the CRs just so they are easy to find if anyone is doing code archeology years down the line."},{"timestamp":1485475130,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1485475711,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nTest notes:\n\nThe short of it: I ran a mass zone start/stop along with a dladm stress script which produced deadlocks on the current PI but didn\u0027t on my patched PI. I am confident that these changes are an improvement on the existing code and should greatly reduce if not completely eliminate our \"Manta has stuck zones\" issue.\n\nI merged the OS-3506, OS-5363 and OS-5919 patches into one branch and tested them as a single unit (though I think they should be pushed separate so that the patches can be easily differentiated during code archeology). But before I tested my patches I first made sure I could replicate the bugs on the existing PI (20161222T003450Z). The zone lock file was actually doing it\u0027s job and preventing the concurrency needed to induce the deadlock; but if you induce enough load there is a provision in the lock file code to force drop the lock after 60s of waiting and give it to a new owner, thus allowing concurrent access when there should be none. So I just modified the zone lock logic to immediately drop the lock after acquiring it to fake this 60s timeout and allow more concurrency. Sure enough after making this change I was able to easily replicate several occurrences of the OS-3506 deadlock. I was never able to replicate OS-5363, probably because it\u0027s a trickier three-way deadlock and is hard to hit before hitting OS-3506. After a few days of chasing OS-5363 I gave up and ran my tests on my patched PI. I found a new deadlock introduced by my fix in OS-3506 but then I found a way to fix that deadlock without reintroducing the original one. After that modification I was able to run my stress test many times with no deadlock. With enough dladm load and concurrent zone shutdowns I can induce some EBUSY failures but the zones can eventually be stopped with \"vmadm stop -f\" when needed. Since this is not a deadlock I consider it out of scope for this ticket and is something we should potentially improve under another ticket. So what was my actual test? Here is the rundown:\n\n* Create 121 native zones. There is noting special about 121, I actually meant to do 120 but had an off-by-one error.\n\n* Write a script to loop through all zones and either start or stop them depending on a) if the zone was even or odd and b) the argument to the script. I would type \"./dlt-test ping\" and that would start half and stop half; then I would type \"./dlt-test pong\" and that would stop the half that was previously started and start the other half. Each start/stop command was run as a background process. Between every 9 operations there was a sleep for 1 second as an attempt to get more concurrency between start/stop operations (the stop op is quicker than start).\n\n* I would run the above script a few times as an initial test to make sure mass start/stop didn\u0027t cause an issue. If it passed this test I added dladm load.\n\n* I created another script to generate dladm load. I would do a dladm show-link, show-vnic, and show-phys in a for loop, typically 8 times, and run each command as a background process. This for loop was then put in a while true loop where it slept 1 second between each for loop. So each second 24 dladm commands were generated.\n\n* My main stress test was to run the mass start/stop script and the dladm load script concurrently. I would let the dladm script run in the background while I continuously ran the dlt-test ping/pong stages. I would first wait for each stage to finish by looking on pgrep \u0027^zoneadm$\u0027 and waiting for all requests to finish. This stress test not only generated plenty of deadlocks but also locked up my machine at least 7 times -- so it was definitely stressing the system.\n\n* On some tests I also added various dtrace probes to dlmgmtd/dls/mac just to slow things down even more and try to induce more unique concurrent executions."},{"timestamp":1485796743,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1485796788,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1485796798,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1485796952,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"4","revision":"d7a890514240ff00bf92194bd9186dc4fb68a367","parents":["d04cf52821cbe87cefcafd2042a168b224ad1af3"],"ref":"refs/changes/97/1197/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485796798,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483470585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483474705,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483509666,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485475130,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1485796952,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":0,"deletions":-59}],"sizeInsertions":0,"sizeDeletions":-59},"patchSets":[{"number":"1","revision":"290b7dfbcc179dbcff8133d325db65af38bab86c","parents":["5b9a367a2e76adf74a7ad077c2d175d749898201"],"ref":"refs/changes/97/1197/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1483470535,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483509666,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483470585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483474705,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":0,"deletions":-59}],"sizeInsertions":0,"sizeDeletions":-59},{"number":"2","revision":"f4248b0684edea308ab0fab7f48d072f6d00f8b1","parents":["5b9a367a2e76adf74a7ad077c2d175d749898201"],"ref":"refs/changes/97/1197/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485286989,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483509666,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483470585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483474705,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485475130,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":0,"deletions":-59}],"sizeInsertions":0,"sizeDeletions":-59},{"number":"3","revision":"61e1f68a2249621c4dc48efbed93c70a605737fa","parents":["d04cf52821cbe87cefcafd2042a168b224ad1af3"],"ref":"refs/changes/97/1197/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485796743,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483509666,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483470585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483474705,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485475130,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":0,"deletions":-59}],"sizeInsertions":0,"sizeDeletions":-59},{"number":"4","revision":"d7a890514240ff00bf92194bd9186dc4fb68a367","parents":["d04cf52821cbe87cefcafd2042a168b224ad1af3"],"ref":"refs/changes/97/1197/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485796798,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483509666,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483470585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483474705,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485475130,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1485796952,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":0,"deletions":-59}],"sizeInsertions":0,"sizeDeletions":-59}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}