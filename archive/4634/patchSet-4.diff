From 1d58b6c2cff1c4402c6f803dce06b621ccb4f627 Mon Sep 17 00:00:00 2001
From: "Joshua M. Clulow" <jmc@joyent.com>
Date: Fri, 10 Aug 2018 11:25:25 +0000
Subject: [PATCH] TRITON-665 headnode setup should refer to Triton, not SDC
 Reviewed by: Trent Mick <trent.mick@joyent.com> Approved by: Trent Mick
 <trent.mick@joyent.com>

---
 README.md                |  8 ++---
 config/banner            |  2 +-
 scripts/prompt-config.sh | 76 ++++++++++++++++++++++++++++------------
 3 files changed, 59 insertions(+), 27 deletions(-)

diff --git a/README.md b/README.md
index a94e46db..44f2bee6 100644
--- a/README.md
+++ b/README.md
@@ -76,7 +76,7 @@ Then to set up the zone:
 ### Build Specification: `build.spec` and `build.spec.local`
 
 Some aspects of the configuration of the build, including which build artefacts
-will be included in the resultant SDC installation media, are specified
+will be included in the resultant Triton installation media, are specified
 declaratively.  The JSON file `build.spec` contains the default specification
 of all build configuration, and is versioned in the repository.
 
@@ -120,7 +120,7 @@ file: zones and files.
 
 ##### Zones
 
-The SDC headnode installation media includes images of various core zones.
+The Triton headnode installation media includes images of various core zones.
 These zone images are generally built by [Mountain Gorilla (MG)][mg], and the
 resultant build artefacts are uploaded to a directory structure in
 [Manta][manta].  Zone images are nominated for inclusion in the build via
@@ -225,7 +225,7 @@ output of [Mountain Gorilla (MG)][mg] build targets and are obtained either
 from Manta (by default) or an MG-style `BITS_DIR`.
 
 Files are specified in the `"files"` key of `build.spec`.  For example, the
-SDC Agents are bundled together in a shell archive (shar) installer.  This
+Triton Agents are bundled together in a shell archive (shar) installer.  This
 installer is produced as part of the `agentsshar` MG target.  The shar itself
 is specified for inclusion with this entry:
 
@@ -264,7 +264,7 @@ an alternative top-level `build.spec` key on a per-file basis.
 
 For example, Joyent ships firmware files for specific server hardware that are
 not available under an opensource license.  As a result, these files are only
-included in the commercially supported builds of SDC to Joyent customers.
+included in the commercially supported builds of Triton to Joyent customers.
 The firmware artefact is stored in a different (Joyent-private) area of Manta,
 and configured thus:
 
diff --git a/config/banner b/config/banner
index 3bf5728c..d9746280 100644
--- a/config/banner
+++ b/config/banner
@@ -1 +1 @@
-                          --> Welcome to SDC7! <--
+                         --> Welcome to Triton! <--
diff --git a/scripts/prompt-config.sh b/scripts/prompt-config.sh
index 99a87ee1..60b5f2b1 100755
--- a/scripts/prompt-config.sh
+++ b/scripts/prompt-config.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2017, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 # XXX - TODO
@@ -39,6 +39,30 @@ declare -a nics
 declare -a assigned
 declare prmpt_str
 
+#
+# Generate a horizontal ruler of appropriate length.  Doing this each time we
+# emit a ruler appears to induce a surprisingly noticeable latency, so we just
+# do it once.
+#
+ruler=
+while (( ${#ruler} < 80 )); do
+	ruler+='-'
+done
+
+#
+# Determine whether we need a trailing newline after the horizontal ruler.  It
+# would seem that most modern terminal emulators behave like the VT100: if the
+# cursor has naturally progressed to the rightmost column _and_ the next
+# character is a newline, the terminal will discard what is effectively a
+# redundant newline.  Unfortunately, the framebuffer terminal emulator in
+# illumos does not currently do this.  Attempt to guess if we are attached to a
+# serial line or not, so as to decide whether we should send the extra newline.
+#
+console=$(bootparams | awk -F= '$1 == "console" { print $2 }')
+if [[ $(/bin/tty) != '/dev/console' ]] || [[ $console =~ ^tty ]]; then
+	ruler+='\n'
+fi
+
 nicsup_done=0
 
 sig_doshell()
@@ -701,6 +725,16 @@ updatenicstates()
 	done < <(dladm show-phys -po link,state 2>/dev/null)
 }
 
+printruler()
+{
+	#
+	# Print the horizontal ruler we have generated for this terminal.  Note
+	# that the ruler string is a printf(1) format string which may include
+	# a newline escape sequence.
+	#
+	printf -- "$ruler"
+}
+
 printheader()
 {
 	local newline=
@@ -712,21 +746,19 @@ printheader()
 		return
 	fi
 
-	if [ $cols -gt 80 ] ;then
-		newline='\n'
-	fi
-
 	clear
-	printf " %-40s\n" "Smart Data Center (SDC) Setup"
-	printf " %-40s%38s\n" "$subheader" "http://docs.joyent.com/sdc7"
-	for i in {1..80} ; do printf "-" ; done && printf "$newline"
+	printf " %-40s\n" "Triton Setup"
+	printf " %-40s%38s\n" "$subheader" \
+	    "https://docs.joyent.com/private-cloud"
+
+	printruler
 }
 
 print_warning()
 {
 	clear
 	printf "WARNING\n"
-	for i in {1..80} ; do printf "-" ; done && printf "\n"
+	printruler
 	printf "\n$1\n"
 
 	prmpt_str="\nPress [enter] to continue "
@@ -822,20 +854,20 @@ export TERM=xterm-color
 
 trap sig_doshell SIGINT
 
-printheader "Copyright 2014, Joyent, Inc."
+printheader "Copyright (c) 2018, Joyent, Inc."
 
 message="
-Before proceeding with the installation of SDC please familiarise yourself with
-the architecture and components of SDC by reviewing the SDC 7 Overview:
+Before proceeding with the installation of Triton please familiarise yourself
+with the architecture and components of Triton by reviewing the Triton Overview:
 
-http://docs.joyent.com/sdc7/overview-of-smartdatacenter-7.
+    https://docs.joyent.com/private-cloud
 
 Please also read through the installation instructions:
 
-http://docs.joyent.com/sdc7/installing-sdc7
+    https://docs.joyent.com/private-cloud/install
 
-paying particular attention to the "Preparation" section and the networking
-requirements.
+Of particular note are the sections describing networking requirements and
+deployment planning.
 
 You must answer the following questions to configure the head node. You will
 have a chance to review and correct your answers, as well as a chance to edit
@@ -920,7 +952,7 @@ datacenter_name=us-west-1, but this isn't required.
 	message="
 Several applications will be made available on these networks using IP
 addresses which are automatically incremented based on the headnode IP.
-In order to determine what IP addresses have been assigned to SDC, you can
+In order to determine what IP addresses have been assigned to Triton, you can
 either review the configuration prior to its application, or you can run
 'sdc-netinfo' after the install.
 
@@ -935,10 +967,10 @@ Press [enter] to continue"
 	printheader "Networking - Admin"
 	message="
 The admin network is used for management traffic and other information that
-flows between the Compute Nodes and the Headnode in an SDC cluster. This
+flows between the Compute Nodes and the Headnode in a Triton cluster. This
 network will be used to automatically provision new compute nodes and there are
 several application zones which are assigned sequential IP addresses on this
-network. It is important that this network be used exclusively for SDC
+network. It is important that this network be used exclusively for Triton
 management. Note that DHCP traffic will be present on this network following
 the installation and that this network is connected in VLAN ACCESS mode only.
 \n\n"
@@ -1110,7 +1142,7 @@ other networks. This will almost certainly be the router connected to your
 
 	message="
 The DNS servers set here will be used to provide name resolution abilities to
-the SDC cluster itself. These will also be default DNS servers for zones
+the Triton cluster itself. These will also be default DNS servers for zones
 provisioned on the 'external' network.\n\n"
 
 	if [[ $(getanswer "skip_instructions") != "true" ]]; then
@@ -1160,8 +1192,8 @@ set the headnode to be an NTP client to synchronize to another NTP server.\n"
 	message="
 There are two primary accounts for managing a Smart Data Center.  These are
 'admin', and 'root'. Each account can have a unique password. Most of the
-interaction you will have with SDC will be using the 'admin' user, unless
-otherwise specified.  In addition, SDC has the ability to send notification
+interaction you will have with Triton will be using the 'admin' user, unless
+otherwise specified.  In addition, Triton has the ability to send notification
 emails to a specific address. Each of these values will be configured below.
 \n"
 
-- 
2.21.0

