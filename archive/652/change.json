{"project":"joyent/node-moray","branch":"master","topic":"MORAY-346","id":"Ia65aa319c7aefeed9fe1f506927c642c3ac16659","number":"652","subject":"MORAY-346 moray client needs work MORAY-309 error events should be emitted with prudence MORAY-257 MorayClient should emit errors properly MORAY-334 minnow clients reporting no active connections when moray seems to be up MORAY-361 moray client tools hang","owner":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"url":"https://cr.joyent.us/652","commitMessage":"MORAY-346 moray client needs work\nMORAY-309 error events should be emitted with prudence\nMORAY-257 MorayClient should emit errors properly\nMORAY-334 minnow clients reporting no active connections when moray seems to be up\nMORAY-361 moray client tools hang forever while moray is down\nMORAY-238 node-moray retry policy does not match what\u0027s configured\nMORAY-357 moray errors indict client for server-side problem\nMORAY-356 moray client continuing to periodically check DNS after close\nMORAY-325 node-moray client emits \u0027close\u0027 event even if some connections are still open\nMORAY-300 node-moray requires log parameter unnecessarily for version and ping\nMORAY-362 reindexobjects always fails on missing vasync dependency\nMORAY-365 command-line tools are not checked for style or lint\nMORAY-366 want command-line tool for \"gettokens\" RPC call\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1476226423,"lastUpdated":1563212284,"open":false,"status":"MERGED","comments":[{"timestamp":1476226423,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 1."},{"timestamp":1476229260,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 2."},{"timestamp":1476229299,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476232222,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(5 comments)\n\nNotes for reviewers:\n\n- I\u0027d suggest starting with CHANGES.md to get an overview of what changed, then skimming the tickets in the commit message.\n- The CLI tools all changed in similar ways: they use two new constructor options (see the block comment above the constructor for details), they use bunyan log level \u0027fatal\u0027 by default (to avoid emitting bunyan output unless it\u0027s requested), and they use cmdutil.fail() to print errors in a uniform way.  (They previously had no \u0027error\u0027 listener, which meant that they would crash with a stack trace.  However, errors usually didn\u0027t happen because of MORAY-361.)\n- The RPC files (lib/buckets.js, lib/objects.js, lib/tokens.js) look like they\u0027ve got more delta than they really do because I moved the RPC implementation functions up.  I think this is clearer for readers looking at the new code.  The new implementations are also more concise and have less boilerplate.\n- A few miscellaneous RPC calls (ping, version/versionInternal, and sql) were in lib/client.js. I separated these out into lib/meta.js.\n\nIn terms of sunny-day testing, I\u0027ve tested:\n\n- the moray test suite\n- the libmanta test suite using moray v2\n- the muskie test suite using moray v2 within itself (used in the picker and medusa), within its \"marlin\" dependency (used for working with jobs), and within its \"libmanta\" dependency\n- the marlin test suite using the above-modified muskie, plus a marlin agent and jobsupervisor using moray v2 within itself and its copy of libmanta.\n\nThere are many other components that use moray that I have not yet tested, including minnow and many Triton components, but I think this is enough coverage to believe that the changes are basically sound.\n\nIn terms of failure testing, I started load using \"mlive\".  All of the following resulted in little to no impact (i.e., occasional, transient errors):\n\n- restarting electric-moray processes\n- restarting moray processes\n- restarting haproxy processes inside moray and electric-moray zones\n- disabling haproxy inside moray and electric-moray zones\n\nI also tested:\n\n- Disabling registrar.  As expected, this took a minute or two to propagate, but resulted in muskie not using that zone any more.\n- Disabling registrar in all zones for a given Moray.  Cueball actually hangs onto the last backends it knew about in this case, so it did not affect service.  However, I disabled haproxy in that last zone, which did cause requests to fail until I brought them back up.\n- Partitioning off electric-moray and moray zones using ipdadm.  This caused some requests to hang for several minutes until the sockets timed out, at which point things started failing quickly.  This is suboptimal but expected.\n- Partitioning off a binder zone.  This resulted in an elevated error rate for several minutes (it never stopped), but I think that\u0027s likely a result of components that hadn\u0027t been updated.\n\nIn all cases, the system recovered when at least one dependency was brought online."},{"timestamp":1476290937,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 3."},{"timestamp":1476291010,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476392207,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Topic set to MORAY-346"},{"timestamp":1476392425,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\nHere\u0027s a smaller change for the updates to the test suite: https://cr.joyent.us/682"},{"timestamp":1476393227,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\nAnother note on testing: I also ran the stress-client test for 55 minutes to look for memory leaks or other rare issues.  Here\u0027s the final result:\nhttps://gist.github.com/davepacheco/c36520056ea7b6a85f178ef107cf8099\n\nI\u0027m satisfied that there are no leaks or issues uncovered by that test.  It ultimately crashed because it failed to start a server within an allotted timeout, which is more likely a result of load (and can\u0027t really be a client problem)."},{"timestamp":1476402234,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Code-Review+1\n\n(13 comments)"},{"timestamp":1476404686,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(13 comments)\n\nThanks for taking a look at this!  I believe I\u0027ve incorporated all of the feedback into patchset 4.  I\u0027ve successfully run the moray test suite using this new version."},{"timestamp":1476404693,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 4."},{"timestamp":1476404717,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476406007,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Code-Review+1\n\nThis looks great to me. Thanks, Dave!"},{"timestamp":1476487725,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1\n\n(2 comments)\n\nThis looks sharp, Dave.  Nice work"},{"timestamp":1476488539,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 5."},{"timestamp":1476488585,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476488974,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1476490902,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1476492273,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1476492837,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1476493233,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by David Pacheco"},{"timestamp":1563212284,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6:\n\n(2 comments)\n\n\u003e Another note on testing: I also ran the stress-client test for 55\n \u003e minutes to look for memory leaks or other rare issues.  Here\u0027s the\n \u003e final result:\n \u003e https://gist.github.com/davepacheco/c36520056ea7b6a85f178ef107cf8099\n \u003e \n \u003e I\u0027m satisfied that there are no leaks or issues uncovered by that\n \u003e test.  It ultimately crashed because it failed to start a server\n \u003e within an allotted timeout, which is more likely a result of load\n \u003e (and can\u0027t really be a client problem).\n\nI moved these test results into MORAY-346."}],"currentPatchSet":{"number":"6","revision":"a65aa319c7aefeed9fe1f506927c642c3ac16659","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/6","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476492837,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476488585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476488974,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476490902,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1476492273,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1476493233,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":22,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":73,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-25},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":22,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":914,"deletions":-389},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":215,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":230,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2578,"sizeDeletions":-1636},"patchSets":[{"number":"1","revision":"6e4a954f9335dccaad8140e149f205f6f54c901b","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/1","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476226423,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":true,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":15,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-23},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":23,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":911,"deletions":-386},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":223,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":239,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2520,"sizeDeletions":-1631},{"number":"2","revision":"d2af0a510b70ae63470ca7ad664244a9ec79b2c7","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476229260,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476229299,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"package.json","line":17,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Without service discovery, we don\u0027t need native-dns any more."},{"file":"package.json","line":19,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I removed all uses of once()."},{"file":"package.json","line":22,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I removed clone() in favor of jsprim.deepCopy(), since we wanted jsprim here anyway.\n\nNote that some code used the local function utils.clone(), which created a shallow copy.  I\u0027ve removed these uses."},{"file":"package.json","line":4,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is technically a major version bump, but it\u0027s one that should be easy for consumers to cross.  See CHANGES.md and RFD 33 for details."},{"file":"package.json","line":12,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This crossed a breaking change, which is that null objects are no longer accepted by assertplus.object().  I verified through code inspection that this will not break us here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":17,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":71,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-23},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":23,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":911,"deletions":-386},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":223,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":239,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2591,"sizeDeletions":-1631},{"number":"3","revision":"d3925c48f0126a1a37c06d6a3ba852481d79e722","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/3","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476290937,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476402234,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476291010,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/backfill","line":212,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This can just be: countReq.once(\u0027end\u0027, cb);"},{"file":"bin/backfill","line":212,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"bin/getobject","line":137,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Maybe move the client.close()\u0027s outside the conditional?"},{"file":"bin/getobject","line":137,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"bin/gettokens","line":107,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If I invoke this (or any of the other commands) with -v, should I also get the stack trace?"},{"file":"bin/gettokens","line":107,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you will see the stack trace only if the underlying client also logged whatever error is being reported.  (That behavior is hopefully not modified by this change.)"},{"file":"lib/buckets.js","line":240,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"What type of bad bucket are you concerned about here? One that has a bad set of pre and post functions?"},{"file":"lib/buckets.js","line":240,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Anything where obj.index, obj.pre, or the like are not valid JSON."},{"file":"lib/client.js","line":251,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Do you want an assert.optionalNumber() before this conditional, like with minTimeout and retries?"},{"file":"lib/client.js","line":251,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"There\u0027s one at line 182."},{"file":"lib/client.js","line":439,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"It would be nice if there were a message for each of these like \u0027\"host\" and \"cueballOptions\" cannot be used together\u0027 or \u0027\"port\" and \"cueballOptions\" are incompatible\u0027, so that when someone misuses the interface, they don\u0027t need to track down the line the assertion failed on."},{"file":"lib/client.js","line":439,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/client.js","line":527,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"It would be good to turn this into  Object.defineProperty(MorayClient.prototype, \u0027connected\u0027, ...) just after the constructor instead, since __defineGetter__ is deprecated."},{"file":"lib/client.js","line":527,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/client.js","line":694,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Need a semicolon at the end"},{"file":"lib/client.js","line":694,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/client.js","line":816,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Maybe use assert.equal() instead, so that if this fails the error message will have the details?"},{"file":"lib/client.js","line":816,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/client.js","line":837,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You should skip the slice, and just call this with \"arguments\"."},{"file":"lib/client.js","line":837,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/fast_connection.js","line":15,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"The opening curly brackets in this file are all on their own line, but in other files are at the end of the line that the function keyword is on. It seems like this file should either be consistent with the others, or the others should be consistent with this one."},{"file":"lib/fast_connection.js","line":15,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Good catch.  lib/pool.js and about half of lib/client.js also had this problem.  I\u0027ve updated those to use the existing style in this repo, which is braces at the end of the previous line."},{"file":"lib/pool.js","line":42,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Same as the other file. It seems like the repo should be consistent about its style."},{"file":"lib/pool.js","line":42,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/pool.js","line":218,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Does connDrain() get called again later on, after connRelease() happens?"},{"file":"lib/pool.js","line":218,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"connDrain() does not, but connDelete() is called from connRelease()."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":19,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":73,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-23},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":23,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":911,"deletions":-386},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":223,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":239,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2593,"sizeDeletions":-1631},{"number":"4","revision":"2b50d8440b8ff8c706485da809865b6b6e6bd4ba","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/4","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476404693,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476406007,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476404717,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476487725,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"lib/client.js","line":1309,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"s/this/that is/"},{"file":"lib/client.js","line":1309,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Done"},{"file":"lib/client.js","line":1387,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I presume this was originally named something like FastConnectionHandle?  The fch name seems a little weird in the current MorayRpcContext object."},{"file":"lib/client.js","line":1387,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Yup.  Good call.  I will replace this prefix with \"mc_\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":19,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":73,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-25},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":22,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":913,"deletions":-388},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":215,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":230,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2577,"sizeDeletions":-1635},{"number":"5","revision":"33f9a7266f969507bd6d1c2d40e436502e0778ad","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/5","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476488539,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1476492273,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476488974,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476488585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476490902,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":19,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":73,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-25},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":22,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":914,"deletions":-389},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":215,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":230,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2578,"sizeDeletions":-1636},{"number":"6","revision":"a65aa319c7aefeed9fe1f506927c642c3ac16659","parents":["fd5781bc25a9bfe2ba82167664639753fb9f0ca5"],"ref":"refs/changes/52/652/6","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1476492837,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1476493233,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1476492273,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476488974,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476488585,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476490902,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":22,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":73,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/backfill","type":"MODIFIED","insertions":29,"deletions":-25},{"file":"bin/delbucket","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"bin/delmany","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/delobject","type":"MODIFIED","insertions":16,"deletions":-14},{"file":"bin/findobjects","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/getbucket","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/getobject","type":"MODIFIED","insertions":22,"deletions":-20},{"file":"bin/gettokens","type":"ADDED","insertions":116,"deletions":0},{"file":"bin/listbuckets","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"bin/morayping","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"bin/morayversion","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/putbucket","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"bin/putobject","type":"MODIFIED","insertions":18,"deletions":-20},{"file":"bin/reindexobjects","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"bin/sql","type":"MODIFIED","insertions":11,"deletions":-7},{"file":"bin/updatemany","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"lib/buckets.js","type":"MODIFIED","insertions":209,"deletions":-228},{"file":"lib/client.js","type":"MODIFIED","insertions":914,"deletions":-389},{"file":"lib/connection_pool.js","type":"DELETED","insertions":0,"deletions":-156},{"file":"lib/dns.js","type":"DELETED","insertions":0,"deletions":-164},{"file":"lib/fast_connection.js","type":"ADDED","insertions":215,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-19},{"file":"lib/meta.js","type":"ADDED","insertions":187,"deletions":0},{"file":"lib/objects.js","type":"MODIFIED","insertions":199,"deletions":-254},{"file":"lib/pool.js","type":"ADDED","insertions":230,"deletions":0},{"file":"lib/ring.js","type":"DELETED","insertions":0,"deletions":-130},{"file":"lib/rpc.js","type":"ADDED","insertions":180,"deletions":0},{"file":"lib/tokens.js","type":"MODIFIED","insertions":31,"deletions":-60},{"file":"lib/utils.js","type":"DELETED","insertions":0,"deletions":-71},{"file":"package.json","type":"MODIFIED","insertions":9,"deletions":-8}],"sizeInsertions":2578,"sizeDeletions":-1636}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}