From 0d173c3d35d1ab5189b56c6ec91d245c7a2e9494 Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Fri, 22 Dec 2017 18:09:07 -0500
Subject: [PATCH] TRITON-24 node-triton ListNetworkIPs has unordered results

---
 lib/common.js                   | 28 +++++++++++++++++++++++++++-
 lib/do_network/do_ip/do_list.js | 16 +++++++++++++++-
 package.json                    |  2 +-
 3 files changed, 43 insertions(+), 3 deletions(-)

diff --git a/lib/common.js b/lib/common.js
index 9db8f30..1dfb7b0 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -1387,6 +1387,31 @@ function validateObject(input, valid, opts) {
     }
 }
 
+/*
+ * Convert an IPv4 address (as a string) to a number
+ */
+function ipv4ToLong(ip) {
+    var l = 0;
+    var spl;
+
+    assert.string(ip, 'ip');
+    spl = ip.split('.');
+    assert.equal(spl.length, 4, 'ip octet length');
+
+    spl.forEach(function processIpOctet(octet) {
+        octet = parseInt(octet, 10);
+
+        assert.number(octet, 'octet');
+        assert(octet >= 0, 'octet >= 0');
+        assert(octet < 256, 'octet < 256');
+
+        l <<= 8;
+        l += octet;
+    });
+
+    return l;
+}
+
 //---- exports
 
 module.exports = {
@@ -1425,6 +1450,7 @@ module.exports = {
     jsonPredFromKv: jsonPredFromKv,
     monotonicTimeDiffMs: monotonicTimeDiffMs,
     readStdin: readStdin,
-    validateObject: validateObject
+    validateObject: validateObject,
+    ipv4ToLong: ipv4ToLong
 };
 // vim: set softtabstop=4 shiftwidth=4:
diff --git a/lib/do_network/do_ip/do_list.js b/lib/do_network/do_ip/do_list.js
index 854045d..9c010be 100644
--- a/lib/do_network/do_ip/do_list.js
+++ b/lib/do_network/do_ip/do_list.js
@@ -41,7 +41,21 @@ function do_list(subcmd, opts, args, callback) {
     }
     columns = columns.split(',');
 
-    var sort = opts.s.split(',');
+    var sort = opts.s.split(',').map(function mapSort(field) {
+        var obj = {
+            field: field
+        };
+
+        switch (field) {
+        case 'ip':
+            obj.keyFunc = common.ipv4ToLong;
+            break;
+        default:
+            break;
+        }
+
+        return obj;
+    });
 
     vasync.pipeline({arg: {cli: this.top}, funcs: [
         common.cliSetupTritonApi,
diff --git a/package.json b/package.json
index 43a7a58..1096f50 100644
--- a/package.json
+++ b/package.json
@@ -25,7 +25,7 @@
     "sshpk": "1.10.2",
     "sshpk-agent": "1.4.2",
     "strsplit": "1.0.0",
-    "tabula": "1.9.0",
+    "tabula": "1.10.0",
     "vasync": "1.6.3",
     "verror": "1.10.0",
     "which": "1.2.4",
-- 
2.21.0

