commit b751d9dc133205bf1a81b28b8eec0ddc2a1cc19f (refs/changes/32/2532/5)
Author: Orlando Vazquez <ovazquez@gmail.com>
Date:   2017-09-11T14:12:19-07:00 (2 years, 1 month ago)
    
    DOCKER-1100 Hung docker cp connections cause sdc-docker descriptor growth

diff --git a/lib/endpoints/containers.js b/lib/endpoints/containers.js
index 0819881..c1041d4 100644
--- a/lib/endpoints/containers.js
+++ b/lib/endpoints/containers.js
@@ -19,6 +19,9 @@ var getVmInState = common.getVmInState;
 var validate = require('../validate');
 
 
+// How long to wait between docker copy data events.
+var DATA_TIMEOUT_MS = 60 * 2 * 1000;
+
 
 // ---- internal support stuff
 
@@ -760,7 +763,6 @@ function containerReadArchive(req, res, next) {
         var statHeader = new Buffer(JSON.stringify(
             extras.containerPathStat)).toString('base64');
 
-
         readSocket.on('connect', function () {
             res.setHeader('content-type', 'application/tar');
             res.setHeader('x-docker-container-path-stat', statHeader);
@@ -771,6 +773,24 @@ function containerReadArchive(req, res, next) {
                     opts.vm.uuid, e.message);
             });
 
+            /*
+             * If a connection hangs (i.e. it stops emitting 'data' events
+             * without closing) we'll see unwanted growth in the number of used
+             * file descriptors in sdc-docker. In addition, the still-running
+             * tar process on the cn-agent/compute-node side will prevent a
+             * zone from shutting down.
+             *
+             * To mitigate this, we will set a timeout on how long to wait
+             * between data events before giving up.
+             */
+
+            readSocket.setTimeout(DATA_TIMEOUT_MS);
+            readSocket.on('timeout', function () {
+                log.error('onConnectionZoneRunning(read): '
+                        + 'data timeout; terminating archive process');
+                readSocket.destroy();
+            });
+
             readSocket.pipe(res);
             next();
         });
