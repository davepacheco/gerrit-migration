{"project":"joyent/sdc-cnapi","branch":"master","id":"Ie746773346dc5a7005c73187e0bb232825db93d1","number":"1335","subject":"NET-367 sysinfo-refresh should be more hesitant about deleting NICs from NAPI Reviewed by: Cody Mello \u003ccody.mello@joyent.com\u003e Reviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e Approved by: Orlando Vazquez \u003corlando@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/1335","commitMessage":"NET-367 sysinfo-refresh should be more hesitant about deleting NICs from NAPI\nReviewed by: Cody Mello \u003ccody.mello@joyent.com\u003e\nReviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e\nApproved by: Orlando Vazquez \u003corlando@joyent.com\u003e\n","createdOn":1485354227,"lastUpdated":1486658138,"open":false,"status":"MERGED","comments":[{"timestamp":1485354227,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1485354275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485355628,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1:\n\nThis change removes the delete_nics step from the sysinfo-refresh workflow. `make prepush` looks good. \n\nTo directly test this change I\u0027ve created VNICs intended for a server\u0027s GZ directly in NAPI against the /nics endpoint. The result of this is a VNIC created in NAPI, but the server is not yet aware of this VNIC (it doesn\u0027t exist in the server or CNAPI\u0027s sysinfo). I subsequently ran a sysinfo-refresh job and confirmed that the VNIC was not deleted from NAPI, even though it doesn\u0027t exist on the server. Prior to this change, this would have deleted the VNIC from NAPI (except for a nic with the \"underlay\" property set to true). \n\nIn my tests I used the compute node in CoaL. Because the code made reference to the underlay VNIC, I\u0027ve tested creating VNICs on an underlay network (as created by `sdcadm post-setup underlay-nics`), as well as VNICs created on other networks (in my case testing the \"external\" network). \n\nIn NET-367 I made reference to CNAPI-675 where aggregations are also deleted. I would like to prevent the deletion of aggregations, also, but I haven\u0027t bundled it into this change. Let me know if this would be best addressed here and I\u0027ll make some changes."},{"timestamp":1485523204,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1485523232,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485525417,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\nPS 2 adds the change in updateAggrs that prevents aggregations from being deleted if they don\u0027t exist on the server (as discussed in NET-367).\n\nI\u0027m not a huge fan of a seemingly duplicate callback out of this function (471 \u0026 508), but I feel they do convey different things. The first is if there are 0 aggregations found at all, in which case we return quickly and with an appropriate message. The second callback is for when we\u0027ve determined that there _are_ aggregations, but there is no action to perform against NAPI. Previously we would have looked at deletes as an action to perform, but these are no longer considered.\n\nTo test this I\u0027ve tried a mix of scenarios where an aggregations exists in either NAPI or on the server and the sysinfo-refresh workflow appears to work as expected. Notable examples:\n\n- No aggrs: \"No aggregations found\"\n- Aggr in NAPI, not on server\u0027s sysinfo: \"No aggregations to update\"\n- Aggr on server, not in NAPI: aggr created in NAPI"},{"timestamp":1485813384,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1485856460,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1485856488,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485856492,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1486027203,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1486402582,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1486402609,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1486493362,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1486495437,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\nPlease make sure you describe in the JIRA ticket how this is tested before you integrate it."},{"timestamp":1486571539,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n\u003e Please make sure you describe in the JIRA ticket how this is tested\n \u003e before you integrate it.\n\nSure thing. I\u0027ve summarised my test notes from this change\u0027s comment history into NET-367."},{"timestamp":1486654826,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1486658138,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"5","revision":"e746773346dc5a7005c73187e0bb232825db93d1","parents":["8b72e0f7f9dbf9ad4fce3f451991b7fcd26ce5c9"],"ref":"refs/changes/35/1335/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1486654826,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485856488,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486027203,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486493362,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486493362,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1486658138,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/workflows/server-sysinfo.js","type":"MODIFIED","insertions":15,"deletions":-70}],"sizeInsertions":15,"sizeDeletions":-70},"patchSets":[{"number":"1","revision":"36feb6d766c9c2a6dfc8b4c85744256b412d9679","parents":["8eba445e91bcef134207cd02a2e09f1216a0f57e"],"ref":"refs/changes/35/1335/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1485354227,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485354275,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/workflows/server-sysinfo.js","type":"MODIFIED","insertions":7,"deletions":-55}],"sizeInsertions":7,"sizeDeletions":-55},{"number":"2","revision":"420ace08b4493850171fed74ebb8da75b8e925a2","parents":["8eba445e91bcef134207cd02a2e09f1216a0f57e"],"ref":"refs/changes/35/1335/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1485523204,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485813384,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485523232,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/workflows/server-sysinfo.js","line":18,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s say \"nics and aggrs\" on both of these lines, to make it clear that the workflow also touches aggregations."},{"file":"lib/workflows/server-sysinfo.js","line":18,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/workflows/server-sysinfo.js","type":"MODIFIED","insertions":13,"deletions":-68}],"sizeInsertions":13,"sizeDeletions":-68},{"number":"3","revision":"ba23146e2f55003664f7ac9735ad78432f947e5a","parents":["8eba445e91bcef134207cd02a2e09f1216a0f57e"],"ref":"refs/changes/35/1335/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1485856460,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486027203,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485856488,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/workflows/server-sysinfo.js","type":"MODIFIED","insertions":15,"deletions":-70}],"sizeInsertions":15,"sizeDeletions":-70},{"number":"4","revision":"56eb2f7dfd87ee6a322843f2fe6b99747c58adc9","parents":["8b72e0f7f9dbf9ad4fce3f451991b7fcd26ce5c9"],"ref":"refs/changes/35/1335/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1486402582,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486027203,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485856488,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486493362,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486493362,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/workflows/server-sysinfo.js","type":"MODIFIED","insertions":15,"deletions":-70}],"sizeInsertions":15,"sizeDeletions":-70},{"number":"5","revision":"e746773346dc5a7005c73187e0bb232825db93d1","parents":["8b72e0f7f9dbf9ad4fce3f451991b7fcd26ce5c9"],"ref":"refs/changes/35/1335/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1486654826,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486027203,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485856488,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486493362,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486493362,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1486658138,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/workflows/server-sysinfo.js","type":"MODIFIED","insertions":15,"deletions":-70}],"sizeInsertions":15,"sizeDeletions":-70}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}