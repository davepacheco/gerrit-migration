{"project":"joyent/illumos-joyent","branch":"master","id":"Ic6f48adc748c5507279a550ec38b3545c1e8a07b","number":"1296","subject":"OS-5904 pwritev64 can\u0027t write at offsets between [2 GiB, 4 GiB) Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1296","commitMessage":"OS-5904 pwritev64 can\u0027t write at offsets between [2 GiB, 4 GiB)\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1484847727,"lastUpdated":1485274019,"open":false,"status":"MERGED","comments":[{"timestamp":1484847727,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1484850523,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1484926383,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1484930858,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1484930878,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nI consolidated and cleaned up the redundant code."},{"timestamp":1484931065,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1484931432,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1484932241,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1484956360,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1484956779,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1484957531,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1485030382,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1485118958,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1485125084,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1485194181,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1\n\nI\u0027m not 100% certain one way or the other what the right call is here, but I\u0027ll defer to your analysis. Thanks Jerry!"},{"timestamp":1485272066,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1485273834,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1485273964,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1485274019,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"7","revision":"c6f48adc748c5507279a550ec38b3545c1e8a07b","parents":["612a197d487a92d1c352e002725b94af3c030d6e"],"ref":"refs/changes/96/1296/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485273964,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485194181,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1485274019,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":59,"deletions":-100}],"sizeInsertions":59,"sizeDeletions":-100},"patchSets":[{"number":"1","revision":"359750d837ac1a620c4a14ea856b31869362055c","parents":["d5b602f5cc96d493c2cbc1851eefbc5b297e6576"],"ref":"refs/changes/96/1296/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484847727,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":35,"deletions":-15}],"sizeInsertions":35,"sizeDeletions":-15},{"number":"2","revision":"b846969f112b30819cbb97e64f661a996bec00c8","parents":["b9c647a9c13d987816a1d4cd2f9a21512d559949"],"ref":"refs/changes/96/1296/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484850523,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"usr/src/uts/common/syscall/rw.c","line":1003,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/syscall/rw.c","line":1005,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/syscall/rw.c","line":1437,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027s not clear to me why we shouldn\u0027t merge this check with the amended one up at L1334.  They both yield the same errors for overage conditions, just with different comparison values.  None of the other rw methods seem to perform the check twice like this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":35,"deletions":-15}],"sizeInsertions":35,"sizeDeletions":-15},{"number":"3","revision":"0d9b97a4ac67ed3fa0dff37e9d6e768fc01cc27e","parents":["bc87e8c6458e3355e50c0d5254bf71793da68947"],"ref":"refs/changes/96/1296/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484930858,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/syscall/rw.c","line":1342,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"singular is probably fine here"},{"file":"usr/src/uts/common/syscall/rw.c","line":1376,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"v_type is already tested against VREG at L1337"},{"file":"usr/src/uts/common/syscall/rw.c","line":1376,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I caught this and fixed it in a subsequent update."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":45,"deletions":-61}],"sizeInsertions":45,"sizeDeletions":-61},{"number":"4","revision":"ab9f4917f10d03bea2a83fa6291388a3d1717b51","parents":["bc87e8c6458e3355e50c0d5254bf71793da68947"],"ref":"refs/changes/96/1296/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1484931065,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/syscall/rw.c","line":1007,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we expand in this comment about the fact that we\u0027re relying on the split signed off_t becoming an unsigned value and therefore larger than MAXOFF?"},{"file":"usr/src/uts/common/syscall/rw.c","line":1007,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Will do"},{"file":"usr/src/uts/common/syscall/rw.c","line":1108,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m not quite sure why we have to do this dance for preadv, but when it comes to pwritev we can use the OFFSET_MAX macro. Mind clarifying that?"},{"file":"usr/src/uts/common/syscall/rw.c","line":1108,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027ll update the comment."},{"file":"usr/src/uts/common/syscall/rw.c","line":1108,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I think this code could actually benefit from similar changes that I made for pwrite, so I am going to do that before I update the CR."},{"file":"usr/src/uts/common/syscall/rw.c","line":1335,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What comment in write() is this referring to? I couldn\u0027t figure that out."},{"file":"usr/src/uts/common/syscall/rw.c","line":1335,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I preserved this comment from the old code, but I agree that it is not clear so I\u0027ll improve it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":45,"deletions":-61}],"sizeInsertions":45,"sizeDeletions":-61},{"number":"5","revision":"a2455b8ce4ab56b519c59b70c5e7be8ca6801f5b","parents":["855743dd7d47afe17f1b7eca99ff457919fdef70"],"ref":"refs/changes/96/1296/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485030382,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485194181,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/syscall/rw.c","line":1417,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"write(2) seems to do this inside of the vop_rwlock. Is it safe for us to do this outside of it or should we have only ever done it inside of it?"},{"file":"usr/src/uts/common/syscall/rw.c","line":1417,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"There is nothing in this check that is being protected by the rwlock so it is safe to do it outside."},{"file":"usr/src/uts/common/syscall/rw.c","line":1128,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it correct to move this earlier? My reading of the comment in read(2) is that we actually need to do this check inside of the VOP_RWLOCK()."},{"file":"usr/src/uts/common/syscall/rw.c","line":1128,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I don\u0027t  agree with the comment in read(2), but I can change this back if it seems to be too much of a change.\n\nThere are two cases to consider here:\n\n1) This is a large-file or 64bit app with an offset that exceeds the 64bit\n   max. The file size check doesn\u0027t matter since fileoff will always be\n   larger, so we will always return 0.\n2) This is a 32-bit app with an offset that exceeds the 32bit max. We will\n   never be able to read any data from a file with this offset so the only \n   difference is if we return 0 vs. EOVERFLOW. The only time holding the\n   lock will matter is if a 64-bit app is simultaneously changing the file\n   size to cross the 32-bit max size boundary. I cannot really see how\n   any32-bit program could be realistically broken by this behavior \n   on an excessively large offset but I can move it back down inside the\n   rwlock if you disagree."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":59,"deletions":-100}],"sizeInsertions":59,"sizeDeletions":-100},{"number":"6","revision":"2d7e957fa430affc4dd453bc9bbfebe0bb971b34","parents":["612a197d487a92d1c352e002725b94af3c030d6e"],"ref":"refs/changes/96/1296/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485273834,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485194181,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":59,"deletions":-100}],"sizeInsertions":59,"sizeDeletions":-100},{"number":"7","revision":"c6f48adc748c5507279a550ec38b3545c1e8a07b","parents":["612a197d487a92d1c352e002725b94af3c030d6e"],"ref":"refs/changes/96/1296/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1485273964,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485194181,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1485274019,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485272066,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/syscall/rw.c","type":"MODIFIED","insertions":59,"deletions":-100}],"sizeInsertions":59,"sizeDeletions":-100}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}