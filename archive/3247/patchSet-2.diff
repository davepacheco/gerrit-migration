From 9be5e6870224b7e3214716e51381568ed5eecda8 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 23 Jan 2018 09:46:16 -0800
Subject: [PATCH] =?UTF-8?q?TRITON-66=20'sdcadm=20experimental=20update-oth?=
 =?UTF-8?q?er'=20crashes=20on=20a=20non-master/non-release=20SAPI=20image?=
 =?UTF-8?q?=20version=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<?=
 =?UTF-8?q?pedro@joyent.com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Can?=
 =?UTF-8?q?del=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/steps/sapi.js | 16 ++++++++++++----
 1 file changed, 12 insertions(+), 4 deletions(-)

diff --git a/lib/steps/sapi.js b/lib/steps/sapi.js
index 74003f3..315d7f6 100644
--- a/lib/steps/sapi.js
+++ b/lib/steps/sapi.js
@@ -144,13 +144,21 @@ function sapiEnsureAgentServices(arg, cb) {
                     MIN_VALID_SAPI_VERSION;
             } else if (splitVersion[0] === 'release') {
                 validSapi = splitVersion[1] >= MIN_VALID_SAPI_VERSION;
+            } else {
+                progress('Warning: cannot verify that SAPI is at least of ' +
+                    '%s vintage, because a non-master/non-release SAPI ' +
+                    'image is being used.', MIN_VALID_SAPI_VERSION);
+                validSapi = true;
             }
 
             if (!validSapi) {
-                return next(new errors.SDCClientError(new Error('Datacenter ' +
-                    'does not have the minimum SAPI version needed for adding' +
-                    ' service agents. ' +
-                    'Please try again after upgrading SAPI', 'sapi')));
+                return next(new errors.SDCClientError(
+                    new Error(util.format('SAPI in this datacenter is using ' +
+                        'image version %s, which is not the minimum version ' +
+                        'required for adding service agents (%s). Please ' +
+                        'upgrade SAPI and then retry.', img.version,
+                        MIN_VALID_SAPI_VERSION)),
+                    'sapi'));
             }
 
             return next();
-- 
2.21.0

