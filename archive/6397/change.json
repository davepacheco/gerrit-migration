{"project":"joyent/node-zkstream","branch":"master","id":"I755b53f2118c16eb587d2ac264db2cfba1e91616","number":"6397","subject":"joyent/node-zkstream#40 Fallback poll for watchers to panic on missed notifications Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/6397","commitMessage":"joyent/node-zkstream#40 Fallback poll for watchers to panic on missed notifications\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1559759023,"lastUpdated":1559778811,"open":false,"status":"MERGED","comments":[{"timestamp":1559759023,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1559759049,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n fatal: ref HEAD is not a symbolic ref\n deps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dtools/jsl.node.conf lib/client.js lib/zk-streams.js lib/jute-buffer.js lib/zk-consts.js lib/errors.js lib/zk-buffer.js lib/zk-session.js lib/connection-fsm.js lib/index.js test/multi-node.test.js test/streams.test.js test/nasty.test.js test/zkserver.js test/basic.test.js test/utils.js\n /tmp/repo/lib/client.js\n /tmp/repo/lib/zk-streams.js\n /tmp/repo/lib/jute-buffer.js\n /tmp/repo/lib/zk-consts.js\n /tmp/repo/lib/errors.js\n /tmp/repo/lib/zk-buffer.js\n /tmp/repo/lib/zk-session.js\n /tmp/repo/lib/connection-fsm.js\n /tmp/repo/lib/index.js\n /tmp/repo/test/multi-node.test.js\n /tmp/repo/test/streams.test.js\n /tmp/repo/test/nasty.test.js\n /tmp/repo/test/zkserver.js\n /tmp/repo/test/basic.test.js\n /tmp/repo/test/basic.test.js(1292): warning: variable is declared but never referenced: ret\n /tmp/repo/test/utils.js\n gmake: *** [tools/mk/Makefile.targ:196: check-jsl-node] Error 1"},{"timestamp":1559759390,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1559759437,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559761126,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1559763191,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1559765985,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1559770471,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1559770515,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559770820,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1559772324,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1559778626,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1559778767,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1559778772,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1559778811,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"3a8628ffea851d46880b2ed499189a07e243bad3","parents":["5fb47ab5636295fbceb2f1fd53d07166b84cda66"],"ref":"refs/changes/97/6397/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559778767,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559770515,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770820,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559772324,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1559778772,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":122,"deletions":-46}],"sizeInsertions":122,"sizeDeletions":-46},"patchSets":[{"number":"1","revision":"3531a929c7061aa7a4b520b7590891aeb88defe0","parents":["8f639bbf7618629dc11e3d993bf8e3160b3d5222"],"ref":"refs/changes/97/6397/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559759023,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559759049,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":73,"deletions":0}],"sizeInsertions":73,"sizeDeletions":0},{"number":"2","revision":"fbcdba64bc4ba85afe246c050a352ca3a715af00","parents":["b38351a6882ca01a1b57dfd2bea0b2201b0c0d86"],"ref":"refs/changes/97/6397/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559759390,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559759437,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/zk-session.js","line":667,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Shouldn\u0027t this be updated to better describe and explain how the double check works?"},{"file":"lib/zk-session.js","line":667,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yeah it should, sorry."},{"file":"lib/zk-session.js","line":927,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I have to be honest, I\u0027m having trouble convincing myself of these changes. Why do we go to armed straight from attached? What implies that we\u0027re still connected and that we can make that transition?\n\nWith respect to this, if we\u0027re not connected, why do we go to armed. I feel like I\u0027m missing something that this is trying to catch here."},{"file":"lib/zk-session.js","line":927,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"\"straight from attached\"? We\u0027re not in \"attached\" here -- that\u0027s a state of the ZKSession, not the ZKWatchEvent. The ZKWatchEvent can still be in \"armed\" when the ZKSession has detached -- we will receive the disconnect notification shortly, but it\u0027s not guaranteed to be in the same turn of the event loop.\n\nWe return to the \"armed\" base state here because we\u0027re about to get the \"disconnectAsserted\" or \"notifyAsserted\" if one of these conditions is true. Those handlers also apply in this armed.doublecheck substate, but we should just go back to plain \"armed\" and handle it there since we\u0027re not actually doing the doublecheck in that case."},{"file":"lib/zk-session.js","line":927,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think I got the state of the underlying session confused with the state of the watcher, sorry. That makes a lot more sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":73,"deletions":0}],"sizeInsertions":73,"sizeDeletions":0},{"number":"3","revision":"755b53f2118c16eb587d2ac264db2cfba1e91616","parents":["b38351a6882ca01a1b57dfd2bea0b2201b0c0d86"],"ref":"refs/changes/97/6397/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559770471,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770820,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559772324,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559770515,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/zk-session.js","line":661,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it worth mentioning that this can transition to a place where it throws an exception and aborts?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":122,"deletions":-46}],"sizeInsertions":122,"sizeDeletions":-46},{"number":"4","revision":"e7fd382934686e2fb72521a351c6e1314b669e10","parents":["b38351a6882ca01a1b57dfd2bea0b2201b0c0d86"],"ref":"refs/changes/97/6397/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559778626,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770820,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559772324,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559770515,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":122,"deletions":-46}],"sizeInsertions":122,"sizeDeletions":-46},{"number":"5","revision":"3a8628ffea851d46880b2ed499189a07e243bad3","parents":["5fb47ab5636295fbceb2f1fd53d07166b84cda66"],"ref":"refs/changes/97/6397/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559778767,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770820,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1559778772,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559772324,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559770515,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":122,"deletions":-46}],"sizeInsertions":122,"sizeDeletions":-46}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}