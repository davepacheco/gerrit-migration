{"project":"joyent/sdc-imgapi","branch":"master","id":"I458258bdf0e7d52500005a978bb326223be9cec1","number":"3364","subject":"TRITON-98 Add artedi metrics collection to IMGAPI Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"url":"https://cr.joyent.us/3364","commitMessage":"TRITON-98 Add artedi metrics collection to IMGAPI\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1518636585,"lastUpdated":1519084928,"open":false,"status":"MERGED","comments":[{"timestamp":1518636585,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 1."},{"timestamp":1518636586,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit f72224b47061ca2c8dacf066677e660bb9483816\n    \n    add artedi metrics"},{"timestamp":1518738970,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1518739298,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1518817753,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 2."},{"timestamp":1518817754,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit db97425d36a3b5f96199fa33af253d9bfeab67b5\n    \n    makes cr fixes"},{"timestamp":1518817814,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1518819699,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1518822450,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 3."},{"timestamp":1518822451,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 80068280db6b03e4adeddfe5b1c9b3590a114515\n    \n    more cr fixes"},{"timestamp":1518822458,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\n(6 comments)"},{"timestamp":1518827452,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nassuming the tests pass, LGTM!"},{"timestamp":1518828364,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 4."},{"timestamp":1518828365,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 104bee54aa009e75017fa5a6c537791f1d2790fb\n    \n    more cr fixes\n    \n    commit 4e945d8ed2a6b7f7376437172553a072f1bff0b6\n    \n    makes cr fixes\n    \n    commit b6605f1006a55f7e71f91cd8e8d595b55f12b5df\n    \n    add artedi metrics"},{"timestamp":1518849281,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1518914786,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dylan Yep"},{"timestamp":1519082198,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1:\n\n\"make check\" passed ok"},{"timestamp":1519083301,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1519084433,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1519084434,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1519084928,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"4","revision":"458258bdf0e7d52500005a978bb326223be9cec1","parents":["fccbd408710a5ebdd5b83f24483ff87e49b8d526"],"ref":"refs/changes/64/3364/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518828364,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518849281,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518849281,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1518914786,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/operator-guide.md","type":"MODIFIED","insertions":39,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":71,"deletions":-30},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/metrics.dc-test.js","type":"ADDED","insertions":198,"deletions":0},{"file":"test/metrics.public-test.js","type":"ADDED","insertions":55,"deletions":0}],"sizeInsertions":498,"sizeDeletions":-31},"patchSets":[{"number":"1","revision":"0907796e63a507b32bf3373b50c711129114c236","parents":["6dc4233621511f8d7ec908e67bc5a37fcd24cce2"],"ref":"refs/changes/64/3364/1","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518636585,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/app.js","line":570,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"If we are adding new async usage, let\u0027s please use the `vasync` module. Usage of `async` in our services is deprecated.  While `async` has a number of conveniences, there has been some care in vasync to make debugging them (e.g. in crash dumps) easier."},{"file":"lib/app.js","line":570,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"Copyright (c) 2018, Joyent, Inc.\" format please, in general, per https://github.com/joyent/eng/blob/master/docs/index.md#copyright"},{"file":"lib/metrics.js","line":8,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/operator-guide.md","type":"MODIFIED","insertions":35,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":60,"deletions":-29},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/metrics.test.js","type":"ADDED","insertions":202,"deletions":0}],"sizeInsertions":432,"sizeDeletions":-30},{"number":"2","revision":"9edc1e2a94827637167ffb37fd6d14e603e36627","parents":["6dc4233621511f8d7ec908e67bc5a37fcd24cce2"],"ref":"refs/changes/64/3364/2","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518817753,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/app.js","line":304,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, I\u0027d be fine just making all these vars go away and do it all as one:\n\n```\nthis.metricsManager \u003d createMetricsManager({\n    ... all the config ...\n```\n\nbut that\u0027s just personal style. I don\u0027t have a justification. :)"},{"file":"lib/app.js","line":304,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/app.js","line":408,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think test on `if (this.metricsManager)`, then the test above can change (e.g. if we add a metricsManager for mode\u003dpublic later) without having to update the test here."},{"file":"lib/app.js","line":408,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/app.js","line":580,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ditto, perhaps test on `if (self.metricsManager)`."},{"file":"lib/app.js","line":580,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":88,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"would be nice to log the IP here. E.g. \"... started on http://1.2.3.4:8881\"."},{"file":"lib/metrics.js","line":88,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"test/metrics.dc-test.js","line":44,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why all this to just make `format(\u0027http://%s:%d\u0027, adminIp, 8881);`? I might be missing something."},{"file":"test/metrics.dc-test.js","line":44,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"No good reason. It\u0027s vestigial code from the muskie/early vmapi implementation."},{"file":"test/metrics.public-test.js","line":44,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh wow. I don\u0027t know that we need a metrics test for the mode\u003dpublic IMGAPI tests given that we\u0027re not adding a metrics server to it. Thoughts?"},{"file":"test/metrics.public-test.js","line":44,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"So my thinking was that it would be useful to have a test that ensures that the metrics config switch is working properly. If, for whatever reason, code gets moved around and createMetricsManager does fire in a public instance, the service may crash on a failed MetricsManager assertion if all the optional config variables aren\u0027t operator defined. I have no idea how likely this actually is in practice, but it felt like a relatively quick test to run to mitigate that possibility. I am very much willing to take this out if you think I\u0027m overthinking this/it\u0027s unnecessary overhead."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/operator-guide.md","type":"MODIFIED","insertions":39,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":74,"deletions":-30},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/metrics.dc-test.js","type":"ADDED","insertions":203,"deletions":0},{"file":"test/metrics.public-test.js","type":"ADDED","insertions":55,"deletions":0}],"sizeInsertions":506,"sizeDeletions":-31},{"number":"3","revision":"5d070c67c2fd2a3f166d992a60fb124fee5cba5b","parents":["6dc4233621511f8d7ec908e67bc5a37fcd24cce2"],"ref":"refs/changes/64/3364/3","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518822450,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518827452,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518827452,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/operator-guide.md","type":"MODIFIED","insertions":39,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":71,"deletions":-30},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/metrics.dc-test.js","type":"ADDED","insertions":198,"deletions":0},{"file":"test/metrics.public-test.js","type":"ADDED","insertions":55,"deletions":0}],"sizeInsertions":498,"sizeDeletions":-31},{"number":"4","revision":"458258bdf0e7d52500005a978bb326223be9cec1","parents":["fccbd408710a5ebdd5b83f24483ff87e49b8d526"],"ref":"refs/changes/64/3364/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518828364,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518849281,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518849281,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1518914786,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/operator-guide.md","type":"MODIFIED","insertions":39,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":71,"deletions":-30},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/metrics.dc-test.js","type":"ADDED","insertions":198,"deletions":0},{"file":"test/metrics.public-test.js","type":"ADDED","insertions":55,"deletions":0}],"sizeInsertions":498,"sizeDeletions":-31}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}]}