From 51182b3447f254910f3084fa163777afe479365f Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Wed, 19 Dec 2018 13:01:54 +0000
Subject: [PATCH] OS-6795 illumos-joyent build tools depend on platform Perl

---
 manifest                                 | 22 ----------------------
 usr/src/cmd/Makefile                     | 10 ++++++----
 usr/src/cmd/auditrecord/Makefile         |  8 +++++---
 usr/src/cmd/dtrace/demo/Makefile         | 10 ++++++----
 usr/src/cmd/dtrace/test/tst/Makefile.com |  4 +++-
 usr/src/lib/libc/Makefile                |  6 ++++--
 6 files changed, 24 insertions(+), 36 deletions(-)

diff --git a/manifest b/manifest
index 3b49d482aa..0dae29e117 100644
--- a/manifest
+++ b/manifest
@@ -2817,8 +2817,6 @@ d usr/include/amd64/sys 0755 root bin
 f usr/include/amd64/sys/kdi_regs.h 0644 root bin
 f usr/include/amd64/sys/privmregs.h 0644 root bin
 f usr/include/amd64/sys/privregs.h 0644 root bin
-f usr/include/apptrace.h 0644 root bin
-f usr/include/apptrace_impl.h 0644 root bin
 f usr/include/ar.h 0644 root bin
 f usr/include/archives.h 0644 root bin
 d usr/include/arpa 0755 root bin
@@ -4889,23 +4887,6 @@ d usr/lib 0755 root bin
 f usr/lib/0@0.so.1 0755 root bin
 s usr/lib/32=.
 s usr/lib/64=amd64
-d usr/lib/abi 0755 root bin
-d usr/lib/abi/amd64 0755 root bin
-f usr/lib/abi/amd64/apptrace.so.1 0755 root bin
-d usr/lib/abi/appcert 0755 root bin
-f usr/lib/abi/appcert/AppcertUtil.pm 0555 root bin
-f usr/lib/abi/appcert/abi_index 0555 root bin
-f usr/lib/abi/appcert/etc.alt 0444 root bin
-f usr/lib/abi/appcert/etc.scoped 0444 root bin
-f usr/lib/abi/appcert/etc.tweaks 0444 root bin
-f usr/lib/abi/appcert/etc.warn 0444 root bin
-f usr/lib/abi/appcert/static_prof 0555 root bin
-f usr/lib/abi/appcert/symcheck 0555 root bin
-f usr/lib/abi/appcert/symprof 0555 root bin
-f usr/lib/abi/appcert/symreport 0555 root bin
-f usr/lib/abi/apptrace.so.1 0755 root bin
-f usr/lib/abi/spec2map 0755 root bin
-f usr/lib/abi/spec2trace 0755 root bin
 d usr/lib/acct 0755 root bin
 f usr/lib/acct/acctcms 0555 root bin
 f usr/lib/acct/acctcon 0555 root bin
@@ -5540,8 +5521,6 @@ f usr/lib/fm/amd64/libseslog.so.1 0755 root bin
 s usr/lib/fm/amd64/libseslog.so=libseslog.so.1
 f usr/lib/fm/amd64/libtopo.so.1 0755 root bin
 s usr/lib/fm/amd64/libtopo.so=libtopo.so.1
-f usr/lib/fm/buildcode 0555 root bin
-f usr/lib/fm/bustcode 0555 root bin
 d usr/lib/fm/dict 0755 root bin
 f usr/lib/fm/dict/AMD.dict 0444 root bin
 f usr/lib/fm/dict/DISK.dict 0444 root bin
@@ -5560,7 +5539,6 @@ f usr/lib/fm/dict/STORAGE.dict 0444 root bin
 f usr/lib/fm/dict/SUNOS.dict 0444 root bin
 f usr/lib/fm/dict/TEST.dict 0444 root bin
 f usr/lib/fm/dict/ZFS.dict 0444 root bin
-f usr/lib/fm/dictck 0555 root bin
 d usr/lib/fm/eft 0755 root bin
 f usr/lib/fm/eft/disk.eft 0444 root bin
 f usr/lib/fm/eft/neptune_xaui.eft 0444 root bin
diff --git a/usr/src/cmd/Makefile b/usr/src/cmd/Makefile
index e303927b65..5e496c38db 100644
--- a/usr/src/cmd/Makefile
+++ b/usr/src/cmd/Makefile
@@ -509,8 +509,11 @@ sparc_SUBDIRS=		\
 	vntsd
 
 #
-# Commands that are messaged.  Note that 'lp' comes first
-# (see previous comment about 'lp'.)
+# Commands that are messaged.  Note that 'lp' comes first (see previous comment
+# about 'lp'.)
+#
+# We purposefully leave out auditrecord from illumos-joyent: it attempts to use
+# Perl modules constructed as part of the build alongside the native Perl.
 #
 MSGSUBDIRS=		\
 	abi		\
@@ -521,7 +524,6 @@ MSGSUBDIRS=		\
 	audit		\
 	auditconfig	\
 	auditd		\
-	auditrecord	\
 	auditset	\
 	auths		\
 	autopush	\
@@ -781,7 +783,7 @@ AUDITSUBDIRS=		\
 	auditreduce	\
 	auditset	\
 	auditstat	\
-	praudit		
+	praudit
 
 #
 # commands not owned by the systems group
diff --git a/usr/src/cmd/auditrecord/Makefile b/usr/src/cmd/auditrecord/Makefile
index 4f4670dfc9..fdf5213b3f 100644
--- a/usr/src/cmd/auditrecord/Makefile
+++ b/usr/src/cmd/auditrecord/Makefile
@@ -22,13 +22,15 @@
 # Copyright 2010 Sun Microsystems, Inc.  All rights reserved.
 # Use is subject to license terms.
 #
+# Copyright (c) 2018, Joyent, Inc.
+#
 
 include $(SRC)/cmd/Makefile.cmd
 
 ATTR =			audit_record_attr
 ROOTAUDITDIR =		$(ROOT)/usr/lib/audit
 
-SECURITYFILES = 	$(ATTR:%=$(ROOTAUDITDIR)/%)
+SECURITYFILES =		$(ATTR:%=$(ROOTAUDITDIR)/%)
 $(SECURITYFILES) :=	FILEMODE = $(LIBFILEMODE)
 
 PROG		= auditrecord
@@ -41,7 +43,7 @@ ADTXMLFILE	= $(LIBBSMDIR)/common/adt.xml
 
 .KEEP_STATE:
 
-all: $(PROG) $(ATTR) 
+all: $(PROG) $(ATTR)
 
 install: all $(ROOTUSRSBINPROG) install_data
 
@@ -59,7 +61,7 @@ clean:
 	$(RM) $(ATTR) $(STRIPTEXT) $(AGETTEXT)
 
 $(ATTR): $(STRIPTEXT) $(ATTRPROC) $(ADTXMLFILE) $(ATTR).txt
-	./$(STRIPTEXT) < $(ATTR).txt > $(ATTR)
+	$(PERL) ./$(STRIPTEXT) < $(ATTR).txt > $(ATTR)
 	$(PERL) -I $(LIBBSMDIR) ./$(ATTRPROC) $(ADTXMLFILE) >> $(ATTR)
 
 $(ROOTUSRSBINPROG): $(PROG)
diff --git a/usr/src/cmd/dtrace/demo/Makefile b/usr/src/cmd/dtrace/demo/Makefile
index a75a418a96..cfb35083ee 100644
--- a/usr/src/cmd/dtrace/demo/Makefile
+++ b/usr/src/cmd/dtrace/demo/Makefile
@@ -21,6 +21,8 @@
 #
 # Copyright (c) 2004, 2010, Oracle and/or its affiliates. All rights reserved.
 #
+# Copyright (c) 2018, Joyent, Inc.
+#
 
 include ../../Makefile.cmd
 
@@ -157,11 +159,11 @@ $(ROOTDEMODIR):
 $(ROOTDEMODIR)/%: %
 	$(INS.file)
 
-$(HTMLFILES):	$(DFILES) $(MKDEMO)	
-	./$(MKDEMO) $@
+$(HTMLFILES):	$(DFILES) $(MKDEMO)
+	$(PERL) ./$(MKDEMO) $@
 
-$(DFILES):	$(MKDEMO)	
-	./$(MKDEMO) $@
+$(DFILES):	$(MKDEMO)
+	$(PERL) ./$(MKDEMO) $@
 
 $(ROOTDEMOFILES): $(ROOTDEMODIR)
 
diff --git a/usr/src/cmd/dtrace/test/tst/Makefile.com b/usr/src/cmd/dtrace/test/tst/Makefile.com
index d4b787d5ec..336c68e086 100644
--- a/usr/src/cmd/dtrace/test/tst/Makefile.com
+++ b/usr/src/cmd/dtrace/test/tst/Makefile.com
@@ -23,6 +23,8 @@
 # Copyright 2008 Sun Microsystems, Inc.  All rights reserved.
 # Use is subject to license terms.
 #
+# Copyright (c) 2018, Joyent, Inc.
+#
 
 include $(SRC)/cmd/Makefile.cmd
 
@@ -109,6 +111,6 @@ scripts: FRC
 	@cd ../cmd/scripts; pwd; $(MAKE) install
 
 dstyle: FRC
-	@if [ -n "$(DSRCS)" ]; then $(DSTYLE) $(DSRCS); fi
+	@if [ -n "$(DSRCS)" ]; then $(PERL) $(DSTYLE) $(DSRCS); fi
 
 FRC:
diff --git a/usr/src/lib/libc/Makefile b/usr/src/lib/libc/Makefile
index 75a6406779..531020ee23 100644
--- a/usr/src/lib/libc/Makefile
+++ b/usr/src/lib/libc/Makefile
@@ -24,6 +24,8 @@
 # Copyright 2010 Nexenta Systems, Inc.  All rights reserved.
 # Use is subject to license terms.
 #
+# Copyright (c) 2018, Joyent, Inc.
+#
 
 LIBBASENAME=	libc
 LIBRARY=	$(LIBBASENAME:%=%.a)
@@ -104,7 +106,7 @@ ROOTVARIANTLIBS= $(VARIANTS:%=$(ROOTVARIANTDIR)/$(LIBBASENAME)_%.so.1)
 ROOTVARIANTLIBS64= $(VARIANTS64:%=$(ROOTVARIANTDIR64)/$(LIBBASENAME)_%.so.1)
 
 # definitions for install_h target
-BASEHDRS=	getxby_door.h 
+BASEHDRS=	getxby_door.h
 CHECKHDRS=	$(BASEHDRS:%.h=port/gen/%.check)
 HDRS=		$(BASEHDRS)
 
@@ -133,7 +135,7 @@ all:	all_h lib32 $(BUILD64) .WAIT lib64 .WAIT etc THIRDPARTYLICENSE
 
 THIRDPARTYLICENSE: extract-copyright
 	$(RM) $@
-	./extract-copyright . > $@
+	$(PERL) ./extract-copyright . > $@
 
 etc:	$($(MACH)_ETC)
 
-- 
2.21.0

