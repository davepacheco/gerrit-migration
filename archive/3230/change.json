{"project":"joyent/illumos-joyent","branch":"master","id":"I9f6b3ea11dce076cf9dd9f88c85a752702938873","number":"3230","subject":"OS-6562 lx_mremap broken under DEBUG build Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3230","commitMessage":"OS-6562 lx_mremap broken under DEBUG build\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1516228671,"lastUpdated":1517256260,"open":false,"status":"MERGED","comments":[{"timestamp":1516228671,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1516233134,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review-1\n\n(1 comment)"},{"timestamp":1516280714,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nThanks, I wasn\u0027t aware of ucopy, but it goes to the same place, so it works fine. I retested and the tests pass (as expected)."},{"timestamp":1516280726,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1516280863,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1516288302,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1516301141,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1516302117,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1516368902,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1516368939,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nSorry for the extra noise on this CR, but before integrating this I ran the mremap tests from LTP and hit another assertion failure. The details are in the ticket. I\u0027ve updated the CR and LTP, apt-get and lx-tests mremap are all passing clean now."},{"timestamp":1516668458,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1516802471,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nclose() was wrong here, so it is unsafe and the new code is safe. There is no way for another thread to do anything with the fd we\u0027re using here since it is a local variable in this function."},{"timestamp":1516904778,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1517242369,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(3 comments)\n\nA couple nits, but looks good otherwise."},{"timestamp":1517248076,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\nI made all of the suggested changes"},{"timestamp":1517248082,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6."},{"timestamp":1517248231,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1517250821,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1517256180,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1517256253,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1517256260,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"8","revision":"9f6b3ea11dce076cf9dd9f88c85a752702938873","parents":["42a73519e898cf2cf4a4216fa8528b2dedfe3551"],"ref":"refs/changes/30/3230/8","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517256253,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517248231,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517250821,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1517256260,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":41,"deletions":-21},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":43,"sizeDeletions":-23},"patchSets":[{"number":"1","revision":"6bf2b56eb6bc4783b5b33a5f8cc14c1be3a38418","parents":["3f0dd18067ae2e49a2f58cbeab0ddc5ef8ee1ec6"],"ref":"refs/changes/30/3230/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516228671,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1516233134,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":48,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please do not do this. Use ucopy()."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":12,"deletions":-3}],"sizeInsertions":12,"sizeDeletions":-3},{"number":"2","revision":"b993671cf110f4679a5f2a783dac67787e08095f","parents":["3f0dd18067ae2e49a2f58cbeab0ddc5ef8ee1ec6"],"ref":"refs/changes/30/3230/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516280726,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1516233134,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":7,"deletions":-3}],"sizeInsertions":7,"sizeDeletions":-3},{"number":"3","revision":"5a7a91db827e62c0733b56da2c4258f5d0549e93","parents":["3f0dd18067ae2e49a2f58cbeab0ddc5ef8ee1ec6"],"ref":"refs/changes/30/3230/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516280863,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516288302,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516301141,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516302117,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":516,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027s not clear to me why pr_getprot requires the higher lock, but all of its callers are content to fulfill that request so I guess I won\u0027t rock the boat."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":4,"sizeDeletions":-3},{"number":"4","revision":"8ddd87e94fc3b33c4b99c444d25eeeebd2a54997","parents":["6b5092032142a30ce4cc20f531c421740910f0cd"],"ref":"refs/changes/30/3230/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516368902,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1013,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"How does this compare to close() in terms of safety if, say, another thread in the process has blindly issued a syscall against the fd while we were performing the mapping?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":11,"deletions":-5}],"sizeInsertions":11,"sizeDeletions":-5},{"number":"5","revision":"681c4e79ff757b0fe9f9d884590b6d47bdf6b587","parents":["a8da368ba60a3b5c5d9b4ca9a216514f9a652c8e"],"ref":"refs/changes/30/3230/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1516904778,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":871,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Aliased by smaller-scope definitions below."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":990,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"style nit: maybe wrap these in parens to make it easier to visual parse, given the ternary already present?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1001,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any harm in making this a VERIFY0()?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":40,"deletions":-20},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":42,"sizeDeletions":-22},{"number":"6","revision":"88d1231471188b6354a6a2399ad8e6f79b41d710","parents":["7f072df6d4905b9c58c1d1b3df55d14a71be3739"],"ref":"refs/changes/30/3230/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517248082,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517248231,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517250821,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":41,"deletions":-21},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":43,"sizeDeletions":-23},{"number":"7","revision":"790594fb66494b55e7c9460d402368aa2e4112c1","parents":["42a73519e898cf2cf4a4216fa8528b2dedfe3551"],"ref":"refs/changes/30/3230/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517256180,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517248231,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517250821,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":41,"deletions":-21},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":43,"sizeDeletions":-23},{"number":"8","revision":"9f6b3ea11dce076cf9dd9f88c85a752702938873","parents":["42a73519e898cf2cf4a4216fa8528b2dedfe3551"],"ref":"refs/changes/30/3230/8","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1517256253,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1517256260,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517248231,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517250821,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":41,"deletions":-21},{"file":"usr/src/uts/common/os/grow.c","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":43,"sizeDeletions":-23}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}