From 6bf2b56eb6bc4783b5b33a5f8cc14c1be3a38418 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 17 Jan 2018 22:37:29 +0000
Subject: [PATCH] OS-6562 lx_mremap broken under DEBUG build

---
 usr/src/uts/common/brand/lx/syscall/lx_mem.c | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/syscall/lx_mem.c b/usr/src/uts/common/brand/lx/syscall/lx_mem.c
index 836edbfa14..e4b7255d62 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_mem.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_mem.c
@@ -12,7 +12,7 @@
 /*
  * Copyright 2006 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2017 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  */
 
 #include <sys/types.h>
@@ -44,6 +44,9 @@ extern struct seg_ops segspt_shmops;
 /* From uts/common/syscall/memcntl.c */
 extern int memcntl(caddr_t, size_t, int, caddr_t, int, int);
 
+/* From machine-specific ml/copy.s */
+extern void bcopy_altentry(const void *, void *, size_t);
+
 /*
  * After Linux 2.6.8, an unprivileged process can lock memory up to its
  * RLIMIT_MEMLOCK resource limit.
@@ -513,7 +516,8 @@ lx_get_mapping(uintptr_t find_addr, size_t find_size, lx_segmap_t *mp,
 	uint_t prot;
 	caddr_t saddr, eaddr, naddr;
 
-	AS_LOCK_ENTER(as, RW_READER);
+	/* pr_getprot asserts that the as is held as a writer */
+	AS_LOCK_ENTER(as, RW_WRITER);
 
 	seg = as_segat(as, (caddr_t)find_addr);
 	if (seg == NULL || (seg->s_flags & S_HOLE) != 0) {
@@ -1083,7 +1087,12 @@ lx_u2u_copy(void *src, void *dst, size_t len)
 			as_pageunlock(p_as, ppa_src, sp, mlen, S_READ);
 			return (EFAULT);
 		}
-		bcopy(sp, dp, mlen);
+
+		/*
+		 * This is ugly, but we use bcopy_altentry to bypass the bcopy
+		 * assertion for the kernelbase check under a DEBUG build.
+		 */
+		bcopy_altentry(sp, dp, mlen);
 		no_fault();		/* calls smap_enable */
 
 		as_pageunlock(p_as, ppa_dst, dp, mlen, S_WRITE);
-- 
2.21.0

