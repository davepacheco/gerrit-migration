From 6b889aaa32e1e6d44a16a3067f3273e56316b441 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Tue, 17 Oct 2017 13:21:46 -0700
Subject: [PATCH] DOCKER-1118 docker build should not set image min_platform

---
 CHANGES.md    |  4 ++++
 lib/images.js | 45 +--------------------------------------------
 package.json  |  2 +-
 3 files changed, 6 insertions(+), 45 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index c1a6958..5b69164 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,9 @@
 # IMGAPI changelog
 
+## 4.0.12
+
+- DOCKER-1118 docker build should not set image min_platform
+
 ## 4.0.11
 
 - joyent/node-docker-registry-client#23 Namespace validation too strict
diff --git a/lib/images.js b/lib/images.js
index fc6cfd4..ac8bfda 100644
--- a/lib/images.js
+++ b/lib/images.js
@@ -52,20 +52,6 @@ var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
 var ICON_CONTENT_TYPES = ['image/jpeg', 'image/gif', 'image/png'];
 
 
-/*
- * IMGAPI-251: If we're creating an incremental image, then we want to
- * make sure it is only used to provision on a server with an imgadm
- * that supports incremental images... or on any 6.5 platform (presuming
- * it has the latest provisioner agent which handles the origin image
- * installation).
- */
-var IMGAPI_251_MIN_PLATFORM = {
-    '7.0': '20130729T063445Z',
-    // The oldest 6.5 platform in the JPC fleet at time of writing.
-    // See IMGAPI-286.
-    '6.5': '20120614T001014Z'
-};
-
 //---- Image model
 
 /**
@@ -1799,13 +1785,6 @@ function apiCreateImageFromVm(req, res, callback) {
     if (manifest.uuid === undefined) {
         manifest.uuid = lib_uuid.v4();
     }
-    // Workaround IMGAPI-251: see note above.
-    if (incremental && !(manifest.requirements &&
-                         manifest.requirements.min_platform)) {
-        if (!manifest.requirements)
-            manifest.requirements = {};
-        manifest.requirements.min_platform = IMGAPI_251_MIN_PLATFORM;
-    }
 
     var vm;
     var vmServer;
@@ -1911,7 +1890,7 @@ function apiCreateImageFromVm(req, res, callback) {
          * above.
          */
         function workaroundImgapi312(next) {
-            if (vm.brand !== 'kvm' /* i.e. this is smartos */) {
+            if (vm.brand === 'smartos') {
                 if (!manifest.requirements)
                     manifest.requirements = {};
                 manifest.requirements.min_platform = {};
@@ -2163,28 +2142,6 @@ function apiAdminImportImage(req, res, callback) {
                         'min_platform (workaround IMGAPI-312 again)');
                 }
 
-                /*
-                 * Workaround OS-2651: This was a bug where imgadm create would
-                 * wipe out a given `manifest.requirements`. The fix was added
-                 * in imgadm 2.6.1. In that version imgadm was changed to
-                 * identify itself in the user-agent header. Use that to scope
-                 * down the workaround.
-                 */
-                if (Object.keys(image.requirements).length === 0 &&
-                    placeholder.requirements.min_platform['6.5'] ===
-                        IMGAPI_251_MIN_PLATFORM['6.5'] &&
-                    placeholder.requirements.min_platform['7.0'] ===
-                        IMGAPI_251_MIN_PLATFORM['7.0'] &&
-                    !imgadmVersionFromReq(req))
-                {
-                    log.info({requirements: placeholder.raw.requirements,
-                        image: image.uuid},
-                        'restoring placeholder image requirements ' +
-                        '(workaround OS-2651)');
-                    image.raw.requirements = placeholder.raw.requirements;
-                    image.requirements = placeholder.requirements;
-                }
-
                 Image.modify(app, image, req.log, function (err) {
                     if (err) {
                         log.error({uuid: image.uuid},
diff --git a/package.json b/package.json
index 2f89b56..4425d93 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgapi",
   "description": "Image API to manage images for SDC 7",
-  "version": "4.0.11",
+  "version": "4.0.12",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

