{"project":"joyent/manta-muskie","branch":"master","id":"I78cac994ffdd707cb564b6c033a0fc6a300eaef3","number":"2246","subject":"MANTA-3356 prevent user and key enumeration through muskie","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/2246","commitMessage":"MANTA-3356 prevent user and key enumeration through muskie\n","createdOn":1500602880,"lastUpdated":1546452911,"open":true,"status":"NEW","comments":[{"timestamp":1500602880,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1500602914,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500665508,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1500665539,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500933961,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThis looks good, though I\u0027d like another pair of eyes if somebody is available, since this could conceivably be a breaking change.\n\nFor ourselves, I think it would be useful to enumerate in the ticket the error codes being removed by this change.  Have you checked whether anything in Manta or node-manta depends on those error codes?  I have a bad feeling they might, and if so, I\u0027m not sure how to evolve this.\n\nDo we think it\u0027s possible that customers might be relying on these codes (and is there anything we could do about it if so)?"},{"timestamp":1500937227,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\nI\u0027ve added a comment to the bug enumerating all the changed error codes and conditions. I\u0027ve also been grepping around in the manta Github repositories for references to these codes and haven\u0027t found any non-trivial ones yet outside of auto-tests (e.g. two of the marlin auto-tests need fixing up)"},{"timestamp":1500938347,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\nThis really is a breaking/major change, mucking about with the error codes (and introducing a new one).\n\nFWIW I think the errors in question though are not really ones that have a useful automated response on the part of clients. The only one that might is UserNotFound (since there actually is an API for creating new sub-users that you could conceivably go call in response). The others are only really reasonable to respond to by throwing the error up to a human."},{"timestamp":1500996796,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 2:\n\n(5 comments)\n\nThis looks good. Thanks for noticing this and fixing it!\n\nCould you paste a sample log entry with the new output in the ticket? \n\nAlso, we should update the muskie API docs to match the new errors. Is there a ticket filed for that?"},{"timestamp":1501003739,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1501003741,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1501003773,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501004675,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)"},{"timestamp":1501007758,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1501786721,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1501786738,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1501786748,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501789217,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1507933921,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nThis change will break the java client tests (https://github.com/joyent/java-manta/blob/master/java-manta-it/src/test/java/com/joyent/manta/client/MantaClientErrorIT.java#L63-L88) and it does expose some of error codes changed here like AccountDoesNotExist (https://github.com/joyent/java-manta/blob/master/java-manta-client-unshaded/src/main/java/com/joyent/manta/exception/MantaErrorCode.java#L27). Given that it is possible the Samsung may be relying on the current responses. Is there an established way to handle these situations to check if this change would affect their code?"},{"timestamp":1509143825,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nThere are 28 failures with MPU tests in the muskie test suite with this change. The failures can be resolved with two small changes:\n\nAdd res as the third argument to the call to loadOwnerFromPath here: https://github.com/joyent/manta-muskie/blob/master/lib/uploads/commit.js#L136\n\ns/AccountDoesNotExistError/AuthorizationFailedError here: https://github.com/joyent/manta-muskie/blob/master/test/mpu/commit.test.js#L651"},{"timestamp":1546452911,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"4","revision":"78cac994ffdd707cb564b6c033a0fc6a300eaef3","parents":["5612dacc607713e3f55a7aa431e832b315193a79"],"ref":"refs/changes/46/2246/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1501786721,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501786748,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501789217,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":71,"deletions":-14},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"test/auth.test.js","type":"MODIFIED","insertions":51,"deletions":-4}],"sizeInsertions":134,"sizeDeletions":-20},"patchSets":[{"number":"1","revision":"a76e0c9e8284cf4cb30a2de17bccceb83673f54d","parents":["5612dacc607713e3f55a7aa431e832b315193a79"],"ref":"refs/changes/46/2246/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1500602880,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500602914,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":68,"deletions":-13},{"file":"lib/errors.js","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":78,"sizeDeletions":-13},{"number":"2","revision":"98aab1bdae2bbd7453409731eca723ba31e89b63","parents":["5612dacc607713e3f55a7aa431e832b315193a79"],"ref":"refs/changes/46/2246/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1500665508,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500665539,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/auth.js","line":716,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is this the same regex exported in common.js? It has the same name. If that\u0027s the case, we should use the commonized version, or name it something different to distinguish it from the already exported regex."},{"file":"lib/auth.js","line":716,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"No, the one in common.js is PUBLIC_STOR_PATH, and matches a path *under* the public directory. This one is PUBLIC_STOR_ROOT and matches only the root of the public tree. They already have different names."},{"file":"lib/auth.js","line":716,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Ah, sorry. In that case, could we move this to the top of the file since it\u0027s a global?"},{"file":"lib/auth.js","line":716,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, moved."},{"file":"lib/auth.js","line":734,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I know this isn\u0027t your change, but could we move this log statement to the actual loadOwner() handler (or update it to have the correct function)? It seems like it got left behind when I abstracted this code out for MPU."},{"file":"lib/auth.js","line":734,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Sure."},{"file":"lib/auth.js","line":756,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m not sure I understand the logic here (I find code evaluating output from mahi a bit difficult to follow). Why wouldn\u0027t req.caller.user or req.caller.account.login be defined?"},{"file":"lib/auth.js","line":756,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"req.caller.user is defined if we\u0027re using a sub-user (RBAC). If we\u0027re authenticated as just a normal account, it\u0027s not defined, and we run this branch (using the account login).\n\nIf it is defined, we use account.login + \u0027/\u0027 + user.login. This is the same logic from further down in this file (though taking anon access into account here too)"},{"file":"lib/auth.js","line":769,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"What happens for a non-readonly request (e.g., a PUT)?\n\nAlso, isn\u0027t this the same check performed by HttpRequest.isPublicGet()?"},{"file":"lib/auth.js","line":769,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"No, isPublicGet() evauates against PUBLIC_STOR_PATH, not PUBLIC_STOR_ROOT.\n\nA PUT here falls through down to the AuthorizationError below, which is the same result it would produce for a real account."},{"file":"lib/auth.js","line":769,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"That makes more sense now that I see they are actually different. Thanks."},{"file":"test/auth.test.js","line":585,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Check the response code here?"},{"file":"test/auth.test.js","line":585,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":68,"deletions":-13},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"test/auth.test.js","type":"MODIFIED","insertions":50,"deletions":-4}],"sizeInsertions":130,"sizeDeletions":-19},{"number":"3","revision":"98b8ceb8fe4a48e6364e69be1f73f2325ab70936","parents":["5612dacc607713e3f55a7aa431e832b315193a79"],"ref":"refs/changes/46/2246/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1501003741,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501007758,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501003773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501004675,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":69,"deletions":-14},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"test/auth.test.js","type":"MODIFIED","insertions":51,"deletions":-4}],"sizeInsertions":132,"sizeDeletions":-20},{"number":"4","revision":"78cac994ffdd707cb564b6c033a0fc6a300eaef3","parents":["5612dacc607713e3f55a7aa431e832b315193a79"],"ref":"refs/changes/46/2246/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1501786721,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501789217,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501786748,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":71,"deletions":-14},{"file":"lib/errors.js","type":"MODIFIED","insertions":12,"deletions":-2},{"file":"test/auth.test.js","type":"MODIFIED","insertions":51,"deletions":-4}],"sizeInsertions":134,"sizeDeletions":-20}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}