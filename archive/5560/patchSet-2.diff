From 5e971a6ca8157047af72fc614958608080ab9fd8 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Tue, 12 Feb 2019 14:32:41 -0800
Subject: [PATCH] TRITON-1209 cn-agent command_execute timeout should return
 correct error code

---
 lib/backends/dummy/tasks/command_execute.js   | 17 +++++++-----
 lib/backends/smartos/tasks/command_execute.js | 26 +++++++++++--------
 package.json                                  |  3 ++-
 3 files changed, 27 insertions(+), 19 deletions(-)

diff --git a/lib/backends/dummy/tasks/command_execute.js b/lib/backends/dummy/tasks/command_execute.js
index f624bba..eb30b3c 100644
--- a/lib/backends/dummy/tasks/command_execute.js
+++ b/lib/backends/dummy/tasks/command_execute.js
@@ -5,10 +5,11 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
+var verror = require('verror');
 
 var Task = require('../../../task_agent/task');
 
@@ -22,6 +23,7 @@ Task.createTask(CommandExecuteTask);
 
 function start(callback) {
     var self = this;
+    var msg = 'command_execute not implemented for mockcloud servers';
     var opts = {};
     var req = self.req;
 
@@ -35,16 +37,17 @@ function start(callback) {
     opts.log = self.log;
     opts.req_id = self.req.req_id;
 
-    opts.log.warn({
-        params: req.params,
-        req_id: opts.req_id
-    }, 'command_execute not implemented for mockcloud servers');
+    opts.log.warn({params: req.params, req_id: opts.req_id}, msg);
+
+    // NOTE: no point implementing timeout here, because we always return
+    // immediately.
 
     // Pretend we executed the script and then got this error.
     self.finish({
+        err: new verror.VError(msg),
         exitCode: 666,
-        stderr:
-            'cn-agent: command_execute not implemented for mockcloud servers\n',
+        signal: null,
+        stderr: 'cn-agent: ' + msg + '\n',
         stdout: ''
     });
 }
diff --git a/lib/backends/smartos/tasks/command_execute.js b/lib/backends/smartos/tasks/command_execute.js
index 7ceb672..94db9a7 100644
--- a/lib/backends/smartos/tasks/command_execute.js
+++ b/lib/backends/smartos/tasks/command_execute.js
@@ -5,13 +5,14 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var child_process = require('child_process');
 var fs = require('fs');
 
 var assert = require('assert-plus');
+var forkExecWait = require('forkexec').forkExecWait;
 var vasync = require('vasync');
 
 var Task = require('../../../task_agent/task');
@@ -57,15 +58,20 @@ function executeScript(opts, script, env, args, callback) {
             fs.chmod(filename, parseInt('0700', 8), cb);
         },
         function executeFile(_, cb) {
-            child_process.execFile(filename, args, {
+            var argv = [filename].concat(args);
+
+            forkExecWait({
+                argv: argv,
                 env: env,
                 maxBuffer: MAX_BUFFER,
                 timeout: opts.timeout ? opts.timeout : 0
-            }, function onExec(err, stdout, stderr) {
+            }, function (err, info) {
                 results = {
-                    exitCode: err ? err.code : 0,
-                    stderr: stderr.toString(),
-                    stdout: stdout.toString()
+                    err: info.error,
+                    exitCode: info.status,
+                    signal: info.signal,
+                    stderr: info.stderr,
+                    stdout: info.stdout
                 };
 
                 cb();
@@ -107,11 +113,9 @@ function start(callback) {
     req.params.env || DEFAULT_ENV,
     req.params.args || [],
     function _onExecute(err, results) {
-        opts.log.info({err: err, results: results}, 'executed command');
-        if (err) {
-            self.fatal('failed to execute command: ' + err.message);
-            return;
-        }
+        assert.equal(err, null);
+
+        opts.log.info({results: results}, 'executed command');
         self.finish(results);
     });
 }
diff --git a/package.json b/package.json
index 9496601..babce7a 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cn-agent",
   "description": "Triton Compute Node Agent",
-  "version": "2.8.0",
+  "version": "2.8.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -12,6 +12,7 @@
     "ctype": "0.5.4",
     "cueball": "2.7.1",
     "digest-stream": "0.2.2",
+    "forkexec": "1.1.0",
     "imgmanifest": "3.1.0",
     "jsprim": "2.0.0",
     "kstat": "1.0.1",
-- 
2.21.0

