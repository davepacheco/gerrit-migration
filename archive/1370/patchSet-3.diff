From 35b226ab939e8fe518596d2af007f0ea89a5640a Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Wed, 11 Jan 2017 19:57:43 +0000
Subject: [PATCH] NAPI-216 GetNicTag should respond with InvalidParameters on a
 name containing invalid chars Reviewed by: Alex Wilson
 <alex.wilson@joyent.com> Approved by: Alex Wilson <alex.wilson@joyent.com>

---
 lib/models/nic-tag.js      | 11 ++++++-----
 test/unit/nic-tags.test.js | 25 ++++++++++++++++++++++++-
 2 files changed, 30 insertions(+), 6 deletions(-)

diff --git a/lib/models/nic-tag.js b/lib/models/nic-tag.js
index 3dbce6a..7115321 100644
--- a/lib/models/nic-tag.js
+++ b/lib/models/nic-tag.js
@@ -65,7 +65,7 @@ var CREATE_SCHEMA = {
 
 var GET_SCHEMA = {
     required: {
-        name: validate.string
+        name: validate.nicTagName
     }
 };
 
@@ -379,13 +379,14 @@ function createNicTag(app, log, params, callback) {
         }
 
         var tag = new NicTag(params);
-        app.moray.putObject(BUCKET.name, tag.name, tag.raw(),
+        app.moray.putObject(BUCKET.name, tag.name, tag.raw(), { etag: null },
             function (err2) {
             if (err2) {
-                return callback(err2);
+                callback(err2);
+                return;
             }
 
-            return callback(null, tag);
+            callback(null, tag);
         });
     });
 }
@@ -581,7 +582,7 @@ function nicTagsExist(single, opts, name, tags, callback) {
         return callback(sErr);
     }
 
-    vasync.forEachParallel({
+    vasync.forEachPipeline({
         inputs: tagArr,
         func: function _getNicTag(tag, cb) {
             getNicTag(opts.app, opts.log, { name: tag }, function (err, res) {
diff --git a/test/unit/nic-tags.test.js b/test/unit/nic-tags.test.js
index 01fe903..de911a5 100644
--- a/test/unit/nic-tags.test.js
+++ b/test/unit/nic-tags.test.js
@@ -315,7 +315,30 @@ test('Create admin nic tag - with wrong MTU', function (t) {
     });
 });
 
-// // --- Delete tests
+
+// --- Get tests
+
+
+test('Get nic tag with invalid name', function (t) {
+    NAPI.getNicTag('__ad**$@$sfasdf', function (err, obj) {
+        t.ok(err, 'error returned');
+        t.deepEqual(obj, null, 'no value returned');
+        if (!err) {
+            t.end();
+            return;
+        }
+
+        t.equal(err.statusCode, 422, '422 returned');
+        t.deepEqual(err.body, h.invalidParamErr({
+            errors: [ mod_err.invalidParam('name', INVALID_MSG) ]
+        }), 'Error body');
+
+        t.end();
+    });
+});
+
+
+// --- Delete tests
 
 
 test('Delete nic tag in use', function (t) {
-- 
2.21.0

