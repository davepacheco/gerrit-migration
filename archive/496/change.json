{"project":"joyent/illumos-joyent","branch":"master","id":"I09b9f0e78b5878f94478446e2b0d61b0cf5a6577","number":"496","subject":"OS-5330 zoneadm mounting an lx or joyent branded zone fails Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/496","commitMessage":"OS-5330 zoneadm mounting an lx or joyent branded zone fails\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1474292229,"lastUpdated":1474555350,"open":false,"status":"MERGED","comments":[{"timestamp":1474292229,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1474299531,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)\n\nOverall this looks good. Once you have a resolution on how we want to handle skipping the hooks for brands like ipkg, then I can take another look."},{"timestamp":1474301927,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1474302335,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1474383400,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1474383505,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1474464647,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1474464756,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5."},{"timestamp":1474492500,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nThis looks good, thanks for incorporating my feedback from the preliminary review."},{"timestamp":1474509799,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1474509859,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1474555350,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"7","revision":"09b9f0e78b5878f94478446e2b0d61b0cf5a6577","parents":["5cf554af1079ca06b1b977788f9c0fb796f68945"],"ref":"refs/changes/96/496/7","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474509859,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1474555350,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23},"patchSets":[{"number":"1","revision":"da8db1a5b75d26992d4c83659391fcfddfc28fae","parents":["41c298045a69fcedc164e2e8ea9a2a372e9fa40e"],"ref":"refs/changes/96/496/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474292229,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/zoneadmd/vplat.c","line":1840,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It seems like the logic here could be made more clear by taking the previous block into account. That is, both test ALT_MOUNT and do a strcmp against \"/dev\". So couldn\u0027t the previous conditional be split up and then make this a simple \u0027else if on the default_brand\"?"},{"file":"usr/src/cmd/zoneadmd/vplat.c","line":1840,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, looking at it again I could simply this if statement to just check if default brand since the previous if block already covers /dev for all brands. It sounds like you were thinking of changing the logic even more to reduce it down to one mount_one() call but then we\u0027d have to check for /dev twice to restore the rootpath value. Though, I do feel that block could also be simplified by just using luroot."},{"file":"usr/src/cmd/zoneadmd/vplat.c","line":1840,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"No, I was think you could split the previous conditional so this would look something like:\n\nif (ALT_MOUNT(mount_cmd)) {\n    if (strcmp(fs_ptr[i].zone_fs_dir, \"/dev\") \u003d\u003d 0) {\n        ...\n    } else if (strcmp(brand_name, default_brand) !\u003d 0) {\n      ...\n    }\n}"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":1253,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I would add a comment here about why we\u0027re skipping the hooks in this function"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":16,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":15,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":32,"sizeDeletions":-7},{"number":"2","revision":"51e70b95a22eee56b42c46e9219372a7d5a0acb0","parents":["41c298045a69fcedc164e2e8ea9a2a372e9fa40e"],"ref":"refs/changes/96/496/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474383400,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23},{"number":"3","revision":"c97d0875819d33dcecbeb66954ba7aee16db7138","parents":["41c298045a69fcedc164e2e8ea9a2a372e9fa40e"],"ref":"refs/changes/96/496/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474383505,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23},{"number":"4","revision":"5664cf909634661491136234eff2fc352c84b723","parents":["6a41e7224f5dce21547e07eced881016dac9e18a"],"ref":"refs/changes/96/496/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474464647,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23},{"number":"5","revision":"964049a54f404faddcf22b53658ae61e96487dd0","parents":["6a41e7224f5dce21547e07eced881016dac9e18a"],"ref":"refs/changes/96/496/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474464756,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23},{"number":"6","revision":"81d7a3695cc5bbf0cd109f92cf97123f2ca71fbc","parents":["5cf554af1079ca06b1b977788f9c0fb796f68945"],"ref":"refs/changes/96/496/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474509799,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23},{"number":"7","revision":"09b9f0e78b5878f94478446e2b0d61b0cf5a6577","parents":["5cf554af1079ca06b1b977788f9c0fb796f68945"],"ref":"refs/changes/96/496/7","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1474509859,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1474492500,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1474555350,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":32,"deletions":-17},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":19,"deletions":-5},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-23}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}