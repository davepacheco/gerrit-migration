{"project":"joyent/muppet","branch":"master","id":"Ibe92708adb744caae4ef32f413bd124e3241ffdb","number":"2454","subject":"MANTA-2495 Muppet writes out haproxy configs with no \u0027listen\u0027 lines Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e","owner":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"url":"https://cr.joyent.us/2454","commitMessage":"MANTA-2495 Muppet writes out haproxy configs with no \u0027listen\u0027 lines\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\n","createdOn":1503599063,"lastUpdated":1505509540,"open":false,"status":"MERGED","comments":[{"timestamp":1503599063,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 1."},{"timestamp":1503599064,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 39741dd2bd216edba7cc9521c81f7874dff7d8ca\n    \n    Bitten by deepcopy\n    \n    commit be72c7b054c947195745d4e749f89b05c665dce4\n    \n    Test restart\n    \n    commit f92e945e6c53720f7cbf1a2811d42458fa62b42b\n    \n    Fix vasync pipeline args\n    \n    commit f84110e11f834c6289a9b753d780c98af43d8a20\n    \n    Add config file check\n    \n    commit dd9af8c753b1f354cb40a1895db8053f794e142a\n    \n    Update checkConfig to waterfall\n    \n    commit fcc2a9dd57f2c47aba5ebfc1f8b5896f28542b74\n    \n    Add lots of tests\n    \n    commit 5a461d5db6a36c5156da0b41e4d717736e89fecd\n    \n    Update tests\n    \n    commit 23c458d730b9ce5e80750f1027caa9c4e3a058f4\n    \n    Update copyrights and add config.test\n    \n    commit 67dfe50bb7e69f8f5b3a3a211f32675df76901e9\n    \n    Finish out config check pipeline\n    \n    commit 3315c7cc51880c7a217193fcb645002100bace5d\n    \n    Cleanups to lb_manager and others\n    \n    commit ccb0706acef66b849abc80c9081171aed745954b\n    \n    Rename main.js -\u003e muppet.js"},{"timestamp":1503599105,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504221708,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\n(3 comments)\n\nI haven\u0027t tested it out yet and I left a few comments, but overall looks good. I\u0027ll get setup and test it out as a next step."},{"timestamp":1504272800,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1504650933,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 2."},{"timestamp":1504650934,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 2e50362d3bbf1e530351921450d2fe187fac2b6a\n    \n    Update based on CR comments"},{"timestamp":1504650957,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504724061,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 3."},{"timestamp":1504724062,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 86812d410c4100f30eb9bb1f048e4f7887286d71\n    \n    Fix make check 80 char\n    \n    commit c04981e2dabe4b6510afd05fed0d694bd3216e13\n    \n    Update tests to remove reliance on hostname"},{"timestamp":1504724091,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504726150,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 4."},{"timestamp":1504726151,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 7e3e847cfdb56712602cef0d527d1d542a61752c\n    \n    Ignore bad watch.test"},{"timestamp":1504726182,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1504729462,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nI\u0027ve run through testing of this and the changes seem to be working properly. I updated the loadbalancer zones in my lab manta to use the experimental image from this branch and tried different sequences of enabling and disabling the registrar on the muskie zones in order to generate a bad config, but the changes worked to prevent any such occurrence. \n\nI also verified the new config test suite works as expected on a freshly provisioned zone by downloading a snapshot of the git repo with the changes and then installing haproxy and zookeeper."},{"timestamp":1504729651,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1505152456,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(6 comments)"},{"timestamp":1505153934,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1505250708,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1505424124,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 5."},{"timestamp":1505424125,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 4888d78268c8ef198e44bdd2d2ed04e2825499d8\n    \n    Update for jsstyle\n    \n    commit 37fa806eb3a179afbe021bc4777e2aa78da6ea10\n    \n    Adjust tests for new restart functionality\n    \n    commit 6dd1044212783338001371c5ac69a14017c5f0b4\n    \n    Adjust tests for new rename\n    \n    commit b19b6d1087de835d44e959a5a25f6cfa2d9df247\n    \n    Rename temp file to final file, instead of rewriting it\n    \n    commit b7be4fd73aef68bb1cb436be9521a57c58c46868\n    \n    Add backoff logging for haproxy start\n    \n    commit fd3c49ed5ef704d9fb75b4f6a0daf135421b4a2f\n    \n    Use svcprop over svccfg\n    \n    commit c2f8b34b150ec31db2a10086b7dbb5dda3ca00ca\n    \n    Remove unused haproxy_path in tests"},{"timestamp":1505424149,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505424149,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1505433383,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1\n\n(1 comment)"},{"timestamp":1505433722,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1505434772,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1505498482,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 6."},{"timestamp":1505498483,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit c4782ec43193f63a584fdd746184893b05690d7f\n    \n    Protect against simultaneous calls to restart()"},{"timestamp":1505498506,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505498689,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1505503604,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 7."},{"timestamp":1505503605,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 54d8ef3d64ffe13a9a54548bdfb6f8ce4b762144\n    \n    Add comment regarding third restart"},{"timestamp":1505503629,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505508006,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1\n\n(1 comment)\n\nThanks for the changes here, looks good."},{"timestamp":1505508098,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1505508300,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 8."},{"timestamp":1505508322,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit edfb9d7202cfdb8afcfafaa962ad57ecb64a715d\n    \n    Move comment according to review feedback"},{"timestamp":1505508333,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1505508357,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8: Code-Review+1\n\nThanks!"},{"timestamp":1505508715,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 8:\n\nI verified the unit tests work for the latest patch set and did another functional verification with the latest changes on my lab manta."},{"timestamp":1505508719,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1505509514,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1505509540,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jared Morrow"}],"currentPatchSet":{"number":"9","revision":"be92708adb744caae4ef32f413bd124e3241ffdb","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/9","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1505509514,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505508333,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505508357,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505508719,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"SUBM","value":"1","grantedOn":1505509540,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":223,"deletions":-21},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":217,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":684,"sizeDeletions":-42},"patchSets":[{"number":"1","revision":"fede83b87a002b0ffb7d59f90090da2bd1cb9bb6","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/1","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1503599063,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503599105,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/lb_manager.js","line":51,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Since the name is changing for this function it could perhaps more appropriately be renamed to writeHaproxyConfig since it\u0027s writing a new file based on the inputs and not actually updating an existing version of the file. No functional impact here, just seems more descriptive of what the function is doing."},{"file":"lib/lb_manager.js","line":51,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Yes, good point, I will do that."},{"file":"lib/lb_manager.js","line":134,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"What happens if m is null here? Will that result in execFile call at line 160 being called with a null for wfResult? I haven\u0027t tried it to know what happens so I could be misunderstanding."},{"file":"lib/lb_manager.js","line":134,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Ah, yes, I should else this clause and return an error so it doesn\u0027t continue on.  Good catch."},{"file":"lib/lb_manager.js","line":209,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Extra p in temporary"},{"file":"lib/lb_manager.js","line":209,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Clearly my dev zone doesn\u0027t have aspell installed!  I will fix."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":148,"deletions":-27},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":180,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":566,"sizeDeletions":-47},{"number":"2","revision":"f29a8f2a5e0e16a5088be3f18867023573a778d2","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/2","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1504650933,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504650957,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":151,"deletions":-27},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":180,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":569,"sizeDeletions":-47},{"number":"3","revision":"c2b92c8e61a6750641a583f26722bb226c5e052c","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/3","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1504724061,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504724091,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":151,"deletions":-27},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":181,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":570,"sizeDeletions":-47},{"number":"4","revision":"fa4a96ed9e8ebc89f86983faadd7ddbfe3c490f1","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/4","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1504726150,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1504726182,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504729651,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504729651,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"comments":[{"file":"lib/lb_manager.js","line":106,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I notice that we set the failAfter numbers, but we don\u0027t do anything on failure. Should we be listening for the failure event in particular? From looking at the docs, it seems like it\u0027ll end up restarting the backoff, but it\u0027s not clear if we\u0027ll end up being able to see why anything failed if we end up in a retry loop."},{"file":"lib/lb_manager.js","line":106,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"This basic logic was in the code to begin with, so I didn\u0027t look as hard at it as I should. I\u0027ll take a look at it more closely."},{"file":"lib/lb_manager.js","line":106,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"lib/lb_manager.js","line":125,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"You can also get this via \u0027svcprop -p start/exec haproxy\u0027. That will skip the property name / type. Not sure if that\u0027s easier or not."},{"file":"lib/lb_manager.js","line":125,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"The same regex works, but it is a /usr/bin binary vs. sbin of svccfg, so I\u0027ll use svcprop instead.  Thanks."},{"file":"lib/lb_manager.js","line":125,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"lib/lb_manager.js","line":137,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we log or include in the error the string that we failed to go through and match (as in the contents of stdout)?"},{"file":"lib/lb_manager.js","line":137,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Yes, I will do that."},{"file":"lib/lb_manager.js","line":137,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"lib/lb_manager.js","line":223,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe this should just be a rename from the temporary file to the permanent file? Now, I fully admit that this is a problem that existed in the original code, but because we\u0027re using writeFile to serialize the string to the actual config file, it seems like there\u0027s a window where if either haproxy restarts (say it crashed), it could see a bad config file or if muppet crashed and then haproxy did, it might also see a bad config file.\n\nIf we instead just do a rename of the temporary to the actual rather than writing and serializing it out again, it seems like that would avoid this problem. Though maybe this should be a follow up change?"},{"file":"lib/lb_manager.js","line":223,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"You are correct, we should just rename the temp file rather than rewrite a new file."},{"file":"lib/lb_manager.js","line":229,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It looks like if we hit this cb(err), there\u0027s nothing that stops us from then calling cb(null) down below."},{"file":"lib/lb_manager.js","line":229,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Will fix."},{"file":"lib/lb_manager.js","line":229,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"test/config.test.js","line":20,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we check if this isn\u0027t set for whatever reason and error explicitly?"},{"file":"test/config.test.js","line":20,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"This isn\u0027t used anymore, will remove."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":151,"deletions":-27},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":181,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":576,"sizeDeletions":-48},{"number":"5","revision":"fed2a11c76fac7ef1423eadf09d234089710bbd2","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/5","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1505424124,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505433383,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505424149,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/config.test.js","line":161,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Out of curiosity, why are we using lstat? Is it important that we look at a symlink itself?"},{"file":"test/config.test.js","line":161,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Good question.  I looked up `fs.exists()` and it is questionable whether or not it is deprecated in node.  Some versions say yes, some no.  So I used lstatSync based on recommendations for alternates as a simple / fast way to check existence."},{"file":"test/config.test.js","line":161,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK. Gotcha. I\u0027d probably end up using statSync as opposed to lstatSync, but I don\u0027t think it matters in either way for the test. Thanks for explaining!"},{"file":"test/config.test.js","line":161,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"While I pushed the locking patchset, I changed this to statSync."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":184,"deletions":-27},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":184,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":612,"sizeDeletions":-48},{"number":"6","revision":"5a2f6410352e3f8a522beaab75512249806b6c16","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/6","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1505498482,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505498506,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":215,"deletions":-21},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":218,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":677,"sizeDeletions":-42},{"number":"7","revision":"af655a3adb9c33fc7898e7d283f792b14a8be957","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/7","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1505503604,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505508006,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505503629,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/config.test.js","line":219,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It may be worth putting this comment near restart() itself, as someone might miss it while searching through the code if for some odd reason they hit this."},{"file":"test/config.test.js","line":219,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Will do"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":215,"deletions":-21},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":226,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":685,"sizeDeletions":-42},{"number":"8","revision":"5f91e064789e8bbb07340e92b1c834f75873d832","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/8","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1505508300,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505508357,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505508333,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505508719,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":223,"deletions":-21},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":217,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":684,"sizeDeletions":-42},{"number":"9","revision":"be92708adb744caae4ef32f413bd124e3241ffdb","parents":["8b2217407ea169da6c73489352e9583d5272e6f5"],"ref":"refs/changes/54/2454/9","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1505509514,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505508357,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1505508333,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1505509540,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505508719,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"env.sh","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":5,"deletions":-10},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":223,"deletions":-21},{"file":"muppet.js","fileOld":"main.js","type":"RENAMED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"smf/manifests/muppet.xml.in","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/config.test.js","type":"ADDED","insertions":217,"deletions":0},{"file":"test/haproxy.cfg.empty","type":"ADDED","insertions":0,"deletions":0},{"file":"test/haproxy.cfg.good","type":"ADDED","insertions":39,"deletions":0},{"file":"test/haproxy.cfg.in","type":"ADDED","insertions":54,"deletions":0},{"file":"test/haproxy.cfg.no-frontend","type":"ADDED","insertions":12,"deletions":0},{"file":"test/haproxy.cfg.no-listener","type":"ADDED","insertions":9,"deletions":0},{"file":"test/haproxy.cfg.out-check","type":"ADDED","insertions":68,"deletions":0},{"file":"test/haproxy.cfg.parse-error","type":"ADDED","insertions":41,"deletions":0}],"sizeInsertions":684,"sizeDeletions":-42}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}]}