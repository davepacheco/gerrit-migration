From 4c1db75dd76ec50a788dcabcd7f9b9ca7f6331b6 Mon Sep 17 00:00:00 2001
From: Ryan Zezeski <rpz@joyent.com>
Date: Mon, 8 May 2017 09:51:08 -0600
Subject: [PATCH] OS-6084 logic error in i_dls_devnet_setzid() [undo previous
 change]

---
 usr/src/uts/common/io/dls/dls_mgmt.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/usr/src/uts/common/io/dls/dls_mgmt.c b/usr/src/uts/common/io/dls/dls_mgmt.c
index 775d142549..31d7565bff 100644
--- a/usr/src/uts/common/io/dls/dls_mgmt.c
+++ b/usr/src/uts/common/io/dls/dls_mgmt.c
@@ -1618,9 +1618,16 @@ i_dls_devnet_setzid(dls_devnet_t *ddp, zoneid_t new_zoneid, boolean_t setprop,
 		setzid.ld_zoneid = new_zoneid;
 		err = i_dls_mgmt_upcall(&setzid, sizeof (setzid), &retval,
 		    sizeof (retval));
-		upcall_done = B_TRUE;
 		if (err != 0)
 			goto done;
+
+		/*
+		 * We set upcall_done only if the upcall is
+		 * successful. This way, if dls_link_setzid() fails,
+		 * we know another upcall must be done to reset the
+		 * dlmgmtd state.
+		 */
+		upcall_done = B_TRUE;
 	}
 	if ((err = dls_link_setzid(ddp->dd_mac, new_zoneid)) == 0) {
 		ddp->dd_zid = new_zoneid;
-- 
2.21.0

