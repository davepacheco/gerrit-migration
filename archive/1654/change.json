{"project":"joyent/sdc-cn-agent","branch":"master","id":"Id36a7c08fa73116763d21fba58e28abf164c2f79","number":"1654","subject":"AGENT-1065 cn-agent crashing with \"Uncaught AssertionError: Cannot write to a destroyed stream\" Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/1654","commitMessage":"AGENT-1065 cn-agent crashing with \"Uncaught AssertionError: Cannot write to a destroyed stream\"\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1489438788,"lastUpdated":1489772375,"open":false,"status":"MERGED","comments":[{"timestamp":1489438788,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1489438789,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 5e111bc62d599684c1e6fa0cb07ff187575361be\n    \n    kill cmdSpawn when socket is closed, don\u0027t try to write to destroyed socket"},{"timestamp":1489438816,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489512702,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1489535791,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1489535859,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1489535860,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit a048e22df3acce29ee44e533f35db1c8a4468a50\n    \n    apply feedback"},{"timestamp":1489535905,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489539793,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1489687613,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 3."},{"timestamp":1489687615,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 3dc26217b7ff085b2b8fa33ca0d9dcd7b7a85862\n    \n    more tweaks"},{"timestamp":1489687640,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489689719,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1489690603,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 4."},{"timestamp":1489690604,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 6894c19840cb666b52c25e37b1a7acd9d75e0376\n    \n    another round of feedback changes"},{"timestamp":1489690634,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489692566,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1489693408,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1489695732,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 5."},{"timestamp":1489695734,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit ab2db340b5e6b015d53f5bd146b483c7ca10519e\n    \n    assert interval variable, VError \u003d\u003e Error"},{"timestamp":1489695769,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489699379,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1489699469,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 6."},{"timestamp":1489699470,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit b8a775b71309c0e0231c9d1dffc4aae157ad2165\n    \n    remove VError require"},{"timestamp":1489699538,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1489699656,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1489772370,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1489772375,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"7","revision":"d36a7c08fa73116763d21fba58e28abf164c2f79","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/7","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489772370,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489699538,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489699656,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489699656,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1489772375,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":124,"deletions":-26}],"sizeInsertions":124,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"c0aa9997885e5b50ef9954d26c2d18eedfe5b54c","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489438788,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489438816,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/docker-stdio.js","line":935,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What is the encoding expected by the docker client? Is it always utf-8? If not, then using toString() here might not always be what we want to do."},{"file":"lib/docker-stdio.js","line":935,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Honestly I\u0027m not too sure, which is why I just left this more or less as it was before. This value will get passed into JSON.stringify in `writeData()` which does spit out utf8? I think for the particular case of runContainerLogsCommand function, the LineStream object we use was created with `encoding: \u0027utf8\u0027`."},{"file":"lib/docker-stdio.js","line":1189,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This anonymous function should be named, since its name won\u0027t be inferred by V8 (it\u0027s not part of a variable assignment expression)."},{"file":"lib/docker-stdio.js","line":1191,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"%shas -\u003e %s has\n\nOr maybe log.info({container: container}, \u0027..\u0027) if \"container\" is an object?"},{"file":"lib/docker-stdio.js","line":1191,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Good catch, in this particular case the `container` variable corresponds to the uuid of the container."},{"file":"lib/docker-stdio.js","line":1191,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Cool, then fixing the typo should be enough. It might help renaming that variable to \"containerUuid\" to improve readability."},{"file":"lib/docker-stdio.js","line":1193,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does killing the command when the socket is closed conform to the semantics of running a docker command? That is, do users expect the running program to continue running in the face of these problems?\n\nIf so, I\u0027d think that removing event listeners from the linestream object might be a better solution.\n\nRegardless, we should check that kill succeeded or not. That doesn\u0027t necessarily mean that the process was terminate though, just that the signal was sent. So it\u0027s worth thinking what we should do when the process is not terminated."},{"file":"lib/docker-stdio.js","line":1193,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"The process we\u0027re killing (the one referenced via cmdSpawn) is just the cat/tail process that we started above on line 1133 to follow the stdio log, so if I\u0027m not mistaken I think we should be okay to end that one once we have nothing to stream into. Though removing the \u0027readable\u0027 listener seems like a good thing to do here too, though.\n\nGood call on the kill, do you have any thoughts what would be the best way to check/confirm the kill succeeded?"},{"file":"lib/docker-stdio.js","line":1193,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I hadn\u0027t realized that this code was running to handle logs, and that in this case sdc-docker really owns the child process, and knows what program is running and for which purpose. So I think it\u0027s ok to kill it.\n\nYou can check whether the \"kill\" call succeeded by checking its return value. \u0027kill()\u0027 works synchronously in the sense that when the call to kill returns, the signal has either been sent or it hasn\u0027t and will not be sent.\n\nIf the docker client\u0027s connection is closed, the cn-agent process won\u0027t be able to exit until the tail/cat process exits. So it seems it\u0027d be worth it to retry killing it when \u0027kill()\u0027 doesn\u0027t succeed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":68,"deletions":-18}],"sizeInsertions":68,"sizeDeletions":-18},{"number":"2","revision":"8011601b4a50cc3e9d23cae044df56c04566bab8","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489535859,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489535905,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":72,"deletions":-22}],"sizeInsertions":72,"sizeDeletions":-22},{"number":"3","revision":"bcda4e25f4560a5ad95d2092ec8c0d7429e4c665","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489687613,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489687640,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/docker-stdio.js","line":1221,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Shouldn\u0027t this be \"if (!cmdSpawnExited)\"? I would think that we want to send te SIGTERM signal to the spawned process only if it hasn\u0027t already exited."},{"file":"lib/docker-stdio.js","line":1230,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"If I understand correctly, we\u0027re \"following\" only if using tail. Is that correct to assume here that we\u0027re using tail and not cat?"},{"file":"lib/docker-stdio.js","line":1233,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"The \"cmdSpawnExitInterval\" was already added to \"cmdSpawnExitCurrentlyWaited\" at line 1219, shouldn\u0027t we do this just once in this callback?"},{"file":"lib/docker-stdio.js","line":1237,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"With the current code, the interval\u0027s callback will keep firing, and a signal will keep being sent to the spawned process, is that what we intended?\n\nOn timeout, we might instead want to call \"process.exit(1)\" to cleanup the process that forwards the logs, and communicate an error to the system (with the non-zero exit code). I\u0027m not sure what would happen to the spawned process, but maybe exiting the parent and having one process potentially left over is better than having two processes left over?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":117,"deletions":-26}],"sizeInsertions":117,"sizeDeletions":-26},{"number":"4","revision":"a608a3a8312a02cd0036965021a588fabdbc3f8b","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489690603,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489690634,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/docker-stdio.js","line":1218,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Maybe assert that cmdSpawnExitInterval is \"undefined\" to make sure we notice if there\u0027s a programmer error that calls this function more than once?"},{"file":"lib/docker-stdio.js","line":1218,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Great idea!"},{"file":"lib/docker-stdio.js","line":1239,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is it worth it to use VError if we don\u0027t pass a \"cause\" Error object as the first argument?"},{"file":"lib/docker-stdio.js","line":1239,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Good point, I didn\u0027t even think about that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":118,"deletions":-26}],"sizeInsertions":118,"sizeDeletions":-26},{"number":"5","revision":"d01b07ec56441a0e8b64ac0169542b907c3716c0","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/5","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489695732,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489695769,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/docker-stdio.js","line":22,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is VError still used in this module after the latest change you made?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":125,"deletions":-26}],"sizeInsertions":125,"sizeDeletions":-26},{"number":"6","revision":"3acff54a1e20cd055ff3e45452fdf5122e8c2792","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/6","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489699469,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489699538,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489699656,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489699656,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":124,"deletions":-26}],"sizeInsertions":124,"sizeDeletions":-26},{"number":"7","revision":"d36a7c08fa73116763d21fba58e28abf164c2f79","parents":["3d7c06c2cb9cf9170d5a4afa0ebe0e2aa2636c52"],"ref":"refs/changes/54/1654/7","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1489772370,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1489699538,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1489699656,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1489699656,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1489772375,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/docker-stdio.js","type":"MODIFIED","insertions":124,"deletions":-26}],"sizeInsertions":124,"sizeDeletions":-26}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}