From 21d1fde64f343c5c01969e0323c4b64359718b17 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 29 Nov 2016 09:05:33 -0800
Subject: [PATCH] =?UTF-8?q?TOOLS-1591=20'sdcadm=20up'=20of=20all=20"statel?=
 =?UTF-8?q?ess"=20zones=20is=20accidentally=20giving=20them=20a=20delegate?=
 =?UTF-8?q?=20dataset=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<?=
 =?UTF-8?q?pedro@joyent.com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Can?=
 =?UTF-8?q?del=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.md                                    |  7 +++++
 .../update-stateless-services-v1.js           | 29 ++++++++++++-------
 package.json                                  |  2 +-
 3 files changed, 26 insertions(+), 12 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 9ffa95a..151acd8 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,13 @@
 
 # sdcadm Changelog
 
+## 1.15.0
+
+- TOOLS-1591: 'sdcadm up' of a number of core Triton services (the simple
+  "stateless" ones, e.g. vmapi, napi, papi, etc.) will ensure the instance
+  has a delegate dataset if required (if the SAPI service says it should
+  have one).
+
 ## 1.14.1
 
 - joyent/sdcadm#28 Allow 'sdcadm create portolan --skip-ha-check' to work.
diff --git a/lib/procedures/update-stateless-services-v1.js b/lib/procedures/update-stateless-services-v1.js
index 8b4ae26..4056a50 100644
--- a/lib/procedures/update-stateless-services-v1.js
+++ b/lib/procedures/update-stateless-services-v1.js
@@ -98,17 +98,24 @@ UpdateStatelessServicesV1.prototype.execute = function ussv1Execute(opts, cb) {
             ]);
         }
         if (change.inst) {
-            // Only for the Docker service instances:
-            steps.push(function (_, next) {
-                s.ensureDelegateDataset({
-                    service: change.service,
-                    progress: opts.progress,
-                    zonename: change.inst.zonename,
-                    log: opts.log,
-                    server: change.inst.server
-                }, next);
-            });
-            // Some svcs might not have an instance (e.g. the manta zone).
+            /*
+             * If the service params require a delegate dataset, then ensure
+             * the instance has one.
+             */
+            assert.optionalBool(change.service.params.delegate_dataset,
+                'change.service.params.delegate_dataset');
+            if (change.service.params.delegate_dataset) {
+                steps.push(function (_, next) {
+                    s.ensureDelegateDataset({
+                        service: change.service,
+                        progress: opts.progress,
+                        zonename: change.inst.zonename,
+                        log: opts.log,
+                        server: change.inst.server
+                    }, next);
+                });
+            }
+
             steps = steps.concat([
                 s.updateVmUserScript,
                 s.imgadmInstall,
diff --git a/package.json b/package.json
index 9019689..38164a2 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.14.1",
+  "version": "1.15.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

