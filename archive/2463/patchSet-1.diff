From 73ab2485260ea77aa9812193e7ce6c80e945dd3a Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 25 Aug 2017 17:05:24 +0000
Subject: [PATCH] OS-6288 mmap of /dev not zone-aware; can lead to information
 leakage

---
 usr/src/uts/common/fs/specfs/specsubr.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/common/fs/specfs/specsubr.c b/usr/src/uts/common/fs/specfs/specsubr.c
index a5937dec2b..014bad1216 100644
--- a/usr/src/uts/common/fs/specfs/specsubr.c
+++ b/usr/src/uts/common/fs/specfs/specsubr.c
@@ -24,6 +24,7 @@
  */
 /*
  * Copyright (c) 2012 by Delphix. All rights reserved.
+ * Copyright 2017 Joyent, Inc.
  */
 
 /*	Copyright (c) 1983, 1984, 1985, 1986, 1987, 1988, 1989 AT&T	*/
@@ -416,8 +417,13 @@ specfind(dev_t dev, vtype_t type)
 			nvp = STOV(st);
 			if (nvp->v_type == type && st->s_commonvp != nvp) {
 				VN_HOLD(nvp);
-				mutex_exit(&stable_lock);
-				return (nvp);
+				/* validate vnode is visible in the zone */
+				if (nvp->v_path != NULL &&
+				    ZONE_PATH_VISIBLE(nvp->v_path, curzone)) {
+					mutex_exit(&stable_lock);
+					return (nvp);
+				}
+				VN_RELE(nvp);
 			}
 		}
 		st = st->s_next;
-- 
2.21.0

