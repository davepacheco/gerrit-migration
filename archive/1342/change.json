{"project":"joyent/illumos-joyent","branch":"master","id":"I0e21e957f7ee4ef75f79e71f2fd6f09da211893d","number":"1342","subject":"OS-1457 dladm won\u0027t show or create vnics Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/1342","commitMessage":"OS-1457 dladm won\u0027t show or create vnics\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1485392472,"lastUpdated":1485877689,"open":false,"status":"MERGED","comments":[{"timestamp":1485392472,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1485437390,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1485437440,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nOnce your testing is complete, I can IA +1"},{"timestamp":1485443624,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\nThis is the same test I ran to originally verify OS-1457. Except this test was run against my patch. Notice that the link doesn\u0027t disappear in dladm show-link, dlmgmtd keeps the correct link id, and the zone\u0027d datalink list is the same before and after. Basically, the duplicate vnic creation fails as expected and the various link state across the system is the same before and after failure.\n\n    [root@testsos ~]# dladm create-vnic  -t -l e1000g0 -p zone\u003de0b64261-4708-c1f3-971b-dd561161b3dc -m 12:22:33:01:01:01 tmp687240\n    [root@testsos ~]# dladm show-link\n    LINK        CLASS     MTU    STATE    BRIDGE     OVER\n    e1000g0     phys      1500   up       --         --\n    net0        vnic      1500   ?        --         e1000g0\n    tmp687240   vnic      1500   up       --         e1000g0\n    [root@testsos ~]# echo \"::walk dls_devnet_cache | ::print dls_devnet_t dd_linkid dd_linkname\" | mdb -k\n    dd_linkid \u003d 0x3\n    dd_linkname \u003d [ \"tmp687240\" ]\n    dd_linkid \u003d 0x2\n    dd_linkname \u003d [ \"net0\" ]\n    dd_linkid \u003d 0x1\n    dd_linkname \u003d [ \"e1000g0\" ]\n    [root@testsos ~]# echo \"::modhash -t ! grep vnic\" | mdb -k\n    ffffff0189562a40     40     2               id vnic_hash\n    [root@testsos ~]# echo \"ffffff0189562a40::modhash -e | ::print vnic_t vn_id\" | mdb -k\n    vn_id \u003d 0x2\n    vn_id \u003d 0x3\n    [root@testsos ~]# echo \"dlmgmt_id_avl::walk avl | ::print dlmgmt_link_t ll_linkid ll_link\" | mdb -p $(pgrep dlmgmtd)\n    ll_linkid \u003d 0x1\n    ll_link \u003d [ \"e1000g0\" ]\n    ll_linkid \u003d 0x2\n    ll_link \u003d [ \"net0\" ]\n    ll_linkid \u003d 0x3\n    ll_link \u003d [ \"tmp687240\" ]\n    [root@testsos ~]# echo \"::walk zone | ::print -a zone_t zone_name\" | mdb -k\n    fffffffffbcf2700 zone_name \u003d 0xfffffffffbb67204 \"global\"\n    ffffff01990b10c0 zone_name \u003d 0xffffff019d83ea80 \"\n    e0b64261-4708-c1f3-971b-dd561161b3dc\"\n    [root@testsos ~]# echo \"ffffff01990b10c0::print zone_t zone_dl_list | ::walk list | ::print zone_dl_t zdl_id\" | mdb -k\n    zdl_id \u003d 0x3\n    zdl_id \u003d 0x2\n    [root@testsos ~]#\n    [root@testsos ~]# dladm create-vnic  -t -l e1000g0 -p zone\u003de0b64261-4708-c1f3-971b-dd561161b3dc -m 12:22:32:01:01:01 tmp687240\n    dladm: warning: failed to set property zone: object already exists\n    dladm: vnic creation over e1000g0 failed: object already exists\n    [root@testsos ~]# dladm show-link\n    LINK        CLASS     MTU    STATE    BRIDGE     OVER\n    e1000g0     phys      1500   up       --         --\n    net0        vnic      1500   ?        --         e1000g0\n    tmp687240   vnic      1500   up       --         e1000g0\n    [root@testsos ~]# echo \"::walk dls_devnet_cache | ::print dls_devnet_t dd_linkid dd_linkname\" | mdb -k\n    dd_linkid \u003d 0x3\n    dd_linkname \u003d [ \"tmp687240\" ]\n    dd_linkid \u003d 0x2\n    dd_linkname \u003d [ \"net0\" ]\n    dd_linkid \u003d 0x1\n    dd_linkname \u003d [ \"e1000g0\" ]\n    [root@testsos ~]# echo \"ffffff0189562a40::modhash -e | ::print vnic_t vn_id\" | mdb -k\n    vn_id \u003d 0x2\n    vn_id \u003d 0x3\n    [root@testsos ~]# echo \"dlmgmt_id_avl::walk avl | ::print dlmgmt_link_t ll_linkid ll_link\" | mdb -p $(pgrep dlmgmtd)\n    ll_linkid \u003d 0x1\n    ll_link \u003d [ \"e1000g0\" ]\n    ll_linkid \u003d 0x2\n    ll_link \u003d [ \"net0\" ]\n    ll_linkid \u003d 0x3\n    ll_link \u003d [ \"tmp687240\" ]\n    [root@testsos ~]# echo \"ffffff01990b10c0::print zone_t zone_dl_list | ::walk list | ::print zone_dl_t zdl_id\" | mdb -k\n    zdl_id \u003d 0x3\n    zdl_id \u003d 0x2"},{"timestamp":1485475154,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1485797109,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1485797136,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nI had to rebase and resolve merge conflict around copyright year change."},{"timestamp":1485872697,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1485877594,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1485877678,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1485877689,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"4","revision":"0e21e957f7ee4ef75f79e71f2fd6f09da211893d","parents":["ca8c1f45695962c5f0fcafb697b9a4799e47ec9e"],"ref":"refs/changes/42/1342/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485877678,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1485877689,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/dlmgmtd/dlmgmt_door.c","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"fe516e33087e2e8194f3a9cfab50b736eda47efe","parents":["1920b70c619829b92093182e77620558506a12d1"],"ref":"refs/changes/42/1342/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485392472,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485437390,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485475154,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/dlmgmtd/dlmgmt_door.c","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2,"sizeDeletions":-3},{"number":"2","revision":"7d6ef65cd8e0eda9dfb07618f8b36d52e42fcd9c","parents":["33df115038809a05a8856b165fabdb823350567e"],"ref":"refs/changes/42/1342/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485797109,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/dlmgmtd/dlmgmt_door.c","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2,"sizeDeletions":-3},{"number":"3","revision":"3e1f690cb67f4876863c8fba5d2c29a0ee01d256","parents":["ca8c1f45695962c5f0fcafb697b9a4799e47ec9e"],"ref":"refs/changes/42/1342/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485877594,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/dlmgmtd/dlmgmt_door.c","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2,"sizeDeletions":-3},{"number":"4","revision":"0e21e957f7ee4ef75f79e71f2fd6f09da211893d","parents":["ca8c1f45695962c5f0fcafb697b9a4799e47ec9e"],"ref":"refs/changes/42/1342/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1485877678,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1485872697,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1485877689,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/dlmgmtd/dlmgmt_door.c","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2,"sizeDeletions":-3}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}