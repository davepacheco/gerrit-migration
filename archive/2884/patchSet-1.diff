From b2898cb30fbece18a0f36f4634a15278ba311f4d Mon Sep 17 00:00:00 2001
From: Jonathan Perkin <jperkin@joyent.com>
Date: Mon, 30 Oct 2017 18:21:45 +0000
Subject: [PATCH] OS-6428 bad free in ctf_dwarf_init_die

---
 usr/src/lib/libctf/common/ctf_dwarf.c | 14 ++------------
 1 file changed, 2 insertions(+), 12 deletions(-)

diff --git a/usr/src/lib/libctf/common/ctf_dwarf.c b/usr/src/lib/libctf/common/ctf_dwarf.c
index 811a55bc64..f1e120b7a8 100644
--- a/usr/src/lib/libctf/common/ctf_dwarf.c
+++ b/usr/src/lib/libctf/common/ctf_dwarf.c
@@ -2746,42 +2746,30 @@ ctf_dwarf_init_die(int fd, Elf *elf, ctf_die_t *cdp, int ndie, char *errbuf,
 		if ((ret = ctf_dwarf_die_elfenc(elf, cdp, errbuf,
 		    errlen)) != 0) {
 			avl_destroy(&cdp->cd_map);
-			ctf_free(cdp, sizeof (ctf_die_t));
 			return (ret);
 		}
 
 		if ((ret = ctf_dwarf_sib(cdp, NULL, &cu)) != 0) {
 			avl_destroy(&cdp->cd_map);
-			ctf_free(cdp, sizeof (ctf_die_t));
 			return (ret);
 		}
 		if (cu == NULL) {
 			(void) snprintf(errbuf, errlen,
 			    "file does not contain DWARF data\n");
 			avl_destroy(&cdp->cd_map);
-			ctf_free(cdp, sizeof (ctf_die_t));
 			return (ECTF_CONVBKERR);
 		}
 
 		if ((ret = ctf_dwarf_child(cdp, cu, &child)) != 0) {
 			avl_destroy(&cdp->cd_map);
-			ctf_free(cdp, sizeof (ctf_die_t));
 			return (ret);
 		}
-		if (child == NULL) {
-			(void) snprintf(errbuf, errlen,
-			    "file does not contain DWARF data\n");
-			avl_destroy(&cdp->cd_map);
-			ctf_free(cdp, sizeof (ctf_die_t));
-			return (ECTF_CONVBKERR);
-		}
 
 		cdp->cd_cuoff = offset;
 		cdp->cd_cu = child;
 
 		if ((cdp->cd_cmh = ctf_merge_init(fd, &ret)) == NULL) {
 			avl_destroy(&cdp->cd_map);
-			ctf_free(cdp, sizeof (ctf_die_t));
 			return (ret);
 		}
 
@@ -2886,6 +2874,8 @@ ctf_dwarf_convert(int fd, Elf *elf, uint_t nthrs, int *errp, ctf_file_t **fpp,
 
 	for (i = 0; i < ndies; i++) {
 		cdp = &cdies[i];
+		if (cdp->cd_cu == NULL)
+			continue;
 		ctf_dprintf("adding die %s: %p, %x %x\n", cdp->cd_name,
 		    cdp->cd_cu, cdp->cd_cuoff, cdp->cd_maxoff);
 		if (workq_add(wqp, cdp) == -1) {
-- 
2.21.0

