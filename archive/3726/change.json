{"project":"joyent/illumos-joyent","branch":"master","id":"I58cc4d26d2f2ea99f0f9aa988f720d8782bd9bb6","number":"3726","subject":"OS-6840 want support for PCI BAR size \u003e\u003d 4G Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/3726","commitMessage":"OS-6840 want support for PCI BAR size \u003e\u003d 4G\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1522111667,"lastUpdated":1523021120,"open":false,"status":"MERGED","comments":[{"timestamp":1522111667,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1522167848,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1522167965,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522175811,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522329775,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1522329897,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522332219,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1522333587,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\nI spent some time looking more to figure out who uses the mem_size aspects. I think this fix is incomplete at this time. For example, there are a lot of other places in pci_boot where we now reference the 64-bit mem_size value in the pci_bus_resource but now would assign it to a uint_t.\n\nNotably, I think this occurs in the following places in pci_boot.c:\n\n* fix_ppb_res\n\nI didn\u0027t spot any others as I was reviewing this."},{"timestamp":1522771674,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1522771735,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5."},{"timestamp":1522771911,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 5:\n\nI fixed fix_ppb_res() and ppb_ctlops()."},{"timestamp":1522774021,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1522843947,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 6."},{"timestamp":1522849387,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1522852963,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1522856478,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1\n\n(1 comment)"},{"timestamp":1522856824,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1522946990,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1523020886,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1523021098,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1523021120,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"8","revision":"58cc4d26d2f2ea99f0f9aa988f720d8782bd9bb6","parents":["6a175f35f25ea47a4b116ad2dd1a0600fdf5a2bc"],"ref":"refs/changes/26/3726/8","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523021098,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522852963,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856478,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856824,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522946990,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1523021120,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":30,"deletions":-17},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":42,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"e6ef8a4c4ed0d805e574ca5a47e9e0c140832b6d","parents":["929399046cc464d1c38a4d4facf93476166a5662"],"ref":"refs/changes/26/3726/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1522111667,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":14,"deletions":-3}],"sizeInsertions":15,"sizeDeletions":-4},{"number":"2","revision":"a32ab52c86f343e3720268569917d4c839339363","parents":["929399046cc464d1c38a4d4facf93476166a5662"],"ref":"refs/changes/26/3726/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1522167848,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/sys/pci.h","line":584,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This define is used in a lot of places and I\u0027m not sure we can just expand it."},{"file":"usr/src/uts/common/sys/pci.h","line":584,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I agree with Patrick here. It seems like this is really supposed to represent the mask that we\u0027re reading from the register, not the overall mask. It seems like we may want a new #define that we use to try and clarify which mask is what we\u0027re reading from a register and which mask is the actual one from an address constructed from reading the two 4-byte regs."},{"file":"usr/src/uts/common/sys/pci.h","line":584,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":14,"deletions":-3}],"sizeInsertions":16,"sizeDeletions":-5},{"number":"3","revision":"4c7ee34cf3b8bcababfa0f0f6f6c14848b7e56a4","parents":["929399046cc464d1c38a4d4facf93476166a5662"],"ref":"refs/changes/26/3726/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1522329775,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522332219,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":16,"deletions":-5}],"sizeInsertions":18,"sizeDeletions":-6},{"number":"4","revision":"6ad527a389edebfb6f9c598487cf6e82de67ed70","parents":["d7c531a2a2da0161df2cf044f19dc53e35af2dc1"],"ref":"refs/changes/26/3726/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1522771674,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522332219,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":16,"deletions":-5}],"sizeInsertions":18,"sizeDeletions":-6},{"number":"5","revision":"1ee610620bfdd122a941b5e467cff3209c5279a6","parents":["d7c531a2a2da0161df2cf044f19dc53e35af2dc1"],"ref":"refs/changes/26/3726/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1522771735,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/intel/io/pci/pci_pci.c","line":570,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"An off_t is signed. A uint64_t is unsigned. We should probably check the size and make sure we\u0027re not going to overflow as a result of this and error if we will before we do the assignment. There\u0027s an OFF_MAX macro in the kernel we can compare against. If it\u0027s larger, we should return DDI_FAILURE."},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","line":570,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done. The SPARC code has the same problem, but I don\u0027t think I really want to fix it without being able to test it."},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","line":570,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think that\u0027s fine. We should probably file a bug on illumos.org for someone to note for the future about SPARC."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":30,"deletions":-17},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-19},{"number":"6","revision":"bdc295f6d034965d4f16c14a66d8d0e5ef836370","parents":["d7c531a2a2da0161df2cf044f19dc53e35af2dc1"],"ref":"refs/changes/26/3726/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1522843947,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856478,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856824,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522946990,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522852963,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":30,"deletions":-17},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":42,"sizeDeletions":-19},{"number":"7","revision":"d417d1c413ae4cc1970cfe7e36a3da988316bfc1","parents":["6a175f35f25ea47a4b116ad2dd1a0600fdf5a2bc"],"ref":"refs/changes/26/3726/7","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523020886,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856478,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856824,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522946990,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522852963,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":30,"deletions":-17},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":42,"sizeDeletions":-19},{"number":"8","revision":"58cc4d26d2f2ea99f0f9aa988f720d8782bd9bb6","parents":["6a175f35f25ea47a4b116ad2dd1a0600fdf5a2bc"],"ref":"refs/changes/26/3726/8","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1523021098,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856478,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522856824,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522946990,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522852963,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1523021120,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/sys/pci.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/pci_impl.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/intel/io/pci/pci_boot.c","type":"MODIFIED","insertions":30,"deletions":-17},{"file":"usr/src/uts/intel/io/pci/pci_pci.c","type":"MODIFIED","insertions":10,"deletions":-1}],"sizeInsertions":42,"sizeDeletions":-19}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}