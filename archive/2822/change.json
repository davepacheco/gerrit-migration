{"project":"joyent/illumos-joyent","branch":"master","id":"Ic78733726279ff79f248a5ce19150a4e28d1dd7f","number":"2822","subject":"OS-6338 panic from kvm_load_gs Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2822","commitMessage":"OS-6338 panic from kvm_load_gs\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1508440848,"lastUpdated":1508790162,"open":false,"status":"MERGED","comments":[{"timestamp":1508440848,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1508441887,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1508510974,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1508517250,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI moved the call like you suggested, since that seems like it might be a safer place. I also expanded the comment. We could potentially move this back into freelwp where we\u0027re removing the context ops as another potential location, but the clean function seems like it might be safer."},{"timestamp":1508517259,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1508518773,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1508521126,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1508521133,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1508529175,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1508532741,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nI\u0027ve tested this in my smartos VM where every lx process basically takes this path on exit. I also have a kvm zone running concurrently and I\u0027m running a 32bit linux process in a loop which continuously forks, does a bit of work, and exits. However, I have never been able to reproduce the strange kvm save behavior we see in eu-ams. I think there is some unfortunate kvm sequence happening there which I haven\u0027t figured out how to hit (especially since its rare there too)."},{"timestamp":1508538527,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review-1"},{"timestamp":1508770271,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nI\u0027ve looked at all of the ways we can get here. I do think we need to keep this in lx_cleanlwp to handle the case of exec-ing a native program. This simplest solution seems to be to disable kernel preemption before the lx_save call, which I have done."},{"timestamp":1508770280,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1508771483,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1508775999,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\nI\u0027ve been running the same stuff for testing as my earlier comment, again with no problem."},{"timestamp":1508787480,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1508787502,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Code-Review+1\n\nWow. And good analysis."},{"timestamp":1508790059,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1508790137,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1508790162,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"7","revision":"c78733726279ff79f248a5ce19150a4e28d1dd7f","parents":["841ca367b46ecb6830ddafaa7a0352310bb8a270"],"ref":"refs/changes/22/2822/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508790137,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508771483,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508787480,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508787502,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1508790162,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"2c2771cb3996fc57fcf96dea52728fdd76e78046","parents":["797a25a44d0fb15715c40a2b75693d39a547c37c"],"ref":"refs/changes/22/2822/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508440848,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":8,"deletions":0}],"sizeInsertions":8,"sizeDeletions":0},{"number":"2","revision":"746ca6a66f89f466dc70f228846dff27e1bbb73a","parents":["797a25a44d0fb15715c40a2b75693d39a547c37c"],"ref":"refs/changes/22/2822/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508441887,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","line":279,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I think it would be nice to expand this comment.  Given how it\u0027s not at all straightforward why the lx_save() handler is seemingly skipped in these situations, one wouldn\u0027t want the circumstances to seem innocuous."},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","line":281,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Would lx_cleanlwp perhaps be more appropriate for this?  If a branded 32-bit process executes a native ELF binary, the exec(2)-ing LWP will only but unbranded with b_freelwp, rather than exiting.  I suspect the %gs selector would be cleaned in that situation, but the GDT entries might be left dangling?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":6,"sizeDeletions":0},{"number":"3","revision":"6cf40d9218f195dd8ea6ec61b8efec3ad9252d10","parents":["797a25a44d0fb15715c40a2b75693d39a547c37c"],"ref":"refs/changes/22/2822/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508517259,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","line":200,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027s"},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","line":200,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I fixed both of these."},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","line":201,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sentence fragment, perhaps make it a parenthetical?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":18,"deletions":0}],"sizeInsertions":18,"sizeDeletions":0},{"number":"4","revision":"c6e5f539eb066eafe7bd5869e52372760a43f448","parents":["797a25a44d0fb15715c40a2b75693d39a547c37c"],"ref":"refs/changes/22/2822/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508521133,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1508538527,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":18,"deletions":0}],"sizeInsertions":18,"sizeDeletions":0},{"number":"5","revision":"e817e741e2ba1900c124709cfb621671499a8787","parents":["797a25a44d0fb15715c40a2b75693d39a547c37c"],"ref":"refs/changes/22/2822/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508770280,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508771483,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508787502,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508787480,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},{"number":"6","revision":"acb1ddd6778ecf1b3e82b93409a7bf39f4010574","parents":["841ca367b46ecb6830ddafaa7a0352310bb8a270"],"ref":"refs/changes/22/2822/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508790059,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508771483,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508787502,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508787480,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0},{"number":"7","revision":"c78733726279ff79f248a5ce19150a4e28d1dd7f","parents":["841ca367b46ecb6830ddafaa7a0352310bb8a270"],"ref":"refs/changes/22/2822/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508790137,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1508790162,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508771483,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508787502,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508787480,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_misc.c","type":"MODIFIED","insertions":20,"deletions":0}],"sizeInsertions":20,"sizeDeletions":0}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}