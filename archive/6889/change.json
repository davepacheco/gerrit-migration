{"project":"joyent/eng","branch":"master","id":"I5b179b4fea532e9775ef84edb5d579391760f87c","number":"6889","subject":"TOOLS-2319 eng.git never passes the gerrit bot \u0027make check\u0027 Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/6889","commitMessage":"TOOLS-2319 eng.git never passes the gerrit bot \u0027make check\u0027\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1568283937,"lastUpdated":1568654578,"open":false,"status":"MERGED","comments":[{"timestamp":1568283937,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1568283942,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit ec4357234812c3f7dd5ec47653264117810fd241\n    \n    TOOLS-2319 eng.git never passes the gerrit bot \u0027make check\u0027"},{"timestamp":1568283976,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1568303794,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1568304196,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1568312050,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1568312162,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nHere is a full run of that diff working for me: https://gist.github.com/trentm/7b416e1fb087afcd2c76cecb42aec589"},{"timestamp":1568637457,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n\u003e Here is a full run of that diff working for me: \n\nAha, I see the problem with my earlier suggestion. It should have been:\n\ncheck:: $(NODE_EXEC)\n\n(though that\u0027s not as good as the idea you suggested, which we\u0027ll get to)\n\nFrom doing a \u0027make --print-database\u0027 when we had this in the Makefile:\n\ncheck-bashstyle: $(NODE_EXEC)\n\nwe were see:\n\n\u003d\u003d\u003d\ncheck-bashstyle: build/prebuilt-node-v6.17.0-zone64-c2c31b00-1d60-11e9-9a77-ff9f06554b0f\n#  Implicit rule search has not been done.\n#  File is an intermediate prerequisite.\n#  Modification time never checked.\n#  File has not been updated.\n.\n.\ncheck-bash: tools/check-copyright.bashchk tools/check-copyright.bashstyle\n#  Phony target (prerequisite of .PHONY).\n#  Implicit rule search has not been done.\n#  File is an intermediate prerequisite.\n#  File does not exist.\n#  File has not been updated.\n# variable set hash-table stats:\n# Load\u003d0/32\u003d0%, Rehash\u003d0, Collisions\u003d0/9\u003d0%\n.\n.\ncheck:: check-jsl check-json check-jsstyle check-bash check-copyright\n#  Phony target (prerequisite of .PHONY).\n#  Implicit rule search has not been done.\n#  File does not exist.\n#  File has not been updated.\n# variable set hash-table stats:\n# Load\u003d0/32\u003d0%, Rehash\u003d0, Collisions\u003d0/31\u003d0%\n#  recipe to execute (from \u0027deps/eng/tools/mk/Makefile.targ\u0027, line 296):\n        @echo check ok\n\u003d\u003d\u003d\n\nNotably, \u0027check-bashstyle\u0027 isn\u0027t dependency of \u0027check\u0027 at all, so it never ran.\n\nYour suggestion of adding $(NODE_EXEC) as a dependency of check-bash is a good one. I think adding it as an order-only-prerequisite (https://www.gnu.org/software/make/manual/make.html#Prerequisite-Types) is probably the right way to do this."},{"timestamp":1568639303,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n\u003e I think adding it as an order-only-prerequisite\n \u003e (https://www.gnu.org/software/make/manual/make.html#Prerequisite-Types)\n \u003e is probably the right way to do this.\n\nHm, nope, I don\u0027t think it\u0027s exactly correct - I was misinterpreting what order-only-prerequisites are actually for.\n\nWhile:\n\n%.bashstyle: % | $(NODE_EXEC)\n        $(BASHSTYLE) $^\n\nworks, that\u0027s only because $^ maps to the % in the dependency list and doesn\u0027t include $(NODE_EXEC). Sticking $(NODE_EXEC) as a dependency for \u0027check-bash\u0027 seems a bit cleaner."},{"timestamp":1568639379,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1568639384,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 9ddb992c19096e265417d41a501c5df9baaed94b\n    \n    TOOLS-2319 eng.git never passes the gerrit bot \u0027make check\u0027"},{"timestamp":1568639419,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1568639486,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1568639491,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit f284dc800236514b55a2f45a8f52829dcafc8b98\n    \n    TOOLS-2319 eng.git never passes the gerrit bot \u0027make check\u0027"},{"timestamp":1568639526,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1568653007,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1568654512,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1568654540,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1568654553,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"},{"timestamp":1568654578,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"c38311a4e29cdb61735a3d1700e1d1142cb080f3","parents":["a4cbbd907fa765a9115cc986accf414a53e39e7f"],"ref":"refs/changes/89/6889/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1568654540,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1568639419,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1568654553,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"694498e6b8c9190340d68d20ad6372483e02b51e","parents":["ff8cb80de7275871d2e3c5929356d31d142dd6ac"],"ref":"refs/changes/89/6889/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1568283937,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1568283976,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":282,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"WOuld it be (not sure) more correct to have the dep on NODE_EXEC be for the `check-bashstyle` target?"},{"file":"Makefile","line":282,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"It seems so, but I think we\u0027re falling foul of some make target ordering issue when we try that:\n\n\ntimf@jenkins-agent-x86_64-18.4.0 (grr-TOOLS-2319) git diff\ndiff --git a/Makefile b/Makefile\nindex 53bf488..751e30d 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -279,7 +279,7 @@ test_ctf: helloctf $(STAMP_CTF_TOOLS)\n # runs correctly when making changes to eng.git. It should not be\n # copied into repositories using this Makefile as a template.\n #\n-check:: $(NODE_EXEC)\n+check-bashstyle: $(NODE_EXEC)\n\n #\n # Target definitions.  This is where we include the target Makefiles for\n\n\ntimf@jenkins-agent-x86_64-18.4.0 (grr-TOOLS-2319) make clean\nrm -rf myproject-pkg*.gz make_stamps smf/manifests/bapi.xml cache/gopath-1.9.2 node_modules man cache/helloctf.obj helloctf cscope.in.out cscope.out cscope.po.out build/docs/public docs/index.html docs/boilerplateapi.html docs/index.json docs/boilerplateapi.json\n\n\n\ntimf@jenkins-agent-x86_64-18.4.0 (grr-TOOLS-2319) make check\nsed -e \u0027s#@@NODE@@#@@PREFIX@@/build/node/bin/node#\u0027 smf/manifests/bapi.xml.in \u003e smf/manifests/bapi.xml\nxmllint --noout --path deps/eng/tools/ --dtdvalid deps/eng/tools/service_bundle.dtd.1 smf/manifests/bapi.xml\ndeps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dtools/jsl.node.conf lib/index.js test/api.test.js tools/bashstyle\n/mnt/tank/projects/eng.git/lib/index.js\n/mnt/tank/projects/eng.git/test/api.test.js\n/mnt/tank/projects/eng.git/tools/bashstyle\njson --validate -f package.json\ndeps/jsstyle/jsstyle -f tools/jsstyle.conf lib/index.js test/api.test.js tools/bashstyle\nbash -n tools/check-copyright\n/mnt/tank/projects/eng.git/build/node/bin/node deps/eng/tools/bashstyle tools/check-copyright\nmake: /mnt/tank/projects/eng.git/build/node/bin/node: Command not found\nmake: *** [deps/eng/tools/mk/Makefile.targ:245: tools/check-copyright.bashstyle] Error 127\ntimf@jenkins-agent-x86_64-18.4.0 (grr-TOOLS-2319)"},{"file":"Makefile","line":282,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I mean this:\n\n```\ndiff --git a/Makefile b/Makefile\nindex 523eaef..e0b5eef 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -129,6 +129,8 @@ include ./deps/eng/tools/mk/Makefile.smf.defs\n NODE_PREBUILT_VERSION \u003d        v6.17.0\n ifeq ($(shell uname -s),SunOS)\n        NODE_PREBUILT_TAG \u003d zone64\n+       # Use the sdcnode build for minimal-64-lts@18.4.0\n+       NODE_PREBUILT_IMAGE \u003d c2c31b00-1d60-11e9-9a77-ff9f06554b0f\n        include ./deps/eng/tools/mk/Makefile.node_prebuilt.defs\n else\n        NPM\u003dnpm\ndiff --git a/tools/mk/Makefile.targ b/tools/mk/Makefile.targ\nindex 755107f..a375664 100644\n--- a/tools/mk/Makefile.targ\n+++ b/tools/mk/Makefile.targ\n@@ -236,7 +236,7 @@ deps/%/.git:\n # the command line with \"make filename.bashchk\".\n #\n .PHONY: check-bash\n-check-bash: $(BASH_FILES:%\u003d%.bashchk) $(BASH_FILES:%\u003d%.bashstyle)\n+check-bash: $(NODE_EXEC) $(BASH_FILES:%\u003d%.bashchk) $(BASH_FILES:%\u003d%.bashstyle)\n\n %.bashchk: %\n        $(BASH) -n $^\n```"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":9,"deletions":0}],"sizeInsertions":9,"sizeDeletions":0},{"number":"2","revision":"11d06ea4db3c24e3e867e688301406c6e7d58dc2","parents":["ff8cb80de7275871d2e3c5929356d31d142dd6ac"],"ref":"refs/changes/89/6889/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1568639379,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1568639419,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-1},{"number":"3","revision":"d4e88f7c2a657116851f8a7e04a215132e433803","parents":["cdd764936f02cc306a7fc7df4552e9e986338b32"],"ref":"refs/changes/89/6889/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1568639486,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1568639419,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-1},{"number":"4","revision":"5b179b4fea532e9775ef84edb5d579391760f87c","parents":["cdd764936f02cc306a7fc7df4552e9e986338b32"],"ref":"refs/changes/89/6889/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1568654512,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1568639419,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-1},{"number":"5","revision":"c38311a4e29cdb61735a3d1700e1d1142cb080f3","parents":["a4cbbd907fa765a9115cc986accf414a53e39e7f"],"ref":"refs/changes/89/6889/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1568654540,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1568639419,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568653007,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1568654553,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":6,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}