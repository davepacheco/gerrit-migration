From 60d0a2655d62eeb54e48b3baf3a94d7edc1d148e Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Thu, 20 Dec 2018 00:39:05 +0000
Subject: [PATCH] MANTA-3779 Add 'singlePath' field to new object metadata

---
 lib/moray_delete_record_reader.js | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/lib/moray_delete_record_reader.js b/lib/moray_delete_record_reader.js
index 96c643d..210b380 100644
--- a/lib/moray_delete_record_reader.js
+++ b/lib/moray_delete_record_reader.js
@@ -309,9 +309,29 @@ state_running(S)
 		 */
 		var creator = record.value.creator || record.value.owner;
 
-		if (self._is_allowed_creator(creator)) {
+		/*
+		 * There are two ways objects may enter the accelerated
+		 * garbage-collection pipeline:
+		 *
+		 * 1. The objects are owned by a snaplink disabled account
+		 * 2. The objects have the `singlePath` property set to true
+		 *
+		 * (2) implies that the object has never been snaplinked, so it
+		 * is safe to get rid of its only metadata record.
+		 */
+		if (self._is_allowed_creator(creator) ||
+		    record.value.singlePath === true) {
 			self.mr_listener.emit('record', record);
 			record_keys.push(record.key);
+		} else {
+			self.mr_log.error({
+				key: record.key,
+				value: record.value
+			}, 'Found a record belonging to an account with ' +
+			    'snaplinks enabled that does not have the '   +
+			    '`singlePath` property set. Such entries '    +
+			    'should never appear in an accelerated gc '   +
+			    'queue!');
 		}
 	});
 
-- 
2.21.0

