{"project":"joyent/sdc-vmapi","branch":"master","id":"I7370388b563755807d54d31baccc3b0aab61d306","number":"3280","subject":"TRITON-63 Add metrics collection to VMAPI Reviewed by: Richard Kiene \u003crichard.kiene@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"url":"https://cr.joyent.us/3280","commitMessage":"TRITON-63 Add metrics collection to VMAPI\nReviewed by: Richard Kiene \u003crichard.kiene@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1517425527,"lastUpdated":1518117295,"open":false,"status":"MERGED","comments":[{"timestamp":1517425527,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 1."},{"timestamp":1517425528,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 8d1235cc5f8bd0ef3cc9b8e1f7fef33cb8c5d6b7\n    \n    TRITON-63 add artedi metrics collection"},{"timestamp":1517425560,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517426946,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 1:\n\n(3 comments)\n\nPlease, please, please feel free to nit everything. I\u0027m still not very familiar with the code style/standards of the codebase and I\u0027m sure I have a lot of blindspots. I\u0027ll be using this as a reference as I implement artedi into other Triton services so it\u0027s important that this serves as a good example."},{"timestamp":1517598767,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 2."},{"timestamp":1517598767,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 817a49d6a1181d5431e83de93e5e85c4e1d75e4c\n    \n    break monitoring server into module"},{"timestamp":1517598797,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517604316,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(14 comments)"},{"timestamp":1517885151,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 3."},{"timestamp":1517885152,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 6bf046d63624b293ba561f0323dc86cc575e2949\n    \n    refactor metrics"},{"timestamp":1517885182,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\n(13 comments)"},{"timestamp":1517885191,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517885425,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 4."},{"timestamp":1517885425,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit ad53013adc4537a394220ea55cfb973ec16c6e4f\n    \n    doc fixes"},{"timestamp":1517885457,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517886095,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 5."},{"timestamp":1517886096,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 6e7c90c2aab9323f8308bf31ce69cd73b58bdbc0\n    \n    makefile fix"},{"timestamp":1517886128,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517942999,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 6."},{"timestamp":1517942999,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit c626e5474739b5ff22d6faf1b8a33571f856b73d\n    \n    move metrics log into module"},{"timestamp":1517943036,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517943275,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1517944331,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1517958908,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(16 comments)"},{"timestamp":1517972466,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 7."},{"timestamp":1517972466,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit fae3711fddc3d5a7c6af0944367b6a4e82f4e4b6\n    \n    cr fixes"},{"timestamp":1517972498,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517972512,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 7:\n\n(13 comments)"},{"timestamp":1518028744,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 8."},{"timestamp":1518028745,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 8ca2abec425fadd8a6054a40ce35486c28e8316b\n    \n    tiny fix"},{"timestamp":1518028778,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 7:\n\n(3 comments)"},{"timestamp":1518028802,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518029944,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 9."},{"timestamp":1518029945,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 700b346d297ae9e3b737ad7bf6652112e9f41d77\n    \n    change Metrics to MetricsManager"},{"timestamp":1518029985,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518047846,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 9:\n\n(2 comments)\n\nJust the \u0027pid\u0027 thing and a nit for the docs. This is working for me!\n\nI poke RichardK to take a sanity check at this CR if he has a chance. Let\u0027s wait a bit for that at least."},{"timestamp":1518048707,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 9:\n\n(4 comments)"},{"timestamp":1518049218,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1518050187,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1518052229,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1518052765,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 10."},{"timestamp":1518052765,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 19581f48bac937e2a6b838b1d5d9ffe6611e8295\n    \n    remove pid from labels"},{"timestamp":1518052801,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518055937,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1518103477,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1518103531,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1518111747,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 10: Code-Review+1 Integration-Approval+1\n\n(2 comments)"},{"timestamp":1518114040,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Uploaded patch set 11."},{"timestamp":1518114041,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit cb5beafbf6893ac50ec1c32b2e574e932acef9e1\n    \n    split user agent at space"},{"timestamp":1518114082,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518114636,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 11: Code-Review+1 Integration-Approval+1"},{"timestamp":1518117295,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dylan Yep"}],"currentPatchSet":{"number":"11","revision":"7370388b563755807d54d31baccc3b0aab61d306","parents":["12fdf6192a9469fc79d9ebcbd4badc96991420d4"],"ref":"refs/changes/80/3280/11","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518114040,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518114082,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518114636,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518114636,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1518117295,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":397,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"5f48cd215247e229805e833c5c59faf1514c30d1","parents":["3ce6a7de61610641325f0bb6cccca27104c5ecc2"],"ref":"refs/changes/80/3280/1","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517425527,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517425560,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":449,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d like the actual metric names we have for this. That\u0027s useful for grepping around in docs/repos."},{"file":"docs/index.md","line":449,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"docs/index.md","line":460,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The TRITON-37 proposal was to have route, method, user_agent, api_version, status_code.\n\nWould be nice if that list put the general (datacenter, service, instance, server, pid) ones at the top."},{"file":"docs/index.md","line":460,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"My apologies for my reading comprehension issues! I\u0027ll be clearly stating this in my tickets to make sure I don\u0027t get confused again."},{"file":"lib/vmapi.js","line":182,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"It might be helpful to pull these declarations and the \u0027after\u0027 processing below into the metrics.js/monitoring.js separate file.  Then we\u0027ll be able to see all the smarts of metrics collection in one file, which could better lead to moving that functionality out to a shared \"node-triton-service-metrics\" library (or whatever name)."},{"file":"lib/vmapi.js","line":182,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/vmapi.js","line":184,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"How about drop \"VMAPI\" here so it is generic for cut \u0027n paste (or module re-use) in all the services?"},{"file":"lib/vmapi.js","line":184,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/vmapi.js","line":230,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The TRITON-37 proposal was to have route, method, user_agent, api_version, status_code."},{"file":"lib/vmapi.js","line":230,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/vmapi.js","line":234,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be good have this in a separate handler that is registered on \u0027after\u0027, so it isn\u0027t mixed up with the audit logging that this handler is doing."},{"file":"lib/vmapi.js","line":234,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"sapi_manifests/vmapi/template","line":10,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"These two vars are deprecated as of SAPI-248\n(see https://github.com/joyent/sdc-sapi/blob/master/lib/server/attributes.js#L365-L372).  From the ticket:\n\n```\nReplace with:\n- auto.ZONENAME by config-agent v1.2.0 (See SAPI-224 for related work)\n  It\u0027ll get it from running `zonename`.\n- auto.SERVER_UUID by config-agent v1.2.0\n  It\u0027ll get it from `mdata-get sdc:server_uuid`.\n```\n\nAny vmapi builds these days will have config-agent v1.2.0."},{"file":"sapi_manifests/vmapi/template","line":10,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"server.js","line":139,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Worth putting this in a separate file?"},{"file":"server.js","line":139,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yes, this and the createMonitoringServer below as well. You may already have done that in patchset 2."},{"file":"server.js","line":139,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"server.js","line":186,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps do not hang this off the `config` object, which is mostly just a data object loaded from /opt/smartdc/vmapi/config.json.  Is `config` passed to some function that needs `config.collector`?"},{"file":"server.js","line":186,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"server.js","line":305,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Terminology: I *think* I\u0027d like to use \"metrics\" rather than \"monitor(ing)\" for the naming of all this stuff. I understand there isn\u0027t a good term for \"the thing that collects the metrics\" where that is needed. Perhaps \"collector\" as artedi is using.\n\nTo me a \"monitor\" is more something like Amon that active is checking things and acting on results. However, we do have *CMON* that is only about *enabling* doing monitoring, so we do have both usages.\n\nOur services\u0027 servers for these will have a \"/metrics\" endpoint, so that name is going to be in play regardless.\n\nThoughts? Totally happy to discuss."},{"file":"server.js","line":305,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"indentation issue there?"},{"file":"server.js","line":305,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"server.js","line":305,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Makes sense to me. I initially went with monitor so as to mirror the Muskie implementation."},{"file":"server.js","line":305,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, I hadn\u0027t realized Muskie had that naming. I see it is because they also use that \"monitoring\" server for things other than metrics (e.g. Kang for debug info). Hrm."},{"file":"server.js","line":312,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We should always avoid using \"0.0.0.0\" for listening. Those zones that get an external NIC will then be listening on a public IP (potentially). There is a config-agent provide var for SAPI templates (aka \"sapi_manifests\") called `auto.ADMIN_IP` that can be put in the config file and used for this.  E.g. https://github.com/joyent/sdc-cnapi/blob/master/sapi_manifests/cnapi/template#L45"},{"file":"server.js","line":312,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","line":1,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"This test will always fail when running \"make test-coal\" because it runs the tests from the global zone. Not sure if fixing this is within the scope of this change."},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","line":1,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm. This is how the vmapi test suite is run in nightly-1/2:\nhttps://github.com/joyent/globe-theatre/blob/master/bin/stage-test-vmapi#L99-L103\n\nI.e. it runs the tests from inside the VMAPI zone, IIUC. Perhaps \u0027make test-coal\u0027 should change here to do the same?"},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","line":1,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","line":106,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Should maybe mock/stub/noop this in everything but monitoring.test.js?"},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","line":106,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Potentially. If the artedi collector is fairly lightweight (which I\u0027d guess it is), then it shouldn\u0027t be a problem."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":30,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":59,"deletions":-1},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"test/monitoring.test.js","type":"ADDED","insertions":154,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":309,"sizeDeletions":-12},{"number":"2","revision":"d8a385589d7a1d18334518517201e42fbf5daccb","parents":["3ce6a7de61610641325f0bb6cccca27104c5ecc2"],"ref":"refs/changes/80/3280/2","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517598767,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517598797,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"lib/monitor.js","type":"ADDED","insertions":63,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":30,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":4,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":31,"deletions":-1},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"test/monitoring.test.js","type":"ADDED","insertions":154,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":344,"sizeDeletions":-12},{"number":"3","revision":"8b437c19da867ef84dda7b8354a32f01e76dd21a","parents":["3ce6a7de61610641325f0bb6cccca27104c5ecc2"],"ref":"refs/changes/80/3280/3","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517885151,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517885191,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/metrics.js","line":33,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"need a `return;` here else we will call `next` twice."},{"file":"lib/metrics.js","line":33,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":36,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is the \"exposition\" reference meant to explain the \"; version\u003d0.0.4\"? Because I still don\u0027t get why that."},{"file":"lib/metrics.js","line":36,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":47,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Any preference as to constructors vs factory functions (in general and in this specific instance)? I went with a constructor to stay consistent with the rest of the repo, but I usually err towards factory functions --\n especially when I\u0027m only creating a few objects -- for flexibility and avoiding ambiguities with regard to \u0027this\u0027."},{"file":"lib/metrics.js","line":47,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t have a strong bias in general. So I\u0027m fine with which ever you or others prefer."},{"file":"test/vms.data-migrations.test.js","line":40,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"I think these are actually stubs, right? I definitely don\u0027t feel the need to change this -- it\u0027s more for my understanding."},{"file":"test/vms.data-migrations.test.js","line":40,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yah, just stubs to support the required options to VmapiApp, but not actually do anything."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":26,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":156,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":375,"sizeDeletions":-11},{"number":"4","revision":"5fea862e5aa3331d1ac68772a96f934ae07735fb","parents":["3ce6a7de61610641325f0bb6cccca27104c5ecc2"],"ref":"refs/changes/80/3280/4","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517885425,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517885457,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":39,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":26,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":156,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":377,"sizeDeletions":-11},{"number":"5","revision":"e0436987fcf8be6c4a3fd161433d05e851b45605","parents":["3ce6a7de61610641325f0bb6cccca27104c5ecc2"],"ref":"refs/changes/80/3280/5","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517886095,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517886128,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":39,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":99,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":26,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":156,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":377,"sizeDeletions":-11},{"number":"6","revision":"55ee6c56b0102eaaf3d630bba08f4f8f992194ea","parents":["3ce6a7de61610641325f0bb6cccca27104c5ecc2"],"ref":"refs/changes/80/3280/6","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517942999,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517943036,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":454,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Typo. Will fix after cr."},{"file":"docs/index.md","line":454,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"docs/index.md","line":458,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"In TRITON-37 it was still a TODO on me to spec this. I actually believe that VMAPI is setting `version` incorrectly in its `restify.createServer` call... and that it is all fine because VMAPI doesn\u0027t do API versioning yet.\n\nPerhaps drop \"api_version\" for now and we can revisit (open a separate TRITON ticket to revisit this?).  It has long be a TODO on me to define how we should do API versioning with restify and our APIs. Currently IMGAPI and CloudAPI at least are doing API versioning."},{"file":"docs/index.md","line":458,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"TRITON-113"},{"file":"lib/metrics.js","line":29,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"And to save a future reader some archaeology, there was some discussion of this equivalent change in Muskie on this CR: https://cr.joyent.us/#/c/2823/ (the comments on line 400 of lib/other.js)."},{"file":"lib/metrics.js","line":29,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":35,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"perhaps link to https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md#format-version-004 ?"},{"file":"lib/metrics.js","line":35,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":50,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Eventually we might want to assert that the core Triton set of labels are specified here. Again, can wait for the factoring out."},{"file":"lib/metrics.js","line":50,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":67,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can be later, but when we factor this out to re-usable code, we\u0027ll have to allow (require?) the port to be given in the config. E.g. in the cloudapi zone there are multiple cloudapi processes. Each will have to use a separate port for its metrics server."},{"file":"lib/metrics.js","line":67,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":73,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"add a name to all functions please; same for the method below"},{"file":"lib/metrics.js","line":73,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"lib/metrics.js","line":89,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I wonder if we\u0027ll want to trim this user-agent at the first space for cardinality. Can you at least open a separate TRITON ticket to look into that? We should take a look at user-agents for logs to our core services to see the range. The first token is typically the important bit; after that you sometimes get the versions of libraries compiled into the app calling... which is potentially useful, but cardinality could explode."},{"file":"lib/metrics.js","line":89,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"I\u0027ll err on the side of caution and trim the user-agent header. \n\nTicket opened:\nTRITON-112"},{"file":"server.js","line":278,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Naming nit.  BTW, I\u0027d totally be okay ignoring this, or following up in a separate commit.  For a while the \"VmapiApp\" was called \"VMAPI\"... but we found that it was misleading and hard to grep for.  It might be nicer to call this the MetricsManager or similar.  I still like \"lib/metrics.js\", so perhaps that could export a \"createMetricsManager(options)\"?  Anyway, this is a nit compared to other comments."},{"file":"server.js","line":278,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"test/metrics.test.js","line":94,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, a bare `funcs` works fine. The use of explicit quoting there is just dap\u0027s style (the author of vasync, etc.). :)"},{"file":"test/metrics.test.js","line":94,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"test/metrics.test.js","line":117,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps just assert that it has increased, but not by one? Otherwise tests running in parallel or just someone else using nightly-1 at the same time or some separate thing running in cron in the DC could spuriously break this test.\n\nThat is unless I misunderstand and this is a VMAPI server that is only running for this test case."},{"file":"test/metrics.test.js","line":117,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"test/metrics.test.js","line":153,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Same comment as above."},{"file":"test/metrics.test.js","line":153,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":39,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":104,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":381,"sizeDeletions":-11},{"number":"7","revision":"bd6536a3702756d0dad4c3307ac859936e7d1f51","parents":["12fdf6192a9469fc79d9ebcbd4badc96991420d4"],"ref":"refs/changes/80/3280/7","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1517972466,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517972498,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/vmapi.js","line":123,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"No need to attach this to VmapiApp instance"},{"file":"server.js","line":41,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"make alphabetical"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":38,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":401,"sizeDeletions":-11},{"number":"8","revision":"18f024f0a24fe99496658196aadad4804777cf87","parents":["12fdf6192a9469fc79d9ebcbd4badc96991420d4"],"ref":"refs/changes/80/3280/8","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518028744,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518028802,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":38,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":399,"sizeDeletions":-11},{"number":"9","revision":"a7deff240f611c7ecb81ea371fd59ec540029108","parents":["12fdf6192a9469fc79d9ebcbd4badc96991420d4"],"ref":"refs/changes/80/3280/9","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518029944,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518029985,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":442,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, using \"localhost\" doesn\u0027t work (at least for me) now that that server is only listening on $ADMIN_IP:\n\n```\n[root@0ddbc991-76bf-4450-9293-342e3faaaa06 (coal:vmapi0) /opt/smartdc/vmapi]# curl 10.99.99.26:8881/metrics\n# HELP http_requests_completed count of requests completed\n# TYPE http_requests_completed counter\n# HELP http_request_duration_seconds total time to process requests\n# TYPE http_request_duration_seconds histogram\n[root@0ddbc991-76bf-4450-9293-342e3faaaa06 (coal:vmapi0) /opt/smartdc/vmapi]# curl localhost:8881/metrics\ncurl: (7) Couldn\u0027t connect to server\n```"},{"file":"docs/index.md","line":442,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"What is the motivation for port 8881? We\u0027ve been using 9163 for CMON. It\u0027s not a huge deal, just curious."},{"file":"docs/index.md","line":457,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Are there any concerns with the cardinality of these labels?"},{"file":"docs/index.md","line":457,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"@richard:\n\nWe are dropping pid.\n\nserver: not sure. How high is too high for cardinality? I guess across, say, SPC, we\u0027ll be into many 100s."},{"file":"docs/index.md","line":457,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"It\u0027ll depend on the cardinality of permutations and combinations of labels, but I\u0027m good with giving the server label a try :)"},{"file":"lib/metrics.js","line":99,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Do we want to split at \u0027/\u0027 instead of \u0027 \u0027 for cardinality issues?"},{"file":"lib/metrics.js","line":99,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Small sample size, but I ran a quick job on one day of production vmapi logs. Splitting at \u0027 \u0027 gave a user-agent cardinality of 13. Splitting at \u0027/\u0027 had a cardinality of 6."},{"file":"lib/metrics.js","line":99,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nah. Let\u0027s leave that to TRITON-112 work to decide. This\u0027ll be fine for now."},{"file":"lib/metrics.js","line":113,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"I believe the general recommendation from Prometheus is to not do these types of conversions and instead defer the conversion to query time at the Prometheus server.\n\nIt might be preferable to leave this as milliseconds."},{"file":"lib/metrics.js","line":113,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We discussed this with josh and from reading https://prometheus.io/docs/practices/naming/#metric-names that exposing as *seconds* was preferred. Josh\u0027s example was that his CMON GZ metrics work for NTP would use *seconds*."},{"file":"lib/metrics.js","line":113,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Yeah, I guess they changed their recommendation. I personally think expressing request latency in seconds will lead to some fidelity loss, but whatever we\u0027re okay with :) My preference would be to *not* follow that recommendation since milliseconds should be the largest measurement necessary for request latency. That said, I certainly wouldn\u0027t block a +1 for that."},{"file":"package.json","line":8,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Any objections to removing the ^ and going with an explicit version?"},{"file":"package.json","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"+1 from me.  Avoiding any ranges, esp. for top-level components is my pref -- tho the Triton team or eng.git haven\u0027t formalized that preference (yet :)."},{"file":"package.json","line":8,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"},{"file":"server.js","line":271,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We just discussed dropping \u0027pid\u0027. I\u0027ve updated the proposal comment on TRITON-37."},{"file":"server.js","line":271,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":38,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":399,"sizeDeletions":-11},{"number":"10","revision":"5b088edd07bd9adcdfc1d77bc13ebdd4a8d45754","parents":["12fdf6192a9469fc79d9ebcbd4badc96991420d4"],"ref":"refs/changes/80/3280/10","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518052765,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518052801,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518103531,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518111747,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518111747,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/vmapi.js","line":239,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"This collects metrics on /ping unlike the audit function above. Do we want that?"},{"file":"lib/vmapi.js","line":239,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yes, I think it is fine (and good) to have metrics on all the endpoints."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":397,"sizeDeletions":-11},{"number":"11","revision":"7370388b563755807d54d31baccc3b0aab61d306","parents":["12fdf6192a9469fc79d9ebcbd4badc96991420d4"],"ref":"refs/changes/80/3280/11","uploader":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"createdOn":1518114040,"author":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518114082,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518114636,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518114636,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1518117295,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":37,"deletions":-1},{"file":"lib/metrics.js","type":"ADDED","insertions":125,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/vmapi/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"test/metrics.test.js","type":"ADDED","insertions":157,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":6,"deletions":-1}],"sizeInsertions":397,"sizeDeletions":-11}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}]}