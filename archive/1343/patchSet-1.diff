From 074fb4a79696900dd184374c9011706d6b49ae6d Mon Sep 17 00:00:00 2001
From: Ryan Zezeski <rpz@joyent.com>
Date: Wed, 25 Jan 2017 20:21:46 -0700
Subject: [PATCH] OS-5716 avoid unnecessary sudo calls in test-runner

---
 usr/src/test/test-runner/cmd/run | 44 +++++++++++++++++++++++++++-----
 1 file changed, 37 insertions(+), 7 deletions(-)

diff --git a/usr/src/test/test-runner/cmd/run b/usr/src/test/test-runner/cmd/run
index ad0204d136..beb3319584 100644
--- a/usr/src/test/test-runner/cmd/run
+++ b/usr/src/test/test-runner/cmd/run
@@ -12,6 +12,7 @@
 #
 
 #
+# Copyright 2017 Joyent, Inc.
 # Copyright (c) 2012, 2015 by Delphix. All rights reserved.
 #
 
@@ -35,6 +36,7 @@ BASEDIR = '/var/tmp/test_results'
 KILL = '/usr/bin/kill'
 TRUE = '/usr/bin/true'
 SUDO = '/usr/bin/sudo'
+SU = '/usr/bin/su'
 
 # Custom class to reopen the log file in case it is forcibly closed by a test.
 class WatchedFileHandlerClosed(WatchedFileHandler):
@@ -162,7 +164,16 @@ class Cmd(object):
         sudo is required, this user was verified previously.
         """
         self.killed = True
-        do_sudo = len(self.user) != 0
+
+        cur_user = getpwuid(os.getuid()).pw_name
+
+        #
+        # If a no user was specified in the runfile or the user
+        # executing the test is root then don't use sudo.
+        #
+        if len(self.user) == 0 or cur_user == 'root':
+            do_sudo = False
+
         signal = '-TERM'
 
         cmd = [SUDO, KILL, signal, str(proc.pid)]
@@ -179,14 +190,19 @@ class Cmd(object):
         """
         If a user has been specified to run this Cmd and we're not already
         running as that user, prepend the appropriate sudo command to run
-        as that user.
+        as that user. If running as root use su instead.
         """
-        me = getpwuid(os.getuid())
 
-        if not user or user is me:
+        cur_user = getpwuid(os.getuid()).pw_name
+
+        if not user or user == cur_user:
             return cmd
 
-        ret = '%s -E -u %s %s' % (SUDO, user, cmd)
+        if cur_user == 'root':
+            ret = '%s %s -c %s' % (SU, user, cmd)
+        else:
+            ret = '%s -E -u %s %s' % (SUDO, user, cmd)
+
         return ret.split(' ')
 
     def collect_output(self, proc):
@@ -729,14 +745,28 @@ def verify_file(pathname):
 
 def verify_user(user, logger):
     """
-    Verify that the specified user exists on this system, and can execute
-    sudo without being prompted for a password.
+    Verify that the specified user exists on this system, and can
+    execute sudo without being prompted for a password. If the user
+    executing the test is the same as the requested user then this
+    check is skipped. If the user executing the test is root this
+    check is skipped as su can be used instead of sudo.
     """
+
     testcmd = [SUDO, '-n', '-u', user, TRUE]
 
     if user in Cmd.verified_users:
         return True
 
+    cur_user = getpwuid(os.getuid()).pw_name
+
+    if user == cur_user:
+        Cmd.verified_users.append(user)
+        return True
+
+    if user == 'root':
+        Cmd.verified_users.append(user)
+        return True
+
     try:
         _ = getpwnam(user)
     except KeyError:
-- 
2.21.0

