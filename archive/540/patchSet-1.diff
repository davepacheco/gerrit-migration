From 3c2c0481bd870c0f84b3f1d42a63915dfedd83d2 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 28 Sep 2016 22:38:30 +0000
Subject: [PATCH] OS-5686 new boot loader build is racy

---
 usr/src/boot/sys/boot/efi/boot1/Makefile       | 2 +-
 usr/src/boot/sys/boot/efi/libefi/Makefile      | 2 +-
 usr/src/boot/sys/boot/efi/loader/Makefile      | 2 +-
 usr/src/boot/sys/boot/ficl/Makefile.inc        | 2 +-
 usr/src/boot/sys/boot/i386/gptzfsboot/Makefile | 2 +-
 usr/src/boot/sys/boot/i386/libi386/Makefile    | 2 +-
 usr/src/boot/sys/boot/i386/loader/Makefile     | 2 +-
 usr/src/boot/sys/boot/zfs/Makefile.com         | 2 +-
 8 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/usr/src/boot/sys/boot/efi/boot1/Makefile b/usr/src/boot/sys/boot/efi/boot1/Makefile
index 01d8d95fdc..7d8ae61d83 100644
--- a/usr/src/boot/sys/boot/efi/boot1/Makefile
+++ b/usr/src/boot/sys/boot/efi/boot1/Makefile
@@ -66,7 +66,7 @@ LDFLAGS=	-nostdlib --eh-frame-hdr -znocombreloc
 LDFLAGS +=	-shared --hash-style=both --enable-new-dtags
 LDFLAGS +=	-T${LDSCRIPT} -Bsymbolic
 
-all: machine x86 boot1.efi
+all: machine x86 .WAIT boot1.efi
 install: all $(ROOTBOOTFILES)
 
 #
diff --git a/usr/src/boot/sys/boot/efi/libefi/Makefile b/usr/src/boot/sys/boot/efi/libefi/Makefile
index 38a544f743..98ed84d597 100644
--- a/usr/src/boot/sys/boot/efi/libefi/Makefile
+++ b/usr/src/boot/sys/boot/efi/libefi/Makefile
@@ -19,7 +19,7 @@ CC=     $(GCC_ROOT)/bin/gcc
 
 LIB=	efi
 
-all:	machine x86 lib$(LIB).a
+all:	machine x86 .WAIT lib$(LIB).a
 install:
 
 SRCS=	delay.c efi_console.c efinet.c efipart.c errno.c handles.c \
diff --git a/usr/src/boot/sys/boot/efi/loader/Makefile b/usr/src/boot/sys/boot/efi/loader/Makefile
index 5824a84ada..eef630e44f 100644
--- a/usr/src/boot/sys/boot/efi/loader/Makefile
+++ b/usr/src/boot/sys/boot/efi/loader/Makefile
@@ -88,7 +88,7 @@ CLEANFILES=	vers.c loader.efi
 
 NEWVERSWHAT=	"EFI loader" ${MACHINE}
 
-all: machine x86 loader.efi
+all: machine x86 .WAIT loader.efi
 install: all $(ROOTBOOTFILES)
 
 vers.c:	../../common/newvers.sh ../../efi/loader/version
diff --git a/usr/src/boot/sys/boot/ficl/Makefile.inc b/usr/src/boot/sys/boot/ficl/Makefile.inc
index 37a3cc45af..0a1d59d58f 100644
--- a/usr/src/boot/sys/boot/ficl/Makefile.inc
+++ b/usr/src/boot/sys/boot/ficl/Makefile.inc
@@ -36,7 +36,7 @@ HEADERS= $(FICLDIR)/ficl.h $(FICLDIR)/ficlplatform/unix.h ../ficllocal.h
 MAJOR = 4
 MINOR = 1.0
 
-lib: machine x86 libficl.a
+lib: machine x86 .WAIT libficl.a
 
 # static library build
 libficl.a: $(OBJECTS)
diff --git a/usr/src/boot/sys/boot/i386/gptzfsboot/Makefile b/usr/src/boot/sys/boot/i386/gptzfsboot/Makefile
index 6147c3a947..a96a836c50 100644
--- a/usr/src/boot/sys/boot/i386/gptzfsboot/Makefile
+++ b/usr/src/boot/sys/boot/i386/gptzfsboot/Makefile
@@ -73,7 +73,7 @@ include ../Makefile.inc
 
 .PARALLEL:
 
-all: machine x86 $(PROG)
+all: machine x86 .WAIT $(PROG)
 
 install: all $(ROOTBOOTPROG)
 
diff --git a/usr/src/boot/sys/boot/i386/libi386/Makefile b/usr/src/boot/sys/boot/i386/libi386/Makefile
index f3780e856e..7762822419 100644
--- a/usr/src/boot/sys/boot/i386/libi386/Makefile
+++ b/usr/src/boot/sys/boot/i386/libi386/Makefile
@@ -19,7 +19,7 @@ CFLAGS= -O2 -I../../../../include -I../../..
 CFLAGS += -DLOADER_ZFS_SUPPORT
 CPPFLAGS=
 
-all: machine x86 libi386.a
+all: machine x86 .WAIT libi386.a
 
 clean: clobber
 clobber:
diff --git a/usr/src/boot/sys/boot/i386/loader/Makefile b/usr/src/boot/sys/boot/i386/loader/Makefile
index bf8ed9f9b4..28b51286c7 100644
--- a/usr/src/boot/sys/boot/i386/loader/Makefile
+++ b/usr/src/boot/sys/boot/i386/loader/Makefile
@@ -42,7 +42,7 @@ ROOTBOOTFORTH=$(FORTH:%=$(ROOT_BOOT_FORTH)/%)
 ROOTBOOTDEFAULTS=$(DEFFILES:%=$(ROOT_BOOT_DEFAULTS)/%)
 FILEMODE=0444
 
-all: machine x86 ${LOADER} loader.help
+all: machine x86 .WAIT ${LOADER} loader.help
 
 install: all $(ROOTBOOTLOADER)
 
diff --git a/usr/src/boot/sys/boot/zfs/Makefile.com b/usr/src/boot/sys/boot/zfs/Makefile.com
index bb11ab91d6..2523c4791d 100644
--- a/usr/src/boot/sys/boot/zfs/Makefile.com
+++ b/usr/src/boot/sys/boot/zfs/Makefile.com
@@ -17,7 +17,7 @@ include $(SRC)/Makefile.master
 
 LIB=		zfsboot
 
-all: machine x86 libzfsboot.a
+all: machine x86 .WAIT libzfsboot.a
 clean: clobber
 
 clobber:
-- 
2.21.0

