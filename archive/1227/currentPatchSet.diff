From 0740d10431a769451e3544f71408bd691febe961 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 9 Jan 2017 12:41:58 -0800
Subject: [PATCH] IMGAPI-610 Ignore docker migration on images that don't use a
 64-char id

---
 .../migration-012-update-docker-image-uuids.js    | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/lib/migrations/migration-012-update-docker-image-uuids.js b/lib/migrations/migration-012-update-docker-image-uuids.js
index 327e914..d013e21 100644
--- a/lib/migrations/migration-012-update-docker-image-uuids.js
+++ b/lib/migrations/migration-012-update-docker-image-uuids.js
@@ -344,7 +344,18 @@ function migrateImage(uuid, callback) {
                 uuid);
             callback();
             return;
-        } else if (!image.tagsObj['docker:repo']) {
+        }
+
+        var dockerId = image.tagsObj['docker:id'];
+        if (dockerId.length !== 64) {
+            // It's a different docker id to what we are expecting - skip it, as
+            // it's likely a newer (v2.2) docker id of the form 'sha256:123...'.
+            info('Skipped dockerId where length != 64: %s', dockerId);
+            callback();
+            return;
+        }
+
+        if (!image.tagsObj['docker:repo']) {
             // Cheat. We know before this migration (which was part of
             // private registry support) that the only index/registry from
             // which pulls were supported was 'docker.io'.
@@ -355,7 +366,7 @@ function migrateImage(uuid, callback) {
         }
 
         newUuid = imgmanifest.imgUuidFromDockerInfo({
-            id: image.tagsObj['docker:id'],
+            id: dockerId,
             indexName: indexName
         });
 
-- 
2.21.0

