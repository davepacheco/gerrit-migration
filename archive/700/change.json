{"project":"joyent/sdcadm","branch":"master","id":"Ie9627c404ec2a3941e246cb7729f0694601fb18a","number":"700","subject":"TOOLS-1574 sdcadm experimental avail crashes due to missing agent image uuids Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/700","commitMessage":"TOOLS-1574 sdcadm experimental avail crashes due to missing agent image uuids\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1476704432,"lastUpdated":1484931334,"open":false,"status":"MERGED","comments":[{"timestamp":1476704432,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1476704504,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476876037,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1476876069,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1478511510,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1478511545,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1480031128,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)\n\nSee comment on ticket as well. Let\u0027s discuss that then I can come back and complete review here."},{"timestamp":1480088252,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1480088288,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1480088360,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1480112628,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1481848742,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nThis is going to break on dockerlogger I think:\n\n[root@headnode (coal) ~]# sdc-sapi /services?type\u003dagent | json -Ha name | while read name; do cat /opt/smartdc/agents/lib/node_modules/$name/image_uuid; done\n59e26de7-61d3-476f-834c-012b0bbc9b07\ne5e78c98-f2c6-4fb6-9b7b-eba9013a942b\n217199cf-2f34-4697-988a-4bc8514dbc44\n7e89ae4a-b534-42ac-97c0-e992162a691c\n2209fecd-3a8c-45f0-9dee-d8ed4fd7b90b\n948b1d89-88f7-41b8-8ad9-c3744bf43f6f\nd9887833-ce8f-466f-92bd-5c54e24987ad\nfec5c84e-3b0c-4270-8442-a3fd9af7e1f8\n4bc8b371-7daa-4319-b8c3-b162f0603e4f\n0473c054-8d62-45ff-a7ad-798a17a0cd14\nbac59322-fd11-4dcc-87de-6fd6bcd52f0e\ncfbde081-1d9e-40cb-aebe-800c197d0c50\n1592b9a5-9308-4a15-8325-156ff00586b2\ncat: cannot open /opt/smartdc/agents/lib/node_modules/dockerlogger/image_uuid: No such file or directory"},{"timestamp":1483551476,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1483551510,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1483552224,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1483552260,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1483552339,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nNote we\u0027re not saving image uuid with dockerlogger setups. It shouldn\u0027t be a problem for this concrete issue, though, since we always installed docker logger with image uuid in SAPI"},{"timestamp":1484345849,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\nFWIW, I found that after applying the patch for https://cr.joyent.us/#/c/1246/ that we don\u0027t get the \"sdcadm ex avail\" crash anymore."},{"timestamp":1484587537,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nI\u0027m not sure we should abandon this change due to TOOLS-1631. My take would be that if we want some coherence for every SAPI service/instance, we should add params.image_uuid everywhere in SAPI"},{"timestamp":1484697603,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(2 comments)\n\nOtherwise, LGTM."},{"timestamp":1484843932,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 7."},{"timestamp":1484843978,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\n(2 comments)\n\nTrent, done with the suggested changes"},{"timestamp":1484843978,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1484872257,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1484931297,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1484931300,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"},{"timestamp":1484931334,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"8","revision":"4e2251ed1ed0b917f3b2dfde0a9d35cc8d153cd9","parents":["4652d5c797853c3028f8531bb057c1e460cb112a"],"ref":"refs/changes/00/700/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1484931297,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484843978,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484872257,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484872257,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1484931300,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":51,"deletions":-1}],"sizeInsertions":124,"sizeDeletions":-20},"patchSets":[{"number":"1","revision":"74b875836b8ce8a4c699a07e0d7211119aa6b92b","parents":["aa0ea58066f8489e99c0f32ce5789f6ca3f95916"],"ref":"refs/changes/00/700/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1476704432,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476704504,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-19},{"number":"2","revision":"dd05ebd7696f937ca8e08025c0b51a9fede68e7b","parents":["27385a38a4578ad0b0247a76fc72a075c86b88cb"],"ref":"refs/changes/00/700/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1476876037,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476704504,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-19},{"number":"3","revision":"42038a7ffd1fa9d67b4b6c41a33008d92be476cf","parents":["5d14e20e4538153be5c88e83cea7b94e61e0e34d"],"ref":"refs/changes/00/700/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478511510,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476704504,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli/do_add_new_agent_svcs.js","line":212,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Avoid a var and a function with the same name, please."},{"file":"lib/cli/do_add_new_agent_svcs.js","line":212,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Hrrrm one is updateAgentsServices and the other updateAgentServices, note the extra \"s\" before Services on the first one. Could anyway change to some other name, but definitely not the same."},{"file":"lib/cli/do_add_new_agent_svcs.js","line":212,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"oh, sorry, my mistake"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-19},{"number":"4","revision":"aae5e1e29018377fdb9e0261f2d6163ea16d15eb","parents":["80d13804d754f9ab9ab0f4bbcfd007fe383c3c05"],"ref":"refs/changes/00/700/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1480088252,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476704504,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-19},{"number":"5","revision":"c30af35b99a175fefda4a1b5f4ef75eeaa86e858","parents":["5334e7bc0b626cbbbd155e559d931cd6b2e49630"],"ref":"refs/changes/00/700/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1483551476,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476704504,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":122,"sizeDeletions":-19},{"number":"6","revision":"d6ccf1f3ed99ed7b9a23c6c05f4e33d1d14a0aed","parents":["5334e7bc0b626cbbbd155e559d931cd6b2e49630"],"ref":"refs/changes/00/700/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1483552224,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1483552260,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli/do_add_new_agent_svcs.js","line":13,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: a single block for these imports, and in alpha order"},{"file":"lib/cli/do_add_new_agent_svcs.js","line":13,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/cli/do_add_new_agent_svcs.js","line":76,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Actually sorry about the dockerlogger comment before. We probably don\u0027t need this, because dockerlogger isn\u0027t on the \u0027agentNames\u0027 array above, right?"},{"file":"lib/cli/do_add_new_agent_svcs.js","line":76,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Correct, removing it"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":77,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":51,"deletions":-1}],"sizeInsertions":128,"sizeDeletions":-20},{"number":"7","revision":"e9627c404ec2a3941e246cb7729f0694601fb18a","parents":["5334e7bc0b626cbbbd155e559d931cd6b2e49630"],"ref":"refs/changes/00/700/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1484843932,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484843978,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484872257,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484872257,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":51,"deletions":-1}],"sizeInsertions":124,"sizeDeletions":-20},{"number":"8","revision":"4e2251ed1ed0b917f3b2dfde0a9d35cc8d153cd9","parents":["4652d5c797853c3028f8531bb057c1e460cb112a"],"ref":"refs/changes/00/700/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1484931297,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1484843978,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1484872257,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484872257,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1484931300,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_add_new_agent_svcs.js","type":"MODIFIED","insertions":73,"deletions":-19},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":51,"deletions":-1}],"sizeInsertions":124,"sizeDeletions":-20}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}