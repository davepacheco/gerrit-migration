{"project":"joyent/illumos-joyent","branch":"master","topic":"gm","id":"Ib9d7466cea7e2032246dd955df4300af408f0710","number":"97","subject":"OS-5448 clear() on llquantize aggregation causes dtrace to exit OS-5501 printa() of multiple aggregations can fail for llquantize() Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"url":"https://cr.joyent.us/97","commitMessage":"OS-5448 clear() on llquantize aggregation causes dtrace to exit\nOS-5501 printa() of multiple aggregations can fail for llquantize()\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1468885388,"lastUpdated":1468961571,"open":false,"status":"MERGED","comments":[{"timestamp":1468885388,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Uploaded patch set 1."},{"timestamp":1468888960,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review+1\n\n(3 comments)"},{"timestamp":1468890936,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1468891529,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Uploaded patch set 2."},{"timestamp":1468891789,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1468892455,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\nIn general, this looks good. A few notes:\n\n1) It\u0027d be good to have an analysis in OS-5448.\n2) In the spirit of OS-5501, I noticed the following additional places where we seem to special case a subset of the aggregations:\n\ndt_aggregate_minmaxbin()\ndt_print_quanthdr_packed()\ndt_print_datum()\n\nOne thing that led me to notice was that aggpack didn\u0027t work with llquantize. I\u0027m not sure of all the implications of some of the others. I\u0027d be happy with these being addressed as follow ups.\n\nThe following is an example of the aggpack failure I saw:\n\n[rm@122fff4d-b9d7-cd35-b1f9-f9e6eca3362a ~]$ pfexec dtrace -x aggpack -n \u0027BEGIN{ @ \u003d llquantize(10000, 10, 0, 6, 20); printa(@); }\u0027\ndtrace: description \u0027BEGIN\u0027 matched 1 probe\nCPU     ID                    FUNCTION:NAME\n  0      1                           :BEGIN \n\n           value  ------------- Distribution ------------- count    \n            9500 |                                         0        \n           10000 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 1        \n           15000 |                                         0"},{"timestamp":1468904837,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 2:\n\nThere isn\u0027t much analysis to be had for OS-5448, but I added it such as it is.\n\nAs for the aggpack comment: As I replied in my feedback to Patrick\u0027s earlier comment, it is by design that llquantize() doesn\u0027t work with aggpack, as the former is really for non-interactive use, while the latter is purely for interactive use.  So this isn\u0027t so much a bug as a request for enhancement -- one of dubious value and certainly low priority, and should be treated as a separate issue regardless."},{"timestamp":1468904860,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1468904999,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Topic set to gm"},{"timestamp":1468948480,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+2\n\nGiven the new tests and the (presumed) running of dtest with them, I\u0027m happy to be the approver on this."},{"timestamp":1468961264,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1468961277,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1468961433,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1468961478,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Approval+1"},{"timestamp":1468961571,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Bryan Cantrill"}],"currentPatchSet":{"number":"6","revision":"05eb12488a7b3639d543f6458140ecaef9147737","parents":["5b906d728d7999b28ec95f09b8e95dd56216a546"],"ref":"refs/changes/97/97/6","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468961433,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468891789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468948480,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Approval","value":"1","grantedOn":1468961478,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1468961570,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":15,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":85,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"11ec0f9ecb75b18665bb1e332ceb2eeb33c63716","parents":["dda35189e97fb97cbc0cdf00dbd4b1dda1d2b840"],"ref":"refs/changes/97/97/1","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468885388,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468888960,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","line":21,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"shots fired"},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","line":1148,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"A comment about why these changes are applied to the size/offset would be nice."},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","line":1148,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Will do."},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","line":1448,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps out of scope, but since I went looking for other spots which may have been missed when llquantize was added...: Does there need to be a similar adjustment to the start here, as done at L1148?"},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","line":1448,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"aggpack just doesn\u0027t work with llquantize() -- see L1854 of dt_consume.c.  So no similar adjustment is required here, though one would be required if aggpack were to be extended to work on llquantize()\u0027d aggregations (which is itself a somewhat strange enhancement)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":10,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":80,"sizeDeletions":-8},{"number":"2","revision":"b9d7466cea7e2032246dd955df4300af408f0710","parents":["dda35189e97fb97cbc0cdf00dbd4b1dda1d2b840"],"ref":"refs/changes/97/97/2","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468891529,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468892455,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468891789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":15,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":85,"sizeDeletions":-8},{"number":"3","revision":"a54cdc7bc950ee4068a1fdb95d75389b0724fa84","parents":["1436d54580f1c4a257c82c438ba282a9a149b732"],"ref":"refs/changes/97/97/3","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468904860,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468948480,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468891789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":15,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":85,"sizeDeletions":-8},{"number":"4","revision":"4650b9717debe41b2114e8923053f7ccb5862d96","parents":["1436d54580f1c4a257c82c438ba282a9a149b732"],"ref":"refs/changes/97/97/4","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468961264,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468948480,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468891789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":15,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":85,"sizeDeletions":-8},{"number":"5","revision":"b327db011bf39be736e7b69295b68b291c7d62d0","parents":["5b906d728d7999b28ec95f09b8e95dd56216a546"],"ref":"refs/changes/97/97/5","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468961277,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468948480,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468891789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":15,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":85,"sizeDeletions":-8},{"number":"6","revision":"05eb12488a7b3639d543f6458140ecaef9147737","parents":["5b906d728d7999b28ec95f09b8e95dd56216a546"],"ref":"refs/changes/97/97/6","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1468961433,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Approval","value":"1","grantedOn":1468961478,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468948480,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1468961570,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468891789,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d","type":"ADDED","insertions":23,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.clear.d.out","type":"ADDED","insertions":6,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d","type":"ADDED","insertions":24,"deletions":0},{"file":"usr/src/cmd/dtrace/test/tst/common/llquantize/tst.multiaggs.d.out","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/libdtrace/common/dt_aggregate.c","type":"MODIFIED","insertions":15,"deletions":-8},{"file":"usr/src/pkg/manifests/system-dtrace-tests.mf","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":85,"sizeDeletions":-8}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}]}