From bb67e496915688ce371a6e3a1caab6bf6d3d455a Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 13 Mar 2017 17:23:52 +0000
Subject: [PATCH] OS-6008 autofs direct mounts not working

---
 usr/src/uts/common/brand/lx/autofs/lx_autofs.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/autofs/lx_autofs.c b/usr/src/uts/common/brand/lx/autofs/lx_autofs.c
index c55fc6d95f..0a1479f05d 100644
--- a/usr/src/uts/common/brand/lx/autofs/lx_autofs.c
+++ b/usr/src/uts/common/brand/lx/autofs/lx_autofs.c
@@ -2065,6 +2065,14 @@ lx_autofs_open(vnode_t **vpp, int flag, cred_t *cr, caller_context_t *ctp)
 	return (0);
 }
 
+/*
+ * Internally we have already converted our autofs vfs device number into a
+ * Linux-format device during lx_autofs_mount and stored that device number
+ * in data->lav_dev. However, our lx emulation for the various stat() syscalls
+ * also wants to convert the fsid the same way. That obviously will be
+ * incorrect if we pass along an fsid that is already converted, so we always
+ * pass along the original vfs fsid here.
+ */
 static int
 lx_autofs_getattr(vnode_t *vp, vattr_t *vap, int flags, cred_t *cr,
     caller_context_t *ctp)
@@ -2073,6 +2081,7 @@ lx_autofs_getattr(vnode_t *vp, vattr_t *vap, int flags, cred_t *cr,
 	vnode_t		*dvp;
 	int		error;
 	lx_autofs_vfs_t *data = (lx_autofs_vfs_t *)vp->v_vfsp->vfs_data;
+	dev_t		autofs_fsid = vp->v_vfsp->vfs_dev;
 
 	if ((dvp = lx_autofs_do_direct(vp)) != NULL) {
 		uvp = dvp;
@@ -2091,12 +2100,12 @@ lx_autofs_getattr(vnode_t *vp, vattr_t *vap, int flags, cred_t *cr,
 			 * autofs fifo requests to the correct entry. Thus, we
 			 * have to update the attributes with our own id's.
 			 */
-			vap->va_fsid = data->lav_dev;
+			vap->va_fsid = autofs_fsid;
 			vap->va_nodeid = data->lav_ino;
 		}
 	} else if (error == 0) {
 		/* Update the attributes with our filesystem id. */
-		vap->va_fsid = data->lav_dev;
+		vap->va_fsid = autofs_fsid;
 	}
 
 	return (error);
-- 
2.21.0

