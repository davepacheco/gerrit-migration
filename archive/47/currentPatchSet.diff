From 3f90d046b790f03236628e02ae02b6111bc0f0eb Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Fri, 8 Jul 2016 16:26:51 -0700
Subject: [PATCH] ZAPI-742: Upgrade restify to latest 4.x version

Reviewed by: Trent Mick <trentm@gmail.com>
---
 lib/vmapi.js | 10 +++++++---
 package.json |  2 +-
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/lib/vmapi.js b/lib/vmapi.js
index e3da883..d6ab3e3 100644
--- a/lib/vmapi.js
+++ b/lib/vmapi.js
@@ -413,7 +413,9 @@ VMAPI.prototype.listen = function (callback) {
 /*
  * Force JSON for all accept headers
  */
-function formatJSON(req, res, body) {
+function formatJSON(req, res, body, callback) {
+    var formattedJson;
+
     if (body instanceof Error) {
         // snoop for RestError or HttpError, but don't rely on
         // instanceof
@@ -440,10 +442,12 @@ function formatJSON(req, res, body) {
         // used to properly set the Content-Length and Content-MD5 headers, but
         // no data should actually be sent as part of the response's body. This
         // is all according to RFC 2616.
-        return ('');
+        formattedJson = '';
     } else {
-        return (data);
+        formattedJson = data;
     }
+
+    callback(null, formattedJson);
 }
 
 
diff --git a/package.json b/package.json
index df1b8e3..4f4e8ae 100644
--- a/package.json
+++ b/package.json
@@ -18,7 +18,7 @@
     "moray": "git+ssh://git@github.com:joyent/node-moray.git#b84ef0e",
     "nodeunit": "0.9.1",
     "once": "^1.3.3",
-    "restify": "2.7.0",
+    "restify": "4.1.1",
     "sdc-clients": "git+ssh://git@github.com:joyent/node-sdc-clients.git#c962959",
     "sigyan": "0.2.0",
     "sprintf": "0.1.1",
-- 
2.21.0

