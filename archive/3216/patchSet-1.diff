From 3bf45c97c69119ada8ce93df8336f0ea31ffc578 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 15 Jan 2018 17:43:21 +0100
Subject: [PATCH] TOOLS-1974 sdc-scripts update sdc_common_setup to allow
 creation of additional sapi instances

---
 lib/util.sh | 16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/lib/util.sh b/lib/util.sh
index 8e07285..0150439 100644
--- a/lib/util.sh
+++ b/lib/util.sh
@@ -696,10 +696,20 @@ function sdc_common_setup
 
     if [[ ! -f /var/svc/setup_complete ]]; then
         if [[ ${ZONE_ROLE} != "assets" ]]; then
-            if [[ ${ZONE_ROLE} == "sapi" && "${SAPI_PROTO_MODE}" == \
-              "true" ]]; then
-                echo "Skipping config-agent/SAPI instance setup: 'sapi' " \
+            if [[ ${ZONE_ROLE} == "sapi" ]]; then
+                if [[ "${SAPI_PROTO_MODE}" == "true" ]]; then
+                    echo "Skipping config-agent/SAPI instance setup: 'sapi' " \
                   "zone in proto mode" >&2
+                else
+                    config_agent_state=$(/usr/bin/svcs -H -o state config-agent)
+                    if [[ $? != 0 ]]; then
+                        echo "Setup config-agent and registrar services" >&2
+                        setup_config_agent
+                        download_metadata
+                        write_initial_config
+                        registrar_setup
+                    fi
+                fi
             else
                 setup_config_agent
                 download_metadata
-- 
2.21.0

