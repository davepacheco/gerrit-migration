{"project":"joyent/sdc-designation","branch":"master","id":"I0ca6a4c26dbe4151f14521a3b66e306cf7e067c0","number":"3724","subject":"TRITON-273 Triton should refuse to provision a bhyve VM with more vcpus than bhyve supports or than the CN has","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/3724","commitMessage":"TRITON-273 Triton should refuse to provision a bhyve VM with more vcpus than bhyve supports or than the CN has\n","createdOn":1522022124,"lastUpdated":1522284677,"open":false,"status":"MERGED","comments":[{"timestamp":1522022124,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1522022125,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit a3f460b8ceb7b66a2ce0f86a18574a173ed5922a\n    \n    should refuse to provision bhyve vm with too many vcpus for CN"},{"timestamp":1522022151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522037086,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(6 comments)\n\nOverall LGTM. The main thing I\u0027d like added are some additional checks of boundary conditions in hard-filter-hvm.test.js"},{"timestamp":1522125377,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1522125379,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 850624a1f7af8dafa3a338ee4aff604100d182cb\n    \n    updates based on CR feedback"},{"timestamp":1522125379,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1522125405,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522147730,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nThe main thing I\u0027d like added are some additional checks of boundary conditions in hard-filter-hvm.test.js"},{"timestamp":1522279301,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1522279303,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit b5fa4e48871330c22a468c5f06867a6451bf8416\n    \n    add more tests"},{"timestamp":1522279328,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522279792,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1522279793,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit f65551128f4c5664835e286bbc6736b0d51a4184\n    \n    update for joyent-schemas change adding new keys."},{"timestamp":1522279819,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522280730,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1522284677,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"4","revision":"0ca6a4c26dbe4151f14521a3b66e306cf7e067c0","parents":["af2b13ddc5dbe10a4511936ea46e6655bf6d4aab"],"ref":"refs/changes/24/3724/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522279792,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522279819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522280730,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522280730,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"SUBM","value":"1","grantedOn":1522284677,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/algorithms/hard-filter-hvm.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/algorithms/hard-filter-hvm.test.js","type":"MODIFIED","insertions":108,"deletions":-2},{"file":"test/validations.test.js","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":175,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"b9e870ff55dbaa697c4769d7590fcb7f8bb955b3","parents":["af2b13ddc5dbe10a4511936ea46e6655bf6d4aab"],"ref":"refs/changes/24/3724/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522022124,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522022151,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/algorithms/hard-filter-hvm.js","line":52,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Shouldn\u0027t the optionalNumber() above prevent that?"},{"file":"lib/algorithms/hard-filter-hvm.js","line":52,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"optionalNumber doesn\u0027t prevent null or undefined, no.\n\n    \u003e var assert \u003drequire(\u0027assert-plus\u0027)\n    undefined\n    \u003e assert.optionalNumber(null)\n    undefined\n    \u003e assert.optionalNumber(undefined)\n    undefined\n    \u003e assert.optionalNumber(\u0027bacon\u0027)\n    AssertionError: undefined (number) is required\n        at repl:1:8\n        at REPLServer.defaultEval (repl.js:272:27)\n        at bound (domain.js:287:14)\n        at REPLServer.runBound [as eval] (domain.js:300:12)\n        at REPLServer.\u003canonymous\u003e (repl.js:441:12)\n        at emitOne (events.js:82:20)\n        at REPLServer.emit (events.js:169:7)\n        at REPLServer.Interface._onLine (readline.js:203:10)\n        at REPLServer.Interface._line (readline.js:542:8)\n        at REPLServer.Interface._ttyWrite (readline.js:819:14)\n    \u003e"},{"file":"lib/algorithms/hard-filter-hvm.js","line":52,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I\u0027m wondering what I was thinking when I asked that question. -.-\n\nObviously I wasn\u0027t."},{"file":"lib/algorithms/hard-filter-hvm.js","line":59,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Considering that server.sysinfo is used several times in this scope, I think you should do a \"var sysinfo \u003d server.sysinfo\" and make use of that."},{"file":"lib/algorithms/hard-filter-hvm.js","line":59,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok"},{"file":"lib/algorithms/hard-filter-hvm.js","line":70,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This could be replaced with:\n\nbhyveMaxVcpus \u003d bhyveMaxVcpus || 16"},{"file":"lib/algorithms/hard-filter-hvm.js","line":70,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"it could, except that would imo be less obvious what was happening."},{"file":"lib/algorithms/hard-filter-hvm.js","line":73,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Unrelated to this CR, just out of curiosity: how does this state of affairs even come about? Does bhyve have a tuneable that can be out of sync with the actual hardware?"},{"file":"lib/algorithms/hard-filter-hvm.js","line":73,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yes. The bhyve binary is built with a hardcoded maximum number of vcpus. Even in COAL with 2 CPUs the bhyve tool itself supports 32 vcpus."},{"file":"lib/algorithms/hard-filter-hvm.js","line":74,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Are servers sometimes missing this?"},{"file":"lib/algorithms/hard-filter-hvm.js","line":74,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This is required in the server schema for dapi, so I guess I\u0027ll remove the check."},{"file":"lib/algorithms/hard-filter-hvm.js","line":113,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Personally, I think this conditional would be better above the for() loop. It\u0027s not important though."},{"file":"lib/algorithms/hard-filter-hvm.js","line":113,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/algorithms/hard-filter-hvm.js","type":"MODIFIED","insertions":40,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-hvm.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/validations.test.js","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-4},{"number":"2","revision":"252804c58422c0ea87c96aa4f746e1bc82c078e7","parents":["af2b13ddc5dbe10a4511936ea46e6655bf6d4aab"],"ref":"refs/changes/24/3724/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522125377,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522125405,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522147730,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/algorithms/hard-filter-hvm.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-hvm.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/validations.test.js","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":68,"sizeDeletions":-5},{"number":"3","revision":"f9a0ef9df77455aaffbc985284aa5578dc355b26","parents":["af2b13ddc5dbe10a4511936ea46e6655bf6d4aab"],"ref":"refs/changes/24/3724/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522279301,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522279328,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/algorithms/hard-filter-hvm.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/algorithms/hard-filter-hvm.test.js","type":"MODIFIED","insertions":108,"deletions":-2},{"file":"test/validations.test.js","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":174,"sizeDeletions":-5},{"number":"4","revision":"0ca6a4c26dbe4151f14521a3b66e306cf7e067c0","parents":["af2b13ddc5dbe10a4511936ea46e6655bf6d4aab"],"ref":"refs/changes/24/3724/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522279792,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522279819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1522284677,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522280730,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522280730,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/algorithms/hard-filter-hvm.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/algorithms/hard-filter-hvm.test.js","type":"MODIFIED","insertions":108,"deletions":-2},{"file":"test/validations.test.js","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":175,"sizeDeletions":-6}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}