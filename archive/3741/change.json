{"project":"joyent/illumos-joyent","branch":"master","id":"If1cf07346708b8d828747333b8f5ea6dd4f612cd","number":"3741","subject":"OS-6831 bhyve brand should use zfd for zhyve logging Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3741","commitMessage":"OS-6831 bhyve brand should use zfd for zhyve logging\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1522414971,"lastUpdated":1522674834,"open":false,"status":"MERGED","comments":[{"timestamp":1522414971,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1522417572,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)\n\nThis looks good, I just had a couple of questions/comments."},{"timestamp":1522419319,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1522419791,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\nOK, thanks for the clarification."},{"timestamp":1522446386,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nUpdated OS-6831 with test results"},{"timestamp":1522448308,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI saw the testing notes. Is there another ticket that OS-6831 should be dependent upon for the vmadm changes? Without those, it looks like the zoneadmd thread won\u0027t consume anything out of the pipe and eventually the zfd pipe will fill and the console will hang. Do you want to test a zone without the zlog-mode attr on it?"},{"timestamp":1522448707,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nThe statechange change will update the zone configuration to contain the necessary information for logging.  While we may want changes to vmadm to customize logging (maybe the the log file size), it\u0027s not essential to proper operation.\n\nAs I was reading zfd code, I came to understand that if no one is listening on the other end, the bits just fall into the bitbucket.  An experiment with lx seems to verify that:\n\n[root@buglets ~]# pgrep zoneadmd\n[root@buglets ~]# zlogin $(vm lxtest)\n[Connected to zone \u00279dcfbb29-4127-ec1c-a7b1-ab2e4c274a2a\u0027 pts/3]\nLast login: Fri Mar 30 21:23:43 UTC 2018 from zone:global on pts/2\nWelcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.3.0 x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n   __        .                   .\n _|  |_      | .-. .  . .-. :--. |-\n|_    _|     ;|   ||  |(.-\u0027 |  | |\n  |__|   `--\u0027  `-\u0027 `;-| `-\u0027 \u0027  \u0027 `-\u0027\n                   /  ;  Instance (Ubuntu 16.04 20170403)\n                   `-\u0027   https://docs.joyent.com/images/container-native-linux\n\nroot@9dcfbb29-4127-ec1c-a7b1-ab2e4c274a2a:~# dd if\u003d/dev/zero of\u003d/dev/zfd/1 bs\u003d1024k count\u003d5\n5+0 records in\n5+0 records out\n5242880 bytes (5.2 MB, 5.0 MiB) copied, 0.0018493 s, 2.8 GB/s\nroot@9dcfbb29-4127-ec1c-a7b1-ab2e4c274a2a:~# exit\nlogout\n\n[Connection to zone \u00279dcfbb29-4127-ec1c-a7b1-ab2e4c274a2a\u0027 pts/3 closed]\n[root@buglets ~]# pgrep zoneadmd\n[root@buglets ~]#"},{"timestamp":1522449586,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: -Code-Review\n\nSorry, I forgot about the script change handling that. Maybe run that as its own test case and then I\u0027ll IA.\n\nI\u0027m a little confused about your other note since every running zone should have a corresponding zoneadmd. I\u0027m not sure if you\u0027re implying that zoneadmd is not running for your zone?"},{"timestamp":1522508682,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nThe statechange test is already noted: \"Started a bhyve zone. Verified that attr name\u003dzlog-mode value\u003dg-- and attr name\u003dzlog-name value\u003dplatform.log were set\"\n\nThe example in my previous note shows\n1. zoneadmd is not running (because I did `pkill -9 zoneadmd` in step 0.\n2. I zlogin into an lx zone\n3. I write 5 MB to /dev/zfd/1.  It completes without delay.\n4. I log out of the lx zone\n5. I show that zoneadmd is still not running in the global zone\n\nIf zoneadmd is not running, there is nothing reading from the global side of the zfd devices.  This shows that if logging is not configured or zoneadmd dies that the operation of programs in the zone (dd, zhyve) that write to zfd devices are not blocked."},{"timestamp":1522598667,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1\n\nSorry on the mixup with the testing notes. It wasn\u0027t obvious to me that the 2nd bullet was a separate test that you ran without the zlog-mode being set. Thanks for the clarification."},{"timestamp":1522674801,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2: Commit message was updated."},{"timestamp":1522674811,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1522674834,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"3","revision":"33bcab42a282d0baf14fdb9b4b8b084a8f56bd55","parents":["9e9f2b7fabfab0fc4e259b2bf8a562c669a9d8ba"],"ref":"refs/changes/41/3741/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522674811,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1522674834,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/zhyve.c","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"usr/src/lib/brand/bhyve/zone/platform.xml","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/statechange","type":"MODIFIED","insertions":43,"deletions":0}],"sizeInsertions":82,"sizeDeletions":-18},"patchSets":[{"number":"1","revision":"f1cf07346708b8d828747333b8f5ea6dd4f612cd","parents":["b409c9a314a881a4aa643e85cd5494af77fa4488"],"ref":"refs/changes/41/3741/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522414971,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/cmd/bhyve/zhyve.c","line":162,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I don\u0027t think any of the zfd work is upstream. Would it be better to abandon the logging here if the open fails? We at least need to remember that upstreaming the brand now first depends on upstreaming the zoneadmd zfd changes."},{"file":"usr/src/cmd/bhyve/zhyve.c","line":162,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Let\u0027s sort that out when it comes time to upstream this.  There are currently other zoneadmd divergences (e.g. _ZONECFG_* env variables), lots of work is needed in zonecfg, and other things like sdev plugins need to be upstreamed."},{"file":"usr/src/lib/brand/bhyve/zone/statechange","line":50,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Would it make sense to move this old log out to the new log location in the zone\u0027s root?"},{"file":"usr/src/lib/brand/bhyve/zone/statechange","line":50,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"It\u0027s a turd no matter where it lands.  All of the other log files in $zonepath/logs are json, and this isn\u0027t.  Since any existing zhyve.log will be from a boot on an earlier PI, the debate in my mind was whether it should be renamed or deleted."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/zhyve.c","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"usr/src/lib/brand/bhyve/zone/platform.xml","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/statechange","type":"MODIFIED","insertions":43,"deletions":0}],"sizeInsertions":82,"sizeDeletions":-18},{"number":"2","revision":"347fca5ee402fe87f6a6e5d6cc40af2ff4bbe4b8","parents":["b409c9a314a881a4aa643e85cd5494af77fa4488"],"ref":"refs/changes/41/3741/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522674801,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/zhyve.c","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"usr/src/lib/brand/bhyve/zone/platform.xml","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/statechange","type":"MODIFIED","insertions":43,"deletions":0}],"sizeInsertions":82,"sizeDeletions":-18},{"number":"3","revision":"33bcab42a282d0baf14fdb9b4b8b084a8f56bd55","parents":["9e9f2b7fabfab0fc4e259b2bf8a562c669a9d8ba"],"ref":"refs/changes/41/3741/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522674811,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522598667,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1522674834,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/bhyve/zhyve.c","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zfd.c","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"usr/src/lib/brand/bhyve/zone/platform.xml","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/statechange","type":"MODIFIED","insertions":43,"deletions":0}],"sizeInsertions":82,"sizeDeletions":-18}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}