From 7ccb1c0754e739ff0a1d7100cf47ddab1ede92df Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Wed, 28 Feb 2018 15:34:45 -0800
Subject: [PATCH] TRITON-197 TRITON-182 broke platform builds

---
 configure           |  4 ++--
 tools/jenkins-build | 11 +++++++----
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/configure b/configure
index c1d34a8..4706422 100755
--- a/configure
+++ b/configure
@@ -301,11 +301,11 @@ function preload_bits_from_manta() {
         dirnames[${#dirnames[@]}]="${branch}-latest"
     fi
 
-    consider_prev_releases=$(echo ",${CONSIDER_PREV_RELEASES_FOR}," | \
+    consider_prev_releases=$(echo ,"${CONSIDER_PREV_RELEASES_FOR}", | \
         grep ",$target_base,") || true
     if [[ "$consider_prev_releases" != "" ]]; then
         dirnames[${#dirnames[@]}]=$(mls /Joyent_Dev/${builds_subdir}/builds/${target_base} | \
-            grep -E 'release-\d{8}-latest' | sort | tail -1)
+            grep -E 'release-[[:digit:]]{8}-latest' | sort | tail -1)
     fi;
 
     set +o errexit  # want to do our own error-handling here
diff --git a/tools/jenkins-build b/tools/jenkins-build
index 87da878..b4936c8 100755
--- a/tools/jenkins-build
+++ b/tools/jenkins-build
@@ -156,17 +156,20 @@ else
     JENKINS_OUTPUT_BASE="/stor/${MG_JENKINS_BUILDS_DIR}"
 fi
 
-if [[ -z ${USE_PREV_RELEASES_FOR} ]]; then
-    USE_PREV_RELEASES_FOR=""
+EXTRA_ARGS=""
+
+if [[ ! -z ${USE_PREV_RELEASES_FOR} ]]; then
+    EXTRA_ARGS="${EXTRA_ARGS}-R ${USE_PREV_RELEASES_FOR}"
 fi
 
 if [[ -z ${JOYENT_BUILD} || ${JOYENT_BUILD} == "true" ]]; then
     TRACE=1 ./configure -j -t $JOB_NAME -c "$CACHE_DIR" -b "$BRANCH" \
         -J /stor/builds -D /public/builds -O ${JENKINS_OUTPUT_BASE} \
-        -B "$TRY_BRANCH" -R ${USE_PREV_RELEASES_FOR}
+        -B "$TRY_BRANCH" ${EXTRA_ARGS}
 else
     TRACE=1 ./configure -t $JOB_NAME -c "$CACHE_DIR" -b "$BRANCH" \
-        -D /public/builds -O ${JENKINS_OUTPUT_BASE} -B "$TRY_BRANCH"
+        -D /public/builds -O ${JENKINS_OUTPUT_BASE} -B "$TRY_BRANCH" \
+        ${EXTRA_ARGS}
 fi
 
 now_time=$(date +%s)
-- 
2.21.0

