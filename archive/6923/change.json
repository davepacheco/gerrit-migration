{"project":"joyent/manta-remora","branch":"master","id":"I1ae82a813231bb8d415f3d3f18af9bc20c99ca53","number":"6923","subject":"MANTA-4561 Rebalancer agent should protect against receiving duplicate assignment ids Reviewed by: Rui Loura \u003crui.loura@joyent.com\u003e Approved by: Rui Loura \u003crui.loura@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/6923","commitMessage":"MANTA-4561 Rebalancer agent should protect against receiving duplicate assignment ids\nReviewed by: Rui Loura \u003crui.loura@joyent.com\u003e\nApproved by: Rui Loura \u003crui.loura@joyent.com\u003e\n","createdOn":1568915255,"lastUpdated":1568923559,"open":false,"status":"MERGED","comments":[{"timestamp":1568915255,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1568915357,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n     Checking futures-cpupool v0.1.8\n     Checking threadpool v1.7.1\n error: aborting due to previous error\n \n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1568915891,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n(4 comments)\n\nHotspots:\n* The proposed fix is on agent.rs: 394-404.\n* One change in there to clean up an agent-related clippy message (773).\n* Everything else is test code to cover the situation that this fix relieves."},{"timestamp":1568919444,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1568922456,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1568922470,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1568922580,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n \n     Checking num-complex v0.2.3\n error: aborting due to previous error\n \n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1568922889,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1568923232,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1568923336,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n\"make check\" exited with status 2\n\n \n     Checking num-traits v0.1.43\n     Checking num-complex v0.2.3\n     Checking regex v1.3.1\n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1568923419,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1568923420,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1568923518,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1568923559,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"4","revision":"1ae82a813231bb8d415f3d3f18af9bc20c99ca53","parents":["c28f3299cf5aa02706480d502e64f64566366c91"],"ref":"refs/changes/23/6923/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1568923518,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1568923336,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568923419,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568923419,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1568923559,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":99,"deletions":-19}],"sizeInsertions":99,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"6572884c57ef8db05e2f42710399aff3fcde3b4a","parents":["c28f3299cf5aa02706480d502e64f64566366c91"],"ref":"refs/changes/23/6923/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1568915255,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1568915357,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/agent.rs","line":367,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"double \"both\""},{"file":"src/agent.rs","line":367,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"src/agent.rs","line":401,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"I think 409 CONFLICT might make more sense here.  403 FORBIDDEN is used more around authorization and authentication.  In this case there is a resource conflict that the zone COULD repair if it just set another UUID.  Or maybe this is indeed a double POST."},{"file":"src/agent.rs","line":401,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"For what it\u0027s worth, I think 403 has more to do with authorization than authentication.  Someone can be perfectly well authenticated and still receive a response of 403 because an operation that it\u0027s attempting to perform simply isn\u0027t allowed.\n\nAt the end of the day, I think that this really isn\u0027t about an operation that we can\u0027t perform -- it\u0027s a problem with the target resource that we chose, so for that reason I have to agree that 409 is a better choice."},{"file":"src/agent.rs","line":773,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"This change was to pacify clippy."},{"file":"src/agent.rs","line":948,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Made more sense to call `to_string()\u0027 here so that any future callers didn\u0027t have to deal with it."},{"file":"src/agent.rs","line":948,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Alternatively you could do:\n  fn load_assignment\u003cS: Into\u003cString\u003e\u003e(path: S) -\u003e Arc\u003c...\u003e {\n    let path \u003d path.into();\n    ...\n  }\n\nThen call load_assignment() with whatever you want.  You could do the same with assignment_recall() then pass the \u0027S\u0027 from load_assignment() directly to assignment_recall().\n  fn load_assignment\u003cS: Into\u003cString\u003e\u003e(path: S) -\u003e Arc\u003c...\u003e {\n    let assignment \u003d match assignment_recall(path) {\n        ...\n    }\n  }\n\n  fn assignment_recall\u003cS: Into\u003cString\u003e\u003e(path: S) -\u003e ... {\n     let path \u003d path.into();\n  }"},{"file":"src/agent.rs","line":948,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Neat.  I\u0027ll take this in."},{"file":"src/agent.rs","line":1065,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I realized that using Arc::clone() here meant that I didn\u0027t have to load the same assignment in from disk again."},{"file":"src/agent.rs","line":1142,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I\u0027ll take care of this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":97,"deletions":-19}],"sizeInsertions":97,"sizeDeletions":-19},{"number":"2","revision":"cae1c3af25e2d3c722f1883860f8b6dca9c824d4","parents":["c28f3299cf5aa02706480d502e64f64566366c91"],"ref":"refs/changes/23/6923/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1568922470,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1568922580,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/agent.rs","line":950,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"you should be able to pass the path directly without calling into().... I think..."},{"file":"src/agent.rs","line":950,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Oh, that\u0027s right.  I did the first part before I did the second which is how I ended up this way.  Now that I think about it, I really don\u0027t need it for load assignment, but who knows, it might pay off in the future."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":100,"deletions":-20}],"sizeInsertions":100,"sizeDeletions":-20},{"number":"3","revision":"21e6ac912db995debdfa4eb80ffc392be3b9c8ba","parents":["c28f3299cf5aa02706480d502e64f64566366c91"],"ref":"refs/changes/23/6923/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1568923232,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1568923336,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568923419,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568923419,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":99,"deletions":-19}],"sizeInsertions":99,"sizeDeletions":-19},{"number":"4","revision":"1ae82a813231bb8d415f3d3f18af9bc20c99ca53","parents":["c28f3299cf5aa02706480d502e64f64566366c91"],"ref":"refs/changes/23/6923/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1568923518,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1568923336,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1568923419,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1568923419,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1568923559,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":99,"deletions":-19}],"sizeInsertions":99,"sizeDeletions":-19}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}