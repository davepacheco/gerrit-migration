From 6a6f0d5d3d9843270613ec96f39ea57c2636ec51 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Thu, 28 Jun 2018 17:20:59 -0700
Subject: [PATCH] joyent/node-cueball#143 want ability to set
 decoherence/shuffle timer interval in Sets, too

---
 CHANGES.adoc  | 11 +++++++++++
 docs/api.adoc |  4 ++++
 lib/set.js    |  9 ++++++++-
 package.json  |  2 +-
 4 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/CHANGES.adoc b/CHANGES.adoc
index 9a90ea8..47caba2 100644
--- a/CHANGES.adoc
+++ b/CHANGES.adoc
@@ -6,6 +6,17 @@ toc::[]
 
 ## v2.x
 
+### v2.7.0
+
+New minor release, due to addition of new API. The v2.6.0 release was
+mistakenly published with only the `Pool` part of the API change.
+
+API changes:
+
+ - The `Pool` and `Set` classes now both accept a new constructor option --
+   `decoherenceInterval` which allows increasing the interval of the
+   decoherence/shuffle timer.
+
 ### v2.5.3
 
 Maintenance release.
diff --git a/docs/api.adoc b/docs/api.adoc
index 54392f6..8d35dd9 100644
--- a/docs/api.adoc
+++ b/docs/api.adoc
@@ -823,6 +823,10 @@ Parameters
    * `maximum` -- Number, maximum number of sockets opened by the set.
                   Note that this number may temporarily be exceeded by 1 socket
                   to allow the set to re-balance.
+   * `decoherenceInterval` -- optional Number, seconds between re-shuffles of
+     the backend preference list to try to avoid "coherence" between multiple
+     clients (see the Cueball Internals document for more information). Minimum
+     value of 60 (smaller values will be clamped to 60 seconds).
    * `log` -- optional Object, a `bunyan`-style logger to use
    * `connectionHandlesError` -- optional Boolean (default `false`). If `true`,
                                  cueball assumes that the connection object (the
diff --git a/lib/set.js b/lib/set.js
index 374a3aa..06a98d4 100644
--- a/lib/set.js
+++ b/lib/set.js
@@ -122,10 +122,17 @@ function CueBallConnectionSet(options) {
 	}, 10000);
 	this.cs_rebalTimerInst.unref();
 
+	mod_assert.optionalFinite(options.decoherenceInterval,
+	    'options.decoherenceInterval');
+	var shuffleIntvl = options.decoherenceInterval;
+	if (shuffleIntvl === undefined || shuffleIntvl === null ||
+	    shuffleIntvl < 60) {
+		shuffleIntvl = 60;
+	}
 	this.cs_shuffleTimer = new EventEmitter();
 	this.cs_shuffleTimerInst = setInterval(function () {
 		self.cs_shuffleTimer.emit('timeout');
-	}, 60000);
+	}, shuffleIntvl * 1000);
 	this.cs_shuffleTimerInst.unref();
 
 	FSM.call(this, 'starting');
diff --git a/package.json b/package.json
index 9f7c420..c5de4bb 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "2.6.0",
+  "version": "2.7.0",
   "description": "manage a pool of connections to a multi-node service where nodes are listed in DNS",
   "main": "lib/index.js",
   "dependencies": {
-- 
2.21.0

