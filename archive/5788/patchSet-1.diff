commit b64ba6a8d0b22b1275332dd1f87badd3def6f0f0
Author: Josh Wilsdon <jwilsdon@joyent.com>
Date:   2019-03-13T09:20:10-07:00 (7 months ago)
    
    TRITON-1306 Setup when specifying a hostname was inadvertently broken

diff --git a/lib/models/server.js b/lib/models/server.js
index a0c00a0..71ae8aa 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -1147,8 +1147,8 @@ ModelServer.prototype.setup = function (params, callback) {
             wfParams.disk_layout = params.disk_layout;
         }
 
-        async.waterfall([
-            function (cb) {
+        vasync.pipeline({funcs: [
+            function _optionallySetHostname(_, cb) {
                 if (params.hasOwnProperty('hostname') && params.hostname) {
                     ModelServer.upsert(self.uuid, {hostname: params.hostname}, {
                         etagRetries: 0
@@ -1156,7 +1156,7 @@ ModelServer.prototype.setup = function (params, callback) {
                 } else {
                     cb();
                 }
-            }, function (cb) {
+            }, function _instantiateSetupWorkflow(_, cb) {
                 self.log.info('Instantiating server-setup workflow');
                 ModelServer.getWorkflow().getClient().createJob(
                     'server-setup',
@@ -1173,7 +1173,7 @@ ModelServer.prototype.setup = function (params, callback) {
                         return;
                     });
             }
-        ], function (err) {
+        ]}, function (err) {
             callback(err, job_uuid);
         });
     });
diff --git a/package.json b/package.json
index 8249d14..c574db9 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.21.3",
+  "version": "1.21.4",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
