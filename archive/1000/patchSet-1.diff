From c12589eaf9406fccd800cac935d2cfe36c68e20d Mon Sep 17 00:00:00 2001
From: Chris Burroughs <chris.burroughs@joyent.com>
Date: Wed, 23 Nov 2016 18:37:45 -0500
Subject: [PATCH] ./bin/triton instance audit a567a843

---
 lib/do_instance/do_audit.js | 29 +++++++++++++++--------------
 1 file changed, 15 insertions(+), 14 deletions(-)

diff --git a/lib/do_instance/do_audit.js b/lib/do_instance/do_audit.js
index 82b09f8..ce4060f 100644
--- a/lib/do_instance/do_audit.js
+++ b/lib/do_instance/do_audit.js
@@ -27,7 +27,6 @@ var sortDefault = 'id,time';
 
 
 function do_audit(subcmd, opts, args, cb) {
-    var self = this;
     if (opts.help) {
         this.do_help('help', {}, [subcmd], cb);
         return;
@@ -51,23 +50,25 @@ function do_audit(subcmd, opts, args, cb) {
 
     var arg = args[0];
     var uuid;
+    var tritonapi = this.top.tritonapi;
 
-    if (common.isUUID(arg)) {
-        uuid = arg;
-        go1();
-    } else {
-        self.top.tritonapi.getInstance(arg, function (err, inst) {
-            if (err) {
-                cb(err);
-                return;
-            }
-            uuid = inst.id;
+    common.cliSetupTritonApi({cli: this.top}, function onSetup(setupErr) {
+        if (common.isUUID(arg)) {
+            uuid = arg;
             go1();
-        });
-    }
+        } else {
+            tritonapi.getInstance(arg, function (err, inst) {
+                if (err) {
+                    cb(err);
+                    return;
+                }
+                uuid = inst.id;
+                go1();
+            });
+        }});
 
     function go1() {
-        self.top.tritonapi.cloudapi.machineAudit(uuid, function (err, audit) {
+        tritonapi.cloudapi.machineAudit(uuid, function (err, audit) {
             if (err) {
                 cb(err);
                 return;
-- 
2.21.0

