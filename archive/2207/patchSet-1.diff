commit 3e8da52b9ff473ef17d5325c764a9be051e68f1a (refs/changes/07/2207/1)
Author: Kody A Kantor <kody.kantor@gmail.com>
Date:   2017-07-11T22:22:32+00:00 (2 years, 3 months ago)
    
    MANTA-2955 audit jobs report false positives when mako dumps take over 16 hours

diff --git a/lib/common.js b/lib/common.js
index 7a68875..78e3542 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -130,7 +130,28 @@ function getObjectsInDir(opts, cb) {
                 });
 
                 res.once('end', function () {
-                        cb(null, objects);
+                        // Once we have received all of the objects in the
+                        // directory, we iterate through them and append the
+                        // 'info' structure before returning the listing to the
+                        // calling function.
+                        var getInfo = function (obj, callback) {
+                                client.info(obj.fullPath, {},
+                                        function (infoErr, result) {
+                                                obj.info = result.headers;
+                                                callback(infoErr, obj);
+                                        });
+                        };
+
+                        vasync.forEachParallel({
+                                'func': getInfo,
+                                'inputs': objects
+                        }, function (verr, result) {
+                                if (verr) {
+                                        cb(verr);
+                                        return;
+                                }
+                                cb(null, result.successes);
+                        });
                 });
         });
 }
@@ -354,25 +375,47 @@ function findLatestMakoObjects(opts, cb) {
                 }
 
                 var earliestDump = null;
+                var oldestDump = null;
                 for (var i = 0; i < objects.length; ++i) {
                         var o = objects[i].object;
+                        var info = objects[i].info;
+                        var startTime, endTime;
+
+                        if (info && info['m-mako-dump-time']) {
+                                // Prevent MANTA-2955 false positive corruption.
+                                startTime = info['m-mako-dump-time'];
+                        } else {
+                                startTime = o.mtime;
+                        }
+                        endTime = o.mtime;
+
                         //We can string compare here since we have an
                         // ISO 8601 date.
-                        if (earliestDump === null || earliestDump > o.mtime) {
-                                earliestDump = o.mtime;
+                        // 'earliestDump' represents the dump which _started_
+                        // least recently.
+                        // 'oldestDump' represents the dump which _finished_
+                        // least recently.
+                        if (earliestDump === null || earliestDump > startTime) {
+                                earliestDump = startTime;
                         }
+                        if (oldestDump === null || oldestDump > endTime) {
+                                oldestDump = endTime;
+                        }
+
                 }
                 if (earliestDump === null) {
                         return (cb(new Error('Couldn\'t determine earliest ' +
                                              'dump from mako dumps.')));
                 }
+                opts.log.info('Earliest Mako dump started at %s', earliestDump);
+                opts.log.info('Oldest Mako dump finished at %s', oldestDump);
 
                 // Mako dumps are too far in the past, then fatal.
                 var now = new Date().getTime();
-                var eTime = new Date(earliestDump).getTime();
+                var eTime = new Date(oldestDump).getTime();
                 if ((now - MAX_MILLIS_MAKO_DUMPS_IN_PAST) > eTime) {
                         var error = new Error('Earliest mako dumps are too ' +
-                                              ' old: ' + earliestDump);
+                                              'old: ' + oldestDump);
                         return (cb(error));
                 }
 
