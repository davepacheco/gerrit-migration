{"project":"joyent/manta-mola","branch":"master","topic":"MANTA-2955","id":"I7c451b869f81e0c4f46da921c5e7633acbe56413","number":"2207","subject":"MANTA-2955 audit jobs report false positives when mako dumps take over 16 hours Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/2207","commitMessage":"MANTA-2955 audit jobs report false positives when mako dumps take over 16 hours\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1499811887,"lastUpdated":1504819111,"open":false,"status":"MERGED","comments":[{"timestamp":1499811887,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1499811912,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1499812098,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Topic set to MANTA-2955"},{"timestamp":1499815387,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1499870079,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1499898191,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1499898226,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1499898655,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(3 comments)\n\nThe queue change looks good, aside from a question about the error handling (below)."},{"timestamp":1500321077,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1500321117,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500321292,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(3 comments)\n\nThanks for the feedback, Dave! This patchset addresses the error handling of the vasync queue. I\u0027ll go back and look at what a valid value for dump lag time should be."},{"timestamp":1500489950,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1500492571,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1500650585,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1500650617,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500933175,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1501275632,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5."},{"timestamp":1501275663,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501277880,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 4:\n\n(2 comments)\n\nThanks for pointing these out! I spent a lot of the day trying to figure out how all of this stuff works under the hood. Let me know if my explanations aren\u0027t clear."},{"timestamp":1501522387,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Code-Review+1\n\n(1 comment)\n\nCool."},{"timestamp":1502115819,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1502115845,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1504818883,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1504819083,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1504819111,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"7","revision":"7c451b869f81e0c4f46da921c5e7633acbe56413","parents":["4b8b2975f0b7b70fc2dfc402910ee2c5f3ce0c6f"],"ref":"refs/changes/07/2207/7","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1504819083,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501275663,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501522387,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504818883,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1504819111,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":50,"deletions":-9}],"sizeInsertions":50,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"3e8da52b9ff473ef17d5325c764a9be051e68f1a","parents":["a61d29fe7a32a113c77538e0cd9550c0e3a65f16"],"ref":"refs/changes/07/2207/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1499811887,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1499811912,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":145,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"We probably want to bound the concurrency here, since the number of inputs can get quite large.  A vasync queue is probably the most flexible way to do this, and we could even start these operations as we read results back (e.g., at line 124)."},{"file":"lib/common.js","line":145,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Good point. I\u0027ll implement this with a vasync queue as suggested."},{"file":"lib/common.js","line":416,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s the rationale for having this be based on the dump end time instead of also being based on the dump\u0027s start time?"},{"file":"lib/common.js","line":416,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"There isn\u0027t a good reason why we use the end time instead of the start time. If we switch to basing this on the time that the mako dump started, we\u0027d have to adjust the number of days that we allow dumps to be \u0027behind.\u0027 The value is currently set to three days. I think we would have to bump that to at least five days, otherwise the audit job would almost never run.\n\nIf you think that we should make a change, I can go through our logs to find a reasonable lag allowance. It would clean up this code a little bit."},{"file":"lib/common.js","line":416,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think that change sounds good."},{"file":"lib/common.js","line":416,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Okay, super. I\u0027ll go and figure out a reasonable time to use."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":48,"deletions":-5}],"sizeInsertions":48,"sizeDeletions":-5},{"number":"2","revision":"48aeaeb5878b4e860e5adc56c2440afa399c2e57","parents":["a61d29fe7a32a113c77538e0cd9550c0e3a65f16"],"ref":"refs/changes/07/2207/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1499898191,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1499898226,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":116,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"How does an error here get handled?"},{"file":"lib/common.js","line":116,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I added MultiError handling in the latest patchset. Let me know if you had something else in mind...\n\nSorry about this. I totally spaced on handling errors."},{"file":"lib/common.js","line":383,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think it\u0027s better if comments like this stand alone without a ticket identifier.  e.g., \"If present, use the time when the dump was created, since that most accurately reflects what we care about.  Older versions did not always provide this, so fall back to the mtime if that\u0027s all we have.\"  If people want to understand the history, they can look through the git history to find the ticket and get a lot more information."},{"file":"lib/common.js","line":383,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sounds good! Thanks. I used what you wrote here, but changed the wording a little bit."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":51,"deletions":-10}],"sizeInsertions":51,"sizeDeletions":-10},{"number":"3","revision":"31bc612ca81dcea8024c06f5b0533f89732d40fa","parents":["a61d29fe7a32a113c77538e0cd9550c0e3a65f16"],"ref":"refs/changes/07/2207/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1500321077,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500321117,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":161,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Were you able to exercise the error case?  I\u0027m not sure I understand whether (or when) \u0027end\u0027 would be emitted after queue.kill().  If it\u0027s not emitted, then I\u0027d be worried this would hang if you had a request error."},{"file":"lib/common.js","line":161,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I was able to exercise this error case, but synthetically (by forcing the client.info() call to request info for an object that doesn\u0027t exist). In my testing, the \u0027end\u0027 event is always emitted after kill(), even if nothing was enqueued, and always after the pending workers finished. The queued workers are purged after a kill() call.\n\nIf that\u0027s not an accurate understanding, that would be good to know."},{"file":"lib/common.js","line":165,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you can replace all of this with:\n\n    callback(VError.errorFromList(errors), objects)"},{"file":"lib/common.js","line":165,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, yep. That makes more sense than what I have here. Thanks."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":67,"deletions":-9}],"sizeInsertions":67,"sizeDeletions":-9},{"number":"4","revision":"a55d19e38a3a4c0bdea05f679ea276d732462593","parents":["a61d29fe7a32a113c77538e0cd9550c0e3a65f16"],"ref":"refs/changes/07/2207/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1500650585,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500650617,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":118,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sorry I did not notice this the last time, but why is it that this doesn\u0027t crash if the info() request fails?  Is that because it\u0027s usually a valid response object, even if the result is a 500 error?  What if it couldn\u0027t even contact the server?\n\nAlso, do we want to be pushing this object onto \"obj\" if there were errors?  It seems safer to put these two lines into an \"else\" block."},{"file":"lib/common.js","line":118,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Good question! I thought I tested this, but I must not have. Looking at the node-manta code, this situation would definitely return an error. I tested the new code by setting node-manta to return an error immediately without any \u0027result\u0027 populated."},{"file":"lib/common.js","line":148,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it possible to hit this error case and wind up having invoked the callback through some other means?  I\u0027m guessing not, but not sure."},{"file":"lib/common.js","line":148,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I don\u0027t believe this is possible. \n\nIf an error occurs during json serialization in the node-manta \u0027ls\u0027 function, the lstream.abandon() function is called and an error is emitted. lstream seems to be a wrapper around the node \u0027stream.Transform\u0027 class. I couldn\u0027t find the source code or API definition for the \u0027abandon\u0027 function, but in my testing it does not lead to the \u0027end\u0027 event being emitted. \n\nIf an error occurs in the lstream class, the \u0027error\u0027 event is directly emitted.\n\nOnce the \u0027end\u0027 event is emitted from lstream, node-manta emits the \u0027end\u0027 event (causing the queue\u0027s \u0027end\u0027 event to emit), it looks like node-manta doesn\u0027t do any more processing. As long as lstream/stream.Transform doesn\u0027t have issues with emitting \u0027data\u0027 events after an \u0027end\u0027/\u0027error\u0027 event, we should be fine."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":49,"deletions":-9}],"sizeInsertions":49,"sizeDeletions":-9},{"number":"5","revision":"71c93799d8bbf97e5d5d87e757f27859e743e809","parents":["36644908787ccbbed64499a2f6f4f2c368afe393"],"ref":"refs/changes/07/2207/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501275632,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501522387,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501275663,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":158,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like this will cause us to potentially emit both an Error and a list of objects, but I don\u0027t think that\u0027s likely to break anything."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":50,"deletions":-9}],"sizeInsertions":50,"sizeDeletions":-9},{"number":"6","revision":"23f657f5fc33338ed36650649be3056eef25c1cd","parents":["4b8b2975f0b7b70fc2dfc402910ee2c5f3ce0c6f"],"ref":"refs/changes/07/2207/6","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502115819,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501522387,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504818883,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501275663,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":50,"deletions":-9}],"sizeInsertions":50,"sizeDeletions":-9},{"number":"7","revision":"7c451b869f81e0c4f46da921c5e7633acbe56413","parents":["4b8b2975f0b7b70fc2dfc402910ee2c5f3ce0c6f"],"ref":"refs/changes/07/2207/7","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1504819083,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501522387,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504818883,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501275663,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1504819111,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":50,"deletions":-9}],"sizeInsertions":50,"sizeDeletions":-9}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}