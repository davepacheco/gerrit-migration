{"project":"joyent/sdc-vmapi","branch":"master","id":"I1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1","number":"3206","subject":"ZAPI-667 offset_fields_vms_ok test and related tests should not rely on existing VMs Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/3206","commitMessage":"ZAPI-667 offset_fields_vms_ok test and related tests should not rely on existing VMs\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1515736428,"lastUpdated":1516227536,"open":false,"status":"MERGED","comments":[{"timestamp":1515736428,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1515736431,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 806a658f6f539078cf6cab23fb623ae28e953faa\n    \n    initial commit"},{"timestamp":1515736458,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515736626,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1515785528,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(9 comments)"},{"timestamp":1515786562,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1516126789,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(8 comments)"},{"timestamp":1516128408,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1516128411,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 0118a6309da704f382ce1a18a7185427b12ef4d9\n    \n    iteration based on julien review"},{"timestamp":1516128438,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516143183,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1516153540,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1516156653,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1516156656,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 3af7c933581822b6d5ed61003fa967ffd80d9597\n    \n    julien review"},{"timestamp":1516156683,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516223194,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1516227181,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1516227375,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1516227397,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1516227400,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 6712c6312a1bde1d067a7819fd51c5ff94c624c4\n    \n    julien review\n    \n    commit 53a4e713585af9ed8b18d63aebcf8b336790dac5\n    \n    iteration based on julien review\n    \n    commit de026a6b68d8e7c36217484939c7b5f0d2ba2225\n    \n    initial commit"},{"timestamp":1516227427,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1516227536,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"5","revision":"1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1","parents":["404ffe5679e6430d37282d5eb258993cfda8dae4"],"ref":"refs/changes/06/3206/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1516227397,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516156683,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516223194,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516227181,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1516227536,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":163,"deletions":-19}],"sizeInsertions":164,"sizeDeletions":-20},"patchSets":[{"number":"1","revision":"a8acdfabc28aa6e79f399e5d9c69babaf6ac9439","parents":["6b8bc50157c9d787091179b003b6e0d95d213e74"],"ref":"refs/changes/06/3206/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1515736428,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515736458,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/vms.full.test.js","line":137,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Assert on the expected types of t and cb.\n\nAlso, I generally try to avoid passing a test object to a reusable function. The rationale is that some tests that will use a given function will expect some things to fail, others will expect everything to succeed, etc.\n\nSo having t.ok or t.ifError calls in those reusable functions make them less reusable.\n\nInstead, tests that use those functions should examine the error and result(s) passed to their callbacks and determine whether the test is successful or not.\n\nIt\u0027s not a big deal though if you don\u0027t agree with that, just a preference."},{"file":"test/vms.full.test.js","line":137,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"This makes sense to me - I\u0027ll refactor the code so createTestVms doesn\u0027t take a test object."},{"file":"test/vms.full.test.js","line":153,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I didn\u0027t know about that field, what is it used for?"},{"file":"test/vms.full.test.js","line":153,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I don\u0027t either, I lifted this from other VM payloads in this file."},{"file":"test/vms.full.test.js","line":153,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It seems that this gets written to workflow job objects so that maybe we can determine what component created them? If so, I\u0027d think that setting \"cloudadpi\" is at best misleading, and probably not useful. I\u0027d remove it."},{"file":"test/vms.full.test.js","line":153,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"test/vms.full.test.js","line":154,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Do we need that? What for?"},{"file":"test/vms.full.test.js","line":154,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Same as `origin`"},{"file":"test/vms.full.test.js","line":154,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same response as for \"origin\". I\u0027d remove that."},{"file":"test/vms.full.test.js","line":154,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"test/vms.full.test.js","line":157,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"If possible, let\u0027s use vasync instead of async. We\u0027ve been slowly trying to get rid of usage of the async module in sdc-vmapi."},{"file":"test/vms.full.test.js","line":157,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"+1 having authored vasync.whilst i fully support this :)"},{"file":"test/vms.full.test.js","line":179,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Ideally, we would also stop waiting when the execution of a workflow job is \u0027failed\u0027. But at last \"waitForValue\" has a timeout, so it wouldn\u0027t be stuck forever."},{"file":"test/vms.full.test.js","line":190,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Assert on the type of t and cb, and same comment as above regarding passing test objects to reusable functions."},{"file":"test/vms.full.test.js","line":191,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Maybe make the \"vmapitest-full-\" prefix a reusable constant (or variable) somewhere?"},{"file":"test/vms.full.test.js","line":191,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"test/vms.full.test.js","line":206,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"ditto for async vs vasync."},{"file":"test/vms.full.test.js","line":206,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"test/vms.full.test.js","line":213,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Even though `alias\u003dvmapitest-full-` is specified above, does it make sense to assert `vm.alias.match(/^vmapitest-full-/)` here to ensure nothing important is deleted in the event that something is broken with `alias\u003d` above"},{"file":"test/vms.full.test.js","line":213,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, I think that could be useful."},{"file":"test/vms.full.test.js","line":213,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"test/vms.full.test.js","line":214,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Instead of \"err2\", can we name that \"delErr\" or use a name that conveys the semantics of that error?"},{"file":"test/vms.full.test.js","line":214,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":116,"deletions":-1}],"sizeInsertions":116,"sizeDeletions":-1},{"number":"2","revision":"bd60033698694e68ff7a4907dce0f1a4363ce92d","parents":["6b8bc50157c9d787091179b003b6e0d95d213e74"],"ref":"refs/changes/06/3206/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1516128408,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516128438,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"package.json","line":4,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why bump VMAPI\u0027s minor version number?"},{"file":"package.json","line":4,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Oh, good catch. I did this originally when bumping the vasync version but then (thought) I had undone it. will remove."},{"file":"package.json","line":31,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: I prefer to use fixed version numbers instead of ranges, but I don\u0027t think we have an actual guideline for this."},{"file":"package.json","line":31,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027ll use the exact version."},{"file":"test/vms.full.test.js","line":245,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"rename err2 to \"delVmsErr\" or \"delTestVmsErr\" or anything clearer than \"err2\", which doesn\u0027t convey the meaning of the error object."},{"file":"test/vms.full.test.js","line":245,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Will do."},{"file":"test/vms.full.test.js","line":304,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Asserting in a tests suite aborts the whole tests suite, so we want to do that _only when we\u0027re sure that there\u0027s an actual bug in the tests suite_. I don\u0027t think this and all asserts in this function match this use case: there is at least one way that this code could work as expected but the system would e.g fail to destroy a VM or create one, and we\u0027d assert here.\n\nSame comment for the destroy_test_vms_final function."},{"file":"test/vms.full.test.js","line":304,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":154,"deletions":-3}],"sizeInsertions":156,"sizeDeletions":-5},{"number":"3","revision":"8d311686f95c70f459e529ec280d266679f8924b","parents":["6b8bc50157c9d787091179b003b6e0d95d213e74"],"ref":"refs/changes/06/3206/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1516156653,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516156683,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516223194,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516227181,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":163,"deletions":-19}],"sizeInsertions":164,"sizeDeletions":-20},{"number":"4","revision":"acdda103379bd722ba70d8888e54890dd1466743","parents":["6b8bc50157c9d787091179b003b6e0d95d213e74"],"ref":"refs/changes/06/3206/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1516227375,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516156683,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516223194,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516227181,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":163,"deletions":-19}],"sizeInsertions":164,"sizeDeletions":-20},{"number":"5","revision":"1bdd286fcb7c7168e43a425c8ccb100d4b38d3f1","parents":["404ffe5679e6430d37282d5eb258993cfda8dae4"],"ref":"refs/changes/06/3206/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1516227397,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516156683,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1516223194,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1516227181,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1516227536,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/vms.full.test.js","type":"MODIFIED","insertions":163,"deletions":-19}],"sizeInsertions":164,"sizeDeletions":-20}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}