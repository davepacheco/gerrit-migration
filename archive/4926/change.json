{"project":"joyent/illumos-joyent","branch":"master","id":"I25a094ff667150ca3325d3a86ab4b3ff2b7a83db","number":"4926","subject":"OS-7394 defer bhyve instance destruction to last close Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/4926","commitMessage":"OS-7394 defer bhyve instance destruction to last close\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1538667842,"lastUpdated":1544050828,"open":false,"status":"MERGED","comments":[{"timestamp":1538667842,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1538667912,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1: Code-Review-1"},{"timestamp":1538668025,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\nMy experiments with mdb reliably trip over an assertion in vmm_zsd_destroy() when a VM is destroyed while mdb is still attached.\n\nThis is what I came up with to prevent that from happening."},{"timestamp":1543337710,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1543337827,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1543338374,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1543338394,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: -Code-Review"},{"timestamp":1543351467,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(3 comments)\n\nHave you done any analysis about any weird hangs or other state change issues this could stumble into?  The whole zone shutdown and clean-up process seems fairly fraught."},{"timestamp":1543502157,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n\u003e Have you done any analysis about any weird hangs or other state\n \u003e change issues this could stumble into?  The whole zone shutdown and\n \u003e clean-up process seems fairly fraught.\n\nI have tested it, but not analyzed.\n\nWhile mdb is attached to a VM, it can be halted either with vmadm or by halting the guest OS. This will actually finish faster than normal since the work to do the resources isn\u0027t done yet. mdb will notice the VM is gone, and when exiting it\u0027ll actually wait for the resources to be freed. If a VM is started again before mdb exited and the resources are freed the VM will fail to start.\n\nRebooting a VM is different, mdb won\u0027t notice that at all and just continue to operate normally."},{"timestamp":1543506092,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5."},{"timestamp":1543506173,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1543509856,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1543574562,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 6."},{"timestamp":1543574609,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1543936178,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1544007774,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1544024877,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Code-Review+1\n\n(1 comment)"},{"timestamp":1544029040,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1544029659,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Code-Review+1\n\nIt looks like it\u0027s possible to *create* a VM that\u0027s in state VMM_DESTROY; I find that a bit weird, but I was also unable to spot a specific issue with doing so, so...\n\nIn terms of testing, I\u0027d prefer to see some stress testing done. One great test for issues previously has been a whole bunch of VMs in reboot loops, along with processes randomly opening and closing the corresponding device files."},{"timestamp":1544048561,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1544048574,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6:\n\n(Hans did the additional testing I asked for.)"},{"timestamp":1544049244,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1544050779,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1544050828,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"8","revision":"e0f08ef22a20cf816904f0b60a05b9dbe40cb836","parents":["a454ac291ee3d52860e81c8b77efa408915b3aa3"],"ref":"refs/changes/26/4926/8","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1544050779,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544024877,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544029659,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544048561,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1544050828,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":-8},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"c527c2553a4f7f5726cecec77a8ab1dd87e40f6e","parents":["be9e2e3289d8ed66d3715f0d7b46dd404dd2e4a5"],"ref":"refs/changes/26/4926/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1538667842,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1538667912,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":17,"deletions":-6},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":19,"sizeDeletions":-7},{"number":"2","revision":"ba8afa8cc43278a36173822a46e61c72180bd238","parents":["28bce0b9e448858f6b3f50f0900da272bae87512"],"ref":"refs/changes/26/4926/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543337710,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1538667912,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":17,"deletions":-6},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":19,"sizeDeletions":-7},{"number":"3","revision":"40d44af49bbbc9823f8b3f0bf06ee58bb0e0ed73","parents":["28bce0b9e448858f6b3f50f0900da272bae87512"],"ref":"refs/changes/26/4926/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543337827,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1538667912,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":19,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-8},{"number":"4","revision":"c60c574ce98b74fd23cb02cb9f995ac79790570f","parents":["28bce0b9e448858f6b3f50f0900da272bae87512"],"ref":"refs/changes/26/4926/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543338374,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1290,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Would it make sense to have an explicit guard for that new state bit here too?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1290,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1493,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"A different name for this would probably be sensible since we\u0027re actually deferring the vm_destroy() call."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1493,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Do you have any suggestions? Perhaps VMM_DESTROY, VMM_DOWN, or VMM_DEAD? I have trouble thinking of something better that is also reasonably short."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1493,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"VMM_DESTROY is definitely better than VMM_DESTROYED."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1493,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1577,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should we be guarding against new opens?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1577,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"We implicitly do that by removing the minor node even when we keep the rest of the VM state around."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":19,"deletions":-7},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-8},{"number":"5","revision":"0607bed40c616a0dcb558a7610dd15393869df9a","parents":["28bce0b9e448858f6b3f50f0900da272bae87512"],"ref":"refs/changes/26/4926/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543506092,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":-8},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-9},{"number":"6","revision":"1f964c61cb509eee604f8f7190b9e03c95ca40b3","parents":["28bce0b9e448858f6b3f50f0900da272bae87512"],"ref":"refs/changes/26/4926/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1543574562,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544024877,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544029659,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544048561,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1488,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I don\u0027t meant to rock the boat this late in the process, but here\u0027s a question:  When deferring the instance destruction, would we perhaps want to keep it on a separate list? (vmmdev_destroy_list, or something?)  That way it would be easier to find instances which were being held open without needing to dig them up via softstate/minor."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1488,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Sounds like a reasonable idea, but I\u0027d do it in its own bug at a later time."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1488,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Works for me.  Could you open that issue prior to merging this, so it is not forgotten?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1488,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done, see OS-7424."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":-8},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-9},{"number":"7","revision":"25a094ff667150ca3325d3a86ab4b3ff2b7a83db","parents":["28bce0b9e448858f6b3f50f0900da272bae87512"],"ref":"refs/changes/26/4926/7","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1544049244,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544024877,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544029659,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544048561,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":-8},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-9},{"number":"8","revision":"e0f08ef22a20cf816904f0b60a05b9dbe40cb836","parents":["a454ac291ee3d52860e81c8b77efa408915b3aa3"],"ref":"refs/changes/26/4926/8","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1544050779,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544024877,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1544050828,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544029659,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544048561,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":20,"deletions":-8},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":22,"sizeDeletions":-9}],"allReviewers":[{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}