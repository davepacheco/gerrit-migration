commit 252bbfaf8821d5c2b5f44f6d3625fb82e034adfd
Author: Mike Gerdts <mike.gerdts@joyent.com>
Date:   2019-06-20T19:14:53+00:00 (4 months ago)
    
    OS-7847 vminfod does not sort bhyve disks properly
    Reviewed by: Pedro Palaz√≥n Candel <pedro@joyent.com>
    Reviewed by: Orlando Vazquez <orlando@joyent.com>
    Approved by: Orlando Vazquez <orlando@joyent.com>

diff --git a/src/vm/node_modules/vmload/vmload-xml.js b/src/vm/node_modules/vmload/vmload-xml.js
index c460c358..84c0ee75 100644
--- a/src/vm/node_modules/vmload/vmload-xml.js
+++ b/src/vm/node_modules/vmload/vmload-xml.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2018, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  *
  * vmload-xml: loads VM properties from /etc/zones/<zonename>.xml
@@ -148,7 +148,7 @@ function getVmobjXML(data, options, callback)
 
     // sort the disks + nics + filesystems by index
     if (obj.hasOwnProperty('disks')) {
-        indexSort(obj.disks, 'path', /^.*-disk(\d+)$/);
+        indexSort(obj.disks, 'path', /^.*[\-\/]disk(\d+)$/);
     }
     if (obj.hasOwnProperty('nics')) {
         indexSort(obj.nics, 'interface', /^net(\d+)$/);
diff --git a/src/vm/tests/testdata/vmload-xml/bhyve-disk-sort.json b/src/vm/tests/testdata/vmload-xml/bhyve-disk-sort.json
new file mode 100644
index 00000000..2f03d314
--- /dev/null
+++ b/src/vm/tests/testdata/vmload-xml/bhyve-disk-sort.json
@@ -0,0 +1,65 @@
+{
+  "zonename": "aaac8650-4b58-6633-9054-a2c22e7beb36",
+  "autoboot": false,
+  "brand": "bhyve",
+  "limit_priv": "default,-file_link_any,-net_access,-proc_fork,-proc_info,-proc_session",
+  "v": 1,
+  "create_timestamp": "2019-05-23T15:54:24.802Z",
+  "cpu_shares": 100,
+  "max_lwps": 2000,
+  "max_msg_ids": 4096,
+  "max_sem_ids": 4096,
+  "max_shm_ids": 4096,
+  "max_shm_memory": 2304,
+  "zfs_io_priority": 100,
+  "max_physical_memory": 2304,
+  "max_locked_memory": 2304,
+  "max_swap": 2304,
+  "billing_id": "00000000-0000-0000-0000-000000000000",
+  "owner_uuid": "00000000-0000-0000-0000-000000000000",
+  "ram": 1024,
+  "vcpus": 2,
+  "device": null,
+  "disks": [
+    {
+      "path": "/dev/zvol/rdsk/zones/aaac8650-4b58-6633-9054-a2c22e7beb36/disk0",
+      "boot": true,
+      "model": "virtio",
+      "media": "disk",
+      "image_size": 10240,
+      "image_uuid": "cf6b54f9-2952-4213-ba84-b6f64a7ec229",
+      "pci_slot": "0:4:0",
+      "uuid": "11adf075-d948-6518-eaa7-fab9fcadb934"
+    },
+    {
+      "path": "/dev/zvol/rdsk/zones/aaac8650-4b58-6633-9054-a2c22e7beb36/disk1",
+      "boot": false,
+      "model": "virtio",
+      "media": "disk",
+      "pci_slot": "0:4:1",
+      "uuid": "4869641c-555b-6809-bd97-b9fc2a84e1b9"
+    }
+  ],
+  "nics": [
+    {
+      "interface": "net0",
+      "mac": "b2:f6:32:07:6c:3b",
+      "nic_tag": "admin",
+      "gateway": "10.88.88.2",
+      "gateways": [
+        "10.88.88.2"
+      ],
+      "netmask": "255.255.255.0",
+      "ip": "10.88.88.221",
+      "ips": [
+        "10.88.88.221/24"
+      ],
+      "model": "virtio",
+      "primary": true
+    }
+  ],
+  "com1": "/dev/zconsole",
+  "com2": "socket,/tmp/vm.ttyb",
+  "zlog_mode": "g--",
+  "zlog_name": "platform.log"
+}
diff --git a/src/vm/tests/testdata/vmload-xml/bhyve-disk-sort.xml b/src/vm/tests/testdata/vmload-xml/bhyve-disk-sort.xml
new file mode 100644
index 00000000..d2340e17
--- /dev/null
+++ b/src/vm/tests/testdata/vmload-xml/bhyve-disk-sort.xml
@@ -0,0 +1,73 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    DO NOT EDIT THIS FILE.  Use zonecfg(1M) instead.
+-->
+<!DOCTYPE zone PUBLIC "-//Sun Microsystems Inc//DTD Zones//EN" "file:///usr/share/lib/xml/dtd/zonecfg.dtd.1">
+<zone name="aaac8650-4b58-6633-9054-a2c22e7beb36" zonepath="/zones/aaac8650-4b58-6633-9054-a2c22e7beb36" autoboot="false" brand="bhyve" ip-type="exclusive" limitpriv="default,-file_link_any,-net_access,-proc_fork,-proc_info,-proc_session" debugid="13968">
+  <attr name="vm-version" type="string" value="1"/>
+  <attr name="create-timestamp" type="string" value="2019-05-23T15:54:24.802Z"/>
+  <rctl name="zone.cpu-shares">
+    <rctl-value priv="privileged" limit="100" action="none"/>
+  </rctl>
+  <rctl name="zone.max-lwps">
+    <rctl-value priv="privileged" limit="2000" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-msg-ids">
+    <rctl-value priv="privileged" limit="4096" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-sem-ids">
+    <rctl-value priv="privileged" limit="4096" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-shm-ids">
+    <rctl-value priv="privileged" limit="4096" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-shm-memory">
+    <rctl-value priv="privileged" limit="2415919104" action="deny"/>
+  </rctl>
+  <rctl name="zone.zfs-io-priority">
+    <rctl-value priv="privileged" limit="100" action="none"/>
+  </rctl>
+  <rctl name="zone.max-physical-memory">
+    <rctl-value priv="privileged" limit="2415919104" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-locked-memory">
+    <rctl-value priv="privileged" limit="2415919104" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-swap">
+    <rctl-value priv="privileged" limit="2415919104" action="deny"/>
+  </rctl>
+  <attr name="billing-id" type="string" value="00000000-0000-0000-0000-000000000000"/>
+  <attr name="owner-uuid" type="string" value="00000000-0000-0000-0000-000000000000"/>
+  <attr name="ram" type="string" value="1024"/>
+  <attr name="vcpus" type="string" value="2"/>
+  <device match="/dev/zvol/rdsk/zones/aaac8650-4b58-6633-9054-a2c22e7beb36/disk1">
+    <net-attr name="boot" value="false"/>
+    <net-attr name="model" value="virtio"/>
+    <net-attr name="media" value="disk"/>
+    <net-attr name="size" value="256"/>
+    <net-attr name="pci-slot" value="0:4:1"/>
+    <net-attr name="uuid" value="4869641c-555b-6809-bd97-b9fc2a84e1b9"/>
+  </device>
+  <network physical="net0" mac-addr="b2:f6:32:07:6c:3b" global-nic="admin">
+    <net-attr name="gateway" value="10.88.88.2"/>
+    <net-attr name="gateways" value="10.88.88.2"/>
+    <net-attr name="netmask" value="255.255.255.0"/>
+    <net-attr name="ip" value="10.88.88.221"/>
+    <net-attr name="ips" value="10.88.88.221/24"/>
+    <net-attr name="model" value="virtio"/>
+    <net-attr name="primary" value="true"/>
+  </network>
+  <attr name="com1" type="string" value="/dev/zconsole"/>
+  <attr name="com2" type="string" value="socket,/tmp/vm.ttyb"/>
+  <attr name="zlog-mode" type="string" value="g--"/>
+  <attr name="zlog-name" type="string" value="platform.log"/>
+  <device match="/dev/zvol/rdsk/zones/aaac8650-4b58-6633-9054-a2c22e7beb36/disk0">
+    <net-attr name="boot" value="true"/>
+    <net-attr name="model" value="virtio"/>
+    <net-attr name="media" value="disk"/>
+    <net-attr name="image-size" value="10240"/>
+    <net-attr name="image-uuid" value="cf6b54f9-2952-4213-ba84-b6f64a7ec229"/>
+    <net-attr name="pci-slot" value="0:4:0"/>
+    <net-attr name="uuid" value="11adf075-d948-6518-eaa7-fab9fcadb934"/>
+  </device>
+</zone>
diff --git a/src/vm/tests/testdata/vmload-xml/kvm-disk-sort.json b/src/vm/tests/testdata/vmload-xml/kvm-disk-sort.json
new file mode 100644
index 00000000..1a523969
--- /dev/null
+++ b/src/vm/tests/testdata/vmload-xml/kvm-disk-sort.json
@@ -0,0 +1,59 @@
+{
+  "zonename": "5a02245a-422c-4e0a-c5f8-fd6fac1ac04e",
+  "autoboot": false,
+  "brand": "kvm",
+  "limit_priv": "default,-file_link_any,-net_access,-proc_fork,-proc_info,-proc_session",
+  "v": 1,
+  "create_timestamp": "2019-06-19T04:34:48.243Z",
+  "cpu_shares": 100,
+  "max_lwps": 2000,
+  "max_msg_ids": 4096,
+  "max_sem_ids": 4096,
+  "max_shm_ids": 4096,
+  "max_shm_memory": 2048,
+  "zfs_io_priority": 100,
+  "max_physical_memory": 2048,
+  "max_locked_memory": 2048,
+  "max_swap": 2048,
+  "billing_id": "00000000-0000-0000-0000-000000000000",
+  "owner_uuid": "00000000-0000-0000-0000-000000000000",
+  "hostname": "kvm7",
+  "alias": "kvm7",
+  "ram": 1024,
+  "vcpus": 2,
+  "device": null,
+  "disks": [
+    {
+      "path": "/dev/zvol/rdsk/zones/5a02245a-422c-4e0a-c5f8-fd6fac1ac04e-disk0",
+      "boot": true,
+      "model": "virtio",
+      "media": "disk",
+      "image_size": 10240,
+      "image_uuid": "462d1d03-8457-e134-a408-cf9ea2b9be96"
+    },
+    {
+      "path": "/dev/zvol/rdsk/zones/5a02245a-422c-4e0a-c5f8-fd6fac1ac04e-disk1",
+      "boot": false,
+      "model": "virtio",
+      "media": "disk"
+    }
+  ],
+  "nics": [
+    {
+      "interface": "net0",
+      "mac": "b2:db:d2:3f:36:d9",
+      "nic_tag": "admin",
+      "gateway": "10.88.88.2",
+      "gateways": [
+        "10.88.88.2"
+      ],
+      "netmask": "255.255.255.0",
+      "ip": "10.88.88.213",
+      "ips": [
+        "10.88.88.213/24"
+      ],
+      "model": "virtio",
+      "primary": true
+    }
+  ]
+}
diff --git a/src/vm/tests/testdata/vmload-xml/kvm-disk-sort.xml b/src/vm/tests/testdata/vmload-xml/kvm-disk-sort.xml
new file mode 100644
index 00000000..eff32ae6
--- /dev/null
+++ b/src/vm/tests/testdata/vmload-xml/kvm-disk-sort.xml
@@ -0,0 +1,68 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    DO NOT EDIT THIS FILE.  Use zonecfg(1M) instead.
+-->
+<!DOCTYPE zone PUBLIC "-//Sun Microsystems Inc//DTD Zones//EN" "file:///usr/share/lib/xml/dtd/zonecfg.dtd.1">
+<zone name="5a02245a-422c-4e0a-c5f8-fd6fac1ac04e" zonepath="/zones/5a02245a-422c-4e0a-c5f8-fd6fac1ac04e" autoboot="false" brand="kvm" ip-type="exclusive" limitpriv="default,-file_link_any,-net_access,-proc_fork,-proc_info,-proc_session" debugid="13985">
+  <attr name="vm-version" type="string" value="1"/>
+  <attr name="create-timestamp" type="string" value="2019-06-19T04:34:48.243Z"/>
+  <rctl name="zone.cpu-shares">
+    <rctl-value priv="privileged" limit="100" action="none"/>
+  </rctl>
+  <rctl name="zone.max-lwps">
+    <rctl-value priv="privileged" limit="2000" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-msg-ids">
+    <rctl-value priv="privileged" limit="4096" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-sem-ids">
+    <rctl-value priv="privileged" limit="4096" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-shm-ids">
+    <rctl-value priv="privileged" limit="4096" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-shm-memory">
+    <rctl-value priv="privileged" limit="2147483648" action="deny"/>
+  </rctl>
+  <rctl name="zone.zfs-io-priority">
+    <rctl-value priv="privileged" limit="100" action="none"/>
+  </rctl>
+  <rctl name="zone.max-physical-memory">
+    <rctl-value priv="privileged" limit="2147483648" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-locked-memory">
+    <rctl-value priv="privileged" limit="2147483648" action="deny"/>
+  </rctl>
+  <rctl name="zone.max-swap">
+    <rctl-value priv="privileged" limit="2147483648" action="deny"/>
+  </rctl>
+  <attr name="billing-id" type="string" value="00000000-0000-0000-0000-000000000000"/>
+  <attr name="owner-uuid" type="string" value="00000000-0000-0000-0000-000000000000"/>
+  <attr name="hostname" type="string" value="kvm7"/>
+  <attr name="alias" type="string" value="a3ZtNw=="/>
+  <attr name="ram" type="string" value="1024"/>
+  <attr name="vcpus" type="string" value="2"/>
+  <device match="/dev/zvol/rdsk/zones/5a02245a-422c-4e0a-c5f8-fd6fac1ac04e-disk1">
+    <net-attr name="boot" value="false"/>
+    <net-attr name="model" value="virtio"/>
+    <net-attr name="media" value="disk"/>
+    <net-attr name="size" value="100"/>
+  </device>
+  <device match="/dev/zvol/rdsk/zones/5a02245a-422c-4e0a-c5f8-fd6fac1ac04e-disk0">
+    <net-attr name="boot" value="true"/>
+    <net-attr name="model" value="virtio"/>
+    <net-attr name="media" value="disk"/>
+    <net-attr name="image-size" value="10240"/>
+    <net-attr name="image-uuid" value="462d1d03-8457-e134-a408-cf9ea2b9be96"/>
+  </device>
+  <network physical="net0" mac-addr="b2:db:d2:3f:36:d9" global-nic="admin">
+    <net-attr name="gateway" value="10.88.88.2"/>
+    <net-attr name="gateways" value="10.88.88.2"/>
+    <net-attr name="netmask" value="255.255.255.0"/>
+    <net-attr name="ip" value="10.88.88.213"/>
+    <net-attr name="ips" value="10.88.88.213/24"/>
+    <net-attr name="model" value="virtio"/>
+    <net-attr name="primary" value="true"/>
+  </network>
+  <attr name="vm-autoboot" type="string" value="false"/>
+</zone>
