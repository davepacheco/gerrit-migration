{"project":"joyent/manatee","branch":"master","id":"I35be0bca5871d9ba35f68c75b0ec1e8aa8538f42","number":"3971","subject":"MANATEE-375 Update dev zone scripts for MANATEE-335 Reviewed by: Robert Bogart \u003cRobert.bogart@joyent.com\u003e Approved by: Robert Bogart \u003cRobert.bogart@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/3971","commitMessage":"MANATEE-375 Update dev zone scripts for MANATEE-335\nReviewed by: Robert Bogart \u003cRobert.bogart@joyent.com\u003e\nApproved by: Robert Bogart \u003cRobert.bogart@joyent.com\u003e\n","createdOn":1526644408,"lastUpdated":1548408506,"open":false,"status":"MERGED","comments":[{"timestamp":1526644408,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1526644440,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545062998,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1545063030,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545063782,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1545063813,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546979131,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(2 comments)\n\nAll in all, looks pretty reasonable to me.  I would have asked for the obligatory `set -o errexit`, but it might be a lot of re-work and it\u0027s for development purposes anyway.  I feel like I have more confidence in this than a regular reviewer since I\u0027ve tested it numerous times in addition to reading it.  I only had a couple of comments.  Thanks for doing all this work -- it\u0027s really nice."},{"timestamp":1547051762,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(2 comments)\n\nThanks for looking! I\u0027m going to look into your `set -o errexit` suggestion also."},{"timestamp":1547052618,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1547235513,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\nHey Rich, I had a conversation with Josh Clulow yesterday about Manatee testing (for MANATEE-343 which I\u0027m working on) and he had mentioned to me that testing for the time being is necessary with both 9.2 and 9.6 before integration.  In light of that, when in development, we will probably always need to have both, so I think you were right to build both in the first place."},{"timestamp":1547468746,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1547468778,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547468886,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(1 comment)\n\nThat\u0027s a good point re: testing. I\u0027ll leave it so we install all versions up front.\n\nI\u0027ve also removed the dataset creation part of tools/mkdevsitter in PS4 because this is done by sitter now that we have MANATEE-400. I didn\u0027t quite realise this was the case and it came up while testing the rebuild steps added in PS4."},{"timestamp":1547679074,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nPersonally, I\u0027m fine with this.  I\u0027ve reviewed it and we\u0027ve both tested it.  If you feel like there\u0027s something that you want to add, I\u0027ll re-approve, but this looks good to me."},{"timestamp":1548147039,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1548147072,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548176963,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1548408506,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"5","revision":"35be0bca5871d9ba35f68c75b0ec1e8aa8538f42","parents":["9cf04af7d152c1dfc7e74342b530155a7697cd3e"],"ref":"refs/changes/71/3971/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1548147039,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548147072,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548176963,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548176963,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}},{"type":"SUBM","value":"1","grantedOn":1548408506,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":3,"deletions":-191},{"file":"docs/working-on-manatee.md","type":"ADDED","insertions":304,"deletions":0},{"file":"tools/mkdevsitters","type":"MODIFIED","insertions":95,"deletions":-24},{"file":"tools/mksitterconfig","type":"MODIFIED","insertions":44,"deletions":-7}],"sizeInsertions":446,"sizeDeletions":-222},"patchSets":[{"number":"1","revision":"900c08b117a067c3a45ff7bb27286f8978224cec","parents":["729d799b844630f8f6eb34dcbaf3ae7fdfd3bf7f"],"ref":"refs/changes/71/3971/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1526644408,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526644440,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":3,"deletions":-166},{"file":"docs/working-on-manatee.md","type":"ADDED","insertions":249,"deletions":0},{"file":"tools/mkdevsitters","type":"MODIFIED","insertions":86,"deletions":-10},{"file":"tools/mksitterconfig","type":"MODIFIED","insertions":44,"deletions":-7}],"sizeInsertions":382,"sizeDeletions":-183},{"number":"2","revision":"ccb05bd751ee5973a740fc8bbe1eeccf43e01822","parents":["179a24faf5fac6c477d0459646c78c1fccf4fce8"],"ref":"refs/changes/71/3971/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1545062998,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545063030,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":3,"deletions":-191},{"file":"docs/working-on-manatee.md","type":"ADDED","insertions":249,"deletions":0},{"file":"tools/mkdevsitters","type":"MODIFIED","insertions":86,"deletions":-10},{"file":"tools/mksitterconfig","type":"MODIFIED","insertions":44,"deletions":-7}],"sizeInsertions":382,"sizeDeletions":-208},{"number":"3","revision":"c02936465bb4ad3db741666b6f12bb53dfa0a0fd","parents":["179a24faf5fac6c477d0459646c78c1fccf4fce8"],"ref":"refs/changes/71/3971/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1545063782,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545063813,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/working-on-manatee.md","line":1,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"One of the things that I noticed when using this branch to set up my own cluster was that certain features won\u0027t be available in the way that they would be if someone had deployed this the traditional way.  Naturally, given what I\u0027m working on, I\u0027m thinking of `manatee-adm rebuild`.  As it stands, I think the only way for someone to figure it out is to deploy the cluster, then attempt to rebuild a node and finally come to the realization that manatee-adm relies on smf to start services.  I think that\u0027s a limitation that existed prior to any work here and this is still a huge help, but it might be worth mentioning that rebuild isn\u0027t straight forward anymore if they deploy this way.\n\nI ended up taking your branch and using it to deploy 1 peer per zone for a total of 3 zones and then making them smf services after the fact.  If you agree with that approach, it might be worth mentioning somewhere in this document to people who need to perform a rebuild."},{"file":"docs/working-on-manatee.md","line":1,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Yes, indeed this is a bit awkward. I think MANATEE-317 will help a little here, but there are likely more cases that should be addressed.\n\nFor the case of a rebuild, what I tend to do is manually perform the steps required to do this rebuild. That is, I\u0027ll kill the manatee process, run `rm -rf ...` on the dataset\u0027s path, reap the deposed peer (if the peer is in fact deposed), then start the process again. This may have changed recently, but I have found this to be enough for development purposes, but when directly testing the `manatee-adm rebuild` command (or for proper testing around IA) this is not sufficient.\n\nWould you say adding to the document a section around limitations, and also adding some known workarounds (like the above) to those limitations? I can\u0027t think of others at the moment, but I agree with you. This is certainly a case that could do with being called out explicitly."},{"file":"docs/working-on-manatee.md","line":1,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Yeah, that would be awesome.  It may not be possible to add everything, but maybe just some of the big things that you mentioned."},{"file":"docs/working-on-manatee.md","line":1,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"tools/mkdevsitters","line":149,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Need some education: how come we install all supported versions of Postgres when the user has either specified one or defaulted to 9.6 by not specifying any?"},{"file":"tools/mkdevsitters","line":149,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Good question! I can\u0027t remember why I did it this way. I think I was trying to consider the case where a developer is perhaps switching between 9.2 and 9.6 fairly frequently, and it would be useful if the versions were built upfront.\n\nThere\u0027s no reason in Manatee to have the 2 versions available that I\u0027m aware of, but I can check that also. We do ship the image with both versions, but that\u0027s only because we don\u0027t know what version of postgres is going to be used at build time.\n\nI think I\u0027m going to change this to only build the version being setup at the time of running the script."},{"file":"tools/mkdevsitters","line":149,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Ah, ok cool.  Now that you\u0027ve explained that, I think I\u0027m indifferent on the subject, so I will defer to you.  I had no idea that someone may indeed want to switch back and forth, but then again, I haven\u0027t been working on manatee for very long."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":3,"deletions":-191},{"file":"docs/working-on-manatee.md","type":"ADDED","insertions":265,"deletions":0},{"file":"tools/mkdevsitters","type":"MODIFIED","insertions":93,"deletions":-10},{"file":"tools/mksitterconfig","type":"MODIFIED","insertions":44,"deletions":-7}],"sizeInsertions":405,"sizeDeletions":-208},{"number":"4","revision":"335cdcc625e97127028e4a495ed16eb26727416a","parents":["179a24faf5fac6c477d0459646c78c1fccf4fce8"],"ref":"refs/changes/71/3971/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1547468746,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547468778,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547679074,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547679074,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":3,"deletions":-191},{"file":"docs/working-on-manatee.md","type":"ADDED","insertions":304,"deletions":0},{"file":"tools/mkdevsitters","type":"MODIFIED","insertions":95,"deletions":-24},{"file":"tools/mksitterconfig","type":"MODIFIED","insertions":44,"deletions":-7}],"sizeInsertions":446,"sizeDeletions":-222},{"number":"5","revision":"35be0bca5871d9ba35f68c75b0ec1e8aa8538f42","parents":["9cf04af7d152c1dfc7e74342b530155a7697cd3e"],"ref":"refs/changes/71/3971/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1548147039,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548147072,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1548408506,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548176963,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548176963,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":3,"deletions":-191},{"file":"docs/working-on-manatee.md","type":"ADDED","insertions":304,"deletions":0},{"file":"tools/mkdevsitters","type":"MODIFIED","insertions":95,"deletions":-24},{"file":"tools/mksitterconfig","type":"MODIFIED","insertions":44,"deletions":-7}],"sizeInsertions":446,"sizeDeletions":-222}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}