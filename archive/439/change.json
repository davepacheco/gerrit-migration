{"project":"joyent/smartos-live","branch":"master","id":"Ibda83f42a0a11f3626c6136a780f501a9eaf9f61","number":"439","subject":"OS-5643 Rebooting KVM VMs sometimes causes vmadmd to leak zoneevent processes Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/439","commitMessage":"OS-5643 Rebooting KVM VMs sometimes causes vmadmd to leak zoneevent processes\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1473378772,"lastUpdated":1473877677,"open":false,"status":"MERGED","comments":[{"timestamp":1473378772,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1473378775,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit bdbedc72c58d9fe95abaa53e9b4f494b0e7ff6de\n    \n    OS-5643"},{"timestamp":1473378815,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473378828,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1473378866,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1473405889,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1473405891,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 12e173a13a51dfa7192917133266f55302d0a24e\n    \n    add .unref() as suggested by Julien"},{"timestamp":1473405910,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1473405951,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473405966,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473448321,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1473448705,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1473715671,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1473715673,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 16c2b39678fbc3a0696f90cf12300094f9fa9163\n    \n    It turns out the real problem (obvious in hind-sight) here was that when we call:\n    https://github.com/joyent/smartos-live/blob/release-20160901/src/vm/node_modules/VM.js#L3630-L3639\n    the first time, there\u0027s no global `zoneevent`, so we create that and a watcher\n    and return callback as a closure that has the correct watcher in it. The problem\n    is that the second time we call watchZoneTransitions() we already have a\n    watcher... so the cleanup() closure we pass back to that second caller doesn\u0027t\n    have the correct watcher in it. Instead it\u0027s undefined.\n    To fix this, I\u0027ve put the watcher on the zoneevent object. This way, we can\n    always create a cleanup closure with the correct watcher by using\n    zoneevent.watcher, even on subsequent calls to watchZoneTransitions()."},{"timestamp":1473715699,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1473715715,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473715738,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1473788351,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1473877412,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1473877574,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1473877653,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1473877658,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8: Commit message was updated."},{"timestamp":1473877677,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"8","revision":"a87a647e689807a39f4975f9e29de0c7f4318400","parents":["4bb69f554a4b60b03b888224e633dd3a235e51e9"],"ref":"refs/changes/39/439/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473877658,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473715738,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473788351,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473877412,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1473877677,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":62,"deletions":-51}],"sizeInsertions":62,"sizeDeletions":-51},"patchSets":[{"number":"1","revision":"2df24976e24354a64b4c60281eaf484a5dc2ef93","parents":["1601be5078dc64bcb860cd7f77d43915220b6cda"],"ref":"refs/changes/39/439/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473378772,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473378815,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":43,"deletions":-6}],"sizeInsertions":43,"sizeDeletions":-6},{"number":"2","revision":"dd877ddbd8d7e0ddfd2cf57c00f564f2a300247c","parents":["f592eaaa4d630b4a508c29940bf5f89ba4efcb95"],"ref":"refs/changes/39/439/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473378828,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473378815,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":43,"deletions":-6}],"sizeInsertions":43,"sizeDeletions":-6},{"number":"3","revision":"fa75ae848a617d06bf839cf0916bbe735646234c","parents":["1601be5078dc64bcb860cd7f77d43915220b6cda"],"ref":"refs/changes/39/439/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473405889,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473405951,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":45,"deletions":-6}],"sizeInsertions":45,"sizeDeletions":-6},{"number":"4","revision":"6e5b49435dddeec6f5ba2a79d16da54d98893eaa","parents":["f592eaaa4d630b4a508c29940bf5f89ba4efcb95"],"ref":"refs/changes/39/439/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473405910,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473405966,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":3653,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Nit: It might not hurt to move this function at the top level, since it doesn\u0027t use any of its enclosing function environment/context. That would prevent creating an instance of this function every time \"watchZoneTransitions\" is called."},{"file":"src/vm/node_modules/VM.js","line":3670,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Would it be helpful to make this value into a constant like REAPER_TIMEOUT_DELAY, since it\u0027s used in two different places?"},{"file":"src/vm/node_modules/VM.js","line":3681,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It might be useful to log.warn the return value of this process.kill and the value of watcher.killed after the call."},{"file":"src/vm/node_modules/VM.js","line":3682,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It\u0027s possible here that \"watcher\" will actually not be terminated due to the signal sent at 3681, so setting watcher to \"null\" here might leak a process too.\n\nInstead, maybe adding a listener on the \u0027close\u0027 event and setting the watcher to null when _both_ the \u0027close\u0027 and \u0027exit\u0027 event have been emitted is a more robust solution."},{"file":"src/vm/node_modules/VM.js","line":3753,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It\u0027s possible that the call to \"kill\" fail to terminate the watcher process, and that the process still need to be reaped. Instead maybe the timer should be cleared and the reference to \"watcher\" should be set to \"null\" only after the watcher process emitted _both_ \u0027close\u0027 and \u0027exit\u0027 events."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":45,"deletions":-6}],"sizeInsertions":45,"sizeDeletions":-6},{"number":"5","revision":"bda83f42a0a11f3626c6136a780f501a9eaf9f61","parents":["1601be5078dc64bcb860cd7f77d43915220b6cda"],"ref":"refs/changes/39/439/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473715671,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473715715,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":62,"deletions":-51}],"sizeInsertions":62,"sizeDeletions":-51},{"number":"6","revision":"69f0d79a508b8a3219113bf7d7d4200fa5fefe0e","parents":["64998c0b5a7c33287eb7dd118fef4aea42e5a6f3"],"ref":"refs/changes/39/439/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473715699,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473715738,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473788351,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473877412,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":62,"deletions":-51}],"sizeInsertions":62,"sizeDeletions":-51},{"number":"7","revision":"d86f28193a98132e5a5b7ca04552d6575d879da2","parents":["4bb69f554a4b60b03b888224e633dd3a235e51e9"],"ref":"refs/changes/39/439/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473877574,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473715738,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473788351,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473877412,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":62,"deletions":-51}],"sizeInsertions":62,"sizeDeletions":-51},{"number":"8","revision":"a87a647e689807a39f4975f9e29de0c7f4318400","parents":["4bb69f554a4b60b03b888224e633dd3a235e51e9"],"ref":"refs/changes/39/439/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1473877658,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1473715738,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1473877677,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1473788351,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1473877412,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":62,"deletions":-51}],"sizeInsertions":62,"sizeDeletions":-51}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}