From 1bd96f8db0b0b83a7f9b19c8f71befce3dda7460 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Wed, 2 May 2018 22:38:55 +0000
Subject: [PATCH] MORAY-469 moray getobject-done probe should pass req_id

---
 bin/snoop_bucket.d | 2 +-
 lib/dtrace.js      | 4 ++--
 lib/objects/get.js | 2 +-
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/bin/snoop_bucket.d b/bin/snoop_bucket.d
index a30b270..fdc1ef2 100755
--- a/bin/snoop_bucket.d
+++ b/bin/snoop_bucket.d
@@ -63,7 +63,7 @@ moray*:::getobject-done
 {
         printf("\n\nGET\n");
         printf("\tkey  => %s\n", key[arg0]);
-        printf("\tval  => %s\n", copyinstr(arg1));
+        printf("\tval  => %s\n", copyinstr(arg2));
         printf("\tcode => %s\n", code[arg0]);
         printf("\ttime => %dms\n", ((timestamp - req[arg0]) / 1000000));
 }
diff --git a/lib/dtrace.js b/lib/dtrace.js
index 52ae765..ef4a291 100644
--- a/lib/dtrace.js
+++ b/lib/dtrace.js
@@ -43,8 +43,8 @@ var PROBES = {
     // msgid, req_id, bucket, key
     'getobject-start': ['int', 'char *', 'char *', 'char *'],
 
-    // msgid, value
-    'getobject-done': ['int', 'char *'],
+    // msgid, req_id, value
+    'getobject-done': ['int', 'char *', 'char *'],
 
     // msgid, req_id, bucket, key
     'delobject-start': ['int', 'char *', 'char *', 'char *'],
diff --git a/lib/objects/get.js b/lib/objects/get.js
index 985e741..47afd0a 100644
--- a/lib/objects/get.js
+++ b/lib/objects/get.js
@@ -176,7 +176,7 @@ function get(options) {
             cbOutput: function () { return req.object; },
             cbProbe: function () {
                 var val = JSON.stringify(req.object);
-                return ([req.msgid, val]);
+                return ([req.msgid, req.req_id, val]);
             }
         });
     }
-- 
2.21.0

