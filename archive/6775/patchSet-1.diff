From fb9d8084fb81acaeb82b01895f3ff641244bbf4f Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex@uq.edu.au>
Date: Fri, 9 Aug 2019 14:11:29 +1000
Subject: [PATCH] joyent/node-mahi#3 filtering of roles to ones from the owning
 account should be done in libmahi, not in muskie/marlin

---
 lib/auth.js  | 19 ++++++-------------
 package.json |  2 +-
 2 files changed, 7 insertions(+), 14 deletions(-)

diff --git a/lib/auth.js b/lib/auth.js
index 4d7172a..590578d 100644
--- a/lib/auth.js
+++ b/lib/auth.js
@@ -950,17 +950,6 @@ function getActiveRoles(req, res, next) {
             activeRoles = caller.user.defaultRoles || [];
         } else {
             activeRoles = caller.account.defaultRoles || [];
-            /*
-             * Account default roles might include roles that aren't actually
-             * for this account. We filter out ones that don't match here to
-             * avoid wasting time considering them, and to make the error
-             * message when we deny access the same as it was before
-             * cross-account role support.
-             */
-            activeRoles = activeRoles.filter(function (role) {
-                return (caller.roles[role].account ===
-                    owner.account.uuid);
-            });
         }
         if (readerRole) {
             /*
@@ -1130,12 +1119,16 @@ function authorize(req, res, next) {
             return;
         case 'NoMatchingRoleTag':
             /*
-             * If we didn't activate any roles, we want to return an
+             * If we didn't activate any owner roles, we want to return an
              * AuthorizationError here, like we would have previously if we
              * got a CrossAccount Error before cross-account role support was
              * added.
              */
-            if (!req.activeRoles || !req.activeRoles.length) {
+            var ownerRoles = (req.activeRoles || []).filter(function (role) {
+                return (req.caller.roles[role].account ===
+                    req.owner.account.uuid);
+            });
+            if (!ownerRoles.length) {
                 next(new AuthorizationError(login, req.path(), e));
             } else {
                 next(new NoMatchingRoleTagError());
diff --git a/package.json b/package.json
index dbacf73..2b90ea0 100644
--- a/package.json
+++ b/package.json
@@ -32,7 +32,7 @@
         "libuuid": "0.1.2",
         "lru-cache": "4.1.5",
         "lstream": "0.0.4",
-        "mahi": "2.3.0",
+        "mahi": "2.3.1",
         "marlin": "git+https://github.com/joyent/manta-marlin.git#master",
         "mime": "1.2.11",
         "moray": "3.4.1",
-- 
2.21.0

