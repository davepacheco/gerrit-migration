{"project":"joyent/sdc-cloudapi","branch":"master","topic":"triton-vnc","id":"I1e2135ce727fbbf5067e81463a388045df8d1c7a","number":"2980","subject":"PUBAPI-804 Provide access to KVM Console for end users","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/2980","commitMessage":"PUBAPI-804 Provide access to KVM Console for end users\n","createdOn":1511308916,"lastUpdated":1562886098,"open":true,"status":"NEW","comments":[{"timestamp":1511308916,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1511308947,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1511309763,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\nbuilt as image 199fe9da-cf1a-11e7-8cce-3b756bab02ed"},{"timestamp":1511338318,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(16 comments)"},{"timestamp":1511338374,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\nAnd the obvious comment about tests and docs. :)"},{"timestamp":1511383382,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1511383406,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(5 comments)\n\nTests still to come, but I\u0027ve added docs now."},{"timestamp":1511383412,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512008129,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1512008160,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512010174,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3:\n\n(2 comments)\n\nJust docs now. Looking forward to it. :D"},{"timestamp":1549478551,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Topic set to triton-vnc"},{"timestamp":1562855672,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n(4 comments)\n\nSome comments made. Minor all of them but the required rebase. Do you want me to help on that?"},{"timestamp":1562886021,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\nYeah, it\u0027s all yours, Pedro. Re-push it however you want."},{"timestamp":1562886098,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(1 comment)"}],"currentPatchSet":{"number":"3","revision":"1e2135ce727fbbf5067e81463a388045df8d1c7a","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/80/2980/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1512008129,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512008160,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":723,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Do we actually support it for this time w/o having mentioned it?"},{"file":"docs/index.md","line":723,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes, we\u0027ve supported ECDSA for auth since PUBAPI-1186 in 2015"},{"file":"lib/endpoints/vnc.js","line":8,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Obvious changes for C here"},{"file":"package.json","line":4,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"This file obviously need a rebase and a version bump above current \"9.7.1\"."},{"file":"test/auth.test.js","line":86,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Just curious why not:\n\nvar params \u003d {\n    algorithm: ... \n    expires: ...\n    keyId: ...\n};"},{"file":"test/auth.test.js","line":86,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027m curious here too ;-)"},{"file":"test/auth.test.js","line":173,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Maybe also add a check for OTHER.privateKey? Just to be safe?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":89,"deletions":-8},{"file":"lib/app.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":124,"deletions":-1},{"file":"lib/endpoints/vnc.js","type":"ADDED","insertions":304,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":22,"deletions":-19},{"file":"test/auth.test.js","type":"MODIFIED","insertions":99,"deletions":0}],"sizeInsertions":644,"sizeDeletions":-28},"patchSets":[{"number":"1","revision":"1b85af3f37f6e2f84b3d00127b88e671eccb4f77","parents":["d0efd0f0114bfa31eb881f7445037ae93a99f566"],"ref":"refs/changes/80/2980/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1511308916,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511308947,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":469,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"We\u0027re confident this won\u0027t cause problems for existing endpoints?"},{"file":"lib/app.js","line":469,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Well, currently if you send an Upgrade request to cloudapi it hangs forever (since it emitted the \u0027upgrade\u0027 event and then never handled it). This makes upgrade requests now be passed to handlers and return e.g. 404 if you asked for a URI that doesn\u0027t map to anything. It doesn\u0027t change any other behaviour."},{"file":"lib/auth.js","line":688,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"A comment to explain what\u0027s going on here?"},{"file":"lib/auth.js","line":696,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Maybe consider jsprim\u0027s parseInt()"},{"file":"lib/auth.js","line":696,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yeah, good call since I\u0027m pretty sure this is wrong without an isFinite check, too."},{"file":"lib/auth.js","line":711,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Superfluous \\n"},{"file":"lib/auth.js","line":722,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Given how often req.query is used in this function, I\u0027d assign it to reqQuery at the top."},{"file":"lib/auth.js","line":743,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Consider naming the anonymous functions here."},{"file":"lib/endpoints/vnc.js","line":25,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Cloudapi has this at the end for all other files. Your call if you want to move it."},{"file":"lib/endpoints/vnc.js","line":63,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Why not undefined?"},{"file":"lib/endpoints/vnc.js","line":74,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Aren\u0027t domains deprecated?\n\nIn any case, given that domain code is pretty rare, please add a comment here on what\u0027s happening."},{"file":"lib/endpoints/vnc.js","line":74,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"This is only here because we have domains enabled in restify for cloudapi still. So I have to exit the domain for this FSM, or else errors get swallowed up and lost because restify has already answered the request (by us claiming the upgrade). I\u0027ll add a comment."},{"file":"lib/endpoints/vnc.js","line":76,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"From here to the end of the file: mamma mia, are we running out of newlines? :p"},{"file":"lib/endpoints/vnc.js","line":77,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Please name all the top-level anonymous functions in this FSM."},{"file":"lib/endpoints/vnc.js","line":110,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This is unreachable code due to the check in connectVNC()?"},{"file":"lib/endpoints/vnc.js","line":110,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yeah. I might move all of this up there."},{"file":"lib/endpoints/vnc.js","line":114,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This is probably worth asserting on."},{"file":"lib/endpoints/vnc.js","line":122,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Given that rejectsock can only arrive from upgrade, the dance around this.err seems unnecessary. Create the InternalServerError here instead, and toss the conditionals?"},{"file":"lib/endpoints/vnc.js","line":145,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Could you elaborate a bit on what\u0027s going on here? restify continues off on its own way, and this FSM exists concurrently?"},{"file":"lib/endpoints/vnc.js","line":145,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes. From restify\u0027s perspective the request ends when we give the 101 return code back and upgrade the socket. This is how the claimUpgrade() process is meant to work. The socket gets broken off and becomes ours and restify never touches it again."},{"file":"lib/endpoints/vnc.js","line":151,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Name function."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":114,"deletions":-1},{"file":"lib/endpoints/vnc.js","type":"ADDED","insertions":289,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":23,"deletions":-21}],"sizeInsertions":432,"sizeDeletions":-22},{"number":"2","revision":"281b4cf664874855aa5513c08945f066edc2e5d3","parents":["d0efd0f0114bfa31eb881f7445037ae93a99f566"],"ref":"refs/changes/80/2980/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1511383382,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1511383412,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":89,"deletions":-8},{"file":"lib/app.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":124,"deletions":-1},{"file":"lib/endpoints/vnc.js","type":"ADDED","insertions":304,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":23,"deletions":-21}],"sizeInsertions":546,"sizeDeletions":-30},{"number":"3","revision":"1e2135ce727fbbf5067e81463a388045df8d1c7a","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/80/2980/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1512008129,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512008160,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":723,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Do we actually support it for this time w/o having mentioned it?"},{"file":"docs/index.md","line":723,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes, we\u0027ve supported ECDSA for auth since PUBAPI-1186 in 2015"},{"file":"lib/endpoints/vnc.js","line":8,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Obvious changes for C here"},{"file":"package.json","line":4,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"This file obviously need a rebase and a version bump above current \"9.7.1\"."},{"file":"test/auth.test.js","line":86,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Just curious why not:\n\nvar params \u003d {\n    algorithm: ... \n    expires: ...\n    keyId: ...\n};"},{"file":"test/auth.test.js","line":86,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027m curious here too ;-)"},{"file":"test/auth.test.js","line":173,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Maybe also add a check for OTHER.privateKey? Just to be safe?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":89,"deletions":-8},{"file":"lib/app.js","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":124,"deletions":-1},{"file":"lib/endpoints/vnc.js","type":"ADDED","insertions":304,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":22,"deletions":-19},{"file":"test/auth.test.js","type":"MODIFIED","insertions":99,"deletions":0}],"sizeInsertions":644,"sizeDeletions":-28}],"allReviewers":[{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Joyent Automation","username":"joyent-automation"}]}