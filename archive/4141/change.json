{"project":"joyent/manatee","branch":"master","topic":"MANATEE-400","id":"I179a24faf5fac6c477d0459646c78c1fccf4fce8","number":"4141","subject":"MANATEE-400 Manatee deleterious when dataset will not unmount MANATEE-405 snapshotter should not enter maintenance when dataset does not exist Reviewed by: Kody A Kantor \u003ckody@kkantor.com\u003e Reviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e Approved by:","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/4141","commitMessage":"MANATEE-400 Manatee deleterious when dataset will not unmount\nMANATEE-405 snapshotter should not enter maintenance when dataset does not exist\nReviewed by: Kody A Kantor \u003ckody@kkantor.com\u003e\nReviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1528218194,"lastUpdated":1535396060,"open":false,"status":"MERGED","comments":[{"timestamp":1528218194,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1528218225,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528220947,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1528220978,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528325642,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\n(13 comments)\n\nA lot of this looks good to me. Are snapshot utility functions like \u0027deleteSnapshot\u0027 and \u0027getSnapshots\u0027 candidates for inclusion in lib_common?"},{"timestamp":1528390762,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1528390794,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528390837,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(13 comments)\n\n\u003e A lot of this looks good to me. Are snapshot utility functions like\n \u003e \u0027deleteSnapshot\u0027 and \u0027getSnapshots\u0027 candidates for inclusion in\n \u003e lib_common?\n\nI think we could do some more work in the future to migrate the \"zfs\" invocations in the snapshotter over to the use of the common.js functions, but I\u0027d rather not add that to this change right now."},{"timestamp":1528390878,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Topic set to MANATEE-400"},{"timestamp":1528399263,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(10 comments)\n\nGreat! This is much cleaner and easier to follow."},{"timestamp":1533165020,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4."},{"timestamp":1533165052,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533165138,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(6 comments)"},{"timestamp":1533168486,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5."},{"timestamp":1533168518,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1533169112,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1533223752,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1533233538,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1533233796,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1534804666,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 6."},{"timestamp":1534804693,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1534804697,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1534862590,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 6: Code-Review+1\n\nLooks good!"},{"timestamp":1534903616,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 6:\n\n(1 comment)\n\nThis looks good to me! The code is a lot easier to follow. I have a pretty minor suggestion."},{"timestamp":1534903632,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1535070730,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6:\n\nBroadly, I think the testing looks thorough. I have a few questions:\n- The testing notes mention installing the image in a fresh Manta installation for a Postgres 9.2 cluster, but most of the extensive testing was on 9.6 clusters. I understand that this change will almost certainly be deployed to deployments running 9.6 first, but I imagine we would eventually want to deploy it everywhere, including deployments with 9.2. Do we expect we will upgrade Postgres in those deployments to 9.6 before deploying this change? If not, should some of the testing be repeated for 9.2? (This type of tesing could probably be delayed if needed until deploying this image in 9.2 deployments is scheduled, and it seems such testing could be performed by the QA team as well.)\n- The testing notes mention using `mlive` to generate load but doesn\u0027t mention whether mlive saw any errors during the testing. Presumably it did not see any notable errors? If so, I think that should be mentioned in the notes.\n- Another minor thing: It looks like manatee has a test suite. Do those tests pass?"},{"timestamp":1535395265,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6:\n\n\u003e Broadly, I think the testing looks thorough. I have a few\n \u003e questions:\n \u003e - The testing notes mention installing the image in a fresh Manta\n \u003e installation for a Postgres 9.2 cluster, but most of the extensive\n \u003e testing was on 9.6 clusters. I understand that this change will\n \u003e almost certainly be deployed to deployments running 9.6 first, but\n \u003e I imagine we would eventually want to deploy it everywhere,\n \u003e including deployments with 9.2. Do we expect we will upgrade\n \u003e Postgres in those deployments to 9.6 before deploying this change?\n \u003e If not, should some of the testing be repeated for 9.2? (This type\n \u003e of tesing could probably be delayed if needed until deploying this\n \u003e image in 9.2 deployments is scheduled, and it seems such testing\n \u003e could be performed by the QA team as well.)\n\nI have re-run the relevant test actions on a PostgreSQL 9.2 system without incident, and updated the testing notes.\n\n \u003e - The testing notes mention using `mlive` to generate load but\n \u003e doesn\u0027t mention whether mlive saw any errors during the testing.\n \u003e Presumably it did not see any notable errors? If so, I think that\n \u003e should be mentioned in the notes.\n\nI have clarified this in the testing notes.\n\n \u003e - Another minor thing: It looks like manatee has a test suite. Do\n \u003e those tests pass?\n\nAfter investigation, the parts of the test suite that run for \"make test\" do very little other than confirm various \"manatee-adm\" behaviour, none of which is changing here.  Nonetheless, \"make test\" does pass!"},{"timestamp":1535395981,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6: Integration-Approval+1\n\nThanks for the testing updates. Approved!"},{"timestamp":1535396040,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1535396060,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"7","revision":"179a24faf5fac6c477d0459646c78c1fccf4fce8","parents":["58d2c51af324f21d08e27bfb723554924bc152d9"],"ref":"refs/changes/41/4141/7","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1535396040,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534804697,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534862590,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534903632,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535395981,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1535396060,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":61,"deletions":-22},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":371,"deletions":-279},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":33,"deletions":-2},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":507,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":1450,"sizeDeletions":-731},"patchSets":[{"number":"1","revision":"45f6b2dcbe07965614ba5c5acde9e037b942b158","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/41/4141/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1528218194,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528218225,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":61,"deletions":-23},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":367,"deletions":-277},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":521,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":1453,"sizeDeletions":-727},{"number":"2","revision":"76879e5e8c4efe0d0fdcfec55409d30583a16213","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/41/4141/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1528220947,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528220978,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":1514,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is there any value in distinguishing datasets isolated via manatee-adm rebuild from those isolated automatically by a sitter going into standby mode (postgresMgr.js L137)? I\u0027m imagining the unlikely scenario where for some reason the sync restore fails during the zfs_recv and leaves behind the isolated dataset in the same parent dataset as one that was isolated in this codepath."},{"file":"lib/adm.js","line":1514,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yeah, I did think about this a little but I couldn\u0027t think of a good name that wasn\u0027t longer.  I\u0027ve sucked it up, though, and changed the other one to \"autorebuild\"!"},{"file":"lib/common.js","line":204,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Mentioned this elsewhere, but should we support the \u0027-r\u0027 option here?"},{"file":"lib/common.js","line":204,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think it\u0027s needed at the moment, but we can always add it in the future."},{"file":"lib/postgresMgr.js","line":1329,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"nit: I\u0027d want this to be more descriptive, but I can\u0027t think of a better name. \u0027res\u0027 just seems overloaded in this waterfall."},{"file":"lib/postgresMgr.js","line":1329,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/zfsClient.js","line":182,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Why do we not use ZfsClient#snapshotDataset here?"},{"file":"lib/zfsClient.js","line":182,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/zfsClient.js","line":297,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is it worth embedding this sort of validation in lib_common? I\u0027m imagining a kind of schema-validating library function that accepts a dictionary of desired property values and a dataset identifier and ensures that the dataset has those values before returning. Might be overkill."},{"file":"lib/zfsClient.js","line":297,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I thought about this a bit at the time, but in the end it broke down on the third function (where we check that \"mounted\" is \"yes\", and if not, call \"zfsMount()\" instead of \"zfsSet()\").\n\nIf we end up doing a lot more of it, we could perhaps invest in a higher-level mechanism, but I think it\u0027s relatively explicit and easy to understand as it is now."},{"file":"lib/zfsClient.js","line":424,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is there a reason we do this after checking /etc/mnttab? I don\u0027t think it necessarily needs to be changed. It just seems like work we might be able to get away with even if the dataset is mounted in the wrong place."},{"file":"lib/zfsClient.js","line":424,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes.  This operation is intended to mutate only files in the Manatee-managed dataset, not files in the root file system of the zone.  If we\u0027re not absolutely sure that the dataset is mounted at this point, we might accidentally change the mode bits on the mountpoint directory underneath where the dataset should be mounted -- and I\u0027d prefer ownership on that directory remains root:root so that PostgreSQL (running as \"postgres\") can\u0027t accidentally start up without a dataset mounted."},{"file":"lib/zfsClient.js","line":479,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"\u0027-r\u0027 also destroys child datasets right? Not sure it\u0027s worth mentioning."},{"file":"lib/zfsClient.js","line":479,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It does, but: there won\u0027t be any child datasets, and this comment is really about our motivation for using recursive, which is in case there are snapshots."},{"file":"lib/zfsClient.js","line":492,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"If the existence check on line 464 fails with some error destroy will be undefined right?"},{"file":"lib/zfsClient.js","line":492,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It will, but we will also have bailed out in the \"if (err)\" block of this function before we get to the assertion."},{"file":"lib/zfsClient.js","line":553,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"nit: this is already set to false on L530. Not sure if it\u0027s repeated here for clarity."},{"file":"lib/zfsClient.js","line":553,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It\u0027s for clarity, really."},{"file":"lib/zfsClient.js","line":567,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"After this change, will it be true that all non-isolated datasets managed by Manatee have canmount\u003dnoauto?"},{"file":"lib/zfsClient.js","line":567,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"That is true, but I think it\u0027s also true today; e.g., in staging Manta:\n\n    [root@a4c27bf3 (postgres) ~]$ zfs list -o name,canmount |\n        sed \"s/$(zonename)/.../g\" | column -t\n    NAME                    CANMOUNT\n    zones                   on\n    zones/...               on\n    zones/.../data          on\n    zones/.../data/manatee  noauto\n\nWe used to do this in at least five different places in \"lib/zfsClient.js\", and also in the first-boot script for the zone: https://github.com/joyent/manta-manatee/blob/master/boot/setup.sh#L102-L104\n\nI\u0027m cleaning up the ZFS management in \"setup.sh\" in the other change for this bug, as it\u0027s totally redundant: https://cr.joyent.us/4152"},{"file":"lib/zfsClient.js","line":581,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"s/seting/setting"},{"file":"lib/zfsClient.js","line":581,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/zfsClient.js","line":605,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Do we care about potential children of the dataset we are clearing the mountpoint here? From my reading of the zfs man page, I understood the mountpoint property to be inherited by children accordingly (which means they will be remounted), but it seems that other properties might only be inherited if the \u0027-r\u0027 option is passed to zfs inherit."},{"file":"lib/zfsClient.js","line":605,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"With the current design, there shouldn\u0027t ever be a child dataset.  The software certainly won\u0027t create one by itself.  I think it\u0027s possible a lot of other things would break before this if somebody manually created a child under the Manatee-managed dataset."},{"file":"lib/zfsClient.js","line":628,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It\u0027s possible for us to clear the mountpoint on L608 and then fail during the zfsRename on L624 right? Is it too complicated to roll things back to the state they were before the function call if so?"},{"file":"lib/zfsClient.js","line":628,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think it\u0027s worth trying to roll back, merely to report the failure.  The overall design of the system needs to reflect (and deal with) partial failures of these operations.\n\nIn the case of a failure after clearing the mountpoint but before renaming, I believe another attempt to isolate (on the next try to rebuild, or the next time the operator runs \"manatee-adm rebuild\") would then do the right thing -- assuming whatever condition prevented the original rename was transient."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":62,"deletions":-23},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":367,"deletions":-277},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":521,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":1454,"sizeDeletions":-727},{"number":"3","revision":"4ee8ed3e6064ce42c8041fa5d3bdd093a3e726a1","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/41/4141/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1528390762,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528390794,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":117,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It seems like we could combine chown and chmod into a single function with a couple \u0027if\u0027 switches. Having them separate is a little more clear from the caller\u0027s perspective though, I suppose.\n\nSame goes for a lot of the zfs operations. But I think you\u0027re going for caller clarity here."},{"file":"lib/common.js","line":117,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yeah most of these functions are pretty verbose in their implementation, but it\u0027s all an attempt to try and provide something closer to Javascript-level type safety for the call sites in other places."},{"file":"lib/postgresMgr.js","line":1173,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"haha. Nice."},{"file":"lib/postgresMgr.js","line":1253,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"While you\u0027re at it you could replace this with a \u0027/* */\u0027 comment and s/other wise/otherwise. You definitely don\u0027t have to though."},{"file":"lib/postgresMgr.js","line":1253,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/postgresMgr.js","line":1767,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Some of these functions have names and some don\u0027t. It would be nice for readability and debugging if the functions all had names, but it\u0027s not critical."},{"file":"lib/postgresMgr.js","line":1767,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"A lot of the names end up being pretty arbitrary, and I think readability is more improved by good use of whitespace and comments.\n\nAs for debugging I think the most useful thing for Manatee ends up being the logging, and I\u0027ve tried to make better use of chained VError so that the logs are more helpful; e.g.,\n\n    21:19:29.750Z ERROR manatee-sitter/PostgresMgr: standby transition failed (op\u003d\"standby transition\", primaryUrl\u003dtcp://postgres@10.77.77.82:5432/postgres, backupUrl\u003dhttp://10.77.77.82:12345)\n        VError: mounting dataset \"zones/2f71f413-405e-4ba0-81e7-092c2c19aa4a/data/manatee\" at \"/manatee/pg\": mount dataset \"zones/2f71f413-405e-4ba0-81e7-092c2c19aa4a/data/manatee\": exec \"/sbin/zfs mount zones/2f71f413-405e-4ba0-81e7-092c2c19aa4a/data/manatee\": exited with status 1: cannot mount \u0027zones/2f71f413-405e-4ba0-81e7-092c2c19aa4a/data/manatee\u0027: mountpoint or dataset is busy\n            at /opt/smartdc/manatee/node_modules/manatee/lib/zfsClient.js:429:22"},{"file":"lib/zfsClient.js","line":11,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"(It doesn\u0027t matter to me, but I notice this is the only file that you\u0027re pitching the manatee ascii art from :) )"},{"file":"lib/zfsClient.js","line":11,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think it belongs in the README but probably not all over the source.  I\u0027m also too tired to clean up the other ones at this point."},{"file":"lib/zfsClient.js","line":492,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"s/did/does to match the tense of other statements?"},{"file":"lib/zfsClient.js","line":554,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Why not invoke the callback with an error? That way we wouldn\u0027t have to do the\n\nif (!isolate)\n\ndance in the following functions. You could do a verror.hasCauseWithName on the error to make sure the \u0027preserving dataset\u0027 line doesn\u0027t execute in this case. If that error was then passed up to the caller (adm.js) we could use hasCauseWithName on the error instead of checking that name \u003d\u003d\u003d null."},{"file":"lib/zfsClient.js","line":554,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/zfsClient.js","line":587,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Can we pitch this line since we assert that the string is required on line 588?"},{"file":"lib/zfsClient.js","line":587,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"package.json","line":52,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"So do we still need shelljs for something?"},{"file":"package.json","line":52,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It would appear to be in use in some of the tests:\n\n    package.json:        \"shelljs\": \"0.0.5pre4\",\n    test/integ.test.js:var shelljs \u003d require(\u0027shelljs\u0027);\n    test/testManatee.js:var shelljs \u003d require(\u0027shelljs\u0027);\n    test/testManatee.js:            shelljs.mkdir(\u0027-p\u0027, opts.mountPoint);\n    test/testManatee.js:            shelljs.mkdir(\u0027-p\u0027, opts.mountPoint + \u0027/data\u0027);\n    test/testManatee.js:            shelljs.mkdir(\u0027-p\u0027, self.configLocation + \u0027/data\u0027);\n    test/testManatee.js:            shelljs.mkdir(\u0027-p\u0027, self.logLocation);\n    test/testManatee.js:            shelljs.mkdir(\u0027-p\u0027, self.configLocation);"},{"file":"sitter.js","line":8,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"update copyright?"},{"file":"sitter.js","line":8,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":62,"deletions":-23},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":367,"deletions":-277},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":520,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":1,"deletions":-5}],"sizeInsertions":1453,"sizeDeletions":-727},{"number":"4","revision":"18bfde0070e4c89a142f46c4df87dd7e945eba79","parents":["58d2c51af324f21d08e27bfb723554924bc152d9"],"ref":"refs/changes/41/4141/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1533165020,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533165052,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":61,"deletions":-22},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":371,"deletions":-279},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":520,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":1457,"sizeDeletions":-729},{"number":"5","revision":"4b499c86686861d2407284dbbaa989d1541ac5eb","parents":["58d2c51af324f21d08e27bfb723554924bc152d9"],"ref":"refs/changes/41/4141/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1533168486,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1533168518,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/snapShotter.js","line":199,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks like cb isn\u0027t called if the dataset doesn\u0027t exist. I can\u0027t tell if this is by design or not, but it seems like we\u0027d have vasync pipelines pile up in this case.\n\nI suppose if you wanted to you could invoke cb with an error  and let the final pipeline callback function start the cleanup timeout. Maybe you\u0027d have to make a little change to have it log the particular error at \u0027info\u0027 and not \u0027error\u0027 though."},{"file":"lib/snapShotter.js","line":199,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Do they not just fall out of scope and get garbage collected, the same as if we made it all the way to the end?"},{"file":"lib/snapShotter.js","line":199,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Could be, I\u0027ve never checked. I thought that we always liked to explicitly reach the end of these things."},{"file":"lib/snapShotter.js","line":199,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":61,"deletions":-22},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":371,"deletions":-279},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":27,"deletions":0},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":507,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":1444,"sizeDeletions":-729},{"number":"6","revision":"d32800a1e9e031a9cc979b4eb70a1f0ebabfedd5","parents":["58d2c51af324f21d08e27bfb723554924bc152d9"],"ref":"refs/changes/41/4141/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1534804666,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534804697,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535395981,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534862590,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534903632,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"comments":[{"file":"lib/zfsClient.js","line":504,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It looks like there are some different values passed in as the prefix argument. Is there an exhaustive list of these somewhere? Where the prefixes have some meaning (i.e. \u0027autorebuild\u0027, vs \u0027rebuild\u0027), would it be useful to include an explanation of what they indicate? I could see it being useful if we are debugging and looking at the list of zfs datasets in a manatee zone."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":61,"deletions":-22},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":371,"deletions":-279},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":33,"deletions":-2},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":507,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":1450,"sizeDeletions":-731},{"number":"7","revision":"179a24faf5fac6c477d0459646c78c1fccf4fce8","parents":["58d2c51af324f21d08e27bfb723554924bc152d9"],"ref":"refs/changes/41/4141/7","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1535396040,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1535396060,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534804697,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535395981,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534862590,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534903632,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":61,"deletions":-22},{"file":"lib/backupSender.js","type":"MODIFIED","insertions":1,"deletions":-4},{"file":"lib/backupServer.js","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"lib/common.js","type":"ADDED","insertions":468,"deletions":0},{"file":"lib/postgresMgr.js","type":"MODIFIED","insertions":371,"deletions":-279},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":33,"deletions":-2},{"file":"lib/statusServer.js","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"lib/zfsClient.js","type":"MODIFIED","insertions":507,"deletions":-405},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sitter.js","type":"MODIFIED","insertions":2,"deletions":-6}],"sizeInsertions":1450,"sizeDeletions":-731}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}