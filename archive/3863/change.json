{"project":"joyent/sdc-imgapi","branch":"master","id":"I5494dd602518e2a2f68aff4d2e6947dce83c0e71","number":"3863","subject":"TRITON-52 x-DC image copy Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/3863","commitMessage":"TRITON-52 x-DC image copy\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1524519234,"lastUpdated":1530315699,"open":false,"status":"MERGED","comments":[{"timestamp":1524519234,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1524519235,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 09ff289c7e19aa5f8a00da5441eb743d78a28873\n    \n    TRITON-52 x-DC image copy"},{"timestamp":1524519265,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1524519272,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1524519274,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit b04a9ecd3cfb13396e41ebad096aa6a546bbd86b\n    \n    TRITON-52 x-DC image copy"},{"timestamp":1524519304,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1524611854,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1526683248,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3."},{"timestamp":1526683249,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit d315607636d5d6a100a7bc41782dd1efd3165e49\n    \n    Validate images before passing to AdminImportImage"},{"timestamp":1526683278,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526683526,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\n(3 comments)\n\nNew changes will now validate the image - ensuring the account is the owner, and that you cannot import an admin image. Then when all is good it\u0027ll pass on to AdminImportImage to do the work.\n\nBTW - ignore the \"test/...\" changes at the moment, I didn\u0027t mean to commit that yet - I have a bunch of tests to include, which also moves test image files around."},{"timestamp":1527551815,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 4."},{"timestamp":1527551816,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 647badd431f04a1ada644f3ed4bfb9ec0a47cc82\n    \n    use datacenter instead of dc, add tests"},{"timestamp":1527551846,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527624479,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 5."},{"timestamp":1527624481,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit d3855b4de4e09d842af16657317453e02b716bcd\n    \n    handle UnauthorizedError during file import\n    \n    commit 678ac671acbee453711bfffcc8095e2b110106ac\n    \n    use imgapi test base image uuid\n    \n    commit ca6be5a8f7eafa086fbd04e5db28a4c03bc05326\n    \n    fix error format call - missing uuid argument"},{"timestamp":1527624511,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527624563,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 5:\n\nTests all passing.\n\nOK: 470 assertions (57817ms)"},{"timestamp":1528144115,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1528144117,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 6011b01e2716ad455d64bb5f617c62f53e0b6b45\n    \n    handle UnauthorizedError during file import\n    \n    commit 9aced281e5d3d76c3b1fc894ff301bd65f7d7c97\n    \n    use imgapi test base image uuid\n    \n    commit e2c6d4224bd1059c13f4edfc4331fc82a6a0bb2f\n    \n    fix error format call - missing uuid argument\n    \n    commit 77e67b3ad33846b63cd3e19e77f360d788559378\n    \n    use datacenter instead of dc, add tests\n    \n    commit 0eedb6d6746ff3875091a39eba0f719fbb2fb1e1\n    \n    Validate images before passing to AdminImportImage\n    \n    commit c9a8f1160da4316921556a94ea28b437a9712292\n    \n    TRITON-52 x-DC image copy"},{"timestamp":1528144146,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1528237701,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(17 comments)"},{"timestamp":1528498828,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 6:\n\n(17 comments)"},{"timestamp":1528498841,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 7."},{"timestamp":1528498843,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 4250ba5473d064424e23e1ce41a3f1035481a3a1\n    \n    validate manta file location, fixup indentation, cr tweaks\n    \n    commit 033b6fbe8f01d9a66564bca316f43c7e9fa947a5\n    \n    update ImportFromDatacenter docs"},{"timestamp":1528498871,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529103343,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 8."},{"timestamp":1529103344,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit ac023ff52f6d255e8f284cb05497ddd9d179e9d1\n    \n    specify MOCK_IMGAPI_PORT for where the mock imgapi server will run"},{"timestamp":1529103378,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529605210,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 9."},{"timestamp":1529605213,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit d734bf491b93ee4133587343bfa34e3314448673\n    \n    specify MOCK_IMGAPI_PORT for where the mock imgapi server will run\n    \n    commit 8b63a5dc3ecdd69ed566435743c5bc539876e440\n    \n    validate manta file location, fixup indentation, cr tweaks\n    \n    commit 869e7165cea9f37cc61fdbea4a9de67c999d4be9\n    \n    update ImportFromDatacenter docs\n    \n    commit 369f8b4d8cf6a9e13c7cff6bcae42c411b09336f\n    \n    handle UnauthorizedError during file import\n    \n    commit c4a02744fabde57cc51a7a2c8052080256cb82df\n    \n    use imgapi test base image uuid\n    \n    commit 57adda7bf076483cca76c7517f081715a9b96dd8\n    \n    fix error format call - missing uuid argument\n    \n    commit f7b1b39d38438f7b69a5a3c79742604827e13f52\n    \n    use datacenter instead of dc, add tests\n    \n    commit 3574dd006250fb253dc3179cb23aea7c19d79bf9\n    \n    Validate images before passing to AdminImportImage\n    \n    commit 1b893a42d49a9cdcfb602b12924243a0182be3b2\n    \n    TRITON-52 x-DC image copy"},{"timestamp":1529605243,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530146044,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 10."},{"timestamp":1530146046,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 95b8427d4177d33e0e9677c7b6e728834848d83e\n    \n    bump sdc-clients version\n    \n    commit 9d9e9ab78108843b7f07cd7f28319b41a939d025\n    \n    specify MOCK_IMGAPI_PORT for where the mock imgapi server will run\n    \n    commit c3b359b52004cea7c4d78335dfbfaec7b7a99740\n    \n    validate manta file location, fixup indentation, cr tweaks\n    \n    commit 583a939c822c3397d98818c6a3c7385e96df0633\n    \n    update ImportFromDatacenter docs\n    \n    commit 4ef2e1d9f0c5daa5c4a4a945fab4b1903ceb319a\n    \n    handle UnauthorizedError during file import\n    \n    commit 93b360320b81ce9b9c3336e2e7ef78251532d235\n    \n    use imgapi test base image uuid\n    \n    commit b698594d07f111c4afe9e36ae43588a1a53609e4\n    \n    fix error format call - missing uuid argument\n    \n    commit 51d958434fe7d61afc18d47ee9224b39745b8dfa\n    \n    use datacenter instead of dc, add tests\n    \n    commit b6902e17e0b77478a832dc3d828fc14b99359e24\n    \n    Validate images before passing to AdminImportImage\n    \n    commit 9dfecf3a756feeabd0c59c2c105b5fe4ee04d156\n    \n    TRITON-52 x-DC image copy"},{"timestamp":1530146081,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530155516,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 11: Patch Set 10 was rebased."},{"timestamp":1530155517,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit f5e6a0104192330ccb022c21c3d0dd76d1e72722\n    \n    bump sdc-clients version\n    \n    commit 3757689a105ee965d8a5962bdc0554348569ead9\n    \n    specify MOCK_IMGAPI_PORT for where the mock imgapi server will run\n    \n    commit bc8e1cc8321e61e142a5e057e3b6b164e1d67706\n    \n    validate manta file location, fixup indentation, cr tweaks\n    \n    commit ee5dd8eefea83d57d970a4e95d03eb54b4ead5e4\n    \n    update ImportFromDatacenter docs\n    \n    commit e98990ed8d94226732feb65f6b0fa404cc7275ed\n    \n    handle UnauthorizedError during file import\n    \n    commit 7e9b1fe74b22dd487d5ef9f308d76bb52300b7aa\n    \n    use imgapi test base image uuid\n    \n    commit 23c67ade8d1fb9069240fde825382b81e8d277c5\n    \n    fix error format call - missing uuid argument\n    \n    commit b986b8ecb86e345c08a925719f7f2e1dba59e843\n    \n    use datacenter instead of dc, add tests\n    \n    commit 43eb50034d6bf0b18954624e971f8f4b719873e5\n    \n    Validate images before passing to AdminImportImage\n    \n    commit 7e85cc391f7ae909f7a7d8b2269822a3914c25a8\n    \n    TRITON-52 x-DC image copy"},{"timestamp":1530218705,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 11:\n\n(13 comments)"},{"timestamp":1530230787,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 11:\n\n(13 comments)"},{"timestamp":1530231077,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 12."},{"timestamp":1530231079,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 12:\n\nNew commits:\n    \n    commit afab18bc8a58cf9e0534e7aa12c41bbdc33befcf\n    \n    cleanup test images before and after test run\n    \n    commit 67a2becfbb44e24d03a422a33d351602914f504d\n    \n    skip xdc tests when the TestDc is not configured\n    \n    commit ef4c5a7e236be1ca6d81d751ba84e9c715e58461\n    \n    origin images with a different owner must already be imported\n    \n    commit 57188f3fa44a20f201324a789e32b2c2c91331ac\n    \n    doesn\u0027t need state check for origin images\n    \n    commit da349e930b6b76ed417fec5dc7a070e232de00a9\n    \n    ensure imported image is active\n    \n    commit a24d34b3d4bad9b0cb05c1dd9f6b85c584553e76\n    \n    provide list of configured datacenter names when dc name does not match\n    \n    commit dc24c047541bd92246c0fc59705171ea7e25e4f1\n    \n    rename _storPathFromImageUuid to storPathFromImageUuid\n    \n    commit 15c78cba2dc2f11917a5bd30e5e15ee1b2a198d8\n    \n    validate config.imgapiUrlFromDatacenter\n    \n    commit 6e6dfee22ec0b7a8bc3203a7432663ab48dff8df\n    \n    correct API name in CHANGES.md"},{"timestamp":1530231110,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530232235,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 12:\n\n(8 comments)"},{"timestamp":1530291956,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 13."},{"timestamp":1530291957,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 13:\n\nNew commits:\n    \n    commit 27f538f551a080b9bf0a9599d768937c516af059\n    \n    remove unused variable\n    \n    commit 042085232ec2b5648b95da7b1933110b80e9739d\n    \n    add note on why checkIfImageExistsLocally occurs after checkImageExistsInRemoteDc\n    \n    commit 10a9809e4dccda41ecef1fb1dfe59ecb302eea42\n    \n    exclude current dc name, add tests for importing into the same DC\n    \n    commit f6892c7bd6684fcdf23929c6ee51449e79841e7a\n    \n    drop api from endpoint name"},{"timestamp":1530291969,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 12:\n\n(8 comments)"},{"timestamp":1530291989,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530293304,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 13: Code-Review+1 Integration-Approval+1"},{"timestamp":1530312690,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 14: Commit message was updated."},{"timestamp":1530315699,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"14","revision":"5494dd602518e2a2f68aff4d2e6947dce83c0e71","parents":["8b088889cc4bf386f77959773c0ab48855aa04b8"],"ref":"refs/changes/63/3863/14","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1530312690,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530291989,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530293304,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530293304,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1530315699,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/config.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":357,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":31,"deletions":-11},{"file":"lib/utils.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":307,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":1187,"sizeDeletions":-39},"patchSets":[{"number":"1","revision":"d33f84d5ef8ae0bc5d422551a7a9e472c570560b","parents":["8c681864a96e97adf7b6cdd08618783772751b13"],"ref":"refs/changes/63/3863/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1524519234,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524519265,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":170,"deletions":-21},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":194,"sizeDeletions":-21},{"number":"2","revision":"06c7be99eb0fcdce05de2d4ed5a3f9c2203e58a6","parents":["806153bd3df17bbe12a82872ca3517e00f56674d"],"ref":"refs/changes/63/3863/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1524519272,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1524519265,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/images.js","line":1603,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"- Suggest you call this `mantaPath` rather than just `path` to make it clearer.\n\n\nAlso, this *might not be the same manta* or the same manta account (meaning this IMGAPI might not have access to that other manta).\n\n- Perhaps add `mantaUrl` and `mantaUser` (from `config.manta.{url,user}`) so the receiving IMGAPI can check if it uses the same Manta for snaplinking."},{"file":"lib/images.js","line":1603,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Will use mantaPath.\n\nAh - I had thought if it\u0027s been configured as a shared IMGAPI location (i.e. in the same cloud) it would have to use the same Manta - but I guess that doesn\u0027t need to be true, it could use a different Manta.\n\nI\u0027ll add these other Manta vars too :)"},{"file":"lib/images.js","line":2446,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"AFAICT nothing is ensuring that the end user calling this can only import an image that they own. The `skipOwnerCheck\u003dfalse` does *not* do this.\n\nAlso, we need to do the same caller-is-the-image-owner for any origin images to be imported as well -- either here, or in `Image.createImportImageJob` where the origin chain is walked. For example, say:\n\n- us-west-1 has operator-provided image minimal-multiarch@18.4.1\n- us-east-1 does NOT have this image (yet)\n- user Bob creates a custom image \"foo\" based on minimal-multiarch@18.4.1 in us-west-1\n- user Bob calls us-east-1 ImportImageFromDc?dc\u003dus-west-1 for image \"foo\"\n\nThat should *fail* because Bob shouldn\u0027t be allowed to initiate an import of image minimal-multiarch@18.4.1 between DCs."},{"file":"lib/images.js","line":2671,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d *thought* you don\u0027t need the `undefined` here to not set the \"account\" arg. Not sure though."},{"file":"lib/images.js","line":2671,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Checked again - you are right, so don\u0027t need \u0027undefined\u0027."},{"file":"lib/images.js","line":2679,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Also need to confirm the mantaUser and mantaUrl match the local IMGAPI\u0027s manta config. See notes in apiGetImage above."},{"file":"lib/images.js","line":2679,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"sapi_manifests/imgapi/template","line":51,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it should *not* come from the current \"ListDataCenters\" data (which itself is in SAPI). At least not for starters, to keep it simple. For example, currently us-east-3b\u0027s ListDataCenters doesn\u0027t include the other DCs in JPC... however we might want to allow sharing images with it and other JPC DCs. Not sure.\n\nIf we eventually want those to be shared, I think we should talk about a \"metadata_schema\" on the SAPI \u0027sdc\u0027 app for cloud DCs data and then have ListDataCenters and this inter-DC IMGAPI sharing generate from that."},{"file":"sapi_manifests/imgapi/template","line":53,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You are so Australian! :)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":170,"deletions":-21},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":194,"sizeDeletions":-21},{"number":"3","revision":"28572576ef7a640bf185c90b185f007918c296d2","parents":["806153bd3df17bbe12a82872ca3517e00f56674d"],"ref":"refs/changes/63/3863/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1526683248,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526683278,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":50,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":318,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/fauxnodejs-1.4.0.dsmanifest","fileOld":"test/fauxnodejs-1.4.0.dsmanifest","type":"RENAMED","insertions":0,"deletions":0},{"file":"test/data/fauxnodejs-1.4.0.imgmanifest","fileOld":"test/fauxnodejs-1.4.0.imgmanifest","type":"RENAMED","insertions":0,"deletions":0},{"file":"test/data/fauxnodejs-1.4.0.zfs.bz2","fileOld":"test/fauxnodejs-1.4.0.zfs.bz2","type":"RENAMED","insertions":0,"deletions":0},{"file":"test/data/fauxubuntu.dsmanifest","fileOld":"test/fauxubuntu.dsmanifest","type":"RENAMED","insertions":0,"deletions":0},{"file":"test/data/fauxubuntu.zfs.bz2","fileOld":"test/fauxubuntu.zfs.bz2","type":"RENAMED","insertions":0,"deletions":0},{"file":"test/data/icon.jpg","fileOld":"test/icon.jpg","type":"RENAMED","insertions":0,"deletions":0},{"file":"test/data/what_a_piece_of_junk.zfs.bz2","fileOld":"test/what_a_piece_of_junk.zfs.bz2","type":"RENAMED","insertions":0,"deletions":0}],"sizeInsertions":400,"sizeDeletions":-26},{"number":"4","revision":"b32be5fb9d64810d2aa74627afc3b69d086efb2f","parents":["806153bd3df17bbe12a82872ca3517e00f56674d"],"ref":"refs/changes/63/3863/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1527551815,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527551846,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":50,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":323,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/a224da79-1806-4e66-b949-d481c7ca8cee.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/a224da79-1806-4e66-b949-d481c7ca8cee.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1054,"sizeDeletions":-26},{"number":"5","revision":"b594ec3039041ec571502bb03793a0967a2dc565","parents":["806153bd3df17bbe12a82872ca3517e00f56674d"],"ref":"refs/changes/63/3863/5","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1527624479,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527624511,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":50,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":341,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1072,"sizeDeletions":-26},{"number":"6","revision":"7376361f72c296beff5f71a188c5da13658b8b84","parents":["2bc6b57da32e8ba5a1791cd07d9fda5522f4cccb"],"ref":"refs/changes/63/3863/6","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1528144115,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527624511,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":1908,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Q: It is more strict than that right? Account \u0027bob\u0027 cannot import an image unless he is the *owner* right? E.g. if account \u0027sally\u0027 shares an image with \u0027bob\u0027 (bob is on the image.acl), Bob still cannot import that image, right?"},{"file":"docs/index.md","line":1908,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Right - I\u0027ve updated the comment to be more precise about this."},{"file":"lib/images.js","line":786,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ooh, nice fix. Was that a leak from before? Perhaps they clean up themselves after a timeout? Anyway."},{"file":"lib/images.js","line":786,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"It was a leak of sorts (the sockets will automatically close after their connection timeout expires).\n\nThis affected the tests mostly - where a test would hang at the end, waiting for the connection(s) to close."},{"file":"lib/images.js","line":1606,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"See earlier discussion about making this mantaPath and adding the other vars: https://cr.joyent.us/#/c/3863/2/lib/images.js@1603"},{"file":"lib/images.js","line":1606,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Right - I swear I made that change already - I must have f\u0027d my repo up somewhere and lost it before it got committed.\n\nAnyway - on it again!"},{"file":"lib/images.js","line":2425,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"THis incorrectly let\u0027s an empty account through."},{"file":"lib/images.js","line":2425,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Good catch - I was thinking this might be applicable for operators (no account), to be able to copy around operator images (e.g. ubuntu 16.04) to different dc\u0027s, as that would be a lot faster (snap linking) than having to import these images (copying the bits), but you can specify the admin account in the call, so meh."},{"file":"lib/images.js","line":2442,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps change this to say something like: \u0027image import from datacenter \"foo\" is not supported\u0027\n\nI think for the user that will be less confusing than \"unknown datacenter: us-east-3b\" if either (a) imgapiUrlFromDatacenter isn\u0027t configured or (b) ops has specifically disabled import from a particular datacenter."},{"file":"lib/images.js","line":2442,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2466,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I asked about this on the index.md doc page as well. I thought the restriction was that one must be the owner of the image to import it."},{"file":"lib/images.js","line":2466,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Yes - updated (simplified) to check account is the owner."},{"file":"lib/images.js","line":2501,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"s/clone/copy"},{"file":"lib/images.js","line":2501,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2520,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm. That feels like the wrong error then, but perhaps is fine. Could also use OriginDoesNotExistError, or make a new one. Meh."},{"file":"lib/images.js","line":2520,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Changed to OriginDoesNotExist"},{"file":"lib/images.js","line":2527,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why this? Do we really have that case? This UNSET_OWNER_UUID should only happen in `app.mode !\u003d\u003d \"dc\"` cases, for which I think this endpoint need not exist. I might be missing soemthign tho."},{"file":"lib/images.js","line":2527,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"What you wrote makes sense - I don\u0027t think the UNSET_OWNER_UUID is needed - the admin owner should always be correctly set in \u0027dc\u0027 mode."},{"file":"lib/images.js","line":2561,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This recursion might better be implemented as vasync.whilst, but given the limit of 100, perhaps not a concern with stack exhaustion."},{"file":"lib/images.js","line":2561,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"If it\u0027s okay - I\u0027ll leave it as is (the indentation is already pretty deep here ;)"},{"file":"lib/images.js","line":2578,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"indentation"},{"file":"lib/images.js","line":2578,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Woops - VSCode fudged up my indentation, and I missed fixing these up."},{"file":"lib/images.js","line":2584,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"debugging code?"},{"file":"lib/images.js","line":2584,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Good catch - yup."},{"file":"lib/images.js","line":2586,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Indentation. Also just want `cb()`?"},{"file":"lib/images.js","line":2586,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Good catch - yup."},{"file":"lib/images.js","line":2809,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yah, definitely. :)  This function has grown over time."},{"file":"lib/images.js","line":2809,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Okay - will do - but will make this as a separate Gerrit update (as hopefully that makes it easier to review that major indentation/flow change)."},{"file":"lib/images.js","line":2818,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"How about we make it explicit when this is expected to be a mode\u003d\"dc\" import. That\u0027ll mean we can skip special UnauthorizedError handling below.\n\nTo know if this is meant to be a DC-mode import, we could:\n\n1. do a reverse lookup in config.imgapiUrlFromDatacenter with the source URL\n2. pass a param through the import-remote-image job and to this endpoint (more work)"},{"file":"lib/images.js","line":2818,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I\u0027ll try (1), as I already went down the rabbit hole of (2) and backed it out as it got messy pretty fast (lots of little changes all over the place)."},{"file":"lib/images.js","line":2827,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Actually mode\u003d\"private\" (e.g. updates.jo) or also mode\u003d\"public\" (e.g. images.jo) ... or really any mode other than mode\u003d\"dc\"."},{"file":"lib/images.js","line":2827,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"This code is now gone (after making change (1) above)."},{"file":"lib/images.js","line":2843,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This block is updated for files[0].mantaPath, and also checking they are the same configured Manta and manta account."},{"file":"lib/images.js","line":2843,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done - again :)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":50,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":341,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1072,"sizeDeletions":-26},{"number":"7","revision":"9f27e9a475d7025d03bf6373ee79efec1a89e7fb","parents":["2bc6b57da32e8ba5a1791cd07d9fda5522f4cccb"],"ref":"refs/changes/63/3863/7","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1528498841,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528498871,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":337,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1069,"sizeDeletions":-26},{"number":"8","revision":"4ba5fd7d5a5fa6745000f79ef65e2409f079c8ac","parents":["2bc6b57da32e8ba5a1791cd07d9fda5522f4cccb"],"ref":"refs/changes/63/3863/8","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1529103343,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529103378,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":337,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":265,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1070,"sizeDeletions":-26},{"number":"9","revision":"2dbf1455d5524e0bf55e78368a1f8666439b2203","parents":["99b4534c0c662495ab9cac2f5e574fa86f391b77"],"ref":"refs/changes/63/3863/9","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1529605210,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529605243,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":337,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":265,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1070,"sizeDeletions":-26},{"number":"10","revision":"e0980d4685d308623302fe8926e79dadd1691ad0","parents":["3ccdabddafbb96833769b28fa249639213925e34"],"ref":"refs/changes/63/3863/10","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1530146044,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530146081,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":337,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":265,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1071,"sizeDeletions":-27},{"number":"11","revision":"15bb3f1dabc2f9400f048f8a02ebea959be5e2c9","parents":["8b088889cc4bf386f77959773c0ab48855aa04b8"],"ref":"refs/changes/63/3863/11","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1530155516,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530146081,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":5,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"ImportFromDatacenter\""},{"file":"CHANGES.md","line":5,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/config.js","line":120,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"There should be validation of the format of \u0027imgapiUrlFromDatacenter\u0027 in here somewhere. IMGAPI should fail hard and fast if a bogus IMGAPI_URL_FROM_DATACENTER is set."},{"file":"lib/config.js","line":120,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":1715,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps let\u0027s make that method public (i.e. drop the leading \u0027_\u0027) in storage.js."},{"file":"lib/images.js","line":1715,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2554,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t think the current work will provide an endpoint to list explicitly which DCs one can import from, other than the assumed match with CloudAPI ListDatacenters.  It might be nice to include the set of DC names in `config.imgapiUrlFromDatacenter` in this error message."},{"file":"lib/images.js","line":2554,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2554,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should also exclude app.config.datacenterName in this (see comment below)."},{"file":"lib/images.js","line":2554,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2556,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I imagine for simpler config, it will be nice to configure imgapiUrlFromDatacenter with the same data in all the DCs. That means that IMGAPI in us-west-1 will have \"us-west-1\" in its mapping. We should explicitly exclude importing from the current DC somewhere around here."},{"file":"lib/images.js","line":2556,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Do you know of a way to test that (i.e. name \"us-west-1\" matches the current imgapi location)?"},{"file":"lib/images.js","line":2556,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Match against app.config.datacenterName"},{"file":"lib/images.js","line":2556,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2569,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"If not routable, does this take a long time to timeout? It would be nice to have it fail fast with the equivalent of curl\u0027s `--connect-timeout 10` or something. This could be done separately, however."},{"file":"lib/images.js","line":2569,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I would expect it to take the system/node configured time to timeout. I don\u0027t like to add custom timeouts myself - as it\u0027s a guess (a slow machine can cause a timeout, network could be congested at that time, etc...) - it\u0027s very difficult to get that right, especially when your talking outside of a datacenter (i.e. when it\u0027s not locally configured networking)."},{"file":"lib/images.js","line":2569,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m fine to leave it until we see if it is a problem. However, if our admin-network routed DCs in the same cloud take longer than 10s to talk to each other, then I\u0027d be *fine* with this failing. ;)"},{"file":"lib/images.js","line":2569,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"OK."},{"file":"lib/images.js","line":2574,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should there be a guard on image state? E.g., I think this will pass through a \"failed\" image currently."},{"file":"lib/images.js","line":2574,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Yes, it should - done. Should it allow \u0027disabled\u0027 state?"},{"file":"lib/images.js","line":2574,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think we can start with just \u0027active\u0027 as you have here. We can add more later if there is a good case for it."},{"file":"lib/images.js","line":2574,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2588,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"While we don\u0027t support re-import from a DC, perhaps this step could come before \"checkImageExistsInRemoteDc\" so we can fail out faster if it is already imported."},{"file":"lib/images.js","line":2588,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I had it that way originally - but that could allow a user to check if an image exists in IMGAPI (even if they are not the owner), which could be a security problem. The checkIfImageExistsLocally is essentially an admin lookup of the image."},{"file":"lib/images.js","line":2588,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, cool."},{"file":"lib/images.js","line":2588,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Added a comment here to explain why it\u0027s after checkImageExistsInRemoteDc."},{"file":"lib/images.js","line":2594,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"There was talk at some point in RFD 113 (perhaps not written into the RFD) of supporting *re*-importing to update changed fields. That could be separate work, however."},{"file":"lib/images.js","line":2594,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Couldn\u0027t one delete the image and re-import it?"},{"file":"lib/images.js","line":2594,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yes, tho that is overkill if you just updated a tag, say, on one of your images and wanted that to propagate to the image in your other active DCs."},{"file":"lib/images.js","line":2594,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Okay - I made a note in the RFD about re-import."},{"file":"lib/images.js","line":2632,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"As with TRITON-53, I don\u0027t think we need to check this. It is an inconsistent IMGAPI db if there are unactivated origin images."},{"file":"lib/images.js","line":2632,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"lib/images.js","line":2636,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Or maybe should stop when hitting an image that is not owned by `account` instead? E.g. I *think* Bob can have an image whose origin image is just *shared* with him (owned by Alice).  In this case, I think (for now at least), Bob\u0027s ImportFromDatacenter should just require that the local DC already has Alice\u0027s image."},{"file":"lib/images.js","line":2636,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"test/images-xdc.dc-test.js","line":79,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would really like this test suite to be skipped if we aren\u0027t configured for testing it. I think this could use child_process.execSync to run `node .../lib/config.js imgapiUrlFromDatacenter` and see if \"TEST_DC_NAME\" is in it. If not, then skip. See `CAN_RUN_TEST` in admincreateimagefromvm.dc-test.js for a current skipping example."},{"file":"test/images-xdc.dc-test.js","line":79,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"test/images-xdc.dc-test.js","line":249,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Potentially will want the cleanup of test images from a previous failed run to be deleted in *setup* steps."},{"file":"test/images-xdc.dc-test.js","line":249,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done - now deleting beginning and end - doing it at the end ensures I don\u0027t affect other tests too."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":8,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":337,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":20,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":265,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0}],"sizeInsertions":1071,"sizeDeletions":-27},{"number":"12","revision":"af0103091f2688c5eaf0fe2693c35838db41f837","parents":["8b088889cc4bf386f77959773c0ab48855aa04b8"],"ref":"refs/changes/63/3863/12","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1530231077,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530231110,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":5,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"drop that \"api\""},{"file":"CHANGES.md","line":5,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"test/images-xdc.dc-test.js","line":56,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this used?"},{"file":"test/images-xdc.dc-test.js","line":56,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Not used, removed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/config.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":342,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":31,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":281,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":5,"deletions":0}],"sizeInsertions":1127,"sizeDeletions":-38},{"number":"13","revision":"ef3dba489bd43297e488e9dec2d1f2412644f609","parents":["8b088889cc4bf386f77959773c0ab48855aa04b8"],"ref":"refs/changes/63/3863/13","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1530291956,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530291989,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530293304,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530293304,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/config.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":357,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":31,"deletions":-11},{"file":"lib/utils.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":307,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":1187,"sizeDeletions":-39},{"number":"14","revision":"5494dd602518e2a2f68aff4d2e6947dce83c0e71","parents":["8b088889cc4bf386f77959773c0ab48855aa04b8"],"ref":"refs/changes/63/3863/14","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1530312690,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530291989,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530293304,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530293304,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1530315699,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":51,"deletions":-1},{"file":"lib/config.js","type":"MODIFIED","insertions":18,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":357,"deletions":-24},{"file":"lib/storage.js","type":"MODIFIED","insertions":31,"deletions":-11},{"file":"lib/utils.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"sapi_manifests/imgapi/template","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/15963d90-61d7-4664-87a6-f56b16492d5a.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/649d6948-4f1d-11e8-8249-1b9928638559.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/900cffef-55e3-4e7d-b7ec-ccf439a159e3.manifest","type":"ADDED","insertions":34,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/9f819499-8298-9842-8cc5-1c2838196ab4.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/c58161c0-2547-11e2-a75e-9fdca1940570.manifest","type":"ADDED","insertions":37,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.file0","type":"ADDED","insertions":0,"deletions":0},{"file":"test/data/xdc/f3078f0c-a53b-4140-b7af-fbb6308a8e35.manifest","type":"ADDED","insertions":22,"deletions":0},{"file":"test/images-xdc.dc-test.js","type":"ADDED","insertions":307,"deletions":0},{"file":"test/mock/imgapi.js","type":"ADDED","insertions":180,"deletions":0},{"file":"test/runtests","type":"MODIFIED","insertions":6,"deletions":0}],"sizeInsertions":1187,"sizeDeletions":-39}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}