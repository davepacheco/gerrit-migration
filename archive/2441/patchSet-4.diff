commit 8b5e3024a623d0d2530cc8821f43060909eeb7e5 (refs/changes/41/2441/4)
Author: Brittany Wald <brittany.wald@joyent.com>
Date:   2017-08-31T18:49:29+00:00 (2 years, 1 month ago)
    
    MANTA-3384 muskie docs for mpu_enable in deploys

diff --git a/README.md b/README.md
index 50d8ba6..d689763 100644
--- a/README.md
+++ b/README.md
@@ -44,9 +44,9 @@ prerequisites in your development environment:
    to the same user account, and they should both refer to the ssh key stored in
    $HOME/.ssh/id\_rsa.pub mentioned above.
 4. Before running the tests, you must set the `MUSKIE_SALT`, `MUSKIE_KEY`, and
-   `MUSKIE_IV` environment variables to the same values being used for the muskie
-   instances in your existing Manta installation.  You can find these values in
-   SAPI, using:
+   `MUSKIE_IV` environment variables to the same values being used for the
+   muskie instances in your existing Manta installation.  You can find these
+   values in SAPI, using:
 
         sdc-sapi /services?application_uuid="$(sdc-sapi \
             /applications?name=manta | json -H application_uuid)&name=webapi" |
@@ -131,15 +131,28 @@ check first before reporting problems:
    you ran the acsetup script described above for the user that you're using.
    (Note that you may see some other muskie\_test\_role in the message.)
 3. If a test fails with a message like "Error: MUSKIE\_SALT required", then
-   check that you've specified the three `MUSKIE_` environment variables described
-   above.
+   check that you've specified the three `MUSKIE_` environment variables
+   described above.
 4. If a test fails due to authorization errors (perhaps while completing a job),
    you may have an incorrect muskie configuration. Check that the `MUSKIE_ID`,
-   `MUSKIE_KEY` and `MUSKIE_IV` attributes in your config.json match the environment
-   variables set for the user running the tests (`$MANTA_USER`).
-5. If the "rmdir mpuRoot" and "ls top" tests fail, MPU may not be enabled. If
-   you recently upgraded from a pre-MPU muskie version, ensure the line
-   '"enableMPU": true' is present in your config.json.
+   `MUSKIE_KEY` and `MUSKIE_IV` attributes in your config.json match the
+   environment variables set for the user running the tests (`$MANTA_USER`).
+5. If the "rmdir mpuRoot" and "ls top" tests fail, MPU may not be enabled. MPU
+   GC is not supported, so if MPU is left enabled, records may accumulate in
+   metadata shards.  For this reason, *non-developers should not run this code*.
+   However, if you are a developer, and you recently upgraded from a pre-MPU
+   muskie version go ahead and ensure the line '"enableMPU": true' is present in
+   your config.json file.  If you are running tests against an image whose 
+   configuration is managed by SAPI, which includes any zones deployed using 
+   `manta-adm`, you will need to set this variable using sapiadm:
+
+   		$ sapiadm update (sdc-sapi /services?name=webapi | json -Ha uuid) metadata."MPU_ENABLE"=true
+
+   Next, check that `/opt/smartdc/muskie/etc/config.json` in each of your webapi
+   zones has updated to contain `"enableMPU": true`".  Then restart your muskie
+   instances so that they will pick up the changes to the configuration file: 
+
+		$ manta-oneach -s webapi 'svcadm restart "*muskie-*"'
 
 If you're changing anything about the way muskie is deployed, configured, or
 started, you should definitely test creating a muskie image and deploying that
