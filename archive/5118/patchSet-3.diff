From d4f1315a2ede6c8ce9fd90df75f5505d61c9a964 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 23 Nov 2018 21:20:26 -0800
Subject: [PATCH] TRITON-937 CNAPI should have ServerInstallAgentShar endpoint

---
 lib/endpoints/servers.js | 44 ++++++++++++++++++++++++++++++++++++++++
 lib/server.js            |  7 +++++--
 package.json             |  2 +-
 3 files changed, 50 insertions(+), 3 deletions(-)

diff --git a/lib/endpoints/servers.js b/lib/endpoints/servers.js
index 1c32028..a1c00cb 100644
--- a/lib/endpoints/servers.js
+++ b/lib/endpoints/servers.js
@@ -1137,6 +1137,37 @@ Server.installAgent = function handlerServerInstallAgent(req, res, next) {
         }});
 };
 
+/* BEGIN JSSTYLED */
+/**
+ * Instruct server to install given agents shar. Pass in the name of an
+ * agentsshar package to install and server will download the shar and
+ * install.
+ *
+ * @name ServerInstallAgentsShar
+ * @endpoint POST /servers/:server_uuid/install-agentsshar
+ * @section Server API
+ * @param {String} url URL of agentsshar to install
+ *
+ * @response 200 Ok Install task initiated successfully
+ * @response 500 Error Could not process request
+ */
+/* END JSSTYLED */
+
+Server.installAgentsShar =
+function handlerServerInstallAgentsShar(req, res, next) {
+    var self = this;
+
+    req.stash.server.sendTaskRequest({
+        task: 'agent_install_shar',
+        params: req.params,
+        req: req,
+        evcb: ModelServer.createComputeNodeAgentHandler(self, req.params.jobid),
+        cb: function (error, task) {
+            res.send({ id: task.id });
+            next();
+            return;
+        }});
+};
 
 Server.nop = function handlerServerNop(req, res, next) {
     req.params.sleep = parseInt(req.params.sleep, 10) || 0;
@@ -1248,6 +1279,19 @@ function attachTo(http, app) {
         }),
         Server.installAgent);
 
+    // Import an image to the server
+    http.post({
+        path: '/servers/:server_uuid/install-agent-shar',
+        name: 'ServerInstallAgentsShar' },
+        ensure({
+            connectionTimeoutSeconds: 60 * 60,
+            app: app,
+            serverRunning: true,
+            prepopulate: ['server'],
+            connected: ['moray']
+        }),
+        Server.installAgentsShar);
+
     // Refresh server sysinfo
     http.post({
         path: '/servers/:server_uuid/sysinfo-refresh',
diff --git a/lib/server.js b/lib/server.js
index e0cacef..ce6bd87 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -20,8 +20,11 @@ var request_seq_id = 0;
 
 
 function createServer(options) {
-    var cnapi = restify.createServer({
-        name: 'Compute Node API',
+    var cnapi;
+    var cnapiVersion = require(__dirname + '/../package.json').version;
+
+    cnapi = restify.createServer({
+        name: 'cnapi/' + cnapiVersion,
         log: options.log,
         handleUpgrades: true,
         handleUncaughtExceptions: false
diff --git a/package.json b/package.json
index b3196c5..d09397c 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.16.0",
+  "version": "1.18.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

