From b9da4dca2ef72acbe981684e61fc08cc1bcdc6b6 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Wed, 12 Dec 2018 13:05:52 -0800
Subject: [PATCH] TRITON-937 CNAPI should have ServerInstallAgentShar endpoint

---
 lib/endpoints/servers.js | 44 ++++++++++++++++++++++++++++++++++++++++
 package.json             |  2 +-
 2 files changed, 45 insertions(+), 1 deletion(-)

diff --git a/lib/endpoints/servers.js b/lib/endpoints/servers.js
index 1c32028..b09807e 100644
--- a/lib/endpoints/servers.js
+++ b/lib/endpoints/servers.js
@@ -1137,6 +1137,37 @@ Server.installAgent = function handlerServerInstallAgent(req, res, next) {
         }});
 };
 
+/* BEGIN JSSTYLED */
+/**
+ * Instruct server to install given agents shar. Pass in the name of an
+ * agentsshar package to install and server will download the shar and
+ * install.
+ *
+ * @name ServerInstallAgentsShar
+ * @endpoint POST /servers/:server_uuid/install-agentsshar
+ * @section Server API
+ * @param {String} url URL of agentsshar to install
+ *
+ * @response 200 Ok Install task initiated successfully
+ * @response 500 Error Could not process request
+ */
+/* END JSSTYLED */
+
+Server.installAgentsShar =
+function handlerServerInstallAgentsShar(req, res, next) {
+    var self = this;
+
+    req.stash.server.sendTaskRequest({
+        task: 'agentsshar_install',
+        params: req.params,
+        req: req,
+        evcb: ModelServer.createComputeNodeAgentHandler(self, req.params.jobid),
+        cb: function (error, task) {
+            res.send({ id: task.id });
+            next();
+            return;
+        }});
+};
 
 Server.nop = function handlerServerNop(req, res, next) {
     req.params.sleep = parseInt(req.params.sleep, 10) || 0;
@@ -1248,6 +1279,19 @@ function attachTo(http, app) {
         }),
         Server.installAgent);
 
+    // Import an image to the server
+    http.post({
+        path: '/servers/:server_uuid/install-agentsshar',
+        name: 'ServerInstallAgentsShar' },
+        ensure({
+            connectionTimeoutSeconds: 60 * 60,
+            app: app,
+            serverRunning: true,
+            prepopulate: ['server'],
+            connected: ['moray']
+        }),
+        Server.installAgentsShar);
+
     // Refresh server sysinfo
     http.post({
         path: '/servers/:server_uuid/sysinfo-refresh',
diff --git a/package.json b/package.json
index 10bcb5a..d09397c 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.17.1",
+  "version": "1.18.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

