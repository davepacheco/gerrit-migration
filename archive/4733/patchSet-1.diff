From 414a10aa29515be6817feaf8a77579b59fb7edf6 Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody@kkantor.com>
Date: Wed, 22 Aug 2018 17:45:21 +0000
Subject: [PATCH] joyent/node-vmapi-resolver#2 should support regexp matching
 of nic_tags

---
 README.md       |  2 +-
 lib/resolver.js | 10 +++++++---
 package.json    |  2 +-
 3 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/README.md b/README.md
index 68ed871..474d880 100644
--- a/README.md
+++ b/README.md
@@ -35,7 +35,7 @@ var resolver = new mod_resolver.VmapiResolver({
 	'tags': { /* NIC and VM tags */
 		'vm_tag_name': 'manta_role',
 		'vm_tag_value': 'postgres',
-		'nic_tag': 'manta'
+		'nic_tag': 'manta.*' /* regexp-based match */
 	},
 	'backend_port': 5432 /* port number of the listening process */
 });
diff --git a/lib/resolver.js b/lib/resolver.js
index 23574c1..38046f0 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -39,6 +39,7 @@ function VmapiResolver(opts) {
 	this.vmr_backends = {}; /* emitted backends */
 	this.vmr_discovered_backends = [];  /* response from VMAPI */
 	this.vmr_lastPoll = null; /* blocks setInterval() from piling up */
+	this.vmr_regexp = new RegExp(this.vmr_tags.nic_tag);
 
 	/* useful for debugging */
 	this.vmr_lastBackends = {};
@@ -66,7 +67,7 @@ VmapiResolver.prototype.getBackends = function getBackends(cb) {
 	var log = this.vmr_log;
 	var vm_tag_name = this.vmr_tags.vm_tag_name;
 	var vm_tag_value = this.vmr_tags.vm_tag_value;
-	var nic_tag = this.vmr_tags.nic_tag;
+	var nic_tag_regexp = this.vmr_regexp;
 	var backends = [];
 
 	/* create a 'tag.manta_role' or similar for filtering VMs */
@@ -84,8 +85,11 @@ VmapiResolver.prototype.getBackends = function getBackends(cb) {
 		}
 		Object.keys(vms).forEach(function (vm) {
 			vms[vm].nics.forEach(function (nic) {
-				/* nic tag has to match the requested nic tag */
-				if (nic.nic_tag === nic_tag) {
+				/*
+				 * nic tags are matched by the caller-provided
+				 * regexp, e.g. 'manta.*'.
+				 */
+				if (nic_tag_regexp.test(nic.nic_tag)) {
 					backends.push({
 						'name': vms[vm].alias,
 						'address': nic.ip
diff --git a/package.json b/package.json
index e3a1eb9..caf0366 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "vmapi-resolver",
-  "version": "1.0.0",
+  "version": "2.0.0",
   "description": "node-cueball resolver using VMAPI",
   "repository": {
     "url": "https://github.com/joyent/node-vmapi-resolver.git",
-- 
2.21.0

