From 65cf526abf296db282b9c63abeb6b63de8105bb5 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Mon, 21 Aug 2017 20:41:45 +0000
Subject: [PATCH] MANTA-3340 muskie mpu could log a bit quieter

---
 lib/uploads/commit.js | 10 ++++++----
 lib/uploads/common.js |  4 +++-
 2 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/lib/uploads/commit.js b/lib/uploads/commit.js
index ded74d8..0f0f39e 100644
--- a/lib/uploads/commit.js
+++ b/lib/uploads/commit.js
@@ -312,7 +312,7 @@ function validateParts(req, res, next) {
                 var e = errors[i];
                 assert.number(e.statusCode);
                 if (e.statusCode >= 500) {
-                    log.error('internal error: ' + e);
+                    log.warn('internal error: ' + e);
                 } else if (e.statusCode >= 400) {
                     next(e);
                     return;
@@ -434,8 +434,10 @@ function finalizeUpload(req, res, next) {
 
             if (err) {
                 results.operations.forEach(function (r) {
-                    log.error('error with shark ' + r.result.shark +
-                        ': ' + r.err);
+                    log.warn({
+                        err: r.err,
+                        shark: r.result.shark
+                    }, 'error with shark');
                 });
                 next(new SharksExhaustedError());
             } else {
@@ -458,7 +460,7 @@ function finalizeUpload(req, res, next) {
                     var msg = 'mako nodes returned different md5 sums for ' +
                         'the same object';
 
-                    log.error({
+                    log.warn({
                         results: results.operations.map(function (r) {
                             return ({
                                 shark: r.result.shark,
diff --git a/lib/uploads/common.js b/lib/uploads/common.js
index e22ca84..cc43a1c 100644
--- a/lib/uploads/common.js
+++ b/lib/uploads/common.js
@@ -886,7 +886,9 @@ function commitUpload(partsMD5, size, md5, cb) {
 
                     self.req.moray.commitMPU(opts, function (err3, meta) {
                         if (err3) {
-                            log.error('error batching data: ' + err3);
+                            err3 = new verror.VError(err3,
+                                'error batching data');
+                            log.warn(err3);
                             cb(err3);
                         } else {
                             log.debug('batch successful');
-- 
2.21.0

