{"project":"joyent/manta-muskie","branch":"master","id":"I3a00a96957f9d9d003c0cb980890c42de1451337","number":"2437","subject":"MANTA-3340 muskie mpu could log a bit quieter","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2437","commitMessage":"MANTA-3340 muskie mpu could log a bit quieter\n","createdOn":1503348276,"lastUpdated":1504285933,"open":false,"status":"MERGED","comments":[{"timestamp":1503348276,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1503348314,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503349685,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1503350999,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2: Commit message was updated."},{"timestamp":1503505160,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(2 comments)\n\nThe change looks good.  I have some notes about other ways we might want to improve the log messages here -- it\u0027s up to you if you want to take those on."},{"timestamp":1503520685,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1503520728,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503520779,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1503520822,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503521646,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1503521727,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1503683159,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 4:\n\nSo I ran `make prepush` successfully but I\u0027m a bit stuck on how to force some of these failures. Could use some input on how to test these changes if anyone has any."},{"timestamp":1503946637,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4:\n\nFor the error logged in lib/uploads/common.js (https://github.com/joyent/manta-muskie/blob/1b6dd87b0d30fa14e046214ab972f87dc57d4cc0/lib/uploads/common.js#L890-L897), you would need an error returned from Moray. You can search old alarms in your email for this error message to see the types of errors returned inducing this message. One way you could induce a dummy failure here just to exercise the code path is to modify your local copy of libmanta to always return an error for commitMPU. I think that is probably sufficient to verify a log-level change.\n\nAs for the other failures:\n\nYou could try changing your local makos to an image without MANTA-3296 fixed and repeat the testing done there to induce the failure here: https://github.com/joyent/manta-muskie/blob/1b6dd87b0d30fa14e046214ab972f87dc57d4cc0/lib/uploads/commit.js#L461-L467.\n\nI think taking enough makos offline (by halting the vms or partitioning them off) should induce the failure logged here: https://github.com/joyent/manta-muskie/blob/1b6dd87b0d30fa14e046214ab972f87dc57d4cc0/lib/uploads/commit.js#L436-L439.\n\nThanks for being so thorough in your testing! In addition to helping test this change, I think these are good cases to walk through for understanding Manta system failures in general."},{"timestamp":1504203755,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1504285900,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1504285904,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"},{"timestamp":1504285933,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"89de83de9693fde0987ff6e6a2c2b0e853579384","parents":["1b6dd87b0d30fa14e046214ab972f87dc57d4cc0"],"ref":"refs/changes/37/2437/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1504285900,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503520822,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503521646,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503521727,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504203755,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1504285904,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":10,"sizeDeletions":-5},"patchSets":[{"number":"1","revision":"d0934ca715547eb82ed6267f8a6b949fd6ae3892","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/37/2437/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1503348276,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503348314,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503349685,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":4,"sizeDeletions":-4},{"number":"2","revision":"562c7476094dae356ad40a07ab36ce70099ddfdb","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/37/2437/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1503350999,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503348314,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503349685,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"lib/uploads/commit.js","line":315,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think a better pattern here is probably something like:\n\n    e \u003d new VError(e, \u0027internal error\u0027)\n    log.warn(e);\n\nLogging the error directly should cause bunyan to include the error\u0027s name, message, and stack trace in JSON format in the log record (instead of a toString()\u0027d version of the error).  Using a VError with a cause will keep the message the same as what we have here, but preserve both the original and the new stack trace."},{"file":"lib/uploads/commit.js","line":437,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Similar to above, we can keep more structured information in the log message with something like:\n\n    log.warn({\n        \u0027err\u0027: r.err,\n        \u0027shark\u0027: r.result.shark\n    }, \u0027error with shark\u0027)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":4,"sizeDeletions":-4},{"number":"3","revision":"65cf526abf296db282b9c63abeb6b63de8105bb5","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/37/2437/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1503520685,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503520728,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":9,"sizeDeletions":-5},{"number":"4","revision":"3a00a96957f9d9d003c0cb980890c42de1451337","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/37/2437/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1503520779,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503521646,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504203755,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503520822,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503521727,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":10,"sizeDeletions":-5},{"number":"5","revision":"89de83de9693fde0987ff6e6a2c2b0e853579384","parents":["1b6dd87b0d30fa14e046214ab972f87dc57d4cc0"],"ref":"refs/changes/37/2437/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1504285900,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503521646,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504203755,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503520822,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503521727,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1504285904,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/uploads/commit.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":10,"sizeDeletions":-5}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}