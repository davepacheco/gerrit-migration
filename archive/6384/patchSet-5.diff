commit 2ebed53a0f0979a025dde2fc8e72efb21204273b
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2019-06-05T20:42:24+02:00 (4 months ago)
    
    OS-7668 fwadm needs to selectively add new syntax

diff --git a/overlay/generic/etc/ipf/smartos_version b/overlay/generic/etc/ipf/smartos_version
new file mode 100644
index 00000000..0cfbf088
--- /dev/null
+++ b/overlay/generic/etc/ipf/smartos_version
@@ -0,0 +1 @@
+2
diff --git a/src/fw/lib/fw.js b/src/fw/lib/fw.js
index 1ee415f4..0b812605 100644
--- a/src/fw/lib/fw.js
+++ b/src/fw/lib/fw.js
@@ -21,7 +21,7 @@
  * CDDL HEADER END
  *
  *
- * Copyright (c) 2018, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  *
  * fwadm: Main entry points
@@ -105,6 +105,9 @@ var v6fallbacks = fallbacks.concat([
     'pass out quick proto ipv6-icmp from any to any keep state',
     'pass out proto ipv6-icmp from any to any']);
 
+// Do not use directly - use haveIpfEventLogger() instead.
+var haveDevIpfEv = undefined;
+var DEV_IPFEV = '/dev/ipfev';
 
 // --- Internal helper functions
 
@@ -120,6 +123,17 @@ function assertStringOrObject(obj, name) {
 }
 
 
+/**
+ * Determine if /dev/ipfev exists, caching the result for future calls in the
+ * global variable haveDevIpfEv.
+ */
+function haveIpfEventLogger() {
+    if (haveDevIpfEv === undefined) {
+        haveDevIpfEv = fs.existsSync(DEV_IPFEV);
+    }
+    return haveDevIpfEv;
+}
+
 /**
  * For a rule and a direction, return whether or not we actually need to
  * write ipf rules. FROM+ALLOW and TO+BLOCK are essentially no-ops, as
@@ -841,10 +855,8 @@ function validateRules(vms, rvms, rules, log, callback) {
                 sideData[rule.uuid][dir].vms[vm] = 1;
             }
             delete rulesLeft[rule.uuid];
-
         } else if (hasKey(rvms[type], t)) {
             delete rulesLeft[rule.uuid];
-
         } else {
             sideData[rule.uuid][dir].missing[type][t] = 1;
         }
@@ -901,7 +913,6 @@ function protoTarget(rule, target) {
     } else {
         if (hasKey(target, 'start')
             && hasKey(target, 'end')) {
-
             return 'port ' + target.start + ' : ' + target.end;
         } else {
             return 'port = ' + target;
@@ -1083,6 +1094,16 @@ function ipfRuleObj(opts) {
     // ipfilter uses /etc/protocols which calls ICMPv6 'ipv6-icmp'
     var ipfProto = (rule.protocol === 'icmp6') ? 'ipv6-icmp' : rule.protocol;
 
+    var readtags = [];
+    if (haveIpfEventLogger()) {
+        if (rule.uuid) {
+            readtags.push(util.format('uuid=%s', rule.uuid));
+        }
+        if (rule.log) {
+            readtags.push('cfwlog');
+        }
+    }
+
     var sortObj = {
         action: rule.action,
         direction: dir,
@@ -1097,7 +1118,9 @@ function ipfRuleObj(opts) {
         type: opts.type,
         uuid: rule.uuid,
         value: opts.value,
-        version: rule.version
+        version: rule.version,
+        allTags: readtags.length !== 0 ?
+            util.format(' set-tag(%s)', readtags.join(', ')) : ''
     };
 
     if (opts.type === 'wildcard' && opts.value === 'any') {
@@ -1107,10 +1130,8 @@ function ipfRuleObj(opts) {
                 dir === 'from' ? 'out' : 'in',
                 ipfProto,
                 protoTarget(rule, t));
-            if (rule.protocol !== 'icmp6')
-                sortObj.v4text.push(wild);
-            if (rule.protocol !== 'icmp')
-                sortObj.v6text.push(wild);
+            if (rule.protocol !== 'icmp6') { sortObj.v4text.push(wild); }
+            if (rule.protocol !== 'icmp') { sortObj.v6text.push(wild); }
         });
 
         return sortObj;
@@ -1252,16 +1273,21 @@ function prepareIPFdata(opts, log, callback) {
             '# AND MAY BE OVERWRITTEN AT ANY TIME.',
             '#',
             '# File generated at ' + date.toString(),
-            '#',
-            ''];
+            '#'
+        ];
+        if (haveIpfEventLogger()) {
+            ipf4Conf.push('# smartos_ipf_version 2');
+        }
+        ipf4Conf.push('#', '');
         var ipf6Conf = ipf4Conf.slice();
         var iks = hasKey(keepInboundState, vm) ? keepInboundState[vm] : {};
 
         conf[vm].sort(compareRules).forEach(function (sortObj) {
             var ktxt = KEEP_FRAGS;
-            if ((sortObj.direction === 'from' && sortObj.action === 'allow')
+            if (sortObj.allTags !== ''
+                || (sortObj.direction === 'from' && sortObj.action === 'allow')
                 || (sortObj.direction === 'to' && iks[sortObj.protocol])) {
-                ktxt += KEEP_STATE;
+                ktxt += KEEP_STATE + sortObj.allTags;
             }
 
             if (!hasKey(rulesIncluded, sortObj.uuid)) {
@@ -1981,7 +2007,6 @@ function del(opts, callback) {
             throw new Error(
                 'Payload must contain one of: rvmUUIDs, uuids');
         }
-
     } catch (err) {
         return callback(err);
     }
@@ -2183,7 +2208,7 @@ function listRemoteVMs(opts, callback) {
 
             // XXX: support sorting by other fields, filtering
             var sortFn = function _sort(a, b) {
-                return (a.uuid > b.uuid) ? 1: -1;
+                return (a.uuid > b.uuid) ? 1 : -1;
             };
 
             log.debug('listRemoteVMs: finish');
@@ -2238,7 +2263,7 @@ function listRules(opts, callback) {
             // XXX: support sorting by other fields, filtering
             // (eg: enabled=true vm=<uuid>)
             var sortFn = function _defaultSort(a, b) {
-                return (a.uuid > b.uuid) ? 1: -1;
+                return (a.uuid > b.uuid) ? 1 : -1;
             };
             var mapFn = function _defaultMap(r) {
                 return r.serialize();
@@ -2709,7 +2734,6 @@ function getRemoteTargets(opts, callback) {
         if (opts.rules.length === 0) {
             throw new Error('Must specify rules');
         }
-
     } catch (err) {
         return callback(err);
     }
diff --git a/src/fw/node_modules/fwrule/rule.js b/src/fw/node_modules/fwrule/rule.js
index 8032a3ff..6904fe01 100644
--- a/src/fw/node_modules/fwrule/rule.js
+++ b/src/fw/node_modules/fwrule/rule.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2018, Joyent, Inc. All rights reserved.
+ * Copyright (c) 2019, Joyent, Inc. All rights reserved.
  *
  *
  * fwadm: firewall rule model
@@ -48,6 +48,7 @@ var FIELDS = [
     'description',
     'enabled',
     'global',
+    'log',
     'owner_uuid',
     'rule',
     'uuid',
@@ -379,6 +380,18 @@ function FwRule(data, opts) {
         this.enabled = false;
     }
 
+    if (hasOwnProperty(data, 'log')) {
+        if (!validators.bool(data.log)) {
+            errs.push(new validators.InvalidParamError('log',
+                'log must be true or false'));
+        }
+
+        this.log = data.log;
+    } else {
+        this.log = false;
+    }
+
+
     for (var s in STRING_PROPS) {
         var str = STRING_PROPS[s];
         if (hasOwnProperty(data, str)) {
@@ -591,6 +604,7 @@ FwRule.prototype.raw = function () {
     var raw = {
         action: this.action,
         enabled: this.enabled,
+        log: this.log,
         from: this.from,
         priority: this.priority,
         protocol: this.protocol,
diff --git a/src/fw/package.json b/src/fw/package.json
index 91311202..7e828eae 100644
--- a/src/fw/package.json
+++ b/src/fw/package.json
@@ -1,7 +1,7 @@
 {
   "name": "fw",
   "description": "Administrative tool for managing SmartOS VM firewalls",
-  "version": "1.1.1",
+  "version": "1.2.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "main": "./lib/fw.js",
@@ -16,7 +16,7 @@
     "clone": "0.1.4",
     "cmdln": "4.1.1",
     "extsprintf": "1.0.2",
-    "fwrule": "2.0.0",
+    "fwrule": "2.1.0",
     "ip6addr": "0.2.2",
     "mkdirp": "0.3.4",
     "uuid": "3.2.1",
diff --git a/src/fw/test/lib/mocks.js b/src/fw/test/lib/mocks.js
index d2fb1227..ab507f68 100644
--- a/src/fw/test/lib/mocks.js
+++ b/src/fw/test/lib/mocks.js
@@ -1,5 +1,5 @@
 /*
- * Copyright 2016, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc. All rights reserved.
  *
  * mocks for tests
  */
@@ -43,7 +43,8 @@ var MOCKS = {
         rename: rename,
         link: link,
         unlink: unlink,
-        writeFile: writeFile
+        writeFile: writeFile,
+        existsSync: existsSync
     },
     './locker': {
         acquireSharedLock: acquireLock,
@@ -238,6 +239,16 @@ function execFile(path, args, opts, cb) {
 
 // --- fs
 
+function existsSync(file) {
+    var p = _splitFile(file);
+    var root = VALUES.fs;
+
+    if (!hasKey(root, p.dir) || !hasKey(root[p.dir], p.file)) {
+        return false;
+    } else {
+        return true;
+    }
+}
 
 function stat(file, cb) {
     var p = _splitFile(file);
diff --git a/src/fw/test/unit/add.test.js b/src/fw/test/unit/add.test.js
index 1dd634b7..111a53f0 100644
--- a/src/fw/test/unit/add.test.js
+++ b/src/fw/test/unit/add.test.js
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2013, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm add unit tests
  */
@@ -9,13 +9,8 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
 var mod_uuid = require('uuid');
 var util = require('util');
-var util_vm = require('../../lib/util/vm');
-
-var createSubObjects = mod_obj.createSubObjects;
-var mergeObjects = mod_obj.mergeObjects;
 
 
 
@@ -26,7 +21,6 @@ var mergeObjects = mod_obj.mergeObjects;
 // Set this to any of the exports in this file to only run that test,
 // plus setup and teardown
 var runOne;
-var printVMs = false;
 
 
 
@@ -84,6 +78,8 @@ exports['created_by'] = function (t) {
 
     var expRules = clone(payload.rules);
     expRules[0].created_by = payload.createdBy;
+    expRules[0].log = false;
+    expRules[1].log = false;
 
     var expRulesOnDisk = {};
 
@@ -139,6 +135,7 @@ exports['created_by'] = function (t) {
         changing.version = '2383205215597.167882';
         expRules = clone(payload.rules);
         expRules[0].created_by = payload.createdBy;
+        expRules[0].log = false;
         expRulesOnDisk[changing.uuid].version = changing.version;
 
         fw.add(payload, function (err, res) {
@@ -167,6 +164,8 @@ exports['created_by'] = function (t) {
         payload.rules[1].uuid = mod_uuid.v4();
         expRules = clone(payload.rules);
         expRules[0].created_by = payload.createdBy;
+        expRules[0].log = false;
+        expRules[1].log = false;
 
         fw.update(payload, function (err, res) {
             t.ifError(err);
diff --git a/src/fw/test/unit/fw.test.js b/src/fw/test/unit/fw.test.js
index cee15158..2a46efb2 100644
--- a/src/fw/test/unit/fw.test.js
+++ b/src/fw/test/unit/fw.test.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2018, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm tests
  */
@@ -30,13 +30,7 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
-var mod_uuid = require('uuid');
 var util = require('util');
-var util_vm = require('../../lib/util/vm');
-
-var mergeObjects = mod_obj.mergeObjects;
-
 
 
 // --- Globals
@@ -78,7 +72,8 @@ exports['add: no rules or VMs'] = function (t) {
     fw.add({}, function (err, res) {
         t.ok(err, 'error returned');
         if (!err) {
-            return t.done();
+            t.done();
+            return;
         }
 
         t.equal(err.message, 'opts.vms ([object]) required', 'VMs required');
@@ -124,7 +119,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             t.ok(res.rules[0].uuid, 'rule has a uuid');
@@ -133,6 +129,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
             t.ok(res.rules[0].version, 'rule has a version');
             expRule.version = res.rules[0].version;
 
+            expRule.log = false;
+
             t.deepEqual(res, {
                 vms: [ vm.uuid ],
                 rules: [ expRule ]
@@ -157,22 +155,22 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwGetEquals(t, expRule, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwListEquals(t, [expRule], cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.vmsAffected({
             t: t,
             allVMs: [vm],
             rule: expRule,
             vms: [vm]
         }, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         var updatePayload = {
             rules: [
                 {
@@ -188,7 +186,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
         fw.update(updatePayload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             t.equal(res.rules[0].uuid, expRule.uuid, 'uuid is the same');
@@ -219,30 +218,30 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwGetEquals(t, expRule, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwListEquals(t, [expRule], cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwRulesEqual({
             t: t,
             rules: [ expRule ],
             vm: vm,
             vms: [vm]
         }, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.vmsAffected({
             t: t,
             allVMs: [vm],
             rule: expRule,
             vms: [vm]
         }, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         // Disabling and re-enabling the firewall should have no effect on the
         // zone rules
         helpers.testEnableDisable({
@@ -250,7 +249,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
             vm: vm,
             vms: [vm]
         }, cb);
-    }, function (cb) {
+    },
+    function (cb) {
         // Delete the rule - the firewall should remain running, but only the
         // default rules should remain
 
@@ -262,7 +262,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
         fw.del(delPayload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             t.deepEqual(res, {
@@ -284,8 +285,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwRulesEqual({
             t: t,
             rules: [ ],
@@ -294,7 +295,8 @@ exports['add / update: vm to IP: BLOCK'] = function (t) {
         }, cb);
     }
 
-    ], function () {
+    ],
+    function () {
         t.done();
     });
 };
@@ -321,7 +323,8 @@ exports['add / update: vm to IP: ALLOW'] = function (t) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             helpers.fillInRuleBlanks(res.rules, expRule);
@@ -347,13 +350,10 @@ exports['add / update: vm to IP: ALLOW'] = function (t) {
 
             cb();
         });
-
     }, function (cb) {
         helpers.fwGetEquals(t, expRule, cb);
-
     }, function (cb) {
         helpers.fwListEquals(t, [expRule], cb);
-
     }, function (cb) {
         helpers.vmsAffected({
             t: t,
@@ -361,7 +361,6 @@ exports['add / update: vm to IP: ALLOW'] = function (t) {
             rule: expRule,
             vms: [vm]
         }, cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -378,8 +377,8 @@ exports['add / update: vm to IP: ALLOW'] = function (t) {
 
 
 exports['add: tag to IP'] = function (t) {
-    var vm1 = helpers.generateVM({ tags: { foo : true } });
-    var vm2 = helpers.generateVM({ tags: { foo : true } });
+    var vm1 = helpers.generateVM({ tags: { foo: true } });
+    var vm2 = helpers.generateVM({ tags: { foo: true } });
     var payload = {
         rules: [
             {
@@ -398,7 +397,8 @@ exports['add: tag to IP'] = function (t) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             t.ok(res.rules[0].uuid, 'rule has a uuid');
@@ -409,6 +409,9 @@ exports['add: tag to IP'] = function (t) {
             expRule.version = res.rules[0].version;
             delete res.rules[0].version;
 
+            expRule.log = false;
+            payload.rules[0].log = false;
+
             t.deepEqual(res, {
                 vms: [ vm1.uuid, vm2.uuid ],
                 rules: [ payload.rules[0] ]
@@ -437,17 +440,14 @@ exports['add: tag to IP'] = function (t) {
 
             cb();
         });
-
     }, function (cb) {
         fw.get({ uuid: expRule.uuid }, function (err, res) {
             t.ifError(err);
             t.deepEqual(res, expRule, 'get returns same rule');
             cb();
         });
-
     }, function (cb) {
         helpers.fwListEquals(t, [expRule], cb);
-
     }, function (cb) {
         helpers.vmsAffected({
             t: t,
@@ -455,7 +455,6 @@ exports['add: tag to IP'] = function (t) {
             rule: expRule,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -463,7 +462,6 @@ exports['add: tag to IP'] = function (t) {
             vm: vm1,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -479,8 +477,8 @@ exports['add: tag to IP'] = function (t) {
 
 
 exports['add: tag to subnet'] = function (t) {
-    var vm1 = helpers.generateVM({ tags: { foo : true } });
-    var vm2 = helpers.generateVM({ tags: { foo : true } });
+    var vm1 = helpers.generateVM({ tags: { foo: true } });
+    var vm2 = helpers.generateVM({ tags: { foo: true } });
     var payload = {
         rules: [
             {
@@ -506,14 +504,14 @@ exports['add: tag to subnet'] = function (t) {
     function (cb) {
         fw.validatePayload(payload, function (err, res) {
             t.ifError(err);
-            return cb();
+            cb();
         });
-
     }, function (cb) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb(err);
+                cb(err);
+                return;
             }
 
             helpers.fillInRuleBlanks(res.rules, [rule1, rule2]);
@@ -554,17 +552,14 @@ exports['add: tag to subnet'] = function (t) {
 
             cb();
         });
-
     }, function (cb) {
         fw.get({ uuid: rule1.uuid }, function (err, res) {
             t.ifError(err);
             t.deepEqual(res, rule1, 'get returns same rule');
             cb();
         });
-
     }, function (cb) {
         helpers.fwListEquals(t, [rule1, rule2].sort(helpers.uuidSort), cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -572,7 +567,6 @@ exports['add: tag to subnet'] = function (t) {
             vm: vm1,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -580,7 +574,6 @@ exports['add: tag to subnet'] = function (t) {
             vm: vm2,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.vmsAffected({
             t: t,
@@ -588,7 +581,6 @@ exports['add: tag to subnet'] = function (t) {
             rule: rule1,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.vmsAffected({
             t: t,
@@ -596,7 +588,6 @@ exports['add: tag to subnet'] = function (t) {
             rule: rule2,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.testEnableDisable({
             t: t,
@@ -611,9 +602,9 @@ exports['add: tag to subnet'] = function (t) {
 
 
 exports['add: vm to subnet'] = function (t) {
-    var vm1 = helpers.generateVM({ tags: { foo : true } });
+    var vm1 = helpers.generateVM({ tags: { foo: true } });
     // Not the target of the rule:
-    var vm2 = helpers.generateVM({ tags: { foo : true } });
+    var vm2 = helpers.generateVM({ tags: { foo: true } });
     var payload = {
         rules: [
             {
@@ -641,14 +632,14 @@ exports['add: vm to subnet'] = function (t) {
     function (cb) {
         fw.validatePayload(payload, function (err, res) {
             t.ifError(err);
-            return cb();
+            cb();
         });
-
     }, function (cb) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb(err);
+                cb(err);
+                return;
             }
 
             helpers.fillInRuleBlanks(res.rules, [rule1, rule2]);
@@ -682,17 +673,14 @@ exports['add: vm to subnet'] = function (t) {
 
             cb();
         });
-
     }, function (cb) {
         fw.get({ uuid: rule1.uuid }, function (err, res) {
             t.ifError(err);
             t.deepEqual(res, rule1, 'get returns same rule');
             cb();
         });
-
     }, function (cb) {
         helpers.fwListEquals(t, [rule1, rule2].sort(helpers.uuidSort), cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -700,7 +688,6 @@ exports['add: vm to subnet'] = function (t) {
             vm: vm1,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.fwRulesEqual({
             t: t,
@@ -708,7 +695,6 @@ exports['add: vm to subnet'] = function (t) {
             vm: vm2,
             vms: [vm1, vm2]
         }, cb);
-
     }, function (cb) {
         helpers.vmsAffected({
             t: t,
@@ -716,7 +702,6 @@ exports['add: vm to subnet'] = function (t) {
             rule: rule1,
             vms: [vm1]
         }, cb);
-
     }, function (cb) {
         // Ensure we can use the rule UUID to check
         helpers.vmsAffected({
@@ -725,7 +710,6 @@ exports['add: vm to subnet'] = function (t) {
             rule: rule1.uuid,
             vms: [vm1]
         }, cb);
-
     }, function (cb) {
         helpers.vmsAffected({
             t: t,
@@ -733,7 +717,6 @@ exports['add: vm to subnet'] = function (t) {
             rule: rule2,
             vms: [vm1]
         }, cb);
-
     }, function (cb) {
         // Ensure we can use the rule UUID to check
         helpers.vmsAffected({
@@ -806,8 +789,8 @@ exports['sorting: multiple ip and subnet rules'] = function (t) {
             t.ifError(err);
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
@@ -853,18 +836,17 @@ exports['sorting: multiple ip and subnet rules'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwListEquals(t, rules.sort(helpers.uuidSort), cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwRulesEqual({
             t: t,
             rules: rules,
             vm: vm,
             vms: [vm]
         }, cb);
-
     }
     ], function () {
         t.done();
@@ -929,8 +911,8 @@ exports['sorting: multiple icmp types'] = function (t) {
             t.ifError(err);
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
@@ -976,18 +958,17 @@ exports['sorting: multiple icmp types'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwListEquals(t, rules.sort(helpers.uuidSort), cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwRulesEqual({
             t: t,
             rules: rules,
             vm: vm,
             vms: [vm]
         }, cb);
-
     }
     ], function () {
         t.done();
@@ -1003,7 +984,8 @@ exports['enable / disable rule'] = function (t) {
                 owner_uuid: vm.owner_uuid,
                 rule: util.format('FROM vm %s TO ip 192.168.5.2 BLOCK tcp '
                                 + 'PORT 25', vm.uuid),
-                enabled: false
+                enabled: false,
+                log: true
             }
         ],
         vms: [vm]
@@ -1019,7 +1001,8 @@ exports['enable / disable rule'] = function (t) {
         fw.add(payload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             helpers.fillInRuleBlanks(res.rules, expRule);
@@ -1042,22 +1025,22 @@ exports['enable / disable rule'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwGetEquals(t, expRule, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwListEquals(t, [expRule], cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.fwRulesEqual({
             t: t,
             rules: [expRule],
             vm: vm,
             vms: [vm]
         }, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         // Even though the rule is disabled, it should still show up as
         // affected
         helpers.vmsAffected({
@@ -1066,8 +1049,8 @@ exports['enable / disable rule'] = function (t) {
             rule: expRule,
             vms: [vm]
         }, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         // Update the rule - it should still not affect the VM
         var updatePayload = {
             rules: [
@@ -1084,7 +1067,8 @@ exports['enable / disable rule'] = function (t) {
         fw.update(updatePayload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             expRule.version = res.rules[0].version;
@@ -1103,15 +1087,16 @@ exports['enable / disable rule'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         // Add an enabled rule - disabled rule should still not affect the vm
         var addPayload = {
             rules: [
                 {
                     owner_uuid: vm.owner_uuid,
                     rule: 'FROM any TO all vms ALLOW tcp PORT 33',
-                    enabled: true
+                    enabled: true,
+                    log: true
                 }
             ],
             vms: [vm]
@@ -1121,7 +1106,8 @@ exports['enable / disable rule'] = function (t) {
         fw.add(addPayload, function (err, res) {
             t.ifError(err);
             if (err) {
-                return cb();
+                cb();
+                return;
             }
 
             helpers.fillInRuleBlanks(res.rules, expRule2);
@@ -1134,7 +1120,6 @@ exports['enable / disable rule'] = function (t) {
                 [ helpers.allowPortInTCP('any', 33) ];
             v6rules[vm.uuid].in.tcp =
                 [ helpers.allowPortInTCP('any', 33) ];
-
             t.deepEqual(helpers.zoneIPFconfigs(4), v4rules,
                 'zone ipf.conf files still the same');
             t.deepEqual(helpers.zoneIPFconfigs(6), v6rules,
@@ -1145,16 +1130,16 @@ exports['enable / disable rule'] = function (t) {
 
             cb();
         });
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.vmsAffected({
             t: t,
             allVMs: [vm],
             rule: expRule,
             vms: [vm]
         }, cb);
-
-    }, function (cb) {
+    },
+    function (cb) {
         helpers.vmsAffected({
             t: t,
             allVMs: [vm],
@@ -1169,11 +1154,13 @@ exports['enable / disable rule'] = function (t) {
 };
 
 
+
 exports['del: no uuids or rvmUUIDs'] = function (t) {
     fw.del({ vms: [ helpers.generateVM() ] }, function (err, res) {
         t.ok(err, 'error returned');
         if (!err) {
-            return t.done();
+            t.done();
+            return;
         }
 
         t.equal(err.message, 'Payload must contain one of: rvmUUIDs, uuids',
diff --git a/src/fw/test/unit/global.test.js b/src/fw/test/unit/global.test.js
index dfbea8fd..f86685f5 100644
--- a/src/fw/test/unit/global.test.js
+++ b/src/fw/test/unit/global.test.js
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2013, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm add unit tests
  */
@@ -9,14 +9,6 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
-var mod_uuid = require('uuid');
-var util = require('util');
-var util_vm = require('../../lib/util/vm');
-
-var createSubObjects = mod_obj.createSubObjects;
-var mergeObjects = mod_obj.mergeObjects;
-
 
 
 // --- Globals
@@ -26,7 +18,6 @@ var mergeObjects = mod_obj.mergeObjects;
 // Set this to any of the exports in this file to only run that test,
 // plus setup and teardown
 var runOne;
-var printVMs = false;
 
 
 
@@ -73,6 +64,7 @@ exports['global'] = function (t) {
 
     var expRules = clone(payload.rules);
     expRules[0].created_by = payload.createdBy;
+    expRules[0].log = false;
 
     var expRulesOnDisk = {};
 
diff --git a/src/fw/test/unit/icmp.test.js b/src/fw/test/unit/icmp.test.js
index 53deb355..89ca2d07 100644
--- a/src/fw/test/unit/icmp.test.js
+++ b/src/fw/test/unit/icmp.test.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2016, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm tests : ICMP
  */
@@ -30,14 +30,7 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
-var mod_uuid = require('uuid');
 var util = require('util');
-var util_vm = require('../../lib/util/vm');
-
-var createSubObjects = mod_obj.createSubObjects;
-var mergeObjects = mod_obj.mergeObjects;
-
 
 
 // --- Globals
@@ -106,6 +99,7 @@ exports['add / update ICMPv4'] = function (t) {
             expRule.uuid = res.rules[0].uuid;
             t.ok(res.rules[0].version, 'rule has a version');
             expRule.version = res.rules[0].version;
+            expRule.log = false;
 
             t.deepEqual(res, {
                 vms: [ vm.uuid ],
@@ -155,6 +149,7 @@ exports['add / update ICMPv4'] = function (t) {
             t.ok(res.rules[0].version, 'rule has a version');
             expRule.version = res.rules[0].version;
             expRule.rule = res.rules[0].rule;
+            expRule.log = false;
 
             t.deepEqual(res, {
                 vms: [ vm.uuid ],
@@ -327,6 +322,7 @@ exports['add / update ICMPv6'] = function (t) {
             expRule.uuid = res.rules[0].uuid;
             t.ok(res.rules[0].version, 'rule has a version');
             expRule.version = res.rules[0].version;
+            expRule.log = false;
 
             t.deepEqual(res, {
                 vms: [ vm.uuid ],
diff --git a/src/fw/test/unit/owner.test.js b/src/fw/test/unit/owner.test.js
index 9e229b9e..88d3a940 100644
--- a/src/fw/test/unit/owner.test.js
+++ b/src/fw/test/unit/owner.test.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2018, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * test rules with owner_uuid set
  */
@@ -30,12 +30,9 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
 var mod_uuid = require('uuid');
 var util = require('util');
 
-var createSubObjects = mod_obj.createSubObjects;
-
 
 
 // --- Globals
@@ -106,6 +103,8 @@ exports['tag to IP'] = function (t) {
             expRule.version = res.rules[0].version;
             delete res.rules[0].version;
 
+            payload.rules[0].log = expRule.log = false;
+
             t.deepEqual(res, {
                 vms: [ vm2.uuid ],
                 rules: [ payload.rules[0] ]
@@ -174,6 +173,8 @@ exports['tag to IP'] = function (t) {
             t.ok(res.rules[0].version, 'rule has a version');
             delete res.rules[0].version;
 
+            expRule2.log = payload2.rules[0].log = false;
+
             t.deepEqual(res, {
                 vms: [ vm1.uuid, vm2.uuid ],
                 rules: [ payload2.rules[0] ]
diff --git a/src/fw/test/unit/tags.test.js b/src/fw/test/unit/tags.test.js
index 27dbc245..5ebbe82a 100644
--- a/src/fw/test/unit/tags.test.js
+++ b/src/fw/test/unit/tags.test.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright 2017, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm test: tags
  */
@@ -30,9 +30,7 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_addr = require('ip6addr');
 var mod_obj = require('../../lib/util/obj');
-var mod_uuid = require('uuid');
 var net = require('net');
 var util = require('util');
 var util_vm = require('../../lib/util/vm');
@@ -181,6 +179,7 @@ exports['add / update: tag to tag'] = function (t) {
 
             rule1.uuid = res.rules[0].uuid;
             rule1.version = res.rules[0].version;
+            rule1.log = false;
             t.deepEqual(helpers.sortRes(res), {
                 vms: tagOneVMs.map(getUUID).sort(),
                 rules: [ rule1 ]
@@ -1011,6 +1010,7 @@ exports['tags with values'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[0].version = res.rules[0].version;
+            expRules[0].log = false;
 
             t.deepEqual(helpers.sortRes(res), {
                 remoteVMs: helpers.sortedUUIDs([rvm1, rvm2, rvm3]),
@@ -1077,6 +1077,8 @@ exports['tags with values'] = function (t) {
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[1].version = res.rules[0].version;
 
+            expRules[1].log = false;
+
             t.deepEqual(helpers.sortRes(res), {
                 vms: [ vm2.uuid, vm4.uuid, vm5.uuid ].sort(),
                 rules: [ expRules[1] ]
diff --git a/src/fw/test/unit/update.test.js b/src/fw/test/unit/update.test.js
index 71931205..c36ac966 100644
--- a/src/fw/test/unit/update.test.js
+++ b/src/fw/test/unit/update.test.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2016, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm update unit tests
  */
@@ -30,12 +30,8 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
 var mod_uuid = require('uuid');
 var util = require('util');
-var util_vm = require('../../lib/util/vm');
-
-var mergeObjects = mod_obj.mergeObjects;
 
 
 
@@ -46,7 +42,6 @@ var mergeObjects = mod_obj.mergeObjects;
 // Set this to any of the exports in this file to only run that test,
 // plus setup and teardown
 var runOne;
-var printVMs = false;
 
 
 
@@ -115,6 +110,7 @@ exports['update non-existent rule'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[0].version = res.rules[0].version;
+            expRules[0].log = false;
 
             t.deepEqual(res, {
                 rules: expRules,
@@ -191,6 +187,7 @@ exports['description and created_by'] = function (t) {
                 return cb();
             }
 
+            expRules[0].log = false;
             t.deepEqual(res, {
                 rules: expRules,
                 vms: [ payload.vms[0].uuid ]
@@ -212,6 +209,7 @@ exports['description and created_by'] = function (t) {
         payload.rules[0].description = 'two';
 
         expRules = [clone(payload.rules[0])];
+        expRules[0].log = false;
         fw.update(payload, function (err, res) {
             t.ifError(err);
             if (err) {
@@ -298,6 +296,7 @@ exports['FWAPI-237: Ignore rules that don\'t change'] = function (t) {
 
                 t.ok(res.rules[i].version, 'rule has a version');
                 expRules[i].version = res.rules[i].version;
+                expRules[i].log = false;
             }
 
             t.deepEqual(helpers.sortRes(res), helpers.sortRes({
@@ -363,6 +362,7 @@ exports['FWAPI-237: Ignore rules that don\'t change'] = function (t) {
                 return cb();
             }
 
+            updatePayload.rules[0].log = false;
             // This rule should only affect the VM that it mentions.
             t.deepEqual(helpers.sortRes(res), {
                 vms: [ vm1.uuid ],
@@ -430,6 +430,7 @@ exports['FWAPI-237: Ignore rules that don\'t change'] = function (t) {
             if (err) {
                 return cb();
             }
+            addPayload.rules[0].log = false;
 
             t.deepEqual(helpers.sortRes(res), {
                 vms: [ vm1.uuid, vm2.uuid, vm3.uuid ],
diff --git a/src/fw/test/unit/wildcards.test.js b/src/fw/test/unit/wildcards.test.js
index af8d267b..0b3dfe16 100644
--- a/src/fw/test/unit/wildcards.test.js
+++ b/src/fw/test/unit/wildcards.test.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2018, Joyent, Inc. All rights reserved.
+ * Copyright 2019 Joyent, Inc.
  *
  * fwadm tests: all and any targets
  */
@@ -30,14 +30,7 @@ var clone = require('clone');
 var fw;
 var helpers = require('../lib/helpers');
 var mocks = require('../lib/mocks');
-var mod_obj = require('../../lib/util/obj');
-var mod_uuid = require('uuid');
 var util = require('util');
-var util_vm = require('../../lib/util/vm');
-
-var createSubObjects = mod_obj.createSubObjects;
-var mergeObjects = mod_obj.mergeObjects;
-
 
 
 // --- Globals
@@ -109,6 +102,7 @@ exports['any <-> vm: add / update'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[0].version = res.rules[0].version;
+            expRules[0].log = false;
 
             t.deepEqual(res, {
                 rules: expRules,
@@ -169,6 +163,7 @@ exports['any <-> vm: add / update'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[1].version = res.rules[0].version;
+            expRules[1].log = false;
 
             t.deepEqual(res, {
                 vms: [ vm.uuid ],
@@ -636,6 +631,7 @@ exports['add / update: all ports'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[0].version = res.rules[0].version;
+            expRules[0].log = false;
 
             t.deepEqual(res, {
                 rules: expRules,
@@ -691,6 +687,7 @@ exports['add / update: all ports'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[1].version = res.rules[0].version;
+            expRules[1].log = false;
 
             t.deepEqual(res, {
                 vms: [ vm.uuid ],
@@ -749,6 +746,7 @@ exports['add / update: all ports'] = function (t) {
 
             t.ok(res.rules[0].version, 'rule has a version');
             expRules[1].version = res.rules[0].version;
+            expRules[1].log = false;
 
             t.deepEqual(helpers.sortRes(res), {
                 vms: [ vm.uuid, vm2.uuid ].sort(),
