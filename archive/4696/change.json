{"project":"joyent/illumos-kvm","branch":"master","topic":"OS-7080","id":"I08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735","number":"4696","subject":"OS-7080 bhyve and KVM should coexist in peace OS-7126 KVM queries host MSRs dangerously OS-7154 kvm lacks preempt protection for installctx OS-7155 KVM uses wrong cpu ID Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003c","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/4696","commitMessage":"OS-7080 bhyve and KVM should coexist in peace\nOS-7126 KVM queries host MSRs dangerously\nOS-7154 kvm lacks preempt protection for installctx\nOS-7155 KVM uses wrong cpu ID\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1534377046,"lastUpdated":1534877988,"open":false,"status":"MERGED","comments":[{"timestamp":1534377046,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1534447740,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1534454324,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(2 comments)\n\nI\u0027m not an expert in kvm, but from what I can see this looks fine. I saw a few small nits. I\u0027m going to look at the other half of this CR, then come back to this for a second look."},{"timestamp":1534461322,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1534461401,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1534461592,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1534462686,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1534517047,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1534523707,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1534774297,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Topic set to OS-7080"},{"timestamp":1534776154,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(1 comment)\n\nOnly a single very minor nit :)"},{"timestamp":1534792430,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1534792462,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1534795294,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534800598,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534803531,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1534873890,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nTesting covered in OS-7080 ticket."},{"timestamp":1534873948,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1534874258,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1534874271,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Integration-Approval-1\n\nwaiting on flag-day email"},{"timestamp":1534877938,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: -Integration-Approval"},{"timestamp":1534877988,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"5","revision":"08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735","parents":["e05dd9f674b33879dce5db3fe3187092b4a0e24e"],"ref":"refs/changes/96/4696/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534874258,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534795294,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534800598,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534803531,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534873948,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1534877988,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":14,"deletions":0},{"file":"kvm.c","type":"MODIFIED","insertions":26,"deletions":-120},{"file":"kvm_host.h","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"kvm_vmx.c","type":"MODIFIED","insertions":89,"deletions":-251},{"file":"kvm_x86.c","type":"MODIFIED","insertions":41,"deletions":-72},{"file":"kvm_x86.h","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"msr-index.h","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":159,"sizeDeletions":-463},"patchSets":[{"number":"1","revision":"412d70392904959a607681229f8c1b80741d86eb","parents":["e05dd9f674b33879dce5db3fe3187092b4a0e24e"],"ref":"refs/changes/96/4696/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534377046,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"kvm.c","type":"MODIFIED","insertions":26,"deletions":-120},{"file":"kvm_host.h","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"kvm_vmx.c","type":"MODIFIED","insertions":90,"deletions":-238},{"file":"kvm_x86.c","type":"MODIFIED","insertions":41,"deletions":-72},{"file":"kvm_x86.h","type":"MODIFIED","insertions":1,"deletions":-14}],"sizeInsertions":160,"sizeDeletions":-449},{"number":"2","revision":"a3d55648ea64daa002fe840fea4c6a2d39ea25bf","parents":["e05dd9f674b33879dce5db3fe3187092b4a0e24e"],"ref":"refs/changes/96/4696/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534447740,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"kvm.c","line":494,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess we were always doing this incorrectly and if we were pre-empted between installctx() and kpreempt_disabled() in the past, that\u0027d be awkward."},{"file":"kvm.c","line":498,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Using \u0027seqid\u0027 here was an error on my part, and could have lead to improper behavior for CPU kicks if it differs from cpu_id."},{"file":"kvm.c","line":522,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027m not sure why this was changed from the previous code. Am I missing something?"},{"file":"kvm.c","line":522,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The vcpu-\u003ecpu should be unassigned when VMX unloads it, so it\u0027s cached beforehand so the event contains the right CPU ID.  The vmx_vcpu_put routine was missing the logic to assign -1 to vcpu-\u003ecpu, so I\u0027ve fixed that."},{"file":"kvm_vmx.c","line":865,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"this could be inside the conditional"},{"file":"kvm_vmx.c","line":865,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"kvm.c","type":"MODIFIED","insertions":26,"deletions":-120},{"file":"kvm_host.h","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"kvm_vmx.c","type":"MODIFIED","insertions":87,"deletions":-251},{"file":"kvm_x86.c","type":"MODIFIED","insertions":41,"deletions":-72},{"file":"kvm_x86.h","type":"MODIFIED","insertions":1,"deletions":-14}],"sizeInsertions":157,"sizeDeletions":-462},{"number":"3","revision":"8288dbbafcf7dbd76cfe6edb604dd9e3b392c0a3","parents":["e05dd9f674b33879dce5db3fe3187092b4a0e24e"],"ref":"refs/changes/96/4696/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534461322,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534517047,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"kvm.c","line":473,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Would you mind just creating a separate bug ID for this and the installctx so when coming back later we can know these explicit problems where here? No need for separate commit."},{"file":"kvm.c","line":473,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sure"},{"file":"kvm_vmx.c","line":488,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason we don\u0027t have a memory attribute here ala vmcs_clear?"},{"file":"kvm_vmx.c","line":488,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"That\u0027s how it was in the old vmx_vcpu_load, but I can\u0027t think of a good reason to omit something cautious like that."},{"file":"kvm_vmx.c","line":4508,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"preceding\""},{"file":"kvm_vmx.c","line":4508,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"kvm.c","type":"MODIFIED","insertions":26,"deletions":-120},{"file":"kvm_host.h","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"kvm_vmx.c","type":"MODIFIED","insertions":89,"deletions":-251},{"file":"kvm_x86.c","type":"MODIFIED","insertions":41,"deletions":-72},{"file":"kvm_x86.h","type":"MODIFIED","insertions":1,"deletions":-14}],"sizeInsertions":159,"sizeDeletions":-462},{"number":"4","revision":"8dbd12bd2cc0f44ea1a2b5fd726412a6a15fc8ee","parents":["e05dd9f674b33879dce5db3fe3187092b4a0e24e"],"ref":"refs/changes/96/4696/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534792430,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534800598,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534795294,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534803531,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534873948,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"kvm.c","type":"MODIFIED","insertions":26,"deletions":-120},{"file":"kvm_host.h","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"kvm_vmx.c","type":"MODIFIED","insertions":89,"deletions":-251},{"file":"kvm_x86.c","type":"MODIFIED","insertions":41,"deletions":-72},{"file":"kvm_x86.h","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"msr-index.h","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":159,"sizeDeletions":-463},{"number":"5","revision":"08e1d7f3a86f3f4f8d6e6aea59a0b4074b31c735","parents":["e05dd9f674b33879dce5db3fe3187092b4a0e24e"],"ref":"refs/changes/96/4696/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1534874258,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534800598,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534795294,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1534877988,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1534803531,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534873948,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":14,"deletions":0},{"file":"kvm.c","type":"MODIFIED","insertions":26,"deletions":-120},{"file":"kvm_host.h","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"kvm_vmx.c","type":"MODIFIED","insertions":89,"deletions":-251},{"file":"kvm_x86.c","type":"MODIFIED","insertions":41,"deletions":-72},{"file":"kvm_x86.h","type":"MODIFIED","insertions":1,"deletions":-14},{"file":"msr-index.h","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":159,"sizeDeletions":-463}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}