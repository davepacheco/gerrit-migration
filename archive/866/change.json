{"project":"joyent/sdc-cnapi","branch":"master","id":"I33ee9296cdb47d33a50d112e466cf17594876fc2","number":"866","subject":"CNAPI-677 Add support for disklayout params to server setup Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e Reviewed by: Trent Mick \u003ctrent.mick@joyent.co","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/866","commitMessage":"CNAPI-677 Add support for disklayout params to server setup\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Orlando Vazquez \u003corlando@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1478711322,"lastUpdated":1478868969,"open":false,"status":"MERGED","comments":[{"timestamp":1478711322,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1478711358,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478732099,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(3 comments)\n\nI think this looks reasonable, though I\u0027m not as familiar with CNAPI.\n\nOne major issue I see is that there are no updates to the CNAPI docs for this, which I think is important."},{"timestamp":1478788034,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)\n\nI too am not really familiar with CNAPI but this looks good to me. Is there anybody else who knows CNAPI who should also review this? I don\u0027t have anything to add beyond Robert\u0027s comments."},{"timestamp":1478794688,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\n(1 comment)\n\nOnce we\u0027ve agreed with the parameter names, I\u0027ll add the required changes to CNAPI documents and ask Orlando for a review of CNAPI code before we integrate. Thanks!"},{"timestamp":1478795716,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1478795805,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(1 comment)\n\nHelp added. Also, little explanation of the CNAPI check to avoid passing HTTP parameters set to empty strings"},{"timestamp":1478799946,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1478800871,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1478800933,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478809129,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1478809170,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478809274,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n(4 comments)\n\nApplied Orlando\u0027s suggested changes and replied to Trent\u0027s comments. Should we change CNAPI parameters from being prefixed by \"disk_\" to be prefixed by \"disklayout_\"?"},{"timestamp":1478810779,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1478810839,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478820713,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1478823685,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1478828992,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1478868969,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"4","revision":"33ee9296cdb47d33a50d112e466cf17594876fc2","parents":["e1d49bb4eae1d6c8060a16bf7d7bd6ba8937b747"],"ref":"refs/changes/66/866/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478810779,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478810839,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478820713,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478823685,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478823685,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1478868969,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"docs/index.md","line":1156,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we\u0027re going to say see disklayout, we should probably at least link to the online manual pages on smartos.org. Though, in general, it feels like we should probably actually describe this a bit more (though we can always do that in a follow up)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/endpoints/servers.js","type":"MODIFIED","insertions":37,"deletions":-2},{"file":"lib/models/server.js","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/workflows/server-setup.js","type":"MODIFIED","insertions":16,"deletions":-5}],"sizeInsertions":71,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"74aab5f1f0860310211e5b2dbfb109db874b723e","parents":["e1d49bb4eae1d6c8060a16bf7d7bd6ba8937b747"],"ref":"refs/changes/66/866/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478711322,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478711358,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/endpoints/servers.js","line":666,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What does single refer to here?"},{"file":"lib/endpoints/servers.js","line":666,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"\"single\" is the input type name string for disklayout. See disklayout(1m)."},{"file":"lib/endpoints/servers.js","line":666,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027d assume it\u0027s just a pool using a single device. From disklayout command:\n\n        [root@headnode (coal) ~]# disklayout -h\n        illegal option -- h\n        usage: /usr/node/bin/node [-f file] \u003clayout\u003e\n        supported layouts:\n                single\n                mirror\n                raidz1\n                raidz2"},{"file":"lib/models/server.js","line":1591,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason we need to special case this? How about we just always send it?"},{"file":"lib/models/server.js","line":1591,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"We can always send it, but then we\u0027ll need to handle it on the other end. I\u0027d prefer that the receiver not have to deal with it since we have less ability there for error handling and communication to the admin."},{"file":"lib/models/server.js","line":1598,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we need the secondary part of this \u0026\u0026 statement? I would expect that if we need it here, then we need something similar for the other checks, no?"},{"file":"lib/models/server.js","line":1598,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Because it can take the empty string as value and, on that case, a boolean check will result in it being false and we avoiding to pass in an empty value:\n\n        \u003e var params \u003d { disk_layout: \u0027\u0027};\n        undefined\n        \u003e params.hasOwnProperty(\u0027disk_layout\u0027);\n        true\n        \u003e params.disk_layout\n        \u0027\u0027\n        \u003e Boolean(params.hasOwnProperty(\u0027disk_layout\u0027) \u0026\u0026 params.disk_layout)\n        false"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/endpoints/servers.js","type":"MODIFIED","insertions":37,"deletions":-2},{"file":"lib/models/server.js","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/workflows/server-setup.js","type":"MODIFIED","insertions":15,"deletions":-4}],"sizeInsertions":67,"sizeDeletions":-6},{"number":"2","revision":"4e1582afee37c42ad158b4d7919a29775f5857d2","parents":["e1d49bb4eae1d6c8060a16bf7d7bd6ba8937b747"],"ref":"refs/changes/66/866/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478795716,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478800933,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":1157,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Does \u0027man disklayout\u0027 give more detail on what that number means? Perhaps it is obvious to others?"},{"file":"docs/index.md","line":1157,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Actually, no, it doesn\u0027t. It points to man zpool, which includes some documentation regarding Hot Spares and how to use them. Reading it, I\u0027d say that a better description would be something like \"Number of disk spares\"."},{"file":"lib/endpoints/servers.js","line":618,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"perhaps names for these things would be clearer then as: disklayout_spares, disklayout_cache, disklayout_type ?"},{"file":"lib/endpoints/servers.js","line":618,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"It could be possible. I\u0027m not married with either prefixing them with \"disk_\" or \"disklayout_\". Honestly, choose \"disk_\" to just make them shorter. I don\u0027t think that will create confusion but, as I\u0027ve said, if we prefer the \"disklayout_\" prefix I\u0027ll happily change it :-)"},{"file":"lib/endpoints/servers.js","line":618,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"For what it\u0027s worth, I wouldn\u0027t want to encode the name of disklayout in the implementation."},{"file":"lib/endpoints/servers.js","line":662,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"I\u0027d convert `params.disk_cache` to a boolean type here."},{"file":"lib/endpoints/servers.js","line":662,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/models/server.js","line":1594,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Small nit, but I usually try to pass into the model parameters which have already been cast to the correct type, so in this situation, the `params.disk_cache` would be passed into ModelServer#setup as a boolean, rather than a string representing a boolean type."},{"file":"lib/models/server.js","line":1594,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/endpoints/servers.js","type":"MODIFIED","insertions":37,"deletions":-2},{"file":"lib/models/server.js","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/workflows/server-setup.js","type":"MODIFIED","insertions":15,"deletions":-4}],"sizeInsertions":70,"sizeDeletions":-6},{"number":"3","revision":"c5c5d06ec02db59e9336c7548df2002662abc2fb","parents":["e1d49bb4eae1d6c8060a16bf7d7bd6ba8937b747"],"ref":"refs/changes/66/866/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478809129,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478809170,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/endpoints/servers.js","type":"MODIFIED","insertions":37,"deletions":-2},{"file":"lib/models/server.js","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/workflows/server-setup.js","type":"MODIFIED","insertions":16,"deletions":-5}],"sizeInsertions":71,"sizeDeletions":-7},{"number":"4","revision":"33ee9296cdb47d33a50d112e466cf17594876fc2","parents":["e1d49bb4eae1d6c8060a16bf7d7bd6ba8937b747"],"ref":"refs/changes/66/866/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478810779,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478810839,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478820713,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1478868969,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478823685,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478823685,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"comments":[{"file":"docs/index.md","line":1156,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we\u0027re going to say see disklayout, we should probably at least link to the online manual pages on smartos.org. Though, in general, it feels like we should probably actually describe this a bit more (though we can always do that in a follow up)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/endpoints/servers.js","type":"MODIFIED","insertions":37,"deletions":-2},{"file":"lib/models/server.js","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/workflows/server-setup.js","type":"MODIFIED","insertions":16,"deletions":-5}],"sizeInsertions":71,"sizeDeletions":-7}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}