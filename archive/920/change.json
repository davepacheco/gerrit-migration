{"project":"joyent/illumos-joyent","branch":"master","id":"I6bd01ddca2d0dd95b05bbc3db21df2e9bc2855b4","number":"920","subject":"OS-5792 lxbrand SIGEV_THREAD_ID timers inappropriately reuse allocation Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/920","commitMessage":"OS-5792 lxbrand SIGEV_THREAD_ID timers inappropriately reuse allocation\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1479436925,"lastUpdated":1480456146,"open":false,"status":"MERGED","comments":[{"timestamp":1479436925,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1479477441,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1479487606,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1479491204,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1479518595,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1479739136,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1479740618,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Integration-Approval-1\n\nBlocking merge until additional review is done and the next release window closes."},{"timestamp":1479783777,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(3 comments)\n\nYou should be able to remove B_SIGEV_THREAD_ID from common/brand/lx/sys/lx_brand.h common/brand/lx/os/lx_brand.c."},{"timestamp":1479832938,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1479833048,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(3 comments)\n\nI also removed the old B_SIGEV_THREAD_ID handler per Ryan\u0027s suggestion."},{"timestamp":1479834155,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1479841088,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1479843344,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1479843383,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1479844977,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1479847909,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1479927190,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review-1\n\n(5 comments)\n\nIn general, I feel like the changes to expose the new timer_setup and have lx populate the private members of the itimer_t is the wrong way to go here. Not only have we created this race condition, but it also means we have to start exposing a lot more internals of the subsystem.\n\nIs there some reason that we didn\u0027t just add a new timer_create function or variant thereof that allowed you to specify this custom callback (even if that took the itimer_t)? That means we don\u0027t need to start exposing all of the timer_release and delete calls that we did."},{"timestamp":1479933464,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(5 comments)"},{"timestamp":1479940539,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: -Code-Review\n\n(4 comments)"},{"timestamp":1479948870,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1479948884,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5."},{"timestamp":1480266754,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1480358213,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1480358240,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: -Integration-Approval"},{"timestamp":1480361012,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1480390024,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1480390091,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1480403074,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 7: Code-Review-1\n\n(1 comment)"},{"timestamp":1480439254,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 8."},{"timestamp":1480439265,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8: -Code-Review"},{"timestamp":1480445287,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1480453412,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 8:\n\nThis was retested with LTP on 32/64bit, including a specific run of the \u0027timers\u0027 suite.  While the CPUTIME-related tests failed as expected, the others were successful."},{"timestamp":1480455938,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1480456146,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"8","revision":"6bd01ddca2d0dd95b05bbc3db21df2e9bc2855b4","parents":["12fff98ee5917359b18247a1cf2e8292ab958f8b"],"ref":"refs/changes/20/920/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1480439254,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480445287,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480455938,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1480456146,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":172,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":452,"sizeDeletions":-350},"patchSets":[{"number":"1","revision":"eb404ef8d02d991b72c0252382f60396ef5caa27","parents":["9035d37f2dc0a9fee9342a2b7cc8a86621788ae7"],"ref":"refs/changes/20/920/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1479436925,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":281,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Could you add a comment explaining the constants in this macro. I realize the old user-level code did not have a comment."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":281,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sure, I\u0027ll go look up the history on it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":347,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Since it should not make an appearance, would an assert make sense here?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":347,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"An assert?  No, since that would be an easy vector for panic.  If you feel strongly about it, I\u0027ll add an lx_unsupported call, but really it\u0027s about ignoring invalid parameters with EINVAL."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":347,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Good point. I can re-review once you have finished on the other comment question."},{"file":"usr/src/uts/common/os/timer.c","line":607,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I am confused about your dual use of \u0027it\u0027 here and above at line 600. Don\u0027t you lose the handle to the cache? How is that actually used? I see the old code also did that, but I am still confused about this."},{"file":"usr/src/uts/common/os/timer.c","line":607,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"OS-5806"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-149},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":242,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":162,"deletions":-134},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":432,"sizeDeletions":-293},{"number":"2","revision":"6b5d5c313d84f5ac3d74526fcb419523875a4e46","parents":["b6ebeeac71aba19031ac94ed8f38ac1f180f5170"],"ref":"refs/changes/20/920/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1479518595,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479739136,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479739136,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1479740618,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","line":38,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"If you look at my original commit you\u0027ll see I added stdlib, unistd, and sys/syscall.h. You could remove these if you want."},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","line":38,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fixed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":329,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Perhaps keep the note from the original enum about how linux skips 3."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":329,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Wouldn\u0027t cstyle dictate we place these above the functions?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":329,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The definitions in the Linux src don\u0027t bother.  I\u0027m going to omit it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":329,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Moved."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-149},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":247,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":159,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":434,"sizeDeletions":-290},{"number":"3","revision":"a8642edc1beccd82a5c3d4ca0d56c285e5c198a8","parents":["dec418ad77ca1ad8b6560e627d4f4d4cee27ab5c"],"ref":"refs/changes/20/920/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1479832938,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479834155,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1479740618,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/os/timer.c","line":587,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Would it make sense to add an ASSERT(evp !\u003d NULL)?"},{"file":"usr/src/uts/common/os/timer.c","line":587,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Seems reasonable"},{"file":"usr/src/uts/common/os/timer.c","line":669,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I don\u0027t think you want the set_errno() here, timer_create() calls it."},{"file":"usr/src/uts/common/os/timer.c","line":669,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Right you are.  Fixed."},{"file":"usr/src/uts/common/os/timer.c","line":681,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I don\u0027t think you want the set_errno() here, timer_create() calls it."},{"file":"usr/src/uts/common/os/timer.c","line":681,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":159,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":439,"sizeDeletions":-350},{"number":"4","revision":"068627011c1290ee686c3107cd3488a823abe63b","parents":["dec418ad77ca1ad8b6560e627d4f4d4cee27ab5c"],"ref":"refs/changes/20/920/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1479843383,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479844977,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1479740618,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479847909,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":368,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Are the semantics here such that if SIGEV_SIGNAL is not set than sigev_signo can be anything?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":368,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The translated SIGEV_SIGNAL (covering both SIGEV_SIGNAL and SIGEV_THREAD_ID) is the only case where we\u0027ll do signal delivery.  In those cases, we want to make sure that the translated signo is valid.  For SIGEV_NONE, we don\u0027t care since there won\u0027t be any notification and the sigq will be unconditionally freed."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":368,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":444,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we use a constant to understand what this is?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":444,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I was a little on the fence about this.  The old emulation referenced the value directly.  Without support for the more complicated cases, I didn\u0027t want to go whole-hog on negative-clockid decoding.\n\nThis value is meant to maintain direct compatibility with the old (although knowingly wrong) behavior."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":444,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can the comment below indicate what this used to correspond to then?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":444,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Prior to this special case being put in place, there was no handling for negative clock IDs at all.  MapR demanded -2 in order to function."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":503,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t believe that this is safe to perform. Looking at all other uses of the flags and how this works today the itimer_t should not be modified this way after the timer backend has been called. Importantly there is zero synchronization between these flags and the firing of the timer that I can see.\n\nBasically once you finish your call to timer_setup() you\u0027ve already programmed the backend, so there\u0027s no reason to believe it can\u0027t fire before you execute again. Especially given that it doesn\u0027t need any locks in these models."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":503,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The timer is left locked by timer_setup.  This prevents it from being used in timer_settime(2) or timer_delete(2), which are the functions which would be racy in this situation.  I believe we are safe here."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":503,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I see, I guess the clock backend won\u0027t actually be in a position to fire or at least, that\u0027s the expectation."},{"file":"usr/src/uts/common/os/timer.c","line":456,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"You\u0027re missing the update for the IT_CALLBACK flag to this logic which explains why it\u0027s safe."},{"file":"usr/src/uts/common/os/timer.c","line":456,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"IT_CALLBACK is ORed into the flags for LX, so it falls under the purview of IT_SIGNAL."},{"file":"usr/src/uts/common/os/timer.c","line":456,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Perhaps we should somewhere say that it\u0027s illegal for IT_CALLBACK to be set and not IT_SIGNAL then."},{"file":"usr/src/uts/common/os/timer.c","line":456,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This would only be a problem if the callback expected that p_lock be held on entry if it were configured without IT_SIGNAL."},{"file":"usr/src/uts/common/sys/timer.h","line":103,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m really not a fan of having to pass the entire itimer_t into this callback and forcing the implementation of this down into subsystems. Maybe this would be better phrased as a way of having this help determine what sigqueue_t to use is.\n\nThis is the first time we\u0027re leaking the itimer_t to other subsystems, so it feels like we should have a good reason to not just encapsulate the logic we want here."},{"file":"usr/src/uts/common/sys/timer.h","line":103,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"As you noted in chat, timerfd is making use of itimer_t as well."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":160,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":440,"sizeDeletions":-350},{"number":"5","revision":"7faf6e6798eae003daa9fcdb73962341845b5fe1","parents":["e37c335e4639fbb0e0f2fc5f4efd7712783da31d"],"ref":"refs/changes/20/920/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1479948884,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480266754,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480361012,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480358213,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":172,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":452,"sizeDeletions":-350},{"number":"6","revision":"850e2318b19ab3183f27e7123ec4e308fe96fe07","parents":["90fa1a0e184c887ef2a0987fa046c3aeb6f12c6b"],"ref":"refs/changes/20/920/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1480390024,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480266754,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480361012,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480358213,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":172,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":452,"sizeDeletions":-350},{"number":"7","revision":"02623970c1e17b945539b8002514904c0ba0231f","parents":["90fa1a0e184c887ef2a0987fa046c3aeb6f12c6b"],"ref":"refs/changes/20/920/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1480390091,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480266754,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480361012,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1480403074,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480358213,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","line":132,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Needs to reference LX_SIGEV32_PAD_SIZE."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":172,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":452,"sizeDeletions":-350},{"number":"8","revision":"6bd01ddca2d0dd95b05bbc3db21df2e9bc2855b4","parents":["12fff98ee5917359b18247a1cf2e8292ab958f8b"],"ref":"refs/changes/20/920/8","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1480439254,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1480445287,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1480455938,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1480456146,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/common/clock.c","type":"MODIFIED","insertions":0,"deletions":-152},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":0,"deletions":-56},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_timer.c","type":"MODIFIED","insertions":251,"deletions":-2},{"file":"usr/src/uts/common/os/timer.c","type":"MODIFIED","insertions":172,"deletions":-131},{"file":"usr/src/uts/common/sys/timer.h","type":"MODIFIED","insertions":23,"deletions":-3}],"sizeInsertions":452,"sizeDeletions":-350}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}