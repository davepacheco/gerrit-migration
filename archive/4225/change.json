{"project":"joyent/illumos-joyent","branch":"master","id":"I7058c3c954af033fd27362cf841933da915322f1","number":"4225","subject":"OS-7017 rescan cpuid after ucode updates OS-7018 Need cpuid detection for security sec features Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/4225","commitMessage":"OS-7017 rescan cpuid after ucode updates\nOS-7018 Need cpuid detection for security sec features\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1529011132,"lastUpdated":1529443184,"open":false,"status":"MERGED","comments":[{"timestamp":1529011132,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1529066931,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(14 comments)"},{"timestamp":1529338686,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1529338704,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(14 comments)"},{"timestamp":1529339629,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1529358707,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1529358708,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1529361660,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1529417154,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1529432125,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Integration-Approval+1\n\nTesting notes look good, given there are no current consumers of the feature bits that are being rescanned."},{"timestamp":1529442855,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1529443120,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1529443184,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"5","revision":"7058c3c954af033fd27362cf841933da915322f1","parents":["f367310f219802eaffd224b4cdddf2133302efa6"],"ref":"refs/changes/25/4225/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1529443120,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529361660,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529417154,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529432125,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1529443184,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":245,"deletions":-3},{"file":"usr/src/uts/i86pc/os/microcode.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/os/mlsetup.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/mp_startup.c","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":47,"deletions":-2}],"sizeInsertions":314,"sizeDeletions":-22},"patchSets":[{"number":"1","revision":"fd16a165ddc67d9e24157af9f32d1edfb899ffc8","parents":["3e8a676794f61d5ffc5eec10861cf7547b2a28aa"],"ref":"refs/changes/25/4225/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1529011132,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"manifest","line":2106,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This was erroneous and only done for testing. I thought that had been fixed, but it looks like it wasn\u0027t rebased."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1034,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"paranoid"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1034,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":1056,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Since failure to read this MSR is directly contradictory to what cpuid told us, it seems like it\u0027s worth logging this fact?"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":2015,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Right now, this is too late for RDCL_NO (mlsetup does init_desctbls() way before cpuid_pass1)."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":2015,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yes, I know it is. Until we have actual hardware that supports these bits, I didn\u0027t want to go through and try and rearrange everything to see if it worked. I suspect we may need to do some subset of cpuid scanning early in boot for this to figure that out versus trying to do cpuid_pass1 earlier. But I\u0027m not sure at this time. I just wanted to start knowing about the features."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":2073,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this line no longer directly relevant"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":2073,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Ah yeah. Thanks."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5429,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"s/microcode/microcode update/"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5429,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5431,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"s/callers/caller\u0027s/"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5431,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5451,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"no need for this assert, we\u0027ll fall over immediately after anyway"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5451,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5454,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"can combine into CPUSET_ONLY()"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5454,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Thanks, didn\u0027t know about that one."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5459,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"is this really just OK?"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5459,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"After discussion I think this should panic as well as the one at 5488."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5490,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"differing"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5490,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/i86pc/os/mp_startup.c","line":1817,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"spurious?"},{"file":"usr/src/uts/i86pc/os/mp_startup.c","line":1817,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":194,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"Enhanced\""},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":194,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":196,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Is this purposefully missing EBX[18] ?"},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":196,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"No, thanks for catching that."},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":483,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Do all of these have the same meanings in Intel/AMD? Are we bothered?"},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":483,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"They do seem to have the same meaning per the AMD and Intel docs that I checked:\n\nhttps://developer.amd.com/wp-content/resources/124441_AMD64_SpeculativeStoreBypassDisable_Whitepaper_final.pdf\nhttps://developer.amd.com/wp-content/resources/Architecture_Guidelines_Update_Indirect_Branch_Control.pdf\nhttps://developer.amd.com/wp-content/resources/Managing-Speculation-on-AMD-Processors.pdf\nhttps://software.intel.com/sites/default/files/managed/c5/63/336996-Speculative-Execution-Side-Channel-Mitigations.pdf"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":253,"deletions":-1},{"file":"usr/src/uts/i86pc/os/microcode.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/os/mlsetup.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/mp_startup.c","type":"MODIFIED","insertions":18,"deletions":-16},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":46,"deletions":-2}],"sizeInsertions":322,"sizeDeletions":-21},{"number":"2","revision":"d87e649dd352d8deb5d6f3e972b056310fecdcd4","parents":["a550c142d05bbcc2a90f7f0f9e343f869d6d6aa2"],"ref":"refs/changes/25/4225/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1529338686,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"manifest","line":2106,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this is now listed twice"},{"file":"manifest","line":2106,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Sigh. Thanks."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5459,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"comment is slightly weird now, but can just remove it: I think the panic msg is clear enough."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":5459,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yeah, I agree. Removed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":249,"deletions":-3},{"file":"usr/src/uts/i86pc/os/microcode.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/os/mlsetup.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/mp_startup.c","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":47,"deletions":-2}],"sizeInsertions":319,"sizeDeletions":-22},{"number":"3","revision":"696ba7dfaab98d6fa25bfc4276076c06725b61e3","parents":["a550c142d05bbcc2a90f7f0f9e343f869d6d6aa2"],"ref":"refs/changes/25/4225/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1529358707,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529432125,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529417154,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529361660,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":245,"deletions":-3},{"file":"usr/src/uts/i86pc/os/microcode.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/os/mlsetup.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/mp_startup.c","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":47,"deletions":-2}],"sizeInsertions":314,"sizeDeletions":-22},{"number":"4","revision":"7c427eaf60e55a38fded1ffa6526b07b64236880","parents":["3576587e66a76032163d63aa7350ada0287340ab"],"ref":"refs/changes/25/4225/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1529442855,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529432125,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529417154,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529361660,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":245,"deletions":-3},{"file":"usr/src/uts/i86pc/os/microcode.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/os/mlsetup.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/mp_startup.c","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":47,"deletions":-2}],"sizeInsertions":314,"sizeDeletions":-22},{"number":"5","revision":"7058c3c954af033fd27362cf841933da915322f1","parents":["f367310f219802eaffd224b4cdddf2133302efa6"],"ref":"refs/changes/25/4225/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1529443120,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1529443184,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529432125,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529417154,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529361660,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":245,"deletions":-3},{"file":"usr/src/uts/i86pc/os/microcode.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/i86pc/os/mlsetup.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/os/mp_startup.c","type":"MODIFIED","insertions":17,"deletions":-16},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":47,"deletions":-2}],"sizeInsertions":314,"sizeDeletions":-22}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}