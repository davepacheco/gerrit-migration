From 94d5dd6e40e3ccad6c4e165344b0fec690654296 Mon Sep 17 00:00:00 2001
From: "Joshua M. Clulow" <jmc@joyent.com>
Date: Fri, 27 Oct 2017 15:13:01 +0000
Subject: [PATCH] MANTA-3477 create "manta-reshard" zone image

---
 config/services/reshard/service.json |  6 ++++++
 lib/layout.js                        | 10 ++++++++--
 lib/services.js                      |  6 ++++--
 test/tst.services.js                 |  7 ++++---
 4 files changed, 22 insertions(+), 7 deletions(-)
 create mode 100644 config/services/reshard/service.json

diff --git a/config/services/reshard/service.json b/config/services/reshard/service.json
new file mode 100644
index 0000000..fa21752
--- /dev/null
+++ b/config/services/reshard/service.json
@@ -0,0 +1,6 @@
+{
+	"params": {
+		"networks": [ "manta", "admin" ],
+		"ram": 512
+	}
+}
diff --git a/lib/layout.js b/lib/layout.js
index d50d342..01c66bd 100644
--- a/lib/layout.js
+++ b/lib/layout.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -85,7 +85,13 @@ var ML_SERVICES_EXACT = {
 	 * "propeller" is a testing component not intended for use in production
 	 * environments.
 	 */
-	'propeller': 0
+	'propeller': 0,
+
+	/*
+	 * "reshard" is an optional component for systems that are undergoing
+	 * resharding.
+	 */
+	'reshard': 0
 };
 
 /*
diff --git a/lib/services.js b/lib/services.js
index 64bf761..3166b0a 100644
--- a/lib/services.js
+++ b/lib/services.js
@@ -50,7 +50,8 @@ var mSvcNames = [
     'ops',
     'madtom',
     'marlin-dashboard',
-    'marlin'
+    'marlin',
+    'reshard'
 ];
 
 /*
@@ -73,7 +74,8 @@ var mSvcConfigs = {
     'madtom':		{ 'oneach': true,  'probes': true,  'sharded': false },
     'marlin-dashboard':	{ 'oneach': true,  'probes': true,  'sharded': false },
     'marlin':		{ 'oneach': false, 'probes': false, 'sharded': false },
-    'propeller':	{ 'oneach': true,  'probes': false, 'sharded': false }
+    'propeller':	{ 'oneach': true,  'probes': false, 'sharded': false },
+    'reshard':		{ 'oneach': true,  'probes': false, 'sharded': false }
 };
 
 exports.mSvcNames = mSvcNames;
diff --git a/test/tst.services.js b/test/tst.services.js
index bf2cf11..9d0ae14 100644
--- a/test/tst.services.js
+++ b/test/tst.services.js
@@ -38,7 +38,8 @@ var knownServices = [
     'madtom',
     'marlin-dashboard',
     'marlin',
-    'propeller'
+    'propeller',
+    'reshard'
 ];
 
 function main()
@@ -90,8 +91,8 @@ function main()
 	/*
 	 * Test serviceSupportsProbes().
 	 */
-	assertplus.deepEqual([ 'marlin', 'propeller' ], knownServices.filter(
-	    function (svcname) {
+	assertplus.deepEqual([ 'marlin', 'propeller', 'reshard' ],
+	    knownServices.filter(function (svcname) {
 		return (!services.serviceSupportsProbes(svcname));
 	    }));
 	assertplus.deepEqual(services.mSvcNamesProbes,
-- 
2.21.0

