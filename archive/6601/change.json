{"project":"joyent/sdc-vmapi","branch":"master","id":"I8887095d7413f4b9941f27093cefea2625d67b35","number":"6601","subject":"TRITON-1813 non-integer \u0027refreservation\u0027 values confound sdc-migrate Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/6601","commitMessage":"TRITON-1813 non-integer \u0027refreservation\u0027 values confound sdc-migrate\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1562971848,"lastUpdated":1564085439,"open":false,"status":"MERGED","comments":[{"timestamp":1562971848,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1562971850,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 8435a6cef23a3bb86ea56bfe769bb27aa6857a43\n    \n    TRITON-1813 non-integer \u0027refreservation\u0027 values confound sdc-migrate"},{"timestamp":1562971893,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1563197533,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nI think that the real issue here is that vmobj.disks.*.refreservation is being set even when device.*.refreservation is not set in zonecfg.  This (vmadmd?) seemingly makes it impossible to use disks.*.refreservation in a vmadm payload.\n\nIf migration works around that by always deleting disks.*.refreservation, it makes it hard to ever make it so that a custom refreservation is ever supported across migration.   That being said, it does seem as though a fix is needed to migrate off of hosts with this vminfod bug.  Deleting refreservation when it is not an integer seems like a reasonable approach."},{"timestamp":1563990404,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\n\u003e I think that the real issue here is that vmobj.disks.*.refreservation is being set even when device.*.refreservation is not set in zonecfg.  This (vmadmd?) seemingly makes it impossible to use disks.*.refreservation in a vmadm payload.\n\nI\u0027m not following. If it\u0027s not possible to use in a vmadm payload - how does refreservation get set at all?"},{"timestamp":1564066120,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: Code-Review+1\n\nAs Todd and I discussed, refreservation is implicitly set to auto by `zfs create -V`.  vminfod then picks up this value and any later manual changes.  To properly distinguish between explicit and implicit refreservation, more work is needed elsewhere."},{"timestamp":1564082738,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1564085425,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1564085439,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"2","revision":"8887095d7413f4b9941f27093cefea2625d67b35","parents":["ea9de154831ec95d7ad5ba7fda570f1d3569c7fd"],"ref":"refs/changes/01/6601/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1564085425,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562971893,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1564066120,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1564082738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1564085439,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/workflows/vm-migration/begin.js","type":"MODIFIED","insertions":7,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":8,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"f391518545f63f0ccba02726be2840ab43355624","parents":["ea9de154831ec95d7ad5ba7fda570f1d3569c7fd"],"ref":"refs/changes/01/6601/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1562971848,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562971893,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1564082738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1564066120,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/workflows/vm-migration/begin.js","type":"MODIFIED","insertions":7,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":8,"sizeDeletions":-1},{"number":"2","revision":"8887095d7413f4b9941f27093cefea2625d67b35","parents":["ea9de154831ec95d7ad5ba7fda570f1d3569c7fd"],"ref":"refs/changes/01/6601/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1564085425,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562971893,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1564082738,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1564085439,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1564066120,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/workflows/vm-migration/begin.js","type":"MODIFIED","insertions":7,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":8,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}