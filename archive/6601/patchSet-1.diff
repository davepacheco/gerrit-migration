From f391518545f63f0ccba02726be2840ab43355624 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 12 Jul 2019 15:50:47 -0700
Subject: [PATCH] TRITON-1813 non-integer 'refreservation' values confound
 sdc-migrate

---
 lib/workflows/vm-migration/begin.js | 7 +++++++
 package.json                        | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/lib/workflows/vm-migration/begin.js b/lib/workflows/vm-migration/begin.js
index 249d60c..1efe85b 100644
--- a/lib/workflows/vm-migration/begin.js
+++ b/lib/workflows/vm-migration/begin.js
@@ -259,6 +259,13 @@ function createProvisionPayload(job, cb) {
                 delete disk.refreservation;
             }
 
+            // Bhyve refreservations should not be set (they are set
+            // automagically during vmadm create).
+            if (disk.refreservation && disk.size &&
+                    vmPayload.brand === 'bhyve') {
+                delete disk.refreservation;
+            }
+
             // You cannot specify a path for a disk unless you set nocreate=true
             if (disk.path && !disk.nocreate) {
                 // XXX: TODO: Could this cause a change to the resulting disk
diff --git a/package.json b/package.json
index 2bfc24b..edc6f64 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.8.13",
+  "version": "9.8.14",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

