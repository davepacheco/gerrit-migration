From 8887095d7413f4b9941f27093cefea2625d67b35 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 25 Jul 2019 13:10:24 -0700
Subject: [PATCH] =?UTF-8?q?TRITON-1813=20non-integer=20'refreservation'=20?=
 =?UTF-8?q?values=20confound=20sdc-migrate=20Reviewed=20by:=20Mike=20Gerdt?=
 =?UTF-8?q?s=20<mike.gerdts@joyent.com>=20Approved=20by:=20Pedro=20Palaz?=
 =?UTF-8?q?=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/workflows/vm-migration/begin.js | 7 +++++++
 package.json                        | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/lib/workflows/vm-migration/begin.js b/lib/workflows/vm-migration/begin.js
index 249d60c..1efe85b 100644
--- a/lib/workflows/vm-migration/begin.js
+++ b/lib/workflows/vm-migration/begin.js
@@ -259,6 +259,13 @@ function createProvisionPayload(job, cb) {
                 delete disk.refreservation;
             }
 
+            // Bhyve refreservations should not be set (they are set
+            // automagically during vmadm create).
+            if (disk.refreservation && disk.size &&
+                    vmPayload.brand === 'bhyve') {
+                delete disk.refreservation;
+            }
+
             // You cannot specify a path for a disk unless you set nocreate=true
             if (disk.path && !disk.nocreate) {
                 // XXX: TODO: Could this cause a change to the resulting disk
diff --git a/package.json b/package.json
index 2bfc24b..edc6f64 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.8.13",
+  "version": "9.8.14",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

