From 7be1e44b3e5d65b50644f734fefee1fdfb112134 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 20 Oct 2017 15:35:40 -0700
Subject: [PATCH] IMGAPI-651 do not set min_platform for lx images

---
 CHANGES.md    |   5 +++
 lib/images.js | 114 ++++++++++++++++++++++----------------------------
 package.json  |   2 +-
 3 files changed, 57 insertions(+), 64 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index c1a6958..6a0ce47 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,10 @@
 # IMGAPI changelog
 
+## 4.0.12
+
+- IMGAPI-651 unset image requirements.min_platform for lx-dataset images.
+  This is done for both CreateImageFromVm and AdminImportRemoteImage.
+
 ## 4.0.11
 
 - joyent/node-docker-registry-client#23 Namespace validation too strict
diff --git a/lib/images.js b/lib/images.js
index fc6cfd4..a94fd7f 100644
--- a/lib/images.js
+++ b/lib/images.js
@@ -52,20 +52,6 @@ var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
 var ICON_CONTENT_TYPES = ['image/jpeg', 'image/gif', 'image/png'];
 
 
-/*
- * IMGAPI-251: If we're creating an incremental image, then we want to
- * make sure it is only used to provision on a server with an imgadm
- * that supports incremental images... or on any 6.5 platform (presuming
- * it has the latest provisioner agent which handles the origin image
- * installation).
- */
-var IMGAPI_251_MIN_PLATFORM = {
-    '7.0': '20130729T063445Z',
-    // The oldest 6.5 platform in the JPC fleet at time of writing.
-    // See IMGAPI-286.
-    '6.5': '20120614T001014Z'
-};
-
 //---- Image model
 
 /**
@@ -1799,13 +1785,6 @@ function apiCreateImageFromVm(req, res, callback) {
     if (manifest.uuid === undefined) {
         manifest.uuid = lib_uuid.v4();
     }
-    // Workaround IMGAPI-251: see note above.
-    if (incremental && !(manifest.requirements &&
-                         manifest.requirements.min_platform)) {
-        if (!manifest.requirements)
-            manifest.requirements = {};
-        manifest.requirements.min_platform = IMGAPI_251_MIN_PLATFORM;
-    }
 
     var vm;
     var vmServer;
@@ -1911,7 +1890,7 @@ function apiCreateImageFromVm(req, res, callback) {
          * above.
          */
         function workaroundImgapi312(next) {
-            if (vm.brand !== 'kvm' /* i.e. this is smartos */) {
+            if (vm.brand === 'joyent' || vm.brand === 'joyent-minimal') {
                 if (!manifest.requirements)
                     manifest.requirements = {};
                 manifest.requirements.min_platform = {};
@@ -2126,6 +2105,42 @@ function apiAdminImportImage(req, res, callback) {
                 owner: data.owner
             }, next);
         },
+        /*
+         * Because of OS-2651 we need to workaround IMGAPI-312 *again*!
+         * SmartOS custom images need a min_platform of the current
+         * platform of the source VM.
+         *
+         * The appropriate min_platform was set on the placeholder.
+         * Use that.
+         */
+        function workaroundImgapi312(image, next) {
+            if (placeholder && image.os === 'smartos' &&
+                !imgadmVersionFromReq(req))
+            {
+                image.requirements.min_platform =
+                    placeholder.requirements.min_platform;
+                image.raw.requirements = image.requirements;
+                log.info({min_platform: image.requirements.min_platform,
+                    image: image.uuid}, 'restoring smartos image ' +
+                    'min_platform (workaround IMGAPI-312 again)');
+            }
+            next(null, image);
+        },
+        /*
+         * IMGAPI-651: 'imgadm import' for *lx-dataset* images needs to unset
+         * min_platform if imgadm < v3.7.4.
+         */
+        function workaroundImgapi651(image, next) {
+            if (placeholder && image.type === 'lx-dataset' &&
+                    image.requirements &&
+                    image.requirements.min_platform &&
+                    !semverGter(imgadmVersionFromReq(req), '3.7.4')) {
+                log.info({min_platform: image.requirements.min_platform},
+                    'removing min_platform for lx images (IMGAPI-651)');
+                delete image.requirements.min_platform;
+            }
+            next(null, image);
+        },
         function createIt(next) {
             log.info({data: data}, 'AdminImportImage: create it');
             Image.create(app, data, true, false, next);
@@ -2144,47 +2159,6 @@ function apiAdminImportImage(req, res, callback) {
         },
         function addItToDb(image, next) {
             if (placeholder) {
-                /*
-                 * Because of OS-2651 we need to workaround IMGAPI-312 *again*!
-                 * SmartOS custom images need a min_platform of the current
-                 * platform of the source VM.
-                 *
-                 * The appropriate min_platform was set on the placeholder.
-                 * Use that.
-                 */
-                if (image.os === 'smartos' &&
-                    !imgadmVersionFromReq(req))
-                {
-                    image.requirements.min_platform =
-                        placeholder.requirements.min_platform;
-                    image.raw.requirements = image.requirements;
-                    log.info({min_platform: image.requirements.min_platform,
-                        image: image.uuid}, 'restoring smartos image ' +
-                        'min_platform (workaround IMGAPI-312 again)');
-                }
-
-                /*
-                 * Workaround OS-2651: This was a bug where imgadm create would
-                 * wipe out a given `manifest.requirements`. The fix was added
-                 * in imgadm 2.6.1. In that version imgadm was changed to
-                 * identify itself in the user-agent header. Use that to scope
-                 * down the workaround.
-                 */
-                if (Object.keys(image.requirements).length === 0 &&
-                    placeholder.requirements.min_platform['6.5'] ===
-                        IMGAPI_251_MIN_PLATFORM['6.5'] &&
-                    placeholder.requirements.min_platform['7.0'] ===
-                        IMGAPI_251_MIN_PLATFORM['7.0'] &&
-                    !imgadmVersionFromReq(req))
-                {
-                    log.info({requirements: placeholder.raw.requirements,
-                        image: image.uuid},
-                        'restoring placeholder image requirements ' +
-                        '(workaround OS-2651)');
-                    image.raw.requirements = placeholder.raw.requirements;
-                    image.requirements = placeholder.requirements;
-                }
-
                 Image.modify(app, image, req.log, function (err) {
                     if (err) {
                         log.error({uuid: image.uuid},
@@ -2317,6 +2291,20 @@ function apiAdminImportImageFromSource(req, res, cb) {
             next();
         },
 
+        /*
+         * IMGAPI-651: Importing *lx-dataset* images must unset min_platform.
+         */
+        function workaroundImgapi651_importFromSource(_, next) {
+            if (manifest.type === 'lx-dataset' &&
+                    manifest.requirements &&
+                    manifest.requirements.min_platform) {
+                log.info({min_platform: manifest.requirements.min_platform},
+                    'removing min_platform for lx images (IMGAPI-651)');
+                delete manifest.requirements.min_platform;
+            }
+            next();
+        },
+
         function createImageFromManifest(_, next) {
             log.debug({ data: manifest },
                 'AdminImportImageFromSource: create it');
diff --git a/package.json b/package.json
index 2f89b56..4425d93 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgapi",
   "description": "Image API to manage images for SDC 7",
-  "version": "4.0.11",
+  "version": "4.0.12",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

