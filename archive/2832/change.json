{"project":"joyent/sdc-imgapi","branch":"master","id":"Icbdfc99c45866c83ef90b454b30da12798eaa70c","number":"2832","subject":"IMGAPI-651 do not set min_platform for lx images","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/2832","commitMessage":"IMGAPI-651 do not set min_platform for lx images\n","createdOn":1508538824,"lastUpdated":1509387012,"open":false,"status":"MERGED","comments":[{"timestamp":1508538824,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1508538825,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 3dc6a2b958a0f64ebca3e970110b814a0e16c7bf\n    \n    IMGAPI-651 do not set min_platform for lx images"},{"timestamp":1508538863,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(12 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1508538941,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2."},{"timestamp":1508538942,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 87935f998a3fc18df2a40e6537e9783fe6e25709\n    \n    fixup style nits"},{"timestamp":1508538974,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508546316,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1508890496,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1509046002,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3."},{"timestamp":1509046004,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 60e61f655a5e0e648671d9a6ac9ee77a2aab54da\n    \n    updates for CR, drop IMGAPI-312 code, update min_platform handling"},{"timestamp":1509046029,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509132999,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)\n\nLooks good. What testing have you done?"},{"timestamp":1509136618,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nTested using:\n\n\"imgadm create -p\" on lx container (imgadm version 3.7.3) - verified min_platform gets removed (or inherited for incremental)\n\n\"imgadm create -p\" on lx container (imgadm version 3.7.4) - noop, but verfied min_platform is not set (or was inherited for incremental)\n\n\"sdc-imgapi \u0027/images?action\u003dcreate-from-vm\u0027\" on lx container - verified min_platform is not set (or inherited for incremental)\n\n\"sdc-imgapi \u0027/images/{uuid}?action\u003dimport-remote\u0027\" on lx image to ensure min_platform remains unchanged"},{"timestamp":1509136702,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1509137580,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1509386979,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1509387006,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1509387012,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"4","revision":"60755744adc67fd7b9014e63a86d1036a323a12f","parents":["897bffcb1fa1cf8937b202a1ac628efc5725f541"],"ref":"refs/changes/32/2832/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1509386979,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509046029,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509137580,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509137580,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1509387012,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":32,"deletions":-88},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":43,"sizeDeletions":-89},"patchSets":[{"number":"1","revision":"a0e97d888cc404b301cf7552e8c92fd71829dfd5","parents":["ba1d634230e16c007a14a1991fcdf5e58f2e1b01"],"ref":"refs/changes/32/2832/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1508538824,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1508538863,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/images.js","line":2109,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment"},{"file":"lib/images.js","line":2110,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment"},{"file":"lib/images.js","line":2111,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment"},{"file":"lib/images.js","line":2112,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment"},{"file":"lib/images.js","line":2113,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment"},{"file":"lib/images.js","line":2114,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment"},{"file":"lib/images.js","line":2115,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper block comment close"},{"file":"lib/images.js","line":2135,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper boolean continuation"},{"file":"lib/images.js","line":2136,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper boolean continuation"},{"file":"lib/images.js","line":2137,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper boolean continuation"},{"file":"lib/images.js","line":2299,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper boolean continuation"},{"file":"lib/images.js","line":2300,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"improper boolean continuation"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":51,"deletions":-63},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":57,"sizeDeletions":-64},{"number":"2","revision":"7be1e44b3e5d65b50644f734fefee1fdfb112134","parents":["ba1d634230e16c007a14a1991fcdf5e58f2e1b01"],"ref":"refs/changes/32/2832/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1508538941,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508538974,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":6,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think this should mention the removal of the workarounds in place for those old issues: IMGAPI-251 and IMGAPI-312."},{"file":"CHANGES.md","line":6,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Okay - will do."},{"file":"lib/images.js","line":1892,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"can drop this function, see discussion below"},{"file":"lib/images.js","line":1892,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Okay - will do."},{"file":"lib/images.js","line":2116,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"IMGAPI-312 went in before our oldest supported platform date:\n\n```\ncommit e3d270768a9e31a2deba6b95307ebd7dda60cc6f\nAuthor: Trent Mick \u003ctrentm@gmail.com\u003e\nDate:   2013-12-04T11:24:11-08:00 (3 years, 11 months ago)\n\n    IMGAPI-312: *smartos* \u0027imgadm create\u0027 set min_platform to the current platform version\n```\n\nso we can drop all the \"work around IMGAPI-312\" code: here and above."},{"file":"lib/images.js","line":2116,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Okay - will do."},{"file":"lib/images.js","line":2140,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Me working out the cases:\n\n- A smartos image should get reqs.min_platform set to the current platform on which it was built. All deployed imgadm versions are doing this now.\n- A KVM image should inherit the reqs.min_platform from its origin image. All deployed imgadm versions are doing this (https://github.com/joyent/smartos-live/blob/62c82a5a6d3bed983ba13a95bcb1643b91040328/src/img/lib/imgadm.js#L3440-L3462).\n- An LX image should, as with KVM images, inherit the req.min_platform from its origin image. Only imgadm \u003e\u003d3.7.4 is doing this correctly. Earlier imgadm versions are wiping that inherited-from-origin reqs.min_platform and setting it to the current platform version. So, the workaround here is not to *delete* reqs.min_platform for LX images, but to find the value from the origin image and use that.\n\nFor example, this ubuntu LX image from images.jo has a min_plat:\n\n```\n    \"uuid\": \"04179d8e-188a-11e7-af4a-1349e98cbd17\",\n    \"name\": \"ubuntu-14.04\",\n    \"version\": \"20170403\",\n    \"requirements\": {\n      \"min_platform\": {\n        \"7.0\": \"20160317T000105Z\"\n      },\n    ...\n```\n\n\nWe have the origin above in ensureOriginExists (if there is an origin). Currently we are throughing that away. We should change to keep it, and then here we use its requirements.min_platform if there is an origin and it has it.\n\nMake sense? I might have screwed something up. :)  The test is if a created LX image with imgadm versions before and after 3.7.4 result in reqs.min_plat matching the origin image\u0027s value."},{"file":"lib/images.js","line":2140,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Okay, I think that makes sense. I had originally thought we didn\u0027t want to initially set a min_platform (at all) for LX images and that inheriting would just work (in DAPI or some such)... but it also makes sense (and is simpler for DAPI) to set the min_platform from the inherited origin image(s)."},{"file":"lib/images.js","line":2303,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Whoa, really? I\u0027m not sure we want to blow these away. \n\nNow I\u0027m curious why our latest LX images have a min_plat. I.e. if that is because core LX support required for those images was added to the platform then. If so, then we want to maintain those min_plats. E.g. this for the latest ubuntu-14.04 lx image:\n\n      \"min_platform\": {\n        \"7.0\": \"20160317T000105Z\"\n      },\n\nWe should ask IMAGE and OS guys on Monday."},{"file":"lib/images.js","line":2303,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I\u0027m going to remove this - I was originally thinking that we\u0027d just always wipe min_platform when importing a remote LX image - but that doesn\u0027t really make sense.\n\nThere can be a good and valid reason why these are set, and there is no way from the image metadata to tell if it was deliberately set (intended) or unexpectedly set by an old imgadm. I think it should be fine to leave min_platform set even in the case it was unexpectedly set by imgadm - people can rebuild images or manually tweak these image settings, and newer imgadm\u0027s will do the correct thing."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":51,"deletions":-63},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":57,"sizeDeletions":-64},{"number":"3","revision":"cbdfc99c45866c83ef90b454b30da12798eaa70c","parents":["ba1d634230e16c007a14a1991fcdf5e58f2e1b01"],"ref":"refs/changes/32/2832/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1509046002,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509046029,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509137580,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509137580,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/images.js","line":2085,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\u0027create\u0027 right?"},{"file":"lib/images.js","line":2085,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"It\u0027s \u0027imgadm publish\u0027 or \u0027imgadm create -p\u0027 that pushes the image up to IMGAPI, right?"},{"file":"lib/images.js","line":2085,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah I see what you mean. Okay, fair."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":32,"deletions":-88},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":43,"sizeDeletions":-89},{"number":"4","revision":"60755744adc67fd7b9014e63a86d1036a323a12f","parents":["897bffcb1fa1cf8937b202a1ac628efc5725f541"],"ref":"refs/changes/32/2832/4","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1509386979,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509046029,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509137580,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1509137580,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1509387012,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":10,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":32,"deletions":-88},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":43,"sizeDeletions":-89}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}