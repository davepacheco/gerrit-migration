From aac927e474efae4c075620d15cef8960e7dcb5ba Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Fri, 26 May 2017 18:10:04 +0200
Subject: [PATCH] WORKFLOW-213 workflow should update to node v4

---
 LICENSE                           | 22 ++++++++++++++++++++++
 Makefile                          |  1 +
 README.md                         |  2 +-
 bin/workflow-api                  |  1 +
 bin/workflow-runner               |  1 +
 docs/index.restdown               |  4 ++--
 example.js                        |  2 +-
 lib/api.js                        |  4 +++-
 lib/child.js                      |  1 +
 lib/errors.js                     |  2 ++
 lib/index.js                      |  1 +
 lib/job-runner.js                 |  1 +
 lib/make-emitter.js               |  2 ++
 lib/runner.js                     |  7 ++++---
 lib/task-runner.js                |  2 ++
 lib/workflow-factory.js           |  4 +++-
 lib/workflow-in-memory-backend.js |  1 +
 package.json                      |  6 +++---
 test/api.test.js                  |  4 +++-
 test/child.test.js                |  4 +++-
 test/config.json.sample           |  2 +-
 test/config.nofork.sample         |  2 +-
 test/errors.test.js               |  2 ++
 test/helper.js                    |  1 +
 test/in-memory-backend.test.js    |  4 +++-
 test/job-runner.test.js           |  6 ++++--
 test/runner.test.js               |  8 +++++---
 test/task-runner.test.js          | 12 +++++++-----
 28 files changed, 82 insertions(+), 27 deletions(-)
 create mode 100644 LICENSE

diff --git a/LICENSE b/LICENSE
new file mode 100644
index 0000000..da1ba2f
--- /dev/null
+++ b/LICENSE
@@ -0,0 +1,22 @@
+The MIT License (MIT)
+
+Copyright (c) 2017 Joyent, Inc.
+
+Permission is hereby granted, free of charge, to any person obtaining a copy
+of this software and associated documentation files (the "Software"), to deal
+in the Software without restriction, including without limitation the rights
+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+copies of the Software, and to permit persons to whom the Software is
+furnished to do so, subject to the following conditions:
+
+The above copyright notice and this permission notice shall be included in all
+copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+SOFTWARE.
+
diff --git a/Makefile b/Makefile
index 52458fa..13b7f9e 100644
--- a/Makefile
+++ b/Makefile
@@ -1,5 +1,6 @@
 #
 # Copyright (c) 2012, Joyent, Inc. All rights reserved.
+# Copyright (c) 2016, Joyent, Inc.
 #
 
 #
diff --git a/README.md b/README.md
index 46125c8..427fc40 100644
--- a/README.md
+++ b/README.md
@@ -184,7 +184,7 @@ See https://github.com/joyent/node-workflow/issues.
 
 # LICENSE
 
-The MIT License (MIT) Copyright (c) 2016 Pedro Palaz√≥n Candel
+The MIT License (MIT) Copyright (c) 2017 Joyent, Inc.
 
 Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 
diff --git a/bin/workflow-api b/bin/workflow-api
index 0fd2788..24ff4e5 100755
--- a/bin/workflow-api
+++ b/bin/workflow-api
@@ -1,4 +1,5 @@
 #!/usr/bin/env node
+// Copyright (c) 2016, Joyent, Inc.
 
 // vim: set filetype=javascript :
 
diff --git a/bin/workflow-runner b/bin/workflow-runner
index efc5113..8ad1ae6 100755
--- a/bin/workflow-runner
+++ b/bin/workflow-runner
@@ -1,4 +1,5 @@
 #!/usr/bin/env node
+// Copyright (c) 2016, Joyent, Inc.
 
 // vim: set filetype=javascript :
 
diff --git a/docs/index.restdown b/docs/index.restdown
index 7e6ad0a..5bcd124 100644
--- a/docs/index.restdown
+++ b/docs/index.restdown
@@ -449,7 +449,7 @@ relevant sections included:
         "sandbox": {
             "modules": {
                 "http": "http",
-                "uuid": "node-uuid"
+                "uuid": "uuid"
             },
             "foo": "bar",
             "bool": true,
@@ -519,7 +519,7 @@ required.
   VM where we run our tasks. The key for each member will be the identifier for 
   referring to each object inside a task's `body` and `fallback` functions,
   while the value is what the system will use to require the module.
-  For example: `{uuid: 'node-uuid'}`.
+  For example: `{uuid: 'uuid'}`.
 
   Remember that, by default, only [global node timers](http://nodejs.org/docs/latest/api/timers.html)
   will be available for tasks if nothing is given.
diff --git a/example.js b/example.js
index d3e05c5..2c63d63 100644
--- a/example.js
+++ b/example.js
@@ -1,5 +1,5 @@
 // Copyright 2013 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
-
+// Copyright (c) 2017, Joyent, Inc.
 // First part of the example: You create workflows, add tasks, queue jobs
 // anywhere in your code using NodeJS.
 
diff --git a/lib/api.js b/lib/api.js
index bc49226..ac1e5d6 100644
--- a/lib/api.js
+++ b/lib/api.js
@@ -1,7 +1,9 @@
 // Copyright 2014 Pedro P. Candel <kusorbox@gmail.com> All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var restify = require('restify');
 var util = require('util');
-var uuid = require('node-uuid');
+var uuid = require('uuid');
 var path = require('path');
 var fs = require('fs');
 var os = require('os');
diff --git a/lib/child.js b/lib/child.js
index 190fa60..14524de 100644
--- a/lib/child.js
+++ b/lib/child.js
@@ -1,4 +1,5 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com> All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
 //
 // Child process to be "forked" from task-runner.js.
 //
diff --git a/lib/errors.js b/lib/errors.js
index c8b8a72..6625136 100644
--- a/lib/errors.js
+++ b/lib/errors.js
@@ -1,4 +1,6 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com> All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var restify = require('restify'),
     util = require('util');
 
diff --git a/lib/index.js b/lib/index.js
index 866c252..92ae173 100644
--- a/lib/index.js
+++ b/lib/index.js
@@ -1,4 +1,5 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
 
 var DTRACE;
 
diff --git a/lib/job-runner.js b/lib/job-runner.js
index d1a7eb5..aa5b478 100644
--- a/lib/job-runner.js
+++ b/lib/job-runner.js
@@ -1,4 +1,5 @@
 // Copyright 2014 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
 
 var assert = require('assert-plus');
 var util = require('util');
diff --git a/lib/make-emitter.js b/lib/make-emitter.js
index b1527c3..9b86e6c 100644
--- a/lib/make-emitter.js
+++ b/lib/make-emitter.js
@@ -1,3 +1,5 @@
+// Copyright (c) 2017, Joyent, Inc.
+
 var EventEmitter = require('events').EventEmitter;
 
 function makeEmitter(o) {
diff --git a/lib/runner.js b/lib/runner.js
index 5f149d2..5af7590 100644
--- a/lib/runner.js
+++ b/lib/runner.js
@@ -1,8 +1,9 @@
 // Copyright 2013 Pedro P. Candel <kusorbox@gmail.com> All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
 
 var assert = require('assert-plus');
 var util = require('util');
-var uuid = require('node-uuid');
+var uuid = require('uuid');
 var fs = require('fs');
 var path = require('path');
 var vasync = require('vasync');
@@ -500,9 +501,9 @@ var WorkflowRunner = module.exports = function (opts) {
                     var job_trace = trace_event.createBunyanTracer({
                         log: job_log,
                         fields: {
-                            name: 'job.'
+                            name: 'job.' +
                                 // Drop trailing '-$version'.
-                                + job.name.slice(0, job.name.lastIndexOf('-')),
+                                job.name.slice(0, job.name.lastIndexOf('-')),
                             args: { job: job.uuid }
                         }
                     });
diff --git a/lib/task-runner.js b/lib/task-runner.js
index df68fac..cfb59ab 100644
--- a/lib/task-runner.js
+++ b/lib/task-runner.js
@@ -1,4 +1,6 @@
 // Copyright 2014 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var bunyan = require('bunyan');
 var util = require('util');
 var vm = require('vm');
diff --git a/lib/workflow-factory.js b/lib/workflow-factory.js
index 5e5e50c..473d72a 100644
--- a/lib/workflow-factory.js
+++ b/lib/workflow-factory.js
@@ -1,5 +1,7 @@
 // Copyright 2014 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
-var uuid = require('node-uuid');
+// Copyright (c) 2017, Joyent, Inc.
+
+var uuid = require('uuid');
 var util = require('util');
 var crypto = require('crypto');
 
diff --git a/lib/workflow-in-memory-backend.js b/lib/workflow-in-memory-backend.js
index 9419769..27c9f61 100644
--- a/lib/workflow-in-memory-backend.js
+++ b/lib/workflow-in-memory-backend.js
@@ -1,4 +1,5 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
 
 var util = require('util');
 var makeEmitter = require('./make-emitter');
diff --git a/package.json b/package.json
index ec38917..1b4069c 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "wf",
     "description": "Tasks Workflows orchestration API and runners",
-    "version": "1.0.2",
+    "version": "1.1.0",
     "repository": {
         "type": "git",
         "url": "git://github.com/kusor/node-workflow.git"
@@ -24,12 +24,12 @@
     "main": "lib/index.js",
     "dependencies": {
         "assert-plus": "1.0.0",
-        "node-uuid": "1.4.7",
+        "uuid": "3.0.1",
         "bunyan": "1.8.1",
         "vasync": "1.6.4",
         "backoff": "1.2.0",
         "clone": "0.1.6",
-        "restify": "4.0.3",
+        "restify": "4.1.1",
         "sigyan": "0.2.0",
         "trace-event": "1.3.0"
     },
diff --git a/test/api.test.js b/test/api.test.js
index e51611e..d4a2485 100644
--- a/test/api.test.js
+++ b/test/api.test.js
@@ -1,6 +1,8 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var test = require('tap').test,
-    uuid = require('node-uuid'),
+    uuid = require('uuid'),
     SOCKET = '/tmp/.' + uuid(),
     util = require('util'),
     path = require('path'),
diff --git a/test/child.test.js b/test/child.test.js
index e4bca5b..eea3d2d 100644
--- a/test/child.test.js
+++ b/test/child.test.js
@@ -1,7 +1,9 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var util = require('util'),
     test = require('tap').test,
-    uuid = require('node-uuid'),
+    uuid = require('uuid'),
     fork = require('child_process').fork;
 
 var job = {
diff --git a/test/config.json.sample b/test/config.json.sample
index 49c295b..82a9c93 100644
--- a/test/config.json.sample
+++ b/test/config.json.sample
@@ -16,7 +16,7 @@
         "sandbox": {
             "modules": {
                 "http": "http",
-                "uuid": "node-uuid"
+                "uuid": "uuid"
             },
             "foo": "bar",
             "bool": true,
diff --git a/test/config.nofork.sample b/test/config.nofork.sample
index 6366620..36b5715 100644
--- a/test/config.nofork.sample
+++ b/test/config.nofork.sample
@@ -17,7 +17,7 @@
         "sandbox": {
             "modules": {
                 "http": "http",
-                "uuid": "node-uuid"
+                "uuid": "uuid"
             },
             "foo": "bar",
             "bool": true,
diff --git a/test/errors.test.js b/test/errors.test.js
index 5d3e3b6..991480e 100644
--- a/test/errors.test.js
+++ b/test/errors.test.js
@@ -1,3 +1,5 @@
+// Copyright (c) 2017, Joyent, Inc.
+
 var test = require('tap').test,
     util = require('util'),
     restify = require('restify'),
diff --git a/test/helper.js b/test/helper.js
index 7483825..019deea 100644
--- a/test/helper.js
+++ b/test/helper.js
@@ -1,4 +1,5 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
 
 var path = require('path'),
     fs = require('fs'),
diff --git a/test/in-memory-backend.test.js b/test/in-memory-backend.test.js
index c161f9b..b80cb6b 100644
--- a/test/in-memory-backend.test.js
+++ b/test/in-memory-backend.test.js
@@ -1,6 +1,8 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var test = require('tap').test,
-    uuid = require('node-uuid'),
+    uuid = require('uuid'),
     SOCKET = '/tmp/.' + uuid(),
     util = require('util'),
     Factory = require('../lib/index').Factory,
diff --git a/test/job-runner.test.js b/test/job-runner.test.js
index a8c83e0..48ffcc1 100644
--- a/test/job-runner.test.js
+++ b/test/job-runner.test.js
@@ -1,7 +1,9 @@
 // Copyright 2014 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var util = require('util'),
     test = require('tap').test,
-    uuid = require('node-uuid'),
+    uuid = require('uuid'),
     WorkflowJobRunner = require('../lib/job-runner'),
     bunyan = require('bunyan'),
     Factory = require('../lib/index').Factory,
@@ -604,7 +606,7 @@ test('a job can access explicitly defined sandbox modules', function (t) {
                 job: job,
                 sandbox: {
                     modules: {
-                        uuid: 'node-uuid'
+                        uuid: 'uuid'
                     }
                 },
                 dtrace: DTRACE,
diff --git a/test/runner.test.js b/test/runner.test.js
index e95543d..f8af832 100644
--- a/test/runner.test.js
+++ b/test/runner.test.js
@@ -1,9 +1,11 @@
 // Copyright 2012 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var util = require('util');
 var path = require('path');
 var fs = require('fs');
 var test = require('tap').test;
-var uuid = require('node-uuid');
+var uuid = require('uuid');
 var WorkflowRunner = require('../lib/runner');
 var Factory = require('../lib/index').Factory;
 var exists = fs.exists || path.exists;
@@ -56,12 +58,12 @@ var taskWithModules = {
     retry: 1,
     body: function (job, cb) {
         if (typeof (uuid) !== 'function') {
-            return cb('node-uuid module is not defined');
+            return cb('uuid module is not defined');
         }
         return cb(null);
     },
     modules: {
-        uuid: 'node-uuid'
+        uuid: 'uuid'
     }
 };
 var okWf, failWf, theJob, failWfWithError, failWfWithRetry;
diff --git a/test/task-runner.test.js b/test/task-runner.test.js
index dd47b81..cede8fa 100644
--- a/test/task-runner.test.js
+++ b/test/task-runner.test.js
@@ -1,7 +1,9 @@
 // Copyright 2014 Pedro P. Candel <kusorbox@gmail.com>. All rights reserved.
+// Copyright (c) 2017, Joyent, Inc.
+
 var util = require('util'),
     test = require('tap').test,
-    uuid = require('node-uuid'),
+    uuid = require('uuid'),
     WorkflowTaskRunner = require('../lib/task-runner');
 
 var job = {
@@ -31,7 +33,7 @@ var task = {
 var sandbox = {
     'modules': {
         'http': 'http',
-        'uuid': 'node-uuid',
+        'uuid': 'uuid',
         'restify': 'restify'
     },
     'foo': 'bar',
@@ -126,7 +128,7 @@ test('sandbox modules and variables', function (t) {
     var foo, bool, aNumber, restify, info, someError;
     var task_body = function (job, cb) {
         if (typeof (uuid) !== 'function') {
-            return cb('node-uuid module is not defined');
+            return cb('uuid module is not defined');
         }
         if (typeof (foo) !== 'string') {
             return cb('sandbox value is not defined');
@@ -669,7 +671,7 @@ test('a task which defines its own modules', function (t) {
     var foo, bool, aNumber, restify, http;
     var task_body = function (job, cb) {
         if (typeof (uuid) !== 'function') {
-            return cb('node-uuid module is not defined');
+            return cb('uuid module is not defined');
         }
         if (typeof (foo) !== 'string') {
             return cb('sandbox value is not defined');
@@ -691,7 +693,7 @@ test('a task which defines its own modules', function (t) {
 
     task.body = task_body.toString();
     task.modules = {
-        'uuid': 'node-uuid'
+        'uuid': 'uuid'
     };
 
     job.chain.push(task);
-- 
2.21.0

