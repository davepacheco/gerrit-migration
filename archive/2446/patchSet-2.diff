From c217c2832178c9b098d75ded2861ce956e1b6129 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 23 Aug 2017 19:43:19 +0000
Subject: [PATCH] OS-6275 lx pipe buffer is too small

---
 usr/src/uts/common/brand/lx/syscall/lx_pipe.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/usr/src/uts/common/brand/lx/syscall/lx_pipe.c b/usr/src/uts/common/brand/lx/syscall/lx_pipe.c
index d6c8f1d274..cdada58f15 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_pipe.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_pipe.c
@@ -179,6 +179,15 @@ lx_hd_pipe(intptr_t arg, int flags)
 	VERIFY((str = vp1->v_stream) != NULL);
 	(void) lx_pipe_setsz(str, LX_DEFAULT_PIPE_SIZE, B_TRUE);
 
+	/*
+	 * Because we're using streams to increase the capacity of the pipe
+	 * up to the default Linux capacity, we have to switch the pipe
+	 * out of FIFOFAST mode and back to a normal stream. In fast mode
+	 * the pipe capacity is limited to "Fifohiwat" which is a compile-time
+	 * limit set to FIFOHIWAT.
+	 */
+	fifo_fastoff(VTOF(vp1));
+
 	/*
 	 * Set the O_NONBLOCK flag if requested.
 	 */
-- 
2.21.0

