{"project":"joyent/smartos-live","branch":"master","id":"I3a2b04b2da8bc9ef52342efa6f9f42de6aeeacaa","number":"3279","subject":"TRITON-93 Routes are not populated consistently when provisioning new instances Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/3279","commitMessage":"TRITON-93 Routes are not populated consistently when provisioning new instances\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1517356208,"lastUpdated":1518233664,"open":false,"status":"MERGED","comments":[{"timestamp":1517356208,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1517356251,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517368610,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\nThis is just a draft to make sure that the current direction of this change makes sense. Hopefully tests will be added (if possible) shortly, as well as testing notes."},{"timestamp":1517389156,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)\n\nI think this looks pretty good. Do you have notes on what tests you ran?"},{"timestamp":1517422168,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n\u003e Do you have notes on what tests you ran?\n\nMy initial comment in this CR was:\n\n\"Hopefully tests will be added (if possible) shortly, as well as testing notes.\""},{"timestamp":1518120872,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1518120903,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1518120915,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518120947,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518121390,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1518152773,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\n(5 comments)\n\nI think this looks good. I was initially worried about loading all properties. I thought we\u0027d just load the resolvers. But your comment makes it clear that sdc:routes is not loaded that frequently so I guess this is fine."},{"timestamp":1518196910,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 4."},{"timestamp":1518196917,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1518196953,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518198524,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1518202634,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1518218570,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 5."},{"timestamp":1518218576,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1518218614,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1518219909,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1518219952,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1518220081,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1518233645,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1518233664,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"6","revision":"8b8d4b06618a694908173adfb39d8299bc505cf5","parents":["feed8677b44d3508bc39e838bfb6aafcf66b1cfd"],"ref":"refs/changes/79/3279/6","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1518233645,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518218614,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518219909,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518219952,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518220081,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1518233664,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/common/vmtest.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":98,"deletions":-38},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/tests/test-routes-joyent-minimal.js","fileOld":"src/vm/tests/test-routes.js","type":"RENAMED","insertions":3,"deletions":-3},{"file":"src/vm/tests/test-routes-lx.js","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":229,"sizeDeletions":-44},"patchSets":[{"number":"1","revision":"cf2a54b11556cec98cb327d26902c1ae97bcc466","parents":["8cb1966020cbc891aa3c18dc9a736dd9c3c42d3d"],"ref":"refs/changes/79/3279/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1517356208,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517356251,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517389156,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":23,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"A poem:\n\n     don\u0027t want to be mean\n     but have you seen\n     it\u0027s 2018!"},{"file":"src/vm/node_modules/vmload/index.js","line":24,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Code written 31-395 days ago was 2017, but not this code!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":31,"deletions":-32},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":32,"sizeDeletions":-32},{"number":"2","revision":"f6b663397a4bc53f68b9bf5243bc9658a457f527","parents":["8cb1966020cbc891aa3c18dc9a736dd9c3c42d3d"],"ref":"refs/changes/79/3279/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1518120872,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518120915,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/common/vmtest.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":98,"deletions":-38},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-routes-joyent-minimal.js","fileOld":"src/vm/tests/test-routes.js","type":"RENAMED","insertions":3,"deletions":-3},{"file":"src/vm/tests/test-routes-lx.js","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":227,"sizeDeletions":-42},{"number":"3","revision":"4b12fb7aeda34ec1a22f5b7b91964cf075ba0ffa","parents":["feed8677b44d3508bc39e838bfb6aafcf66b1cfd"],"ref":"refs/changes/79/3279/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1518120903,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518120947,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518152773,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518152773,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"src/vm/common/vmtest.js","line":2,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Quick! The lawyers are coming!"},{"file":"src/vm/common/vmtest.js","line":2,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":":) Fixed!"},{"file":"src/vm/common/vmtest.js","line":55,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"is this really 14.04?! That\u0027s almost 4 years old! I didn\u0027t realize we had such an old LX image."},{"file":"src/vm/common/vmtest.js","line":55,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we use a more recent one like ubuntu 16.04?"},{"file":"src/vm/common/vmtest.js","line":55,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I don\u0027t really care, I was just surprised we *had* such an old image for LX. The only reason it might be good to get a newer one, would be if we have plans to deprecate the 14.04 image which would break this test. But I guess it\u0027s also easy (hopefully) to fix that if it happens?"},{"file":"src/vm/lib/metadata/agent.js","line":23,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"So last year."},{"file":"src/vm/lib/metadata/agent.js","line":23,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"src/vm/lib/metadata/agent.js","line":387,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Even though that part of the changes are not strictly needed to fix the actual problem tracked by TRITON-93, I thought I\u0027d keep it in that CR because it seems it\u0027s the right thing to do here, compared to what was there.\n\nI\u0027m happy to remove that from this CR though if it looks like it would be better to leave it out for now."},{"file":"src/vm/node_modules/vmload/index.js","line":24,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed it by that much! (1)"},{"file":"src/vm/node_modules/vmload/index.js","line":24,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"src/vm/tests/test-routes-joyent-minimal.js","line":1,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Bullseye!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/common/vmtest.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":98,"deletions":-38},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-routes-joyent-minimal.js","fileOld":"src/vm/tests/test-routes.js","type":"RENAMED","insertions":3,"deletions":-3},{"file":"src/vm/tests/test-routes-lx.js","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":227,"sizeDeletions":-42},{"number":"4","revision":"f2dc9ef339c5521a0b99847b301b217608bd7a4a","parents":["feed8677b44d3508bc39e838bfb6aafcf66b1cfd"],"ref":"refs/changes/79/3279/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1518196910,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518196953,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":406,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"s/,/./"},{"file":"src/vm/lib/metadata/agent.js","line":406,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"src/vm/lib/metadata/agent.js","line":1356,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This problem affects all VMs, so this might be better worded as \"so that the instance can ...\""},{"file":"src/vm/lib/metadata/agent.js","line":1356,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/common/vmtest.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":99,"deletions":-39},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/tests/test-routes-joyent-minimal.js","fileOld":"src/vm/tests/test-routes.js","type":"RENAMED","insertions":3,"deletions":-3},{"file":"src/vm/tests/test-routes-lx.js","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":230,"sizeDeletions":-45},{"number":"5","revision":"3a2b04b2da8bc9ef52342efa6f9f42de6aeeacaa","parents":["feed8677b44d3508bc39e838bfb6aafcf66b1cfd"],"ref":"refs/changes/79/3279/5","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1518218570,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518219909,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518219952,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518218614,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518220081,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/common/vmtest.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":98,"deletions":-38},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/tests/test-routes-joyent-minimal.js","fileOld":"src/vm/tests/test-routes.js","type":"RENAMED","insertions":3,"deletions":-3},{"file":"src/vm/tests/test-routes-lx.js","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":229,"sizeDeletions":-44},{"number":"6","revision":"8b8d4b06618a694908173adfb39d8299bc505cf5","parents":["feed8677b44d3508bc39e838bfb6aafcf66b1cfd"],"ref":"refs/changes/79/3279/6","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1518233645,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518219909,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518219952,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1518218614,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518220081,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1518233664,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/common/vmtest.js","type":"MODIFIED","insertions":7,"deletions":-2},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":98,"deletions":-38},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"src/vm/tests/test-routes-joyent-minimal.js","fileOld":"src/vm/tests/test-routes.js","type":"RENAMED","insertions":3,"deletions":-3},{"file":"src/vm/tests/test-routes-lx.js","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":229,"sizeDeletions":-44}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}