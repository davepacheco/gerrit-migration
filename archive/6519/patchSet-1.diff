From 93ca6a131cb6168a9fdd069fd352d3ad0852576f Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Fri, 28 Jun 2019 12:26:31 +0000
Subject: [PATCH] MANTA-2843 Manta zones lacking CPU cap thwart provisioning

---
 docs/index.md                               |  1 +
 lib/algorithms/hard-filter-capness.js       | 13 ++++++++-
 lib/validations.js                          |  5 ++--
 test/algorithms/hard-filter-capness.test.js | 30 ++++++++++++++++++---
 test/common.js                              |  5 ++--
 test/validations.test.js                    |  1 +
 6 files changed, 46 insertions(+), 9 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index c44f883..54e25c7 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -310,6 +310,7 @@ Some default values can be altered upon allocator initialisation.
 | **Attribute**            | **Type** | **Default** | **Description** |
 | ------------------------ | -------- | ------------| --------------- |
 | disable_override_overprovisioning | Boolean | false | Whether the override-overprovisioning plugin should be disabled. |
+| filter_capness           | Boolean  | true    | Whether to cross check CPU caps.                                      |
 | filter_docker_min_platform        | String  | -     | Minimum platform version allowed for Docker containers.         |
 | filter_docker_nfs_volumes_automount_min_platform      | String  | -     | Minimum platform version allowed for Docker containers that automatically mount NFS volumes. |
 | filter_non_docker_nfs_volumes_automount_min_platform  | String  | -     | Minimum platform version allowed for non-Docker (infrastructure) containers that automatically mount NFS volumes. |
diff --git a/lib/algorithms/hard-filter-capness.js b/lib/algorithms/hard-filter-capness.js
index 935ed45..9219a80 100644
--- a/lib/algorithms/hard-filter-capness.js
+++ b/lib/algorithms/hard-filter-capness.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -30,6 +30,11 @@
  * making cleanup vastly easier. In some cases, if the operators really know
  * what they're doing and getting into, they can omit the traits practice
  * mentioned above altogether.
+ *
+ * However, for development purposes, it can be useful to have a single system
+ * that is both a Manta deployment and usable for provisioning with standard
+ * packages. Since Manta zones currently don't have a CPU cap, we allow a SAPI
+ * setting to disable this check.
  */
 
 var assert = require('assert-plus');
@@ -43,6 +48,12 @@ filterCapness(servers, opts, cb)
 
 	var reasons = {};
 
+	var override = opts.defaults.filter_capness;
+	if (typeof (override) !== 'undefined' && !override) {
+		reasons.skip = 'Do not filter out cpu_cap disparities';
+		return (cb(null, servers, reasons));
+	}
+
 	var pkgCapness = !!(opts.vm.cpu_cap || (opts.pkg && opts.pkg.cpu_cap));
 
 	var adequateServers = servers.filter(function checkServer(server) {
diff --git a/lib/validations.js b/lib/validations.js
index 32cf91d..bb8fcd3 100644
--- a/lib/validations.js
+++ b/lib/validations.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -32,7 +32,8 @@ var DEFAULTS_BOOLEAN_ATTR = [
 	'filter_headnode',
 	'filter_min_resources',
 	'filter_large_servers',
-	'disable_override_overprovisioning'
+	'disable_override_overprovisioning',
+	'filter_capness'
 ];
 
 var DEFAULTS_NUM_ATTR = [
diff --git a/test/algorithms/hard-filter-capness.test.js b/test/algorithms/hard-filter-capness.test.js
index d5506d3..bde618f 100644
--- a/test/algorithms/hard-filter-capness.test.js
+++ b/test/algorithms/hard-filter-capness.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var test = require('tape');
@@ -76,7 +76,7 @@ test('filterCapness() with package with cpu_cap', function (t) {
 		/* END JSSTYLED */
 	};
 
-	var opts = { vm: {}, pkg: { cpu_cap: 100 } };
+	var opts = { defaults: {}, vm: {}, pkg: { cpu_cap: 100 } };
 
 	checkFilter(t, SERVERS, opts, expectServers, expectReasons);
 });
@@ -92,7 +92,29 @@ test('filterCapness() with package without cpu_cap', function (t) {
 		/* END JSSTYLED */
 	};
 
-	var opts = { vm: {}, pkg: {} };
+	var opts = { defaults: {}, vm: {}, pkg: {} };
+
+	checkFilter(t, SERVERS, opts, expectServers, expectReasons);
+});
+
+
+test('filterCapness() with package with cpu_cap, over-ridden', function (t) {
+	var expectServers = SERVERS;
+	var expectReasons = { skip: 'Do not filter out cpu_cap disparities' };
+
+	var opts = { defaults:  { filter_capness: false },
+		     vm: {}, pkg: { cpu_cap: 100 } };
+
+	checkFilter(t, SERVERS, opts, expectServers, expectReasons);
+});
+
+
+test('filterCapness() with package without cpu_cap, over-ridden', function (t) {
+	var expectServers = SERVERS;
+	var expectReasons = { skip: 'Do not filter out cpu_cap disparities' };
+
+	var opts = { defaults:  { filter_capness: false },
+		     vm: {}, pkg: {} };
 
 	checkFilter(t, SERVERS, opts, expectServers, expectReasons);
 });
@@ -101,7 +123,7 @@ test('filterCapness() with package without cpu_cap', function (t) {
 test('filterCapness() with no servers', function (t) {
 	var expectServers = [];
 	var expectReasons = {};
-	var opts = { vm: {}, pkg: {} };
+	var opts = { defaults: {},  vm: {}, pkg: {} };
 
 	checkFilter(t, [], opts, expectServers, expectReasons);
 });
diff --git a/test/common.js b/test/common.js
index 57b6858..c877e97 100644
--- a/test/common.js
+++ b/test/common.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var fs = require('fs');
@@ -61,7 +61,8 @@ var DEFAULTS = {
 	weight_unreserved_ram: 2,
 	filter_headnode: true,
 	filter_min_resources: true,
-	filter_large_servers: true
+	filter_large_servers: true,
+	filter_capness: true
 };
 
 
diff --git a/test/validations.test.js b/test/validations.test.js
index fd1c56c..f3e86b0 100644
--- a/test/validations.test.js
+++ b/test/validations.test.js
@@ -195,6 +195,7 @@ var DEFAULTS = {
 	filter_headnode: true,
 	filter_min_resources: true,
 	filter_large_servers: true,
+	filter_capness: true,
 	filter_docker_min_platform: '20130308T102805Z',
 	filter_vm_limit: true,
 	filter_owner_server: {
-- 
2.21.0

