{"project":"joyent/node-moray","branch":"master","topic":"MORAY-428","id":"I3367330b7ca53232bb8936501eced32d8b8b5028","number":"2650","subject":"MORAY-428 Make it safer to use reindexing buckets Reviewed by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/2650","commitMessage":"MORAY-428 Make it safer to use reindexing buckets\nReviewed by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1506373127,"lastUpdated":1507784992,"open":false,"status":"MERGED","comments":[{"timestamp":1506373127,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1506373136,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Topic set to MORAY-428"},{"timestamp":1506373151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506543199,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1506720243,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(2 comments)\n\nThis looks very good, my comments are pretty minor, I think once you address them I\u0027ll be able to +1 this. Thanks!"},{"timestamp":1506723821,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1506736085,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1506736114,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506736133,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1506989571,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1506989605,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507154650,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1507588042,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1507588067,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1507588499,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5."},{"timestamp":1507588525,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1507588527,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507592407,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 6."},{"timestamp":1507592436,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507750514,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Code-Review+1\n\n(1 comment)\n\nWhat about the version number in package.json? Should we bump the minor version number since we added a new option to some of the existing APIs?"},{"timestamp":1507754689,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1507754980,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 7."},{"timestamp":1507755009,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507755076,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1507755158,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 6:\n\nI\u0027ve bumped the version number, and refactored the client. I\u0027m running the client through the test suite right now."},{"timestamp":1507755626,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1507755935,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 8:\n\nSorry that I haven\u0027t had a chance to look at this very closely, but the changes for the notes that I made before look good."},{"timestamp":1507756316,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1507756376,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 9: Commit message was updated."},{"timestamp":1507784992,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"9","revision":"22ab00cf1982302d4cc77546c346ebbbd681e914","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/9","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507756376,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507755009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507756316,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1507784992,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"lib/client.js","type":"MODIFIED","insertions":15,"deletions":-5},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":110,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"aa4d0018206707706b87fc9498dda298b73446d2","parents":["e1320409e5c630b6a57b0594947db035057b7924"],"ref":"refs/changes/50/2650/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1506373127,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506373151,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":719,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"If we initialize opts to \u0027{}\u0027, wouldn\u0027t line 725 catch that and add the onlineReindexing field?"},{"file":"lib/client.js","line":719,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same question! :)"},{"file":"lib/client.js","line":719,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You\u0027re right, it would. I\u0027ll revert this to {}, and let the check below handle it."},{"file":"lib/objects.js","line":133,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is it possible to get just one record in the response and for it to be a metadata record?"},{"file":"lib/objects.js","line":133,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If there was no object for the server to return, then we would also receive ObjectNotFoundError, and exit above."},{"file":"lib/objects.js","line":302,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Does Sr mean \u0027supports online reindexing?\u0027"},{"file":"lib/objects.js","line":302,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"It was for \"safeReindexing\", what I initially named the option. I forgot to update this function name after changing it to \"onlineReindexing\"."},{"file":"lib/objects.js","line":489,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Don\u0027t we want to support the \"onlineReindexing\" option for deleteMany too?"},{"file":"lib/objects.js","line":489,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Since the behaviour for deleteMany/updateObjects will be the new behaviour all the time, we don\u0027t need an option to enable it.\n\nIt would be nice if there were a way to send an option such that older Moray servers would reject it if they didn\u0027t recognize it, but there isn\u0027t a way to do that. We can\u0027t expect something like the metadata record here either, since deleteMany and updateObjects just go ahead and modify the data, and we can\u0027t roll that back if the server didn\u0027t send a metadata record.\n\nI took a look at the consumers of updateObjects and deleteMany, and they don\u0027t try using them on fields that might be reindexing at the time."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":21,"deletions":-4},{"file":"lib/objects.js","type":"MODIFIED","insertions":78,"deletions":-9}],"sizeInsertions":99,"sizeDeletions":-13},{"number":"2","revision":"197c19cd290f6fef8687eda70c4d621cdbc9343c","parents":["e1320409e5c630b6a57b0594947db035057b7924"],"ref":"refs/changes/50/2650/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1506736085,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506736114,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":18,"deletions":-3},{"file":"lib/objects.js","type":"MODIFIED","insertions":78,"deletions":-9}],"sizeInsertions":96,"sizeDeletions":-12},{"number":"3","revision":"46fd0e4f2bc233047dd521d4e5fba554f1fe16ed","parents":["e1320409e5c630b6a57b0594947db035057b7924"],"ref":"refs/changes/50/2650/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1506989571,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506989605,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":726,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I generally think it\u0027s dangerous to modify the caller\u0027s object.  Since we only support plain JS objects, how about deep copying it?"},{"file":"lib/client.js","line":726,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/client.js","line":785,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same here."},{"file":"lib/client.js","line":785,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9}],"sizeInsertions":99,"sizeDeletions":-12},{"number":"4","revision":"9cfa8151db46a2632711a5692b82c76d2b3455df","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507588042,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506989605,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9}],"sizeInsertions":99,"sizeDeletions":-12},{"number":"5","revision":"99cd033075483f511352f50db6f4b43284470b91","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507588499,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507588527,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":17,"deletions":-3},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9}],"sizeInsertions":96,"sizeDeletions":-12},{"number":"6","revision":"bdd0e30c62734c12f17071ceff481717a5367454","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/6","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507592407,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507592436,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507750514,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"lib/client.js","line":786,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is the \"opts || defaultOpts\" below at line 791 still necessary then?"},{"file":"lib/client.js","line":786,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Yes, in case opts is undefined. I\u0027ll refactor this though so that that doesn\u0027t matter."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":17,"deletions":-3},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9}],"sizeInsertions":96,"sizeDeletions":-12},{"number":"7","revision":"e1edc75b05cd1c4fe19b786b2abcea3e1887fe09","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/7","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507754980,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507755009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"lib/client.js","type":"MODIFIED","insertions":15,"deletions":-5},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":110,"sizeDeletions":-26},{"number":"8","revision":"3367330b7ca53232bb8936501eced32d8b8b5028","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/8","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507755626,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507755009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507756316,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"lib/client.js","type":"MODIFIED","insertions":15,"deletions":-5},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":110,"sizeDeletions":-26},{"number":"9","revision":"22ab00cf1982302d4cc77546c346ebbbd681e914","parents":["aa8a4c7507ee7ab6b93c8e8e9d50c67893bd5dc2"],"ref":"refs/changes/50/2650/9","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1507756376,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1507784992,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507755009,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507755076,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507756316,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":-11},{"file":"lib/client.js","type":"MODIFIED","insertions":15,"deletions":-5},{"file":"lib/objects.js","type":"MODIFIED","insertions":79,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":110,"sizeDeletions":-26}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}