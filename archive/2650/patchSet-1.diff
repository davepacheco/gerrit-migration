From aa4d0018206707706b87fc9498dda298b73446d2 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Wed, 20 Sep 2017 22:18:44 +0000
Subject: [PATCH] MORAY-428 Make it safer to use reindexing buckets

---
 lib/client.js  | 25 ++++++++++++---
 lib/objects.js | 87 ++++++++++++++++++++++++++++++++++++++++++++------
 2 files changed, 99 insertions(+), 13 deletions(-)

diff --git a/lib/client.js b/lib/client.js
index e08178c..5dbeb1e 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -85,6 +85,7 @@ function MorayClient(options) {
     assert.optionalBool(options.unwrapErrors, 'options.unwrapErrors');
     assert.optionalBool(options.failFast, 'options.failFast');
     assert.optionalBool(options.requireIndexes, 'options.requireIndexes');
+    assert.optionalBool(options.onlineReindexing, 'options.onlineReindexing');
 
     coptions = parseMorayParameters(options);
     cueballOptions = coptions.cueballOptions;
@@ -95,6 +96,7 @@ function MorayClient(options) {
     this.unwrapErrors = options.unwrapErrors ? true : false;
     this.failFast = options.failFast ? true : false;
     this.requireIndexes = options.requireIndexes ? true : false;
+    this.onlineReindexing = options.onlineReindexing ? true : false;
 
     /* Helper objects. */
     this.log = options.log.child({
@@ -713,11 +715,17 @@ MorayClient.prototype.getObject = function getObject(b, k, opts, cb) {
     assert.string(k, 'key');
     if (typeof (opts) === 'function') {
         cb = opts;
-        opts = {};
+        opts = {
+            onlineReindexing: this.onlineReindexing
+        };
     }
     assert.object(opts, 'options');
     assert.func(cb, 'callback');
 
+    if (opts.onlineReindexing === undefined) {
+        opts.onlineReindexing = this.onlineReindexing;
+    }
+
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx)
         objects.getObject(rpcctx, b, k, opts, this.makeReleaseCb(rpcctx, cb));
@@ -767,9 +775,18 @@ MorayClient.prototype.findObjects = function findObjects(b, f, opts) {
     assert.string(f, 'filter');
     assert.optionalObject(opts, 'options');
 
-    var defaultOpts = {requireIndexes: this.requireIndexes};
-    if (opts && opts.requireIndexes === undefined) {
-        opts.requireIndexes = this.requireIndexes;
+    var defaultOpts = {
+        requireIndexes: this.requireIndexes,
+        onlineReindexing: this.onlineReindexing
+    };
+
+    if (opts) {
+        if (opts.requireIndexes === undefined) {
+            opts.requireIndexes = this.requireIndexes;
+        }
+        if (opts.onlineReindexing === undefined) {
+            opts.onlineReindexing = this.onlineReindexing;
+        }
     }
 
     var rpcctx = this.ctxCreateForEmitter();
diff --git a/lib/objects.js b/lib/objects.js
index 917c6ba..90a279c 100644
--- a/lib/objects.js
+++ b/lib/objects.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -67,7 +67,57 @@ function getObject(rpcctx, bucket, key, options, callback) {
     assert.object(options, 'options');
     assert.func(callback, 'callback');
 
+    var handledOptions = {
+        'onlineReindexing': false
+    };
+    var optionsSpec = {
+        onlineReindexing: {
+            testNeedHandling: function testNeedHandling(value) {
+                return (value === true);
+            }
+        }
+    };
+
+    var optionsToHandle = getOptionsToHandle(options, optionsSpec);
+    var needMetadataRecord = optionsToHandle.length > 0;
+
     opts = makeOptions(options);
+    if (needMetadataRecord) {
+        opts.internalOpts = { sendHandledOptions: true };
+    }
+
+    function checkHandledOptions(metadata, obj) {
+        var unhandledOptions;
+
+        if (!jsprim.hasKey(metadata, '_handledOptions')) {
+            callback(new VError({
+                info: {
+                    records: {
+                        metadata: metadata,
+                        obj: obj
+                    }
+                },
+                message: 'received 2 data messages, but ' +
+                    'first message does not look like a metadata record'
+            }));
+            return;
+        }
+
+        if (metadata._handledOptions) {
+            if (metadata._handledOptions.indexOf('onlineReindexing') !== -1) {
+                handledOptions.onlineReindexing = true;
+            }
+        }
+
+        unhandledOptions = getUnhandledOptions(handledOptions, optionsToHandle);
+        if (unhandledOptions.length > 0) {
+            callback(createUnhandledOptionsError(unhandledOptions));
+            return;
+        }
+
+        callback(null, obj);
+    }
+
     log = rpc.childLogger(rpcctx, opts);
     rpc.rpcCommonBufferData({
         'rpcctx': rpcctx,
@@ -75,15 +125,24 @@ function getObject(rpcctx, bucket, key, options, callback) {
         'rpcmethod': 'getObject',
         'rpcargs': [ bucket, key, opts ]
     }, function (err, data) {
-        if (!err && data.length != 1) {
-            err = new VError('expected exactly 1 data message, found %d',
-                data.length);
-        }
-
         if (err) {
             callback(err);
-        } else {
+            return;
+        }
+
+        if (data.length === 1) {
+            if (needMetadataRecord) {
+                err = createUnhandledOptionsError(Object.keys(handledOptions));
+                callback(err);
+                return;
+            }
+
             callback(null, data[0]);
+        } else if (data.length === 2) {
+            checkHandledOptions(data[0], data[1]);
+        } else {
+            callback(new VError('expected 1 or 2 data messages, found %d',
+                data.length));
         }
     });
 }
@@ -230,11 +289,17 @@ function findObjects(rpcctx, bucket, filter, options) {
     var isFirstDataRecord = true;
     var needMetadataRecord = false;
     var handledOptions = {
-        'requireIndexes': false
+        'requireIndexes': false,
+        'onlineReindexing': false
     };
     var optionsSpec = {
         requireIndexes: {
-            testNeedHandling: function testNeedHandling(value) {
+            testNeedHandling: function testRiNeedHandling(value) {
+                return (value === true);
+            }
+        },
+        onlineReindexing: {
+            testNeedHandling: function testSrNeedHandling(value) {
                 return (value === true);
             }
         }
@@ -296,6 +361,10 @@ function findObjects(rpcctx, bucket, filter, options) {
                     if (msg._handledOptions.indexOf('requireIndexes') !== -1) {
                         handledOptions.requireIndexes = true;
                     }
+                    if (msg._handledOptions.indexOf('onlineReindexing')
+                        !== -1) {
+                        handledOptions.onlineReindexing = true;
+                    }
                 }
             }
 
-- 
2.21.0

