{"project":"joyent/illumos-joyent","branch":"master","id":"Ib95f55a69854beac0c81d44ffc5bee397a2ad27a","number":"2557","subject":"PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/2557","commitMessage":"PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint\n","createdOn":1505320874,"lastUpdated":1505771260,"open":false,"status":"ABANDONED","comments":[{"timestamp":1505320874,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1505320878,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 2143275022a431defde6e76ce69121109f433ab6\n    \n    PUBAPI-1420 Add ability to mount NFS volumes with CreateMachine endpoint"},{"timestamp":1505339055,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1505418266,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1505429166,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1505429172,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 98b0280bc13d66261ab783a934e1afa7b42f3859\n    \n    updates based on code review"},{"timestamp":1505429189,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1505430019,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1505496329,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1505520400,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1505520411,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 2ae3ab92dbc46333836d691e92bce5256184fc82\n    \n    simplified further in response to CR"},{"timestamp":1505579965,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1505759097,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1505760728,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1505760743,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 896b4414e957422d5865bfbb4141d214e37e26ef\n    \n    update comment based on CR feedback"},{"timestamp":1505762073,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nA piece of overall feedback:  Up until now, we\u0027ve kept most of the Triton-specific code confined to smartos-live, a good example being dockerinit.  While a hook for accomplishing the volume-mounting is obviously necessary during the lxinit boot-up procedure, what if we made it more general?  Would it be unreasonable to make lxinit call (if present) some general post-network-setup hook program provided by smartos-live.  The volume mounting, as well as anything else really triton specific, could be done there.\n\nIf such a suggestion is too onerous, I\u0027m happy to defer on this and review as-is."},{"timestamp":1505765498,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\n@pmooney: I wonder if it wouldn\u0027t make sense to do that as a separate ticket then? We also have routeinfo which follows this same pattern (routeinfo is in smartos-live). I could file a ticket for creating pre-networking and post-networking hooks and moving the logic for handling routes and volumes there instead. Would that work? I don\u0027t think that the change to these other hooks should change anything from a customer\u0027s perspective, so getting this in now would allow us to set the min_platform for which we can mount volumes and then we can move to the new hooks in the future transparently."},{"timestamp":1505771260,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Abandoned\n\nAbandoning due to OS-6354."}],"currentPatchSet":{"number":"4","revision":"b95f55a69854beac0c81d44ffc5bee397a2ad27a","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/57/2557/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505760728,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","type":"MODIFIED","insertions":207,"deletions":-1}],"sizeInsertions":207,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"efb7282f59e4127fa69965c08bdbc43366b30431","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/57/2557/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505320874,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":828,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I\u0027m not sure if the indentation is correct here, or if Gerrit is confusing me."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":828,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nope. It was wrong I think. Good catch! I\u0027ll fix."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":902,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can at least some of these be \"const char *\"?"},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":902,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"If I do that, the compiler complains when I free since it `discards qualifiers from pointer target type`"},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":914,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Would it make the code more concise to move the \"if (line[i] \u003d\u003d \u0027|\u0027)\" condition up and have the tests on type \u003d\u003d NULL, etc. nested in that test instead of the other way around?\n\nIt seems that the following lines:\n\ncustr_reset(cu);\ncontinue;\n\ncould also not be duplicated for each \"token\" being processed?"},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":914,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I agree that this parsing is not very clear."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":914,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok, I\u0027ve tried to clean this up a bit."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":921,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It appears that \u0027type\u0027 is unused in this function so maybe just skip over it or just validate that it is \"tritonnfs\" and fail the boot if its not."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":921,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"sounds good. Thanks for pointing this out."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":1025,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Shouldn\u0027t we error in this case? Otherwise it seems the provision/startup of that zone will be successful, even though it\u0027s not able to mount the volumes it depends on."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":1025,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"If we did that, a platform with a mismatched smartos-live and illumos-joyent would not allow lx zones to be booted at all. Unfortunately since lxinit itself doesn\u0027t do any mdata lookups, there\u0027s no way to know if a volume was requested or not here. Otherwise we could at least have aborted if a volume was to be mounted but we didn\u0027t have the volumeinfo command.\n\nAs it is, I don\u0027t know what we can do to make this better."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","type":"MODIFIED","insertions":228,"deletions":-1}],"sizeInsertions":228,"sizeDeletions":-1},{"number":"2","revision":"918391bc6d01b5383adbe4a064d1c44ee29e59ba","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/57/2557/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505429166,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":942,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I think this looks a lot easier to understand. You could actually maybe tighten it up even more by dropping the \u0027continue\u0027 everywhere and adding a final clause to call lxi_err."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":942,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"good point, I\u0027ll take another pass at this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","type":"MODIFIED","insertions":216,"deletions":-1}],"sizeInsertions":216,"sizeDeletions":-1},{"number":"3","revision":"61ea066dcfe1c2f9286b2170e509dfffc62336e0","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/57/2557/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505520400,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":944,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This looks a lot better. Sorry to keep nit-picking, but this comment is inconsistent with the fact that you\u0027re failing here."},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","line":944,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"No need to apologize. It\u0027s a good point."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","type":"MODIFIED","insertions":206,"deletions":-1}],"sizeInsertions":206,"sizeDeletions":-1},{"number":"4","revision":"b95f55a69854beac0c81d44ffc5bee397a2ad27a","parents":["b34e44c2aefdd578084f80084c5ad0566f74694f"],"ref":"refs/changes/57/2557/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1505760728,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_init/lxinit.c","type":"MODIFIED","insertions":207,"deletions":-1}],"sizeInsertions":207,"sizeDeletions":-1}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}