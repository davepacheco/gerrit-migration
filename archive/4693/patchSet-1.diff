From f76a054d6617ab6408869ebbda7fdd31c4b83e96 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Wed, 15 Aug 2018 13:21:55 -0600
Subject: [PATCH] joyent/node-manta#346 Fix issues with common options
 refactoring

---
 lib/options.js      |  8 ++++----
 test/mget.test.js   | 39 +++++++++++++++++++++++++++++++++++++++
 test/mmkdir.test.js |  3 ++-
 3 files changed, 45 insertions(+), 5 deletions(-)

diff --git a/lib/options.js b/lib/options.js
index 991614d..3f7fdef 100644
--- a/lib/options.js
+++ b/lib/options.js
@@ -76,10 +76,6 @@ function parseOptions(args) {
         opts.headers[tokens[0]] = tokens[1].trim();
     });
 
-    if (args.parseCmdOptions) {
-        args.parseCmdOptions(opts, parser);
-    }
-
     if (opts._args.length < 1) {
         cc.usage(parser, 'path required', extra);
     }
@@ -90,6 +86,10 @@ function parseOptions(args) {
                     };
     opts.paths = opts._args.map(getPath);
 
+    if (args.parseCmdOptions) {
+        args.parseCmdOptions(opts, parser);
+    }
+
     try {
         cc.checkBinEnv(opts);
     } catch (e) {
diff --git a/test/mget.test.js b/test/mget.test.js
index e6b7774..11cb365 100644
--- a/test/mget.test.js
+++ b/test/mget.test.js
@@ -276,6 +276,45 @@ test('mget -o TMPFILE TESTDIR/01.txt TESTDIR/02.txt TESTDIR/03.txt',
     });
 });
 
+/*
+ * Download a file which does exist, and store the output in a file named after
+ * the remote object using the "-O" flag.
+ */
+test('mget -O TESTDIR/01.txt',
+    function (t) {
+
+    var file = path.join(TMPDIR, '01.txt');
+    var argv = [MGET, '-O', sprintf('%s/%02d.txt', TESTDIR, 1)];
+
+    /*
+     * We expect "mget" to download the one file and store the contents in
+     * the temporary file we nominated.
+     */
+    var expected = [
+        'first',
+        'file (01)'
+    ].join('\n') + '\n';
+
+    unlinkIfExists(file);
+
+    process.chdir(TMPDIR);
+
+    forkExecWait({
+        argv: argv
+    }, function (err, info) {
+        t.ifError(err, err);
+        t.equal(info.stdout, '', 'no stdout');
+        t.equal(info.stderr, '', 'no stderr');
+
+        var fileData = fs.readFileSync(file, 'utf8');
+        t.equal(fileData, expected, 'file data from mget');
+
+        unlinkIfExists(file);
+
+        t.done();
+    });
+});
+
 
 /*
  * Download two files that do exist, then one that does not exist, then a
diff --git a/test/mmkdir.test.js b/test/mmkdir.test.js
index e2063cf..2cc1285 100644
--- a/test/mmkdir.test.js
+++ b/test/mmkdir.test.js
@@ -94,7 +94,8 @@ test('cleanup: rm test directory ' + TESTDIR, function (t) {
     assert.ok(TESTDIR.indexOf('node-manta-test') !== -1);
 
     forkExecWait({ argv: [ MRM, '-r', TESTDIR ]}, function (err) {
-        t.ifError(err, err);
+        // Ignore errors because directory may not exist if optional test was
+        // not run
         t.done();
     });
 });
-- 
2.21.0

