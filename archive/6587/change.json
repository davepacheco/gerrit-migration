{"project":"joyent/illumos-joyent","branch":"master","id":"Iab56f6ef7a90c34752037f913eceabd8ca9e7b19","number":"6587","subject":"OS-6769 want i40e HW VLAN support","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/6587","commitMessage":"OS-6769 want i40e HW VLAN support\n","createdOn":1562801072,"lastUpdated":1562942773,"open":true,"status":"NEW","comments":[{"timestamp":1562801072,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1562803444,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(6 comments)\n\nI tried to audit all the places that we relied on groups having mgi_addmac as valid. I think I caught most of them, but I\u0027m not certain. All in all this seems pretty good, though there are a few edge cases I think we need to consider still."},{"timestamp":1562942773,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(6 comments)\n\nI\u0027m a bit stuck on how to proceed in relation to aggrs. But wanted to add some comments to show you were my head is at for the moment."}],"currentPatchSet":{"number":"1","revision":"ab56f6ef7a90c34752037f913eceabd8ca9e7b19","parents":["3d280bd5aa877a68b01b0b5dc7cb0f92843e8b41"],"ref":"refs/changes/87/6587/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1562801072,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":81,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"See the notes on add. I think we still need to pass I40E_AQC_MACVLAN_DEL_IGNORE_VLAN when we are passed MAC_VLAN_UNTAGGED."},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":81,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I addressed this under the other comment."},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":153,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we have MAC_VLAN_UNTAGGED don\u0027t we need to actually need to set I40E_AQC_MACVLAN_ADD_PERFECT_MATCH? Just like ixgbe does the logical equivalent in that case? Isn\u0027t that the distinction between having vid be zero and the flag?"},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":153,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I assume you meant to ask if we still need I40E_AQC_MACVLAN_ADD_IGNORE_VLAN here. Not only do we no longer need it, I don\u0027t think we ever should have enabled it. That flag indicates that we literally don\u0027t care what the VID value in the L2 frame is, just as long as the MAC matches. That is, the value could be anything and it\u0027ll be accepted as long as the MAC address matches. I think this means we have a bug into the current i40e driver: a client will see all traffic for a given MAC address, not just the untagged/VLAN it is interested in.\n\nIn any case, we want to be explicit about the VLANs we accept. And in order to accept untagged traffic the VID must be set to zero. This is covered in section 7.4.9.5.9.1 of the PG."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1973,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think that we need to update this function to know to either call mac_group_addmac or to call the mac/vlan combo here. It may make more sense to change mac_group_addmac() to call the underlying endpoint with the undefined VLAN bit rather than to try and bubble everything up. I suspect we\u0027ll need to come back and visit how that intersects with aggrs, the only caller of this interface."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1973,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, so we have a problem here. As I mentioned in the other comment, we don\u0027t want to set the \"ignore VLAN\" flag for i40e. And even if we had a way to set that flag only when dealing with aggrs we\u0027d have the problem where all traffic (tagged and untagged) is being sent to the client\u0027s group. I think the only way to rectify this, without some kind of major filtering API overhaul, is to implement the new `mgi_add_macvlan` API for aggr, and then it will determine which API to use for its underlying port. So for an ixgbe port it would call the `mgi_addmac` + `mgi_addvlan` APIs, and for i40e it would call `mgi_add_macvlan`.  I think this would work but I haven\u0027t thought it through completely."},{"file":"usr/src/uts/common/io/mac/mac.c","line":5449,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Right now we don\u0027t check or care if a driver has both interfaces or not. Should we prefer the HW_MACVLAN if it is set over just the HW_VLAN?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":5449,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yes, we should prefer it."},{"file":"usr/src/uts/common/io/mac/mac.c","line":5587,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It the above order is changed this will need to too. Maybe we should indicate what type of hw filter we\u0027ve done in the map structure just to make life easier when tearing down so it\u0027s a little less implicit?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":5587,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"There should be no order because it should always be one or the other. This should be enforced at register to make it absolutely clear."},{"file":"usr/src/uts/common/sys/mac_provider.h","line":473,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t believe we\u0027re actually enforcing that the add/rem_macvlan are exclusive with everything else. I don\u0027t know that we need to either. Just wanted to mention it."},{"file":"usr/src/uts/common/sys/mac_provider.h","line":473,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"We probably should enforce it to make it clear that it\u0027s one or the other."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":39,"deletions":-25},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":68,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":30,"deletions":-2}],"sizeInsertions":161,"sizeDeletions":-45},"patchSets":[{"number":"1","revision":"ab56f6ef7a90c34752037f913eceabd8ca9e7b19","parents":["3d280bd5aa877a68b01b0b5dc7cb0f92843e8b41"],"ref":"refs/changes/87/6587/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1562801072,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":81,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"See the notes on add. I think we still need to pass I40E_AQC_MACVLAN_DEL_IGNORE_VLAN when we are passed MAC_VLAN_UNTAGGED."},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":81,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I addressed this under the other comment."},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":153,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we have MAC_VLAN_UNTAGGED don\u0027t we need to actually need to set I40E_AQC_MACVLAN_ADD_PERFECT_MATCH? Just like ixgbe does the logical equivalent in that case? Isn\u0027t that the distinction between having vid be zero and the flag?"},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","line":153,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I assume you meant to ask if we still need I40E_AQC_MACVLAN_ADD_IGNORE_VLAN here. Not only do we no longer need it, I don\u0027t think we ever should have enabled it. That flag indicates that we literally don\u0027t care what the VID value in the L2 frame is, just as long as the MAC matches. That is, the value could be anything and it\u0027ll be accepted as long as the MAC address matches. I think this means we have a bug into the current i40e driver: a client will see all traffic for a given MAC address, not just the untagged/VLAN it is interested in.\n\nIn any case, we want to be explicit about the VLANs we accept. And in order to accept untagged traffic the VID must be set to zero. This is covered in section 7.4.9.5.9.1 of the PG."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1973,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think that we need to update this function to know to either call mac_group_addmac or to call the mac/vlan combo here. It may make more sense to change mac_group_addmac() to call the underlying endpoint with the undefined VLAN bit rather than to try and bubble everything up. I suspect we\u0027ll need to come back and visit how that intersects with aggrs, the only caller of this interface."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1973,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, so we have a problem here. As I mentioned in the other comment, we don\u0027t want to set the \"ignore VLAN\" flag for i40e. And even if we had a way to set that flag only when dealing with aggrs we\u0027d have the problem where all traffic (tagged and untagged) is being sent to the client\u0027s group. I think the only way to rectify this, without some kind of major filtering API overhaul, is to implement the new `mgi_add_macvlan` API for aggr, and then it will determine which API to use for its underlying port. So for an ixgbe port it would call the `mgi_addmac` + `mgi_addvlan` APIs, and for i40e it would call `mgi_add_macvlan`.  I think this would work but I haven\u0027t thought it through completely."},{"file":"usr/src/uts/common/io/mac/mac.c","line":5449,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Right now we don\u0027t check or care if a driver has both interfaces or not. Should we prefer the HW_MACVLAN if it is set over just the HW_VLAN?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":5449,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yes, we should prefer it."},{"file":"usr/src/uts/common/io/mac/mac.c","line":5587,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It the above order is changed this will need to too. Maybe we should indicate what type of hw filter we\u0027ve done in the map structure just to make life easier when tearing down so it\u0027s a little less implicit?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":5587,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"There should be no order because it should always be one or the other. This should be enforced at register to make it absolutely clear."},{"file":"usr/src/uts/common/sys/mac_provider.h","line":473,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t believe we\u0027re actually enforcing that the add/rem_macvlan are exclusive with everything else. I don\u0027t know that we need to either. Just wanted to mention it."},{"file":"usr/src/uts/common/sys/mac_provider.h","line":473,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"We probably should enforce it to make it clear that it\u0027s one or the other."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/i40e/i40e_gld.c","type":"MODIFIED","insertions":39,"deletions":-25},{"file":"usr/src/uts/common/io/i40e/i40e_sw.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":68,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":30,"deletions":-2}],"sizeInsertions":161,"sizeDeletions":-45}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}