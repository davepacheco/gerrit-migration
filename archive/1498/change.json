{"project":"joyent/node-cueball","branch":"master","id":"I40562d63f81c464ed88373a2ad07945adeb7aa35","number":"1498","subject":"joyent/node-cueball#94 ConnectionSet needs better protection against removing its last working connection Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/1498","commitMessage":"joyent/node-cueball#94 ConnectionSet needs better protection against removing its last working connection\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1486771385,"lastUpdated":1487885549,"open":false,"status":"MERGED","comments":[{"timestamp":1486771385,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1486771584,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487196937,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1487196997,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487294188,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1487728897,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1487728900,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1487728920,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1487728958,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1487728990,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\nWoops, pushed a bit prematurely there. make-check and make-test both pass again now."},{"timestamp":1487729024,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487833323,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1487885325,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1487885330,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1487885333,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1487885334,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1487885549,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"6","revision":"ddc7f88aa7684579155e69a8378ba1b57f79a40c","parents":["53805b0dab2c63735431c6cdc99bdf4882a223c7"],"ref":"refs/changes/98/1498/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487885330,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487729024,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487833323,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487885333,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1487885334,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"test/cset.test.js","type":"MODIFIED","insertions":201,"deletions":0}],"sizeInsertions":215,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"536aaa59cfa5f5354df337cc7da6d52106a7c827","parents":["8077b4e4ec4e5d9f3465e8410fcf8c61fa3c8df2"],"ref":"refs/changes/98/1498/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1486771385,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486771584,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":94,"deletions":-20},{"file":"test/cset.test.js","type":"MODIFIED","insertions":88,"deletions":0}],"sizeInsertions":182,"sizeDeletions":-20},{"number":"2","revision":"8f8d19708b03e752c0b89af90fc31c93e2cd90ca","parents":["8077b4e4ec4e5d9f3465e8410fcf8c61fa3c8df2"],"ref":"refs/changes/98/1498/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487196937,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487196997,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/set.js","line":572,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Is this .rebalance() meant to ensure that if a connection slot stops or fails then the set considers replacing it?"},{"file":"lib/set.js","line":572,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes. It becomes particularly important though in this case, because we may have asked some connections to shut down and then not added new ones yet because we\u0027re at our socket limit. We need to make sure as soon as they shut down we start opening new ones (or we raise the risk of ending up with an empty set)"},{"file":"test/cset.test.js","line":573,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Where does stopTimer get set? It seems like this isn\u0027t needed? Or do you mean to save your current setTimeouts here?"},{"file":"test/cset.test.js","line":644,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Did you mean to test that conn4 is alive here instead of that conn3 is still dead?\n\nOr is this test instead meant to eventually show that conn3 remains alive until conn4 successfully connects, but cueball doesn\u0027t do that yet? (As mentioned in the ticket.)"},{"file":"test/cset.test.js","line":644,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"This is actually a holdover from the earlier versions of this test, like stopTimer. I\u0027ll remove it."},{"file":"test/cset.test.js","line":670,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Same as above."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"test/cset.test.js","type":"MODIFIED","insertions":209,"deletions":0}],"sizeInsertions":223,"sizeDeletions":-6},{"number":"3","revision":"081727e7ed1d448a27c413088e5f82bdf5c3e57c","parents":["8077b4e4ec4e5d9f3465e8410fcf8c61fa3c8df2"],"ref":"refs/changes/98/1498/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487728897,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1487728920,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/cset.test.js","line":575,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: stopTimer"},{"file":"test/cset.test.js","line":576,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: stopTimer"},{"file":"test/cset.test.js","line":669,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: stopTimer"},{"file":"test/cset.test.js","line":670,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: stopTimer"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"test/cset.test.js","type":"MODIFIED","insertions":205,"deletions":0}],"sizeInsertions":219,"sizeDeletions":-6},{"number":"4","revision":"40562d63f81c464ed88373a2ad07945adeb7aa35","parents":["8077b4e4ec4e5d9f3465e8410fcf8c61fa3c8df2"],"ref":"refs/changes/98/1498/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487728958,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487833323,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487729024,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"test/cset.test.js","type":"MODIFIED","insertions":201,"deletions":0}],"sizeInsertions":215,"sizeDeletions":-6},{"number":"5","revision":"35c6e3f8867eb6ae6fa1fde7283bdd605184d75a","parents":["8077b4e4ec4e5d9f3465e8410fcf8c61fa3c8df2"],"ref":"refs/changes/98/1498/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487885325,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487833323,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487729024,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"test/cset.test.js","type":"MODIFIED","insertions":201,"deletions":0}],"sizeInsertions":215,"sizeDeletions":-6},{"number":"6","revision":"ddc7f88aa7684579155e69a8378ba1b57f79a40c","parents":["53805b0dab2c63735431c6cdc99bdf4882a223c7"],"ref":"refs/changes/98/1498/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487885330,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487833323,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487885333,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1487885334,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487729024,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/set.js","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"test/cset.test.js","type":"MODIFIED","insertions":201,"deletions":0}],"sizeInsertions":215,"sizeDeletions":-6}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}