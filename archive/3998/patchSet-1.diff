From 761328931abddbbfb07345ab5de17ac450ee5c8e Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Thu, 24 May 2018 22:28:39 +1200
Subject: [PATCH] TRITON-429 Switch to @smaller/tap

---
 Makefile                                       |  2 +-
 package.json                                   |  2 +-
 test/account.test.js                           |  4 ++--
 test/affinity-unit.test.js                     |  8 +++++---
 test/analytics.test.js                         |  4 ++--
 test/auth.test.js                              |  4 ++--
 test/datacenters.test.js                       |  4 ++--
 test/fabrics.test.js                           | 14 ++++++++++++--
 test/getCreateOptions.test.js                  |  2 +-
 test/images.70.test.js                         |  4 ++--
 test/images.80.test.js                         |  4 ++--
 test/images.test.js                            |  4 ++--
 test/keys.test.js                              |  4 ++--
 test/machines.70.test.js                       |  4 ++--
 test/machines.71.test.js                       |  4 ++--
 test/machines.72.test.js                       |  8 ++++----
 test/machines.73.test.js                       |  6 ++++--
 test/machines.80.test.js                       |  2 +-
 test/machines.test.js                          |  2 +-
 test/networks.test.js                          |  6 ++++--
 test/nics.test.js                              |  6 +++++-
 test/packages.test.js                          |  2 +-
 test/plugins/filter-owner-networks.test.js     |  2 +-
 test/plugins/free-tier.test.js                 |  2 +-
 test/plugins/machine-email.test.js             |  2 +-
 test/plugins/plugin-manager.test.js            |  2 +-
 test/plugins/provision-limits.test.js          |  2 +-
 test/populate_network.test.js                  |  4 ++--
 test/runtests                                  |  2 +-
 test/services.test.js                          |  4 ++--
 test/tests.test.js                             |  4 ++--
 test/users.test.js                             |  2 +-
 test/volumes-automount.test.js                 |  4 ++--
 test/volumes-basic.test.js                     |  4 ++--
 test/volumes-create-name.test.js               |  4 ++--
 test/volumes-create-validation.test.js         |  6 +++---
 test/volumes-get.test.js                       |  6 +++---
 test/volumes-invalid-default-network.test.js   |  4 ++--
 test/volumes-list-params-validation.test.js    | 10 ++++++++--
 test/volumes-list-predicate-validation.test.js |  6 +++---
 test/volumes-list-sizes.test.js                |  4 ++--
 test/volumes-mount-network-unreachable.test.js |  2 +-
 test/volumes-no-fabric-network.test.js         |  4 ++--
 test/volumes-size.test.js                      |  4 ++--
 test/volumes-update.test.js                    |  2 +-
 test/volumes.unavailable-size.test.js          |  4 ++--
 46 files changed, 108 insertions(+), 82 deletions(-)

diff --git a/Makefile b/Makefile
index e1823f8..2339e30 100644
--- a/Makefile
+++ b/Makefile
@@ -25,7 +25,7 @@ NAME		:= cloudapi
 #
 # Tools
 #
-TAP		:= ./node_modules/.bin/tape
+TAP		:= ./node_modules/.bin/tap
 
 #
 # Files
diff --git a/package.json b/package.json
index 69b5f20..df1829b 100644
--- a/package.json
+++ b/package.json
@@ -44,7 +44,7 @@
         "xregexp": "3.1.0"
     },
     "devDependencies": {
-        "tape": "3.5.0",
+        "@smaller/tap": "11.1.4-1.0.0",
         "smartdc": "8.1.0"
     },
     "sdcDependencies": {
diff --git a/test/account.test.js b/test/account.test.js
index c23547d..f52fa54 100644
--- a/test/account.test.js
+++ b/test/account.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var common = require('./common');
 
diff --git a/test/affinity-unit.test.js b/test/affinity-unit.test.js
index ccc86e3..5488ea3 100644
--- a/test/affinity-unit.test.js
+++ b/test/affinity-unit.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -15,8 +15,8 @@
 
 var assert = require('assert-plus');
 var bunyan = require('bunyan');
-var deepEqual = require('tape/node_modules/deep-equal');
-var test = require('tape').test;
+var deepEqual = require('@smaller/tap/node_modules/tsame');
+var test = require('@smaller/tap').test;
 var util = require('util');
 var VError = require('verror');
 var XRegExp = require('xregexp');
@@ -306,4 +306,6 @@ test('affinity-unit', function (tt) {
 
         t.end();
     });
+
+    tt.end();
 });
diff --git a/test/analytics.test.js b/test/analytics.test.js
index e108183..cfbb2b7 100644
--- a/test/analytics.test.js
+++ b/test/analytics.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 
 
diff --git a/test/auth.test.js b/test/auth.test.js
index 0fcbec8..8fd7e53 100644
--- a/test/auth.test.js
+++ b/test/auth.test.js
@@ -5,13 +5,13 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var util = require('util');
 var crypto = require('crypto');
 var Keyapi = require('keyapi');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var restify = require('restify');
 var vasync = require('vasync');
 
diff --git a/test/datacenters.test.js b/test/datacenters.test.js
index 3516bf9..4094a5b 100644
--- a/test/datacenters.test.js
+++ b/test/datacenters.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 
 
diff --git a/test/fabrics.test.js b/test/fabrics.test.js
index 361217a..aa553d5 100644
--- a/test/fabrics.test.js
+++ b/test/fabrics.test.js
@@ -5,13 +5,13 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
 var clone = require('clone');
 var fmt = require('util').format;
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 
 var common = require('./common');
@@ -554,6 +554,7 @@ test('VLANs', TEST_OPTS, function (tt) {
         });
     });
 
+    tt.end();
 });
 
 
@@ -864,6 +865,9 @@ test('networks', TEST_OPTS, function (tt) {
             t.end();
         });
     });
+
+
+    tt.end();
 });
 
 
@@ -1134,6 +1138,9 @@ test('default fabric', TEST_OPTS, function (tt) {
             t.end();
         });
     });
+
+
+    tt.end();
 });
 
 
@@ -1196,6 +1203,7 @@ test('teardown', TEST_OPTS, function (tt) {
         });
     });
 
+
     tt.test('client and server teardown', function (t) {
         common.teardown(CLIENTS, SERVER, function (err) {
             t.ifError(err, 'teardown success');
@@ -1203,4 +1211,6 @@ test('teardown', TEST_OPTS, function (tt) {
         });
     });
 
+
+    tt.end();
 });
diff --git a/test/getCreateOptions.test.js b/test/getCreateOptions.test.js
index f72a136..372d7b3 100644
--- a/test/getCreateOptions.test.js
+++ b/test/getCreateOptions.test.js
@@ -10,7 +10,7 @@
 
 var fs = require('fs');
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 
 var getCreateOptions = require('../lib/machines')._getCreateOptions;
 var safeBrandName = require('../lib/machines')._safeBrandName;
diff --git a/test/images.70.test.js b/test/images.70.test.js
index 434ac4e..de401d9 100644
--- a/test/images.70.test.js
+++ b/test/images.70.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var semver = require('semver');
 var common = require('./common');
diff --git a/test/images.80.test.js b/test/images.80.test.js
index 03bf04f..1a506b2 100644
--- a/test/images.80.test.js
+++ b/test/images.80.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var semver = require('semver');
 var common = require('./common');
diff --git a/test/images.test.js b/test/images.test.js
index 12aa442..e16caa4 100644
--- a/test/images.test.js
+++ b/test/images.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var semver = require('semver');
 var common = require('./common');
diff --git a/test/keys.test.js b/test/keys.test.js
index ccf509e..3f7956f 100644
--- a/test/keys.test.js
+++ b/test/keys.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var common = require('./common');
 
diff --git a/test/machines.70.test.js b/test/machines.70.test.js
index 5e9e8f6..f2a9fa6 100644
--- a/test/machines.70.test.js
+++ b/test/machines.70.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var util = require('util');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 var uuid = common.uuid;
 var machinesCommon = require('./machines/common');
diff --git a/test/machines.71.test.js b/test/machines.71.test.js
index 277c914..8f7e632 100644
--- a/test/machines.71.test.js
+++ b/test/machines.71.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var util = require('util');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 var uuid = common.uuid;
 var machinesCommon = require('./machines/common');
diff --git a/test/machines.72.test.js b/test/machines.72.test.js
index 7c6342e..d48302c 100644
--- a/test/machines.72.test.js
+++ b/test/machines.72.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var util = require('util');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var restify = require('restify');
 var httpSignature = require('http-signature');
 var common = require('./common');
@@ -316,7 +316,7 @@ test('sub-user tests', function (t) {
             }, obj, function (err, req, res, body) {
                 t4.ifError(err, 'POST /my/machines error');
                 t4.equal(res.statusCode, 201, 'POST /my/machines status');
-                common.checkHeaders(t, res.headers);
+                common.checkHeaders(t4, res.headers);
                 t4.equal(res.headers.location,
                     util.format('/%s/machines/%s', CLIENT.login, body.id));
                 t4.ok(body, 'POST /my/machines body');
@@ -334,7 +334,7 @@ test('sub-user tests', function (t) {
         t.test('Wait For Running', function (t5) {
             machinesCommon.waitForRunningMachine(cli, SUB_MACHINE_UUID,
                                                 function (err) {
-                t.ifError(err);
+                t5.ifError(err);
 
                 if (err) {
                     // Skip machine tests when machine creation fails
diff --git a/test/machines.73.test.js b/test/machines.73.test.js
index 5819459..c649231 100644
--- a/test/machines.73.test.js
+++ b/test/machines.73.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var util = require('util');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 var uuid = common.uuid;
 var machinesCommon = require('./machines/common');
@@ -169,6 +169,8 @@ test('networks: invalid formats', function (tt) {
         ], 'ipv4_count can only be set to 1');
     });
 
+
+    tt.end();
 });
 
 
diff --git a/test/machines.80.test.js b/test/machines.80.test.js
index d1f8c03..ad8f3bd 100644
--- a/test/machines.80.test.js
+++ b/test/machines.80.test.js
@@ -9,7 +9,7 @@
  */
 
 var util = require('util');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 var uuid = common.uuid;
 var machinesCommon = require('./machines/common');
diff --git a/test/machines.test.js b/test/machines.test.js
index 2d67c89..a42e4c4 100644
--- a/test/machines.test.js
+++ b/test/machines.test.js
@@ -9,7 +9,7 @@
  */
 
 var util = require('util');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var restify = require('restify');
 var vasync = require('vasync');
 
diff --git a/test/networks.test.js b/test/networks.test.js
index bf10779..455c50f 100644
--- a/test/networks.test.js
+++ b/test/networks.test.js
@@ -5,12 +5,12 @@
  */
 
 /*
- * Copyright 2016, Joyent, Inc.
+ * Copyright 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
 var format = require('util').format;
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 
 var common = require('./common');
@@ -644,4 +644,6 @@ test('networks', function (tt) {
         });
     });
 
+    tt.end();
+
 });
diff --git a/test/nics.test.js b/test/nics.test.js
index 98146ff..56c6c55 100644
--- a/test/nics.test.js
+++ b/test/nics.test.js
@@ -13,7 +13,7 @@
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var vasync = require('vasync');
 
@@ -1950,6 +1950,7 @@ test('nics', function (tt) {
         });
     });
 
+
     tt.test('  Add fabric network NIC with invalid ip', FABRIC_TEST_OPTS,
         function (t) {
         CLIENT.get('/my/networks', function onGetNetworks(err, req, res,
@@ -2001,4 +2002,7 @@ test('nics', function (tt) {
             });
         });
     });
+
+
+    tt.end();
 });
diff --git a/test/packages.test.js b/test/packages.test.js
index 7ea4a2a..d498d01 100644
--- a/test/packages.test.js
+++ b/test/packages.test.js
@@ -11,7 +11,7 @@
 var util = require('util');
 
 var semver = require('semver');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 
 var common = require('./common');
diff --git a/test/plugins/filter-owner-networks.test.js b/test/plugins/filter-owner-networks.test.js
index e08b417..d11660e 100644
--- a/test/plugins/filter-owner-networks.test.js
+++ b/test/plugins/filter-owner-networks.test.js
@@ -8,7 +8,7 @@
  * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var clone = require('jsprim').deepCopy;
 var plugin = require('../../plugins/filter_owner_networks');
 
diff --git a/test/plugins/free-tier.test.js b/test/plugins/free-tier.test.js
index 7440583..3903ff9 100644
--- a/test/plugins/free-tier.test.js
+++ b/test/plugins/free-tier.test.js
@@ -8,7 +8,7 @@
  * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var plugin = require('../../plugins/free_tier');
 var restify = require('restify');
 
diff --git a/test/plugins/machine-email.test.js b/test/plugins/machine-email.test.js
index 4c196e9..ba7d593 100644
--- a/test/plugins/machine-email.test.js
+++ b/test/plugins/machine-email.test.js
@@ -8,7 +8,7 @@
  * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var plugin = require('../../plugins/machine_email');
 
 
diff --git a/test/plugins/plugin-manager.test.js b/test/plugins/plugin-manager.test.js
index 742ce90..293a2c9 100644
--- a/test/plugins/plugin-manager.test.js
+++ b/test/plugins/plugin-manager.test.js
@@ -12,7 +12,7 @@ var bunyan = require('bunyan');
 var clients = require('sdc-clients');
 var fs = require('fs');
 var restify = require('restify');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 
 var PluginManager = require('../../lib/plugin-manager');
 
diff --git a/test/plugins/provision-limits.test.js b/test/plugins/provision-limits.test.js
index a833336..bd4641d 100644
--- a/test/plugins/provision-limits.test.js
+++ b/test/plugins/provision-limits.test.js
@@ -8,7 +8,7 @@
  * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var clone = require('jsprim').deepCopy;
 var plugin = require('../../plugins/provision_limits');
 var restify = require('restify');
diff --git a/test/populate_network.test.js b/test/populate_network.test.js
index 039287c..b2df8a7 100644
--- a/test/populate_network.test.js
+++ b/test/populate_network.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -15,7 +15,7 @@
  * here by listing the CA zone.
  */
 
-var test   = require('tape').test;
+var test   = require('@smaller/tap').test;
 var util   = require('util');
 var common = require('./common');
 
diff --git a/test/runtests b/test/runtests
index 5aa2c88..b80b5ef 100755
--- a/test/runtests
+++ b/test/runtests
@@ -72,7 +72,7 @@ start_time=$(date +%s)
 
 NODE_INSTALL=$TOP/build/node
 PATH=$TOP/build/node/bin:$TOP/node_modules/.bin:$PATH
-TAPE=./node_modules/.bin/tape
+TAPE=./node_modules/.bin/tap
 
 # Options.
 opt_test_pattern=
diff --git a/test/services.test.js b/test/services.test.js
index 4b3242f..c1cc74a 100644
--- a/test/services.test.js
+++ b/test/services.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 
 
diff --git a/test/tests.test.js b/test/tests.test.js
index 5e8b4a5..059512b 100644
--- a/test/tests.test.js
+++ b/test/tests.test.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var common = require('./common');
 
 
diff --git a/test/users.test.js b/test/users.test.js
index f7e51c7..9d07988 100644
--- a/test/users.test.js
+++ b/test/users.test.js
@@ -15,7 +15,7 @@
  * test common during test setup.
  */
 
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var libuuid = require('libuuid');
 var util = require('util');
 var common = require('./common');
diff --git a/test/volumes-automount.test.js b/test/volumes-automount.test.js
index a299a5b..e7312d4 100644
--- a/test/volumes-automount.test.js
+++ b/test/volumes-automount.test.js
@@ -5,13 +5,13 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
 var child_process = require('child_process');
 var fs = require('fs');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 var verror = require('verror');
 
diff --git a/test/volumes-basic.test.js b/test/volumes-basic.test.js
index 18a2c9e..472b047 100644
--- a/test/volumes-basic.test.js
+++ b/test/volumes-basic.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var verror = require('verror');
 
diff --git a/test/volumes-create-name.test.js b/test/volumes-create-name.test.js
index 4e6f889..b89c4d9 100644
--- a/test/volumes-create-name.test.js
+++ b/test/volumes-create-name.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 
 var common = require('./common');
diff --git a/test/volumes-create-validation.test.js b/test/volumes-create-validation.test.js
index 54c362b..7489138 100644
--- a/test/volumes-create-validation.test.js
+++ b/test/volumes-create-validation.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var libuuid = require('libuuid');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 
 var common = require('./common');
@@ -174,4 +174,4 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
             t.end();
         });
     });
-}
\ No newline at end of file
+}
diff --git a/test/volumes-get.test.js b/test/volumes-get.test.js
index a527a93..96e62e4 100644
--- a/test/volumes-get.test.js
+++ b/test/volumes-get.test.js
@@ -5,12 +5,12 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
 var libuuid = require('libuuid');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 
 var common = require('./common');
 var mod_config = require('../lib/config.js');
@@ -56,4 +56,4 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
             t.end();
         });
     });
-}
\ No newline at end of file
+}
diff --git a/test/volumes-invalid-default-network.test.js b/test/volumes-invalid-default-network.test.js
index b1a05ee..ca4a246 100644
--- a/test/volumes-invalid-default-network.test.js
+++ b/test/volumes-invalid-default-network.test.js
@@ -10,7 +10,7 @@
 
 var assert = require('assert-plus');
 var libuuid = require('libuuid');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 
 var common = require('./common');
@@ -167,4 +167,4 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
             t.end();
         });
     });
-}
\ No newline at end of file
+}
diff --git a/test/volumes-list-params-validation.test.js b/test/volumes-list-params-validation.test.js
index 07daed5..bf4cfd1 100644
--- a/test/volumes-list-params-validation.test.js
+++ b/test/volumes-list-params-validation.test.js
@@ -5,12 +5,12 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
 var libuuid = require('libuuid');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var querystring = require('querystring');
 var vasync = require('vasync');
 
@@ -104,6 +104,8 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
                     t.end();
                 });
         });
+
+        tt.end();
     });
 
     test('listing nfs shared volumes with invalid query parameters',
@@ -180,6 +182,8 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
                     t.end();
                 });
             });
+
+        tt.end();
     });
 
     // copied from sdc-volapi test/integration/list-with-params.test.js
@@ -529,5 +533,7 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
                 t.end();
             });
         });
+
+        tt.end();
     });
 }
diff --git a/test/volumes-list-predicate-validation.test.js b/test/volumes-list-predicate-validation.test.js
index bbc78a6..1b18e30 100644
--- a/test/volumes-list-predicate-validation.test.js
+++ b/test/volumes-list-predicate-validation.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var libuuid = require('libuuid');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 
 var common = require('./common');
@@ -207,4 +207,4 @@ if (CONFIG.experimental_cloudapi_nfs_shared_volumes !== true) {
             t.end();
         });
     });
-}
\ No newline at end of file
+}
diff --git a/test/volumes-list-sizes.test.js b/test/volumes-list-sizes.test.js
index f07cfe6..f213269 100644
--- a/test/volumes-list-sizes.test.js
+++ b/test/volumes-list-sizes.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 
 var common = require('./common');
 var mod_config = require('../lib/config.js');
diff --git a/test/volumes-mount-network-unreachable.test.js b/test/volumes-mount-network-unreachable.test.js
index e1e5381..e08a522 100644
--- a/test/volumes-mount-network-unreachable.test.js
+++ b/test/volumes-mount-network-unreachable.test.js
@@ -9,7 +9,7 @@
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var util = require('util');
 var vasync = require('vasync');
 
diff --git a/test/volumes-no-fabric-network.test.js b/test/volumes-no-fabric-network.test.js
index 690d075..63c59af 100644
--- a/test/volumes-no-fabric-network.test.js
+++ b/test/volumes-no-fabric-network.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var verror = require('verror');
 
 var common = require('./common');
diff --git a/test/volumes-size.test.js b/test/volumes-size.test.js
index 32c988f..2821e3c 100644
--- a/test/volumes-size.test.js
+++ b/test/volumes-size.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var verror = require('verror');
 
 var common = require('./common');
diff --git a/test/volumes-update.test.js b/test/volumes-update.test.js
index 04c0cde..227697b 100644
--- a/test/volumes-update.test.js
+++ b/test/volumes-update.test.js
@@ -9,7 +9,7 @@
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 var verror = require('verror');
 
diff --git a/test/volumes.unavailable-size.test.js b/test/volumes.unavailable-size.test.js
index fda1f9c..170f3bc 100644
--- a/test/volumes.unavailable-size.test.js
+++ b/test/volumes.unavailable-size.test.js
@@ -5,11 +5,11 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
-var test = require('tape').test;
+var test = require('@smaller/tap').test;
 var vasync = require('vasync');
 var verror = require('verror');
 
-- 
2.21.0

