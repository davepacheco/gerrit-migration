{"project":"joyent/manatee-state-machine","branch":"master","topic":"MANATEE-343","id":"Ib03cc5a80e14525306a87233eef7c6cf73184ed9","number":"5313","subject":"MANATEE-343 manatee full rebuilds should pull from the primary where possible Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/5313","commitMessage":"MANATEE-343 manatee full rebuilds should pull from the primary where possible\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1546627121,"lastUpdated":1547851019,"open":false,"status":"MERGED","comments":[{"timestamp":1546627121,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1546627124,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1546627332,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1546627335,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1546627585,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1546627588,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n(13 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1546627984,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1546627987,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546853187,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1546882755,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 4:\n\n(1 comment)\n\nHey Rich, thanks so much for helping out and chiming in.  Sounds like you understood what I\u0027m trying to do and your suggestions make sense to me."},{"timestamp":1546903307,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5."},{"timestamp":1546903311,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n(7 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1546903452,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 6."},{"timestamp":1546903456,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546953765,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1547674612,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 7."},{"timestamp":1547674615,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1547674645,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1547713407,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7: Code-Review+1\n\nThanks for taking my suggestions into account!"},{"timestamp":1547793994,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Topic set to MANATEE-343"},{"timestamp":1547794463,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7: Integration-Approval+1\n\nThank you for doing the extended testing.  The testing notes look good to me!  It seems we\u0027ll need to make sure the \"joyent/manatee-state-machine\" change (CR 5313) is integrated first, as the \"joyent/manatee\" change depends on it for correct operation."},{"timestamp":1547850867,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1547851019,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"8","revision":"b03cc5a80e14525306a87233eef7c6cf73184ed9","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/8","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1547850867,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547674615,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547713407,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547794463,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1547851019,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"a9d35d78242579af5dcb6aa3e460fa98df6761da","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1546627121,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1546627124,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/manatee-peer.js","line":989,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon for lambda assignment"},{"file":"lib/manatee-peer.js","line":1003,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable role hides argument"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":28,"deletions":-21}],"sizeInsertions":28,"sizeDeletions":-21},{"number":"2","revision":"b4ea02ea2899c35d69b729937925cf2825067fd0","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1546627332,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1546627335,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/manatee-peer.js","line":1003,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable role hides argument"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":28,"deletions":-21}],"sizeInsertions":28,"sizeDeletions":-21},{"number":"3","revision":"808272e90e5016cc3dc5763dc5d6f2558c3e1e35","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1546627585,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1546627588,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/manatee-peer.js","line":998,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":999,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1000,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1001,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1002,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1003,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1004,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1005,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1006,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1007,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1008,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1009,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1010,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":28,"deletions":-21}],"sizeInsertions":28,"sizeDeletions":-21},{"number":"4","revision":"deaedc93238c626de5b6db0478ab590c8414932b","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1546627984,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546627987,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/manatee-peer.js","line":994,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"If I\u0027m understanding this patchset properly, I\u0027d say that we\u0027re adding the \"primary\" peer to the config if the peer is either a sync or an async, and setting it to null if not. We abstract this to pgCfgInit to ensure we\u0027re setting config properties to either their correct value or null.\n\nI\u0027m not sure if this abstraction is worth it for readability\u0027s sake. Passing the values of \"this.mp_zk_state\" (for example) to this new function is not required because they\u0027re present already in pgCfgInit\u0027s scope (as \"this\"), and pgConfig already has the branching in place to determine the current peer\u0027s role to make these decisions. What do you think of just adding these null/primary assignments alongside the old ones (I think that would be L990, L996, and L1002 of the original code)?\n\nThinking about this a little more, is the property name \"primary\" the right thing to do here? I\u0027m wondering if something indicating that it\u0027s the peer we\u0027re restoring from (e.g. \"restoreLocation\" or \"restorePeer\". I\u0027m bad at naming things) is more appropriate, similar as today where that peer is \"upstream\". I\u0027m thinking of a situation where we\u0027d for some reason make a decision to have the restore always come from the sync instead based on new findings, and it would be nice if we didn\u0027t have to make changes to the joyent/manatee repo to accommodate that.\n\nOf course, I could have this all wrong and I don\u0027t understand the change enough. Let me know what you think."},{"file":"lib/manatee-peer.js","line":994,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Yep, it sounds like you understand what I was intending to do and I think you make some cogent points.\n\nI can eliminate that utility function if you think it\u0027s more readable that way.  My concern was the monotony of that sequence and a future developer accidentally forgetting to initialize some needed property down the road.  As a habit, I tend to try and factor whenever possible, but I don\u0027t have particularly strong feelings about this situation since I can\u0027t think of ways at the moment that it would grow much more.\n\nFor your second suggestion, that makes a lot of sense to me.  It makes a lot more sense to expose that object at a semantic level rather than an implementation one.  As you had mentioned, it\u0027s being used for peers to perform rebuilds off of via zfs send/recv.  Between the names restorePeer and rebuildPeer, do you have a preference?"},{"file":"lib/manatee-peer.js","line":994,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think \"restorePeer\" is the most appropriate. In Manatee, a rebuild is generally a user-executed command that destroys the local dataset (among a few other things), and it\u0027s then up to the sitter to perform the restore which is the process of pulling the dataset from another peer. The differences in naming can be seen in lib/adm.js and lib/postgresMgr.js."},{"file":"lib/manatee-peer.js","line":994,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":22,"deletions":-15}],"sizeInsertions":22,"sizeDeletions":-15},{"number":"5","revision":"f30fca537d46b5db887d3919c27603162a3bde0f","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1546903307,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1546903311,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/manatee-peer.js","line":986,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":991,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":992,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":998,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":999,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1000,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"},{"file":"lib/manatee-peer.js","line":1005,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by spaces instead of tabs"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":10,"deletions":-8}],"sizeInsertions":10,"sizeDeletions":-8},{"number":"6","revision":"51016f355c8aec7b811b3c878e784e1bf81a4c02","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/6","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1546903452,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1546903456,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-1},{"number":"7","revision":"1fdf4cc151a6d08babefcf5357dbfe8ed1ddc2eb","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/7","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1547674612,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547794463,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547674615,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547713407,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-1},{"number":"8","revision":"b03cc5a80e14525306a87233eef7c6cf73184ed9","parents":["795baa99af4b29087cae00f152d8e121c4c20e3f"],"ref":"refs/changes/13/5313/8","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1547850867,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547794463,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1547674615,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547713407,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1547851019,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/manatee-peer.js","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":3,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}