From f30fca537d46b5db887d3919c27603162a3bde0f Mon Sep 17 00:00:00 2001
From: Robert Bogart <Robert.bogart@joyent.com>
Date: Fri, 4 Jan 2019 18:24:56 +0000
Subject: [PATCH] MANATEE-343 manatee full rebuilds should pull from the
 primary where possible

---
 lib/manatee-peer.js | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/lib/manatee-peer.js b/lib/manatee-peer.js
index b6d242f..4b6f085 100644
--- a/lib/manatee-peer.js
+++ b/lib/manatee-peer.js
@@ -983,24 +983,26 @@ ManateePeer.prototype.pgConfig = function ()
 {
 	var config = {};
 
-	if (this.mp_role == MP_ROLE_PRIMARY) {
+        if (this.mp_role == MP_ROLE_PRIMARY) {
 		config.role = 'primary';
 		config.upstream = null;
 		config.downstream = this.mp_zkstate.sync;
-	} else if (this.mp_role == MP_ROLE_SYNC ||
-	    this.mp_role == MP_ROLE_ASYNC) {
+		config.rebuildPeer = null;
+        } else if (this.mp_role == MP_ROLE_SYNC ||
+            this.mp_role == MP_ROLE_ASYNC) {
 		config.role = this.mp_role == MP_ROLE_SYNC ?
 		    'sync' : 'async';
 		config.upstream = this.mp_pg_upstream;
 		config.downstream = null;
-	} else {
-		mod_assertplus.ok(this.mp_role == MP_ROLE_UNASSIGNED ||
-		    this.mp_role == MP_ROLE_DEPOSED);
+		config.rebuildPeer = this.mp_zkstate.primary;
+        } else {
+                mod_assertplus.ok(this.mp_role == MP_ROLE_UNASSIGNED ||
+                    this.mp_role == MP_ROLE_DEPOSED);
 		config.role = 'none';
 		config.upstream = null;
 		config.downstream = null;
-	}
-
+		config.rebuildPeer = null;
+        }
 	return (config);
 };
 
-- 
2.21.0

