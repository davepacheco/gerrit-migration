commit 292a6617177f0a0875a89cbf99a5567ef1233dbc (refs/changes/19/4619/3)
Author: Robert Bogart <robert.bogart@joyent.com>
Date:   2018-08-08T23:56:13+00:00 (1 year, 2 months ago)
    
    MANTA-3854 Mako sometimes fails to create manifests due to limitations in 'find'

diff --git a/Makefile b/Makefile
index 400083a..4aec373 100644
--- a/Makefile
+++ b/Makefile
@@ -58,6 +58,7 @@ else
 endif
 include ./tools/mk/Makefile.node_deps.defs
 include ./tools/mk/Makefile.nginx.defs
+include ./tools/mk/Makefile.ctf.defs
 
 #
 # MG Variables
@@ -72,7 +73,6 @@ RELSTAGEDIR          := /tmp/$(STAMP)
 # See marlin.git Makefile.
 #
 NPM_ENV          = MAKE_OVERRIDES="CTFCONVERT=/bin/true CTFMERGE=/bin/true"
-
 #
 # Repo-specific targets
 #
@@ -115,7 +115,7 @@ clean::
 	-(cd deps/nginx && $(MAKE) clean)
 
 .PHONY: release
-release: all deps docs $(SMF_MANIFESTS) check-nginx
+release: all deps docs $(SMF_MANIFESTS) check-nginx makofind
 	@echo "Building $(RELEASE_TARBALL)"
 	@mkdir -p $(RELSTAGEDIR)/root/opt/smartdc/mako
 	@mkdir -p $(RELSTAGEDIR)/root/opt/smartdc/boot
@@ -131,6 +131,7 @@ release: all deps docs $(SMF_MANIFESTS) check-nginx
 	    $(ROOT)/smf \
 	    $(RELSTAGEDIR)/root/opt/smartdc/mako/
 	cp -r $(ROOT)/build/scripts $(RELSTAGEDIR)/root/opt/smartdc/mako/boot
+	cp $(ROOT)/makofind $(RELSTAGEDIR)/root/opt/smartdc/mako
 	ln -s /opt/smartdc/mako/boot/setup.sh \
 	    $(RELSTAGEDIR)/root/opt/smartdc/boot/setup.sh
 	chmod 755 $(RELSTAGEDIR)/root/opt/smartdc/mako/boot/setup.sh
@@ -156,3 +157,4 @@ endif
 include ./tools/mk/Makefile.node_deps.targ
 include ./tools/mk/Makefile.nginx.targ
 include ./tools/mk/Makefile.targ
+include ./tools/mk/Makefile.ctf.targ
diff --git a/bin/upload_mako_ls.sh b/bin/upload_mako_ls.sh
index 658150f..e86036c 100755
--- a/bin/upload_mako_ls.sh
+++ b/bin/upload_mako_ls.sh
@@ -36,6 +36,7 @@ PID_FILE=/tmp/upload_mako_ls.pid
 TMP_DIR=/var/tmp/mako_dir
 LISTING_FILE=$TMP_DIR/$MANTA_STORAGE_ID
 MANTA_DIR=/mako
+MAKO_DIR=/opt/smartdc/mako
 START_TIME=`date -u +"%Y-%m-%dT%H:%M:%SZ"` # Time that this script started.
 
 
@@ -119,9 +120,9 @@ log "starting directory listing upload"
 
 mkdir -p $TMP_DIR
 
-# %p is filename, %s is *logical* size in *bytes*, %T@ is last modified time,
-# %unix time, %k is the *physical* size in *kilobytes*
-find /manta -type f -printf '%p\t%s\t%T@\t%k\n' >$LISTING_FILE
+# %p is filename.  %s is logical size in bytes.  %T@ is epoch time of last
+# data modification.  %k is the physical size in kilobytes.
+$MAKO_DIR/makofind /manta >$LISTING_FILE
 
 log "Going to upload $LISTING_FILE to $MANTA_DIR/$MANTA_STORAGE_ID"
 manta_put_directory $MANTA_DIR
diff --git a/src/makofind.c b/src/makofind.c
new file mode 100644
index 0000000..8768c7b
--- /dev/null
+++ b/src/makofind.c
@@ -0,0 +1,131 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2018, Joyent, Inc.
+ */
+
+/*
+ * This is a tool intended to mimic a lot of the behavior of FIND(1) when
+ * invoked from the command line as follows:
+ *
+ * find /manta -type f -printf '%p\t%s\t%T@\t%k\n'
+ *
+ * It will traverse the entirety of the directory tree, and for object
+ * discovered of type file, it will print the logical size (in bytes), the time
+ * of last data modification (epoch time)  and the physical size in kilobytes.
+ *
+ * This utility uses nftw() (see FTW(3C)) to recursively traverse the
+ * user-provided directory tree.  The creation of this program was born out of
+ * necessity.  Apparently FIND(1) builds out an internal representation of the
+ * directory tree in memory which is obviously problematic in systems where the
+ * number of objects in the tree is sufficiently high.  In a situation where
+ * FIND(1) taps out, our file listing is truncated, giving an incomplete picture
+ * of the tree's contents.  As a mitigation to this problem, makofind was
+ * created.  It was written with FTW(3C) at the foundation which does not make
+ * over-gratuitous use of memory during the process of recurisvely traversing a
+ * directory tree.
+ */
+
+#include <stdlib.h>
+#include <stdio.h>
+#include <string.h>
+#include <err.h>
+#include <errno.h>
+#include <stdarg.h>
+#include <ftw.h>
+#include <unistd.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+
+/* This should be more than enough to traverse the depth of /manta */
+#define	MAX_DESCRIPTORS	10
+
+static void usage(const char *);
+static void nftw_warn(const char *, ...);
+static int ntfw_cb(const char *, const struct stat *, int, struct FTW *);
+
+/* Globals */
+int errors;
+
+int
+main(int argc, char **argv)
+{
+	int i;
+
+	if (argc < 2)
+		usage(argv[0]);
+
+	/*
+	 * Roll through the list of caller-supplied directories and call
+	 * `nftw()' on each.  Record any errors along the way.
+	 */
+	for (i = 1; i < argc; i++) {
+		if (nftw(argv[i], ntfw_cb, MAX_DESCRIPTORS, FTW_PHYS) != 0) {
+			warn("%s: %s: an error occured\n", argv[0], argv[i]);
+			errors++;
+		}
+	}
+
+	return (errors != 0);
+}
+
+static void
+usage(const char *name)
+{
+	fprintf(stderr, "usage: %s dir1 dir2 ... dirN\n", name);
+	exit(1);
+}
+
+static void
+nftw_warn(const char *fmt, ...)
+{
+	va_list args;
+
+	va_start(args, fmt);
+	vfprintf(stderr, fmt, args);
+	va_end(args);
+
+	errors++;
+}
+
+static int
+ntfw_cb(const char *path, const struct stat *st, int objtype, struct FTW *ftw)
+{
+	int ret = 0;
+	unsigned int logical;
+	const char *name = path + ftw->base;
+
+	switch (objtype) {
+	case FTW_F:
+		logical = st->st_blocks / 2;
+		if (st->st_blocks % 2 > 0)
+			logical++;
+		printf("%s\t%lu\t%lu\t%d\n", path, st->st_size, st->st_mtime,
+		    logical);
+		break;
+
+	/* We are not interested in directories or sym links */
+	case FTW_D:
+	case FTW_SL:
+		break;
+
+	case FTW_DNR:
+		nftw_warn("%s: unable to read\n", name);
+		break;
+
+	case FTW_NS:
+		nftw_warn("%s: stat failed: %s\n", name, strerror(errno));
+		break;
+
+	default:
+		nftw_warn("%s: unknown type (%s)", name, objtype);
+		ret = 1;
+		break;
+	}
+
+	return (ret);
+}
diff --git a/tools/mk/Makefile.ctf.defs b/tools/mk/Makefile.ctf.defs
new file mode 100644
index 0000000..213a3df
--- /dev/null
+++ b/tools/mk/Makefile.ctf.defs
@@ -0,0 +1,31 @@
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright (c) 2018, Joyent, Inc.
+#
+
+#
+# Tools
+#
+CTFCONVERT :=	tmp/ctftools/bin/ctfconvert
+
+#
+# We need to build some C software, and to make it debuggable we should
+# include CTF information.  Download the CTF tools:
+#
+STAMP_CTF :=		tmp/ctftools/.stamp
+
+CLEAN_FILES += tmp/ctftools tmp/ctftools.*.tar.gz tmp/makofind.obj makofind
+
+MAKOFIND_OBJS =	makofind.o
+
+MAKOFIND_CFLAGS =	-gdwarf-2 -m32 -std=c99 -D__EXTENSIONS__ \
+			-Wall -Wextra -Werror \
+			-Wno-unused-parameter \
+			-Isrc/
+
+MAKOFIND_OBJDIR =	tmp/makofind.obj
diff --git a/tools/mk/Makefile.ctf.targ b/tools/mk/Makefile.ctf.targ
new file mode 100644
index 0000000..a5fb080
--- /dev/null
+++ b/tools/mk/Makefile.ctf.targ
@@ -0,0 +1,30 @@
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright (c) 2018, Joyent, Inc.
+#
+
+#
+# We need to build some C software, and to make it debuggable we should
+# include CTF information.  Download the program used to download and deploy
+# the Manta CTF tools.
+#
+$(STAMP_CTF):
+	rm -rf tmp/ctftools 
+	rm -f tools/download_ctftools
+	./tools/pre_downloadctf.sh
+	./tools/download_ctftools
+	touch $@
+
+.PHONY: makofind
+makofind: $(MAKOFIND_OBJS:%=$(MAKOFIND_OBJDIR)/%) | $(STAMP_CTF)
+	gcc -o $@ $^ $(MAKOFIND_CFLAGS)
+	$(CTFCONVERT) -l $@ $@
+
+$(MAKOFIND_OBJDIR)/%.o: src/%.c
+	@mkdir -p $(@D)
+	gcc -o $@ -c $(MAKOFIND_CFLAGS) $<
diff --git a/tools/pre_downloadctf.sh b/tools/pre_downloadctf.sh
new file mode 100755
index 0000000..67e2018
--- /dev/null
+++ b/tools/pre_downloadctf.sh
@@ -0,0 +1,26 @@
+#!/bin/bash
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright (c) 2018, Joyent, Inc.
+#
+
+#
+# This script will download the program used to download and deploy the CTF
+# tools from Manta (download_ctftools).  Currently, download_ctftools  resides
+# in the binder repository, but it should probably eventually be moved to the
+# "eng" repo.
+#
+
+CTF_TOOLS='https://raw.githubusercontent.com/joyent/binder/master/tools/download_ctftools'
+
+rm -f tools/download_ctftools
+if ! curl -sSf -o "tools/download_ctftools" $CTF_TOOLS; then
+	printf 'ERROR: could not download download_ctftools' >&2
+	exit 1
+fi
+chmod 755 tools/download_ctftools
