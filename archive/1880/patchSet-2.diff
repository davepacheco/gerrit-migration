From c3c9dafb78f05d40ea82163eb1b70b522505bc1d Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Mon, 1 May 2017 20:35:20 +0000
Subject: [PATCH] TOOLS-1761 node-moray-sandbox should use a lower
 maxConnections setting

---
 Makefile       | 4 +++-
 lib/sandbox.js | 7 ++++++-
 package.json   | 2 +-
 3 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/Makefile b/Makefile
index 5671231..7a49724 100644
--- a/Makefile
+++ b/Makefile
@@ -45,7 +45,9 @@ all: $(TAPE)
 	$(NPM) rebuild
 
 $(ESLINT): | $(NPM_EXEC)
-	$(NPM) install
+	$(NPM) install \
+	    eslint@`json -f package.json devDependencies.eslint` \
+	    eslint-plugin-joyent@`json -f package.json devDependencies.eslint-plugin-joyent`
 
 $(ISTANBUL): | $(NPM_EXEC)
 	$(NPM) install
diff --git a/lib/sandbox.js b/lib/sandbox.js
index d5ad200..7210258 100644
--- a/lib/sandbox.js
+++ b/lib/sandbox.js
@@ -69,7 +69,7 @@ function mkMorayConfig(log, connstr) {
             audit: false,
             standalone: {
                 pg: {
-                    maxConnections: 15,
+                    maxConnections: 5,
                     queryTimeout: 30000
                 },
                 url: connstr
@@ -179,6 +179,11 @@ MoraySandbox.prototype._startMoray = function startMoray(connstr, callback) {
     var self = this;
     var config = mkMorayConfig(self.log, connstr);
     var server = mod_moray_server.createServer(config.server);
+
+    server.on('error', function onError(err) {
+        callback(new VError(err, 'Failed to start Moray server'));
+    });
+
     server.on('ready', function setupDB() {
         server.db_conn.pg(function (cErr, pg) {
             if (cErr) {
diff --git a/package.json b/package.json
index d1e0b69..3510e80 100644
--- a/package.json
+++ b/package.json
@@ -2,7 +2,7 @@
   "name": "moray-sandbox",
   "description": "Library for managing temporary, sandboxed Moray instances",
   "main": "./lib/index.js",
-  "version": "0.1.0",
+  "version": "0.1.1",
   "keywords": [ "moray" ],
   "repository": {
     "type": "git",
-- 
2.21.0

