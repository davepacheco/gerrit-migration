From 51135084e3f930d62c4f7cf309b840ca37ed2c3b Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Mon, 1 May 2017 20:35:20 +0000
Subject: [PATCH] TOOLS-1761 node-moray-sandbox should use a lower
 maxConnections setting

---
 Makefile       |  4 +++-
 README.md      | 12 ++++++++++--
 lib/sandbox.js |  7 ++++++-
 package.json   |  2 +-
 4 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/Makefile b/Makefile
index 5671231..7a49724 100644
--- a/Makefile
+++ b/Makefile
@@ -45,7 +45,9 @@ all: $(TAPE)
 	$(NPM) rebuild
 
 $(ESLINT): | $(NPM_EXEC)
-	$(NPM) install
+	$(NPM) install \
+	    eslint@`json -f package.json devDependencies.eslint` \
+	    eslint-plugin-joyent@`json -f package.json devDependencies.eslint-plugin-joyent`
 
 $(ISTANBUL): | $(NPM_EXEC)
 	$(NPM) install
diff --git a/README.md b/README.md
index 7ca812e..7889f48 100644
--- a/README.md
+++ b/README.md
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright 2016, Joyent, Inc.
+    Copyright 2017, Joyent, Inc.
 -->
 
 # node-moray-sandbox
@@ -19,12 +19,20 @@ contribution guidelines, issues, and general documentation, visit the main
 
 This is a node library for spinning up a temporary Moray server that can be
 used for unit testing programs that depend on Moray. Before running, make
-sure that you have Postgres 9.2 installed. On both Mac OS X and SmartOS:
+sure that you have at least Postgres 9.2 installed. On both Mac OS X and
+SmartOS:
 
 ```
 pkgin in postgresql92-client postgresql92-server
 ```
 
+Each additional Moray connected to a Postgres instance maintains an additional
+set of connections to the database. With enough Moray instances running, you
+can hit Postgres' maximum connection limit, which will prevent spawning new
+instances. This is normally not an issue, but can be easy to hit with Postgres
+9.2 on Mac OS X, where the max is 20. If that happens to you, newer versions of
+Postgres can help alleviate the issue.
+
 ## Examples
 
 You can spawn a new temporary Moray instance by running:
diff --git a/lib/sandbox.js b/lib/sandbox.js
index d5ad200..7210258 100644
--- a/lib/sandbox.js
+++ b/lib/sandbox.js
@@ -69,7 +69,7 @@ function mkMorayConfig(log, connstr) {
             audit: false,
             standalone: {
                 pg: {
-                    maxConnections: 15,
+                    maxConnections: 5,
                     queryTimeout: 30000
                 },
                 url: connstr
@@ -179,6 +179,11 @@ MoraySandbox.prototype._startMoray = function startMoray(connstr, callback) {
     var self = this;
     var config = mkMorayConfig(self.log, connstr);
     var server = mod_moray_server.createServer(config.server);
+
+    server.on('error', function onError(err) {
+        callback(new VError(err, 'Failed to start Moray server'));
+    });
+
     server.on('ready', function setupDB() {
         server.db_conn.pg(function (cErr, pg) {
             if (cErr) {
diff --git a/package.json b/package.json
index d1e0b69..3510e80 100644
--- a/package.json
+++ b/package.json
@@ -2,7 +2,7 @@
   "name": "moray-sandbox",
   "description": "Library for managing temporary, sandboxed Moray instances",
   "main": "./lib/index.js",
-  "version": "0.1.0",
+  "version": "0.1.1",
   "keywords": [ "moray" ],
   "repository": {
     "type": "git",
-- 
2.21.0

