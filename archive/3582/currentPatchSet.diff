From 9031d01af19f900bcf930ec96c2cb891d84c6225 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Sat, 10 Mar 2018 11:31:02 -0800
Subject: [PATCH] TRITON-226 TRITON-137 broke sapi proto mode setup (i.e.
 headnode setup) (correctly set config var values)

---
 boot/setup.sh | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/boot/setup.sh b/boot/setup.sh
index 6222817..6969b9e 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -75,6 +75,7 @@ EOF
     NAPI_URL=http://$(echo "${NAPI_ADMIN_IPS}" | cut -d',' -f1)
     CNAPI_URL=http://$(echo "${CNAPI_ADMIN_IPS}" | cut -d',' -f1)
     VMAPI_URL=http://$(echo "${VMAPI_ADMIN_IPS}" | cut -d',' -f1)
+    SERVER_UUID=$(mdata-get sdc:server_uuid)
 
     # This config file is used during setup to bootstrap SAPI. With the
     # exception that it requires IP addresses instead of DNS names (as binder is
@@ -89,9 +90,9 @@ EOF
     "level": "debug"
   },
   "datacenter_name": "$DATACENTER_NAME",
-  "serviceName": "{{SERVICE_NAME}}",
-  "instanceUuid": "{{auto.ZONENAME}}",
-  "serverUuid": "{{auto.SERVER_UUID}}",
+  "serviceName": "sapi",
+  "instanceUuid": "$ZONE_UUID",
+  "serverUuid": "$SERVER_UUID",
   "adminIp": "$SAPI_ADMIN_IP",
   "moray": {
     "host": "$MORAY_HOST",
-- 
2.21.0

