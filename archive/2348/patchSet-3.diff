From 122d160900703c25b02e8f5f14008762c17c6a11 Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Tue, 8 Aug 2017 16:04:58 -0700
Subject: [PATCH] MANTA-3311 mako_gc carefully checks lock file but barrels on
 if it can't create one

---
 bin/mako_gc.sh | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/bin/mako_gc.sh b/bin/mako_gc.sh
index 3e4dfa6..a9762bc 100755
--- a/bin/mako_gc.sh
+++ b/bin/mako_gc.sh
@@ -196,7 +196,17 @@ if [[ -n "$LAST_PID" ]]; then
     fi
 fi
 
+# Save our noclobber setting
+ALLOWEDCLOBBER=$(shopt -op | grep noclobber | grep +)
+set -o noclobber
 echo -n $PID >$PID_FILE
+if [[ $? -ne 0 ]]; then
+    fatal "Failed to acquire lockfile"
+fi
+# Restore our saved noclobber setting
+if [[ $ALLOWEDCLOBBER ]]; then
+   set +o noclobber
+fi
 
 # Ok, we're good to start gc
 log "starting gc"
-- 
2.21.0

