commit e6572603819ec0b6e72d6187ece44bb1b54fa9fe (refs/changes/48/2348/5)
Author: Tim Kordas <tim.kordas@joyent.com>
Date:   2017-08-21T16:32:56-07:00 (2 years, 2 months ago)
    
    MANTA-3311 mako_gc carefully checks lock file but barrels on if it can't create one
    Reviewed by: David Pacheco <dap@joyent.com>

diff --git a/bin/mako_gc.sh b/bin/mako_gc.sh
index 3e4dfa6..9a56543 100755
--- a/bin/mako_gc.sh
+++ b/bin/mako_gc.sh
@@ -196,7 +196,21 @@ if [[ -n "$LAST_PID" ]]; then
     fi
 fi
 
-echo -n $PID >$PID_FILE
+# Save our noclobber setting
+ALLOWEDCLOBBER=1
+if [[ -o noclobber ]]; then
+    ALLOWEDCLOBBER=0
+fi
+set -o noclobber
+echo foo > foo
+if [[ $? -ne 0 ]]
+then
+    fatal "Failed to acquire lockfile"
+fi
+# Restore our saved noclobber setting
+if [[ $ALLOWEDCLOBBER -ne 0 ]]; then
+    set +o noclobber
+fi
 
 # Ok, we're good to start gc
 log "starting gc"
