From 4c67f33467a03a305ffedb4dfd562c7483602abe Mon Sep 17 00:00:00 2001
From: "Joshua M. Clulow" <jmc@joyent.com>
Date: Fri, 16 Jun 2017 15:12:04 +0000
Subject: [PATCH] MANTA-3295 audit job should not use an unbounded number of
 reducers

---
 bin/audit.js                 |  1 -
 bin/audit_sweep.js           |  2 -
 bin/audit_transform.js       |  2 -
 bin/cruft.js                 |  1 -
 bin/cruft_transform.js       |  2 -
 bin/kick_off_audit.js        | 51 +++++++++++++------
 bin/kick_off_cruft.js        | 56 +++++++++++++++------
 bin/kick_off_gc.js           | 21 ++++----
 bin/kick_off_pg_job.js       |  9 ++--
 bin/kick_off_pg_transform.js |  9 ++--
 bin/kick_off_rebalance.js    |  6 +--
 bin/pg_transform.js          |  1 -
 bin/rebalance.js             |  1 -
 lib/common.js                | 98 +++++++++++++++++++++++++++++++++++-
 package.json                 |  4 +-
 sapi_manifests/mola/template |  6 ++-
 16 files changed, 201 insertions(+), 69 deletions(-)

diff --git a/bin/audit.js b/bin/audit.js
index 657e951..f3420f0 100755
--- a/bin/audit.js
+++ b/bin/audit.js
@@ -13,7 +13,6 @@
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/bin/audit_sweep.js b/bin/audit_sweep.js
index 0b85d94..91dedb8 100755
--- a/bin/audit_sweep.js
+++ b/bin/audit_sweep.js
@@ -11,12 +11,10 @@
  */
 
 var bunyan = require('bunyan');
-var carrier = require('carrier');
 var fs = require('fs');
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/bin/audit_transform.js b/bin/audit_transform.js
index 621e831..c317360 100755
--- a/bin/audit_transform.js
+++ b/bin/audit_transform.js
@@ -10,11 +10,9 @@
  * Copyright (c) 2014, Joyent, Inc.
  */
 
-var carrier = require('carrier');
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/bin/cruft.js b/bin/cruft.js
index 21b457b..a65c073 100755
--- a/bin/cruft.js
+++ b/bin/cruft.js
@@ -13,7 +13,6 @@
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/bin/cruft_transform.js b/bin/cruft_transform.js
index fc32d17..5be5634 100755
--- a/bin/cruft_transform.js
+++ b/bin/cruft_transform.js
@@ -10,11 +10,9 @@
  * Copyright (c) 2014, Joyent, Inc.
  */
 
-var carrier = require('carrier');
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/bin/kick_off_audit.js b/bin/kick_off_audit.js
index c739bb2..34ef750 100755
--- a/bin/kick_off_audit.js
+++ b/bin/kick_off_audit.js
@@ -1,5 +1,4 @@
 #!/usr/bin/env node
-// -*- mode: js -*-
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
@@ -7,16 +6,16 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
+var assert = require('assert-plus');
 var bunyan = require('bunyan');
 var fs = require('fs');
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var manta = require('manta');
 var path = require('path');
-var sprintf = require('sprintf-js').sprintf;
 
 
 
@@ -45,30 +44,35 @@ var MANTA_DUMP_NAME_PREFIX = 'manta-';
 
 ///--- Helpers
 
-/* BEGIN JSSTYLED */
 function getEnvCommon(opts) {
+        assert.string(opts.marlinPathToAsset, 'opts.marlinPathToAsset');
+
+/* BEGIN JSSTYLED */
         return (' \
 set -o pipefail && \
 cd /assets/ && gtar -xzf ' + opts.marlinPathToAsset + ' && cd mola && \
 ');
-}
 /* END JSSTYLED */
+}
 
 
-/* BEGIN JSSTYLED */
 function getTransformCmd(opts) {
+        assert.number(opts.auditReducerCount, 'opts.auditReducerCount');
+
         var grepForStorageNode = '';
         if (opts.mantaStorageId) {
                 grepForStorageNode = ' | grep ' + opts.mantaStorageId + ' | ';
         }
+
+/* BEGIN JSSTYLED */
         return (getEnvCommon(opts) + ' \
 gzcat -f | \
   ./build/node/bin/node ./bin/audit_transform.js -k $MANTA_INPUT_OBJECT \
     ' + grepForStorageNode + ' | \
-  msplit -n ' + opts.numberReducers + ' \
+  msplit -n ' + opts.auditReducerCount + ' \
 ');
-}
 /* END JSSTYLED */
+}
 
 
 /* BEGIN JSSTYLED */
@@ -86,15 +90,20 @@ function parseOptions() {
         // command line, and use the defaults if all else fails.
         var opts = MOLA_AUDIT_CONFIG_OBJ;
         opts.shards = opts.shards || [];
-        var parser = new getopt.BasicParser('a:d:m:np:r:s:t',
+        var parser = new getopt.BasicParser('a:c:d:m:np:r:s:t',
                                             process.argv);
         while ((option = parser.getopt()) !== undefined && !option.error) {
                 switch (option.option) {
                 case 'a':
                         opts.assetFile = option.optarg;
                         break;
+                case 'c':
+                        opts.auditReducerCount = lib.common.parseNumberOption(
+                            option.optarg, '-c', 1, null, usage);
+                        break;
                 case 'd':
-                        opts.auditReduceDisk = parseInt(option.optarg, 10);
+                        opts.auditReduceDisk = lib.common.parseNumberOption(
+                            option.optarg, '-d', 1, null, usage);
                         break;
                 case 'm':
                         opts.shards.push(option.optarg);
@@ -103,10 +112,12 @@ function parseOptions() {
                         opts.noJobStart = true;
                         break;
                 case 'p':
-                        opts.auditMapDisk = parseInt(option.optarg, 10);
+                        opts.auditMapDisk = lib.common.parseNumberOption(
+                            option.optarg, '-p', 1, null, usage);
                         break;
                 case 'r':
-                        opts.auditReduceMemory = parseInt(option.optarg, 10);
+                        opts.auditReduceMemory = lib.common.parseNumberOption(
+                            option.optarg, '-r', 1, null, usage);
                         break;
                 case 's':
                         opts.mantaStorageId = option.optarg;
@@ -156,8 +167,18 @@ function usage(msg) {
 
 
 function getAuditJob(opts, cb) {
-        //Use the same number of reducers as input files.
-        opts.numberReducers = opts.objects.length;
+        /*
+         * There is at least one input file for each Moray shard and each Mako
+         * storage zone.  Scale the number of reducers based on the number of
+         * input files without exceeding the reducer count cap.  If needed,
+         * this value can be overridden by setting the "AUDIT_REDUCER_COUNT"
+         * property in the Manta SAPI application metadata, or by passing the
+         * "-c" option to this program.
+         */
+        if (!opts.hasOwnProperty('auditReducerCount')) {
+                opts.auditReducerCount = lib.common.reducerCurve(
+                    opts.objects.length);
+        }
 
         var pgCmd = getTransformCmd(opts);
         var auditCmd = getAuditCmd(opts);
@@ -169,7 +190,7 @@ function getAuditJob(opts, cb) {
                         disk: opts.auditMapDisk
                 }, {
                         type: 'reduce',
-                        count: opts.numberReducers,
+                        count: opts.auditReducerCount,
                         memory: opts.auditReduceMemory,
                         disk: opts.auditReduceDisk,
                         exec: auditCmd
diff --git a/bin/kick_off_cruft.js b/bin/kick_off_cruft.js
index 2a2e239..a9e0af4 100755
--- a/bin/kick_off_cruft.js
+++ b/bin/kick_off_cruft.js
@@ -1,5 +1,4 @@
 #!/usr/bin/env node
-// -*- mode: js -*-
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
@@ -7,16 +6,16 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
+var assert = require('assert-plus');
 var bunyan = require('bunyan');
 var fs = require('fs');
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var manta = require('manta');
 var path = require('path');
-var sprintf = require('sprintf-js').sprintf;
 
 
 
@@ -47,20 +46,25 @@ var DEFAULT_TOO_NEW_SECONDS = 60 * 60 * 24 * 2; // 2 days
 
 ///--- Helpers
 
-/* BEGIN JSSTYLED */
 function getEnvCommon(opts) {
+        assert.string(opts.jobName, 'opts.jobName');
+        assert.string(opts.marlinPathToAsset, 'opts.marlinPathToAsset');
+
+/* BEGIN JSSTYLED */
         return (' \
 set -o pipefail && \
 export MANTA_CRUFT=' + opts.jobName + ' && \
 export MARLIN_JOB=$(echo $MANTA_OUTPUT_BASE | cut -d "/" -f 4) && \
 cd /assets/ && gtar -xzf ' + opts.marlinPathToAsset + ' && cd mola && \
 ');
-}
 /* END JSSTYLED */
+}
 
 
-/* BEGIN JSSTYLED */
 function getTransformCmd(opts) {
+        assert.number(opts.tooNewSeconds, 'opts.tooNewSeconds');
+        assert.number(opts.cruftReducerCount, 'opts.cruftReducerCount');
+
         var grepForStorageNode = '';
         var filterTimestamp =
                 Math.floor(opts.earliestMorayDump.getTime() / 1000) -
@@ -68,15 +72,17 @@ function getTransformCmd(opts) {
         if (opts.mantaStorageId) {
                 grepForStorageNode = ' | grep ' + opts.mantaStorageId + ' | ';
         }
+
+/* BEGIN JSSTYLED */
         return (getEnvCommon(opts) + ' \
 gzcat -f | \
   ./build/node/bin/node ./bin/cruft_transform.js -k $MANTA_INPUT_OBJECT \
     -f ' + filterTimestamp + ' \
     ' + grepForStorageNode + ' | \
-  msplit -n ' + opts.numberReducers + ' \
+  msplit -n ' + opts.cruftReducerCount + ' \
 ');
-}
 /* END JSSTYLED */
+}
 
 
 /* BEGIN JSSTYLED */
@@ -105,15 +111,20 @@ function parseOptions() {
         // command line, and use the defaults if all else fails.
         var opts = MOLA_CRUFT_CONFIG_OBJ;
         opts.shards = opts.shards || [];
-        var parser = new getopt.BasicParser('a:d:m:np:r:s:tx:',
+        var parser = new getopt.BasicParser('a:c:d:m:np:r:s:tx:',
                                             process.argv);
         while ((option = parser.getopt()) !== undefined && !option.error) {
                 switch (option.option) {
                 case 'a':
                         opts.assetFile = option.optarg;
                         break;
+                case 'c':
+                        opts.cruftReducerCount = lib.common.parseNumberOption(
+                            option.optarg, '-c', 1, null, usage);
+                        break;
                 case 'd':
-                        opts.cruftReduceDisk = parseInt(option.optarg, 10);
+                        opts.cruftReduceDisk = lib.common.parseNumberOption(
+                            option.optarg, '-d', 1, null, usage);
                         break;
                 case 'm':
                         opts.shards.push(option.optarg);
@@ -122,10 +133,12 @@ function parseOptions() {
                         opts.noJobStart = true;
                         break;
                 case 'p':
-                        opts.cruftMapDisk = parseInt(option.optarg, 10);
+                        opts.cruftMapDisk = lib.common.parseNumberOption(
+                            option.optarg, '-p', 1, null, usage);
                         break;
                 case 'r':
-                        opts.cruftReduceMemory = parseInt(option.optarg, 10);
+                        opts.cruftReduceMemory = lib.common.parseNumberOption(
+                            option.optarg, '-r', 1, null, usage);
                         break;
                 case 's':
                         opts.mantaStorageId = option.optarg;
@@ -135,7 +148,8 @@ function parseOptions() {
                         opts.jobRoot = MP + '/manta_cruft_test';
                         break;
                 case 'x':
-                        opts.tooNewSeconds = parseInt(option.optarg, 10);
+                        opts.tooNewSeconds = lib.common.parseNumberOption(
+                            option.optarg, '-x', 1, null, usage);
                         break;
                 default:
                         usage('Unknown option: ' + option.option);
@@ -184,8 +198,18 @@ function usage(msg) {
 
 
 function getCruftJob(opts, cb) {
-        //Use the same number of reducers as input files.
-        opts.numberReducers = opts.objects.length;
+        /*
+         * There is at least one input file for each Moray shard and each Mako
+         * storage zone.  Scale the number of reducers based on the number of
+         * input files without exceeding the reducer count cap.  If needed,
+         * this value can be overridden by setting the "CRUFT_REDUCER_COUNT"
+         * property in the Manta SAPI application metadata, or by passing the
+         * "-c" option to this program.
+         */
+        if (!opts.hasOwnProperty('cruftReducerCount')) {
+                opts.cruftReducerCount = lib.common.reducerCurve(
+                    opts.objects.length);
+        }
 
         var pgCmd = getTransformCmd(opts);
         var cruftCmd = getCruftCmd(opts);
@@ -197,7 +221,7 @@ function getCruftJob(opts, cb) {
                         disk: opts.cruftMapDisk
                 }, {
                         type: 'reduce',
-                        count: opts.numberReducers,
+                        count: opts.cruftReducerCount,
                         memory: opts.cruftReduceMemory,
                         disk: opts.cruftReduceDisk,
                         exec: cruftCmd
diff --git a/bin/kick_off_gc.js b/bin/kick_off_gc.js
index dda7224..4842d64 100755
--- a/bin/kick_off_gc.js
+++ b/bin/kick_off_gc.js
@@ -1,5 +1,4 @@
 #!/usr/bin/env node
-// -*- mode: js -*-
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
@@ -7,7 +6,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var bunyan = require('bunyan');
@@ -32,12 +31,6 @@ var MOLA_CONFIG = (process.env.MOLA_CONFIG ||
 var MOLA_CONFIG_OBJ = JSON.parse(fs.readFileSync(MOLA_CONFIG));
 var MANTA_CLIENT = manta.createClientFromFileSync(MOLA_CONFIG, LOG);
 var MANTA_USER = MANTA_CLIENT.user;
-var AUDIT = {
-        'audit': true,
-        'startedJob': 0,
-        'cronFailed': 1,
-        'startTime': new Date()
-};
 
 
 
@@ -124,10 +117,12 @@ function parseOptions() {
                         opts.assetFile = option.optarg;
                         break;
                 case 'd':
-                        opts.gcReduceDisk = parseInt(option.optarg, 10);
+                        opts.gcReduceDisk = lib.common.parseNumberOption(
+                            option.optarg, '-d', 1, null, usage);
                         break;
                 case 'g':
-                        opts.gracePeriodSeconds = parseInt(option.optarg, 10);
+                        opts.gracePeriodSeconds = lib.common.parseNumberOption(
+                            option.optarg, '-g', 1, null, usage);
                         break;
                 case 'm':
                         opts.shards.push(option.optarg);
@@ -139,10 +134,12 @@ function parseOptions() {
                         opts.objectId = option.optarg;
                         break;
                 case 'p':
-                        opts.gcMapDisk = parseInt(option.optarg, 10);
+                        opts.gcMapDisk = lib.common.parseNumberOption(
+                            option.optarg, '-p', 1, null, usage);
                         break;
                 case 'r':
-                        opts.gcReduceMemory = parseInt(option.optarg, 10);
+                        opts.gcReduceMemory = lib.common.parseNumberOption(
+                            option.optarg, '-r', 1, null, usage);
                         break;
                 case 't':
                         opts.jobName = 'manta_gc_test';
diff --git a/bin/kick_off_pg_job.js b/bin/kick_off_pg_job.js
index 12f94d8..a2093d5 100755
--- a/bin/kick_off_pg_job.js
+++ b/bin/kick_off_pg_job.js
@@ -1,5 +1,4 @@
 #!/usr/bin/env node
-// -*- mode: js -*-
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
@@ -7,7 +6,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var bunyan = require('bunyan');
@@ -93,7 +92,8 @@ function parseOptions() {
                         opts.reduces.push(option.optarg);
                         break;
                 case 'e':
-                        opts.numberReducers = parseInt(option.optarg, 10);
+                        opts.numberReducers = lib.common.parseNumberOption(
+                            option.optarg, '-e', 1, null, usage);
                         break;
                 case 'm':
                         opts.shards.push(option.optarg);
@@ -105,7 +105,8 @@ function parseOptions() {
                         opts.map = option.optarg;
                         break;
                 case 'r':
-                        opts.pgJobReduceMemory = parseInt(option.optarg, 10);
+                        opts.pgJobReduceMemory = lib.common.parseNumberOption(
+                            option.optarg, '-r', 1, null, usage);
                         break;
                 case 's':
                         opts.readFromStdin = true;
diff --git a/bin/kick_off_pg_transform.js b/bin/kick_off_pg_transform.js
index 467eb21..2586d94 100755
--- a/bin/kick_off_pg_transform.js
+++ b/bin/kick_off_pg_transform.js
@@ -1,5 +1,4 @@
 #!/usr/bin/env node
-// -*- mode: js -*-
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
@@ -7,7 +6,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -102,10 +101,12 @@ function parseOptions() {
                         opts.outputDirectory = option.optarg;
                         break;
                 case 'p':
-                        opts.pgMapDisk = parseInt(option.optarg, 10);
+                        opts.pgMapDisk = lib.common.parseNumberOption(
+                            option.optarg, '-p', 1, null, usage);
                         break;
                 case 'y':
-                        opts.pgMapMemory = parseInt(option.optarg, 10);
+                        opts.pgMapMemory = lib.common.parseNumberOption(
+                            option.optarg, '-y', 1, null, usage);
                         break;
                 default:
                         usage('Unknown option: ' + option.option);
diff --git a/bin/kick_off_rebalance.js b/bin/kick_off_rebalance.js
index c9c6910..cf58738 100755
--- a/bin/kick_off_rebalance.js
+++ b/bin/kick_off_rebalance.js
@@ -1,5 +1,4 @@
 #!/usr/bin/env node
-// -*- mode: js -*-
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
@@ -7,7 +6,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -200,7 +199,8 @@ function parseOptions() {
                         opts.noJobStart = true;
                         break;
                 case 'r':
-                        opts.rebalanceMemory = parseInt(option.optarg, 10);
+                        opts.rebalanceMemory = lib.common.parseNumberOption(
+                            option.optarg, '-r', 1, null, usage);
                         break;
                 case 's':
                         opts.storageShard = option.optarg;
diff --git a/bin/pg_transform.js b/bin/pg_transform.js
index aa32dc1..c586736 100755
--- a/bin/pg_transform.js
+++ b/bin/pg_transform.js
@@ -13,7 +13,6 @@
 var getopt = require('posix-getopt');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/bin/rebalance.js b/bin/rebalance.js
index 43a1874..53d5695 100755
--- a/bin/rebalance.js
+++ b/bin/rebalance.js
@@ -43,7 +43,6 @@ var getopt = require('posix-getopt');
 var fs = require('fs');
 var lib = require('../lib');
 var path = require('path');
-var util = require('util');
 
 
 
diff --git a/lib/common.js b/lib/common.js
index e309943..7a68875 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -5,11 +5,13 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var assert = require('assert-plus');
 var fs = require('fs');
+var jsprim = require('jsprim');
+var sprintf = require('sprintf-js').sprintf;
 var vasync = require('vasync');
 
 
@@ -18,6 +20,21 @@ var MAX_HOURS_IN_PAST = 24;
 // If the mako dumps are more than 3 days in the past we should fatal.
 var MAX_MILLIS_MAKO_DUMPS_IN_PAST = 1000 * 60 * 60 * 24 * 3; // 3 days
 
+/*
+ * There is presently no way to discover the maximum number of reducers that
+ * Manta will allow in job single phase.  The value is essentially hard-coded
+ * for now, and the value below was correct at the time this comment was
+ * written.
+ */
+var MAX_REDUCER_COUNT = 128;
+
+/*
+ * To make sure that software which _can_ use multiple reducers does not
+ * accidentally depend on having only a single reducer, the minimum reducer
+ * count should be small but greater than 1.
+ */
+var MIN_REDUCER_COUNT = 2;
+
 
 // --- Functions
 
@@ -444,6 +461,83 @@ function findMorayMakoObjects(opts, cb) {
 }
 
 
+/*
+ * Parse a numeric option value and check whether it is within a particular
+ * range.
+ */
+function parseNumberOption(value, argname, minval, maxval, errorfunc) {
+        assert.string(value, 'value');
+        assert.string(argname, 'argname');
+        assert.optionalNumber(minval, 'minval');
+        assert.optionalNumber(maxval, 'maxval');
+        assert.func(errorfunc, 'errorfunc');
+
+        var parsed = jsprim.parseInteger(value);
+
+        if (typeof (parsed) !== 'number' ||
+            (minval !== null && parsed < minval) ||
+            (maxval !== null && parsed > maxval)) {
+                var msg = sprintf('%s requires an integer argument', argname);
+
+                if (minval !== null && maxval !== null) {
+                        msg += sprintf(' between %d and %d (inclusive)',
+                            minval, maxval);
+                } else if (minval !== null) {
+                        msg += sprintf(' with a minimum value of %d',
+                            minval);
+                } else if (maxval !== null) {
+                        msg += sprintf(' with a maximum value of %d',
+                            maxval);
+                }
+
+                if (parsed instanceof Error) {
+                        msg += sprintf(': %s', parsed.message);
+                }
+
+                errorfunc(msg);
+                return (null);
+        }
+
+        assert.number(parsed, 'parsed');
+        return (parsed);
+}
+
+
+/*
+ * The reducer phases of some of the maintenance jobs can be scaled with the
+ * size of the input.  This function implements a heuristic for determining a
+ * reasonable reducer count based on the number of input objects to the job.
+ */
+function reducerCurve(n) {
+        assert.number(n, 'n');
+
+        var result;
+
+        /*
+         * For small input counts (up to 16 objects), each additional input
+         * will result in an additional reducer.  This mimics the original
+         * heuristic which was appropriate for smaller Manta deployments.  For
+         * larger input counts the curve is shallower; we add an additional
+         * reducer for every 16 extra input objects, up to the reducer cap.
+         */
+        if (n <= 16) {
+                result = n;
+        } else {
+                result = 16 + n / 16;
+        }
+
+        result = Math.floor(result);
+
+        if (result < MIN_REDUCER_COUNT) {
+                result = MIN_REDUCER_COUNT;
+        } else if (result > MAX_REDUCER_COUNT) {
+                result = MAX_REDUCER_COUNT;
+        }
+
+        return (result);
+}
+
+
 module.exports = {
         endsWith: endsWith,
         findLatestMakoObjects: findLatestMakoObjects,
@@ -454,5 +548,7 @@ module.exports = {
         getObject: getObject,
         getObjectsInDir: getObjectsInDir,
         getObjectToFile: getObjectToFile,
+        parseNumberOption: parseNumberOption,
+        reducerCurve: reducerCurve,
         startsWith: startsWith
 };
diff --git a/package.json b/package.json
index b9d7f0e..3b153a9 100644
--- a/package.json
+++ b/package.json
@@ -6,12 +6,12 @@
         "license": "MPL-2.0",
         "private": true,
         "dependencies": {
-                "assert-plus": "0.1.5",
+                "assert-plus": "^1.0.0",
                 "bunyan": "1.2.1",
                 "carrier": "0.1.14",
                 "dashdash": "1.7.0",
                 "forkexec": "^1.1.0",
-                "hist": "1.0.0",
+                "jsprim": "^1.4.0",
                 "lstream": "0.0.4",
                 "once": "1.3.1",
                 "manta-hk": "git+ssh://git@github.com:joyent/manta-hk.git#master",
diff --git a/sapi_manifests/mola/template b/sapi_manifests/mola/template
index bc39555..c12a616 100644
--- a/sapi_manifests/mola/template
+++ b/sapi_manifests/mola/template
@@ -23,10 +23,12 @@
     }{{#AUDIT_MAP_DISK}},
     "auditMapDisk": {{AUDIT_MAP_DISK}}{{/AUDIT_MAP_DISK}}{{#AUDIT_REDUCE_DISK}},
     "auditReduceDisk": {{AUDIT_REDUCE_DISK}}{{/AUDIT_REDUCE_DISK}}{{#AUDIT_REDUCE_MEMORY}},
-    "auditReduceMemory": {{AUDIT_REDUCE_MEMORY}}{{/AUDIT_REDUCE_MEMORY}}{{#CRUFT_MAP_DISK}},
+    "auditReduceMemory": {{AUDIT_REDUCE_MEMORY}}{{/AUDIT_REDUCE_MEMORY}}{{#AUDIT_REDUCER_COUNT}},
+    "auditReducerCount": {{AUDIT_REDUCER_COUNT}}{{/AUDIT_REDUCER_COUNT}}{{#CRUFT_MAP_DISK}},
     "cruftMapDisk": {{CRUFT_MAP_DISK}}{{/CRUFT_MAP_DISK}}{{#CRUFT_REDUCE_DISK}},
     "cruftReduceDisk": {{CRUFT_REDUCE_DISK}}{{/CRUFT_REDUCE_DISK}}{{#CRUFT_REDUCE_MEMORY}},
-    "cruftReduceMemory": {{CRUFT_REDUCE_MEMORY}}{{/CRUFT_REDUCE_MEMORY}}{{#GC_MAP_DISK}},
+    "cruftReduceMemory": {{CRUFT_REDUCE_MEMORY}}{{/CRUFT_REDUCE_MEMORY}}{{#CRUFT_REDUCER_COUNT}},
+    "cruftReducerCount": {{CRUFT_REDUCER_COUNT}}{{/CRUFT_REDUCER_COUNT}}{{#GC_MAP_DISK}},
     "gcMapDisk": {{GC_MAP_DISK}}{{/GC_MAP_DISK}}{{#GC_REDUCE_DISK}},
     "gcReduceDisk": {{GC_REDUCE_DISK}}{{/GC_REDUCE_DISK}}{{#GC_REDUCE_MEMORY}},
     "gcReduceMemory": {{GC_REDUCE_MEMORY}}{{/GC_REDUCE_MEMORY}}{{#PG_JOB_REDUCE_MEMORY}},
-- 
2.21.0

