From 8ada078c32d6a2aa03fc0d00194c51145594bcf5 Mon Sep 17 00:00:00 2001
From: Bryan Cantrill <bryan@joyent.com>
Date: Tue, 5 Feb 2019 21:38:40 +0000
Subject: [PATCH] OS-7535 allow platform builds on base-64 image Reviewed by:
 Robert Mustacchi <rm@joyent.com> Approved by: Joshua M. Clulow
 <jmc@joyent.com>

---
 configure | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/configure b/configure
index 14e15d8c..ddb60449 100755
--- a/configure
+++ b/configure
@@ -107,11 +107,26 @@ function install_pkgin
 			curl -k "$conf_pkgsrcurl/$pkg.tgz" -o \
 			    /var/tmp/$pkg.tgz || fatal \
 			    "failed to fetch $pkg.tgz"
-			$conf_priv pkg_add -C /dev/null /var/tmp/$pkg.tgz || fatal \
+
+			#
+			# We set the machine to be i386 to force pkg_add
+			# to install the package even if we are on x86_64.
+			#
+			$conf_priv pkg_add -m i386 -C /dev/null \
+			    /var/tmp/$pkg.tgz || fatal \
 			    "failed to pkg_add $pkg"
 			rm -f /var/tmp/$pkg.tgz
 		fi
 	done
+
+	#
+	# There is a bug in pkgsrc (PKGSRC-1338) in that installing a package
+	# as i386 on x86_64 results in some temporary confusion in the
+	# database.  To workaround this, we perform a meaningless pkgin
+	# operation to get the database back into a correct state with respect
+	# to our true machine architecture.
+	#
+	pkgin -y list > /dev/null
 }
 
 function install_ips
-- 
2.21.0

