{"project":"joyent/sdc-imgapi","branch":"master","id":"Id1685c5803043b93adc118e8c1bd8a87d6afaeb3","number":"4921","subject":"TRITON-566 need windows-prepare-image script Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/4921","commitMessage":"TRITON-566 need windows-prepare-image script\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1538561855,"lastUpdated":1540375530,"open":false,"status":"MERGED","comments":[{"timestamp":1538561855,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1538561906,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538561969,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1538562018,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1538562530,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2: Integration-Approval-1\n\nNot yet ready for CR."},{"timestamp":1538649221,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2: -Integration-Approval"},{"timestamp":1538676297,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)\n\nI\u0027m far from an expert in this area, but overall this seems sane."},{"timestamp":1538676756,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1538676989,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1538677743,"reviewer":{"name":"Max Bruning","email":"max@joyent.com","username":"max123"},"message":"Patch Set 2:\n\n(1 comment)\n\nCan you say something about what calls this, or show an example?"},{"timestamp":1538698679,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1538721449,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1538721708,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1538788803,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3."},{"timestamp":1538788864,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538789162,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 4."},{"timestamp":1538789207,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538789286,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1539018215,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1539023061,"reviewer":{"name":"Max Bruning","email":"max@joyent.com","username":"max123"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1539165246,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1539165297,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1539165313,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 5:\n\nThis has been tested, although it\u0027s a troublesome beast with COAL.\n\nAnyone bold enough to IA it so it\u0027ll be in the next release? :)"},{"timestamp":1539198735,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nMarsell added test notes to TRITON-566. I think it would be good to have someone else on the commercial team run through it once to validate. That said, this is new experimental functionality, so I\u0027m fine adding it this.\n\nSeparate concern: Should we look into tweaking IMGAPI\u0027s CreateImageFromVm to error out early and more explicitly for older Windows images and on KVM?  I wouldn\u0027t see a point in attempting to support windows image creation for pre-existing Windows images.\n\nHere in IMGAPI is where there is a guard that the target CN is of sufficient platform: https://github.com/joyent/sdc-imgapi/blob/master/lib/images.js#L1917\nit would be good to do that for bhyve creation if necessary, i.e. if there is a more recent platform version with bhyve windows image creation support changes\n\nround about here is where one could get IMGAPI CreateImageFromVm to disallow KVM + windows image creation: https://github.com/joyent/sdc-imgapi/blob/master/lib/images.js#L1971"},{"timestamp":1539764098,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 6."},{"timestamp":1539764141,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539793569,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1540331307,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1540375526,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1540375530,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"7","revision":"dba785572f00ae8928bf9f80feb8e6ba3fc44c10","parents":["191097b109596e8d43580cc89bb6a40360b91d9e"],"ref":"refs/changes/21/4921/7","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1540375526,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539764141,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539793569,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540331307,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540331307,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1540375530,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":16,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":153,"deletions":0}],"sizeInsertions":169,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"a2f1ba8ddd6b9b74388bc96963a74cf3bd12dd3e","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/21/4921/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1538561855,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538561906,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":152,"deletions":0}],"sizeInsertions":152,"sizeDeletions":0},{"number":"2","revision":"ac92c54251a7b5ff821275a5bbbec4756eb848f4","parents":["15182e0dd1abff91a41b4987d8e79c18015fbc78"],"ref":"refs/changes/21/4921/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1538561969,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538561906,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"tools/prepare-image/windows-prepare-image","line":9,"reviewer":{"name":"Max Bruning","email":"max@joyent.com","username":"max123"},"message":"Can you say something about what calls this, or show an example?"},{"file":"tools/prepare-image/windows-prepare-image","line":9,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Let me know if the new comment addition is sufficient."},{"file":"tools/prepare-image/windows-prepare-image","line":9,"reviewer":{"name":"Max Bruning","email":"max@joyent.com","username":"max123"},"message":"Done"},{"file":"tools/prepare-image/windows-prepare-image","line":38,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"function mput($key, $val) {\n\nand similar for other functions"},{"file":"tools/prepare-image/windows-prepare-image","line":38,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"For some reason I thought that Poweshell was insane like Perl. Maybe I looked at some old docs originally?\n\nWill change."},{"file":"tools/prepare-image/windows-prepare-image","line":38,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I only tested on 2016 - maybe things are different in older versions."},{"file":"tools/prepare-image/windows-prepare-image","line":38,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"So it turns out it works just find in 2012r2 (Powershell 4.0) too, so hooray!\n\nUpdated."},{"file":"tools/prepare-image/windows-prepare-image","line":63,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I believe \"imgadm create ...\" is looking for \"prepare-image:state\" rather than just \"state\", right? See https://github.com/joyent/smartos-live/blob/master/src/img/man/imgadm.1m.md#prepare-image-script\n\nHas this all been testing with a Windows custom image creation?"},{"file":"tools/prepare-image/windows-prepare-image","line":63,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"The mput() function prepends \"prepare-image:\"\n\nIt has been tested -- see the ticket."},{"file":"tools/prepare-image/windows-prepare-image","line":63,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Looking closer at the ticket, it\u0027s not clear that recent versions of this code have been tested with image creation. Okay, let\u0027s be clear: it has actually been tested to produce images that were then successfully used for provisioning. :)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":152,"deletions":0}],"sizeInsertions":152,"sizeDeletions":0},{"number":"3","revision":"6e8780d6c206f11ae436eaf4514accddd7df1820","parents":["15182e0dd1abff91a41b4987d8e79c18015fbc78"],"ref":"refs/changes/21/4921/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1538788803,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538788864,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":146,"deletions":0}],"sizeInsertions":146,"sizeDeletions":0},{"number":"4","revision":"60bd8933cecbe1602fac9006828e625e7be58607","parents":["15182e0dd1abff91a41b4987d8e79c18015fbc78"],"ref":"refs/changes/21/4921/4","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1538789162,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538789207,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539018215,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":153,"deletions":0}],"sizeInsertions":153,"sizeDeletions":0},{"number":"5","revision":"80f6763fb95ac005dee54212269228db2a737b0a","parents":["191097b109596e8d43580cc89bb6a40360b91d9e"],"ref":"refs/changes/21/4921/5","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1539165246,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538789207,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539018215,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":153,"deletions":0}],"sizeInsertions":153,"sizeDeletions":0},{"number":"6","revision":"d1685c5803043b93adc118e8c1bd8a87d6afaeb3","parents":["191097b109596e8d43580cc89bb6a40360b91d9e"],"ref":"refs/changes/21/4921/6","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1539764098,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539764141,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540331307,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540331307,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539793569,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":16,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":153,"deletions":0}],"sizeInsertions":169,"sizeDeletions":0},{"number":"7","revision":"dba785572f00ae8928bf9f80feb8e6ba3fc44c10","parents":["191097b109596e8d43580cc89bb6a40360b91d9e"],"ref":"refs/changes/21/4921/7","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1540375526,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539764141,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540331307,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540331307,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1540375530,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539793569,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/images.js","type":"MODIFIED","insertions":16,"deletions":0},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":153,"deletions":0}],"sizeInsertions":169,"sizeDeletions":0}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Max Bruning","email":"max@joyent.com","username":"max123"}]}