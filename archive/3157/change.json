{"project":"joyent/sdc-docker","branch":"master","id":"I89a2f028f6162c1cc2ccc6308c60018bc46f746a","number":"3157","subject":"DOCKER-1136 DOCKER-1135 needs more work Reviewed by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e Approved by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/3157","commitMessage":"DOCKER-1136 DOCKER-1135 needs more work\nReviewed by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e\nApproved by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e\n","createdOn":1515097043,"lastUpdated":1515436166,"open":false,"status":"MERGED","comments":[{"timestamp":1515097043,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1515097079,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515099213,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1515105389,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1515105435,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1515105469,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515105496,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\nTesting notes for the second patchset: disabled support for image volumes by commenting out the corresponding code that handles it in sdc-docker, and made sure that the test failed. Then re-enabled that code and made sure that the test passed."},{"timestamp":1515109902,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1515110129,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1515110283,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1515173746,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(2 comments)"},{"timestamp":1515203365,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1515203642,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 4."},{"timestamp":1515203676,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515203825,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\nLatest change only deletes the \"bar\" file from the test/images/test-oimage-with-volume directory, since it\u0027s not ADDed anymore in the Dockerfile."},{"timestamp":1515429758,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1515436125,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1515436166,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"5","revision":"064b88a7576382698d45d45f8de4e060a731943e","parents":["46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2"],"ref":"refs/changes/57/3157/5","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1515436125,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515203676,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515429758,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515429758,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"SUBM","value":"1","grantedOn":1515436166,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/images/test-image-with-volume/Dockerfile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"test/images/test-image-with-volume/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/images/test-image-with-volume/bar","type":"DELETED","insertions":0,"deletions":-1},{"file":"test/integration/api-create-with-volume-from-image.test.js","type":"MODIFIED","insertions":14,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"5b6066139464c76ae7f10f3f196de8dc7bfebe38","parents":["46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2"],"ref":"refs/changes/57/3157/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1515097043,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515097079,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/backends/sdc/containers.js","line":2120,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I\u0027m not sure an assert is good here. Image metadata is user defined data - so anyone could craft an image with a different imgConfig.Volumes type and use that to crash the docker service. That\u0027s why I suggested an Array.isArray check, or alternatively you could perform validation and reject any request/image that didn\u0027t specify the correct Volumes array."},{"file":"lib/backends/sdc/containers.js","line":2120,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\"payload.volumes\" is set at https://github.com/joyent/sdc-docker/blob/46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2/lib/backends/sdc/containers.js#L1441, and enforces that it\u0027s an array of objects. If it\u0027s not an array of object, it\u0027s a bug in sdc-docker."},{"file":"lib/backends/sdc/containers.js","line":2120,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"You right, sorry I had meant that comment for line 2108:\n  if (imgConfig.Volumes) {\nwhich does not seem to have any validation that imgConfig.Volumes is an array."},{"file":"lib/backends/sdc/containers.js","line":2120,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In this case, I would perform that validation in lib/validate.js in the validateCreateContainer function. However I think that is outside of the scope of this PR, and I\u0027d rather tackle that in a separate ticket if you don\u0027t mind."},{"file":"lib/backends/sdc/containers.js","line":2120,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Right - please ignore my comments as they don\u0027t apply.\n\nI had thought that the imgConfig.Volumes was used in the same way as container.Volumes (used to connect to a volume at run time), but after reading the Dockerfile Volume docs it\u0027s clearly not - sorry about that.\n\nInstead it seems that all files found in the imgConfig.Volumes location (inside the image tarball) will be copied into the volume that gets mounted to that point - wow - that\u0027s ugly stuff (thanks docker!)."},{"file":"test/images/test-image-with-volume/Dockerfile","line":2,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"An observation - this ADD ensures the /foo/bar file always exists, and the below CMD will always succeed even if volumes are not working or enabled - I\u0027m not sure if that\u0027s what you were going for?"},{"file":"test/images/test-image-with-volume/Dockerfile","line":2,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good point! I had somehow ignored this line, I\u0027ll remove it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/images/test-image-with-volume/Dockerfile","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"test/images/test-image-with-volume/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/api-create-with-volume-from-image.test.js","type":"MODIFIED","insertions":14,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-11},{"number":"2","revision":"e0035a98a67cf1929dcb34a4215713f126df2ffe","parents":["46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2"],"ref":"refs/changes/57/3157/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1515105435,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515105469,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173746,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515173746,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"comments":[{"file":"test/integration/api-create-with-volume-from-image.test.js","line":77,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"I think this now needs to be wrapped in an \u0027if (volumesEnabled) {\u0027 check - as this test should fail if volumes are not enabled (as the /foo directory will not exist)."},{"file":"test/integration/api-create-with-volume-from-image.test.js","line":77,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Image volumes are always enabled, unless I\u0027m missing something. They\u0027re different from shared volumes, which are disabled by default and controlled by a feature flag."},{"file":"test/integration/api-create-with-volume-from-image.test.js","line":77,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Right - please ignore my comment as it doesn\u0027t apply - I didn\u0027t understand how image volumes worked."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/images/test-image-with-volume/Dockerfile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"test/images/test-image-with-volume/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/api-create-with-volume-from-image.test.js","type":"MODIFIED","insertions":14,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-12},{"number":"3","revision":"fff33af5fe453e2da588206c1f9c31fbc56a285c","parents":["46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2"],"ref":"refs/changes/57/3157/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1515203365,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515105469,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173746,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515173746,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/images/test-image-with-volume/Dockerfile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"test/images/test-image-with-volume/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/api-create-with-volume-from-image.test.js","type":"MODIFIED","insertions":14,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-12},{"number":"4","revision":"89a2f028f6162c1cc2ccc6308c60018bc46f746a","parents":["46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2"],"ref":"refs/changes/57/3157/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1515203642,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515203676,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515429758,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515429758,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/images/test-image-with-volume/Dockerfile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"test/images/test-image-with-volume/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/images/test-image-with-volume/bar","type":"DELETED","insertions":0,"deletions":-1},{"file":"test/integration/api-create-with-volume-from-image.test.js","type":"MODIFIED","insertions":14,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-13},{"number":"5","revision":"064b88a7576382698d45d45f8de4e060a731943e","parents":["46458cb1db3746bfbf0d9e1872d8fd68be5ee6d2"],"ref":"refs/changes/57/3157/5","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1515436125,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515203676,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1515436166,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515429758,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515429758,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/backends/sdc/containers.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/images/test-image-with-volume/Dockerfile","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"test/images/test-image-with-volume/Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/images/test-image-with-volume/bar","type":"DELETED","insertions":0,"deletions":-1},{"file":"test/integration/api-create-with-volume-from-image.test.js","type":"MODIFIED","insertions":14,"deletions":-9}],"sizeInsertions":23,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}