commit c865cb16e8455914a93fdece81ba00c67d5d653a
Author: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date:   2019-08-20T13:43:18-06:00 (7 weeks ago)
    
    MANTA-4289 Update electric-moray to use node-fast 2.7.0

diff --git a/lib/moray_client.js b/lib/moray_client.js
index ba32fe3..af56143 100644
--- a/lib/moray_client.js
+++ b/lib/moray_client.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -58,6 +58,7 @@ function createClient(options, callback) {
             morayargs.log = options.log.child({
                 component: 'moray-client-' + pnodeUrl.hostname
             });
+            morayargs.crc_mode = options.crc_mode;
 
             var client = moray.createClient(morayargs);
             clientMap[pnode] = client;
diff --git a/lib/server.js b/lib/server.js
index fdaa7fe..b3c49d7 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -117,6 +117,11 @@ function createServer(options, callback) {
     assert.object(options, 'options');
     assert.func(callback, 'callback');
     assert.string(options.ringLocation, 'options.ringLocation');
+    assert.optionalObject(options.fast, 'options.fast');
+    assert.optionalNumber(options.fast.client_crc_mode,
+        'options.fast.client_crc_mode');
+    assert.optionalNumber(options.fast.server_crc_mode,
+        'options.fast.server_crc_mode');
 
     var log = options.log;
     var opts = {
@@ -142,11 +147,17 @@ function createServer(options, callback) {
 
         opts.ring = _ring;
 
+        var client_crc_mode = options.fast.client_crc_mode ||
+            fast.FAST_CHECKSUM_V1;
+        var server_crc_mode = options.fast.server_crc_mode ||
+            fast.FAST_CHECKSUM_V1;
+
         log.info('creating moray clients');
         moray_client.createClient({
             ring: opts.ring,
             morayOptions: options.morayOptions,
-            log: options.log
+            log: options.log,
+            crc_mode: client_crc_mode
         }, function (cErr, clients) {
             if (cErr) {
                 throw new verror.VError(cErr, 'unable to create moray clients');
@@ -166,11 +177,22 @@ function createServer(options, callback) {
                 labels: labels
             });
 
+            collector.gauge({
+                name: 'client_crc_mode',
+                help: 'The node-fast CRC compatibilty mode of the Fast client'
+            }).set(client_crc_mode);
+
+            collector.gauge({
+                name: 'server_crc_mode',
+                help: 'The node-fast CRC compatibilty mode of the Fast server'
+            }).set(server_crc_mode);
+
             var socket = net.createServer({ 'allowHalfOpen': true });
             var server = new fast.FastServer({
                 collector: collector,
                 log: log.child({ component: 'fast' }),
-                server: socket
+                server: socket,
+                crc_mode: server_crc_mode
             });
 
             var methods = [
diff --git a/package.json b/package.json
index 9a79873..710ee51 100644
--- a/package.json
+++ b/package.json
@@ -16,12 +16,12 @@
         "clone": "0.1.9",
         "dtrace-provider": "0.2.8",
         "fash": "2.5.0",
-        "fast": "2.3.2",
+        "fast": "2.8.1",
         "jsprim": "2.0.0",
         "kang": "1.2.0",
         "ldapjs": "0.6.3",
         "imgapi-cli": "git+https://github.com/joyent/sdc-imgapi-cli.git#v2.4.1",
-        "moray": "^3.4.0",
+        "moray": "git+https://github.com/joyent/node-moray.git#MANTA-4287",
         "node-uuid": "1.4.0",
         "posix-getopt": "^1.0.0",
         "restify": "6.3.1",
diff --git a/sapi_manifests/electric-moray/template b/sapi_manifests/electric-moray/template
index b8cac1d..9e36b5c 100644
--- a/sapi_manifests/electric-moray/template
+++ b/sapi_manifests/electric-moray/template
@@ -6,6 +6,20 @@
             "type": "udp"
         }
     },
+    "fast": {
+      {{#MORAY_FAST_CLIENT_CRC_MODE}}
+      "client_crc_mode": {{MORAY_FAST_CLIENT_CRC_MODE}},
+      {{/MORAY_FAST_CRC_CLIENT_MODE}}
+      {{^MORAY_FAST_CLIENT_CRC_MODE}}
+      "client_crc_mode": 1,
+      {{/MORAY_FAST_CLIENT_CRC_MODE}}
+      {{#MORAY_FAST_SERVER_CRC_MODE}}
+      "server_crc_mode": {{MORAY_FAST_SERVER_CRC_MODE}},
+      {{/MORAY_FAST_CRC_SERVER_MODE}}
+      {{^MORAY_FAST_SERVER_CRC_MODE}}
+      "server_crc_mode": 2
+      {{/MORAY_FAST_SERVER_CRC_MODE}}
+    },
     "numWorkers": 0,
     "audit": false,
     "cache": {
