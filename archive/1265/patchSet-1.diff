From 364b531b9633fa137f3460abf1815b9fb0109cd2 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 17 Jan 2017 11:51:46 -0800
Subject: [PATCH] joyent/node-cueball#73 ConnectionFSM should stop doubling
 "timeout" and "delay" after max retries

---
 lib/connection-fsm.js | 27 +++++++++++++++++----------
 package.json          |  2 +-
 2 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/lib/connection-fsm.js b/lib/connection-fsm.js
index 9072902..e3a8b48 100644
--- a/lib/connection-fsm.js
+++ b/lib/connection-fsm.js
@@ -332,10 +332,12 @@ ConnectionFSM.prototype.state_error = function (S) {
 		return;
 	}
 
-	if (this.cf_retries !== Infinity)
-		--this.cf_retriesLeft;
-
-	if (this.cf_retries === Infinity || this.cf_retriesLeft > 0) {
+	/*
+	 * Unfortunately, "retries" actually means "attempts" in the cueball
+	 * API. To preserve compatibility we have to compare to 1 here instead
+	 * of 0.
+	 */
+	if (this.cf_retries === Infinity || this.cf_retriesLeft > 1) {
 		log.trace(this.cf_lastError, 'failed to connect to ' +
 		    'backend, %d retries left: delaying before retry',
 		    this.cf_retriesLeft);
@@ -343,6 +345,7 @@ ConnectionFSM.prototype.state_error = function (S) {
 	} else {
 		log.warn(this.cf_lastError, 'failed to connect to backend, ' +
 		    'retries exhausted');
+		this.cf_retriesLeft = 0;
 		this.cf_pool._incrCounter('retries-exhausted');
 		S.gotoState('closed');
 	}
@@ -352,12 +355,16 @@ ConnectionFSM.prototype.state_delay = function (S) {
 	S.validTransitions(['connect', 'closed']);
 	var delay = this.cf_delay;
 
-	this.cf_delay *= 2;
-	this.cf_timeout *= 2;
-	if (this.cf_timeout > this.cf_maxTimeout)
-		this.cf_timeout = this.cf_maxTimeout;
-	if (this.cf_delay > this.cf_maxDelay)
-		this.cf_delay = this.cf_maxDelay;
+	if (this.cf_retries !== Infinity) {
+		--this.cf_retriesLeft;
+
+		this.cf_delay *= 2;
+		this.cf_timeout *= 2;
+		if (this.cf_timeout > this.cf_maxTimeout)
+			this.cf_timeout = this.cf_maxTimeout;
+		if (this.cf_delay > this.cf_maxDelay)
+			this.cf_delay = this.cf_maxDelay;
+	}
 
 	var t = S.timeout(delay, function () {
 		S.gotoState('connect');
diff --git a/package.json b/package.json
index 151ef20..66801a0 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "1.3.1",
+  "version": "1.3.2",
   "description": "",
   "main": "lib/index.js",
   "dependencies": {
-- 
2.21.0

