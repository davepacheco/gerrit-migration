{"project":"joyent/illumos-joyent","branch":"master","id":"I3e8f2de8060a6dc6b5940f6a15c3b444fd288b58","number":"2786","subject":"OS-3709 vm_getusage when there is a process with a large (10s of GB) amount of mapped space will cause latency issues Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.co","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2786","commitMessage":"OS-3709 vm_getusage when there is a process with a large (10s of GB) amount of mapped space will cause latency issues\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1508162026,"lastUpdated":1508255536,"open":false,"status":"MERGED","comments":[{"timestamp":1508162026,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1508178251,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1508182064,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1508184261,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1\n\n(3 comments)\n\nModulo the additional comments, ship it."},{"timestamp":1508244460,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1508244474,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1508250511,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1508250804,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1508251053,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI tested this via prstat (which is the primary consumer). Watching the SDT probe I added, I can see that -Z never does the per-process calculations. We do the full calculations when prstat requests projects/task/user RSS data."},{"timestamp":1508251210,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1508255404,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1508255492,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1508255536,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"3e8f2de8060a6dc6b5940f6a15c3b444fd288b58","parents":["e12051ebbcf41716ad84629dd04d5c04b40dd22f"],"ref":"refs/changes/86/2786/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508255492,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250511,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250804,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508251210,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1508255536,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/prstat/prstat.c","type":"MODIFIED","insertions":3,"deletions":-8},{"file":"usr/src/cmd/prstat/prstat.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/prstat/prutil.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/man/man1m/prstat.1m","type":"MODIFIED","insertions":6,"deletions":-18},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":66,"deletions":-5}],"sizeInsertions":83,"sizeDeletions":-36},"patchSets":[{"number":"1","revision":"ef68cbb0fb28d3baade3c8c784097ebdf7672c07","parents":["4f660fcf1984e21a5adb8ab350ef579b91a14eea"],"ref":"refs/changes/86/2786/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508162026,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508184261,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/vm/vm_usage.c","line":1743,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"It\u0027s not clear why you have to clear the flags here, instead of maybe just rewriting vmu_calculate_proc() (only called from here, it seems) to not bother checking them.  It feels... patchy, but the whole file here is complicated enough where I\u0027m not sure I can/should be this nitpicky about it."},{"file":"usr/src/uts/common/vm/vm_usage.c","line":1743,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I agree that this code is complicated. I wanted to minimize the changes in the file and preserve the correct behavior for other consumers. The reason I did it this way is that these global flags are checked during the per-process calculations. Since we already have the correct zone data, I don\u0027t want those numbers changed. I restore the flags at the end of the function since they are subsequently used to determine what data to copy out of the cache."},{"file":"usr/src/uts/common/vm/vm_usage.c","line":1743,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Okay, in that case, consider my recommendations below."},{"file":"usr/src/uts/common/vm/vm_usage.c","line":1758,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Additional text suggestion:\n\n*\n* Since we already obtained the zones RSSes above, this loop\n* executes with the VMUSAGE_ZONE_FLAGS cleared."},{"file":"usr/src/uts/common/vm/vm_usage.c","line":1758,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/vm/vm_usage.c","line":1803,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"/*\n * Restore any caller-supplied zone flags we blocked during\n * the process-table walk.\n */"},{"file":"usr/src/uts/common/vm/vm_usage.c","line":1803,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/prstat/prstat.c","type":"MODIFIED","insertions":3,"deletions":-8},{"file":"usr/src/cmd/prstat/prstat.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/prstat/prutil.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/man/man1m/prstat.1m","type":"MODIFIED","insertions":6,"deletions":-18},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":59,"deletions":-5}],"sizeInsertions":76,"sizeDeletions":-36},{"number":"2","revision":"438ba514e32f022c5041aca1b262275f42492855","parents":["4f660fcf1984e21a5adb8ab350ef579b91a14eea"],"ref":"refs/changes/86/2786/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508244474,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250511,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250804,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508251210,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/prstat/prstat.c","type":"MODIFIED","insertions":3,"deletions":-8},{"file":"usr/src/cmd/prstat/prstat.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/prstat/prutil.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/man/man1m/prstat.1m","type":"MODIFIED","insertions":6,"deletions":-18},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":66,"deletions":-5}],"sizeInsertions":83,"sizeDeletions":-36},{"number":"3","revision":"4b0631de4bc9f689cb462b790f5f50f06f53dd11","parents":["e12051ebbcf41716ad84629dd04d5c04b40dd22f"],"ref":"refs/changes/86/2786/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508255404,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250511,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250804,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508251210,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/prstat/prstat.c","type":"MODIFIED","insertions":3,"deletions":-8},{"file":"usr/src/cmd/prstat/prstat.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/prstat/prutil.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/man/man1m/prstat.1m","type":"MODIFIED","insertions":6,"deletions":-18},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":66,"deletions":-5}],"sizeInsertions":83,"sizeDeletions":-36},{"number":"4","revision":"3e8f2de8060a6dc6b5940f6a15c3b444fd288b58","parents":["e12051ebbcf41716ad84629dd04d5c04b40dd22f"],"ref":"refs/changes/86/2786/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508255492,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1508255536,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250511,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508250804,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508251210,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/prstat/prstat.c","type":"MODIFIED","insertions":3,"deletions":-8},{"file":"usr/src/cmd/prstat/prstat.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/prstat/prutil.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/man/man1m/prstat.1m","type":"MODIFIED","insertions":6,"deletions":-18},{"file":"usr/src/uts/common/sys/vm_usage.h","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/vm/vm_usage.c","type":"MODIFIED","insertions":66,"deletions":-5}],"sizeInsertions":83,"sizeDeletions":-36}],"allReviewers":[{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}