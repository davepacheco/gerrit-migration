From 14bc20e62f8a986c36762c892d2972687d66eaff Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 29 May 2018 09:18:14 +0000
Subject: [PATCH] OS-6977 zoneadmd incorrectly using zerror() in child Reviewed
 by: Hans Rosenfeld <hans.rosenfeld@joyent.com>

---
 usr/src/cmd/zoneadmd/log.c      | 17 ++++++++++-------
 usr/src/cmd/zoneadmd/zoneadmd.c | 26 ++++++++++++++++----------
 usr/src/cmd/zoneadmd/zoneadmd.h |  2 ++
 3 files changed, 28 insertions(+), 17 deletions(-)

diff --git a/usr/src/cmd/zoneadmd/log.c b/usr/src/cmd/zoneadmd/log.c
index 754df3c043..ca531b7177 100644
--- a/usr/src/cmd/zoneadmd/log.c
+++ b/usr/src/cmd/zoneadmd/log.c
@@ -154,6 +154,8 @@ typedef struct jsonpair {
 	const char *jp_val;
 } jsonpair_t;
 
+boolean_t logging_poisoned = B_FALSE;
+
 /*
  * MAX_LOG_STREAMS is a small number so we allocate in the simplest way.
  */
@@ -161,7 +163,6 @@ static logstream_t streams[MAX_LOG_STREAMS];
 static logfile_t logfiles[MAX_LOG_STREAMS];
 
 static boolean_t logging_initialized = B_FALSE;
-static boolean_t logging_poisoned = B_FALSE;
 static uint64_t logging_rot_size;		/* See ZLOG_MAXSZ */
 static uint64_t logging_rot_keep;		/* See ZLOG_KEEP */
 static int logging_pending_sig = 0;		/* Signal recvd while logging */
@@ -396,15 +397,17 @@ logstream_atfork_parent(void)
 	logstream_unlock();
 }
 
+/*
+ * logstream_*() should never be called in a child process, so we make sure this
+ * code is never called there.
+ *
+ * zerror() in a child process is still safe: it knows to check for poisoning,
+ * and in such a case will redirect its output to stderr on the presumption it
+ * is a pipe to the parent.
+ */
 static void
 logstream_atfork_child(void)
 {
-	/*
-	 * This does just enough to cause any errant logging call in the child
-	 * to lead to a failed assertion.  logstream_init() must not be called
-	 * in the child.  It is expected that the child will be calling exec()
-	 * real soon.
-	 */
 	logging_poisoned = B_TRUE;
 	logging_pending_sig = 0;
 	logstream_unlock();
diff --git a/usr/src/cmd/zoneadmd/zoneadmd.c b/usr/src/cmd/zoneadmd/zoneadmd.c
index 51954a9f3e..87f8db6456 100644
--- a/usr/src/cmd/zoneadmd/zoneadmd.c
+++ b/usr/src/cmd/zoneadmd/zoneadmd.c
@@ -226,10 +226,11 @@ localize_msg(char *locale, const char *msg)
 void
 zerror(zlog_t *zlogp, boolean_t use_strerror, const char *fmt, ...)
 {
-	va_list alist;
+	FILE *logfile = zlogp->logfile;
+	int saved_errno = errno;
 	char buf[MAXPATHLEN * 2]; /* enough space for err msg with a path */
 	char *bp, *bp_nozone;
-	int saved_errno = errno;
+	va_list alist;
 
 	if (zlogp == &logsys)
 		(void) snprintf(buf, sizeof (buf), "[zone '%s'] ", zone_name);
@@ -255,10 +256,17 @@ zerror(zlog_t *zlogp, boolean_t use_strerror, const char *fmt, ...)
 
 	(void) strlcat(buf, "\n", sizeof (buf));
 
-	logstream_write(platloghdl, bp_nozone, strlen(bp_nozone));
+	/*
+	 * If we don't have the platform log, we are in a child process, and
+	 * should log to stderr (which is a pipe) instead of the file.
+	 */
+	if (logging_poisoned) {
+		logfile = stderr;
+	} else {
+		logstream_write(platloghdl, bp_nozone, strlen(bp_nozone));
 
-	if (zlogp == NULL || zlogp == &logplat) {
-		return;
+		if (zlogp == &logplat)
+			return;
 	}
 
 	if (zlogp == &logsys) {
@@ -267,8 +275,8 @@ zerror(zlog_t *zlogp, boolean_t use_strerror, const char *fmt, ...)
 			*bp = '\0';
 		}
 		(void) syslog(LOG_ERR, "%s", buf);
-	} else if (zlogp->logfile != NULL) {
-		(void) fprintf(zlogp->logfile, "%s", buf);
+	} else if (logfile != NULL) {
+		(void) fprintf(logfile, "%s", buf);
 	} else {
 		size_t buflen;
 		size_t copylen;
@@ -1094,9 +1102,7 @@ do_subproc(zlog_t *zlogp, char *cmdbuf, char **retstr, boolean_t debug)
 		sigset(SIGINT, SIG_DFL);
 
 		/*
-		 * Do not call zerror() in child process as neither zerror() nor
-		 * logstream_*() functions are designed to handle multiple
-		 * processes logging.  Rather, write all errors to the pipe.
+		 * Set up a pipe for the child to log to.
 		 */
 		if (dup2(fds[1], STDERR_FILENO) == -1) {
 			(void) snprintf(buf, sizeof (buf),
diff --git a/usr/src/cmd/zoneadmd/zoneadmd.h b/usr/src/cmd/zoneadmd/zoneadmd.h
index 4953479e64..471aa40a0e 100644
--- a/usr/src/cmd/zoneadmd/zoneadmd.h
+++ b/usr/src/cmd/zoneadmd/zoneadmd.h
@@ -170,6 +170,8 @@ typedef enum {
 	LS_LINE_BUFFERED = 0x1		/* Write when \n found or full buffer */
 } logstream_flags_t;
 
+extern boolean_t logging_poisoned;
+
 extern void create_log_thread(zlog_t *);
 extern void destroy_log_thread(zlog_t *);
 extern void logstream_init(zlog_t *);
-- 
2.21.0

