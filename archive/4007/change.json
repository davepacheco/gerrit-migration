{"project":"joyent/illumos-joyent","branch":"master","id":"I4c9e0a381cacdbf3ab6633c1376b5af1756c51b1","number":"4007","subject":"OS-6977 zoneadmd incorrectly using zerror() in child Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"url":"https://cr.joyent.us/4007","commitMessage":"OS-6977 zoneadmd incorrectly using zerror() in child\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1527262777,"lastUpdated":1527606905,"open":false,"status":"MERGED","comments":[{"timestamp":1527262777,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 1."},{"timestamp":1527262779,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 4fdf468659634da66197c7947184d510fdcf9fe5\n    \n    m"},{"timestamp":1527265880,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1527269460,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527269878,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527270838,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1527585499,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 2."},{"timestamp":1527585501,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 5cd80d463621169d5e5f24e7ea5cfadd1888c6e3\n    \n    m\n    \n    commit 7f22391b668e2757364472bce01ee4cd9523c10a\n    \n    m"},{"timestamp":1527586513,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 3."},{"timestamp":1527586523,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit a5a817244c6cb76c73961065ad717da6c378f484\n    \n    m"},{"timestamp":1527586792,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 4."},{"timestamp":1527586808,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit e94b9974bcaf6e5591f27289488d826139a5f463\n    \n    m"},{"timestamp":1527602329,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1\n\nThanks for fixing this with the child zerror() goes to stderr approach.  This will stub far fewer tows in the long run."},{"timestamp":1527603034,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1527605481,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1527606813,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1527606840,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1527606905,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by John Levon"}],"currentPatchSet":{"number":"6","revision":"a342859e706a48afa2e2dd03a1ab5af9a3a2532c","parents":["03a391355a4ab2254501dc066c4f49d6748dfa7d"],"ref":"refs/changes/07/4007/6","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527606840,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527602329,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527603034,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527605481,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1527606905,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-16},"patchSets":[{"number":"1","revision":"25e0d55ca5b6460f6e8e16b946e1ff8231a9421d","parents":["adfeb11ce94f7c9b78db3f67388fb704c2d8673a"],"ref":"refs/changes/07/4007/1","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527262777,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527265880,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":839,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"A comment in do_subproc() says:\n\n\t\t/*\n\t\t * Do not call zerror() in child process as neither zerror() nor\n\t\t * logstream_*() functions are designed to handle multiple\n\t\t * processes logging.  Rather, write all errors to the pipe.\n\t\t */\n\nA few things come to mind:\n\n- We should be writing an error to stderr here\n- The comment should probably be above do_subproc() rather than buried in the middle.\n- We could make zerror() more forgiving and log to stderr if running in a subproc."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":839,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"1 - I\u0027m not sure what you mean by this. Fix the comment to suggest stderr not \"the pipe\" ?\n\n2. aye\n\n3. I can take a look; I\u0027m probably not the only one that\u0027ll make this mistake."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":839,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Sorry for lack of clarity.  Somehow this comment got attached a few lines above where it was intended.\n\nI was meaning to say that you can write a detailed error message to stderr to cause it to be logged.  Because of this, I was suggesting that the zerror() calls be changed to fprintf(stderr, ...)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/vplat.c","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":12,"deletions":-16},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":1,"deletions":-2}],"sizeInsertions":18,"sizeDeletions":-20},{"number":"2","revision":"14bc20e62f8a986c36762c892d2972687d66eaff","parents":["adfeb11ce94f7c9b78db3f67388fb704c2d8673a"],"ref":"refs/changes/07/4007/2","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527585499,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":28,"sizeDeletions":-17},{"number":"3","revision":"08fb6b29d4369a52a9dba3590cf6545ada33d1db","parents":["adfeb11ce94f7c9b78db3f67388fb704c2d8673a"],"ref":"refs/changes/07/4007/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527586513,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":14,"deletions":-6},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":26,"sizeDeletions":-13},{"number":"4","revision":"0e685ca81a437a18f0ce760e4c95e30d5c193685","parents":["adfeb11ce94f7c9b78db3f67388fb704c2d8673a"],"ref":"refs/changes/07/4007/4","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527586792,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527603034,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527602329,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527605481,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-16},{"number":"5","revision":"4c9e0a381cacdbf3ab6633c1376b5af1756c51b1","parents":["adfeb11ce94f7c9b78db3f67388fb704c2d8673a"],"ref":"refs/changes/07/4007/5","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527606813,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527603034,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527602329,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527605481,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-16},{"number":"6","revision":"a342859e706a48afa2e2dd03a1ab5af9a3a2532c","parents":["03a391355a4ab2254501dc066c4f49d6748dfa7d"],"ref":"refs/changes/07/4007/6","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1527606840,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527603034,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527602329,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527605481,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1527606905,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/log.c","type":"MODIFIED","insertions":10,"deletions":-7},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"usr/src/cmd/zoneadmd/zoneadmd.h","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-16}],"allReviewers":[{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}