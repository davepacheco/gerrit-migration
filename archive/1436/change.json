{"project":"joyent/manta-mola","branch":"master","id":"I0cf7a30cd8ebc73aad265eddbf680d72376ca2fc","number":"1436","subject":"MANTA-3140 moray_gc could work both smarter and harder Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/1436","commitMessage":"MANTA-3140 moray_gc could work both smarter and harder\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1486196439,"lastUpdated":1488235177,"open":false,"status":"MERGED","comments":[{"timestamp":1486196439,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1486196479,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486758013,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1487293423,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1487293454,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487293678,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(5 comments)\n\nNote that I still have to test these modifications."},{"timestamp":1487575906,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1487575937,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487977792,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4."},{"timestamp":1487977818,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488216392,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(7 comments)\n\nThanks for renaming the functions.  I found it much easier to follow now.\n\nI just have a few questions and suggestions about maxsockets.js, but they\u0027re not blockers."},{"timestamp":1488234154,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1488234555,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1488234654,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1488235169,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1488235177,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"6","revision":"492c32366708cfab9a8325b3a0036987bdbf7c09","parents":["8651e4315a092e49560db15d69fe4e63998c69c1"],"ref":"refs/changes/36/1436/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1488235169,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487977818,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1488235177,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":199,"deletions":-108},{"file":"lib/batch_stream.js","type":"ADDED","insertions":97,"deletions":0},{"file":"lib/maxsockets.js","type":"ADDED","insertions":67,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":172,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":538,"sizeDeletions":-177},"patchSets":[{"number":"1","revision":"37ab548b31b96d526e9af54db5050cfaed5d7dcc","parents":["4611b0d4f153006fd06509306604fb117a92c83a"],"ref":"refs/changes/36/1436/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1486196439,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486196479,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/moray_gc.js","line":10,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The copyright format changed."},{"file":"bin/moray_gc.js","line":10,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"OK."},{"file":"bin/moray_gc.js","line":70,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027d quote the %s here."},{"file":"bin/moray_gc.js","line":70,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ve restructured this a bit, but in all the places where I had (%s), I now have \"%s\" instead."},{"file":"bin/moray_gc.js","line":98,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I realize that these choices predate this change, but it\u0027s a little confusing that we have morayCleanShard, cleanEachShardObject, cleanShard, and cleanShards.  A BTS block comment might help that explains that there are a number of objects for each of a number of shards, and we enumerate the shards, then the objects for each shard (if that\u0027s indeed what\u0027s going on)."},{"file":"bin/moray_gc.js","line":98,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ve restructured a bit, and renamed some of the functions.  Hopefully it\u0027s clearer now."},{"file":"bin/moray_gc.js","line":98,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks!  This is much clearer."},{"file":"lib/batch_stream.js","line":16,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we add a summary comment that explains what the input objects for this look like, what the outputs look like, and what it does?"},{"file":"lib/batch_stream.js","line":16,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/moray_cleaner.js","line":192,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we get a similar comment about this stream?  What types of objects it accepts and what it does with them?  Is that what the comment at line 292 is describing?"},{"file":"lib/moray_cleaner.js","line":192,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":92,"deletions":-43},{"file":"lib/batch_stream.js","type":"ADDED","insertions":80,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":162,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":337,"sizeDeletions":-112},{"number":"2","revision":"74b2123ad7de5c3f42274f7bcaa663ad2e61b128","parents":["6037cf2f6e4bf79d977a8d0f1fce68176ec5e845"],"ref":"refs/changes/36/1436/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1487293423,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487293454,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":199,"deletions":-108},{"file":"lib/batch_stream.js","type":"ADDED","insertions":97,"deletions":0},{"file":"lib/maxsockets.js","type":"ADDED","insertions":65,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":172,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":536,"sizeDeletions":-177},{"number":"3","revision":"8a30c6451bcf4bb2f1960c84819ab56665021ad2","parents":["6037cf2f6e4bf79d977a8d0f1fce68176ec5e845"],"ref":"refs/changes/36/1436/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1487575906,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487575937,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":199,"deletions":-108},{"file":"lib/batch_stream.js","type":"ADDED","insertions":97,"deletions":0},{"file":"lib/maxsockets.js","type":"ADDED","insertions":67,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":172,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":538,"sizeDeletions":-177},{"number":"4","revision":"e5b406312e5d04f7824914eb10a8ae0f17a09af8","parents":["6037cf2f6e4bf79d977a8d0f1fce68176ec5e845"],"ref":"refs/changes/36/1436/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1487977792,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487977818,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/moray_gc.js","line":70,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"`strom`?"},{"file":"bin/moray_gc.js","line":70,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"\"stream\" was already taken."},{"file":"bin/moray_gc.js","line":89,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Out of curiosity, is there any reason this is different than the `finish` event?"},{"file":"bin/moray_gc.js","line":89,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Ah!  Not anymore.  I had originally included the batching of input objects into \"MorayCleaner\" itself, which meant that I had to handle the final (short) batch on \"finish\".  I was then emitting \"workComplete\" after the Moray operation for the final batch.\n\nNow that \"BatchStream\" is doing the batching, \"MorayCleaner\" only deals with whole batches (whatever size they happen to be).\n\nIn the interest of getting this round of changes back without extensive additional testing, as we have discussed elsewhere, I think I\u0027ll push fixing this back to a follow-up."},{"file":"lib/maxsockets.js","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As per discussion elsewhere, though this is perhaps not the clearest file ever, it\u0027s also not _incorrect_ per se.  In the interests of getting back on replacing the entire maintenance job system, we ought to just put this back as is for now -- with the knowledge that it\u0027ll be gone soon."},{"file":"lib/maxsockets.js","line":29,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why not make this interface ensureMaxSocketsAtLeast() and then check for values larger than the target (including Infinity)?"},{"file":"lib/maxsockets.js","line":56,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This seems unnecessarily implicit.  Was there any particular reason not to make this something like:\n\n    socketcfg \u003d require(\u0027./lib/socketcfg\u0027) /* (or whatever you want to call it) */\n    socketcfg.ensureHttpMaxSocketsAtLeast(targetMaxSockets)\n\nOkay, that\u0027s pretty verbose, but the semantics of this are fairly non-trivial, and right now there\u0027s not any named function call from the consumer.\n\nIf we want to keep the interface so that callers don\u0027t need that extra call (i.e., `require(\u0027./lib/maxsockets\u0027)(desiredMaxSockets)`), what do you think of explaining the interface (and the reason for it) as a top-level comment at the top of this file?"},{"file":"lib/maxsockets.js","line":65,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is there any reason not to require these at the top level?"},{"file":"lib/moray_cleaner.js","line":27,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"We should (eventually, not in this change) update this to moray@3.0.0 and eliminate this timeout."},{"file":"lib/moray_cleaner.js","line":27,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Agreed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":199,"deletions":-108},{"file":"lib/batch_stream.js","type":"ADDED","insertions":97,"deletions":0},{"file":"lib/maxsockets.js","type":"ADDED","insertions":67,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":172,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":538,"sizeDeletions":-177},{"number":"5","revision":"0cf7a30cd8ebc73aad265eddbf680d72376ca2fc","parents":["6037cf2f6e4bf79d977a8d0f1fce68176ec5e845"],"ref":"refs/changes/36/1436/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1488234654,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487977818,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":199,"deletions":-108},{"file":"lib/batch_stream.js","type":"ADDED","insertions":97,"deletions":0},{"file":"lib/maxsockets.js","type":"ADDED","insertions":67,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":172,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":538,"sizeDeletions":-177},{"number":"6","revision":"492c32366708cfab9a8325b3a0036987bdbf7c09","parents":["8651e4315a092e49560db15d69fe4e63998c69c1"],"ref":"refs/changes/36/1436/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1488235169,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488234154,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1488235177,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487977818,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/moray_gc.js","type":"MODIFIED","insertions":199,"deletions":-108},{"file":"lib/batch_stream.js","type":"ADDED","insertions":97,"deletions":0},{"file":"lib/maxsockets.js","type":"ADDED","insertions":67,"deletions":0},{"file":"lib/moray_cleaner.js","type":"MODIFIED","insertions":172,"deletions":-68},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-1}],"sizeInsertions":538,"sizeDeletions":-177}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}