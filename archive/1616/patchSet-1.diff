commit 20b8dec9323ebe8cb9916910ec1d2a6ab72735ce (refs/changes/16/1616/1)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2017-03-06T14:25:32-08:00 (2 years, 7 months ago)
    
    joyent/node-sshpk-agent#9 want to sign certificates using agent keys

diff --git a/lib/formats/openssh-cert.js b/lib/formats/openssh-cert.js
index 8ce7350..6fa4fe3 100644
--- a/lib/formats/openssh-cert.js
+++ b/lib/formats/openssh-cert.js
@@ -4,6 +4,7 @@ module.exports = {
 	read: read,
 	verify: verify,
 	sign: sign,
+	signAsync: signAsync,
 	write: write,
 
 	/* Internal private API */
@@ -188,6 +189,31 @@ function sign(cert, key) {
 	return (true);
 }
 
+function signAsync(cert, sign, done) {
+	if (cert.signatures.openssh === undefined)
+		cert.signatures.openssh = {};
+	try {
+		var blob = toBuffer(cert, true);
+	} catch (e) {
+		delete (cert.signatures.openssh);
+		done(e);
+		return;
+	}
+	var sig = cert.signatures.openssh;
+	var hashAlgo = undefined;
+	if (key.type === 'rsa' || key.type === 'dsa')
+		hashAlgo = 'sha1';
+
+	sign(blob, function (err, signature) {
+		if (err) {
+			done(err);
+			return;
+		}
+		sig.signature = signature;
+		done();
+	});
+}
+
 function write(cert, options) {
 	if (options === undefined)
 		options = {};
diff --git a/lib/formats/x509.js b/lib/formats/x509.js
index c630ce1..6ac0116 100644
--- a/lib/formats/x509.js
+++ b/lib/formats/x509.js
@@ -4,6 +4,7 @@ module.exports = {
 	read: read,
 	verify: verify,
 	sign: sign,
+	signAsync: signAsync,
 	write: write
 };
 
@@ -451,6 +452,32 @@ function sign(cert, key) {
 	return (true);
 }
 
+function signAsync(cert, sign, done) {
+	if (cert.signatures.x509 === undefined)
+		cert.signatures.x509 = {};
+	var sig = cert.signatures.x509;
+
+	sig.algo = key.type + '-' + key.defaultHashAlgorithm();
+	if (SIGN_ALGS[sig.algo] === undefined) {
+		done(new Error('Cannot sign with default algorithm'));
+		return;
+	}
+
+	var der = new asn1.BerWriter();
+	writeTBSCert(cert, der);
+	var blob = der.buffer;
+	sig.cache = blob;
+
+	sign(blob, function (err, signature) {
+		if (err) {
+			done(err);
+			return;
+		}
+		sig.signature = signature;
+		done();
+	});
+}
+
 function write(cert, options) {
 	var sig = cert.signatures.x509;
 	assert.object(sig, 'x509 signature');
diff --git a/package.json b/package.json
index a5cf747..6062237 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "sshpk",
-  "version": "1.11.0",
+  "version": "1.12.0",
   "description": "A library for finding and using SSH public keys",
   "main": "lib/index.js",
   "scripts": {
