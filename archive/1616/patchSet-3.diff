From 1c9f1bc9fe943693adfa22197a5e4852a35cbfae Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 6 Mar 2017 14:25:32 -0800
Subject: [PATCH] joyent/node-sshpk-agent#9 want to sign certificates using
 agent keys

---
 lib/formats/openssh-cert.js | 31 ++++++++++++++++++++++++++++++-
 lib/formats/x509.js         | 29 ++++++++++++++++++++++++++++-
 package.json                |  2 +-
 3 files changed, 59 insertions(+), 3 deletions(-)

diff --git a/lib/formats/openssh-cert.js b/lib/formats/openssh-cert.js
index 8ce7350..08f94b1 100644
--- a/lib/formats/openssh-cert.js
+++ b/lib/formats/openssh-cert.js
@@ -1,9 +1,10 @@
-// Copyright 2016 Joyent, Inc.
+// Copyright 2017 Joyent, Inc.
 
 module.exports = {
 	read: read,
 	verify: verify,
 	sign: sign,
+	signAsync: signAsync,
 	write: write,
 
 	/* Internal private API */
@@ -188,6 +189,34 @@ function sign(cert, key) {
 	return (true);
 }
 
+function signAsync(cert, signer, done) {
+	if (cert.signatures.openssh === undefined)
+		cert.signatures.openssh = {};
+	try {
+		var blob = toBuffer(cert, true);
+	} catch (e) {
+		delete (cert.signatures.openssh);
+		done(e);
+		return;
+	}
+	var sig = cert.signatures.openssh;
+
+	signer(blob, function (err, signature) {
+		if (err) {
+			done(err);
+			return;
+		}
+		if ((signature.type === 'rsa' || signature.type === 'dsa') &&
+		    signature.hashAlgorithm !== 'sha1') {
+			done(new Error('RSA/DSA keys can only sign with ' +
+			    'SHA-1 for OpenSSH certificates'));
+			return;
+		}
+		sig.signature = signature;
+		done();
+	});
+}
+
 function write(cert, options) {
 	if (options === undefined)
 		options = {};
diff --git a/lib/formats/x509.js b/lib/formats/x509.js
index c630ce1..23acd24 100644
--- a/lib/formats/x509.js
+++ b/lib/formats/x509.js
@@ -1,9 +1,10 @@
-// Copyright 2016 Joyent, Inc.
+// Copyright 2017 Joyent, Inc.
 
 module.exports = {
 	read: read,
 	verify: verify,
 	sign: sign,
+	signAsync: signAsync,
 	write: write
 };
 
@@ -451,6 +452,32 @@ function sign(cert, key) {
 	return (true);
 }
 
+function signAsync(cert, signer, done) {
+	if (cert.signatures.x509 === undefined)
+		cert.signatures.x509 = {};
+	var sig = cert.signatures.x509;
+
+	var der = new asn1.BerWriter();
+	writeTBSCert(cert, der);
+	var blob = der.buffer;
+	sig.cache = blob;
+
+	signer(blob, function (err, signature) {
+		if (err) {
+			done(err);
+			return;
+		}
+		sig.algo = signature.type + '-' + signature.hashAlgorithm;
+		if (SIGN_ALGS[sig.algo] === undefined) {
+			done(new Error('Invalid signing algorithm "' +
+			    sig.algo + '"'));
+			return;
+		}
+		sig.signature = signature;
+		done();
+	});
+}
+
 function write(cert, options) {
 	var sig = cert.signatures.x509;
 	assert.object(sig, 'x509 signature');
diff --git a/package.json b/package.json
index a5cf747..6062237 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "sshpk",
-  "version": "1.11.0",
+  "version": "1.12.0",
   "description": "A library for finding and using SSH public keys",
   "main": "lib/index.js",
   "scripts": {
-- 
2.21.0

