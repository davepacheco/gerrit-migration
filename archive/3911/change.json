{"project":"joyent/sdc-napi-ufds-watcher","branch":"master","id":"I18039d10d5c42772b7a1a483cbca092291721b62","number":"3911","subject":"TRITON-170 napi-ufds-watcher should retry when failing to list default VLAN Reviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e Approved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e","owner":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"url":"https://cr.joyent.us/3911","commitMessage":"TRITON-170 napi-ufds-watcher should retry when failing to list default VLAN\nReviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\nApproved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\n","createdOn":1525467081,"lastUpdated":1528406481,"open":false,"status":"MERGED","comments":[{"timestamp":1525467081,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 1."},{"timestamp":1525467108,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525905178,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 2."},{"timestamp":1525905204,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525985859,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(8 comments)"},{"timestamp":1526512004,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 2:\n\n(7 comments)\n\nHey, thanks for reviewing this. Code updates will follow shortly. I am not sure I understood one of your comments, and I purposely did not implement any upper bound on the retries, for the reason stated in the reply. Let me know if you think the latter is a bad idea ;)"},{"timestamp":1526512023,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 3."},{"timestamp":1526512050,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1526512203,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 4."},{"timestamp":1526512229,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526525438,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 4:\n\n(3 comments)\n\nFix the indentation and I\u0027m happy to CR/IA.\n\nUnrelatedly, any concerns about races due to the ordering of findDefaultVlan/createDefaultVlan/findDefaultNetwork/createDefaultNetwork in  napiWorker()? Since VLANs and networks can both be deleted in NAPI, there doesn\u0027t seem to be a good way to do this with napi\u0027s current api."},{"timestamp":1528142977,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 5."},{"timestamp":1528143004,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528143253,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Uploaded patch set 6."},{"timestamp":1528143280,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528143612,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 6:\n\n(2 comments)\n\nHey, made the changes requested (CS-5 and CS-6). Regarding the ordering of the operations, I\u0027m not too worried. If it becomes a problem, we can fix it in a different ticket."},{"timestamp":1528380587,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1528406435,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1528406481,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Nick Zivkovic"}],"currentPatchSet":{"number":"7","revision":"60d76a6102cf06879617fa3cfcd3eda7ba6503d4","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/7","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1528406435,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528143280,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528380587,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528380587,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"SUBM","value":"1","grantedOn":1528406481,"by":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":82,"deletions":-49}],"sizeInsertions":82,"sizeDeletions":-49},"patchSets":[{"number":"1","revision":"88bd11d1538de975e70d95bd4c1331cda709d7fc","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/1","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1525467081,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525467108,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":37,"deletions":-19}],"sizeInsertions":37,"sizeDeletions":-19},{"number":"2","revision":"1a80bda40c693e49303abee735f5c2b7fb1bacd6","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/2","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1525905178,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525905204,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/default-fabric-setup.js","line":8,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"2018"},{"file":"lib/default-fabric-setup.js","line":8,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":59,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"name this func"},{"file":"lib/default-fabric-setup.js","line":59,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":63,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"The other log statements below all contain \"user\" too."},{"file":"lib/default-fabric-setup.js","line":65,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"%d ?"},{"file":"lib/default-fabric-setup.js","line":65,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":67,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Any concerns about this potentially repeatedly running forever?"},{"file":"lib/default-fabric-setup.js","line":67,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Not really. The create() functions below and above have the same potential problem, so even if the find() functions were implemented with a max_retry_limit, we could potentially loop infinitely in one of the create() functions. I wanted to keep this changeset as small as possible, so I didn\u0027t set out to modify the create() functions. If you think the code can\u0027t be integrated this way, then I can implement the max_retry_limit for _both_ the `create()` and `find()` functions."},{"file":"lib/default-fabric-setup.js","line":67,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"No, sounds good.\n\nI\u0027m generally in favour of infinite retries, because services sometimes go away for quite a while, but always come back. We need a self-healing system at scale, not various systems that ops need to chase down and restart because a service was offline. Just gotta be careful of the error cases (service gone/internal service error are different from other cases).\n\nAnyway, I digress."},{"file":"lib/default-fabric-setup.js","line":71,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Consistency nit: some of these log messages contain the user UUID, and some don\u0027t."},{"file":"lib/default-fabric-setup.js","line":71,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Maybe I am misunderstanding this comment, but it looks like every log message in the `find()` functions contain a user uuid (either inlined or as part of an object literal that is getting logged)."},{"file":"lib/default-fabric-setup.js","line":71,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"It\u0027s that \"either\" bit I\u0027m referring to. The warn() above doesn\u0027t contain a { uuid: }, and the info() below doesn\u0027t contain a %s.\n\nI\u0027m totally nitpicking though."},{"file":"lib/default-fabric-setup.js","line":71,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":77,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Using a filter() would be cleaner."},{"file":"lib/default-fabric-setup.js","line":77,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"name"},{"file":"lib/default-fabric-setup.js","line":77,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"},{"file":"lib/default-fabric-setup.js","line":77,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":82,"deletions":-47}],"sizeInsertions":82,"sizeDeletions":-47},{"number":"3","revision":"d018bfd89ded218b63ff8dc086db1b24042b666f","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/3","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1526512023,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1526512050,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/default-fabric-setup.js","line":59,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"extra space between function name and left paren"},{"file":"lib/default-fabric-setup.js","line":77,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"extra space between function name and left paren"},{"file":"lib/default-fabric-setup.js","line":151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"extra space between function name and left paren"},{"file":"lib/default-fabric-setup.js","line":169,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"extra space between function name and left paren"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":82,"deletions":-48}],"sizeInsertions":82,"sizeDeletions":-48},{"number":"4","revision":"b81b18acc5df7c8c1cffb73aa9b777b52e68929c","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/4","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1526512203,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526512229,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/default-fabric-setup.js","line":181,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"The indentation here is confusing."},{"file":"lib/default-fabric-setup.js","line":181,"reviewer":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":82,"deletions":-48}],"sizeInsertions":82,"sizeDeletions":-48},{"number":"5","revision":"f40103076f05e1778b144b047d09dcf6364c6fa8","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/5","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1528142977,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528143004,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":83,"deletions":-49}],"sizeInsertions":83,"sizeDeletions":-49},{"number":"6","revision":"18039d10d5c42772b7a1a483cbca092291721b62","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/6","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1528143253,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528143280,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528380587,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528380587,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":82,"deletions":-49}],"sizeInsertions":82,"sizeDeletions":-49},{"number":"7","revision":"60d76a6102cf06879617fa3cfcd3eda7ba6503d4","parents":["9c7858f1b9460e7c55fd3214587bce4fef08a86d"],"ref":"refs/changes/11/3911/7","uploader":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"createdOn":1528406435,"author":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528143280,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1528406481,"by":{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1528380587,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1528380587,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/default-fabric-setup.js","type":"MODIFIED","insertions":82,"deletions":-49}],"sizeInsertions":82,"sizeDeletions":-49}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Nick Zivkovic","email":"nick.zivkovic@joyent.com","username":"nickziv"}]}