{"project":"joyent/illumos-joyent","branch":"master","id":"Iec03b232c131f2289fedb6a63a9990898bbe16c2","number":"3606","subject":"OS-6765 support PCI passthru in bhyve zones Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/3606","commitMessage":"OS-6765 support PCI passthru in bhyve zones\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1520941027,"lastUpdated":1521671661,"open":false,"status":"MERGED","comments":[{"timestamp":1520941027,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1520942246,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1520951577,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1520956745,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521032485,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521137962,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521138154,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521139754,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521472806,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521480921,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1521669051,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1521670657,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1521671635,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1521671661,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"4","revision":"ec03b232c131f2289fedb6a63a9990898bbe16c2","parents":["f3195f72a46cb863b80329145921191a60882155"],"ref":"refs/changes/06/3606/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1521671635,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520942246,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520951577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521669051,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1521671660,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":122,"deletions":-40}],"sizeInsertions":124,"sizeDeletions":-42},"patchSets":[{"number":"1","revision":"cc776ca057c9bfe99724a751247418c2f16cc571","parents":["b4d3cc05ba69320101da4e02e8d10f11063f2ff7"],"ref":"refs/changes/06/3606/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1520941027,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520951577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520942246,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":184,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why are we using BDF notation here?  None of the other devices specify that info, it\u0027s just inferred."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":184,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Apparently some multi-function devices need to be grouped into multiple functions in the guest, too, for the driver to work properly. I\u0027m not aware of a way to figure that out at runtime, so setting a pci-slot will allow the user (or the upstack code) to group the devices accordingly.\n\nI thought about doing some automagic here, as in letting the user specify device X and then really put all functions of device X to slot PCI_SLOT_PPT + X, but I figured it would be confusing.\n\nI\u0027m actually a bit worried about conflicts when the user specifies  a slot that is already occupied by some other device. Bhyve will catch this right now, but I think that eventually we want to this code to be a bit smarter about our slot allocation."},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":184,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps we could just pay heed to the bus/device in the triplet for grouping purposes?"},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":184,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I\u0027m not sure I understand. Do you want me to just remove the possibility to set the function number and somehow infer that from the devices that are configured?"},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":184,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sorry, I meant device/function"},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","line":184,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I\u0027d prefer to keep the bus in there as well. It is optional, just like the function number it will default to 0 if omitted.\n\nThere\u0027s two reasons why I think we want to have the possibility to specify bus numbers. First, with just bus 0 we\u0027ll be limited to 31 devices, including those that we always need. And second, depending on the kind of device or the whats running in the VM it may be useful to put a device on a certain bus in the guest."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":124,"deletions":-42}],"sizeInsertions":126,"sizeDeletions":-44},{"number":"2","revision":"1bdd1dab6a4141670f4fdbd1c2af413a5bae30ed","parents":["db3c1a65483dd60a62c0f8389df50979f1b0bf22"],"ref":"refs/changes/06/3606/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1521480921,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521669051,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520951577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520942246,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":122,"deletions":-40}],"sizeInsertions":124,"sizeDeletions":-42},{"number":"3","revision":"f70b9b6313de36dc71822c8bd3ad40c7b62937ff","parents":["f3195f72a46cb863b80329145921191a60882155"],"ref":"refs/changes/06/3606/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1521670657,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521669051,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520951577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520942246,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":122,"deletions":-40}],"sizeInsertions":124,"sizeDeletions":-42},{"number":"4","revision":"ec03b232c131f2289fedb6a63a9990898bbe16c2","parents":["f3195f72a46cb863b80329145921191a60882155"],"ref":"refs/changes/06/3606/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1521671635,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521669051,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1521671660,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520951577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520942246,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":122,"deletions":-40}],"sizeInsertions":124,"sizeDeletions":-42}],"allReviewers":[{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}