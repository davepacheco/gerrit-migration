From 28bfbb54ba058e972b7e2e8ddea17554246deb53 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Thu, 16 Feb 2017 07:20:16 +0000
Subject: [PATCH] OS-5829 tee(1) stuck waiting on sysevent(1M) in nightly1

---
 src/vm/runtest              |  3 ++-
 src/vm/tests/test-docker.js | 19 ++++++++++---------
 2 files changed, 12 insertions(+), 10 deletions(-)

diff --git a/src/vm/runtest b/src/vm/runtest
index 159adbb5..63157cd2 100755
--- a/src/vm/runtest
+++ b/src/vm/runtest
@@ -100,7 +100,8 @@ done
 
 set +o errexit
 set -o pipefail
-/usr/node/bin/node --abort_on_uncaught_exception \
+/usr/bin/ctrun -l child -o noorphan /usr/node/bin/node \
+    --abort_on_uncaught_exception \
     /usr/vm/node_modules/nodeunit/bin/nodeunit \
     --reporter tap $1 | tee -a /tmp/test.output.$$
 TEST_EXIT_CODE=$?
diff --git a/src/vm/tests/test-docker.js b/src/vm/tests/test-docker.js
index 3aab4de4..660d5b6e 100644
--- a/src/vm/tests/test-docker.js
+++ b/src/vm/tests/test-docker.js
@@ -1,4 +1,4 @@
-// Copyright 2016 Joyent, Inc.  All rights reserved.
+// Copyright 2017 Joyent, Inc.  All rights reserved.
 //
 // These tests ensure that docker flag works as expected when setting/unsetting
 // Also test that /etc/resolv.conf, /etc/hosts and /etc/hostname are set
@@ -1429,15 +1429,16 @@ test('test restart delay reset', function (t) {
 
                 cb();
             });
-        }, function (cb) {
-            // stop the zoneevent watcher
-            if (se != null) {
-                se.stop();
-                se = null;
-            }
-            cb();
         }
-    ]);
+    ], function () {
+        // stop the zoneevent watcher
+        if (se != null) {
+            se.stop();
+            se = null;
+        }
+
+        t.end();
+    });
 });
 
 /* BEGIN JSSTYLED */
-- 
2.21.0

