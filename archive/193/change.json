{"project":"joyent/illumos-joyent","branch":"master","id":"I6fa006e8e0f6560b5ad4df46db0b9cac31cb5e16","number":"193","subject":"OS-5566 ppoll timeout calculation can overflow Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/193","commitMessage":"OS-5566 ppoll timeout calculation can overflow\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1470173003,"lastUpdated":1470274287,"open":false,"status":"MERGED","comments":[{"timestamp":1470173003,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1470173044,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nA regression test will be added to this CR later today."},{"timestamp":1470175075,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1470180408,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1470226819,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1470238622,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1470250582,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1470253120,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1470257923,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1470260923,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\nThanks for changing around the uhrtime_t and adding the macro!"},{"timestamp":1470270439,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1470274157,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1470274232,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nRe-approving since gerrit wrongly tossed the existing ones."},{"timestamp":1470274287,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"4","revision":"6fa006e8e0f6560b5ad4df46db0b9cac31cb5e16","parents":["63ecec4455ffe4397ed23edace7c0409015800a4"],"ref":"refs/changes/93/193/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1470274157,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470274232,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1470274232,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1470274287,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/sys/time.h","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/syscall/poll.c","type":"MODIFIED","insertions":26,"deletions":-4}],"sizeInsertions":35,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"601cac1a018591f52c5449292dedf687d0205c27","parents":["499a5f9af3045df28699c370c6e3f2bcdd92514d"],"ref":"refs/changes/93/193/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1470173003,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/syscall/poll.c","line":385,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Maybe note that itimerspecfix prevents tv_nsec \u003e\u003d NANOSEC and that the addition is therefore overflow-safe (since we tested for \u003e\u003d the dividend of HRTIME_MAX, above)"},{"file":"usr/src/uts/common/syscall/poll.c","line":401,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"hrtime_t is a signed type. This is a cast from an unsigned type to a signed one of smaller width, without any check for the value being higher than the max representable in the signed type -- which is \"implementation-defined\" by the C standards. In practice most compilers (incl GCC) will clear any high bits, making the following if() branch impossible to take (the resulting deadline can never be negative). The compiler will elide the entire following if at *all* optimization levels (and possibly even at -O0)\n\nTo check for overflow on deadline while adding gethrtime() to it, the easiest way is to create a local uint64_t, set to deadline, and then add gethrtime() to it. Then test if the result is \u003c (uint64_t)deadline. Check again that the final result is also \u003c HRTIME_MAX before casting it to signed (to make certain that no bits of precision are being dropped)."},{"file":"usr/src/uts/common/syscall/poll.c","line":401,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/time.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/syscall/poll.c","type":"MODIFIED","insertions":22,"deletions":-3}],"sizeInsertions":25,"sizeDeletions":-3},{"number":"2","revision":"2320883f5e903b1611ef5f62820d7e4948111b0b","parents":["499a5f9af3045df28699c370c6e3f2bcdd92514d"],"ref":"refs/changes/93/193/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1470180408,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470226819,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/sys/time.h","line":270,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"For consistency with outer stuff can we call this time uhrtime_t? Also can we add a UHRTIME_MAX as well?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/sys/time.h","type":"MODIFIED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/syscall/poll.c","type":"MODIFIED","insertions":26,"deletions":-4}],"sizeInsertions":34,"sizeDeletions":-4},{"number":"3","revision":"6e41ee5b1721bffd470ae37950afae92ddb4ac64","parents":["706bcd0697a743cbd0586f76258850399c4f9637"],"ref":"refs/changes/93/193/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1470250582,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470260923,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1470270439,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470257923,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470253120,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/sys/time.h","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/syscall/poll.c","type":"MODIFIED","insertions":26,"deletions":-4}],"sizeInsertions":35,"sizeDeletions":-4},{"number":"4","revision":"6fa006e8e0f6560b5ad4df46db0b9cac31cb5e16","parents":["63ecec4455ffe4397ed23edace7c0409015800a4"],"ref":"refs/changes/93/193/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1470274157,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1470274232,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1470274232,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1470274287,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/sys/time.h","type":"MODIFIED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/syscall/poll.c","type":"MODIFIED","insertions":26,"deletions":-4}],"sizeInsertions":35,"sizeDeletions":-4}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}