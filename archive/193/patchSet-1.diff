From 601cac1a018591f52c5449292dedf687d0205c27 Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Tue, 2 Aug 2016 20:58:15 +0000
Subject: [PATCH] OS-5566 ppoll timeout calculation can overflow

---
 usr/src/uts/common/sys/time.h     |  3 +++
 usr/src/uts/common/syscall/poll.c | 25 ++++++++++++++++++++++---
 2 files changed, 25 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/sys/time.h b/usr/src/uts/common/sys/time.h
index 05cc855a4b..5111d3cdf8 100644
--- a/usr/src/uts/common/sys/time.h
+++ b/usr/src/uts/common/sys/time.h
@@ -15,6 +15,7 @@
  * Use is subject to license terms.
  *
  * Copyright 2013 Nexenta Systems, Inc.  All rights reserved.
+ * Copyright 2016 Joyent, Inc.
  */
 
 /*
@@ -261,6 +262,8 @@ typedef	longlong_t	hrtime_t;
 
 #if defined(_KERNEL) || defined(_FAKE_KERNEL)
 
+#define	HRTIME_MAX	LLONG_MAX
+
 #include <sys/time_impl.h>
 #include <sys/mutex.h>
 
diff --git a/usr/src/uts/common/syscall/poll.c b/usr/src/uts/common/syscall/poll.c
index 3d0a5cc04b..0c6c42d37e 100644
--- a/usr/src/uts/common/syscall/poll.c
+++ b/usr/src/uts/common/syscall/poll.c
@@ -364,7 +364,6 @@ poll_common(pollstate_t *ps, pollfd_t *fds, nfds_t nfds, timespec_t *tsp,
     int *fdcnt)
 {
 	kthread_t *t = curthread;
-	proc_t *p = ttoproc(t);
 	hrtime_t deadline; /* hrtime value when we want to return */
 	pollfd_t *pollfdp;
 	pollcache_t *pcp;
@@ -378,11 +377,31 @@ poll_common(pollstate_t *ps, pollfd_t *fds, nfds_t nfds, timespec_t *tsp,
 		deadline = -1;
 	} else if (tsp->tv_sec == 0 && tsp->tv_nsec == 0) {
 		deadline = 0;
+	} else if (tsp->tv_sec >= HRTIME_MAX/NANOSEC) {
+		/* Use an indefinite timeout if tv_sec would cause overflow */
+		deadline = -1;
 	} else {
+		/*
+		 * The above check, when combined with the protections offered
+		 * by itimerspecfix, will prevent overflow during the
+		 * conversion from timespec_t to hrtime_t.
+		 */
+		deadline = tsp->tv_sec * NANOSEC;
+		deadline += tsp->tv_nsec;
+
 		/* They must wait at least a tick. */
-		deadline = ((hrtime_t)tsp->tv_sec * NANOSEC) + tsp->tv_nsec;
 		deadline = MAX(deadline, nsec_per_tick);
-		deadline += gethrtime();
+
+		/*
+		 * Adding the current time to the deadline interval may cause
+		 * an overflow.  Unsigned math is used to detect such a
+		 * condition without stumbling into undefined behavior.
+		 */
+		deadline = (hrtime_t)((unsigned long long)deadline +
+		    (unsigned long long)gethrtime());
+		if (deadline <= 0) {
+			deadline = -1;
+		}
 	}
 
 	/*
-- 
2.21.0

