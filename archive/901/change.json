{"project":"joyent/manta-muskie","branch":"master","id":"Iecbf9f19cc49d6538dc53a3d094d1a4719a2332e","number":"901","subject":"MANTA-3030 muskie should support detailed moray errors MANTA-2914 muskie stack traces should clarify the problematic component","owner":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"url":"https://cr.joyent.us/901","commitMessage":"MANTA-3030 muskie should support detailed moray errors\nMANTA-2914 muskie stack traces should clarify the problematic component\n","createdOn":1479173283,"lastUpdated":1479491637,"open":false,"status":"MERGED","comments":[{"timestamp":1479173283,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 1."},{"timestamp":1479226715,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1:\n\n(1 comment)\n\nI can see that the substitute comparators here will provide like-for-like functionality, at least given my understanding of the new VError, so this looks good to me. \n\nOnly 1 stye-related question that applies to each use of findCauseByName (see comment), which I personally feel would read better if it was possible. As it is, it\u0027s a little confusing to read some of the double negatives. I can see there is an example in RFD 41 of this exact usage, so it\u0027s quite possible I\u0027m overlooking something."},{"timestamp":1479231015,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1479291285,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1:\n\n\"VError.hasCauseWithName\" sounds good. Presumably this would return a boolean value which we could explicitly compare against, as opposed to checking for the existence of an object. \n\nMy understand is that this isn\u0027t possible today, though, and would require a change in joyent/node-verror. Are you thinking that this would be a separate future improvement to readability, or we\u0027d block here on getting that implemented?\n\nFWIW, I think the changes here look OK and provide the same functionality as existing code, so if you\u0027re OK with \"hasCauseWithName\" being a future piece of work then that\u0027s also fine by me."},{"timestamp":1479317274,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\nI\u0027d probably prefer to keep the VError change separate."},{"timestamp":1479321525,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1\n\nI see we now have https://cr.joyent.us/#/c/907/ for \"hasCauseWithName\", but I\u0027m going to +2 this to give you the option to either integrate as-is, or wait for 907."},{"timestamp":1479322378,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1479323685,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1479323696,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Integration-Approval-1"},{"timestamp":1479327200,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 2."},{"timestamp":1479327256,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479327270,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: -Integration-Approval"},{"timestamp":1479334060,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nPatchset 2 rewrites translateError() to more closely implement the same behavior as before.  I\u0027ve re-run the muskie test suite and will run the Marlin test suite again next.\n\nI tried to exercise the cases that I mentioned earlier might be broken (like the RequestedRangeNotSatisfiableError), but those cases appear to have worked by accident on the older code.  There was no difference before and after the change, and the \"content-range\" header was set in both cases.  My conclusion is that in the old code, the error didn\u0027t have a cause, so \"err\" (the cause) was the same as \"err\" (the argument).\n\nBarring the last bit of testing, this should be ready for re-review."},{"timestamp":1479337219,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThe marlin test suite completed successfully with muskies deployed using patchset 2."},{"timestamp":1479337291,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\nAssuming you\u0027ve finished that last bit of testing you described for the last patch set, this looks good to me!"},{"timestamp":1479460442,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\nlib/errors.js is a lot easier to read with those changes. LGTM"},{"timestamp":1479491637,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by David Pacheco"}],"currentPatchSet":{"number":"2","revision":"ecbf9f19cc49d6538dc53a3d094d1a4719a2332e","parents":["599e0207f2de153321f580b66f69c5e8b6527ff8"],"ref":"refs/changes/01/901/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1479327200,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479327256,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479337291,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479337291,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479460442,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479460442,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1479491637,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/dir.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":25,"deletions":-29},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/picker.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":37,"sizeDeletions":-35},"patchSets":[{"number":"1","revision":"2cc906a6d23e6a7fcd1cc5de8c585d5a0c6a62d2","parents":["599e0207f2de153321f580b66f69c5e8b6527ff8"],"ref":"refs/changes/01/901/1","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1479173283,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1479323696,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479321525,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479321525,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"comments":[{"file":"lib/common.js","line":475,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is there any reason we directly compare the result of this function to null, as opposed to checking for truthy/falsey outputs? For example, in this case could we instead write:\n\n\n    if (VError.findCauseByName(err, \u0027ObjectNotFoundError\u0027)) {\n        ..."},{"file":"lib/common.js","line":475,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I have generally found the use of truthy-ness and falsey-ness in JavaScript to be a source of many subtle issues that escape review, so I generally avoid them.  This is also a bit of a hold-over from cstyle, where the recommendation is to always use boolean expressions in conditionals.\n\nThe use of findCauseByName like this is admittedly a bit of a mouthful, and I\u0027ve also found it to be surprisingly easy to flip the sense of what you meant when used as a boolean.  What about adding a \"VError.hasCauseWithName(err, name)\"?"},{"file":"lib/common.js","line":475,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I like the idea of having a Verror.hasCauseWithName function. It would make reading error handling easier to parse."},{"file":"lib/errors.js","line":604,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is the order we are checking for different causes here is deliberate?\n\nGiven that: \n\n(1) This function seems generic (and not just for error handling from moray) \n(2) The order in which we are checking for different error causes is changing in this diff\n(3) It is theoretically possible for multiple of these errors to occur in an error chain (though I\u0027m not sure if it would ever happen)\n\n\nIt might be nice to document this with a comment either way."},{"file":"lib/errors.js","line":604,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"My expectation was that the order doesn\u0027t matter because these error cases do not overlap.  I\u0027m not sure I can prove that, but based on what they represent, I don\u0027t expect that they could happen at the same time.  Besides that, the old code only dealt with one level of cause, which suggests that if it was cognizant of the possibility of overlapping error cases, it was pretty implicit about it.\n\nThat said, in trying to convince myself that the new code does exactly the same thing, I realized that it actually doesn\u0027t: in particular, in the old code, the \"err\" that we pass to the ResourceNotFoundError and RequestedRangeNotSatisfiableError constructors might be the *cause* of the err that was passed to this function.  But in the new code, it\u0027s the error passed to this function.  That\u0027s good for logging, but it could break things.  And indeed, the RequestedRangeNotSatisfiableError constructor in this file does look for properties hanging off the error it was given, so it will break things to give it a different one.\n\nI will rework this code to more closely resemble the original code.  Thanks for catching this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/dir.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-24},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/picker.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":25,"sizeDeletions":-30},{"number":"2","revision":"ecbf9f19cc49d6538dc53a3d094d1a4719a2332e","parents":["599e0207f2de153321f580b66f69c5e8b6527ff8"],"ref":"refs/changes/01/901/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1479327200,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"SUBM","value":"1","grantedOn":1479491637,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479327256,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479337291,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479337291,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479460442,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479460442,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/dir.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":25,"deletions":-29},{"file":"lib/medusa/connector.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/obj.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/picker.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":37,"sizeDeletions":-35}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}]}