{"project":"joyent/registrar","branch":"master","topic":"3232","id":"I17031daa030463ebb5607aadbe6004a0c995fab8","number":"2933","subject":"MANTA-3232 Undeploy without disruption - electric-moray","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2933","commitMessage":"MANTA-3232 Undeploy without disruption - electric-moray\n","createdOn":1510276625,"lastUpdated":1516401087,"open":true,"status":"NEW","comments":[{"timestamp":1510276625,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1510276649,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510276864,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1510276875,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Topic set to 3232"},{"timestamp":1510276887,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512686668,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1512750704,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(6 comments)\n\nLooks good! Just a few small things."},{"timestamp":1513017037,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1513017048,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1513017072,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513039330,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\nThe more I think about this, the more I\u0027m convinced that it would be good to rebase this change on the move of registrar over node-zkstream since that version of registrar performs fewer unnecessary retries and uses cueball to notice when a zookeeper connection has gone down. I\u0027ve added the changes that would be necessary to make quiescing work there, but am waiting on approval."},{"timestamp":1513624475,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Code-Review+1\n\nSounds good! Let me know when you\u0027re able to rebase on top of the pending node-zkstream change"},{"timestamp":1516303632,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\nGiven the version of zookeeper that we\u0027re running has a bug that makes it difficult to use node-zkstream in registrar in the way we want, I think it might be worth revisiting this CR as the option for quiescing electric moray until I can either come up with a workaround for that issue or we upgrade zookeeper."},{"timestamp":1516401087,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 4: Patch Set 3 was rebased"}],"currentPatchSet":{"number":"4","revision":"261fbaa2f6b3010fc1bee0831966cda8390b48ae","parents":["f0ea512aa6160616d3cce9e5a68c7acde2ca8fab"],"ref":"refs/changes/33/2933/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516401087,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513017072,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513624475,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":33,"deletions":-1},{"file":"smf/manifests/registrar.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"f7a101159b2329bd8db085f45efe8b2b379c038f","parents":["2c4b9a7db6b9a215e0fcd2ff6f16bde701673812"],"ref":"refs/changes/33/2933/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510276625,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510276649,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":36,"deletions":0},{"file":"smf/manifests/registrar.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":37,"sizeDeletions":-1},{"number":"2","revision":"84e9c63e33332c2f621272d480e861ab4f2365f5","parents":["2c4b9a7db6b9a215e0fcd2ff6f16bde701673812"],"ref":"refs/changes/33/2933/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510276864,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510276887,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512686668,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"comments":[{"file":"main.js","line":8,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Wow this is old! Let\u0027s update the copyright!"},{"file":"main.js","line":8,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"main.js","line":17,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Is what we need accessible through the \u0027app\u0027 dependency listed below?"},{"file":"main.js","line":17,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yes"},{"file":"main.js","line":175,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should we use the \u0027/* */\u0027 style block comments?"},{"file":"main.js","line":175,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"main.js","line":182,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I\u0027m trying to think of a case where we register, but registrar isn\u0027t notified that registration occurred. I can\u0027t think of anything reasonable (a network issue that only messes with one way traffic?), so I think it\u0027s fine to wait until the \u0027register\u0027 event."},{"file":"main.js","line":182,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"This event fires when registrar completes the \u0027register\u0027 pipeline successfully, which is the best indication we have that the ephemeral nodes are in zookeeper. I believe any sort of network issue we might experience would manifest itself as an error return ed to the pipeline callback."},{"file":"main.js","line":186,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"We\u0027re using \u0027SIGTERM\u0027 here but \u0027sigterm\u0027 in the other log statements."},{"file":"main.js","line":186,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"main.js","line":200,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"What do you think about having these two log messages be at a non-debug level? Would it be useful to see the error message if we fail to unregister? I see in the \u0027unregister\u0027 listener below we are logging at the \u0027warn\u0027 level."},{"file":"main.js","line":200,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think you\u0027re right. Done."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"smf/manifests/registrar.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":35,"sizeDeletions":-1},{"number":"3","revision":"17031daa030463ebb5607aadbe6004a0c995fab8","parents":["2c4b9a7db6b9a215e0fcd2ff6f16bde701673812"],"ref":"refs/changes/33/2933/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513017048,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513017072,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513624475,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":33,"deletions":-1},{"file":"smf/manifests/registrar.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-2},{"number":"4","revision":"261fbaa2f6b3010fc1bee0831966cda8390b48ae","parents":["f0ea512aa6160616d3cce9e5a68c7acde2ca8fab"],"ref":"refs/changes/33/2933/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516401087,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513017072,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513624475,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":33,"deletions":-1},{"file":"smf/manifests/registrar.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}