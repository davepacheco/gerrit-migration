commit 84e9c63e33332c2f621272d480e861ab4f2365f5 (refs/changes/33/2933/2)
Author: Jan Wyszynski <jan.wyszynski@joyent.com>
Date:   2017-11-10T01:20:23+00:00 (1 year, 11 months ago)
    
    MANTA-3232 Undeploy without disruption - electric-moray

diff --git a/main.js b/main.js
index 3f9b4b3..3c46e14 100644
--- a/main.js
+++ b/main.js
@@ -14,6 +14,7 @@ var assert = require('assert-plus');
 var bunyan = require('bunyan');
 var clone = require('clone');
 var dashdash = require('dashdash');
+var register = require('./lib/register');
 
 var app = require('./lib');
 
@@ -171,6 +172,39 @@ function usage(help, msg) {
             LOG.error(err, 'registrar: unexpected error');
         });
 
+        // Once the register event is triggered, we know that the service will
+        // appear in binder. The SIGTERM signal is sent from the smf stop method
+        // of registrar to trigger an immediate removal from DNS. This is useful
+        // for undeploying services without disruption. If the stop method is
+        // executed before registrar can register, the process will just
+        // terminate. This is fine because the corresponding service hasn't been
+        // added to zookeeper yet.
+        eventStream.once('register', function (nodes) {
+            process.on('SIGTERM', function () {
+                opts.log.info({
+                    znodes: nodes
+                }, 'unregistering nodes upon SIGTERM receipt');
+                var unopts = {
+                    log: opts.log,
+                    zk: opts.zk,
+                    znodes: nodes
+                };
+                // This is not perfect because it's possible that the smf stop
+                // method is invoked right after registrar failed a health
+                // check, in which case we would unregister nodes that are
+                // already gone.
+                register.unregister(unopts, function (err) {
+                    if (err) {
+                        opts.log.debug(err, 'unregister failure on sigterm');
+                    } else {
+                        opts.log.debug('unregistered nodes on sigterm, ' +
+                            'terminating');
+                    }
+                    process.exit(0);
+                });
+            });
+        });
+
         eventStream.on('register', function (nodes) {
             LOG.info({
                 znodes: nodes
diff --git a/smf/manifests/registrar.xml.in b/smf/manifests/registrar.xml.in
index f1b76f5..ff9638b 100644
--- a/smf/manifests/registrar.xml.in
+++ b/smf/manifests/registrar.xml.in
@@ -66,7 +66,7 @@
 
 	<exec_method type="method"
 		     name="stop"
-		     exec=":kill"
+		     exec=":kill -TERM"
 		     timeout_seconds="30" />
 
 
