From 17031daa030463ebb5607aadbe6004a0c995fab8 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Mon, 23 Oct 2017 23:52:34 +0000
Subject: [PATCH] MANTA-3232 Undeploy without disruption - electric-moray

---
 main.js                        | 34 +++++++++++++++++++++++++++++++++-
 smf/manifests/registrar.xml.in |  2 +-
 2 files changed, 34 insertions(+), 2 deletions(-)

diff --git a/main.js b/main.js
index 3f9b4b3..b273859 100644
--- a/main.js
+++ b/main.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 var fs = require('fs');
@@ -171,6 +171,38 @@ function usage(help, msg) {
             LOG.error(err, 'registrar: unexpected error');
         });
 
+        /*
+         * Receiving a 'register' event is an indication that registrar
+         * successfully create ephemeral nodes representing the SAPI instance
+         * running in this zone.
+         *
+         * At this point, we register a signal handler that proactively removes
+         * those ephemeral nodes. This is a best effort approach. If removing
+         * the nodes fails for whatever reason, they will drop out of DNS after
+         * the session that those nodes were associated with expires.
+         */
+        eventStream.once('register', function (nodes) {
+            process.on('SIGTERM', function () {
+                opts.log.info({
+                    znodes: nodes
+                }, 'unregistering nodes upon SIGTERM receipt');
+                var unopts = {
+                    log: opts.log,
+                    zk: opts.zk,
+                    znodes: nodes
+                };
+                app.unregister(unopts, function (err) {
+                    if (err) {
+                        opts.log.warn(err, 'unregister failure on SIGTERM');
+                    } else {
+                        opts.log.warn('unregistered nodes on SIGTERM, ' +
+                            'terminating');
+                    }
+                    process.exit(0);
+                });
+            });
+        });
+
         eventStream.on('register', function (nodes) {
             LOG.info({
                 znodes: nodes
diff --git a/smf/manifests/registrar.xml.in b/smf/manifests/registrar.xml.in
index f1b76f5..ff9638b 100644
--- a/smf/manifests/registrar.xml.in
+++ b/smf/manifests/registrar.xml.in
@@ -66,7 +66,7 @@
 
 	<exec_method type="method"
 		     name="stop"
-		     exec=":kill"
+		     exec=":kill -TERM"
 		     timeout_seconds="30" />
 
 
-- 
2.21.0

