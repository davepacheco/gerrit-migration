From c213a3e2923750112e4104f71541c6900f618e71 Mon Sep 17 00:00:00 2001
From: Nick Zivkovic <nick.zivkovic@joyent.com>
Date: Fri, 3 Aug 2018 19:15:51 +0000
Subject: [PATCH] Revert "TRITON-313 walk back sdcadm steps export sugar"

This reverts commit 907506a17ede0bd75831585f170d55234b71972a.
---
 lib/cli/do_add_new_agent_svcs.js              |  2 +-
 lib/cli/do_create.js                          |  6 +--
 lib/cli/do_fix_core_vm_resolvers.js           |  4 +-
 lib/cli/do_update_agents.js                   |  4 +-
 lib/cli/do_update_other.js                    |  6 +--
 lib/post-setup/cmon.js                        |  2 +-
 lib/post-setup/cns.js                         |  2 +-
 lib/post-setup/docker.js                      |  4 +-
 lib/post-setup/ha-binder.js                   | 14 +++----
 lib/post-setup/ha-manatee.js                  |  2 +-
 lib/post-setup/volapi.js                      |  2 +-
 lib/procedures/create-service-instance-v1.js  |  2 +-
 lib/procedures/update-agent-v1.js             |  2 +-
 lib/procedures/update-manatee-v2.js           |  2 +-
 lib/steps/README.md                           | 10 +++--
 lib/steps/index.js                            | 37 +++++++++++++------
 lib/steps/{noRabbit.js => no-rabbit.js}       |  0
 lib/steps/sapi.js                             | 14 +++----
 lib/steps/servers.js                          | 16 ++++----
 .../{updateVmSize.js => update_vm_size.js}    |  0
 20 files changed, 75 insertions(+), 56 deletions(-)
 rename lib/steps/{noRabbit.js => no-rabbit.js} (100%)
 rename lib/steps/{updateVmSize.js => update_vm_size.js} (100%)

diff --git a/lib/cli/do_add_new_agent_svcs.js b/lib/cli/do_add_new_agent_svcs.js
index fba2923..9742a89 100644
--- a/lib/cli/do_add_new_agent_svcs.js
+++ b/lib/cli/do_add_new_agent_svcs.js
@@ -18,7 +18,7 @@ function do_add_new_agent_svcs(_subcmd, _opts, _args, cb) {
         'Warning: "sdcadm experimental add-new-agent-svcs" is deprecated.');
     console.error('Use "sdcadm experimental update-other" or');
     console.error('"sdcadm experimental update-agents".\n');
-    steps.sapi.ensureAgentServices({
+    steps.sapiEnsureAgentServices({
         progress: this.progress,
         sdcadm: this.sdcadm,
         log: this.log
diff --git a/lib/cli/do_create.js b/lib/cli/do_create.js
index 2e49664..5fa7065 100644
--- a/lib/cli/do_create.js
+++ b/lib/cli/do_create.js
@@ -94,9 +94,9 @@ Create.prototype.execute = function cExecute(opts, args, cb) {
             });
         },
 
-        steps.servers.serversFromServerNames, // ctx.serverNames -> ctx.servers
-        steps.servers.ensureServersSetup,
-        steps.servers.ensureServersRunning,
+        steps.serversServersFromServerNames, // ctx.serverNames -> ctx.servers
+        steps.serversEnsureServersSetup,
+        steps.serversEnsureServersRunning,
 
         function getSvcs(_, next) {
             self.sdcadm.getServices({}, function (err, svcs_) {
diff --git a/lib/cli/do_fix_core_vm_resolvers.js b/lib/cli/do_fix_core_vm_resolvers.js
index 040915c..8bab208 100644
--- a/lib/cli/do_fix_core_vm_resolvers.js
+++ b/lib/cli/do_fix_core_vm_resolvers.js
@@ -28,7 +28,7 @@ function do_fix_core_vm_resolvers(subcmd, opts, args, cb) {
         return;
     }
 
-    steps.binder.checkCoreVmInstancesResolvers({
+    steps.checkCoreVmInstancesResolvers({
         sdcadm: self.sdcadm,
         progress: progress,
         log: log,
@@ -53,7 +53,7 @@ function do_fix_core_vm_resolvers(subcmd, opts, args, cb) {
             return;
         }
 
-        steps.binder.updateCoreVmsResolvers({
+        steps.updateCoreVmsResolvers({
             sdcadm: self.sdcadm,
             progress: progress,
             log: log,
diff --git a/lib/cli/do_update_agents.js b/lib/cli/do_update_agents.js
index df8e90e..7653bf0 100644
--- a/lib/cli/do_update_agents.js
+++ b/lib/cli/do_update_agents.js
@@ -533,7 +533,7 @@ UpdateAgents.prototype.exec = function exec(callback) {
             });
         },
 
-        steps.sapi.ensureAgentServices,
+        steps.sapiEnsureAgentServices,
         self._stepDownloadAgentsshar.bind(self),
 
         function copyFileToAssetsDir(_, next) {
@@ -889,7 +889,7 @@ UpdateAgents.prototype.exec = function exec(callback) {
             });
         },
 
-        steps.noRabbit.noRabbitEnable
+        steps.noRabbitEnable
 
     ]}, function finishUpdateAgents(err) {
         if (err === true) { // early abort signal
diff --git a/lib/cli/do_update_other.js b/lib/cli/do_update_other.js
index c9e4c25..826d42a 100644
--- a/lib/cli/do_update_other.js
+++ b/lib/cli/do_update_other.js
@@ -136,7 +136,7 @@ function do_update_other(subcmd, opts, args, cb) {
                 return;
             }
 
-            steps.noRabbit.noRabbitEnable(ctx, next);
+            steps.noRabbitEnable(ctx, next);
         },
 
         function getServices(ctx, next) {
@@ -611,7 +611,7 @@ function do_update_other(subcmd, opts, args, cb) {
                 func: function updateSizeParametersOne(svcName, done) {
                     assert.object(ctx.svcFromName[svcName]);
 
-                    steps.updateVmSize.updateSizeParameters({
+                    steps.updateSizeParameters({
                         progress: progress,
                         service: ctx.svcFromName[svcName],
                         log: self.log,
@@ -833,7 +833,7 @@ function do_update_other(subcmd, opts, args, cb) {
             });
         },
 
-        steps.sapi.ensureAgentServices,
+        steps.sapiEnsureAgentServices,
 
         /*
          * Previously CloudAPI configuration did not include an external
diff --git a/lib/post-setup/cmon.js b/lib/post-setup/cmon.js
index 0fa9e6b..a3f5fb4 100644
--- a/lib/post-setup/cmon.js
+++ b/lib/post-setup/cmon.js
@@ -81,7 +81,7 @@ function do_cmon(subcmd, opts, args, cb) {
     };
 
     vasync.pipeline({arg: context, funcs: [
-        steps.sapi.assertFullMode,
+        steps.sapiAssertFullMode,
         function ensureSdcApp(_, next) {
             self.sdcadm.ensureSdcApp({}, next);
         },
diff --git a/lib/post-setup/cns.js b/lib/post-setup/cns.js
index 7c6ff42..b409492 100644
--- a/lib/post-setup/cns.js
+++ b/lib/post-setup/cns.js
@@ -71,7 +71,7 @@ function do_cns(subcmd, opts, args, cb) {
         didSomething: false
     };
     vasync.pipeline({arg: context, funcs: [
-        steps.sapi.assertFullMode,
+        steps.sapiAssertFullMode,
         function ensureSdcApp(_, next) {
             self.sdcadm.ensureSdcApp({}, next);
         },
diff --git a/lib/post-setup/docker.js b/lib/post-setup/docker.js
index 158f043..0dd708c 100644
--- a/lib/post-setup/docker.js
+++ b/lib/post-setup/docker.js
@@ -77,7 +77,7 @@ function do_docker(subcmd, opts, args, cb) {
         urConnection: null
     };
     vasync.pipeline({arg: context, funcs: [
-        steps.sapi.assertFullMode,
+        steps.sapiAssertFullMode,
         function ensureSdcApp(_, next) {
             self.sdcadm.ensureSdcApp({}, next);
         },
@@ -113,7 +113,7 @@ function do_docker(subcmd, opts, args, cb) {
          * SDC Docker usage means biting the bullet and switching to the
          * "new" agents (cn-agent, vm-agent, net-agent) via the "no_rabbit"
          */
-        steps.noRabbit.noRabbitEnable,
+        steps.noRabbitEnable,
 
         function getDockerSvc(ctx, next) {
             self.sdcadm.sapi.listServices({
diff --git a/lib/post-setup/ha-binder.js b/lib/post-setup/ha-binder.js
index 9dec9e2..7c15b26 100644
--- a/lib/post-setup/ha-binder.js
+++ b/lib/post-setup/ha-binder.js
@@ -417,7 +417,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
                 next();
                 return;
             }
-            steps.zookeeper.getCoreZkConfig(commonOpts, function (err, zkCtx) {
+            steps.getCoreZkConfig(commonOpts, function (err, zkCtx) {
                 if (err) {
                     next(err);
                     return;
@@ -483,7 +483,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
                 next();
                 return;
             }
-            steps.zookeeper.backupZKData(Object.assign({
+            steps.backupZKData(Object.assign({
                 ctx: ctx
             }, commonOpts), function backupCb(err, stamp) {
                 if (err) {
@@ -596,7 +596,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
             vasync.forEachParallel({
                 inputs: newVms,
                 func: function replaceZkData(vm, nextVm) {
-                    steps.zookeeper.replaceZKData(Object.assign({
+                    steps.replaceZKData(Object.assign({
                         vm: vm,
                         stamp: ctx.stamp
                     }, commonOpts), nextVm);
@@ -611,7 +611,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
                 return;
             }
 
-            steps.zookeeper.updateCoreZkConfig(Object.assign({
+            steps.updateCoreZkConfig(Object.assign({
                 ctx: ctx
             }, commonOpts), next);
         },
@@ -621,7 +621,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
                 next();
                 return;
             }
-            steps.zookeeper.clearZKBackup({
+            steps.clearZKBackup({
                 progress: self.progress,
                 vm: vms[0],
                 stamp: ctx.stamp,
@@ -676,7 +676,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
 
         function updateCoreVmsResolvers(ctx, next) {
             self.progress('Updating core SDC VMs resolvers');
-            steps.binder.checkCoreVmInstancesResolvers(Object.assign({
+            steps.checkCoreVmInstancesResolvers(Object.assign({
                 ctx: ctx
             }, commonOpts), function checkResolversCb(err, resolvers) {
                 if (err) {
@@ -691,7 +691,7 @@ function do_ha_binder(subcmd, opts, args, cb) {
                         resolvers[r].expected.join(', '));
                 });
 
-                steps.binder.updateCoreVmsResolvers(Object.assign({
+                steps.updateCoreVmsResolvers(Object.assign({
                     fixableResolvers: resolvers
                 }, commonOpts), next);
             });
diff --git a/lib/post-setup/ha-manatee.js b/lib/post-setup/ha-manatee.js
index 5e1d124..9981ff7 100644
--- a/lib/post-setup/ha-manatee.js
+++ b/lib/post-setup/ha-manatee.js
@@ -234,7 +234,7 @@ function do_ha_manatee(subcmd, opts, args, cb) {
              * Before we reconfigure Manatee, make sure any updates to the
              * service and instance parameters have been applied.
              */
-            steps.updateVmSize.updateSizeParameters({
+            steps.updateSizeParameters({
                 progress: self.progress,
                 service: svc,
                 log: self.log,
diff --git a/lib/post-setup/volapi.js b/lib/post-setup/volapi.js
index 2172b97..470d602 100644
--- a/lib/post-setup/volapi.js
+++ b/lib/post-setup/volapi.js
@@ -160,7 +160,7 @@ function do_volapi(subcmd, opts, args, cb) {
     var VOLAPI_DOMAIN;
 
     vasync.pipeline({arg: context, funcs: [
-        steps.sapi.assertFullMode,
+        steps.sapiAssertFullMode,
         function ensureSdcApp(_, next) {
             self.sdcadm.ensureSdcApp({}, next);
         },
diff --git a/lib/procedures/create-service-instance-v1.js b/lib/procedures/create-service-instance-v1.js
index b6c3506..974d3f5 100644
--- a/lib/procedures/create-service-instance-v1.js
+++ b/lib/procedures/create-service-instance-v1.js
@@ -103,7 +103,7 @@ CreateServiceInstanceV1.prototype.execute = function csiv1Execute(opts, cb) {
                     next();
                     return;
                 }
-                steps.sapi.fixInstanceAlias({
+                steps.sapiFixInstanceAlias({
                     sdcadm: sdcadm,
                     instances: ctx.instances
                 }, function fixInstCb(fixInstErr, fixedInsts) {
diff --git a/lib/procedures/update-agent-v1.js b/lib/procedures/update-agent-v1.js
index e611040..e4abf16 100644
--- a/lib/procedures/update-agent-v1.js
+++ b/lib/procedures/update-agent-v1.js
@@ -243,7 +243,7 @@ UpdateAgentV1.prototype.execute = function uaExecute(opts, callback) {
                 });
             },
 
-            steps.noRabbit.noRabbitEnable,
+            steps.noRabbitEnable,
 
             function updateAgentOnServers(_, next) {
                 if (process.stderr.isTTY) {
diff --git a/lib/procedures/update-manatee-v2.js b/lib/procedures/update-manatee-v2.js
index 523b553..1044b96 100644
--- a/lib/procedures/update-manatee-v2.js
+++ b/lib/procedures/update-manatee-v2.js
@@ -436,7 +436,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
              * been increased to an appropriate minimum size before updating.
              */
             function updateManateeSizeParameters(_, next) {
-                steps.updateVmSize.updateSizeParameters({
+                steps.updateSizeParameters({
                     progress: progress,
                     service: change.service,
                     log: log,
diff --git a/lib/steps/README.md b/lib/steps/README.md
index b28ecba..520e70c 100644
--- a/lib/steps/README.md
+++ b/lib/steps/README.md
@@ -42,16 +42,20 @@ usage can be:
 
     // ...
     vasync.pipeline({arg: contextArg, funcs: [
-        steps.widget.doACommonThing,
-        steps.widget.doAnotherCommonThing,
+        steps.widgetDoACommonThing,
+        steps.widgetDoAnotherCommonThing,
         function aStepSpecificToHere(arg, next) {
             // ...
         },
-        steps.wuzzle.finishWithThisCommonThing
+        steps.wuzzleFinishWithThisCommonThing
     ]}, function (err) {
         // ...
     });
 
+Naming: Each step file is a "namespace". All exported functions should be
+prefixed with that namespace. Name the file 'like-this.js' with all its
+functions name `likeThisFoo` and `likeThisBarBling`.
+
 
 # TODO
 
diff --git a/lib/steps/index.js b/lib/steps/index.js
index cc6cd7b..dbcb9a5 100644
--- a/lib/steps/index.js
+++ b/lib/steps/index.js
@@ -5,25 +5,40 @@
  */
 
 /*
- * Copyright (c) 2018 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  */
 
 /*
  * The collection of "step" functions. Re-usable chunks of sdcadm code.
  * See the "README.md".
  */
-'use strict';
+
+var format = require('util').format;
+
+
 
 // --- exports
 
-module.exports = {
-    dnsdomain: require('./dnsdomain'),
-    noRabbit: require('./noRabbit'),
-    sapi: require('./sapi'),
-    servers: require('./servers'),
-    updateVmSize: require('./updateVmSize'),
-    usbkey: require('./usbkey'),
-    zookeeper: require('./zookeeper')
-};
+module.exports = {};
+
+[
+    'no-rabbit',
+    'update_vm_size',
+    'sapi',
+    'servers',
+    'binder',
+    'zookeeper',
+    'dnsdomain'
+].forEach(function (modName) {
+    var mod = require('./' + modName);
+    Object.keys(mod).forEach(function (symbol) {
+        if (module.exports.hasOwnProperty(symbol)) {
+            throw new Error(format('duplicate symbol in steps/%s.js: %s',
+                modName, symbol));
+        }
+        module.exports[symbol] = mod[symbol];
+    });
+});
+module.exports.usbkey = require('./usbkey');
 
 // vim: set softtabstop=4 shiftwidth=4:
diff --git a/lib/steps/noRabbit.js b/lib/steps/no-rabbit.js
similarity index 100%
rename from lib/steps/noRabbit.js
rename to lib/steps/no-rabbit.js
diff --git a/lib/steps/sapi.js b/lib/steps/sapi.js
index e655dad..2cc3d50 100644
--- a/lib/steps/sapi.js
+++ b/lib/steps/sapi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018 Joyent, Inc.
+ * Copyright 2018 Joyent, Inc.
  *
  * Steps for doing some things with SAPI.
  */
@@ -28,7 +28,7 @@ var DRY_RUN = false; // An off-switch for dev/testing.
  * marlin agent.
  *
  */
-function ensureAgentServices(arg, cb) {
+function sapiEnsureAgentServices(arg, cb) {
     assert.object(arg, 'arg');
     assert.func(arg.progress, 'arg.progress');
     assert.object(arg.log, 'arg.log');
@@ -248,7 +248,7 @@ function ensureAgentServices(arg, cb) {
 }
 
 
-function assertFullMode(arg, cb) {
+function sapiAssertFullMode(arg, cb) {
     assert.object(arg, 'arg');
     assert.object(arg.sdcadm, 'arg.sdcadm');
     assert.func(cb, 'cb');
@@ -281,7 +281,7 @@ function assertFullMode(arg, cb) {
  * @param {Function} cb: Callback of the form f(err, instances);
  */
 
-function fixInstanceAlias(arg, cb) {
+function sapiFixInstanceAlias(arg, cb) {
     assert.object(arg, 'arg');
     assert.object(arg.sdcadm, 'arg.sdcadm');
     assert.array(arg.instances, 'arg.instances');
@@ -350,9 +350,9 @@ function fixInstanceAlias(arg, cb) {
 // --- exports
 
 module.exports = {
-    ensureAgentServices: ensureAgentServices,
-    assertFullMode: assertFullMode,
-    fixInstanceAlias: fixInstanceAlias
+    sapiEnsureAgentServices: sapiEnsureAgentServices,
+    sapiAssertFullMode: sapiAssertFullMode,
+    sapiFixInstanceAlias: sapiFixInstanceAlias
 };
 
 // vim: set softtabstop=4 shiftwidth=4:
diff --git a/lib/steps/servers.js b/lib/steps/servers.js
index 1ff673d..b04951e 100644
--- a/lib/steps/servers.js
+++ b/lib/steps/servers.js
@@ -59,7 +59,7 @@ function _cnapiServerFromName(args, cb) {
  * `args.serverName` and sets `args.server` to the CNAPI server object,
  * or errors (via `cb(err)`).
  */
-function serverFromServerName(args, cb) {
+function serversServerFromServerName(args, cb) {
     assert.object(args, 'args');
     assert.object(args.log, 'args.log');
     assert.object(args.sdcadm, 'args.sdcadm');
@@ -83,7 +83,7 @@ function serverFromServerName(args, cb) {
  * `args.serverNames` and sets `args.servers` to the CNAPI server
  * objects, or errors (via `cb(err)`).
  */
-function serversFromServerNames(args, cb) {
+function serversServersFromServerNames(args, cb) {
     assert.object(args, 'args');
     assert.object(args.log, 'args.log');
     assert.object(args.sdcadm, 'args.sdcadm');
@@ -124,7 +124,7 @@ function serversFromServerNames(args, cb) {
  * A function appropriate for `vasync.pipeline` funcs that iterates through
  * `args.servers` and errors if any of them are not setup.
  */
-function ensureServersSetup(args, cb) {
+function serversEnsureServersSetup(args, cb) {
     assert.object(args, 'args');
     assert.object(args.log, 'args.log');
     assert.arrayOfObject(args.servers, 'args.servers');
@@ -148,7 +148,7 @@ function ensureServersSetup(args, cb) {
  * A function appropriate for `vasync.pipeline` funcs that iterates through
  * `args.servers` and errors if any of them are not running.
  */
-function ensureServersRunning(args, cb) {
+function serversEnsureServersRunning(args, cb) {
     assert.object(args, 'args');
     assert.object(args.log, 'args.log');
     assert.arrayOfObject(args.servers, 'args.servers');
@@ -171,10 +171,10 @@ function ensureServersRunning(args, cb) {
 // --- exports
 
 module.exports = {
-    serverFromServerName: serverFromServerName,
-    serversFromServerNames: serversFromServerNames,
-    ensureServersSetup: ensureServersSetup,
-    ensureServersRunning: ensureServersRunning
+    serversServerFromServerName: serversServerFromServerName,
+    serversServersFromServerNames: serversServersFromServerNames,
+    serversEnsureServersSetup: serversEnsureServersSetup,
+    serversEnsureServersRunning: serversEnsureServersRunning
 };
 
 // vim: set softtabstop=4 shiftwidth=4:
diff --git a/lib/steps/updateVmSize.js b/lib/steps/update_vm_size.js
similarity index 100%
rename from lib/steps/updateVmSize.js
rename to lib/steps/update_vm_size.js
-- 
2.21.0

