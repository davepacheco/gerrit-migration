From c180f9d210be8dd3a10da5b98827d7986a3985b5 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Fri, 9 Aug 2019 10:30:27 +0100
Subject: [PATCH] TOOLS-2247 move sdcnode to manta Reviewed by: Trent Mick
 <trentm@gmail.com> Approved by: Trent Mick <trentm@gmail.com>

---
 Makefile          |  29 +++--------
 tools/upload-bits | 127 ----------------------------------------------
 2 files changed, 8 insertions(+), 148 deletions(-)
 delete mode 100755 tools/upload-bits

diff --git a/Makefile b/Makefile
index 7fb23cb..ae9e2b0 100644
--- a/Makefile
+++ b/Makefile
@@ -12,7 +12,10 @@
 # sdcnode makefile
 #
 
-NAME=sdcnode
+HOST_IMAGE=$(shell pfexec mdata-get sdc:image_uuid)
+
+# Use HOST_IMAGE as the $(NAME) so that we can reuse eng.git's bits-upload
+NAME=$(HOST_IMAGE)
 
 ENGBLD_REQUIRE := $(shell git submodule update --init deps/eng)
 include ./deps/eng/tools/mk/Makefile.defs
@@ -23,14 +26,13 @@ include ./deps/eng/tools/mk/Makefile.defs
 CLEAN_FILES += build/nodes bits
 DISTCLEAN_FILES += build
 
-HOST_IMAGE=$(shell mdata-get sdc:image_uuid)
-
+ENGBLD_DEST_OUT_PATH ?= /public/releng/sdcnode
 
 #
 # Repo-specific targets
 #
 .PHONY: all
-all: build/src nodes bits
+all: build/src nodes publish
 
 build/src:
 	git clone https://github.com/nodejs/node.git build/src
@@ -44,25 +46,10 @@ nodesrc: | build/src
 nodes: nodesrc
 	./tools/build-all-nodes $(TOP)/build/nodes $(STAMP) "this.image=='$(HOST_IMAGE)'"
 
-.PHONY: bits
-bits:
+.PHONY: publish
+publish: prepublish
 	rm -rf $(TOP)/bits
 	mkdir -p $(TOP)/bits/sdcnode
 	cp $(TOP)/build/nodes/*/sdcnode-*.tgz $(TOP)/bits/sdcnode
 
-# Upload bits to $UPLOAD_LOCATION/...
-.PHONY: upload
-upload:
-	[[ -n "$(UPLOAD_LOCATION)" ]] || (echo "error: UPLOAD_LOCATION is not defined" >&2 ; exit 1)
-	./tools/upload-bits "$(BRANCH)" "" "$(TIMESTAMP)" $(UPLOAD_LOCATION)/sdcnode/$(HOST_IMAGE)
-
-.PHONY: dumpvar
-dumpvar:
-	@if [[ -z "$(VAR)" ]]; then \
-		echo "error: set 'VAR' to dump a var"; \
-		exit 1; \
-	fi
-	@echo "$(VAR) is '$($(VAR))'"
-
-
 include ./deps/eng/tools/mk/Makefile.targ
diff --git a/tools/upload-bits b/tools/upload-bits
deleted file mode 100755
index 6a7623c..0000000
--- a/tools/upload-bits
+++ /dev/null
@@ -1,127 +0,0 @@
-#!/bin/bash
-# vi: expandtab sw=4 ts=4
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-#
-# Upload the sdcnode bits in a pattern somewhat conforming to the "BITS_DIR"
-# layout spec'd by mountain-gorilla (MG).
-#
-
-if [ "$TRACE" != "" ]; then
-    export PS4='${BASH_SOURCE}:${LINENO}: '
-    set -o xtrace
-fi
-set -o errexit
-
-
-
-#---- config, globals
-
-TOP=$(cd $(dirname $0)/../; pwd)
-BITS_DIR=bits
-
-SSH_OPTIONS="-q -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
-SCP="scp $SSH_OPTIONS"
-SSH="ssh $SSH_OPTIONS"
-
-
-
-#---- internal support functions
-
-function fatal {
-    echo "$(basename $0): error: $1"
-    exit 1
-}
-
-
-function errexit {
-    [[ $1 -ne 0 ]] || exit 0
-    fatal "error exit status $1 at line $2"
-}
-
-
-function print_help() {
-    echo "Usage:"
-    echo "  ./tools/upload-bits BRANCH TRY-BRANCH TIMESTAMP UPLOAD-BASE-DIR"
-    echo ""
-    echo "Upload bits. The UPLOAD-BASE-DIR is presumed to be a remote dir "
-    echo "(i.e. user@host:path). 'TRY-BRANCH' is often empty. An MG build"
-    echo "can be configured with '-B TRY-BRANCH' to use a feature branch"
-    echo "for those constituent repos that have that branch. If there is"
-    echo "'TRY-BRANCH', this will be used as the upload dir in favour of"
-    echo "'BRANCH'."
-    echo ""
-    echo "Options:"
-    echo "  -h           Print this help and exit."
-    echo ""
-    echo "Examples:"
-    echo "  ./tool/upload-bits release-20110922 \"\" 20110927T143319Z bits@bits.joyent.us:builds"
-    exit 0
-}
-
-
-
-
-#---- mainline
-
-trap 'errexit $? $LINENO' EXIT
-
-while getopts "hrf:" opt; do
-    case $opt in
-        h) print_help ;;
-        ?) fatal "unknown option: $opt" ;;
-    esac
-    shift $((OPTIND-1))
-done
-
-BRANCH=$1
-TRY_BRANCH=$2
-TIMESTAMP=$3
-UPLOAD_BASE_DIR=$4
-
-UPLOAD_SERVER=$(echo "$UPLOAD_BASE_DIR" | awk -F: '{print $1}')
-UPLOAD_BASE_LOCALDIR=$(echo "$UPLOAD_BASE_DIR" | awk -F: '{print $2}')
-UPLOAD_BRANCH=$TRY_BRANCH
-if [[ -z "$UPLOAD_BRANCH" ]]; then
-    UPLOAD_BRANCH=$BRANCH
-fi
-
-# Determine the upload dir. If there is already a "$UPLOAD_BRANCH-$TIMESTAMP"
-# dir, then we append a "-N" serial number.
-existing_upload_dirs=$($SSH $UPLOAD_SERVER ls -d $UPLOAD_BASE_LOCALDIR/$UPLOAD_BRANCH-$TIMESTAMP* $UPLOAD_BASE_LOCALDIR/.$UPLOAD_BRANCH-$TIMESTAMP* 2>/dev/null || true)
-last_upload_dir=$(echo $existing_upload_dirs | tail -1)
-if [[ -z "$last_upload_dir" ]]; then
-    upload_subdir=$UPLOAD_BRANCH-$TIMESTAMP
-else
-    serial=$(echo $last_upload_dir | awk -F- '{print $NF}')
-    if [[ "${serial:(-1)}" == "Z" ]]; then
-        next_serial=2
-    else
-        next_serial=$(( $serial + 1 ))
-    fi
-    upload_subdir=$UPLOAD_BRANCH-$TIMESTAMP-$next_serial
-fi
-
-# Upload to '.'-prefixed dir to hide it until fully uploaded.
-echo "Uploading bits to <$UPLOAD_SERVER:$UPLOAD_BASE_LOCALDIR/$upload_subdir/>."
-(cd ${BITS_DIR}/ && md5sum $(find ./ -type f) > md5sums.txt)
-($SSH $UPLOAD_SERVER "mkdir -p ${UPLOAD_BASE_LOCALDIR}/.${upload_subdir}/" || /bin/true)
-rsync -e "$SSH" -av $BITS_DIR/ $UPLOAD_SERVER:$UPLOAD_BASE_LOCALDIR/.$upload_subdir/
-
-# Unhide and add a "$UPLOAD_BRANCH-$latest" symlink.
-$SSH $UPLOAD_SERVER mv $UPLOAD_BASE_LOCALDIR/.$upload_subdir/ $UPLOAD_BASE_LOCALDIR/$upload_subdir/
-$SSH $UPLOAD_SERVER "(cd $UPLOAD_BASE_LOCALDIR && rm -f $UPLOAD_BRANCH-latest && ln -s $upload_subdir $UPLOAD_BRANCH-latest)"
-
-
-# Special convenience note for bits.joyent.us.
-if [[ "$UPLOAD_SERVER" == "bits@bits.joyent.us" ]]; then
-    echo "Uploaded to <https://bits.joyent.us/$UPLOAD_BASE_LOCALDIR/$upload_subdir/>."
-fi
-- 
2.21.0

