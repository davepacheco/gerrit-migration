{"project":"joyent/sdcadm","branch":"master","id":"Ice1a11398f25900f22969d1f9a2140de31693ece","number":"5183","subject":"TRITON-904 Needs some useful enhancements for \"sdcadm experimental update-agents\". TRITON-912 Agentshar update does not check for an ongoing agent update before running another agent installation. Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Tr","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/5183","commitMessage":"TRITON-904 Needs some useful enhancements for \"sdcadm experimental update-agents\".\nTRITON-912 Agentshar update does not check for an ongoing agent update before running another agent installation.\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1543904054,"lastUpdated":1544570791,"open":false,"status":"MERGED","comments":[{"timestamp":1543904054,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1543904055,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit dde1054c98726938e231f2f2c2b808d80cd72085\n    \n    first pass at TRITON-904 improvements"},{"timestamp":1543904100,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543904219,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1543904220,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit e74ff48360aa5368c637ad5ff9d159bfa50025e6\n    \n    fix rebase\n    \n    commit 32fe3432f8e1ae65fdad30fb7b6097848c76e226\n    \n    first pass at TRITON-904 improvements"},{"timestamp":1543904259,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543983605,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1543983607,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit e4b7b6e582bed543735cf06a551f8dfb513fa77d\n    \n    changelog should include both tickets"},{"timestamp":1543983649,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544466748,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(12 comments)"},{"timestamp":1544482390,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1544487938,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1544487940,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit eb0aa6903fdac6f861f7e418b1964f314554ef69\n    \n    address review feedback"},{"timestamp":1544487993,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544488010,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1544489459,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\n(2 comments)"},{"timestamp":1544499508,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1544499509,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 6837e4448ba19bb06759db81c8116bc036dcf36f\n    \n    new bug"},{"timestamp":1544499542,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544500429,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1544550925,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1544570791,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"6","revision":"a8f160099b30626405a8013f11809cdfb722f53e","parents":["7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5"],"ref":"refs/changes/83/5183/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1544500429,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544499542,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544550925,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544550925,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1544570791,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":377,"deletions":-71},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":426,"sizeDeletions":-81},"patchSets":[{"number":"1","revision":"297eed91d839cfbd53eaff4c14cd61270298d705","parents":["f5be82edf7f9222374b218d1ecdb86bcead3de8f"],"ref":"refs/changes/83/5183/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1543904054,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543904100,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":386,"deletions":-69},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":426,"sizeDeletions":-78},{"number":"2","revision":"9e06b28ce86fb684491c632b1a3a98513c40d76f","parents":["7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5"],"ref":"refs/changes/83/5183/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1543904219,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543904259,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":386,"deletions":-69},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":426,"sizeDeletions":-78},{"number":"3","revision":"56c157f84e090a586be6dd9c363da8d1ee2802b7","parents":["7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5"],"ref":"refs/changes/83/5183/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1543983605,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543983649,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli/do_update_agents.js","line":97,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could drop this arrayification (see comment below where the \u0027exclude\u0027 option is added)."},{"file":"lib/cli/do_update_agents.js","line":97,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Sure. I made the mistake of copying other existing sdcadm code here (lib/cli/index.js). I\u0027ll do it your way instead."},{"file":"lib/cli/do_update_agents.js","line":356,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I expected the next line to being with \"their shit and\""},{"file":"lib/cli/do_update_agents.js","line":356,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I could change it..."},{"file":"lib/cli/do_update_agents.js","line":363,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"wow. TIL. Where do you learn these things?"},{"file":"lib/cli/do_update_agents.js","line":363,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Not the local library sadly."},{"file":"lib/cli/do_update_agents.js","line":365,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"also TIL"},{"file":"lib/cli/do_update_agents.js","line":591,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m debating whether we *should* support having \u0027sdcadm ex update-agents\u0027 proceed if Ur contact fails for any of the specified servers. Shouldn\u0027t that just error out? If Ur is down on one of the servers, either the operator should `-x HOST`-exclude it, or they should dig in and find why that server\u0027s Ur is not responding.\n\nThoughts?\n\nI guess there is the confirmation step below. The operator gets the choose at that point if the \"warnings\" shown from discovery should be ignored."},{"file":"lib/cli/do_update_agents.js","line":591,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I guess we could push back on this one, but this was one of the original requests in the ticket (TRITON-904). Number 1 in fact. And a request which seemed reasonable to me. I don\u0027t have a strong opinion here except about the fact that there are no good options so long as we\u0027re using Ur.\n\nTo me the fact that we\u0027re doing this discovery first is an unfortunate consequence of the fact that rabbitmq is a complete black hole the way we\u0027re using it. Even doing this discovery first causes problems, as it leaves us with a very large race here in that you could do the discovery (which just broadcasts asking all available nodes to send their sysinfo) and find a node is offline, but when you went to send an actual request it might be fine. Alternatively it might respond just fine to this sysinfo broadcast but then hang until timeout at the next request we make directly. With the current defaults, this race is open for many minutes or even hours. I think the only way to fix this is to not use a mechanism into which you write requests and then cross your fingers. Instead we should use a mechanism through which you get feedback on whether the request was received and then whether the execution occurred or not.\n\nThe discovery may decrease the chances of failure due to timeout, but that\u0027s about all it buys us here.\n\nMy expectation was that with this change the Operator would run the update see the list of nodes that failed discovery and decide whether or not to proceed from there. If they chose to proceed, they would get a list of failures at the end and then review that list (if any failed) and decide either to fix the problems with the failed nodes and re-run the same command again (which is idempotent), or just make a note of the failures if the failures were non-repairable. I don\u0027t understand the benefit of forcing them instead to run a different command where they exclude a list of broken servers explicitly. Is there some advantage to that which I\u0027m missing?"},{"file":"lib/cli/do_update_agents.js","line":591,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"WFM, i.e. keep it the way you have it. Thanks for the details."},{"file":"lib/cli/do_update_agents.js","line":649,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Party pooper."},{"file":"lib/cli/do_update_agents.js","line":693,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Wow, lame that we had this backwards."},{"file":"lib/cli/do_update_agents.js","line":903,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Do you think it would be overkill to have a force option of some kind on `sdcadm ex update-agents ...` to override this? Rather than having to go find and delete a file on the target server. I\u0027m fine crossing that road only if we need to."},{"file":"lib/cli/do_update_agents.js","line":903,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"That sounds a bit like overkill to me. But if you want to create a separate ticket for that, I could do this if you really want it. I don\u0027t think it\u0027s necessary for this change though."},{"file":"lib/cli/do_update_agents.js","line":903,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Okay, cool. And don\u0027t bother with the additional ticket."},{"file":"lib/cli/do_update_agents.js","line":906,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Isn\u0027t this test redundant? Line 903 already checked this."},{"file":"lib/cli/do_update_agents.js","line":906,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yeah, I guess it is! Thanks!"},{"file":"lib/cli/do_update_agents.js","line":906,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I figured out this should have been .post."},{"file":"lib/cli/do_update_agents.js","line":1047,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"IIUC, I suppose all this processing of `results` here *could* just be handled in _onCompletion above, but it is fine here."},{"file":"lib/cli/do_update_agents.js","line":1359,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Totally not obvious, but sdcadm adds a dashdash type called \u0027arrayOfCommaSepString\u0027 that you can use. It will do the arrayification of comma-separated items for you.\n\nIt is defined here: https://github.com/joyent/sdcadm/blob/7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5/lib/cli/index.js#L46-L68 FWIW"},{"file":"lib/cli/do_update_agents.js","line":1359,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Ok, I\u0027ll look into that. Thanks."},{"file":"lib/ur.js","line":15,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"... because it is poor code? or because sdcadm (and anything in Triton) should no longer use Ur at all?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":386,"deletions":-69},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":427,"sizeDeletions":-78},{"number":"4","revision":"4c42cbeb7ef00199318ca1fe062b481dba608fbe","parents":["7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5"],"ref":"refs/changes/83/5183/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1544487938,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544487993,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544489459,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544489459,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":374,"deletions":-69},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":423,"sizeDeletions":-79},{"number":"5","revision":"ce1a11398f25900f22969d1f9a2140de31693ece","parents":["7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5"],"ref":"refs/changes/83/5183/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1544499508,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544499542,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":377,"deletions":-71},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":426,"sizeDeletions":-81},{"number":"6","revision":"a8f160099b30626405a8013f11809cdfb722f53e","parents":["7f46252ff5317a97b4f6a3073c95ea7b5a87f1f5"],"ref":"refs/changes/83/5183/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1544500429,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544499542,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544550925,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544550925,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1544570791,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_agents.js","type":"MODIFIED","insertions":377,"deletions":-71},{"file":"lib/common.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/ur.js","type":"MODIFIED","insertions":29,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":426,"sizeDeletions":-81}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}