From 112bc5d2d7fbfc572af09ad8a6ea273dfa08cf91 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 29 Apr 2019 12:47:34 -0700
Subject: [PATCH] TRITON-1639 migration failing to provision to a valid server

---
 lib/workflows/vm-migration/begin.js | 3 ++-
 package.json                        | 2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/lib/workflows/vm-migration/begin.js b/lib/workflows/vm-migration/begin.js
index dc9ecf1..693a250 100644
--- a/lib/workflows/vm-migration/begin.js
+++ b/lib/workflows/vm-migration/begin.js
@@ -338,7 +338,8 @@ function allocateServer(job, cb) {
 
     // Make sure our VM is placed on a CN away from the old VM.
     job.vmPayload.locality = {
-        far: job.vmPayload.server_uuid
+        far: job.params.vm.uuid,
+        strict: true
     };
 
     // The vmPayload must use vm.vm_uuid (not sure why it's different), anyway,
diff --git a/package.json b/package.json
index 6c30939..f74d152 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.8.3",
+  "version": "9.8.4",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

