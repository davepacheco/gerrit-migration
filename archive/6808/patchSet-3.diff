commit ba1137597018ab44125dea118a18aba5a4ad827d
Author: Tim Foster <tim.foster@joyent.com>
Date:   2019-08-20T11:15:29+01:00 (7 weeks ago)
    
    MANTA-2769 manta-init should be channel aware
    MANTA-4159 manta-init should have an option to specify an image version substring

diff --git a/cmd/manta-init.js b/cmd/manta-init.js
index d6bd7cf..b2dc321 100755
--- a/cmd/manta-init.js
+++ b/cmd/manta-init.js
@@ -7,7 +7,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -53,6 +53,15 @@ var CONCURRENCY = 10;
 optimist.usage('Usage:\tmanta-init -e <email>');
 
 var ARGV = optimist.options({
+	'B': {
+		alias: 'branch',
+		describe: 'the branch substring to use when looking for images',
+		default: ''
+	},
+	'C': {
+		alias: 'channel',
+		describe: 'the channel to use'
+	},
 	'c': {
 		alias: 'concurrent_downloads',
 		describe: 'number of concurrent image downloads (default: 10)'
@@ -217,17 +226,24 @@ function findLatestImage(service, cb) {
 	var log = self.log;
 
 	var image_name = services.serviceNameToImageName(service);
-	var version_substr = 'master';
+	var version_substr = ARGV.branch;
+	var channel = ARGV.channel;
 
-	log.info('finding image %s (version substr "%s") for service %s',
-	    image_name, version_substr, service);
+	log.info('finding image %s for service %s on channel "%s"',
+	    image_name, service, channel);
 
 	var onSearchFinish = function (err, image) {
 		if (err) {
 			log.error(err);
 			return (cb(err));
 		}
-
+		if (image === undefined) {
+			var msg = sprintf(
+			    'Unable to find image %s for %s on channel "%s"',
+			    image_name, service, channel);
+			log.error(msg);
+			return (cb(new Error(msg)));
+		}
 		log.info({ image: image }, 'found image %s for %s',
 		    image_name, service);
 
@@ -236,7 +252,7 @@ function findLatestImage(service, cb) {
 
 	/*
 	 * If -n is used, find the most recent image which is installed in
-	 * this datacenter's IMGAPI.
+	 * this datacenter's IMGAPI, assuming it matches our version_substr.
 	 */
 	if (ARGV.n) {
 		return (findLatestLocalImage(
@@ -245,7 +261,12 @@ function findLatestImage(service, cb) {
 
 	var filters = {};
 	filters.name = image_name;
-	filters.version = '~' + version_substr;
+	if (version_substr.length > 0) {
+		log.info('search restricted to version substring: %s',
+		    version_substr);
+		filters.version = '~' + version_substr;
+	}
+	filters.channel = channel;
 	log.info({ filters: filters }, 'search for images');
 
 	remote_imgapi.listImages(filters, function (err, images) {
@@ -263,12 +284,15 @@ function findLatestLocalImage(image_name, version_substr, cb) {
 	var imgapi = self.IMGAPI;
 	var log = self.log;
 
-	log.info('search for image %s (version substr "%s") restricted ' +
-	    'to local images', image_name, version_substr);
+	log.info('search for image %s restricted to local images', image_name);
 
 	var filters = {};
 	filters.name = image_name;
-	filters.version = '~' + version_substr;
+	if (version_substr.length > 0) {
+		log.info('search restricted to version substring: %s',
+		    version_substr);
+		filters.version = '~' + version_substr;
+	}
 
 	imgapi.listImages(filters, function (err, images) {
 		if (err) {
@@ -396,6 +420,11 @@ if (typeof (ARGV.c) == 'number' && ARGV.c > 0 && ARGV.c < 128 &&
 	usage('unsupported value for "-c" option ' +
 	    '(must be a positive integer less than 128)');
 }
+// let the user pass an empty string to indicate they do not want
+// version-filtering.
+if (typeof (ARGV.branch) == 'boolean') {
+	ARGV.branch = '';
+}
 
 var pipelineFuncs = [
 	function verifyArgs(_, cb) {
@@ -698,6 +727,26 @@ var pipelineFuncs = [
 		});
 	},
 
+	function determineDefaultChannel(_, cb) {
+		var log = self.log;
+		// If the user passed a -C argument, then we're done
+		if (ARGV.channel !== undefined) {
+			return (cb(null));
+		}
+
+		log.info('determining update_channel from sapi');
+		common.getSdcChannel.call(self,
+			POSEIDON.owner_uuid, function (err, channel) {
+			if (!err) {
+				ARGV.channel = channel;
+				return (cb(null));
+			}
+			log.error(
+			    err, 'failed to determine sdc update_channel');
+			return (cb(err));
+		});
+	},
+
 	function findLatestImages(ctx, cb) {
 		var log = self.log;
 
diff --git a/docs/man/man1/manta-init.md b/docs/man/man1/manta-init.md
index 82f82e9..92b9452 100644
--- a/docs/man/man1/manta-init.md
+++ b/docs/man/man1/manta-init.md
@@ -1,4 +1,4 @@
-# MANTA-INIT 1 "2016" Manta "Manta Operator Commands"
+# MANTA-INIT 1 "2019" Manta "Manta Operator Commands"
 
 ## NAME
 
@@ -24,6 +24,19 @@ run this command except as documented in the Manta Operator's Guide.**
 
 ## OPTIONS
 
+`-B, --branch BRANCH`
+  Specifies a substring which must be present in the version string of the
+  images to be downloaded. The default for this value is the empty string,
+  which means that the latest images on the given channel are used, regardless
+  of their branch.
+
+`-C, --channel CHANNEL`
+  Specifies the updates.joyent.com channel from which images should be
+  downloaded unless `-n` is used. By default, this value is set to the current
+  value of `update_channel` in this data-center, obtained from the `sdc`
+  application in SAPI. Use the `sdcadm channel` command to view or change
+  the default value.
+
 `-c, --concurrent_downloads N`
   Specifies that no more than `N` zone images should be downloaded
   concurrently.
@@ -71,7 +84,7 @@ Non-zero
 
 ## COPYRIGHT
 
-Copyright (c) 2016 Joyent Inc.
+Copyright 2019 Joyent, Inc.
 
 ## SEE ALSO
 
diff --git a/lib/common.js b/lib/common.js
index a2659ea..af51611 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -937,6 +937,36 @@ function getServerNicTags(cb) {
 	});
 }
 
+function getSdcChannel(owner_uuid, cb) {
+	if (typeof (owner_uuid) === 'function') {
+		cb = owner_uuid;
+		owner_uuid = undefined;
+	}
+	var sapi = this.SAPI;
+	var log = this.log;
+
+	var search = {};
+	search.name = 'sdc';
+	if (owner_uuid) {
+		search.owner_uuid = owner_uuid;
+	}
+
+	search.include_master = true;
+
+	sapi.listApplications(search, function (err, apps) {
+		if (err) {
+			log.error(err, 'failed to list applications');
+			return (cb(err));
+		}
+
+		log.debug({ app: apps[0] }, 'found sdc application');
+
+		assert.ok(apps.length <= 1);
+
+		return (cb(null, apps[0].metadata.update_channel));
+	});
+}
+
 exports.shuffle = shuffle;
 exports.domainToPath = domainToPath;
 exports.initSdcClients = initSdcClients;
@@ -953,3 +983,4 @@ exports.sortObjectsByProps = sortObjectsByProps;
 exports.fmtDuration = fmtDuration;
 exports.updateNetworkUsers = updateNetworkUsers;
 exports.getServerNicTags = getServerNicTags;
+exports.getSdcChannel = getSdcChannel;
