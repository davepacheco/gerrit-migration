From ebd3de82ea489e689728a85e8c2603bdbdff544d Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 15 Oct 2019 22:47:52 +0000
Subject: [PATCH] MANTA-3101 mako nginx logs can be uploaded under wrong path

---
 boot/setup.sh | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/boot/setup.sh b/boot/setup.sh
index 0355f3d..a25b135 100644
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -7,7 +7,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 set -o xtrace
@@ -129,11 +129,10 @@ function manta_setup_nginx {
 
     logadm -w mako_logs -C 48 -p 1h \
         -t '/var/log/manta/upload/$basename_$nodename_%FT%H:00:00.log' \
-        -a 'pkill -USR1 -ox nginx; cd /var/log/manta/upload; mv mako-error* $(ls mako-error* | sed "s/\.log_/_/"); mv mako-access* $(ls mako-access* | sed "s/\.log_/_/")' \
+        -a 'pkill -USR1 -ox nginx; cd /var/log/manta/upload; for file in mako-error.log_* mako-access.log_*; do mv "$file" "${file/.log_/_}"; done' \
         '/var/log/mako-{access,error}.log'
 }
 
-
 function manta_setup_crons {
     local crontab=/tmp/.manta_mako_cron
     crontab -l > $crontab
-- 
2.17.2 (Apple Git-113)

