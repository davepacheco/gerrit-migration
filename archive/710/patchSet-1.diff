From 79d70af8e6efc941a5514e32f55ec129fba7da85 Mon Sep 17 00:00:00 2001
From: David Pacheco <dap@joyent.com>
Date: Mon, 17 Oct 2016 10:10:14 -0700
Subject: [PATCH] MANTA-3006 marlin should adopt moray v2

---
 common/lib/bus.js    | 4 ++--
 common/lib/marlin.js | 4 ++--
 dev/package.json     | 2 +-
 package.json         | 2 +-
 4 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/common/lib/bus.js b/common/lib/bus.js
index d4fc16c..843fe16 100644
--- a/common/lib/bus.js
+++ b/common/lib/bus.js
@@ -277,9 +277,9 @@ MorayBus.prototype.connect = function ()
 	    'host': this.mb_host,
 	    'port': this.mb_port,
 	    'log': this.mb_log.child({ 'component': 'moray' }),
-	    'reconnect': true,
 	    'retry': this.mb_reconnect,
-	    'dns': this.mb_dns
+	    'dns': this.mb_dns,
+	    'unwrapErrors': true
 	});
 
 	client.on('error', function (err) {
diff --git a/common/lib/marlin.js b/common/lib/marlin.js
index bd2b07d..ffff647 100644
--- a/common/lib/marlin.js
+++ b/common/lib/marlin.js
@@ -227,8 +227,8 @@ function MarlinApi(args)
 	    'host': url['hostname'],
 	    'port': parseInt(url['port'], 10),
 	    'log': args['log'].child({'component': 'moray'}),
-	    'reconnect': true,
-	    'retry': conf['moray']['retry']
+	    'retry': conf['moray']['retry'],
+	    'unwrapErrors': true
 	});
 
 	this.ma_client.on('close', this.emit.bind(this, 'close'));
diff --git a/dev/package.json b/dev/package.json
index 77f8469..a15ad63 100644
--- a/dev/package.json
+++ b/dev/package.json
@@ -32,7 +32,7 @@
 		"manta-compute-bin": "git+https://github.com/joyent/manta-compute-bin.git#master",
 		"memorystream": "0.2.0",
 		"mkdirp": "0.3.1",
-		"moray": "git+https://github.com/joyent/node-moray.git#fd5781bc25a9bfe2ba82167664639753fb9f0ca5",
+		"moray": "^2.0.0",
 		"native-dns": "0.2.1",
 		"node-uuid": "1.4.0",
 		"panic": "0.2.1",
diff --git a/package.json b/package.json
index 84bdc51..88e7c0f 100644
--- a/package.json
+++ b/package.json
@@ -22,7 +22,7 @@
 		"jsprim": "0.5.0",
 		"lstream": "0.0.3",
 		"mahi": "git+https://github.com/joyent/node-mahi.git#master",
-		"moray": "git+https://github.com/joyent/node-moray.git#fd5781bc25a9bfe2ba82167664639753fb9f0ca5",
+		"moray": "^2.0.0",
 		"node-uuid": "1.4.0",
 		"posix-getopt": "1.0.0",
 		"retry": "0.6.0",
-- 
2.21.0

