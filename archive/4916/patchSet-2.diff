From b73403854ddb43c117e65620dd9b15bcf6d1f844 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Tue, 2 Oct 2018 23:08:23 +0000
Subject: [PATCH] joyent/node-cueball#149 planRebalance should take an
 preference-ordered array of backend keys

---
 lib/pool.js  |  4 ++--
 lib/set.js   |  3 ++-
 lib/utils.js | 11 +++++++----
 3 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/lib/pool.js b/lib/pool.js
index effa229..91601bb 100644
--- a/lib/pool.js
+++ b/lib/pool.js
@@ -580,8 +580,8 @@ CueBallConnectionPool.prototype._rebalance = function () {
 	if (target > this.p_max)
 		target = this.p_max;
 
-	var plan = mod_utils.planRebalance(conns, self.p_dead, target,
-	    self.p_max);
+	var plan = mod_utils.planRebalance(conns, self.p_keys, self.p_dead,
+	    target, self.p_max);
 
 	if (plan.remove.length > 0 || plan.add.length > 0) {
 		this.p_log.trace('rebalancing pool, remove %d, ' +
diff --git a/lib/set.js b/lib/set.js
index 06a98d4..b1f0d1f 100644
--- a/lib/set.js
+++ b/lib/set.js
@@ -404,7 +404,8 @@ CueBallConnectionSet.prototype._rebalance = function () {
 	});
 
 	var plan = mod_utils.planRebalance(
-	    conns, this.cs_dead, this.cs_target, this.cs_max, true);
+	    conns, this.cs_keys, this.cs_dead, this.cs_target, this.cs_max,
+	    true);
 
 	if (plan.remove.length > 0 || plan.add.length > 0) {
 		this.cs_log.trace('rebalancing cset, remove %d, ' +
diff --git a/lib/utils.js b/lib/utils.js
index 35247e4..270d801 100644
--- a/lib/utils.js
+++ b/lib/utils.js
@@ -220,8 +220,10 @@ function shuffle(array) {
  * - `remove` -- Array of Object, connections to be closed
  *
  * Parameters:
- * - `connections` -- an Object, map of String (backend id) to Array of Object
- *                    (connections), list of currently open connections
+ * - `inSpares` -- an Object, map of String (backend id) to Array of Object
+ *                 (connections), list of currently open connections
+ * - `backendKeys` -- an Array, containing keys ordered by decreasing
+ *                    preference
  * - `dead` -- an Object, map of String (backend id) to Boolean, true when a
  *             a given backend is declared dead
  * - `target` -- a Number, target number of connections we want to have
@@ -229,18 +231,19 @@ function shuffle(array) {
  * - `singleton` -- optional Boolean (default false), create only a single
  *                  connection per distinct backend. used for Sets.
  */
-function planRebalance(inSpares, dead, target, max, singleton) {
+function planRebalance(inSpares, backendKeys, dead, target, max, singleton) {
 	var replacements = 0;
 	var wantedSpares = {};
 
 	mod_assert.object(inSpares, 'connections');
+	mod_assert.arrayOfString(backendKeys, 'backendKeys');
 	mod_assert.number(target, 'target');
 	mod_assert.number(max, 'max');
 
 	mod_assert.ok(target >= 0, 'target must be >= 0');
 	mod_assert.ok(max >= target, 'max must be >= target');
 
-	var keys = Object.keys(inSpares);
+	var keys = backendKeys.slice();
 
 	var plan = { add: [], remove: [] };
 
-- 
2.21.0

