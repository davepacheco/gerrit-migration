From 1c46b283c74cbc70b650147aa668168486731b9a Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 12 Jun 2018 09:49:43 -0700
Subject: [PATCH] =?UTF-8?q?TRITON-494=20drop=20(mostly)=20unused=20object?=
 =?UTF-8?q?=5Fcaches=20in=20SAPI=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n?=
 =?UTF-8?q?=20Candel=20<pedro@joyent.com>=20Approved=20by:=20Pedro=20Palaz?=
 =?UTF-8?q?=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/server/stor/moray.js | 57 +++++++---------------------------------
 1 file changed, 9 insertions(+), 48 deletions(-)

diff --git a/lib/server/stor/moray.js b/lib/server/stor/moray.js
index 516c921..775db3e 100644
--- a/lib/server/stor/moray.js
+++ b/lib/server/stor/moray.js
@@ -9,7 +9,7 @@
  */
 
 /*
- * lib/server/stor/moray.js: moray interface
+ * Storage/DB interface to Moray.
  */
 
 var mod_net = require('net');
@@ -17,12 +17,11 @@ var mod_net = require('net');
 var async = require('async');
 var assert = require('assert-plus');
 var jsprim = require('jsprim');
-var LRU = require('lru-cache');
 var moray = require('moray');
 var morayFilter = require('moray-filter');
 var once = require('once');
 var vasync = require('vasync');
-var verror = require('verror');
+var VError = require('verror');
 
 var mod_errors = require('../errors');
 
@@ -124,14 +123,6 @@ MorayStorage.prototype.init = function init(cb) {
         init_barrier.start('master_moray');
     }
 
-    if (this.object_caches) {
-        Object.keys(this.object_caches).forEach(function (key) {
-            if (this.object_caches && this.object_caches[key]) {
-                this.object_caches[key].reset();
-            }
-        });
-    }
-
     function setup(tag, client) {
         log.info({ tag: tag, client: client.toString() },
             'moray: setting up');
@@ -246,7 +237,7 @@ function initBuckets(client, cb) {
         },
         function removeHistoryBucket(subcb) {
             client.getBucket('sapi_history', function getBucketCb(err) {
-                if (err && verror.hasCauseWithName(err,
+                if (err && VError.hasCauseWithName(err,
                     'BucketNotFoundError')) {
                     subcb();
                     return;
@@ -283,7 +274,7 @@ function createBucket(client, name, cfg, cb) {
             return;
         }
 
-        if (err && !verror.hasCauseWithName(err, 'BucketNotFoundError')) {
+        if (err && !VError.hasCauseWithName(err, 'BucketNotFoundError')) {
             log.error(err, 'failed to get bucket %s', name);
             cb(err);
             return;
@@ -300,15 +291,6 @@ function createBucket(client, name, cfg, cb) {
             log.info({ client: client.toString() },
                 'moray: create bucket %s', name);
 
-            if (!self.object_caches)
-                self.object_caches = {};
-
-            self.object_caches[name] = LRU({
-                max: 1000,
-                maxAge: 15 * 1000,  /* 15 seconds */
-                length: function () { return (1); }
-            });
-
             cb();
         });
     });
@@ -359,11 +341,6 @@ function putObject(bucket, uuid, obj, opts, cb) {
         record.value = obj;
         record.etag = res.etag;
 
-        if (self.object_caches && self.object_caches[bucket]) {
-            log.debug('adding object %s to cache', uuid);
-            self.object_caches[bucket].set(uuid, record);
-        }
-
         cb(null);
     });
 }
@@ -375,14 +352,6 @@ MorayStorage.prototype.getObject = function getObject(bucket, uuid, cb) {
     assert.string(uuid, 'uuid');
     assert.func(cb, 'cb');
 
-    if (this.object_caches && this.object_caches[bucket]) {
-        var obj = this.object_caches[bucket].peek(uuid);
-        if (obj) {
-            log.debug('serving object %s from cache', uuid);
-            return (cb(null, obj));
-        }
-    }
-
     var filter = sprintf('(uuid=%s)', uuid);
 
     /*
@@ -413,26 +382,18 @@ MorayStorage.prototype.delObject = function delObject(bucket, uuid, cb) {
     assert.string(uuid, 'uuid');
     assert.func(cb, 'cb');
 
-    var onFinish = function () {
-        if (self.object_caches && self.object_caches[bucket]) {
-            log.debug('deleting object %s from cache', uuid);
-            self.object_caches[bucket].del(uuid);
-        }
-        cb();
-    };
-
     this.local.delObject(bucket, uuid, function (err) {
-        if (err && !verror.hasCauseWithName(err, 'ObjectNotFoundError')) {
+        if (err && !VError.hasCauseWithName(err, 'ObjectNotFoundError')) {
             cb(err);
             return;
         }
 
         if (!err) {
-            onFinish();
+            cb();
             return;
         }
 
-        assert.ok(err && verror.hasCauseWithName(err, 'ObjectNotFoundError'));
+        assert.ok(err && VError.hasCauseWithName(err, 'ObjectNotFoundError'));
 
         if (!self.master) {
             cb(new mod_errors.ObjectNotFoundError(err.message));
@@ -447,13 +408,13 @@ MorayStorage.prototype.delObject = function delObject(bucket, uuid, cb) {
          */
         self.master.delObject(bucket, uuid, function (suberr) {
             if (suberr &&
-                !verror.hasCauseWithName(suberr, 'ObjectNotFoundError')) {
+                !VError.hasCauseWithName(suberr, 'ObjectNotFoundError')) {
                 cb(suberr);
                 return;
             }
 
             if (!suberr) {
-                onFinish();
+                cb();
                 return;
             }
 
-- 
2.21.0

