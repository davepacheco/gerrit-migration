commit 118fbf4f8fa9497cae252ab90a983c33a210cb82 (refs/changes/49/4149/3)
Author: Brian Bennett <brian.bennett@joyent.com>
Date:   2018-06-07T07:47:12-07:00 (1 year, 4 months ago)
    
    MANATEE-397 `manatee-adm history` fails with `TypeError: Cannot read property 'zoneId' of null` (again)

diff --git a/lib/adm.js b/lib/adm.js
index 92b2636..60feac3 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -1927,6 +1927,17 @@ function annotateHistoryNode(evt, last)
     }
 
     if (nst.generation > lst.generation) {
+        if (lst.sync === null && lst.generation == 0 &&
+            lst.oneNodeWriteMode !== true) {
+            /* We seem to have arrived here due to an invalid state on the
+             * previous generation, namely the previous generation is
+             * multi-mode, writable, with no replicas. This should never
+             * happen, but somehow it did. At any rate, it's in the past and
+             * now we don't want `manatee-adm history` to crash.
+             */
+            return (sprintf('upgrade to 2.0, sync "%s" added',
+                nst.sync.zoneId.substr(0, 8)));
+        }
         if (nst.sync.zoneId == lst.sync.zoneId) {
             return ('error: gen number changed, but ' +
                 'primary and sync did not');
