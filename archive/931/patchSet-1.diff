From ad6b6a6c8eaa36d06568c820eac49a16534d021c Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 21 Nov 2016 15:30:23 -0800
Subject: [PATCH] joyent/node-cueball#52 possible for claim() to give out a
 connection that has suddenly died

---
 lib/connection-fsm.js | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/lib/connection-fsm.js b/lib/connection-fsm.js
index 5f778e9..e15d01f 100644
--- a/lib/connection-fsm.js
+++ b/lib/connection-fsm.js
@@ -157,14 +157,17 @@ ConnectionFSM.prototype.claim = function (stack, cb) {
 	    map(function (l) { return (l.replace(/^[ ]*at /, '')); });
 	this.cf_claimed = true;
 	var self = this;
-	this.once('stateChanged', function (st) {
-		if (st === 'busy') {
+	this.on('stateChanged', onStateChanged);
+	function onStateChanged(st) {
+		if (st === 'busy' && self.isInState('busy')) {
+			self.removeListener('stateChanged', onStateChanged);
 			cb(null, self.cf_shadow, self.cf_conn);
-		} else {
+		} else if (st !== 'busy') {
+			self.removeListener('stateChanged', onStateChanged);
 			cb(new Error('Claimed connection entered state ' +
 			    st + ' during claim, instead of "busy"'));
 		}
-	});
+	}
 	this.emit('claimAsserted');
 };
 
-- 
2.21.0

