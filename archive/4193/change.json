{"project":"joyent/node-artedi","branch":"master","id":"I6b16f81d249ccc52a8f5889d80a7bfb5eb59f6f5","number":"4193","subject":"joyent/node-artedi#14 Allow for metrics in a MetricVector to be optionally expired or reset to a default value","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/4193","commitMessage":"joyent/node-artedi#14 Allow for metrics in a MetricVector to be optionally expired or reset to a default value\n","createdOn":1528843140,"lastUpdated":1529076097,"open":false,"status":"MERGED","comments":[{"timestamp":1528843140,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1528843141,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit e39bbe60c7d6edfef616e8a5c76637028dbf8bfc\n    \n    joyent/node-artedi#14 Allow metrics to expired and reset to a default value"},{"timestamp":1528843164,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528905717,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(2 comments)\n\nLooks good! What do you think about restricting this to only be available to Gauge types?"},{"timestamp":1528910846,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\n(2 comments)\n\n\u003e (2 comments)\n \u003e \n \u003e Looks good! What do you think about restricting this to only be\n \u003e available to Gauge types?\n\nIt\u0027s limited to just counters and gauges. I wasn\u0027t sure if it was something we needed for counters as well. I\u0027m happy to limit it to just gauges if you think it\u0027s not necessary for counters."},{"timestamp":1528914283,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(4 comments)\n\nI think it would be nice if we could limit this to just gauges for now. If/when we have a use case that requires us to expire counters we can remove the gate.\n\nAlso, do you mind updating CHANGES.md, the package.json version, docs/API.md, and docs/private_api.md ? Maybe having all of those API docs manually maintained is a bad idea now that I\u0027m thinking about it... :)\n\nIf you wanted to you could also add a blurb to docs/DESIGN.md about the expiring metrics feature, but it\u0027s totally up to you."},{"timestamp":1528920560,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\n\u003e (4 comments)\n \u003e \n \u003e I think it would be nice if we could limit this to just gauges for\n \u003e now. If/when we have a use case that requires us to expire counters\n \u003e we can remove the gate.\n\nOk so my assertion that it was limited to gauges and counters was mistaken. I restricted it to gauges and counters within my pgstatsmon changes. One thing I like about this is that expiry is a property of a Metric and the changes are very general and don\u0027t affect any specialization that uses Metric. I think if we change the common constructor to also accept the type then we can still keep things pretty general and also make it easy to allow other types to make use of expiry in the future with little necessary change."},{"timestamp":1528920736,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\nYeah, I think that\u0027s a good approach. FWIW the entire Gauge/Counter/Histogram object is passed in to the constructor() function and has a .type field that indicates if it\u0027s a gauge/histogram/counter."},{"timestamp":1528994789,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1528994791,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 49b77d5488f467ace49a5ddea1cace43e12979b8\n    \n    joyent/node-artedi#14 Allow metrics to expired and reset to a default value"},{"timestamp":1528994814,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528994996,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\n(3 comments)\n\n\u003e (4 comments)\n \u003e \n \u003e I think it would be nice if we could limit this to just gauges for\n \u003e now. If/when we have a use case that requires us to expire counters\n \u003e we can remove the gate.\n \u003e \n \u003e Also, do you mind updating CHANGES.md, the package.json version,\n \u003e docs/API.md, and docs/private_api.md ? Maybe having all of those\n \u003e API docs manually maintained is a bad idea now that I\u0027m thinking\n \u003e about it... :)\n \u003e \n \u003e If you wanted to you could also add a blurb to docs/DESIGN.md about\n \u003e the expiring metrics feature, but it\u0027s totally up to you.\n\nI updated the changelog and the docs and bumped the version to 1.4.0 as part of patch set 2."},{"timestamp":1529010028,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(6 comments)\n\nThanks Kelly. I think the only question I have is about the \u0027metric-reset\u0027 dtrace probe."},{"timestamp":1529010438,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1529013309,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1529013311,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit ab6fdcc8477435102c3f89c2a99539162405dc28\n    \n    joyent/node-artedi#14 Allow metrics to expired and reset to a default value"},{"timestamp":1529013335,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529075108,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nLooks good to me! Thanks for doing this. Let me know if you\u0027d like to upload a new version to NPM (and add the version tags in GitHub) or if you\u0027d like me to do that for you."},{"timestamp":1529076097,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"3","revision":"6b16f81d249ccc52a8f5889d80a7bfb5eb59f6f5","parents":["b5ddded7169f6cc9d2e8305086b833dc876ba45e"],"ref":"refs/changes/93/4193/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529013309,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529013335,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529075108,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529075108,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1529076097,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/API.md","type":"MODIFIED","insertions":22,"deletions":-2},{"file":"docs/DESIGN.md","type":"MODIFIED","insertions":18,"deletions":0},{"file":"docs/private_api.md","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/metric.js","type":"MODIFIED","insertions":61,"deletions":-1},{"file":"lib/metric_vector.js","type":"MODIFIED","insertions":31,"deletions":-4},{"file":"lib/provider.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":61,"deletions":0}],"sizeInsertions":227,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"b68187b2f82f8900b19cb2264025bb72e1bd7bcf","parents":["b5ddded7169f6cc9d2e8305086b833dc876ba45e"],"ref":"refs/changes/93/4193/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1528843140,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528843164,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":43,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Can we assert somewhere that if the user provides opts.expires \u003d true they also provide expiryPeriod?"},{"file":"lib/common.js","line":43,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"The expiryPeriod is optional. There is a default of 5 minutes if none is specified. I arrived at 5 minutes as the default based on some reading about prometheus using it as its period to determine staleness, but maybe that\u0027s too long for a default?"},{"file":"lib/common.js","line":43,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, I missed that you had it set to 5 minutes by default. Sorry about that. This sounds good to me."},{"file":"lib/metric.js","line":114,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It might be nice to have a dtrace probe here since we\u0027re adjusting the value of the metric."},{"file":"lib/metric.js","line":114,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Good idea. Are you thinking a distinct probe for this or just the metric-set probe?"},{"file":"lib/metric.js","line":114,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think a name like \u0027metric-reset\u0027 is fine."},{"file":"lib/metric.js","line":114,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"},{"file":"test/basic.test.js","line":675,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Can we make the expiry periods for these gauges smaller? I just don\u0027t want these tests to take too long to run."},{"file":"test/basic.test.js","line":675,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"},{"file":"test/basic.test.js","line":710,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"how about 1.5x? That way we don\u0027t have to worry much about the node event loop, but can still be relatively certain the expiration code works well."},{"file":"test/basic.test.js","line":710,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-2},{"file":"lib/metric.js","type":"MODIFIED","insertions":54,"deletions":-1},{"file":"lib/metric_vector.js","type":"MODIFIED","insertions":31,"deletions":-4},{"file":"test/basic.test.js","type":"MODIFIED","insertions":125,"deletions":0}],"sizeInsertions":227,"sizeDeletions":-7},{"number":"2","revision":"eed33ff1da07738aa0460d6e069b9d2bb1c49e8b","parents":["b5ddded7169f6cc9d2e8305086b833dc876ba45e"],"ref":"refs/changes/93/4193/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1528994789,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528994814,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/API.md","line":58,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"If*"},{"file":"docs/API.md","line":58,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I just thought it needed some extra emphasis. ;) Will fix."},{"file":"docs/private_api.md","line":34,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ha! I suppose the Metric class is getting less \u0027simple\u0027 nowadays! :)"},{"file":"docs/private_api.md","line":49,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Thanks for adding this!"},{"file":"lib/common.js","line":35,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I\u0027m guessing this can\u0027t reference the GAUGE constant defined in module.exports because module.exports isn\u0027t referencing a global variable... My mistake."},{"file":"lib/common.js","line":35,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Exactly. I mean I can make it a global constant as part of this if you want."},{"file":"lib/common.js","line":99,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I\u0027m totally face-palming now that I see this is \u0027NOEXISTERROR\u0027 and not \u0027ENOEXIST.\u0027 I have no idea what I was thinking."},{"file":"lib/metric.js","line":114,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"is \u0027this\u0027 defined in this callback\u0027s context as the Metric object?"},{"file":"lib/metric.js","line":114,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Right, that\u0027s why I added the bind call in the setTimeout callback to ensure that this was the right this in this context. :p"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/API.md","type":"MODIFIED","insertions":22,"deletions":-2},{"file":"docs/DESIGN.md","type":"MODIFIED","insertions":18,"deletions":0},{"file":"docs/private_api.md","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/metric.js","type":"MODIFIED","insertions":58,"deletions":-1},{"file":"lib/metric_vector.js","type":"MODIFIED","insertions":31,"deletions":-4},{"file":"lib/provider.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":61,"deletions":0}],"sizeInsertions":224,"sizeDeletions":-12},{"number":"3","revision":"6b16f81d249ccc52a8f5889d80a7bfb5eb59f6f5","parents":["b5ddded7169f6cc9d2e8305086b833dc876ba45e"],"ref":"refs/changes/93/4193/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1529013309,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529013335,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529075108,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529075108,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1529076097,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"docs/API.md","type":"MODIFIED","insertions":22,"deletions":-2},{"file":"docs/DESIGN.md","type":"MODIFIED","insertions":18,"deletions":0},{"file":"docs/private_api.md","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"lib/common.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/metric.js","type":"MODIFIED","insertions":61,"deletions":-1},{"file":"lib/metric_vector.js","type":"MODIFIED","insertions":31,"deletions":-4},{"file":"lib/provider.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":61,"deletions":0}],"sizeInsertions":227,"sizeDeletions":-12}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}