From cb4351164fd716ec029ddb7d431652862d2fc3f6 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Thu, 13 Jun 2019 09:17:11 -0700
Subject: [PATCH] TRITON-1732 instance migration failing with vm state should
 be "running" error

---
 test/lib/migration.js | 25 ++++++++++++++++---------
 1 file changed, 16 insertions(+), 9 deletions(-)

diff --git a/test/lib/migration.js b/test/lib/migration.js
index c505eb3..c6e00a7 100644
--- a/test/lib/migration.js
+++ b/test/lib/migration.js
@@ -257,14 +257,21 @@ function TestMigrationCfg(test, cfg) {
     };
 
     test.user_set_vm_explicitly_disallow_migrations = function (t) {
-        var payload = {
-            internal_metadata: { user_migration_allowed: false }
-        };
-        updateVmAndWait(t, client, sourceVm.uuid, payload,
-            function onUpdateVm(err) {
-                t.ifError(err);
-                t.done();
-            });
+        var payload = {};
+
+        client.get('/vms/' + sourceVm.uuid, function (getErr, req, res, body) {
+            common.ifError(t, getErr, 'VM should appear in vmapi');
+
+            payload.internal_metadata = body.internal_metadata;
+            payload.internal_metadata.user_migration_allowed = false;
+
+            updateVmMetadataAndWait(t, client, sourceVm.uuid, payload,
+                function onUpdateVm(updateErr) {
+                    t.ifError(updateErr);
+                    t.done();
+                });
+        });
+
     };
 
     test.user_check_allow_migration_flag_false = function (t) {
@@ -1547,7 +1554,7 @@ function TestMigrationCfg(test, cfg) {
     };
 }
 
-function updateVmAndWait(t, client, vmUuid, payload, cb) {
+function updateVmMetadataAndWait(t, client, vmUuid, payload, cb) {
     var postOpts = {
         path: format('/vms/%s?action=update', vmUuid)
     };
-- 
2.21.0

