From 8613432c42ea6f7ded84a536600f596088a774d8 Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Wed, 11 Jul 2018 20:31:28 +0000
Subject: [PATCH] MDB sarc walker

---
 .../mdb/common/modules/genunix/Makefile.files |   3 +-
 .../cmd/mdb/common/modules/genunix/genunix.c  |   9 +-
 usr/src/cmd/mdb/common/modules/genunix/sarc.c | 117 ++++++++++++++++++
 usr/src/cmd/mdb/common/modules/genunix/sarc.h |  40 ++++++
 4 files changed, 167 insertions(+), 2 deletions(-)
 create mode 100644 usr/src/cmd/mdb/common/modules/genunix/sarc.c
 create mode 100644 usr/src/cmd/mdb/common/modules/genunix/sarc.h

diff --git a/usr/src/cmd/mdb/common/modules/genunix/Makefile.files b/usr/src/cmd/mdb/common/modules/genunix/Makefile.files
index 5d9cf9bb8f..2ea182e843 100644
--- a/usr/src/cmd/mdb/common/modules/genunix/Makefile.files
+++ b/usr/src/cmd/mdb/common/modules/genunix/Makefile.files
@@ -21,7 +21,7 @@
 #
 # Copyright 2011 Nexenta Systems, Inc.  All rights reserved.
 # Copyright (c) 1999, 2010, Oracle and/or its affiliates. All rights reserved.
-# Copyright 2016 Joyent, Inc.
+# Copyright 2018 Joyent, Inc.
 # Copyright (c) 2013 by Delphix. All rights reserved.
 #
 
@@ -72,6 +72,7 @@ GENUNIX_SRCS =		\
 	nvpair.c	\
 	pg.c		\
 	rctl.c		\
+	sarc.c		\
 	sobj.c		\
 	streams.c	\
 	sysevent.c	\
diff --git a/usr/src/cmd/mdb/common/modules/genunix/genunix.c b/usr/src/cmd/mdb/common/modules/genunix/genunix.c
index 9da3c5eba0..d97ab63c84 100644
--- a/usr/src/cmd/mdb/common/modules/genunix/genunix.c
+++ b/usr/src/cmd/mdb/common/modules/genunix/genunix.c
@@ -21,7 +21,7 @@
 /*
  * Copyright 2011 Nexenta Systems, Inc.  All rights reserved.
  * Copyright (c) 1999, 2010, Oracle and/or its affiliates. All rights reserved.
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  * Copyright (c) 2013 by Delphix. All rights reserved.
  */
 
@@ -97,6 +97,7 @@
 #include "nvpair.h"
 #include "pg.h"
 #include "rctl.h"
+#include "sarc.h"
 #include "sobj.h"
 #include "streams.h"
 #include "sysevent.h"
@@ -4689,6 +4690,12 @@ static const mdb_walker_t walkers[] = {
 	{ "rctl_val", "given a rctl_t, walk all rctl_val entries associated",
 		rctl_val_walk_init, rctl_val_walk_step },
 
+	/*  from sarc.c */
+	{ SARC_WALK_NAME, SARC_WALK_DESC,
+		sarc_walk_init_arc, sarc_walk_step, sarc_walk_fini },
+	{ SARC_WALK_HASH_NAME, SARC_WALK_HASH_DESC,
+		sarc_walk_init_hash, sarc_walk_step, sarc_walk_fini },
+
 	/* from sobj.c */
 	{ "blocked", "walk threads blocked on a given sobj",
 		blocked_walk_init, blocked_walk_step, NULL },
diff --git a/usr/src/cmd/mdb/common/modules/genunix/sarc.c b/usr/src/cmd/mdb/common/modules/genunix/sarc.c
new file mode 100644
index 0000000000..aefc6900c1
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/genunix/sarc.c
@@ -0,0 +1,117 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright 2018, Joyent, Inc.
+ */
+
+#include <mdb/mdb_modapi.h>
+#include <mdb/mdb_ctf.h>
+
+#include <sys/types.h>
+#include <sys/sarc.h>
+#include <sys/sarc_impl.h>
+
+typedef struct sarc_walk_data {
+	size_t	swd_link_off;
+} sarc_walk_data_t;
+
+typedef struct mdb_sarc {
+	size_t sarc_link_off;
+	size_t sarc_nbuckets;
+} mdb_sarc_t;
+
+static int
+sarc_walk_init(mdb_walk_state_t *wsp, boolean_t use_arc)
+{
+	mdb_sarc_t sarc = { 0 };
+	sarc_walk_data_t *swd;
+	uintptr_t base;
+	size_t i, n;
+	ssize_t sarc_list_size;
+	int arc_off, bucket_off, list_off;
+
+	/*  mdb_ctf_offsetof_by_name() will print any errors */
+	arc_off = mdb_ctf_offsetof_by_name("sarc_t", "sarc_list");
+	if (arc_off == -1)
+		return (WALK_ERR);
+
+	bucket_off = mdb_ctf_offsetof_by_name("sarc_t", "sarc_bucket");
+	if (bucket_off == -1)
+		return (WALK_ERR);
+
+	list_off = mdb_ctf_offsetof_by_name("sarc_list_t", "sal_list");
+	if (list_off == -1)
+		return (WALK_ERR);
+
+	sarc_list_size = mdb_ctf_sizeof_by_name("sarc_list_t");
+	if (sarc_list_size == -1)
+		return (WALK_ERR);
+
+	if (mdb_ctf_vread(&sarc, "sarc_t", "mdb_sarc_t", wsp->walk_addr,
+	    0) == -1) {
+		mdb_warn("failed to read sarc_t at %#lx", wsp->walk_addr);
+		return (WALK_ERR);
+	}
+
+	wsp->walk_data = swd = mdb_zalloc(sizeof (*swd), UM_SLEEP);
+
+	swd->swd_link_off = sarc.sarc_link_off;
+
+	if (use_arc) {
+		base = wsp->walk_addr + arc_off;
+		n = SARC_NUM_LISTS;
+	} else {
+		base = wsp->walk_addr + bucket_off;
+		n = sarc.sarc_nbuckets;
+	}
+
+	for (i = 0; i < n; i++) {
+		wsp->walk_addr = base + i * sarc_list_size + list_off;
+
+		if (mdb_layered_walk("list", wsp) == -1) {
+			mdb_warn("can't walk sarc_t");
+			mdb_free(swd, sizeof (*swd));
+			return (WALK_ERR);
+		}
+	}
+
+	return (WALK_NEXT);
+}
+
+int
+sarc_walk_init_arc(mdb_walk_state_t *wsp)
+{
+	return (sarc_walk_init(wsp, B_TRUE));
+}
+
+int
+sarc_walk_init_hash(mdb_walk_state_t *wsp)
+{
+	return (sarc_walk_init(wsp, B_FALSE));
+}
+
+int
+sarc_walk_step(mdb_walk_state_t *wsp)
+{
+	sarc_walk_data_t *swd = wsp->walk_data;
+	uintptr_t addr = wsp->walk_addr - swd->swd_link_off;
+
+	return (wsp->walk_callback(addr, wsp->walk_layer, wsp->walk_cbdata));
+}
+
+void
+sarc_walk_fini(mdb_walk_state_t *wsp)
+{
+	sarc_walk_data_t *swd = wsp->walk_data;
+
+	mdb_free(swd, sizeof (*swd));
+}
diff --git a/usr/src/cmd/mdb/common/modules/genunix/sarc.h b/usr/src/cmd/mdb/common/modules/genunix/sarc.h
new file mode 100644
index 0000000000..2b594f2e4e
--- /dev/null
+++ b/usr/src/cmd/mdb/common/modules/genunix/sarc.h
@@ -0,0 +1,40 @@
+/*
+ * This file and its contents are supplied under the terms of the
+ * Common Development and Distribution License ("CDDL"), version 1.0.
+ * You may only use this file in accordance with the terms of version
+ * 1.0 of the CDDL.
+ *
+ * A full copy of the text of the CDDL should have accompanied this
+ * source.  A copy of the CDDL is also available via the Internet at
+ * http://www.illumos.org/license/CDDL.
+ */
+
+/*
+ * Copyright 2018, Joyent Inc.
+ */
+
+#ifndef _SARC_H
+#define	_SARC_H
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+#define	SARC_WALK_NAME	"sarc"
+#define	SARC_WALK_DESC	"walk a sarc cache"
+
+#define	SARC_WALK_HASH_NAME	"sarc_hash"
+#define	SARC_WALK_HASH_DESC	"walk a sarc cache using the hash buckets"
+
+struct mdb_walk_state;
+
+extern int sarc_walk_init_arc(struct mdb_walk_state *);
+extern int sarc_walk_init_hash(struct mdb_walk_state *);
+extern int sarc_walk_step(struct mdb_walk_state *);
+extern void sarc_walk_fini(struct mdb_walk_state *);
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif /* _SARC_H */
-- 
2.21.0

