From 2957592e50fbdd686b6fab2c826fe381a73e3a84 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 12 Feb 2019 17:13:09 -0800
Subject: [PATCH] TRITON-1224 add "agents_uninstall" task to cn-agents "dummy"
 backend for mockcloud

---
 lib/backends/dummy/index.js                  |  1 +
 lib/backends/dummy/tasks/agents_uninstall.js | 76 ++++++++++++++++++++
 2 files changed, 77 insertions(+)
 create mode 100644 lib/backends/dummy/tasks/agents_uninstall.js

diff --git a/lib/backends/dummy/index.js b/lib/backends/dummy/index.js
index 7f6f5e3..6dbb3e1 100644
--- a/lib/backends/dummy/index.js
+++ b/lib/backends/dummy/index.js
@@ -67,6 +67,7 @@ var queueDefns = [
         maxConcurrent: 1,
         tasks: [
             'agent_install',
+            'agents_uninstall',
             'refresh_agents'
         ]
     },
diff --git a/lib/backends/dummy/tasks/agents_uninstall.js b/lib/backends/dummy/tasks/agents_uninstall.js
new file mode 100644
index 0000000..a6a8462
--- /dev/null
+++ b/lib/backends/dummy/tasks/agents_uninstall.js
@@ -0,0 +1,76 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2019, Joyent, Inc.
+ */
+
+/*
+ * This task uninstalls the named Triton agents on this mock server.
+ *
+ * Params:
+ * - 'agents' - An array of agent names to remove.
+ *
+ * This task will:
+ * - remove SERVER_ROOT/<server_uuid>/agents/<agent> for each named agent
+ * - refresh CNAPI's view of the agents
+ */
+
+var path = require('path');
+
+var assert = require('assert-plus');
+var rimraf = require('rimraf');
+var vasync = require('vasync');
+
+var common = require('../common');
+var shared = require('./shared');
+var Task = require('../../../task_agent/task');
+
+function AgentsUninstallTask(req) {
+    Task.call(this);
+    this.req = req;
+}
+
+Task.createTask(AgentsUninstallTask);
+
+function start() {
+    var self = this;
+
+    assert.arrayOfString(self.req.params.agents, 'self.req.params.agents');
+    assert.object(self.sysinfo, 'self.sysinfo');
+    assert.uuid(self.sysinfo.UUID, 'self.sysinfo.UUID');
+
+    var agents = self.req.params.agents;
+    var agentsDir = path.join(common.SERVER_ROOT, self.sysinfo.UUID, 'agents');
+
+    vasync.forEachPipeline({
+        inputs: agents,
+        func: function rmOneAgent(agent, nextAgent) {
+            var agentDir = path.join(agentsDir, agent);
+            rimraf(agentDir, nextAgent);
+        }
+    }, function onRemoved(rmErr) {
+        if (rmErr) {
+            self.fatal('AgentsUninstallTask error: ' + rmErr.message);
+            return;
+        }
+
+        shared.refreshAgents({
+            log: self.log,
+            serverUuid: self.sysinfo.UUID
+        }, function (refreshErr) {
+            if (refreshErr) {
+                self.fatal('AgentsUninstallTask error: ' + refreshErr.message);
+            } else {
+                self.finish();
+            }
+        });
+    });
+}
+
+AgentsUninstallTask.setStart(start);
+
+module.exports = AgentsUninstallTask;
-- 
2.21.0

