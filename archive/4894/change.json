{"project":"joyent/node-zkstream","branch":"master","id":"I2ed3aa078c2ce7c55333d3443725d9af7e1e2a3a","number":"4894","subject":"joyent/node-zkstream#36 when dead ZKs come back to life, session attaches to wrong connection joyent/node-zkstream#35 auto-test ZK sometimes is slow to start up, leading to test failures Reviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e Approved by: J","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/4894","commitMessage":"joyent/node-zkstream#36 when dead ZKs come back to life, session attaches to wrong connection\njoyent/node-zkstream#35 auto-test ZK sometimes is slow to start up, leading to test failures\nReviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\nApproved by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\n","createdOn":1538162726,"lastUpdated":1548283264,"open":false,"status":"MERGED","comments":[{"timestamp":1538162726,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1538163159,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1538167457,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1538170553,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n fatal: ref HEAD is not a symbolic ref\n deps/javascriptlint/build/install/jsl --nologo --nosummary --conf\u003dtools/jsl.node.conf lib/connection-fsm.js lib/zk-consts.js lib/zk-buffer.js lib/index.js lib/zk-session.js lib/jute-buffer.js lib/errors.js lib/zk-streams.js lib/client.js test/nasty.test.js test/streams.test.js test/multi-node.test.js test/basic.test.js test/zkserver.js\n /tmp/repo/lib/connection-fsm.js\n /tmp/repo/lib/zk-consts.js\n /tmp/repo/lib/zk-buffer.js\n /tmp/repo/lib/index.js\n /tmp/repo/lib/zk-session.js\n /tmp/repo/lib/jute-buffer.js\n /tmp/repo/lib/errors.js\n /tmp/repo/lib/zk-streams.js\n /tmp/repo/lib/client.js\n /tmp/repo/test/nasty.test.js\n /tmp/repo/test/streams.test.js\n /tmp/repo/test/multi-node.test.js\n /tmp/repo/test/basic.test.js\n /tmp/repo/test/zkserver.js\n npm install\n npm WARN deprecated node-uuid@1.4.8: Use uuid module instead\n npm ERR! SunOS 5.11\n npm ERR! argv \"/opt/local/bin/node\" \"/opt/local/bin/npm\" \"install\"\n npm ERR! node v0.10.48\n npm ERR! npm  v2.15.1\n npm ERR! code ETARGET\n \n npm ERR! notarget No compatible version found: cueball@\u0027\u003e\u003d2.9.0 \u003c3.0.0\u0027\n npm ERR! notarget Valid install targets:\n npm ERR! notarget [\"0.1.0\",\"0.2.0\",\"0.2.1\",\"0.2.2\",\"0.2.3\",\"0.2.4\",\"0.2.5\",\"0.2.6\",\"0.3.0\",\"0.3.1\",\"0.3.2\",\"0.3.3\",\"0.3.4\",\"0.3.6\",\"0.3.7\",\"0.3.8\",\"0.3.10\",\"0.3.11\",\"0.3.12\",\"0.4.0\",\"0.4.1\",\"0.5.0\",\"1.0.0\",\"1.0.1\",\"1.0.2\",\"1.0.3\",\"1.1.0\",\"1.1.1\",\"1.1.2\",\"1.1.3\",\"1.1.4\",\"1.1.5\",\"1.1.6\",\"1.1.7\",\"1.1.8\",\"1.1.9\",\"1.2.0\",\"1.2.1\",\"1.2.2\",\"1.2.3\",\"1.2.4\",\"1.3.0\",\"1.3.1\",\"1.3.2\",\"2.0.0\",\"2.0.1\",\"2.1.0\",\"2.1.1\",\"2.2.0\",\"2.2.1\",\"2.2.2\",\"2.2.3\",\"2.2.4\",\"2.2.5\",\"2.2.6\",\"2.2.7\",\"2.2.8\",\"2.2.9\",\"2.3.0\",\"2.4.0\",\"2.5.0\",\"2.5.1\",\"2.5.2\",\"2.6.0\",\"2.7.0\",\"2.7.1\",\"2.8.0\"]\n npm ERR! notarget \n npm ERR! notarget This is most likely not a problem with npm itself.\n npm ERR! notarget In most cases you or one of your dependencies are requesting\n npm ERR! notarget a package version that doesn\u0027t exist.\n npm ERR! notarget \n npm ERR! notarget It was specified as a dependency of \u0027zkstream\u0027\n npm ERR! notarget \n \n npm ERR! Please include the following file with any support request:\n npm ERR!     /tmp/repo/npm-debug.log\n Makefile:48: recipe for target \u0027node_modules/.bin/json\u0027 failed\n gmake: *** [node_modules/.bin/json] Error 1"},{"timestamp":1538519104,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\n(2 comments)\n\nThis looks good, I have a couple of questions."},{"timestamp":1539735411,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544206013,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1544206032,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1544206090,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544206176,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1544211905,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1544211921,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1544211962,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544217996,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1546567474,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1546567532,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1548283195,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 5: Integration-Approval+1\n\nSee latest comment on https://jira.joyent.us/browse/MANTA-3542 registrar testing that uses this change."},{"timestamp":1548283243,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1548283264,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"6","revision":"767208ca5fbf54d107b7567834b91c38bc1964c7","parents":["d781668386e3adb9c1f171bf2c04396e065189d1"],"ref":"refs/changes/94/4894/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1548283243,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544211962,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544217996,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548283195,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"SUBM","value":"1","grantedOn":1548283264,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":18,"deletions":-18}],"sizeInsertions":67,"sizeDeletions":-25},"patchSets":[{"number":"1","revision":"e060bf84df0d4be4943a76f853644fee48fcaaf9","parents":["44d313f9c06dfe573d479b78dd361def419aefa4"],"ref":"refs/changes/94/4894/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1538162726,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1538163159,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/zk-session.js","line":258,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer sid hides an identifier in a parent scope"},{"file":"test/zkserver.js","line":141,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: comparisons against null, 0, true, false, or an empty string allowing implicit type conversion (use \u003d\u003d\u003d or !\u003d\u003d)"},{"file":"test/zkserver.js","line":268,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: cmd"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":17,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":23,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":17,"deletions":-16}],"sizeInsertions":63,"sizeDeletions":-21},{"number":"2","revision":"f27fbb16669e242144eb6eeb31b8760be38b1e91","parents":["44d313f9c06dfe573d479b78dd361def419aefa4"],"ref":"refs/changes/94/4894/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1538167457,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539735411,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":312,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"This returns undefined if the client is not in the \u0027normal\u0027 state. Was this guaranteed to not be called outside of the \u0027normal\u0027 state before? \n\nI guess I\u0027m really asking why you made this change."},{"file":"lib/client.js","line":312,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Well, to be totally honest I made this change because it crashed in testing, heh. If we take a very long time to shut down because of busy client operations, it seems like we can end up calling this and expecting to get undefined rather than crash. I\u0027ve misplaced the stack trace I found at the time though, sorry."},{"file":"lib/zk-session.js","line":6,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I guess we also need to update this, ditto for other files"},{"file":"lib/zk-session.js","line":6,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Done"},{"file":"lib/zk-session.js","line":286,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Can we assert that zs_oldConn is defined here? I\u0027m just concerned there is some case that L240 introduces that I\u0027m missing."},{"file":"lib/zk-session.js","line":286,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Sure, I\u0027ll add the assert at the top of state_reattaching. L240 is in a different state and makes no real difference here (there\u0027s only one path into reattaching, and it\u0027s via the assertAttach handler which unconditionally sets oldConn)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":17,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":23,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":17,"deletions":-17}],"sizeInsertions":63,"sizeDeletions":-22},{"number":"3","revision":"72ed39f9515f99a3d651b42f9dc36622a30c0edf","parents":["44d313f9c06dfe573d479b78dd361def419aefa4"],"ref":"refs/changes/94/4894/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1544206032,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544206090,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":17,"deletions":0},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":24,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":17,"deletions":-17}],"sizeInsertions":64,"sizeDeletions":-22},{"number":"4","revision":"2ed3aa078c2ce7c55333d3443725d9af7e1e2a3a","parents":["44d313f9c06dfe573d479b78dd361def419aefa4"],"ref":"refs/changes/94/4894/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1544211905,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544211962,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544217996,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":18,"deletions":-18}],"sizeInsertions":67,"sizeDeletions":-25},{"number":"5","revision":"eb39e15b608670eabb54c5c1ce5e2c779c084f0f","parents":["d781668386e3adb9c1f171bf2c04396e065189d1"],"ref":"refs/changes/94/4894/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1546567474,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544211962,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544217996,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548283195,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":18,"deletions":-18}],"sizeInsertions":67,"sizeDeletions":-25},{"number":"6","revision":"767208ca5fbf54d107b7567834b91c38bc1964c7","parents":["d781668386e3adb9c1f171bf2c04396e065189d1"],"ref":"refs/changes/94/4894/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1548283243,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1548283264,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544211962,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544217996,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548283195,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":18,"deletions":-1},{"file":"lib/zk-session.js","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/zkserver.js","type":"MODIFIED","insertions":18,"deletions":-18}],"sizeInsertions":67,"sizeDeletions":-25}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}