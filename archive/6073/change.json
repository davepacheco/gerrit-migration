{"project":"joyent/illumos-joyent","branch":"master","id":"I040c370c612b46cb6acc19cf972d1db2477a1617","number":"6073","subject":"OS-7625 loader fails to boot Dell R510 in UEFI mode OS-7644 mnode_range_setup() makes assumptions about mnodes Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Toomas Soome \u003ctsoome@me.com\u003e Ap","owner":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"url":"https://cr.joyent.us/6073","commitMessage":"OS-7625 loader fails to boot Dell R510 in UEFI mode\nOS-7644 mnode_range_setup() makes assumptions about mnodes\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Toomas Soome \u003ctsoome@me.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1554807004,"lastUpdated":1556184653,"open":false,"status":"MERGED","comments":[{"timestamp":1554807004,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 1."},{"timestamp":1554812864,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 2."},{"timestamp":1554899750,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 3."},{"timestamp":1555354493,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1\n\nAs best I can see, this looks good to me."},{"timestamp":1555354807,"reviewer":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1555355153,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 4."},{"timestamp":1555355196,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1555355266,"reviewer":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1555367075,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1555424687,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1555426050,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1555427174,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1555428527,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1555515638,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 5."},{"timestamp":1555516768,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1555524188,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1555524449,"reviewer":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1556010480,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\nTesting notes have been added to the tickets."},{"timestamp":1556124024,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1556133151,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1556133195,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1556184653,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by John Levon"}],"currentPatchSet":{"number":"7","revision":"7c712ad23d9ba7f9eaffec29e5aeb29fafe3ab07","parents":["486e689913103fa372f7e2c3e054b2bd602546c4"],"ref":"refs/changes/73/6073/7","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1556133195,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555516768,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524188,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524449,"by":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556124024,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1556184653,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":55,"deletions":-58}],"sizeInsertions":99,"sizeDeletions":-83},"patchSets":[{"number":"1","revision":"dff8ad445515491d24af0ca799f64481b13fbe6a","parents":["cf5e484e4a5c4f2d361170e543095ddcc6707af4"],"ref":"refs/changes/73/6073/1","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1554807004,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":45,"deletions":-23},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":50,"deletions":-57}],"sizeInsertions":95,"sizeDeletions":-80},{"number":"2","revision":"2b0adc34386ab93bf9973de4891a6e2e5f015ce3","parents":["919d37f67476ae6f9911035197d34891582d50e6"],"ref":"refs/changes/73/6073/2","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1554812864,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":47,"deletions":-23},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":50,"deletions":-57}],"sizeInsertions":97,"sizeDeletions":-80},{"number":"3","revision":"b254228b6adba1597f575d846af1e5c0a2dfcdfc","parents":["919d37f67476ae6f9911035197d34891582d50e6"],"ref":"refs/changes/73/6073/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1554899750,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555354493,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":1316,"reviewer":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"},"message":"our free() does this check. And yes, the free(cmdline) doe not need it either:)"},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":1316,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":47,"deletions":-23},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":55,"deletions":-58}],"sizeInsertions":102,"sizeDeletions":-81},{"number":"4","revision":"f329a476010462a7e25b134fe6d1e0d529eb00a0","parents":["919d37f67476ae6f9911035197d34891582d50e6"],"ref":"refs/changes/73/6073/4","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1555355153,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555367075,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555355266,"by":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"}}],"comments":[{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":1187,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"What is now guaranteeing that we don\u0027t allocate at Physical address zero? We really want to make sure that we never put anything in the first page as that page is always susceptible to L1TF, no matter what we do."},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":1187,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This is done by avail_filter() in the kernel. BTW loader (and grub) never did protect against this, it\u0027s a kernel side thing only.\n\nThere is also p0_va - an interesting wrinkle, but as it happens OK I think."},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":1187,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, we should probably circle back on that with loader at some point. I\u0027d like us to be in a place where we can\u0027t be responsible for leaking data there."},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":1187,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m not really sure what you mean TBH. It\u0027s not the bootloader\u0027s job to decide which pages an OS uses, it just presents the memory map as known."},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":17,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can we just combine with the above block to reduce lines here?"},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":811,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we need to worry about overflow here since we\u0027re just adding uintptr_t values?"},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":811,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"No? These are allocations and file sizes, by definition start+end can\u0027t overflow."},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":811,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We\u0027re assuming that the multiboot2 data is trusted? I guess given how things have operated in booting, it probably is a reasonable assumption, though if I was writing a new loader today (which this isn\u0027t), I wouldn\u0027t make that assumption."},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","line":811,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"As we discussed previously, if we ever do trusted boot, we would not be going down this path anyway. We\u0027d also need a full audit of the rest of the stuff :/"},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","line":266,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is this guarded here in case we don\u0027t have actually have valid memory in that region? Should we be initializing mtype16m to -1 then?"},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","line":266,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"See :1455\n\nOf course, on such systems this does mean that we never use any of the 16m range. I dunno if it\u0027s worth changing that look up to be PFN_16MEG - 1 ??"},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","line":266,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Regarding :1455, I saw that. I just wasn\u0027t sure that zero was a good sentinal value for initialization given that we\u0027ve made it more load bearing and the xpg version returned zero by default for the type, which seems counter to what this kind of expects. Though maybe it has a different assumption. It just made it unclear to me what the values that said it wasn\u0027t valid really should be considered.\n\nRegarding the other bit, if we\u0027re trying to keep it below 16m, we probably should consider it being an address that\u0027s actually in the range we\u0027d allocate from? But I\u0027m not sure I\u0027m following its purpose as well as I should be."},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","line":266,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Having it be -1 basically says there is no memory that can be allocated in the range 0-16m for normal purposes at all. Even on EFI systems, there\u0027s *some* memory there. It\u0027s probably worth making this change so I\u0027ll take a look at it now."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":47,"deletions":-25},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":55,"deletions":-58}],"sizeInsertions":102,"sizeDeletions":-83},{"number":"5","revision":"e411e919c7c2d2dbfdc9617a8d30998e44575683","parents":["919d37f67476ae6f9911035197d34891582d50e6"],"ref":"refs/changes/73/6073/5","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1555515638,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555516768,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524188,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556124024,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524449,"by":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":55,"deletions":-58}],"sizeInsertions":99,"sizeDeletions":-83},{"number":"6","revision":"040c370c612b46cb6acc19cf972d1db2477a1617","parents":["919d37f67476ae6f9911035197d34891582d50e6"],"ref":"refs/changes/73/6073/6","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1556133151,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555516768,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524188,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556124024,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524449,"by":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":55,"deletions":-58}],"sizeInsertions":99,"sizeDeletions":-83},{"number":"7","revision":"7c712ad23d9ba7f9eaffec29e5aeb29fafe3ab07","parents":["486e689913103fa372f7e2c3e054b2bd602546c4"],"ref":"refs/changes/73/6073/7","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1556133195,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555516768,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524188,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1556124024,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555524449,"by":{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"}},{"type":"SUBM","value":"1","grantedOn":1556184653,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"usr/src/boot/sys/boot/common/multiboot2.c","type":"MODIFIED","insertions":44,"deletions":-25},{"file":"usr/src/uts/i86pc/vm/vm_machdep.c","type":"MODIFIED","insertions":55,"deletions":-58}],"sizeInsertions":99,"sizeDeletions":-83}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Toomas Soome","email":"tsoome@me.com","username":"tsoome"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}