From 23f25069d7473c2897b4535d57120d9b6aaba121 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 11 Apr 2017 15:57:20 -0700
Subject: [PATCH] joyent/node-cueball#107 Bootstrap resolver not stopped when
 the last resolver using it stops

---
 lib/resolver.js | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/lib/resolver.js b/lib/resolver.js
index a7f456d..c19e59a 100644
--- a/lib/resolver.js
+++ b/lib/resolver.js
@@ -262,6 +262,7 @@ function CueBallDNSResolver(options) {
 		this.r_service = '_dns._udp';
 		this.r_defport = 53;
 		this.r_maxres = 10;
+		this.r_refCount = 0;
 		this.setMaxListeners(500);
 	}
 
@@ -364,6 +365,11 @@ CueBallDNSResolver.prototype.list = function () {
 
 CueBallDNSResolver.prototype.state_init = function (S) {
 	this.r_stopping = false;
+	if (this.r_bootstrap !== undefined) {
+		if (--this.r_bootstrap.r_refCount <= 0)
+			this.r_bootstrap.stop();
+		this.r_bootstrap = undefined;
+	}
 	S.on(this, 'startAsserted', function () {
 		S.gotoState('check_ns');
 	});
@@ -394,6 +400,7 @@ CueBallDNSResolver.prototype.state_check_ns = function (S) {
 			CueBallDNSResolver.bootstrapResolvers[notIp[0]] =
 			    this.r_bootstrap;
 		}
+		++this.r_bootstrap.r_refCount;
 		S.gotoState('bootstrap_ns');
 	} else {
 		mod_fs.readFile('/etc/resolv.conf', 'ascii',
-- 
2.21.0

