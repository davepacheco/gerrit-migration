From 05392827f00d0786809321f8d925e8bf5e8edacd Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Wed, 16 Nov 2016 15:01:55 -0800
Subject: [PATCH] OS-5798 imgadm should allow "+" in an image manifest
 "version", per semver Reviewed by: Todd Whiteman <todd.whiteman@joyent.com>
 Approved by: Todd Whiteman <todd.whiteman@joyent.com>

---
 CHANGES.md          | 16 +++++++---------
 Makefile            | 25 ++++++++++++++++++++-----
 README.md           | 18 ++++--------------
 lib/imgmanifest.js  |  4 ++--
 package.json        |  2 +-
 test/basics.test.js | 12 ++++++++++++
 6 files changed, 46 insertions(+), 31 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 6c04f27..d7b1f06 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,14 +1,12 @@
-<!--
-    This Source Code Form is subject to the terms of the Mozilla Public
-    License, v. 2.0. If a copy of the MPL was not distributed with this
-    file, You can obtain one at http://mozilla.org/MPL/2.0/.
--->
+# node-imgmanifest Changelog
 
-<!--
-    Copyright (c) 2015, Joyent, Inc.
--->
+## not yet released
 
-# node-imgmanifest Changelog
+(nothing yet)
+
+## 2.3.0
+
+- OS-5798 Allow '+' in the image manifest "version" field.
 
 ## 2.2.0
 
diff --git a/Makefile b/Makefile
index d9ae0f6..f4778ba 100644
--- a/Makefile
+++ b/Makefile
@@ -40,16 +40,31 @@ $(NODEUNIT):
 test: | $(TAPE)
 	@$(TAPE) test/*.test.js
 
+# Ensure CHANGES.md and package.json have the same version.
 .PHONY: versioncheck
 versioncheck:
-	@echo version is: $(shell json -f package.json version)
-	[[ `json -f package.json version` == `grep '^## ' CHANGES.md | head -1 | awk '{print $$2}'` ]]
+	@echo version is: $(shell cat package.json | json version)
+	[[ `cat package.json | json version` == `grep '^## ' CHANGES.md | head -2 | tail -1 | awk '{print $$2}'` ]]
 
 .PHONY: cutarelease
 cutarelease: versioncheck
-	[[ `git status | tail -n1` == "nothing to commit, working directory clean" ]]
-	./tools/cutarelease.py -p docker-registry-client -f package.json
-
+	[[ -z `git status --short` ]]  # If this fails, the working dir is dirty.
+	@which json 2>/dev/null 1>/dev/null && \
+	    ver=$(shell json -f package.json version) && \
+	    name=$(shell json -f package.json name) && \
+	    publishedVer=$(shell npm view -j $(shell json -f package.json name)@$(shell json -f package.json version) version 2>/dev/null) && \
+	    if [[ -n "$$publishedVer" ]]; then \
+		echo "error: $$name@$$ver is already published to npm"; \
+		exit 1; \
+	    fi && \
+	    echo "** Are you sure you want to tag and publish $$name@$$ver to npm?" && \
+	    echo "** Enter to continue, Ctrl+C to abort." && \
+	    read
+	ver=$(shell cat package.json | json version) && \
+	    date=$(shell date -u "+%Y-%m-%d") && \
+	    git tag -a "$$ver" -m "version $$ver ($$date)" && \
+	    git push --tags origin && \
+	    npm publish
 
 include ./tools/mk/Makefile.deps
 include ./tools/mk/Makefile.targ
diff --git a/README.md b/README.md
index bdd3cb0..3090057 100644
--- a/README.md
+++ b/README.md
@@ -1,18 +1,9 @@
-<!--
-    This Source Code Form is subject to the terms of the Mozilla Public
-    License, v. 2.0. If a copy of the MPL was not distributed with this
-    file, You can obtain one at http://mozilla.org/MPL/2.0/.
--->
-
-<!--
-    Copyright (c) 2014, Joyent, Inc.
--->
-
 # node-imgmanifest
 
-This repository is part of the Joyent SmartDataCenter project (SDC).  For
-contribution guidelines, issues, and general documentation, visit the main
-[SDC](http://github.com/joyent/sdc) project page.
+This repository is part of the Joyent Triton project. See the [contribution
+guidelines](https://github.com/joyent/triton/blob/master/CONTRIBUTING.md) --
+*Triton does not use GitHub PRs* -- and general documentation at the main
+[Triton project](https://github.com/joyent/triton) page.
 
 node-imgmanifest is a node.js lib for working with SmartOS image manifests.
 
@@ -77,4 +68,3 @@ include a "message" string field. Current error "code" values are:
 
 Note: This error format is based on
 <https://mo.joyent.com/docs/eng/master/#error-handling>.
-
diff --git a/lib/imgmanifest.js b/lib/imgmanifest.js
index 2aa2688..e7adc89 100644
--- a/lib/imgmanifest.js
+++ b/lib/imgmanifest.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2016, Joyent, Inc.
  */
 
 /*
@@ -29,7 +29,7 @@ var V = 2;
 // Regexes
 var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
 var NAME_RE = /^[A-Za-z0-9._/ -]+$/;
-var VERSION_RE = /^[A-Za-z0-9._/-]+$/;
+var VERSION_RE = /^[A-Za-z0-9._/+-]+$/;
 // published_at (ISO 8601 date string, e.g. "2012-12-25T12:00:00.123Z")
 // Required if activated.
 var PUBLISHED_AT_RE = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z$/;
diff --git a/package.json b/package.json
index 041beb4..d2e7f69 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgmanifest",
   "description": "Library for working with Triton/SDC/SmartOS image manifests",
-  "version": "2.2.0",
+  "version": "2.3.0",
   "author": "Joyent (joyent.com)",
   "main": "./lib/imgmanifest.js",
   "dependencies": {
diff --git a/test/basics.test.js b/test/basics.test.js
index eee8405..c97ebd3 100644
--- a/test/basics.test.js
+++ b/test/basics.test.js
@@ -182,6 +182,18 @@ var MINIMAL_VALIDATIONS = [
             os: 'smartos',
             origin: 'f669428c-a939-11e2-a485-b790efc0f0c1'
         }
+    },
+    {
+        name: 'good minimal, "+" in version',
+        manifest: {
+            v: 2,
+            uuid: 'ceca6018-ac4a-11e6-b7bd-8720e9a86711',
+            name: 'withaplus',
+            version: '1.2.3+master-20131204T013417Z-gcafebab',
+            owner: '930896af-bf8c-48d4-885c-6573a94b1853',
+            type: 'zone-dataset',
+            os: 'smartos'
+        }
     }
 ];
 
-- 
2.21.0

