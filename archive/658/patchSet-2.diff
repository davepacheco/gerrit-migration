From e1cc88406611082de2ef3117b725556588176e70 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 12 Oct 2016 15:38:41 +0000
Subject: [PATCH] OS-5712 LTP open13 fails in nightly

---
 usr/src/lib/brand/lx/testing/Readme_ltp        |  3 +++
 usr/src/uts/common/brand/lx/syscall/lx_xattr.c | 12 ++++++++++++
 2 files changed, 15 insertions(+)

diff --git a/usr/src/lib/brand/lx/testing/Readme_ltp b/usr/src/lib/brand/lx/testing/Readme_ltp
index 0cadd130f5..4a2fcd353b 100644
--- a/usr/src/lib/brand/lx/testing/Readme_ltp
+++ b/usr/src/lib/brand/lx/testing/Readme_ltp
@@ -10,6 +10,9 @@ To build
 As root first make sure you have the tools installed:
     apt-get install build-essential autoconf automake git quota
 
+For 64-bit:
+    apt-get install libc6-dev-i386
+
 Additional prerequisites are required activate some tests:
     apt-get install attr-dev libaio-dev
 
diff --git a/usr/src/uts/common/brand/lx/syscall/lx_xattr.c b/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
index bd7667226f..eb3f975038 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
@@ -240,6 +240,18 @@ lx_fgetxattr(int fd, char *name, void *value, size_t size)
 		return (set_errno(EBADF));
 	}
 
+	/*
+	 * When a file is opened with O_PATH we clear read/write and fgetxattr
+	 * is expected to return EBADF.
+	 */
+	mutex_enter(&fp->f_tlock);
+	if ((fp->f_flag & (FREAD | FWRITE)) == 0) {
+		mutex_exit(&fp->f_tlock);
+		releasef(fd);
+		return (set_errno(EBADF));
+	}
+	mutex_exit(&fp->f_tlock);
+
 	error = lx_getxattr_common(fp->f_vnode, name, value, size, &osize);
 	releasef(fd);
 
-- 
2.21.0

