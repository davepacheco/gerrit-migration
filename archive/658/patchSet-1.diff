From d078f9d94d491ce40fd853769f00e697606550dc Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 12 Oct 2016 14:32:03 +0000
Subject: [PATCH] OS-5712 LTP open13 fails in nightly

---
 usr/src/lib/brand/lx/testing/Readme_ltp        | 3 +++
 usr/src/uts/common/brand/lx/syscall/lx_xattr.c | 7 +++++++
 2 files changed, 10 insertions(+)

diff --git a/usr/src/lib/brand/lx/testing/Readme_ltp b/usr/src/lib/brand/lx/testing/Readme_ltp
index 0cadd130f5..4a2fcd353b 100644
--- a/usr/src/lib/brand/lx/testing/Readme_ltp
+++ b/usr/src/lib/brand/lx/testing/Readme_ltp
@@ -10,6 +10,9 @@ To build
 As root first make sure you have the tools installed:
     apt-get install build-essential autoconf automake git quota
 
+For 64-bit:
+    apt-get install libc6-dev-i386
+
 Additional prerequisites are required activate some tests:
     apt-get install attr-dev libaio-dev
 
diff --git a/usr/src/uts/common/brand/lx/syscall/lx_xattr.c b/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
index bd7667226f..42fbb7b844 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
@@ -244,6 +244,13 @@ lx_fgetxattr(int fd, char *name, void *value, size_t size)
 	releasef(fd);
 
 	if (error != 0) {
+		/*
+		 * We don't yet properly support xattr (see lx_getxattr_common)
+		 * but to make LTP happy we need to return the expected errno
+		 * here.
+		 */
+		if (error == EOPNOTSUPP)
+			error = EBADF;
 		return (set_errno(error));
 	}
 	return (osize);
-- 
2.21.0

