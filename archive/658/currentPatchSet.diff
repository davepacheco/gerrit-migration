From 13da9a87f119cfb5e2d86a869caa131363a153a9 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 12 Oct 2016 16:18:10 +0000
Subject: [PATCH] OS-5712 LTP open13 fails in nightly Reviewed by: Patrick
 Mooney <patrick.mooney@joyent.com> Approved by: Patrick Mooney
 <patrick.mooney@joyent.com>

---
 usr/src/lib/brand/lx/testing/Readme_ltp        | 3 +++
 usr/src/uts/common/brand/lx/syscall/lx_xattr.c | 9 +++++++++
 2 files changed, 12 insertions(+)

diff --git a/usr/src/lib/brand/lx/testing/Readme_ltp b/usr/src/lib/brand/lx/testing/Readme_ltp
index 0cadd130f5..4a2fcd353b 100644
--- a/usr/src/lib/brand/lx/testing/Readme_ltp
+++ b/usr/src/lib/brand/lx/testing/Readme_ltp
@@ -10,6 +10,9 @@ To build
 As root first make sure you have the tools installed:
     apt-get install build-essential autoconf automake git quota
 
+For 64-bit:
+    apt-get install libc6-dev-i386
+
 Additional prerequisites are required activate some tests:
     apt-get install attr-dev libaio-dev
 
diff --git a/usr/src/uts/common/brand/lx/syscall/lx_xattr.c b/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
index bd7667226f..fcdccdf327 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_xattr.c
@@ -240,6 +240,15 @@ lx_fgetxattr(int fd, char *name, void *value, size_t size)
 		return (set_errno(EBADF));
 	}
 
+	/*
+	 * When a file is opened with O_PATH we clear read/write and fgetxattr
+	 * is expected to return EBADF.
+	 */
+	if ((fp->f_flag & (FREAD | FWRITE)) == 0) {
+		releasef(fd);
+		return (set_errno(EBADF));
+	}
+
 	error = lx_getxattr_common(fp->f_vnode, name, value, size, &osize);
 	releasef(fd);
 
-- 
2.21.0

