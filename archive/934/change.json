{"project":"joyent/manatee","branch":"master","id":"Iacbcf534d671d9f75a7c3092520f650bbfb6b803","number":"934","subject":"MANATEE-260 `manatee-adm rebuild` loops without feedback when postgres fails to start MANATEE-261 `manatee-adm rebuild` claims it was successful when it was not MANATEE-262 manatee-adm hangs at spinner even after it appears to have been successful Reviewe","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/934","commitMessage":"MANATEE-260 `manatee-adm rebuild` loops without feedback when postgres fails to start\nMANATEE-261 `manatee-adm rebuild` claims it was successful when it was not\nMANATEE-262 manatee-adm hangs at spinner even after it appears to have been successful\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1479830570,"lastUpdated":1481625956,"open":false,"status":"MERGED","comments":[{"timestamp":1479830570,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1479830610,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479835197,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 1:\n\nI don\u0027t consider this CR complete yet, but I\u0027ve created it to get some feedback on an initial pass.\n\nI\u0027m not certain that creating a ZFS client independently of postgresMgr is a great idea. Ultimately we need to be certain that our ZFS dataset\u0027s mountpoint contains what we think it contains so that a full rebuild is triggered when sitter is started, but what I don\u0027t like is that I\u0027m delving into postgresMgr\u0027s config to pull out zfsClientCfg and other pieces. \n\nThis change does appear to resolve the issue reported in MANATEE-262, where I\u0027ve been able to manually induce the symptoms reported.\n\nSome additions I\u0027d like to make before considering this CR complete:\n\n* Add a comment documenting the new _createZfsClient function\n* Possibly add a timeout to checkZfsStatus to protect against a null response from sitter\u0027s /restore endpoint. Even if we assert that the dataset is mounted, there\u0027s still a small race scenario where the dataset is somehow unmounted again by the time we attempt to `rm` its contents"},{"timestamp":1480954642,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1480954822,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1480954867,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480955661,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\nThis is my latest revision to this CR, and it extends to a few more issues that existed with `manatee-adm rebuild`. The full list of known issues that this addresses are:\n\n- MANATEE-260\n- MANATEE-261\n- MANATEE-262 (original)\n- MANATEE-318 (not a fix but a workaround)\n\nI\u0027ve performed a number of rebuilds with this code and am happy with the overall procedure that it follows, but I\u0027d like to put together a more structured comment regarding my testing soon. \n\nMy main reason for pushing this latest patch set, however, is to simply get some eyes on my progress so far. This change has grown quite a bit since it was started and it encompasses a few other issues that were ultimately caused by assuming that a restore (ZFS send/revc) was triggered on every rebuild, which is not always the case.\n\nI\u0027ve spent a fair amount of time buried in this one, so I\u0027d really appreciate some oversight to make sure I\u0027m not overlooking something. I\u0027m not 100% happy with the complexity from L1502 onwards, but it mostly revolves around determining if we should draw a progress bar or not.\n\nThe main tasks of `manatee-adm rebuild` (delete dataset contents, start sitter, watch) remain largely unchanged. The additional code is centered around better checks on the cluster state and providing more feedback to the user."},{"timestamp":1480958791,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(4 comments)\n\nIt\u0027s going to be really great to get these issues resolved!\n\nThis looks broadly good to me.  I\u0027ve made a few nitty comments below.  I didn\u0027t take a close look at how L1502 onward could be restructured, but I\u0027m happy to if you like."},{"timestamp":1481029956,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1481030014,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481030314,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(4 comments)\n\nThanks for the feedback. I\u0027ve addressed your points in the comments. I\u0027ve not put together my full test notes yet, but once the code changes settle down I\u0027ll put them through another full set of manual tests that I will document here. \n\n\u003e I didn\u0027t take a close look at how L1502 onward could be restructured, but I\u0027m happy to if you like.\n\nI\u0027m fairly happy with how it\u0027s turning out, but I overlooked the error handling in my initial push (now added in PS4). I would appreciate some extra scrutiny here just to make sure there\u0027s nothing else obvious that I\u0027ve missed."},{"timestamp":1481070831,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1481130594,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\nI\u0027ve written up my testing here: https://gist.github.com/chudley/f35981e2e0a6c2a811a93e9b7b6c784d, which I think is a little too unwieldy for gerrit, and too broad to fit into individual tickets. I can attempt to summarise here for longevity if you think it\u0027s worth doing so.\n\nHopefully the testing covers most scenarios here and contains enough information to give some context on these changes. I\u0027m happy to flesh this out some more, especially if there are other scenarios that would be worth digging further into."},{"timestamp":1481132767,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n\u003e I\u0027ve written up my testing here: https://gist.github.com/chudley/f35981e2e0a6c2a811a93e9b7b6c784d,\n \u003e which I think is a little too unwieldy for gerrit, and too broad to\n \u003e fit into individual tickets. I can attempt to summarise here for\n \u003e longevity if you think it\u0027s worth doing so.\n \u003e \n \u003e Hopefully the testing covers most scenarios here and contains\n \u003e enough information to give some context on these changes. I\u0027m happy\n \u003e to flesh this out some more, especially if there are other\n \u003e scenarios that would be worth digging further into.\n\nThe testing looks good.  I do think it would be worth putting those notes into one of the tickets.  That way we\u0027ll have a record of past behavior if we find ourselves debugging related issues in the future.\n\nI wasn\u0027t sure based on your previous comments whether you\u0027re expecting more change or if this is ready for final review?\n\nOne other thing occurred to me looking at the output, but this is pretty nitty: technically, I don\u0027t think we know how many attempts have been made or even that PostgreSQL failed to start.  (We could have missed an attempt between polls or before we started polling, or the sitter itself could have restarted.)  What do you think of it saying something like: \"Sitter has begun a new restore operation.  Waiting for up to $N more attempts.\"?"},{"timestamp":1481211668,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1481211697,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481212439,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\nI\u0027ve added some comments to the relevant tickets explaining the test scenarios and results.\n\n\u003e What do you think of it saying something like: \"Sitter has begun a new restore operation.  Waiting for up to $N more attempts.\"?\n\nAgreed on this one. I\u0027ve updated this message to display as a countdown, and updated a few other messages to more accurately convey what\u0027s happening. Also a slight change of the constant name to make it more accurate. \n\nI\u0027ve added some example output to https://gist.github.com/chudley/f35981e2e0a6c2a811a93e9b7b6c784d#file-restore_no-pg-out-1, which just illustrates the messages that a user would see.\n\n`make prepush` looks clean, so I\u0027d consider this ready for final review."},{"timestamp":1481299236,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1481625868,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1481625956,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"6","revision":"acbcf534d671d9f75a7c3092520f650bbfb6b803","parents":["3d2bd9b0912e7a09ce460b0d93abb41d309d87cf"],"ref":"refs/changes/34/934/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481625868,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481211697,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481299236,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481299236,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1481625956,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":128,"deletions":-38}],"sizeInsertions":128,"sizeDeletions":-38},"patchSets":[{"number":"1","revision":"40f358d1e7b47834f0d2418f4444925f093bdff6","parents":["b9bd56a756d42cdc7fc50ff45fe7ab7264421768"],"ref":"refs/changes/34/934/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1479830570,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479830610,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":15,"deletions":-1}],"sizeInsertions":15,"sizeDeletions":-1},{"number":"2","revision":"6ab97bec9adfd19c8f6e407b1fec7c541aace6a5","parents":["3d2bd9b0912e7a09ce460b0d93abb41d309d87cf"],"ref":"refs/changes/34/934/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1480954642,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":112,"deletions":-38}],"sizeInsertions":112,"sizeDeletions":-38},{"number":"3","revision":"db0d12450c3f31b86e93791c057f073362595388","parents":["3d2bd9b0912e7a09ce460b0d93abb41d309d87cf"],"ref":"refs/changes/34/934/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1480954822,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480954867,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":1465,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m not sure what \"since uptime\" means.\n\nIs it worth explaining how the sitter copes with this, or is that too much of an implementation detail of some other code?  Maybe refer to that code here?"},{"file":"lib/adm.js","line":1465,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thanks for pointing this out. I guess \"since uptime\" is a bit of slang that I use to refer to the last boot time as indicated by the `uptime` command. I\u0027ll make this more clear in the comment. \n\nThe most concise reference to when a restore is triggered I can find is here: https://github.com/joyent/manatee/blob/master/lib/postgresMgr.js#L970-L974, so I\u0027ve added a comment to refer to \"postgresMgr._standby\" on the details.\n\nThis isn\u0027t as solid a reference as I\u0027d like, and given our discussion in MANATEE-262 I\u0027m not entirely sure there\u0027s a single place with a definitive answer on how this scenario is handled (to my knowledge). Let me know if you think the updated comment reads a little better now, though."},{"file":"lib/adm.js","line":1465,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"That looks good to me!"},{"file":"lib/adm.js","line":1503,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The underscores here are starting to make this pretty hard to read.\n\nAs you\u0027ve found, a lot of code in Manatee makes heavy use of \"_\" as a pipeline argument.  This is unfortunate; I think this was erroneously copied from an example where the argument was deliberately unused.  \"_\" is supposed to be used only to name arguments that are not going to be used.\n\nPeople also sometimes use the \"_x\" prefix to mean \"a different x\" (e.g., where \"x\" is a callback, and _cb is a different callback).  I think that quickly leads to code that\u0027s pretty hard to understand.  I usually use \"callback\", \"subcallback\" or \"subcb\", and (if I need another one), \"pipecb\".\n\nIn Manatee, these issues predate this change, but as long as we\u0027re adding new pipelines, I think it\u0027s worthwhile to use clearer naming."},{"file":"lib/adm.js","line":1503,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I agree. I\u0027ll change these up to see about making them read a little better."},{"file":"lib/adm.js","line":1541,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be nice to pull the \"5\" out into a constant in case we end up needing to hot-patch it for some reason."},{"file":"lib/adm.js","line":1541,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":1600,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t think we want to use \"return\" here or line 1602."},{"file":"lib/adm.js","line":1600,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I\u0027ve kept the \"return\"s here because the other parts of this function make use of the \"return callback()\" style, which is prevalent throughout this code. My understanding with removing the \"return\"s would lead to this function sometimes returning a value and sometimes not.\n\njsl with config for this project doesn\u0027t complain either way, so I\u0027m happy to either remove them or leave them in."},{"file":"lib/adm.js","line":1600,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sorry, I was comparing to what looked like analogous lines on the left-hand side, which return early but without a value.  But it looks like those were inside a different callback."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":112,"deletions":-38}],"sizeInsertions":112,"sizeDeletions":-38},{"number":"4","revision":"782f2c765768723b1c41d313b1c53dd45a78f610","parents":["3d2bd9b0912e7a09ce460b0d93abb41d309d87cf"],"ref":"refs/changes/34/934/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481029956,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481030014,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":117,"deletions":-38}],"sizeInsertions":117,"sizeDeletions":-38},{"number":"5","revision":"4fd021704265cce3c0588addfbf1bcc2793ebce9","parents":["3d2bd9b0912e7a09ce460b0d93abb41d309d87cf"],"ref":"refs/changes/34/934/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481211668,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481299236,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481299236,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481211697,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":128,"deletions":-38}],"sizeInsertions":128,"sizeDeletions":-38},{"number":"6","revision":"acbcf534d671d9f75a7c3092520f650bbfb6b803","parents":["3d2bd9b0912e7a09ce460b0d93abb41d309d87cf"],"ref":"refs/changes/34/934/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1481625868,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481299236,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481299236,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481211697,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1481625956,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":128,"deletions":-38}],"sizeInsertions":128,"sizeDeletions":-38}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}