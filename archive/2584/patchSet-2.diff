From 8a11324b537e23ee7fb047672b573170fa47541f Mon Sep 17 00:00:00 2001
From: Sean Chittenden <sean@chittenden.org>
Date: Fri, 15 Sep 2017 11:29:16 -0700
Subject: [PATCH] MANATEE-363 Update postgresql.conf to be more useful in busy
 production workloads.

---
 etc/9.6/postgresql.manta.coal.conf       | 47 +++++++++++-------------
 etc/9.6/postgresql.manta.lab.conf        | 47 +++++++++++-------------
 etc/9.6/postgresql.manta.production.conf | 47 +++++++++++-------------
 3 files changed, 66 insertions(+), 75 deletions(-)

diff --git a/etc/9.6/postgresql.manta.coal.conf b/etc/9.6/postgresql.manta.coal.conf
index 5170bb8..99a2f8d 100644
--- a/etc/9.6/postgresql.manta.coal.conf
+++ b/etc/9.6/postgresql.manta.coal.conf
@@ -125,7 +125,7 @@ shared_buffers = 32MB                   # min 128kB
 #replacement_sort_tuples = 150000       # limits use of replacement selection sort
 #autovacuum_work_mem = -1               # min 1MB, or -1 to use maintenance_work_mem
 #max_stack_depth = 2MB                  # min 100kB
-#dynamic_shared_memory_type = posix     # the default is the first option
+dynamic_shared_memory_type = sysv       # the default is the first option
                                         # supported by the operating system:
                                         #   posix
                                         #   sysv
@@ -142,7 +142,7 @@ shared_buffers = 32MB                   # min 128kB
 
 #max_files_per_process = 1000           # min 25
                                         # (change requires restart)
-shared_preload_libraries = 'pg_stat_statements' # (change requires restart)
+shared_preload_libraries = 'auto_explain,pg_buffercache,pg_freespacemap,pg_stat_statements,pg_visibility,pgstattuple' # (change requires restart)
 
 # - Cost-Based Vacuum Delay -
 
@@ -189,10 +189,9 @@ synchronous_commit = on                 # synchronization level;
                                         #   fsync
                                         #   fsync_writethrough
                                         #   open_sync
-# Not neccessary on ZFS, see http://www.postgresql.org/docs/current/static/wal-reliability.html
-full_page_writes = off                  # recover from partial page writes
+full_page_writes = on                   # recover from partial page writes
 #wal_compression = off                  # enable compression of full-page writes
-#wal_log_hints = off                    # also do full page writes of non-critical updates
+wal_log_hints = on                      # also do full page writes of non-critical updates
                                         # (change requires restart)
 #wal_buffers = -1                       # min 32kB, -1 sets based on shared_buffers
                                         # (change requires restart)
@@ -205,8 +204,8 @@ full_page_writes = off                  # recover from partial page writes
 # - Checkpoints -
 
 checkpoint_timeout = 30s                # range 30s-1h
-max_wal_size = 480MB
-#min_wal_size = 80MB
+max_wal_size = 100GB
+min_wal_size = 80MB
 #checkpoint_completion_target = 0.5     # checkpoint target duration, 0.0 - 1.0
 #checkpoint_flush_after = 0             # measured in pages, 0 disables
 #checkpoint_warning = 30s               # 0 disables
@@ -238,7 +237,7 @@ wal_keep_segments = 50          # in logfile segments, 16MB each; 0 disables
 
 #max_replication_slots = 0      # max number of replication slots
                                 # (change requires restart)
-#track_commit_timestamp = off   # collect timestamp of transaction commit
+track_commit_timestamp = on     # collect timestamp of transaction commit
                                 # (change requires restart)
 
 # - Master Server -
@@ -264,9 +263,9 @@ max_standby_streaming_delay = 30s       # max delay before canceling queries
                                         # -1 allows indefinite delay
 wal_receiver_status_interval = 10s      # send replies at least this often
                                         # 0 disables
-hot_standby_feedback = off              # send info from standby to prevent
+hot_standby_feedback = on               # send info from standby to prevent
                                         # query conflicts
-#wal_receiver_timeout = 60s             # time that receiver waits for
+wal_receiver_timeout = 0                # time that receiver waits for
                                         # communication from master
                                         # in milliseconds; 0 disables
 #wal_retrieve_retry_interval = 5s       # time to wait before retrying to
@@ -296,7 +295,7 @@ hot_standby_feedback = off              # send info from standby to prevent
 #seq_page_cost = 1.0                    # measured on an arbitrary scale
 #random_page_cost = 4.0                 # same scale as above
 #cpu_tuple_cost = 0.01                  # same scale as above
-#cpu_index_tuple_cost = 0.005           # same scale as above
+cpu_index_tuple_cost = 0.0001           # same scale as above
 #cpu_operator_cost = 0.0025             # same scale as above
 #parallel_tuple_cost = 0.1              # same scale as above
 #parallel_setup_cost = 1000.0   # same scale as above
@@ -424,13 +423,13 @@ log_min_messages = error                # values in order of decreasing detail:
 #debug_print_rewritten = off
 #debug_print_plan = off
 #debug_pretty_print = on
-#log_checkpoints = off
-#log_connections = off
-#log_disconnections = off
+log_checkpoints = on
+log_connections = on
+log_disconnections = on
 #log_duration = off
 #log_error_verbosity = default          # terse, default, or verbose messages
 #log_hostname = off
-log_line_prefix = '%m'                  # special values:
+log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '                  # special values:
                                         #   %a = application name
                                         #   %u = user name
                                         #   %d = database name
@@ -451,10 +450,10 @@ log_line_prefix = '%m'                  # special values:
                                         #        processes
                                         #   %% = '%'
                                         # e.g. '<%u%%%d> '
-#log_lock_waits = off                   # log lock waits >= deadlock_timeout
-#log_statement = 'none'                 # none, ddl, mod, all
+log_lock_waits = on                     # log lock waits >= deadlock_timeout
+log_statement = 'ddl'                   # none, ddl, mod, all
 #log_replication_commands = off
-#log_temp_files = -1                    # log temporary files equal or larger
+log_temp_files = 0                      # log temporary files equal or larger
                                         # than the specified size in kilobytes;
                                         # -1 disables, 0 logs all temp files
 log_timezone = 'UTC'
@@ -475,8 +474,8 @@ log_timezone = 'UTC'
 
 #track_activities = on
 #track_counts = on
-#track_io_timing = off
-#track_functions = none                 # none, pl, all
+track_io_timing = on
+track_functions = all                   # none, pl, all
 #track_activity_query_size = 1024       # (change requires restart)
 #stats_temp_directory = 'pg_stat_tmp'
 
@@ -495,14 +494,11 @@ log_timezone = 'UTC'
 
 #autovacuum = on                        # Enable autovacuum subprocess?  'on'
                                         # requires track_counts to also be on.
-#log_autovacuum_min_duration = -1       # -1 disables, 0 logs all actions and
+log_autovacuum_min_duration = 0         # -1 disables, 0 logs all actions and
                                         # their durations, > 0 logs only
                                         # actions running at least this number
                                         # of milliseconds.
-log_autovacuum_min_duration = 1000
-          # set to 1 second to log any vacuum operations that take longer than
-          # a second. Per Pg High Perf page 163
-#autovacuum_max_workers = 3             # max number of autovacuum subprocesses
+autovacuum_max_workers = 10             # max number of autovacuum subprocesses
                                         # (change requires restart)
 #autovacuum_naptime = 1min              # time between autovacuum runs
 #autovacuum_vacuum_threshold = 50       # min number of row updates before
@@ -647,3 +643,4 @@ default_text_search_config = 'pg_catalog.english'
 #------------------------------------------------------------------------------
 
 # Add settings for extensions here
+pg_stat_statements.track = 'all'
diff --git a/etc/9.6/postgresql.manta.lab.conf b/etc/9.6/postgresql.manta.lab.conf
index 9bd60ee..78efb54 100644
--- a/etc/9.6/postgresql.manta.lab.conf
+++ b/etc/9.6/postgresql.manta.lab.conf
@@ -125,7 +125,7 @@ maintenance_work_mem = 1GB              # min 1MB
 #replacement_sort_tuples = 150000       # limits use of replacement selection sort
 #autovacuum_work_mem = -1               # min 1MB, or -1 to use maintenance_work_mem
 #max_stack_depth = 2MB                  # min 100kB
-#dynamic_shared_memory_type = posix     # the default is the first option
+dynamic_shared_memory_type = sysv       # the default is the first option
                                         # supported by the operating system:
                                         #   posix
                                         #   sysv
@@ -142,7 +142,7 @@ maintenance_work_mem = 1GB              # min 1MB
 
 #max_files_per_process = 1000           # min 25
                                         # (change requires restart)
-shared_preload_libraries = 'pg_stat_statements' # (change requires restart)
+shared_preload_libraries = 'auto_explain,pg_buffercache,pg_freespacemap,pg_stat_statements,pg_visibility,pgstattuple' # (change requires restart)
 
 # - Cost-Based Vacuum Delay -
 
@@ -189,10 +189,9 @@ synchronous_commit = on                 # synchronization level;
                                         #   fsync
                                         #   fsync_writethrough
                                         #   open_sync
-# Not neccessary on ZFS, see http://www.postgresql.org/docs/current/static/wal-reliability.html
-full_page_writes = off                  # recover from partial page writes
+full_page_writes = on                   # recover from partial page writes
 #wal_compression = off                  # enable compression of full-page writes
-#wal_log_hints = off                    # also do full page writes of non-critical updates
+wal_log_hints = on                      # also do full page writes of non-critical updates
                                         # (change requires restart)
 #wal_buffers = -1                       # min 32kB, -1 sets based on shared_buffers
                                         # (change requires restart)
@@ -205,8 +204,8 @@ full_page_writes = off                  # recover from partial page writes
 # - Checkpoints -
 
 checkpoint_timeout = 30s                # range 30s-1h
-max_wal_size = 480MB
-#min_wal_size = 80MB
+max_wal_size = 100GB
+min_wal_size = 80MB
 #checkpoint_completion_target = 0.5     # checkpoint target duration, 0.0 - 1.0
 #checkpoint_flush_after = 0             # measured in pages, 0 disables
 #checkpoint_warning = 30s               # 0 disables
@@ -238,7 +237,7 @@ wal_keep_segments = 100         # in logfile segments, 16MB each; 0 disables
 
 #max_replication_slots = 0      # max number of replication slots
                                 # (change requires restart)
-#track_commit_timestamp = off   # collect timestamp of transaction commit
+track_commit_timestamp = on     # collect timestamp of transaction commit
                                 # (change requires restart)
 
 # - Master Server -
@@ -264,9 +263,9 @@ max_standby_streaming_delay = 30s       # max delay before canceling queries
                                         # -1 allows indefinite delay
 wal_receiver_status_interval = 10s      # send replies at least this often
                                         # 0 disables
-hot_standby_feedback = off              # send info from standby to prevent
+hot_standby_feedback = on               # send info from standby to prevent
                                         # query conflicts
-#wal_receiver_timeout = 60s             # time that receiver waits for
+wal_receiver_timeout = 0                # time that receiver waits for
                                         # communication from master
                                         # in milliseconds; 0 disables
 #wal_retrieve_retry_interval = 5s       # time to wait before retrying to
@@ -296,7 +295,7 @@ hot_standby_feedback = off              # send info from standby to prevent
 #seq_page_cost = 1.0                    # measured on an arbitrary scale
 #random_page_cost = 4.0                 # same scale as above
 #cpu_tuple_cost = 0.01                  # same scale as above
-#cpu_index_tuple_cost = 0.005           # same scale as above
+cpu_index_tuple_cost = 0.0001           # same scale as above
 #cpu_operator_cost = 0.0025             # same scale as above
 #parallel_tuple_cost = 0.1              # same scale as above
 #parallel_setup_cost = 1000.0   # same scale as above
@@ -424,13 +423,13 @@ log_min_messages = error                # values in order of decreasing detail:
 #debug_print_rewritten = off
 #debug_print_plan = off
 #debug_pretty_print = on
-#log_checkpoints = off
-#log_connections = off
-#log_disconnections = off
+log_checkpoints = on
+log_connections = on
+log_disconnections = on
 #log_duration = off
 #log_error_verbosity = default          # terse, default, or verbose messages
 #log_hostname = off
-log_line_prefix = '%m'                  # special values:
+log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '                  # special values:
                                         #   %a = application name
                                         #   %u = user name
                                         #   %d = database name
@@ -451,10 +450,10 @@ log_line_prefix = '%m'                  # special values:
                                         #        processes
                                         #   %% = '%'
                                         # e.g. '<%u%%%d> '
-#log_lock_waits = off                   # log lock waits >= deadlock_timeout
-#log_statement = 'none'                 # none, ddl, mod, all
+log_lock_waits = on                     # log lock waits >= deadlock_timeout
+log_statement = 'ddl'                   # none, ddl, mod, all
 #log_replication_commands = off
-#log_temp_files = -1                    # log temporary files equal or larger
+log_temp_files = 0                      # log temporary files equal or larger
                                         # than the specified size in kilobytes;
                                         # -1 disables, 0 logs all temp files
 log_timezone = 'UTC'
@@ -475,8 +474,8 @@ log_timezone = 'UTC'
 
 #track_activities = on
 #track_counts = on
-#track_io_timing = off
-#track_functions = none                 # none, pl, all
+track_io_timing = on
+track_functions = all                   # none, pl, all
 #track_activity_query_size = 1024       # (change requires restart)
 #stats_temp_directory = 'pg_stat_tmp'
 
@@ -495,14 +494,11 @@ log_timezone = 'UTC'
 
 #autovacuum = on                        # Enable autovacuum subprocess?  'on'
                                         # requires track_counts to also be on.
-#log_autovacuum_min_duration = -1       # -1 disables, 0 logs all actions and
+log_autovacuum_min_duration = 0         # -1 disables, 0 logs all actions and
                                         # their durations, > 0 logs only
                                         # actions running at least this number
                                         # of milliseconds.
-log_autovacuum_min_duration = 1000
-          # set to 1 second to log any vacuum operations that take longer than
-          # a second. Per Pg High Perf page 163
-#autovacuum_max_workers = 3             # max number of autovacuum subprocesses
+autovacuum_max_workers = 10             # max number of autovacuum subprocesses
                                         # (change requires restart)
 #autovacuum_naptime = 1min              # time between autovacuum runs
 #autovacuum_vacuum_threshold = 50       # min number of row updates before
@@ -647,3 +643,4 @@ default_text_search_config = 'pg_catalog.english'
 #------------------------------------------------------------------------------
 
 # Add settings for extensions here
+pg_stat_statements.track = 'all'
diff --git a/etc/9.6/postgresql.manta.production.conf b/etc/9.6/postgresql.manta.production.conf
index 10f800d..c6da02e 100644
--- a/etc/9.6/postgresql.manta.production.conf
+++ b/etc/9.6/postgresql.manta.production.conf
@@ -125,7 +125,7 @@ maintenance_work_mem = 4GB              # min 1MB
 #replacement_sort_tuples = 150000       # limits use of replacement selection sort
 #autovacuum_work_mem = -1               # min 1MB, or -1 to use maintenance_work_mem
 #max_stack_depth = 2MB                  # min 100kB
-#dynamic_shared_memory_type = posix     # the default is the first option
+dynamic_shared_memory_type = sysv       # the default is the first option
                                         # supported by the operating system:
                                         #   posix
                                         #   sysv
@@ -142,7 +142,7 @@ maintenance_work_mem = 4GB              # min 1MB
 
 #max_files_per_process = 1000           # min 25
                                         # (change requires restart)
-shared_preload_libraries = 'pg_stat_statements' # (change requires restart)
+shared_preload_libraries = 'auto_explain,pg_buffercache,pg_freespacemap,pg_stat_statements,pg_visibility,pgstattuple' # (change requires restart)
 
 # - Cost-Based Vacuum Delay -
 
@@ -189,10 +189,9 @@ synchronous_commit = on                 # synchronization level;
                                         #   fsync
                                         #   fsync_writethrough
                                         #   open_sync
-# Not neccessary on ZFS, see http://www.postgresql.org/docs/current/static/wal-reliability.html
-full_page_writes = off                  # recover from partial page writes
+full_page_writes = on                   # recover from partial page writes
 #wal_compression = off                  # enable compression of full-page writes
-#wal_log_hints = off                    # also do full page writes of non-critical updates
+wal_log_hints = on                      # also do full page writes of non-critical updates
                                         # (change requires restart)
 #wal_buffers = -1                       # min 32kB, -1 sets based on shared_buffers
                                         # (change requires restart)
@@ -205,8 +204,8 @@ full_page_writes = off                  # recover from partial page writes
 # - Checkpoints -
 
 checkpoint_timeout = 30s                # range 30s-1h
-max_wal_size = 480MB
-#min_wal_size = 80MB
+max_wal_size = 100GB
+min_wal_size = 80MB
 #checkpoint_completion_target = 0.5     # checkpoint target duration, 0.0 - 1.0
 #checkpoint_flush_after = 0             # measured in pages, 0 disables
 #checkpoint_warning = 30s               # 0 disables
@@ -238,7 +237,7 @@ wal_keep_segments = 1000        # in logfile segments, 16MB each; 0 disables
 
 #max_replication_slots = 0      # max number of replication slots
                                 # (change requires restart)
-#track_commit_timestamp = off   # collect timestamp of transaction commit
+track_commit_timestamp = on     # collect timestamp of transaction commit
                                 # (change requires restart)
 
 # - Master Server -
@@ -264,9 +263,9 @@ max_standby_streaming_delay = 30s       # max delay before canceling queries
                                         # -1 allows indefinite delay
 wal_receiver_status_interval = 10s      # send replies at least this often
                                         # 0 disables
-hot_standby_feedback = off              # send info from standby to prevent
+hot_standby_feedback = on               # send info from standby to prevent
                                         # query conflicts
-#wal_receiver_timeout = 60s             # time that receiver waits for
+wal_receiver_timeout = 0                # time that receiver waits for
                                         # communication from master
                                         # in milliseconds; 0 disables
 #wal_retrieve_retry_interval = 5s       # time to wait before retrying to
@@ -296,7 +295,7 @@ hot_standby_feedback = off              # send info from standby to prevent
 #seq_page_cost = 1.0                    # measured on an arbitrary scale
 #random_page_cost = 4.0                 # same scale as above
 #cpu_tuple_cost = 0.01                  # same scale as above
-#cpu_index_tuple_cost = 0.005           # same scale as above
+cpu_index_tuple_cost = 0.0001           # same scale as above
 #cpu_operator_cost = 0.0025             # same scale as above
 #parallel_tuple_cost = 0.1              # same scale as above
 #parallel_setup_cost = 1000.0   # same scale as above
@@ -424,13 +423,13 @@ log_min_messages = error                # values in order of decreasing detail:
 #debug_print_rewritten = off
 #debug_print_plan = off
 #debug_pretty_print = on
-#log_checkpoints = off
-#log_connections = off
-#log_disconnections = off
+log_checkpoints = on
+log_connections = on
+log_disconnections = on
 #log_duration = off
 #log_error_verbosity = default          # terse, default, or verbose messages
 #log_hostname = off
-log_line_prefix = '%m'                  # special values:
+log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '                  # special values:
                                         #   %a = application name
                                         #   %u = user name
                                         #   %d = database name
@@ -451,10 +450,10 @@ log_line_prefix = '%m'                  # special values:
                                         #        processes
                                         #   %% = '%'
                                         # e.g. '<%u%%%d> '
-#log_lock_waits = off                   # log lock waits >= deadlock_timeout
-#log_statement = 'none'                 # none, ddl, mod, all
+log_lock_waits = on                     # log lock waits >= deadlock_timeout
+log_statement = 'ddl'                   # none, ddl, mod, all
 #log_replication_commands = off
-#log_temp_files = -1                    # log temporary files equal or larger
+log_temp_files = 0                      # log temporary files equal or larger
                                         # than the specified size in kilobytes;
                                         # -1 disables, 0 logs all temp files
 log_timezone = 'UTC'
@@ -475,8 +474,8 @@ log_timezone = 'UTC'
 
 #track_activities = on
 #track_counts = on
-#track_io_timing = off
-#track_functions = none                 # none, pl, all
+track_io_timing = on
+track_functions = all                   # none, pl, all
 #track_activity_query_size = 1024       # (change requires restart)
 #stats_temp_directory = 'pg_stat_tmp'
 
@@ -495,14 +494,11 @@ log_timezone = 'UTC'
 
 #autovacuum = on                        # Enable autovacuum subprocess?  'on'
                                         # requires track_counts to also be on.
-#log_autovacuum_min_duration = -1       # -1 disables, 0 logs all actions and
+log_autovacuum_min_duration = 0         # -1 disables, 0 logs all actions and
                                         # their durations, > 0 logs only
                                         # actions running at least this number
                                         # of milliseconds.
-log_autovacuum_min_duration = 1000
-          # set to 1 second to log any vacuum operations that take longer than
-          # a second. Per Pg High Perf page 163
-#autovacuum_max_workers = 3             # max number of autovacuum subprocesses
+autovacuum_max_workers = 10             # max number of autovacuum subprocesses
                                         # (change requires restart)
 #autovacuum_naptime = 1min              # time between autovacuum runs
 #autovacuum_vacuum_threshold = 50       # min number of row updates before
@@ -648,3 +644,4 @@ default_text_search_config = 'pg_catalog.english'
 #------------------------------------------------------------------------------
 
 # Add settings for extensions here
+pg_stat_statements.track = 'all'
-- 
2.21.0

