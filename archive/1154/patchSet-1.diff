From e103cd2a55f8a150e7afba05d4f3e30a812dbeba Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 21 Dec 2016 17:39:19 +0000
Subject: [PATCH] OS-5866 incorrect pid in cmsg for Unix socket with
 SO_PASSCRED

---
 usr/src/uts/common/brand/lx/syscall/lx_socket.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/usr/src/uts/common/brand/lx/syscall/lx_socket.c b/usr/src/uts/common/brand/lx/syscall/lx_socket.c
index 4bb7440eca..fd93f08f02 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_socket.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_socket.c
@@ -1314,6 +1314,16 @@ lx_convert_sock_args(int in_dom, int in_type, int in_proto, int *out_dom,
 		return (EPROTONOSUPPORT);
 	}
 
+	/*
+	 * For the specal case of SOCK_SEQPACKET for AF_UNIX we want to treat
+	 * this as a SOCK_DGRAM. The semantics are similar in this case, and
+	 * in particular our native code can pass cmsgs over a connectionless
+	 * socket, but not a connection-oriented socket. Some Linux code depends
+	 * on this for Unix-domain sockets.
+	 */
+	if (domain == AF_UNIX && type == SOCK_SEQPACKET)
+		type = SOCK_DGRAM;
+
 	options = 0;
 	in_type &= ~(LX_SOCK_TYPE_MASK);
 	if (in_type & LX_SOCK_NONBLOCK) {
-- 
2.21.0

