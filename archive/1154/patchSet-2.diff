From 440023657cbcede9d15245e74c194db72e5a512a Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 21 Dec 2016 22:29:01 +0000
Subject: [PATCH] OS-5866 incorrect pid in cmsg for Unix socket with
 SO_PASSCRED

---
 usr/src/uts/common/brand/lx/syscall/lx_socket.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/usr/src/uts/common/brand/lx/syscall/lx_socket.c b/usr/src/uts/common/brand/lx/syscall/lx_socket.c
index 4bb7440eca..e4a60ea4ef 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_socket.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_socket.c
@@ -3850,6 +3850,16 @@ lx_socketpair(int domain, int type, int protocol, int *sv)
 	int err, options, fds[2];
 	file_t *fps[2];
 
+	/*
+	 * For the specal case of SOCK_SEQPACKET for AF_UNIX we want to treat
+	 * this as a SOCK_DGRAM. The semantics are similar in this case, and
+	 * in particular our native code can pass cmsgs over a connectionless
+	 * socket, but not a connection-oriented socket. Some Linux code depends
+	 * on this for Unix-domain sockets.
+	 */
+	if (domain == LX_AF_UNIX && type == LX_SOCK_SEQPACKET)
+		type = LX_SOCK_DGRAM;
+
 	if ((err = lx_convert_sock_args(domain, type, protocol, &domain, &type,
 	    &options, &protocol)) != 0) {
 		return (set_errno(err));
-- 
2.21.0

