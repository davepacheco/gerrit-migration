{"project":"joyent/illumos-joyent","branch":"master","id":"I9c8d4a1a37ad374d40250c38a5103106b29903a6","number":"5339","subject":"OS-7501 overlay(7D) can receive packets with DB_CKSUMFLAGS() set Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Ryan Zezeski \u003crpz@joyent.com\u003e","owner":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"url":"https://cr.joyent.us/5339","commitMessage":"OS-7501 overlay(7D) can receive packets with DB_CKSUMFLAGS() set\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Ryan Zezeski \u003crpz@joyent.com\u003e\n","createdOn":1547082034,"lastUpdated":1547512435,"open":false,"status":"MERGED","comments":[{"timestamp":1547082034,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 1."},{"timestamp":1547098557,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1547137602,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)"},{"timestamp":1547137687,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1547143708,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1547151508,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1547161441,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\nI\u0027m more worried about the lack of context in this case than I am the performance.  As I\u0027ve demonstrated, the packet could\u0027ve come in from the outside.  Will be changing."},{"timestamp":1547161741,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 2."},{"timestamp":1547234797,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1547235601,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1547238013,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1547412651,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1547427251,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1547427299,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1547483143,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1547483662,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1547510427,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1547512414,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1547512435,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dan McDonald"}],"currentPatchSet":{"number":"9","revision":"9c8d4a1a37ad374d40250c38a5103106b29903a6","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/39/5339/9","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547512414,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547510427,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1547512435,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"3cbeced1de1b9bab8ef71a0f2b99a1f7bb58115d","parents":["f9b7abc6be240f4777d99c3a6bfa47119887b890"],"ref":"refs/changes/39/5339/1","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547082034,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547098557,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547137602,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":134,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Nit: You don\u0027t have to change it, but it might be better to spell it out as HW_LOCAL_MAC so if someone does cscope/grok symbol search they find it."},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":134,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Ahhh, good catch."},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":137,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m wondering if we should clear everything we don\u0027t want or instead and it with everything we know explicitly. Either way is OK."},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":137,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I think this could be argued both ways.\n\nOn one hand, if we add new flags in the future it could end up breaking this again.\n\nOn the other hand, if we add new flags in the future and we want to preserve them here then we have to know to modify this location when we add the new flags.\n\nIn both cases, if we don\u0027t check all uses of the flags field across the entire code base, we could end up breaking something (either because the flag shouldn\u0027t be passed thru or because it should but isn\u0027t). I\u0027m not sure which case would be more likely, but I\u0027m okay with the current implementation. It kind of makes me wonder if it would be at all useful to add a CTASSERT to all locations like this that trips if a new flag was added to pattr.h but not considered here. Like:\n\nCTASSERT(HW_FLAGS_ALL \u0026 (HCK_FLAGS | HW_LSO_FLAGS | HW_LOCAL_MAC | ...) \u003d\u003d HW_FLAGS_ALL);\n\nYes, it\u0027s a bit ridiculous but it would make sure anyone adding/removing these fields looks at every place using them. Anyways, I\u0027m not saying Dan has to do this; I\u0027m more musing on this general problem we have.\n\nPerhaps the real issue is we shouldn\u0027t be mixing all these flags in one place."},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":137,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I had draft text here, but I\u0027ll come back to this in a bit."},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":137,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Okay, back to what I was trying to say earlier.\n\nRyan covers the tradeoff between \"everything we don\u0027t want\" vs. \"everything we know explicitly\".  What isn\u0027t mentioned is, WHAT EXACTLY do either of those sets entail?\n\nI\u0027m curious even about HW_LOCAL_MAC, as it is only valid for the MAC and IP information on the outermost/lowest-on-the-stack headers.  If I get MAC + IP + UDP + VXLAN + MAC + IP + \u003csomething\u003e, ALL of the DB_CKSUMFLAGS only cover up to UDP \u0026 VXLAN for now.  We\u0027ve already lost all context of anything after the VXLAN header.\n\nI\u0027m tempted to *zero* this out for now after seeing all of this. That is, \"everything we don\u0027t want\" is all if it, and \"everything we know explicitly\" is nothing.  If/when we support NICs that accelerate what VXLAN encapsulates (and I think i40e can, e.g.), we would need to revisit here anyway."},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","line":137,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I don\u0027t think zeroing will hurt anything except maybe performance. That was the point of it: so various layers can know if this packet originated locally and never traveled across the wire: in that case, if we want, we can assume it won\u0027t be corrupted in memory and we can trust the contents. It was to avoid the very real cost of constant software checksum calculation for packets that only traveled across DRAM/cache."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":13,"deletions":-3}],"sizeInsertions":13,"sizeDeletions":-3},{"number":"2","revision":"1ed769923a59fd71a756c9062a276e2afb6af417","parents":["20d7681782f0be44786f67236858906ed0e07504"],"ref":"refs/changes/39/5339/2","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547161741,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"3","revision":"bedbea84dd4786bbeb906629280c52b866b53c19","parents":["4a74895e6ebb5c0234ebb920a7d1a250d3f7cf19"],"ref":"refs/changes/39/5339/3","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547234797,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"4","revision":"52a8a3689155dc508c9686a72bf335793ca3dfcb","parents":["4a74895e6ebb5c0234ebb920a7d1a250d3f7cf19"],"ref":"refs/changes/39/5339/4","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547238013,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"5","revision":"813148b6086cdf9a08d26d8a0b3372a4252e807c","parents":["b573326a8abbdb9267b014e71f2ae41fea720655"],"ref":"refs/changes/39/5339/5","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547427251,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"6","revision":"07cc00adfed1638db6d5f61237d754618b4b43b9","parents":["b573326a8abbdb9267b014e71f2ae41fea720655"],"ref":"refs/changes/39/5339/6","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547427299,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"7","revision":"8c75025362060f2ffe0201468d6f947e76d3f979","parents":["ff1b696851b0f3c59776af146a4bc820f0e498f1"],"ref":"refs/changes/39/5339/7","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547483143,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"8","revision":"cf0cc762af20bb9fd6738f9de83e96d20ea88fe8","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/39/5339/8","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547483662,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547510427,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3},{"number":"9","revision":"9c8d4a1a37ad374d40250c38a5103106b29903a6","parents":["3261980fc834080481df409165235747db001b84"],"ref":"refs/changes/39/5339/9","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1547512414,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547412651,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547235601,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1547510427,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"SUBM","value":"1","grantedOn":1547512435,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/overlay/overlay_mux.c","type":"MODIFIED","insertions":17,"deletions":-3}],"sizeInsertions":17,"sizeDeletions":-3}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}