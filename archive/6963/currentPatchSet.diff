From fe0405a142eb51fd06e6567851595a72024f0970 Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Fri, 6 Oct 2017 09:25:16 -0600
Subject: [PATCH] MANATEE-323 manatee misguidedly convinced that if it calls
 watch() on a dead ZK client enough, it will come back to life

---
 lib/zookeeperMgr.js | 6 ++++--
 package.json        | 2 +-
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/lib/zookeeperMgr.js b/lib/zookeeperMgr.js
index 7fcfba5..d0351e3 100644
--- a/lib/zookeeperMgr.js
+++ b/lib/zookeeperMgr.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /**
@@ -247,7 +247,9 @@ function watch(zk, getFunc, path, wat, cb) {
                 path: path,
                 err: err
             }, 'zk: error fetching zk data or children');
-            setTimeout(registerWatch, 5000);
+            if (err.code !== zkClient.Exception.CONNECTION_LOSS) {
+                setTimeout(registerWatch, 5000);
+            }
         } else {
             wat.call(self, watRes);
         }
diff --git a/package.json b/package.json
index 8629ba1..c5e6539 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "author": "Yunong Xiao <yunong@joyent.com>",
     "name": "manatee",
-    "version": "2.1.0",
+    "version": "2.1.1",
     "private": true,
     "homepage": "seacow.io",
     "description": "H/A Postgres Minder",
-- 
2.21.0

