From fd72dc1c8db8af219e9372b512a48dad6dd61fa4 Mon Sep 17 00:00:00 2001
From: Cameron Watters <cameron.watters@joyent.com>
Date: Fri, 4 Nov 2016 13:56:16 -0700
Subject: [PATCH] DOCKER-967 properly order extraHosts entries in /etc/hosts

---
 src/vm/node_modules/VM.js   | 6 ++++--
 src/vm/tests/test-docker.js | 6 +++---
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 4f7bacab..eeaae1d2 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -2147,8 +2147,10 @@ function createHostConfFileMounts(vmobj, opts, log, callback) {
                     return;
                 } else {
                     idx = extraHost.indexOf(':');
-                    extraHosts[i] = [extraHost.slice(0, idx),
-                        extraHost.slice(idx+1)];
+
+                    // /etc/hosts expects IP first, then hostname(s)
+                    extraHosts[i] = [extraHost.slice(idx+1),
+                        extraHost.slice(0,idx)];
                 }
             }
         }
diff --git a/src/vm/tests/test-docker.js b/src/vm/tests/test-docker.js
index a1952d43..3aab4de4 100644
--- a/src/vm/tests/test-docker.js
+++ b/src/vm/tests/test-docker.js
@@ -762,7 +762,7 @@ test('test docker VM with "docker:extraHosts"', function (t) {
             var hostsPath = path.resolve(
                 vmobj.zonepath, 'root', 'etc', 'hosts');
             var hostsContent = fs.readFileSync(hostsPath, 'utf8');
-            var foo = /^foo\t1.2.3.4$/m;
+            var foo = /^1.2.3.4\tfoo$/m;
             t.ok(foo.test(hostsContent),
                 util.format('%s entry found in hosts path (%s): %j',
                     foo, hostsPath, hostsContent));
@@ -781,8 +781,8 @@ test('test docker VM with "docker:extraHosts"', function (t) {
             var hostsPath = path.resolve(
                 vmobj.zonepath, 'root', 'etc', 'hosts');
             var hostsContent = fs.readFileSync(hostsPath, 'utf8');
-            var foo = /^foo\t1.2.3.4$/m;
-            var bar = /^bar\t5.6.7.8$/m;
+            var foo = /^1.2.3.4\tfoo$/m;
+            var bar = /^5.6.7.8\tbar$/m;
             t.notOk(foo.test(hostsContent),
                 util.format('%s entry NOT found in hosts path (%s): %j',
                     foo, hostsPath, hostsContent));
-- 
2.21.0

