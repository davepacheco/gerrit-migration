From 3e1fc5a77f8f6f54c2b6ed028f01084dc01673ab Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 13 Sep 2019 16:37:58 +0200
Subject: [PATCH] TRITON-1841 Updating NICs in VMAPI should call out to NAPI
 where appropriate

---
 lib/workflows/migrate-abort.js |  2 +-
 lib/workflows/migrate-begin.js |  2 +-
 lib/workflows/migrate-sync.js  |  2 +-
 lib/workflows/update-nics.js   | 41 ++++++++++++++++++++++++++++++++--
 4 files changed, 42 insertions(+), 5 deletions(-)

diff --git a/lib/workflows/migrate-abort.js b/lib/workflows/migrate-abort.js
index 3c80bd1..e657ec8 100644
--- a/lib/workflows/migrate-abort.js
+++ b/lib/workflows/migrate-abort.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
diff --git a/lib/workflows/migrate-begin.js b/lib/workflows/migrate-begin.js
index a9f6057..8986c63 100644
--- a/lib/workflows/migrate-begin.js
+++ b/lib/workflows/migrate-begin.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
diff --git a/lib/workflows/migrate-sync.js b/lib/workflows/migrate-sync.js
index 795b66f..5025a19 100644
--- a/lib/workflows/migrate-sync.js
+++ b/lib/workflows/migrate-sync.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
diff --git a/lib/workflows/update-nics.js b/lib/workflows/update-nics.js
index a89b3b5..dbbf6e5 100644
--- a/lib/workflows/update-nics.js
+++ b/lib/workflows/update-nics.js
@@ -5,14 +5,14 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
  * A brief overview of this source file: what is its purpose.
  */
 
-var async = require('async');
+var vasync = require('vasync');
 var common = require('./job-common');
 var VERSION = '7.0.4';
 
@@ -38,6 +38,33 @@ function setupRequest(job, cb) {
 }
 
 
+/*
+ * This handles updating the NICs in NAPI. It's important to do this before
+ * updating the VM on the Compute Node so that net-agent has a chance to see
+ * the values, and won't try reverting them back to match NAPI.
+ */
+function updateNics(job, cb) {
+    var napi = new sdcClients.NAPI({
+        url: napiUrl,
+        headers: { 'x-request-id': job.params['x-request-id'] }
+    });
+
+    function updateNic(nic, done) {
+        napi.updateNic(nic.mac, nic, done);
+    }
+
+    vasync.forEachPipeline({
+        inputs: job.params.update_nics,
+        func: updateNic
+    }, function (err) {
+        if (err) {
+            cb(err);
+            return;
+        }
+
+        cb(null, 'Updated NAPI NICs');
+    });
+}
 
 var workflow = module.exports = {
     name: 'update-nics-' + VERSION,
@@ -66,6 +93,16 @@ var workflow = module.exports = {
         retry: 1,
         body: common.waitOnVMTicket,
         modules: { sdcClients: 'sdc-clients' }
+    }, {
+        name: 'napi.update_nics',
+        timeout: 10,
+        retry: 1,
+        body: updateNics,
+        modules: {
+            restify: 'restify',
+            sdcClients: 'sdc-clients',
+            vasync: 'vasync'
+        }
     }, {
         name: 'cnapi.update_vm',
         timeout: 10,
-- 
2.21.0

