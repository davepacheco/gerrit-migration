{"project":"joyent/illumos-joyent","branch":"master","id":"I53a42a062a574c20378f6a05d857f07244260518","number":"6921","subject":"OS-6743 need topo maps for the SMCI,SYS-2028U-E1CNRT+ OS-6748 extend disk topo plugin to enumerate nvme devices","owner":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"url":"https://cr.joyent.us/6921","commitMessage":"OS-6743 need topo maps for the SMCI,SYS-2028U-E1CNRT+\nOS-6748 extend disk topo plugin to enumerate nvme devices\n","createdOn":1568845614,"lastUpdated":1571071831,"open":true,"status":"NEW","comments":[{"timestamp":1568845614,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 1."},{"timestamp":1570202640,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(11 comments)\n\nI think this looks good. I just have a few questions due to my unfamiliarity and nit picks."},{"timestamp":1571071704,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 2."},{"timestamp":1571071831,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 1:\n\n(11 comments)\n\nThanks again for looking at this!"}],"currentPatchSet":{"number":"2","revision":"53a42a062a574c20378f6a05d857f07244260518","parents":["5a02003f48844ffada03336634b28edaff8574ec"],"ref":"refs/changes/21/6921/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1571071704,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_xml.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/fm/topo/maps/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/Makefile","type":"ADDED","insertions":29,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","type":"ADDED","insertions":161,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-usb.usbtopo","type":"ADDED","insertions":50,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.c","type":"MODIFIED","insertions":19,"deletions":-6},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":33,"deletions":-15},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":0,"deletions":-33},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_drivers.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","type":"ADDED","insertions":589,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":1,"deletions":-9}],"sizeInsertions":943,"sizeDeletions":-71},"patchSets":[{"number":"1","revision":"668eb51c8a8091a61e3c22500376055752aec632","parents":["5a02003f48844ffada03336634b28edaff8574ec"],"ref":"refs/changes/21/6921/1","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1568845614,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/fm/topo/libtopo/common/topo_xml.c","line":1355,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"What problem occurs when this block is in its previous place?"},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_xml.c","line":1355,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"The disk enumerator was being executed before the \"binding\" property group was added to the parent \"bay\" node.  As a result the disk enumerator didn\u0027t find the properties it was expecting because they hadn\u0027t been created, yet.\n\nI actually hit this issue a few years ago and made this same change to Oracle Solaris.  Deja vu."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","line":23,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This falls under the umbrella of \"Kody doesn\u0027t know how these maps work,\" but do we need to specify this if the \u0027node\u0027 that this is part of has the fac-enum\u0027s provider set to \u0027fac_prov_ipmi\u0027?"},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","line":23,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"The XML at line 19 causes a set of methods to be registered to the \"chassis\u003d0\" node so that it can use them.  The XML at line 23 causes a set of methods to be registered to the \"locate\" facility node."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","line":25,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I looked at a bunch of these XML mapping files and they each used spaces instead of tabs."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","line":25,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yep, should be spaces.  I fixed this line and also line 35."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","line":29,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should we drop this and instead use \u003cpropmethod ... /\u003e on the previous line?"},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","line":29,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yes, that would be better.  Done."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":30,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I take it the list of properties here is what IPMI will give us when we ask for sensor data? Is there a document that SMCI publishes that we can use to verify this list?"},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":30,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Right.  Basically we could discover all these sensors by iterating through the IPMI sensor data repository (SDR), but the SDR on this platform doesn\u0027t give enough additional metadata to associate the senor with the correct hardware resource.   So we hardcode the association here - binding them all to the motherboard.  We\u0027ve had to do this on most of the SMCI platforms.   SMCI doesn\u0027t provide a document for this, as far as I know and the names of the sensors aren\u0027t even consistent between SMCI platforms, which is annoying."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":47,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Switch tabs to spaces here and later in this file?"},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":47,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yes - fixed."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":67,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Why would this value be up to 254 instead of 256?"},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":67,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Should actually be 255 (there are up to 256 PCI busses).  Fixed."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":104,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Am I understanding this correctly in thinking that we\u0027re manually defining the last four bays to be NVMe bays? How do we calculate the parent-device \u0027value\u0027 field? What if we stick disks in those bays (the SMCI landing page for this chassis seems to indicate we could do that if we wanted to)."},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","line":104,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yes.  We calculate the parent-device field by looking at an actual system and seeing what the parent bus device actually looks like.  Obviously the assumption here is that these paths will hold true for every instance of this platform model - but that should be the cases.\n\nI wasn\u0027t aware that you could plug a non-NVME device into these four slots.  I can try it on the box we have when I\u0027m in the office tomorrow.  If that does indeed work then I think this code will still be ok, because the ses-enumerator module (invoked at line 100) will find the disk and enumerate it.  Later when we run the disk enumerator again for that bay it should bail out - but I will definitely test this case to be sure."},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.c","line":92,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Shouldn\u0027t topo_mod_dprintf be provided a newline? I see it\u0027s removed here, but present later in this file. The new disk_nvme.c file doesn\u0027t seem to have any newlines in topo_mod_dprintf."},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.c","line":92,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"topo_mod_dprintf() calls topo_vdprintf() which will automatically append a newline if the string doesn\u0027t already end in one."},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","line":546,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"snapshop/snapshot"},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","line":546,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Done"},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","line":555,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should we have a \u0027goto out;\u0027 here as well?"},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","line":555,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Yes - good catch!  Fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_xml.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/fm/topo/maps/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/Makefile","type":"ADDED","insertions":29,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","type":"ADDED","insertions":40,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","type":"ADDED","insertions":161,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-usb.usbtopo","type":"ADDED","insertions":50,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.c","type":"MODIFIED","insertions":19,"deletions":-6},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":33,"deletions":-15},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":0,"deletions":-33},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_drivers.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","type":"ADDED","insertions":588,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":1,"deletions":-9}],"sizeInsertions":943,"sizeDeletions":-71},{"number":"2","revision":"53a42a062a574c20378f6a05d857f07244260518","parents":["5a02003f48844ffada03336634b28edaff8574ec"],"ref":"refs/changes/21/6921/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1571071704,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_hc.h","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_xml.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/lib/fm/topo/maps/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/Makefile","type":"ADDED","insertions":29,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-chassis-hc-topology.xml","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-hc-topology.xml","type":"ADDED","insertions":161,"deletions":0},{"file":"usr/src/lib/fm/topo/maps/SMCI,SYS-2028U-E1CNRT+/SYS-2028U-E1CNRT+-usb.usbtopo","type":"ADDED","insertions":50,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/disk/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.c","type":"MODIFIED","insertions":19,"deletions":-6},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk.h","type":"MODIFIED","insertions":33,"deletions":-15},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_common.c","type":"MODIFIED","insertions":0,"deletions":-33},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_drivers.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/disk/disk_nvme.c","type":"ADDED","insertions":589,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":1,"deletions":-9}],"sizeInsertions":943,"sizeDeletions":-71}],"allReviewers":[{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}]}