From 53e51bfc924949c64c231a22283a0c5067ec4644 Mon Sep 17 00:00:00 2001
From: Bryan Cantrill <bryan@joyent.com>
Date: Tue, 22 Nov 2016 01:13:07 +0000
Subject: [PATCH] joyent/eng#11 bashstyle should detect trailing whitespace
 joyent/eng#12 bashstyle should be jsstyle-clean

---
 tools/bashstyle | 23 +++++++++++++++++------
 1 file changed, 17 insertions(+), 6 deletions(-)

diff --git a/tools/bashstyle b/tools/bashstyle
index 3e8052e..3ea6622 100755
--- a/tools/bashstyle
+++ b/tools/bashstyle
@@ -79,19 +79,22 @@ function checkFile(filename)
 		if (line.match(/# END BASHSTYLED/)) {
 			if (styled != true) {
 				nerrors++;
-				console.log('%s: %d: END BASHSTYLED w/o corresponding BEGIN',
-				            filename, i);
+				console.log('%s: %d: END BASHSTYLED ' +
+				    'w/o corresponding BEGIN', filename, i);
 			}
 			styled = false;
 		}
 
+		/*JSSTYLED*/
 		if (!styled && line.match(/^\s*local\s+(\w+)\s*=.*\$\(/)) {
 			nerrors++;
+			/*JSSTYLED*/
 			var m = line.match(/^\s*local\s+(\w+)\s*=/);
 			console.log('%s: %d: declaring and setting a "local" ' +
 				'var in the same statement ' +
 				'ignores a subshell return code ' +
-				'<http://www.tldp.org/LDP/abs/html/localvar.html#EXITVALANOMALY01>: ' +
+				'<http://www.tldp.org/LDP/abs/html/' +
+				'localvar.html#EXITVALANOMALY01>: ' +
 				'local %s=...',
 				filename, i, m[1]);
 		}
@@ -100,7 +103,8 @@ function checkFile(filename)
 		// groups before and after brackets to ease search/replace.
 		if (!styled && line.match(/(^|[^\[])\[(\s.+\s)\]([^\]])/)) {
 			nerrors++;
-			console.log('%s: %d: prefer [[ to [ for tests.', filename, i);
+			console.log('%s: %d: prefer [[ to [ for tests.',
+			    filename, i);
 		}
 
 		if (!styled && line.length > 80) {
@@ -108,6 +112,12 @@ function checkFile(filename)
 			console.log('%s: %d: line exceeds 80 columns',
 			    filename, i);
 		}
+
+		if (!styled && line.match(/\s+$/)) {
+			nerrors++;
+			console.log('%s: %d: line ends in whitespace',
+			    filename, i);
+		}
 	}
 
 	if (styled) {
@@ -118,7 +128,8 @@ function checkFile(filename)
 
 
 	/*
-	 * No sane editor lets you save a file without a newline at the very end.
+	 * No sane editor lets you save a file without a newline at the
+	 * very end.
 	 */
 	if (lines[lines.length - 1].length !== 0) {
 		nerrors++;
@@ -155,7 +166,7 @@ function expandTabs(text)
 
 		do {
 			out += ' ';
-		}  while (--k > 0);
+		} while (--k > 0);
 
 		col += k;
 	}
-- 
2.21.0

