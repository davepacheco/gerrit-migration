{"project":"joyent/sdcadm","branch":"master","id":"I1edce7165e890355f1b5e27f863541af70a1d20d","number":"1403","subject":"TOOLS-1645 sdcadm update procedure for HA-ready stateless services Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/1403","commitMessage":"TOOLS-1645 sdcadm update procedure for HA-ready stateless services\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1486054794,"lastUpdated":1487609060,"open":false,"status":"MERGED","comments":[{"timestamp":1486054794,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1486054826,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486065154,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1486065190,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486124294,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1486124331,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1486408914,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1486408950,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1486430598,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(5 comments)\n\nIs there a reason to not consider this new V2 procedure for *all* the stateless services? Even those that are just a single instance on the headnode? I may have missed something obvious."},{"timestamp":1486750884,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1486750922,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486750933,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(5 comments)\n\nOk, another attempt with all the suggestions made and using UpdateSvcV2 also for non HA services."},{"timestamp":1486752120,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nWe partially discussed this in chat. Perhaps:\n\n- put the update-stateless-services-v2.js changes in update-stateless-services-v1.js and just not have a new file.\n- Also, we could consider merging these two functions in lib/procedures/index.js#coordinatePlan:\n\n        function updateSimpleServices(_, next) {\n        function updateSimpleHAReadyServices(_, next) {\n\nThey are pretty close. https://gist.github.com/trentm/a3ab4aa7fd944fdd6cf04d9b5bd02261"},{"timestamp":1487086887,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1487086925,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487086929,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nTrent, all the changes we agreed committed"},{"timestamp":1487271174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1487609022,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1487609026,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"},{"timestamp":1487609060,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"7","revision":"932c322ab61fced8fff9bfbdbd3defc611b2c08a","parents":["e65d00ec66519e97bc2d1bca792c660eb2e4eb0b"],"ref":"refs/changes/03/1403/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1487609022,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487086925,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487271174,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487271174,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1487609026,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":22,"deletions":-66},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":189,"deletions":-63}],"sizeInsertions":211,"sizeDeletions":-338},"patchSets":[{"number":"1","revision":"88c4c4600f4d9dc7a22f2f5cc7f9b669bfe6bc52","parents":["a57e0eaa198414a91d2c1594cc99f06f7832bca1"],"ref":"refs/changes/03/1403/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1486054794,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486054826,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":60,"deletions":-40},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v2.js","type":"ADDED","insertions":262,"deletions":0}],"sizeInsertions":322,"sizeDeletions":-249},{"number":"2","revision":"562b1bb10aa124728cf1f6f0b48744437c279442","parents":["a57e0eaa198414a91d2c1594cc99f06f7832bca1"],"ref":"refs/changes/03/1403/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1486065154,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486065190,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":60,"deletions":-40},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v2.js","type":"ADDED","insertions":263,"deletions":0}],"sizeInsertions":323,"sizeDeletions":-249},{"number":"3","revision":"60a11720d287bdc0e1cf93fba1368f17f7258a7e","parents":["67a2f42b011d95e856210cbe662252234bd9d5a4"],"ref":"refs/changes/03/1403/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1486124294,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486065190,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":60,"deletions":-40},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v2.js","type":"ADDED","insertions":263,"deletions":0}],"sizeInsertions":323,"sizeDeletions":-249},{"number":"4","revision":"48e99bc2d8dc91acc3b85d9e900aad7baacd216a","parents":["15bc1c85511709f20ac8a73f55b7a07436f8e16c"],"ref":"refs/changes/03/1403/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1486408914,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486065190,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/update-stateless-services-v2.js","line":23,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be good to clarify in the top comment that this differs from \"V1\" in being able to support multiple instances and instances not on the local headnode."},{"file":"lib/procedures/update-stateless-services-v2.js","line":23,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-stateless-services-v2.js","line":56,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"on"},{"file":"lib/procedures/update-stateless-services-v2.js","line":56,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-stateless-services-v2.js","line":62,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"on"},{"file":"lib/procedures/update-stateless-services-v2.js","line":62,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-stateless-services-v2.js","line":98,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is hardcoded `false` just above, so this check isn\u0027t necessary."},{"file":"lib/procedures/update-stateless-services-v2.js","line":98,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not really, what it was set was `arg.HA` not `change.HA`, which is set below on this same file"},{"file":"lib/procedures/update-stateless-services-v2.js","line":101,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"IIUC, \u0027tmpAlias\u0027 is only used by shared.provisionTmpVm, which isn\u0027t used here, I don\u0027t think. So this ref to tmpAlias and above can be dropped."},{"file":"lib/procedures/update-stateless-services-v2.js","line":101,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":60,"deletions":-40},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v2.js","type":"ADDED","insertions":263,"deletions":0}],"sizeInsertions":323,"sizeDeletions":-249},{"number":"5","revision":"a5a8df2d5cb3bfe54bd9aabc9e75df7bee9e47fb","parents":["bc6e8bfa1cd91ec3946b0bd57829ff9e6a733907"],"ref":"refs/changes/03/1403/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1486750884,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486750922,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":65,"deletions":-45},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v2.js","type":"ADDED","insertions":277,"deletions":0}],"sizeInsertions":342,"sizeDeletions":-254},{"number":"6","revision":"1edce7165e890355f1b5e27f863541af70a1d20d","parents":["541923162247dbb232cfc842a33842f6da6dcf2c"],"ref":"refs/changes/03/1403/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1487086887,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487086925,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487271174,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487271174,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/procedures/update-stateless-services-v1.js","line":179,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be nice to merge these sections someday. IIUC, there is no reason to need to divide between multiple and since insts here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":22,"deletions":-66},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":189,"deletions":-63}],"sizeInsertions":211,"sizeDeletions":-338},{"number":"7","revision":"932c322ab61fced8fff9bfbdbd3defc611b2c08a","parents":["e65d00ec66519e97bc2d1bca792c660eb2e4eb0b"],"ref":"refs/changes/03/1403/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1487609022,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487086925,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487271174,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487271174,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1487609026,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":22,"deletions":-66},{"file":"lib/procedures/update-mahi-v2.js","type":"DELETED","insertions":0,"deletions":-209},{"file":"lib/procedures/update-stateless-services-v1.js","type":"MODIFIED","insertions":189,"deletions":-63}],"sizeInsertions":211,"sizeDeletions":-338}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}