From e450cc8acbcb43eb1c2de2df965d910a9e7231a6 Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Fri, 27 Sep 2019 21:02:03 +0000
Subject: [PATCH] OS-8001 vmadm create chokes if no zvols created for bhyve

---
 src/vm/node_modules/VM.js | 16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 48eff549..edf119d1 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -1452,7 +1452,7 @@ function setQuotaBhyve(opts, callback) {
     var dataset = opts.dataset;
     var volumes = [];
     var volsize = 0;
-    var volrefres;
+    var volrefres = 0;
 
 
     // maxQuota is in GiB
@@ -1498,13 +1498,17 @@ function setQuotaBhyve(opts, callback) {
                     return;
                 }
 
+                if (fds.stdout === '') {
+                    // The guest has no normal disks: probably uses live CD.
+                    next();
+                    return;
+                }
+
                 fds.stdout.trim().split('\n').forEach(function (line) {
                     var fields = line.split('\t');
                     volumes.push(fields[0]);
                     volsize += parseInt(fields[1], 10);
                 });
-                assert(volumes.length > 0, 'at least 1 volume must be present');
-                assert(volsize > 0, 'volume size must be non-zero');
                 next();
             });
         },
@@ -1530,6 +1534,12 @@ function setQuotaBhyve(opts, callback) {
         function getVolumeCalculatedRefRes(_, next) {
             // Get the values which were calculated by the system when we set
             // the refreservation to 'auto'
+
+            if (volumes.length === 0) {
+                next();
+                return;
+            }
+
             var zfsArgs = [
                 'list', '-Hpr', '-t', 'volume',
                 '-o', 'refreservation',
-- 
2.17.2 (Apple Git-113)

