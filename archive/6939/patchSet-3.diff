From c19858a8087b57959bc40367cfdaa17963dd28fa Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Fri, 27 Sep 2019 21:02:03 +0000
Subject: [PATCH] =?UTF-8?q?OS-8001=20vmadm=20create=20chokes=20if=20no=20z?=
 =?UTF-8?q?vols=20created=20for=20bhyve=20Reviewed=20by:=20Jorge=20Schrauw?=
 =?UTF-8?q?en=20<sjorge@blackdot.be>=20Reviewed=20by:=20Pedro=20Palaz?=
 =?UTF-8?q?=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved=20by:=20Pedro?=
 =?UTF-8?q?=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/vm/node_modules/VM.js | 16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 48eff549..edf119d1 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -1452,7 +1452,7 @@ function setQuotaBhyve(opts, callback) {
     var dataset = opts.dataset;
     var volumes = [];
     var volsize = 0;
-    var volrefres;
+    var volrefres = 0;
 
 
     // maxQuota is in GiB
@@ -1498,13 +1498,17 @@ function setQuotaBhyve(opts, callback) {
                     return;
                 }
 
+                if (fds.stdout === '') {
+                    // The guest has no normal disks: probably uses live CD.
+                    next();
+                    return;
+                }
+
                 fds.stdout.trim().split('\n').forEach(function (line) {
                     var fields = line.split('\t');
                     volumes.push(fields[0]);
                     volsize += parseInt(fields[1], 10);
                 });
-                assert(volumes.length > 0, 'at least 1 volume must be present');
-                assert(volsize > 0, 'volume size must be non-zero');
                 next();
             });
         },
@@ -1530,6 +1534,12 @@ function setQuotaBhyve(opts, callback) {
         function getVolumeCalculatedRefRes(_, next) {
             // Get the values which were calculated by the system when we set
             // the refreservation to 'auto'
+
+            if (volumes.length === 0) {
+                next();
+                return;
+            }
+
             var zfsArgs = [
                 'list', '-Hpr', '-t', 'volume',
                 '-o', 'refreservation',
-- 
2.17.2 (Apple Git-113)

