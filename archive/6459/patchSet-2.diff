From cb8f613ca0745ccc94b3c3c8ab0dc0d571dfb208 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 18 Jun 2019 14:18:42 +0200
Subject: [PATCH] TRITON-1649 Add "flexible_disk" to AdminUI packages UI

---
 .eslintrc                     | 18 +++++++
 less/package.less             |  8 +--
 lib/packages.js               | 92 ++++++++++++++++++++++-----------
 tools/rsync-to                | 76 +++++++++++++++++++++++++++
 www/js/tpl/package.hbs        | 25 ++++++++-
 www/js/tpl/packages-form.hbs  | 43 +++++++++++++---
 www/js/views/package.js       | 71 ++++++++++++++++----------
 www/js/views/packages-form.js | 96 +++++++++++++++++++++++++++--------
 www/js/views/packages.js      | 24 +++++----
 9 files changed, 352 insertions(+), 101 deletions(-)
 create mode 100644 .eslintrc
 create mode 100755 tools/rsync-to

diff --git a/.eslintrc b/.eslintrc
new file mode 100644
index 00000000..5269a7a1
--- /dev/null
+++ b/.eslintrc
@@ -0,0 +1,18 @@
+{
+    "env": {
+        "browser": true,
+        "node": true
+    },
+    "rules": {
+        "max-len": [
+            "error",
+            80,
+            {
+                "tabWidth": 8,
+                "ignoreComments": false,
+                "ignoreTrailingComments": false,
+                "ignoreUrls": true
+            }
+        ],
+    }
+}
diff --git a/less/package.less b/less/package.less
index 0c4d9a9b..08f32256 100644
--- a/less/package.less
+++ b/less/package.less
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 #page-package {
@@ -82,8 +82,9 @@
 
   form .package-owners .controls { margin-bottom: 1em; }
   form .package-owners .add-owner-entry { clear: both; margin-left: 180px;}
+  form .disks .add-disk-entry { clear: both; margin-left: 180px; }
 
-  .owner, .description, .billing-id, .memory, .quota, .vcpus, .swap, .max-processes, .cpu-cap, .io-priority, .brand {
+  .owner, .description, .billing-id, .memory, .quota, .vcpus, .swap, .max-processes, .cpu-cap, .io-priority, .brand, .flexible-disk, .disk-size {
     .widget-content;
 
     strong {
@@ -98,7 +99,6 @@
     }
   }
 
-
   .description {
     font-weight: bold;
     padding-left: 24px;
@@ -123,7 +123,7 @@
 }
 
 #page-package-form {
-  .add-owner-entry {
+  .add-owner-entry, .add-disk-entry {
     padding: 10px;
     display: block;
   }
diff --git a/lib/packages.js b/lib/packages.js
index 22165612..46e7deea 100644
--- a/lib/packages.js
+++ b/lib/packages.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var _ = require('underscore');
@@ -30,16 +30,29 @@ module.exports.add = function (req, res, next) {
         delete params.brand;
     }
 
+    // We don't support disks/flexible_disk for anything than Bhyve right now
+    if (!params.flexible_disk || params.flexible_disk.length === 0 ||
+            (params.brand && params.brand !== 'bhyve')) {
+        delete params.flexible_disk;
+    }
+
+    if (!params.disks || params.disks.length === 0 ||
+        (params.brand && params.brand !== 'bhyve')) {
+        delete params.disks;
+    }
+
     req.log.info(params, 'papi.add');
 
-    pkgclient.add(params, {headers: {'x-request-id': req.getId()}}, function (err, pkg) {
+    pkgclient.add(params, {
+        headers: {'x-request-id': req.getId()}
+    }, function (err, pkg) {
         if (err) {
             req.log.fatal(err, 'Error adding package', params);
-            return next(err);
-        } else {
-            res.send(pkg);
-            return next();
+            next(err);
+            return;
         }
+        res.send(pkg);
+        next();
     });
 };
 
@@ -47,26 +60,30 @@ module.exports.add = function (req, res, next) {
 
 module.exports.del = function (req, res, next) {
     var pkgclient = req.sdc[req.dc].papi;
-    pkgclient.del(req.params.uuid, {headers: {'x-request-id': req.getId()}}, function (err, pkg) {
+    pkgclient.del(req.params.uuid, {
+        headers: {'x-request-id': req.getId()}
+    }, function (err, pkg) {
         if (err) {
-            return next(err);
-        } else {
-            res.send(pkg);
-            return next();
+            next(err);
+            return;
         }
+        res.send(pkg);
+        next();
     });
 };
 
 
 module.exports.get = function (req, res, next) {
     var pkgclient = req.sdc[req.dc].papi;
-    pkgclient.get(req.params.uuid, {headers: {'x-request-id': req.getId()}}, function (err, pkg) {
+    pkgclient.get(req.params.uuid, {
+        headers: {'x-request-id': req.getId()}
+    }, function (err, pkg) {
         if (err) {
-            return next(err);
-        } else {
-            res.send(pkg);
-            return next();
+            next(err);
+            return;
         }
+        res.send(pkg);
+        next();
     });
 };
 
@@ -74,9 +91,12 @@ module.exports.get = function (req, res, next) {
 module.exports.update = function (req, res, next) {
     var pkgclient = req.sdc[req.dc].papi;
 
-    pkgclient.get(req.params.uuid, {headers: {'x-request-id': req.getId()}}, function (err, pkg) {
+    pkgclient.get(req.params.uuid, {
+        headers: {'x-request-id': req.getId()}
+    }, function (err, pkg) {
         if (err) {
-            req.log.fatal(err, 'Error retrieving package info', req.params.uuid);
+            req.log.fatal(
+                err, 'Error retrieving package info', req.params.uuid);
             next(err);
             return;
         }
@@ -88,7 +108,6 @@ module.exports.update = function (req, res, next) {
             }
         }
 
-
         if (!changes.owner_uuid || changes.owner_uuid.length === 0) {
             delete changes.owner_uuid;
         }
@@ -97,9 +116,12 @@ module.exports.update = function (req, res, next) {
         req.log.info('sdc-clients.package.update',
             {uuid: req.params.uuid, changes: changes});
 
-        pkgclient.update(pkg.uuid, changes, {headers: {'x-request-id': req.getId()}}, function (updateErr) {
+        pkgclient.update(pkg.uuid, changes, {
+            headers: {'x-request-id': req.getId()}
+        }, function (updateErr) {
             if (updateErr) {
-                req.log.fatal(updateErr, 'Error updating package', pkg.uuid, changes);
+                req.log.fatal(
+                    updateErr, 'Error updating package', pkg.uuid, changes);
                 next(updateErr);
                 return;
             }
@@ -130,13 +152,16 @@ module.exports.list = function (req, res, next) {
             if (key === 'group' || key === 'traits') {
                 return;
             }
-            // We need to distinguish the exact name search from partial name search by tweaking the
-            // argument of the latter to 'name_substring'. Exact name search is done when displaying the
-            // different versions of the same package name on the details page. Partial name search
-            // is used on the list page. Both result in the same search key 'name' in papi but have
-            // different argument/filter syntax.
+            // We need to distinguish the exact name search from partial name
+            // search by tweaking the argument of the latter to
+            // 'name_substring'. Exact name search is done when displaying the
+            // different versions of the same package name on the details page.
+            // Partial name search is used on the list page. Both result in the
+            // same search key 'name' in papi but have different
+            // argument/filter syntax.
             if (typeof (value) === 'string' && value.length) {
-                if (key === 'billing_id' || key === 'name' || value === 'true' || value === 'false') {
+                if (key === 'billing_id' || key === 'name' ||
+                    value === 'true' || value === 'false') {
                     if (key === 'billing_id') {
                         filter.push(sprintf('(%s=%s)', 'uuid', value));
                     } else {
@@ -144,9 +169,13 @@ module.exports.list = function (req, res, next) {
                     }
                 } else {
                     if (key === 'name_substring') {
-                        filter.push(sprintf('(%s:caseIgnoreSubstringsMatch:=*%s*)', 'name', value));
+                        filter.push(sprintf(
+                            '(%s:caseIgnoreSubstringsMatch:=*%s*)',
+                            'name', value));
                     } else {
-                        filter.push(sprintf('(%s:caseIgnoreSubstringsMatch:=*%s*)', key, value));
+                        filter.push(sprintf(
+                            '(%s:caseIgnoreSubstringsMatch:=*%s*)',
+                            key, value));
                     }
                 }
                 return;
@@ -174,7 +203,8 @@ module.exports.list = function (req, res, next) {
 
     pkgclient.list(ldapFilter || filter, opts, function (err, packages) {
         if (err) {
-            return next(err);
+            next(err);
+            return;
         }
         if (req.query.group) {
             packages = packages.filter(function (p) {
@@ -186,6 +216,6 @@ module.exports.list = function (req, res, next) {
         }
 
         res.send(packages);
-        return next();
+        next();
     });
 };
diff --git a/tools/rsync-to b/tools/rsync-to
new file mode 100755
index 00000000..e01ea7b1
--- /dev/null
+++ b/tools/rsync-to
@@ -0,0 +1,76 @@
+#!/bin/bash
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+#
+# Copyright 2019 Joyent, Inc.
+#
+
+#
+# Rsync the adminui build in this working copy to the install on the given
+# HN. If there are multiple adminui instances and/or the instance isn't
+# on the HN, this'll fail.
+#
+
+# This is different than the other repos rsync-to script, since
+# This program takes the files in www/js and less/ and converts and bundles
+# them using tools/bundle.js, and then syncs those files and the files under
+# less/ and www/js to the adminui zone.
+
+if [[ -n "$TRACE" ]]; then
+    export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
+    set -o xtrace
+fi
+set -o errexit
+set -o pipefail
+
+TOP=$(cd $(dirname $0)/../; pwd)
+NODE=root@$1
+
+if [[ -z "$ADMINUI_ZONE" ]]; then
+    ADMINUI_ZONE=$(ssh $NODE "/opt/smartdc/bin/sdc-vmapi /vms" 2>/dev/null \
+        | json -H -c 'this.tags && this.tags.smartdc_role === "adminui"' \
+            -c 'this.state === "running"' 0.uuid)
+fi
+echo "ADMINUI_ZONE: $ADMINUI_ZONE"
+
+extraOpts=
+if [[ $(uname -s) != "SunOS" ]]; then
+    extraOpts="--exclude *.node --exclude build"
+else
+    # Clean node_modules everytime.
+    ssh $NODE rm -rf /zones/$ADMINUI_ZONE/root/opt/smartdc/adminui/node_modules
+fi
+
+echo "Rebuilding files"
+
+${TOP}/tools/bundle.js | ${TOP}/node_modules/bunyan/bin/bunyan
+
+echo "Syncing files"
+
+rsync -av ${TOP}/www/app.js \
+    $NODE:/zones/$ADMINUI_ZONE/root/opt/smartdc/adminui/www/
+
+rsync -av ${TOP}/www/app.css \
+    $NODE:/zones/$ADMINUI_ZONE/root/opt/smartdc/adminui/www/
+
+rsync -av ${TOP}/www/libs.js \
+    $NODE:/zones/$ADMINUI_ZONE/root/opt/smartdc/adminui/www/
+
+rsync -av ${TOP}/less \
+    $NODE:/zones/$ADMINUI_ZONE/root/opt/smartdc/adminui/less
+
+SERVICES=$(ssh ${NODE} svcs -z ${ADMINUI_ZONE} -H -o fmri adminui)
+for service in $SERVICES; do
+    state=$(ssh ${NODE} svcs -z ${ADMINUI_ZONE} -H -o state $service)
+    if [[ "$state" == "maintenance" ]]; then
+        ssh ${NODE} svcadm -z ${ADMINUI_ZONE} clear $service
+    else
+        ssh ${NODE} svcadm -z ${ADMINUI_ZONE} restart $service
+    fi
+done
+ssh ${NODE} svcadm -z ${ADMINUI_ZONE} restart config-agent
+
diff --git a/www/js/tpl/package.hbs b/www/js/tpl/package.hbs
index 0f9ff4a8..76b51fa9 100644
--- a/www/js/tpl/package.hbs
+++ b/www/js/tpl/package.hbs
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright 2019 Joyent, Inc.
 -->
 
 <div class="page-header">
@@ -102,6 +102,29 @@
     <div class="value">{{brand}}</div>
   </div>
 
+  <div class="flexible-disk">
+    <strong>Flexible disk</strong>
+    <div class="value">{{flexible_disk}}</div>
+  </div>
+
+
+  {{#if disks}}
+  <div class="disks">
+    <h4>Disks (Only when Brand is <em>"Bhyve"</em>)</h4>
+    <div class="disk-size">
+      {{#each disks}}
+        <strong>Size</strong>
+        {{#if this.size}}
+        <div class="value">{{this.size}}</div>
+        {{else}}
+        <div class="value">OS disk (size set by image)</div>
+        {{/if}}
+        <br />
+      {{/each}}
+    </div>
+  </div>
+  {{/if}}
+
   <section class="networks">
     <h3>Networks</h3>
     <div class="networks-list"></div>
diff --git a/www/js/tpl/packages-form.hbs b/www/js/tpl/packages-form.hbs
index 5f0a9297..0904efd1 100644
--- a/www/js/tpl/packages-form.hbs
+++ b/www/js/tpl/packages-form.hbs
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright 2019 Joyent, Inc.
 -->
 
 <div class="row">
@@ -229,15 +229,41 @@
             <div class="col-md-7">
                 <select class="form-control" name="brand">
                     <option></option>
-                    <option value="joyent">joyent</option>
-                    <option value="joyent-minimal">joyent-minimal</option>
-                    <option value="kvm">kvm</option>
-                    <option value="bhyve">bhyve</option>
-                    <option value="lx">lx</option>
+                    <option value="joyent" {{#ifeq brand "joyent"}}selected{{/ifeq}}>joyent</option>
+                    <option value="joyent-minimal"> {{#ifeq brand "joyent-minimal"}}selected{{/ifeq}}joyent-minimal</option>
+                    <option value="kvm"> {{#ifeq brand "kvm"}}selected{{/ifeq}}kvm</option>
+                    <option value="bhyve" {{#ifeq brand "bhyve"}}selected{{/ifeq}}>bhyve</option>
+                    <option value="lx" {{#ifeq brand "lx"}}selected{{/ifeq}}>lx</option>
                 </select>
             </div>
         </div>
 
+
+      <div class="form-group package-disks">
+        <label class="control-label col-sm-4" for="package-disk">Disks</label>
+        <div class="col-sm-6">
+            {{#unless disks.length}}
+            <input type="text"
+                 class="form-control input-xl package-disk"
+                 name="disks[]"
+                 placeholder="Disk size in MiB">
+            {{else}}
+
+            {{#each disks}}
+              <input type="text"
+                  value="{{size}}"
+                  class="form-control package-disk"
+                  name="disks[]"
+                  placeholder="Disk size in MiB">
+            {{/each}}
+            {{/unless}}
+        </div>
+        <div class="clearfix"></div>
+        <div class="col-sm-6 col-sm-offset-4">
+            <a class="add-disk-entry"><i class="fa fa-plus"></i> Add Another Disk (Bhyve only)</a>
+        </div>
+      </div>
+
       {{/unless}}
 
       <div class="form-group">
@@ -248,6 +274,11 @@
           <div class="checkbox">
             <label><input type="checkbox" {{#if default}}checked{{/if}} name="default"> Make this the Default Package</label>
           </div>
+          {{#unless changeOwnerMode}}
+          <div class="checkbox">
+            <label><input type="checkbox" {{#if flexible_disk}}checked{{/if}} name="flexible_disk" {{#ifnoteq brand "bhyve"}}disabled{{/ifnoteq}}> Flexible Disk (Bhyve only)</label>
+          </div>
+          {{/unless}}
         </div>
       </div>
 
diff --git a/www/js/views/package.js b/www/js/views/package.js
index 0cea3d25..d452ac96 100644
--- a/www/js/views/package.js
+++ b/www/js/views/package.js
@@ -5,10 +5,10 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
-"use strict";
+'use strict';
 
 var Backbone = require('backbone');
 var _ = require('underscore');
@@ -20,8 +20,10 @@ var Packages = require('../models/packages');
 
 var User = require('../models/user');
 
-var NetworksList = React.createFactory(require('../components/pages/networking/networks-list'));
-var NetworkPoolsList = React.createFactory(require('../components/pages/networking/network-pool-list'));
+var NetworksList = React.createFactory(
+    require('../components/pages/networking/networks-list'));
+var NetworkPoolsList = React.createFactory(
+    require('../components/pages/networking/network-pool-list'));
 
 var TraitsEditor = require('./traits-editor');
 var PackageTemplate = require('../tpl/package.hbs');
@@ -29,15 +31,24 @@ var PackageTemplate = require('../tpl/package.hbs');
 var NotesComponent = React.createFactory(require('../components/notes'));
 
 var Handlebars = require('handlebars');
-Handlebars.registerHelper('normalize', function(v) {
+Handlebars.registerHelper('normalize', function (v) {
     v = Number(v);
     if (v % 1024 === 0) {
-        return _.str.sprintf("%d GB", v / 1024);
+        return _.str.sprintf('%d GB', v / 1024);
     }
 
-    return _.str.sprintf("%d MB", v);
+    return _.str.sprintf('%d MB', v);
 });
 
+Handlebars.registerHelper('ifeq', function (a, b, options) {
+    if (a == b) { return options.fn(this); }
+    return options.inverse(this);
+});
+
+Handlebars.registerHelper('ifnoteq', function (a, b, options) {
+    if (a != b) { return options.fn(this); }
+    return options.inverse(this);
+});
 
 
 var PackageVersions = Backbone.Marionette.CompositeView.extend({
@@ -51,10 +62,10 @@ var PackageVersions = Backbone.Marionette.CompositeView.extend({
         events: {
             'click a': 'onClickPackageVersion'
         },
-        onClickPackageVersion: function() {
+        onClickPackageVersion: function () {
             adminui.vent.trigger('showview', 'package', {model: this.model });
         },
-        onRender: function() {
+        onRender: function () {
             if (this.package.get('uuid') === this.model.get('uuid')) {
                 this.$el.addClass('active');
                 console.log(this.model);
@@ -62,17 +73,17 @@ var PackageVersions = Backbone.Marionette.CompositeView.extend({
         }
     }),
     itemViewContainer: 'ul',
-    initialize: function(options) {
-        if (typeof(options.package) !== 'object') {
+    initialize: function (options) {
+        if (typeof (options.package) !== 'object') {
             throw TypeError('options.package should be a package model');
         }
         this.package = options.package;
         this.collection = new Packages();
     },
-    onBeforeItemAdded: function(iv) {
+    onBeforeItemAdded: function (iv) {
         iv.package = this.package;
     },
-    onShow: function() {
+    onShow: function () {
         this.collection.fetch({params: {name: this.package.get('name')}});
     }
 });
@@ -90,7 +101,7 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
 
     sidebar: 'packages',
 
-    url: function() {
+    url: function () {
         return ('packages/' + this.model.get('uuid'));
     },
 
@@ -102,7 +113,7 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
         'click .login': 'navigateToUser'
     },
 
-    initialize: function (options) {
+    initialize: function (_options) {
         this.packageVersionsView = new PackageVersions({
             package: this.model
         });
@@ -112,7 +123,7 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
         var data = _.clone(this.model.toJSON());
         var owner_uuid = this.model.get('owner_uuid');
 
-        if (typeof(owner_uuid) === 'string') {
+        if (typeof (owner_uuid) === 'string') {
             data.owner_uuid = [owner_uuid];
         }
 
@@ -121,7 +132,9 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
 
     navigateToUser: function (e) {
         e.preventDefault();
-        adminui.vent.trigger('showcomponent', 'user', {uuid: $(e.target).attr('data-uuid')});
+        adminui.vent.trigger('showcomponent', 'user', {
+            uuid: $(e.target).attr('data-uuid')
+        });
     },
 
     onChangeOwner: function () {
@@ -139,23 +152,24 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
     },
 
     onSaveTraits: function (traits) {
-        var that = this;
+        var self = this;
         this.model.save(
             { traits: traits },
             { patch: true }
-        ).done(function() {
+        ).done(function () {
             adminui.vent.trigger('notification', {
                 level: 'success',
                 message: 'Package traits saved successfully.'
             });
-            that.traitsEditor.close();
+            self.traitsEditor.close();
         });
     },
 
     onTraits: function () {
         this.traitsEditor = new TraitsEditor({
             data: this.model.get('traits'),
-            title: _.str.sprintf('Traits Editor for package: %s', this.model.get('name'))
+            title: _.str.sprintf('Traits Editor for package: %s',
+                this.model.get('name'))
         });
         this.listenTo(this.traitsEditor, 'save', this.onSaveTraits, this);
         this.traitsEditor.show();
@@ -166,13 +180,18 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
     },
 
     onRender: function () {
-        adminui.vent.trigger('settitle', _.str.sprintf('package: %s', this.model.get('name'), this.model.get('version')));
+        adminui.vent.trigger('settitle', _.str.sprintf(
+            'package: %s', this.model.get('name'), this.model.get('version')));
         var networks = this.model.get('networks') || [];
         if (!networks.length) {
             this.$('.networks').hide();
         } else {
-            React.render(new NetworksList({uuids: networks, showHeader: false}), this.$('.networks-list').get(0));
-            React.render(new NetworkPoolsList({uuids: networks}), this.$('.network-pools-list').get(0));
+            React.render(new NetworksList({
+                uuids: networks, showHeader: false
+            }), this.$('.networks-list').get(0));
+            React.render(new NetworkPoolsList({
+                uuids: networks
+            }), this.$('.network-pools-list').get(0));
         }
 
         if (adminui.user.role('operators')) {
@@ -181,9 +200,9 @@ var PackageDetail = Backbone.Marionette.Layout.extend({
                 this.$('.notes-component-container').get(0));
         }
 
-        this.$('.owner .login').each(function (i, elm) {
+        this.$('.owner .login').each(function (_i, elm) {
             var user = new User({uuid: $(elm).attr('data-uuid')});
-            user.fetch().done(function (u) {
+            user.fetch().done(function (_u) {
                 $(elm).html(user.get('login'));
             });
         });
diff --git a/www/js/views/packages-form.js b/www/js/views/packages-form.js
index e7e358eb..71950c56 100644
--- a/www/js/views/packages-form.js
+++ b/www/js/views/packages-form.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var Backbone = require('backbone');
@@ -29,20 +29,24 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
     events: {
         'submit': 'onSubmit',
         'click a.add-owner-entry': 'onAddOwnerEntry',
+        'click a.add-disk-entry': 'onAddDiskEntry',
         'click button[type=cancel]': 'onCancel',
-        'input input': 'onChangeInput'
+        'input input': 'onChangeInput',
+        'change select[name=brand]': 'onChangeSelect'
     },
 
-    initialize: function(options) {
+    initialize: function (options) {
         options = options || {};
 
         if (!options.model) {
-            this.model = new Package({ version: "1.0.0" });
+            this.model = new Package({ version: '1.0.0' });
         }
     },
 
-    onAddOwnerEntry: function() {
-        var node = $('<input type="text" class="form-control" name="owner_uuids[]" placeholder="Search by login, email or uuid"></div>');
+    onAddOwnerEntry: function () {
+        var node = $('<input type="text" class="form-control" ' +
+            'name="owner_uuids[]" ' +
+            'placeholder="Search by login, email or uuid"></div>');
 
         this.$('.add-owner-entry').before(node);
 
@@ -55,12 +59,37 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
         userInput.$el.focus();
     },
 
-    onChangeInput: function() {
+
+    onAddDiskEntry: function () {
+        if (this.$('select[name=brand]').val() !== 'bhyve') {
+            var msg = 'Disks can be added only to Bhyve branded packages';
+            adminui.vent.trigger('notification', {
+                level: 'warn',
+                message: msg
+            });
+            return;
+        }
+        var node = $('<input type="text" class="form-control" ' +
+            'name="disks[]" ' +
+            'placeholder="Add disk size in MiB or \'remaining\'"></div>');
+
+        this.$('.add-disk-entry').before(node);
+
+        var userInput = new UserInput({
+            el: $(node),
+            showPreview: true
+        });
+
+        userInput.render();
+        userInput.$el.focus();
+    },
+
+    onChangeInput: function () {
         console.log('changeInput');
         this.checkFields();
     },
 
-    checkFields: function() {
+    checkFields: function () {
         if (this.options.mode !== 'change-owner') {
             if (this.$('input[name=version]').val().length) {
                 this.$('button[type=submit]').prop('disabled', false);
@@ -70,7 +99,22 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
         }
     },
 
-    onError: function(model, xhr) {
+    onChangeSelect: function () {
+        console.log('changeSelect');
+        this.checkBrandSpecifics();
+    },
+
+    checkBrandSpecifics: function () {
+        if (this.$('select[name=brand]').val() === 'bhyve') {
+            this.$('input[name=flexible_disk]').prop('disabled', false);
+            this.$('input[name="disks[]"]').prop('disabled', false);
+        } else {
+            this.$('input[name=flexible_disk]').prop('disabled', true);
+            this.$('input[name="disks[]"]').prop('disabled', true);
+        }
+    },
+
+    onError: function (_model, xhr) {
         var error = xhr.responseData;
         this.renderError(error);
 
@@ -79,7 +123,7 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
         }, 200);
     },
 
-    onCancel: function(e) {
+    onCancel: function (e) {
         e.preventDefault();
 
         if (this.model.isNew()) {
@@ -89,19 +133,25 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
         }
     },
 
-    onSubmit: function(e) {
+    onSubmit: function (e) {
         e.preventDefault();
 
         var values = Backbone.Syphon.serialize(this);
         values.owner_uuids = _.compact(values.owner_uuids);
+        if (this.options.mode !== 'change-owner' && values.disks) {
+            values.disks = _.compact(values.disks);
+            values.disks = _.map(values.disks, function (size) {
+                return ({ size: (size === 'remaining') ? size : Number(size) });
+            });
+        }
 
         if (this.options.mode === 'new-version') {
             this.model.unset('uuid');
         }
 
 
-        _.each(values, function(v, k) {
-            if (typeof(v) === 'string' && /^\d+$/.test(v)) {
+        _.each(values, function (v, k) {
+            if (typeof (v) === 'string' && /^\d+$/.test(v)) {
                 values[k] = Number(v);
             }
             if (k === 'name' || k === 'version') {
@@ -112,17 +162,17 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
 
         this.model.save(values, {
             patch: true,
-            success: function(model, resp) {
-                adminui.vent.trigger('showview', 'package', {model:  model});
+            success: function (model, resp) {
+                adminui.vent.trigger('showview', 'package', {model: model});
                 adminui.vent.trigger('notification', {
                     level: 'success',
-                    message: "Package saved succesfully."
+                    message: 'Package saved succesfully.'
                 });
             }
         });
     },
 
-    serializeData: function() {
+    serializeData: function () {
         var data = this.model.toJSON();
         if (data.owner_uuid && _.isArray(data.owner_uuid) === false) {
             data.owner_uuid = [data.owner_uuid];
@@ -133,20 +183,22 @@ var PackageForm = Backbone.Marionette.ItemView.extend({
 
         return data;
     },
-    renderError: function(error) {
+    renderError: function (error) {
         var c = this.$('.error-alert-container').get(0);
         React.render(ErrorAlert({error: error}), c);
     },
 
-    onRender: function() {
-        this.userInput = new UserInput({el: this.$('.package-owner'), showPreview: true});
+    onRender: function () {
+        this.userInput = new UserInput({
+            el: this.$('.package-owner'), showPreview: true
+        });
         this.userInput.render();
         this.checkFields();
     },
 
-    onShow: function() {
+    onShow: function () {
         if (this.options.mode === 'new-version') {
-            this.$("#package-version").focus();
+            this.$('#package-version').focus();
         } else {
             this.$('input:first').focus();
         }
diff --git a/www/js/views/packages.js b/www/js/views/packages.js
index 8799573a..f1a2da20 100644
--- a/www/js/views/packages.js
+++ b/www/js/views/packages.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var Backbone = require('backbone');
@@ -27,10 +27,10 @@ var Handlebars = require('handlebars');
 Handlebars.registerHelper('normalize', function (v) {
     v = Number(v);
     if (v % 1024 === 0) {
-        return _.str.sprintf("%d GB", v / 1024);
+        return _.str.sprintf('%d GB', v / 1024);
     }
 
-    return _.str.sprintf("%d MB", v);
+    return _.str.sprintf('%d MB', v);
 });
 
 var PackagesListItemView = Backbone.Marionette.ItemView.extend({
@@ -79,7 +79,7 @@ var PackagesView = Backbone.Marionette.Layout.extend({
     },
 
     attributes: {
-        id: "page-packages"
+        id: 'page-packages'
     },
 
     events: {
@@ -102,7 +102,8 @@ var PackagesView = Backbone.Marionette.Layout.extend({
 
     url: function () {
         var url = 'packages';
-        return location.pathname === '/packages' ? (url + location.search || '') : url;
+        return location.pathname === '/packages' ?
+            (url + location.search || '') : url;
     },
     template: PackagesTemplate,
 
@@ -206,7 +207,8 @@ var PackagesView = Backbone.Marionette.Layout.extend({
                 if (key.match(field)) {
                     var target = field === 'quota' ? 'disk' : 'ram';
                     $('select[name=' + target +  '-op] option[value="' +
-                        key.replace(/([a-z&\]&\[&\_])/g, '') + '"]').attr('selected', 'true');
+                        key.replace(/([a-z&\]&\[&\_])/g, '') + '"]').attr(
+                            'selected', 'true');
 
                     $('input[name=' + target +  '-value]').val(options[key]);
                 }
@@ -217,7 +219,8 @@ var PackagesView = Backbone.Marionette.Layout.extend({
     getFilterOptions: function () {
         var self = this;
         var getValue = function (name) {
-            return $((name === 'active' ? 'select' : 'input') + '[name=' + name + ']').val();
+            return $((name === 'active' ? 'select' : 'input') +
+                '[name=' + name + ']').val();
         };
 
         var data = {
@@ -230,7 +233,8 @@ var PackagesView = Backbone.Marionette.Layout.extend({
 
         Object.keys(data).forEach(function (key) {
             var value = data[key];
-            if (value && ((key === 'active' && value === 'true' || value === 'false') || key !== 'active')) {
+            if (value && ((key === 'active' && value === 'true' ||
+                value === 'false') || key !== 'active')) {
                 self.filterOptions[key] = value;
             } else {
                 delete self.filterOptions[key];
@@ -259,14 +263,12 @@ var PackagesView = Backbone.Marionette.Layout.extend({
 
     showForm: function (model) {
         if (!model) {
-            this.$(".sidebar").animate({
+            this.$('.sidebar').animate({
                 opacity: 0.4
             });
             this.list.currentView.deselect();
         }
-
     }
-
 });
 
 
-- 
2.21.0

