From bfe2e281be076a1bb86cd4a8d1296a9cf87d2f2e Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Tue, 10 Jul 2018 08:21:39 -0700
Subject: [PATCH] joyent/node-artedi#15 hashObj() is too damn expensive
 Reviewed by: Kody A Kantor <kody@kkantor.com> Approved by: Kody A Kantor
 <kody@kkantor.com>

---
 CHANGES.md   |  3 +++
 lib/utils.js | 26 +++++++++++++++-----------
 package.json |  2 +-
 3 files changed, 19 insertions(+), 12 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 49d1c8f..c4cd2aa 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -3,6 +3,9 @@
 ## Not yet released
 None
 
+## 1.4.1
+* #15 improve the performance of hashObj()
+
 ## 1.4.0
 * #14 Allow for metrics in a MetricVector to be optionally expired or reset to a
     default value
diff --git a/lib/utils.js b/lib/utils.js
index 495ce79..48b9ec1 100644
--- a/lib/utils.js
+++ b/lib/utils.js
@@ -3,15 +3,13 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
  *
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 var mod_assert = require('assert-plus');
 var mod_jsprim = require('jsprim');
 var VError = require('verror').VError;
 
-var mod_crypto = require('crypto');
-
 /*
  * This is a similar regex to the one used in the golang prometheus client lib.
  * The Go client doesn't validate against a regex (citing bad performance), and
@@ -37,19 +35,25 @@ function shallowClone(obj) {
 /*
  * To ensure that we don't store duplicate metrics, we must hash all of
  * the metrics before they're stored. This function takes an object of labels.
- * The labels are sorted alphabetically, sent through stringify, and then their
- * md5 hash is calculated. This should be adequately unique for our case.
+ * The labels are sorted alphabetically and returned as a string with the keys
+ * joined together (with no separator), the values joined together (with no
+ * separator) and the resulting two strings (keys and values) joined together
+ * with a '/' separator.
  */
 function hashObj(obj) {
     mod_assert.object(obj, 'obj');
 
-    var hash = mod_crypto.createHash('md5');
-    var newObj = {};
+    var idx;
     var keys = Object.keys(obj).sort();
-    keys.forEach(function (key) {
-        newObj[key] = obj[key];
-    });
-    return (hash.update(JSON.stringify(newObj)).digest('hex'));
+    var keysStr = '';
+    var values = '';
+
+    for (idx = 0; idx < keys.length; idx++) {
+        keysStr += keys[idx];
+        values += obj[keys[idx]];
+    }
+
+    return (keysStr + '/' + values);
 }
 
 /*
diff --git a/package.json b/package.json
index 44047aa..798fe58 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "artedi",
-  "version": "1.4.0",
+  "version": "1.4.1",
   "description": "a metric client library",
   "main": "lib/collector.js",
   "dependencies": {
-- 
2.21.0

