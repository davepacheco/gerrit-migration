From 49bfd4c002cf2c2a9b1eb3e75c6e6e3174bef174 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Mon, 15 Apr 2019 13:52:21 +0100
Subject: [PATCH] Address code review feedback from rm

---
 Makefile              |  6 ++----
 tools/build_jenkins   |  3 +--
 tools/smartos-index   | 11 ++++++++++-
 tools/smartos-release |  9 ++++++++-
 4 files changed, 21 insertions(+), 8 deletions(-)

diff --git a/Makefile b/Makefile
index ccd0ca24..63041ea6 100644
--- a/Makefile
+++ b/Makefile
@@ -451,7 +451,7 @@ PLATFORM_BRANCH ?= $(shell git symbolic-ref HEAD | awk -F/ '{print $$3}')
 # Our shell script uniqifies the branches used, then emits a
 # hyphen-separated string containing them if the configure-branches file
 # contains branches *other* than just $PLATFORM_BRANCH (the branch
-# of smartos-live.git itself)
+# of smartos-live.git itself).
 # While this doesn't perfectly disambiguate builds from different branches,
 # it is good enough for our needs.
 #
@@ -509,8 +509,7 @@ triton-platform-publish: common-platform-publish
 	    -e "s/VERSION_STAMP/$(PLATFORM_STAMP)/" \
 	    -e "s/BUILDSTAMP/$(PLATFORM_STAMP)/" \
 	    -e "s/SIZE/$$(stat --printf="%s" $(PLATFORM_TARBALL))/" \
-	    -e "s#SHA#$$(openssl sha1 $(PLATFORM_TARBALL) \
-	        | cut -d ' ' -f2)#" \
+	    -e "s#SHA#$$(digest -a sha1 $(PLATFORM_TARBALL))#" \
 	    > $(PUB_PLATFORM_MF)
 	cp $(IMAGES_TARBALL) $(PUB_IMAGES_TARBALL)
 	cp $(BOOT_TARBALL) $(PUB_BOOT_TARBALL)
@@ -615,7 +614,6 @@ smartos-publish:
 .PHONY: common-release
 common-release: \
     check \
-    world \
     live \
     pkgsrc
 
diff --git a/tools/build_jenkins b/tools/build_jenkins
index 15e0357e..51f626c2 100755
--- a/tools/build_jenkins
+++ b/tools/build_jenkins
@@ -27,8 +27,7 @@ if [[ -z "${ENGBLD_DEST_OUT_PATH}" ]]; then
     export ENGBLD_DEST_OUT_PATH=/stor/builds
 fi
 
-export TIMESTAMP=$(TZ=UTC date "+%Y%m%dT%H%M%SZ")
-export PATH=/usr/sfw/bin:${PATH}
+export TIMESTAMP=$(TZ=UTC /bin/date "+%Y%m%dT%H%M%SZ")
 export BUILDSTAMP=${TIMESTAMP}
 
 # Used to flag if this is a non-default build. This modifies the description
diff --git a/tools/smartos-index b/tools/smartos-index
index 7605c363..0d24ed1f 100755
--- a/tools/smartos-index
+++ b/tools/smartos-index
@@ -6,7 +6,16 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright 2019, Joyent, Inc.
+#
+
+#
+# This script is intended to be run from the smartos-live ./output/bits/platform
+# directory during build publication. This script creates an index.html fragment
+# which gets redirected to from
+# https://us-east.manta.joyent.com/Joyent_Dev/public/SmartOS/latest.html
+#
+# The latest.html file itself is created by the 'smartos-release' script.
 #
 
 echo "<html>"
diff --git a/tools/smartos-release b/tools/smartos-release
index 6e58a51a..c8d24815 100755
--- a/tools/smartos-release
+++ b/tools/smartos-release
@@ -14,7 +14,6 @@ if [ "$TRACE" != "" ]; then
     export PS4='${BASH_SOURCE}:${LINENO}: '
     set -o xtrace
 fi
-set -o errexit
 
 TOP=$(cd $(dirname $0)/../; pwd)
 PATH=$PATH:${TOP}/node_modules/manta/bin
@@ -62,6 +61,13 @@ BRANCH=$1
 shift
 TIMESTAMP=$1
 
+if [[ -z "$BRANCH" ]] || [[ -z "$TIMESTAMP" ]]; then
+    echo "Error: Missing branch and/or timestamp arguments"
+    print_help
+    exit 2
+fi
+
+set -o errexit
 
 # Note that ${BRANCH} appears only once here as we assume that for release
 # builds, our configure-branches file contains only a single branch name
@@ -88,6 +94,7 @@ mln ${SOURCE}/smartos-${TIMESTAMP}.vmwarevm.tar.gz ${SMARTOS}/smartos-latest.vmw
 echo "Updating ${SMARTOS}/latest object"
 echo ${DESTINATION} | mput -v -H 'content-type: text/plain' ${SMARTOS}/latest
 
+# The index.html file referenced here gets created by 'smartos-index'
 echo "<html><head><meta HTTP-EQUIV=\"REFRESH\" content=\"0; url=${SOURCE}/index.html\"></head></html>" | mput -H 'content-type: text/html' ${SMARTOS}/latest.html
 
 end_time=$(date +%s)
-- 
2.21.0

