{"project":"joyent/node-artedi","branch":"master","id":"I08c12c8021a741d24bc60b0117cb8d31ea19f4a7","number":"3278","subject":"joyent/node-artedi#12 histograms can\u0027t observe values less than one Reviewed by: Dylan Yep \u003cdyep49@gmail.com\u003e Approved by: Dylan Yep \u003cdyep49@gmail.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/3278","commitMessage":"joyent/node-artedi#12 histograms can\u0027t observe values less than one\nReviewed by: Dylan Yep \u003cdyep49@gmail.com\u003e\nApproved by: Dylan Yep \u003cdyep49@gmail.com\u003e\n","createdOn":1517262803,"lastUpdated":1517347232,"open":false,"status":"MERGED","comments":[{"timestamp":1517262803,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1517262842,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517263365,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1517263394,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517263631,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1517277464,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(2 comments)\n\nQuestions/comments are mostly out of curiosity. Nothing is a deal breaker. Looks good to me."},{"timestamp":1517335495,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n(2 comments)\n\nThanks for taking a look!"},{"timestamp":1517340970,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1517340988,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517341092,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1517342527,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1517342546,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517342576,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1517344979,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nThanks so much for taking care of this quickly! This all looks good to me."},{"timestamp":1517347181,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1517347232,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"5","revision":"08c12c8021a741d24bc60b0117cb8d31ea19f4a7","parents":["1acdf3fcbf7f836b993430d32604b9d988f1f035"],"ref":"refs/changes/78/3278/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1517347181,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517342546,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517344979,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517344979,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"SUBM","value":"1","grantedOn":1517347231,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/histogram.js","type":"MODIFIED","insertions":28,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":53,"deletions":-43}],"sizeInsertions":90,"sizeDeletions":-60},"patchSets":[{"number":"1","revision":"7bcc2780aa07a573fce0a0cf8ef77d1e213304e0","parents":["1acdf3fcbf7f836b993430d32604b9d988f1f035"],"ref":"refs/changes/78/3278/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1517262803,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517262842,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/histogram.js","type":"MODIFIED","insertions":26,"deletions":-10},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":31,"deletions":-25}],"sizeInsertions":66,"sizeDeletions":-41},{"number":"2","revision":"74ccc39d07ba0572f602898d25f78a8aca9909a0","parents":["1acdf3fcbf7f836b993430d32604b9d988f1f035"],"ref":"refs/changes/78/3278/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1517263365,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517263394,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517277464,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517277464,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"comments":[{"file":"lib/histogram.js","line":293,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"This looks good and seems to work well in practice. I ran the VMAPI test suite twice to generate some data:\n\nhttps://gist.github.com/dyep49/2fcf58bdcb1319a9080ec036fb6fbc10\n\nIn the eyes of Prometheus, how many buckets is too many? Looking at lines 58-95 in the gist, it seems reasonable to expect 40 buckets for some measurements and 600+ total.\n\nIt might be nice to allow the user a little more control over the creation of buckets as is referenced in the code comments. With that being said, this seems good for now pending the answer to the too many buckets question."},{"file":"lib/histogram.js","line":293,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Good question! And thanks for running this against the VMAPI test suite.\n\nI don\u0027t think that there\u0027s really a straightforward answer to the question of bucket counts. It all depends on how varied the workloads are (lots of latency variance vs very little latency variance). I don\u0027t think that we\u0027ve run into a problem with the number of buckets being created in production. Usually our Muskie instances have the greatest number of time series being tracked. Muskie usually sits around 1300 time series per process, the vast majority of which are for histogram buckets.\n\nThis bucket code ensures there are only a finite number of buckets that can be created, which helps to protect us a little bit from creating too many buckets. On the Prometheus server side the answer is even less defined. We can make Prometheus servers \u0027bigger\u0027 (more memory, faster disk, more CPUs), or deploy more servers to cope with a growing number of time series.\n\nIt would be nice to give control to the user for things like this. I just don\u0027t know that we currently have a problem that would be solved by giving the users greater control over bucketing."},{"file":"test/basic.test.js","line":360,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Maybe we should limit the number of places after the decimal point?"},{"file":"test/basic.test.js","line":360,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"That would probably be nice. I\u0027d imagine not limiting it might make some Prometheus queries a little annoying/ugly. Not urgent though."},{"file":"test/basic.test.js","line":360,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"That\u0027s true. I\u0027ll see what I can do about this."},{"file":"test/basic.test.js","line":360,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Okay, I think this is better. Unfortunately rounding the numbers changed the values of the bigger buckets too. It\u0027s not a breaking change, but that meant I had to go back and change the \u0027expected\u0027 result of all of the histogram output in the tests."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/histogram.js","type":"MODIFIED","insertions":27,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":31,"deletions":-25}],"sizeInsertions":67,"sizeDeletions":-42},{"number":"3","revision":"f1006a937ec7c1ea0c458def7686ac9ac619284e","parents":["1acdf3fcbf7f836b993430d32604b9d988f1f035"],"ref":"refs/changes/78/3278/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1517340970,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517340988,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/histogram.js","type":"MODIFIED","insertions":28,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":48,"deletions":-43}],"sizeInsertions":85,"sizeDeletions":-60},{"number":"4","revision":"a22a7c707765fdc83bfdbe890e01b45b8123ab40","parents":["1acdf3fcbf7f836b993430d32604b9d988f1f035"],"ref":"refs/changes/78/3278/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1517342527,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517342546,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517344979,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517344979,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"comments":[{"file":"test/basic.test.js","line":559,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Added a test for this as well."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/histogram.js","type":"MODIFIED","insertions":28,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":53,"deletions":-43}],"sizeInsertions":90,"sizeDeletions":-60},{"number":"5","revision":"08c12c8021a741d24bc60b0117cb8d31ea19f4a7","parents":["1acdf3fcbf7f836b993430d32604b9d988f1f035"],"ref":"refs/changes/78/3278/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1517347181,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517342546,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1517347231,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517344979,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517344979,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":3,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/histogram.js","type":"MODIFIED","insertions":28,"deletions":-11},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":53,"deletions":-43}],"sizeInsertions":90,"sizeDeletions":-60}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}