{"project":"joyent/illumos-joyent","branch":"master","id":"Ie6c7580c6215121cdb3e00cf18843f8010beda6c","number":"6012","subject":"OS-7676 Add topo method to determine occupant status Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"url":"https://cr.joyent.us/6012","commitMessage":"OS-7676 Add topo method to determine occupant status\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1553553244,"lastUpdated":1553892258,"open":false,"status":"MERGED","comments":[{"timestamp":1553553244,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 1."},{"timestamp":1553627369,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\nThis looks good. Using the presence of children was a rather smart way to approach this. I\u0027m not sure I would have thought of doing it in such a generic way."},{"timestamp":1553790444,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 2."},{"timestamp":1553790487,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 2:\n\ndebug build exposed a minor issue (unused var)"},{"timestamp":1553805564,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1553812367,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 2:\n\n(1 comment)\n\nThe testing LGTM, but I have one question on the review before IA\u0027ing."},{"timestamp":1553822191,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 3."},{"timestamp":1553822333,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1553832406,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1553882247,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1553892074,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1553892184,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1553892258,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Rob Johnston"}],"currentPatchSet":{"number":"5","revision":"e6c7580c6215121cdb3e00cf18843f8010beda6c","parents":["1df0262127ba10f20347daae7ac94c0d44fcd150"],"ref":"refs/changes/12/6012/5","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1553892184,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553832406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553882247,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1553892258,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/libtopo.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/mapfile-vers","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_method.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.c","type":"MODIFIED","insertions":34,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.map","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_node.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/pcibus/pcibus_hba.c","type":"MODIFIED","insertions":18,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/shared/topo_port.c","type":"MODIFIED","insertions":15,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/smbios/smbios_enum.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/x86pi/x86pi_bay.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"9613d69a3bce4294c596ce6e9a4aacd0b174a44f","parents":["52767bdcffaf8c9d0a1cbfac8fa46b8506ee88cd"],"ref":"refs/changes/12/6012/1","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1553553244,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553627369,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/libtopo.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/mapfile-vers","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_method.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.c","type":"MODIFIED","insertions":35,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.map","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_node.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/pcibus/pcibus_hba.c","type":"MODIFIED","insertions":18,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/shared/topo_port.c","type":"MODIFIED","insertions":15,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/smbios/smbios_enum.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/x86pi/x86pi_bay.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-9},{"number":"2","revision":"90d31fc39a1a7cb83312e75844cc3283cd026d9f","parents":["52767bdcffaf8c9d0a1cbfac8fa46b8506ee88cd"],"ref":"refs/changes/12/6012/2","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1553790444,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553805564,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","line":180,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I am wondering if it would make more sense to not print the \"Occupied\" line at all in the case that the node is not a FRU container. Looking at the `fmtopo -S` output in the ticket, most of the FMRIs printed aren\u0027t FRU containers, so the vast majority have \"Occupied: -\". One can probably infer that this means they cannot be occupied, but in some cases, it\u0027s not so obvious to me. For example, this one:\n\nhc://:product-id\u003dJoyent-M12G5:server-id\u003dsky1:chassis-id\u003dS287109X8231992/motherboard\u003d0/hostbridge\u003d5/pciexrc\u003d5/pciexbus\u003d134/pciexdev\u003d0/pciexfn\u003d0/iport\u003d2\n        Present: true\n        Unusable: false\n        Occupied: -\n\nBecause it has \"port\" in the final part of the FMRI string, I might expect it to be able to be occupied. So it\u0027s unclear to me whether there\u0027s an underlying error or it cannot actually \"contain\" anything. I think this is probably true of other types of nodes as well.\n\nI think it might minimize potential user confusion if the \"Occupied\" line is left out in the case it doesn\u0027t make semantic sense to have it. OTOH, I do not know of the history of the stability of the output of this tool, or whether users of it would be surprised if there weren\u0027t an identical number of lines after each FMRI. If that were the case, I would certainly expect that printing the \"Occupied\" line in all cases is the correct thing to do."},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","line":180,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"The output of fmtopo is definitely not stable or committed interface.  That said, I tweaked the change to fmtopo such that if topo_node_occupied() returns an error code indicating that the method isn\u0027t registered on the node, then it doesn\u0027t print the \"Occupied\" line at all.  If it fails for some other reason it will print the Occupied line with a value of \"-\".\n\nI also updated the fmtopo output in the ticket."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","type":"MODIFIED","insertions":8,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/libtopo.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/mapfile-vers","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_method.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.c","type":"MODIFIED","insertions":34,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.map","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_node.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/pcibus/pcibus_hba.c","type":"MODIFIED","insertions":18,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/shared/topo_port.c","type":"MODIFIED","insertions":15,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/smbios/smbios_enum.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/x86pi/x86pi_bay.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":177,"sizeDeletions":-9},{"number":"3","revision":"f97391f348834ac3a4c97d3b5dd8860d633eebba","parents":["52767bdcffaf8c9d0a1cbfac8fa46b8506ee88cd"],"ref":"refs/changes/12/6012/3","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1553822191,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553832406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553882247,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/libtopo.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/mapfile-vers","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_method.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.c","type":"MODIFIED","insertions":34,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.map","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_node.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/pcibus/pcibus_hba.c","type":"MODIFIED","insertions":18,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/shared/topo_port.c","type":"MODIFIED","insertions":15,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/smbios/smbios_enum.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/x86pi/x86pi_bay.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-9},{"number":"4","revision":"8541f6bed8c8a95ad106079de658637869fd47aa","parents":["52767bdcffaf8c9d0a1cbfac8fa46b8506ee88cd"],"ref":"refs/changes/12/6012/4","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1553892074,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553832406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553882247,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/libtopo.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/mapfile-vers","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_method.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.c","type":"MODIFIED","insertions":34,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.map","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_node.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/pcibus/pcibus_hba.c","type":"MODIFIED","insertions":18,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/shared/topo_port.c","type":"MODIFIED","insertions":15,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/smbios/smbios_enum.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/x86pi/x86pi_bay.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-9},{"number":"5","revision":"e6c7580c6215121cdb3e00cf18843f8010beda6c","parents":["1df0262127ba10f20347daae7ac94c0d44fcd150"],"ref":"refs/changes/12/6012/5","uploader":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"createdOn":1553892184,"author":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553832406,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553882247,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1553892258,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/fm/fmtopo/common/fmtopo.c","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/hc.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/libtopo.h","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/mapfile-vers","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_method.h","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.c","type":"MODIFIED","insertions":34,"deletions":0},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.h","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_mod.map","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/lib/fm/topo/libtopo/common/topo_node.c","type":"MODIFIED","insertions":17,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/pcibus/pcibus_hba.c","type":"MODIFIED","insertions":18,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/ses/ses.c","type":"MODIFIED","insertions":19,"deletions":0},{"file":"usr/src/lib/fm/topo/modules/common/shared/topo_port.c","type":"MODIFIED","insertions":15,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/common/smbios/smbios_enum.c","type":"MODIFIED","insertions":17,"deletions":-1},{"file":"usr/src/lib/fm/topo/modules/i86pc/x86pi/x86pi_bay.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":178,"sizeDeletions":-9}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}]}