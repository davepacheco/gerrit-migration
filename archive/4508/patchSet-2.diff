commit 6ef3f59d2094447bd95bcfaabf7b69ced1ad1888 (refs/changes/08/4508/2)
Author: Rui Loura <rui@joyent.com>
Date:   2018-07-12T19:25:58+00:00 (1 year, 3 months ago)
    
    OS-7075 platform needs to be rackaware

diff --git a/overlay/generic/lib/svc/method/net-physical b/overlay/generic/lib/svc/method/net-physical
index d2010681..86af5b33 100644
--- a/overlay/generic/lib/svc/method/net-physical
+++ b/overlay/generic/lib/svc/method/net-physical
@@ -64,6 +64,7 @@ function log_if_state
 {
     set -o xtrace
     echo "== debug start: $1 =="
+    nictagadm list
     if ! /usr/sbin/dladm show-phys; then
         echo "WARNING: 'dladm show-phys' failed"
     fi
@@ -422,19 +423,19 @@ function setup_mtu
             exit $SMF_EXIT_ERR_FATAL
         fi
 
-	#
-	# Check the current MTU of the device. To help out devices which
-	# don't support the setting of the MTU (here's looking at you
-	# bnx), if the MTU is identical to its default, don't do
-	# anything and save the poor folks stuck with bnx some grief.
-	#
-	curmtu=$(/usr/sbin/dladm show-linkprop -c -o value -p mtu ${link})
-	[[ $? -eq 0 ]] && [[ "$curmtu" -eq "${mtus[$mac]}" ]] && continue
-
-        if ! /usr/sbin/dladm set-linkprop -p mtu=${mtus[$mac]} ${link}; then
-            echo "Failed to set mtu to ${mtus[$mac]} for link ${link}"
-            exit $SMF_EXIT_ERR_FATAL
-        fi
+        #
+        # Check the current MTU of the device. To help out devices which
+        # don't support the setting of the MTU (here's looking at you
+        # bnx), if the MTU is identical to its default, don't do
+        # anything and save the poor folks stuck with bnx some grief.
+        #
+        curmtu=$(/usr/sbin/dladm show-linkprop -c -o value -p mtu ${link})
+        [[ $? -eq 0 ]] && [[ "$curmtu" -eq "${mtus[$mac]}" ]] && continue
+
+            if ! /usr/sbin/dladm set-linkprop -p mtu=${mtus[$mac]} ${link}; then
+                echo "Failed to set mtu to ${mtus[$mac]} for link ${link}"
+                exit $SMF_EXIT_ERR_FATAL
+            fi
     done
 }
 
@@ -498,6 +499,7 @@ if smf_is_globalzone; then
     setup_mtu
 
     # Setup admin NIC
+    ADMIN_NIC_TAG=${CONFIG_admin_tag:-"admin"}
 
     # If there is no NIC with the admin tag, and the config has
     # admin_nic_autoselect=true, designate the first NIC reported
@@ -505,14 +507,14 @@ if smf_is_globalzone; then
     # the NICs are known to change beneath us.
     if [[ "${BOOT_smartos}" == "true" ]] && \
         [[ "${CONFIG_admin_nic_autoselect}" == "true" ]] && \
-        ! nictagadm exists admin ; then
+        ! nictagadm exists $ADMIN_NIC_TAG ; then
         autoselected_admin_nic=$(dladm show-phys -m -p -o address | head -n1)
         if [[ -z ${autoselected_admin_nic} ]] ; then
             echo "ERROR: no NICs found, unable to autoselect admin NIC."
             exit ${SMF_EXIT_ERR_CONFIG}
         fi
 
-        nictagadm add admin "${autoselected_admin_nic}"
+        nictagadm add $ADMIN_NIC_TAG "${autoselected_admin_nic}"
         if [[ $? -ne 0 ]] ; then
             echo "ERROR: unable to add admin tag to NIC ${autoselected_admin_nic}"
             exit ${SMF_EXIT_ERR_FATAL}
@@ -524,6 +526,19 @@ if smf_is_globalzone; then
         fi
 
         nictagadm list
+    elif [[ -v CONFIG_admin_tag ]]; then
+        #
+        # This handles the case when the 'admin_tag' property is set to
+        # override the default admin nic tag.
+        #
+        eval SYSINFO_NIC_admin='$'SYSINFO_NIC_${CONFIG_admin_tag}
+
+        eval CONFIG_admin_ip='$'CONFIG_${CONFIG_admin_tag}_ip
+        eval CONFIG_admin_ip6='$'CONFIG_${CONFIG_admin_tag}_ip6
+        eval CONFIG_admin_netmask='$'CONFIG_${CONFIG_admin_tag}_netmask
+        eval CONFIG_admin_mtu='$'CONFIG_${CONFIG_admin_tag}_mtu
+        eval CONFIG_admin_gateway='$'CONFIG_${CONFIG_admin_tag}_gateway
+        eval CONFIG_admin_gateway6='$'CONFIG_${CONFIG_admin_tag}_gateway6
     fi
 
     if [[ -z "${SYSINFO_NIC_admin}" ]]; then
diff --git a/src/node_modules/net-boot-config.js b/src/node_modules/net-boot-config.js
index b252a1bb..9c07bdc8 100644
--- a/src/node_modules/net-boot-config.js
+++ b/src/node_modules/net-boot-config.js
@@ -127,6 +127,7 @@ function configValues(callback) {
         var ipKeys = [];
         var tagNums = {};
         var vals = {};
+        var admin_tag = 'admin';
 
         if (err) {
             return callback(err);
@@ -144,11 +145,21 @@ function configValues(callback) {
             vals.hostname = conf.hostname;
         }
 
+        if (conf.admin_tag) {
+            admin_tag = conf.admin_tag;
+        }
+        vals.admin_tag = admin_tag;
+
         conf.nictags.forEach(function (tag) {
             if (!tag.hasOwnProperty('name')) {
                 return;
             }
 
+            /* if admin_tag is not 'admin', skip the admin nictag. */
+            if (tag.name === 'admin' && admin_tag !== tag.name) {
+                return;
+            }
+
             if (tag.mac) {
                 vals[tag.name + '_nic'] = tag.mac;
             }
@@ -166,7 +177,13 @@ function configValues(callback) {
             var iface;
             var tag = nic.nic_tag;
 
-            if (!tag) {
+            /*
+             * If this is a nic tagged 'admin' and the admin_tag is not 'admin,
+             * skip this.  When admin_tag is set to something other than
+             * 'admin' we want to completely override the admin_nic and not
+             * display it at all.
+             */
+            if (!tag || (tag === 'admin' && admin_tag !== tag)) {
                 return;
             }
 
@@ -183,7 +200,12 @@ function configValues(callback) {
                 tagNums[tag] = 0;
             }
 
-            if ((tag != 'admin' && tag != 'external') || tagNums[tag] !== 0) {
+            /*
+             * If this is not the admin nic, the external nic, or the nic
+             * tagged with the admin_tag, add the instance number.
+             */
+            if ((tag !== 'admin' && tag !== admin_tag && tag !== 'external')
+                || tagNums[tag] !== 0) {
                 iface = fmt('%s%d', tag, tagNums[tag]);
             }
 
@@ -248,8 +270,6 @@ function configValues(callback) {
     });
 }
 
-
-
 module.exports = {
     values: configValues,
     enabled: isEnabled,
diff --git a/src/sysinfo b/src/sysinfo
index 2a889c77..106da2ba 100644
--- a/src/sysinfo
+++ b/src/sysinfo
@@ -537,6 +537,14 @@ function get_overlay_nic_tags()
     fi
 }
 
+function get_admin_nic_tag()
+{
+    prop=$(net_conf_grep "^admin_tag=")
+    fields=(${prop//=/ })
+    eval "Admin_NIC_Tag=${fields[1]}"
+}
+
+
 function get_nic_tags()
 {
     NicTagCount=0
@@ -684,6 +692,7 @@ CPU_Physical_Cores=${CPU_Count}
 Bhyve_Capable='${Bhyve_Capable}'
 Bhyve_Max_Vcpus=${Bhyve_Max_Vcpus}
 Nic_Tags=${NicTagList}
+Admin_NIC_Tag=${Admin_NIC_Tag}
 Setup='${Setup_complete}'
 END
     else
@@ -820,6 +829,7 @@ END
   "CPU Type": "${CPU_Version}",
   "CPU Virtualization": "${CPU_Virtualization}",
   "CPU Physical Cores": ${CPU_Count},
+  "Admin NIC Tag": "${Admin_NIC_Tag}",
 END
     else
         echo "  \"ZFS Quota\": \"${QUOTA}\","
@@ -1011,6 +1021,7 @@ get_system_type
 get_hostname
 get_aggregation_mappings
 get_overlay_nic_tags
+get_admin_nic_tag
 get_nic_tags
 get_smartos_network_interfaces
 get_smartos_vnics
