{"project":"joyent/moray","branch":"master","id":"Ibabdba064ca568b3a9668e84bf9e2bd0cf30c121","number":"3015","subject":"MANTA-3503 moray pgclient query function creates its own request id Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Reviewed by: Tim Kordas \u003ctim.kordas@joyent.com\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/3015","commitMessage":"MANTA-3503 moray pgclient query function creates its own request id\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nReviewed by: Tim Kordas \u003ctim.kordas@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1512009458,"lastUpdated":1512427730,"open":false,"status":"MERGED","comments":[{"timestamp":1512009458,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1512009484,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512065290,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1512079017,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1512079043,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512079649,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1512080243,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1512080333,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1512081723,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1512082962,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1512082988,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512086492,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1512151863,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1512151889,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512156454,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1512156484,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512157854,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1512178217,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1512178251,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512414191,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1512425363,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1512425583,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1512427721,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1512427730,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jan Wyszynski"}],"currentPatchSet":{"number":"7","revision":"f761c3764f3c9079bc4259a7ec4e904ca94adc75","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512427721,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512178251,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512414191,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512425363,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512425583,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1512427730,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":21,"deletions":-4},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/manatee.js","type":"MODIFIED","insertions":0,"deletions":-27},{"file":"lib/pg.js","type":"MODIFIED","insertions":30,"deletions":-2},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/standalone.js","type":"MODIFIED","insertions":0,"deletions":-25}],"sizeInsertions":54,"sizeDeletions":-61},"patchSets":[{"number":"1","revision":"ebda519c1a280795fb24bb158ab7f899e60c1ff8","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512009458,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512009484,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pg.js","line":80,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can you initialize this.reqid to null here?"},{"file":"lib/pg.js","line":162,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can you make this:\n\n    var reqid \u003d this.reqid \u003d\u003d\u003d null ? libuuid.create() : this.reqid;\n\nThe client gets checked out by the pool occasionally to check that it\u0027s still functional (see pgCheck()), and the request id won\u0027t be set then."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/pg.js","type":"MODIFIED","insertions":24,"deletions":-1},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":26,"sizeDeletions":-3},{"number":"2","revision":"091333278df5ed98cd5971cc3736eeb2ac49911e","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512079017,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512079043,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512080333,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"comments":[{"file":"lib/control.js","line":151,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This will need to go at the end of the array, so that we don\u0027t break the current ordering. (This is also where handler-start places the request id currently.)"},{"file":"lib/pg.js","line":166,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"as written there isn\u0027t a good way to see that these reqids are related to the healthcheck: I can easily imagine chasing down references for them and not realizing that in this instance they originate with Moray, here. Is there a good way we can clarify ?"},{"file":"lib/pg.js","line":166,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"All of the healthchecks will have the same SQL string passed to the probe (\u0027SELECT NOW() AS when\u0027). Do you think that\u0027s enough to help identify it as being part of the healthcheck?"},{"file":"lib/pg.js","line":166,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"probably so! good point!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/pg.js","type":"MODIFIED","insertions":29,"deletions":-1},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":34,"sizeDeletions":-6},{"number":"3","revision":"79a7a0ac6925189b1f94f2bf16c9e1362fd54d49","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512082962,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512086492,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512082988,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/pg.js","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":35,"sizeDeletions":-6},{"number":"4","revision":"56338f1b87d17ba2e44b72e559b1473389af09f4","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512151863,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512151889,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/pg.js","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":35,"sizeDeletions":-6},{"number":"5","revision":"cfb140a1ab0a9d6ca252e54de0e59d93696e74cf","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512156454,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512156484,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/control.js","line":83,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think you could structure this so that you still keep the client.setRequestId bits in _getPGHandleAfter. For example:\n\n    req.manatee.pg(_getPGHandleAfter(req, function (err) {\n        if (err) {\n            cb(err);\n            return;\n        }\n\n        req.pg.begin(cb);\n    });"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":35,"deletions":-5},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/manatee.js","type":"MODIFIED","insertions":0,"deletions":-27},{"file":"lib/pg.js","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/standalone.js","type":"MODIFIED","insertions":0,"deletions":-25}],"sizeInsertions":68,"sizeDeletions":-61},{"number":"6","revision":"babdba064ca568b3a9668e84bf9e2bd0cf30c121","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512178217,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512414191,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512425583,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512178251,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512425363,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":21,"deletions":-4},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/manatee.js","type":"MODIFIED","insertions":0,"deletions":-27},{"file":"lib/pg.js","type":"MODIFIED","insertions":30,"deletions":-2},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/standalone.js","type":"MODIFIED","insertions":0,"deletions":-25}],"sizeInsertions":54,"sizeDeletions":-61},{"number":"7","revision":"f761c3764f3c9079bc4259a7ec4e904ca94adc75","parents":["44a6fd4273e890b82fe5ca333a5362add7a0acfc"],"ref":"refs/changes/15/3015/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512427721,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512414191,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1512425583,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512178251,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512425363,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"SUBM","value":"1","grantedOn":1512427730,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/control.js","type":"MODIFIED","insertions":21,"deletions":-4},{"file":"lib/dtrace.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/manatee.js","type":"MODIFIED","insertions":0,"deletions":-27},{"file":"lib/pg.js","type":"MODIFIED","insertions":30,"deletions":-2},{"file":"lib/ping.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/standalone.js","type":"MODIFIED","insertions":0,"deletions":-25}],"sizeInsertions":54,"sizeDeletions":-61}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}