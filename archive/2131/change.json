{"project":"joyent/manta-mako","branch":"master","id":"I13a92bfbd534d9f237f38b048be2740c26f6749e","number":"2131","subject":"MANTA-3317 upload-mako-ls uses all memory, then uploads incomplete dump Reviewed by: Brian Bennett \u003cbrian.bennett@joyent.com\u003e Reviewed by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e Approved by: Brian Bennett \u003cbrian.bennett@joyent.com\u003e Approved by: Kody A Kant","owner":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"url":"https://cr.joyent.us/2131","commitMessage":"MANTA-3317 upload-mako-ls uses all memory, then uploads incomplete dump\nReviewed by: Brian Bennett \u003cbrian.bennett@joyent.com\u003e\nReviewed by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e\nApproved by: Brian Bennett \u003cbrian.bennett@joyent.com\u003e\nApproved by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e\n","createdOn":1498001391,"lastUpdated":1498241945,"open":false,"status":"MERGED","comments":[{"timestamp":1498001391,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 1."},{"timestamp":1498001417,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1498010017,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 1: Code-Review-1 Integration-Approval-1"},{"timestamp":1498010080,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1\n\nSorry, wrong radio button. I approve."},{"timestamp":1498084491,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\nAre we worried about the performance impact of moving this off of tmpfs? I\u0027m just a little worried that it might mess up our nightly cron stuff if we have an operation that runs longer than it used to."},{"timestamp":1498091531,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\nIn many contexts, we\u0027ve mounted ZFS at /tmp anyway.  It\u0027s not necessarily any slower except for synchronous operations.  This is one big find(1), so it shouldn\u0027t matter too much.  It\u0027s also an asynchronous process with respect to everything else -- as long as it finishes within 16 hours, things are fine.  (That can be a problem.  If it is, we\u0027ll need to re-evaluate, but I\u0027m not sure it\u0027ll really be tenable to require this to live in memory.)"},{"timestamp":1498187212,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1: Code-Review+1\n\nThis sounds good to me. The only other thing I\u0027m worried about is extra disk usage. I can\u0027t imagine these are currently large enough to make a drastic difference in our disk usage, but I am curious how large these will get in a (much) larger datacenter."},{"timestamp":1498240900,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n\u003e This sounds good to me. The only other thing I\u0027m worried about is\n \u003e extra disk usage. I can\u0027t imagine these are currently large enough\n \u003e to make a drastic difference in our disk usage, but I am curious\n \u003e how large these will get in a (much) larger datacenter.\n\nThat\u0027s a good question.  Looking at the dumps in /poseidon/stor/mako, the size of this file is about 100 bytes per object file.  I think that\u0027s a reasonably small \"tax\" to pay per object.  (And it\u0027s either on disk or DRAM, and DRAM is more valuable here.)"},{"timestamp":1498241008,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1: Integration-Approval+1\n\nThanks for looking into that! Looks good."},{"timestamp":1498241932,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1498241945,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by David Pacheco"}],"currentPatchSet":{"number":"2","revision":"13a92bfbd534d9f237f38b048be2740c26f6749e","parents":["58535bbe0dacd766e5156207377a898bad75b760"],"ref":"refs/changes/31/2131/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1498241932,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1498001417,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498010080,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498010080,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498187212,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498241008,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1498241945,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"bin/upload_mako_ls.sh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":1,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"21420f93e78409d3ef5a4e65239f4c52b252c2af","parents":["58535bbe0dacd766e5156207377a898bad75b760"],"ref":"refs/changes/31/2131/1","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1498001391,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1498001417,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498010080,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498010080,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498187212,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498241008,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/upload_mako_ls.sh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":1,"sizeDeletions":-1},{"number":"2","revision":"13a92bfbd534d9f237f38b048be2740c26f6749e","parents":["58535bbe0dacd766e5156207377a898bad75b760"],"ref":"refs/changes/31/2131/2","uploader":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"createdOn":1498241932,"author":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1498241945,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1498001417,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498010080,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498010080,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1498187212,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1498241008,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"bin/upload_mako_ls.sh","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":1,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}