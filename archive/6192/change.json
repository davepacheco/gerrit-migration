{"project":"joyent/boray","branch":"master","id":"I48fccae67a84fe9d8f87190272f854f982643bed","number":"6192","subject":"MANTA-4246 Make boray use rust-cueball Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/6192","commitMessage":"MANTA-4246 Make boray use rust-cueball\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\n","createdOn":1556894228,"lastUpdated":1557338406,"open":false,"status":"MERGED","comments":[{"timestamp":1556894228,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1556894230,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 48b8232b0552b8040cd2d491a147d906c5de7488\n    \n    MANTA-4246 Make boray use rust-cueball\n    Use cueball for postgres connection pooling."},{"timestamp":1556894232,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/boray.xml\n warning: failed to load external entity \"tools/service_bundle.dtd.1\"\n Could not parse DTD tools/service_bundle.dtd.1\n deps/eng/tools/mk/Makefile.smf.targ:34: recipe for target \u0027smf/manifests/boray.xml.smfchk\u0027 failed\n gmake: *** [smf/manifests/boray.xml.smfchk] Error 2"},{"timestamp":1556894410,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1556894412,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 4ab03b38f01be8249f9f5d61b4f5c4013c78f972\n    \n    MANTA-4246 Make boray use rust-cueball\n    Use cueball for postgres connection pooling."},{"timestamp":1556894414,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/boray.xml\n warning: failed to load external entity \"tools/service_bundle.dtd.1\"\n Could not parse DTD tools/service_bundle.dtd.1\n deps/eng/tools/mk/Makefile.smf.targ:34: recipe for target \u0027smf/manifests/boray.xml.smfchk\u0027 failed\n gmake: *** [smf/manifests/boray.xml.smfchk] Error 2"},{"timestamp":1557302180,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)\n\nThis looks good!\n\nI\u0027m not a huge fan of the \"create-ephemeral-db.sh\" and \"schema.sql\" files living where they are.  I also might change the \"schema.sql\" file to \"ephemeral-db-schema.sql\" or something to clarify it\u0027s part of this tool (which is my understanding). They would probably be better suited to a \"tools\" directory instead, but that\u0027s not a huge concern to me.\n\nWhat do we usually do in terms of testing for IA at this point in development? Happy to hit the IA+1 button too but don\u0027t want to jump the gun."},{"timestamp":1557321866,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(2 comments)\n\n\u003e (2 comments)\n \u003e \n \u003e This looks good!\n \u003e \n \u003e I\u0027m not a huge fan of the \"create-ephemeral-db.sh\" and \"schema.sql\"\n \u003e files living where they are.  I also might change the \"schema.sql\"\n \u003e file to \"ephemeral-db-schema.sql\" or something to clarify it\u0027s part\n \u003e of this tool (which is my understanding). They would probably be\n \u003e better suited to a \"tools\" directory instead, but that\u0027s not a huge\n \u003e concern to me.\n \u003e \n \u003e What do we usually do in terms of testing for IA at this point in\n \u003e development? Happy to hit the IA+1 button too but don\u0027t want to\n \u003e jump the gun.\n\nI can move those files to a `tools` directory instead. Do you think keeping the nested `postgres` directory is the way to go and just rename `etc` to `tools`?\n\nFor IA the process has been we\u0027d have to build and deploy a new image and incorporate it into one of our hacked-up buckets setups. That was my motivation for the new tests with this change. I wanted to speed up that process and give us the basically the same validation about the postgres interaction while we\u0027re still getting all the details for a proper deployment of the components ironed out."},{"timestamp":1557330180,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1557330182,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 5119e0a55bce39b3d5c32ef6b7363bdaa395e531\n    \n    Move pg_tmp files to tools subdirectory and make sharks column a text array."},{"timestamp":1557330184,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/boray.xml\n warning: failed to load external entity \"tools/service_bundle.dtd.1\"\n Could not parse DTD tools/service_bundle.dtd.1\n deps/eng/tools/mk/Makefile.smf.targ:34: recipe for target \u0027smf/manifests/boray.xml.smfchk\u0027 failed\n gmake: *** [smf/manifests/boray.xml.smfchk] Error 2"},{"timestamp":1557330314,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nPS3 renames the `etc` directory to `tools` and it also changes the type of `sharks` to a vector of strings in correspondence to the most recent update to RFD 149 to make `sharks` a text array column in postgres (due to possible data loss using `hstore` since `hstore` does not allow for duplicate key values)."},{"timestamp":1557330950,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\nThanks for the changes and for answering my questions!\n\nThis looks fine to me. I\u0027ve hit IA+1 for this too (assuming the test suite that was added passes). What do we do about the -1 from CI?"},{"timestamp":1557331583,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\n\u003e Thanks for the changes and for answering my questions!\n \u003e \n \u003e This looks fine to me. I\u0027ve hit IA+1 for this too (assuming the\n \u003e test suite that was added passes). What do we do about the -1 from\n \u003e CI?\n\nI just ran that error by Tim and it looks like a known bug reported as TOOLS-2178. Tim said it\u0027s on his list to fix, but for this project `make check` probably won\u0027t really do much anyways so I think we can press on."},{"timestamp":1557338406,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"3","revision":"48fccae67a84fe9d8f87190272f854f982643bed","parents":["961a391a9a570d322e405e82be66a8e6be5ce6e5"],"ref":"refs/changes/92/6192/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1557330180,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1557330184,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557330950,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557330950,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1557338406,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Cargo.lock","type":"MODIFIED","insertions":446,"deletions":-155},{"file":"Cargo.toml","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"src/bucket.rs","type":"MODIFIED","insertions":133,"deletions":-92},{"file":"src/lib.rs","type":"ADDED","insertions":59,"deletions":0},{"file":"src/main.rs","type":"MODIFIED","insertions":45,"deletions":-52},{"file":"src/object.rs","type":"MODIFIED","insertions":145,"deletions":-124},{"file":"src/opts.rs","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"tests/rpc_handlers.rs","type":"ADDED","insertions":416,"deletions":0},{"file":"tools/postgres/create-ephemeral-db.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"tools/postgres/ephemeral-db-schema.sql","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":1410,"sizeDeletions":-432},"patchSets":[{"number":"1","revision":"27e05da61b951191f14c37031a0825d11dfe8a5b","parents":["961a391a9a570d322e405e82be66a8e6be5ce6e5"],"ref":"refs/changes/92/6192/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1556894228,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1556894232,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Cargo.lock","type":"MODIFIED","insertions":446,"deletions":-155},{"file":"Cargo.toml","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"deps/eng","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"deps/manta-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"etc/postgres/create-ephemeral-db.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"etc/postgres/schema.sql","type":"ADDED","insertions":119,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":133,"deletions":-92},{"file":"src/lib.rs","type":"ADDED","insertions":59,"deletions":0},{"file":"src/main.rs","type":"MODIFIED","insertions":45,"deletions":-52},{"file":"src/object.rs","type":"MODIFIED","insertions":143,"deletions":-124},{"file":"src/opts.rs","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"tests/rpc_handlers.rs","type":"ADDED","insertions":416,"deletions":0}],"sizeInsertions":1410,"sizeDeletions":-434},{"number":"2","revision":"5838d435e6f84a03d457e2809991212c4a0132c8","parents":["961a391a9a570d322e405e82be66a8e6be5ce6e5"],"ref":"refs/changes/92/6192/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1556894410,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1556894414,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557302180,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"comments":[{"file":"src/bucket.rs","line":25,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Why does the visibility have to change here?"},{"file":"src/bucket.rs","line":25,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"In rust if you want to directly access any struct members they have to be marked as public. So for the new tests to be able to create the structs to feed into each rpc handler function I had to make these all public."},{"file":"src/bucket.rs","line":333,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Why does this no longer need to be a reference?"},{"file":"src/bucket.rs","line":333,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Great question. The rust lint tool, clippy, pointed this out for me. It recommends to pass smallish parameters by value rather than reference. [Here](https://github.com/rust-lang/rust-clippy/issues/1680) is the discussion of it with the reasoning behind it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Cargo.lock","type":"MODIFIED","insertions":446,"deletions":-155},{"file":"Cargo.toml","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"etc/postgres/create-ephemeral-db.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"etc/postgres/schema.sql","type":"ADDED","insertions":119,"deletions":0},{"file":"src/bucket.rs","type":"MODIFIED","insertions":133,"deletions":-92},{"file":"src/lib.rs","type":"ADDED","insertions":59,"deletions":0},{"file":"src/main.rs","type":"MODIFIED","insertions":45,"deletions":-52},{"file":"src/object.rs","type":"MODIFIED","insertions":143,"deletions":-124},{"file":"src/opts.rs","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"tests/rpc_handlers.rs","type":"ADDED","insertions":416,"deletions":0}],"sizeInsertions":1408,"sizeDeletions":-432},{"number":"3","revision":"48fccae67a84fe9d8f87190272f854f982643bed","parents":["961a391a9a570d322e405e82be66a8e6be5ce6e5"],"ref":"refs/changes/92/6192/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1557330180,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1557330184,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557330950,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557330950,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1557338406,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Cargo.lock","type":"MODIFIED","insertions":446,"deletions":-155},{"file":"Cargo.toml","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"src/bucket.rs","type":"MODIFIED","insertions":133,"deletions":-92},{"file":"src/lib.rs","type":"ADDED","insertions":59,"deletions":0},{"file":"src/main.rs","type":"MODIFIED","insertions":45,"deletions":-52},{"file":"src/object.rs","type":"MODIFIED","insertions":145,"deletions":-124},{"file":"src/opts.rs","type":"MODIFIED","insertions":14,"deletions":-5},{"file":"tests/rpc_handlers.rs","type":"ADDED","insertions":416,"deletions":0},{"file":"tools/postgres/create-ephemeral-db.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"tools/postgres/ephemeral-db-schema.sql","type":"ADDED","insertions":119,"deletions":0}],"sizeInsertions":1410,"sizeDeletions":-432}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}