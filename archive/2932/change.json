{"project":"joyent/electric-moray","branch":"master","topic":"3232","id":"I9055ad267adc238991637837ec6bd08585c59773","number":"2932","subject":"MANTA-3232 Undeploy without disruption - electric-moray","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2932","commitMessage":"MANTA-3232 Undeploy without disruption - electric-moray\n","createdOn":1510276476,"lastUpdated":1542751640,"open":true,"status":"NEW","comments":[{"timestamp":1510276476,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1510276501,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510276538,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Topic set to 3232"},{"timestamp":1510277236,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1510277261,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510278456,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1510278480,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510278621,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1510278646,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510279074,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1510279099,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512528864,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1512528889,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512575697,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 5:\n\n(3 comments)\n\nLooks good! I\u0027m happy to see that the dependency graph is respected on zone shutdown!"},{"timestamp":1512582757,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1513099648,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1513104415,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 7."},{"timestamp":1513104441,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516401614,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1516401642,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516667165,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1542751605,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 9: Patch Set 8 was rebased"},{"timestamp":1542751640,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"9","revision":"c24cc19a17ecdec8b02214da4c41da852c93ac0b","parents":["380d68bb2eeafd4b7b562a6645f9a29a8da1c719"],"ref":"refs/changes/32/2932/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542751605,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516401642,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":77,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":80,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"105c2cbc848c26ae25158ce3fbcf7b2f3dca0ab8","parents":["c8998df5ee19446b0bf808941b3901d2c8c9a670"],"ref":"refs/changes/32/2932/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510276476,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510276501,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/quiesce.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":51,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":76,"sizeDeletions":-1},{"number":"2","revision":"c59e9e1b695d026d6917a553367d9576e8ee1e0c","parents":["c8998df5ee19446b0bf808941b3901d2c8c9a670"],"ref":"refs/changes/32/2932/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510277236,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510277261,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/quiesce.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":66,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":91,"sizeDeletions":-1},{"number":"3","revision":"8159c6500c53c14901b275f7d4870f0dd936cc97","parents":["c8998df5ee19446b0bf808941b3901d2c8c9a670"],"ref":"refs/changes/32/2932/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510278456,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510278480,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/quiesce.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":81,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":106,"sizeDeletions":-1},{"number":"4","revision":"a8a323186cb8885d5b19cd7076c17550b04b80e0","parents":["c8998df5ee19446b0bf808941b3901d2c8c9a670"],"ref":"refs/changes/32/2932/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510278621,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510278646,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/quiesce.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":79,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":104,"sizeDeletions":-1},{"number":"5","revision":"841c7486f7358971bbefc0b7874c3aed2aecc22a","parents":["c8998df5ee19446b0bf808941b3901d2c8c9a670"],"ref":"refs/changes/32/2932/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1510279074,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510279099,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/quiesce.sh","type":"ADDED","insertions":24,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":79,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":104,"sizeDeletions":-1},{"number":"6","revision":"d2e72662af8f099c86e2a4ec9ce585d7cac2a06c","parents":["c5128f07e3697a5845fb4a8b48c9bfd935848581"],"ref":"refs/changes/32/2932/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1512528864,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512528889,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":301,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should we refer to electric-moray as \u0027moray-\u003cport\u003e\u0027 or \u0027electric-moray-\u003cport\u003e\u0027 in the log statements? I\u0027m not sure what is common elsewhere in this code. I see on line 237 we are using \u0027moray,\u0027 so maybe this is fine."},{"file":"lib/server.js","line":301,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I\u0027m not really sure, I\u0027ve seen both. I know that muskie reports a new connection to electric-moray with \"moray: connected.\" I actually have not seen \"electric-moray\" in our log messages yet."},{"file":"lib/server.js","line":302,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"as Cody pointed out on a copy of this, maybe we want to shutdown the monitorServer last."},{"file":"lib/server.js","line":307,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Can we safely refer to private fields for the FastServer and FastRpcConnection objects (fs_conns, fs_server, fc_pending)?\n\nI see that fastv2 has some support for clean shutdown. It looks like when we call FastServer.close() it will wait for requests to finish, but then throw away the result. Would it make sense to modify node-fast to provide a clean(er) shutdown mechanism when we call FastServer.close()? That might allow us to simply call server.close() instead of polling the number of active connections. I haven\u0027t looked at the node-fast code in depth, so maybe this is a bad suggestion :)"},{"file":"lib/server.js","line":307,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"No I think it\u0027s a good suggestion and it was something I was going to take a look at today. The way this is written now is really a proof of concept, I will take a look at node-fast to see if there is a cleaner shutdown mechanism and if not - will add one."},{"file":"smf/manifests/electric-moray.xml.in","line":64,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I guess I don\u0027t understand why we aren\u0027t setting a timeout now. I think it would be good to have a cap on the time we wait for electric-moray to shut down cleanly."},{"file":"smf/manifests/electric-moray.xml.in","line":64,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"The reason is that theoretically I think there is no safe bound on the amount of time that it take electric-moray to drain the request queue. If SMF finds that the process hasn\u0027t died within timeout_seconds, it will kill it more forcefully (I\u0027m not actually sure how, but I would guess something like SIGKILL). I guess we could make this a multiple of the DNS ttl since for the case of a zone shutdown the SIGTERMs will be sent to registrar and electric-moray at roughly the same time.\n\nI also think it\u0027s a not a good idea to get rid of this timeout. I\u0027ll see if I can determine what a safe bound might be."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":78,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":80,"sizeDeletions":-2},{"number":"7","revision":"a6b041828d49e0426a3350b0e6218d163d341e45","parents":["c5128f07e3697a5845fb4a8b48c9bfd935848581"],"ref":"refs/changes/32/2932/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1513104415,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513104441,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":83,"deletions":0},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":85,"sizeDeletions":-2},{"number":"8","revision":"9055ad267adc238991637837ec6bd08585c59773","parents":["27c91ecbf129a0845e3b62b73d5b10329e4b57c9"],"ref":"refs/changes/32/2932/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1516401614,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516401642,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"package.json","line":19,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"do we want this ? or something more like \"^2.4.0\" ? (or even \"2.4.0\")"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":77,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":80,"sizeDeletions":-3},{"number":"9","revision":"c24cc19a17ecdec8b02214da4c41da852c93ac0b","parents":["380d68bb2eeafd4b7b562a6645f9a29a8da1c719"],"ref":"refs/changes/32/2932/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542751605,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516401642,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":77,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":80,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}