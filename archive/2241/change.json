{"project":"joyent/manta-muskie","branch":"master","id":"I60685027dbf01fba725cd811be98c7e653410389","number":"2241","subject":"MANTA-3258 muskie could expose metrics Reviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/2241","commitMessage":"MANTA-3258 muskie could expose metrics\nReviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1500572921,"lastUpdated":1503521131,"open":false,"status":"MERGED","comments":[{"timestamp":1500572921,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1500572953,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1500930372,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(5 comments)\n\nNice!\n\nCould we add some documentation about this to the README?  Something about the fact that Muskie exposes these metrics via artedi in the Prometheus format, which metrics are exposed, and maybe a note about which fields are selected (which is presumably limited because of the high cardinality when you start adding lots of fields?).  I imagine we\u0027ll want some of that in a lot of repos, so maybe it would make sense to make sure the considerations for selecting fields are part of the node-artedi documentation and then just link to that, but I still think it would be useful to say here that we\u0027re exposing metrics with artedi, which ones we picked, and why."},{"timestamp":1500930772,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\nAnother idea that came up during the discussion about Moray was a per-handler histogram.  That would be pretty helpful.\n\nThe ticket also mentions per-owner and/or per-caller stats.  Would we defer that for future work?\n\nIt\u0027s most important to have this basic stuff, so it\u0027s totally fine to defer any of this but I\u0027d like to file new tickets for it if we still think we want to tackle it later."},{"timestamp":1500932324,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(3 comments)\n\nThanks for the comments! I\u0027ll get to work on revisions."},{"timestamp":1500933294,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1501186651,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1501186690,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501189824,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\nThis patchset adds the \u0027_ms\u0027 label to the latency histogram names and addresses the line-item review feedback.\n\nIt\u0027s best to defer user and caller tracking until we better understand how this impacts our systems (in both memory usage and metric query time). I\u0027ll create a ticket to add user and caller metrics.\n\nPer-handler histograms would be useful! I think we can also defer that for future work, and I\u0027ll create a ticket to add instrumentation to restify.\n\nI can also create a ticket for documentation if it\u0027s not required right now."},{"timestamp":1501268214,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThanks!\n\n \u003e I can also create a ticket for documentation if it\u0027s not required\n \u003e right now.\n\nI don\u0027t think the docs need to be more than a few sentences in total, but I think it would be really worthwhile.  I think a note about how to access them for a given process will pay off when somebody from ops wants to inspect a particular process in prod or an engineer wants to add (and test) another metric.\n\nAbout the cardinality problem: my worry is that somebody might add a metric on some very high-cardinality field, like remote IP or something, without realizing that just exposing that metric creates very significant impact downstream.  I don\u0027t think this would need to be more than a sentence of warning."},{"timestamp":1501278747,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2:\n\n\u003e Thanks!\n \u003e \n \u003e \u003e I can also create a ticket for documentation if it\u0027s not required\n \u003e \u003e right now.\n \u003e \n \u003e I don\u0027t think the docs need to be more than a few sentences in\n \u003e total, but I think it would be really worthwhile.  I think a note\n \u003e about how to access them for a given process will pay off when\n \u003e somebody from ops wants to inspect a particular process in prod or\n \u003e an engineer wants to add (and test) another metric.\n \u003e \n \u003e About the cardinality problem: my worry is that somebody might add\n \u003e a metric on some very high-cardinality field, like remote IP or\n \u003e something, without realizing that just exposing that metric creates\n \u003e very significant impact downstream.  I don\u0027t think this would need\n \u003e to be more than a sentence of warning.\n\nI was imagining it to be longer than a few sentences. I added MANTA-3360 yesterday. What I\u0027ll do is add some docs to this CR, and then change MANTA-3360 to be about adding documentation to the operator guide. Does that sound good?"},{"timestamp":1501285099,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nThat sounds great.  Thanks!"},{"timestamp":1501515722,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1501515755,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501515844,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\nThis patchset adds documentation in docs/internal/design.md. The README for this repo looks to be primarily for consumers of the public-facing API, so it didn\u0027t seem like a great fit there. I thought the design.md file was more where an operator would look for something like this."},{"timestamp":1501518601,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n\u003e This patchset adds documentation in docs/internal/design.md. The\n \u003e README for this repo looks to be primarily for consumers of the\n \u003e public-facing API, so it didn\u0027t seem like a great fit there. I\n \u003e thought the design.md file was more where an operator would look\n \u003e for something like this.\n\nThanks!  That looks great.  Can we add a note to the README about it too?  I\u0027m trying to make sure that new people see this because I think it will be an important tool for people new to developing Muskie.  To me, it\u0027s right up there with running the test suite (which is most of what the README covers today) as something people working on Muskie should know about."},{"timestamp":1501528235,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1501528268,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501528365,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 4:\n\n\u003e Can we add a note to the README about it too?\n\nOk, awesome. I added a note in the README, primarily pointing to the design.md file, but I moved the note about metric cardinality to the README, with an extra warning and link to node-artedi."},{"timestamp":1501531788,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1\n\nThanks!  That looks great."},{"timestamp":1501532868,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 3:\n\n(6 comments)\n\nLooks great!\n\nOne question that I didn\u0027t know where to put in the code:\n- Where is the route for GET /metrics actually added? I can\u0027t seem to find it."},{"timestamp":1501532913,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1501534206,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1501541494,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5."},{"timestamp":1501541521,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501541633,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 6."},{"timestamp":1501541671,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501541849,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 6:\n\n\u003e Looks great!\n \u003e \n \u003e One question that I didn\u0027t know where to put in the code:\n \u003e - Where is the route for GET /metrics actually added? I can\u0027t seem\n \u003e to find it.\n\nGreat! We already spoke about this, but it\u0027s in main.js line 238.\n\nPatchset 5 fixes typos, adds the coal json config, and changes the way we create the restify handler in other.js. \nPatchset 6 adds a couple lines in the README to explain how to get metrics using curl (sorry, I forgot to add this to patchset 5). It\u0027s make-prepush clean."},{"timestamp":1501699369,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1501780223,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1\n\n(1 comment)"},{"timestamp":1501798013,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 7."},{"timestamp":1501798045,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1501798074,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1501798080,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 7:\n\nThanks! This was all great feedback. I\u0027ll add testing notes to the JIRA ticket."},{"timestamp":1501798091,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1502229567,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 8."},{"timestamp":1502229594,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502229742,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 8:\n\nThis latest patchset adds a testing file. The way we get the port number for the monitoring server feels like a hack. I\u0027m all ears if anyone has a better suggestion for how we do that :)"},{"timestamp":1502289123,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 8:\n\n\u003e This latest patchset adds a testing file. The way we get the port\n \u003e number for the monitoring server feels like a hack. I\u0027m all ears if\n \u003e anyone has a better suggestion for how we do that :)\n\nActually, I think I should use something like node-strsplit for this."},{"timestamp":1502291182,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 9."},{"timestamp":1502291220,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502291240,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 8:\n\nOk, this latest patch set makes the tests better. I added a devDependency for strsplit, though it\u0027s being used just like the built-in split() function. Let me know if I should change it back."},{"timestamp":1502296925,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1502300458,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1502309530,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 10."},{"timestamp":1502309562,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502312534,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1502314183,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1502314834,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1502315285,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1502315562,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 10:\n\n(1 comment)"},{"timestamp":1502322152,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 11."},{"timestamp":1502322190,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502323622,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 11:\n\n(3 comments)"},{"timestamp":1502330697,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 12."},{"timestamp":1502330731,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502331452,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 11:\n\n(2 comments)"},{"timestamp":1502382655,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 13."},{"timestamp":1502382683,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502382853,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 13:\n\nThis latest patch set adds a \u0027checkEnvironment()\u0027 function to the helper.js file. Hopefully that\u0027s helpful for checking if environment variables are set before we do anything. That runs for all of the tests, including the mpu tests."},{"timestamp":1502383281,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 13: Code-Review+1\n\n(2 comments)"},{"timestamp":1502383336,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 13:\n\n(1 comment)"},{"timestamp":1502384410,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1502384766,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 13:\n\n(1 comment)"},{"timestamp":1502384960,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 14."},{"timestamp":1502385001,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502385042,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 14:\n\nPatch set 14 is a rebase and commit message update"},{"timestamp":1502385480,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 14: Code-Review+1\n\nI wonder why that didn\u0027t show up as a simple rebase in Gerrit."},{"timestamp":1502726530,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 14:\n\nI believe we decided to wait until you are back from time off to integrate this, so ping me when you\u0027re back to do IA."},{"timestamp":1503343488,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 15."},{"timestamp":1503343521,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1503343617,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 15:\n\nPatchset 15 is a non-trivial rebase. There was a small conflict with MANTA-2500 where we set up the \u0027cfg\u0027 object in main.js. It didn\u0027t require any logic changes.\n\nAs usual, this is \u0027make prepush\u0027 clean."},{"timestamp":1503415715,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 15:\n\nIt seems like the changes from MANTA-2500 are appearing as your changes in patchset 15. Did something else change from 14 to 15?"},{"timestamp":1503416706,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 15:\n\n(1 comment)\n\n\u003e It seems like the changes from MANTA-2500 are appearing as your\n \u003e changes in patchset 15. Did something else change from 14 to 15?\n\nFrom looking at other conflict-rebase-CRs, I think this is the intended behavior. Since the parent commits changed between 14 and 15, the contents of those files also changed, which seems misleading in gerrit. The diff to \u0027base\u0027 is correct, and includes MANTA-2500 without marking it as being changed in this CR.\n\nTo actually answer your question, nothing really changed. I added a newline during the rebase, which I marked with a note."},{"timestamp":1503435152,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 15: Code-Review+1\n\nSorry - I should\u0027ve compared to the base after the rebase instead of the previous patchset.\n\nAnyway, for IA, given that the muskie tests pass, I think it would be useful to at least build an image and do some sanity checking against the metrics. After you\u0027ve done that (or if you\u0027ve already done that), would you mind noting that in the ticket?"},{"timestamp":1503505294,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 15: Code-Review+1"},{"timestamp":1503520177,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 15: Integration-Approval+1"},{"timestamp":1503521042,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 16: Commit message was updated."},{"timestamp":1503521131,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"16","revision":"60685027dbf01fba725cd811be98c7e653410389","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/41/2241/16","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1503521042,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503343521,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503435152,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503505294,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503520177,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1503521131,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":91,"deletions":0}],"sizeInsertions":307,"sizeDeletions":-27},"patchSets":[{"number":"1","revision":"9e7efce83d098dba8a78a80f6b7b6d361ad7d3cc","parents":["5612dacc607713e3f55a7aa431e832b315193a79"],"ref":"refs/changes/41/2241/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1500572921,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1500572953,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/audit.js","line":275,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I know this is nitty, but could we put this block before the \"log.info\"?  That way if somebody is looking at the state at that point, it would reflect updated counters."},{"file":"lib/audit.js","line":276,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Could we have these fields match the log entry (so these would be \"operation\" and \"statusCode\")?  I also wonder if we want to add a proper \"method\" field (that would generally be PUT, GET, DELETE, or POST instead of \"putobject\" or the like) because in a lot of cases, it doesn\u0027t matter which specific operation it is as much as the method (e.g., \"putobject\" and \"putreportsobject\" or something like that)."},{"file":"lib/audit.js","line":276,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sure, I can make this change. \n\nI would like to remain consistent throughout all of our REST-based applications, however. That will make it easier on the side of the monitoring server to make queries (for example, a query counting requests per second grouped by HTTP response code, regardless of whether it came from muskie, sapi, cnapi, etc.). So if we choose the names \u0027operation\u0027 and \u0027statusCode,\u0027 that\u0027s what we should be using for all of our REST components."},{"file":"lib/audit.js","line":276,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think \"operation\" is already muskie specific -- it refers to muskie-specific routes.  (We could also *just* do \"method\" for now, which would be more broadly applicable and may be all we need.)  \"statusCode\" seems fine to me for other components as well."},{"file":"main.js","line":128,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we add pid?"},{"file":"main.js","line":275,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It feels like this is starting to get a little much for a function that was supposedly just creating an agent.  Would it be reasonable to move L259 through L281 to a separate setupMonitoring() function or would that involve a lot of surgery?"},{"file":"main.js","line":275,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yep, that shouldn\u0027t take much effort."},{"file":"sapi_manifests/muskie/template","line":204,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this new, or was this always provided?"},{"file":"sapi_manifests/muskie/template","line":204,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This is already provided for Manta services. There was some discussion about this in manta@ on June 12th. For a code pointer: https://github.com/joyent/sdc-manta/blob/f3c4aa6163768e56e8acea4f21f03b5a50b648be/lib/deploy.js#L785"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":36,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":22,"deletions":-8},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":90,"sizeDeletions":-12},{"number":"2","revision":"0529f529a97413619d8f1d2a3c37e854d00a93f9","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501186651,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501186690,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":100,"sizeDeletions":-22},{"number":"3","revision":"023ba01f9796b05e8155729551a3345279d06387","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501515722,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501515755,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/internal/design.md","line":49,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: s/accesible/accessible"},{"file":"docs/internal/design.md","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/processes/process"},{"file":"docs/internal/design.md","line":63,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It\u0027s good that we have this explanation of the design. Could we also provide a short example on how to use the metrics in the top-level muskie README? That might help users of the metrics get up to speed on consuming these faster."},{"file":"docs/internal/design.md","line":82,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This is interesting -- thanks for including it. Do you think this reasoning should be in a comment or the operator\u0027s guide so we know not to add these types of labels in the future?"},{"file":"docs/internal/design.md","line":82,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"FWIW, I do think this note is important for future developers, but I don\u0027t think the operator guide is a good place for content that\u0027s only applicable for people that are changing the software itself."},{"file":"docs/internal/design.md","line":82,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"just noticed: \"metadata\""},{"file":"lib/other.js","line":402,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think we should be consistent on using the \"*Handler\" name only to refer to restify handlers (i.e., having the signature \"func (req, res, next)\")."},{"file":"lib/server.js","line":671,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: add newline after this line to be consistent with other exports"},{"file":"sapi_manifests/muskie/template","line":204,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Do we also need to update the coal config to have these fields?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":48,"deletions":-3},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":148,"sizeDeletions":-25},{"number":"4","revision":"933d10599839c590fb0954b12d63f99be881ac49","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501528235,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501531788,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501528268,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":14,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":156,"sizeDeletions":-25},{"number":"5","revision":"97b108926041d81f172d5bae185ac70dbe7e9dd5","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501541494,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501541521,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":164,"sizeDeletions":-26},{"number":"6","revision":"6929bf1bbde18b3d00efac4729936aee42a8dde8","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/6","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501541633,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501780223,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501541671,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501699369,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"README.md","line":71,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be nice to explain either what this is used for or the impact of not including it so that a new developer knows whether to skip this step."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":24,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":169,"sizeDeletions":-26},{"number":"7","revision":"01ae72c6add5d9b9e0be78e80ecaee9520428117","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/7","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1501798013,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501798074,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501798045,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1501798091,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":171,"sizeDeletions":-26},{"number":"8","revision":"c2f9d34edfbddbdfbbfc2aab65d93e763c81fd28","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/8","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502229567,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502229594,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":69,"deletions":0}],"sizeInsertions":240,"sizeDeletions":-26},{"number":"9","revision":"42c3375507584098bc9d75786d92ad6c913fdeaa","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/9","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502291182,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502291220,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/monitoring.test.js","line":38,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you probably want to use Node\u0027s built-in url.parse()."},{"file":"test/monitoring.test.js","line":71,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"We could also check the response code here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":75,"deletions":0}],"sizeInsertions":247,"sizeDeletions":-26},{"number":"10","revision":"286d6aa5d34214c163dc14bff37b0ac4b0c9b813","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/10","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502309530,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502309562,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502312534,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"test/monitoring.test.js","line":38,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like this flies off the rails if I\u0027m not using a port in MANTA_URL (e.g., MANTA_URL\u003dhttp://1.2.3.4).  I think it would pick port \"NaN\", and I\u0027m not sure what happens after that.  Arguably we wouldn\u0027t expect you to point the test suite at the default port (80 or 443, depending on the protocol), but if that\u0027s the position seems like we should blow up here rather than proceed.\n\nIt would also be nice if this validated the input a bit better (e.g., checked for MANTA_URL being present at all and used jsprim.parseInteger() to see if \"port\" was really a valid int and a valid TCP port).  Even in test code, I find that\u0027s pretty valuable because new contributors burn a bunch of time trying to figure out what they haven\u0027t set properly in their environment.  Sorry I didn\u0027t mention this before (and it\u0027s not critical)."},{"file":"test/monitoring.test.js","line":38,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yeah, this breaks in that case (hence the note in the comment). In my sandbox I would originally have this test suite be skipped if the MANTA_URL didn\u0027t have a port number, but I thought that wouldn\u0027t fly since that\u0027s valid for all of the other tests. All of the other tests will run if pointed at a load balancer as well (port 80), but not these tests since haproxy is not configured to forward requests to the monitoring server.\n\nThe README does state to include a port in the MANTA_URL string. This whole business with editing the ports doesn\u0027t sit right with me in general, so I\u0027m up for suggestions for other approaches.\n\nI\u0027ll go ahead and make the changes you\u0027re suggesting here."},{"file":"test/monitoring.test.js","line":38,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\u003e (hence the note in the comment)\n\nOops!  Sorry I missed that.  I would recommend failing explicitly then."},{"file":"test/monitoring.test.js","line":42,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why not url.format()?"},{"file":"test/monitoring.test.js","line":42,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I looked into this. Maybe I\u0027m not understanding it correctly, but url.format() will not take into account changes to the url.port field. So if I would set url.port \u003d url.port+800 and then called url.format(url), it would return the old url string :/"},{"file":"test/monitoring.test.js","line":42,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think that\u0027s because the parsed representation has some redundant information (the port is also in the \"host\" field), and the docs say that \"port\" will only be used if \"host\" is absent.  From my test, if you delete the \"host\" property, it will do the right thing."},{"file":"test/monitoring.test.js","line":42,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sure, yep. I just looked at the code for that function. Alright, I can do that.\n\nFor the record, that code is here: https://github.com/nodejs/node-v0.x-archive/blob/v0.12.7/lib/url.js#L394"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":77,"deletions":0}],"sizeInsertions":249,"sizeDeletions":-26},{"number":"11","revision":"19fc32762761cfaa4b3cd77822967233ffb886ee","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/11","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502322152,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502322190,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/monitoring.test.js","line":38,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It looks like url.parse() blows up if given undefined, so I think if you leave this out of the environment, you\u0027ll just get a stack trace from Node core."},{"file":"test/monitoring.test.js","line":38,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yep. This error check is really to give us a better error message than what we\u0027ll get if jsprim blows an assertion."},{"file":"test/monitoring.test.js","line":39,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Return here?"},{"file":"test/monitoring.test.js","line":39,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sure. It will be unreached, since the callback just logs the error and exits, but I can do that."},{"file":"test/monitoring.test.js","line":46,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This could just be VError.  You don\u0027t have to pull that in here just for that, but maybe this should be \"port.message\"?\n\nShould we return here?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":89,"deletions":0}],"sizeInsertions":261,"sizeDeletions":-26},{"number":"12","revision":"997e4826fa46172047e867621f6abe817f3e879b","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/12","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502330697,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502330731,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":91,"deletions":0}],"sizeInsertions":263,"sizeDeletions":-26},{"number":"13","revision":"8b39fa69ec1b8bb36648143bbcca0aed78bd11e1","parents":["2330f3b82cbc39cc9c6c4fd82db15cfa7eb6c0c3"],"ref":"refs/changes/41/2241/13","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502382655,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502384410,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502382683,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502383281,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"test/helper.js","line":35,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Do you have an example of what this output looks like?"},{"file":"test/helper.js","line":35,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Specifically: output if I forget to set or incorrectly set 1  or more env variables."},{"file":"test/helper.js","line":35,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sure, I just posted a comment in the Jira issue. There isn\u0027t any validation beyond checking if the variables exist... I could create a jira issue for creating more general \u0027pre-test vetting\u0027 if you think that\u0027s a good idea. That would include things like making sure MANTA_USER exists, the MANTA_URL is pingable, etc."},{"file":"test/helper.js","line":261,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Sweet. This should be helpful for debugging tests."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":91,"deletions":0}],"sizeInsertions":307,"sizeDeletions":-27},{"number":"14","revision":"9469490d83d01b9a178bc5ea394b87461d8c5d36","parents":["af4520cc26aaed16d4e4024f8088c4a2d6eed8b0"],"ref":"refs/changes/41/2241/14","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1502384960,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502385480,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502385001,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":91,"deletions":0}],"sizeInsertions":307,"sizeDeletions":-27},{"number":"15","revision":"2e0e428452296c6a3d6c925a2c16b63fcd60a5ac","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/41/2241/15","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1503343488,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503505294,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503343521,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503435152,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503520177,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"main.js","line":152,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This line (a new blank line) is all that I changed when I did the rebase. The rest was a simple merge (and test)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":91,"deletions":0}],"sizeInsertions":307,"sizeDeletions":-27},{"number":"16","revision":"60685027dbf01fba725cd811be98c7e653410389","parents":["cecdfce62528af5535e29640b414287860afaf25"],"ref":"refs/changes/41/2241/16","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1503521042,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503505294,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1503343521,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1503435152,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1503520177,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1503521131,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":26,"deletions":0},{"file":"docs/internal/design.md","type":"MODIFIED","insertions":42,"deletions":-3},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/audit.js","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/other.js","type":"MODIFIED","insertions":19,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"main.js","type":"MODIFIED","insertions":38,"deletions":-18},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":0},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"test/monitoring.test.js","type":"ADDED","insertions":91,"deletions":0}],"sizeInsertions":307,"sizeDeletions":-27}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}