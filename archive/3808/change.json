{"project":"joyent/illumos-joyent","branch":"master","id":"I7620edd0c9cc3a66ffed10c76664535b373ddd45","number":"3808","subject":"OS-6878 mac_fix_cksum is incomplete Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/3808","commitMessage":"OS-6878 mac_fix_cksum is incomplete\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1523477866,"lastUpdated":1524261939,"open":false,"status":"MERGED","comments":[{"timestamp":1523477866,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1523483631,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1523538452,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1523542941,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1523544865,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1523545488,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1523546599,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1523558501,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nPlease make sure you do a full nightly on this, and file a followup for getting rid of that nxge global.  I\u0027m happy to do the full nightly if that\u0027ll help."},{"timestamp":1523992310,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1523994795,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1523994819,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1523996081,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1524235722,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nTesting note in the ticket."},{"timestamp":1524255212,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1524255232,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Code-Review+1\n\nNo changes modulo two unused variables removed."},{"timestamp":1524261827,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1524261917,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1524261939,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"7620edd0c9cc3a66ffed10c76664535b373ddd45","parents":["73dd2365dcd084d8ce1e3c7e1051570c1724de3f"],"ref":"refs/changes/08/3808/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1524261917,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523996081,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524255212,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524255232,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1524261938,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6.c","type":"MODIFIED","insertions":0,"deletions":-106},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":208,"deletions":-76},{"file":"usr/src/uts/common/os/ip_cksum.c","type":"MODIFIED","insertions":108,"deletions":0},{"file":"usr/src/uts/common/sys/stream.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/strsubr.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":331,"sizeDeletions":-187},"patchSets":[{"number":"1","revision":"a1e47391d2e8ab76550161ae96de245dddc8f00b","parents":["b69f4bed85ad0bc7cab4782cf2398bee183d4a0f"],"ref":"refs/changes/08/3808/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1523477866,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/inet/ip/ip6_output.c","line":816,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is this just for testing?  Or are you going to actually keep this around?"},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","line":816,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I cleaned up the code below which was using this flag, but as I pointed out in the comment I added here, I can\u0027t actually remove this without breaking the build. It\u0027s probably worth figuring out why the \"ip\" module has this build time check, but that is a separate issue in my mind."},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","line":816,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"It\u0027s weird, and has to do with needing to be consistent with genunix.  There are things in the build directories that need adjustment when you alter global symbols:\n\n everywhere(ws/ij-varpd)[1]% grep nxge usr/src/uts/intel/ip/*\n usr/src/uts/intel/ip/ip.global-objs.debug64:nxge_cksum_workaround\n usr/src/uts/intel/ip/ip.global-objs.obj64:nxge_cksum_workaround\n everywhere(ws/ij-varpd)[0]%\n\nI can\u0027t remember WHY it has to be this way, but if you alter global symbols in IP, you need to alter all of the ip.global-objs* files."},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","line":900,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Why the extra variable?  Not using \"orig\" after this, are you? Same applies above as well."},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","line":900,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I had this here for some intermediate changes I was originally working on before I split out this work into a new ticket. I\u0027ll remove it."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":158,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"alternatively you could move ip_hdr_length_v6() into $SRC/uts/common/os/ip_csum.c where sctp_cksum() lives."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":158,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This is a great suggestion, I\u0027ll do that."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":429,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Can you ASSERT(ipha-\u003eipha_hdr_checksum \u003d\u003d 0) as well?"},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":429,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I will have to spend some time to investigate if that is valid. Is there a reason you\u0027d like me to do that? Eventually I expect all of the checksum work to consolidate here in MAC, but right now it is still kind of spread out."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":429,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Computing the IP header checksum requires the checksum 16-bits be zeroed.  From RFC 791, page 13:\n\n\"For purposes of computing the checksum, the value of the checksum field is zero.\"\n\nip_csum_hdr() doesn\u0027t check, because on inbound packets if the sum is filled in properly, the result will be 0.\n\nAnything exploiting HDRCKSUM should already have zeroed this out, hence my request for an assertion."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":429,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sorry, yes, of course. I think instead of asserting here, I should just set the value to 0. Does that seem reasonable to you?"},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":429,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I guess there\u0027s no harm in it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":15,"deletions":-3},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":273,"deletions":-76},{"file":"usr/src/uts/common/sys/stream.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/strsubr.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":292,"sizeDeletions":-81},{"number":"2","revision":"bda0560cf9e3a3a1931727e759e677d0f0354dfb","parents":["b69f4bed85ad0bc7cab4782cf2398bee183d4a0f"],"ref":"refs/changes/08/3808/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1523546599,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523558501,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/io/mac/mac_util.c","line":158,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Unused copy pasta."},{"file":"usr/src/uts/common/io/mac/mac_util.c","line":158,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"removed"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6.c","type":"MODIFIED","insertions":0,"deletions":-106},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":209,"deletions":-76},{"file":"usr/src/uts/common/os/ip_cksum.c","type":"MODIFIED","insertions":108,"deletions":0},{"file":"usr/src/uts/common/sys/stream.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/strsubr.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":332,"sizeDeletions":-187},{"number":"3","revision":"99f0497d4f0cfd5b96bc4b57098596626248984f","parents":["99dda62835ffd7e81816de700276a4ec1420691e"],"ref":"refs/changes/08/3808/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1523994819,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523996081,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524255232,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524255212,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6.c","type":"MODIFIED","insertions":0,"deletions":-106},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":208,"deletions":-76},{"file":"usr/src/uts/common/os/ip_cksum.c","type":"MODIFIED","insertions":108,"deletions":0},{"file":"usr/src/uts/common/sys/stream.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/strsubr.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":331,"sizeDeletions":-187},{"number":"4","revision":"4e19def98f257cf6a84dc91a4208c226f30ac888","parents":["73dd2365dcd084d8ce1e3c7e1051570c1724de3f"],"ref":"refs/changes/08/3808/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1524261827,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523996081,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524255232,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524255212,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6.c","type":"MODIFIED","insertions":0,"deletions":-106},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":208,"deletions":-76},{"file":"usr/src/uts/common/os/ip_cksum.c","type":"MODIFIED","insertions":108,"deletions":0},{"file":"usr/src/uts/common/sys/stream.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/strsubr.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":331,"sizeDeletions":-187},{"number":"5","revision":"7620edd0c9cc3a66ffed10c76664535b373ddd45","parents":["73dd2365dcd084d8ce1e3c7e1051570c1724de3f"],"ref":"refs/changes/08/3808/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1524261917,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1524261938,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523996081,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524255232,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524255212,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6.c","type":"MODIFIED","insertions":0,"deletions":-106},{"file":"usr/src/uts/common/inet/ip/ip6_output.c","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"usr/src/uts/common/io/mac/mac_util.c","type":"MODIFIED","insertions":208,"deletions":-76},{"file":"usr/src/uts/common/os/ip_cksum.c","type":"MODIFIED","insertions":108,"deletions":0},{"file":"usr/src/uts/common/sys/stream.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/uts/common/sys/strsubr.h","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":331,"sizeDeletions":-187}],"allReviewers":[{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}