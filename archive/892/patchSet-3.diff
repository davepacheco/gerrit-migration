commit f50093175dfd054bc608f52f00ae7d243fb8624e (refs/changes/92/892/3)
Author: Jerry Jelinek <jerry.jelinek@joyent.com>
Date:   2016-11-15T10:31:42+00:00 (2 years, 11 months ago)
    
    HEAD-2329 hook cnapi changes for RFD 53 into joysetup

diff --git a/scripts/joysetup.sh b/scripts/joysetup.sh
index 1c0d6b0c..e8dc8eda 100755
--- a/scripts/joysetup.sh
+++ b/scripts/joysetup.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright 2016, Joyent, Inc.
 #
 
 #
@@ -622,7 +622,20 @@ if [[ "$(zpool list)" == "no pools available" ]] \
         POOL_FILE=/mockcn/${MOCKCN_SERVER_UUID}/pool.json
     fi
 
-    if ! /usr/bin/disklayout "${arg_disklayout}" > ${POOL_FILE}; then
+    # We expect sdc-server to validate the input for the following parameters
+    # passed by CNAPI, but to be safe, we use some defensive quoting as well.
+    if [[ -n "${CONFIG_spares}" ]]; then
+        dl0="-s"
+        dl1="${CONFIG_spares}"
+    fi
+    if [[ -n "${CONFIG_cache}" && "${CONFIG_cache}" == "false" ]]; then
+        dl2="-c"
+    fi
+    if [[ -n "${CONFIG_layout}" ]]; then
+        dl3="${CONFIG_layout}"
+    fi
+
+    if ! /usr/bin/disklayout ${dl0} "${dl1}" ${dl2} "${dl3}"> ${POOL_FILE}; then
         fatal "disk layout failed"
     fi
 
