{"project":"joyent/sdc-papi","branch":"master","id":"Ia9f707e86c97781a5a36794f8fb43e061552d946","number":"3532","subject":"TRITON-181 would like packages to be able to optionally be brand-specific Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/3532","commitMessage":"TRITON-181 would like packages to be able to optionally be brand-specific\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1520040902,"lastUpdated":1520475229,"open":false,"status":"MERGED","comments":[{"timestamp":1520040902,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1520040904,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 55f1e7b315e290690c034d841ad4f8ef48c5d6a4\n    \n    initial attempt"},{"timestamp":1520040940,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nThis is still being worked on, not ready for full review yet."},{"timestamp":1520274652,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1520274653,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit b6ed1d090dfd67acfc1dd789848ea995bd5ccd18\n    \n    fix make check?"},{"timestamp":1520276532,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1520278776,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1520279507,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1520279509,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 9f5726563af93163882b4936662d646c09b5718b\n    \n    address CR comments"},{"timestamp":1520279738,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1520284056,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1520284102,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1520290331,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1520290354,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"},{"timestamp":1520474742,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1:\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1520475172,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1520475229,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"4","revision":"a9f707e86c97781a5a36794f8fb43e061552d946","parents":["8d9f8ee18278d0e97321efc04348365f4d5fff47"],"ref":"refs/changes/32/3532/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1520290331,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520284102,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520284102,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1520290354,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":58,"deletions":-47},{"file":"lib/validations.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/papi/template","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"test/api.test.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"tools/rsync-to","type":"ADDED","insertions":66,"deletions":0}],"sizeInsertions":162,"sizeDeletions":-56},"patchSets":[{"number":"1","revision":"00a194527d31a8c9ffa094ea11ad320b1bf2df81","parents":["8d9f8ee18278d0e97321efc04348365f4d5fff47"],"ref":"refs/changes/32/3532/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1520040902,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"test/api.test.js","line":435,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":29,"deletions":-20},{"file":"lib/validations.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"sapi_manifests/papi/template","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"test/api.test.js","type":"MODIFIED","insertions":25,"deletions":-6},{"file":"tools/rsync-to","type":"ADDED","insertions":66,"deletions":0}],"sizeInsertions":132,"sizeDeletions":-28},{"number":"2","revision":"fa0530fb71d4ba06878821d6a9f8b807ef10b868","parents":["8d9f8ee18278d0e97321efc04348365f4d5fff47"],"ref":"refs/changes/32/3532/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1520274652,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"docs/index.md","line":59,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps let\u0027s bump the minor version in PAPI package.json and add a `*(Added in vX.Y.Z)*` note here. Thoughts?"},{"file":"docs/index.md","line":59,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok"},{"file":"docs/index.md","line":99,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Same thought as above: add `*(Added in vX.Y.Z)*`."},{"file":"docs/index.md","line":99,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok"},{"file":"lib/validations.js","line":174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I know you are following a pattern here, but if pkg.brand is a *number* or an object or whatever, does this validation code miss that?\n\nI wonder if the `if (typeof foo \u003d\u003d\u003d \u0027string\u0027)` was a way to test for existence back when PAPI data was in UFDS and the only possible type for an existing field was \"string\"."},{"file":"lib/validations.js","line":174,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"good catch. I\u0027ll get rid of this and test that."},{"file":"lib/validations.js","line":174,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I tested this, and without changing it did still fail with:\n\n[root@headnode (coal) ~]# sdc-papi /packages/c8218f52-a6c4-c113-ebac-efa1403330ce -X PUT -d \u0027{\"brand\": 3}\u0027\nHTTP/1.1 409 Conflict\nrequest-id: c8218f52-a6c4-c113-ebac-efa1403330ce\nrequest-id: c8218f52-a6c4-c113-ebac-efa1403330ce\nContent-Type: application/json\nContent-Length: 138\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Headers: Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, Api-Version, Response-Time\nAccess-Control-Allow-Methods: GET, HEAD, PUT, DELETE\nAccess-Control-Expose-Headers: Api-Version, Request-Id, Response-Time\nConnection: Keep-Alive\nContent-MD5: jzr87DYV03P/prNn8E1S7A\u003d\u003d\nDate: Sun, 04 Mar 2018 04:26:23 GMT\nServer: SDC Package API 7.0.0\nApi-Version: 7.0.0\nResponse-Time: 110\n\n{\n  \"code\": \"InvalidArgument\",\n  \"message\": \"Updated package is invalid\",\n  \"errors\": [\n    {\n      \"field\": \"brand\",\n      \"code\": \"Invalid\",\n      \"message\": \"must be string\"\n    }\n  ]\n}\n[root@headnode (coal) ~]#\n\nbut with my change it now fails with:\n\n[root@headnode (coal) ~]# sdc-papi /packages/c8218f52-a6c4-c113-ebac-efa1403330ce -X PUT -d \u0027{\"brand\": 3}\u0027\nHTTP/1.1 409 Conflict\nrequest-id: c8218f52-a6c4-c113-ebac-efa1403330ce\nrequest-id: c8218f52-a6c4-c113-ebac-efa1403330ce\nContent-Type: application/json\nContent-Length: 240\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Headers: Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, Api-Version, Response-Time\nAccess-Control-Allow-Methods: GET, HEAD, PUT, DELETE\nAccess-Control-Expose-Headers: Api-Version, Request-Id, Response-Time\nConnection: Keep-Alive\nContent-MD5: Hi5DZa1rQKCE7bB+Foop8A\u003d\u003d\nDate: Sun, 04 Mar 2018 04:27:05 GMT\nServer: SDC Package API 7.1.0\nApi-Version: 7.1.0\nResponse-Time: 100\n\n{\n  \"code\": \"InvalidArgument\",\n  \"message\": \"Updated package is invalid\",\n  \"errors\": [\n    {\n      \"field\": \"brand\",\n      \"code\": \"Invalid\",\n      \"message\": \"must be string\"\n    },\n    {\n      \"field\": \"brand\",\n      \"code\": \"Invalid\",\n      \"message\": \"must be one of: bhyve, joyent, joyent-minimal, kvm, lx\"\n    }\n  ]\n}\n[root@headnode (coal) ~]#"},{"file":"lib/validations.js","line":174,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, so the *type* checking is elsewhere in the code. Okay."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":29,"deletions":-20},{"file":"lib/validations.js","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"sapi_manifests/papi/template","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"test/api.test.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"tools/rsync-to","type":"ADDED","insertions":66,"deletions":0}],"sizeInsertions":133,"sizeDeletions":-28},{"number":"3","revision":"fac73e06dd7afb4fb038d4e63b1957879c6c9ff3","parents":["8d9f8ee18278d0e97321efc04348365f4d5fff47"],"ref":"refs/changes/32/3532/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1520279507,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520284102,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520284102,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":58,"deletions":-47},{"file":"lib/validations.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/papi/template","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"test/api.test.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"tools/rsync-to","type":"ADDED","insertions":66,"deletions":0}],"sizeInsertions":162,"sizeDeletions":-56},{"number":"4","revision":"a9f707e86c97781a5a36794f8fb43e061552d946","parents":["8d9f8ee18278d0e97321efc04348365f4d5fff47"],"ref":"refs/changes/32/3532/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1520290331,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520284102,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520284102,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1520290354,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":58,"deletions":-47},{"file":"lib/validations.js","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/papi/template","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"test/api.test.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"tools/rsync-to","type":"ADDED","insertions":66,"deletions":0}],"sizeInsertions":162,"sizeDeletions":-56}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}