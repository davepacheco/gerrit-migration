{"project":"joyent/sdc-vmapi","branch":"master","id":"I748ce0dd003f34824cac4d74ea3ea28808b90886","number":"807","subject":"ZAPI-753 Update VMAPI to node v4.x Reviewed by: Richard Kiene \u003crichard.kiene@joyent.com\u003e Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Approved by: Richard Kiene \u003crichard.kiene@joyent.com\u003e Approved by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/807","commitMessage":"ZAPI-753 Update VMAPI to node v4.x\nReviewed by: Richard Kiene \u003crichard.kiene@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nApproved by: Richard Kiene \u003crichard.kiene@joyent.com\u003e\nApproved by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1477629398,"lastUpdated":1477678989,"open":false,"status":"MERGED","comments":[{"timestamp":1477629398,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1477629400,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 7881001f52a4b6a30efc81a790a116322419c0b0\n    \n    ZAPI-753 updates for node v4"},{"timestamp":1477629431,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1477669581,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1\n\nLGTM"},{"timestamp":1477671707,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1477672613,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1477673589,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1477673681,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1477673682,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 03c899d2cf2eb926ab42db878346c970942b3025\n    \n    updates based on feedback from Trent"},{"timestamp":1477673708,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1477675877,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1477677708,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1477678989,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"3","revision":"fd3a8dbd65d4a890dcedbfc0f5d6382d2ba6dbad","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/07/807/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1477677708,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477673708,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477675877,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477675877,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1477678989,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":13,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-11},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"test/vms.curl-head-requests.test.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":5,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-50},"patchSets":[{"number":"1","revision":"2366624959f3c872b18d353a73cc702eb304ff84","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/07/807/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1477629398,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477629431,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477669581,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477669581,"by":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"}}],"comments":[{"file":"lib/apis/moray.js","line":24,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"My *pref* (doesn\u0027t have to block this) would be that the var change name to match. I.e. to `ldapFilter` or whatever.\n\nAlso could consider moving to moray-filter at some point."},{"file":"lib/apis/moray.js","line":24,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I started to change this, but since ldapFilter is also used as a variable here and a property of objects and ldapFilterString is also used, using ldapFilter seems confusing. I\u0027ll leave this for whoever updates to moray-filter."},{"file":"lib/errors.js","line":217,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is there a ticket with details on this?"},{"file":"lib/errors.js","line":217,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"There isn\u0027t a ticket, and I\u0027m not sure where to create one since the issue is a \"feature\" of restify. The problem happens when you have an Error object that\u0027s passed to a next() handler without a .name since this will blow up:\n\nhttps://github.com/restify/node-restify/blob/bd0b524cd3635d4c230aec50702930ca5535bb04/lib/server.js#L829\n\nwith:\n\n    TypeError: Cannot read property \u0027replace\u0027 of undefined\n        at next (/opt/smartdc/vmapi/node_modules/restify/lib/server.js:829:35)"},{"file":"package.json","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"There is one incompat change here, in that assert.number accepts Infinity now. It might be worth sanity checking the following hits and switching to \u0027assert.finite\u0027 as appropriate:\n\n[09:16:02 trentm@danger0:~/joy/sdc-vmapi (master)]\n$ ag assert.number | grep -v node_modules\nlib/apis/moray.js:346:        assert.number(params.create_timestamp,\nlib/endpoints/vms.js:228:                assert.number(req.params.limit,\nlib/vmapi.js:107:    assert.number(options.moray.port, \u0027Moray config.moray.port\u0027);\nlib/vmapi.js:118:    assert.number(options.changefeed.moray.port,\nlib/vmapi.js:120:    assert.number(options.changefeed.maxAge,\nlib/vmapi.js:146:    assert.number(res.statusCode, \u0027res.statusCode\u0027);\ntest/lib/vm.js:62:    assert.number(nbTestVmsToCreate, \u0027nbTestVmsToCreate\u0027);\ntools/add-test-vms.js:79:    assert.number(nbVms, \u0027nbVms must be a number\u0027);\ntools/add-test-vms.js:82:    assert.number(concurrency, \u0027concurrency must be a number\u0027);\ntools/add-test-vms.js:93:        assert.number(nbTestVmsToCreate);\ntools/add-test-vms.js:96:        assert.number(concurrency);\ntest/vms.list.test.js:299:    assert.number(limit, \u0027options\u0027);\n[09:16:05 trentm@danger0:~/joy/sdc-vmapi (master)]\n$ ag assert.optionalNumber | grep -v node_modules\nlib/common/validation.js:525:    assert.optionalNumber(options.min, \u0027options.min\u0027);\nlib/common/validation.js:526:    assert.optionalNumber(options.max, \u0027options.max\u0027);\nlib/common/validation.js:1813:    assert.optionalNumber(options.min);\nlib/common/validation.js:1814:    assert.optionalNumber(options.max);"},{"file":"package.json","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok, I\u0027ll just change those all to finite now then to be safe. Thanks."},{"file":"package.json","line":21,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could take 10.0.3 here, tho that fix doesn\u0027t affect VMAPI\u0027s current usage."},{"file":"package.json","line":21,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok, will do."},{"file":"test/vms.curl-head-requests.test.js","line":219,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nice!"},{"file":"test/vms.curl-head-requests.test.js","line":211,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"what\u0027s this change about?"},{"file":"test/vms.curl-head-requests.test.js","line":211,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Change in node has changed the default from \u0027keep-alive\u0027 to \u0027close\u0027. Since this test is just testing that the default is what we expect, it needs to change to the new default."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":9,"deletions":-5},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-11},{"file":"test/vms.curl-head-requests.test.js","type":"MODIFIED","insertions":5,"deletions":-5}],"sizeInsertions":36,"sizeDeletions":-31},{"number":"2","revision":"748ce0dd003f34824cac4d74ea3ea28808b90886","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/07/807/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1477673681,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477673708,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477675877,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477675877,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":13,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-11},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"test/vms.curl-head-requests.test.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":5,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-50},{"number":"3","revision":"fd3a8dbd65d4a890dcedbfc0f5d6382d2ba6dbad","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/07/807/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1477677708,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477673708,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477675877,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477675877,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1477678989,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":13,"deletions":-9},{"file":"package.json","type":"MODIFIED","insertions":10,"deletions":-11},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"test/vms.curl-head-requests.test.js","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":5,"deletions":-5}],"sizeInsertions":65,"sizeDeletions":-50}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}