{"project":"joyent/node-triton","branch":"master","id":"I6417595ba60ba213ac51cc160658ed86d7d59e00","number":"3575","subject":"TRITON-167 Anti-affinity rules fail when no instances match the name TRITON-168 Regex anti-affinity rules fail unexpectedly Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/3575","commitMessage":"TRITON-167 Anti-affinity rules fail when no instances match the name\nTRITON-168 Regex anti-affinity rules fail unexpectedly\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1520601592,"lastUpdated":1523414678,"open":false,"status":"MERGED","comments":[{"timestamp":1520601592,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1520601623,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520975218,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2."},{"timestamp":1520975249,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520975367,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3."},{"timestamp":1520975399,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520979794,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1522923728,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 4."},{"timestamp":1522923760,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522949064,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1\n\n(8 comments)"},{"timestamp":1523009133,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 5."},{"timestamp":1523009165,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1523402143,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5: Code-Review+1\n\nMarsell, LGTM. Please do *NOT* merge this yet until we get the 5.10.0 release out."},{"timestamp":1523402940,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5: Integration-Approval+1\n\nOkay, published in TRITON-316."},{"timestamp":1523408232,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 6."},{"timestamp":1523408264,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1523414600,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1523414678,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"6","revision":"6417595ba60ba213ac51cc160658ed86d7d59e00","parents":["d3d3216a38349db449126daad41bc22324e98190"],"ref":"refs/changes/75/3575/6","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1523408232,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1523408264,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523414600,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523414600,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1523414678,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":3,"deletions":-160},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":43,"deletions":-8}],"sizeInsertions":77,"sizeDeletions":-170},"patchSets":[{"number":"1","revision":"a4cdca68aa53769883fb11b68da89fed829810ea","parents":["002171ea067fc76541ea5f384c8e697900e3987f"],"ref":"refs/changes/75/3575/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1520601592,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520601623,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":60,"deletions":-118},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":63,"sizeDeletions":-121},{"number":"2","revision":"37d59c2a59d23501e776a478deafa077cb86316e","parents":["002171ea067fc76541ea5f384c8e697900e3987f"],"ref":"refs/changes/75/3575/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1520975218,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520975249,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":60,"deletions":-118},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":68,"sizeDeletions":-121},{"number":"3","revision":"0c9a75fb73613933f874d64f394b8e460f2dedca","parents":["002171ea067fc76541ea5f384c8e697900e3987f"],"ref":"refs/changes/75/3575/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1520975367,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520975399,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/do_instance/do_create.js","line":95,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"An alternative suggestion:\nLet\u0027s not parse/validate affinity rules at all in client-side node-triton. Instead we\u0027ll just pass them directly through to cloudapi. Given that we are dropping affinity-\u003elocality translation in the client, we are changing this to require cloudapi v8.3.0 already. That means we should change node-triton to \"Accept-Version: ~8\" (i.e. drop \"~7\" as an acceptable version here: https://github.com/joyent/node-triton/blob/master/lib/tritonapi.js#L136). If we doing that we should bump the node-triton major ver. If we are doing that we can just drop the other client-side conveniences that are being done here:\n\n- \"inst\" -\u003e \"instance\" abbreviation\n- \"\u003d\" -\u003e \"\u003d\u003d\" abbreviation\n\nSome benefits of doing so:\n\n- less code in node-triton\n- examples that work with node-triton will work directly with cloudapi (less potential confusion)\n- other cloudapi clients (like terraform) won\u0027t feel obliged to also do (potentially incompatible or buggy) parsing of affinity rules to implement to same conveniences.\n\n\nAlso, I\u0027m totally okay bumping the node-triton major version for this. CloudAPI v8 came out more than 2 years ago. Users stuck with an older cloudapi can stay at the older node-triton."},{"file":"lib/do_instance/do_create.js","line":316,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"`ctx.locality` was only ever set in `resolveLocality` which you\u0027ve dropped, so can remove this block."},{"file":"lib/do_instance/do_create.js","line":325,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Given that ctx.locality is gone, I think we can drop this block."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":60,"deletions":-118},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":69,"sizeDeletions":-121},{"number":"4","revision":"70f39a017afdc3f8ea73041d09448f35082d39f6","parents":["96a5be8ce70cfcc4697f370a90ba03e786b4facb"],"ref":"refs/changes/75/3575/4","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1522923728,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522923760,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522949064,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"CHANGES.md","line":25,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"`[TRITON-167, TRITON-168]`"},{"file":"CHANGES.md","line":26,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"An example would be very helpful"},{"file":"CHANGES.md","line":27,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Tags or globs? Or both?"},{"file":"CHANGES.md","line":28,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can we specify that in terms of CloudAPI semver version? E.g. is this about being at CloudAPI version 8.3.0? https://mo.joyent.com/docs/cloudapi/master/#830"},{"file":"CHANGES.md","line":32,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Also the \"--affinity\u003dINST\" shortcut has been removed as well, right?"},{"file":"lib/tritonapi.js","line":136,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think the CHANGES.md section for 6.0.0 should spell out that this node-triton is dropping support for 7.x CloudAPI\u0027s."},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"ah, rigth. If we are doing this major ver bump, then I think we should get a 5.x release out with the current queued up changes, and then do this after.\n\nThere is a bug that MikeZ is working on with test/cli-nics.test.js (don\u0027t have a ticket for it yet)."},{"file":"test/integration/cli-affinity.test.js","line":95,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I just noticed that this and the next `tt.test` name should not have \"setup:\" in them. These are the actual tests in this file. :)\n\nPossible to add a test case using regex, glob and tags?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":9,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":3,"deletions":-160},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":6,"deletions":-6}],"sizeInsertions":20,"sizeDeletions":-168},{"number":"5","revision":"f2166eda3e9f63a33f1f6243ec67181843e0dbf4","parents":["96a5be8ce70cfcc4697f370a90ba03e786b4facb"],"ref":"refs/changes/75/3575/5","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1523009133,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1523009165,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523402143,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523402940,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":32,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":3,"deletions":-160},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":43,"deletions":-8}],"sizeInsertions":80,"sizeDeletions":-170},{"number":"6","revision":"6417595ba60ba213ac51cc160658ed86d7d59e00","parents":["d3d3216a38349db449126daad41bc22324e98190"],"ref":"refs/changes/75/3575/6","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1523408232,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1523408264,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523414600,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1523414600,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1523414678,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/do_instance/do_create.js","type":"MODIFIED","insertions":3,"deletions":-160},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/integration/cli-affinity.test.js","type":"MODIFIED","insertions":43,"deletions":-8}],"sizeInsertions":77,"sizeDeletions":-170}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}]}