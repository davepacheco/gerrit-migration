{"project":"joyent/illumos-joyent","branch":"master","id":"Ic9254ee5521e8eeed03d6346a57472e239fce71a","number":"2230","subject":"OS-6116 epoll should better detect fd reassignment Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Jason King \u003cjason.king@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/2230","commitMessage":"OS-6116 epoll should better detect fd reassignment\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1500412986,"lastUpdated":1500599548,"open":false,"status":"MERGED","comments":[{"timestamp":1500412986,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1500416558,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)\n\nThis looks good to me and I think the generation handling is good. I just had one really minor nit."},{"timestamp":1500437982,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1500438002,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1500466484,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1500488107,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nModulo the tiny nit, ship it!"},{"timestamp":1500488779,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1500489183,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1500490175,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1500490760,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1500577001,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\nThe epoll-test-suite yield the expected results, including from the new testcase I wrote to exercise fd reassignment detection.  LTP runs clean with the change as well."},{"timestamp":1500577406,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1500582941,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1500589869,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1500589969,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1500599548,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"4","revision":"c9254ee5521e8eeed03d6346a57472e239fce71a","parents":["b09f56270cc4cc33835a844b694a499dad9a5fea"],"ref":"refs/changes/30/2230/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1500589969,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500466484,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500488107,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500577406,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500582941,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1500599548,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":149,"deletions":-155},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":21,"deletions":-7},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/user.h","type":"MODIFIED","insertions":19,"deletions":-2}],"sizeInsertions":191,"sizeDeletions":-169},"patchSets":[{"number":"1","revision":"4656ff33f735f5d9bcfa95112ae07acdf08baaf6","parents":["2bcd0c2213ad2567e05837f2b5406447e005a44b"],"ref":"refs/changes/30/2230/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1500412986,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/devpoll.c","line":714,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"could you use an explicit type here, like uint_t"},{"file":"usr/src/uts/common/io/devpoll.c","line":714,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":149,"deletions":-155},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":21,"deletions":-7},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/user.h","type":"MODIFIED","insertions":19,"deletions":-2}],"sizeInsertions":191,"sizeDeletions":-169},{"number":"2","revision":"a9603098d286a8ecf2f9e3f82f7e1b40ab699705","parents":["2bcd0c2213ad2567e05837f2b5406447e005a44b"],"ref":"refs/changes/30/2230/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1500437982,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500466484,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500577406,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500582941,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500488107,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/os/fio.c","line":622,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"TINY nit.  Since getf_gen() is prototyped in sys/file.h, I\u0027d move this to BEFORE getf_gen(), so a clever compiler can utter code that is essentially one function with two entry points. (This occurs in IP sometimes.)"},{"file":"usr/src/uts/common/os/fio.c","line":622,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Can you recall any specific examples of this?  I\u0027d like to understand the circumstances before messing with it here."},{"file":"usr/src/uts/common/os/fio.c","line":622,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"http://src.illumos.org/source/xref/illumos-gate/usr/src/uts/common/inet/ip/ip_output.c#762\n\nhttp://src.illumos.org/source/xref/illumos-gate/usr/src/uts/common/inet/ip/ip.c#2323\n\nTBH, I can take it or leave it - i.e. it\u0027s not a blocker \u0026 you can say no, but since you\u0027re adding it new anyway, I figured it\u0027d be easy."},{"file":"usr/src/uts/common/os/fio.c","line":622,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Looking at the emitted instructions, I don\u0027t see anything of significant difference for those functions.  Won\u0027t ABI strictness keep the compiler on the straight-n-narrow here?\n\nPerhaps I\u0027m misunderstanding?"},{"file":"usr/src/uts/common/os/fio.c","line":622,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Well shoot. Future compilers may be that clever then (also I-cache effects).\n\nSeriously, don\u0027t worry about this.  I didn\u0027t mean to bikeshed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":149,"deletions":-155},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":21,"deletions":-7},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/user.h","type":"MODIFIED","insertions":19,"deletions":-2}],"sizeInsertions":191,"sizeDeletions":-169},{"number":"3","revision":"e5813b6b522aa5acd2c62f7421bf3f887c997231","parents":["b09f56270cc4cc33835a844b694a499dad9a5fea"],"ref":"refs/changes/30/2230/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1500589869,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500466484,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500577406,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500582941,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500488107,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":149,"deletions":-155},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":21,"deletions":-7},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/user.h","type":"MODIFIED","insertions":19,"deletions":-2}],"sizeInsertions":191,"sizeDeletions":-169},{"number":"4","revision":"c9254ee5521e8eeed03d6346a57472e239fce71a","parents":["b09f56270cc4cc33835a844b694a499dad9a5fea"],"ref":"refs/changes/30/2230/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1500589969,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500466484,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1500577406,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1500599548,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500582941,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1500488107,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/devpoll.c","type":"MODIFIED","insertions":149,"deletions":-155},{"file":"usr/src/uts/common/os/fio.c","type":"MODIFIED","insertions":21,"deletions":-7},{"file":"usr/src/uts/common/sys/file.h","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/sys/poll_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/sys/user.h","type":"MODIFIED","insertions":19,"deletions":-2}],"sizeInsertions":191,"sizeDeletions":-169}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}