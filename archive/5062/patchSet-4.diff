From f1a8efb01446f4c2ee46f75743c3d5e6c48031f9 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 20 Nov 2018 18:25:41 +0100
Subject: [PATCH] TRITON-964 Add `flexible_disk` attribute support to Packages

---
 docs/index.md                |  80 ++++++++++++++++++++++++---
 etc/config.test.json         |   8 +++
 lib/validations.js           |  29 ++++++++--
 package.json                 |   2 +-
 sapi_manifests/papi/template |   8 +++
 test/api.test.js             | 102 +++++++++++++++++++++++++----------
 6 files changed, 188 insertions(+), 41 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index 1ff0788..ab17574 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -58,11 +58,11 @@ example of a package:
 | [billing_tag](#package-billing_tag)                 |           |        |           | string  |          | Arbitrary tag that can be used by ops for billing purposes; it has no intrinsic meaning to Triton.         |
 | [brand](#package-brand)                             |           |        | true      | string  |   v7.1.0 | Force this brand for zones using this package, one of: 'bhyve', 'joyent', 'joyent-minimal', 'kvm', 'lx'    |
 | [common_name](#package-common_name)                 |           |        |           | string  |          | Name displayed in the Portal.                                                                              |
-| cpu_burst_ratio                                     |           |        |           | float   |          | Typically computed value. See below for more.                                                              |
+| `cpu_burst_ratio`                                   |           |        |           | float   |          | Typically computed value. See below for more.                                                              |
 | [cpu_cap](#package-cpu_cap)                         | sometimes |        | true      | integer |          | Cap on how much CPU a machine can use. 100 = one core, 350 = 3.5 cores, etc.                               |
 | [default](#package-default)                         |           |        |           | boolean |          | **DEPRECATED** Whether this is the default package of this name through the SDC 6.5 API                    |
 | [description](#package-description)                 |           |        |           | string  |          | Human description of this package.                                                                         |
-| [fss](#package-fss)                                 |           |        |           | integer |          | CPU shares for a VM. This operates relative to other machines on a CN. (also known as cpu_shares)          |
+| [fss](#package-fss)                                 |           |        |           | integer |          | CPU shares for a VM. This operates relative to other machines on a CN. (also known as `cpu_shares`)        |
 | [group](#package-group)                             |           |        |           | string  |          | Group of associated packages. E.g. High CPU, High Memory, High Storage, High IO or the customer's name.    |
 | [max_lwps](#package-max_lwps)                       | true      |        | true      | integer |          | Max number of processes allowed                                                                            |
 | [max_physical_memory](#package-max_physical_memory) | true      |        | true      | integer |          | Max RAM in MiB.                                                                                            |
@@ -74,13 +74,15 @@ example of a package:
 | [owner_uuids](#package-owner_uuids)                 |           |        |           | array   |          | UUIDs of package owners.                                                                                   |
 | [parent](#package-parent)                           |           |        |           | string  |          | `name` of instance this was cloned from. Useful if package is created from another package for a customer. |
 | [quota](#package-quota)                             | true      |        | true      | integer |          | Disk size in MiB. Must be a multiple of 1024.                                                              |
-| ram_ratio                                           |           |        |           | float   |          | Typically computed value. See below for more.                                                              |
+| `ram_ratio`                                         |           |        |           | float   |          | Typically computed value. See below for more.                                                              |
 | [traits](#package-traits)                           |           |        |           | hash    |          | Set of traits for provisioning to servers. See DAPI docs for details on traits.                            |
 | [uuid](#package-uuid)                               | true      | true   | true      | uuid    |          | Package identifier.                                                                                        |
 | [v](#package-v)                                     |           |        |           | integer |          | API version of PAPI.                                                                                       |
 | [version](#package-version)                         | true      |        | true      | string  |          | Semver version number.                                                                                     |
 | [vcpus](#package-vcpus)                             | sometimes |        | true      | integer |          | Number of cpus to show, between 1 - 64. Required during provisioning if `type` == 'kvm'.                   |
 | [zfs_io_priority](#package-zfs_io_priority)         | true      |        | true      | integer |          | ZFS I/O priority. This operates relative to other machines on a CN, determining which get I/O first.       |
+| [flexible_disk](#package-flexible_disk)             | sometimes |        |           | boolean |   v7.2.0 | If set to `true` the package's `quota` reflects the amount of space available for all disks                |
+| [disks](#package-flexible_disk)                     |           |        |           | hash    |   v7.2.0 | The `size` for each package disk. Allowed when `flexible_disk` = `true`                                    |
 
 
 ## Package: active
@@ -125,7 +127,7 @@ core, 350 = 3.5 cores, and so forth.
 
     "cpu_cap": 1600
 
-cpu_cap is required by default, but can be made optional by setting
+`cpu_cap` is required by default, but can be made optional by setting
 `IGNORE_CPU_CAP` in papi's sapi metadata to boolean "true". See more details and
 *important warnings* in the "SAPI Configuration" section below.
 
@@ -150,7 +152,7 @@ Sets a limit on the number of fair share scheduler (FSS) CPU shares for a VM.
 This value is relative, so a value only has meaning in relation to other VMs on
 the same CN. If one VM has a value 2048 and one has a value 1024, the VM with
 2048 should expect to get more time from the scheduler. The rest of SDC calls
-this value 'cpu_shares'.
+this value `cpu_shares`.
 
 For some more information, see also references to 'cpu-shares' in the [SmartOS
 zonecfg(1M) man page.](https://smartos.org/man/1M/zonecfg)
@@ -204,8 +206,8 @@ Name displayed through the API.
 
     "name": "g3-standard-0.25-smartos"
 
-Must match /^[a-zA-Z0-9]([a-zA-Z0-9\_\-\.]+)?[a-zA-Z0-9]$/ and not have
-consecutive '_', '-' or '.' characters.
+Must match `/^[a-zA-Z0-9]([a-zA-Z0-9\_\-\.]+)?[a-zA-Z0-9]$/` and not have
+consecutive `_`, `-` or `.` characters.
 
 
 ## Package: networks
@@ -303,12 +305,74 @@ same name, but different versions.
 ## Package: zfs_io_priority
 
 When I/O between different zones on a CN compete for disk, their
-zfs_io_priorities are compared, and the ones with higher priority get a larger
+`zfs_io_priorities` are compared, and the ones with higher priority get a larger
 proportion of disk accesses. The proportions are determined by the relative
 differences between this attribute in zones.
 
     "zfs_io_priority": 50
 
+## Package: flexible_disk
+
+When set to `true` the package's `quota` attribute reflects the amount of
+space available for all disks. It only applies when the brand is set to `bhyve`.
+
+Consider the following packages:
+
+**Inflexible package**
+
+        {
+          ...,
+          "quota": 102400,
+          ...,
+        }
+
+
+**Flexible package**
+
+        {
+          ...,
+          "quota": 102400,
+          "flexible_disk": true,
+          ...,
+        }
+
+
+The following table outlines the results when used with various images.
+
+| Image size | Inflexible boot disk size | Inflexible data disk size | Flexible boot disk size | Flexible data disk size |
+| -----------| ------------------------- | ------------------------- | ----------------------- | ----------------------- |
+| 10 GiB     | 10 GiB                    | 100 GiB                   | 10 GiB                  | 90 GiB                  |
+| 90 GiB     | 90 GiB                    | 100 GiB                   | 90 GiB                  | 10 GiB                  |
+| 1 TiB      | 1 TiB                     | 100 GiB                   | Error                   | Error                   |
+
+### Default disks in package
+
+A flexible disk package may specify the default size for disks through the `disks` property.
+These sizes can be overridden by a `disks` attribute when creating a machine.
+
+In this example, any image smaller than 102400 MiB is resized to occupy all of the instance's disk space (102400 MiB).
+
+        {
+          ...,
+          "quota": 102400,
+          "flexible_disk": true,
+          "disks": [ { "size": "remaining" } ],
+          ...,
+        }
+
+
+In this example, all space not allocated to the image remains free for future disk allocations and snapshots.
+
+
+        {
+          ...,
+          "quota": 102400,
+          "flexible_disk": true,
+          "disks": [ { } ],
+          ...,
+        }
+
+
 
 ## Immutable Attributes and Package Persistence
 
diff --git a/etc/config.test.json b/etc/config.test.json
index 1e48931..d2db780 100644
--- a/etc/config.test.json
+++ b/etc/config.test.json
@@ -154,6 +154,14 @@
         },
         "alloc_server_spread": {
             "type": "string"
+        },
+        "flexible_disk": {
+            "type": "boolean",
+            "index": false
+        },
+        "disks": {
+            "type": "[object]",
+            "index": false
         }
     }
 }
diff --git a/lib/validations.js b/lib/validations.js
index d6866de..f7c5b8f 100644
--- a/lib/validations.js
+++ b/lib/validations.js
@@ -12,16 +12,13 @@
  * Validations run on each package.
  */
 
-var util = require('util');
-var sprintf = util.format;
-
 var BAD_NAME_RE = /[\_\-\.][\_\-\.]/;
 var NAME_RE = /^[a-zA-Z0-9]([a-zA-Z0-9\_\-\.]+)?[a-zA-Z0-9]$/;
 var UUID_RE = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;
 var VALID_BRANDS = ['bhyve', 'joyent', 'joyent-minimal', 'kvm', 'lx'];
 var VALID_SPREADS = ['min-ram', 'random', 'min-owner'];
 
-///--- Validation helpers
+// -- Validation helpers
 
 function validUUID(uuid) {
     return UUID_RE.test(uuid);
@@ -112,6 +109,9 @@ function validate(pkg, schema) {
         if (expectedType === 'string' && actualType !== 'string') {
             invalid(name, 'must be string');
 
+        } else if (expectedType === 'boolean' && actualType !== 'boolean') {
+            invalid(name, 'must be boolean');
+
         } else if (expectedType === 'uuid' && !validUUID(val)) {
             invalid(name, 'must be UUID');
 
@@ -147,6 +147,22 @@ function validate(pkg, schema) {
                     invalid(name, 'must only contain UUIDs');
             }
 
+        } else if (expectedType === '[object]') {
+            if (!Array.isArray(val)) {
+                invalid(name, 'must be an array');
+
+            } else if (name === 'disks') {
+                var nonObjects = val.filter(function filterNonObject(i) {
+                    return (Object.keys(i).some(function someInvalidKey(k) {
+                            return k !== 'size';
+                        }));
+                });
+
+                if (nonObjects.length > 0)
+                    invalid(name, 'must only contain Objects with ' +
+                        '"size" property');
+            }
+
         } else if (expectedType === 'object' &&
                    (actualType !== 'object' || Array.isArray(val))) {
             invalid(name, 'must be a hash');
@@ -213,6 +229,11 @@ function validate(pkg, schema) {
                 ', and less or equal to ' + MAX_VCPUS);
     }
 
+    if (pkg.disks && pkg.flexible_disk !== true) {
+        invalid('disks',
+            'disks can be specified only for flexible_disk packages');
+    }
+
     if (errors.length)
         return errors;
 
diff --git a/package.json b/package.json
index 918be9e..c0eddc4 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdc-papi",
   "description": "Packages API",
-  "version": "7.1.1",
+  "version": "7.2.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "repository": {
diff --git a/sapi_manifests/papi/template b/sapi_manifests/papi/template
index 9e26247..5df61d6 100644
--- a/sapi_manifests/papi/template
+++ b/sapi_manifests/papi/template
@@ -163,6 +163,14 @@
         },
         "alloc_server_spread": {
             "type": "string"
+        },
+        "flexible_disk": {
+            "type": "boolean",
+            "index": false
+        },
+        "disks": {
+            "type": "[object]",
+            "index": false
         }
     }
 }
diff --git a/test/api.test.js b/test/api.test.js
index 217287f..91a268c 100644
--- a/test/api.test.js
+++ b/test/api.test.js
@@ -409,7 +409,9 @@ test('POST /packages (fields validation failed)', function (t) {
         description: 'This is a package description, and should be present',
         common_name: 'Regular 128MiB',
         fss: 25,
-        alloc_server_spread: 'invalid'
+        alloc_server_spread: 'invalid',
+        flexible_disk: 'ho-ho-ho!',
+        disks: [ {'foo': 'bar'} ]
     };
 
     client.post('/packages', pkg, function (err, req, res, _) {
@@ -420,31 +422,69 @@ test('POST /packages (fields validation failed)', function (t) {
         t.equal(err.body.message, 'Package is invalid');
 
         var expectedErrs = [
-            { field: 'networks',
-              code: 'Invalid',
-              message: 'must only contain UUIDs' },
-            { field: 'os', code: 'Invalid', message: 'must be string' },
-            { field: 'uuid', code: 'Invalid', message: 'must be UUID' },
-            { field: 'alloc_server_spread',
-              code: 'Invalid',
-              message: 'must be one of: min-ram, random, min-owner' },
-            { field: 'brand',
-              code: 'Invalid',
-              message:
-                'must be one of: bhyve, joyent, joyent-minimal, kvm, lx' },
-            { field: 'max_physical_memory',
-              code: 'Invalid',
-              message: 'must be greater or equal to 64' },
-            { field: 'quota',
-              code: 'Invalid',
-              message: 'must be greater or equal to 1024' },
-            { field: 'quota',
-              code: 'Invalid',
-              message: 'must be a multiple of 1024' },
-            { field: 'zfs_io_priority',
-              code: 'Invalid',
-              message: 'must be greater or equal to 0, and less than or ' +
-                  'equal to 16383' }
+            {
+                field: 'disks',
+                code: 'Invalid',
+                message: 'must only contain Objects with "size" property'
+            },
+            {
+                field: 'flexible_disk',
+                code: 'Invalid',
+                message: 'must be boolean'
+            },
+            {
+                field: 'networks',
+                code: 'Invalid',
+                message: 'must only contain UUIDs'
+            },
+            {
+                field: 'os',
+                code: 'Invalid',
+                message: 'must be string'
+            },
+            {
+                field: 'uuid',
+                code: 'Invalid',
+                message: 'must be UUID'
+            },
+            {
+                field: 'alloc_server_spread',
+                code: 'Invalid',
+                message: 'must be one of: min-ram, random, min-owner'
+            },
+            {
+                field: 'brand',
+                code: 'Invalid',
+                message:
+                    'must be one of: bhyve, joyent, joyent-minimal, kvm, lx'
+            },
+            {
+                field: 'max_physical_memory',
+                code: 'Invalid',
+                message: 'must be greater or equal to 64'
+            },
+            {
+                field: 'quota',
+                code: 'Invalid',
+                message: 'must be greater or equal to 1024'
+            },
+            {
+                field: 'quota',
+                code: 'Invalid',
+                message: 'must be a multiple of 1024'
+            },
+            {
+                field: 'zfs_io_priority',
+                code: 'Invalid',
+                message: 'must be greater or equal to 0, and less than or ' +
+                  'equal to 16383'
+            },
+            {
+                field: 'disks',
+                code: 'Invalid',
+                message: 'disks can be specified only for flexible_disk' +
+                ' packages'
+            }
         ];
         t.deepEqual(err.body.errors, expectedErrs);
 
@@ -472,7 +512,9 @@ test('POST /packages (quota must be multiple of 1024)', function (t) {
         uuid: 'ebb58a8c-b77e-4559-bbf0-19ebd67973f0',
         description: 'This is a package description, and should be present',
         common_name: 'Regular 128MiB',
-        fss: 25
+        fss: 25,
+        flexible_disk: true,
+        disks: [ {} ]
     };
 
     client.post('/packages', pkg, function (err, req, res, _) {
@@ -528,7 +570,11 @@ test('POST /packages (VCPUS exceeding MAX value)', function (t) {
         uuid: 'ebb58a8c-b77e-4559-bbf0-19ebd67973f0',
         description: 'This is a package description, and should be present',
         common_name: 'Regular 128MiB',
-        fss: 25
+        fss: 25,
+        flexible_disk: true,
+        disks: [ {
+            size: 'remaining'
+        } ]
     };
 
     client.post('/packages', pkg, function (err, req, res, _) {
-- 
2.21.0

