From a85b4deb7d6e661c741bdcf42fab1f8aef217e4e Mon Sep 17 00:00:00 2001
From: Jordan Hendricks <jordan.hendricks@joyent.com>
Date: Mon, 19 Jun 2017 02:27:07 +0000
Subject: [PATCH] MANTA-3296 Mako returned different md5 sums for the same MPU
 object Reviewed By: Approved By:

---
 src/http/modules/mpu/ngx_http_mpu_commit_module.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/http/modules/mpu/ngx_http_mpu_commit_module.c b/src/http/modules/mpu/ngx_http_mpu_commit_module.c
index a682babf..0e077728 100644
--- a/src/http/modules/mpu/ngx_http_mpu_commit_module.c
+++ b/src/http/modules/mpu/ngx_http_mpu_commit_module.c
@@ -601,6 +601,13 @@ mpu_convert_md5(mpu_request_t *mpcr)
 static boolean_t
 mpu_determine_output_md5(mpu_request_t *mpcr, int fd)
 {
+    /*
+     * It's possible we have already started calculating the md5 sum of the
+     * object before this function is called, so we need to reinitialize the
+     * state of the md5 sum before starting from the beginning of the object.
+     */
+	ngx_md5_init(&mpcr->mpcr_md5);
+
 	for (;;) {
 		ssize_t ret;
 
-- 
2.21.0

