From 42ee64dc50568215082a642fc3e51f3b748b61ee Mon Sep 17 00:00:00 2001
From: Brian Bennett <brian.bennett@joyent.com>
Date: Thu, 7 Dec 2017 16:47:40 -0800
Subject: [PATCH] joyent/manta-thoth#167 thoth should be easier to use from the
 headnode

---
 bin/sdc-thoth-install    | 39 +++++++++++++++++++++++++++++++--------
 bin/sdc-thoth-update-all |  2 ++
 2 files changed, 33 insertions(+), 8 deletions(-)

diff --git a/bin/sdc-thoth-install b/bin/sdc-thoth-install
index d05019c..15858eb 100755
--- a/bin/sdc-thoth-install
+++ b/bin/sdc-thoth-install
@@ -161,6 +161,7 @@ crontab=$home/crontab
 postboot=$base/bin/postboot
 manifest=/opt/custom/smf/thoth.xml
 runthoth=$home/run-thoth
+thothwrapper=$base/bin/thoth
 
 echo Creating crontab ...
 
@@ -170,24 +171,46 @@ EOF
 
 echo Creating `basename $runthoth` script ...
 
-cat > $runthoth <<EOF
+cat > "$runthoth" <<"EOF"
+#!/bin/bash
 #
 # This script is run out of a cron job.  By default, it does nothing (it
 # runs with --dry-run); this option should be removed to get sdc-thoth to
 # actually start uploading.
 #
-source ~/.bashrc
 
-log=\`date +log/%Y/%m/%d/%H/%M/sdc-thoth.out\`
-mkdir -p \$HOME/\`dirname \$log\`
-sdc-thoth --dry-run > \$log
+if [[ $LOGNAME == thoth ]]
+    thoth_home=$HOME
+else
+    thoth_home=$(getent passwd thoth | awk -F: '{print $6}')
+fi
+source "${thoth_home:?}/.bashrc"
+
+[[ -z $thoth_home ]]; then
+    printf 'Unable to find thoth $HOME.\n'
+    printf 'Is thoth set up properly?\n'
+    exit 1
+fi
+
+log=$(date +log/%Y/%m/%d/%H/%M/sdc-thoth.out)
+mkdir -p "${HOME}/$(dirname $log)
+sdc-thoth --dry-run > "$log"
 
-mlog=/\$MANTA_USER/stor/thoth/logs/\$THOTH_UUID/\$log
-mmkdir -p \`dirname \$mlog\`
-mput -f \$log \$mlog
+mlog="/${MANTA_USER}/stor/thoth/logs/${THOTH_UUID}/${log}"
+mmkdir -p "$(dirname $mlog)"
+mput -f "$log" "$mlog"
 EOF
 
 chmod +x $runthoth
+ln -s /opt/custom/thoth/bin/run-thoth ../home/thoth/run-thoth
+
+cat > $thothwrapper <<EOF
+#!/bin/bash
+
+$base/bin/node $base/node_modules/.bin/thoth "${@}"
+EOF
+
+chmod +x $thothwrapper
 
 cat > $postboot <<EOF
 #!/bin/bash
diff --git a/bin/sdc-thoth-update-all b/bin/sdc-thoth-update-all
index d337e68..415f639 100755
--- a/bin/sdc-thoth-update-all
+++ b/bin/sdc-thoth-update-all
@@ -72,6 +72,8 @@ echo "Downloading thoth to compute nodes ..."
 sdc-oneachnode -a -g $staged -d /var/tmp 1>&2
 echo "Installing thoth on compute nodes ..."
 sdc-oneachnode -a "cd / ; gzcat $tarball | tar xf - ; rm $tarball" 1>&2
+sdc-oneachnode -c -gX /opt/custom/thoth/bin/thoth -d /opt/custom/thoth/bin/
+sdc-oneachnode -a 'chmod +x /opt/custom/thoth/bin/thoth'
 rm $staged
 echo "Done"
 
-- 
2.21.0

