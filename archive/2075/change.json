{"project":"joyent/sdc-cloudapi","branch":"master","id":"I8aed3d6843aaa89b90421fedf3be9c75d9b29e46","number":"2075","subject":"PUBAPI-1404: cloudapi test failures: \"origNics and newNics should be the same\" Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/2075","commitMessage":"PUBAPI-1404: cloudapi test failures: \"origNics and newNics should be the same\"\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1497280274,"lastUpdated":1497653953,"open":false,"status":"ABANDONED","comments":[{"timestamp":1497280274,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1497280304,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1497299579,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1497337062,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1497337665,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1497337679,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2."},{"timestamp":1497337709,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1497369676,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1497384253,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1497387857,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1497448292,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1497450425,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\nI just witnessed a NIC get deleted... then come back from the dead.\n\nNope, nope, nope; this is a problem for later today."},{"timestamp":1497532934,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3."},{"timestamp":1497532969,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1497533415,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3:\n\nI wasted far more than I should have digging into various failures that appear if you elide the VM reboot check. Life is much easier with the check; all sorts of timing issues and task failures start manifesting themselves if you don\u0027t.\n\nI\u0027d rather not spend any more time on this. There are more pressing issues."},{"timestamp":1497653953,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Abandoned\n\nSuperceded by https://cr.joyent.us/#/c/2120/"}],"currentPatchSet":{"number":"3","revision":"8aed3d6843aaa89b90421fedf3be9c75d9b29e46","parents":["7f06df08c0d15709660528902ca1b1c515344d0e"],"ref":"refs/changes/75/2075/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1497532934,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497532969,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"test/nics.test.js","type":"MODIFIED","insertions":165,"deletions":-46}],"sizeInsertions":165,"sizeDeletions":-46},"patchSets":[{"number":"1","revision":"a368b96b16ffcfc766c735ac3c730e60ad52082d","parents":["7f06df08c0d15709660528902ca1b1c515344d0e"],"ref":"refs/changes/75/2075/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1497280274,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497280304,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/nics.test.js","line":650,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Do you know why these were necessary?"},{"file":"test/nics.test.js","line":756,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps as an error object?  `cb(new Error(\"VM ...\"));`"},{"file":"test/nics.test.js","line":756,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would prefer this style:\n\n```\ncb(...);\nreturn;\n```\n\nThen we can drop two of the `return`s below in this function."},{"file":"test/nics.test.js","line":756,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I\u0027m not remotely a fan of that pattern. It\u0027s one of the most common patterns in our codebases, yet we make it four lines instead of the single line it could be:\n\nif (err) return cb(err);\n\nLord knows JS needs a lot of help when it comes to boilerplate."},{"file":"test/nics.test.js","line":756,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Sorry. You can take a survey with others if you like. The general preference (at least for those working in sdc-docker.git and others) from previous conversations on the same point is the one I indicated. Unfortunately I don\u0027t have links to those conversations, and we don\u0027t have enforced rules or docs for those, so this is fluid and in the \"nit\" category.\n\nI agree it is more lines. However, IIRC, there is already a rule (in jsl or jsstyle) to avoid having two keywords on one line (`if` and `return`) so really it is a change from 3:\n\n```\nif (err) {\n    return cb(err);\n}\n```\n\nto 4 lines; not quite as severe as 1 to 4 lines.\n\nWe don\u0027t hard enforce that style yet, but we might at some point.\n\nIn any case, it is just a nit on a style issue. No biggie. Thanks."},{"file":"test/nics.test.js","line":788,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"shoudl that be an *error* it is returning there?"},{"file":"test/nics.test.js","line":806,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"AFAICT this latch doesn\u0027t work properly.\n\n```\nThe VM has two nics: mac1 and mac2.\n\n// starting state\nnicLatches \u003d {}\n\n// pass 1: mac1 running, mac2 stopped\nnicLatches \u003d {\n    mac1: false\n    mac2: true\n}\nbarrier \u003d false\n\n// pass 2: mac1 running, mac2 stopped\nnicLatches \u003d {\n    mac1: false\n    mac2: true\n}\nbarrier \u003d false\n\n// pass 3: mac1 running, mac2 running\nnicLatches \u003d {\n    mac1: false\n    mac2: true\n}\nbarrier \u003d false\n```\n\nHere we are stuck until timeout. If the starting state includes one NIC that\nis already state\u003d\"running\" and stays in that state, then this code will always\nset `barrier\u003dfalse`. Am I missing some detail?"},{"file":"test/nics.test.js","line":806,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"When a NIC is added or removed, all existing NICs on that VM enter a \u0027stopped\u0027 state."},{"file":"test/nics.test.js","line":806,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can you guarantee that by the time this code does the first \"GET /my/machines/UUID/nics\" that all the NICs are still in a \u0027stopped\u0027 state?"},{"file":"test/nics.test.js","line":806,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"No, not in a formal sense. Yes, it\u0027s polling, so it\u0027s subject to assorted problems (e.g. ABA).\n\nIn practice it works. I\u0027m open to better ideas."},{"file":"test/nics.test.js","line":806,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This code just wants to wait for all the nics on the VM to go to \"running\" right? Or is it attempting to ensure a first state of not \"running\" to ensure it cycled. The comment above states it is looking for a restart cycle of the NICs, but the implementation is closer to \"wait for the VM to reboot, then wait for the VM\u0027s NICs to go to running\".\n\nFWIW, node-triton has a rebootInstance that uses MachineAudit to watch for a reboot and has a comment acknowledging that isn\u0027t perfect either: https://github.com/joyent/node-triton/blob/master/lib/tritonapi.js#L2407-L2493\n\nI realize that\u0027d be overkill here. Eventually it would be nice to have the cloudapi test suite use tritonapi.js. I think that could lead to tighter testing code (relying on tritonapi.js to handle the PITA \"wait for this to complete\" logic).\n\nIf you had a brief comment on these functions about their limitations, I\u0027d be cool with them."},{"file":"test/nics.test.js","line":806,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"The code in question is used in two difference contexts. In one of them, it\u0027s right after a VM reboot. In the other, the VM never restarts. In both cases, the NICs bounce; so might as well share that code even if the VM restart case can be simplified a bit.\n\nMachineAudit is sadly only of minor use here, although it\u0027s a valid improvement. Our problem in these tests is less the VM restarting, and more the NICs bouncing.\n\nUnfortunately, ignoring the VM state and just waiting for NICs to bounce got me in trouble (there would sometimes be multiple bounces); admittedly that trouble was because NIC deletion tests weren\u0027t checking for a bounce at the time, but I decided to leave the VM restart check simply for sanity\u0027s sake.\n\nI\u0027m going to remove the VM check again. With the deletion bounce case handled, the VM check can hopefully be elided."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"test/nics.test.js","type":"MODIFIED","insertions":135,"deletions":-47}],"sizeInsertions":135,"sizeDeletions":-47},{"number":"2","revision":"f7a71141968686ab63f4684d58e8cb33b10f4879","parents":["7f06df08c0d15709660528902ca1b1c515344d0e"],"ref":"refs/changes/75/2075/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1497337679,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497337709,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"test/nics.test.js","type":"MODIFIED","insertions":140,"deletions":-46}],"sizeInsertions":140,"sizeDeletions":-46},{"number":"3","revision":"8aed3d6843aaa89b90421fedf3be9c75d9b29e46","parents":["7f06df08c0d15709660528902ca1b1c515344d0e"],"ref":"refs/changes/75/2075/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1497532934,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497532969,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"test/nics.test.js","type":"MODIFIED","insertions":165,"deletions":-46}],"sizeInsertions":165,"sizeDeletions":-46}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}]}