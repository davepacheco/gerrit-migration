{"project":"joyent/node-moray","branch":"master","id":"I0a298e8425c61aba4abaef2ebe6df28f120d2b3e","number":"1425","subject":"MORAY-396 update to cueball v2 MORAY-405 need to delay emitting \u0027close\u0027 until cueball is stopped Reviewed by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/1425","commitMessage":"MORAY-396 update to cueball v2\nMORAY-405 need to delay emitting \u0027close\u0027 until cueball is stopped\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1486152344,"lastUpdated":1488412545,"open":false,"status":"MERGED","comments":[{"timestamp":1486152344,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1486152367,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486691266,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1: Code-Review+1\n\nThe code change is fine, but it sounds like there are some cueball changes and more testing needed before integration?"},{"timestamp":1487885902,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1487885934,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1487886291,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1487886320,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487888319,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(3 comments)\n\nI don\u0027t remember the conclusion of our discussion about the new timeout to know why this is worth doing.  It seems like kind of a band-aid since connections can take more than 5 seconds to be re-established (and have a whole retry policy around dealing with that fact)."},{"timestamp":1488221327,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(1 comment)\n\n\u003e (3 comments)\n \u003e \n \u003e I don\u0027t remember the conclusion of our discussion about the new\n \u003e timeout to know why this is worth doing.  It seems like kind of a\n \u003e band-aid since connections can take more than 5 seconds to be\n \u003e re-established (and have a whole retry policy around dealing with\n \u003e that fact).\n\nThe conclusion I think we reached in that discussion was that if we are going to do this, the real place to do it is the Resolver itself (since it already handles the fiction of failed requests not leading to everything disappearing, and has the state info to tell what\u0027s going on).\n\nWe didn\u0027t really ever finish discussing whether a temporary band-aid in the interim is a good idea or not, though. I\u0027m happy to take that part back out again, since it seems like it\u0027s ill-advised with the command blocking problem. I don\u0027t really want to re-work the entire way connections get managed in here just for a temporary band-aid."},{"timestamp":1488221826,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(1 comment)\n\n\u003e (1 comment)\n \u003e \n \u003e \u003e (3 comments)\n \u003e \u003e\n \u003e \u003e I don\u0027t remember the conclusion of our discussion about the new\n \u003e \u003e timeout to know why this is worth doing.  It seems like kind of a\n \u003e \u003e band-aid since connections can take more than 5 seconds to be\n \u003e \u003e re-established (and have a whole retry policy around dealing with\n \u003e \u003e that fact).\n \u003e \n \u003e The conclusion I think we reached in that discussion was that if we\n \u003e are going to do this, the real place to do it is the Resolver\n \u003e itself (since it already handles the fiction of failed requests not\n \u003e leading to everything disappearing, and has the state info to tell\n \u003e what\u0027s going on).\n \u003e \n \u003e We didn\u0027t really ever finish discussing whether a temporary\n \u003e band-aid in the interim is a good idea or not, though. I\u0027m happy to\n \u003e take that part back out again, since it seems like it\u0027s ill-advised\n \u003e with the command blocking problem. I don\u0027t really want to re-work\n \u003e the entire way connections get managed in here just for a temporary\n \u003e band-aid.\n\nThat sounds good."},{"timestamp":1488222280,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1488399334,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1488399357,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488399397,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1488399430,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488405997,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1488406740,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1488406809,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 6."},{"timestamp":1488406833,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488409548,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1488412119,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 7."},{"timestamp":1488412142,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1488412323,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1488412474,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 8: Commit message was updated."},{"timestamp":1488412545,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"8","revision":"2c2bb0ec6e1a68478dad18a87204ee5c10ec3dcc","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1488412474,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488412142,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488412323,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488412323,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1488412545,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"lib/pool.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":27,"sizeDeletions":-12},"patchSets":[{"number":"1","revision":"89c9b777b5a12a977d746527d73aef64570fae42","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1486152344,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486691266,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486152367,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":16,"sizeDeletions":-9},{"number":"2","revision":"6d545f1a21953501474407498074ca9ceb1291df","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487885902,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1487885934,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pool.js","line":204,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: self"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":53,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":60,"sizeDeletions":-9},{"number":"3","revision":"10d4399a65575505d41c5302812cffece912aca6","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1487886291,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487886320,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pool.js","line":108,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This package uses snake case for fields of classes (e.g., mcp_cueball_resolver)."},{"file":"lib/pool.js","line":198,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t really understand this.  Does cueball not have an error listener for the connection any more?  Doesn\u0027t it need one?"},{"file":"lib/pool.js","line":198,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Part of the API rework in cueball 2.0, the API changed to require you to place an error listener on any connection that has an active lease. For Sets, this means from the moment you get the \u0027added\u0027 event. cueball still has its own internal listener, but if it sees that it\u0027s the only thing on the event, it will throw."},{"file":"lib/pool.js","line":198,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does Fast not have one here?\n\nI guess it feels dubious for the API to require a check if we can reasonably satisfy it with effectively a no-op handler.  Or, it seems surprising that adding a no-op error handler would affect correctness of the program."},{"file":"lib/pool.js","line":198,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"The problem is that the thing we\u0027re giving cueball is the entire FastClient instance, not the socket. The FastClient re-emits \u0027error\u0027 on itself when the socket emits \u0027error\u0027, while also erroring out all the requests.\n\nSo the FastClient has already taken the action we need to take here (making the requests emit error so we drain and get rid of this logical connection). But then the FastClient still insists on emitting \u0027error\u0027 itself anyway."},{"file":"lib/pool.js","line":233,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I assume it\u0027s not possible for us to see this \"key\" again (either via connAdd or connDrain) while the timer is outstanding.  Is that right?\n\nI think it would be cleaner to separate this into a connDrain() and a connDrainFini() (or something) instead of relying on the fact that mcp_lastRemovalTimeout is set as an indicator that this is not the first time through this function for this connection.\n\nShouldn\u0027t we avoid doing this if we\u0027re in the process of closing?  Does this not cause commands to block for 5 seconds after they run?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/pool.js","type":"MODIFIED","insertions":52,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":59,"sizeDeletions":-9},{"number":"4","revision":"1a6b459fd0d38de2357976726aa7d75e1b0f09bd","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1488399334,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488399357,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/pool.js","type":"MODIFIED","insertions":39,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":48,"sizeDeletions":-10},{"number":"5","revision":"43133b3f8154dc649db298f15d5cec3ef793b64c","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1488399397,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488399430,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pool.js","line":42,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think this can go now.  Otherwise, this looks great."},{"file":"lib/pool.js","line":42,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Oh poop. Forgot to delete that. Now I have to re-do the testing again."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/pool.js","type":"MODIFIED","insertions":16,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":25,"sizeDeletions":-10},{"number":"6","revision":"f6c0a63b7b9288e691e56b14fa9c88c8cd9253b6","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1488406809,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488409548,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488406833,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/pool.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":18,"sizeDeletions":-10},{"number":"7","revision":"0a298e8425c61aba4abaef2ebe6df28f120d2b3e","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1488412119,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488412323,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488412323,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488412142,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"lib/pool.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":27,"sizeDeletions":-12},{"number":"8","revision":"2c2bb0ec6e1a68478dad18a87204ee5c10ec3dcc","parents":["df14ef45f8fe2e2881983add71ecb59ed27edf80"],"ref":"refs/changes/25/1425/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1488412474,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488412323,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488412323,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1488412545,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1488412142,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":11,"deletions":-3},{"file":"lib/pool.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":27,"sizeDeletions":-12}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}