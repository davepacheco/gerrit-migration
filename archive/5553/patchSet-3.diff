commit 797c18f8d3b3b285dbd11fbfa1c4e705a0330993 (refs/changes/53/5553/3)
Author: Rui Loura <rui@joyent.com>
Date:   2019-02-11T16:42:02+00:00 (8 months ago)
    
    TRITON-954 sdcadm post-setup common-external-nics should be rack aware

diff --git a/CHANGES.md b/CHANGES.md
index 2d01589..7e19bbd 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.24.5
+
+- TRITON-954 sdcadm post-setup common-external-nics should be rack aware
+
 ## 1.24.4
 
 - TRITON-1178 sdcadm man page build expects node in $PATH
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 085b019..5b88add 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -640,7 +640,6 @@ SdcAdm.prototype.listInsts = function listInsts(opts, cb) {
                     var server = servers[i];
                     ctx.serverFromUuid[server.uuid] = server;
 
-
                     if (!server.sysinfo) {
                         ctx.serverAdminIpFromUuid[server.uuid] = 'unknown';
                         continue;
@@ -4187,8 +4186,6 @@ function checkMissingExternalNics(opts, cb) {
     var doadminui = true;
     var doimgapi = true;
 
-    var netexternal;
-
     function getInstance(svcname, callback) {
         sapi.listServices({ name: svcname }, onServices);
 
@@ -4235,25 +4232,6 @@ function checkMissingExternalNics(opts, cb) {
                 next();
             });
         },
-        // Grab the external network details.
-        function (_, next) {
-            var listOpts = { name: 'external' };
-            napi.listNetworks(listOpts, function (err, nets) {
-                if (err) {
-                    cb(new errors.SDCClientError(err, 'napi'));
-                    return;
-                }
-
-                if (!nets.length) {
-                    cb(new Error(
-                        'Couldn\'t find external network in NAPI'));
-                    return;
-                }
-
-                netexternal = nets[0];
-                next();
-            });
-        },
         // Check what NICS the imgapi and adminui zones currently have. Only do
         // work for those which do not yet have an external nic.
         function (_, next) {
@@ -4276,10 +4254,10 @@ function checkMissingExternalNics(opts, cb) {
                 for (var i = 0, nic; i < nics.length; i++) {
                     nic = nics[i];
                     if (nic.belongs_to_uuid === svcadminui.uuid &&
-                        nic.nic_tag === 'external') {
+                        netconfig.isNicExternal(nic)) {
                         doadminui = false;
                     } else if (nic.belongs_to_uuid === svcimgapi.uuid &&
-                        nic.nic_tag === 'external') {
+                        netconfig.isNicExternal(nic)) {
                         doimgapi = false;
                     }
                 }
@@ -4295,8 +4273,7 @@ function checkMissingExternalNics(opts, cb) {
                 doimgapi: doimgapi,
                 doadminui: doadminui,
                 svcadminui: svcadminui,
-                svcimgapi: svcimgapi,
-                netexternal: netexternal
+                svcimgapi: svcimgapi
             });
         }
     });
@@ -4304,23 +4281,20 @@ function checkMissingExternalNics(opts, cb) {
 
 SdcAdm.prototype.setupCommonExternalNics = function
 setupCommonExternalNics(opts, cb) {
-    var self = this;
     assert.func(opts.progress, 'options.progress');
 
+    var self = this;
+    var doadminui = true;
+    var doimgapi = true;
     var progress = opts.progress;
-
     var svcadminui;
     var svcimgapi;
-    var doadminui = true;
-    var doimgapi = true;
-
-    var netexternal;
 
     function addExternaNicToZone(svcobj, subcb) {
         var addparams = {
             uuid: svcobj.uuid,
             networks: [
-                { 'uuid': netexternal.uuid, primary: true }
+                { 'name': 'external', primary: true }
             ]
         };
         self.vmapi.addNicsAndWait(addparams, function (err, job) {
@@ -4344,7 +4318,6 @@ setupCommonExternalNics(opts, cb) {
                 return;
             }
 
-
             self.sapi.updateService(svcArr[0].uuid, {
                 params: {
                     networks: [
@@ -4373,7 +4346,6 @@ setupCommonExternalNics(opts, cb) {
                 doadminui = res.doadminui;
                 svcadminui = res.svcadminui;
                 svcimgapi = res.svcimgapi;
-                netexternal = res.netexternal;
                 next();
             });
         },
diff --git a/package.json b/package.json
index 31bec76..4d84ff9 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.24.4",
+  "version": "1.24.5",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
