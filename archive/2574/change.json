{"project":"joyent/illumos-joyent","branch":"master","id":"Icc6a60c023d4a0e9e6235976d2601175be4557f0","number":"2574","subject":"OS-6344 elide squeue wake-ups when prudent Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/2574","commitMessage":"OS-6344 elide squeue wake-ups when prudent\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003cryan.zeseski@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1505427860,"lastUpdated":1505943643,"open":false,"status":"MERGED","comments":[{"timestamp":1505427860,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1505428984,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)\n\nThis looks good to me, modulo my one question, which is probably more about my ignorance about all of the possible interaction."},{"timestamp":1505481712,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505482991,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\nThanks for the clarification."},{"timestamp":1505772832,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1505773391,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1505779633,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nTesting notes added to the ticket."},{"timestamp":1505783992,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1505943390,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1505943467,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1505943643,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"3","revision":"cc6a60c023d4a0e9e6235976d2601175be4557f0","parents":["4cfebd603890220f4859425ccd92c691498e462b"],"ref":"refs/changes/74/2574/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505943467,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505482991,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505772832,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505783992,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1505943643,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":122,"deletions":-21},{"file":"usr/src/uts/common/inet/tcp/tcp_socket.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-32},"patchSets":[{"number":"1","revision":"6438ed65d606936c9793e9c6e75b160bdc4a0efd","parents":["83f1905cc24370140e0c51011346814bb5f2a31e"],"ref":"refs/changes/74/2574/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505427860,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505482991,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505783992,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505772832,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/inet/squeue.c","line":1472,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"cstye nit: Shouldn\u0027t we explicitly check against B_TRUE?"},{"file":"usr/src/uts/common/inet/squeue.c","line":1472,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Just to chime in, but from my perspective, one of the key benefits of using a boolean_t is that you don\u0027t need to do that."},{"file":"usr/src/uts/common/inet/squeue.c","line":1505,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This is a question and not a critique. Since we dropped and reacquired the lock, is there any chance that the worker thread has somehow set the SQS_PROC bits while the lock was dropped and now we\u0027re clearing them? I don\u0027t understand the full interaction here. Maybe if nothing else, a comment discussing the interaction might be useful?"},{"file":"usr/src/uts/common/inet/squeue.c","line":1505,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This is an inherent part of the squeue design.  By leaving SQS_PROC set when we exit the mutex above, we exclude all other threads from processing on the squeue. Even if the worker thread were to be woken, it would continue waiting when it saw the flag set."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":122,"deletions":-21},{"file":"usr/src/uts/common/inet/tcp/tcp_socket.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-32},{"number":"2","revision":"971861a3b46fc431df1ef63a69f6bb5a4f297dbd","parents":["4cfebd603890220f4859425ccd92c691498e462b"],"ref":"refs/changes/74/2574/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505943390,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505482991,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505783992,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505772832,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":122,"deletions":-21},{"file":"usr/src/uts/common/inet/tcp/tcp_socket.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-32},{"number":"3","revision":"cc6a60c023d4a0e9e6235976d2601175be4557f0","parents":["4cfebd603890220f4859425ccd92c691498e462b"],"ref":"refs/changes/74/2574/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1505943467,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505482991,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1505783992,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1505943643,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1505772832,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/squeue.c","type":"MODIFIED","insertions":122,"deletions":-21},{"file":"usr/src/uts/common/inet/tcp/tcp_socket.c","type":"MODIFIED","insertions":16,"deletions":-10},{"file":"usr/src/uts/common/sys/squeue.h","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":139,"sizeDeletions":-32}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}