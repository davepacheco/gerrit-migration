{"project":"joyent/sdc-sapi","branch":"master","id":"I66e30b6f0643ef8389e80973cf9c971c669ad523","number":"2896","subject":"SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI Co-authored-by: Trent Mick \u003ctrentm@gmail.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/2896","commitMessage":"SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI\nCo-authored-by: Trent Mick \u003ctrentm@gmail.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1509552654,"lastUpdated":1529678576,"open":false,"status":"MERGED","comments":[{"timestamp":1509552654,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1509552659,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit ba1ab6ac3f5c537e38c7ae2cadd2097444968461\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1509552677,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1509554168,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1509554173,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 76617af0fa3797ff34335029059686268d88a750\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1509554193,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509641772,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Integration-Approval-1\n\nStill making changes"},{"timestamp":1509723213,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1509723220,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 21c2dadb8c192d09a503a73b76e4dd558e340792\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1509723239,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509986645,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: -Integration-Approval"},{"timestamp":1510084612,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1510084617,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 197eb4543f5ee94703acaf56e2f12b3c0afa87dd\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1510084637,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510167025,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(13 comments)\n\nPedro,\n\nThis is a *start* at reviewing this. Sorry I haven\u0027t finished. I\u0027m submitting this now because I\u0027m not sure when I\u0027ll have more time to get back to it given the YVR meetings today and tomorrow.\n\nI haven\u0027t finished reviewing config.js changes and thinking about usbkey_config handling."},{"timestamp":1510590029,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1510590035,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 6900c782ce484d56d1d4e5c9b8190173cec2f268\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1510590055,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510596542,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1510596548,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 9cd27c6936245f46337efa132a725da4ca9849cc\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1510596567,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510596618,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\n(13 comments)\n\nOk, did most of the changes you suggested but the sec-scripts one, which I plan to do once we\u0027re sure about every change we want to make there before I modify that repo. I know you\u0027re not gonna review this today, though :-)"},{"timestamp":1511279856,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1511279861,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit dbe5003491a5010cb30d2793c65e801f0914237c\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1511279882,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1511482374,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7:\n\n(14 comments)"},{"timestamp":1512066238,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 8."},{"timestamp":1512066243,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 749274e243158791dce3c0498fc5fb0dc7f799f1\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1512066263,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512067461,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 8:\n\n(9 comments)\n\nI think I\u0027ve replied to most of your comments and made most of the changes you suggested. Mind to take another look?"},{"timestamp":1515750632,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 9."},{"timestamp":1515750638,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 7c26b39f8dd0f0f01eee54d3a075df1b29f4ab9a\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1515750659,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515759382,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 10: Patch Set 9 was rebased."},{"timestamp":1515759387,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 780d0b8904fbcab6689b8b8c64bfab8fafe36946\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1515759408,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10:\n\n\"make check\" passed ok"},{"timestamp":1515774315,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 11."},{"timestamp":1515774320,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11:\n\nNew commits:\n    \n    commit 80e3d32a9cfd9b41121af2c4ecec52a5bc82f348\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1515774341,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515781361,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 12."},{"timestamp":1515781366,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 12:\n\nNew commits:\n    \n    commit 16e01bcf411d7846e94447ebe022c0b80d343316\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1515781387,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516052239,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 12:\n\n(11 comments)"},{"timestamp":1516216322,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 13."},{"timestamp":1516216327,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13:\n\nNew commits:\n    \n    commit 031d3a8c23c018d1269784d6746645808f1b4688\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1516216349,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516216360,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 12:\n\n(11 comments)\n\nDone with all the suggested changes Trent. Rebuilding now to see if we\u0027re good to IA too"},{"timestamp":1516306152,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 13:\n\n(1 comment)"},{"timestamp":1516306293,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 14."},{"timestamp":1516306298,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 14:\n\nNew commits:\n    \n    commit 46515ca5082131cdd928d14941d0215baad701b8\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1516306322,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516306358,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 14:\n\n(1 comment)\n\nDone with the right flag"},{"timestamp":1516642032,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 13:\n\n(1 comment)\n\nI\u0027m trying out a SAPI-294 branch build in a new COAL now."},{"timestamp":1516666052,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 14: Integration-Approval-1\n\nSo... this doesn\u0027t fix the core issue. With this latest code, a first booting SAPI in non-proto mode depends on there being a working SAPI at \"mdata-get sapi-url\".\n\nHere is how I tested:\n\n- Create a sapi1 zone via \"sdcadm create sapi -s headnode --dev-allow-multiple-instances`. This works fine.\n- Stop sapi0 and wait for it to fall out of DNS (`dig sapi.coal.joyent.us` for my COAL config).\n- Reprovision sapi1 to test \"SAPI first boot in non-proto mode\" via something like: `echo \u0027{\"image_uuid\": \"0806d4fa-fc9b-11e7-a65d-2be26af5a061\"}\u0027 | vmadm reprovision e20ab4de-f9e3-41d1-9712-b22e2fbce79f`\n\nThe result is mdata:execute that is going to take a LONG time to fail:\n\n```\n...\n[2018-01-22T23:50:14Z] /opt/smartdc/boot/lib/util.sh:50: warn(): printf \u0027%s: WARNING: %s\\n\u0027 setup.sh \u0027could not download SAPI metadata (retrying)\u0027\nsetup.sh: WARNING: could not download SAPI metadata (retrying)\n[2018-01-22T23:50:14Z] /opt/smartdc/boot/lib/util.sh:365: download_metadata(): sleep 2\n[2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:366: download_metadata(): continue\n[2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:353: download_metadata(): ((  i++ \u003c 30  ))\n[2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:357: download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.raw\n[2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:358: download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.extracted\n[2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:363: download_metadata(): _sdc_curl -o /var/tmp/metadata.json.raw http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n[2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:102: _sdc_curl(): curl -sSf --connect-timeout 45 --max-time 120 -o /var/tmp/metadata.json.raw http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\ncurl: (28) Connection timed out after 45000 milliseconds\n[2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:364: download_metadata(): warn \u0027could not download SAPI metadata (retrying)\u0027\n[[2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:50: warn(): basename /opt/smartdc/boot/setup.sh\n[2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:50: warn(): printf \u0027%s: WARNING: %s\\n\u0027 setup.sh \u0027could not download SAPI metadata (retrying)\u0027\nsetup.sh: WARNING: could not download SAPI metadata (retrying)\n[2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:365: download_metadata(): sleep 2\n[2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:366: download_metadata(): continue\n[2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:353: download_metadata(): ((  i++ \u003c 30  ))\n[2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:357: download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.raw\n[2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:358: download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.extracted\n[2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:363: download_metadata(): _sdc_curl -o /var/tmp/metadata.json.raw http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n[2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:102: _sdc_curl(): curl -sSf --connect-timeout 45 --max-time 120 -o /var/tmp/metadata.json.raw http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n[ Jan 22 23:51:18 Method or service exit timed out.  Killing contract 1625. ]\n[ Jan 22 23:51:18 Method \"start\" failed due to signal KILL. ]\n```\n\nThe failure is in sdc-scripts/lib/util.sh sdc_common_setup calling `download_metadata`. That \"download_metadata\" expects a working SAPI at the given sapi-url.\n\nA fix here would be to have an update to sdc_common_setup to not call \"download_metadata\" for the sapi zone. I haven\u0027t tested that.\n\nAside: It would be good to start a separate ticket to eventually drop \"download_metadata\" altogether. This is a silly crutch of \"sdc_common_setup\". It downloads the SAPI config for this zone to /var/tmp/metadata.json and exports the \"METADATA\" var with the path to that file.  The only current core Triton zones that use that file (that I see) are:\n\n```\n    moray/boot/setup.sh\n        local shard_name\u003d$(json -f ${METADATA} manatee_shard)\n            local shard\u003d$(json -f ${METADATA} ${SHARD_KEY})\n    sdc-papi/boot/setup.sh:UFDS_ADMIN_UUID\u003d$(json -f ${METADATA} ufds_admin_uuid)\n    sdc-papi/boot/setup.sh:PACKAGES\u003d($(json -f ${METADATA} packages))\n    sdc-ufds/boot/setup.sh:UFDS_LDAP_ROOT_DN\u003d$(json -f ${METADATA} ufds_ldap_root_dn)\n    sdc-ufds/boot/setup.sh:UFDS_LDAP_ROOT_PW\u003d$(json -f ${METADATA} ufds_ldap_root_pw)\n    sdc-manatee/boot/setup.sh:    ZONE_UUID\u003d$(json -f /var/tmp/metadata.json ZONE_UUID)\n    sdc-manatee/boot/setup.sh:    BINDER_ADMIN_IPS\u003d$(json -f /var/tmp/metadata.json binder_admin_ips)\n```\n\nI think that separate ticket could look at removing the need for those. I think we should move our services away, if possible, from needing SAPI up to do their initial boot. Obviously that would be case-by-case analysis for each repo in separate tickets, though."},{"timestamp":1516691813,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 15."},{"timestamp":1516691819,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 15:\n\nNew commits:\n    \n    commit 37399ccd54fdb240fb71f02c0af00577c555c74a\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1516691841,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516691966,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 15:\n\n\u003e So... this doesn\u0027t fix the core issue. With this latest code, a\n \u003e first booting SAPI in non-proto mode depends on there being a\n \u003e working SAPI at \"mdata-get sapi-url\".\n \u003e \n \u003e Here is how I tested:\n \u003e \n \u003e - Create a sapi1 zone via \"sdcadm create sapi -s headnode\n \u003e --dev-allow-multiple-instances`. This works fine.\n \u003e - Stop sapi0 and wait for it to fall out of DNS (`dig\n \u003e sapi.coal.joyent.us` for my COAL config).\n \u003e - Reprovision sapi1 to test \"SAPI first boot in non-proto mode\" via\n \u003e something like: `echo \u0027{\"image_uuid\": \"0806d4fa-fc9b-11e7-a65d-2be26af5a061\"}\u0027\n \u003e | vmadm reprovision e20ab4de-f9e3-41d1-9712-b22e2fbce79f`\n \u003e \n \u003e The result is mdata:execute that is going to take a LONG time to\n \u003e fail:\n \u003e \n \u003e ```\n \u003e ...\n \u003e [2018-01-22T23:50:14Z] /opt/smartdc/boot/lib/util.sh:50: warn():\n \u003e printf \u0027%s: WARNING: %s\\n\u0027 setup.sh \u0027could not download SAPI\n \u003e metadata (retrying)\u0027\n \u003e setup.sh: WARNING: could not download SAPI metadata (retrying)\n \u003e [2018-01-22T23:50:14Z] /opt/smartdc/boot/lib/util.sh:365:\n \u003e download_metadata(): sleep 2\n \u003e [2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:366:\n \u003e download_metadata(): continue\n \u003e [2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:353:\n \u003e download_metadata(): ((  i++ \u003c 30  ))\n \u003e [2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:357:\n \u003e download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.raw\n \u003e [2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:358:\n \u003e download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.extracted\n \u003e [2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:363:\n \u003e download_metadata(): _sdc_curl -o /var/tmp/metadata.json.raw\n \u003e http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n \u003e [2018-01-22T23:50:16Z] /opt/smartdc/boot/lib/util.sh:102:\n \u003e _sdc_curl(): curl -sSf --connect-timeout 45 --max-time 120 -o\n \u003e /var/tmp/metadata.json.raw http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n \u003e curl: (28) Connection timed out after 45000 milliseconds\n \u003e [2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:364:\n \u003e download_metadata(): warn \u0027could not download SAPI metadata\n \u003e (retrying)\u0027\n \u003e [[2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:50: warn():\n \u003e basename /opt/smartdc/boot/setup.sh\n \u003e [2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:50: warn():\n \u003e printf \u0027%s: WARNING: %s\\n\u0027 setup.sh \u0027could not download SAPI\n \u003e metadata (retrying)\u0027\n \u003e setup.sh: WARNING: could not download SAPI metadata (retrying)\n \u003e [2018-01-22T23:51:01Z] /opt/smartdc/boot/lib/util.sh:365:\n \u003e download_metadata(): sleep 2\n \u003e [2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:366:\n \u003e download_metadata(): continue\n \u003e [2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:353:\n \u003e download_metadata(): ((  i++ \u003c 30  ))\n \u003e [2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:357:\n \u003e download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.raw\n \u003e [2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:358:\n \u003e download_metadata(): /usr/bin/rm -f /var/tmp/metadata.json.extracted\n \u003e [2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:363:\n \u003e download_metadata(): _sdc_curl -o /var/tmp/metadata.json.raw\n \u003e http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n \u003e [2018-01-22T23:51:03Z] /opt/smartdc/boot/lib/util.sh:102:\n \u003e _sdc_curl(): curl -sSf --connect-timeout 45 --max-time 120 -o\n \u003e /var/tmp/metadata.json.raw http://10.99.99.31/configs/e20ab4de-f9e3-41d1-9712-b22e2fbce79f\n \u003e [ Jan 22 23:51:18 Method or service exit timed out.  Killing\n \u003e contract 1625. ]\n \u003e [ Jan 22 23:51:18 Method \"start\" failed due to signal KILL. ]\n \u003e ```\n \u003e \n \u003e The failure is in sdc-scripts/lib/util.sh sdc_common_setup calling\n \u003e `download_metadata`. That \"download_metadata\" expects a working\n \u003e SAPI at the given sapi-url.\n \u003e \n \u003e A fix here would be to have an update to sdc_common_setup to not\n \u003e call \"download_metadata\" for the sapi zone. I haven\u0027t tested that.\n \u003e \n \u003e Aside: It would be good to start a separate ticket to eventually\n \u003e drop \"download_metadata\" altogether. This is a silly crutch of\n \u003e \"sdc_common_setup\". It downloads the SAPI config for this zone to\n \u003e /var/tmp/metadata.json and exports the \"METADATA\" var with the path\n \u003e to that file.  The only current core Triton zones that use that\n \u003e file (that I see) are:\n \u003e \n \u003e ```\n \u003e moray/boot/setup.sh\n \u003e local shard_name\u003d$(json -f ${METADATA} manatee_shard)\n \u003e local shard\u003d$(json -f ${METADATA} ${SHARD_KEY})\n \u003e sdc-papi/boot/setup.sh:UFDS_ADMIN_UUID\u003d$(json -f ${METADATA}\n \u003e ufds_admin_uuid)\n \u003e sdc-papi/boot/setup.sh:PACKAGES\u003d($(json -f ${METADATA} packages))\n \u003e sdc-ufds/boot/setup.sh:UFDS_LDAP_ROOT_DN\u003d$(json -f ${METADATA}\n \u003e ufds_ldap_root_dn)\n \u003e sdc-ufds/boot/setup.sh:UFDS_LDAP_ROOT_PW\u003d$(json -f ${METADATA}\n \u003e ufds_ldap_root_pw)\n \u003e sdc-manatee/boot/setup.sh:    ZONE_UUID\u003d$(json -f /var/tmp/metadata.json\n \u003e ZONE_UUID)\n \u003e sdc-manatee/boot/setup.sh:    BINDER_ADMIN_IPS\u003d$(json -f\n \u003e /var/tmp/metadata.json binder_admin_ips)\n \u003e ```\n \u003e \n \u003e I think that separate ticket could look at removing the need for\n \u003e those. I think we should move our services away, if possible, from\n \u003e needing SAPI up to do their initial boot. Obviously that would be\n \u003e case-by-case analysis for each repo in separate tickets, though.\n\nApologies, it looks like I removed the bits where its setting local admin ip addresses as the source of SAPI service when I moved the sdc_common function to sdc-sdcripts. Fixed.\n\nCompletely agree with moving the services away from SAPI. Didn\u0027t we pass initial metadata into VMs when we create them? Couldn\u0027t we just add everything needed there and forget about the need to talk to SAPI? Anyway, worth checking individually, as you\u0027ve said."},{"timestamp":1516723043,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 15:\n\nJust finished checking it also works fine for the case you mentioned:\n\n[root@headnode (coal) ~]# IMG\u003d01fc9a8c-000f-11e8-99b8-a366ccb73d39\n\n[root@headnode (coal) ~]# sdcadm up sapi@$IMG --yes -C experimental\nUsing channel experimental\n\nThis update will make the following changes:\n    download 1 image (46 MiB):\n        image 01fc9a8c-000f-11e8-99b8-a366ccb73d39\n            (sapi@SAPI-294-20180123T072322Z-g37399cc)\n    update \"sapi\" service to image 01fc9a8c-000f-11e8-99b8-a366ccb73d39\n        (sapi@SAPI-294-20180123T072322Z-g37399cc):\n        instance \"4d91e3a2-bf29-4040-a09f-fd816851a416\" (sapi0) on server 564dd420-e741-202f-4348-7ea8a0947d3d\n\nCreate work dir: /var/sdcadm/updates/20180123T104902Z\nDownloading image 01fc9a8c-000f-11e8-99b8-a366ccb73d39\n    (sapi@SAPI-294-20180123T072322Z-g37399cc)\nImported image 01fc9a8c-000f-11e8-99b8-a366ccb73d39\n    (sapi@SAPI-294-20180123T072322Z-g37399cc)\nVerifying SAPI full mode\nUpdating image for SAPI service \"sapi\"\n    service uuid: b3cb695f-d825-4d84-b9ab-9f0a2f857e25\nUpdating \u0027sapi-url\u0027 in SAPI\nInstalling image 01fc9a8c-000f-11e8-99b8-a366ccb73d39\n    (sapi@SAPI-294-20180123T072322Z-g37399cc)\nReprovisioning VM 4d91e3a2-bf29-4040-a09f-fd816851a416 on server 564dd420-e741-202f-4348-7ea8a0947d3d\nWaiting for sapi instance 4d91e3a2-bf29-4040-a09f-fd816851a416 to come up\nUpdate VM metadata 4d91e3a2-bf29-4040-a09f-fd816851a416\nUpdated successfully (elapsed 195s).\n\n[root@headnode (coal) ~]# sdcadm create sapi -s `sysinfo|json UUID` --yes --dev-allow-multiple-instances\nUsing channel dev\n\nThis command will make the following changes:\n    create \"sapi\" service instance\n        using image 01fc9a8c-000f-11e8-99b8-a366ccb73d39 (sapi@SAPI-294-20180123T072322Z-g37399cc)\n        on server 564dd420-e741-202f-4348-7ea8a0947d3d\n\nCreate work dir: /var/sdcadm/updates/20180123T111506Z\nGetting SDC\u0027s sapi instances from SAPI\nUpdating image for SAPI service \"sapi\"\n    service uuid: b3cb695f-d825-4d84-b9ab-9f0a2f857e25\nInstalling image 01fc9a8c-000f-11e8-99b8-a366ccb73d39\n    (sapi@SAPI-294-20180123T072322Z-g37399cc)\nCreating \"sapi1\" instance\nInstance \"e2a29da9-1feb-422c-8856-a96a678d990f\" (sapi1) created\nWaiting for sapi instance e2a29da9-1feb-422c-8856-a96a678d990f to come up\nCreated successfully (elapsed 39s).\n\n[root@headnode (coal) ~]# vmadm stop 4d91e3a2-bf29-4040-a09f-fd816851a416\nSuccessfully completed stop for VM 4d91e3a2-bf29-4040-a09f-fd816851a416\n\n[root@headnode (coal) ~]# vmadm list\nUUID                                  TYPE  RAM      STATE             ALIAS\nd7b97d3c-cf9e-4c81-8e87-c72dd54e4abe  OS    128      running           assets0\n34ec628f-3244-4159-9d22-aac61f78023e  OS    256      running           napi0\n4d91e3a2-bf29-4040-a09f-fd816851a416  OS    512      stopped           sapi0\n8ef07a98-493e-4aa8-895e-de3723360c12  OS    512      running           dhcpd0\ne2a29da9-1feb-422c-8856-a96a678d990f  OS    512      running           sapi1\n329da82a-5c2f-468c-ba39-2d3a53539646  OS    768      running           imgapi0\n2d8a7a8f-e196-40f3-bf83-d8a936f9c417  OS    1024     running           fwapi0\n4ad312c4-1fe5-473c-a4bf-011a38182f03  OS    1024     running           amon0\n67a4eaf8-1bd1-4eda-9af3-50dd41905ade  OS    1024     running           amonredis0\n9910e6fe-c756-4cc0-ab6d-f20f45e041aa  OS    1024     running           binder0\nab1e0983-ae0e-4a2c-b98c-00ac77f37677  OS    1024     running           sdc0\nbec189a9-a5d4-4a5d-955b-8659da14ca8c  OS    1024     running           papi0\nc60f8fb7-f591-47bb-aa75-d8c565c03dbb  OS    1024     running           mahi0\ncb9b7d8d-e05e-41e9-87ab-531f121ec72a  OS    1024     running           cnapi0\ndf19a640-7991-4ff0-aa81-c946504d2c49  OS    1024     running           vmapi0\n1793dfd6-19d1-403b-998e-25f40166342a  OS    2048     running           manatee0\n4ce2e08e-1b13-45e9-80fd-fda50d8238e6  OS    2048     running           adminui0\n666f5df1-d8ab-453c-a6a3-b3bd6f0258fd  OS    2048     running           rabbitmq0\ndee836f1-d605-477f-92dd-b0b8dbc99494  OS    4096     running           ca0\n470e5e47-23ce-48ce-8dab-6ab96371d65d  OS    8192     running           workflow0\nf289a0dc-fffc-4814-b5f1-a6d7acac2665  OS    8192     running           ufds0\nf462f377-0472-4e21-a567-099591dc22d0  OS    8192     running           moray0\n[root@headnode (coal) ~]# sleep 60\n[root@headnode (coal) ~]# dig sapi.coal.joyent.us\n\n; \u003c\u003c\u003e\u003e DiG 9.10.1-P1 \u003c\u003c\u003e\u003e sapi.coal.joyent.us\n;; global options: +cmd\n;; Got answer:\n;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 4626\n;; flags: qr rd ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n;; WARNING: recursion requested but not available\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1470\n;; QUESTION SECTION:\n;sapi.coal.joyent.us.           IN      A\n\n;; ANSWER SECTION:\nsapi.coal.joyent.us.    60      IN      A       10.99.99.38\n\n;; Query time: 1 msec\n;; SERVER: 10.99.99.11#53(10.99.99.11)\n;; WHEN: Tue Jan 23 11:29:03 UTC 2018\n;; MSG SIZE  rcvd: 64\n\n[root@headnode (coal) ~]# echo \u0027{\"image_uuid\": \"01fc9a8c-000f-11e8-99b8-a366ccb73d39\"}\u0027 | vmadm reprovision e2a29da9-1feb-422c-8856-a96a678d990f\nSuccessfully reprovisioned VM e2a29da9-1feb-422c-8856-a96a678d990f\n\nApologies again for haven\u0027t noticing that line deletion when moving that fragment to the other repo."},{"timestamp":1516993366,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 16."},{"timestamp":1516993371,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 16:\n\nNew commits:\n    \n    commit 2c294a849159902a48a8f46d1cbd3440581bb349\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1516993405,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1516995319,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 15:\n\n(1 comment)"},{"timestamp":1517254152,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 17."},{"timestamp":1517254156,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 17:\n\nNew commits:\n    \n    commit 3cc1555dfdf90fa7de90ecd0cc23ed796031cbcf\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1517254181,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517307857,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 17:\n\n(4 comments)\n\nTrent: the changes you suggested + I\u0027ve brought back the change in SAPI attributes.js in order to allow dns_domain metadata value to made it from the Service to the new instances. Explanation at the file."},{"timestamp":1517339546,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 17: -Integration-Approval\n\n(1 comment)"},{"timestamp":1517339653,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 17:\n\n(1 comment)"},{"timestamp":1517429676,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 18."},{"timestamp":1517429681,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\nNew commits:\n    \n    commit 8c63231a0d842af8841bac384dd1257d00e1c65e\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1517429712,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517499486,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\nTrent: I\u0027ve tried both approaches now. Option #2 belongs to patch set #18 here and it\u0027s image 8819ec24-06c1-11e8-9f63-0f9ee081c617 on the experimental channel. It\u0027s also pushed to the SAPI-294 branch of the GH repo.\n\nFor option #3 I\u0027ve pushed to branch SAPI-294-TRITON-92 of GH and built another image: 48ae1ed2-0736-11e8-82bc-1f264cbf0114.\n\nI\u0027ve tested everything now, but building and booting new Headnodes with these images, which is what I\u0027m working into right now.\n\nRegarding what option to pick (and also regarding TRITON-92) my 5cents would be to go for the `metadata.pass_vmapi_metadata_keys` option, specially if we consider that our new view for the whole Triton DataCenter thing is nevermore a single \"irremovable\" headnode but instead, a collection of headnodes where new instances of core services can be created when needed.\n\nHonestly, I don\u0027t think we\u0027re gonna change \"dns_domain\" too much for these setups. But considering \"assets-ip\" and \"sapi-url\" changes we\u0027ve experienced in east-3b, for example, I can see that not adding any of these properties to service metadata neither service params would make our life much easier if we need to update those properties to something new: we just need to update sdc application metadata on that case and move ahead.\n\nI\u0027d say we could just add these values to service metadata only for those services which may require a different value (sapi, binder) and, for everything else, rely into sdc application metadata. I just need to confirm that reprovisioning of existing instances will get updated metadata when sdc application metadata changes but, other than that, looks like a smarter approach than having to go through all the services updating the same value n times. Thoughts?"},{"timestamp":1517502305,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 19."},{"timestamp":1517502309,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 19:\n\nNew commits:\n    \n    commit 5c458fe9100e14d11a1654b214bb946c491d0766\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1517502336,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517502395,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\nForget the images below. I\u0027ve fixed and issue of those booting in proto mode (patch set #19) \n\n\u003e Trent: I\u0027ve tried both approaches now. Option #2 belongs to patch\n \u003e set #18 here and it\u0027s image 8819ec24-06c1-11e8-9f63-0f9ee081c617 on\n \u003e the experimental channel. It\u0027s also pushed to the SAPI-294 branch\n \u003e of the GH repo.\n \u003e \n \u003e For option #3 I\u0027ve pushed to branch SAPI-294-TRITON-92 of GH and\n \u003e built another image: 48ae1ed2-0736-11e8-82bc-1f264cbf0114.\n \u003e \n \u003e I\u0027ve tested everything now, but building and booting new Headnodes\n \u003e with these images, which is what I\u0027m working into right now.\n \u003e"},{"timestamp":1517504823,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\nBtw, note that these approaches has the drawback that if we do not reprovision the first sapi instance, we\u0027ll never get `metadata.pass_vmapi_metadata_keys` or `params.dns_domain` set for new setups, since the first boot of sapi0 will happen in `PROTO_MODE` and, therefore, no updates to the service will take place. Once we decide which option we prefer, we should update sdc-headnode and modify the changes made for HEAD-2387 and HEAD-2378, replacing them with the option we finally pick here.\n\nIn the meanwhile, in order to test stuff in a new setup, we need to reprovision sapi0 at least once for everything else to work."},{"timestamp":1517505499,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\n\u003e Btw, note that these approaches has the drawback that if we do not\n \u003e reprovision the first sapi instance, we\u0027ll never get\n \u003e `metadata.pass_vmapi_metadata_keys` or `params.dns_domain` set for\n \u003e new setups, since the first boot of sapi0 will happen in\n \u003e `PROTO_MODE` and, therefore, no updates to the service will take\n \u003e place. Once we decide which option we prefer, we should update\n \u003e sdc-headnode and modify the changes made for HEAD-2387 and\n \u003e HEAD-2378, replacing them with the option we finally pick here.\n \u003e \n \u003e In the meanwhile, in order to test stuff in a new setup, we need to\n \u003e reprovision sapi0 at least once for everything else to work.\n\nOf course, using sdcadm from TOOLS-1896 CR"},{"timestamp":1528475859,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 20."},{"timestamp":1528475865,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 20:\n\nNew commits:\n    \n    commit b9b3654ea2af8b0005c602b129313853d47d8458\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1528482026,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528804476,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 21."},{"timestamp":1528804481,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 21:\n\nNew commits:\n    \n    commit e78c4456476ee5ae58252466c70220781120aa6a\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1528804505,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 21: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528820196,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 22."},{"timestamp":1528820202,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 22:\n\nNew commits:\n    \n    commit d67cb7519aaad087083aad8968f7ad5918f058ed\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1528820225,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 22: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1528821602,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 20:\n\nBefore I forget, this is the latest working image, including all the config updates due to the Artedi metrics addition: 978ec84c-6e5d-11e8-b718-0b421093ca47"},{"timestamp":1528995216,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 23: Patch Set 22 was rebased."},{"timestamp":1528995221,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 23:\n\nNew commits:\n    \n    commit f488441e2286e18ecc81c615bb5baee612d9c794\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1528995245,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 23:\n\n\"make check\" passed ok"},{"timestamp":1529578660,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 24."},{"timestamp":1529578665,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 24:\n\nNew commits:\n    \n    commit 003e4aa03cd2ca74432f86e8d3d81c00cda0cf3d\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529578691,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 24: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529579302,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 25."},{"timestamp":1529579307,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 25:\n\nNew commits:\n    \n    commit faabdd3f484bd80da424480efe7a8f9baa97f609\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529579328,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 25: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1529579919,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 26."},{"timestamp":1529579924,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 26:\n\nNew commits:\n    \n    commit 649fbb5cc581780df5d50e53cc1fd1e71c56fbd2\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529579947,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 26: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529579964,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 25:\n\n(3 comments)\n\nTrent: Going through the XXX. I\u0027m gonna figure that stuff out and give it a try with a new image built w/o any of these things to see what happens."},{"timestamp":1529580276,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 27."},{"timestamp":1529580281,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 27:\n\nNew commits:\n    \n    commit cd8ab3091cefd8966971313d6fd97d93ec1b15b9\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529580304,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 27: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529591568,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 28."},{"timestamp":1529591573,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 28:\n\nNew commits:\n    \n    commit 3196742dc137a390eaaebd553233dc1c0af4d457\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529591597,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 28: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529591697,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 29."},{"timestamp":1529591702,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 29:\n\nNew commits:\n    \n    commit 2660ff1a5dded83093df32ae3d1d67f62ec8be3f\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529591726,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 29: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529616922,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 30."},{"timestamp":1529616923,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 30:\n\nNew commits:\n    \n    commit 09cff6883a28ca4d7abc03f745cfb5cae28672e1\n    \n    fix test suite; add simple CLI for lib/config.js to facilitate the test suite cleanup script"},{"timestamp":1529616955,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 30: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529617072,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 31: Patch Set 30 was rebased."},{"timestamp":1529617074,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 31:\n\nNew commits:\n    \n    commit fd9eb968a6697915f0e12805e877da088293b478\n    \n    fix test suite; add simple CLI for lib/config.js to facilitate the test suite cleanup script\n    \n    commit 2660ff1a5dded83093df32ae3d1d67f62ec8be3f\n    \n    SAPI-294 SAPI first boot (in non-proto mode) depends on SAPI"},{"timestamp":1529621435,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 32."},{"timestamp":1529621436,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 32:\n\nNew commits:\n    \n    commit 010ef837a980775b2b797bd653d039d7b4f9dfb6\n    \n    update copyright dates"},{"timestamp":1529621463,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 32: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529621646,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 33."},{"timestamp":1529621647,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 33:\n\nNew commits:\n    \n    commit 53a12ab726c2845961d3676fac014940a7a01a9a\n    \n    bump ver and start a changelog for SAPI"},{"timestamp":1529621674,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 33: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529621729,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 33: Code-Review+1 Integration-Approval+1\n\nPedro,\nI\u0027ve added some minor tweaks to the SAPI-294 branch. There is a try-branch build available. The latest changes are in this CR as well. Please review those and then I\u0027m good integrating this."},{"timestamp":1529678564,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 34: Commit message was updated."},{"timestamp":1529678576,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"34","revision":"a4209a1eabb9d8db2170617195a08516bba845f5","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/34","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529678564,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529621674,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529621729,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529621729,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1529678576,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":371,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":18,"deletions":-12},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"test/helper.js","type":"MODIFIED","insertions":48,"deletions":-44},{"file":"tools/cleanup-test-resources.js","type":"MODIFIED","insertions":21,"deletions":-12}],"sizeInsertions":682,"sizeDeletions":-221},"patchSets":[{"number":"1","revision":"4c2ef5f4f9fefcea7de08b77394dcbd159650612","parents":["c0039918888e9e2d0f8edd284c52b3ffaabbef5b"],"ref":"refs/changes/96/2896/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1509552654,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1509552677,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/config.js","line":83,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer res hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":33,"deletions":-66},{"file":"lib/config.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":19,"deletions":-28},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":331,"sizeDeletions":-128},{"number":"2","revision":"42909dbf27b16458992c81dc989fedfc2f50f227","parents":["c0039918888e9e2d0f8edd284c52b3ffaabbef5b"],"ref":"refs/changes/96/2896/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1509554168,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509554193,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1509641772,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":33,"deletions":-66},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":19,"deletions":-28},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":333,"sizeDeletions":-128},{"number":"3","revision":"1c8ba76e3a90b855de20d032fae2d98f2e52df45","parents":["c0039918888e9e2d0f8edd284c52b3ffaabbef5b"],"ref":"refs/changes/96/2896/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1509723213,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509723239,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/configure.sh","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":18,"deletions":-66},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":19,"deletions":-28},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":339,"sizeDeletions":-129},{"number":"4","revision":"f6954eca501e9684187560805a49c71cc07d4a54","parents":["c0039918888e9e2d0f8edd284c52b3ffaabbef5b"],"ref":"refs/changes/96/2896/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1510084612,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510084637,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":102,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"perhaps change these lines to just copy the full lib/ dir?\n\"tools/rsync-to\" already does that."},{"file":"Makefile","line":102,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027d say go for it. It\u0027ll avoid us to have to change makefile in the future if we add any other file."},{"file":"boot/configure.sh","line":22,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why are we doing things in configure.sh rather than setup.sh?  I might be misunderstanding. Could we not enable config-agent and registrar while still in proto mode?"},{"file":"boot/configure.sh","line":22,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"We need to enable them once sapi service is up and running, despite of the mode. The problem so far is that SAPI service is imported as part of configure script, instead of setup one. And this is completely different than for our other services so I\u0027d say the issue here would be to also move the manifest update/import into setup. Sounds right?"},{"file":"boot/configure.sh","line":26,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Not sure `role` is used. Could drop that."},{"file":"boot/configure.sh","line":26,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"As soon as I remove this stuff from configure.sh and move into setup.sh this will be history"},{"file":"boot/configure.sh","line":29,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, sdc-sapi/boot/setup.sh uses *spaces* for indentation."},{"file":"boot/configure.sh","line":29,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, sorry, my default configuration for the other bash scripts across Joyent projects. I\u0027ll change."},{"file":"boot/setup.sh","line":29,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this necessary? It would be great if config-agent created this."},{"file":"boot/setup.sh","line":29,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I really don\u0027t know. I assume it\u0027s not needed; can test it, though."},{"file":"boot/setup.sh","line":36,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why duplicating (parts of) sdc_common_setup instead of updating it in sdc-scripts and using the new sdc-scripts?  I\u0027d really like to avoid coupling between the two. I.e. SAPI\u0027s boot script using \"_foo\" functions from sdc-scripts isn\u0027t great."},{"file":"boot/setup.sh","line":36,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Because I want to make all the changes into a single repo then, once we\u0027re good with how things are working I\u0027ll move the changes into sdc-scripts and update here accordingly. It\u0027s just faster while making changes."},{"file":"lib/config.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\" (c) \""},{"file":"lib/config.js","line":8,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":33,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The app level (i.e. in server.js) should create the logger (possibly using a lib/logger.js or whatever) and pass that in to `loadConfig`."},{"file":"lib/config.js","line":33,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok, let\u0027s go for it"},{"file":"lib/config.js","line":50,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Use the exit status of 1, isntead of grepping stderr. From `man mdata-get`:\n\n```\n       1\n            Metadata value not found.\n\n            The requested keyname was not found in the metadata.\n```"},{"file":"lib/config.js","line":50,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call!"},{"file":"lib/config.js","line":59,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps error out if it is a different value."},{"file":"lib/config.js","line":59,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sounds good."},{"file":"lib/server/sapi.js","line":116,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d prefer this handler is only on endpoints that support using include_master rather than splatted on all endpoints.\n\nAside: It is weird that, for example, ListInstances supports include_master\u003dtrue, but it looks like GetInstance does not?"},{"file":"lib/server/sapi.js","line":116,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I really dunno a lot about it\u0027s potential usage but, yeah, looks like it\u0027s supported only by \"list\" end-points"},{"file":"lib/server/sapi.js","line":119,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"use a 503 ServiceUnavailable I think."},{"file":"lib/server/sapi.js","line":119,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok"},{"file":"package.json","line":21,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"cmd/mdata-update.js still uses optimist, right?"},{"file":"package.json","line":21,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call, thanks!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/configure.sh","type":"MODIFIED","insertions":21,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":18,"deletions":-66},{"file":"lib/config.js","type":"ADDED","insertions":262,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":12,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":19,"deletions":-28},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":342,"sizeDeletions":-129},{"number":"5","revision":"824fbb6c515b8824dd37b93097a9ddd5797a5a63","parents":["5e4ea9d6f5896af89553ca058f95e3e6bc3111b1"],"ref":"refs/changes/96/2896/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1510590029,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510590055,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":35,"deletions":-63},{"file":"lib/config.js","type":"ADDED","insertions":271,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":22,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":402,"sizeDeletions":-157},{"number":"6","revision":"37e25b1535f8fa4e0459da07726547bd5f7a42f7","parents":["5e4ea9d6f5896af89553ca058f95e3e6bc3111b1"],"ref":"refs/changes/96/2896/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1510596542,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510596567,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":35,"deletions":-63},{"file":"lib/config.js","type":"ADDED","insertions":271,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":22,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":402,"sizeDeletions":-157},{"number":"7","revision":"40d5d7839df709a9bece0d242c65d1fddff6f30c","parents":["ccab35148089aab19d5191dae183cffbb898bc1f"],"ref":"refs/changes/96/2896/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1511279856,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510596567,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":34,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We aren\u0027t going to integrate this using internal sdc-scripts functions, right?"},{"file":"boot/setup.sh","line":34,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No, no. Indeed my plan is to put all these changes back into sdc-scripts once we\u0027re good to go with this stuff"},{"file":"boot/setup.sh","line":71,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"indent more"},{"file":"boot/setup.sh","line":76,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Likewise on using internal sdc-scripts methods: we aren\u0027t going to integrate this patch in this state, right?"},{"file":"boot/setup.sh","line":76,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No, no, same answer. This will go sdc-scripts once we\u0027re good with it"},{"file":"lib/config.js","line":12,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This should be replace with a theory statement summarizing how config works for SAPI: not sync dependent on config-agent, various bits retrieved from mdata, \"moray master\" info from a separate config file."},{"file":"lib/config.js","line":12,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":68,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"protoMode perhaps? I.e. thisStyle instead of this_style for vars? I know that we have this_style for config file fields. I wish we didn\u0027t. Obviously this is a style nit, so you can ignore. :)"},{"file":"lib/config.js","line":68,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":76,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think we should look for `mdata-get dns_domain` first. If that is set, then use that. If not, only then do we even look for `mdata-get usbkey_config`. If neither is there, then error out.\n\nThis means when, in the future, sapi insts have customer_metadata.dns_domain set (the ticket talks about updating headnode.sh to do that), this code won\u0027t bother loading usbkey_config."},{"file":"lib/config.js","line":76,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":98,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should only bother gathering these if in protoMode."},{"file":"lib/config.js","line":98,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":158,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This was already done above in getUsbkeyConfig"},{"file":"lib/config.js","line":158,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":189,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"style nit: missingIps"},{"file":"lib/config.js","line":189,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":248,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"log.info or log.debug here for the attempt to load this file would be good."},{"file":"lib/config.js","line":250,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"style nit: masterCfg or similar"},{"file":"lib/config.js","line":250,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":265,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"All this should be in separate funcs in the vasync.pipeline above."},{"file":"lib/server/endpoints/instances.js","line":137,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is repeated in the four endpoints that support include_master. I think it would be better to create a separate restify handler called, say, `ensureMasterConfigLoaded`. Put that in lib/server/endpoints/common.js or something, then add it to the handler chain the attachTo function in each of these four lib/server/endpoints/*.js files.\n\nAlso the logic here is wrong. The current behaviour is that one *can* call ListInstances?include_master\u003dtrue on a SAPI that just doesn\u0027t have `MASTER_MORAY_*` configured. E.g. in nightly-1 right now:\n\n```\n[root@headnode (nightly-1) ~]# sdc-sapi /instances?include_master\u003dtrue | head -10\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 15130\nDate: Fri, 24 Nov 2017 00:05:35 GMT\nConnection: keep-alive\n\n[\n  {\n    \"uuid\": \"098e44d4-8a18-49bf-8758-86583704d54d\",\n    \"service_uuid\": \"1dcc7c65-9464-41b6-9e20-6e0ef52f4697\",\n```\n\nI think you want to change a few things:\n\n1. lib/config.js should set some marker for whether a sapi-master.config.json has yet been loaded. For example, this could be whether `config.moray.master_host` is set at all. If a value was provided in sapi-master.config.json for it, then set it to that value, if not, then set it to `null`.\n\n\n2. Have this `ensureMasterConfigLoaded` error out only if that marker isn\u0027t on `config...`.\n\n3. Change the error message to mention \"... but this SAPI instance has not yet loaded SAPI master config details\" or similar."},{"file":"lib/server/endpoints/instances.js","line":141,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You\u0027ve incorrectly changed the meaning. This opts.include_master\u003dtrue should be in the `if-block`, not the else-part."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":35,"deletions":-63},{"file":"lib/config.js","type":"ADDED","insertions":271,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":9,"deletions":-1},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":17,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":22,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":12,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":402,"sizeDeletions":-157},{"number":"8","revision":"ee9667e320544fbec721b21c978520176da57527","parents":["ccab35148089aab19d5191dae183cffbb898bc1f"],"ref":"refs/changes/96/2896/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1512066238,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512066263,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":63,"deletions":-61},{"file":"lib/config.js","type":"ADDED","insertions":262,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":438,"sizeDeletions":-155},{"number":"9","revision":"d665779f432bf9d6315ce0fc084fc25e260e2f09","parents":["ccab35148089aab19d5191dae183cffbb898bc1f"],"ref":"refs/changes/96/2896/9","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1515750632,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515750659,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":60,"deletions":-61},{"file":"lib/config.js","type":"ADDED","insertions":262,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":435,"sizeDeletions":-155},{"number":"10","revision":"69ba10ace986bafe963aa66ee112b11724cc69f4","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/10","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1515759382,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515750659,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":60,"deletions":-61},{"file":"lib/config.js","type":"ADDED","insertions":262,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":435,"sizeDeletions":-155},{"number":"11","revision":"bbad0ce009289de21c9f118a51327db695cb9bf1","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/11","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1515774315,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515774341,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":56,"deletions":-61},{"file":"lib/config.js","type":"ADDED","insertions":262,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":431,"sizeDeletions":-155},{"number":"12","revision":"47641e3669c1a515268a119ede248e4d2f00a6bb","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1515781361,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515781387,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":74,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027ve a question on this block in the CR for TOOLS-1974"},{"file":"boot/setup.sh","line":74,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Already done with that one."},{"file":"boot/setup.sh","line":106,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This block is setting dns_domain, even if it is already set. I don\u0027t think it should do that.\n\nI have a CR comment in lib/config.js requesting a block comment that describes usage and setting of \"dns_domain\" on mdata."},{"file":"boot/setup.sh","line":106,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"boot/setup.sh","line":111,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Actually, if this block was moved to be *before* we import the SAPI SMF manifest, then we could remove the code in lib/config.js that uses usbkey_config to get \"dns_domain\". That would be good, because then there would only be one place that does that."},{"file":"boot/setup.sh","line":111,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call!"},{"file":"lib/config.js","line":18,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think it would be useful to have a description of the expected presence of \"dns_domain\" in mdata, because I think without the description in SAPI-294 comments, it isn\u0027t obvious.\n\nAlso, do you have a ticket for: \"Initial headnode setup should explicitly set metadata.dns_domain for\nthe \u0027sapi\u0027 SAPI service.\""},{"file":"lib/config.js","line":18,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":58,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Use `err.code\u003d\u003d\u003d1` here, as you\u0027ve done in the next step.\n\nAlso, at this point it is a little"},{"file":"lib/config.js","line":58,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":118,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Use a \u0027^\u0027 anchor, else `napi_admin_ips\u003d(.*)` will match \"cnapi_admin_ips\u003d...\", for example. You\u0027ll need to add the \u0027m\u0027 flag."},{"file":"lib/config.js","line":118,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":129,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Add \u0027^\u0027 anchor here. And if you do that, you\u0027ll need the \u0027m\u0027 flag. So, this could be changed to:\n\n```\n/^dns_domain\u003d(.+)$/m\n```"},{"file":"lib/config.js","line":129,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Removed since I\u0027ve moved the block where it gets dns_domain on the setup file before we import SAPI SMF"},{"file":"lib/config.js","line":153,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: It would be clearer to move this guard into `getDcName`."},{"file":"lib/config.js","line":153,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":175,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Don\u0027t need this part of the test."},{"file":"lib/config.js","line":175,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":217,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Don\u0027t need this second arg, right?"},{"file":"lib/config.js","line":217,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/config.js","line":235,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Don\u0027t need this second arg, right?"},{"file":"lib/config.js","line":235,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":56,"deletions":-61},{"file":"lib/config.js","type":"ADDED","insertions":262,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":432,"sizeDeletions":-156},{"number":"13","revision":"e3ad7e421ed8e801be325ecb50cfba9ae43aa301","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/13","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516216322,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516216349,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/config.js","line":122,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nope, I thnk you need the `m` flag, so `^` anchors at the start of a line, rather than just the start of the multiline string.  Does this *work* with \u0027g\u0027 in testing?"},{"file":"lib/config.js","line":122,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. You\u0027re right about the \"m\" flag. Still, it worked w/o it same than with it."},{"file":"lib/config.js","line":122,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Pedro,\nThis code path can *not* have worked without the \u0027m\u0027 flag:\n\n    [root@headnode (nightly-1) ~]# /usr/node/bin/node\n    \u003e var fs \u003d require(\u0027fs\u0027);\n    undefined\n    \u003e var config \u003d fs.readFileSync(\u0027/usbkey/config\u0027, \u0027utf8\u0027)\n    undefined\n    \n    \u003e re \u003d /^cnapi_admin_ips\u003d(.+)/g\n    /^cnapi_admin_ips\u003d(.+)/g\n    \u003e config.match(re)\n    null\n    \n    \u003e re2 \u003d /^cnapi_admin_ips\u003d(.+)/m\n    /^cnapi_admin_ips\u003d(.+)/m\n    \u003e config.match(re2)\n    [ \u0027cnapi_admin_ips\u003d172.25.1.22\u0027,\n      \u0027172.25.1.22\u0027,\n      index: 642,\n      input: \u0027#\\n# This file was auto-generated ...\u0027 ]"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":18,"deletions":-65},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":392,"sizeDeletions":-161},{"number":"14","revision":"8f191e71f03133109ab2529cb56bf36a3d3f0e8c","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/14","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516306293,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516306322,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1516666052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":18,"deletions":-65},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":392,"sizeDeletions":-161},{"number":"15","revision":"797b009f84f3a0f3cbcaf0ed10828ef52f27dd5a","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/15","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516691813,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516691841,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1516666052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"boot/setup.sh","line":48,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Does this work? ... oh, does it work because soonish after \u0027svccfg import sapi.xml\u0027 SAPI will be up and will respond for the requests in sdc_common_setup. Also, it relies on \"download_metadata\" doing retries if SAPI perhaps takes a while to come up.\n\nThat\u0027s cool. I\u0027d like the comments in here to make clear what is going on. I can try to draft comments for that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":21,"deletions":-64},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":395,"sizeDeletions":-160},{"number":"16","revision":"b7d2f319ce2d197fe2f1c5dc81abb1b2f3a1ffc7","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/16","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1516993366,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1516993405,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1516666052,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":21,"deletions":-64},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":394,"sizeDeletions":-159},{"number":"17","revision":"1c44b09cf5037b80f44ae02342c36bedf5e2b1e5","parents":["b8dc8cc7576c7396ba873acf053180ede007ee3b"],"ref":"refs/changes/96/2896/17","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517254152,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517254181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":49,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Added the comment to notice that we need it because we need creation/reprovision of SAPI instances to be independent of any other running instances."},{"file":"boot/setup.sh","line":81,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Is this the kind of comment you suggested?"},{"file":"boot/setup.sh","line":117,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"This is what we commented about setting \u0027dns_domain\u0027 value into SAPI service from any existing instance so we can avoid having to do it from sdcadm"},{"file":"lib/server/attributes.js","line":221,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not adding \u0027dns_domain\u0027 here means that, despite of we setting up or not the value for the SAPI service, it will never made it \"automatically\" to the new SAPI instances, as explained into SAPI docs (https://mo.joyent.com/docs/sapi/master/#CreateInstance), unless we use something like `pass_vmapi_metadata_keys`, which looks a lot uglier, more considering that we\u0027ll want it present as `sdc:dns_domain` in the future.\n\nIf we don\u0027t allow \u0027dns_domain\u0027 to be automatically added here, we need to figure out a way to add it from boot/setup.sh file, which brings the problem of \"from where are we gonna get this value, if we need to have it added to the zone before the SAPI service boots?\" A possible approach would be to do something similar to what headnode setup does with `usbkey_config`, but that would require us to perform such operations from outside the zone, (say from sdcadm), we would need to boot the zone into some special mode (similar to PROTO MODE), and do all the download metadata ourselves too.\n\nHonestly, I think the less \"messy\" approach is just allowing this attribute to be passed into the VM at creation time from the service to VMAPI. Thoughts?"},{"file":"lib/server/attributes.js","line":221,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, thanks for pointing out that CreateInstance won\u0027t pass through a\n`$sapiService.metadata.dns_domain` value to new sapi instances.\n\n\n### option 1: allowed_keys\n\nThe reason I don\u0027t like adding \u0027dns_domain\u0027 to `allowed_keys` is that it applies\nto all services, but we only want `$inst.customer_metadata.dns_domain` on\n*sapi* instances.\n\n### option 2: pass_vmapi_metadata_keys\n\nThanks also for mentioning `pass_vmapi_metadata_keys`! While that is an\nawful name for the feature :) I think that using it is actually *cleaner*\nbecause, if I understand correctly, it means that we wouldn\u0027t need to duplicate\nthe *value* for `dns_domain`. The value for dns_domain would automatically get\ntaken from the \u0027sdc\u0027 SAPI application.\n\n- \"boot/setup.sh\" would ensure `$sapiService.metadata.pass_vmapi_metadata_keys`\n  includes \"dns_domain\". It would do this after `sdc_common_setup` to benefit\n  from the polling that `download_metadata` does to ensure that the SAPI process\n  is up.\n\n\n### option 3: params.dns_domain\n\nHere is yet another idea. :) **Set `$sapiService.params.dns_domain`.**\nNote the \"params\", not \"metadata\".\n\nGiven that eventually (in TRITON-92) we want to have `params.dns_domain` for\nall Triton core instances, we could do that for just the SAPI service now.\nWe\u0027d change sdc-sapi as follows:\n\n- \"boot/setup.sh\" would handle `dns_domain` as follows:\n    - if `mdata-get sdc:dns_domain` is not \"local\" (the default), then\n      nothing to do\n    - else, check `mdata-get dns_domain`. If that isn\u0027t set, then try to\n      set it from `usbkey_config`.\n    - else, error out that `dns_domain` could not be determined.\n\n- \"lib/config.js#loadConfig\" would determine `dns_domain` as follows:\n    - First, try `mdata-get sdc:dns_domain` and if it is not \"local\" (the\n      default), then use that.\n    - Otherwise, try `mdata-get dns_domain`. This is a fallback only.\n    - Otherwise, throw an Error.\n\n- \"boot/setup.sh\" would ensure `$sapiService.params.dns_domain` is set.\n  It would do this after `sdc_common_setup` to benefit from the polling that\n  `download_metadata` does to ensure that the SAPI process is up."},{"file":"lib/server/attributes.js","line":221,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think option 2 is probably the easier of option 2 and option 3.  Eventually, I think the changes to boot/setup.sh and lib/config.js for dns_domain handling should be done anyway, but that can be deferred to TRITON-92."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":63,"deletions":-62},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":3,"deletions":-5},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":439,"sizeDeletions":-162},{"number":"18","revision":"750f825c8bda3169f0d9c25044cb2e13b9a9855c","parents":["9a3428d6d98cc9c2a06af00feb518c85fd45c4c7"],"ref":"refs/changes/96/2896/18","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517429676,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517429712,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":80,"deletions":-62},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":455,"sizeDeletions":-161},{"number":"19","revision":"e39053901b27e4119572e2673f3c8da943b79aea","parents":["9a3428d6d98cc9c2a06af00feb518c85fd45c4c7"],"ref":"refs/changes/96/2896/19","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1517502305,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517502336,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-5},{"file":"boot/configure.sh","type":"MODIFIED","insertions":1,"deletions":-7},{"file":"boot/setup.sh","type":"MODIFIED","insertions":79,"deletions":-62},{"file":"deps/sdc-scripts","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/attributes.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":4,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml.in","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":454,"sizeDeletions":-161},{"number":"20","revision":"16027a25aaeb0cac7e9c80ce45be32c80af65d61","parents":["802c7eecf0ed411fd37718e3e41e0189efcdf4be"],"ref":"refs/changes/96/2896/20","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1528475859,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528482026,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":73,"deletions":-67},{"file":"lib/config.js","type":"ADDED","insertions":259,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":436,"sizeDeletions":-118},{"number":"21","revision":"031fbc922ed9704ea30028ce364ddb4acd9b665d","parents":["802c7eecf0ed411fd37718e3e41e0189efcdf4be"],"ref":"refs/changes/96/2896/21","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1528804476,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528804505,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":73,"deletions":-67},{"file":"lib/config.js","type":"ADDED","insertions":301,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":478,"sizeDeletions":-118},{"number":"22","revision":"1b9153d0db92fd979515d4cf7cc0ce89d4392564","parents":["802c7eecf0ed411fd37718e3e41e0189efcdf4be"],"ref":"refs/changes/96/2896/22","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1528820196,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528820225,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":73,"deletions":-67},{"file":"lib/config.js","type":"ADDED","insertions":318,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":495,"sizeDeletions":-118},{"number":"23","revision":"bef0e120f57b2a0870e131ae06fd0012f2793a44","parents":["360c24e528e388cc469708f51dac738b948a9c6b"],"ref":"refs/changes/96/2896/23","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1528995216,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528820225,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":73,"deletions":-67},{"file":"lib/config.js","type":"ADDED","insertions":318,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":495,"sizeDeletions":-118},{"number":"24","revision":"ee047bede1329c4cf5aaa0d26a7da13381412a96","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/24","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529578660,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529578691,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":75,"deletions":-67},{"file":"lib/config.js","type":"ADDED","insertions":318,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"smf/manifests/sapi.xml","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":497,"sizeDeletions":-118},{"number":"25","revision":"025c3f951ba1cd736a9a757ef1348f9a004294d0","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/25","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529579302,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1529579328,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":55,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"We carry this since the early beginning. I assume it\u0027s due we want to use some binaries in other core VMs and we\u0027re using the same code everywhere:\n\n        commit 118c39cdc6e7baf3d8be50483f8260f55ef22753\n       Author: Josh Wilsdon \u003cjwilsdon@joyent.com\u003e\n       Date:   Mon Sep 9 15:57:24 2013 -0700\n\n            HEAD-1804 move from sdc-boot -\u003e boot\n\nI\u0027m gonna give it a try w/o such stuff in the path and see what happens."},{"file":"lib/config.js","line":137,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No, as we already commented by email this is no longer needed after SAPI-224, ie, no longer needed for any build younger than February 2015, which I\u0027d say it\u0027s pretty much every Triton setup running"},{"file":"lib/config.js","line":259,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Before the changes you\u0027ve made to setup.sh, we weren\u0027t having DNS domain until this file run the first time and we read its value from usbkey_config. Now, with those changes we can remove this part"},{"file":"lib/config.js","line":261,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: XXX"},{"file":"lib/config.js","line":261,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: expected an assignment or function call"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":168,"deletions":-74},{"file":"lib/config.js","type":"ADDED","insertions":350,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27}],"sizeInsertions":621,"sizeDeletions":-158},{"number":"26","revision":"b56ca8a564dfd8095301d4c7e9b7d1224e61c986","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/26","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529579919,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529579947,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":168,"deletions":-74},{"file":"lib/config.js","type":"ADDED","insertions":350,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27}],"sizeInsertions":621,"sizeDeletions":-158},{"number":"27","revision":"429e0a7153933efd646a7149d4a8c44bd4c7ffd8","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/27","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529580276,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529580304,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":168,"deletions":-74},{"file":"lib/config.js","type":"ADDED","insertions":353,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27}],"sizeInsertions":624,"sizeDeletions":-158},{"number":"28","revision":"73ba6bac896454592d2c0db0a0f802230b98dbdd","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/28","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529591568,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529591597,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":289,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27}],"sizeInsertions":514,"sizeDeletions":-160},{"number":"29","revision":"1f4969234424380effb87aa78dcee30d3301fc17","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/29","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529591697,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529591726,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":288,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27}],"sizeInsertions":513,"sizeDeletions":-160},{"number":"30","revision":"b888763feb7a79508b6e9cf6fb338e007ba50ef2","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/30","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1529616922,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529616955,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":371,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"test/helper.js","type":"MODIFIED","insertions":48,"deletions":-44},{"file":"tools/cleanup-test-resources.js","type":"MODIFIED","insertions":21,"deletions":-12}],"sizeInsertions":665,"sizeDeletions":-216},{"number":"31","revision":"426d798c8f23da42494866a45f2544c2e7fc9a06","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/31","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1529617072,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529616955,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":371,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":13,"deletions":-7},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":17,"deletions":-11},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"test/helper.js","type":"MODIFIED","insertions":48,"deletions":-44},{"file":"tools/cleanup-test-resources.js","type":"MODIFIED","insertions":21,"deletions":-12}],"sizeInsertions":665,"sizeDeletions":-216},{"number":"32","revision":"28593d5fc9fdc548abf6d2301a8f41abc9ac196a","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/32","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1529621435,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529621463,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":371,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":18,"deletions":-12},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":0,"deletions":-4},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"test/helper.js","type":"MODIFIED","insertions":48,"deletions":-44},{"file":"tools/cleanup-test-resources.js","type":"MODIFIED","insertions":21,"deletions":-12}],"sizeInsertions":669,"sizeDeletions":-220},{"number":"33","revision":"66e30b6f0643ef8389e80973cf9c971c669ad523","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/33","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1529621646,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529621674,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529621729,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529621729,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":371,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":18,"deletions":-12},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"test/helper.js","type":"MODIFIED","insertions":48,"deletions":-44},{"file":"tools/cleanup-test-resources.js","type":"MODIFIED","insertions":21,"deletions":-12}],"sizeInsertions":682,"sizeDeletions":-221},{"number":"34","revision":"a4209a1eabb9d8db2170617195a08516bba845f5","parents":["ae84eaf1f5412c14c1d62eaa7e1313cce07d04cc"],"ref":"refs/changes/96/2896/34","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1529678564,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1529621674,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529621729,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1529621729,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1529678576,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":122,"deletions":-76},{"file":"lib/config.js","type":"ADDED","insertions":371,"deletions":0},{"file":"lib/server/endpoints/applications.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"lib/server/endpoints/common.js","type":"ADDED","insertions":36,"deletions":0},{"file":"lib/server/endpoints/instances.js","type":"MODIFIED","insertions":14,"deletions":-8},{"file":"lib/server/endpoints/manifests.js","type":"MODIFIED","insertions":18,"deletions":-12},{"file":"lib/server/endpoints/services.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"sapi_manifests/sapi/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/sapi/template","type":"MODIFIED","insertions":0,"deletions":-28},{"file":"server.js","type":"MODIFIED","insertions":23,"deletions":-27},{"file":"test/helper.js","type":"MODIFIED","insertions":48,"deletions":-44},{"file":"tools/cleanup-test-resources.js","type":"MODIFIED","insertions":21,"deletions":-12}],"sizeInsertions":682,"sizeDeletions":-221}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}