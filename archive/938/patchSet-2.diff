From c249559041c70d7bd7abb389d6b9ea2dcbdfe90f Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Tue, 22 Nov 2016 16:49:00 +0000
Subject: [PATCH] OS-5813 lxbrand remove thunk cruft

---
 usr/src/uts/common/brand/lx/os/lx_brand.c       | 4 ----
 usr/src/uts/common/brand/lx/sys/lx_brand.h      | 9 +--------
 usr/src/uts/common/brand/lx/syscall/lx_getpid.c | 6 +-----
 3 files changed, 2 insertions(+), 17 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/os/lx_brand.c b/usr/src/uts/common/brand/lx/os/lx_brand.c
index fbca57a418..fa7da00684 100644
--- a/usr/src/uts/common/brand/lx/os/lx_brand.c
+++ b/usr/src/uts/common/brand/lx/os/lx_brand.c
@@ -1618,10 +1618,6 @@ lx_brandsys(int cmd, int64_t *rval, uintptr_t arg1, uintptr_t arg2,
 		return (lx_helper_rt_tgsigqueueinfo(arg1, arg2, arg3,
 		    (siginfo_t *)arg4));
 
-	case B_SET_THUNK_PID:
-		lwpd->br_lx_thunk_pid = arg1;
-		return (0);
-
 	case B_GETPID:
 		/*
 		 * The usermode clone(2) code needs to be able to call
diff --git a/usr/src/uts/common/brand/lx/sys/lx_brand.h b/usr/src/uts/common/brand/lx/sys/lx_brand.h
index 959e84b0a0..1791170da6 100644
--- a/usr/src/uts/common/brand/lx/sys/lx_brand.h
+++ b/usr/src/uts/common/brand/lx/sys/lx_brand.h
@@ -101,7 +101,7 @@ extern "C" {
 #define	B_STORE_ARGS		137
 #define	B_GETPID		138
 #define	B_JUMP_TO_LINUX		139
-#define	B_SET_THUNK_PID		140
+/* formerly B_SET_THUNK_PID	140 */
 #define	B_EXIT_AS_SIG		141
 /* formerly B_HELPER_WAITID	142 */
 #define	B_HELPER_CLONE		143
@@ -524,13 +524,6 @@ struct lx_lwp_data {
 	uintptr_t br_ntv_stack;
 	uintptr_t br_ntv_stack_current;
 
-	/*
-	 * If this pid is set, we return it with getpid().  This allows the
-	 * thunking server to interpose on the pid returned to the Linux
-	 * syslog software.
-	 */
-	pid_t	br_lx_thunk_pid;
-
 	/*
 	 * If strict mode is enabled (via LX_STRICT in the environment), any
 	 * call to lx_unsupported() will set this boolean to B_TRUE.  This will
diff --git a/usr/src/uts/common/brand/lx/syscall/lx_getpid.c b/usr/src/uts/common/brand/lx/syscall/lx_getpid.c
index c2506f52c5..4d9ca04bcc 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_getpid.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_getpid.c
@@ -48,11 +48,7 @@ lx_getpid(void)
 	} else {
 		VERIFY(lwpd != NULL);
 
-		if (lwpd->br_lx_thunk_pid != 0) {
-			rv = lwpd->br_lx_thunk_pid;
-		} else {
-			rv = lwpd->br_tgid;
-		}
+		rv = lwpd->br_tgid;
 	}
 
 	return (rv);
-- 
2.21.0

