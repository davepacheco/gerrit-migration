{"project":"joyent/binder","branch":"master","topic":"manta-metricports","id":"I2f72f87c2a03cfbecf0692646bbd6bb176535fe5","number":"5698","subject":"MANTA-4146 Add metricPorts mdata variable to binder when part of manta application Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"url":"https://cr.joyent.us/5698","commitMessage":"MANTA-4146 Add metricPorts mdata variable to binder when part of manta application\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1551492481,"lastUpdated":1558563127,"open":false,"status":"MERGED","comments":[{"timestamp":1551492481,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 1."},{"timestamp":1551492510,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1551495680,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1553304121,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 2."},{"timestamp":1553304151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1553304194,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 2:\n\n(5 comments)\n\nSee ticket for new testing notes."},{"timestamp":1557194611,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Topic set to manta-metricports"},{"timestamp":1557254686,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(8 comments)"},{"timestamp":1557277276,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 3."},{"timestamp":1557277303,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557277363,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 3:\n\n(8 comments)\n\nTesting notes for PS3: I ran through the sequence of commands on the ticket for PS2, and saw identical results."},{"timestamp":1558562870,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Code-Review+1\n\nThis is great!  Thank you for the changes."},{"timestamp":1558562955,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1558563123,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1558563127,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Isaac Davis"}],"currentPatchSet":{"number":"4","revision":"0210c2b37b7c005279c96b51a2fd7103fa09fd99","parents":["a52e94b2a0957fd079d31c751705d94363e1f2b0"],"ref":"refs/changes/98/5698/4","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1558563123,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557277303,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558562870,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558562955,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1558563127,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"deps/eng","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"smf/manifests/metric-ports-updater.xml.in","type":"ADDED","insertions":55,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":81,"deletions":0},{"file":"src/smf_adjust.c","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"tools/cstyle.pl","type":"ADDED","insertions":1002,"deletions":0}],"sizeInsertions":1174,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"b7d6c69727f51865600d18cb9727ae0d65e8e05b","parents":["b2393abf5f713661a5b2f41221f129eb1158fa09"],"ref":"refs/changes/98/5698/1","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1551492481,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1551492510,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":143,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Can you put the \"fins\" around this comment; i.e.,\n\n    #\n    # We determine ...\n    #\n    # .... by cmon-agent.\n    #\n\nI think the first paragraph is effectively redundant with the second; I\u0027d elide it -- and then either join the other two sentences into one paragraph, or insert an inter-paragraph line break."},{"file":"boot/setup.sh","line":143,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"boot/setup.sh","line":145,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Can you put spaces between the math context surrounds and the actual expression; i.e.,\n\n    metric_base_port\u003d$(( $base_port + 1000 ))"},{"file":"boot/setup.sh","line":145,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"boot/setup.sh","line":146,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Should we be limited by $nprocs here?  If somebody uses \"smf_adjust\" to make an adhoc change to the set of instances, the metricPorts list may contain either too many, or too few, ports.\n\nHow does cmon-agent deal with ports that are not open?\n\nWould it be more appropriate to do what we do with logadm rules in 62-87 above, and just populate the list with all possible values?"},{"file":"boot/setup.sh","line":146,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"made obsolete by new patchset"},{"file":"boot/setup.sh","line":147,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Spaces here too --\n\n    metric_ports+\u003d ( $(( $metric_base_port + i )) )"},{"file":"boot/setup.sh","line":147,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"made obsolete by new patchset"},{"file":"boot/setup.sh","line":149,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This value ought not to contain spaces, but I think we should really quote it anyway, i.e.,\n\n    mdata-put metricPorts \"$(IFS\u003d\u0027,\u0027; echo \"${metric_ports[*]}\")\""},{"file":"boot/setup.sh","line":149,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":18,"deletions":-2}],"sizeInsertions":18,"sizeDeletions":-2},{"number":"2","revision":"cffa194f2fd2d77f9609ad7995379e277b75f002","parents":["df162f9168205d73a7f43de57388dd70e923d4af"],"ref":"refs/changes/98/5698/2","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1553304121,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1553304151,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"boot/setup.sh","line":9,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As per RFD 164, we\u0027re doing a simplified Copyright message from now on; e.g.,\n\n    Copyright 2019 Joyent, Inc.\n\nSee also: https://github.com/joyent/rfd/blob/master/rfd/0164/README.md#copyright-notice\n\n(There are a few other instances of this in the repo/change, but I\u0027ll just mark this one as a comment.)"},{"file":"boot/setup.sh","line":9,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Fixed, in all edited files."},{"file":"smf/manifests/metric-ports-updater.xml.in","line":29,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"When we install the script we should just make sure it\u0027s executable, then the interpreter line will take care of the \"/bin/bash\" part and it won\u0027t be needed here."},{"file":"smf/manifests/metric-ports-updater.xml.in","line":29,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Leaving this consistent with mksockdir, as we discussed."},{"file":"smf/methods/metric-ports-updater.sh","line":1,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027d be explicit about the path to bash; i.e.,\n\n    #!/usr/bin/bash"},{"file":"smf/methods/metric-ports-updater.sh","line":1,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Fixed (to /bin/bash, to match mksockdir)"},{"file":"smf/methods/metric-ports-updater.sh","line":13,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027d probably put this in double quotes to make clear that it\u0027s an exact variable name."},{"file":"smf/methods/metric-ports-updater.sh","line":13,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Probably \"value\" instead of \"variable\"."},{"file":"smf/methods/metric-ports-updater.sh","line":13,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"smf/methods/metric-ports-updater.sh","line":13,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"smf/methods/metric-ports-updater.sh","line":18,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would replace \"sfmri\" with \"instance FMRI\""},{"file":"smf/methods/metric-ports-updater.sh","line":18,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"smf/methods/metric-ports-updater.sh","line":35,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"The challenge with using \"svcs\" in this way is that you can\u0027t tell the difference between there not being an instance of \"binder\", and there being some other potentially transient fault that prevented \"svcs\" from running.  Unfortunately there doesn\u0027t seem to be an easy way to tell _why_ \"svcs\" failed.  I\u0027d probably recommend instead doing something like:\n\n    service\u003dsvc:/manta/application/binder\n    pattern\u003d\"${service}:binder-\"\n    \n    if ! all\u003d$(svcs -Ho sta,nsta,fmri \"$service\"); then\n            printf \u0027ERROR: svcs failure\\n\u0027 \u003e\u00262\n            exit 1\n    fi\n    \n    insts\u003d()\n    while read sta nsta fmri; do\n            if [[ \"$fmri\" !\u003d \"$pattern\"* ]]; then\n                    continue\n            fi\n    \n            #\n            # Discard instances that are not either online or\n            # transitioning to online.\n            #\n            if [[ \"$sta\" !\u003d \u0027ON\u0027 \u0026\u0026 \"$nsta\" !\u003d \u0027ON\u0027 ]]; then\n                    continue\n            fi\n\n            insts+\u003d( \"$fmri\" )\n\n    done \u003c\u003c\u003c \"$all\"\n    \n    if (( ${#insts[@]} \u003c 1 )); then\n            printf \u0027no running binder instances found; exiting\\n\u0027\n            exit 0\n    fi\n    \n    ports\u003d()\n    for inst in \"${insts[@]}\"; do\n            ports+\u003d( $(( \"${inst//$pattern/}\" + 1000 )) )\n    done\n    \n    mdata-put metricPorts \"$(IFS\u003d\u0027,\u0027; echo \"${ports[*]}\")\""},{"file":"smf/methods/metric-ports-updater.sh","line":35,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done - thanks for writing this code!"},{"file":"src/smf_adjust.c","line":895,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I suspect this whole function might not be needed if we instead require an _instance_ FMRI for the \"-r\" option?  In that case, even the new \"restart_instance()\" would probably not be needed -- we could, I think, directly pass the -r option value string to \"smf_restart_instance()\" in that case.\n\nWhat do you think?"},{"file":"src/smf_adjust.c","line":895,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Indeed! Fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"smf/manifests/metric-ports-updater.xml.in","type":"ADDED","insertions":55,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":71,"deletions":0},{"file":"src/smf_adjust.c","type":"MODIFIED","insertions":82,"deletions":-2},{"file":"tools/cstyle.pl","type":"ADDED","insertions":1002,"deletions":0}],"sizeInsertions":1219,"sizeDeletions":-4},{"number":"3","revision":"2f72f87c2a03cfbecf0692646bbd6bb176535fe5","parents":["a52e94b2a0957fd079d31c751705d94363e1f2b0"],"ref":"refs/changes/98/5698/3","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1557277276,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558562870,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558562955,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557277303,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"deps/eng","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"smf/manifests/metric-ports-updater.xml.in","type":"ADDED","insertions":55,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":81,"deletions":0},{"file":"src/smf_adjust.c","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"tools/cstyle.pl","type":"ADDED","insertions":1002,"deletions":0}],"sizeInsertions":1174,"sizeDeletions":-7},{"number":"4","revision":"0210c2b37b7c005279c96b51a2fd7103fa09fd99","parents":["a52e94b2a0957fd079d31c751705d94363e1f2b0"],"ref":"refs/changes/98/5698/4","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1558563123,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558562870,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558562955,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557277303,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1558563127,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"deps/eng","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"smf/manifests/metric-ports-updater.xml.in","type":"ADDED","insertions":55,"deletions":0},{"file":"smf/methods/metric-ports-updater.sh","type":"ADDED","insertions":81,"deletions":0},{"file":"src/smf_adjust.c","type":"MODIFIED","insertions":25,"deletions":-3},{"file":"tools/cstyle.pl","type":"ADDED","insertions":1002,"deletions":0}],"sizeInsertions":1174,"sizeDeletions":-7}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}]}