From b7d6c69727f51865600d18cb9727ae0d65e8e05b Mon Sep 17 00:00:00 2001
From: Isaac Davis <isaac.davis@joyent.com>
Date: Sat, 2 Mar 2019 02:07:50 +0000
Subject: [PATCH] MANTA-4146 Add metricPorts mdata variable to binder when part
 of manta application

---
 boot/setup.sh | 20 ++++++++++++++++++--
 1 file changed, 18 insertions(+), 2 deletions(-)

diff --git a/boot/setup.sh b/boot/setup.sh
index d681fbd..52b6348 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -57,6 +57,8 @@ if [[ ${FLAVOR} == "manta" ]]; then
     echo "Adding local manifest directories"
     manta_add_manifest_dir "/opt/smartdc/binder"
 
+    base_port=5301
+
     echo "Adding log rotation rules"
     for (( i = 0; i < MANTA_BINDER_MAX_PROCS; i++ )); do
         #
@@ -65,7 +67,7 @@ if [[ ${FLAVOR} == "manta" ]]; then
         # arrive through the load balancer.  This base value must align with
         # the value passed to "smf_adjust" via the "-B" argument.
         #
-        port=$(( 5301 + i ))
+        port=$(( $base_port + i ))
 
         #
         # If there are multiple binder processes configured, there will be
@@ -128,10 +130,24 @@ if [[ ${FLAVOR} == "manta" ]]; then
 
     echo "Configuring instances of binder SMF service"
     if ! /opt/smartdc/binder/lib/smf_adjust -s 'svc:/manta/application/binder' \
-      -b binder -B 5301 -i $nprocs; then
+      -b binder -B $base_port -i $nprocs; then
         fatal "unable to configure instances of binder SMF service"
     fi
 
+    # We determine metricPorts in the same way that smf_adjust assigns ports,
+    # using an offset from a base port.
+    # We use the same base port and number of binder processes as are passed to
+    # smf_adjust, but add 1000 to arrive at the metricPort for each binder
+    # process instead.
+    # We join the metric ports in a comma-separated list, then add this list as
+    # metricPorts mdata to allow scraping by cmon-agent.
+    declare -a metric_ports
+    metric_base_port=$(($base_port + 1000))
+    for (( i = 0; i < $nprocs; i++ )); do
+        metric_ports+=( $(($metric_base_port + i)) )
+    done
+    mdata-put metricPorts $(IFS=','; echo "${metric_ports[*]}")
+
     manta_common_setup_end
 
 else # FLAVOR == "sdc"
-- 
2.21.0

