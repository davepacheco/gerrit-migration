{"project":"joyent/illumos-joyent","branch":"master","id":"I67641ea6388b5f3e3e6a72aadf956313c58ca521","number":"6781","subject":"OS-7947 OS-7899 causes failure mode with SO_REUSEADDR and SOCK_DGRAM Reviewed by: Michael Zeller \u003cmike.zeller@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"url":"https://cr.joyent.us/6781","commitMessage":"OS-7947 OS-7899 causes failure mode with SO_REUSEADDR and SOCK_DGRAM\nReviewed by: Michael Zeller \u003cmike.zeller@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1565624960,"lastUpdated":1565727856,"open":false,"status":"MERGED","comments":[{"timestamp":1565624960,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 1."},{"timestamp":1565625046,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\nCurrently untested, but wanted to put a stake in the ground."},{"timestamp":1565633196,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\nI reran my test program that mimics the linux software I run in a zone and it completed successfully:\n\nroot@thehive:~/src/mcast# ./mcast\n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d ipv4 \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\nsocketfd: 3\nset socket options successfully\nbind successful\nMCAST_JOIN_GROUP successful\nMCAST_LEAVE_GROUP successful\n\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d ipv6 \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\nsocketfd: 4\nset socket options successfully\nbind successful\nMCAST_JOIN_GROUP successful\nMCAST_LEAVE_GROUP successful\n\n\n\nI also ran the ltp which resulted in the follow failures:\n\nroot@thehive:/opt/ltp/results# grep TFAIL /tmp/test.log\nmsgctl10    1  TFAIL  :  msgctl10.c:157:   Fork failed (may be OK if under stress)\nmsgctl11    1  TFAIL  :  msgctl11.c:205: Fork failed (may be OK if under stress)\nrecv01      5  TFAIL  :  recv01.c:147: invalid MSG_ERRQUEUE flag set ; returned 0 (expected -1), errno 0 (expected 11)\nrecvfrom01    7  TFAIL  :  recvfrom01.c:170: invalid MSG_ERRQUEUE flag set ; returned 0 (expected -1), errno 0 (expected 11)\nrecvmsg01   10  TFAIL  :  recvmsg01.c:235: invalid MSG_ERRQUEUE flag set ; returned 0 (expected -1), errno 0 (expected 11)"},{"timestamp":1565633359,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\nDid the LTP fail similarly without this fix in place?"},{"timestamp":1565635689,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\nOn a platform without the OS-7899 changes I saw:\n\nroot@channelsdvr:/opt/ltp# grep TFAIL /tmp/test.log\nmsgctl10    1  TFAIL  :  msgctl10.c:157:   Fork failed (may be OK if under stress)\nrecv01      5  TFAIL  :  recv01.c:147: invalid MSG_ERRQUEUE flag set ; returned 0 (expected -1), errno 0 (expected 11)\nrecvfrom01    7  TFAIL  :  recvfrom01.c:170: invalid MSG_ERRQUEUE flag set ; returned 0 (expected -1), errno 0 (expected 11)\nrecvmsg01   10  TFAIL  :  recvmsg01.c:235: invalid MSG_ERRQUEUE flag set ; returned 0 (expected -1), errno 0 (expected 11)"},{"timestamp":1565636539,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1565711097,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1565711182,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1565716953,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)\n\nThis looks good to me. I saw one comment nit which you can ignore."},{"timestamp":1565717027,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1565717337,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 4."},{"timestamp":1565718288,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1565719813,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1565720246,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Uploaded patch set 5."},{"timestamp":1565720268,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5:\n\n(1 comment)\n\nDAMMIT!  Missed cstyle."},{"timestamp":1565720589,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1565727724,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1565727856,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dan McDonald"}],"currentPatchSet":{"number":"5","revision":"67641ea6388b5f3e3e6a72aadf956313c58ca521","parents":["0360c6a8996bc74a9d2ad3fb4ea9201732a4deac"],"ref":"refs/changes/81/6781/5","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1565720246,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565720589,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565727724,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565727724,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1565727856,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":25,"deletions":-4}],"sizeInsertions":25,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"6c9c429f4e33ccde63f4add58b8aad821c0f54e5","parents":["6ea47f7a1107071503a26c8f0256b607e1ad29e9"],"ref":"refs/changes/81/6781/1","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1565624960,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565636539,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":25,"deletions":-4}],"sizeInsertions":25,"sizeDeletions":-4},{"number":"2","revision":"5ba52153df7d88db0df1ec0345cf0db49285a5a1","parents":["881846a585dd22760b95f55003f1344df8af4198"],"ref":"refs/changes/81/6781/2","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1565711097,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565636539,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":25,"deletions":-4}],"sizeInsertions":25,"sizeDeletions":-4},{"number":"3","revision":"b498b52f4569f772206324e922c567afc6f98a35","parents":["881846a585dd22760b95f55003f1344df8af4198"],"ref":"refs/changes/81/6781/3","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1565711182,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565716953,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565717027,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565636539,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":3028,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"nit: this word doesn\u0027t belong here"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":3028,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Doh!  Will fix.  This means you\u0027ll have to re +1.  Sorry."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":25,"deletions":-4}],"sizeInsertions":25,"sizeDeletions":-4},{"number":"4","revision":"74f356421b6fba8e2619098643202ddc575b324e","parents":["0360c6a8996bc74a9d2ad3fb4ea9201732a4deac"],"ref":"refs/changes/81/6781/4","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1565717337,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565718288,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565718288,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565719813,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":25,"deletions":-4}],"sizeInsertions":25,"sizeDeletions":-4},{"number":"5","revision":"67641ea6388b5f3e3e6a72aadf956313c58ca521","parents":["0360c6a8996bc74a9d2ad3fb4ea9201732a4deac"],"ref":"refs/changes/81/6781/5","uploader":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"createdOn":1565720246,"author":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565727724,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565727724,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565720589,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"SUBM","value":"1","grantedOn":1565727856,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":25,"deletions":-4}],"sizeInsertions":25,"sizeDeletions":-4}],"allReviewers":[{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}]}