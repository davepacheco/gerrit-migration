commit 5fa70dba662b981b2031b97660a60ea236073fd4
Author: Tim Foster <tim.foster@joyent.com>
Date:   2019-04-30T10:48:00+01:00 (5 months ago)
    
    OS-7775 platform builds on base-64 need gcc4.x to bootstrap

diff --git a/README.md b/README.md
index 172e9130..fba51a1f 100644
--- a/README.md
+++ b/README.md
@@ -157,19 +157,20 @@ inside of a non-global zone.
 
 #### Importing the Zone Image
 
-The SmartOS build currently uses the `base-multiarch-lts 16.4.1` image
-which has a UUID of `bafa230e-e6ea-11e6-8438-c72c10ff2d1f `. To import
+The SmartOS build currently uses the `base-64-lts 18.4.0` image
+which has a UUID of `c193a558-1d63-11e9-97cf-97bb3ee5c14f `. To import
 the image, you should run the imgadm command from the global zone:
 
 ```
-# imgadm import bafa230e-e6ea-11e6-8438-c72c10ff2d1f
-Importing bafa230e-e6ea-11e6-8438-c72c10ff2d1f (base-multiarch-lts@16.4.1) from "https://images.joyent.com"
-Gather image bafa230e-e6ea-11e6-8438-c72c10ff2d1f ancestry
-Must download and install 1 image (220.6 MiB)
-Download 1 image                     [=======================================================================>] 100% 220.65MB   7.95MB/s    27s
-Downloaded image bafa230e-e6ea-11e6-8438-c72c10ff2d1f (220.6 MiB)
-...a230e-e6ea-11e6-8438-c72c10ff2d1f [=======================================================================>] 100% 220.65MB  18.76MB/s    11s
-Imported image bafa230e-e6ea-11e6-8438-c72c10ff2d1f (base-multiarch-lts@16.4.1)
+# imgadm import c193a558-1d63-11e9-97cf-97bb3ee5c14f
+Importing c193a558-1d63-11e9-97cf-97bb3ee5c14f (base-64-lts@18.4.0) from "https://images.joyent.com"
+Gather image c193a558-1d63-11e9-97cf-97bb3ee5c14f ancestry
+Must download and install 1 image (148.6 MiB)
+Download 1 image     [=======================>] 100% 148.62MB 497.77KB/s  5m 5s
+Downloaded image c193a558-1d63-11e9-97cf-97bb3ee5c14f (148.6 MiB)
+...97cf-97bb3ee5c14f [=======================>] 100% 148.62MB   5.12MB/s    29s
+Imported image c193a558-1d63-11e9-97cf-97bb3ee5c14f (base-64-lts@18.4.0)
+#
 ```
 
 #### Creating the Zone
@@ -178,7 +179,7 @@ To create a zone, you need to create a `joyent` branded zone with
 `vmadm`. We recommend that the zone have the following attributes:
 
 * The brand set to `"joyent"`
-* The `image_uuid` set to `"bafa230e-e6ea-11e6-8438-c72c10ff2d1f"`
+* The `image_uuid` set to `"c193a558-1d63-11e9-97cf-97bb3ee5c14f"`
 * At least 25 GiB of disk space specified in the `quota` property
 * At least 2-4 GiB of DRAM specified in the `max-physical-memory`
 property
diff --git a/configure b/configure
index 75bff507..e99bfe64 100755
--- a/configure
+++ b/configure
@@ -91,6 +91,9 @@ function install_pkgin
 	pkglist="$pkglist p5-XML-Parser gettext python27 py27-expat"
 	pkglist="$pkglist coreutils gsed pkg_alternatives cdrtools"
 	pkglist="$pkglist py27-sqlite3 nasm pigz"
+	# If /opt/local/bin/gcc isn't 4.x, install gcc 4.9 also,
+	# needed in order to build our local copy of gcc 4.4.
+	pkglist="$pkglist $PKGSRC_GCC4X_PKG"
 
 	for pkg in $pkglist; do
 		if ! pkg_info -qe $pkg; then
@@ -480,6 +483,14 @@ done
 
 PRIMARY_COMPILER_VER=$(echo $PRIMARY_COMPILER | sed 's/^gcc//')
 
+HOST_GCC_IS_4X=$(/opt/local/bin/gcc --version | head -1 | fgrep '(GCC) 4')
+if [[ -n "$HOST_GCC_IS_4X" ]]; then
+	HOST_GCC4_PREFIX=/opt/local/bin
+else
+	HOST_GCC4_PREFIX=/opt/local/gcc49/bin
+	PKGSRC_GCC4X_PKG="gcc49"
+fi
+
 cat >build.env <<EOF
 FORCE_STRAP_REBUILD=$FORCE_STRAP_REBUILD
 ILLUMOS_CLOBBER=$ILLUMOS_CLOBBER
@@ -487,6 +498,7 @@ ILLUMOS_ENABLE_DEBUG=$ILLUMOS_ENABLE_DEBUG
 PRIMARY_COMPILER=$PRIMARY_COMPILER
 PRIMARY_COMPILER_VER=$PRIMARY_COMPILER_VER
 SHADOW_COMPILERS=$SHADOW_COMPILERS
+HOST_GCC4_PREFIX=$HOST_GCC4_PREFIX
 EOF
 
 echo "Doing pre-flight checks... \c "
diff --git a/tools/build_strap b/tools/build_strap
index 7aa6f22e..e3b604e3 100755
--- a/tools/build_strap
+++ b/tools/build_strap
@@ -9,7 +9,7 @@
 # source.  A copy of the CDDL is also available via the Internet at
 # http://www.illumos.org/license/CDDL.
 #
-# Copyright 2018 Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 #
@@ -43,6 +43,10 @@ force_build="no"
 report_loc="no"
 create_cache="no"
 
+if [[ -f $wsroot/build.env ]]; then
+	source $wsroot/build.env
+fi
+
 function fatal
 {
         local msg="$*"
@@ -85,6 +89,7 @@ function build_strap
 	DESTDIR=$(echo $protodir | sed 's+//*+/+g')
 
 	verbose gmake STRAP=strap MAX_JOBS=$max_jobs DESTDIR=$DESTDIR \
+	    GCC4.host_prefix=$HOST_GCC4_PREFIX \
 	    -C $wsroot/projects/illumos-extra install_strap ||
 	    fatal "failed to build install_strap"
 
