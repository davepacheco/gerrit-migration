{"project":"joyent/sdc-headnode","branch":"master","id":"I7b9ed57fde79be7afe9c69e3ca7526d3cdcf9c3a","number":"3032","subject":"HEAD-2380 \u0027sdc-usbkey mount --nofoldcase\u0027 option Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/3032","commitMessage":"HEAD-2380 \u0027sdc-usbkey mount --nofoldcase\u0027 option\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1512424685,"lastUpdated":1513203894,"open":false,"status":"MERGED","comments":[{"timestamp":1512424685,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1512424686,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 0754a180a92b87fd8a6895fafd298c6c4f10e821\n    \n    sdc-usbkey mount --nofoldcase"},{"timestamp":1512424716,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1512424893,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2."},{"timestamp":1512424894,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit e36358838ece719c4f9438dfc3ca25e4c8028adf\n    \n    fix make check"},{"timestamp":1512424975,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1512429837,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nMight we have problems with other tools while this is mounted with nofoldcase? I wonder if it\u0027s a better idea to mount the nofoldcase version in a different place. We mount the usb key normally on /mnt/usbkey, what about mounting the non-foldcase version on /mnt/nofoldusbkey or something? That way we\u0027d never have a conflict as all existing software already has to deal with the /mnt/usbkey not being mounted, so to it there will remain 2 cases:\n\n    * /mnt/usbkey is mounted foldcase\n    * /mnt/usbkey is not mounted\n\nwhereas this change as-is will add a 3rd path which is where /mnt/usbkey is mounted but with different options. Do we have a list of all the consumers here that aren\u0027t using /lib/sdc/config.sh (that prefers the usbkey copy, so seems like it won\u0027t be affected)."},{"timestamp":1512430472,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)\n\n\u003e I wonder if it\u0027s a better idea to mount the nofoldcase version in a different place.\n\nThat\u0027s a good idea. I can look into that."},{"timestamp":1512430579,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1513197906,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1513197908,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit fd10604d88cbd1eb3187dcebb4ac750cef39d0bb\n    \n    update to use alt mount path for alt options, per CR feedback from joshw"},{"timestamp":1513197986,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513198016,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 4."},{"timestamp":1513198018,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 22f795b2987d2cf043fb54710c884dc14cf40e73\n    \n    update to use alt mount path for alt options, per CR feedback from joshw\n    \n    commit a8c176b14588f764f413e1d33582fba53b1d10b7\n    \n    fix make check\n    \n    commit b0865a53aaef183979a8abad7fdb37fac845be1a\n    \n    sdc-usbkey mount --nofoldcase"},{"timestamp":1513198099,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513200126,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1513200191,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Code-Review+1\n\nTook me a while to get my head around, but it seems fine.\n\nWhat testing have you done?"},{"timestamp":1513200786,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(4 comments)"},{"timestamp":1513200854,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n\u003e What testing have you done?\n\nTesting in coal:\n\nhttps://jira.joyent.us/browse/HEAD-2380?focusedCommentId\u003d173257\u0026page\u003dcom.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-173257"},{"timestamp":1513201313,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Integration-Approval+1\n\n(4 comments)\n\nship it ¯\\_(ツ)_/¯"},{"timestamp":1513203219,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 5."},{"timestamp":1513203220,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 00f0ffab75d53ebf097e58f0f11e82d2d0194ba3\n    \n    clarify comments a bit"},{"timestamp":1513203297,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513203853,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nBetterer and betterer!"},{"timestamp":1513203894,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"5","revision":"7b9ed57fde79be7afe9c69e3ca7526d3cdcf9c3a","parents":["4700d836e0caa529de321618f9b94670c1960ac3"],"ref":"refs/changes/32/3032/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513203219,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513203297,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513203853,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513203853,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1513203894,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"tools/cmd/sdc-usbkey.js","type":"MODIFIED","insertions":31,"deletions":-7},{"file":"tools/lib/oscmds.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"tools/lib/usbkey.js","type":"MODIFIED","insertions":265,"deletions":-95}],"sizeInsertions":299,"sizeDeletions":-103},"patchSets":[{"number":"1","revision":"27bb23b64399cd4b4acd46a8d41e21489365cb99","parents":["fb5168bc0876c5acc74d18c89a9c5a78578112e5"],"ref":"refs/changes/32/3032/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1512424685,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1512424716,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"tools/cmd/sdc-usbkey.js","line":145,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: extra comma is not recommended in array initializers"},{"file":"tools/lib/usbkey.js","line":141,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon for lambda assignment"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/cmd/sdc-usbkey.js","type":"MODIFIED","insertions":14,"deletions":-3},{"file":"tools/lib/oscmds.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"tools/lib/usbkey.js","type":"MODIFIED","insertions":78,"deletions":-32}],"sizeInsertions":95,"sizeDeletions":-36},{"number":"2","revision":"714b691552586ce7ffd69b71df8440c85cc635cc","parents":["fb5168bc0876c5acc74d18c89a9c5a78578112e5"],"ref":"refs/changes/32/3032/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1512424893,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512424975,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1512429837,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"tools/lib/usbkey.js","line":474,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"The ticket says that in this case we wanted to umount and remount with the correct options, is that not the case?"},{"file":"tools/lib/usbkey.js","line":474,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"That is the case. My understanding is that if there are different mount options here this function, usbkey_mount_status_common(), will return a \u0027status\u0027 object that does NOT have \u0027status.steps.options_ok\u0027 and when attempting to mount it\u0027ll hit this code path: https://github.com/joyent/sdc-headnode/blob/master/tools/lib/usbkey.js#L613-L618\nwhich will unmoiunt and re-mount."},{"file":"tools/lib/usbkey.js","line":474,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Ah, ok. I see. That\u0027s not a new feature then. Great!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/cmd/sdc-usbkey.js","type":"MODIFIED","insertions":13,"deletions":-2},{"file":"tools/lib/oscmds.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"tools/lib/usbkey.js","type":"MODIFIED","insertions":78,"deletions":-32}],"sizeInsertions":94,"sizeDeletions":-35},{"number":"3","revision":"63938dd40b398037f0e506f7c781c153a3977f50","parents":["fb5168bc0876c5acc74d18c89a9c5a78578112e5"],"ref":"refs/changes/32/3032/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513197906,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513197986,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"tools/cmd/sdc-usbkey.js","line":127,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I\u0027m not sure I understand why we need the alt_ prefix here. Is that because these \"mount options\" can only ever be used by the \"alt\" mount?"},{"file":"tools/cmd/sdc-usbkey.js","line":127,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The intent is to separate \"alt_mount_options\" (alternative),  which are an object that includes only the mount options that differ from the defaults, from \"mount_options\", which are the merge of any given alt_mount_options and the DEFAULT_MOUNT_OPTIONS."},{"file":"tools/cmd/sdc-usbkey.js","line":127,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok"},{"file":"tools/lib/usbkey.js","line":444,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"those are some seriously experienced mount options."},{"file":"tools/lib/usbkey.js","line":444,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"exp\" \u003d\u003d\u003d expected here.\nShould I clarify in the comments, do you think?"},{"file":"tools/lib/usbkey.js","line":444,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nah, I figured it out eventually. If you were going to do anything, I\u0027d suggest just using: expected_mount_options, but if that\u0027s too long I guess this is fine."},{"file":"tools/lib/usbkey.js","line":483,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"did this intentionally get indented an extra level, or is gerrit lying to me?"},{"file":"tools/lib/usbkey.js","line":483,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yes-ish. I don\u0027t have a consistent pattern for `if (`-test-case indentation. I started re-flowing this section because the added \"exp_\" threw it over 80.\n\nI can re-adjust if you like, or just wait for the coming prettier-ification. :)"},{"file":"tools/lib/usbkey.js","line":483,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Nah, it\u0027s fine. Just looked like a mistake so I figured I\u0027d point it out."},{"file":"tools/lib/usbkey.js","line":840,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"The function name I think makes more sense as \"get_mountpoint\" still, since it\u0027s still only getting 1. It just has 2 choices. Right?"},{"file":"tools/lib/usbkey.js","line":840,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"`get_mountpoints` is returning two strings that are potential mountpoint paths. That feels plural to me. I don\u0027t care strongly though.\n\nThe code below is what reduces from 2 to 1 mountpoint path."},{"file":"tools/lib/usbkey.js","line":840,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Right, ok. Fine with me. :)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"tools/cmd/sdc-usbkey.js","type":"MODIFIED","insertions":31,"deletions":-7},{"file":"tools/lib/oscmds.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"tools/lib/usbkey.js","type":"MODIFIED","insertions":262,"deletions":-95}],"sizeInsertions":296,"sizeDeletions":-103},{"number":"4","revision":"8ed23460cc36da3dae0525ef8a2772b3b4a75792","parents":["4700d836e0caa529de321618f9b94670c1960ac3"],"ref":"refs/changes/32/3032/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513198016,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513198099,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513200191,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513201313,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/cmd/sdc-usbkey.js","type":"MODIFIED","insertions":31,"deletions":-7},{"file":"tools/lib/oscmds.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"tools/lib/usbkey.js","type":"MODIFIED","insertions":262,"deletions":-95}],"sizeInsertions":296,"sizeDeletions":-103},{"number":"5","revision":"7b9ed57fde79be7afe9c69e3ca7526d3cdcf9c3a","parents":["4700d836e0caa529de321618f9b94670c1960ac3"],"ref":"refs/changes/32/3032/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513203219,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513203297,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1513203894,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513203853,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513203853,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"tools/cmd/sdc-usbkey.js","type":"MODIFIED","insertions":31,"deletions":-7},{"file":"tools/lib/oscmds.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"tools/lib/usbkey.js","type":"MODIFIED","insertions":265,"deletions":-95}],"sizeInsertions":299,"sizeDeletions":-103}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}