{"project":"joyent/node-mname","branch":"master","topic":"MANTA-3141","id":"I3412a7178a1bfe5130714b8cbc8cf466862ebfd2","number":"3544","subject":"MANTA-3141 binder saturated, manta sadness ensues Reviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/3544","commitMessage":"MANTA-3141 binder saturated, manta sadness ensues\nReviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1520295907,"lastUpdated":1520887976,"open":false,"status":"MERGED","comments":[{"timestamp":1520295907,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1520296104,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1520373497,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(16 comments)"},{"timestamp":1520400520,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1520400549,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(10 comments)\n\nThanks for taking a look, Dave!  I\u0027ve made some changes to the file based on your feedback, and made a list of deferred work for the future."},{"timestamp":1520475398,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520475422,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520476362,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520493323,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Topic set to MANTA-3141"},{"timestamp":1520639912,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1520642288,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4."},{"timestamp":1520642313,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520642354,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1520642888,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1520642912,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1\n\nAny remaining feedback is to be addressed in follow-up changes."},{"timestamp":1520887577,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1520887949,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1520887976,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"5","revision":"3412a7178a1bfe5130714b8cbc8cf466862ebfd2","parents":["b900b1562e47b0bc0406f83337aacd945b9424f3"],"ref":"refs/changes/44/3544/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520887949,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520642313,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642888,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642912,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520887577,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1520887976,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/balancer.js","type":"ADDED","insertions":326,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":257,"deletions":-132},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":589,"sizeDeletions":-136},"patchSets":[{"number":"1","revision":"66f41f214284ab1acc4d08ca315e4a9062d68a93","parents":["b900b1562e47b0bc0406f83337aacd945b9424f3"],"ref":"refs/changes/44/3544/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520295907,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520475398,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/balancer.js","type":"ADDED","insertions":406,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-131},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":663,"sizeDeletions":-135},{"number":"2","revision":"b0a23f7389906eed3f7ccd727c445e511f9a74b6","parents":["b900b1562e47b0bc0406f83337aacd945b9424f3"],"ref":"refs/changes/44/3544/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520296104,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520475422,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should the balancer functionality be documented here?"},{"file":"docs/index.md","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"There are a lot of changes that need to be made to bring this documentation into sync with the current state of the library, but I\u0027d like to defer that work for now."},{"file":"docs/index.md","line":115,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like there are a bunch of other close-related changes here?"},{"file":"lib/balancer.js","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"There don\u0027t seem to be any automated tests for any of this.\n\nIt seems like it might also be useful to check this facility for memory leaks as we accept large numbers of both UDP packets and TCP connections, in both normal and error cases."},{"file":"lib/balancer.js","line":40,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I wonder if there\u0027s anything that\u0027s missing in this sort of translation -- for example, settings like SO_KEEPALIVE, send/receive buffer sizes, timeouts, and the like.  (I wonder what haproxy does to handle these cases.)"},{"file":"lib/balancer.js","line":40,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Well, in the load balancer today we enable keepalives for all the TCP connections we receive:\n\nhttps://github.com/joyent/mname-balancer/blob/master/deps/libcloop/src/cserver.c#L952-L973\n\nAny tuning we need would have to be configured in the load balancer itself, or we would need to extend the protocol to allow the backend to request such an adjustment.\n\nWith respect to timeouts for inactivity, etc, these are effectively driven by the backend closing the connection when it\u0027s finished with it."},{"file":"lib/balancer.js","line":44,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it not worthwhile to have a magic value or major version at the start?"},{"file":"lib/balancer.js","line":44,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"At this point I\u0027d like to defer all non-critical changes to the protocol until a possible follow-up later."},{"file":"lib/balancer.js","line":66,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Might we want the destination IP address and port number here, in case we support different behavior on different interfaces?"},{"file":"lib/balancer.js","line":80,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same question about the destination IP and port."},{"file":"lib/balancer.js","line":90,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Would it be worthwhile to include timestamps in these frames?"},{"file":"lib/balancer.js","line":91,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s the behavior of the load balancer if the socket cannot accept more data (i.e., because binder isn\u0027t reading anything)?"},{"file":"lib/balancer.js","line":91,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I did some tests with \"pstop\" on backends, to attempt to simulate this condition.  The load balancer correctly detects that we have not received a heartbeat and marks the backend as faulted.  It attempts a reconnection, but out of line with any request processing from remote peers."},{"file":"lib/balancer.js","line":112,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Similar question about providing the source IP and port here."},{"file":"lib/balancer.js","line":121,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It\u0027s the last \"frame\", but it\u0027s not the last data sent, right?"},{"file":"lib/balancer.js","line":121,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"That\u0027s correct.  As we discussed, I\u0027ve removed the PROTOCOL section from this comment, though, and I\u0027ll work on improving the description in \"mname.balancer.git\" itself."},{"file":"lib/balancer.js","line":249,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I found it pretty confusing that the arguments to `avail()` and `discard()` appear to be in bytes, while the offsets for `readIPv4()` and `readU32()` are in 4-byte units."},{"file":"lib/balancer.js","line":249,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/balancer.js","line":281,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What about read()?  Does that just come from \"self\"?"},{"file":"lib/balancer.js","line":281,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, it does."},{"file":"lib/balancer.js","line":300,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we not emit an error here?  I think this is the equivalent of what Node calls \"socket hang-up\" for HTTP and what node-fast calls a FastProtocolError."},{"file":"lib/balancer.js","line":300,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/balancer.js","line":323,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same -- this is a protocol error."},{"file":"lib/balancer.js","line":323,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/balancer.js","line":387,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think it would be nice to record the peername() and sockname() here, even though it\u0027s likely going to be a UDP path.  (That\u0027s probably more important on the load balancer side of it.)"},{"file":"lib/balancer.js","line":387,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It\u0027s not really clear how (via Node) to get what we would want here, which I imagine is the PID of the remote process."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/balancer.js","type":"ADDED","insertions":406,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":252,"deletions":-132},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":664,"sizeDeletions":-136},{"number":"3","revision":"c4a2c8ed090610eb71c275266748e36e6cca1689","parents":["b900b1562e47b0bc0406f83337aacd945b9424f3"],"ref":"refs/changes/44/3544/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520400520,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520476362,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/balancer.js","line":175,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This should be `\u0027error\u0027`."},{"file":"lib/balancer.js","line":175,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/balancer.js","type":"ADDED","insertions":321,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":257,"deletions":-132},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":584,"sizeDeletions":-136},{"number":"4","revision":"b519bf7f16a6e2dd0cada405882f07d54fe458f7","parents":["b900b1562e47b0bc0406f83337aacd945b9424f3"],"ref":"refs/changes/44/3544/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520642288,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642912,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520887577,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642888,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520642313,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/balancer.js","type":"ADDED","insertions":326,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":257,"deletions":-132},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":589,"sizeDeletions":-136},{"number":"5","revision":"3412a7178a1bfe5130714b8cbc8cf466862ebfd2","parents":["b900b1562e47b0bc0406f83337aacd945b9424f3"],"ref":"refs/changes/44/3544/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520887949,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642912,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520887577,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642888,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1520887976,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520642313,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/balancer.js","type":"ADDED","insertions":326,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":257,"deletions":-132},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":589,"sizeDeletions":-136}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}