From 06dd0abc315c7a3b55e164cb007e0a0f7519cf1e Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Mon, 12 Jun 2017 16:56:21 -0700
Subject: [PATCH] DOCKER-1066 sdc-docker should expose current config

---
 lib/endpoints/admin/config.js             | 79 ++++++++++++++++++++++
 lib/endpoints/admin/index.js              |  3 +-
 test/integration/api-admin-config.test.js | 82 +++++++++++++++++++++++
 test/runtest.common                       |  4 +-
 tools/jsl.node.conf                       |  1 +
 5 files changed, 167 insertions(+), 2 deletions(-)
 create mode 100644 lib/endpoints/admin/config.js
 create mode 100644 test/integration/api-admin-config.test.js

diff --git a/lib/endpoints/admin/config.js b/lib/endpoints/admin/config.js
new file mode 100644
index 0000000..651717b
--- /dev/null
+++ b/lib/endpoints/admin/config.js
@@ -0,0 +1,79 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2017, Joyent, Inc.
+ */
+
+var assert = require('assert-plus');
+
+//
+// borrowed from bunyan safeCyclesSet, modified to not dump:
+//
+//  * buffer contents
+//  * bunyan Loggers
+//  * passwords
+//
+function safeCycles() {
+    var seen = new Set();
+
+    return function (key, val) {
+        if (!val || typeof (val) !== 'object') {
+            if (key.match(/password/i)) {
+                return '[Password]';
+            }
+            return val;
+        }
+
+        if (seen.has(val)) {
+            return '[Circular]';
+        }
+
+        if (Buffer.isBuffer(val)) {
+            return '[Buffer]';
+        }
+
+        if (Array.isArray(val) && val.length > 10) {
+            return '[Array ' + val.length + ']';
+        }
+
+        if (val.constructor.name === 'Logger') {
+            return '[Logger]';
+        }
+
+        seen.add(val);
+        return val;
+    };
+}
+
+
+/**
+ * GET /admin/config
+ */
+function adminGetConfig(req, res, next) {
+    assert.object(req, 'req');
+    assert.object(req.app, 'req.app');
+    assert.object(req.app.config, 'req.app.config');
+
+    var safeConfig = JSON.parse(JSON.stringify(req.app.config, safeCycles()));
+
+    res.send(200, safeConfig);
+    next();
+}
+
+
+/**
+ * Register all endpoints with the restify server
+ */
+function register(http, before) {
+    http.get({ path: '/admin/config', name: 'AdminGetConfig' },
+        before, adminGetConfig);
+}
+
+
+module.exports = {
+    register: register
+};
diff --git a/lib/endpoints/admin/index.js b/lib/endpoints/admin/index.js
index 749b440..94852c5 100644
--- a/lib/endpoints/admin/index.js
+++ b/lib/endpoints/admin/index.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 
@@ -15,6 +15,7 @@
  *   /containers -> containers.js
  */
 var toRegister = {
+    '/admin/config': require('./config'),
     '/admin/progress': require('./progress'),
     '/admin/images': require('./images'),
     '/admin/image_tags': require('./image-tags')
diff --git a/test/integration/api-admin-config.test.js b/test/integration/api-admin-config.test.js
new file mode 100644
index 0000000..14a8a32
--- /dev/null
+++ b/test/integration/api-admin-config.test.js
@@ -0,0 +1,82 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright (c) 2017, Joyent, Inc.
+ */
+
+/*
+ * Tests for the /admin/config endpoint
+ */
+
+var restify = require('restify');
+var test = require('tape');
+
+var adminClient;
+
+// include the fields from the sapi template
+var EXPECTED_FIELDS = [
+    'account_allowed_dcs',
+    'account_allowed_dcs_msg',
+    'adminUuid',
+    'backend',
+    'binder',
+    'cnapi',
+    'datacenterName',
+    'defaultMaxLogSize',
+    'defaultMemory',
+    'dockerRegistryInsecure',
+    'enabledLogDrivers',
+    'externalNetwork',
+    'fwapi',
+    'httpProxy',
+    'imgapi',
+    'logLevel',
+    'moray',
+    'napi',
+    'overlay',
+    'packagePrefix',
+    'papi',
+    'port',
+    'tls',
+    'ufds',
+    'useTls',
+    'vmapi',
+    'wfapi'
+];
+
+// --- Tests
+
+test('setup', function (tt) {
+    tt.test(' create admin client', function (t) {
+        t.ok(process.env.DOCKER_ADMIN_URL, 'have DOCKER_ADMIN_URL: '
+            + JSON.stringify(process.env.DOCKER_ADMIN_URL));
+
+        adminClient = restify.createJsonClient({
+            url: process.env.DOCKER_ADMIN_URL
+        });
+        t.ok(adminClient, 'created a restify client');
+
+        t.end();
+    });
+});
+
+test('test /admin/config', function (tt) {
+    tt.test(' GET /admin/config', function (t) {
+        adminClient.get('/admin/config', function onConfig(err, req, res, obj) {
+            t.ifErr(err, 'getting config should succeed');
+
+            t.ok(obj, 'have config object');
+
+            EXPECTED_FIELDS.forEach(function checkExpectedField(field) {
+                t.ok(obj.hasOwnProperty(field), 'config should have ' + field
+                    + ', got: ' + JSON.stringify(obj[field]));
+            });
+
+            t.end();
+        });
+    });
+});
diff --git a/test/runtest.common b/test/runtest.common
index e2b93f4..545d2fa 100644
--- a/test/runtest.common
+++ b/test/runtest.common
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright 2016, Joyent, Inc.
+# Copyright 2017, Joyent, Inc.
 #
 
 #
@@ -33,6 +33,8 @@ fi
 
 # Gather DC data.
 export DOCKER_UUID="$(vmadm lookup -j alias=docker0 | json 0.uuid)"
+export DOCKER_ADMIN_URL="http://$(vmadm lookup -j alias=docker0 | json 0.nics \
+    | json -c 'this.nic_tag==="admin"' 0.ip)"
 export DOCKER_URL="https://$(vmadm lookup -j alias=docker0 | json 0.nics \
     | json -c 'this.nic_tag==="external"' 0.ip):2376"
 export FWAPI_URL="http://$(vmadm lookup -j alias=fwapi0 | json 0.nics \
diff --git a/tools/jsl.node.conf b/tools/jsl.node.conf
index 2efa341..967b551 100644
--- a/tools/jsl.node.conf
+++ b/tools/jsl.node.conf
@@ -125,6 +125,7 @@
 +define Buffer
 +define JSON
 +define Math
++define Set
 
 ### JavaScript Version
 # To change the default JavaScript version:
-- 
2.21.0

