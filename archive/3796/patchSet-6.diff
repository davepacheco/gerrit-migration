From a267b636229541c03c5913d1ad4f4a642de9849f Mon Sep 17 00:00:00 2001
From: Mike Gerdts <mike.gerdts@joyent.com>
Date: Tue, 10 Apr 2018 16:24:16 +0000
Subject: [PATCH] OS-6863 presetate should enforce zlog-name

---
 .../generic/usr/lib/brand/jcommon/statechange | 85 +++++++++++++++----
 .../usr/lib/brand/joyent-minimal/statechange  |  8 +-
 .../generic/usr/lib/brand/joyent/statechange  |  8 +-
 overlay/generic/usr/lib/brand/lx/statechange  |  8 +-
 src/vm/node_modules/VM.js                     |  5 ++
 src/vm/node_modules/proptable.js              |  2 +
 6 files changed, 95 insertions(+), 21 deletions(-)

diff --git a/overlay/generic/usr/lib/brand/jcommon/statechange b/overlay/generic/usr/lib/brand/jcommon/statechange
index 2678b0fa..4f61a02a 100644
--- a/overlay/generic/usr/lib/brand/jcommon/statechange
+++ b/overlay/generic/usr/lib/brand/jcommon/statechange
@@ -794,27 +794,76 @@ cleanup_mount()
 	    id_gz_sockholder /var/run/.smartdc-amon.sock
 }
 
+function fix_forced_attrs {
+	typeset attr
+
+	for attr in ${!FORCED_ATTRS[@]}; do
+		typeset nval=${FORCED_ATTRS["$attr"]}
+		typeset -n envvar=_ZONECFG_attr_${attr//-/_}
+		typeset cval=$envvar
+
+		if [[ $cval == $nval ]]; then
+			# In most cases, $nval and $cval will be the same and
+			# nothing needs to be done. This includes the case where
+			# $nval and $cval are "".
+			continue
+		elif [[ -z $nval ]]; then
+			logger -p daemon.error "[zone $ZONENAME]" \
+			    "Illegal value for attr '$attr': '$cval'." \
+			    "Removing attr '$attr'"
+			zonecfg -z "$ZONENAME" "remove -F attr name=$attr"
+
+			unset ${!envvar}
+		else
+			logger -p daemon.error "[zone $ZONENAME]" \
+			    "Illegal value for attr '$attr': '$cval'." \
+			    "Setting to '$nval'"
+			zonecfg -z "$ZONENAME" "remove -F attr name=$attr;" \
+			    "add attr; set type=string;" \
+			    "set name=$attr; set value=\"$nval\"; end;"
+
+			export ${!envvar}="$nval"
+		fi
+	done
+}
+
 #
 # Main
 #
 
-[[ "$subcommand" == "pre" && $cmd == 0 ]] && setup_fs
-if [[ "$subcommand" == "post" && $cmd == 0 ]]; then
-	[[ -n "$jst_showsnap" ]] && setup_snapshots
-	setup_net
-	setup_fw
-fi
-
-# We can't set a rctl until we have a process in the zone to grab
-[[ "$subcommand" == "post" && $cmd == 1 ]] && setup_cpu_baseline
-
-# Zone halt is hung unmounting, try to recover
-[[ "$subcommand" == "post" && $state == 6 && $cmd == 8 ]] && \
-    cleanup_mount "$6"
-
-if [[ "$subcommand" == "pre" && $cmd == 4 ]]; then
-	[[ -n "$jst_snowsnap" ]] && cleanup_snapshots
-	cleanup_net
-fi
+case $subcommand in
+pre)
+	case $cmd in
+	0)	# pre-ready
+		fix_forced_attrs
+		setup_fs
+		;;
+	4)	# pre-halt
+		[[ -n "$jst_snowsnap" ]] && cleanup_snapshots
+		cleanup_net
+		;;
+	esac
+	;;
+post)
+	case $cmd in
+	0)	# post-ready
+		[[ -n "$jst_showsnap" ]] && setup_snapshots
+		setup_net
+		setup_fw
+		;;
+	1)	# post-boot
+		# We can't set a rctl until we have a process in the zone to
+		# grab
+		setup_cpu_baseline
+		;;
+	8)	# post-unmount
+		# Zone halt is hung unmounting, try to recover
+		if [[ $state == 6 ]]; then
+			cleanup_mount "$6"
+		fi
+		;;
+	esac
+	;;
+esac
 
 exit 0
diff --git a/overlay/generic/usr/lib/brand/joyent-minimal/statechange b/overlay/generic/usr/lib/brand/joyent-minimal/statechange
index 22731cf6..5e2eeff0 100755
--- a/overlay/generic/usr/lib/brand/joyent-minimal/statechange
+++ b/overlay/generic/usr/lib/brand/joyent-minimal/statechange
@@ -12,7 +12,7 @@
 #
 
 #
-# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+# Copyright (c) 2018 Joyent, Inc.  All rights reserved.
 #
 
 # Do we support vrrp?
@@ -33,4 +33,10 @@ jst_showsnap="yes"
 # Where does the mdata socket live?
 jst_mdatapath="/.zonecontrol/"
 
+# Ensure docker zfd(7D) log is not put in the wrong place
+if [[ "$_ZONECFG_attr_docker" == true ]]; then
+	typeset -A FORCED_ATTRS
+	FORCED_ATTRS["zlog-name"]=
+fi
+
 . /usr/lib/brand/jcommon/statechange
diff --git a/overlay/generic/usr/lib/brand/joyent/statechange b/overlay/generic/usr/lib/brand/joyent/statechange
index 22731cf6..5e2eeff0 100755
--- a/overlay/generic/usr/lib/brand/joyent/statechange
+++ b/overlay/generic/usr/lib/brand/joyent/statechange
@@ -12,7 +12,7 @@
 #
 
 #
-# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+# Copyright (c) 2018 Joyent, Inc.  All rights reserved.
 #
 
 # Do we support vrrp?
@@ -33,4 +33,10 @@ jst_showsnap="yes"
 # Where does the mdata socket live?
 jst_mdatapath="/.zonecontrol/"
 
+# Ensure docker zfd(7D) log is not put in the wrong place
+if [[ "$_ZONECFG_attr_docker" == true ]]; then
+	typeset -A FORCED_ATTRS
+	FORCED_ATTRS["zlog-name"]=
+fi
+
 . /usr/lib/brand/jcommon/statechange
diff --git a/overlay/generic/usr/lib/brand/lx/statechange b/overlay/generic/usr/lib/brand/lx/statechange
index d4c434e8..d0bc11ee 100755
--- a/overlay/generic/usr/lib/brand/lx/statechange
+++ b/overlay/generic/usr/lib/brand/lx/statechange
@@ -11,7 +11,7 @@
 #
 
 #
-# Copyright (c) 2014 Joyent, Inc.  All rights reserved.
+# Copyright (c) 2018 Joyent, Inc.  All rights reserved.
 #
 
 # Do we support vrrp?
@@ -32,4 +32,10 @@ jst_showsnap="yes"
 # Where does the mdata socket live?
 jst_mdatapath="/native/.zonecontrol/"
 
+# Ensure docker zfd(7D) log is not put in the wrong place
+if [[ "$_ZONECFG_attr_docker" == true ]]; then
+	typeset -A FORCED_ATTRS
+	FORCED_ATTRS["zlog-name"]=
+fi
+
 . /usr/lib/brand/jcommon/statechange
diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index ee4fbe72..f0f360f4 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -6097,6 +6097,11 @@ function buildZonecfgUpdate(vmobj, payload, log)
         setAttr('com2', 'com2');
 
         setAttr('bhyve-extra-opts', 'bhyve_extra_opts');
+
+        payload.zlog_mode = 'g--';
+        payload.zlog_name = 'platform.log';
+        setAttr('zlog-mode', 'zlog_mode');
+        setAttr('zlog-name', 'zlog_name');
     }
 
     // NOTE: Thanks to normalizePayload() we'll only have these when relevant
diff --git a/src/vm/node_modules/proptable.js b/src/vm/node_modules/proptable.js
index fd698311..714d0fef 100644
--- a/src/vm/node_modules/proptable.js
+++ b/src/vm/node_modules/proptable.js
@@ -1977,6 +1977,8 @@ exports.properties = {
             min: 0
         },
         zonexml: 'zone.rctl.zone.zfs-io-priority.privileged.none'
+    }, zlog_name: {
+        zonexml: 'zone.attr.zlog-name'
     }, zlog_mode: {
         zonexml: 'zone.attr.zlog-mode'
     }, zlog_max_size: {
-- 
2.21.0

