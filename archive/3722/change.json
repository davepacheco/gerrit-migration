{"project":"joyent/smartos-live","branch":"master","id":"Idbc853fb73ca7455bee991e97a70822c3b69bdde","number":"3722","subject":"OS-6828 \"vmadm sysrq \u003cuuid\u003e nmi\" should send NMI to bhyve guest Reviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e Approved by: Jason King \u003cjason.king@joyent.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/3722","commitMessage":"OS-6828 \"vmadm sysrq \u003cuuid\u003e nmi\" should send NMI to bhyve guest\nReviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1521954591,"lastUpdated":1522290802,"open":false,"status":"MERGED","comments":[{"timestamp":1521954591,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1521954593,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 2a94cd771ce55899ae7b9c7287466d01e39285b9\n    \n    implement sysrq nmi for bhyve"},{"timestamp":1521954639,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522039180,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1522108258,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1522109750,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1522109751,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 35e254e18144b3bde232f744bad9a116bdc517ca\n    \n    update based on CR feedback"},{"timestamp":1522109797,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522148572,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1522148618,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2: Code-Review+1\n\nI don\u0027t feel qualified to give an IA to this codebase. So just a CR+1 from me!"},{"timestamp":1522193773,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1522193775,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit f011bfc105c59a7eee55726898ac47a4e17688a9\n    \n    update based on CR feedback"},{"timestamp":1522193798,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1522193819,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522275891,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1522286159,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1522290744,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1522290756,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1522290761,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"},{"timestamp":1522290802,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"64df0211f2032b8e7177e36b0c06007da6ea6b03","parents":["a8ef68d4fbd678c3f9ad8506bae053777dee22f7"],"ref":"refs/changes/22/3722/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522290756,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522193819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275891,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522286159,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1522290761,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/etc/vmadm.completion","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":13,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":73,"deletions":-9},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"src/vm/node_modules/vmload/vmload-zoneadm.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-send-recv.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"src/vm/tests/test-vmload-zoneadm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":117,"sizeDeletions":-22},"patchSets":[{"number":"1","revision":"ff12470864df11f5109fd2c94cdee44fae454d9b","parents":["abf3fa4b0b3b4201ef27c7c608f2fd86e4193b57"],"ref":"refs/changes/22/3722/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1521954591,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1521954639,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/etc/vmadm.completion","line":36,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Oh, that\u0027s evil. Consolations. :)"},{"file":"src/vm/man/vmadm.1m.md","line":2181,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I\u0027d omit this.\n\nFor my own edification, what is the difference between zoneid and zonedid? It doesn\u0027t change on stop/start? (and preferably is this documented anywhere?)"},{"file":"src/vm/man/vmadm.1m.md","line":2181,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"The only documentation I\u0027m aware of is OS-200\n\nAnd yes, zonedid is kept even when the zone is halted. You can see it as the last field in /etc/zones/index. It\u0027s not in the zoneadm man page, but also shows up in zoneadm list -pc."},{"file":"src/vm/man/vmadm.1m.md","line":2181,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Okay. I think it\u0027d be helpful to add a line or two in comments and/or here about what zonedid is. I\u0027m surely not going to be the only one who will wonder about zoneid/zonedid."},{"file":"src/vm/man/vmadm.1m.md","line":2181,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ok"},{"file":"src/vm/node_modules/VM.js","line":14838,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I wonder if it would be more robust to check if this is undefined and err out, rather than the explicit [\u0027bhyve\u0027, \u0027kvm\u0027].indexOf() check above; you won\u0027t need to keep VM.SYSRQ_TYPES and the bhyve/kvm check array in sync."},{"file":"src/vm/node_modules/VM.js","line":14838,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I just tried this out and I think I like the current code better above, because when this changes otherwise, it might be possible to miss the message. In this case when we added bhyve, we just searched for \u0027kvm\u0027 and if we changed that conditional, we\u0027d need something like:\n\n    if (VM.SYSRQ_TYPES[vmobj.brand] !\u003d\u003d undefined \u0026\u0026  vmobj.brand !\u003d\u003d \u0027all\u0027) {\n\nbecause of the \u0027all\u0027 key here. I think it\u0027s simpler and more obvious how it is."},{"file":"src/vm/node_modules/VM.js","line":14848,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Can do a \"options.log \u003d options.log || log\" if you\u0027d rather a one-liner."},{"file":"src/vm/node_modules/VM.js","line":14855,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"So for KVM we call vmadmd, but for bhyve we call bhyvectl directly?\n\nIs there/will there be a ticket for this?"},{"file":"src/vm/node_modules/VM.js","line":14855,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yes, we use bhyvectl for bhyve and vmadmd to talk via QMP to qemu.\n\nRe: ticket, you mean OS-6828?"},{"file":"src/vm/node_modules/VM.js","line":14855,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Ticket: I assume that at some point vmadmd will support this functionality (for bhyve)?"},{"file":"src/vm/node_modules/VM.js","line":14855,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I don\u0027t think vmadmd will ever support this. The design of the bhyve brand is different such that the brand does more of the work here. Also bhyve itself works differently in that there\u0027s no bhyve socket (qemu has a QMP socket) with which to communicate and instead commands are sent via bhyvectl instead."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/etc/vmadm.completion","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":73,"deletions":-9},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"src/vm/node_modules/vmload/vmload-zoneadm.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-send-recv.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"src/vm/tests/test-vmload-zoneadm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":116,"sizeDeletions":-22},{"number":"2","revision":"236392737f784af4f1cd50b774361d2155b5c6ef","parents":["abf3fa4b0b3b4201ef27c7c608f2fd86e4193b57"],"ref":"refs/changes/22/3722/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522109750,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522109797,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522148618,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/etc/vmadm.completion","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":73,"deletions":-9},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"src/vm/node_modules/vmload/vmload-zoneadm.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-send-recv.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"src/vm/tests/test-vmload-zoneadm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":116,"sizeDeletions":-22},{"number":"3","revision":"42a01c2ea35fc8aeffa4bd06778bcf1fa0893b22","parents":["abf3fa4b0b3b4201ef27c7c608f2fd86e4193b57"],"ref":"refs/changes/22/3722/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522193773,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522193819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275891,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522286159,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/etc/vmadm.completion","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":13,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":73,"deletions":-9},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"src/vm/node_modules/vmload/vmload-zoneadm.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-send-recv.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"src/vm/tests/test-vmload-zoneadm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":117,"sizeDeletions":-22},{"number":"4","revision":"dbc853fb73ca7455bee991e97a70822c3b69bdde","parents":["abf3fa4b0b3b4201ef27c7c608f2fd86e4193b57"],"ref":"refs/changes/22/3722/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522290744,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522193819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275891,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522286159,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/etc/vmadm.completion","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":13,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":73,"deletions":-9},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"src/vm/node_modules/vmload/vmload-zoneadm.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-send-recv.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"src/vm/tests/test-vmload-zoneadm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":117,"sizeDeletions":-22},{"number":"5","revision":"64df0211f2032b8e7177e36b0c06007da6ea6b03","parents":["a8ef68d4fbd678c3f9ad8506bae053777dee22f7"],"ref":"refs/changes/22/3722/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1522290756,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522193819,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1522290761,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522275891,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522286159,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/etc/vmadm.completion","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":13,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":73,"deletions":-9},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"src/vm/node_modules/vmload/vmload-zoneadm.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"src/vm/tests/test-send-recv.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"src/vm/tests/test-vmload-zoneadm.js","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":117,"sizeDeletions":-22}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}