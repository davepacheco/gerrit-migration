{"project":"joyent/sdc-cnapi","branch":"master","id":"Ib2ad3270e650fa617453621e89f7118cd13a43b9","number":"1796","subject":"CNAPI-706: Add a command in bin/ which shows the reasoning behind dapi\u0027s most recent allocation Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/1796","commitMessage":"CNAPI-706: Add a command in bin/ which shows the reasoning behind dapi\u0027s most recent allocation\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1492413992,"lastUpdated":1493235939,"open":false,"status":"MERGED","comments":[{"timestamp":1492413992,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1492414024,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492447822,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nMarsell,\n\nPerhaps this could steal from https://mo.joyent.com/trentops/blob/master/bin/dapi-snapshots  which (a) takes a VM or Job uuid (though it would perhaps be nice to have an option to dump the DAPI snapshot for the \"last\" allocation); and (b) handles the case where DAPI does multiple batches of 50 CNs for a single allocation run."},{"timestamp":1492517059,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 2."},{"timestamp":1492517092,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492539715,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1492549140,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1492553172,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1492593061,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 3."},{"timestamp":1492593094,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1493058731,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1493067848,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1493148435,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)\n\nCode looks good to me, but running that script in my COAL\u0027s CNAPI zone does not output anything, even though I just had run VMAPI\u0027s test/vms.full.test.js before, and so I assume that allocations took place. Are you able to list allocations in your COAL with this script?"},{"timestamp":1493153350,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 3:\n\n(1 comment)\n\n\u003e Code looks good to me, but running that script in my COAL\u0027s CNAPI\n \u003e zone does not output anything, even though I just had run VMAPI\u0027s\n \u003e test/vms.full.test.js before, and so I assume that allocations took\n \u003e place. Are you able to list allocations in your COAL with this\n \u003e script?\n\nYes, it works for me.\n\nvms.full.test.js provides a server_uuid in create_vm(), which bypasses dapi, ergo this script will find nothing.\n\nBut thanks for testing! :D"},{"timestamp":1493154736,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(1 comment)\n\nAlso, thanks for clarifying why I wouldn\u0027t get any output from this script after running VMAPI\u0027s tests. I did another test after running a \"docker run...\" and the script outputted the latest allocation correctly."},{"timestamp":1493209594,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 4."},{"timestamp":1493209621,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1493231114,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1493231118,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1493231419,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1493232829,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1493235895,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1493235939,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"5","revision":"b2ad3270e650fa617453621e89f7118cd13a43b9","parents":["822cbcacc6839af73a842cda363979a33e40343a"],"ref":"refs/changes/96/1796/5","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1493235895,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493209621,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493231114,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493231118,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1493235939,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/alloc-reasons.sh","type":"ADDED","insertions":62,"deletions":0}],"sizeInsertions":62,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"562caf202d6c7293f641dc0d9012a119c01ea799","parents":["822cbcacc6839af73a842cda363979a33e40343a"],"ref":"refs/changes/96/1796/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1492413992,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492414024,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/alloc-reasons.sh","type":"ADDED","insertions":26,"deletions":0}],"sizeInsertions":26,"sizeDeletions":0},{"number":"2","revision":"ac553640e4f1740af69e87d1178e52d327651a4e","parents":["822cbcacc6839af73a842cda363979a33e40343a"],"ref":"refs/changes/96/1796/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1492517059,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492517092,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/alloc-reasons.sh","line":16,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we also support passing in a job uuid?"},{"file":"bin/alloc-reasons.sh","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can this be factored out into a separate function to avoid duplication?"},{"file":"bin/alloc-reasons.sh","line":36,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Sure, but how would I do that when the only difference between the two commands is the tail -1 in the middle of one of them?"},{"file":"bin/alloc-reasons.sh","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I hadn\u0027t seen the \"tail -1\" in the second pipeline. We might be able to use \"/bin/sh -c\" and construct the whole pipeline dynamically. I\u0027m not sure how tedious that would be, but if it ends up not being too complex, it might be worth it.\n\nI would not consider this a blocker though if we can\u0027t find a solution that is not too complex."},{"file":"bin/alloc-reasons.sh","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Ok, then"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/alloc-reasons.sh","type":"ADDED","insertions":50,"deletions":0}],"sizeInsertions":50,"sizeDeletions":0},{"number":"3","revision":"4608bbf7078383cf8ddbffab33cf9cf87000c620","parents":["822cbcacc6839af73a842cda363979a33e40343a"],"ref":"refs/changes/96/1796/3","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1492593061,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492593094,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493148435,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"bin/alloc-reasons.sh","line":48,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why do we need to pipe to \"tail -$MAX_RESULTS\"?"},{"file":"bin/alloc-reasons.sh","line":48,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Simplest way to keep the tail -1, which is used when grepping for \"snapshot\" instead of a specific request_id."},{"file":"bin/alloc-reasons.sh","line":48,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Ok, it seems a bit hacky and that it could potentially miss snapshots in some edge case? Maybe deduplicating that pipeline is not worth it after all. I\u0027ll let you determine the best course of action here, I don\u0027t want to make you do more work than what I\u0027ve done already."},{"file":"bin/alloc-reasons.sh","line":48,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"It\u0027s definitely hacky, but it\u0027s a hack that works. :)\n\nIf we have more than 9999 results, then we either have a pretty bad bug somewhere in the stack, or a single DC with nearly 1M servers.\n\nAs for the \"snapshot\" case, which does a tail -1: yes, it can definitely miss servers if dapi was invoked multiple times for the same allocations, but if no VM UUID or request_id was provided then there isn\u0027t any way to catch all the lines without resorting to a two-pass algorithm.\n\nBut perhaps in the \"snapshot\" case a warning should be printed to stderr about this? E.g. \"Warnong: allocations may be missed if a VM UUID or request ID isn\u0027t provided?\""},{"file":"bin/alloc-reasons.sh","line":48,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Warning could be a good idea, or making the default behavior require an ID and introducing a \"latest\" command line parameter that is documented to have limitations.\n\nWhatever works for you, I realize we\u0027ve been back and forth on this many times and I don\u0027t want to waste more of your time for something that is good enough."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/alloc-reasons.sh","type":"ADDED","insertions":52,"deletions":0}],"sizeInsertions":52,"sizeDeletions":0},{"number":"4","revision":"0f5fbd9b2ea3e18512a84252494558260095bfaa","parents":["822cbcacc6839af73a842cda363979a33e40343a"],"ref":"refs/changes/96/1796/4","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1493209594,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493209621,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493231114,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493231118,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"bin/alloc-reasons.sh","line":33,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Pardon my ignorance: why using 1\u003e\u00262 here? I understand what it does, but I don\u0027t understand why we\u0027d want to use that here."},{"file":"bin/alloc-reasons.sh","line":33,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"The command was used incorrectly.\n\nI don\u0027t have a strong opinion on the matter, so if you think this should go to stdout, I\u0027ll change it."},{"file":"bin/alloc-reasons.sh","line":33,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sorry, I don\u0027t know why I confused this for some sort of --help support instead of the usage outputted when the command line is invalid. I agree it\u0027s better to redirect the output to stderr in this case."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/alloc-reasons.sh","type":"ADDED","insertions":62,"deletions":0}],"sizeInsertions":62,"sizeDeletions":0},{"number":"5","revision":"b2ad3270e650fa617453621e89f7118cd13a43b9","parents":["822cbcacc6839af73a842cda363979a33e40343a"],"ref":"refs/changes/96/1796/5","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1493235895,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493209621,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493231114,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493231118,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1493235939,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/alloc-reasons.sh","type":"ADDED","insertions":62,"deletions":0}],"sizeInsertions":62,"sizeDeletions":0}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}