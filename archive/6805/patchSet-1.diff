From 7c5be73ff6f20bd369049bef160d4d6cb99396da Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 16 Aug 2019 16:22:58 -0700
Subject: [PATCH] TRITON-1869 node-triton needs `triton instance migration
 finalize`

---
 CHANGES.md                                  |  4 +
 lib/cloudapi2.js                            |  3 +-
 lib/do_instance/do_migration/do_finalize.js | 85 +++++++++++++++++++++
 lib/do_instance/do_migration/index.js       |  4 +-
 package.json                                |  2 +-
 test/integration/cli-migrations.test.js     | 25 ++++++
 6 files changed, 120 insertions(+), 3 deletions(-)
 create mode 100644 lib/do_instance/do_migration/do_finalize.js

diff --git a/CHANGES.md b/CHANGES.md
index 0cfd736..b822260 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -6,6 +6,10 @@ Known issues:
 
 ## not yet released
 
+## 7.4.1
+
+- [TRITON-1869] node-triton needs `triton instance migration finalize`.
+
 ## 7.4.0
 
 - [TRITON-1862] Add `triton account limits` support. This returns the
diff --git a/lib/cloudapi2.js b/lib/cloudapi2.js
index 96e3944..6a08995 100644
--- a/lib/cloudapi2.js
+++ b/lib/cloudapi2.js
@@ -1963,7 +1963,8 @@ function machineMigration(opts, cb) {
     assert.optionalArrayOfString(opts.affinity, 'opts.affinity');
     assert.func(cb, 'cb');
 
-    var actions = ['begin', 'sync', 'pause', 'switch', 'automatic', 'abort'];
+    var actions = ['begin', 'sync', 'pause', 'switch', 'automatic', 'abort',
+        'finalize'];
 
     if (actions.indexOf(opts.action) === -1) {
         cb(new errors.TritonError('Unsupported migration action ' +
diff --git a/lib/do_instance/do_migration/do_finalize.js b/lib/do_instance/do_migration/do_finalize.js
new file mode 100644
index 0000000..6713902
--- /dev/null
+++ b/lib/do_instance/do_migration/do_finalize.js
@@ -0,0 +1,85 @@
+/*
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+/*
+ * Copyright 2019 Joyent, Inc.
+ *
+ * `triton instance migration finalize ...`
+ */
+
+var assert = require('assert-plus');
+var vasync = require('vasync');
+
+var common = require('../../common');
+var errors = require('../../errors');
+
+
+function do_finalize(subcmd, opts, args, cb) {
+    assert.func(cb, 'cb');
+
+    if (opts.help) {
+        this.do_help('help', {}, [subcmd], cb);
+        return;
+    }
+
+    if (args.length === 0) {
+        cb(new errors.UsageError('missing <inst> argument'));
+        return;
+    } else if (args.length > 1) {
+        cb(new errors.UsageError('incorrect number of arguments'));
+        return;
+    }
+
+    var inst = args[0];
+    var cli = this.top;
+
+    var finalizeOpts = {
+        userId: opts.userId,
+        id: inst,
+        action: 'finalize'
+    };
+
+    vasync.pipeline({
+        arg: {
+            cli: cli
+        }, funcs: [
+        common.cliSetupTritonApi,
+        function finalizeMigration(ctx, next) {
+            cli.tritonapi.doInstanceMigration(finalizeOpts,
+            function finalizeMigrationCb(err) {
+                if (err) {
+                    next(err);
+                    return;
+                }
+
+                console.log('Done - the migration is finalized');
+                next();
+            });
+        }
+    ]}, cb);
+}
+
+do_finalize.options = [
+    {
+        names: ['help', 'h'],
+        type: 'bool',
+        help: 'Show this help.'
+    }
+];
+
+do_finalize.synopses = ['{{name}} {{cmd}} [OPTIONS] INST'];
+
+do_finalize.help = [
+    'The original source instance will be removed (cleaned up).',
+    '',
+    '{{usage}}',
+    '',
+    '{{options}}'
+].join('\n');
+
+do_finalize.completionArgtypes = ['tritoninstance', 'none'];
+
+module.exports = do_finalize;
diff --git a/lib/do_instance/do_migration/index.js b/lib/do_instance/do_migration/index.js
index 3664b21..318b72f 100644
--- a/lib/do_instance/do_migration/index.js
+++ b/lib/do_instance/do_migration/index.js
@@ -31,7 +31,8 @@ function MigrationCLI(top) {
             'abort',
             'list',
             'automatic',
-            'get'
+            'get',
+            'finalize'
         ]
     });
 }
@@ -50,4 +51,5 @@ MigrationCLI.prototype.do_abort = require('./do_abort');
 MigrationCLI.prototype.do_list = require('./do_list');
 MigrationCLI.prototype.do_get = require('./do_get');
 MigrationCLI.prototype.do_automatic = require('./do_automatic');
+MigrationCLI.prototype.do_finalize = require('./do_finalize');
 module.exports = MigrationCLI;
diff --git a/package.json b/package.json
index 50def24..ad01b1b 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "triton",
   "description": "Joyent Triton CLI and client (https://www.joyent.com/triton)",
-  "version": "7.4.0",
+  "version": "7.4.1",
   "author": "Joyent (joyent.com)",
   "homepage": "https://github.com/joyent/node-triton",
   "dependencies": {
diff --git a/test/integration/cli-migrations.test.js b/test/integration/cli-migrations.test.js
index 5d3aa5e..527a3aa 100644
--- a/test/integration/cli-migrations.test.js
+++ b/test/integration/cli-migrations.test.js
@@ -246,6 +246,31 @@ test('triton instance migration', OPTS, function (tt) {
     });
 
 
+    tt.test('   triton instance migration finalize', function (t) {
+        if (!INST_SHORT) {
+            t.comment('Skipping test. Instance not created');
+            t.end();
+            return;
+        }
+
+        if (!USER_MIGR_ALLOWED) {
+            t.comment('Skipping test. User migration not allowed');
+            t.end();
+            return;
+        }
+        var cmd = ['instance', 'migration', 'finalize', INST_SHORT];
+
+        h.safeTriton(t, cmd, function syncCb(err, stdout, stderr) {
+            if (err) {
+                t.end();
+                return;
+            }
+            t.equal(stdout.trim(), 'Done - the migration is finalized');
+            t.end();
+        });
+    });
+
+
     /*
      * Use a timeout, because '-w' on delete doesn't have a way to know if the
      * attempt failed or if it is just taking a really long time.
-- 
2.21.0

