From ad6a922ce8a03153e991d91aaa7ed08c7b805c95 Mon Sep 17 00:00:00 2001
From: Mark Brooks <mark.brooks@joyent.com>
Date: Tue, 10 Sep 2019 14:05:20 -0400
Subject: [PATCH] OS-7935 infinite loop in mdb ::load

---
 usr/src/cmd/mdb/common/mdb/mdb_module_load.c | 22 +++++++++++---------
 1 file changed, 12 insertions(+), 10 deletions(-)

diff --git a/usr/src/cmd/mdb/common/mdb/mdb_module_load.c b/usr/src/cmd/mdb/common/mdb/mdb_module_load.c
index 811af3dd47..1bb86fb62a 100644
--- a/usr/src/cmd/mdb/common/mdb/mdb_module_load.c
+++ b/usr/src/cmd/mdb/common/mdb/mdb_module_load.c
@@ -22,7 +22,7 @@
 /*
  * Copyright (c) 2004, 2010, Oracle and/or its affiliates. All rights reserved.
  * Copyright (c) 2012 by Delphix. All rights reserved.
- * Copyright (c) 2012 Joyent, Inc. All rights reserved.
+ * Copyright (c) 2019 Joyent, Inc. All rights reserved.
  */
 
 #include <sys/param.h>
@@ -60,21 +60,23 @@ mdb_module_load(const char *name, int mode)
 		/*
 		 * Remove any .so(.[0-9]+)? suffix
 		 */
-		while ((p = strrchr(buf, '.')) != NULL) {
+		if ((p = strrchr(buf, '.')) != NULL) {
 			for (q = p + 1; isdigit(*q); q++)
 				;
 
 			if (*q == '\0') {
-				/* found digits to remove */
-				*p = '\0';
-				continue;
-			}
+				if (q > p + 1) {
 
-			if (strcmp(p, ".so") == 0) {
-				*p = '\0';
-				break;
-			}
+					/* found digits to remove */
+					*p = '\0';
 
+					if ((p = strrchr(buf, '.')) != NULL) {
+						if (strcmp(p, ".so") == 0) {
+							*p = '\0';
+						}
+					}
+				}
+			}
 		}
 		fullname = name;
 		name = buf;
-- 
2.17.2 (Apple Git-113)

