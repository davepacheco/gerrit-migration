From 67b561a4c7d400d8fcfd83c2351718397d417e85 Mon Sep 17 00:00:00 2001
From: Mark Brooks <mark.brooks@joyent.com>
Date: Tue, 10 Sep 2019 14:05:20 -0400
Subject: [PATCH] OS-7935 infinite loop in mdb ::load

---
 usr/src/cmd/mdb/common/mdb/mdb_module_load.c | 19 ++++++-------------
 1 file changed, 6 insertions(+), 13 deletions(-)

diff --git a/usr/src/cmd/mdb/common/mdb/mdb_module_load.c b/usr/src/cmd/mdb/common/mdb/mdb_module_load.c
index 811af3dd47..f1105c9f1b 100644
--- a/usr/src/cmd/mdb/common/mdb/mdb_module_load.c
+++ b/usr/src/cmd/mdb/common/mdb/mdb_module_load.c
@@ -22,7 +22,7 @@
 /*
  * Copyright (c) 2004, 2010, Oracle and/or its affiliates. All rights reserved.
  * Copyright (c) 2012 by Delphix. All rights reserved.
- * Copyright (c) 2012 Joyent, Inc. All rights reserved.
+ * Copyright (c) 2019 Joyent, Inc. All rights reserved.
  */
 
 #include <sys/param.h>
@@ -60,21 +60,14 @@ mdb_module_load(const char *name, int mode)
 		/*
 		 * Remove any .so(.[0-9]+)? suffix
 		 */
-		while ((p = strrchr(buf, '.')) != NULL) {
-			for (q = p + 1; isdigit(*q); q++)
-				;
+		if (p = strstr(buf, ".so.") != NULL) {
+			q = p + strlen(".so.");
 
-			if (*q == '\0') {
-				/* found digits to remove */
-				*p = '\0';
-				continue;
-			}
+			while (isdigit(*q))
+				q++;
 
-			if (strcmp(p, ".so") == 0) {
+			if (*q == '\0')
 				*p = '\0';
-				break;
-			}
-
 		}
 		fullname = name;
 		name = buf;
-- 
2.21.0

