commit 4bf6c8372e906419dcc7232d5e5542e10b9ff7ca (refs/changes/83/2183/1)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2017-07-04T09:25:05+02:00 (2 years, 3 months ago)
    
    TOOLS-1772 Add "--just-update-symlink" option to `sdcadm experimental update-agents`

diff --git a/lib/cli/do_update_agents.js b/lib/cli/do_update_agents.js
index b04760e..40c88c0 100644
--- a/lib/cli/do_update_agents.js
+++ b/lib/cli/do_update_agents.js
@@ -51,6 +51,8 @@ function updateAgents(options, callback) {
     assert.object(options.sdcadm, 'options.sdcadm');
     assert.string(options.agentsshar, 'options.agentsshar');
     assert.optionalBool(options.justDownload, 'options.justDownload');
+    assert.optionalBool(options.justUpdateSymlink,
+        'options.justUpdateSymlink');
     assert.optionalBool(options.yes, 'options.yes');
     assert.optionalBool(options.all, 'options.all');
     assert.optionalArrayOfString(options.servers, 'options.servers');
@@ -58,7 +60,8 @@ function updateAgents(options, callback) {
     assert.func(callback, 'callback');
 
     if ((options.all && options.servers) ||
-        (!options.all && !options.servers)) {
+        (!options.all && !options.servers &&
+         !options.justDownload && !options.justUpdateSymlink)) {
         callback(new errors.UsageError(
             'must specify exactly one of "options.all" or "options.servers"'));
         return;
@@ -76,6 +79,7 @@ function updateAgents(options, callback) {
     var fname;
     var progress = options.progress;
     var justDownload = options.justDownload;
+    var justUpdateSymlink = options.justUpdateSymlink;
     var hist;
 
     function setImageToLatest(cb) {
@@ -135,8 +139,9 @@ function updateAgents(options, callback) {
          * it:
          */
         function urDiscoveryGetReady(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload ||Â justUpdateSymlink) {
+                next();
+                return;
             }
 
             sdcadm.getUrConnection(function (err, urconn) {
@@ -184,6 +189,19 @@ function updateAgents(options, callback) {
             }
         },
 
+        function verifyFilepath(ctx, next) {
+            if (!justUpdateSymlink) {
+                next();
+                return;
+            }
+            if (!filepath) {
+                next(new Error('existing file must be specified when using ' +
+                    '"--just-update-symlink" option'));
+                return;
+            }
+            next();
+        },
+
         /*
          * If we are about to download an image, first check to see if that
          * image is already available locally (verifying via checksum).
@@ -256,14 +274,16 @@ function updateAgents(options, callback) {
         },
 
         function listServers(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
             progress('Finding servers to update');
             // Get all servers to validate if unsetup servers are selected.
             sdcadm.cnapi.listServers({}, function (err, servers) {
                 if (err) {
-                    return next(err);
+                    next(err);
+                    return;
                 }
                 ctx.allServers = servers;
                 next();
@@ -271,8 +291,9 @@ function updateAgents(options, callback) {
         },
 
         function findServersToUpdate(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
 
             if (options.all) {
@@ -327,8 +348,9 @@ function updateAgents(options, callback) {
         },
 
         function urDiscovery(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
 
             common.urDiscovery({
@@ -339,10 +361,11 @@ function updateAgents(options, callback) {
                 urconn: ctx.urconn
             }, function (err, urAvailServers) {
                 if (err) {
-                    return next(err);
+                    next(err);
+                    return;
                 }
                 ctx.urServersToUpdate = urAvailServers;
-                return next();
+                next();
             });
         },
 
@@ -364,32 +387,40 @@ function updateAgents(options, callback) {
                     'Download agentsshar %s\n    (%s)',
                     image.uuid, image.version)));
             }
-            if (!justDownload) {
+            if (!justDownload && !justUpdateSymlink) {
                 progress(common.indent(format(
                     'Update GZ agents on %d (of %d) servers using\n' +
                     '    agentsshar %s', ctx.serversToUpdate.length,
                     ctx.allServers.length,
                     (filepath ? filepath : image.version))));
             }
+            if (justUpdateSymlink && filepath) {
+                progress(common.indent(format('Update ' +
+                    '\'/usbkey/extra/agents/latest\' symkink to %s',
+                    filepath)));
+            }
             progress('');
             if (options.yes) {
-                return next();
+                next();
+                return;
             }
             var msg = 'Would you like to continue? [y/N] ';
             common.promptYesNo({msg: msg, default: 'n'}, function (answer) {
                 if (answer !== 'y') {
                     progress('Aborting agents update');
-                    return callback();
+                    callback();
+                    return;
                 }
                 progress('');
                 startTime = Date.now(); // Reset to not count confirm time.
-                return next();
+                next();
             });
         },
 
         function saveChangesToHistory(_, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
             var change = {
                 service: {
@@ -403,10 +434,11 @@ function updateAgents(options, callback) {
                 changes: [change]
             }, function (err, hst) {
                 if (err) {
-                    return next(err);
+                    next(err);
+                    return;
                 }
                 hist = hst;
-                return next();
+                next();
             });
         },
 
@@ -492,8 +524,9 @@ function updateAgents(options, callback) {
         },
 
         function updateCNAgents(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
 
             progress('Starting agentsshar update on %d servers',
@@ -678,8 +711,9 @@ function updateAgents(options, callback) {
         },
 
         function doCleanup(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
             if (ctx.deleteAgentssharOnFinish) {
                 progress('Deleting temporary %s', filepath);
@@ -699,8 +733,9 @@ function updateAgents(options, callback) {
         // instances and until we move from update agents using a shar file
         // to the individual agents update.
         function refreshSysinfo(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
 
             progress('Reloading sysinfo on updated servers');
@@ -757,8 +792,9 @@ function updateAgents(options, callback) {
          * race.
          */
         function refreshConfigAgents(ctx, next) {
-            if (justDownload) {
-                return next();
+            if (justDownload || justUpdateSymlink) {
+                next();
+                return;
             }
             progress('Refreshing config-agent on all the updated servers');
 
@@ -787,8 +823,9 @@ function updateAgents(options, callback) {
         if (err === true) { // early abort signal
             err = null;
         }
-        if (justDownload) {
-            return callback(err);
+        if (justDownload || justUpdateSymlink) {
+            callback(err);
+            return;
         }
 
         if (!hist) {
@@ -797,7 +834,8 @@ function updateAgents(options, callback) {
             hist.error = err;
             sdcadm.history.updateHistory(hist, function (histErr) {
                 if (err) {
-                    return callback(err);
+                    callback(err);
+                    return;
                 }
                 progress('Successfully updated agents (%s)',
                     common.humanDurationFromMs(Date.now() - startTime));
@@ -833,7 +871,8 @@ function do_update_agents(subcmd, opts, args, cb) {
             'cannot specify "--all" and explicit servers: ' +
             servers.join(' ')));
         return;
-    } else if (!opts.all && !servers && !opts.just_download) {
+    } else if (!opts.all && !servers && !opts.just_download &&
+        !opts.just_update_symlink) {
         cb(new errors.UsageError(
             'either --all option or explicitly specifying ' +
             'SERVER(s) is required'));
@@ -851,6 +890,7 @@ function do_update_agents(subcmd, opts, args, cb) {
         agentsshar: agentsshar,
         progress: self.progress,
         justDownload: opts.just_download,
+        justUpdateSymlink: opts.just_update_symlink,
         yes: opts.yes,
         servers: servers,
         all: opts.all,
@@ -906,6 +946,12 @@ do_update_agents.options = [
         type: 'bool',
         help: 'Download the agents installer for later usage.'
     },
+    {
+        names: ['just-update-symlink'],
+        type: 'bool',
+        help: 'Only update \'/usbkey/extra/agents/latest\' ' +
+            'to the given file path.'
+    },
     {
         names: ['all', 'a'],
         type: 'bool',
