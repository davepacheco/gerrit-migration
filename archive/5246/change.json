{"project":"joyent/triton-cns","branch":"master","topic":"triton-1044","id":"Icf3400bf172159d2acfbe0e78694bfcca3045d72","number":"5246","subject":"TRITON-1044 cns should use newer redis server and client, paginate AXFRs Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Approved by: Isaac Davis \u003cisaac.davis@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/5246","commitMessage":"TRITON-1044 cns should use newer redis server and client, paginate AXFRs\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nApproved by: Isaac Davis \u003cisaac.davis@joyent.com\u003e\n","createdOn":1544823052,"lastUpdated":1545867989,"open":false,"status":"MERGED","comments":[{"timestamp":1544823052,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1544823071,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Topic set to triton-1044"},{"timestamp":1544823081,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544823126,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1544825338,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544828808,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1544828836,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1544836821,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(6 comments)\n\nNote, I didn\u0027t end up reviewing the list of node modules and what the flag days between major versions was."},{"timestamp":1545078866,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(6 comments)"},{"timestamp":1545083880,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1545083919,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545087065,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1545434519,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(1 comment)\n\nLooking good to me. One thing:\n\nOne of the things from https://github.com/luin/ioredis/wiki/Migrating-from-node_redis\n\n- ioredis returns an empty object ({}) when hgetall a non-existed key while node_redis returns null.\n\nand I notice there are 4 places in triton-cns.git that use hgetall and then check for a null return. Some of those might need to be updated, not sure."},{"timestamp":1545435137,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1545435165,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1545850194,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1545863484,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1545867949,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1545867989,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"6","revision":"d75aa32ebbba9cf8d655a17631aa9a5e00a341b2","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1545867949,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545435165,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545850194,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545863484,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}},{"type":"SUBM","value":"1","grantedOn":1545867989,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"bin/cnsadm","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/api-server.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/cmd-utils.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":66,"deletions":-27},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":16,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-12},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":112,"sizeDeletions":-56},"patchSets":[{"number":"1","revision":"6480cfae6b204dc43cc6671b01d7888d3abc0715","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1544823052,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544823081,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":42,"deletions":-25},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":64,"sizeDeletions":-44},{"number":"2","revision":"dd787d04d2fe5e7f6bc4c1d39a441f5b1a8990b6","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1544823126,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544825338,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":42,"deletions":-25},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":63,"sizeDeletions":-43},{"number":"3","revision":"81246853b8eeb0a495d014923146f269cfac7824","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1544828808,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1544828836,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/dns-server.js","line":1236,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can this be a constant or an explanation of how it was picked?"},{"file":"lib/dns-server.js","line":1236,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, will make a constant with a comment."},{"file":"lib/dns-server.js","line":1250,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there any way that with a large database and a small limit, we\u0027re going to end up with a stack overflow (say we have 100k items)?"},{"file":"lib/dns-server.js","line":1250,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"hscan never calls its callback sync, so no."},{"file":"lib/dns-server.js","line":1264,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why did you pick to take the up to 50 responses and break them into chunks of 20, especially when the MAX_ANS_PER_MSG is 500?"},{"file":"lib/dns-server.js","line":1264,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"\"Up to 50 responses\" is not really correct (see redis docs, the COUNT is purely a hint which the server can and does ignore), and note that there are two loops here -- each outer record we got from redis can (and usually) does contain multiple actual records. We could probably be smarter here at picking the number to push in at once, but this is the way it\u0027s always done it... ehh..."},{"file":"lib/dns-server.js","line":1270,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think it\u0027s a bit confusing to have this caller call finish() as opposed to the caller of it when it fails. I think that\u0027d be a little bit simpler in keeping the semantics of it clear."},{"file":"lib/dns-server.js","line":1270,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ah, good point. I only moved it out here into its own function to prevent ruining all the indentation. I\u0027ll rework it."},{"file":"sapi_manifests/cns/template","line":52,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is this for the internal redis image?"},{"file":"sapi_manifests/cns/template","line":52,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I don\u0027t understand this question, sorry. This is used as the argument to the redis client constructor in cns-updater (notably not in cns-server though)"},{"file":"server.js","line":55,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we want to consider the options \u0027autoResendUnfulfilledCommands\u0027? What about the retryStrategy? Do we want its default behavior?"},{"file":"server.js","line":55,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We definitely do not want any of those options for cns-server. The defaults for those are off, thankfully.\n\nIn cns-server this is being managed by cueball, and it needs the client to *not* do any retries or reconnects or queuing or resumption so it can take over that logic."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":42,"deletions":-25},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":16,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":79,"sizeDeletions":-46},{"number":"4","revision":"6f33dbe22639d243413a324537370e3315885418","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1545083880,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545087065,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545083919,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"updater.js","line":6,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: copyright year"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":64,"deletions":-26},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":16,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-11},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":101,"sizeDeletions":-47},{"number":"5","revision":"cf3400bf172159d2acfbe0e78694bfcca3045d72","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1545435137,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545850194,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545435165,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545863484,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"bin/cnsadm","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/api-server.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/cmd-utils.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":66,"deletions":-27},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":16,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-12},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":112,"sizeDeletions":-56},{"number":"6","revision":"d75aa32ebbba9cf8d655a17631aa9a5e00a341b2","parents":["468227419df8d463ff710e41e3d053f2308577c1"],"ref":"refs/changes/46/5246/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1545867949,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545850194,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1545867989,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1545435165,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1545863484,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"bin/cnsadm","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/api-server.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/cmd-utils.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/dns-server.js","type":"MODIFIED","insertions":66,"deletions":-27},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":16,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":11,"deletions":-12},{"file":"sapi_manifests/cns/template","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"updater.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":112,"sizeDeletions":-56}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}