From 56a8b1a036d1db5ef54ea8b1127b05c0b8635909 Mon Sep 17 00:00:00 2001
From: "Pedro P. Candel" <pedro@joyent.com>
Date: Mon, 8 Aug 2016 11:10:25 +0200
Subject: [PATCH] TOOLS-1469 sdcadm tests improvements

---
 test/channel.test.js      |  31 +++++--
 test/check-config.test.js |   6 +-
 test/check-health.test.js | 152 +++++++++++++++++++++---------
 test/common.js            |  22 ++++-
 test/help.test.js         |   4 +-
 test/history.test.js      |   4 +-
 test/instances.test.js    | 191 +++++++++++++++++++++++++-------------
 test/runtests             |  37 +++++---
 test/sdcadm.test.js       |  11 +--
 test/self-update.test.js  |  93 ++++++++++++++++---
 test/services.test.js     | 184 +++++++++++++++++++-----------------
 11 files changed, 491 insertions(+), 244 deletions(-)

diff --git a/test/channel.test.js b/test/channel.test.js
index 2956cc2..e8944b2 100644
--- a/test/channel.test.js
+++ b/test/channel.test.js
@@ -5,13 +5,25 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2016, Joyent, Inc.
  */
 
-
+var util = require('util');
 var test = require('tape').test;
 var exec = require('child_process').exec;
 
+var CURR_CHANNEL = null;
+
+test('setup', function (t) {
+    exec('sdcadm channel get', function (err, stdout, stderr) {
+        t.ifError(err);
+        t.equal(stderr, '');
+        if (stdout) {
+            CURR_CHANNEL = stdout.trim();
+        }
+        t.end();
+    });
+});
 
 test('sdcadm channel --help', function (t) {
     exec('sdcadm channel --help', function (err, stdout, stderr) {
@@ -45,7 +57,6 @@ test('sdcadm channel list', function (t) {
         var lines = stdout.split('\n');
         var titles = lines[0].split(/\s+/);
         t.deepEqual(titles, ['NAME', 'DEFAULT', 'DESCRIPTION']);
-
         t.end();
     });
 });
@@ -54,24 +65,24 @@ test('sdcadm channel list', function (t) {
 test('sdcadm channel set', function (t) {
     exec('sdcadm channel set release', function (err, stdout, stderr) {
         t.ifError(err);
-
         t.equal(stdout, 'Update channel has been successfully set to: ' +
-                        '\'release\'\n');
+                        '\'release\'');
         t.equal(stderr, '');
-
         t.end();
     });
 });
 
 
-test('sdcadm channel set', function (t) {
-    exec('sdcadm channel set dev', function (err, stdout, stderr) {
+test('sdcadm channel reset', {
+    skip: CURR_CHANNEL !== null
+}, function (t) {
+    var cmd = util.format('sdcadm channel set %s', CURR_CHANNEL);
+    exec(cmd, function (err, stdout, stderr) {
         t.ifError(err);
 
         t.equal(stdout, 'Update channel has been successfully set to: ' +
-                        '\'dev\'\n');
+                        '\'' + CURR_CHANNEL + '\'');
         t.equal(stderr, '');
-
         t.end();
     });
 });
diff --git a/test/check-config.test.js b/test/check-config.test.js
index 739ef5f..ad73e2c 100644
--- a/test/check-config.test.js
+++ b/test/check-config.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 
@@ -26,8 +26,6 @@ test('sdcadm check-config --help', function (t) {
 
 
 test('sdcadm check-config', function (t) {
-    // TODO: huge todo here; should intentionally break something and see if
-    // check-config picks it up
     exec('sdcadm check-config', function (err, stdout, stderr) {
         t.ifError(err);
 
@@ -36,4 +34,4 @@ test('sdcadm check-config', function (t) {
 
         t.end();
     });
-});
\ No newline at end of file
+});
diff --git a/test/check-health.test.js b/test/check-health.test.js
index 8c6c435..4899727 100644
--- a/test/check-health.test.js
+++ b/test/check-health.test.js
@@ -5,59 +5,120 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 
 var test = require('tape').test;
 var exec = require('child_process').exec;
-var common = require('./common');
+var util = require('util');
+
+var vasync = require('vasync');
 
+var common = require('./common');
 
+var serverHostnamesFromUUID = {};
+var serviceNamesFromUUID = {};
 var HEALTH_TITLES = ['INSTANCE', 'SERVICE', 'HOSTNAME', 'ALIAS', 'HEALTHY'];
 var HEALTH_DETAILS = [];
 
-
-function parseHealthOutput(output) {
-    return common.parseTextOut(output).filter(function (r) {
-        // TODO: we should check everything, not just VMs
-        return r[3] !== '-';
+function checkHealthDetails(t, healthDetails) {
+    vasync.forEachPipeline({
+        func: function (item, next) {
+
+            if (item[1] === 'global') {
+                return next();
+            }
+
+            var description = (item[3] !== '-') ?
+                util.format('%s (%s)', item[3], item[0]) :
+                util.format('%s (%s)', item[0], item[1]);
+            t.comment(util.format('checking %s in %s',
+                description, item[2]));
+
+
+
+            var cmd2 = 'sdc-sapi /instances/' + item[0] + ' | json -H';
+            exec(cmd2, function (err2, stdout2, stderr2) {
+                t.ifError(err2, 'no SAPI error');
+                var instanceDetails = common.parseJsonOut(stdout2);
+                if (!instanceDetails) {
+                    t.ok(false, 'failed to parse JSON for cmd ' + cmd2);
+                    return next();
+                }
+
+                if (item[1] !== 'assets') {
+                    t.equal(serviceNamesFromUUID[instanceDetails.service_uuid],
+                        item[1], 'service should match');
+                }
+
+                if (item[3] === '-') {
+                    return next();
+                }
+
+                var cmd = 'sdc-vmapi /vms/' + item[0] + ' | json -H';
+                exec(cmd, function (err, stdout, stderr) {
+                    t.ifError(err, 'no VMAPI error');
+
+                    var vmDetails = common.parseJsonOut(stdout);
+                    if (!vmDetails) {
+                        t.ok(false, 'failed to parse JSON for cmd ' + cmd);
+                        return next();
+                    }
+
+                    t.equal(vmDetails.uuid,  item[0], 'uuid should match');
+                    t.equal(vmDetails.alias, item[3], 'alias should match');
+
+                    t.equal(serverHostnamesFromUUID[vmDetails.server_uuid],
+                        item[2], 'server hostname should match');
+                    next();
+                });
+            });
+        },
+        inputs: healthDetails
+    }, function (resErr) {
+        t.ifError(resErr);
+        t.end();
     });
 }
 
 
-// TODO: need to check if service and hostname are correct
-function checkHealthDetails(t, healthDetails) {
-    if (healthDetails.length === 0) {
-        return t.end();
-    }
-
-    var details = healthDetails.pop();
+// ---
 
-    var cmd = 'sdc-vmapi /vms/' + details[0] + ' | json -H';
+// Preload Servers and SAPI services
+test('setup', function (t) {
+    var cmd = 'sdc-sapi /services | json -H';
     exec(cmd, function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'No error preloading SAPI services');
 
-        var vmDetails = common.parseJsonOut(stdout);
-        if (!vmDetails) {
+        var svcs = common.parseJsonOut(stdout);
+        if (!svcs) {
             t.ok(false, 'failed to parse JSON for cmd ' + cmd);
             return t.end();
         }
-
-        t.equal(vmDetails.uuid,  details[0], 'uuid should match');  // sanity
-        t.equal(vmDetails.alias, details[3], 'alias should match');
-
-        checkHealthDetails(t, healthDetails);
+        svcs.forEach(function (svc) {
+            serviceNamesFromUUID[svc.uuid] = svc.name;
+        });
+        var cmd2 = 'sdc-cnapi /servers?setup=true|json -H';
+        exec(cmd2, function (err2, stdout2, stderr2) {
+            t.ifError(err2, 'No error preloading CNAPI servers');
+
+            var servers = common.parseJsonOut(stdout2);
+            if (!servers) {
+                t.ok(false, 'failed to parse JSON for cmd ' + cmd2);
+                return t.end();
+            }
+            servers.forEach(function (server) {
+                serverHostnamesFromUUID[server.uuid] = server.hostname;
+            });
+            t.end();
+        });
     });
-}
-
-
-// ---
-
+});
 
 test('sdcadm check-health --help', function (t) {
     exec('sdcadm check-health --help', function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'exec error');
 
         t.ok(stdout.indexOf('sdcadm check-health [<options>]') !== -1);
         t.equal(stderr, '');
@@ -69,15 +130,15 @@ test('sdcadm check-health --help', function (t) {
 
 test('sdcadm check-health', function (t) {
     exec('sdcadm check-health', function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'exec error');
         t.equal(stderr, '');
 
-        common.DEFAULT_SERVICES.forEach(function (svcName) {
+        common.DEFAULT_VM_SERVICES.forEach(function (svcName) {
             var found = stdout.indexOf(svcName) !== -1;
             t.ok(found, svcName + ' in instances output');
         });
 
-        var healthDetails = parseHealthOutput(stdout);
+        var healthDetails = common.parseTextOut(stdout);
 
         var titles = healthDetails.shift();
         t.deepEqual(titles, HEALTH_TITLES, 'check column titles');
@@ -88,7 +149,6 @@ test('sdcadm check-health', function (t) {
 
         // global, so other tests can compare against
         HEALTH_DETAILS = healthDetails;
-
         checkHealthDetails(t, common.deepCopy(healthDetails));
     });
 });
@@ -123,17 +183,24 @@ test('sdcadm check-health --json', function (t) {
         });
 
         HEALTH_DETAILS.forEach(function (oldDetails) {
-            var vmUuid = oldDetails[0];
-            var jsonDetails = healthDetails[vmUuid];
-            t.equal(jsonDetails.type,    'vm',           vmUuid + ' type');
-            t.equal(jsonDetails.service,  oldDetails[1], vmUuid + ' service');
-            t.equal(jsonDetails.hostname, oldDetails[2], vmUuid + ' hostname');
-            t.equal(jsonDetails.alias,    oldDetails[3], vmUuid + ' alias');
+            var id = oldDetails[0];
+            var jsonDetails = healthDetails[id];
+            if (jsonDetails.type === 'global') {
+                return;
+            }
+            t.equal(jsonDetails.type, (
+                (oldDetails[3] !== '-') ? 'vm' : 'agent'
+            ), id + ' type');
+            t.equal(jsonDetails.service,  oldDetails[1], id + ' service');
+            t.equal(jsonDetails.hostname, oldDetails[2], id + ' hostname');
+            if (oldDetails[3] !== '-') {
+                t.equal(jsonDetails.alias,    oldDetails[3], id + ' alias');
+            }
 
             var oldHealthy = oldDetails[4];
             t.notEqual(['true', 'false'].indexOf(oldHealthy), -1);
             oldHealthy = (oldHealthy === 'true' ? true : false);
-            t.equal(jsonDetails.healthy,  oldHealthy, vmUuid + ' hostname');
+            t.equal(jsonDetails.healthy,  oldHealthy, id + ' hostname');
         });
 
         t.end();
@@ -172,7 +239,8 @@ test('sdcadm check-health with disabled papi', function (t) {
         t.notEqual(stderr, 'Some instances appear unhealthy'.indexOf(stderr),
                    -1);
 
-        var unhealthyPapis = parseHealthOutput(stdout).filter(function (inst) {
+        var unhealthyPapis = common.parseTextOut(stdout).
+            filter(function (inst) {
             return inst[1] === 'papi' && inst[4] === 'false';
         });
 
@@ -194,4 +262,4 @@ test('enable papi after health check', function (t) {
         t.equal(stderr, '');
         t.end();
     });
-});
\ No newline at end of file
+});
diff --git a/test/common.js b/test/common.js
index 309704a..f3649a9 100644
--- a/test/common.js
+++ b/test/common.js
@@ -5,18 +5,29 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 var exec = require('child_process').exec;
 
 
-var DEFAULT_SERVICES = [
+var DEFAULT_VM_SERVICES = [
     'adminui', 'amon', 'amonredis', 'assets', 'binder', 'ca', 'cnapi', 'dhcpd',
     'fwapi', 'imgapi', 'mahi', 'manatee', 'moray', 'napi', 'papi', 'rabbitmq',
     'redis', 'sapi', 'sdc', 'ufds', 'vmapi', 'workflow'
 ];
 
+var ALL_VM_SERVICES = DEFAULT_VM_SERVICES.concat([
+    'portolan', 'cloudapi', 'docker', 'cns'
+]);
+
+var DEFAULT_AGENT_SERVICES = [
+    'amon-agent', 'amon-relay', 'cainstsvc', 'firewaller',
+    'cn-agent', 'vm-agent', 'net-agent', 'smartlogin',
+    'hagfish-watcher'
+];
+
+var ALL_AGENT_SERVICES = DEFAULT_AGENT_SERVICES.concat(['dockerlogger']);
 
 var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
 
@@ -57,10 +68,13 @@ function checkHelp(t, subcommand, match) {
 
 
 module.exports = {
-    DEFAULT_SERVICES: DEFAULT_SERVICES,
+    DEFAULT_VM_SERVICES: DEFAULT_VM_SERVICES,
+    ALL_VM_SERVICES: ALL_VM_SERVICES,
+    DEFAULT_AGENT_SERVICES: DEFAULT_AGENT_SERVICES,
+    ALL_AGENT_SERVICES: ALL_AGENT_SERVICES,
     UUID_RE: UUID_RE,
     checkHelp: checkHelp,
     deepCopy: deepCopy,
     parseJsonOut: parseJsonOut,
     parseTextOut: parseTextOut
-};
\ No newline at end of file
+};
diff --git a/test/help.test.js b/test/help.test.js
index 8bf597e..3e01dbc 100644
--- a/test/help.test.js
+++ b/test/help.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 
@@ -32,7 +32,7 @@ test('sdcadm help', function (t) {
 
 
 test('sdcadm help self-update', function (t) {
-    checkHelp(t, 'self-update', 'sdcadm self-update [<options>]');
+    checkHelp(t, 'self-update', 'sdcadm self-update --latest [<options>]');
 });
 
 
diff --git a/test/history.test.js b/test/history.test.js
index 9127d17..06258df 100644
--- a/test/history.test.js
+++ b/test/history.test.js
@@ -116,7 +116,7 @@ test('sdcadm history --json', function (t) {
             t.ok(entry.uuid.match(common.UUID_RE), entry.uuid + ' is a UUID');
             t.ok(Array.isArray(entry.changes), 'changes is an array');
             // TODO: no username?
-            t.ok(entry.username == 'root' || !entry.username);
+            t.ok(entry.username === 'root' || !entry.username);
             t.ok(new Date(entry.started));
             t.ok(new Date(entry.finished));
         });
@@ -235,4 +235,4 @@ test('sdcadm history --until', function (t) {
 
         t.end();
     });
-});
\ No newline at end of file
+});
diff --git a/test/instances.test.js b/test/instances.test.js
index 2576861..ac39bc3 100644
--- a/test/instances.test.js
+++ b/test/instances.test.js
@@ -13,9 +13,13 @@ var test = require('tape').test;
 var exec = require('child_process').exec;
 var util = require('util');
 var format = util.format;
-var common = require('./common');
 
+var vasync = require('vasync');
+
+var common = require('./common');
 
+var serverHostnamesFromUUID = {};
+var serviceNamesFromUUID = {};
 var INSTANCE_TITLES = ['INSTANCE', 'SERVICE', 'HOSTNAME', 'VERSION', 'ALIAS'];
 var INSTANCES_DETAILS = [];
 
@@ -40,66 +44,120 @@ function parseInstancesOutput(t, output, expectedTitles) {
     t.deepEqual(titles, expectedTitles || INSTANCE_TITLES,
                 'check column titles');
 
-    return instancesDetails.filter(function (r) {
-        // TODO: we should check everything, not just VMs
-        return r[4] !== '-';
-    });
+    return instancesDetails;
 }
 
 
-/*
- * Recursive function to check the existence of a VM, and its alias and version
- * are correct.
- */
 function checkInstancesDetails(t, instancesDetails) {
-    if (instancesDetails.length === 0) {
-        return t.end();
-    }
+    vasync.forEachPipeline({
+        func: function (item, next) {
+            if (item[0] === '-') {
+                return next();
+            }
+            var description = (item[4] !== '-') ?
+                util.format('%s (%s)', item[4], item[0]) :
+                util.format('%s (%s)', item[0], item[1]);
+            t.comment(util.format('checking %s in %s',
+                description, item[2]));
+
+            var cmd2 = 'sdc-sapi /instances/' + item[0] + ' | json -H';
+            exec(cmd2, function (err2, stdout2, stderr2) {
+                t.ifError(err2, 'no SAPI error');
+                var instanceDetails = common.parseJsonOut(stdout2);
+                if (!instanceDetails) {
+                    t.ok(false, 'failed to parse JSON for cmd ' + cmd2);
+                    return next();
+                }
+
+                if (item[1] !== 'assets') {
+                    t.equal(serviceNamesFromUUID[instanceDetails.service_uuid],
+                        item[1], 'service should match');
+                }
+
+                if (item[4] === '-') {
+                    return next();
+                }
+
+                var cmd = 'sdc-vmapi /vms/' + item[0] + ' | json -H';
+                exec(cmd, function (err, stdout, stderr) {
+                    t.ifError(err, 'no VMAPI error');
+
+                    var vmDetails = common.parseJsonOut(stdout);
+                    if (!vmDetails) {
+                        t.ok(false, 'failed to parse JSON for cmd ' + cmd);
+                        return next();
+                    }
+
+                    t.equal(vmDetails.uuid,  item[0], 'uuid should match');
+                    t.equal(vmDetails.alias, item[4], 'alias should match');
+
+                    t.equal(serverHostnamesFromUUID[vmDetails.server_uuid],
+                        item[2], 'server hostname should match');
+
+                    t.notEqual(vmDetails.state, 'failed',
+                            'check state for VM ' + item[0]);
+
+                    var imgUuid = vmDetails.image_uuid;
+                    var cmd3 = 'sdc-imgapi /images/' + imgUuid + ' | json -H';
+
+                    exec(cmd3, function (err3, stdout3, stderr3) {
+                        t.ifError(err3, 'IMGAPI call error');
+
+                        var imgInfo = common.parseJsonOut(stdout3);
+                        if (!imgInfo) {
+                            t.ok(false, 'failed to parse JSON for cmd ' + cmd3);
+                            return next();
+                        }
+
+                        t.equal(imgInfo.version, item[3],
+                                'check version for VM ' + vmDetails.uuid);
+
+                        next();
+                    });
+                });
+            });
+        },
+        inputs: instancesDetails
+    }, function (pipeErr) {
+        t.ifError(pipeErr);
+        t.end();
+    });
+}
 
-    function recur() {
-        checkInstancesDetails(t, instancesDetails); // recursive call
-    }
 
-    var instanceDetails = instancesDetails.pop();
-    var vmUuid  = instanceDetails[0];
-    var version = instanceDetails[3];
-    var alias   = instanceDetails[4];
+// ---
 
-    var cmd = 'sdc-vmapi /vms/' + vmUuid + ' | json -H';
 
+// Preload Servers and SAPI services
+test('setup', function (t) {
+    var cmd = 'sdc-sapi /services | json -H';
     exec(cmd, function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'No error preloading SAPI services');
 
-        var vmInfo = common.parseJsonOut(stdout);
-        if (!vmInfo) {
+        var svcs = common.parseJsonOut(stdout);
+        if (!svcs) {
             t.ok(false, 'failed to parse JSON for cmd ' + cmd);
-            return recur();
+            return t.end();
         }
-
-        t.equal(vmInfo.alias, alias, 'check VM alias is ' + alias);
-        t.notEqual(vmInfo.state, 'failed', 'check state for VM ' + vmUuid);
-
-        var imgUuid = vmInfo.image_uuid;
-        var cmd2 = 'sdc-imgapi /images/' + imgUuid + ' | json -H';
-
+        svcs.forEach(function (svc) {
+            serviceNamesFromUUID[svc.uuid] = svc.name;
+        });
+        var cmd2 = 'sdc-cnapi /servers?setup=true|json -H';
         exec(cmd2, function (err2, stdout2, stderr2) {
-            t.ifError(err2);
+            t.ifError(err2, 'No error preloading CNAPI servers');
 
-            var imgInfo = common.parseJsonOut(stdout2);
-            if (!imgInfo) {
+            var servers = common.parseJsonOut(stdout2);
+            if (!servers) {
                 t.ok(false, 'failed to parse JSON for cmd ' + cmd2);
-                return recur();
+                return t.end();
             }
-
-            t.equal(imgInfo.version, version, 'check version for VM ' + vmUuid);
-
-            recur();
+            servers.forEach(function (server) {
+                serverHostnamesFromUUID[server.uuid] = server.hostname;
+            });
+            t.end();
         });
     });
-}
-
-
-// ---
+});
 
 test('sdcadm instances --help', function (t) {
     checkHelp(t, 'instances');
@@ -116,7 +174,7 @@ test('sdcadm instances', function (t) {
         t.ifError(err);
         t.equal(stderr, '');
 
-        common.DEFAULT_SERVICES.forEach(function (svcName) {
+        common.DEFAULT_VM_SERVICES.forEach(function (svcName) {
             var found = stdout.indexOf(svcName) !== -1;
             t.ok(found, svcName + ' in instances output');
         });
@@ -164,19 +222,27 @@ test('sdcadm instances --json', function (t) {
             return t.end();
         }
 
-        var vmsDetails = {};
-        details.forEach(function (vm) {
-            vmsDetails[vm.zonename] = vm;
+        var instDetails = {};
+        details.forEach(function (inst) {
+            instDetails[inst.instance] = inst;
         });
 
         INSTANCES_DETAILS.forEach(function (oldDetails) {
-            var vmUuid = oldDetails[0];
-            var jsonDetails = vmsDetails[vmUuid];
-            t.equal(jsonDetails.type,    'vm',           vmUuid + ' type');
-            t.equal(jsonDetails.service,  oldDetails[1], vmUuid + ' service');
-            t.equal(jsonDetails.hostname, oldDetails[2], vmUuid + ' hostname');
-            t.equal(jsonDetails.version,  oldDetails[3], vmUuid + ' version');
-            t.equal(jsonDetails.alias,    oldDetails[4], vmUuid + ' alias');
+            var id = oldDetails[0];
+            // No instance id
+            if (id === '-') {
+                return;
+            }
+            var jsonDetails = instDetails[id];
+            t.equal(jsonDetails.type, (
+                (oldDetails[4] !== '-') ? 'vm' : 'agent'
+            ), id + ' type');
+            t.equal(jsonDetails.service, oldDetails[1], id + ' service');
+            t.equal(jsonDetails.hostname, oldDetails[2], id + ' hostname');
+            t.equal(jsonDetails.version, oldDetails[3], id + ' version');
+            if (oldDetails[4] !== '-') {
+                t.equal(jsonDetails.alias, oldDetails[4], id + ' alias');
+            }
         });
 
         t.end();
@@ -193,18 +259,17 @@ test('sdcadm instances -o', function (t) {
         var expectedTitles = ['TYPE', 'INSTANCE', 'VERSION'];
         var data = parseInstancesOutput(t, stdout, expectedTitles);
 
-        // TODO: should check more than just vms
-        var vms = data.filter(function (r) {
-            return r[0] === 'vm';
+        var insts = data.filter(function (r) {
+            return true;
         }).map(function (r) {
             return [ r[1], r[2] ];
         });
 
-        var prevVms = INSTANCES_DETAILS.map(function (r) {
+        var prevInsts = INSTANCES_DETAILS.map(function (r) {
             return [ r[0], r[3] ];
         });
 
-        t.deepEqual(vms, prevVms);
+        t.deepEqual(insts, prevInsts);
 
         t.end();
     });
@@ -216,12 +281,14 @@ test('sdcadm instances -s', function (t) {
         t.ifError(err);
         t.equal(stderr, '');
 
-        var vms = parseInstancesOutput(t, stdout);
-        var sortedVms = common.deepCopy(vms).sort(function (a, b) {
+        var insts = parseInstancesOutput(t, stdout).filter(function (item) {
+            return item[0] !== '-';
+        });
+        var sortedInsts = common.deepCopy(insts).sort(function (a, b) {
             return (a[0] < b[0]) ? -1 : 1;
         });
 
-        t.deepEqual(vms, sortedVms);
+        t.deepEqual(insts, sortedInsts);
 
         t.end();
     });
diff --git a/test/runtests b/test/runtests
index 53d5263..f644d87 100755
--- a/test/runtests
+++ b/test/runtests
@@ -26,8 +26,6 @@ fi
 set -o errexit
 set -o pipefail
 
-
-
 #---- guard
 
 guard_file=/lib/sdc/.sdc-test-no-production-data
@@ -72,7 +70,6 @@ TOP=$(cd $(dirname $0)/../; pwd)
 NODE_INSTALL=$TOP/node
 OUTPUT_DIR=/var/tmp/sdcadmtest
 TAPE=$TOP/node_modules/.bin/tape
-FAILING_LIST=$OUTPUT_DIR/failing-tests.txt
 
 
 # Options.
@@ -99,10 +96,26 @@ do
 done
 
 
+if [[ "${TOP}" == '/opt/smartdc/sdcadm' ]]; then
+  echo "Copying test files to ${OUTPUT_DIR}"
+  DESTDIR=/var/tmp/sdcadmtest
+  rm -rf $OUTPUT_DIR
+  mkdir -p $OUTPUT_DIR
+  cp -PR \
+      $TOP/test \
+      $TOP/node_modules \
+      $TOP/node \
+      $OUTPUT_DIR
+  sh $DESTDIR/test/runtests "${@}"
+  exit $?
+fi
+
+RESULTS=$OUTPUT_DIR/results
 # Setup a clean output dir.
-echo "# Setup a clean output dir ($OUTPUT_DIR)."
-rm -rf $OUTPUT_DIR
-mkdir -p /$OUTPUT_DIR
+echo "# Setup a clean output dir ($RESULTS)."
+rm -rf $RESULTS
+mkdir -p /$RESULTS
+FAILING_LIST=$RESULTS/failing-tests.txt
 touch $FAILING_LIST
 
 cd $TOP
@@ -121,9 +134,9 @@ for file in $test_files; do
     test_file=$(basename $file)
     echo "# $test_file"
     PATH=$NODE_INSTALL/bin:$PATH $TAPE $file \
-        | tee $OUTPUT_DIR/$test_file.tap
+        | tee $RESULTS/$test_file.tap
     if [[ "$?" != "0" ]]; then
-        echo $file >> $OUTPUT_DIR/failing-tests.txt
+        echo $file >> $FAILING_LIST
         [[ -n "$opt_stop_on_failure" ]] && break
     fi
 done
@@ -131,8 +144,8 @@ done
 set -o errexit
 
 echo ""
-echo "# test output in $OUTPUT_DIR:"
-cd $OUTPUT_DIR
+echo "# test output in $RESULTS:"
+cd $RESULTS
 ls *.tap
 
 
@@ -143,8 +156,8 @@ echo "# test results:"
 end_time=$(date +%s)
 elapsed=$((${end_time} - ${start_time}))
 
-tests=$(grep "^# tests [0-9]" $OUTPUT_DIR/*.tap | cut -d ' ' -f3 | xargs | tr ' ' '+' | bc)
-passed=$(grep "^# pass  [0-9]" $OUTPUT_DIR/*.tap | tr -s ' ' | cut -d ' ' -f3 | xargs | tr ' ' '+' | bc)
+tests=$(grep "^# tests [0-9]" $RESULTS/*.tap | cut -d ' ' -f3 | xargs | tr ' ' '+' | bc)
+passed=$(grep "^# pass  [0-9]" $RESULTS/*.tap | tr -s ' ' | cut -d ' ' -f3 | xargs | tr ' ' '+' | bc)
 [[ -z ${tests} ]] && tests=0
 [[ -z ${passed} ]] && passed=0
 fail=$((${tests} - ${passed}))
diff --git a/test/sdcadm.test.js b/test/sdcadm.test.js
index 2d74af8..35cd336 100644
--- a/test/sdcadm.test.js
+++ b/test/sdcadm.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 
@@ -15,7 +15,7 @@ var exec = require('child_process').exec;
 
 test('sdcadm', function (t) {
     exec('sdcadm', function (err, stdout, stderr) {
-        t.ok(err);
+        t.ok(err, 'usage error');
         t.equal(err.code, 1);
 
         t.ok(stdout.match('Usage'));
@@ -28,7 +28,7 @@ test('sdcadm', function (t) {
 
 test('sdcadm --help', function (t) {
     exec('sdcadm --help', function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'no help error');
 
         t.ok(stdout.match('Usage'));
         t.equal(stderr, '');
@@ -40,9 +40,8 @@ test('sdcadm --help', function (t) {
 
 test('sdcadm --version', function (t) {
     exec('sdcadm --version', function (err, stdout, stderr) {
-        t.ifError(err);
-
-        t.ok(stdout.match(/^sdcadm \d\.\d\.\d \(master-\d+T\d+Z-.+\)/));
+        t.ifError(err, 'no version error');
+        t.ok(stdout.match(/^sdcadm \d+\.\d+\.\d+ \(master-\d+T\d+Z-.+\)/));
         t.equal(stderr, '');
 
         t.end();
diff --git a/test/self-update.test.js b/test/self-update.test.js
index fdd3f5e..3ab3060 100644
--- a/test/self-update.test.js
+++ b/test/self-update.test.js
@@ -5,15 +5,25 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016 Joyent, Inc.
  */
 
 
 var test = require('tape').test;
 var exec = require('child_process').exec;
+var fs = require('fs');
+var util = require('util');
+var assert = require('assert-plus');
 
+var CURRENT_VERSION = null;
+var CURRENT_BUILDSTAMP = null;
+var LATEST_UUID = null;
+
+function checkUpdateResults(t, err, stdout, stderr, moreStrings) {
+    if (moreStrings) {
+        assert.arrayOfString(moreStrings, 'moreStrings');
+    }
 
-function checkUpdateResults(t, err, stdout, stderr) {
     t.ifError(err);
     t.equal(stderr, '');
 
@@ -28,40 +38,97 @@ function checkUpdateResults(t, err, stdout, stderr) {
         'Updated to sdcadm'
     ];
 
+    if (moreStrings) {
+        findStrings = findStrings.concat(moreStrings);
+    }
+
     findStrings.forEach(function (str) {
         t.ok(stdout.match(str), 'check update string present');
     });
 
-    return t.end();
+    t.end();
+}
+
+function getSdcadmBuildstampVersion(t, cb) {
+    fs.readFile('/opt/smartdc/sdcadm/etc/buildstamp', {
+        encoding: 'utf8'
+    }, function (err, data) {
+        t.ifError(err);
+        t.ok(data);
+        cb(data.trim());
+    });
 }
 
 
+test('setup', function (t) {
+    getSdcadmBuildstampVersion(t, function (data) {
+        CURRENT_BUILDSTAMP = data;
+        var updatesCmd = '/opt/smartdc/bin/updates-imgadm list ' +
+            'tag.buildstamp=' + data + ' --latest -o uuid -H';
+        exec(updatesCmd, function (err2, stdout, stderr) {
+            t.ifError(err2);
+            CURRENT_VERSION = stdout.trim();
+            t.ok(CURRENT_VERSION);
+            t.equal(stderr, '');
+            var updatesCmd2 = '/opt/smartdc/bin/updates-imgadm list ' +
+                'name=sdcadm --latest -o uuid -H';
+            exec(updatesCmd2, function (err3, stdout2, stderr2) {
+                t.ifError(err3);
+                LATEST_UUID = stdout.trim();
+                t.ok(LATEST_UUID);
+                t.equal(stderr, '');
+                t.end();
+            });
+        });
+    });
+});
+
 test('sdcadm self-update --help', function (t) {
     exec('sdcadm self-update --help', function (err, stdout, stderr) {
         t.ifError(err);
-
-        t.notEqual(stdout.indexOf('sdcadm self-update [<options>]'), -1);
+        t.notEqual(stdout.indexOf('sdcadm self-update --latest [<options>]'),
+            -1);
         t.equal(stderr, '');
-
         t.end();
     });
 });
 
 
-test('sdcadm self-update --dry-run', function (t) {
-    exec('sdcadm self-update --dry-run', function (err, stdout, stderr) {
+test('sdcadm self-update --latest --dry-run', function (t) {
+    exec('sdcadm self-update --latest --dry-run',
+        function (err, stdout, stderr) {
         checkUpdateResults(t, err, stdout, stderr);
     });
 });
 
 
-test('sdcadm self-update --allow-major-update --dry-run', function (t) {
-    exec('sdcadm self-update --allow-major-update --dry-run',
-         function (err, stdout, stderr) {
+test('sdcadm self-update --allow-major-update', function (t) {
+    exec('sdcadm self-update --allow-major-update --dry-run --latest',
+        function (err, stdout, stderr) {
         checkUpdateResults(t, err, stdout, stderr);
     });
 });
 
 
-// TODO: how do we fully run self-update without mucking with the sdcadm we're
-// testing?
\ No newline at end of file
+test('sdcadm self-update --latest --channel=staging', function (t) {
+    var cmd = 'sdcadm self-update --latest --channel=staging';
+    exec(cmd, function (err, stdout, stderr) {
+        checkUpdateResults(t, err, stdout, stderr, ['Using channel staging']);
+    });
+});
+
+
+test('sdcadm self-update --latest', function (t) {
+    var cmd = 'sdcadm self-update --latest';
+    exec(cmd, function (err, stdout, stderr) {
+        checkUpdateResults(t, err, stdout, stderr, ['Using channel dev']);
+    });
+});
+
+
+test('sdcadm self-update IMAGE_UUID', function (t) {
+    var cmd = 'sdcadm self-update ' + CURRENT_VERSION;
+    exec(cmd, function (err, stdout, stderr) {
+        checkUpdateResults(t, err, stdout, stderr, ['Using channel dev']);
+    });
+});
diff --git a/test/services.test.js b/test/services.test.js
index c19bc84..1c45566 100644
--- a/test/services.test.js
+++ b/test/services.test.js
@@ -5,12 +5,16 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2016, Joyent, Inc.
  */
 
 
 var test = require('tape').test;
 var exec = require('child_process').exec;
+var util = require('util');
+
+var vasync = require('vasync');
+
 var common = require('./common');
 
 
@@ -21,10 +25,11 @@ var SERVICES_DETAILS = [];
 
 function checkHelp(t, command) {
     exec('sdcadm ' + command + ' --help', function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'Execution error');
 
-        t.ok(stdout.indexOf('sdcadm services [<options>]') !== -1);
-        t.equal(stderr, '');
+        t.ok(stdout.indexOf('sdcadm services [<options>]') !== -1,
+            'Expected help');
+        t.equal(stderr, '', 'Empty stderr');
 
         t.end();
     });
@@ -33,125 +38,130 @@ function checkHelp(t, command) {
 
 function parseServicesOutput(t, output, expectedTitles) {
     var servicesDetails = common.parseTextOut(output);
-    t.ok(servicesDetails.length > 0);
+    t.ok(servicesDetails.length > 0, 'Have services');
 
     var titles = servicesDetails.shift();
     t.deepEqual(titles, expectedTitles || SERVICE_TITLES,
                 'check service titles present');
 
     return servicesDetails.filter(function (r) {
-        // TODO: we should check validity of non-sapi-registered entries as well
         return r[1] !== '-';
     });
 }
 
 
+function checkInstancesExist(t, instances, cb) {
+    vasync.forEachPipeline({
+        func: function (instance, next) {
+            var vmUuid = instance.uuid;
+            var cmd = 'sdc-vmapi /vms/' + vmUuid + ' | json -H';
+
+            exec(cmd, function (err, stdout, stderr) {
+                t.ifError(err, 'check service instance ' + vmUuid +
+                    ' actually exists');
+
+                var instanceDetails = common.parseJsonOut(stdout);
+                if (!instanceDetails) {
+                    t.ok(false, 'failed to parse JSON for cmd ' + cmd);
+                    return next();
+                }
+
+                t.equal(instanceDetails.uuid, instance.uuid,
+                    'Instance uuid');
+                next();
+            });
+        },
+        inputs: instances
+    }, function (resErr) {
+        cb(resErr);
+    });
+}
+
+
 /*
- * Recursive function to check the existence of a service, and its type, name,
+ * Function to check the existence of a service, and its type, name,
  * image, and instances count are correct.
  */
 function checkServicesDetails(t, servicesDetails) {
-    if (servicesDetails.length === 0) {
-        return t.end();
-    }
+    vasync.forEachPipeline({
+        func: function (serviceDetails, next) {
+            var type     = serviceDetails[0];
+            var svcUuid  = serviceDetails[1];
+            var name     = serviceDetails[2];
+            var imgUuid  = serviceDetails[3];
+            var numInsts = +serviceDetails[4];
+            t.comment(util.format('checking service %s (%s)', name, svcUuid));
+
+            t.notEqual(['vm', 'agent'].indexOf(type), -1,
+                svcUuid + ' service type');
+
+            if (svcUuid === '-') {
+                return next();
+            }
 
-    function recur() {
-        return checkServicesDetails(t, servicesDetails);
-    }
+            var svcInfo = SERVICES_INFO[svcUuid];
 
-    var serviceDetails = servicesDetails.pop();
-    var type     = serviceDetails[0];
-    var svcUuid  = serviceDetails[1];
-    var name     = serviceDetails[2];
-    var imgUuid  = serviceDetails[3];
-    var numInsts = +serviceDetails[4];
+            t.equal(svcInfo.type, type, svcUuid + ' service type matches');
+            t.equal(svcInfo.name, name, svcUuid + ' service name matches');
 
-    t.notEqual(['vm', 'agent'].indexOf(type), -1, svcUuid + ' service type');
+            if (imgUuid === '-') {
+                return next();
+            }
 
-    if (svcUuid === '-') {
-        return recur();
-    }
+            t.equal(svcInfo.params.image_uuid, imgUuid,
+                'service image matches');
 
-    var svcInfo = SERVICES_INFO[svcUuid];
+            var cmd = 'sdc-imgapi /images/' + imgUuid + ' | json -H';
 
-    t.equal(svcInfo.type, type, svcUuid + ' service type matches');
-    t.equal(svcInfo.name, name, svcUuid + ' service name matches');
+            exec(cmd, function (err, stdout, stderr) {
+                t.ifError(err, svcUuid + ' service image exists');
 
-    if (imgUuid === '-') {
-        return recur();
-    }
+                if (type !== 'vm') {
+                    return next();
+                }
 
-    t.equal(svcInfo.params.image_uuid, imgUuid);
+                var cmd2 = 'sdc-sapi /instances?service_uuid=' +
+                    svcUuid + ' | json -H';
 
-    var cmd = 'sdc-imgapi /images/' + imgUuid + ' | json -H';
+                exec(cmd2, function (err2, stdout2, stderr2) {
+                    t.ifError(err2, svcUuid + ' service instance fetch');
 
-    exec(cmd, function (err, stdout, stderr) {
-        t.ifError(err, svcUuid + ' service image exists');
+                    var instances = common.parseJsonOut(stdout2);
+                    if (!instances) {
+                        t.ok(false, 'failed to parse JSON for cmd ' + cmd2);
+                        return next();
+                    }
 
-        if (type !== 'vm') {
-            return recur();
-        }
+                    instances.forEach(function (inst) {
+                        t.equal(inst.service_uuid, svcUuid); // sanity check
+                    });
 
-        var cmd2 = 'sdc-sapi /instances?service_uuid=' + svcUuid + ' | json -H';
+                    t.equal(instances.length, numInsts,
+                        'Service instances');
+                    checkInstancesExist(t, instances, function (instErr) {
+                        t.ifError(instErr,
+                            'Error checking service instances');
+                        next();
+                    });
 
-        exec(cmd2, function (err2, stdout2, stderr2) {
-            t.ifError(err2, svcUuid + ' service instance fetch');
-
-            var instances = common.parseJsonOut(stdout2);
-            if (!instances) {
-                t.ok(false, 'failed to parse JSON for cmd ' + cmd2);
-                return recur();
-            }
-
-            instances.forEach(function (inst) {
-                t.equal(inst.service_uuid, svcUuid); // sanity check
+                });
             });
-
-            // garganuan hack: napi is abused in create.test.js, so the
-            // instances listed here won't match what's normal
-            if (name === 'napi') {
-                t.ok(instances.length >= numInsts);
-                return recur();
-            } else {
-                t.equal(instances.length, numInsts);
-                checkInstancesExist(t, instances, recur);
-            }
-        });
+        },
+        inputs: servicesDetails
+    }, function (resErr) {
+        t.ifError(resErr, 'Error checking services');
+        t.end();
     });
 }
 
 
-function checkInstancesExist(t, instances, cb) {
-    if (instances.length === 0) {
-        return cb();
-    }
-
-    var instance = instances.pop();
-    var vmUuid = instance.uuid;
-    var cmd = 'sdc-vmapi /vms/' + vmUuid + ' | json -H';
-
-    exec(cmd, function (err, stdout, stderr) {
-        t.ifError(err, 'check service instance ' + vmUuid + ' actually exists');
-
-        var instanceDetails = common.parseJsonOut(stdout);
-        if (!instanceDetails) {
-            t.ok(false, 'failed to parse JSON for cmd ' + cmd);
-            return checkInstancesExist(t, instances, cb);
-        }
-
-        t.equal(instanceDetails.uuid, instance.uuid); // sanity check
-
-        checkInstancesExist(t, instances, cb);
-    });
-}
-
 
 // ---
 
 
 test('setup', function (t) {
     exec('sdc-sapi /services | json -H', function (err, stdout, stderr) {
-        t.ifError(err);
+        t.ifError(err, 'SAPI error');
 
         var servicesInfo = common.parseJsonOut(stdout);
         if (!servicesInfo) {
@@ -180,10 +190,10 @@ test('sdcadm svcs --help', function (t) {
 
 test('sdcadm services', function (t) {
     exec('sdcadm services', function (err, stdout, stderr) {
-        t.ifError(err);
-        t.equal(stderr, '');
+        t.ifError(err, 'Execution error');
+        t.equal(stderr, '', 'Empty stderr');
 
-        common.DEFAULT_SERVICES.forEach(function (svcName) {
+        common.DEFAULT_VM_SERVICES.forEach(function (svcName) {
             var found = stdout.indexOf(svcName) !== -1;
             t.ok(found, svcName + ' in instances output');
         });
-- 
2.21.0

