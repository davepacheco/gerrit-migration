From 1f3b8e739b785854393073312fcead24aa8f3132 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Fri, 2 Sep 2016 19:41:03 +0000
Subject: [PATCH] OS-5644 lx tmpfs mount with uid or gid option fails

---
 usr/src/uts/common/brand/lx/syscall/lx_mount.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/usr/src/uts/common/brand/lx/syscall/lx_mount.c b/usr/src/uts/common/brand/lx/syscall/lx_mount.c
index 825d70cf6a..604a796bf9 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_mount.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_mount.c
@@ -95,6 +95,9 @@ typedef struct mount_opt {
 /* From uts/common/syscall/umount.c */
 extern int umount2(char *, int);
 
+/* From lx_chown.c */
+extern long lx_vn_chown(vnode_t *, uid_t, gid_t);
+
 /*
  * Globals
  */
@@ -614,7 +617,11 @@ lx_mount(const char *sourcep, const char *targetp, const char *fstypep,
 	VFS_RELE(vfsp);
 	if (strcmp(fstype, "tmpfs") == 0 && (uid != -1 || gid != -1)) {
 		/* Handle tmpfs uid/gid mount options. */
-		(void) lx_chown(target, uid, gid);
+		if (lookupname(target, UIO_SYSSPACE, FOLLOW, NULLVPP,
+		    &vp) == 0) {
+			(void) lx_vn_chown(vp, (uid_t)uid, (gid_t)gid);
+			VN_RELE(vp);
+		}
 	}
 
 	return (0);
-- 
2.21.0

