{"project":"joyent/illumos-joyent","branch":"master","id":"I46f8347ef2704a099df610666a4ca49f88dabf80","number":"4567","subject":"OS-6620 bhyve reboot should reuse existing process Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@jo","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/4567","commitMessage":"OS-6620 bhyve reboot should reuse existing process\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1532525565,"lastUpdated":1534518842,"open":false,"status":"MERGED","comments":[{"timestamp":1532525565,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1532699215,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI think this is fine, but could you put an evaluation in the bug report."},{"timestamp":1532701656,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1532713187,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1532713382,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1533309805,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1533310115,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1533323246,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1533558527,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1\n\nPersonally I think it\u0027s fine with the header change, but also fine with the alternative."},{"timestamp":1533568795,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1533572629,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1533583100,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1533744945,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1533745072,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1533746267,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1533751088,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1533764949,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1534506321,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1534507631,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1534516367,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1534518809,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1534518842,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"6","revision":"a72f92c76cef0e035c3ae9af38ea6789c0676527","parents":["c6f905766eb40c4295246520607032b0d63fe48f"],"ref":"refs/changes/67/4567/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534518809,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533745072,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533746267,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533764949,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534507631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1534518842,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_object.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":50,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"5412f4544e5fb48695ce17a532e5d7c45f4166b7","parents":["38f64374d18ab98698fbcb42fd4cf987833fd27a"],"ref":"refs/changes/67/4567/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1532525565,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":640,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This looks like it will leak -\u003evrtc - think a ::findleaks is worth it?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":640,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It looks OK to me?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":640,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Yes, I missed that vrtc_init() is gated on create"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":667,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The reasoning for this needs a comment at the very least."},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":667,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":684,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This makes me a little uneasy for a couple reasons:\n1. It\u0027s reaching pretty deeply into the VM shim abstraction.  It\u0027s fine for brevity, I guess, but the fact that we\u0027re taking the liberty should probably be documented.\n\n2. Do we have a handle on what part of memory is necessary to be zeroed?  Is it lingering data in something like the ACPI/mp tables or device driver state?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":684,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"1: I\u0027ve refactored it to keep the abstraction intact. Should we ever implement a better way than bzero() to clear large regions this will automatically be used both here and in memseg allocation.\n\n2: I have really no idea. I didn\u0027t dig deep into the UEFI firmware to figure out whats wrong, I just concluded that it\u0027s likely old memory contents. I can do more experiments to narrow it down if you think thats useful. My guess would be that it\u0027s old ACPI stuff, but thats really only a guess."},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":684,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Let\u0027s at least get a ticket open about it so we might follow up on it later when we\u0027re taking a closer look at the UEFI firmware."},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":684,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done: OS-7110"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":14,"deletions":0}],"sizeInsertions":15,"sizeDeletions":-2},{"number":"2","revision":"bdaa8fb1de5abd6f28f68a7685a7b91a1fbb0aa6","parents":["3c9e3d9ba40d898ceec413492c6aa061d80286ba"],"ref":"refs/changes/67/4567/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1533309805,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533572629,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533558527,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":836,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Wouldn\u0027t it be better to make this static and get rid of the header file change?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":836,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I really have no strong opinion on this. It could be static, but then I\u0027d have to add a prototype to vmm.c or move it up before its first invocation."},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":836,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would vote for static with the prototype."},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","line":836,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":972,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Assert that \u0027vmo\u0027 is of type OBJT_DEFAULT?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","line":972,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_object.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":36,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/i86pc/sys/vmm.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":49,"sizeDeletions":-4},{"number":"3","revision":"3c13933cf72af886680fa5394bfac4839230ef96","parents":["3c9e3d9ba40d898ceec413492c6aa061d80286ba"],"ref":"refs/changes/67/4567/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1533744945,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533764949,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533745072,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533746267,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_object.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":50,"sizeDeletions":-4},{"number":"4","revision":"0946f59273b3cc0d157e1dd81403df9636dc2469","parents":["48810110f815c605fe76c7da807dcfc9f4962485"],"ref":"refs/changes/67/4567/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534506321,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533764949,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533745072,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534507631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533746267,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_object.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":50,"sizeDeletions":-4},{"number":"5","revision":"46f8347ef2704a099df610666a4ca49f88dabf80","parents":["48810110f815c605fe76c7da807dcfc9f4962485"],"ref":"refs/changes/67/4567/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534516367,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533764949,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533745072,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534507631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533746267,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_object.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":50,"sizeDeletions":-4},{"number":"6","revision":"a72f92c76cef0e035c3ae9af38ea6789c0676527","parents":["c6f905766eb40c4295246520607032b0d63fe48f"],"ref":"refs/changes/67/4567/6","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1534518809,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533764949,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533745072,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1534507631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1534518842,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1533746267,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/brand/bhyve/zone/boot.c","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vm/vm_object.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":38,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_vm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":50,"sizeDeletions":-4}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}