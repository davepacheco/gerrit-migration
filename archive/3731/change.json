{"project":"joyent/illumos-joyent","branch":"master","id":"Ic71361021aefa698da0636af512389499353e02d","number":"3731","subject":"OS-6829 bhyve can miss PIR wake-ups Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e Approved by: Bryan Cantrill \u003cbryan@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/3731","commitMessage":"OS-6829 bhyve can miss PIR wake-ups\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Bryan Cantrill \u003cbryan@joyent.com\u003e\nApproved by: Bryan Cantrill \u003cbryan@joyent.com\u003e\n","createdOn":1522191055,"lastUpdated":1522277829,"open":false,"status":"MERGED","comments":[{"timestamp":1522191055,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1522192710,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 1:\n\n(1 comment)\n\nLooks good, other than the question about the ASSERT"},{"timestamp":1522192909,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1522192942,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1522194019,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1522197977,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\nI ran the offending omnios workload on non-DEBUG and DEBUG kernels, both of which seemed to perform the necessary vCPU wake-ups to prevent the system from locking up."},{"timestamp":1522202621,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2:\n\n(2 comments)\n\nA couple of WTFs at least from my cursory reading of the changes AND of chapter 29 of the manual."},{"timestamp":1522202725,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1522202876,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1522203044,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Code-Review+1\n\nThank you, pardon my naivete."},{"timestamp":1522245734,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(3 comments)\n\nI only have comment comments :)"},{"timestamp":1522268623,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1522268652,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1522268761,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1522271128,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1522276726,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1522277794,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1522277829,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"c71361021aefa698da0636af512389499353e02d","parents":["4328d0a48dfc91c96c425a121cc858f78e9365d2"],"ref":"refs/changes/31/3731/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522277794,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522268761,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522271128,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522276726,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"SUBM","value":"1","grantedOn":1522277829,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":64,"sizeDeletions":-5},"patchSets":[{"number":"1","revision":"47f77e90600c9b50982b629efca1ca2dc13bb63e","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/31/3731/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522191055,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3333,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Is this ASSERT correct?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3333,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":51,"deletions":-5}],"sizeInsertions":51,"sizeDeletions":-5},{"number":"2","revision":"55a9a06aaec4b68e477cf3c5a8d75667d51641fb","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/31/3731/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522192909,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522194019,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3316,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is this macro used at all?  It\u0027s defined here but not used at all below.\n\nAlso, it\u0027s unusual to have the 2nd-lowest bit not set, 0xfffd \u003d\u003d 0b1111111111111101, no?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3316,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The mask was there as an example, but yeah, it should be only  the last bit which is clear.  I\u0027ll just remove it."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3330,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"For example, should this be PRIORITY not pending?"},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3330,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"No, it is the pending bit (the least significant one) which absolutely must be set."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":51,"deletions":-5}],"sizeInsertions":51,"sizeDeletions":-5},{"number":"3","revision":"8642d0b6d9b9452c931519034fbbce9f67dd9239","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/31/3731/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522202876,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522203044,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3365,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I had a comment here on how this made no sense until I realised I was checking rdsv3_impl.h\u0027s definition. Gah."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3375,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think I convinced myself that we\u0027re OK with stale SW bits (i.e. the corresponding bit has been posted+consumed already), but it might be worth expanding on WRT vmx_inject_intr() - namely that we\u0027ll never re-enter the guest with a stale SW prio bit."},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","line":3381,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"It\u0027s worth an explicit comment here explaining why it\u0027s OK to lose software pending bits."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":54,"deletions":-5}],"sizeInsertions":54,"sizeDeletions":-5},{"number":"4","revision":"183e8cc1a1a0705a3d507e0e3f9192628b0f442c","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/31/3731/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522268623,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":64,"sizeDeletions":-5},{"number":"5","revision":"08917262a4abb823f39d1a3136b220b6d33dc870","parents":["4328d0a48dfc91c96c425a121cc858f78e9365d2"],"ref":"refs/changes/31/3731/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522268652,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522276726,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522271128,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522268761,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":64,"sizeDeletions":-5},{"number":"6","revision":"c71361021aefa698da0636af512389499353e02d","parents":["4328d0a48dfc91c96c425a121cc858f78e9365d2"],"ref":"refs/changes/31/3731/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1522277794,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522276726,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"SUBM","value":"1","grantedOn":1522277829,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522271128,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522268761,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/vmm/intel/vmx.c","type":"MODIFIED","insertions":64,"deletions":-5}],"sizeInsertions":64,"sizeDeletions":-5}],"allReviewers":[{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}