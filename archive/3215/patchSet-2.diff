From 28c2537c0f344bc3cdb346cfc44a0285accb63a5 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 16 Jan 2018 16:11:15 +0100
Subject: [PATCH] TOOLS-1973 sdcadm up moray throws an exception when a VM
 never made it from SAPI into VMAPI

---
 lib/procedures/update-moray-v2.js | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/lib/procedures/update-moray-v2.js b/lib/procedures/update-moray-v2.js
index ded1934..6a83962 100644
--- a/lib/procedures/update-moray-v2.js
+++ b/lib/procedures/update-moray-v2.js
@@ -12,6 +12,7 @@ var assert = require('assert-plus');
 var sprintf = require('extsprintf').sprintf;
 var util = require('util');
 var vasync = require('vasync');
+var verror = require('verror');
 
 var errors = require('../errors');
 var common = require('../common');
@@ -130,6 +131,14 @@ UpdateMorayV2.prototype.execute = function morayv2Execute(opts, cb) {
                             uuid: tmpInst.uuid
                         }, function (vmErr, vm) {
                             if (vmErr) {
+                                if (verror.hasCauseWithName(
+                                    vmErr, 'ResourceNotFoundError')) {
+                                    ctx.tmpInstToRemove =
+                                        ctx.tmpInstToRemove || [];
+                                    ctx.tmpInstToRemove.push(tmpInst.uuid);
+                                    nextVm();
+                                    return;
+                                }
                                 nextVm(new errors.SDCClientError(vmErr,
                                     'vmapi'));
                                 return;
@@ -173,7 +182,8 @@ UpdateMorayV2.prototype.execute = function morayv2Execute(opts, cb) {
                     inputs: ctx.tmpInstToRemove,
                     func: function removeFromSapi(inst, nextInst) {
                         sdcadm.sapi.deleteInstance(inst, function (remErr) {
-                            if (remErr) {
+                            if (remErr && !verror.hasCauseWithName(remErr,
+                                'ResourceNotFoundError')) {
                                 nextInst(new errors.SDCClientError(remErr,
                                     'sapi'));
                                 return;
-- 
2.21.0

