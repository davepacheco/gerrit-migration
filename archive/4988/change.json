{"project":"joyent/illumos-joyent","branch":"master","id":"I0409882fb39df24b4d972e0267da997459a13712","number":"4988","subject":"OS-7318 hook_stack_notify_unregister can leave stack locked Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/4988","commitMessage":"OS-7318 hook_stack_notify_unregister can leave stack locked\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1540244920,"lastUpdated":1540418012,"open":false,"status":"MERGED","comments":[{"timestamp":1540244920,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1540313276,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1\n\nGood catch, and thanks for the analysis in the bug report."},{"timestamp":1540313758,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1540333579,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1540333607,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1540340150,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nBetter, sorry for missing the first bug, and what a mess."},{"timestamp":1540341008,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1540397611,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1540397862,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1540406623,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Integration-Approval+1\n\nThanks for the testing notes as well."},{"timestamp":1540417378,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1540417912,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1540418012,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jason King"}],"currentPatchSet":{"number":"5","revision":"7d3919ab7a2211492c9de34cc44e9ba9f2262b90","parents":["b6a0b04d591f5b877cfe05f45e81f0e8a5cfc2b3"],"ref":"refs/changes/88/4988/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1540417912,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540340150,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540397611,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540406623,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1540418012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":45,"deletions":-30}],"sizeInsertions":45,"sizeDeletions":-30},"patchSets":[{"number":"1","revision":"54fcca0e7d9a12f7b9d1cbdf0d49b265f1d1879f","parents":["504b3e4c2ecff2fc5ce62559b4ba11c33e33027c"],"ref":"refs/changes/88/4988/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1540244920,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540313276,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/io/hook.c","line":747,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The old code was repeating the hook_stack_get() lookup after re-entering hook_stack_lock after the unregistration callbacks.  Is it safe to reuse the cached pointer here?  If so, perhaps note why?"},{"file":"usr/src/uts/common/io/hook.c","line":747,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"The short version is that once a flag is set, the stack won\u0027t go away, so it\u0027ll be valid.  However that revealed another slight issue that I\u0027m going to fix while here (if hook_wait_setflag returns -1, something else is already waiting to tear this down).  I\u0027ll have another update posted shortly, including comments that hopefully clear up some of this mess."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":30,"deletions":-31}],"sizeInsertions":30,"sizeDeletions":-31},{"number":"2","revision":"d7b90551324edc3462ff4f956c48c3d881148ee1","parents":["504b3e4c2ecff2fc5ce62559b4ba11c33e33027c"],"ref":"refs/changes/88/4988/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1540333607,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540397611,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540340150,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/io/hook.c","line":765,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Where does this constant come from?  Not a dealbreaker, as I see it elsewhere, but wow..."},{"file":"usr/src/uts/common/io/hook.c","line":765,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"It\u0027s of course not documented anywhere in the framework :) - I suppose the closest thing to being defined would be in hook_stack_{shutdown, destroy}.\n\nSince the hook module is itself a netstack module, when it\u0027s netstack \u0027shutdown\u0027 callback is invoked, it sets hks_shutdown to \u00271\u0027 the hook stack instance, and then \u00272\u0027 when it\u0027s \u0027fini\u0027 netstack callback is invoked (the latter indicating that things should get deallocated).  Here it\u0027s a bit more complicated since all the callbacks need to be unregistered before the stack instance can be freed -- the hook_stack_remove call will attempt to do so."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":45,"deletions":-30}],"sizeInsertions":45,"sizeDeletions":-30},{"number":"3","revision":"9f25b031983e1e73049ecbdcecb61bb60413082f","parents":["504b3e4c2ecff2fc5ce62559b4ba11c33e33027c"],"ref":"refs/changes/88/4988/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1540397862,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540397611,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540340150,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540406623,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":45,"deletions":-30}],"sizeInsertions":45,"sizeDeletions":-30},{"number":"4","revision":"0409882fb39df24b4d972e0267da997459a13712","parents":["504b3e4c2ecff2fc5ce62559b4ba11c33e33027c"],"ref":"refs/changes/88/4988/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1540417378,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540397611,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540340150,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540406623,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":45,"deletions":-30}],"sizeInsertions":45,"sizeDeletions":-30},{"number":"5","revision":"7d3919ab7a2211492c9de34cc44e9ba9f2262b90","parents":["b6a0b04d591f5b877cfe05f45e81f0e8a5cfc2b3"],"ref":"refs/changes/88/4988/5","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1540417912,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540397611,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1540418012,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1540340150,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1540406623,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/io/hook.c","type":"MODIFIED","insertions":45,"deletions":-30}],"sizeInsertions":45,"sizeDeletions":-30}],"allReviewers":[{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}]}