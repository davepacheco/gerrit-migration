{"project":"joyent/mountain-gorilla","branch":"master","id":"I23fe17f1d6299103b2686d9f8f85cb5686addd0f","number":"5039","subject":"TOOLS-2104 MG should be able to build a Gerrit changeset Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"url":"https://cr.joyent.us/5039","commitMessage":"TOOLS-2104 MG should be able to build a Gerrit changeset\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1541630586,"lastUpdated":1542643296,"open":false,"status":"MERGED","comments":[{"timestamp":1541630586,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 1."},{"timestamp":1541630587,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 3a85238be88792e38e5f98f1a2831451bf2acaf2\n    \n    TOOLS-2104 MG should be able to build a Gerrit changeset"},{"timestamp":1541630603,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1: Code-Review-1\n\nnot ready for a proper review yet"},{"timestamp":1542038685,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 2."},{"timestamp":1542038688,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit d3f508a639ba33687dc173a58a4251923da4188a\n    \n    m"},{"timestamp":1542039020,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: -Code-Review"},{"timestamp":1542328639,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)\n\nLooking good.\n\nHave you had a chance to push this to a GitHub branch and do a try-branch build of some component to make sure the TRY_BRANCH stuff hasn\u0027t been broken by your changes?\n\nThen I guess the next step would be to add a \"GERRIT_CR\" param to the Jenkins jobs."},{"timestamp":1542361006,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 3."},{"timestamp":1542361008,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 682ef782ca5a7c35e58cfa8805bfe9011f95f236\n    \n    m"},{"timestamp":1542361307,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\n(2 comments)\n\nI\u0027m building https://jenkins.joyent.us/job/platform-debug-gcc7/28/\nright now with these changes on the gcc-update branch.\n\nI also directly tested this with:\n\nhttps://jenkins.joyent.us/job/platform-debug-gerrit/17/\n\n(To do this, I had to hack up the gerrit-jenkins branch to *not* TRY_BRANCH switch gerrit itself!)"},{"timestamp":1542395725,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1542640777,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1542643296,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by John Levon"}],"currentPatchSet":{"number":"4","revision":"23fe17f1d6299103b2686d9f8f85cb5686addd0f","parents":["de8af64dad24b35599617dc887e5bccc5397985c"],"ref":"refs/changes/39/5039/4","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542640777,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542395725,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542395725,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1542643296,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"configure","type":"MODIFIED","insertions":64,"deletions":-38},{"file":"docs/index.md","type":"MODIFIED","insertions":11,"deletions":0},{"file":"smartos-live-configure-branches-smartos.in","type":"DELETED","insertions":0,"deletions":-5},{"file":"smartos-live-configure-branches.in","type":"DELETED","insertions":0,"deletions":-6},{"file":"targets.json.in","type":"MODIFIED","insertions":88,"deletions":-88},{"file":"tools/jenkins-build","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":167,"sizeDeletions":-150},"patchSets":[{"number":"1","revision":"67358d91873b8c8d9ca88844c0c5ef5a2ab0dd58","parents":["de8af64dad24b35599617dc887e5bccc5397985c"],"ref":"refs/changes/39/5039/1","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1541630586,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1541630603,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"configure","type":"MODIFIED","insertions":56,"deletions":-34},{"file":"smartos-live-configure-branches-smartos.in","type":"DELETED","insertions":0,"deletions":-5},{"file":"smartos-live-configure-branches.in","type":"DELETED","insertions":0,"deletions":-6},{"file":"targets.json.in","type":"MODIFIED","insertions":88,"deletions":-88},{"file":"tools/jenkins-build","type":"MODIFIED","insertions":15,"deletions":-14}],"sizeInsertions":160,"sizeDeletions":-158},{"number":"2","revision":"4c9aab577ee24631b8b5c67f104aea6778d09efc","parents":["de8af64dad24b35599617dc887e5bccc5397985c"],"ref":"refs/changes/39/5039/2","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542038685,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"configure","line":484,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: It would be slightly cleaner for get_repo2 to have the Gerrit CR passed in, as is done with TRY-BRANCH, rather than relying on the global (notwithstanding the current reliance on the MG_CACHE_DIR global). So, something like this:\n\n```\ndiff --git a/configure b/configure\nindex 4706422..09e9fd5 100755\n--- a/configure\n+++ b/configure\n@@ -442,7 +442,7 @@ function get_repo_cache() {\n \n # Get the requested repo.\n # Usage:\n-#   get_repo2 REPO-URL BRANCH SUBMODULE-UPDATE [NAME] [TRY-BRANCH]\n+#   get_repo2 REPO-URL BRANCH SUBMODULE-UPDATE [NAME] [TRY-BRANCH] [GERRIT-CR]\n #\n # If \"SUBMODULE-UPDATE\" is \"true\", then \"git submodule update ...\" is\n # used on the repo.\n@@ -456,6 +456,7 @@ function get_repo2() {\n     local submodule_update\u003d$3\n     local repo_dir\u003d$4\n     local try_branch\u003d$5\n+    local gerrit_cr\u003d$6\n \n     if [[ -z \"$repo_dir\" ]]; then\n         repo_dir\u003d${repo_url##*/}    # strip to last \u0027/\u0027\n@@ -474,6 +475,9 @@ function get_repo2() {\n     if [[ ! -z \"$try_branch\" ]]; then\n         (cd build/$repo_dir ; git checkout $try_branch \u0026\u0026 git pull || true)\n     fi\n+\n+    # ... using \u0027$gerrit_cr\u0027\n+\n     if [[ \"$submodule_update\" \u003d\u003d \"true\" ]]; then\n         (cd \"build/$repo_dir\" \u0026\u0026\n             git submodule sync $GIT_SUBMODULE_SYNC_FLAGS \u0026\u0026\n@@ -600,7 +604,7 @@ function get_target_repos() {\n         local repo_dir\u003d$(echo \"$info\" | cut -d, -f 2)\n         local submodule_update\u003d$(echo \"$info\" | cut -d, -f 3)\n         [[ -z \"$submodule_update\" ]] \u0026\u0026 submodule_update\u003dtrue\n-        get_repo2 $repo_url $BRANCH \"$submodule_update\" \"$repo_dir\" \"$TRY_BRANCH\"\n+        get_repo2 $repo_url $BRANCH \"$submodule_update\" \"$repo_dir\" \"$TRY_BRANCH\" \"$MG_GERRIT_CR\"\n     done\n }\n \n```"},{"file":"configure","line":484,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Done"},{"file":"configure","line":574,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Presentation of these options, at least some of the leading ones, were intentionally grouped by relation. I.e. -b and -B were together because they are about branch selection."},{"file":"configure","line":574,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m aware, but ultimately felt that it was getting too unwieldy to try and group like that with so many options - case in point being the documentation of a non-existent option, which I only caught from being able to sort and compare all three option list places."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"configure","type":"MODIFIED","insertions":58,"deletions":-36},{"file":"docs/index.md","type":"MODIFIED","insertions":11,"deletions":0},{"file":"smartos-live-configure-branches-smartos.in","type":"DELETED","insertions":0,"deletions":-5},{"file":"smartos-live-configure-branches.in","type":"DELETED","insertions":0,"deletions":-6},{"file":"targets.json.in","type":"MODIFIED","insertions":88,"deletions":-88},{"file":"tools/jenkins-build","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":161,"sizeDeletions":-148},{"number":"3","revision":"d47b79a9669b0ff13b620748ea569d8b0c98ea0f","parents":["de8af64dad24b35599617dc887e5bccc5397985c"],"ref":"refs/changes/39/5039/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542361006,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542395725,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542395725,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"configure","type":"MODIFIED","insertions":64,"deletions":-38},{"file":"docs/index.md","type":"MODIFIED","insertions":11,"deletions":0},{"file":"smartos-live-configure-branches-smartos.in","type":"DELETED","insertions":0,"deletions":-5},{"file":"smartos-live-configure-branches.in","type":"DELETED","insertions":0,"deletions":-6},{"file":"targets.json.in","type":"MODIFIED","insertions":88,"deletions":-88},{"file":"tools/jenkins-build","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":167,"sizeDeletions":-150},{"number":"4","revision":"23fe17f1d6299103b2686d9f8f85cb5686addd0f","parents":["de8af64dad24b35599617dc887e5bccc5397985c"],"ref":"refs/changes/39/5039/4","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542640777,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542395725,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542395725,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1542643296,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"configure","type":"MODIFIED","insertions":64,"deletions":-38},{"file":"docs/index.md","type":"MODIFIED","insertions":11,"deletions":0},{"file":"smartos-live-configure-branches-smartos.in","type":"DELETED","insertions":0,"deletions":-5},{"file":"smartos-live-configure-branches.in","type":"DELETED","insertions":0,"deletions":-6},{"file":"targets.json.in","type":"MODIFIED","insertions":88,"deletions":-88},{"file":"tools/jenkins-build","type":"MODIFIED","insertions":3,"deletions":-2}],"sizeInsertions":167,"sizeDeletions":-150}],"allReviewers":[{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}