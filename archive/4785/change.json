{"project":"joyent/triton-cns","branch":"master","id":"I9d186082f8939fbc72b10163794e218b9a8ce1d2","number":"4785","subject":"TRITON-749 CNS reaper marks things as reaped *before* reaping them Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/4785","commitMessage":"TRITON-749 CNS reaper marks things as reaped *before* reaping them\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1536108050,"lastUpdated":1536283365,"open":false,"status":"MERGED","comments":[{"timestamp":1536108050,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1536108078,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1536110840,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1536110870,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536171566,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1536174440,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1536174472,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1536175857,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1536179939,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1536182794,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\nThanks for clarifying this. I think I understand this and I think it makes sense."},{"timestamp":1536283189,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1536283193,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1536283262,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1536283268,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"},{"timestamp":1536283365,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"5","revision":"7212189f1398f2e4c0b5252bd970cdc3e141231e","parents":["db26c78fccf707417a7d919e08d8b70554246043"],"ref":"refs/changes/85/4785/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536283262,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536174472,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536182794,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283189,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1536283268,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":60,"deletions":-7}],"sizeInsertions":60,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"e19b574e0c817b2ae87882a1a82f123dbfb46b0c","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/85/4785/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536108050,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1536108078,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/reaper-stream.js","line":203,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"},{"file":"lib/reaper-stream.js","line":203,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer val hides an identifier in a parent scope"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":19,"deletions":-7}],"sizeInsertions":19,"sizeDeletions":-7},{"number":"2","revision":"877ee4535ceaf6f0dd05cc4c53a79dfc99a82ebc","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/85/4785/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536110840,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536110870,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/reaper-stream.js","line":206,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This FSM really deserves a comment explaining it in general."},{"file":"lib/reaper-stream.js","line":210,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"A comment or something explaining how this can happen would be appreciated. It\u0027s not clear to me right now how we end up in this state."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":19,"deletions":-7}],"sizeInsertions":19,"sizeDeletions":-7},{"number":"3","revision":"9d186082f8939fbc72b10163794e218b9a8ce1d2","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/85/4785/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536174440,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536182794,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283189,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536174472,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/reaper-stream.js","line":238,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Just to make sure I\u0027m understanding this correctly. This would happen because we end up in a situation where even though we think it\u0027s destroyed, redis doesn\u0027t have the record that it\u0027s destroyed. So for now we skip it until the normal processing comes back around and marks in redis that it should be destroyed and then we come back here again."},{"file":"lib/reaper-stream.js","line":238,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We end up in a situation where:\n\n * This VM has produced DNS records in the past\n * We have not examined it (it hasn\u0027t made it through the pipeline) for \u003e1hr\n * We tried to visit it once before and marked it as \"reaped\"\n * But it still has records in the live zone associated with it\n\nThis situation implies that the time when we visited it once before and market it as \"reaped\" failed to update things in some way (e.g. because after pushing it into the pipeline, the cns-updater crashed, or there\u0027s some other bug happening)\n\nThe status as \"destroyed\" is not what we look at for anything except deciding whether to mark the VM as \"reaped\" -- we do it there as a bit of a paranoid double-check.\n\nIt\u0027s important to note that the call to .push() does *not* wait for anything to complete. None of the code in ReaperStream really has any way to be sure whether the record it pushed into the stream was completely processed or not (and this might not happen for up to 10+ seconds after we push it, because of the nature of batched zone updates in CNS)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":60,"deletions":-7}],"sizeInsertions":60,"sizeDeletions":-7},{"number":"4","revision":"996895062a17f10dd092f9d0160072c60d94315a","parents":["1cf0030efbf067ca4960a443211a91c586992706"],"ref":"refs/changes/85/4785/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536283193,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536182794,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283189,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536174472,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":60,"deletions":-7}],"sizeInsertions":60,"sizeDeletions":-7},{"number":"5","revision":"7212189f1398f2e4c0b5252bd970cdc3e141231e","parents":["db26c78fccf707417a7d919e08d8b70554246043"],"ref":"refs/changes/85/4785/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1536283262,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1536182794,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1536283189,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1536283268,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1536174472,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/reaper-stream.js","type":"MODIFIED","insertions":60,"deletions":-7}],"sizeInsertions":60,"sizeDeletions":-7}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}