commit 620d21c3408f1bf8d94934c6d098b786ba08845e (refs/changes/28/4528/3)
Author: Rui Loura <rui@joyent.com>
Date:   2018-07-23T14:11:09+00:00 (1 year, 3 months ago)
    
    TRITON-603 cnapi should be aware of alternate admin nictags

diff --git a/lib/app.js b/lib/app.js
index 3edde1c..04b1b79 100644
--- a/lib/app.js
+++ b/lib/app.js
@@ -589,6 +589,12 @@ App.prototype.haveSysinfoNicsChanged = function (sysinfo, fullNapiList) {
     var toAddNics = [];
     var toUpdateNics = [];
     var uuid = sysinfo['UUID'];
+    var adminTag = 'admin';
+    var sysAdminTag = sysinfo['Admin NIC Tag'];
+
+    if (sysAdminTag) {
+        adminTag = sysAdminTag;
+    }
 
     for (n in sysinfo['Network Interfaces']) {
         sysinfoNics[n] = sysinfo['Network Interfaces'][n];
@@ -660,8 +666,12 @@ App.prototype.haveSysinfoNicsChanged = function (sysinfo, fullNapiList) {
                 newNic.nic_tags_provided = sysinfoNic['NIC Names'];
             }
 
+            /*
+             * Only the admin nic should be on the PHYS datalink and have
+             * an IP (and thus no VLAN id).
+             */
             if (!sysinfoNic.hasOwnProperty('VLAN') && sysinfoNic.ip4addr) {
-                newNic.nic_tag = 'admin';
+                newNic.nic_tag = adminTag;
                 newNic.vlan_id = 0;
             }
 
diff --git a/lib/common.js b/lib/common.js
index 7fd600c..f721517 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -108,6 +108,11 @@ function orderedKVString(obj) {
 function getAdminIp(sysinfo) {
     var interfaces;
     var ip;
+    var admin_tag = 'admin';
+
+    if (sysinfo['Admin NIC Tag']) {
+        admin_tag = sysinfo['Admin NIC Tag'];
+    }
 
     interfaces = sysinfo['Network Interfaces'];
 
@@ -117,7 +122,7 @@ function getAdminIp(sysinfo) {
         }
 
         var nic = interfaces[iface]['NIC Names'];
-        var isAdmin = nic.indexOf('admin') !== -1;
+        var isAdmin = nic.indexOf(admin_tag) !== -1;
         if (isAdmin) {
             ip = interfaces[iface]['ip4addr'];
             return ip;
diff --git a/lib/models/server.js b/lib/models/server.js
index 016fb62..cb77f18 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -2174,10 +2174,10 @@ function (opts) {
                 // instead of trying to fish the IP out of the networks.
                 serverAdminIp = sysinfo['CN Agent IP'];
             } else {
-                try {
-                    serverAdminIp = firstAdminIp(sysinfo);
-                } catch (e) {
-                    wfcb(new VError(e, 'parsing server ip address'));
+                serverAdminIp = common.getAdminIp(sysinfo);
+                if (!serverAdminIp) {
+                    wfcb(new VError('parsing server ip address in sendTaskReq '
+                        + '(No admin NICs detected.)'));
                     return;
                 }
             }
@@ -2382,10 +2382,10 @@ ModelServer.prototype.sendRequest = function (opts, cb) {
                 // instead of trying to fish the IP out of the networks.
                 serverAdminIp = sysinfo['CN Agent IP'];
             } else {
-                try {
-                    serverAdminIp = firstAdminIp(sysinfo);
-                } catch (e) {
-                    wfcb(new VError(e, 'parsing server ip address'));
+                serverAdminIp = common.getAdminIp(sysinfo);
+                if (!serverAdminIp) {
+                    wfcb(new VError('parsing server ip address in sendReq '
+                        + '(No admin NICs detected.)'));
                     return;
                 }
             }
@@ -2477,33 +2477,4 @@ ModelServer.prototype.getWaitlist = function () {
 };
 
 
-function firstAdminIp(sysinfo) {
-    var interfaces;
-    var addr;
-
-    // first see if we have an override in the sysinfo
-    addr = sysinfo['Admin IP'];
-    if (addr) {
-        return addr;
-    }
-
-    interfaces = sysinfo['Network Interfaces'];
-
-    for (var iface in interfaces) {
-        if (!interfaces.hasOwnProperty(iface)) {
-            continue;
-        }
-
-        var nic = interfaces[iface]['NIC Names'];
-        var isAdmin = nic.indexOf('admin') !== -1;
-        if (isAdmin) {
-            addr = interfaces[iface]['ip4addr'];
-            return addr;
-        }
-    }
-
-    throw new Error('No NICs with name "admin" detected.');
-}
-
-
 module.exports = ModelServer;
diff --git a/lib/workflows/server-sysinfo.js b/lib/workflows/server-sysinfo.js
index b07b223..40e3e11 100644
--- a/lib/workflows/server-sysinfo.js
+++ b/lib/workflows/server-sysinfo.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -179,6 +179,13 @@ function getExistingAggrs(job, cb) {
 
 function getServerNics(job, cb) {
     var napi = new sdcClients.NAPI({ url: napiUrl });
+    var adminTag = 'admin';
+    var sysAdminTag = job.params.sysinfo['Admin NIC Tag'];
+
+    if (sysAdminTag) {
+        adminTag = sysAdminTag;
+    }
+
     napi.getNics(job.params.sysinfo['UUID'], function (err, nics) {
         if (err) {
             cb(err);
@@ -261,8 +268,12 @@ function getServerNics(job, cb) {
                     newNic.nic_tags_provided = sysinfoNic['NIC Names'];
                 }
 
+                /*
+                 * Only the admin nic should be on the PHYS datalink and have
+                 * an IP (and thus no VLAN id).
+                 */
                 if (!sysinfoNic.hasOwnProperty('VLAN') && sysinfoNic.ip4addr) {
-                    newNic.nic_tag = 'admin';
+                    newNic.nic_tag = adminTag;
                     newNic.vlan_id = 0;
                 }
 
