{"project":"joyent/sdc-manta","branch":"master","topic":"MANTA-2587","id":"I8e07e20846642c577cbce88a6778c8bb65496b14","number":"854","subject":"MANTA-2587 manta-net.sh Needs to Support Adding tags to Aggregations MANTA-2150 manta net config and validate allows for mac addresses to have single-digits between :: Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Jordan Hendricks \u003cjordan.hen","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/854","commitMessage":"MANTA-2587 manta-net.sh Needs to Support Adding tags to Aggregations\nMANTA-2150 manta net config and validate allows for mac addresses to have single-digits between ::\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\n","createdOn":1478534638,"lastUpdated":1479396681,"open":false,"status":"MERGED","comments":[{"timestamp":1478534638,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1478534698,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n json --validate -f config/services/jobpuller/service.json.production\n json --validate -f config/services/postgres/service.json.lab\n json --validate -f config/services/postgres/service.json\n json --validate -f config/services/postgres/service.json.production\n json --validate -f config/services/propeller/service.json.production\n json --validate -f config/services/propeller/service.json\n json --validate -f config/services/madtom/service.json\n json --validate -f config/services/madtom/service.json.production\n json --validate -f config/services/madtom/service.json.coal\n json --validate -f config/services/authcache/service.json.production\n json --validate -f config/services/authcache/service.json\n json --validate -f config/services/marlin-dashboard/service.json.production\n json --validate -f config/services/marlin-dashboard/service.json\n json --validate -f config/services/webapi/service.json.production\n json --validate -f config/services/webapi/service.json.lab\n json --validate -f config/services/webapi/service.json\n json --validate -f config/services/webapi/service.json.coal\n json --validate -f config/application.json\n json --validate -f manifests/applications/manta/registrar/manifest.json\n json --validate -f manifests/applications/manta/ssh_public_key/manifest.json\n json --validate -f manifests/applications/manta/ssh_private_key/manifest.json\n json --validate -f manifests/applications/manta/common/manifest.json\n json --validate -f manifests/applications/manta/dns_client/manifest.json\n json --validate -f sapi_manifests/manta/manifest.json\n deps/jsstyle/jsstyle -o doxygen cmd/manta-factoryreset.js cmd/manta-merge-config.js cmd/manta-replace-cert.js cmd/manta-undeploy.js cmd/manta-init.js cmd/manta-shardadm.js cmd/manta-oneach.js cmd/manta-adm.js cmd/manta-deploy.js cmd/manta-marlin.js lib/sdc.js lib/ssl.js lib/services.js lib/adm.js lib/ssh.js lib/deploy.js lib/common.js lib/oneach/oneach.js lib/oneach/cli.js lib/layout.js test/tst.oneach_cmd.js test/common.js test/tst.services.js test/tst.oneach_cli.js test/tst.oneach_exec.js test/tst.zk.js test/CollectorStream.js test/tst.layout.js test/tst.adm.js test/tst.oneach_formatters.js\n Unescaped left brace in regex is deprecated, passed through in regex; marked by \u003c-- HERE in m/\\S{ \u003c-- HERE / at deps/jsstyle/jsstyle line 666.\n bash -n scripts/user-script.sh\n bash -n tools/add-dev-user\n bash -n bin/manta-deploy-lab\n bash -n networking/manta-net.sh\n /tmp/repo/build/node/bin/node tools/bashstyle scripts/user-script.sh\n /tmp/repo/build/node/bin/node tools/bashstyle tools/add-dev-user\n /tmp/repo/build/node/bin/node tools/bashstyle bin/manta-deploy-lab\n /tmp/repo/build/node/bin/node tools/bashstyle networking/manta-net.sh\n networking/manta-net.sh: 392: line exceeds 80 columns\n networking/manta-net.sh: 413: line exceeds 80 columns\n networking/manta-net.sh: 414: line exceeds 80 columns\n networking/manta-net.sh: 415: line exceeds 80 columns\n networking/manta-net.sh: 416: line exceeds 80 columns\n networking/manta-net.sh: 417: line exceeds 80 columns\n networking/manta-net.sh: 422: line exceeds 80 columns\n networking/manta-net.sh: 423: line exceeds 80 columns\n networking/manta-net.sh: 424: line exceeds 80 columns\n networking/manta-net.sh: 426: line exceeds 80 columns\n networking/manta-net.sh: 427: line exceeds 80 columns\n networking/manta-net.sh: 428: line exceeds 80 columns\n networking/manta-net.sh: 432: line exceeds 80 columns\n tools/mk/Makefile.targ:178: recipe for target \u0027networking/manta-net.sh.bashstyle\u0027 failed\n gmake: *** [networking/manta-net.sh.bashstyle] Error 1"},{"timestamp":1478535886,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1478535940,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478538012,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1478538064,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478633350,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(8 comments)"},{"timestamp":1478691296,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1478691340,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478692092,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(8 comments)\n\nThanks for the feedback so far.\n\nYou\u0027re right; the sdc-napi error checks are rather limited if I\u0027m just checking for non-zero output (for example, napi returns a 500, we\u0027ll get a 0 exit code). \n\nI\u0027m struggling to think of a good way to deal with this. For example, manta-net.sh@468: sdc-napi could (rarely) respond with a non-zero exit code, but it could also very well respond with a HTTP 500 (0 exit code). In the HTTP 500  case, we\u0027ll not match the nic tag via grep, and we\u0027ll continue to attempt to add the (now duplicate) nic tag, because the HTTP 500 response body will pass through `json` without complaints.\n\nThis kind of return value checking applies in a few places (@445, @468, @470, and @477), so if you have any suggestions on the best course of action here I\u0027d appreciate the input."},{"timestamp":1478710627,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Topic set to MANTA-2587"},{"timestamp":1478730812,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(1 comment)\n\nEverything here looks good, thanks for putting this together. I think I\u0027m still a little confused on the style aspects of the networking/validate.js. I\u0027m a bit surprised that it allowed a tab indentation for the continuation. Would you terribly mind making sure the if statements have four space continuations?"},{"timestamp":1478775045,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1478775104,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478775239,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1478776805,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1478780997,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6."},{"timestamp":1478781046,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478800497,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1478805693,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6:\n\n(3 comments)\n\nGreat work! Is there a summary of how you tested this change somewhere? Apologies if I\u0027ve missed it."},{"timestamp":1478864942,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 6:\n\n(3 comments)\n\nFor testing I\u0027ve been deploying my changes to coal/emy-14 and running the script, verifying that the tags get added to the correct mac/aggr. \n\nTesting of validate.js is easier, as I\u0027ve been able to create a range of netconfig.json files locally and run validate.js against them, where the expected outcome for a validated config should be a 0 exit code. \n\nI believe the above tests are enough for the new changes made to the code, but for completeness I\u0027ve created a test build (7c08eff0-a800-11e6-a0c7-232fe78db2ad) which includes your suggested changes against patch set 6 in order to go through this new config structure on coal as part of the normal manta deployment process with aggregations included. This is currently in progress, so I\u0027ll update this CR when complete. \n\nFor backwards compatibility testing I\u0027ve used this test build to deploy manta into emy-14/coal using existing install documentation/scripts (e.g. genmanta.js and gen-coal.sh) and no regressions were found. \n\nHopefully that clarifies the testing, but let me know if there\u0027s anything else I can expand on!"},{"timestamp":1478868389,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 7."},{"timestamp":1478868446,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478882338,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1479143950,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7: Integration-Approval+1"},{"timestamp":1479290011,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 8."},{"timestamp":1479290056,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1479290329,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 8:\n\nSorry about this, but on my last round of testing I noticed that I passed the wrong variable to sdc-server. This means that if there was a non-expanded mac address in the config (e.g. \"0:c:29:ce:e3:9c\"), it would get expanded correctly by the script (MANTA-2150) to $mac, but I passed the original, non-expanded version ($interface) to sdc-server.\n\nThis recent patch set addresses this by passing the expanded mac address to sdc-server, and I\u0027ve tested this minor change against my COAL installation to verify the tag gets added correctly."},{"timestamp":1479323388,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1479324073,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 8: Integration-Approval+1"},{"timestamp":1479396606,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1479396681,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"9","revision":"8e07e20846642c577cbce88a6778c8bb65496b14","parents":["f6518de961b3aaf0ac9f5ce3cb4a8f63e2dd76a9"],"ref":"refs/changes/54/854/9","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1479396606,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479290056,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479323388,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479324073,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1479396681,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":106,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":42,"deletions":-26}],"sizeInsertions":149,"sizeDeletions":-45},"patchSets":[{"number":"1","revision":"c4a10a742b562658a851f90c1150c30779f022b6","parents":["e689b657352ee94b9492ba13f15c1d4284cbb713"],"ref":"refs/changes/54/854/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478534638,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1478534698,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":48,"deletions":-17},{"file":"networking/validate.js","type":"MODIFIED","insertions":49,"deletions":-8}],"sizeInsertions":97,"sizeDeletions":-25},{"number":"2","revision":"4f1fb631dd5929f2cedbff8bfd13ee8cb486d1c1","parents":["e689b657352ee94b9492ba13f15c1d4284cbb713"],"ref":"refs/changes/54/854/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478535886,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478535940,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":57,"deletions":-17},{"file":"networking/validate.js","type":"MODIFIED","insertions":49,"deletions":-8}],"sizeInsertions":106,"sizeDeletions":-25},{"number":"3","revision":"9940fb4ca689613b17cbf1a1c7b421e09e74af77","parents":["e689b657352ee94b9492ba13f15c1d4284cbb713"],"ref":"refs/changes/54/854/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478538012,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478538064,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"networking/manta-net.sh","line":392,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Conventionally continuations are indented by four spaces as opposed to a whole tab. This is the case in a number of places, though I understand the style checker isn\u0027t great about that right now."},{"file":"networking/manta-net.sh","line":392,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"networking/manta-net.sh","line":397,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you add a comment that we\u0027re basically relying on the assumption that the new mode is a JSON structure which is why we\u0027re doing this?\n\nAlso, you don\u0027t need to use a subshell here, IIRC."},{"file":"networking/manta-net.sh","line":397,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"networking/manta-net.sh","line":399,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Because the assignment is going on, it may actually end up swallowing the exit code (I\u0027m not 100% sure). I\u0027d suggest you also check for an empty string like in the other cases. This is strue for all the other places in this function."},{"file":"networking/manta-net.sh","line":399,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like the error code will properly make its way out (for example, changing `json` to `jsonj` leads to `fatal` being hit), but I think it\u0027s going to be pretty rare that `json` will return non-zero, especially with `validate.js` doing much of the JSON validation. \n\nI have added more checking around empty strings, as you\u0027ve suggested, to ensure we have the values we expect."},{"file":"networking/manta-net.sh","line":427,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"See earlier note on the -z/-n checks. It\u0027s useful to do it on the intermediate parts."},{"file":"networking/manta-net.sh","line":427,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"networking/manta-net.sh","line":435,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be checking for failure along the way here? For example, what if sdc-napi fails?"},{"file":"networking/manta-net.sh","line":435,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I would like to, and now that you\u0027ve mentioned it, I think the failure scenario here (if sdc-napi fails, either non-zero or HTTP error) is that we\u0027ll _not_ hit the continue statement and proceed to attempt to add the tag, even if it may already exist, but I\u0027m not certain there. \n\nFWIW, this is a statement from the current version of the script (https://github.com/joyent/sdc-manta/blob/03836177b8a7bd1540d62dd14dfcbf9b2581a95a/networking/manta-net.sh#L403), but luckily it doesn\u0027t seem to appear anywhere else today.\n\nI\u0027ve considered assigning this output to something like `json` or `response` (example: https://github.com/joyent/sdc-manta/blob/03836177b8a7bd1540d62dd14dfcbf9b2581a95a/networking/manta-net.sh#L346) and check the output more thoroughly. I\u0027m happy that we could check against sdc-napi errors that return non-zero, but most cases it would actually return zero and we\u0027d get a HTTP error instead. I\u0027m not 100% how\u0027s best to check for this, but I\u0027ll try a few things and see."},{"file":"networking/manta-net.sh","line":435,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thinking about this some more, I think we can get the robustness we need by pulling in the whole NAPI response @430, then checking for the owner_uuid in the response (as opposed to all in-line). If no owner_uuid (@433), NAPI is clearly acting up. If we\u0027re OK here, we can use the previously stored response object to check against before continuing. \n\nThanks for pointing this out. I\u0027m going to put together another patch set to address this, as well as where this comes up in add_tag_to_aggr."},{"file":"networking/manta-net.sh","line":437,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be checking for sdc-server failure here?"},{"file":"networking/manta-net.sh","line":437,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This was intended to be done @412, but I have moved the error checking into each mac/aggr function, as they will need to be more specific."},{"file":"networking/manta-net.sh","line":440,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"See a lot of the minor style nits in the previous function and return value checking questions."},{"file":"networking/manta-net.sh","line":440,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Style and return value checking done in most cases, more to follow."},{"file":"networking/validate.js","line":33,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"When I saw this, I realized that the style looked incorrect. However, when I dug further, I realized that the problem is that this file isn\u0027t actually properly being checked by gmake check. Can you modify the Makefile to add networking directory to JS_FILES list in the Makefile and then clean up a bunch of the style issues here?"},{"file":"networking/validate.js","line":33,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":74,"deletions":-17},{"file":"networking/validate.js","type":"MODIFIED","insertions":49,"deletions":-8}],"sizeInsertions":123,"sizeDeletions":-25},{"number":"4","revision":"c67f43518974174aa417ce8ccd619770d8af58e2","parents":["e689b657352ee94b9492ba13f15c1d4284cbb713"],"ref":"refs/changes/54/854/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478691296,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478691340,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"networking/validate.js","line":33,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Does the style checker actually say that this is right? I would have complained about the tab indentation."},{"file":"networking/validate.js","line":33,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Apparently so. jsstyle _does_ appear to work against networking/validate.js as it complains if I make a line \u003e80 characters. \n\nNevertheless, thanks for pointing this out. I\u0027ve fixed this indentation here and in a few other places."},{"file":"networking/validate.js","line":53,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Should we be checking that this value actually exists in the config (i.e., `tag` is not undefined?). I don\u0027t believe I see that validated elsewhere in this script."},{"file":"networking/validate.js","line":53,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The check for \"marlin\" is done @127, and the check for \"nic_tag\" is done @142. This is a similar case for \"manta\", too. Having said that, these checks are performed *after* we reference them, so I\u0027ll move this section to a point in the code after they\u0027ve been checked for.\n\nThanks for pointing this out!"},{"file":"networking/validate.js","line":87,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This code is (and previously was, even before this change) nearly identical to the code that validates the marlin_nodes section of the config. Now that the validation code is a bit more complicated, it might make sense to abstract this into a helper function to make it a bit more maintainable and easier to follow in general."},{"file":"networking/validate.js","line":87,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Good point, thanks for mentioning it. Fixing this will also fix your comment @92, which was an oversight due to duplicate complex code."},{"file":"networking/validate.js","line":92,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think there should be a leading space before the \"i\" in the \u0027in mappings.\u0027 string so that it prints a space after the tag value."},{"file":"networking/validate.js","line":92,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"See comment @87."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":91,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":54,"deletions":-17}],"sizeInsertions":146,"sizeDeletions":-36},{"number":"5","revision":"ce439fa73b8c30944ff504d60712acf661097293","parents":["e689b657352ee94b9492ba13f15c1d4284cbb713"],"ref":"refs/changes/54/854/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478775045,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478775104,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":91,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":54,"deletions":-17}],"sizeInsertions":146,"sizeDeletions":-36},{"number":"6","revision":"56d802e0cf9e5f6428c743a6d182b86d703a43f2","parents":["e689b657352ee94b9492ba13f15c1d4284cbb713"],"ref":"refs/changes/54/854/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478780997,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478800497,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478781046,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":106,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":54,"deletions":-17}],"sizeInsertions":161,"sizeDeletions":-36},{"number":"7","revision":"812065cc0140d99a00bc86e1232539835a48ec2d","parents":["f6518de961b3aaf0ac9f5ce3cb4a8f63e2dd76a9"],"ref":"refs/changes/54/854/7","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1478868389,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478882338,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478868446,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479143950,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":106,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":42,"deletions":-26}],"sizeInsertions":149,"sizeDeletions":-45},{"number":"8","revision":"8d9370864ffaf75de3e39e3fc013b8fa955d944c","parents":["f6518de961b3aaf0ac9f5ce3cb4a8f63e2dd76a9"],"ref":"refs/changes/54/854/8","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1479290011,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479323388,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479290056,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479324073,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":106,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":42,"deletions":-26}],"sizeInsertions":149,"sizeDeletions":-45},{"number":"9","revision":"8e07e20846642c577cbce88a6778c8bb65496b14","parents":["f6518de961b3aaf0ac9f5ce3cb4a8f63e2dd76a9"],"ref":"refs/changes/54/854/9","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1479396606,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1479323388,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1479290056,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1479324073,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"SUBM","value":"1","grantedOn":1479396681,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"networking/manta-net.sh","type":"MODIFIED","insertions":106,"deletions":-18},{"file":"networking/validate.js","type":"MODIFIED","insertions":42,"deletions":-26}],"sizeInsertions":149,"sizeDeletions":-45}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}