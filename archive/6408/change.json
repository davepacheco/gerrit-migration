{"project":"joyent/node-zkstream","branch":"master","id":"I7e36366cf36385021401379ddc98bbe105dd05fc","number":"6408","subject":"joyent/node-zkstream#46 ZKConnectionFSM does not emit anything on outstanding requests when closing Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/6408","commitMessage":"joyent/node-zkstream#46 ZKConnectionFSM does not emit anything on outstanding requests when closing\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1559870405,"lastUpdated":1559948353,"open":false,"status":"MERGED","comments":[{"timestamp":1559870405,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1559870431,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1559870475,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1559870520,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559932249,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1559932993,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1559933128,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1559933173,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559933239,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1559935782,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1559943067,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1559944776,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1559948257,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1559948344,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1559948353,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"4","revision":"353a86ff8ee33228b4229030f974b43d4c31ca13","parents":["3a8628ffea851d46880b2ed499189a07e243bad3"],"ref":"refs/changes/08/6408/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559948344,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559933173,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559943067,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559948257,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1559948353,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":47,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"5aa75d193524f66179d0fd698df5c7767367c1a1","parents":["3a8628ffea851d46880b2ed499189a07e243bad3"],"ref":"refs/changes/08/6408/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559870405,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1559870431,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"test/basic.test.js","line":1317,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: connected"},{"file":"test/basic.test.js","line":1318,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: closed"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":43,"deletions":0}],"sizeInsertions":54,"sizeDeletions":-1},{"number":"2","revision":"d227f151e2a61ea5a24a25503264e94eea2c6017","parents":["3a8628ffea851d46880b2ed499189a07e243bad3"],"ref":"refs/changes/08/6408/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559870475,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559870520,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/connection-fsm.js","line":349,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Am I reading this correctly that the reason we don\u0027t need to delete anything from self.zcf_regs like we do in the Connection FSM error state is because when when we add the object in ZKConnectionFSM.prototype.request() we add an on error callback to delete it from this?"},{"file":"lib/connection-fsm.js","line":349,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"No, it\u0027s more like -- when we\u0027re in the error state, we\u0027re going to transition into this state, where we look at zcf_reqs again. But from \u0027closed\u0027 there\u0027s nowhere else to go, so there\u0027s not much point clearing it. And it might be useful to be able to see the cancelled requests on the old connection object for debugging."},{"file":"lib/connection-fsm.js","line":349,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we start this back up again will we clear out the various requests? It appears that it\u0027s totally fine to call connect() again from the closed state. That would suggest that we\u0027d start up the state machine with all of these still here and if we hit another case where it\u0027s closed, we\u0027d end up firing this on all of the old events a second time, no?"},{"file":"lib/connection-fsm.js","line":349,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"You can\u0027t start it back up again. Calling connect() will do nothing if the connectionFSM is already closed (there\u0027s no handler here for \u0027connectAsserted\u0027)"},{"file":"lib/connection-fsm.js","line":349,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, if that\u0027s the case it seems erroneous that in ZKConnectionFSM.prototype.connect we assert that we\u0027re in the closed state. Though that\u0027s a different problem. I guess in this case because of the design it\u0027ll eventually be gc\u0027d when the general connection FSM falls out of scope so we aren\u0027t likely to leak too much additional memory?"},{"file":"lib/connection-fsm.js","line":349,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yeah, that assertion should be changed, but it\u0027s also not really part of this bug, as you\u0027ve observed. The ConnectionFSMs are created by cueball on our behalf and it will discard it once it\u0027s emitted close or error, then it will be GC\u0027d."},{"file":"test/basic.test.js","line":1339,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Maybe worth a comment do describe the purpose of the unpipe for the test and that it\u0027s there to simulate the fact that we\u0027ll never get a reply."},{"file":"test/basic.test.js","line":1339,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":40,"deletions":0}],"sizeInsertions":51,"sizeDeletions":-1},{"number":"3","revision":"7e36366cf36385021401379ddc98bbe105dd05fc","parents":["3a8628ffea851d46880b2ed499189a07e243bad3"],"ref":"refs/changes/08/6408/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559933128,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559943067,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559948257,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559933173,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":47,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-1},{"number":"4","revision":"353a86ff8ee33228b4229030f974b43d4c31ca13","parents":["3a8628ffea851d46880b2ed499189a07e243bad3"],"ref":"refs/changes/08/6408/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1559948344,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559943067,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559948257,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1559948353,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559933173,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/basic.test.js","type":"MODIFIED","insertions":47,"deletions":0}],"sizeInsertions":58,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}