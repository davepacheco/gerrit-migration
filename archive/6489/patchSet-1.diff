From 04b95d664f5ab47de776adc74d89e4ea8f0a901a Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Mon, 24 Jun 2019 07:38:47 -0600
Subject: [PATCH] MANTA-4368 Pass along request id with node-boray API calls

---
 lib/buckets.js |  46 +++++++++++++--------
 lib/client.js  | 106 +++++++++++++++++++++++++++++++------------------
 lib/objects.js |  60 ++++++++++++++++++----------
 3 files changed, 138 insertions(+), 74 deletions(-)

diff --git a/lib/buckets.js b/lib/buckets.js
index a163143..b92d8b8 100644
--- a/lib/buckets.js
+++ b/lib/buckets.js
@@ -28,11 +28,12 @@ var rpc = require('./rpc');
 
 ///--- API
 
-function createBucket(rpcctx, owner, bucket, vnode, callback) {
+function createBucket(rpcctx, owner, bucket, vnode, req_id, callback) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket, 'bucket');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     var opts = makeBucketOptions({});
@@ -40,7 +41,8 @@ function createBucket(rpcctx, owner, bucket, vnode, callback) {
     var arg = {
         owner: owner,
         name: bucket,
-        vnode: vnode
+        vnode: vnode,
+        request_id: req_id
     };
 
     var log = rpc.childLogger(rpcctx, opts);
@@ -74,10 +76,11 @@ function createBucket(rpcctx, owner, bucket, vnode, callback) {
     });
 }
 
-function createBucketNoVnode(rpcctx, owner, bucket, callback) {
+function createBucketNoVnode(rpcctx, owner, bucket, req_id, callback) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket, 'bucket');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     var opts = makeBucketOptions({});
@@ -91,7 +94,7 @@ function createBucketNoVnode(rpcctx, owner, bucket, callback) {
     rpc.rpcCommonBufferData({
         rpcctx: rpcctx,
         rpcmethod: 'createbucket',
-        rpcargs: [owner, bucket],
+        rpcargs: [owner, bucket, req_id],
         ignoreNullValues: true,
         log: log
     }, function (err, buckets) {
@@ -113,11 +116,12 @@ function createBucketNoVnode(rpcctx, owner, bucket, callback) {
     });
 }
 
-function getBucket(rpcctx, owner, bucket, vnode, callback) {
+function getBucket(rpcctx, owner, bucket, vnode, req_id, callback) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket, 'bucket');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     var opts = makeBucketOptions({});
@@ -125,7 +129,8 @@ function getBucket(rpcctx, owner, bucket, vnode, callback) {
     var arg = {
         owner: owner,
         name: bucket,
-        vnode: vnode
+        vnode: vnode,
+        request_id: req_id
     };
 
     var log = rpc.childLogger(rpcctx, opts);
@@ -154,10 +159,11 @@ function getBucket(rpcctx, owner, bucket, vnode, callback) {
     });
 }
 
-function getBucketNoVnode(rpcctx, owner, bucket, callback) {
+function getBucketNoVnode(rpcctx, owner, bucket, req_id, callback) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket, 'bucket');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     var opts = makeBucketOptions({});
@@ -167,7 +173,7 @@ function getBucketNoVnode(rpcctx, owner, bucket, callback) {
     rpc.rpcCommonBufferData({
         rpcctx: rpcctx,
         rpcmethod: 'getbucket',
-        rpcargs: [owner, bucket],
+        rpcargs: [owner, bucket, req_id],
         log: log
     }, function (err, buckets) {
         if (err) {
@@ -188,11 +194,12 @@ function getBucketNoVnode(rpcctx, owner, bucket, callback) {
     });
 }
 
-function deleteBucket(rpcctx, owner, bucket, vnode, callback) {
+function deleteBucket(rpcctx, owner, bucket, vnode, req_id, callback) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket, 'bucket');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     var opts = makeBucketOptions({});
@@ -200,7 +207,8 @@ function deleteBucket(rpcctx, owner, bucket, vnode, callback) {
     var arg = {
         owner: owner,
         name: bucket,
-        vnode: vnode
+        vnode: vnode,
+        request_id: req_id
     };
 
     var log = rpc.childLogger(rpcctx, opts);
@@ -230,10 +238,11 @@ function deleteBucket(rpcctx, owner, bucket, vnode, callback) {
     });
 }
 
-function deleteBucketNoVnode(rpcctx, owner, bucket, callback) {
+function deleteBucketNoVnode(rpcctx, owner, bucket, req_id, callback) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket, 'bucket');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     var opts = makeBucketOptions({});
@@ -243,7 +252,7 @@ function deleteBucketNoVnode(rpcctx, owner, bucket, callback) {
     rpc.rpcCommonBufferData({
         rpcctx: rpcctx,
         rpcmethod: 'deletebucket',
-        rpcargs: [owner, bucket],
+        rpcargs: [owner, bucket, req_id],
         ignoreNullValues: true,
         log: log
     }, function (err, buckets) {
@@ -258,7 +267,8 @@ function deleteBucketNoVnode(rpcctx, owner, bucket, callback) {
 /*
  * This function talks to boray
  */
-function listBuckets(rpcctx, owner, order_by, prefix, limit, offset, vnode) {
+function listBuckets(rpcctx, owner, order_by, prefix, limit, offset, vnode,
+    req_id) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(order_by, 'order_by');
@@ -266,6 +276,7 @@ function listBuckets(rpcctx, owner, order_by, prefix, limit, offset, vnode) {
     assert.number(limit, 'limit');
     assert.number(offset, 'offset');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
 
     var opts = makeBucketOptions({});
 
@@ -275,7 +286,8 @@ function listBuckets(rpcctx, owner, order_by, prefix, limit, offset, vnode) {
         prefix: prefix,
         limit: limit,
         offset: offset,
-        vnode: vnode
+        vnode: vnode,
+        request_id: req_id
     };
 
     var log = rpc.childLogger(rpcctx, opts);
@@ -305,17 +317,19 @@ function listBuckets(rpcctx, owner, order_by, prefix, limit, offset, vnode) {
 /*
  * This function talks to electric-boray
  */
-function listBucketsNoVnode(rpcctx, owner, sorted, order_by, prefix, limit) {
+function listBucketsNoVnode(rpcctx, owner, sorted, order_by, prefix, limit,
+    req_id) {
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.bool(sorted, 'sorted');
     assert.string(order_by, 'order_by');
     assert.string(prefix, 'prefix');
     assert.number(limit, 'limit');
+    assert.string(req_id, 'req_id');
 
     var opts = makeBucketOptions({});
 
-    var arg = [owner, sorted, order_by, prefix, limit];
+    var arg = [owner, sorted, order_by, prefix, limit, req_id];
 
     var log = rpc.childLogger(rpcctx, opts);
 
diff --git a/lib/client.js b/lib/client.js
index 126a42e..d5e4b00 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -552,14 +552,15 @@ BorayClient.prototype.releaseWhenDone = function releaseOnEnd(rpcctx, emitter) {
  * @param {String} owner  - Account owner
  * @param {String} bucket - Bucket name
  * @param {Number} vnode  - Virtual node identifier
+ * @param {String} req_id - Request identifier
  * @param {Function} cb   - callback
  */
 BorayClient.prototype.createBucket =
-    function createBucket(owner, bucket, vnode, cb) {
+    function createBucket(owner, bucket, vnode, req_id, cb) {
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        buckets.createBucket(rpcctx, owner, bucket, vnode,
+        buckets.createBucket(rpcctx, owner, bucket, vnode, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -572,14 +573,15 @@ BorayClient.prototype.createBucket =
  *
  * @param {String} owner  - Account owner
  * @param {String} bucket - Bucket name
+ * @param {String} req_id - Request identifier
  * @param {Function} cb   - callback
  */
 BorayClient.prototype.createBucketNoVnode =
-    function createBucketNoVnode(owner, bucket, cb) {
+    function createBucketNoVnode(owner, bucket, req_id, cb) {
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        buckets.createBucketNoVnode(rpcctx, owner, bucket,
+        buckets.createBucketNoVnode(rpcctx, owner, bucket, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -594,11 +596,13 @@ BorayClient.prototype.createBucketNoVnode =
  * @param {String} owner  - Account owner
  * @param {String} bucket - Bucket name
  * @param {Number} vnode  - Virtual node identifier
+ * @param {String} req_id - Request identifier
  */
-BorayClient.prototype.getBucket = function getBucket(owner, bucket, vnode, cb) {
+BorayClient.prototype.getBucket = function getBucket(owner, bucket, vnode,
+    req_id, cb) {
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        buckets.getBucket(rpcctx, owner, bucket, vnode,
+        buckets.getBucket(rpcctx, owner, bucket, vnode, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -611,13 +615,14 @@ BorayClient.prototype.getBucket = function getBucket(owner, bucket, vnode, cb) {
  *
  * @param {String} owner  - Account owner
  * @param {String} bucket - Bucket name
+ * @param {String} req_id - Request identifier
  * @param {Function} cb - callback
  */
 BorayClient.prototype.getBucketNoVnode =
-    function getBucketNoVnode(owner, bucket, cb) {
+    function getBucketNoVnode(owner, bucket, req_id, cb) {
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx)
-        buckets.getBucketNoVnode(rpcctx, owner, bucket,
+        buckets.getBucketNoVnode(rpcctx, owner, bucket, req_id,
             this.makeReleaseCb(rpcctx, cb));
 };
 
@@ -630,9 +635,11 @@ BorayClient.prototype.getBucketNoVnode =
  * @param {Number} limit     - The maximum number of buckets to return
  * @param {Number} offset    - An starting offset into the buckets set
  * @param {Number} vnode     - Virtual node identifier
+ * @param {String} req_id    - Request identifier
  */
 BorayClient.prototype.listBuckets =
-    function listBuckets(owner, order_by, prefix, limit, offset, vnode) {
+    function listBuckets(owner, order_by, prefix, limit, offset, vnode,
+        req_id) {
 
     var rpcctx = this.ctxCreateForEmitter();
     var rv;
@@ -642,7 +649,7 @@ BorayClient.prototype.listBuckets =
     }
 
     rv = buckets.listBuckets(rpcctx, owner, order_by, prefix, limit, offset,
-        vnode);
+        vnode, req_id);
     this.releaseWhenDone(rpcctx, rv);
 
     return (rv);
@@ -656,9 +663,11 @@ BorayClient.prototype.listBuckets =
  * @param {String} order_by  - An ordering clause for the resulting buckets
  * @param {String} prefix    - A prefix to use to group buckets
  * @param {Number} limit     - The maximum number of buckets to return
+ * @param {String} req_id    - Request identifier
  */
 BorayClient.prototype.listBucketsNoVnode =
-    function listBucketsNoVnode(owner, sorted, order_by, prefix, limit) {
+    function listBucketsNoVnode(owner, sorted, order_by, prefix, limit,
+        req_id) {
     var rpcctx = this.ctxCreateForEmitter();
     var rv;
 
@@ -667,7 +676,7 @@ BorayClient.prototype.listBucketsNoVnode =
     }
 
     rv = buckets.listBucketsNoVnode(rpcctx, owner, sorted, order_by, prefix,
-        limit);
+        limit, req_id);
     this.releaseWhenDone(rpcctx, rv);
 
     return (rv);
@@ -683,13 +692,14 @@ BorayClient.prototype.listBucketsNoVnode =
  * @param {String} owner  - Account owner
  * @param {String} bucket - Bucket name
  * @param {Number} vnode  - Virtual node identifier
+ * @param {String} req_id - Request identifier
  * @param {Function} cb   - callback
  */
 BorayClient.prototype.deleteBucket = function deleteBucket(owner, bucket, vnode,
-    cb) {
+    req_id, cb) {
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        buckets.deleteBucket(rpcctx, owner, bucket, vnode,
+        buckets.deleteBucket(rpcctx, owner, bucket, vnode, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -703,14 +713,15 @@ BorayClient.prototype.deleteBucket = function deleteBucket(owner, bucket, vnode,
  *
  * @param {String} owner  - Account owner
  * @param {String} bucket - Bucket name
+ * @param {String} req_id - Request identifier
  * @param {Function} cb   - callback
  */
 BorayClient.prototype.deleteBucketNoVnode =
-    function deleteBucketNoVnode(owner, bucket, cb) {
+    function deleteBucketNoVnode(owner, bucket, req_id, cb) {
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        buckets.deleteBucketNoVnode(rpcctx, owner, bucket,
+        buckets.deleteBucketNoVnode(rpcctx, owner, bucket, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -739,11 +750,12 @@ BorayClient.prototype.deleteBucketNoVnode =
  *                                   which we are not immediately able to
  *                                   migrate the database to accommodate.
  * @param {Number} vnode           - Virtual node identifier
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.createObject = function createObject(owner, bucket_id,
     name, object_id, content_length, content_md5, content_type, headers,
-    sharks, props, vnode, cb) {
+    sharks, props, vnode, req_id, cb) {
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
@@ -753,14 +765,15 @@ BorayClient.prototype.createObject = function createObject(owner, bucket_id,
     assert.object(headers, 'headers');
     assert.object(sharks, 'sharks');
     assert.number(vnode, 'vnode');
-    assert.func(cb, 'callback');
+    assert.string(req_id, 'req_id');
     assert.optionalObject(props, 'props');
+    assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
         objects.createObject(rpcctx, owner, bucket_id, name, object_id,
             content_length, content_md5, content_type, headers, sharks, props,
-            vnode, this.makeReleaseCb(rpcctx, cb));
+            vnode, req_id, this.makeReleaseCb(rpcctx, cb));
     }
 };
 
@@ -787,11 +800,12 @@ BorayClient.prototype.createObject = function createObject(owner, bucket_id,
  *                                   that may be shown to be important, but for
  *                                   which we are not immediately able to
  *                                   migrate the database to accommodate.
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.createObjectNoVnode = function createObjectNoVnode(owner,
     bucket_id, name, object_id, content_length, content_md5, content_type,
-    headers, sharks, props, cb) {
+    headers, sharks, props, req_id, cb) {
 
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
@@ -802,6 +816,7 @@ BorayClient.prototype.createObjectNoVnode = function createObjectNoVnode(owner,
     assert.string(content_type, 'content_type');
     assert.object(headers, 'headers');
     assert.object(sharks, 'sharks');
+    assert.string(req_id, 'req_id');
     assert.func(cb, 'callback');
     assert.optionalObject(props, 'props');
 
@@ -809,7 +824,7 @@ BorayClient.prototype.createObjectNoVnode = function createObjectNoVnode(owner,
     if (rpcctx) {
         objects.createObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
             content_length, content_md5, content_type, headers, sharks, props,
-            this.makeReleaseCb(rpcctx, cb));
+            req_id, this.makeReleaseCb(rpcctx, cb));
     }
 };
 
@@ -833,23 +848,25 @@ BorayClient.prototype.createObjectNoVnode = function createObjectNoVnode(owner,
  *                                   which we are not immediately able to
  *                                   migrate the database to accommodate.
  * @param {Number} vnode           - Virtual node identifier
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.updateObject = function updateObject(owner, bucket_id,
-    name, object_id, content_type, headers, props, vnode, cb) {
+    name, object_id, content_type, headers, props, vnode, req_id, cb) {
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
     assert.string(content_type, 'content_type');
     assert.object(headers, 'headers');
     assert.number(vnode, 'vnode');
-    assert.func(cb, 'callback');
     assert.optionalObject(props, 'props');
+    assert.string(req_id, 'req_id');
+    assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
         objects.updateObject(rpcctx, owner, bucket_id, name, object_id,
-        content_type, headers, props, vnode,
+        content_type, headers, props, vnode, req_id,
         this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -873,10 +890,11 @@ BorayClient.prototype.updateObject = function updateObject(owner, bucket_id,
  *                                   that may be shown to be important, but for
  *                                   which we are not immediately able to
  *                                   migrate the database to accommodate.
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.updateObjectNoVnode = function updateObjectNoVnode(owner,
-    bucket_id, name, object_id, content_type, headers, props, cb) {
+    bucket_id, name, object_id, content_type, headers, props, req_id, cb) {
 
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
@@ -884,13 +902,15 @@ BorayClient.prototype.updateObjectNoVnode = function updateObjectNoVnode(owner,
     assert.string(object_id, 'object_id');
     assert.string(content_type, 'content_type');
     assert.object(headers, 'headers');
-    assert.func(cb, 'callback');
     assert.optionalObject(props, 'props');
+    assert.string(req_id, 'req_id');
+    assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
         objects.updateObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
-            content_type, headers, props, this.makeReleaseCb(rpcctx, cb));
+        content_type, headers, props, req_id,
+        this.makeReleaseCb(rpcctx, cb));
     }
 };
 
@@ -905,20 +925,22 @@ BorayClient.prototype.updateObjectNoVnode = function updateObjectNoVnode(owner,
  * @param {String} bucket_id       - Bucket id
  * @param {String} name            - Object key name
  * @param {Number} vnode           - Virtual node identifier
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.getObject =
-    function getObject(owner, bucket_id, name, vnode, cb) {
+    function getObject(owner, bucket_id, name, vnode, req_id, cb) {
 
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        objects.getObject(rpcctx, owner, bucket_id, name, vnode,
+        objects.getObject(rpcctx, owner, bucket_id, name, vnode, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -932,19 +954,21 @@ BorayClient.prototype.getObject =
  * @param {String} owner           - Account owner
  * @param {String} bucket_id       - Bucket id
  * @param {String} name            - Object key name
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.getObjectNoVnode =
-    function getObjectNoVnode(owner, bucket_id, name, cb) {
+    function getObjectNoVnode(owner, bucket_id, name, req_id, cb) {
 
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
+    assert.string(req_id, 'req_id');
     assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        objects.getObjectNoVnode(rpcctx, owner, bucket_id, name,
+        objects.getObjectNoVnode(rpcctx, owner, bucket_id, name, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -956,10 +980,11 @@ BorayClient.prototype.getObjectNoVnode =
  * @param {String} owner           - Account owner
  * @param {String} bucket_id       - Bucket id
  * @param {Number} vnode           - Virtual node identifier
+ * @param {String} req_id          - Request identifier
  */
 BorayClient.prototype.listObjects =
     function listObjects(owner, bucket_id, order_by, prefix, limit, offset,
-        vnode) {
+        vnode, req_id) {
 
     var rpcctx = this.ctxCreateForEmitter();
     var rv;
@@ -969,7 +994,7 @@ BorayClient.prototype.listObjects =
     }
 
     rv = objects.listObjects(rpcctx, owner, bucket_id, order_by, prefix, limit,
-        offset, vnode);
+        offset, vnode, req_id);
     this.releaseWhenDone(rpcctx, rv);
 
     return (rv);
@@ -980,10 +1005,11 @@ BorayClient.prototype.listObjects =
  *
  * @param {String} owner           - Account owner
  * @param {String} bucket_id       - Bucket id
+ * @param {String} req_id          - Request identifier
  */
 BorayClient.prototype.listObjectsNoVnode =
     function listObjectsNoVnode(owner, bucket_id, sorted, order_by, prefix,
-        limit) {
+        limit, req_id) {
 
     var rpcctx = this.ctxCreateForEmitter();
     var rv;
@@ -993,7 +1019,7 @@ BorayClient.prototype.listObjectsNoVnode =
     }
 
     rv = objects.listObjectsNoVnode(rpcctx, owner, bucket_id, sorted, order_by,
-        prefix, limit);
+        prefix, limit, req_id);
     this.releaseWhenDone(rpcctx, rv);
 
     return (rv);
@@ -1009,20 +1035,22 @@ BorayClient.prototype.listObjectsNoVnode =
  * @param {String} bucket_id       - Bucket id
  * @param {String} name            - Object key name
  * @param {Number} vnode           - Virtual node identifier
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.deleteObject =
-    function deleteObject(owner, bucket_id, name, vnode, cb) {
+    function deleteObject(owner, bucket_id, name, vnode, req_id, cb) {
 
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
     if (rpcctx) {
-        objects.deleteObject(rpcctx, owner, bucket_id, name, vnode,
+        objects.deleteObject(rpcctx, owner, bucket_id, name, vnode, req_id,
             this.makeReleaseCb(rpcctx, cb));
     }
 };
@@ -1036,14 +1064,16 @@ BorayClient.prototype.deleteObject =
  * @param {String} owner           - Account owner
  * @param {String} bucket_id       - Bucket id
  * @param {String} name            - Object key name
+ * @param {String} req_id          - Request identifier
  * @param {Function} cb            - callback
  */
 BorayClient.prototype.deleteObjectNoVnode =
-    function deleteObjectNoVnode(owner, bucket_id, name, cb) {
+    function deleteObjectNoVnode(owner, bucket_id, name, req_id, cb) {
 
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
+    assert.string(req_id, 'req_id');
     assert.func(cb, 'callback');
 
     var rpcctx = this.ctxCreateForCallback(cb);
diff --git a/lib/objects.js b/lib/objects.js
index 1444f82..d73f0fa 100644
--- a/lib/objects.js
+++ b/lib/objects.js
@@ -29,7 +29,8 @@ var rpc = require('./rpc');
 ///--- API
 
 function createObject(rpcctx, owner, bucket_id, name, object_id, content_length,
-    content_md5, content_type, headers, sharks, props, vnode, callback) {
+    content_md5, content_type, headers, sharks, props, vnode, req_id,
+    callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -45,6 +46,7 @@ function createObject(rpcctx, owner, bucket_id, name, object_id, content_length,
     assert.number(vnode, 'vnode');
     assert.func(callback, 'callback');
     assert.optionalObject(props, 'props');
+    assert.string(req_id, 'req_id');
 
     opts = makeOptions({});
 
@@ -58,7 +60,8 @@ function createObject(rpcctx, owner, bucket_id, name, object_id, content_length,
                 content_type: content_type,
                 headers: headers,
                 sharks: sharks,
-                properties: props
+                properties: props,
+                requestId: req_id
               };
     log = rpc.childLogger(rpcctx, opts);
     rpc.rpcCommonBufferData({
@@ -82,7 +85,7 @@ function createObject(rpcctx, owner, bucket_id, name, object_id, content_length,
 
 function createObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
     content_length, content_md5, content_type, headers, sharks, props,
-    callback) {
+    req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -95,6 +98,7 @@ function createObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
     assert.string(content_type, 'content_type');
     assert.object(headers, 'headers');
     assert.object(sharks, 'sharks');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     opts = makeOptions({});
@@ -108,7 +112,8 @@ function createObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
                  content_type,
                  headers,
                  sharks,
-                 props
+                 props,
+                 req_id
               ];
     log = rpc.childLogger(rpcctx, opts);
     rpc.rpcCommonBufferData({
@@ -131,7 +136,7 @@ function createObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
 }
 
 
-function getObject(rpcctx, owner, bucket_id, name, vnode, callback) {
+function getObject(rpcctx, owner, bucket_id, name, vnode, req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -139,6 +144,7 @@ function getObject(rpcctx, owner, bucket_id, name, vnode, callback) {
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     opts = makeOptions({});
@@ -146,7 +152,8 @@ function getObject(rpcctx, owner, bucket_id, name, vnode, callback) {
     var arg = { owner: owner,
                 bucket_id: bucket_id,
                 name: name,
-                vnode: vnode
+                vnode: vnode,
+                request_id: req_id
               };
 
     log = rpc.childLogger(rpcctx, opts);
@@ -171,20 +178,22 @@ function getObject(rpcctx, owner, bucket_id, name, vnode, callback) {
 }
 
 
-function getObjectNoVnode(rpcctx, owner, bucket_id, name, callback) {
+function getObjectNoVnode(rpcctx, owner, bucket_id, name, req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     opts = makeOptions({});
 
     var args = [ owner,
                  bucket_id,
-                 name
+                 name,
+                 req_id
                ];
 
     log = rpc.childLogger(rpcctx, opts);
@@ -210,7 +219,7 @@ function getObjectNoVnode(rpcctx, owner, bucket_id, name, callback) {
 
 
 function updateObject(rpcctx, owner, bucket_id, name, object_id, content_type,
-    headers, props, vnode, callback) {
+    headers, props, vnode, req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -223,6 +232,7 @@ function updateObject(rpcctx, owner, bucket_id, name, object_id, content_type,
     assert.number(vnode, 'vnode');
     assert.func(callback, 'callback');
     assert.optionalObject(props, 'props');
+    assert.string(req_id, 'req_id');
 
     opts = makeOptions({});
 
@@ -233,7 +243,8 @@ function updateObject(rpcctx, owner, bucket_id, name, object_id, content_type,
                 vnode: vnode,
                 content_type: content_type,
                 headers: headers,
-                properties: props
+                properties: props,
+                request_id: req_id
               };
     log = rpc.childLogger(rpcctx, opts);
     rpc.rpcCommonBufferData({
@@ -256,7 +267,7 @@ function updateObject(rpcctx, owner, bucket_id, name, object_id, content_type,
 }
 
 function updateObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
-    content_type, headers, props, callback) {
+    content_type, headers, props, req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -266,6 +277,7 @@ function updateObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
     assert.string(object_id, 'object_id');
     assert.string(content_type, 'content_type');
     assert.object(headers, 'headers');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     opts = makeOptions({});
@@ -276,7 +288,8 @@ function updateObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
                  object_id,
                  content_type,
                  headers,
-                 props
+                 props,
+                 req_id
               ];
     log = rpc.childLogger(rpcctx, opts);
     rpc.rpcCommonBufferData({
@@ -299,7 +312,7 @@ function updateObjectNoVnode(rpcctx, owner, bucket_id, name, object_id,
 }
 
 
-function deleteObject(rpcctx, owner, bucket_id, name, vnode, callback) {
+function deleteObject(rpcctx, owner, bucket_id, name, vnode, req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
@@ -307,6 +320,7 @@ function deleteObject(rpcctx, owner, bucket_id, name, vnode, callback) {
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     opts = makeOptions({});
@@ -314,7 +328,8 @@ function deleteObject(rpcctx, owner, bucket_id, name, vnode, callback) {
     var arg = { owner: owner,
                 bucket_id: bucket_id,
                 name: name,
-                vnode: vnode
+                vnode: vnode,
+                request_id: req_id
               };
 
     log = rpc.childLogger(rpcctx, opts);
@@ -338,20 +353,22 @@ function deleteObject(rpcctx, owner, bucket_id, name, vnode, callback) {
     });
 }
 
-function deleteObjectNoVnode(rpcctx, owner, bucket_id, name, callback) {
+function deleteObjectNoVnode(rpcctx, owner, bucket_id, name, req_id, callback) {
     var opts, log;
 
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
     assert.string(bucket_id, 'bucket_id');
     assert.string(name, 'name');
+    assert.string(req_id, 'req_id');
     assert.func(callback, 'callback');
 
     opts = makeOptions({});
 
     var args = [ owner,
                  bucket_id,
-                 name
+                 name,
+                 req_id
                ];
 
     log = rpc.childLogger(rpcctx, opts);
@@ -372,7 +389,7 @@ function deleteObjectNoVnode(rpcctx, owner, bucket_id, name, callback) {
 
 
 function listObjects(rpcctx, owner, bucket_id, order_by, prefix, limit, offset,
-    vnode) {
+    vnode, req_id) {
 
     assert.object(rpcctx, 'rpcctx');
     assert.string(owner, 'owner');
@@ -382,6 +399,7 @@ function listObjects(rpcctx, owner, bucket_id, order_by, prefix, limit, offset,
     assert.number(limit, 'limit');
     assert.number(offset, 'offset');
     assert.number(vnode, 'vnode');
+    assert.string(req_id, 'req_id');
 
     var arg = {
         owner: owner,
@@ -390,7 +408,8 @@ function listObjects(rpcctx, owner, bucket_id, order_by, prefix, limit, offset,
         prefix: prefix,
         limit: limit,
         offset: offset,
-        vnode: vnode
+        vnode: vnode,
+        request_id: req_id
     };
 
     var opts = makeOptions(arg);
@@ -420,7 +439,7 @@ function listObjects(rpcctx, owner, bucket_id, order_by, prefix, limit, offset,
 }
 
 function listObjectsNoVnode(rpcctx, owner, bucket_id, sorted, order_by, prefix,
-    limit) {
+    limit, req_id) {
 
     var opts, log;
 
@@ -431,6 +450,7 @@ function listObjectsNoVnode(rpcctx, owner, bucket_id, sorted, order_by, prefix,
     assert.string(order_by, 'order_by');
     assert.string(prefix, 'prefix');
     assert.number(limit, 'limit');
+    assert.string(req_id, 'req_id');
 
     opts = makeOptions({});
 
@@ -441,7 +461,7 @@ function listObjectsNoVnode(rpcctx, owner, bucket_id, sorted, order_by, prefix,
     var req = rpc.rpcCommon({
         rpcctx: rpcctx,
         rpcmethod: 'listobjects',
-        rpcargs: [owner, bucket_id, sorted, order_by, prefix, limit],
+        rpcargs: [owner, bucket_id, sorted, order_by, prefix, limit, req_id],
         log: log
     }, function (err) {
         if (err) {
-- 
2.21.0

