{"project":"joyent/eng","branch":"master","id":"Ibcaf0675f77fdb07e155951a9199df933eb44c9c","number":"5792","subject":"TOOLS-2202 buildimage needs a mechanism to audit pkgsrc packages TOOLS-2203 buildimage needs a way to (optionally) upgrade packages Reviewed by: Tim Foster \u003ctim.foster@joyent.com\u003e Approved by: Tim Foster \u003ctim.foster@joyent.com\u003e","owner":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"url":"https://cr.joyent.us/5792","commitMessage":"TOOLS-2202 buildimage needs a mechanism to audit pkgsrc packages\nTOOLS-2203 buildimage needs a way to (optionally) upgrade packages\nReviewed by: Tim Foster \u003ctim.foster@joyent.com\u003e\nApproved by: Tim Foster \u003ctim.foster@joyent.com\u003e\n","createdOn":1552512600,"lastUpdated":1553544526,"open":false,"status":"MERGED","comments":[{"timestamp":1552512600,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 1."},{"timestamp":1552564715,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1552577104,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 2."},{"timestamp":1552577504,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1553014437,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1553032540,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(3 comments)\n\nDoes running:\n\n```\n[root@17180836-6ae7-4d70-98d3-a8b00f6581a1 ~]# pkg_admin fetch-pkg-vulnerabilities\n```\n\nresult in some increase in the size of the created image that we\u0027d want to avoid, do you know? I\u0027d assume whatever it downloads is small."},{"timestamp":1553088070,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1553114667,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 3:\n\n(1 comment)\n\n# ls -lh /opt/local/pkg/pkg-vulnerabilities\n-rw-r--r-- 1 root root 191K Mar 20 20:32 /opt/local/pkg/pkg-vulnerabilities\n\nI think it count as small."},{"timestamp":1553139019,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1553188649,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 4."},{"timestamp":1553197192,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1\n\nI\u0027ll leave it to Tim to IA, if that is okay."},{"timestamp":1553249094,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4: Integration-Approval+1\n\nThis looks great, thanks for making those changes.\n\nI took these bits and built imgapi as non-root with them, both with and without setting BUILDIMAGE_DO_PKGSRC_UPGRADE, checking the pkgsrc audit log. I deployed the pkgin upgraded bits to coal out of curiosity and the imgapi instance came up as expected and seemed functional (though if it didn\u0027t, that wouldn\u0027t necessarily have been a gating factor for this change, depending on what broke)\n\nPlease could you update both tickets to describe the implementation here, probably noting that the upgrade support is really only intended for origin or base images.\n\nThe image size bump for the pkgin-upgraded version of imgapi I built was fairly significant, going from 131mb without upgrades to 253mb with upgrades, which would add up to fairly large usbkey if we were to do this everywhere."},{"timestamp":1553280132,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 5."},{"timestamp":1553280515,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1553519022,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1553520506,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 6."},{"timestamp":1553520649,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1553544502,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1553544526,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Chris Burroughs"}],"currentPatchSet":{"number":"7","revision":"bcaf0675f77fdb07e155951a9199df933eb44c9c","parents":["126c0f032b8bfddd45b14e8ee14e73e9798a013f"],"ref":"refs/changes/92/5792/7","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1553544502,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553520649,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553520649,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"SUBM","value":"1","grantedOn":1553544526,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":166,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":185,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"930d7648ebbce5c57c245fcaac68580e302b22c6","parents":["3fb93c5f46cc857ddeec97b1e178e4d9b83f39ab"],"ref":"refs/changes/92/5792/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1552512600,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","comments":[{"file":"Makefile","line":213,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"typo?"},{"file":"Makefile","line":213,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Done"},{"file":"tools/buildimage/bin/buildimage","line":293,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Does this work even when buildimage is invoked using pfexec as a non-root user? I have vague memories of pkgin failing here (which is why I needed to use pkg_add rather than \u0027pkgin in\u0027 elsewhere - something about it incorrectly accessing the pkgsrc db, but I forget the details)"},{"file":"tools/buildimage/bin/buildimage","line":293,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"The build did not error out for me when running \"buildimage\" as a not-root user."},{"file":"tools/buildimage/bin/buildimage","line":447,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Should we have an option to buildimage to abort the build in the case of vulnerabilities?\n\nOtherwise, are we planning other automation to check for pkgadit files containing errors (similar to the way \u0027bits-upload.sh\u0027 refuses to upload \u0027-dirty\u0027 builds. I could imagine some components wanting to only release if they had packages with zero reported vulnerabilities."},{"file":"tools/buildimage/bin/buildimage","line":447,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I agree failing the build sounds like a reasonable think to want.  However, I don\u0027t think there are any practical use cases today.  After a full-upgrade,  `audit` turns up several issues even on just the default set of packages on minimal-64-lts@18.4.0 (the most up to date option we have).\n\n[root@17180836-6ae7-4d70-98d3-a8b00f6581a1 ~]# pkgin update\nprocessing remote summary (https://pkgsrc.joyent.com/packages/SmartOS/2018Q4/x86_64/All)...\ndatabase for https://pkgsrc.joyent.com/packages/SmartOS/2018Q4/x86_64/All is up-to-date\n[root@17180836-6ae7-4d70-98d3-a8b00f6581a1 ~]# pkgin full-upgrade\nnothing to do.\n[root@17180836-6ae7-4d70-98d3-a8b00f6581a1 ~]# pkg_admin fetch-pkg-vulnerabilities\n[root@17180836-6ae7-4d70-98d3-a8b00f6581a1 ~]# pkg_admin audit\nPackage ncurses-6.1nb3 has a null-pointer-dereference vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-19211\nPackage ncurses-6.1nb3 has a null-pointer-dereference vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-19217\nPackage libarchive-3.3.2 has a denial-of-service vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2017-14166\nPackage libarchive-3.3.2 has a out-of-bounds-read vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2017-14501\nPackage libarchive-3.3.2 has a off-by-one vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2017-14502\nPackage libarchive-3.3.2 has a out-of-bounds-read vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2017-14503\nPackage libarchive-3.3.2 has a double-free vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-1000877\nPackage libarchive-3.3.2 has a use-after-free vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-1000878\nPackage libarchive-3.3.2 has a null-pointer-dereference vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-1000879\nPackage libarchive-3.3.2 has a denial-of-service vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-1000880\nPackage libarchive-3.3.2 has a out-of-bounds-read vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2019-1000019\nPackage libarchive-3.3.2 has a infinite-loop vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2019-1000020\nPackage openssl-1.0.2p has a timing-attack vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-0734\nPackage openssl-1.0.2p has a timing-attack vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2018-5407\nPackage openssl-1.0.2p has a oracle-attack vulnerability, see https://nvd.nist.gov/vuln/detail/CVE-2019-1559"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":140,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":159,"sizeDeletions":0},{"number":"2","revision":"4713e1b4b3853f5817f49db92439de4d7a61be59","parents":["3fb93c5f46cc857ddeec97b1e178e4d9b83f39ab"],"ref":"refs/changes/92/5792/2","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1552577104,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":140,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":159,"sizeDeletions":0},{"number":"3","revision":"d63fcc8c54760da542920c94bf0ab0c89d6e9590","parents":["126c0f032b8bfddd45b14e8ee14e73e9798a013f"],"ref":"refs/changes/92/5792/3","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1553014437,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"Makefile","line":216,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: The \"FIRST\" is a little weird, personally. Perhaps something like \"BUILDIMAGE_PKGSRC_FULL_UPGRADE\u003dtrue\".  However, just a nit, so won\u0027t affect +1s if you\u0027d rather not change it."},{"file":"Makefile","line":216,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"That\u0027s a bit nicer, though makes you think \"as opposed to what, a partial upgrade?\" Would BUILDIMAGE_DO_PKGSRC_UPGRADE\u003dtrue be better? It\u0027s no problem for me to stamp again, whatever you decide."},{"file":"Makefile","line":216,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I find the fact that \"upgrade\" and \"full-upgrade\" are different things confusing, but that is what pkgin calls it."},{"file":"Makefile","line":216,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Indeed.  I\u0027m fine with BUILDIMAGE_DO_PKGSRC_UPGRADE as the name as well."},{"file":"tools/buildimage/bin/buildimage","line":68,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps state that it writes it to a tmp file, showing the name pattern?  \n\nAlso, FWIW, we don\u0027t *have* to ahve a short option for every option. Not suggestion this needs change, however."},{"file":"tools/mk/Makefile.targ","line":468,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Unrelated to this change: I wonder why not just three `mv`s here, instead of \"cp then rm\"."},{"file":"tools/mk/Makefile.targ","line":468,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Probably just leftover debugging code where I was leaving the image in /tmp on the build machine (having commented out the removals) so that I could dig around it rather than fetch it over NFS."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":140,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":159,"sizeDeletions":0},{"number":"4","revision":"9e39f40909d4b96a1ea3f3ff9911d1030f9c7ad8","parents":["126c0f032b8bfddd45b14e8ee14e73e9798a013f"],"ref":"refs/changes/92/5792/4","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1553188649,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553197192,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553249094,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":140,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":159,"sizeDeletions":0},{"number":"5","revision":"ff087e30c155a4bb8cf21298a4acbd72ab0c88d1","parents":["126c0f032b8bfddd45b14e8ee14e73e9798a013f"],"ref":"refs/changes/92/5792/5","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1553280132,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","comments":[{"file":"tools/buildimage/bin/buildimage","line":478,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"What was the savings in deleting this? ... and is this safe todo and then run future `pkgin ...` commands?"},{"file":"tools/buildimage/bin/buildimage","line":478,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"(From chat, this is in the ticket now.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":166,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":185,"sizeDeletions":0},{"number":"6","revision":"7b16e72a519516ac5b7078dcb443aa2e95ec8377","parents":["126c0f032b8bfddd45b14e8ee14e73e9798a013f"],"ref":"refs/changes/92/5792/6","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1553520506,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553520649,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553520649,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":166,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":185,"sizeDeletions":0},{"number":"7","revision":"bcaf0675f77fdb07e155951a9199df933eb44c9c","parents":["126c0f032b8bfddd45b14e8ee14e73e9798a013f"],"ref":"refs/changes/92/5792/7","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1553544502,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1553544526,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553520649,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553520649,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":6,"deletions":0},{"file":"tools/buildimage/bin/buildimage","type":"MODIFIED","insertions":166,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":13,"deletions":0}],"sizeInsertions":185,"sizeDeletions":0}],"allReviewers":[{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}