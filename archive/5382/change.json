{"project":"joyent/illumos-joyent","branch":"master","id":"Ibbe2e2f7e7f932bf06d6b1b053c47c4a7b4a0fc2","number":"5382","subject":"OS-5872 Need to handle SLOG failure better when the SLOG dies OS-6462 System hangs when slog device is removed from zpool Reviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Kody Kantor \u003ck","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/5382","commitMessage":"OS-5872 Need to handle SLOG failure better when the SLOG dies\nOS-6462 System hangs when slog device is removed from zpool\nReviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1547767405,"lastUpdated":1548260187,"open":false,"status":"MERGED","comments":[{"timestamp":1547767405,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1547819778,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nBased on CR feedback from Patrick in chat, I\u0027m splitting out the test changes into a separate issue and I added a macro for testing reexecution."},{"timestamp":1547819800,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1547843024,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1547872290,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1548166495,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1548166514,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1548172098,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1548172676,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1548173470,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1548174278,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1548174882,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1548175096,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1548254921,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nTesting notes added to OS-5872 ticket."},{"timestamp":1548259321,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1548259561,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\nNice work, Jerry.  It\u0027ll be great to have this fixed."},{"timestamp":1548260072,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1548260164,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1548260187,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"6","revision":"bbe2e2f7e7f932bf06d6b1b053c47c4a7b4a0fc2","parents":["4014b5dddd3d82d5c801ad28807ad911d324ca51"],"ref":"refs/changes/82/5382/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1548260164,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548175096,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1548260187,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":22,"deletions":-3}],"sizeInsertions":31,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"f26fbf440b2a1673e342a512b1e6e1484c977559","parents":["4eeb8089d22a777b919f608ca4fb5c090d2eea84"],"ref":"refs/changes/82/5382/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1547767405,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/test/zfs-tests/runfiles/smartos.run","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"usr/src/test/zfs-tests/tests/functional/slog/slog.cfg","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/test/zfs-tests/tests/functional/slog/slog_014_pos.ksh","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":30,"deletions":-3}],"sizeInsertions":48,"sizeDeletions":-10},{"number":"2","revision":"839cf98ab71dc2d087550de2a3828dca29454383","parents":["4eeb8089d22a777b919f608ca4fb5c090d2eea84"],"ref":"refs/changes/82/5382/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1547819800,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1547843024,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"usr/src/uts/common/fs/zfs/zio.c","line":3829,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Instead of including this block I think we could change the ZIO_SHOULD_REEXECUTE macro to be something like\n\n  zio-\u003eio_reexecute \u0026 ZIO_REEXECUTE_NO_SUSPEND \u003d\u003d 0\n\nUnless my bitwise math is escaping me.\n\nThe way this block is written now does help to explain the behavior of this change, so keeping this in is fine with me."},{"file":"usr/src/uts/common/fs/zfs/zio.c","line":3829,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, are there circumstances where REEXECUTE_NOW would be set and that would be OK?"},{"file":"usr/src/uts/common/fs/zfs/zio.c","line":3829,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I removed this block and rewrote the macro."},{"file":"usr/src/uts/common/fs/zfs/zio.c","line":3829,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Rexecuting now is fine as far as I know, although I am not sure if it is actually possible to get the combination of actions that lead to rexecuting now when we have a dead slog. The problems we have seen with the dead slogs are all related to suspended zios."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":30,"deletions":-3}],"sizeInsertions":37,"sizeDeletions":-6},{"number":"3","revision":"36800b9bacee8263ae63443f5fcffe799d6dfb34","parents":["a240634660453b6e26ddc359174bc73d4f8c9bc3"],"ref":"refs/changes/82/5382/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1548166514,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548172098,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","line":381,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"wrap the bitwise operation in parens for safety? (I\u0027ve been bitten by that more than once)"},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","line":381,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I think this code is correct. Can you explain your concern?"},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","line":381,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The \u0027\u003d\u003d\u0027 has higher precedence than the \u0027\u0026\u0027, so it effectively becomes \"x-\u003eio_reexecute \u0026 (ZIO_REEXECUTE_NO_SUSPEND \u003d\u003d 0)\""}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":22,"deletions":-3}],"sizeInsertions":31,"sizeDeletions":-6},{"number":"4","revision":"18c277fd7e5a02f887274f5eadbf8373b20a53bd","parents":["a240634660453b6e26ddc359174bc73d4f8c9bc3"],"ref":"refs/changes/82/5382/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1548174882,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548175096,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":22,"deletions":-3}],"sizeInsertions":31,"sizeDeletions":-6},{"number":"5","revision":"1279be0c34f003e6e7b56292886b1d50a3e7beaf","parents":["4014b5dddd3d82d5c801ad28807ad911d324ca51"],"ref":"refs/changes/82/5382/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1548260072,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548175096,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":22,"deletions":-3}],"sizeInsertions":31,"sizeDeletions":-6},{"number":"6","revision":"bbe2e2f7e7f932bf06d6b1b053c47c4a7b4a0fc2","parents":["4014b5dddd3d82d5c801ad28807ad911d324ca51"],"ref":"refs/changes/82/5382/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1548260164,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1548260187,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548175096,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548259321,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/fs/zfs/sys/zio.h","type":"MODIFIED","insertions":9,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/zio.c","type":"MODIFIED","insertions":22,"deletions":-3}],"sizeInsertions":31,"sizeDeletions":-6}],"allReviewers":[{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}