{"project":"joyent/illumos-joyent","branch":"master","id":"I56651a474ca10d3fb356c0e36f6ba69d86e4bcab","number":"1588","subject":"OS-5987 zone stuck in shutdown during clustrix install Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/1588","commitMessage":"OS-5987 zone stuck in shutdown during clustrix install\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1488300680,"lastUpdated":1488322196,"open":false,"status":"MERGED","comments":[{"timestamp":1488300680,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1488312325,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1488313944,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1488314863,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1488317587,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1488319241,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1488320293,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1488320415,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1488320655,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6."},{"timestamp":1488321047,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1488321384,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1488322101,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1488322187,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 8: Commit message was updated."},{"timestamp":1488322196,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"8","revision":"56651a474ca10d3fb356c0e36f6ba69d86e4bcab","parents":["aeabe6c6a467e47cc2b4ad15a38b19115f5b599a"],"ref":"refs/changes/88/1588/8","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488322187,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488321047,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488321384,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1488322196,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":44,"deletions":-1}],"sizeInsertions":44,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"9b465033ef13126ed8e04390d9d71f529a5c8f36","parents":["f7b7abfa6104a9c74789db9692c2fc269644b2eb"],"ref":"refs/changes/88/1588/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488300680,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":25,"deletions":0}],"sizeInsertions":25,"sizeDeletions":0},{"number":"2","revision":"55835f4eda14d30f324a9cc73181bb562b003764","parents":["f7b7abfa6104a9c74789db9692c2fc269644b2eb"],"ref":"refs/changes/88/1588/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488312325,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":430,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would move this logic into lx_io_setup(), prior to when lwp_create_done() is called on the thread.  We\u0027ll hold p_lock there anyways."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":438,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We\u0027ll want a (void) cast here to make lint happy about the ignored return value."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":460,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would consider abstracting this into a little mini function.  It seems like a good place for a more lengthy comment about the difficulties of the situation and a convenient location where we could integrate SIGSTOP logic when we get that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":46,"deletions":-1}],"sizeInsertions":46,"sizeDeletions":-1},{"number":"3","revision":"cbefc78d3c4449d7c9dc0ec0da33287262292b2b","parents":["f7b7abfa6104a9c74789db9692c2fc269644b2eb"],"ref":"refs/changes/88/1588/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488314863,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":75,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: s/the thread/them/ would be a little more concise"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":78,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would say it\u0027s a stretch to say they are \"participating\" in the fork."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":416,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"To say that \u0027we\u0027 are forking in this context seems a little confusing from the context of the aio worker thread.  Maybe something like this would be a little clearer?:\n\nIf this process is undergoing a fork(), it expects all LWPs to be stopped first.  In the AIO worker threads, a stop the equivalent of holdlwp() is necessary before the fork can proceed. Initial checks are performed outside p_lock to avoid the extra work"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":421,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"\u0027worker event\u0027 seems a little generic for the very specific task at hand.  Something like \u0027lx_io_checkstop\u0027 might be more descriptive in a stacktrace."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":447,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It might be good to spell out the importance of a wakeable cv_wait here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":39,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1},{"number":"4","revision":"a0715ff4d7a43734d11ab0e5d5b6983cf0bffed1","parents":["f7b7abfa6104a9c74789db9692c2fc269644b2eb"],"ref":"refs/changes/88/1588/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488319241,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":416,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","line":417,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"comma after \u0027worker threads\u0027, remove the other two commas"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":44,"deletions":-1}],"sizeInsertions":44,"sizeDeletions":-1},{"number":"5","revision":"b24c0930953ff662614eae4ff454b3af8c2b65a6","parents":["f7b7abfa6104a9c74789db9692c2fc269644b2eb"],"ref":"refs/changes/88/1588/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488320415,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":44,"deletions":-1}],"sizeInsertions":44,"sizeDeletions":-1},{"number":"6","revision":"0494a7454777fe5d07f9576f9c7990536a61b980","parents":["f7b7abfa6104a9c74789db9692c2fc269644b2eb"],"ref":"refs/changes/88/1588/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488320655,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488321047,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488321384,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":44,"deletions":-1}],"sizeInsertions":44,"sizeDeletions":-1},{"number":"7","revision":"eb21cac371a948c7710c8cf2d89c3838f03af6d9","parents":["aeabe6c6a467e47cc2b4ad15a38b19115f5b599a"],"ref":"refs/changes/88/1588/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488322101,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488321047,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488321384,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":44,"deletions":-1}],"sizeInsertions":44,"sizeDeletions":-1},{"number":"8","revision":"56651a474ca10d3fb356c0e36f6ba69d86e4bcab","parents":["aeabe6c6a467e47cc2b4ad15a38b19115f5b599a"],"ref":"refs/changes/88/1588/8","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1488322187,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1488322196,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488321047,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488321384,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_aio.c","type":"MODIFIED","insertions":44,"deletions":-1}],"sizeInsertions":44,"sizeDeletions":-1}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}