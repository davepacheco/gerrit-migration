commit 5cc6d53c406471953e0a02bfebf609273a85b57c (refs/changes/93/5693/1)
Author: Jerry Jelinek <jerry.jelinek@joyent.com>
Date:   2019-03-01T23:08:33+00:00 (7 months ago)
    
    OS-7627 allow wider raidz stripe width in disklayout

diff --git a/src/test/disklayout/16.di.w16.z3.out b/src/test/disklayout/16.di.w16.z3.out
deleted file mode 100644
index 8ddb70af..00000000
--- a/src/test/disklayout/16.di.w16.z3.out
+++ /dev/null
@@ -1 +0,0 @@
-fatal error: 16 is an invalid width for raidz3 and 16 disks (min: 9, max: 15)
diff --git a/src/test/disklayout/36.0s.w17.z3.out b/src/test/disklayout/36.0s.w17.z3.out
new file mode 100644
index 00000000..fac9cbfd
--- /dev/null
+++ b/src/test/disklayout/36.0s.w17.z3.out
@@ -0,0 +1,262 @@
+{
+	"vdevs": [
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk00",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk01",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk02",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk03",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk04",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk05",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk06",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk07",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk08",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk09",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk0a",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk0b",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk0c",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk0d",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk0e",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk0f",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk10",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		},
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk11",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk12",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk13",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk14",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk15",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk16",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk17",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk18",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk19",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1a",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1b",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1c",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1d",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1e",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk1f",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk20",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				},
+				{
+					"name": "disk21",
+					"vid": "MFG",
+					"pid": "DISK",
+					"size": "600127266816",
+					"solid_state": false
+				}
+			]
+		}
+	],
+	"capacity": 16803563470848,
+	"logs": [
+		{
+			"name": "disk23",
+			"vid": "MFG",
+			"pid": "DISK",
+			"size": "600127266816",
+			"solid_state": true
+		}
+	]
+}
diff --git a/src/test/disklayout/60.di.w21.z3.out b/src/test/disklayout/60.di.w21.z3.out
new file mode 100644
index 00000000..d7380175
--- /dev/null
+++ b/src/test/disklayout/60.di.w21.z3.out
@@ -0,0 +1 @@
+fatal error: 21 is an invalid width for raidz3 and 60 disks (min: 9, max: 20)
diff --git a/src/test/disklayout/run b/src/test/disklayout/run
index de82aca2..70a7e278 100755
--- a/src/test/disklayout/run
+++ b/src/test/disklayout/run
@@ -136,6 +136,11 @@ printf "%-16s " 60.0s.w15.out
 diff -u 60.di.0s.w15.z3.out /var/tmp/s60.out
 rm -f /var/tmp/s60.out
 
+disklayout -s 0 -w 17 -f 36.di > /var/tmp/s34.out
+printf "%-16s " 36.0s.w17.z3.out
+diff -u 36.0s.w17.z3.out /var/tmp/s34.out
+rm -f /var/tmp/s34.out
+
 disklayout -w 15 -f s16.di > /var/tmp/s16.out
 printf "%-16s " 16.w15.out
 diff -u s16.di.w15.out /var/tmp/s16.out
@@ -181,9 +186,9 @@ printf "%-16s " 7.w6.z2.out
 diff -u 7.di.w6.z2.out /var/tmp/err.out
 rm -f /var/tmp/err.out
 
-disklayout -w 16 -f s16.di raidz3 > /var/tmp/err.out
-printf "%-16s " 16.w16.z3.out
-diff -u 16.di.w16.z3.out /var/tmp/err.out
+disklayout -w 21 -f 60.di raidz3 > /var/tmp/err.out
+printf "%-16s " 60.di.w21.z3.out
+diff -u 60.di.w21.z3.out /var/tmp/err.out
 rm -f /var/tmp/err.out
 
 disklayout -w 15 -s 2 -f s16.di raidz3 > /var/tmp/err.out
diff --git a/src/test/disklayout/s16.di.z3-0.out b/src/test/disklayout/s16.di.z3-0.out
index 1da168bd..7c164576 100644
--- a/src/test/disklayout/s16.di.z3-0.out
+++ b/src/test/disklayout/s16.di.z3-0.out
@@ -1 +1,122 @@
-fatal error: no acceptable raidz3 layout is possible with 16 disks and 0 spares
+{
+	"vdevs": [
+		{
+			"type": "raidz3",
+			"devices": [
+				{
+					"name": "disk0",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk1",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk2",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk3",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk4",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk5",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk6",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk7",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk8",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "disk9",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diska",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskb",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskc",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskd",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diske",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				},
+				{
+					"name": "diskf",
+					"vid": "ATA",
+					"pid": "INTEL SSDSC2BX01",
+					"size": "1600321314816",
+					"solid_state": true
+				}
+			]
+		}
+	],
+	"capacity": 20804177092608
+}
