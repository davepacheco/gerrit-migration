From ef3d6ac88fc877b6f237e9af8cd0dd524a365334 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 7 Sep 2018 17:44:16 +0200
Subject: [PATCH] TRITON-759 CloudAPI configuration to support bhyve VM
 snapshots

---
 lib/snapshots.js                 | 8 ++++++++
 sapi_manifests/cloudapi/template | 3 +++
 2 files changed, 11 insertions(+)

diff --git a/lib/snapshots.js b/lib/snapshots.js
index 587757b..2206047 100644
--- a/lib/snapshots.js
+++ b/lib/snapshots.js
@@ -107,6 +107,14 @@ function create(req, res, next) {
     var vmUuid = params.machine;
     var name = params.name || snapshotName();
 
+    if (req.machine.brand === 'bhyve') {
+        if (!req.config.experimental_cloudapi_bhyve_snapshots) {
+            next(new restify.InvalidArgumentError(
+                'Snapshots of bhyve VMs are not allowed'));
+            return;
+        }
+    }
+
     vmapi.snapshotVm({
         uuid: vmUuid,
         name: name,
diff --git a/sapi_manifests/cloudapi/template b/sapi_manifests/cloudapi/template
index fc09b6d..1bac06e 100644
--- a/sapi_manifests/cloudapi/template
+++ b/sapi_manifests/cloudapi/template
@@ -77,6 +77,9 @@
         "url": "http://volapi.{{{datacenter_name}}}.{{{dns_domain}}}"
     },
 {{/experimental_cloudapi_nfs_shared_volumes}}
+{{#experimental_cloudapi_bhyve_snapshots}}
+    "experimental_cloudapi_bhyve_snapshots": {{{experimental_cloudapi_bhyve_snapshots}}},
+{{/experimental_cloudapi_bhyve_snapshots}}
     "cueballHttpAgent": {
         "resolvers": ["{{{BINDER_SERVICE}}}"],
         "initialDomains": [
-- 
2.21.0

