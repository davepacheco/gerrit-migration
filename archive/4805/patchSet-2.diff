commit 69d5ace1fd1019ba51bca644479bc016f25ad47f (refs/changes/05/4805/2)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2018-09-07T17:45:00+02:00 (1 year, 1 month ago)
    
    TRITON-759 CloudAPI configuration to support bhyve VM snapshots

diff --git a/lib/snapshots.js b/lib/snapshots.js
index 587757b..2206047 100644
--- a/lib/snapshots.js
+++ b/lib/snapshots.js
@@ -107,6 +107,14 @@ function create(req, res, next) {
     var vmUuid = params.machine;
     var name = params.name || snapshotName();
 
+    if (req.machine.brand === 'bhyve') {
+        if (!req.config.experimental_cloudapi_bhyve_snapshots) {
+            next(new restify.InvalidArgumentError(
+                'Snapshots of bhyve VMs are not allowed'));
+            return;
+        }
+    }
+
     vmapi.snapshotVm({
         uuid: vmUuid,
         name: name,
diff --git a/sapi_manifests/cloudapi/template b/sapi_manifests/cloudapi/template
index fc09b6d..1bac06e 100644
--- a/sapi_manifests/cloudapi/template
+++ b/sapi_manifests/cloudapi/template
@@ -77,6 +77,9 @@
         "url": "http://volapi.{{{datacenter_name}}}.{{{dns_domain}}}"
     },
 {{/experimental_cloudapi_nfs_shared_volumes}}
+{{#experimental_cloudapi_bhyve_snapshots}}
+    "experimental_cloudapi_bhyve_snapshots": {{{experimental_cloudapi_bhyve_snapshots}}},
+{{/experimental_cloudapi_bhyve_snapshots}}
     "cueballHttpAgent": {
         "resolvers": ["{{{BINDER_SERVICE}}}"],
         "initialDomains": [
