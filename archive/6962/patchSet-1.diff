From 86aa34740653f59d63063bbb35424dcd2f973284 Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Tue, 8 Oct 2019 15:57:11 -0400
Subject: [PATCH] MANTA-4515 ListBucketObjects delimiter doesn't work when the
 prefix includes that delimiter

---
 lib/server.js | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/lib/server.js b/lib/server.js
index f35dced..1fb09cd 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -1398,6 +1398,7 @@ function paginationStream(opts, onRecord, done) {
     assert.number(opts.limit, 'opts.limit');
     assert.string(opts.order_by, 'opts.order_by');
     assert.optionalString(opts.delimiter, 'opts.delimiter');
+    assert.optionalString(opts.prefix, 'opts.prefix');
     assert.func(onRecord, 'onRecord');
     assert.func(done, 'done');
 
@@ -1405,6 +1406,7 @@ function paginationStream(opts, onRecord, done) {
     var vnodes = opts.vnodes;
     var limit = opts.limit;
     var delimiter = opts.delimiter;
+    var prefix = opts.prefix;
 
     var nextMarker;
 
@@ -1521,6 +1523,18 @@ function paginationStream(opts, onRecord, done) {
 
         // try to split the string by the delimiter
         var name = rec[opts.order_by];
+
+        // delimiter is specified, chop off the prefix (if it is supplied) from
+        // the name
+        if (prefix) {
+            assert.ok(name.length >= prefix.length,
+                'name.length >= prefix.length');
+            assert.equal(name.substr(0, prefix.length), prefix,
+                'prefix correct');
+
+            name = name.substr(prefix.length);
+        }
+
         var idx = name.indexOf(delimiter);
 
         // no delimiter found, just send the plain record
@@ -1531,7 +1545,7 @@ function paginationStream(opts, onRecord, done) {
         }
 
         // delimiter found
-        var base = name.substr(0, idx);
+        var base = (prefix || '') + name.substr(0, idx);
         nextMarker = base + String.fromCharCode(delimiter.charCodeAt(0) + 1);
 
         // send the group record
-- 
2.21.0

