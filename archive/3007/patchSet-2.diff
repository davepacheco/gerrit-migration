From 5aa46f9b92a5e978181197f870d754a53a04e95e Mon Sep 17 00:00:00 2001
From: Kelly McLaughlin <kelly.mclaughlin@joyent.com>
Date: Wed, 29 Nov 2017 17:56:56 -0700
Subject: [PATCH] MANTA-2947 muskie storage utilization threshold must be
 configurable

---
 lib/picker.js                  | 11 +++++++----
 main.js                        |  3 ++-
 sapi_manifests/muskie/template |  3 ++-
 3 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/lib/picker.js b/lib/picker.js
index 06aafa9..271fdbc 100644
--- a/lib/picker.js
+++ b/lib/picker.js
@@ -74,9 +74,9 @@ var fetch = function fetch_moray(opts, cb) {
     assert.object(opts, 'options');
     assert.number(opts.lag, 'options.lag');
     assert.object(opts.moray, 'options.moray');
+    assert.number(opts.utilization, 'options.utilization');
     assert.optionalNumber(opts.limit, 'options.limit');
     assert.optionalNumber(opts.marker, 'options.marker');
-    assert.optionalNumber(opts.utilization, 'options.utilization');
     assert.optionalArrayOfObject(opts.values, 'options.values');
     assert.func(cb, 'callback');
 
@@ -85,7 +85,7 @@ var fetch = function fetch_moray(opts, cb) {
     var count = 0;
     var recs = 0;
     var f = sprintf('(&(percentUsed<=%d)(timestamp>=%d)%s)',
-                    opts.utilization || 90,
+                    opts.utilization,
                     Date.now() - opts.lag,
                     opts.marker ? '(_id>=' + opts.marker + ')' : '');
     var marker = opts.marker;
@@ -159,7 +159,7 @@ function fetch_stub(opts, cb) {
             var values;
             try {
                 values = JSON.parse(data).filter(function (obj) {
-                    return (obj.value.percentUsed < (opts.utilization || 90));
+                    return (obj.value.percentUsed < opts.utilization);
                 }).map(function (obj) {
                     return (obj.value);
                 });
@@ -181,7 +181,8 @@ function fetch_stub(opts, cb) {
 function poll() {
     var opts = {
         lag: this.lag,
-        moray: this.client
+        moray: this.client,
+        utilization: this.utilization
     };
     var self = this;
 
@@ -332,6 +333,7 @@ function Picker(opts) {
     assert.number(opts.defaultMaxStreamingSizeMB,
         'options.defaultMaxStreamingSizeMB');
     assert.object(opts.log, 'options.log');
+    assert.number(opts.maxUtilizationPct, 'options.maxUtilizationPct');
 
     EventEmitter.call(this);
 
@@ -347,6 +349,7 @@ function Picker(opts) {
     this.multiDC = opts.multiDC === undefined ? true : opts.multiDC;
     this.url = opts.url;
     this.defMaxSizeMB = opts.defaultMaxStreamingSizeMB;
+    this.utilization = opts.maxUtilizationPct;
 
     this.client.once('connect', poll.bind(this));
     this.once('topology', this.emit.bind(this, 'connect'));
diff --git a/main.js b/main.js
index 0bf2441..ba8ee8e 100644
--- a/main.js
+++ b/main.js
@@ -343,7 +343,8 @@ function createPickerClient(cfg) {
         moray: cfg.moray,
         log: LOG.child({component: 'picker'}, true),
         multiDC: cfg.multiDC,
-        defaultMaxStreamingSizeMB: cfg.defaultMaxStreamingSizeMB
+        defaultMaxStreamingSizeMB: cfg.defaultMaxStreamingSizeMB,
+        maxUtilizationPct: cfg.maxUtilizationPct || 90
     };
 
     var client = app.picker.createClient(opts);
diff --git a/sapi_manifests/muskie/template b/sapi_manifests/muskie/template
index 998e3ed..56ec6d4 100644
--- a/sapi_manifests/muskie/template
+++ b/sapi_manifests/muskie/template
@@ -182,7 +182,8 @@
   "storage": {
     "lag": 60000,
     "multiDC": {{MUSKIE_MULTI_DC}}{{#MUSKIE_DEFAULT_MAX_STREAMING_SIZE_MB}},
-    "defaultMaxStreamingSizeMB": {{MUSKIE_DEFAULT_MAX_STREAMING_SIZE_MB}}{{/MUSKIE_DEFAULT_MAX_STREAMING_SIZE_MB}},
+    "defaultMaxStreamingSizeMB": {{MUSKIE_DEFAULT_MAX_STREAMING_SIZE_MB}}{{/MUSKIE_DEFAULT_MAX_STREAMING_SIZE_MB}}{{#MUSKIE_MAX_UTILIZATION_PCT}},
+    "maxUtilizationPct": {{MUSKIE_MAX_UTILIZATION_PCT}}{{/MUSKIE_MAX_UTILIZATION_PCT}},
     "moray": {
         "srvDomain": "{{STORAGE_MORAY_SHARD}}",
         "cueballOptions": {
-- 
2.21.0

