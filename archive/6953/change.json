{"project":"joyent/manta-remora","branch":"master","id":"I5f3b205ad41915ac400c07255d6b7fb78be01d29","number":"6953","subject":"MANTA-4580 Improve handling of durability and cross datacenter fault domain during object rebalancing Reviewed by: Rui Loura \u003crui.loura@joyent.com\u003e Approved by: Rui Loura \u003crui.loura@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/6953","commitMessage":"MANTA-4580 Improve handling of durability and cross datacenter fault domain during object rebalancing\nReviewed by: Rui Loura \u003crui.loura@joyent.com\u003e\nApproved by: Rui Loura \u003crui.loura@joyent.com\u003e\n","createdOn":1570063013,"lastUpdated":1570227269,"open":false,"status":"MERGED","comments":[{"timestamp":1570063013,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1570063097,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n     Checking log v0.3.9\n error: aborting due to previous error\n \n     Checking want v0.2.0\n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1570133712,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1570135391,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1570135400,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1570135513,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 2:\n\nSomewhat related, I imagine that the skip_object() function can take that skip enumerated type that we\u0027ve been talking about instead of the str once we have it ironed out."},{"timestamp":1570135513,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n\"make check\" exited with status 2\n\n     Checking crc v1.8.1\n    Compiling diesel-derive-enum v0.4.4 (https://github.com/adwhit/diesel-derive-enum.git#2540b116)\n error: aborting due to previous error\n \n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1570138111,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 2:\n\n(1 comment)\n\nFunctionality looks good.  Just one comment on .... a comment :)"},{"timestamp":1570139804,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1570222469,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1570222586,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n\"make check\" exited with status 2\n\n \n     Checking num-integer v0.1.41\n error: aborting due to previous error\n \n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1570223888,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1570224642,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1570227231,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1570227269,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"4","revision":"5f3b205ad41915ac400c07255d6b7fb78be01d29","parents":["1d31e7bc22cccf7e0f90d62e2b32d70e40debbf1"],"ref":"refs/changes/53/6953/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1570227231,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1570222586,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1570223888,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1570224642,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1570227269,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/jobs/evacuate.rs","type":"MODIFIED","insertions":92,"deletions":-34}],"sizeInsertions":92,"sizeDeletions":-34},"patchSets":[{"number":"1","revision":"0390e2df41a2b18f762135a3cbda671bc3fe458b","parents":["1d31e7bc22cccf7e0f90d62e2b32d70e40debbf1"],"ref":"refs/changes/53/6953/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1570063013,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1570063097,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/jobs/evacuate.rs","line":1017,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"I think this is backwards.\n\n  // If the destination is in the same DC as the evac, OK\n  if from_shark.datacenter \u003d\u003d to_shark.datacenter {\n    // destination ok\n  } else if obj.sharks.iter().any(|s| { \n    s.datacenter \u003d\u003d to_shark.datacenter \n  }) {\n    // we already have a copy in that \"different\" DC, NOT OK\n  }\n\nYou could do:\n  if from_shark.datacenter !\u003d to_shark.datacenter \u0026\u0026\n    obj.sharks.iter().any(|s| { \n      s.datacenter \u003d\u003d to_shark.datacenter\n    }) {\n      return false;\n  }\n  true"},{"file":"src/jobs/evacuate.rs","line":1017,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Or I could just negate the whole expression.   That should get the job done.  Originally, I had what you have listed there, but I prefer to just return an expression if I know that it evaluates to a boolean anyway, rather than saying\n\nif (something)\n  return false\nelse\n  return true\n\nStill a good catch though because I forgot to add the \"!\"."},{"file":"src/jobs/evacuate.rs","line":1020,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Instead of Arc\u0027ing and passing the EvacuateJob, we can just make this part of the EvacuateJob implementation.  Maybe around line 429."},{"file":"src/jobs/evacuate.rs","line":1020,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"src/jobs/evacuate.rs","line":1027,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"You can remove this comment.  This was added before we had sqlite support."},{"file":"src/jobs/evacuate.rs","line":1027,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/jobs/evacuate.rs","type":"MODIFIED","insertions":47,"deletions":-24}],"sizeInsertions":47,"sizeDeletions":-24},{"number":"2","revision":"4a410be95812c33d0ec66915d86e48f0a8693100","parents":["1d31e7bc22cccf7e0f90d62e2b32d70e40debbf1"],"ref":"refs/changes/53/6953/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1570135391,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1570135513,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/jobs/evacuate.rs","line":1025,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"With the exception of the single datacenter region, we do not want to allow two objects..."},{"file":"src/jobs/evacuate.rs","line":1025,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"You don\u0027t feel like that\u0027s clear from the first sentence in that comment?"},{"file":"src/jobs/evacuate.rs","line":1025,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Yeah, I\u0027m not sure the best way to word this.  I suppose what you have is fine."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/jobs/evacuate.rs","type":"MODIFIED","insertions":46,"deletions":-24}],"sizeInsertions":46,"sizeDeletions":-24},{"number":"3","revision":"4ef40d05b542fe6dc6b591a1d25d2b01b86693b6","parents":["1d31e7bc22cccf7e0f90d62e2b32d70e40debbf1"],"ref":"refs/changes/53/6953/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1570222469,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1570222586,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1570223888,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1570224642,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/jobs/evacuate.rs","type":"MODIFIED","insertions":92,"deletions":-34}],"sizeInsertions":92,"sizeDeletions":-34},{"number":"4","revision":"5f3b205ad41915ac400c07255d6b7fb78be01d29","parents":["1d31e7bc22cccf7e0f90d62e2b32d70e40debbf1"],"ref":"refs/changes/53/6953/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1570227231,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1570222586,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1570223888,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1570224642,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1570227269,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/jobs/evacuate.rs","type":"MODIFIED","insertions":92,"deletions":-34}],"sizeInsertions":92,"sizeDeletions":-34}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}