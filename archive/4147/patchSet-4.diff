From 2ed706c5da63e5a6647e9ad2fd90965a792132fe Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Wed, 13 Jun 2018 14:05:53 -0700
Subject: [PATCH] TRITON-469 CNAPI should be able to connect to cn-agent
 listening on non-default port

---
 lib/models/server.js | 102 ++++++++++++++++++++++++++++++++++---------
 package.json         |   4 +-
 2 files changed, 84 insertions(+), 22 deletions(-)

diff --git a/lib/models/server.js b/lib/models/server.js
index ccabe5c..016fb62 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -17,6 +17,7 @@
 var async = require('async');
 var assert = require('assert-plus');
 var dns = require('dns');
+var jsprim = require('jsprim');
 var qs = require('querystring');
 var restify = require('restify');
 var sprintf = require('sprintf').sprintf;
@@ -2100,10 +2101,13 @@ function (opts) {
     assert.optionalFunc(opts.cb, 'opts.cb');
 
     var task, params, callback, origreq, persist;
-    var synccb;
-    var serverAdminIp;
+
     var client;
     var req_id;
+    var serverAdminIp;
+    var serverAdminPort = 5309;
+    var synccb;
+    var sysinfo;
 
     if (opts.req_id) {
         req_id = opts.req_id;
@@ -2144,28 +2148,54 @@ function (opts) {
      */
 
     async.waterfall([
-        function (wfcb) {
+        // XXX this code is the same as ModelServer.prototype.sendRequest
+        // could use some deduplication
+        function getSysinfo(wfcb) {
             self.getRaw(function (err, server) {
                 if (err) {
                     wfcb(new VError(err, err));
-                   return;
+                    return;
                 }
 
                 if (!server) {
                     wfcb(new VError('server not found'));
-                   return;
+                    return;
                 }
+                sysinfo = server.sysinfo;
 
+                log.info('sysinfo for %s before task %s', self.uuid, task);
+
+                wfcb();
+            });
+        },
+        function getCnapiLocationFromSysinfo(wfcb) {
+            if (sysinfo.hasOwnProperty('CN Agent IP')) {
+                // Allow sysinfo to include an IP that we'll use to connect to
+                // instead of trying to fish the IP out of the networks.
+                serverAdminIp = sysinfo['CN Agent IP'];
+            } else {
                 try {
-                    serverAdminIp = firstAdminIp(server.sysinfo);
+                    serverAdminIp = firstAdminIp(sysinfo);
                 } catch (e) {
                     wfcb(new VError(e, 'parsing server ip address'));
                     return;
                 }
+            }
 
-                log.info('sysinfo for %s before task %s', self.uuid, task);
-                wfcb();
-            });
+            if (sysinfo.hasOwnProperty('CN Agent Port')) {
+                if (!jsprim.parseInteger('CN Agent Port') instanceof Error) {
+                    serverAdminPort = sysinfo['CN Agent Port'];
+                }
+            }
+
+            log.info({
+                serverAdminIp: serverAdminIp,
+                serverAdminPort: serverAdminPort,
+                serverUuid: self.uuid,
+                task: task
+            }, 'found server location before task request');
+
+            wfcb();
         },
         function (wfcb) {
             if (persist) {
@@ -2176,7 +2206,7 @@ function (opts) {
         },
         function (wfcb) {
             var cOpts = {
-                url: 'http://' + serverAdminIp + ':' + 5309,
+                url: 'http://' + serverAdminIp + ':' + serverAdminPort,
                 requestTimeout: 3600 * 1000,
                 connectTimeout: 3600 * 1000
             };
@@ -2316,44 +2346,76 @@ ModelServer.prototype.sendRequest = function (opts, cb) {
     assert.optionalObject(opts.params, 'opts.params');
     assert.func(cb, 'cb');
 
+    var client;
     var method = opts.method.toLowerCase();
     var params = opts.params || {};
     var serverAdminIp;
-    var client;
+    var serverAdminPort = 5309;
+    var sysinfo;
 
     var log = self.log;
 
     async.waterfall([
-        function getAdminIpFromSysinfo(wfcb) {
+        // XXX this code is the same as ModelServer.prototype.sendTaskRequest
+        // could use some deduplication
+        function getSysinfo(wfcb) {
             self.getRaw(function (err, server) {
                 if (err) {
                     wfcb(new VError(err, err));
-                   return;
+                    return;
                 }
 
                 if (!server) {
                     wfcb(new VError('server not found'));
-                   return;
+                    return;
                 }
+                sysinfo = server.sysinfo;
 
+                log.info('sysinfo for %s before HTTP request', self.uuid);
+
+                wfcb();
+            });
+        },
+        function getCnapiLocationFromSysinfo(wfcb) {
+            if (sysinfo.hasOwnProperty('CN Agent IP')) {
+                // Allow sysinfo to include an IP that we'll use to connect to
+                // instead of trying to fish the IP out of the networks.
+                serverAdminIp = sysinfo['CN Agent IP'];
+            } else {
                 try {
-                    serverAdminIp = firstAdminIp(server.sysinfo);
+                    serverAdminIp = firstAdminIp(sysinfo);
                 } catch (e) {
                     wfcb(new VError(e, 'parsing server ip address'));
                     return;
                 }
+            }
 
-                log.info('sysinfo for %s before HTTP request', self.uuid);
-                wfcb();
-            });
+            if (sysinfo.hasOwnProperty('CN Agent Port')) {
+                if (!jsprim.parseInteger('CN Agent Port') instanceof Error) {
+                    serverAdminPort = sysinfo['CN Agent Port'];
+                }
+            }
+
+            log.info({
+                serverAdminIp: serverAdminIp,
+                serverAdminPort: serverAdminPort,
+                serverUuid: self.uuid
+            }, 'found server location before HTTP request');
+
+            wfcb();
         },
         function executeRequest(wfcb) {
             var cOpts = {
-                url: 'http://' + serverAdminIp + ':' + 5309,
+                url: 'http://' + serverAdminIp + ':' + serverAdminPort,
                 requestTimeout: 3600 * 1000,
                 connectTimeout: 3600 * 1000
             };
-            var rOpts = { path: opts.path };
+            var rOpts = {
+                headers: {
+                    'x-server-uuid': self.uuid
+                },
+                path: opts.path
+            };
 
             client = restify.createJsonClient(cOpts);
 
diff --git a/package.json b/package.json
index 6438f03..6b55537 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cnapi",
   "description": "SmartDataCenter Compute Node API",
-  "version": "1.9.1",
+  "version": "1.10.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -13,7 +13,7 @@
     "deep-equal": "1.0.1",
     "dox": "0.9.0",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
-    "jsprim": "1.3.1",
+    "jsprim": "1.4.1",
     "libuuid": "0.2.1",
     "moray": "3.5.0",
     "nodeunit": "0.11.0",
-- 
2.21.0

