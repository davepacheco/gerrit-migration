From 60ff9290d768b950992850a98e28965e69d4cdec Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Fri, 20 Oct 2017 20:35:44 +0000
Subject: [PATCH] OS-6416 add bhyve UEFI firmware to illumos-extra

---
 Makefile                          |   1 +
 manifest                          |   3 +
 uefi-edk2/Makefile                |  54 ++++++++++++++
 uefi-edk2/Patches/BaseTools.diff  | 118 ++++++++++++++++++++++++++++++
 uefi-edk2/Patches/BhyveCsm16.diff |  33 +++++++++
 uefi-edk2/README                  |   2 +
 uefi-edk2/uefi-edk2.tar.gz        | Bin 0 -> 30980154 bytes
 7 files changed, 211 insertions(+)
 create mode 100644 uefi-edk2/Makefile
 create mode 100644 uefi-edk2/Patches/BaseTools.diff
 create mode 100644 uefi-edk2/Patches/BhyveCsm16.diff
 create mode 100644 uefi-edk2/README
 create mode 100644 uefi-edk2/uefi-edk2.tar.gz

diff --git a/Makefile b/Makefile
index 165f999..7692a74 100644
--- a/Makefile
+++ b/Makefile
@@ -73,6 +73,7 @@ SUBDIRS = \
 	screen \
 	socat \
 	tun \
+	uefi-edk2 \
 	uuid \
 	vim \
 	wget \
diff --git a/manifest b/manifest
index 3399611..89916b6 100644
--- a/manifest
+++ b/manifest
@@ -27,6 +27,7 @@ d usr/gnu/share 0755 root sys
 d usr/gnu/share/doc 0755 root other
 d usr/sbin 0755 root bin
 d usr/share 0755 root sys
+d usr/share/bhyve 0755 root sys
 d usr/share/lib 0755 root bin
 d usr/share/man 0755 root bin
 d usr/share/man/man1 0755 root bin
@@ -3020,6 +3021,8 @@ f usr/share/man/man1/screen.1 0444 root bin
 # socat
 f usr/bin/socat 0555 root bin
 f usr/share/man/man1/socat.1 0444 root bin
+# uefi-edk2
+f usr/share/bhyve/uefi-rom.bin 0644 root bin
 # uuid
 f usr/bin/uuid 0755 root bin
 f usr/share/man/man1/uuid.1 0644 root bin
diff --git a/uefi-edk2/Makefile b/uefi-edk2/Makefile
new file mode 100644
index 0000000..c8beed9
--- /dev/null
+++ b/uefi-edk2/Makefile
@@ -0,0 +1,54 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright 2017 Joyent, Inc.
+#
+
+
+VER =	uefi-edk2
+
+include ../Makefile.defs
+
+PATCHES =		Patches/*
+UNPACK_SENTINEL =	edksetup.sh
+
+include ../Makefile.targ
+
+STRAPPROTO=	$(PWD)/../../../proto.strap
+MAKE_ARGS+=	AS=$(STRAPPROTO)/usr/gnu/bin/gas \
+		AR=$(STRAPPROTO)/usr/gnu/bin/gar \
+		LD=$(STRAPPROTO)/usr/gnu/bin/gld \
+		OBJCOPY=$(STRAPPROTO)/usr/gnu/bin/gobjcopy \
+		CC=$(STRAPPROTO)/usr/bin/gcc \
+		CXX=$(STRAPPROTO)/usr/bin/g++
+
+ARCH=		X64
+UEFI_TARGET=	RELEASE
+
+
+all: $(VER.64)/$(UNPACK_SENTINEL)
+	mkdir -p $(VER.64)/Build
+	ln -sf $(STRAPPROTO)/usr/bin/gcc $(VER.64)/Build/gcc
+	ln -sf $(STRAPPROTO)/usr/gnu/bin/gld $(VER.64)/Build/ld
+	ln -sf /opt/local/bin/gmake $(VER.64)/Build/make
+	ln -sf $(STRAPPROTO)/usr/gnu/bin/gar $(VER.64)/Build/ar
+	ln -sf $(STRAPPROTO)/usr/gnu/bin/gobjcopy $(VER.64)/Build/objcopy
+	ln -sf /opt/local/bin/nasm $(VER.64)/Build/nasm
+	$(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C $(VER.64)/BaseTools
+	bash -c "cd $(VER.64); source edksetup.sh; $(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C BhyvePkg/Csm/BhyveCsm16"
+	bash -c "cd $(VER.64); source edksetup.sh; export ILGCC_BIN=$(PWD)/$(VER.64)/Build/; build -t ILGCC -a $(ARCH) -b $(UEFI_TARGET) -p BhyvePkg/BhyvePkgX64.dsc -DDEBUG_ON_SERIAL_PORT=TRUE -DFD_SIZE_2MB -DCSM_ENABLE=TRUE"
+	mv $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/BHYVE.fd $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/uefi-rom.bin
+
+install: all
+	mkdir -p $(DESTDIR)/usr/share/bhyve
+	/usr/sbin/install -m 0755 -f $(DESTDIR)/usr/share/bhyve $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/uefi-rom.bin
+
diff --git a/uefi-edk2/Patches/BaseTools.diff b/uefi-edk2/Patches/BaseTools.diff
new file mode 100644
index 0000000..8a6fe62
--- /dev/null
+++ b/uefi-edk2/Patches/BaseTools.diff
@@ -0,0 +1,118 @@
+--- a/BaseTools/Source/C/Makefiles/header.makefile.orig	2016-05-25 17:12:18.000000000 +0000
++++ b/BaseTools/Source/C/Makefiles/header.makefile	2017-10-23 15:16:42.344167968 +0000
+@@ -20,6 +20,7 @@ ARCH ?= IA32
+ CYGWIN:=$(findstring CYGWIN, $(shell uname -s))
+ LINUX:=$(findstring Linux, $(shell uname -s))
+ DARWIN:=$(findstring Darwin, $(shell uname -s))
++SUNOS:=$(findstring SunOS, $(shell uname -s))
+ 
+ CC ?= gcc
+ CXX ?= g++
+@@ -66,7 +67,15 @@ ifeq ($(DARWIN),Darwin)
+ endif
+ endif
+ 
+-  
++ifeq ($(ARCH), X64)
++ifeq ($(SUNOS),SunOS)
++  CFLAGS   += -m64
++  CPPFLAGS   += -m64
++  LFLAGS   += -m64
++endif
++endif
++
++ 
+ .PHONY: all
+ .PHONY: install
+ .PHONY: clean
+--- a/BaseTools/Conf/illumos.specs	2018-02-03 16:44:57.000000000 +0000
++++ b/BaseTools/Conf/illumos.specs	2018-02-03 16:47:31.139600153 +0000
+@@ -0,0 +1,4 @@
++%rename	cpp	old_cpp
++
++*cpp:
++%(cpp_subtarget)
+--- a/BaseTools/Conf/tools_def.template.orig	2016-05-25 17:12:18.000000000 +0000
++++ b/BaseTools/Conf/tools_def.template	2018-02-03 17:02:29.919648815 +0000
+@@ -4127,6 +4127,81 @@ DEFINE GCC49_AARCH64_ASLDLINK_FLAGS  = D
+ *_GCC44_X64_OBJCOPY_FLAGS        = 
+ *_GCC44_X64_NASM_FLAGS           = -f elf64
+ 
++#############################################################################
++#
++# ILGCC       -- illumos
++#         This configuration is used to compile under illumos to produce
++#         PE/COFF binaries using GCC 4.4.4
++#
++#############################################################################
++
++*_ILGCC_*_*_FAMILY			= GCC
++
++DEFINE ILGCC_PREFIX			= ENV(ILGCC_BIN)
++DEFINE ILGCC_IA32_PREFIX		= DEF(ILGCC_PREFIX)
++DEFINE ILGCC_X64_PREFIX			= DEF(ILGCC_PREFIX)
++
++DEFINE ILGCC_ALL_CC_FLAGS		= DEF(GCC44_ALL_CC_FLAGS)
++DEFINE ILGCC_IA32_CC_FLAGS		= DEF(GCC44_IA32_CC_FLAGS)
++DEFINE ILGCC_X64_CC_FLAGS		= DEF(GCC44_X64_CC_FLAGS)
++DEFINE ILGCC_IA32_X64_DLINK_COMMON	= DEF(GCC44_IA32_X64_DLINK_COMMON)
++DEFINE ILGCC_IA32_X64_ASLDLINK_FLAGS	= DEF(GCC44_IA32_X64_ASLDLINK_FLAGS)
++DEFINE ILGCC_IA32_X64_DLINK_FLAGS	= DEF(GCC44_IA32_X64_DLINK_FLAGS)
++DEFINE ILGCC_X64_DLINK_FLAGS		= DEF(ILGCC_IA32_X64_DLINK_FLAGS) -melf_x86_64_sol2 --oformat=elf64-x86-64-sol2
++DEFINE ILGCC_ASM_FLAGS			= DEF(GCC44_ASM_FLAGS)
++
++*_ILGCC_*_MAKE_PATH			= DEF(ILGCC_PREFIX)make
++*_ILGCC_*_*_DLL				= ENV(GCC44_DLL)
++*_ILGCC_*_ASL_PATH			= DEF(UNIX_IASL_BIN)
++
++*_ILGCC_*_OBJCOPY_PATH			= DEF(ILGCC_PREFIX)objcopy
++*_ILGCC_*_CC_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_SLINK_PATH			= DEF(ILGCC_PREFIX)ar
++*_ILGCC_*_DLINK_PATH			= DEF(ILGCC_PREFIX)ld
++*_ILGCC_*_ASLDLINK_PATH			= DEF(ILGCC_PREFIX)ld
++*_ILGCC_*_ASM_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_PP_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_VFRPP_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_ASLCC_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_ASLPP_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_RC_PATH			= DEF(ILGCC_PREFIX)objcopy
++
++# Specify an alternative specs file that doesn't remove line number information
++# when pre-processing assembly language files.
++*_ILGCC_*_PP_FLAGS                     = DEF(GCC_PP_FLAGS) -specs=ENV(WORKSPACE)/BaseTools/Conf/illumos.specs
++*_ILGCC_*_ASLPP_FLAGS                  = DEF(GCC_ASLPP_FLAGS)
++*_ILGCC_*_ASLCC_FLAGS                  = DEF(GCC_ASLCC_FLAGS)
++*_ILGCC_*_VFRPP_FLAGS                  = DEF(GCC_VFRPP_FLAGS)
++*_ILGCC_*_APP_FLAGS                    = DEF(GCC_PP_FLAGS)
++*_ILGCC_*_ASL_FLAGS                    = DEF(IASL_FLAGS)
++*_ILGCC_*_ASL_OUTFLAGS                 = DEF(IASL_OUTFLAGS)
++
++##################
++# ILGCC IA32 definitions
++##################
++
++*_ILGCC_IA32_ASLCC_FLAGS          = DEF(GCC_ASLCC_FLAGS) -m32
++*_ILGCC_IA32_ASLDLINK_FLAGS       = DEF(ILGCC_IA32_X64_ASLDLINK_FLAGS) -m elf_i386
++*_ILGCC_IA32_ASM_FLAGS            = DEF(ILGCC_ASM_FLAGS) -m32 --32 -march=i386
++*_ILGCC_IA32_CC_FLAGS             = DEF(ILGCC_IA32_CC_FLAGS) -Os
++*_ILGCC_IA32_DLINK_FLAGS          = DEF(ILGCC_IA32_X64_DLINK_FLAGS) -m elf_i386 --oformat=elf32-i386
++*_ILGCC_IA32_RC_FLAGS             = DEF(GCC_IA32_RC_FLAGS)
++*_ILGCC_IA32_OBJCOPY_FLAGS        = 
++*_ILGCC_IA32_NASM_FLAGS           = -f elf32
++
++##################
++# ILGCC X64 definitions
++##################
++
++*_ILGCC_X64_ASLCC_FLAGS          = DEF(GCC_ASLCC_FLAGS) -m64
++*_ILGCC_X64_ASLDLINK_FLAGS       = DEF(ILGCC_IA32_X64_ASLDLINK_FLAGS) -m elf_x86_64_sol2
++*_ILGCC_X64_ASM_FLAGS            = DEF(ILGCC_ASM_FLAGS) -m64 --64 -melf_x86_64_sol2
++*_ILGCC_X64_CC_FLAGS             = DEF(ILGCC_X64_CC_FLAGS)
++*_ILGCC_X64_DLINK_FLAGS          = DEF(ILGCC_X64_DLINK_FLAGS)
++*_ILGCC_X64_RC_FLAGS             = DEF(GCC_X64_RC_FLAGS)
++*_ILGCC_X64_OBJCOPY_FLAGS        = 
++*_ILGCC_X64_NASM_FLAGS           = -f elf64
++
+ ####################################################################################
+ #
+ # GCC 4.5 - This configuration is used to compile under Linux to produce
diff --git a/uefi-edk2/Patches/BhyveCsm16.diff b/uefi-edk2/Patches/BhyveCsm16.diff
new file mode 100644
index 0000000..ade9d00
--- /dev/null
+++ b/uefi-edk2/Patches/BhyveCsm16.diff
@@ -0,0 +1,33 @@
+--- a/BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S.orig	2016-05-25 17:12:18.000000000 +0000
++++ b/BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S	2017-10-23 15:21:45.563145538 +0000
+@@ -368,7 +368,7 @@
+ 
+         /*  Zero out the 24KB buffer. */
+         push    %di
+-        mov     $(6*(4096/4)), %ecx
++        mov     $6144, %ecx
+         xor     %eax, %eax
+         cld
+         rep stos %eax,(%di)
+--- a/BhyvePkg/Csm/BhyveCsm16/GNUmakefile.orig	2016-05-25 17:12:18.000000000 +0000
++++ b/BhyvePkg/Csm/BhyveCsm16/GNUmakefile	2017-10-23 15:22:47.231309461 +0000
+@@ -61,7 +61,7 @@
+ 	$(CC) $(ASFLAGS) $(CPPFLAGS) -c -o $@ $<
+ 
+ Bin/BhyveCsm16.bin: linker.lds $(OBJECTS)
+-	$(LD) -Tlinker.lds -m elf_x86_64_fbsd -o Bin/BhyveCsm16.raw.o -Map Bin/BhyveCsm16.bin.map $(OBJECTS)
++	$(LD) -Tlinker.lds -m elf_x86_64_sol2 -o Bin/BhyveCsm16.raw.o -Map Bin/BhyveCsm16.bin.map $(OBJECTS)
+ 	$(OBJCOPY) --only-section .raw --output-target binary --pad-to 0x100000 Bin/BhyveCsm16.raw.o Bin/BhyveCsm16.bin
+ 
+ clean:
+--- a/BhyvePkg/Csm/BhyveCsm16/linker.lds.orig	2016-05-25 17:12:18.000000000 +0000
++++ b/BhyvePkg/Csm/BhyveCsm16/linker.lds	2017-10-23 15:23:25.821238974 +0000
+@@ -11,7 +11,7 @@
+  * EXPRESS OR IMPLIED.
+  */
+ 
+-OUTPUT_FORMAT("elf64-x86-64")
++OUTPUT_FORMAT("elf64-x86-64-sol2")
+ OUTPUT_ARCH(i386:x86-64)
+ 
+ SECTIONS
diff --git a/uefi-edk2/README b/uefi-edk2/README
new file mode 100644
index 0000000..7f01056
--- /dev/null
+++ b/uefi-edk2/README
@@ -0,0 +1,2 @@
+This is uefi-edk2 from FreeBSD for bhyve. The upstream for this is the
+bhyve/UDK2014.SP1 branch in git@github.com:freebsd/uefi-edk2.git.
diff --git a/uefi-edk2/uefi-edk2.tar.gz b/uefi-edk2/uefi-edk2.tar.gz
new file mode 100644
index 0000000..fc1e7a5
Binary files /dev/null and b/uefi-edk2/uefi-edk2.tar.gz differ
-- 
2.21.0

