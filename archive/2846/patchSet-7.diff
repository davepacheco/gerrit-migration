From 1f07edc8a3cca8a02c142fa009ce5447faa02ca2 Mon Sep 17 00:00:00 2001
From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
Date: Fri, 20 Oct 2017 20:35:44 +0000
Subject: [PATCH] OS-6416 add bhyve UEFI firmware to illumos-extra

---
 Makefile                                      |   1 +
 manifest                                      |   3 +
 uefi-edk2/Makefile                            |  54 +++++++
 ...Add-ILGCC-target-to-build-on-illumos.patch | 137 ++++++++++++++++++
 .../0002-Fix-build-of-BhyveCsm16.patch        |  50 +++++++
 ...mum-memory-range-in-bhyve-DSDT-table.patch |  25 ++++
 uefi-edk2/README                              |   2 +
 uefi-edk2/uefi-edk2-a36132939e.tar.gz         | Bin 0 -> 31657635 bytes
 8 files changed, 272 insertions(+)
 create mode 100644 uefi-edk2/Makefile
 create mode 100644 uefi-edk2/Patches/0001-Add-ILGCC-target-to-build-on-illumos.patch
 create mode 100644 uefi-edk2/Patches/0002-Fix-build-of-BhyveCsm16.patch
 create mode 100644 uefi-edk2/Patches/0003-Increase-maximum-memory-range-in-bhyve-DSDT-table.patch
 create mode 100644 uefi-edk2/README
 create mode 100644 uefi-edk2/uefi-edk2-a36132939e.tar.gz

diff --git a/Makefile b/Makefile
index 165f999..7692a74 100644
--- a/Makefile
+++ b/Makefile
@@ -73,6 +73,7 @@ SUBDIRS = \
 	screen \
 	socat \
 	tun \
+	uefi-edk2 \
 	uuid \
 	vim \
 	wget \
diff --git a/manifest b/manifest
index 3399611..e2568f6 100644
--- a/manifest
+++ b/manifest
@@ -27,6 +27,7 @@ d usr/gnu/share 0755 root sys
 d usr/gnu/share/doc 0755 root other
 d usr/sbin 0755 root bin
 d usr/share 0755 root sys
+d usr/share/bhyve 0755 root sys
 d usr/share/lib 0755 root bin
 d usr/share/man 0755 root bin
 d usr/share/man/man1 0755 root bin
@@ -3020,6 +3021,8 @@ f usr/share/man/man1/screen.1 0444 root bin
 # socat
 f usr/bin/socat 0555 root bin
 f usr/share/man/man1/socat.1 0444 root bin
+# uefi-edk2
+f usr/share/bhyve/uefi-csm-rom.bin 0644 root bin
 # uuid
 f usr/bin/uuid 0755 root bin
 f usr/share/man/man1/uuid.1 0644 root bin
diff --git a/uefi-edk2/Makefile b/uefi-edk2/Makefile
new file mode 100644
index 0000000..49af187
--- /dev/null
+++ b/uefi-edk2/Makefile
@@ -0,0 +1,54 @@
+#
+# This file and its contents are supplied under the terms of the
+# Common Development and Distribution License ("CDDL"), version 1.0.
+# You may only use this file in accordance with the terms of version
+# 1.0 of the CDDL.
+#
+# A full copy of the text of the CDDL should have accompanied this
+# source.  A copy of the CDDL is also available via the Internet at
+# http://www.illumos.org/license/CDDL.
+#
+
+#
+# Copyright 2018 Joyent, Inc.
+#
+
+
+VER =	uefi-edk2-a36132939e
+
+include ../Makefile.defs
+
+PATCHES =		Patches/*
+UNPACK_SENTINEL =	edksetup.sh
+
+include ../Makefile.targ
+
+STRAPPROTO=	$(PWD)/../../../proto.strap
+MAKE_ARGS+=	AS=$(STRAPPROTO)/usr/gnu/bin/gas \
+		AR=$(STRAPPROTO)/usr/gnu/bin/gar \
+		LD=$(STRAPPROTO)/usr/gnu/bin/gld \
+		OBJCOPY=$(STRAPPROTO)/usr/gnu/bin/gobjcopy \
+		CC=$(STRAPPROTO)/usr/bin/gcc \
+		CXX=$(STRAPPROTO)/usr/bin/g++
+
+ARCH=		X64
+UEFI_TARGET=	RELEASE
+
+
+all: $(VER.64)/$(UNPACK_SENTINEL)
+	mkdir -p $(VER.64)/Build
+	ln -sf $(STRAPPROTO)/usr/bin/gcc $(VER.64)/Build/gcc
+	ln -sf $(STRAPPROTO)/usr/gnu/bin/gld $(VER.64)/Build/ld
+	ln -sf /opt/local/bin/gmake $(VER.64)/Build/make
+	ln -sf $(STRAPPROTO)/usr/gnu/bin/gar $(VER.64)/Build/ar
+	ln -sf $(STRAPPROTO)/usr/gnu/bin/gobjcopy $(VER.64)/Build/objcopy
+	ln -sf /opt/local/bin/nasm $(VER.64)/Build/nasm
+	$(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C $(VER.64)/BaseTools
+	bash -c "cd $(VER.64); source edksetup.sh; $(MAKE) $(MAKE_ARGS) ARCH=$(ARCH) -C BhyvePkg/Csm/BhyveCsm16"
+	bash -c "cd $(VER.64); source edksetup.sh; export ILGCC_BIN=$(PWD)/$(VER.64)/Build/; build -t ILGCC -a $(ARCH) -b $(UEFI_TARGET) -p BhyvePkg/BhyvePkgX64.dsc -DDEBUG_ON_SERIAL_PORT=TRUE -DFD_SIZE_2MB -DCSM_ENABLE=TRUE"
+	mv $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/BHYVE.fd $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/uefi-csm-rom.bin
+
+install: all
+	mkdir -p $(DESTDIR)/usr/share/bhyve
+	/usr/sbin/install -m 0755 -f $(DESTDIR)/usr/share/bhyve $(VER.64)/Build/BhyveX64/RELEASE_ILGCC/FV/uefi-csm-rom.bin
+
diff --git a/uefi-edk2/Patches/0001-Add-ILGCC-target-to-build-on-illumos.patch b/uefi-edk2/Patches/0001-Add-ILGCC-target-to-build-on-illumos.patch
new file mode 100644
index 0000000..db771e9
--- /dev/null
+++ b/uefi-edk2/Patches/0001-Add-ILGCC-target-to-build-on-illumos.patch
@@ -0,0 +1,137 @@
+From 05291454b0ebd1468b7c0e5e5cf4c093ab3f0dad Mon Sep 17 00:00:00 2001
+From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
+Date: Fri, 9 Feb 2018 13:05:51 +0000
+Subject: [PATCH 1/3] Add ILGCC target to build on illumos.
+
+---
+ BaseTools/Conf/illumos.specs                 |  4 ++
+ BaseTools/Conf/tools_def.template            | 75 ++++++++++++++++++++++++++++
+ BaseTools/Source/C/Makefiles/header.makefile | 11 +++-
+ 3 files changed, 89 insertions(+), 1 deletion(-)
+ create mode 100644 BaseTools/Conf/illumos.specs
+
+diff --git a/BaseTools/Conf/illumos.specs b/BaseTools/Conf/illumos.specs
+new file mode 100644
+index 0000000..41713fb
+--- /dev/null
++++ b/BaseTools/Conf/illumos.specs
+@@ -0,0 +1,4 @@
++%rename	cpp	old_cpp
++
++*cpp:
++%(cpp_subtarget)
+diff --git a/BaseTools/Conf/tools_def.template b/BaseTools/Conf/tools_def.template
+index 3fb1216..1b9099e 100644
+--- a/BaseTools/Conf/tools_def.template
++++ b/BaseTools/Conf/tools_def.template
+@@ -4127,6 +4127,81 @@ DEFINE GCC49_AARCH64_ASLDLINK_FLAGS  = DEF(GCC_ARM_AARCH64_ASLDLINK_FLAGS)
+ *_GCC44_X64_OBJCOPY_FLAGS        = 
+ *_GCC44_X64_NASM_FLAGS           = -f elf64
+ 
++#############################################################################
++#
++# ILGCC       -- illumos
++#         This configuration is used to compile under illumos to produce
++#         PE/COFF binaries using GCC 4.4.4
++#
++#############################################################################
++
++*_ILGCC_*_*_FAMILY			= GCC
++
++DEFINE ILGCC_PREFIX			= ENV(ILGCC_BIN)
++DEFINE ILGCC_IA32_PREFIX		= DEF(ILGCC_PREFIX)
++DEFINE ILGCC_X64_PREFIX			= DEF(ILGCC_PREFIX)
++
++DEFINE ILGCC_ALL_CC_FLAGS		= DEF(GCC44_ALL_CC_FLAGS)
++DEFINE ILGCC_IA32_CC_FLAGS		= DEF(GCC44_IA32_CC_FLAGS)
++DEFINE ILGCC_X64_CC_FLAGS		= DEF(GCC44_X64_CC_FLAGS)
++DEFINE ILGCC_IA32_X64_DLINK_COMMON	= DEF(GCC44_IA32_X64_DLINK_COMMON)
++DEFINE ILGCC_IA32_X64_ASLDLINK_FLAGS	= DEF(GCC44_IA32_X64_ASLDLINK_FLAGS)
++DEFINE ILGCC_IA32_X64_DLINK_FLAGS	= DEF(GCC44_IA32_X64_DLINK_FLAGS)
++DEFINE ILGCC_X64_DLINK_FLAGS		= DEF(ILGCC_IA32_X64_DLINK_FLAGS) -melf_x86_64_sol2 --oformat=elf64-x86-64-sol2
++DEFINE ILGCC_ASM_FLAGS			= DEF(GCC44_ASM_FLAGS)
++
++*_ILGCC_*_MAKE_PATH			= DEF(ILGCC_PREFIX)make
++*_ILGCC_*_*_DLL				= ENV(GCC44_DLL)
++*_ILGCC_*_ASL_PATH			= DEF(UNIX_IASL_BIN)
++
++*_ILGCC_*_OBJCOPY_PATH			= DEF(ILGCC_PREFIX)objcopy
++*_ILGCC_*_CC_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_SLINK_PATH			= DEF(ILGCC_PREFIX)ar
++*_ILGCC_*_DLINK_PATH			= DEF(ILGCC_PREFIX)ld
++*_ILGCC_*_ASLDLINK_PATH			= DEF(ILGCC_PREFIX)ld
++*_ILGCC_*_ASM_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_PP_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_VFRPP_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_ASLCC_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_ASLPP_PATH			= DEF(ILGCC_PREFIX)gcc
++*_ILGCC_*_RC_PATH			= DEF(ILGCC_PREFIX)objcopy
++
++# Specify an alternative specs file that doesn't remove line number information
++# when pre-processing assembly language files.
++*_ILGCC_*_PP_FLAGS                     = DEF(GCC_PP_FLAGS) -specs=ENV(WORKSPACE)/BaseTools/Conf/illumos.specs
++*_ILGCC_*_ASLPP_FLAGS                  = DEF(GCC_ASLPP_FLAGS)
++*_ILGCC_*_ASLCC_FLAGS                  = DEF(GCC_ASLCC_FLAGS)
++*_ILGCC_*_VFRPP_FLAGS                  = DEF(GCC_VFRPP_FLAGS)
++*_ILGCC_*_APP_FLAGS                    = DEF(GCC_PP_FLAGS)
++*_ILGCC_*_ASL_FLAGS                    = DEF(IASL_FLAGS)
++*_ILGCC_*_ASL_OUTFLAGS                 = DEF(IASL_OUTFLAGS)
++
++##################
++# ILGCC IA32 definitions
++##################
++
++*_ILGCC_IA32_ASLCC_FLAGS          = DEF(GCC_ASLCC_FLAGS) -m32
++*_ILGCC_IA32_ASLDLINK_FLAGS       = DEF(ILGCC_IA32_X64_ASLDLINK_FLAGS) -m elf_i386
++*_ILGCC_IA32_ASM_FLAGS            = DEF(ILGCC_ASM_FLAGS) -m32 --32 -march=i386
++*_ILGCC_IA32_CC_FLAGS             = DEF(ILGCC_IA32_CC_FLAGS) -nostdinc -Os
++*_ILGCC_IA32_DLINK_FLAGS          = DEF(ILGCC_IA32_X64_DLINK_FLAGS) -m elf_i386 --oformat=elf32-i386
++*_ILGCC_IA32_RC_FLAGS             = DEF(GCC_IA32_RC_FLAGS)
++*_ILGCC_IA32_OBJCOPY_FLAGS        = 
++*_ILGCC_IA32_NASM_FLAGS           = -f elf32
++
++##################
++# ILGCC X64 definitions
++##################
++
++*_ILGCC_X64_ASLCC_FLAGS          = DEF(GCC_ASLCC_FLAGS) -m64
++*_ILGCC_X64_ASLDLINK_FLAGS       = DEF(ILGCC_IA32_X64_ASLDLINK_FLAGS) -m elf_x86_64_sol2
++*_ILGCC_X64_ASM_FLAGS            = DEF(ILGCC_ASM_FLAGS) -m64 --64 -melf_x86_64_sol2
++*_ILGCC_X64_CC_FLAGS             = DEF(ILGCC_X64_CC_FLAGS) -nostdinc 
++*_ILGCC_X64_DLINK_FLAGS          = DEF(ILGCC_X64_DLINK_FLAGS)
++*_ILGCC_X64_RC_FLAGS             = DEF(GCC_X64_RC_FLAGS)
++*_ILGCC_X64_OBJCOPY_FLAGS        = 
++*_ILGCC_X64_NASM_FLAGS           = -f elf64
++
+ ####################################################################################
+ #
+ # GCC 4.5 - This configuration is used to compile under Linux to produce
+diff --git a/BaseTools/Source/C/Makefiles/header.makefile b/BaseTools/Source/C/Makefiles/header.makefile
+index 09d2bff..d89f849 100644
+--- a/BaseTools/Source/C/Makefiles/header.makefile
++++ b/BaseTools/Source/C/Makefiles/header.makefile
+@@ -20,6 +20,7 @@ ARCH ?= IA32
+ CYGWIN:=$(findstring CYGWIN, $(shell uname -s))
+ LINUX:=$(findstring Linux, $(shell uname -s))
+ DARWIN:=$(findstring Darwin, $(shell uname -s))
++SUNOS:=$(findstring SunOS, $(shell uname -s))
+ 
+ CC ?= gcc
+ CXX ?= g++
+@@ -66,7 +67,15 @@ ifeq ($(DARWIN),Darwin)
+ endif
+ endif
+ 
+-  
++ifeq ($(ARCH), X64)
++ifeq ($(SUNOS),SunOS)
++  CFLAGS   += -m64
++  CPPFLAGS   += -m64
++  LFLAGS   += -m64
++endif
++endif
++
++
+ .PHONY: all
+ .PHONY: install
+ .PHONY: clean
diff --git a/uefi-edk2/Patches/0002-Fix-build-of-BhyveCsm16.patch b/uefi-edk2/Patches/0002-Fix-build-of-BhyveCsm16.patch
new file mode 100644
index 0000000..fed93ee
--- /dev/null
+++ b/uefi-edk2/Patches/0002-Fix-build-of-BhyveCsm16.patch
@@ -0,0 +1,50 @@
+From 5467ef660b72196164e49141da556400c37348fe Mon Sep 17 00:00:00 2001
+From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
+Date: Fri, 9 Feb 2018 13:08:04 +0000
+Subject: [PATCH 2/3] Fix build of BhyveCsm16.
+
+---
+ BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S | 2 +-
+ BhyvePkg/Csm/BhyveCsm16/GNUmakefile     | 2 +-
+ BhyvePkg/Csm/BhyveCsm16/linker.lds      | 2 +-
+ 3 files changed, 3 insertions(+), 3 deletions(-)
+
+diff --git a/BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S b/BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S
+index cb4e02c..045b691 100644
+--- a/BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S
++++ b/BhyvePkg/Csm/BhyveCsm16/BhyveCsm16Asm.S
+@@ -368,7 +368,7 @@ CsmEntry:
+ 
+         /*  Zero out the 24KB buffer. */
+         push    %di
+-        mov     $(6*(4096/4)), %ecx
++        mov     $6144, %ecx
+         xor     %eax, %eax
+         cld
+         rep stos %eax,(%di)
+diff --git a/BhyvePkg/Csm/BhyveCsm16/GNUmakefile b/BhyvePkg/Csm/BhyveCsm16/GNUmakefile
+index f345730..390e884 100644
+--- a/BhyvePkg/Csm/BhyveCsm16/GNUmakefile
++++ b/BhyvePkg/Csm/BhyveCsm16/GNUmakefile
+@@ -61,7 +61,7 @@ Bin/%.o: %.S
+ 	$(CC) $(ASFLAGS) $(CPPFLAGS) -c -o $@ $<
+ 
+ Bin/BhyveCsm16.bin: linker.lds $(OBJECTS)
+-	$(LD) -Tlinker.lds -m elf_x86_64_fbsd -o Bin/BhyveCsm16.raw.o -Map Bin/BhyveCsm16.bin.map $(OBJECTS)
++	$(LD) -Tlinker.lds -m elf_x86_64_sol2 -o Bin/BhyveCsm16.raw.o -Map Bin/BhyveCsm16.bin.map $(OBJECTS)
+ 	$(OBJCOPY) --only-section .raw --output-target binary --pad-to 0x100000 Bin/BhyveCsm16.raw.o Bin/BhyveCsm16.bin
+ 
+ clean:
+diff --git a/BhyvePkg/Csm/BhyveCsm16/linker.lds b/BhyvePkg/Csm/BhyveCsm16/linker.lds
+index 0662745..a0b23a0 100644
+--- a/BhyvePkg/Csm/BhyveCsm16/linker.lds
++++ b/BhyvePkg/Csm/BhyveCsm16/linker.lds
+@@ -11,7 +11,7 @@
+  * EXPRESS OR IMPLIED.
+  */
+ 
+-OUTPUT_FORMAT("elf64-x86-64")
++OUTPUT_FORMAT("elf64-x86-64-sol2")
+ OUTPUT_ARCH(i386:x86-64)
+ 
+ SECTIONS
diff --git a/uefi-edk2/Patches/0003-Increase-maximum-memory-range-in-bhyve-DSDT-table.patch b/uefi-edk2/Patches/0003-Increase-maximum-memory-range-in-bhyve-DSDT-table.patch
new file mode 100644
index 0000000..ecadc2a
--- /dev/null
+++ b/uefi-edk2/Patches/0003-Increase-maximum-memory-range-in-bhyve-DSDT-table.patch
@@ -0,0 +1,25 @@
+From c1696407cd411d7a6213956f2e5fcbc951897901 Mon Sep 17 00:00:00 2001
+From: Hans Rosenfeld <hans.rosenfeld@joyent.com>
+Date: Fri, 9 Feb 2018 13:08:53 +0000
+Subject: [PATCH 3/3] Increase maximum memory range in bhyve DSDT table.
+
+---
+ BhyvePkg/BhyveAcpiTables/Dsdt.asl | 4 ++--
+ 1 file changed, 2 insertions(+), 2 deletions(-)
+
+diff --git a/BhyvePkg/BhyveAcpiTables/Dsdt.asl b/BhyvePkg/BhyveAcpiTables/Dsdt.asl
+index a180b52..e622619 100644
+--- a/BhyvePkg/BhyveAcpiTables/Dsdt.asl
++++ b/BhyvePkg/BhyveAcpiTables/Dsdt.asl
+@@ -99,9 +99,9 @@ DefinitionBlock ("DSDT.aml", "DSDT", 2, "BHYVE", "BVDSDT", 0x00000001)
+                 QWordMemory (ResourceProducer, PosDecode, MinFixed, MaxFixed, NonCacheable, ReadWrite,
+                     0x0000000000000000, // Granularity
+                     0x000000D000000000, // Range Minimum
+-                    0x000000D0000FFFFF, // Range Maximum
++                    0x000000DFFFFFFFFF, // Range Maximum
+                     0x0000000000000000, // Translation Offset
+-                    0x0000000000100000, // Length
++                    0x0000001000000000, // Length
+                     ,, , AddressRangeMemory, TypeStatic)
+             })
+             Name (PPRT, Package ()
diff --git a/uefi-edk2/README b/uefi-edk2/README
new file mode 100644
index 0000000..7f01056
--- /dev/null
+++ b/uefi-edk2/README
@@ -0,0 +1,2 @@
+This is uefi-edk2 from FreeBSD for bhyve. The upstream for this is the
+bhyve/UDK2014.SP1 branch in git@github.com:freebsd/uefi-edk2.git.
diff --git a/uefi-edk2/uefi-edk2-a36132939e.tar.gz b/uefi-edk2/uefi-edk2-a36132939e.tar.gz
new file mode 100644
index 0000000..67d1d85
Binary files /dev/null and b/uefi-edk2/uefi-edk2-a36132939e.tar.gz differ
-- 
2.21.0

