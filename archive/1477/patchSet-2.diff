From 834daea160b1c0a9f84d6a22adf7c8c7d46dad05 Mon Sep 17 00:00:00 2001
From: Richard Bradley <richard.bradley@joyent.com>
Date: Mon, 13 Feb 2017 17:03:16 +0000
Subject: [PATCH] MANTA-3100 manta-adm reports wrong server for zone that has
 changed servers

---
 lib/adm.js              | 25 ++++++++++++++++++-------
 test/common.js          |  1 +
 test/tst.oneach_exec.js |  1 +
 3 files changed, 20 insertions(+), 7 deletions(-)

diff --git a/lib/adm.js b/lib/adm.js
index 9fa11a8..55ff01d 100644
--- a/lib/adm.js
+++ b/lib/adm.js
@@ -492,7 +492,12 @@ maAdm.prototype.fetchDeployed = function (callback)
 				for (i = 0;
 				    i < self.ma_instances[svcid].length; i++) {
 					instance = self.ma_instances[svcid][i];
-					cns[instance.params.server_uuid] = null;
+					if (self.ma_vms.hasOwnProperty(
+					    instance['uuid'])) {
+						cns[self.ma_vms[
+						    instance['uuid']]
+						    ['server_uuid']] = null;
+					}
 				}
 			}
 
@@ -1365,8 +1370,14 @@ maAdm.prototype.loadInstances = function ()
 		for (i = 0; i < this.ma_instances[svcid].length; i++) {
 			instance = this.ma_instances[svcid][i];
 			metadata = instance['metadata'];
-			server = instance['params']['server_uuid'];
-			gz = this.ma_gzinfo[server];
+			if (this.ma_vms.hasOwnProperty(instance['uuid'])) {
+				server = this.ma_vms[instance['uuid']]
+				    ['server_uuid'];
+				gz = this.ma_gzinfo[server];
+			} else {
+				server = '-';
+				gz = null;
+			}
 			image = this.ma_vms.hasOwnProperty(instance['uuid']) ?
 			    this.ma_vms[instance['uuid']]['image_uuid'] : '-';
 			ip = this.primaryIpForZone(instance['uuid']) || '-';
@@ -1406,7 +1417,8 @@ maAdm.prototype.loadInstances = function ()
 				continue;
 
 			this.ma_config_bycfg[svcid].incr(row);
-			if (!this.ma_config_bycn[svcid].hasOwnProperty(server))
+			if (server != '-' &&
+			    !this.ma_config_bycn[svcid].hasOwnProperty(server))
 				this.ma_config_bycn[svcid][server] =
 				    new svcs.ServiceConfiguration(svckey);
 			this.ma_config_bycn[svcid][server].incr(row);
@@ -2399,7 +2411,7 @@ maAdm.prototype.auditZkServers = function ()
 	 */
 	nforeign = 0;
 	jsprim.forEachKey(instancesById, function (zkid, zkinstance) {
-		var uuid, serverUuid, ip, entry;
+		var uuid, ip, entry;
 
 		uuid = zkinstance.uuid;
 		if (!entriesByNum.hasOwnProperty(zkid)) {
@@ -2409,8 +2421,7 @@ maAdm.prototype.auditZkServers = function ()
 			return;
 		}
 
-		serverUuid = zkinstance.params['server_uuid'];
-		if (self.ma_cns[serverUuid] === null) {
+		if (!self.ma_vms.hasOwnProperty(uuid)) {
 			nforeign++;
 			return;
 		}
diff --git a/test/common.js b/test/common.js
index 6513f8d..6da2f95 100644
--- a/test/common.js
+++ b/test/common.js
@@ -220,6 +220,7 @@ function generateFakeBase(fakeDeployed, azCount) {
 			if (masterAz) {
 				fakeBase['vms'][id] = {
 					'image_uuid': params['imgid'],
+					'server_uuid': params['cnid'],
 					'nics': [ {
 						'primary': true,
 						'ip4addr': '0.0.0.0'
diff --git a/test/tst.oneach_exec.js b/test/tst.oneach_exec.js
index b130b89..4a3c325 100644
--- a/test/tst.oneach_exec.js
+++ b/test/tst.oneach_exec.js
@@ -469,6 +469,7 @@ function setupMockManta(_, callback)
 		    'metadata': { 'SHARD': '1', 'DATACENTER': 'test' }
 		});
 		fakeDeployedTopology.vms[zoneid] = {
+		    'server_uuid': cnid,
 		    'nics': [ {
 			'primary': true,
 			'ip': '10.0.0.' + (i + 1)
-- 
2.21.0

