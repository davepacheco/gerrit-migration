{"project":"joyent/sdc-manta","branch":"master","id":"I91b7671e0d202170ae99a1c2ef2a36d19ac7f7bc","number":"1477","subject":"MANTA-3100 manta-adm reports wrong server for zone that has changed servers Reviewed by: Dave Pacheco \u003cdap@joyent.com\u003e Approved by: Dave Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/1477","commitMessage":"MANTA-3100 manta-adm reports wrong server for zone that has changed servers\nReviewed by: Dave Pacheco \u003cdap@joyent.com\u003e\nApproved by: Dave Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1486652708,"lastUpdated":1487179096,"open":false,"status":"MERGED","comments":[{"timestamp":1486652708,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1486652764,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486752752,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(3 comments)\n\nThanks for fixing this!"},{"timestamp":1487006320,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1487006351,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(3 comments)\n\nThanks for checking this out!"},{"timestamp":1487006361,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487013652,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1487089872,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1487089922,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487090431,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(2 comments)\n\nAs a final round of testing for the zk pieces I\u0027ve performed the following test.\n\n- Delete a nameservice zone from VMAPI\n- Run `manta-adm zk list`, verify the new validation error is listed and that `fixup` will bail\n\nI\u0027ve also included a new test in the tst.zk.js test suite to check for the scenario where a nameservice instance is expected to be local but doesn\u0027t exist, but I\u0027ve had to make some wider modifications to the tests in order to ensure we have the right structure of VMs/instances. I\u0027m not too keen on making changes like this to the test suites, but it does appear to work and `make prepush` looks clean."},{"timestamp":1487092425,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1487148360,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4."},{"timestamp":1487148405,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487167901,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1487171825,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1487174365,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1487174414,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487177201,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nI\u0027m assuming this was \"make prepush\" clean since there are new tests here."},{"timestamp":1487179096,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"5","revision":"91b7671e0d202170ae99a1c2ef2a36d19ac7f7bc","parents":["bfc8c1e32cdbd411215dcd03b9c126e38fb2a67b"],"ref":"refs/changes/77/1477/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1487174365,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487174414,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487177201,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487177201,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1487179096,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":27,"deletions":-5},{"file":"test/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":39,"deletions":-6}],"sizeInsertions":68,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"93ba69aed6308bb677a2876163c1953fe198392b","parents":["8c43d0347e3cc3445e636ede5d5c3f00e52b63b7"],"ref":"refs/changes/77/1477/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1486652708,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486652764,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":1375,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Are we relying on the next line that \"-\" won\u0027t ever be a property that\u0027s present on \"this.ma_gzinfo\"?\n\nCould we make this more explicit with a ternary, like:\n\n    gz \u003d server !\u003d \u0027-\u0027 ? this.ma_gzinfo[server] : null\n\nor maybe wrapping both of these lines into an \"if/else\" based on the result of this.ma_vms.hasOwnProperty()?"},{"file":"lib/adm.js","line":1375,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Yep, you\u0027re correct here. I prefer the readability of the if/else based on an initial check against ma_vms, so I\u0027ll address that in PS2."},{"file":"lib/adm.js","line":1415,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same comment as above."},{"file":"lib/adm.js","line":1415,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Done"},{"file":"lib/adm.js","line":2418,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"If we had a nameservice zone that was destroyed, it wouldn\u0027t be in ma_vms.  Before this change, I think we would have fallen into the case at line 2425 (in the new version), whereas now we\u0027ll just assume it\u0027s foreign and not report a problem.  I\u0027m not sure if this is even possible because I\u0027m not sure if that zone would show up in the list of SAPI instances we got back.  Given that this error is considered non-repairable, which implies it wasn\u0027t that important to deal with, I\u0027m guessing this isn\u0027t possible.\n\nI just want to convince myself that if you had destroyed a nameservice zone then this command would still do the right thing, since that\u0027s the main point of this tool."},{"file":"lib/adm.js","line":2418,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Nicely spotted! I don\u0027t think I\u0027m going to be able to convince you that we\u0027ll do the right thing with this change. In emy-14 I\u0027ve deleted one of my nameservice instances via VMAPI and it still exists as a SAPI instance.\n\nHere\u0027s an example of the output before this change:\n\n```\n[root@headnode (emy-14) ~]# manta-adm zk fixup\nCURRENT CONFIGURATION\n# DATACENTER ZONENAME                             IP                PORT\n1 emy-14     91438b11-2d45-4db1-8c18-f422b939abec 172.27.14.5       2181\n2 emy-14     ed444cc5-d283-426a-a00e-f981e3fedfa7 172.27.14.6       2181\n3 emy-14     bead05d3-da74-4059-af15-9fdd86c78fec 172.27.14.7       2181\nerror: nameservice instance \"bead05d3-da74-4059-af15-9fdd86c78fec\": failed to find instance\u0027s primary IP address\nmanta-adm: bailing out after errors\n```\n\nIn this case if we have any validationErrors then we bail. With my change we report no errors and \"no issues to repair\". When using `manta-adm update` to deprovision a zone then the instance is deleted from SAPI and I can go through the fixup routine, so this only affects the scenario where a zone is destroyed directly in VMAPI.\n\nGiven that the purpose of this tool is to update the manta application\u0027s ZK_SERVERS list at L2255, I wonder if it\u0027s worth keeping the check against params.server_uuid instead of the VM object? This would still be valid when moving a nameserver zone inside the datacenter, but would not work when moved across datacenters."},{"file":"lib/adm.js","line":2418,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\u003e Given that the purpose of this tool is to update the manta application\u0027s ZK_SERVERS list at L2255, I wonder if it\u0027s worth keeping the check against params.server_uuid instead of the VM object? This would still be valid when moving a nameserver zone inside the datacenter, but would not work when moved across datacenters.\n\nI think that\u0027s true, but it also seems to be working a little bit by accident.  What if we just modify what you\u0027ve got right now so that if the VM uuid is not in self.ma_vms, but its params.server_uuid _is_ in ma_cns and is a CN in the current datacenter, then we emit a new validation error (\"VM appears to have been provisioned in this datacenter, but could not be found in VMAPI\")?\n\nI also think it would be reasonable to say that this case is sufficiently strange that it\u0027s beyond the scope of this tool; something else should deal with VMAPI/SAPI inconsistency.  It\u0027s most important that the intended use-cases still work, and it seems like they do."},{"file":"lib/adm.js","line":2418,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I like it, thanks! I\u0027ve addressed this in PS3."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"test/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":12,"sizeDeletions":-5},{"number":"2","revision":"834daea160b1c0a9f84d6a22adf7c8c7d46dad05","parents":["8c43d0347e3cc3445e636ede5d5c3f00e52b63b7"],"ref":"refs/changes/77/1477/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1487006320,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487013652,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487006361,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":18,"deletions":-7},{"file":"test/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":20,"sizeDeletions":-7},{"number":"3","revision":"1665c2f800175ed3e0b2c9a1d6d0bce2d8344e6c","parents":["8c43d0347e3cc3445e636ede5d5c3f00e52b63b7"],"ref":"refs/changes/77/1477/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1487089872,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487092425,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487089922,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/adm.js","line":2428,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The reason for the \"not null\" check here is partially due to match the initial implementation of checking for null, but mostly because the test suite complained at my attempt to use hasOwnProperty (which I think looks cleaner).\n\nIn the tests we actually populate ma_cns, but the objects in that list are null values, so hasOwnProperty actually gets a match."},{"file":"lib/adm.js","line":2428,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This looks good, although it should probably be \"!\u003d\u003d\" (and I\u0027m not sure why javascriptlint wouldn\u0027t have raised an error)."},{"file":"lib/adm.js","line":2428,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Sorry about that one! Fixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":27,"deletions":-5},{"file":"test/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":39,"deletions":-6}],"sizeInsertions":68,"sizeDeletions":-11},{"number":"4","revision":"6e6973b669a8c4535cffa37d1791e4782e10efb4","parents":["8c43d0347e3cc3445e636ede5d5c3f00e52b63b7"],"ref":"refs/changes/77/1477/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1487148360,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487171825,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487171825,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487148405,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":27,"deletions":-5},{"file":"test/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":39,"deletions":-6}],"sizeInsertions":68,"sizeDeletions":-11},{"number":"5","revision":"91b7671e0d202170ae99a1c2ef2a36d19ac7f7bc","parents":["bfc8c1e32cdbd411215dcd03b9c126e38fb2a67b"],"ref":"refs/changes/77/1477/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1487174365,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1487177201,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1487177201,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487174414,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1487179096,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/adm.js","type":"MODIFIED","insertions":27,"deletions":-5},{"file":"test/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.oneach_exec.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/tst.zk.js","type":"MODIFIED","insertions":39,"deletions":-6}],"sizeInsertions":68,"sizeDeletions":-11}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}