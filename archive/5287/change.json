{"project":"joyent/illumos-joyent","branch":"master","id":"Ifbc6cdbe2367492a7eae42ed12751b4cdaeb6b9b","number":"5287","subject":"OS-7163 Update cpuid detection for new EPYC Socket format Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyen","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/5287","commitMessage":"OS-7163 Update cpuid detection for new EPYC Socket format\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1545844815,"lastUpdated":1546532030,"open":false,"status":"MERGED","comments":[{"timestamp":1545844815,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1545855302,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\nThe actual C source changes look reasonable at first glance.  Were you wanting a close review on the actual content of the changes?  If so, what do you recommend for background reading and comparison?"},{"timestamp":1545855416,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)\n\nI looked just in case it wasn\u0027t gibberish to me, but alas it was mostly gibberish.  That being said there is one thing I noticed that looks inconsistent."},{"timestamp":1545855556,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n\u003e The actual C source changes look reasonable at first glance.  Were\n \u003e you wanting a close review on the actual content of the changes? \n \u003e If so, what do you recommend for background reading and comparison?\n\n \u003e The actual C source changes look reasonable at first glance.  Were\n \u003e you wanting a close review on the actual content of the changes? \n \u003e If so, what do you recommend for background reading and comparison?\n\nIf you\u0027d like to, it\u0027s always welcome. To understand these I use a pair of documents for different families:\n\n- The various AMD Processor Revision Guides map the CPUIDs to explicit revisions.\n- The BIOS \u0026 Kernel Developer\u0027s Guide has information on cpuid Fn8000_0001_EBX which has information about the socket."},{"timestamp":1545855944,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1545855951,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1545856139,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review-1\n\n(1 comment)"},{"timestamp":1545856410,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1545857547,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nOkay, that makes a LOT more sense. I was later going to ask about uint32_t, but your compression to a numeric value eliminates that concern."},{"timestamp":1545920757,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1546531650,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1"},{"timestamp":1546531749,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1546532010,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1546532030,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"4","revision":"fbc6cdbe2367492a7eae42ed12751b4cdaeb6b9b","parents":["5b9482b6cf9e173dc4caf21cfcaa6dc3a22bcce4"],"ref":"refs/changes/87/5287/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1546532010,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545857547,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545920757,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1546532030,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","type":"MODIFIED","insertions":141,"deletions":-4},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":67,"deletions":-22}],"sizeInsertions":208,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"08e16d7080b4c43a4c5e18da4ca0d1ea4f36cd1d","parents":["bf324560c009dad2d854312e9e8aaedcea9fef4d"],"ref":"refs/changes/87/5287/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1545844815,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","line":458,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"\"C0\"?"},{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","line":458,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Nice catch, thanks."},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":853,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Holy *#^$ - these have been broken all this time?!?\nOR, how did _X86_SOCKET_MKVAL ever work? Look at it.  I think the order of operations will do the shift first THEN the or, which means you\u0027re OR-ing small numeric constants instead of bitmasks like the old stuff.\n\nPlease inspect this more carefully."},{"file":"usr/src/uts/intel/sys/x86_archext.h","line":853,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"No, it hasn\u0027t been broken all this time. This change was intentional; however. As you noted, the old scheme was OR-ing in a bit value that was a unique bit. However, this wasn\u0027t really consumed as anything other than an opaque number or really exposed outside of the kernel. The scheme of using one bit per processor socket was not scaling and we would have ran out of sockets we could represent in this scheme. As such I changed it to be an explicit value that\u0027s being ORed in so we have a large number of different possible sockets at our disposal."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","type":"MODIFIED","insertions":141,"deletions":-4},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":67,"deletions":-22}],"sizeInsertions":208,"sizeDeletions":-26},{"number":"2","revision":"7279ed9c87565aef57aed466a6c4c773c719f7e4","parents":["bf324560c009dad2d854312e9e8aaedcea9fef4d"],"ref":"refs/changes/87/5287/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1545855944,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545857547,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545920757,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","type":"MODIFIED","insertions":141,"deletions":-4},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":67,"deletions":-22}],"sizeInsertions":208,"sizeDeletions":-26},{"number":"3","revision":"9d43c8abd91881a3a1cd31268f7af5ef17c76d9d","parents":["5b9482b6cf9e173dc4caf21cfcaa6dc3a22bcce4"],"ref":"refs/changes/87/5287/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1546531749,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545857547,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545920757,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","type":"MODIFIED","insertions":141,"deletions":-4},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":67,"deletions":-22}],"sizeInsertions":208,"sizeDeletions":-26},{"number":"4","revision":"fbc6cdbe2367492a7eae42ed12751b4cdaeb6b9b","parents":["5b9482b6cf9e173dc4caf21cfcaa6dc3a22bcce4"],"ref":"refs/changes/87/5287/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1546532010,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1546532030,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1546531650,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545857547,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1545920757,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/os/cpuid_subr.c","type":"MODIFIED","insertions":141,"deletions":-4},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":67,"deletions":-22}],"sizeInsertions":208,"sizeDeletions":-26}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}