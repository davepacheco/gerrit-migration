From 52f57468539f5bf86230b900cf35dc216cec1eb6 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Sun, 18 Mar 2018 08:43:24 -0700
Subject: [PATCH] OS-6742 "vmadm reboot" is not implemented for bhyve

---
 src/vm/node_modules/VM.js | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index 6c0f3463..b7c39f32 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -14431,19 +14431,20 @@ function reset(uuid, log, callback)
 /*
  * This handles rebooting docker=true zones.
  */
-function doDockerReboot(vmobj, options, callback)
+function doStopStartReboot(vmobj, options, callback)
 {
     var log = options.log;
     var tracers_obj;
 
     if (process.env.EXPERIMENTAL_VMJS_TRACING) {
-        tracers_obj = traceUntilCallback('docker-reboot', log, callback);
+        tracers_obj = traceUntilCallback('docker-stopstart-reboot', log,
+            callback);
         callback = tracers_obj.callback;
         log = tracers_obj.log;
     }
 
     log.debug({vmobj_pid: vmobj.pid, timeout: options.timeout},
-        'doDockerReboot');
+        'doStopStartReboot');
 
     if (!options.timeout) {
         options.timeout = 10;
@@ -14680,8 +14681,8 @@ exports.reboot = function (uuid, options, callback)
             // re-add log in case it was changed
             options.log = log;
 
-            if (vmobj.docker) {
-                doDockerReboot(vmobj, options, cb);
+            if (vmobj.docker || vmobj.brand === 'bhyve') {
+                doStopStartReboot(vmobj, options, cb);
             } else {
                 doReboot(vmobj, options, cb);
             }
-- 
2.21.0

