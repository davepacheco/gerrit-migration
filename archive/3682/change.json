{"project":"joyent/illumos-joyent","branch":"master","id":"I4328d0a48dfc91c96c425a121cc858f78e9365d2","number":"3682","subject":"OS-6719 aggr needs support for multiple pseudo rx groups Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.c","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/3682","commitMessage":"OS-6719 aggr needs support for multiple pseudo rx groups\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1521473874,"lastUpdated":1522253819,"open":false,"status":"MERGED","comments":[{"timestamp":1521473874,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1521501822,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1521579828,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(13 comments)\n\nThanks for putting this together. In general, I like the general ideas for kind of getting a direct path from the rings to the next client. Especially because fanout will be happening there as you point out and if RSS is in use, we\u0027ll still be getting basic fanout, just not at a protocol level."},{"timestamp":1521579834,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\nThanks for putting this together. In general, I like the general ideas for kind of getting a direct path from the rings to the next client. Especially because fanout will be happening there as you point out and if RSS is in use, we\u0027ll still be getting basic fanout, just not at a protocol level."},{"timestamp":1521670550,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1521670566,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(13 comments)"},{"timestamp":1521672029,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1521685755,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4."},{"timestamp":1521685799,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1521686117,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5."},{"timestamp":1521686155,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1521704219,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\n(18 comments)\n\nRound 1.  I need to spend more time looking at aggr_grp.c after a full night of sleep."},{"timestamp":1521724969,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 6."},{"timestamp":1521724987,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 5:\n\n(16 comments)"},{"timestamp":1521730804,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1521742887,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 7."},{"timestamp":1521742914,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1522086972,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1522178595,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1522183925,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 7: Code-Review+1\n\n(7 comments)\n\nI don\u0027t know this part of the code very well, but I went through the CR and it looks really good to me. I just had a few nits which may not be worth fixing."},{"timestamp":1522204569,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 8: Patch Set 7 was rebased."},{"timestamp":1522205152,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 9."},{"timestamp":1522205223,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 9:\n\n(6 comments)\n\nI rebased and addressed the comment typos that Jerry found. The code was untouched."},{"timestamp":1522208023,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 9:\n\nTesting notes added to the Jira ticket."},{"timestamp":1522239812,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1522252062,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1522252532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1522253029,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 9: Integration-Approval+1"},{"timestamp":1522253794,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1522253819,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"10","revision":"4328d0a48dfc91c96c425a121cc858f78e9365d2","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/82/3682/10","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1522253794,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522239812,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522252062,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522252532,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522253029,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1522253819,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":267,"deletions":-160},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":68,"deletions":-57},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":784,"sizeDeletions":-337},"patchSets":[{"number":"1","revision":"c7617b68a91bcc48acff878c0242498552b46327","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521473874,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":249,"deletions":-158},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":73,"deletions":-61},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":181,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":66,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":734,"sizeDeletions":-339},{"number":"2","revision":"a67d7254316ade13058e4b868c4b9337f709b16a","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521501822,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1060,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m not sure I completely follow how the new model handles making sure LACP always works. Could you maybe just reply to this and explain it a little bit more. I think it\u0027s because we lie about stopping the default group. In that case, I assume that we\u0027ll still end up dropping traffic to the target mac addresses since there will be nothing on top of it, right?"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1060,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I had to modify this to actually start the underlying HW ring because otherwise we wouldn\u0027t receive traffic on them. The previous implementation relied on the fact that there was just one group and the rings were already started.\n\nTo make sure LACP always works I had to add code to the aggr_pseudo_stop_rx_ring() to make sure it never stops the default group.\n\nAs for the dropping traffic to the primary (I\u0027m assuming you are referring to the primary MAC when you say \"target\") MAC address: that is correct. Until we plump IP on top of the primary client its mci_flent-\u003efe_flags field will have FE_MC_NO_DATAPATH set which will prevent delivery.\n\nAll that said, I definitely arrived at this code by iteration. The primary client is a little different with aggrs than with NICs and I\u0027m not wild about that. There are certainly other approaches we could take that _might_ be better. E.g., when creating an aggr we could just start all the rings at creation and leave them running; aggr\u0027s MAC can decide what is dropped or not. But then if we are debugging a post mortem it might be confusing to see rings running which don\u0027t actually have any _real_ clients on them."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1060,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, I think I understand why you\u0027ve done that. In the future it\u0027d be nice to make sure it\u0027s running even if there aren\u0027t any real clients such that the link is always correctly performing LACP. Because that has confused operators before. Anyways, we should come back to that later."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1060,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Well, to be clear, the HW rings for the default group on the port MAC will always be running (because of my modification to stop_rx_ring(). But the HW rings for non-default groups will start/stop as MAC clients are added to the aggr and reserve the aggr pseudo group sitting above the HW rings."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1073,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be undoing this in the face of failure?"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1073,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I believe so. I modified this to only set the gen when the hwring start is successful."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1088,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess the implicit assumption here is that hardware will never hash traffic to a non-default group, is that right? I think that makes sense because we\u0027re focused on a multicast mac address for LACP traffic."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1088,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yes, from what I can tell all LACP traffic is EhterType 8809 with the multicast addr 1:80:c2:0:0:2 (Slow Protocols Addr). That said, I don\u0027t pretend to know LACP well. But I do know that without this code LACP traffic cannot be received an will enter \"defaulted\" state. With this code it works fine.\n\nI wish this special case wasn\u0027t needed but I couldn\u0027t come up with a better solution given our time constraints."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1444,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Isn\u0027t the MAX macro usually in caps?"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1444,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I thought I was using max(9F). Should I be using the MAX sysmacro instead?"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1444,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So there was a max(9F) function that the DDI tries to hide by making sure it\u0027s a macro instead of the function. However, the gotcha with that is that if we don\u0027t get the macro we\u0027ll end up with doing a signed comparison on values that are unsigned. We\u0027ll probably be safe for the time being."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1444,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I went ahead and changed this to MAX."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1444,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yeah, I\u0027ve seen MAX() everywhere else I can remember"},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","line":82,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Have you verified that we\u0027re no long seeing duplicates? Even if we have no hw resources available?"},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","line":82,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"So, this whole promisc_path thing never really made sense to begin with. I think it was done this way because they used the traditional MAC client API to place the underlying port into promisc mode. This API requires a promisc callback. The problem of duplicate delivery occurrs because mac_rx_common() _always_ delivers to any registered promisc callbacks as well as any HW SRSes or SW SRSes on the MAC. So if you had a port with HW rings and put it into promisc mode anything going over the HW rings would have its traffic delivered to aggr_recv_path_cb() twice: once via the aggr_recv_promisc_cb(), and then again via the aggr_recv_cb(). So they added this hack to prevent duplicate delivery.\n\nThis hack isn\u0027t so horrible in a land where the aggr can only use one group. But this becomes pretty dire once you add multi-group support. Because the moment you turn on promisc all traffic must now travel over the promisc callback. This forces us to deliver all traffic via mac_rx() which means everything gets SW classified in the aggr\u0027s MAC.\n\nTo get around this I added an API (mac_set_promisc()) to put the port into promisc mode without registering a promisc callback. This works because in promisc mode the MAC will deliver all non-HW-classified traffic to the default group. The passthru callback will then send this traffic up to the aggr_recv_path_cb(). The aggr will then forward this onto its own mac_rx()/mac_rx_common(): at which point it will be passed to any promisc cbs registered with the aggr and to any flows registered in the aggr\u0027s mi_flow_tab interested in this traffic.\n\nIn the case of a port which doesn\u0027t implement RINGS capab I added the mac_client_set_flow_cb() API. In this case the mac_rx_common() of the NIC will take the single-active-client path and call mci_flent-\u003efe_cb_fn, which was set to aggr_recv_cb() during port attach."},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","line":82,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Just to be careful, I went ahead and retested the scenario in illumos#2869 which introduced this dup-checking code. I took the following steps:\n\n* created an aggr of igb ports\n* placed 14 VNICs on the aggr to make sure all HW unicast filters were used (and confirmed that igb-\u003eunicst_avail \u003d\u003d 0 via mdb)\n* created a 15th VNIC causing the aggr ports to enter promisc mode (also verified by checking lp_promisc in mdb)\n* used ping -s to send periodic ICMP echo requests from this 15th VNIC\n* used snoop -d aggr0 icmp[0] \u003d 0x0 to watch all ICMP echo replies come in\n* verified that there was only one echo reply per echo request\n\nAnd just to be extra extra sure I used dtrace to verify that aggr_recv_cb() is never called twice from mac_rx_common()."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1559,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably assert that we have the mac perimeter held, right? As that\u0027s required to access the mi_rx_groups and mi_tx_groups. May be useful to add that as a comment here."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1559,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yes, that was just an oversight on my part. ASSERT + comments added."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1768,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why does only sun4v need to call this function? I guess I\u0027m not clear on what the new expected state transitions are here and what they\u0027re expected to be."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1768,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Since I changed the logic of mac_hwring_start() I simply renamed the original mac_hwring_start() to mac_hwring_activate(). This way the sun4v logic stays the same."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1782,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s probably worth putting together some comments that describe when the different pieces are intended to be used."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1782,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I just kept them here to keep sun4v happy. I don\u0027t really have comments to add."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1782,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The reason I was asking was that I wasn\u0027t sure when should I call start, stop, activate, and quiesce at all as a consumer of these APIs."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1782,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, honestly I just added this because I needed them for aggr. I added some block comments that are hopefully somewhat useful."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1928,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be asserting that the perim is held?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1928,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":3980,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Please explain why it fixes this, not just what it fixes."},{"file":"usr/src/uts/common/io/mac/mac.c","line":3980,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":2405,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I understand why this might be a property of an aggr, but is that really true of all exclusive opens? Does exclusively opening a client actually imply that you don\u0027t want those things to occur or is that just true of the exclusive open clients we have today?"},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":2405,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, this isn\u0027t clearly defined. I changed this to just check for the aggr port flag to leave the previous behavior of other exclusive clients (sun4v) as it was."},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":2421,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"It\u0027s not entirely clear why this has been moved into here and why it\u0027s being implicitly done in this non-exclusive case. Could you maybe clarify that a bit more in a reply to this comment? The same is true for the tx side."},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":2421,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"It wasn\u0027t moved here, it was added. We were already doing this for Tx, I simply added the same logic for Rx. Before this change the aggr code was creating an SRS and then calling mac_hwring_setup() to completely bypass that SRS. It makes little sense to create an SRS only to bypass it, especially if I have to debug a crash dump and see an SRS thinking it is used for something when in reality its not used at all.\n\nFurthermore, there was an old opensolaris bug (6880080) to make Rx like Tx and just not create the SRSes for aggrs. I went ahead and did that.\n\nI actually wanted to handle this logic in the mac_datapath_setup() and not even call this function (because its name implies we are doing something with an SRS, but in this case we aren\u0027t) but this caused some other issues (which I forget now) and I ran out of time. So I just did it here like we were already doing for Tx."},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":4097,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I get that they don\u0027t have SRSes, but is the property here that it\u0027s an aggr or something else? I mostly ask because it seems like aggrs are a symptom of some other property off this."},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","line":4097,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yea, I don\u0027t like that generic MAC code is making exceptions explicitly for aggr: it\u0027s too coupled. But I haven\u0027t had the time to think of this in a more general manner."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":249,"deletions":-158},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":73,"deletions":-61},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":183,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":66,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":737,"sizeDeletions":-339},{"number":"3","revision":"6a46503e4e68202b0a4698c03df32b524d984343","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521670550,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/mac/mac.c","line":3988,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"extra d?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":3988,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":3988,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"hyphenate?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":256,"deletions":-159},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":73,"deletions":-61},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":200,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":760,"sizeDeletions":-340},{"number":"4","revision":"f88301a31e3aa454718168eec858f431e2f475c2","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521685755,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":256,"deletions":-159},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":73,"deletions":-61},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":778,"sizeDeletions":-340},{"number":"5","revision":"d31c80a95a6b255535cb28d2aa5ee2a78cc83b57","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521686117,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":402,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"driver"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":402,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":747,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"General nit: I\u0027m less fond of the ASSERT3B() syntax for booleans.  If the assertion fails, it\u0027s clear what the offending value was.  Take it or leave it, but I don\u0027t think the verbosity buys us much for these specifically."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":747,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Good point. I changed all 3B back to plain assert."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1150,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This can send us into the group-cleanup bail out code without ever attempting the tx_group add or initializing grp_added.  That could cause weird things there, maybe?  At the very least, grp_added should be initialized to 0 at the top of the function."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1150,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"The aggr_rem_pseudo_tx_group() uses lp_tx_grp_added to determine if it should remove the group or not. This way it can be called unconditionally. That\u0027s how it was before my modifications and I left it that way.\n\nThe grp_added count should be initialized earlier, at the top of the for loop. It should be set to 0 for each new port because we could fail during Rx group addition and thus have a partial set of Rx groups to remove. See my reply on your next comment for more info."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1243,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This is some rather awkward coupling to the initialization bail-out some 30+ lines away.  I\u0027m not sure there\u0027s a cleaner way to do it, though."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1243,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"So, when we only had one rx pseudo group we had a bit field per port that determined if the rx pseudo group had been added or not: lp_rx_grp_added. This was used by aggr_rem_pseudo_rx_group() to determine if it actually had a group to remove (that way we could unconditionally call the aggr_rem_pseudo_rx_group() function during bail out). If I wanted to keep this functionality for multi-group I would need to create an array per port to store this flag. I.e., each port would have something like boolean_t lp_rx_grp_added[MAX_GROUPS_PER_PORT] (or use a bitset if we want to get cute). Instead, I modified this function to only all aggr_rem_psuedo_rx_group() when we know the group was actually added; and thus the need for the additional state in this function. For all ports added I know that it added the lg_rx_group_count, except for the last one which might have failed partway through adding the rx groups.\n\nIf you think it would be better to go back to the previous method, at the cost of the additional state, I can do that."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1445,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"destined"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1445,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1455,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Could just use MIN() to clamp the value here."},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1455,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Good call. I also added a comment as to why this is needed."},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":601,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":601,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":602,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"s/this port\u0027s/its/"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":602,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","line":60,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: s/send/pass/ since it\u0027s easy to mix up send/recv with rx/tx"},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","line":60,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1545,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps make an explicit reference to MAX_RINGS_PER_GROUP being the expected allocated size here?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1545,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1565,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should the below check just panic on other rtypes?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1565,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I can add that if you think it\u0027s necessary."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1764,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"And success is expected for in-use rings?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1764,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yes, if the ring is already started then we are good."},{"file":"usr/src/uts/common/io/mac/mac.c","line":4003,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/io/mac/mac.c","line":4003,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":4006,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/io/mac/mac.c","line":4006,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":4007,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/common/io/mac/mac.c","line":4007,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Broke this up into two sentences."},{"file":"usr/src/uts/common/io/mac/mac_client.c","line":2443,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"client"},{"file":"usr/src/uts/common/io/mac/mac_client.c","line":2443,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":256,"deletions":-159},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":73,"deletions":-61},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":778,"sizeDeletions":-340},{"number":"6","revision":"6778cbb0ffb432d229d151ed50fba87896e652f3","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/6","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521724969,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1442,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This call should now be removed?"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1442,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yup, rushed the last patch set in before testing. Fixed this and tested the new PI, everything looks good again."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":266,"deletions":-159},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":68,"deletions":-57},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":783,"sizeDeletions":-336},{"number":"7","revision":"e7f0d538d3d231ca79afcc7b18fc5ea3bdf6b4d6","parents":["1a34bceaa14b4cf3a9cf90aa9c4dae5eb003d9d7"],"ref":"refs/changes/82/3682/7","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1521742887,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522086972,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522183925,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522178595,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1189,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"nit: typo (although I know you didn\u0027t touch this comment)"},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","line":1189,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":584,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"nit: typo"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":584,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":621,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"nit: you fixed the the typo on the previous line, but not here :-)"},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","line":621,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1571,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"These two checks can leave grp undefined (although you assert above). I\u0027m surprised lint didn\u0027t complain about this. You should probably just remove the 2nd check."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1571,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I make it a habit to lint all my changes (as it sometimes catches dumb mistakes of mine before testing) and it didn\u0027t say anything about this.\n\nI agree with you but since I\u0027ve already done all my testing I\u0027m going to leave this alone for now."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1753,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"nit: should this say \"by\"?"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1753,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yep, fixed."},{"file":"usr/src/uts/common/io/mac/mac.c","line":1771,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"same question"},{"file":"usr/src/uts/common/io/mac/mac.c","line":1771,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/common/sys/aggr_impl.h","line":87,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"nit: typo"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":266,"deletions":-159},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":68,"deletions":-57},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":783,"sizeDeletions":-336},{"number":"8","revision":"81dd7fcc62d0f55a3c0741f5840eb662c3879af2","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/82/3682/8","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1522204569,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522086972,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522183925,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522178595,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":266,"deletions":-159},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":68,"deletions":-57},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":783,"sizeDeletions":-336},{"number":"9","revision":"b2f840d19054e607eef326334d6d8b743728529c","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/82/3682/9","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1522205152,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522252062,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522253029,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522239812,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522252532,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":267,"deletions":-160},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":68,"deletions":-57},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":784,"sizeDeletions":-337},{"number":"10","revision":"4328d0a48dfc91c96c425a121cc858f78e9365d2","parents":["071af98c75413701db03a96ce2d39b13aadc775f"],"ref":"refs/changes/82/3682/10","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1522253794,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522252062,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522253029,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522239812,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522252532,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1522253819,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/mac/mac.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/io/aggr/aggr_grp.c","type":"MODIFIED","insertions":267,"deletions":-160},{"file":"usr/src/uts/common/io/aggr/aggr_port.c","type":"MODIFIED","insertions":68,"deletions":-57},{"file":"usr/src/uts/common/io/aggr/aggr_recv.c","type":"MODIFIED","insertions":4,"deletions":-23},{"file":"usr/src/uts/common/io/mac/mac.c","type":"MODIFIED","insertions":218,"deletions":-18},{"file":"usr/src/uts/common/io/mac/mac_client.c","type":"MODIFIED","insertions":12,"deletions":-1},{"file":"usr/src/uts/common/io/mac/mac_datapath_setup.c","type":"MODIFIED","insertions":65,"deletions":-35},{"file":"usr/src/uts/common/io/mac/mac_provider.c","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"usr/src/uts/common/io/mac/mac_stat.c","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"usr/src/uts/common/sys/aggr_impl.h","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"usr/src/uts/common/sys/mac_client_priv.h","type":"MODIFIED","insertions":13,"deletions":0},{"file":"usr/src/uts/common/sys/mac_impl.h","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/uts/common/sys/mac_provider.h","type":"MODIFIED","insertions":49,"deletions":-5},{"file":"usr/src/uts/sun4v/io/vnet.c","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":784,"sizeDeletions":-337}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}