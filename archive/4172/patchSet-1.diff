From 41b198d07722d8f3393c5efa5e97928aff0da513 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 8 Jun 2018 20:13:46 +0200
Subject: [PATCH] TRITON-477 `sdcadm create $SVC --image` does not support
 channels

---
 lib/cli/do_create.js | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/lib/cli/do_create.js b/lib/cli/do_create.js
index 17f5736..5fa7065 100644
--- a/lib/cli/do_create.js
+++ b/lib/cli/do_create.js
@@ -73,6 +73,19 @@ Create.prototype.execute = function cExecute(opts, args, cb) {
     };
 
     vasync.pipeline({ arg: context, funcs: [
+        function ensureSdcApp(_, next) {
+            self.sdcadm.ensureSdcApp({}, function (err) {
+                if (err) {
+                    next(err);
+                    return;
+                }
+                // Set or override the default channel if anything is given:
+                if (opts.channel) {
+                    self.sdcadm.updates.channel = opts.channel;
+                }
+                next();
+            });
+        },
         function getLock(_, next) {
             self.sdcadm.acquireLock({progress: self.progress},
                                     function (lockErr, unlock_) {
@@ -277,6 +290,12 @@ do_create.options = [
         type: 'string',
         help: 'UUID of the Image to be used for the instance.'
     },
+    {
+        names: ['channel', 'C'],
+        type: 'string',
+        help: 'Use the given channel to fetch the image, even if it is ' +
+            'not the default one.'
+    },
     {
         // Deprecated in favour of `-s,--servers`
         names: ['server'],
-- 
2.21.0

