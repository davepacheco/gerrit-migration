{"project":"joyent/illumos-joyent","branch":"master","id":"I319f1706dddd0b2e45c61122ee4a33201f63a466","number":"839","subject":"OS-5761 some code is careless about p_lock when accessing u_cdir Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/839","commitMessage":"OS-5761 some code is careless about p_lock when accessing u_cdir\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1478115667,"lastUpdated":1478192988,"open":false,"status":"MERGED","comments":[{"timestamp":1478115667,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1478115908,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1478116705,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nDon\u0027t review this yet, still testing"},{"timestamp":1478118268,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1478118314,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nok, ready for review now"},{"timestamp":1478120710,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1478180091,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1478180111,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\nI made all of the suggested changes."},{"timestamp":1478181352,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1478191569,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1478192970,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1478192988,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"319f1706dddd0b2e45c61122ee4a33201f63a466","parents":["cb5adfa07a7aefc440f5a55351017de82213ea5c"],"ref":"refs/changes/39/839/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1478192970,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478181352,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478191569,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1478192988,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prsubr.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getcwd.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_stat.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/exec/elf/elf_notes.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/lxproc/lxpr_subr.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/vfs.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/os/core.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/os/exec.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/fork.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/syscall/uadmin.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/syscall/umount.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"2c31399a91d0bc4ac566cde140c5e8211788154f","parents":["e2e74e16e5398731f7fcbec3126085ce72c3b236"],"ref":"refs/changes/39/839/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1478115667,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prsubr.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getcwd.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_stat.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/exec/elf/elf_notes.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/lxproc/lxpr_subr.c","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/fs/vfs.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/os/core.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/os/exec.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/os/fork.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/syscall/uadmin.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/syscall/umount.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":42,"sizeDeletions":-4},{"number":"2","revision":"9947738745587bab0438b237a06275b39aa215ec","parents":["e2e74e16e5398731f7fcbec3126085ce72c3b236"],"ref":"refs/changes/39/839/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1478115908,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prsubr.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getcwd.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_stat.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/exec/elf/elf_notes.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/lxproc/lxpr_subr.c","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/uts/common/fs/vfs.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/os/core.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/os/exec.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/os/fork.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/syscall/uadmin.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/syscall/umount.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":42,"sizeDeletions":-4},{"number":"3","revision":"7a1aa17a253a3388ff9cf7a1b53a1d00a0953c1f","parents":["e2e74e16e5398731f7fcbec3126085ce72c3b236"],"ref":"refs/changes/39/839/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1478118268,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/core.c","line":141,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This should probably be moved below the rootvp VN_HOLD."},{"file":"usr/src/uts/common/os/exec.c","line":261,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since most of the other cases use the PTOU macro, perhaps we should swap that in here?"},{"file":"usr/src/uts/common/syscall/umount.c","line":159,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It might be simpler to move the whole test out of the if statement (rdir !\u003d NULL \u0026\u0026 rdir !\u003d rootvp). Use the boolean you\u0027re adding to keep that result and minimize the p_lock complexity."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prsubr.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getcwd.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_stat.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/exec/elf/elf_notes.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/lxproc/lxpr_subr.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/vfs.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/os/core.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/os/exec.c","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/os/fork.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/syscall/uadmin.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/syscall/umount.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":38,"sizeDeletions":-4},{"number":"4","revision":"13d07525f267cfd6c416a6ca914e46b4bad09eda","parents":["cb5adfa07a7aefc440f5a55351017de82213ea5c"],"ref":"refs/changes/39/839/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1478180091,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478181352,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478191569,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prsubr.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getcwd.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_stat.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/exec/elf/elf_notes.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/lxproc/lxpr_subr.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/vfs.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/os/core.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/os/exec.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/fork.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/syscall/uadmin.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/syscall/umount.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-8},{"number":"5","revision":"319f1706dddd0b2e45c61122ee4a33201f63a466","parents":["cb5adfa07a7aefc440f5a55351017de82213ea5c"],"ref":"refs/changes/39/839/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1478192970,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1478192988,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478181352,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478191569,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_brand.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prsubr.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_getcwd.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_stat.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/exec/elf/elf_notes.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/lxproc/lxpr_subr.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/fs/vfs.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/os/core.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/os/exec.c","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"usr/src/uts/common/os/fork.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/syscall/uadmin.c","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"usr/src/uts/common/syscall/umount.c","type":"MODIFIED","insertions":8,"deletions":-3}],"sizeInsertions":36,"sizeDeletions":-8}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}