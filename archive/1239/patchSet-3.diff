commit f99d5b597e919eecbe6272e7c722a6f7d974a12a (refs/changes/39/1239/3)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2017-02-07T18:26:12-08:00 (2 years, 8 months ago)
    
    MANTA-3084 muskie fails to read from HTTP PUT response stream: sadness ensues

diff --git a/lib/obj.js b/lib/obj.js
index 31f38cb..6686ece 100644
--- a/lib/obj.js
+++ b/lib/obj.js
@@ -520,6 +520,17 @@ function sharkStreams(req, res, next) {
                 sharkInfo.result = 'ok';
                 barrier.done(s._shark.manta_storage_id);
             }
+            /*
+             * Even though PUT requests that are successful normally result
+             * in an empty resonse body from nginx, we still need to make sure
+             * we let the response stream emit 'end'. Otherwise this will jam
+             * up keep-alive agent connections (the node http.js needs that
+             * 'end' even to happen before relinquishing the socket).
+             *
+             * Easiest thing to do is just call resume() which should make the
+             * stream run out and emit 'end'.
+             */
+            sres.resume();
         });
     });
 
diff --git a/package.json b/package.json
index 3dc3839..e107380 100644
--- a/package.json
+++ b/package.json
@@ -14,7 +14,7 @@
         "backoff": "2.3.0",
         "bunyan": "0.22.1",
         "bunyan-syslog": "0.2.2",
-        "cueball": "1.3.0",
+        "cueball": "2.1.0",
         "dashdash": "1.3.2",
         "deep-equal": "0.0.0",
         "dtrace-provider": "0.2.8",
@@ -30,7 +30,7 @@
         "mahi": "2.0.1",
         "marlin": "git+ssh://git@github.com:joyent/manta-marlin.git#master",
         "mime": "1.2.11",
-        "moray": "3.0.0",
+        "moray": "git+https://github.com/joyent/node-moray#moray-396",
         "once": "1.3.0",
         "restify": "2.6.3",
         "vasync": "1.4.3",
