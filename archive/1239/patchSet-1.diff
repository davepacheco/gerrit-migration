From 33f79d7df61841b8987ac4a021deb7d26fc3bf61 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 11 Jan 2017 18:17:23 -0800
Subject: [PATCH] MANTA-3084 muskie fails to read from HTTP PUT response
 stream: sadness ensues

---
 lib/obj.js | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/lib/obj.js b/lib/obj.js
index 31f38cb..6686ece 100644
--- a/lib/obj.js
+++ b/lib/obj.js
@@ -520,6 +520,17 @@ function sharkStreams(req, res, next) {
                 sharkInfo.result = 'ok';
                 barrier.done(s._shark.manta_storage_id);
             }
+            /*
+             * Even though PUT requests that are successful normally result
+             * in an empty resonse body from nginx, we still need to make sure
+             * we let the response stream emit 'end'. Otherwise this will jam
+             * up keep-alive agent connections (the node http.js needs that
+             * 'end' even to happen before relinquishing the socket).
+             *
+             * Easiest thing to do is just call resume() which should make the
+             * stream run out and emit 'end'.
+             */
+            sres.resume();
         });
     });
 
-- 
2.21.0

