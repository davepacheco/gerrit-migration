From a3dc23a7f97b64f69d332537f51f3cf1b92fb473 Mon Sep 17 00:00:00 2001
From: Kody A Kantor <kody@kkantor.com>
Date: Mon, 10 Dec 2018 22:40:20 +0000
Subject: [PATCH] OS-6417 "zpool import -m" could print last txg time Reviewed
 by: Jerry Jelinek <jerry.jelinek@joyent.com> Approved by: Jerry Jelinek
 <jerry.jelinek@joyent.com>

---
 usr/src/cmd/zpool/zpool_main.c          |  2 ++
 usr/src/lib/libzfs/common/libzfs_pool.c |  9 ++++++---
 usr/src/uts/common/fs/zfs/spa.c         | 17 +++++++++++++++++
 3 files changed, 25 insertions(+), 3 deletions(-)

diff --git a/usr/src/cmd/zpool/zpool_main.c b/usr/src/cmd/zpool/zpool_main.c
index 01af9604a1..742891a2a4 100644
--- a/usr/src/cmd/zpool/zpool_main.c
+++ b/usr/src/cmd/zpool/zpool_main.c
@@ -2198,6 +2198,8 @@ zpool_do_checkpoint(int argc, char **argv)
  *
  *       -F     Attempt rewind if necessary.
  *
+ *       -m     Allow import with a missing log device.
+ *
  *       -n     See if rewind would work, but don't actually rewind.
  *
  *       -N     Import the pool but don't mount datasets.
diff --git a/usr/src/lib/libzfs/common/libzfs_pool.c b/usr/src/lib/libzfs/common/libzfs_pool.c
index ae23e06184..3d2cb06ac9 100644
--- a/usr/src/lib/libzfs/common/libzfs_pool.c
+++ b/usr/src/lib/libzfs/common/libzfs_pool.c
@@ -22,7 +22,7 @@
 /*
  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
  * Copyright (c) 2011, 2017 by Delphix. All rights reserved.
- * Copyright (c) 2013, Joyent, Inc. All rights reserved.
+ * Copyright (c) 2018, Joyent, Inc. All rights reserved.
  * Copyright 2016 Nexenta Systems, Inc.
  * Copyright 2016 Igor Kozhukhov <ikozhukhov@gmail.com>
  * Copyright (c) 2017 Datto Inc.
@@ -1857,6 +1857,8 @@ zpool_import_props(libzfs_handle_t *hdl, nvlist_t *config, const char *newname,
 				    "corrupted, use '-m' to import the pool "
 				    "anyway:\n"));
 				print_vdev_tree(hdl, NULL, missing, 2);
+				zpool_rewind_exclaim(hdl, newname ? origname :
+				    thename, B_TRUE, nv);
 				(void) printf("\n");
 			}
 			(void) zpool_standard_error(hdl, error, desc);
@@ -1890,8 +1892,9 @@ zpool_import_props(libzfs_handle_t *hdl, nvlist_t *config, const char *newname,
 			ret = -1;
 		else if (zhp != NULL)
 			zpool_close(zhp);
-		if (policy.zlp_rewind &
-		    (ZPOOL_DO_REWIND | ZPOOL_TRY_REWIND)) {
+		if ((policy.zlp_rewind &
+		    (ZPOOL_DO_REWIND | ZPOOL_TRY_REWIND)) ||
+		    (flags & ZFS_IMPORT_MISSING_LOG)) {
 			zpool_rewind_exclaim(hdl, newname ? origname : thename,
 			    ((policy.zlp_rewind & ZPOOL_TRY_REWIND) != 0), nv);
 		}
diff --git a/usr/src/uts/common/fs/zfs/spa.c b/usr/src/uts/common/fs/zfs/spa.c
index 2b19f71d36..dcfaf2902a 100644
--- a/usr/src/uts/common/fs/zfs/spa.c
+++ b/usr/src/uts/common/fs/zfs/spa.c
@@ -1825,6 +1825,12 @@ spa_check_for_missing_logs(spa_t *spa)
 		if (idx > 0) {
 			spa_load_failed(spa, "some log devices are missing");
 			vdev_dbgmsg_print_tree(rvd, 2);
+
+			/* Save the timestamp of the last completed txg. */
+			VERIFY(nvlist_add_uint64(spa->spa_load_info,
+			    ZPOOL_CONFIG_LOAD_TIME,
+			    spa->spa_last_ubsync_txg_ts) == 0);
+
 			return (SET_ERROR(ENXIO));
 		}
 	} else {
@@ -1833,10 +1839,21 @@ spa_check_for_missing_logs(spa_t *spa)
 
 			if (tvd->vdev_islog &&
 			    tvd->vdev_state == VDEV_STATE_CANT_OPEN) {
+				nvlist_t *rewind_info = fnvlist_alloc();
+
 				spa_set_log_state(spa, SPA_LOG_CLEAR);
 				spa_load_note(spa, "some log devices are "
 				    "missing, ZIL is dropped.");
 				vdev_dbgmsg_print_tree(rvd, 2);
+
+				VERIFY(nvlist_add_uint64(rewind_info,
+				    ZPOOL_CONFIG_LOAD_TIME,
+				    spa->spa_uberblock.ub_timestamp) == 0);
+
+				VERIFY(nvlist_add_nvlist(spa->spa_load_info,
+				    ZPOOL_CONFIG_REWIND_INFO,
+				    rewind_info) == 0);
+
 				break;
 			}
 		}
-- 
2.21.0

