{"project":"joyent/illumos-joyent","branch":"master","id":"Ia3dc23a7f97b64f69d332537f51f3cf1b92fb473","number":"5173","subject":"OS-6417 \"zpool import -m\" could print last txg time Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/5173","commitMessage":"OS-6417 \"zpool import -m\" could print last txg time\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1543861989,"lastUpdated":1544481985,"open":false,"status":"MERGED","comments":[{"timestamp":1543861989,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1543862040,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1544113015,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1544118517,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1544132216,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1\n\nThanks for the clarification. Based on this, I think your changes look good."},{"timestamp":1544481439,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1544481595,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1544481738,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1544481985,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"3","revision":"a3dc23a7f97b64f69d332537f51f3cf1b92fb473","parents":["b1cf180263bead3ec5a4bbdda602d5371c2405d6"],"ref":"refs/changes/73/5173/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1544481738,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544132216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544481439,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1544481985,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/zpool/zpool_main.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/libzfs/common/libzfs_pool.c","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/spa.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":25,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"fe48998062eb2c2a157c01e232a3a37ba28f65fa","parents":["cc78e0e8a9ef1c3c42ba267e1850ca73fa4e0395"],"ref":"refs/changes/73/5173/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1543861989,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544132216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544481439,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/cmd/zpool/zpool_main.c","line":2201,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Not sure why this was missing. The mixed spaces and tabs in this block comment is frustrating."},{"file":"usr/src/uts/common/fs/zfs/spa.c","line":1832,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027m confused by this change. It appears that all current usage of ZPOOL_CONFIG_LOAD_TIME is expected to be on a ZPOOL_CONFIG_REWIND_INFO nvlist that resides in the ZPOOL_CONFIG_LOAD_INFO nvlist, so I don\u0027t understand what putting the load time into the top-level nvlist will do.\n\nThe change below appears to have the ZPOOL_CONFIG_LOAD_TIME on the correct nvlist."},{"file":"usr/src/uts/common/fs/zfs/spa.c","line":1832,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yes! This took me a long time to understand.\n\nI made the kernel behavior a little more complex so that the userspace code would not have to change. I\u0027ll explain what I mean here.\n\nThere are a couple different code paths at work here that modify the nvlist structure in different ways.\n\nIn the case that the zpool imports unsuccessfully due to a (required) missing log device, ZFS will try importing a number of times, each time using older uberblocks. The first time it tries importing the pool (and fails) it will \u0027save\u0027 the spa_load_info structure from the failure (which is what we populate here). On the last subsequent load attempt the spa-\u003espa_load_info is saved off, and then replaced by the initial (first failed) spa_load_info nvlist. The last load attempt\u0027s spa_load_info is then added back as ZPOOL_CONFIG_REWIND_INFO to spa-\u003espa_load_info.\n\nSo in this error case (\u0027zpool import mypool\u0027 fails due to missing log), spa_load_best will do the work of adding this nvlist as ZPOOL_CONFIG_REWIND_INFO for us. This is done here:\nhttps://github.com/joyent/illumos-joyent/blob/693cf0515372e6ad7fd1a58eaa9fc7d5ad4823cb/usr/src/uts/common/fs/zfs/spa.c#L3968-L3974\nand here:\nhttps://github.com/joyent/illumos-joyent/blob/693cf0515372e6ad7fd1a58eaa9fc7d5ad4823cb/usr/src/uts/common/fs/zfs/spa.c#L4005-L4011\n\nThis is saved in the ZPOOL_CONFIG_LOAD_INFO nvlist by spa_import here:\nhttps://github.com/joyent/illumos-joyent/blob/693cf0515372e6ad7fd1a58eaa9fc7d5ad4823cb/usr/src/uts/common/fs/zfs/spa.c#L5106-L5111\n\nThe other case is that the user is forcing the import of the pool with a missing log. In that case spa_load_best will _not_ do the dance of swapping spa_load_info. Instead my suggested change below makes sure that the nvlists are set up properly so no further nvlist dancing is required.\n\nIf you think there\u0027s another way we should be doing this, I\u0027m all ears. We could also change the userspace behavior, but I don\u0027t think there\u0027s anything wrong with the way userspace handles this."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zpool/zpool_main.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/libzfs/common/libzfs_pool.c","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/spa.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":25,"sizeDeletions":-3},{"number":"2","revision":"aa90224195f89548db0c2d214ed24d6b6c79b7a7","parents":["b1cf180263bead3ec5a4bbdda602d5371c2405d6"],"ref":"refs/changes/73/5173/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1544481595,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544132216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544481439,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zpool/zpool_main.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/libzfs/common/libzfs_pool.c","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/spa.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":25,"sizeDeletions":-3},{"number":"3","revision":"a3dc23a7f97b64f69d332537f51f3cf1b92fb473","parents":["b1cf180263bead3ec5a4bbdda602d5371c2405d6"],"ref":"refs/changes/73/5173/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1544481738,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544132216,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544481439,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1544481985,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/cmd/zpool/zpool_main.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/lib/libzfs/common/libzfs_pool.c","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"usr/src/uts/common/fs/zfs/spa.c","type":"MODIFIED","insertions":17,"deletions":0}],"sizeInsertions":25,"sizeDeletions":-3}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}