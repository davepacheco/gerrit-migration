From b2d9da2a3fcd521b9adebcedd13ed81fa5af5c3d Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Fri, 1 Feb 2019 17:12:26 +0000
Subject: [PATCH] TRITON-614 sdc-fwapi test suite should account for alternate
 admin nictags

---
 package.json                   |  1 +
 test/bin/gen-multi-test-config |  2 +-
 test/config.json.in            |  2 +-
 test/lib/client.js             |  8 ++++----
 test/lib/cn.js                 | 16 +++++++++-------
 test/lib/config.js             |  2 +-
 6 files changed, 17 insertions(+), 14 deletions(-)

diff --git a/package.json b/package.json
index 98f696c..d17c33b 100644
--- a/package.json
+++ b/package.json
@@ -31,6 +31,7 @@
     "restify": "4.3.0",
     "restify-warden": "0.2.0",
     "trace-event": "1.3.0",
+    "triton-netconfig": "1.3.0",
     "vasync": "1.6.4",
     "verror": "1.9.0",
     "xtend": "4.0"
diff --git a/test/bin/gen-multi-test-config b/test/bin/gen-multi-test-config
index 064a8f9..1988416 100755
--- a/test/bin/gen-multi-test-config
+++ b/test/bin/gen-multi-test-config
@@ -72,7 +72,7 @@ sed -e "s,{{PROVISION_IMAGE}},${image_uuid}," \
     -e "s,{{SERVER1_UUID}},${servers[0]}," \
     -e "s,{{SERVER2_UUID}},${servers[1]}," \
     -e "s,{{FWAPI_URL}},${vmapi_url//vmapi/fwapi}," \
-    -e "s,{{NAPI_URL}},${vmapi_url//vmapi/napi}," \
+    -e "s,{{CNAPI_URL}},${vmapi_url//vmapi/cnapi}," \
     -e "s,{{VMAPI_URL}},${vmapi_url}," \
     -e "s,{{WFAPI_URL}},${vmapi_url//vmapi/wfapi}," \
     ${json_in_file} > ${json_file}
diff --git a/test/config.json.in b/test/config.json.in
index a1e5b66..7f629c8 100644
--- a/test/config.json.in
+++ b/test/config.json.in
@@ -3,8 +3,8 @@
     "firewaller_check_timeout": 5000,
     "firewaller_check_interval": 1000,
     "billing_id": "{{BILLING_ID}}",
+    "cnapi_url": "{{CNAPI_URL}}",
     "fwapi_url": "{{FWAPI_URL}}",
-    "napi_url": "{{NAPI_URL}}",
     "owner_uuid": "4917d426-2097-42f7-9303-b1968cd7bb3e",
     "provision_image": "{{PROVISION_IMAGE}}",
     "provision_timeout": 600000,
diff --git a/test/lib/client.js b/test/lib/client.js
index 9454f65..23458a3 100644
--- a/test/lib/client.js
+++ b/test/lib/client.js
@@ -16,8 +16,8 @@
 
 var config = require('./config');
 var RestifyClient = require('sdc-clients/lib/restifyclient');
+var CNAPI = require('sdc-clients/lib/cnapi');
 var FWAPI = require('sdc-clients/lib/fwapi');
-var NAPI = require('sdc-clients/lib/napi');
 var VMAPI = require('sdc-clients/lib/vmapi');
 
 
@@ -40,12 +40,12 @@ var CLIENTS = {};
 function getClient(type) {
     if (!CLIENTS[type]) {
         switch (type) {
+        case 'cnapi':
+            CLIENTS.cnapi = new CNAPI(config.cnapi);
+            break;
         case 'fwapi':
             CLIENTS.fwapi = new FWAPI(config.fwapi);
             break;
-        case 'napi':
-            CLIENTS.napi = new NAPI(config.napi);
-            break;
         case 'vmapi':
             CLIENTS.vmapi = new VMAPI(config.vmapi);
             break;
diff --git a/test/lib/cn.js b/test/lib/cn.js
index edf7df2..6d461f2 100644
--- a/test/lib/cn.js
+++ b/test/lib/cn.js
@@ -24,6 +24,7 @@ var fmt = require('util').format;
 var mod_client = require('./client');
 var mod_jsprim = require('jsprim');
 var mod_log = require('./log');
+var netconfig = require('triton-netconfig');
 var restify = require('restify');
 var vasync = require('vasync');
 var VError = require('verror').VError;
@@ -166,16 +167,17 @@ function getAdminIP(t, uuid, callback) {
         return;
     }
 
-    var napi = mod_client.get('napi');
-    napi.listNics({ nic_tags_provided: 'admin', belongs_to_uuid: uuid },
-        function (err, nics) {
-        if (ifErr(t, err, 'listNics for CN ' + uuid)) {
+    var cnapi = mod_client.get('cnapi');
+    cnapi.getServer(uuid, function (err, server) {
+        if (ifErr(t, err, 'get sysinfo for CN' + uuid)) {
             return callback(err);
         }
 
-        t.equal(nics.length, 1, '1 admin nic found for CN ' + uuid);
-        ADMIN_IPS[uuid] = nics[0].ip;
-        return callback(null, nics[0].ip);
+        var admin_ip = netconfig.adminIpFromSysinfo(server.sysinfo);
+        t.ok(admin_ip, 'admin IP for CN ' + uuid);
+        ADMIN_IPS[uuid] = admin_ip;
+
+        return callback(null, admin_ip);
     });
 }
 
diff --git a/test/lib/config.js b/test/lib/config.js
index 93857d0..c4edb9d 100644
--- a/test/lib/config.js
+++ b/test/lib/config.js
@@ -49,8 +49,8 @@ function apiConfig(apiName) {
 // --- Exports
 
 
+config.cnapi = apiConfig('cnapi');
 config.fwapi = apiConfig('fwapi');
-config.napi = apiConfig('napi');
 config.vmapi = apiConfig('vmapi');
 config.wfapi = apiConfig('wfapi');
 
-- 
2.21.0

