From b368205178c97f4dae97b3b8fc208793374ef170 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Thu, 11 Jan 2018 18:50:29 +0100
Subject: [PATCH] TOOLS-1972 'sdcadm avail' crashes when there are not
 available updates

---
 lib/cli/do_avail.js | 26 ++++++++++++--------------
 1 file changed, 12 insertions(+), 14 deletions(-)

diff --git a/lib/cli/do_avail.js b/lib/cli/do_avail.js
index cf6a528..6c8b476 100644
--- a/lib/cli/do_avail.js
+++ b/lib/cli/do_avail.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -102,7 +102,8 @@ Available.prototype.execute = function cExecute(opts, args, cb) {
         }
     ]}, function availCb(err) {
         if (err) {
-            return cb(err);
+            cb(err);
+            return;
         }
 
         var rows = [];
@@ -169,25 +170,22 @@ Available.prototype.execute = function cExecute(opts, args, cb) {
                     process.stdout.write(JSON.stringify(k) + '\n');
                 });
             }
-            return cb();
+            cb();
+            return;
         }
 
-        var validFieldsMap = {};
-
-        rows.forEach(function (v) {
-            var k;
-            for (k in v) {
-                validFieldsMap[k] = true;
-            }
-        });
+        if (!rows.length) {
+            console.log('Up-to-date.');
+            cb();
+            return;
+        }
 
         tabula(rows, {
             skipHeader: opts.H,
             columns: columns,
-            sort: sort,
-            validFields: Object.keys(validFieldsMap)
+            sort: sort
         });
-        return cb();
+        cb();
     });
 };
 
-- 
2.21.0

