From d64bdae45f9ec1af227f94ab486119027702935c Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 17 Nov 2017 17:00:39 +0100
Subject: [PATCH] SAPI-283 sapi multi-DC master mode is undocumented

---
 docs/index.md | 81 +++++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 81 insertions(+)

diff --git a/docs/index.md b/docs/index.md
index 57f3d7c..e2ee1bd 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -648,6 +648,35 @@ instance.
     }'
 
 
+## AdoptInstance (POST /instances)
+
+Existing instances can be added to SAPI by adding `"exists": true` to the
+payload given to [CreateInstance](#CreateInstance). On this case, the `uuid`
+of the instance to be adopted is *mandatory*, not optional.
+
+When SAPI isn't in [Proto Mode](#proto-mode), the existence of the provided
+instance `uuid` will be verified through `VMAPI`. In case the instance cannot
+be found, an `Invalid Argument` error will be returned (`409` Status Code).
+
+### Inputs
+
+See [CreateInstance](#CreateInstance) above.
+
+### Responses
+
+See [CreateInstance](#CreateInstance) above.
+
+### Example
+
+    POST /instances -d '{
+      "name": "papi",
+      "service_uuid": "161f70c5-e18c-448e-bb33-a04142bfe5ea",
+      "params" {
+        "alias": "papi2"
+      },
+      "exists": true
+    }'
+
 
 ## ListInstances (GET /instances)
 
@@ -1066,6 +1095,58 @@ Deletes an history item.
 | ---- | -------------------------- | -------- |
 | 204  | History record was deleted | none     |
 
+
+# Multi DC mode
+
+SAPI supports a cross-DC configuration mode (that is used for Manta).
+In this mode, there are typically three DCs with three separate Triton
+deployments with UFDS linked together.
+There are also cross-DC routes for the admin network, which enables
+cross-DC DNS to be setup.
+
+But there's only one "manta" application, and Manta-related deployment
+operations need to be operating on that one "manta" application instance.
+
+The steps needed to set this up are:
+
+- Set up a multi-DC Triton deployment (with linked UFDS)
+  inside a single region.
+- Pick one of the DCs within the region to be the SAPI master. (The same
+  one than hosts the UFDS master if any, otherwise any of them)
+- Ensure cross-DC "admin" network routes are available, at least among the
+  SAPI zones and the Moray zones in the master's DC.
+- Ensure that cross-DC nameservices are working. This should happen
+  automatically with UFDS replication and routes set up.
+- In the two non-master DCs, update the SAPI service's metadata so that
+  `MASTER_MORAY_IP` refers to the DNS domain of the Moray instance in the
+  master DC, and `MASTER_MORAY_PORT` should likely be `2020`.
+
+        sapi_svc=$(sdc-sapi /services?name=sapi | json -Ha uuid)
+        sapiadm update $sapi_svc metadata.MASTER_MORAY_IP=moray.<primary-datacenter>.<datacenter domain suffix>
+        sapiadm update $sapi_svc metadata.MASTER_MORAY_PORT=2020
+
+  Note that originally `MASTER_MORAY_IP` was intended to be an IP but
+  now it's recommended to use DNS names in order to prevent possible errors
+  in case the IP address of the SAPI master changes. (Either way, IP
+  addresses are still supported for backwards compatibility reasons).
+- After that, you can proceed with the "manta-init" phases of Manta setup.
+
+Client `GET` requests to [List Applications](#ListApplications),
+[List Instances](#ListInstances), [List Manifests](#ListManifests) and
+[List Services](#ListServices) can specify `include_master=true`, in which case
+SAPI will fetch data from its master's moray and will include both, local and
+master data into the response.
+
+Client `POST` request to [Create Application](#CreateApplication),
+[Create Instance](#CreateInstance), [Create Manifest](#CreateManifest) and
+[Create Services](#CreateService) can specify `master=true`, in which case
+SAPI will store the data into its master's moray.
+
+Finally, any `DELETE` request made for any of these end-points will always
+try to delete the records from the local moray storage and, in case it's not
+found there, will attempt the deletion from its master's moray.
+
+
 # API Versions
 
 ## 1.0.0
-- 
2.21.0

