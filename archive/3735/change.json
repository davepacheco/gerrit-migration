{"project":"joyent/manatee","branch":"master","id":"I58d2c51af324f21d08e27bfb723554924bc152d9","number":"3735","subject":"MANATEE-307 manatee-snapshotter failing on snapshot with dependent clones MANATEE-332 manatee-snapshotter fails spuriously during rebuild Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e Approved by:","owner":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"url":"https://cr.joyent.us/3735","commitMessage":"MANATEE-307 manatee-snapshotter failing on snapshot with dependent clones\nMANATEE-332 manatee-snapshotter fails spuriously during rebuild\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\nApproved by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\n","createdOn":1522269368,"lastUpdated":1530825667,"open":false,"status":"MERGED","comments":[{"timestamp":1522269368,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 1."},{"timestamp":1522269427,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1522272646,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1522273209,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522453860,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 2."},{"timestamp":1522453886,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1522454657,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 3."},{"timestamp":1522454688,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1523556971,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1525128472,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 4."},{"timestamp":1525128503,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1525812415,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(8 comments)"},{"timestamp":1525826910,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 5."},{"timestamp":1525826943,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526035322,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1527640880,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1527642373,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 6."},{"timestamp":1527642405,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527644573,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 7."},{"timestamp":1527644606,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527682696,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1527699434,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7:\n\n(2 comments)"},{"timestamp":1528414612,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 8."},{"timestamp":1528482490,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1529439892,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1530656343,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 9: Patch Set 8 was rebased."},{"timestamp":1530656375,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9:\n\n\"make check\" passed ok"},{"timestamp":1530713030,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 9: Code-Review+1 Integration-Approval+1\n\nTesting notes LGTM, thanks!"},{"timestamp":1530825102,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 10: Commit message was updated."},{"timestamp":1530825667,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Brittany Wald"}],"currentPatchSet":{"number":"10","revision":"58d2c51af324f21d08e27bfb723554924bc152d9","parents":["f5adc5e98d3531185dc5c1d5b6cc8262482701d2"],"ref":"refs/changes/35/3735/10","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1530825102,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528482490,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529439892,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530713030,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530713030,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1530825667,"by":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":151,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":184,"sizeDeletions":-40},"patchSets":[{"number":"1","revision":"1a465c8e8cc8cd8ef65625385b29d097eb3b150c","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/1","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1522269368,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522269427,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/snapShotter.js","line":248,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"maybe just \"failureOffset represents ...\" (I got confused about which variable was referenced here)."},{"file":"lib/snapShotter.js","line":271,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"if I\u0027m reading this correctly, we end up double-incrementing here ?\n\ndelIndex \u003d i + failureOffset ... \n\nfor failures where we \"aren\u0027t done\" we increment *both* i and failureOffset ? doesn\u0027t that skip an element without considering it ?"},{"file":"lib/snapShotter.js","line":271,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Great catch, thank you!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":24,"sizeDeletions":-7},{"number":"2","revision":"8ba7b7375e638aa7c891975ba24ab71c5efccfc5","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/2","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1522453860,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1522453886,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/snapShotter.js","line":278,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":66,"deletions":-14},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":70,"sizeDeletions":-18},{"number":"3","revision":"b6e8ab81fcd47893e09905ce69873167bb349960","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/3","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1522454657,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522454688,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/snapShotter.js","line":8,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We should make this reflect the eng.git guideline:\n\n    Copyright (c) 2018, Joyent, Inc."},{"file":"lib/snapShotter.js","line":241,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think it would be a lot clearer to invert this conditional and turn this into an early return; i.e.,\n\n    if (snapshots.length \u003c self._snapshotNumber) {\n        setImmediate(cb);\n        return;\n    }\n    ...\n    log.info(...\n\nThat way we can remove an entire level of indentation and the\n\n    } else {\n        return cb();\n    }\n\nwhich is quite a long way visually from where this decision ends up being made."},{"file":"lib/snapShotter.js","line":288,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would remove the dates from the comments -- they should stand alone in this revision of the software, and archaeology can be performed in the git history and bug tracker."},{"file":"lib/snapShotter.js","line":291,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This is likely not going to work as you might expect, at least under some conditions.\n\nAs the program cycles through each iteration of the \"for\" loop (L260) the value of \"i\" is incremented, and in the body of the loop the call to \"self._deleteSnapshot()\" is made (L266).  One of the arguments, the callback function  (L267), is created with a closure reference to \"i\", but that callback is not _called_ until the \"_deleteSnapshot()\" operation completes its async operation some time later.\n\nAfter the return of \"_deleteSnapshot()\", we move to the next cycle of the \"for\" loop and increment \"i\".  By the time _any_ \"_deleteSnapshot\" operation calls its callback, \"i\" will always have been set to the loop terminal condition; i.e., one more than \"excessSnapshots\".\n\nBecause of the way closures work in Javascript, there is really only one \"i\", even though we\u0027ve created many closure functions.  The value of \"i\" is read lazily, at callback execution time, rather than at closure creation time.\n\nThe reason the \"loopfunc\" warning exists (it is unfortunately gagged on line 265) is to avoid problems like this one."},{"file":"lib/snapShotter.js","line":298,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Because we\u0027re not returning a value from this function, it\u0027d be better to phase this on two lines; i.e.,\n\n    cb(err);\n    return;\n\nThis should make it clearer to the reader, and to any future static analysis tools, that we\u0027re not returning a value from this function."},{"file":"lib/snapShotter.js","line":369,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As per above on dates in comments."},{"file":"smf/snapshotter.xml","line":10,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"2018!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":66,"deletions":-14},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":70,"sizeDeletions":-18},{"number":"4","revision":"ede64cda4032bb909727158f41c7c543875abb9f","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/4","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1525128472,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525128503,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":269,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I believe this should just be \"ZK_IPS\" (i.e., no \"$\").  Same with \"$SHARD\" above."},{"file":"README.md","line":273,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would redirect stdout and stderr here; i.e.,\n\n    # pfexec node ... 2\u003e\u00261 | bunyan\n                      ^^^^"},{"file":"README.md","line":276,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would probably ditch the \"pfexec\" business, and make the command the same as the commands above for the sitter and the backupserver.\n\nThen, I\u0027d add a clarifying note to the opening paragraph of this section that all of these commands are designed to be run as the \"root\" user.  That\u0027s what the \"#\" in the shell prompt is intended to signify, as opposed to the usual \"$\" for an unprivileged user."},{"file":"lib/snapShotter.js","line":264,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"The property names in this object (\"inputs\" and \"func\") don\u0027t need to be quoted."},{"file":"lib/snapShotter.js","line":271,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this condition should probably be \"\u003e\u003d\" for safety."},{"file":"lib/snapShotter.js","line":312,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It looks like we\u0027re going to increment the delete count whether or not we were able to delete a snapshot.  Should we be calling  \"next();\" and returning at the end of the \"if (err) {\" block above?"},{"file":"lib/snapShotter.js","line":319,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Rather than emitting this error, should we instead be calling \"cb(err);\"?  If we don\u0027t call it, I don\u0027t think execution will resume on L324, and I think that means the setTimeout() won\u0027t be called to schedule the next poll operation?"},{"file":"lib/snapShotter.js","line":356,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think we should use setInterval() with the cleanup function.  The setInterval() routine will schedule \"cleanup\" to run every N milliseconds whether or not the previous asynchronous run has completed or not.  If a particular cleanup run takes longer than the polling interval, they will begin to overlap -- which could be disastrous.\n\nOnce the first cleanup run has completed, the setTimeout() on L347 will schedule the next poll operation."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":25,"deletions":-2},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":106,"deletions":-32},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":136,"sizeDeletions":-39},{"number":"5","revision":"ce7654fa1b2b5db621d3f9fe48b9a005a592b60a","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/5","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1525826910,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1525826943,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"README.md","line":267,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Do these environment variables need to be set to run the snapshotter?"},{"file":"README.md","line":267,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"No, they need to be set to have a clean `make prepush`.  I can make that clearer."},{"file":"lib/snapShotter.js","line":257,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is there any way we could end up with a negative value here? Perhaps with a dodgy configuration value?\n\nI don\u0027t think there is, but perhaps an assertion to prove that we have a positive, non-zero value might help at least for future comprehension."},{"file":"lib/snapShotter.js","line":328,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I don\u0027t think we can ever hit this error condition because we catch the error in the callback for _deleteSnapshot and never pass it to `next()`.\n\nDo we want to exit with an error if the condition at L303 is true?"},{"file":"lib/snapShotter.js","line":328,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Thank you!  I don\u0027t think we want to exit (kill the process) at that point -- just raise an alarm, which should now be rarer."},{"file":"lib/snapShotter.js","line":330,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"If no snapshots get deleted because of failures, is this message true?"},{"file":"lib/snapShotter.js","line":330,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Good point! I\u0027ll reword."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":25,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":111,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":141,"sizeDeletions":-40},{"number":"6","revision":"9b441b728423b4d47616c3f6e9f8092d9f9c7fb1","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/6","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1527642373,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527642405,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":118,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":151,"sizeDeletions":-40},{"number":"7","revision":"6ed99758a36b95f44ebc5c501a37f2d352a3ca2b","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/7","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1527644573,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527644606,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527682696,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"comments":[{"file":"lib/snapShotter.js","line":340,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"You need to call \"cb();\" here, so that the outer pipeline step function completes and advances the pipeline.  Otherwise I don\u0027t believe we will reach \"onSnapshotterCleanupEnd()\" when there are no errors."},{"file":"lib/snapShotter.js","line":370,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This should happen in \"onSnapshotterCleanupEnd()\" above, so that the next cleanup operation is not scheduled until the currently executing cleanup operation has completed.  I would probably make it the first thing that happens in that function, even before we check \"err\".\n\nAs it stands, if the poll interval is short and the cleanup process takes too longer, you\u0027ll start to have overlapping executions."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":121,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":154,"sizeDeletions":-40},{"number":"8","revision":"9e26a312feddce5c14f8436028e1e53d51100a1e","parents":["75f395df8510bfad2da779edcedeb5a1ec3ab63f"],"ref":"refs/changes/35/3735/8","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1528414612,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529439892,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528482490,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":151,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":184,"sizeDeletions":-40},{"number":"9","revision":"24ed4523ca44229b2f9f0b4dc3338d4fd3adc64a","parents":["f5adc5e98d3531185dc5c1d5b6cc8262482701d2"],"ref":"refs/changes/35/3735/9","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1530656343,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529439892,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528482490,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530713030,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530713030,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":151,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":184,"sizeDeletions":-40},{"number":"10","revision":"58d2c51af324f21d08e27bfb723554924bc152d9","parents":["f5adc5e98d3531185dc5c1d5b6cc8262482701d2"],"ref":"refs/changes/35/3735/10","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1530825102,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1529439892,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1528482490,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1530713030,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1530713030,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1530825667,"by":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":28,"deletions":-4},{"file":"lib/snapShotter.js","type":"MODIFIED","insertions":151,"deletions":-31},{"file":"smf/snapshotter.xml","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"snapshotter.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":184,"sizeDeletions":-40}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}]}