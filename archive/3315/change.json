{"project":"joyent/illumos-joyent","branch":"master","id":"I38fc6bde3931dc58f0c0eb76cca65e7dd645c756","number":"3315","subject":"OS-6594 zoneadmd forgot to setenv _ZONECFG_device_resources Reviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cj","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3315","commitMessage":"OS-6594 zoneadmd forgot to setenv _ZONECFG_device_resources\nReviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1518123241,"lastUpdated":1518713577,"open":false,"status":"MERGED","comments":[{"timestamp":1518123241,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1518123880,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1518124206,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1518185944,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1518186599,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(1 comment)\n\nTesting:\n\n* Booted lx, joyent, and kvm zones without any issues.  They don\u0027t use this new environment variable, but they do use others that may be mangled by the change.\n*  With the same change in the dev-bhyve branch, bhyve zones with one and several disks work fine.\n\n`make check` is clean.  No new output from `make lint`."},{"timestamp":1518188027,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nAfter I took another look at this, I think my previous +1 was premature. Since we can use regexps in a device match, I am not sure that this is actually going to give us a useful result in the environment variable. For instance, I think the example in the zonecfg man page of:\n    set match\u003d\"/dev/cua/a00[2-5]\"\nwould turn into:\n    _dev_cua_a000_2_5_\nIs this correct and if so, would it be useful in any way to the brand hooks?"},{"timestamp":1518193049,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1518198916,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1\n\nMike, thanks for the additional comments, this seems fine as an intermediate fix."},{"timestamp":1518453975,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1518454695,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 4."},{"timestamp":1518454876,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1518465576,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1518527743,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1518531105,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1518532781,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1518633672,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Published edit on patch set 4."},{"timestamp":1518633984,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5:\n\nTesting: The code from round 1 was running in dev-bhyve for several weeks.  I\u0027ve verified that kvm, smartos, and lx zones still work. I\u0027ve also brought these changes over to dev-bhyve and verified that bhyve zones still work there."},{"timestamp":1518640122,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1518650631,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1518711811,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1518713409,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1518713567,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1518713577,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"7","revision":"9b5f494dc07544fd40038466910d2c20c16406ea","parents":["37630e29b3c68710b76194d9781e23f3a79df300"],"ref":"refs/changes/15/3315/7","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518713567,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518640122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518650631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518713409,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1518713577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-13}],"sizeInsertions":75,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"e0e711d5a740663af5480daff7b390aff0d1d3d8","parents":["be9ad087cc97e02e3d356d4b868c94adf56bd327"],"ref":"refs/changes/15/3315/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518123241,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518124206,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":890,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"A comment explaining the reason why this is needed would be appreciated for random passersby like myself."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":890,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Comment added, but also improved the code.  In the event that there are other characters that aren\u0027t reasonable to have in an environment variable name, they should be whacked as well.  I sanitize each match rather than list of matches because the space between list items is significant."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":11,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-1},{"number":"2","revision":"5e257d045f90fefefe7ef5181f5258249f893a48","parents":["be9ad087cc97e02e3d356d4b868c94adf56bd327"],"ref":"refs/changes/15/3315/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518185944,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":33,"deletions":-9}],"sizeInsertions":33,"sizeDeletions":-9},{"number":"3","revision":"d6bce64d6c61a25604a1439ad3cfc760c0f3efcc","parents":["be9ad087cc97e02e3d356d4b868c94adf56bd327"],"ref":"refs/changes/15/3315/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518193049,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518198916,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":783,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: variable"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":783,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":789,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"style nit: Any reason to exclude this since it\u0027s a simple overwrite?  Up to you."},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":789,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Not that it matters here, but generally I try to avoid invalidating caches with unnecessary writes.  Since you don\u0027t like it and I don\u0027t really care, I\u0027ll remove it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-13}],"sizeInsertions":75,"sizeDeletions":-13},{"number":"4","revision":"38fc6bde3931dc58f0c0eb76cca65e7dd645c756","parents":["be9ad087cc97e02e3d356d4b868c94adf56bd327"],"ref":"refs/changes/15/3315/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518454695,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518465576,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518454876,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518532781,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"comments":[{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":942,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Shouldn\u0027t that be \"boot hook\"?"},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","line":942,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-13}],"sizeInsertions":75,"sizeDeletions":-13},{"number":"5","revision":"6b0fe78dbdbbe179c57cb6ec0bc570db4567f527","parents":["be9ad087cc97e02e3d356d4b868c94adf56bd327"],"ref":"refs/changes/15/3315/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518633672,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518640122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518650631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-13}],"sizeInsertions":75,"sizeDeletions":-13},{"number":"6","revision":"4a4adcded4202fb63db933709a9474b119ab5062","parents":["37630e29b3c68710b76194d9781e23f3a79df300"],"ref":"refs/changes/15/3315/6","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518711811,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518640122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518713409,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518650631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-13}],"sizeInsertions":75,"sizeDeletions":-13},{"number":"7","revision":"9b5f494dc07544fd40038466910d2c20c16406ea","parents":["37630e29b3c68710b76194d9781e23f3a79df300"],"ref":"refs/changes/15/3315/7","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1518713567,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518640122,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1518713409,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1518650631,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1518713577,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/zoneadmd/zoneadmd.c","type":"MODIFIED","insertions":75,"deletions":-13}],"sizeInsertions":75,"sizeDeletions":-13}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}