From 15422e1978550c57070abf9d1af02e2442076b3f Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 26 Oct 2016 18:26:40 -0700
Subject: [PATCH] MANTA-2989 Use cueball in muskie->mako Reviewed by: David
 Pacheco <dap@joyent.com> Reviewed by: Jordan Hendricks
 <jordan.hendricks@joyent.com>

---
 etc/config.coal.json           | 35 +++++++++++--
 lib/common.js                  |  1 +
 lib/obj.js                     |  9 ++--
 lib/shark_client.js            | 15 ++++--
 main.js                        | 34 ++++++++++++-
 package.json                   |  2 +-
 sapi_manifests/muskie/template | 91 ++++++++++++++++++++++++++++++----
 7 files changed, 165 insertions(+), 22 deletions(-)

diff --git a/etc/config.coal.json b/etc/config.coal.json
index 5465d66..cd5dd04 100644
--- a/etc/config.coal.json
+++ b/etc/config.coal.json
@@ -31,6 +31,30 @@
             "expiry": 30
         }
     },
+    "cueballHttpAgent": {
+        "resolver": ["nameservice.coal.joyent.us"],
+        "initialDomains": [
+          "authservice.coal.joyent.us"
+        ],
+        "spares": 8,
+        "maximum": 200,
+        "recovery": {
+          "default": {
+            "timeout": 2000,
+            "maxTimeout": 10000,
+            "retries": 5,
+            "delay": 250,
+            "maxDelay": 2000
+          },
+          "dns_srv": {
+            "timeout": 2000,
+            "maxTimeout": 10000,
+            "retries": 1,
+            "delay": 0,
+            "maxDelay": 0
+          }
+        }
+    },
     "medusa": {
         "moray": {
             "host": "electric-moray.coal.joyent.us",
@@ -49,11 +73,16 @@
     },
     "sharkConfig": {
         "connectTimeout": 2000,
-        "maxIdleTime": 1000,
+        "maxTimeout": 10000,
+        "delay": 250,
+        "maxIdleTime": 10000,
         "maxClients": 50,
         "retry": {
-            "retries": 2
-        }
+          "retries": 2
+        },
+        "spares": 2,
+        "maximum": 2000,
+        "resolver": ["nameservice.coal.joyent.us"]
     },
     "authToken": {
         "salt": "C93A670ACC05C166",
diff --git a/lib/common.js b/lib/common.js
index 7ee2a83..8996f9f 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -872,6 +872,7 @@ module.exports = {
             req.picker = options.picker();
             req.sharks = [];
             req.sharkConfig = options.sharkConfig;
+            req.sharkAgent = options.sharkAgent();
             req.medusa = options.medusa();
 
             var _opts = {
diff --git a/lib/obj.js b/lib/obj.js
index 4e9272d..31f38cb 100644
--- a/lib/obj.js
+++ b/lib/obj.js
@@ -110,7 +110,8 @@ function sharkConnect(opts, sharkInfo, cb) {
         connectTimeout: opts.sharkConfig.connectTimeout,
         log: opts.log,
         retry: opts.sharkConfig.retry,
-        shark: opts.shark
+        shark: opts.shark,
+        agent: opts.sharkAgent
     });
     assert.ok(client, 'sharkClient returned null');
 
@@ -357,7 +358,8 @@ function startSharkStreams(req, res, next) {
         objectId: req.objectId,
         owner: req.owner.account.uuid,
         requestId: req.getId(),
-        sharkConfig: req.sharkConfig
+        sharkConfig: req.sharkConfig,
+        sharkAgent: req.sharkAgent
     };
 
     req.sharksContacted = [];
@@ -832,7 +834,8 @@ function streamFromSharks(req, res, next) {
             connectTimeout: req.sharkConfig.connectTimeout,
             log: req.log,
             retry: req.sharkConfig.retry,
-            shark: s
+            shark: s,
+            agent: req.sharkAgent
         }));
     });
 
diff --git a/lib/shark_client.js b/lib/shark_client.js
index 7a15947..98db362 100644
--- a/lib/shark_client.js
+++ b/lib/shark_client.js
@@ -181,14 +181,13 @@ function SharkClient(options) {
     assert.object(options.log, 'options.log');
     assert.optionalObject(options.retry, 'options.retry');
     assert.object(options.shark, 'options.shark');
+    assert.object(options.agent, 'options.agent');
 
     EventEmitter.call(this);
 
     var self = this;
 
-    this.agent = new KeepAliveAgent({
-        maxSockets: MAX_SOCKETS
-    });
+    this.agent = options.agent;
     this.connectTimeout = options.connectTimeout || 2000;
     this.hostname = options.shark.manta_storage_id;
     this.log = options.log.child({
@@ -198,6 +197,16 @@ function SharkClient(options) {
     this.port = 80;
 
     this.close = once(function close() {
+        /*
+         * Cueball Agents have a .stop() method. If we find one on our agent,
+         * use it.
+         */
+        if (typeof (self.agent.stop) === 'function') {
+            self.agent.stop();
+            return;
+        }
+
+        /* Otherwise, assume it's a KeepAliveAgent. */
         var sockets = self.agent.idleSockets || {};
         Object.keys(sockets).forEach(function (k) {
             sockets[k].forEach(function (s) {
diff --git a/main.js b/main.js
index e467457..9971302 100644
--- a/main.js
+++ b/main.js
@@ -50,6 +50,7 @@ var LOG = bunyan.createLogger({
     serializers: restify.bunyan.serializers
 });
 var AGENT;
+var SHARKAGENT;
 var MAHI;
 var MARLIN;
 var KEYAPI;
@@ -134,6 +135,8 @@ function configure() {
         cfg.marlin.log = LOG;
         cfg.moray.log = LOG;
         cfg.medusa.log = LOG;
+        cfg.cueballHttpAgent.log = LOG;
+        cfg.sharkConfig.log = LOG;
     }
 
     if (opts.verbose || !cfg.bunyan) {
@@ -202,8 +205,34 @@ function usage(parser, message)
     process.exit(2);
 }
 
-function createCueballHttpAgent(cfg) {
+function createCueballHttpAgent(cfg, sharkCfg) {
+    /* Used for connections to mahi and other services. */
     AGENT = new cueball.HttpAgent(cfg);
+
+    /* Used only for connections to sharks. */
+    var sharkCueball = {
+        resolver: sharkCfg.resolver,
+        spares: sharkCfg.spares,
+        maximum: sharkCfg.maximum,
+        linger: sharkCfg.maxIdleTime,
+        tcpKeepAliveInitialDelay: sharkCfg.maxIdleTime,
+        log: sharkCfg.log,
+        recovery: {
+            default: {
+                retries: sharkCfg.retry.retries,
+                timeout: sharkCfg.connectTimeout,
+                maxTimeout: sharkCfg.maxTimeout,
+                delay: sharkCfg.maxTimeout
+            },
+            'dns_srv': {
+                retries: 0,
+                timeout: sharkCfg.connectTimeout,
+                maxTimeout: sharkCfg.maxTimeout,
+                delay: 0
+            }
+        }
+    };
+    SHARKAGENT = new cueball.HttpAgent(sharkCueball);
 }
 
 function createPickerClient(cfg) {
@@ -403,7 +432,7 @@ function version() {
 (function main() {
     var cfg = configure();
 
-    createCueballHttpAgent(cfg.cueballHttpAgent);
+    createCueballHttpAgent(cfg.cueballHttpAgent, cfg.sharkConfig);
     createMarlinClient(cfg.marlin);
     createPickerClient(cfg.storage);
     createAuthCacheClient(cfg.auth);
@@ -422,6 +451,7 @@ function version() {
     cfg.picker = function picker() { return (PICKER); };
     cfg.moray = function moray() { return (MORAY); };
     cfg.medusa = function medusaClient() { return (MEDUSA); };
+    cfg.sharkAgent = function sharkAgent() { return (SHARKAGENT); };
 
     cfg.name = 'ssl';
 
diff --git a/package.json b/package.json
index 30922b1..97e78da 100644
--- a/package.json
+++ b/package.json
@@ -14,7 +14,7 @@
         "backoff": "2.3.0",
         "bunyan": "0.22.1",
         "bunyan-syslog": "0.2.2",
-        "cueball": "1.1.1",
+        "cueball": "1.2.1",
         "dashdash": "1.3.2",
         "deep-equal": "0.0.0",
         "dtrace-provider": "0.2.8",
diff --git a/sapi_manifests/muskie/template b/sapi_manifests/muskie/template
index a663967..ea6f1ba 100644
--- a/sapi_manifests/muskie/template
+++ b/sapi_manifests/muskie/template
@@ -31,23 +31,102 @@
       "expiry": 30
     }
   },
+
+  {{!
+    These settings are used for the generic cueball HttpAgent. This is used
+    for talking to all HTTP APIs (in muskie's case, this means mahi)
+  }}
   "cueballHttpAgent": {
+
+    {{! Use "bootstrap" mode to find binder, then use it for lookups. }}
     "resolver": ["nameservice.{{DOMAIN_NAME}}"],
+
+    {{! Pre-populate pools to make startup faster. }}
     "initialDomains": [
       "{{AUTH_SERVICE}}"
     ],
-    "spares": 4,
-    "maximum": 20,
+
+    {{!
+      The spares value here should be larger than sharkConfig.spares, by
+      a factor probably >2, <10. Mahi connections are shared amongst all reqs
+      unlike shark connections, so we need more of them.
+    }}
+    "spares": 8,
+    {{!
+      We never want to hit this cap, so make it plenty big. This value (200) is
+      an order of magnitude above the max socket usage seen in lab tests.
+    }}
+    "maximum": 200,
+
     "recovery": {
       "default": {
+        {{!
+          Values less than 2s seem to yield lots of false failures. Cueball
+          will double the timeout until it hits maxTimeout.
+        }}
         "timeout": 2000,
         "maxTimeout": 10000,
+        {{!
+          Number of retries until the backend is declared "dead". 3-5 seems to
+          work well in SDC.
+        }}
         "retries": 5,
+        {{! Delay between retries, to space them out. }}
         "delay": 250,
         "maxDelay": 2000
+      },
+
+      {{!
+        No retries on DNS SRV lookups, because mahi currently registers itself
+        in DNS as a redis service, not HTTP. See MANTA-3017 and related bugs.
+      }}
+      "dns_srv": {
+        "timeout": 2000,
+        "maxTimeout": 10000,
+        "retries": 1,
+        "delay": 0,
+        "maxDelay": 0
       }
     }
   },
+
+  {{!
+    These settings are used to set up the per-shark cueball agent. This
+    manages connections from the muskie out to makos for storing/retrieving
+    actual object data.
+  }}
+  "sharkConfig": {
+    {{! These are translated into cueball recovery parameters. }}
+    "connectTimeout": 2000,
+    "maxTimeout": 10000,
+    "delay": 250,
+    "retry": {
+      "retries": 2
+    },
+
+    {{! Use bootstrap mode to find binder, same as for cueballHttpAgent. }}
+    "resolver": ["nameservice.{{DOMAIN_NAME}}"],
+
+    {{! TCP keepalive initial timeout. }}
+    "maxIdleTime": 10000,
+    "maxClients": 50,
+
+    {{!
+      We want spares to be small: for the sake of prudence we don't want lots
+      of idle sockets sitting around for no reason. We also want it to be large:
+      we want to be able to have a margin to soak up load transients. It was
+      originally proposed that this be set to 1, but this causes suffering under
+      transient load. The value 2 seems to work ok in the lab.
+    }}
+    "spares": 2,
+    {{!
+      This needs to be very high, as some requests to sharks may take a very
+      long time to complete (and this is normal). We need plenty of headroom
+      to make sure we don't queue requests unnecessarily.
+    }}
+    "maximum": 2000
+  },
+
   "medusa": {
     "moray": {
       "host": "{{ELECTRIC_MORAY}}",
@@ -65,14 +144,6 @@
     "multiDC": {{MUSKIE_MULTI_DC}}{{#MUSKIE_IGNORE_SIZE}},
     "ignoreSize": {{MUSKIE_IGNORE_SIZE}}{{/MUSKIE_IGNORE_SIZE}}
   },
-  "sharkConfig": {
-    "connectTimeout": 2000,
-    "maxIdleTime": 1000,
-    "maxClients": 50,
-    "retry": {
-      "retries": 2
-    }
-  },
   "authToken": {
     "salt": "{{MUSKIE_JOB_TOKEN_AES_SALT}}",
     "key": "{{MUSKIE_JOB_TOKEN_AES_KEY}}",
-- 
2.21.0

