{"project":"joyent/sdc-vmapi","branch":"master","id":"Ib4015ddcbe539fa52289288be556da803cc5f43d","number":"629","subject":"ZAPI-747 Support updating VMAPI\u0027s moray buckets\u0027 indexes at VMAPI\u0027s startup Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Approved by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/629","commitMessage":"ZAPI-747 Support updating VMAPI\u0027s moray buckets\u0027 indexes at VMAPI\u0027s startup\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nApproved by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1475886854,"lastUpdated":1497050825,"open":false,"status":"MERGED","comments":[{"timestamp":1475886854,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1475886914,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476158224,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1476218681,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476220085,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 3."},{"timestamp":1476220143,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476220999,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 4."},{"timestamp":1476221039,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476228941,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1476229158,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1476345820,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Code-Review+1\n\n(41 comments)"},{"timestamp":1476384806,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1476389904,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4:\n\n(39 comments)"},{"timestamp":1476395565,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 5."},{"timestamp":1476395628,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476402196,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\n(2 comments)\n\nupdates for #5 lgtm"},{"timestamp":1476402203,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1476495201,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(7 comments)\n\nCR https://cr.joyent.us/#/c/629/ for jgilli. Really really.\n\n- \"storage\" for the database name? confusing with imgapi naming, FWIW\n- \"Moray\" class would be nicer for grepping and var naming if called\n  MorayStorage or whatever more specific\n\n- hrm on renaming these things here. Personally I\u0027d rather see:\n\n    var morayStorConsts \u003d require(\u0027./lib/storage/moray/constants\u0027);\n    console.log(\u0027my const is\u0027, morayStorConsts.VMS_BUCKET_CONFIG);\n\n  Then it \"looks\" like a constant. Rather than:\n\n    console.log(\u0027my const is\u0027, morayBucketConfig.vms);\n\n  I guess they both work.\n\n\n# lib/storage/moray/moray.js\n\n\u003e function Moray(morayClient, options) {\n\u003e    EventEmitter.call(this);\n\nIs this missing a `util.inherits` ?\n\n\n# moray-buckets-initializer.js\n\n- style:\n\n        var morayBucketsConfig \u003d require(\u0027../lib/storage/moray/moray-buckets-config\u0027);\n        var morayStorage \u003d require(\u0027../lib/storage/moray/moray\u0027);\n\n    If it is a new-able thing, I\u0027d be inclined to import like this\n\n        var MorayBucketsConfig \u003d require(\u0027../lib/storage/moray/moray-buckets-config\u0027);\n        var MorayStorage \u003d require(\u0027../lib/storage/moray/moray\u0027);\n\n    Even consider calling those files \"lib/storage/moray/MorayStorage.js\",\n    but I don\u0027t think we have a lot of precendent for that.\n\n- Style nit: This is a bit wordy. While accurate, is 3 lines of prose need to\n  ID that this is a constructor?\n\n   /*\n    * The MorayBucketsInitializer function is a constructor that can be used to\n    * create instances of MorayBucketsInitializer. It derives from\n    * events.EventEmitter.\n\n- `this._log \u003d new bunyan({`\n  Preferred is `this._log \u003d bunyan.createLogger({\n\n- Perhaps if given a log it could set component:\n\n    ```\n    function MorayBucketsInitializer(options) {\n        assert.optionalObject(options, \u0027options\u0027);\n        var options \u003d options || {};\n        assert.optionalNumber(options.maxAttempts, \u0027options.maxAttempts\u0027);\n        this._maxAttempts \u003d options.maxAttempts;\n\n        assert.optionalObject(options.log, \u0027options.log\u0027);\n        if (options.log) {\n            this._log \u003d options.log.child(\n                {component: \u0027moray-buckets-initializer\u0027}, true);\n        } else {\n            this._log \u003d new bunyan({\n                name: \u0027moray-buckets-initializer\u0027,\n                level: \u0027info\u0027,\n                serializers: restify.bunyan.serializers\n            });\n        }\n    }\n    ```\n\n  Or frankly, just always require a `options.log`, else this is a bit of\n  featuritis. For the usage in the test case, perhaps have a global `var log`\n  for that test file and pass that in.\n\n# test/vms.delete_non_existing_no_workflow.test.js\n\nThat is a LOT of boilerplate code (setting up moray client and storage) just to\nrun `vmTest.deleteTestVMs`. Likewise (same boilerplate?) in other test files.\nAnd in some tools/... files. Can that boilerplate be shared somehow?\n\n\n\n# test/vms.update-moray-*.test.js\n\n\u003e var mod_vmapiClient \u003d require(\u0027sdc-clients\u0027).VMAPI;\n\nThat\u0027s not really a \"module\" anymore. Also the long name hurts. :)\n\n    var VMAPI \u003d require(\u0027sdc-clients\u0027).VMAPI;\n\nAh, then I see there is a `vmapi` import, which is the VMAPI app. Perhaps\nthis for that one? Obviously I\u0027m showing some style prefs here :)\nOoh, then we get to have the \"app\" vs \"service\" debate!\n\n    var VmapiApp \u003d require(\u0027../lib/vmapi\u0027);\n\n\u003e var mod_morayStorage \u003d require(\u0027../lib/storage/moray/moray\u0027);\n\u003e var MorayBucketsInitializer \u003d\n\u003e    require(\u0027../lib/storage/moray/moray-buckets-initializer\u0027);\n\nI like the latter style, as mentioned above. So perhaps also for the former:\n\n    var MorayStorage \u003d require(\u0027...\u0027);\n\n\n\u003e                vmapiClient.ping(function onVmapiPing(pingErr, obj) {\n\u003e                    var errBody \u003d pingErr.body;\n\nThis test case doesn\u0027t check the statusCode returned by VMAPI /ping. I think\nit should. The `vmapiClient.ping` callback has: `callback(null, obj, req, res)`\nso you have `res.statusCode` to look at.\n\n\nDo these tests clean up the test buckets they create in Moray?\n\n\n# lib/storage/moray/moray.js\n\n+            self.log.error({ error: setupBucketsErr },\n+                \u0027Error when setting up moray buckets\u0027);\n\nThat needs to be the \u0027err\u0027 key to Bunyan to trigger the error serialization.\nOr:\n        self.log.error(setupBucketsErr, \u0027Error when ...\u0027);\n\n\n\u003e _createMorayNotInitialzedErrMsg\n\nTypo: \"Initialized\"\n\n\n\n# ping.js\n\nXXX Are there doc updates for the ping endpoint?\n\n\n# server.js\n\nXXX todo"},{"timestamp":1476676642,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Patch Set 5:\n\n(8 comments)\n\nI have a couple of concerns, one around re-indexing and one around making the change feed options optional now. Otherwise, I\u0027ve just added a few small nits.\n\nBroadly speaking, this is a great addition/refactor of VMAPI"},{"timestamp":1476820363,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 6."},{"timestamp":1476820392,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476820392,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(6 comments)\n\n\u003e - \"storage\" for the database name? confusing with imgapi naming, FWIW\n\n\"storage\" is not meant to be the database name, it\u0027s meant to be the name of the abstraction layer at which VMAPI performs operations to store data. Eventually, we could have another implementation of the storage layer (e.g for testing purposes).\n\n\u003e - \"Moray\" class would be nicer for grepping and var naming if called\n\u003e  MorayStorage or whatever more specific\n\nAgreed, I changed that, but kept it in the same file to avoid confusion during this code-review cycle.\n\n\u003e hrm on renaming these things here. Personally I\u0027d rather see:\n\u003e    var morayStorConsts \u003d require(\u0027./lib/storage/moray/constants\u0027);\n\u003e    console.log(\u0027my const is\u0027, morayStorConsts.VMS_BUCKET_CONFIG);\n\u003e  Then it \"looks\" like a constant. Rather than:\n\u003e    console.log(\u0027my const is\u0027, morayBucketConfig.vms);\n\u003e  I guess they both work.\n\nI don\u0027t like the concept of moray storage constants because it\u0027s a bit too generic. Would capitalizing \"vms\" like \"morayBucketConfig.VMS\" help convey that this property is a constant?\n\n\u003e # lib/storage/moray/moray.js\n\u003e function Moray(morayClient, options) {\n\u003e   EventEmitter.call(this);\n\u003e Is this missing a `util.inherits` ?\n\nGood catch! It\u0027s actually calling EventEmitter\u0027s constructor when it should not. The Moray class is not an event emitter anymore. However, the MorayBucketsInitializer constructor, which is an event emitter, was missing that call.\n\n\u003e Style nit: This is a bit wordy. While accurate, is 3 lines of prose need to\n\u003e  ID that this is a constructor?\n\u003e   /*\n\u003e   * The MorayBucketsInitializer function is a constructor that can be used to\n\u003e    * create instances of MorayBucketsInitializer. It derives from\n\u003e   * events.EventEmitter.\n\nAbsolutely, made this part more concise.\n\n\u003e `this._log \u003d new bunyan({`\n:   Preferred is `this._log \u003d bunyan.createLogger({\n\u003e Perhaps if given a log it could set component:\n\u003e    ```\n\u003e    function MorayBucketsInitializer(options) {\n\u003e        assert.optionalObject(options, \u0027options\u0027);\n\u003e        var options \u003d options || {};\n\u003e        assert.optionalNumber(options.maxAttempts, \u0027options.maxAttempts\u0027);\n\u003e        this._maxAttempts \u003d options.maxAttempts;\n\u003e        assert.optionalObject(options.log, \u0027options.log\u0027);\n\u003e        if (options.log) {\n\u003e            this._log \u003d options.log.child(\n\u003e                {component: \u0027moray-buckets-initializer\u0027}, true);\n\u003e        } else {\n\u003e            this._log \u003d new bunyan({\n\u003e                name: \u0027moray-buckets-initializer\u0027,\n\u003e                level: \u0027info\u0027,\n\u003e                serializers: restify.bunyan.serializers\n\u003e            });\n\u003e        }\n\u003e    }\n\u003e    ```\n\u003e Or frankly, just always require a `options.log`, else this is a bit of\n\u003e featuritis. For the usage in the test case, perhaps have a global `var log`\n\u003e for that test file and pass that in.\n\nI went for the former options (if given a log, create a child).\n\n\u003e # test/vms.delete_non_existing_no_workflow.test.js\n\u003e That is a LOT of boilerplate code (setting up moray client and storage) just to\n\u003e run `vmTest.deleteTestVMs`. Likewise (same boilerplate?) in other test files.\n\u003e And in some tools/... files. Can that boilerplate be shared somehow?\n\nAdded a new lib/storage/moray/moray-init.js module where that boilerplate code is factored out. I\u0027d appreciate if you could take a look at this and let me know if that addresses your concerns.\n\n\u003e # test/vms.update-moray-*.test.js\n\u003e var mod_vmapiClient \u003d require(\u0027sdc-clients\u0027).VMAPI;\n\u003e That\u0027s not really a \"module\" anymore. Also the long name hurts. :)\n\u003e     var VMAPI \u003d require(\u0027sdc-clients\u0027).VMAPI;\n\u003e Ah, then I see there is a `vmapi` import, which is the VMAPI app. Perhaps\n\u003e this for that one? Obviously I\u0027m showing some style prefs here :)\n\u003e Ooh, then we get to have the \"app\" vs \"service\" debate!\n\nReplaced \"mod_vmapiClient\" with \"VMAPI\", and \"vmapi\" with \"VmapiApp\", as well as \"vmapiService\" with \"vmapiApp\".\n\n\u003e var mod_morayStorage \u003d require(\u0027../lib/storage/moray/moray\u0027);\n\u003e var MorayBucketsInitializer \u003d\n\u003e   require(\u0027../lib/storage/moray/moray-buckets-initializer\u0027);\n\u003e I like the latter style, as mentioned above. So perhaps also for the former:\n\u003e    var MorayStorage \u003d require(\u0027...\u0027);\n\nDone.\n\n\u003e   vmapiClient.ping(function onVmapiPing(pingErr, obj) {\n\u003e                    var errBody \u003d pingErr.body;\n\u003e This test case doesn\u0027t check the statusCode returned by VMAPI /ping. I think\n\u003e it should. The `vmapiClient.ping` callback has: `callback(null, obj, req, res)`\n\u003e so you have `res.statusCode` to look at.\n\nDone.\n\n\u003e Do these tests clean up the test buckets they create in Moray?\n\nSome of them did not, now they all do but _at the start_ of each test, not after the test ran. This way, a subsequent test run will always start from a blank state with regards to these test buckets, but when a test fails, we\u0027ll be able to take a look at these test buckets to investigate the root cause of the problem. Does that sound reasonable to you?\n\n\u003e # lib/storage/moray/moray.js\n\u003e +            self.log.error({ error: setupBucketsErr },\n\u003e +                \u0027Error when setting up moray buckets\u0027);\n\u003e That needs to be the \u0027err\u0027 key to Bunyan to trigger the error serialization.\n\u003e Or:\n\u003e        self.log.error(setupBucketsErr, \u0027Error when ...\u0027);\n\nDone.\n\n\u003e \u003e _createMorayNotInitialzedErrMsg\n\u003e Typo: \"Initialized\"\n\nDone.\n\n\u003e # ping.js\n\u003e XXX Are there doc updates for the ping endpoint?\n\nGood catch, there should have been. I updated the documentation now. Note that it seems to have been out of date for a while. Technically, these changes would represent a breaking change and would require a major version bump. I could alter my changes to the /ping endpoint\u0027s response to not change the structure of the response object and only add properties, which would technically be a minor version bump. I could also not alter the response\u0027s object\u0027s structure and consider that the \"moray\" api is connected only if it\u0027s been initialized, and not include the latest initialization error in that response. That would only require a patch version bump.\n\nRegardless of the changes in the /ping endpoint, there are enough changes in the behavior of other parts of VMAPI to require a major version bump anyway, but I don\u0027t know the impact this would have on other parts of Triton."},{"timestamp":1476828349,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 7."},{"timestamp":1476828369,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(8 comments)"},{"timestamp":1476828382,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476833213,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7:\n\n\u003e Added a new lib/storage/moray/moray-init.js module\n\nI\u0027ll take a look (likely tomorrow).\n\n\u003e Some of them did not, now they all do but _at the start_ of each test, not after the test ran.\n\nYup, that\u0027s cool.\nIt might be helpful to have all the test buckets be prefixed with \"vmapitest_\" instead of the \"test\" being somewhere later in the bucket name, but that\u0027s not a biggie.\n\n\u003e ping endpoint\n\nWe effectively don\u0027t handle explicitly using API versions, so we are somewhat in the realm of \"you may not make breaking changes\" because downstream consumers don\u0027t have a way to adapt. So if you can make the ping endpoint be minor version compatible at least, that would be preferred.\n\n\u003e there are enough changes in the behavior of other parts of VMAPI to require a major version bump anyway\n\nCan we eventually be specific on those, so we can discuss?"},{"timestamp":1476841207,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1476946388,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 8."},{"timestamp":1476946428,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476946772,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 9."},{"timestamp":1476946800,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1476946967,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 8:\n\nSubmitted two new patch sets that:\n\n1. Bring back the changes to the /ping endpoint to semver minor changes. package.json was updating accordingly.\n\n2. Add a reindexing step to MorayStorage.prototype.setupBuckets. The storage layer is not considered to be initialized until reindexing for all buckets is complete. The test \"vms.update-moray-bucket-versioning.test.js\" was modified to include more thorough testing of that new reindexing step.\n\n3. Test buckets are now prefixed with \"test_\", instead of just having \"test\" somewhere in their name."},{"timestamp":1495234674,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 10."},{"timestamp":1495234708,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1495234940,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 10:\n\nThe latest patch set rebases the previous changes on master and changes the approach that was taken for initializing VMAPI\u0027s Moray buckets: It splits the creation/update and reindexing processes into two separate steps that happen sequentially.\n\nThe latest patch set also sets the version of all VMAPI Moray buckets to be at version 1. Previously no VMAPI Moray bucket had any version information.\n\nFinally, the latest patch removed any change that wasn\u0027t strictly needed for ZAPI-747, and e.g keeps the Moray DB layer abstraction in the lib/apis/moray.js file instead of moving it to lib/storage/moray.js. Hopefully, that makes things easier to review. If you think it would be even easier to start the review process from scratch, I can abandon this CR and create a new one, just let me know. Otherwise, it will probably be easier to do the code review by comparing the latest patch set with the \"Base\" patch set, not with the previous patch set."},{"timestamp":1496363669,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 11."},{"timestamp":1496363709,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496625414,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 12: Patch Set 11 was rebased."},{"timestamp":1496625454,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12:\n\n\"make check\" passed ok"},{"timestamp":1496873254,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 12:\n\n(27 comments)\n\nI\u0027m confused about whether and how this depends on MORAY-104 and the usage of `requireIndexes`.\n\nPerhaps the new test files should NOT be \"vms.$name.test.js\" but just\n\"$name.test.js\"."},{"timestamp":1496873770,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 13."},{"timestamp":1496873805,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496881645,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 12:\n\n(27 comments)"},{"timestamp":1496884805,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 14."},{"timestamp":1496884840,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496960864,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 15."},{"timestamp":1496960893,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1496961005,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 15:\n\nThe latest changes that were pushed with patch set 14 were according to the latest review done by Trent.\n\nThe changes that were pushed with patch set 15 were according to some additional testing I did in COAL. I basically realized that there was no integration test for the case of a transient error during the reindexing process, so I added one.\n\nThe unsquashed branch that contains these two patch sets as separate commits is available at https://github.com/misterdjules/sdc-vmapi/commits/ZAPI-747-unsquashed."},{"timestamp":1497038441,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 15: Code-Review+1\n\n(2 comments)"},{"timestamp":1497047344,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 16."},{"timestamp":1497047373,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1497047374,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 12:\n\n(2 comments)"},{"timestamp":1497048122,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 16: Code-Review+1 Integration-Approval+1"},{"timestamp":1497050753,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 17: Commit message was updated."},{"timestamp":1497050825,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"17","revision":"a4f4c8f63a2d8be592bd2275ee010c249e7eb48a","parents":["a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105"],"ref":"refs/changes/29/629/17","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1497050753,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497047373,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497048122,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1497048122,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1497050825,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":547,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":111,"deletions":-46},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":282,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":163,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":48,"deletions":-22},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-22},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":53,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":75,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"ADDED","insertions":288,"deletions":0},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":198,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":205,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":248,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":544,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":40,"deletions":-38},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":31,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3269,"sizeDeletions":-656},"patchSets":[{"number":"1","revision":"ba874684f9c01915a9855ca42ec2770b57737944","parents":["a5f6c49d674ce896d05266cfcc978634cc97fa2d"],"ref":"refs/changes/29/629/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1475886854,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475886914,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apis/moray.js","type":"DELETED","insertions":0,"deletions":-1036},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-34},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":165,"deletions":0},{"file":"lib/storage/moray/moray.js","type":"ADDED","insertions":1318,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":133,"deletions":-133},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":223,"deletions":-25},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":60,"deletions":-10},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":106,"deletions":-59},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":174,"deletions":-142},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":205,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":204,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":279,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":296,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":56,"deletions":-27},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":42,"deletions":-35},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":159,"deletions":-143},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":4,"deletions":-5},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":3660,"sizeDeletions":-1768},{"number":"2","revision":"a2901812be5195f36c94f861ecedcbccafc312e6","parents":["a5f6c49d674ce896d05266cfcc978634cc97fa2d"],"ref":"refs/changes/29/629/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476158224,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476218681,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apis/moray.js","type":"DELETED","insertions":0,"deletions":-1036},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-34},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":163,"deletions":0},{"file":"lib/storage/moray/moray.js","type":"ADDED","insertions":1319,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":133,"deletions":-133},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":221,"deletions":-25},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":58,"deletions":-10},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":104,"deletions":-59},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":172,"deletions":-142},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":201,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":199,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":294,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":56,"deletions":-27},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":42,"deletions":-35},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":159,"deletions":-143},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":4,"deletions":-5},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":3638,"sizeDeletions":-1768},{"number":"3","revision":"dbacbde8314402e8e6098231d7d9e94773a72c1a","parents":["a5f6c49d674ce896d05266cfcc978634cc97fa2d"],"ref":"refs/changes/29/629/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476220085,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476220143,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-34},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":163,"deletions":0},{"file":"lib/storage/moray/moray.js","fileOld":"lib/apis/moray.js","type":"RENAMED","insertions":430,"deletions":-173},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":133,"deletions":-133},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":220,"deletions":-25},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":58,"deletions":-10},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":104,"deletions":-59},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":172,"deletions":-142},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":201,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":199,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":294,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":56,"deletions":-27},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":42,"deletions":-35},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":159,"deletions":-143},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":4,"deletions":-5},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2748,"sizeDeletions":-905},{"number":"4","revision":"4fdf58166634b21df8be43028d277dc581240a56","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/29/629/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476220999,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476221039,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476345820,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/endpoints/ping.js","line":17,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: perhaps alphabetize these?"},{"file":"lib/endpoints/ping.js","line":17,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/endpoints/ping.js","line":50,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: perhaps alphabetize these too?"},{"file":"lib/interceptors.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update."},{"file":"lib/interceptors.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/storage/moray/moray-buckets-config.js","line":15,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"is there a reason for the ordering here?"},{"file":"lib/storage/moray/moray-buckets-config.js","line":15,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"There is not specific reason for this ordering. This file is basically a copy/paste from the now deleted lib/api/moray.js file, with the addition of a \"version: 1\" to vmapi_vms\u0027 bucket options."},{"file":"lib/storage/moray/moray-buckets-initializer.js","line":129,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: Would probably be good to be consistent with the message above which uses `Non-transient` instead of `Non transient`. Doesn\u0027t matter to me whether it\u0027s either of those or even Nontransient, just that it\u0027s consistent."},{"file":"lib/storage/moray/moray-buckets-initializer.js","line":129,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/storage/moray/moray.js","line":980,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"\"in that order:\" here I think could be better written \"in order:\" unless I\u0027m misunderstanding the meaning."},{"file":"lib/storage/moray/moray.js","line":989,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"When I read this it seems I\u0027m left with the question: do I need to run something else in order to do the reindexing? Or does it happen automatically in the background?\n\nPerhaps it\u0027d be possible to just mention whether there\u0027s something else that does this or if it\u0027s a manual step or if there\u0027s no need to do this at all?"},{"file":"lib/storage/moray/moray.js","line":989,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"These are definitely important questions we should ask ourselves.\n\nThe current design is that there\u0027s no reindexing performed at all. The rationale is that:\n\n1) it\u0027s difficult to know how much time it\u0027d take (it could take hours if there is a large number of rows to reindex), and so it wouldn\u0027t be reasonable to wait for the reindexing to be considered part of the \"storage initialization process\", because until that is done, all VMAPI endpoints respond with a non-2XX status code and a \"moray not initialized yet\" message.\n\n2) AFAIK, we don\u0027t have the infrastructure to run asynchronous long-lived processes reliably, so I didn\u0027t want to build that infrastructure with these changes, and I thought this is something we can add later when we need it.\n\n3) These changes are designed to support adding indexes only for _new_ properties, and for them there\u0027s no need for reindexing.\n\nAll that being said, with these changes there\u0027s still room for someone adding an index on an existing property, and in that case we\u0027d need to run a reindexing program manually, and we\u0027d need to write this new program."},{"file":"lib/storage/moray/moray.js","line":989,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Perhaps add a note to the comment here then saying that reindexing is something that\u0027s not only not performed by this code, but also not performed by Triton at all? Perhaps with a ticket id?"},{"file":"lib/vmapi.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update"},{"file":"lib/vmapi.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/vmapi.js","line":25,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: util should go after trace_event in alphabetical order."},{"file":"lib/vmapi.js","line":25,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/vmapi.js","line":79,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: \"we consider\" seems unnecessary in this sentence."},{"file":"lib/vmapi.js","line":79,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"server.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update"},{"file":"server.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":21,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: moray should be before restify in alphabetical order"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":21,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":26,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: perhaps alphabetize these?"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":26,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":166,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I wonder if it\u0027d be useful to write something to stderr in this case anyway as a diagnostic (prefixed with #) to make it more obvious at a glance that this happened?"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":166,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"`t.comment(\"blah blah\")`"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":166,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good point! I can\u0027t find a way to output diagnostic messages with nodeunit without hardcoding TAP format, which I\u0027d like to avoid. So I\u0027m not sure yet what the best way forward is for this."},{"file":"test/vms.list.test.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update"},{"file":"test/vms.list.test.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.list.test.js","line":20,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: perhaps alphabetize these?"},{"file":"test/vms.list.test.js","line":20,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.list.test.js","line":79,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"again: perhaps add diagnostics?"},{"file":"test/vms.list.test.js","line":79,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good point, same response as before."},{"file":"test/vms.list.test.js","line":377,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"would vmUuids be more appropriate here than vmsUuid since it\u0027s an array of UUIDs?"},{"file":"test/vms.list.test.js","line":377,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.marker.test.js","line":24,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: alphabetize?"},{"file":"test/vms.marker.test.js","line":24,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.marker.test.js","line":31,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: alphabetize?"},{"file":"test/vms.marker.test.js","line":31,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.marker.test.js","line":122,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"again: does vmUuids make more sense?"},{"file":"test/vms.marker.test.js","line":122,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.marker.test.js","line":266,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"yet again: add a diagnostic message?"},{"file":"test/vms.marker.test.js","line":266,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same response as before: AFAIK there\u0027s no way with nodeunit to output diagnostic messages that will be prefixed with \"#\" when the reporter is a TAP reporter."},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","line":25,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: perhaps alphabetize?"},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","line":25,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","line":58,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"is the typo in \u0027erorr\u0027 also intentional?"},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","line":58,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","line":131,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"again: diagnostic?"},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","line":131,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same as before: AFAIK there\u0027s no way with nodeunit to output diagnostic messages that are formatted appropriately for TAP output without hardcoding a \"#\", which could break other reporters."},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","line":23,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"alphabetize?"},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","line":23,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","line":125,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"as with others: diagnostic?"},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","line":125,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same as before: AFAIK there\u0027s no way with nodeunit to output diagnostic messages that are formatted appropriately for TAP output without hardcoding a \"#\", which could break other reporters."},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":25,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"alphabetize?"},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":25,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":73,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ooc: is there a guarantee that \u0027connect\u0027 only happens once?"},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":73,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, looking at https://github.com/joyent/node-moray/blob/master/lib/client.js#L301, it seems like it\u0027s guaranteed that only one \u0027connect\u0027 event will be emitted over the lifetime of a moray client.\n\nI could make that assumption more explicit by either using \"once\" instead of \"on\", or by asserting if the event listener is called more than once. Do you have a preference? I think I\u0027m leaning towards asserting."},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":73,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Either seems like it\u0027d work here to make it clearer to the reader that we\u0027ll only get through once. Assert is fine with me."},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":85,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"can you guess by now? diagnostic message?"},{"file":"test/vms.update-moray-bucket-transient-error.test.js","line":85,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same as before: AFAIK there\u0027s no way with nodeunit to output diagnostic messages that are formatted appropriately for TAP output without hardcoding a \"#\", which could break other reporters."},{"file":"test/vms.update-moray-bucket-versioning.test.js","line":19,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: alphabetize?"},{"file":"test/vms.update-moray-bucket-versioning.test.js","line":19,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.update-moray-bucket-versioning.test.js","line":229,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"blah, blah, diagnostic?"},{"file":"test/vms.update-moray-bucket-versioning.test.js","line":229,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Right, same as before :)"},{"file":"tools/add-test-vms.js","line":9,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update"},{"file":"tools/add-test-vms.js","line":9,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/add-test-vms.js","line":116,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"slightly different message than the others?"},{"file":"tools/add-test-vms.js","line":116,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/fix-no-owner.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update."},{"file":"tools/fix-no-owner.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/fix-no-owner.js","line":15,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: alphabetize?"},{"file":"tools/fix-no-owner.js","line":15,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/kvm-backfill.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update."},{"file":"tools/kvm-backfill.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/kvm-backfill.js","line":71,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"diagnostic?"},{"file":"tools/kvm-backfill.js","line":71,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same as before: AFAIK there\u0027s no way with nodeunit to output diagnostic messages that are formatted appropriately for TAP output without hardcoding a \"#\", which could break other reporters."},{"file":"tools/perf/profile.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update."},{"file":"tools/perf/profile.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/perf/profile.js","line":21,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"alphabetize?"},{"file":"tools/perf/profile.js","line":21,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"tools/perf/random-load.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"missed copyright update."},{"file":"tools/perf/random-load.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-34},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":163,"deletions":0},{"file":"lib/storage/moray/moray.js","fileOld":"lib/apis/moray.js","type":"RENAMED","insertions":430,"deletions":-173},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":133,"deletions":-133},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":220,"deletions":-25},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":58,"deletions":-10},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":104,"deletions":-59},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":172,"deletions":-142},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":201,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":199,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":294,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":56,"deletions":-27},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":42,"deletions":-35},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":159,"deletions":-143},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":4,"deletions":-5},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":2,"deletions":-3}],"sizeInsertions":2749,"sizeDeletions":-906},{"number":"5","revision":"6ee5fe62384cfae78d52a506a500422611a70b72","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/29/629/5","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476395565,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476395628,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1476402203,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/endpoints/ping.js","line":30,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"sounds like an old obsolete comment. the ping endpoint is doing more than just moray now"},{"file":"lib/endpoints/ping.js","line":36,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"suggest dropping this log.error. We have the log.debug with the error details below as well. Don\u0027t need both."},{"file":"lib/endpoints/ping.js","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/endpoints/ping.js","line":67,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"need to use \u0027err\u0027 key for bunyan err serialization"},{"file":"lib/endpoints/ping.js","line":67,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/endpoints/ping.js","line":89,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"typo \"UNINITIALIZED\""},{"file":"lib/endpoints/ping.js","line":89,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/endpoints/vms.js","line":789,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We talked about perhaps having \u0027cfPublisher\u0027 for some brevity. Thoughts?"},{"file":"lib/endpoints/vms.js","line":789,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/interceptors.js","line":87,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m pretty sure we want to use one of the restify error classes here. Else I suppose you get an InternalError by default (i.e. a \u0027500\u0027 status)?  Would be clearer to have a restify.ServiceUnavailableError perhaps?"},{"file":"lib/interceptors.js","line":87,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Created a new \"MorayUnitializedError\" error constructor that inherits from restify.ServiceUnavailableError."},{"file":"lib/storage/moray/moray-buckets-initializer.js","line":74,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"s/use/used"},{"file":"lib/storage/moray/moray-buckets-initializer.js","line":74,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/storage/moray/moray-buckets-initializer.js","line":75,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"s/values/value"},{"file":"lib/storage/moray/moray-buckets-initializer.js","line":75,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/storage/moray/moray.js","line":13,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"s/values/value"},{"file":"lib/storage/moray/moray.js","line":13,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/storage/moray/moray.js","line":31,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"I know you just moved these around, but while you\u0027re in here would you mind changing this to something like `var bunyan \u003d require(\u0027bunyan\u0027)` and add `var log \u003d bunyan.createLogger(...)`?\n\nAccording to Trent, the existing `var Logger \u003d require(\u0027bunyan)` pattern is deprecated."},{"file":"lib/storage/moray/moray.js","line":31,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I don\u0027t mind at all, good catch!"},{"file":"lib/storage/moray/moray.js","line":989,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"I\u0027m curious about the tradeoff here. I get not keeping VMAPI down until reindexing is complete, but I\u0027m worried that _not_ re-indexing could be its own performance problem. Do we have a good manual method for making sure reindexing eventually happens or is it just not a problem all together?"},{"file":"lib/storage/moray/moray.js","line":989,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good question. We can do reindexing, as long as VMAPI doesn\u0027t wait for its completion to consider its \"storage layer\" initialized. If that\u0027s considered an acceptable solution then I\u0027d actually prefer that than not performing reindexing."},{"file":"lib/storage/moray/moray.js","line":989,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"When testing the current state of these changes with other changes that depend on it to add indexes, I realized that it seems that moray actually _requires_ reindexing to be performed after an index has been added in order for it to be usable.\n\nThe tests that I had used before to make sure it wasn\u0027t the case were subtly broken, in part because when using a new index that is not ready in conjunction with another index, it seems that moray does not generate an error.\n\nIn other words I\u0027ll need to:\n\n1. re-add support for reindexing.\n2. add at least one additional test to the tests suite that makes sure that newly added indexes can actually be used and that doesn\u0027t suffer from the problems that my previous manual tests add."},{"file":"lib/vmapi.js","line":86,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"Why change this to optional and remove all the explicit checking for options.changefeed properties?"},{"file":"lib/vmapi.js","line":86,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It was changed to being optional because it seemed to me that it makes sense to be able to start an instance of the VMAPI application without having to start the  changefeed publisher.\n\nThis is useful e.g when writing tests, such as the newly added tests coming with these changes, where we can start a new VMAPI application instance and just provide the dependencies necessary to test the part of VMAPI we want to test.\n\nDoes that make sense ?\n\nAs for removing the explicit checking for options.changefeed properties, I just missed them, I will add them back.\n\nTo summarize: is it OK to keep the changefeed publisher as an optional dependency of the VMAPI app, but check the options.changefeed properties when changefeed settings are provided?"},{"file":"lib/vmapi.js","line":224,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"I understand the desire for a more descriptive name, but I think there is a delicate balance between descriptive variable names and our 80 char width limit.\n\nLong names like this often cause weird wrapping and extra variables, especially since this is used in conjunction with req.app.changefeedPublisher elsewhere in the app.\n\nHow about cfPublisher as a compromise?"},{"file":"lib/vmapi.js","line":224,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Changed all occurrences of \"changefeedPublisher\" for \"cfPublisher\"."},{"file":"server.js","line":36,"reviewer":{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},"message":"While I like the mod_foo naming scheme, this is inconsistent with the other module requires in this repo."},{"file":"server.js","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Absolutely, changed that in a previous patchset."},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":136,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"pass that same logger to `new morayStorage` opts?"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":136,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This will be done in the new helper function that factors out all storage-related initialization code."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-34},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":8,"deletions":-8},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":164,"deletions":0},{"file":"lib/storage/moray/moray.js","fileOld":"lib/apis/moray.js","type":"RENAMED","insertions":430,"deletions":-173},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":134,"deletions":-134},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":221,"deletions":-26},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":59,"deletions":-11},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":105,"deletions":-60},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":172,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":201,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":199,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":277,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":294,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":60,"deletions":-28},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":45,"deletions":-38},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":160,"deletions":-144},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":5,"deletions":-6},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":2765,"sizeDeletions":-920},{"number":"6","revision":"fe2f9ce92fc02ff1645423b281ecb71d77d6777c","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/29/629/6","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476820363,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476820392,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":19,"deletions":-7},{"file":"lib/apis/moray.js","type":"DELETED","insertions":0,"deletions":-1036},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-38},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":10,"deletions":-8},{"file":"lib/errors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":172,"deletions":0},{"file":"lib/storage/moray/moray-init.js","type":"ADDED","insertions":216,"deletions":0},{"file":"lib/storage/moray/moray.js","type":"ADDED","insertions":1293,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":147,"deletions":-147},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":138,"deletions":-25},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/lib/moray.js","type":"ADDED","insertions":85,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":30,"deletions":-11},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":73,"deletions":-60},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":184,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":206,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":249,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":240,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":42,"deletions":-39},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":61,"deletions":-47},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":163,"deletions":-158},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":5,"deletions":-6},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":3738,"sizeDeletions":-1847},{"number":"7","revision":"0a16033ccc99d80ce48064578363d87880ee40fc","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/29/629/7","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476828349,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476828382,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":19,"deletions":-7},{"file":"lib/apis/moray.js","type":"DELETED","insertions":0,"deletions":-1036},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":112,"deletions":-38},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":10,"deletions":-8},{"file":"lib/errors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":172,"deletions":0},{"file":"lib/storage/moray/moray-init.js","type":"ADDED","insertions":216,"deletions":0},{"file":"lib/storage/moray/moray.js","type":"ADDED","insertions":1293,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":160,"deletions":-146},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":138,"deletions":-25},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/lib/moray.js","type":"ADDED","insertions":85,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":30,"deletions":-11},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":73,"deletions":-60},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":184,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":206,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":249,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":240,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":42,"deletions":-39},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":61,"deletions":-47},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":163,"deletions":-158},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":5,"deletions":-6},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":3751,"sizeDeletions":-1846},{"number":"8","revision":"622c8531153dc6a34573e4270544c0d7658bb29d","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/29/629/8","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476946388,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476946428,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":19,"deletions":-6},{"file":"lib/apis/moray.js","type":"DELETED","insertions":0,"deletions":-1036},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":105,"deletions":-38},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":10,"deletions":-8},{"file":"lib/errors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":172,"deletions":0},{"file":"lib/storage/moray/moray-init.js","type":"ADDED","insertions":216,"deletions":0},{"file":"lib/storage/moray/moray.js","type":"ADDED","insertions":1345,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":159,"deletions":-145},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":138,"deletions":-25},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/lib/moray.js","type":"ADDED","insertions":85,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":30,"deletions":-11},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":73,"deletions":-60},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":183,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":205,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":250,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":533,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":42,"deletions":-39},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":61,"deletions":-47},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":163,"deletions":-158},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":5,"deletions":-6},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":4087,"sizeDeletions":-1844},{"number":"9","revision":"20280c7240b4d0620a05f6bbd13a9930d1a8dde6","parents":["af77e72ae7b26f51d4ac3b5cb9484cd8d04b27dc"],"ref":"refs/changes/29/629/9","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1476946772,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1476946800,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"docs/index.md","type":"MODIFIED","insertions":19,"deletions":-6},{"file":"lib/apis/moray.js","type":"DELETED","insertions":0,"deletions":-1036},{"file":"lib/apis/wfapi.js","type":"MODIFIED","insertions":11,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":8,"deletions":-6},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":105,"deletions":-38},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":10,"deletions":-8},{"file":"lib/errors.js","type":"MODIFIED","insertions":25,"deletions":0},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":21,"deletions":-2},{"file":"lib/storage/moray/moray-buckets-config.js","type":"ADDED","insertions":54,"deletions":0},{"file":"lib/storage/moray/moray-buckets-initializer.js","type":"ADDED","insertions":172,"deletions":0},{"file":"lib/storage/moray/moray-init.js","type":"ADDED","insertions":216,"deletions":0},{"file":"lib/storage/moray/moray.js","type":"ADDED","insertions":1345,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":159,"deletions":-145},{"file":"package.json","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"server.js","type":"MODIFIED","insertions":138,"deletions":-25},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/lib/moray.js","type":"ADDED","insertions":85,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":30,"deletions":-11},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":73,"deletions":-60},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":183,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":205,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":250,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":533,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":42,"deletions":-39},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":61,"deletions":-47},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":163,"deletions":-158},{"file":"tools/migrations/add-docker-index.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"tools/npmfreeze.js","type":"DELETED","insertions":0,"deletions":-93},{"file":"tools/perf/profile.js","type":"MODIFIED","insertions":5,"deletions":-6},{"file":"tools/perf/random-load.js","type":"MODIFIED","insertions":3,"deletions":-4}],"sizeInsertions":4088,"sizeDeletions":-1845},{"number":"10","revision":"78e6f547249d49015142e965b58f73645f437565","parents":["590a4e09c0c76093f66f4ff69d6b4fd66de09bb6"],"ref":"refs/changes/29/629/10","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1495234674,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1495234708,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":538,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":103,"deletions":-36},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":298,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":236,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":53,"deletions":-20},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":77,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":31,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":77,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":145,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":186,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":209,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":252,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":31,"deletions":-32},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":30,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3070,"sizeDeletions":-637},{"number":"11","revision":"c61c4c504632edf290344124a87dc5dc7e36211c","parents":["590a4e09c0c76093f66f4ff69d6b4fd66de09bb6"],"ref":"refs/changes/29/629/11","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1496363669,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496363709,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":540,"deletions":-215},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":103,"deletions":-36},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":298,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":237,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":53,"deletions":-20},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":77,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":31,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":77,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":145,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":186,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":209,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":252,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":31,"deletions":-32},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":30,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3073,"sizeDeletions":-638},{"number":"12","revision":"5b0289fdf4929c5c60a16f7aafa2e8c5b81b0873","parents":["65a88b23ac7722c110fd0c70000afcd823916e2b"],"ref":"refs/changes/29/629/12","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1496625414,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496363709,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/apis/moray.js","line":241,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why this instead of a VError with the _lastBucketsSetupError as the cause?"},{"file":"lib/apis/moray.js","line":241,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1053,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This assert is kinda overkill, given the assert.arrayOfObject 7 lines earlier."},{"file":"lib/apis/moray.js","line":1053,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1070,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Error classes should in lib/errors.js, no?"},{"file":"lib/apis/moray.js","line":1070,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1135,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"indentation"},{"file":"lib/apis/moray.js","line":1135,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1143,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Bunyan supports printf-style %s, though this might be preferred:  self.log.info({bucketName: bucketName},\n   \u0027bucket not found, creating it\u0027);"},{"file":"lib/apis/moray.js","line":1143,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1159,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"could be log.debug, then log.info-level only shows more interesting output"},{"file":"lib/apis/moray.js","line":1159,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In that case, I find this being logged at the default loglevel useful, otherwise it\u0027s hard to tell *after the fact* if anything happened: was there no message logged because this code ran and it determined that the bucket didn\u0027t need to be created, or was it for a different reason?"},{"file":"lib/apis/moray.js","line":1210,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"don\u0027t need this `return`"},{"file":"lib/apis/moray.js","line":1210,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1224,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"ditto: could just be log.debug"},{"file":"lib/apis/moray.js","line":1224,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same rationale as above."},{"file":"lib/endpoints/ping.js","line":63,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I kinda think that pingMoray could be inlined here. It isn\u0027t used anywhere else.\n\nAlso, if getMorayConnectivity isn\u0027t going to use the `status` result from `pingMoray`, then `pingMoray` should probably just stop returning a value other than `err`."},{"file":"lib/endpoints/ping.js","line":63,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/moray/moray-buckets-config.js","line":36,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Why \"_MORAY\" in the name for this one and the next, but not for \"VMS_BUCKET_CONFIG\"? The \"_MORAY\" seems redundant."},{"file":"lib/moray/moray-buckets-config.js","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e Why \"_MORAY\" in the name for this one and the next, but not for \"VMS_BUCKET_CONFIG\"?\n\nThat\u0027s leftover from previous patch set(s) when I was trying to signal that these configurations were specific to moray, but we could, at least in the future or when mocking the database layer for running tests, use a different database system.\n\nThis went away with the recent patch sets and so we can drop the \"MORAY\" part. Inconsistency in use of \"MORAY\" is due to the fact that I forgot to update all names."},{"file":"lib/moray/moray-buckets-config.js","line":45,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: should be \"VM_ROLE_TAGS_BUCKET_CONFIG\""},{"file":"lib/moray/moray-buckets-config.js","line":45,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/moray/moray-buckets-config.js","line":58,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Totally fine to ignore this. My preference would be to export either \"VMS\" (all caps because it is basically a constant) or \"VMS_BUCKET_CONFIG\" to have the same variable name for grepping."},{"file":"lib/moray/moray-buckets-config.js","line":58,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Will change to \"VMS\", because that\u0027s used as e.g \"require(\u0027moray-buckets-config\u0027).VMS\", naming it \"VMS_BUCKET_CONFIG seems like it would be redundant."},{"file":"lib/moray/moray-buckets-initializer.js","line":83,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: FWIW, for internal classes (with a limited number of code locations using them), I think it is fine to make a options.log like this *not* optional. Realistically all calling code is going to have a bunyan logger already, so there is little point in making it optional \"for convenience\". It can tighten the code a little bit."},{"file":"lib/moray/moray-buckets-initializer.js","line":83,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Agreed, sounds good."},{"file":"lib/moray/moray-buckets-initializer.js","line":109,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"drop the \" *\""},{"file":"lib/moray/moray-buckets-initializer.js","line":109,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/moray/moray-buckets-initializer.js","line":148,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is it featuritis to have this and \u0027bucket-reindex-done\u0027?\nThe only user is tools/kvm-backfill.js. I suspect that that script is obsolete (do you know otherwise?) and it could perhaps just wait for \"done\", no?"},{"file":"lib/moray/moray-buckets-initializer.js","line":148,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/moray/moray-init.js","line":111,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\u0027maxBucketsReindexAttempts\u0027 and \u0027morayBucketsConfig\u0027 aren\u0027t documented. Also \u0027changefeedPublisher\u0027"},{"file":"lib/moray/moray-init.js","line":111,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/moray/moray-init.js","line":112,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this just options.log now?"},{"file":"lib/moray/moray-init.js","line":112,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, will fix."},{"file":"lib/vmapi.js","line":18,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"AFAICT, this import isn\u0027t used."},{"file":"lib/vmapi.js","line":18,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good catch, will fix!"},{"file":"lib/vmapi.js","line":91,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why attempt to give an abstract \"storage\" name here? Much of VMAPI code is hardcoded to use \"moray\": `req.app.moray`, `req.app.morayBucketsInitializer`, etc."},{"file":"lib/vmapi.js","line":91,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Right, that\u0027s leftover from previous patch sets. Will revert back to the name \"moray\"."},{"file":"lib/vmapi.js","line":129,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Need it be an event emitter?\nI don\u0027t see any https://nodejs.org/docs/latest/api/all.html#events_class_eventemitter API usage on it, though I only looked briefly.\n\nAnyway, you are just renaming here, so don\u0027t change this for this CR."},{"file":"lib/vmapi.js","line":129,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good catch, it used to emit events to forward events emitted by the moray layer. It does not anymore because it\u0027s not driving that process anymore. I will drop that then."},{"file":"package.json","line":31,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Eventually should update to 1.10.0 and start considering changing to https://github.com/joyent/rfd/blob/master/rfd/0041/README.md style stuff. Not for this CR though."},{"file":"package.json","line":31,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"With the latest patch set, I turned some plain Error instances into VError instances per your (great!) suggestion. So if I understand correctly, now I have to use verror.hasCauseWithName to test for the presence of these errors.\n\nThat hasCauseWithName API was added with https://github.com/joyent/node-verror/commit/29b7ce4dc7c4e488b00355db5a41a11496633679, which was releases as 1.9.0.\n\nSo maybe now is a good time to update to at least 1.9.0? I\u0027ll update to the latest version instead.\n\nActually, scratch that, https://github.com/joyent/sdc-vmapi/commit/a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105 on which I just rebased already did it :)"},{"file":"server.js","line":130,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: You could just not pass in an `arg` if it isn\u0027t used."},{"file":"server.js","line":130,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"server.js","line":152,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Probably don\u0027t need the .child here. That is being done inside the startMorayInit function."},{"file":"server.js","line":152,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In startMorayInit, we create child loggers for sub-components like the moray buckets initializer and the moray client. The moray-init logger is created to be used by the moray-init module only.\n\nHowever, currently this module doesn\u0027t log anything directly. So we could drop passing a logger altogether.\n\nThoughts?"},{"file":"server.js","line":152,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"startMorayInit doesn\u0027t log itself, but it *does* use it for child loggers passed to sub-components. I didn\u0027t check of those sub-components log themselves.\n\nThe \u0027component\u0027 field doesn\u0027t chain (tho there is a ticket for that: https://github.com/trentm/node-bunyan/issues/475).\n\nEither way is fine tho."},{"file":"server.js","line":152,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e Either way is fine tho.\n\nI\u0027ll leave it like this for now then."},{"file":"server.js","line":154,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can this not error out? I\u0027d have expected a first `err` arg on the callback."},{"file":"server.js","line":154,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Perhaps it should be \"onMorayStorageInitializ*ing*\"."},{"file":"server.js","line":154,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes. If we still want to keep the callback-style API, I\u0027ll rename it, otherwise this won\u0027t be relevant anymore."},{"file":"server.js","line":154,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It cannot error since connecting to moray with node-moray cannot error (if I understand correctly, it will instead retry indefinitely)\n\nThe idea was we couldn\u0027t have that function just return an object that is equivalent to \"storageSetup\" because we didn\u0027t want to proceed until the moray client connected.\n\nHowever, thinking more about it, we could definitely instead write something like:\n\nvar moraySetup \u003d morayInit.startMorayInit({...});\nmoraySetup.morayClient.on(\u0027connected\u0027, next);\n\nThat seems better, thoughts?"},{"file":"server.js","line":154,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yah, if we\u0027re sure that this can never error, then that form seems a little better."},{"file":"server.js","line":154,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Updated to the new API that I suggested above."},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":106,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"dedent all this one level"},{"file":"test/vms.delete_non_existing_no_workflow.test.js","line":106,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.exits-on-uncaught.test.js","line":25,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is debugging code to remove before commit?"},{"file":"test/vms.exits-on-uncaught.test.js","line":25,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Right, it\u0027s been useful though, so I\u0027ll move that in the t.strictEqual message."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":540,"deletions":-215},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":103,"deletions":-36},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":298,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":237,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":53,"deletions":-20},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":77,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":31,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":77,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":145,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":186,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":209,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":252,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":31,"deletions":-32},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":30,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3073,"sizeDeletions":-638},{"number":"13","revision":"88af6b845152a9b84cace86e43d8f0060d5ae919","parents":["a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105"],"ref":"refs/changes/29/629/13","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1496873770,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496873805,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":555,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":103,"deletions":-36},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":298,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":157,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":53,"deletions":-20},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":53,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":31,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":77,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":145,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":200,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":209,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":252,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":31,"deletions":-32},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":30,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":2996,"sizeDeletions":-636},{"number":"14","revision":"6593196aeb16e60975add0171e650a51e68311d5","parents":["a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105"],"ref":"refs/changes/29/629/14","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1496884805,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496884840,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":547,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":103,"deletions":-47},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":282,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":170,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":48,"deletions":-22},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":53,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":30,"deletions":-9},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":77,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":145,"deletions":-144},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":200,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":209,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":252,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":31,"deletions":-32},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":30,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":2989,"sizeDeletions":-649},{"number":"15","revision":"5e63a6a4e0f8c685830e50e18032de0acc7c57a2","parents":["a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105"],"ref":"refs/changes/29/629/15","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1496960864,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1496960893,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497038441,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":547,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":111,"deletions":-46},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":282,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":170,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":48,"deletions":-22},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-21},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":53,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":30,"deletions":-9},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":77,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":145,"deletions":-144},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"ADDED","insertions":292,"deletions":0},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":200,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":209,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":252,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":33,"deletions":-34},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":30,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3291,"sizeDeletions":-650},{"number":"16","revision":"b4015ddcbe539fa52289288be556da803cc5f43d","parents":["a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105"],"ref":"refs/changes/29/629/16","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1497047344,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497047373,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497048122,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1497048122,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":547,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":111,"deletions":-46},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":282,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":163,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":48,"deletions":-22},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-22},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":53,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":75,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"ADDED","insertions":288,"deletions":0},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":198,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":205,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":248,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":544,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":40,"deletions":-38},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":31,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3269,"sizeDeletions":-656},{"number":"17","revision":"a4f4c8f63a2d8be592bd2275ee010c249e7eb48a","parents":["a4d0bc5d1fadf3aecc7abd3ba94ba543146d4105"],"ref":"refs/changes/29/629/17","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1497050753,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1497047373,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1497048122,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1497048122,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1497050825,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":31,"deletions":-6},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":547,"deletions":-214},{"file":"lib/changefeed.js","fileOld":"test/lib/changefeed.js","type":"RENAMED","insertions":7,"deletions":0},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":111,"deletions":-46},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":36,"deletions":-1},{"file":"lib/interceptors.js","type":"MODIFIED","insertions":26,"deletions":-2},{"file":"lib/moray/moray-buckets-config.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/moray/moray-buckets-initializer.js","type":"ADDED","insertions":282,"deletions":0},{"file":"lib/moray/moray-init.js","type":"ADDED","insertions":163,"deletions":0},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":48,"deletions":-22},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":43,"deletions":-22},{"file":"test/common.js","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":16,"deletions":-31},{"file":"test/lib/moray.js","type":"MODIFIED","insertions":53,"deletions":-9},{"file":"test/vms.delete_non_existing_no_workflow.test.js","type":"MODIFIED","insertions":28,"deletions":-10},{"file":"test/vms.exits-on-uncaught.test.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/vms.list.test.js","type":"MODIFIED","insertions":75,"deletions":-61},{"file":"test/vms.marker.test.js","type":"MODIFIED","insertions":143,"deletions":-144},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"ADDED","insertions":288,"deletions":0},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"ADDED","insertions":198,"deletions":0},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"ADDED","insertions":205,"deletions":0},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"ADDED","insertions":248,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"ADDED","insertions":544,"deletions":0},{"file":"tools/add-test-vms.js","type":"MODIFIED","insertions":40,"deletions":-38},{"file":"tools/fix-no-owner.js","type":"MODIFIED","insertions":31,"deletions":-28},{"file":"tools/kvm-backfill.js","type":"MODIFIED","insertions":24,"deletions":-7}],"sizeInsertions":3269,"sizeDeletions":-656}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Richard Kiene","email":"richard.kiene@joyent.com","username":"richardkiene"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}