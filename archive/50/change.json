{"project":"joyent/sdc-scripts","branch":"master","id":"I17fc5c8b83623078388b00260e5ad4be4f7348ac","number":"50","subject":"HEAD-2308 download_metadata should retry fetch from SAPI on failure HEAD-2310 common RBAC setup should create \"prof_attr.d\" if missing HEAD-2311 sdc-scripts bootstrap shell library must tolerate \"errexit\", etc Reviewed by: Alex Wilson \u003calex.wilson@joyent.","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/50","commitMessage":"HEAD-2308 download_metadata should retry fetch from SAPI on failure\nHEAD-2310 common RBAC setup should create \"prof_attr.d\" if missing\nHEAD-2311 sdc-scripts bootstrap shell library must tolerate \"errexit\", etc\nReviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e\nReviewed by: Dave Eddy \u003cdave.eddy@joyent.com\u003e\n","createdOn":1468214314,"lastUpdated":1468874763,"open":false,"status":"MERGED","comments":[{"timestamp":1468214314,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1468214633,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1468214872,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1468281273,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(3 comments)\n\nJust a few questions"},{"timestamp":1468304852,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4."},{"timestamp":1468305600,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(3 comments)\n\nI have, hopefully, addressed your comments, Alex."},{"timestamp":1468307580,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1468362668,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(13 comments)\n\ncomments in util.sh"},{"timestamp":1468389009,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(10 comments)"},{"timestamp":1468389021,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5."},{"timestamp":1468525215,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1468569725,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5:\n\nHey Dave, Alex:\n\nAre you both satisfied with this one, now?  (Can I get some +1s?)"},{"timestamp":1468627840,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1468858132,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5: Code-Review+2"},{"timestamp":1468874763,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"5","revision":"17fc5c8b83623078388b00260e5ad4be4f7348ac","parents":["6db4018c4db1e86aa14c6a0d4d1e7e50faaeeb4b"],"ref":"refs/changes/50/50/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1468389021,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468627840,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468858132,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"SUBM","value":"1","grantedOn":1468874763,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"etc/security/exec_attr.d/mdata","type":"ADDED","insertions":14,"deletions":0},{"file":"etc/security/prof_attr.d/mdata","type":"ADDED","insertions":12,"deletions":0},{"file":"lib/setup_config_agent.js","type":"ADDED","insertions":155,"deletions":0},{"file":"lib/util.sh","type":"MODIFIED","insertions":541,"deletions":-179},{"file":"smf/manifests/rbac.xml","type":"ADDED","insertions":105,"deletions":0}],"sizeInsertions":827,"sizeDeletions":-179},"patchSets":[{"number":"1","revision":"432a4a3ea547ca463b91f3bb22ff61b1f3a795af","parents":["6db4018c4db1e86aa14c6a0d4d1e7e50faaeeb4b"],"ref":"refs/changes/50/50/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1468214314,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"etc/security/exec_attr.d/mdata","type":"ADDED","insertions":14,"deletions":0},{"file":"etc/security/prof_attr.d/mdata","type":"ADDED","insertions":12,"deletions":0},{"file":"lib/util.sh","type":"MODIFIED","insertions":532,"deletions":-179}],"sizeInsertions":558,"sizeDeletions":-179},{"number":"2","revision":"eb4d42c66cb6bf3e0a3a00b982eff6eada2dde0b","parents":["6db4018c4db1e86aa14c6a0d4d1e7e50faaeeb4b"],"ref":"refs/changes/50/50/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1468214633,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"etc/security/exec_attr.d/mdata","type":"ADDED","insertions":14,"deletions":0},{"file":"etc/security/prof_attr.d/mdata","type":"ADDED","insertions":12,"deletions":0},{"file":"lib/util.sh","type":"MODIFIED","insertions":532,"deletions":-179},{"file":"smf/manifests/rbac.xml","type":"ADDED","insertions":105,"deletions":0}],"sizeInsertions":663,"sizeDeletions":-179},{"number":"3","revision":"d2fa43fd1764e4b4aa2f9aa3036d74a3ee08479e","parents":["6db4018c4db1e86aa14c6a0d4d1e7e50faaeeb4b"],"ref":"refs/changes/50/50/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1468214872,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/util.sh","line":340,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Why do we have this here, instead of just failing when we don\u0027t have a sapi-url metadata key? What situation was this meant to handle? Any ideas?"},{"file":"lib/util.sh","line":340,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This appears to have been a part of fixing TOOLS-794.  It seems that this is to allow for some service zones (e.g. \"nat\") that legitimately do not get attached to the \"admin\" network."},{"file":"lib/util.sh","line":583,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Should this be /usr/bin/crontab?"},{"file":"lib/util.sh","line":583,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, thanks."},{"file":"lib/util.sh","line":674,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Maybe note what we do differently when it\u0027s set to true (is it only skipping config-agent setup?)"},{"file":"lib/util.sh","line":674,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I believe this only really has an effect if we are in an instance of the \"sapi\" service.  If it _is_ \"sapi\", and we\u0027re in the proto mode, we appear to avoid doing anything that depends on SAPI being available -- as it presumably is not, at this early stage.  I\u0027ll try and flesh it out a bit."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"etc/security/exec_attr.d/mdata","type":"ADDED","insertions":14,"deletions":0},{"file":"etc/security/prof_attr.d/mdata","type":"ADDED","insertions":12,"deletions":0},{"file":"lib/util.sh","type":"MODIFIED","insertions":532,"deletions":-179},{"file":"smf/manifests/rbac.xml","type":"ADDED","insertions":105,"deletions":0}],"sizeInsertions":663,"sizeDeletions":-179},{"number":"4","revision":"18ab05ed12e800f9f6093c7deca8aa0723e2f529","parents":["6db4018c4db1e86aa14c6a0d4d1e7e50faaeeb4b"],"ref":"refs/changes/50/50/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1468304852,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468307580,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"comments":[{"file":"lib/util.sh","line":61,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So, this becomes really tricky here.  Assuming you call this function like this:\n\n\n    value\u003d$(_sdc_mdata_get \u0027foo\u0027)\n\n\n... will NOT exit the program on a failure or empty string.  The `$()` construct invokes a subshell, so calling exit inside of it is the same as calling return... it will only result in the subshell being terminated, and not the calling program.\n\nUnfortunately, I don\u0027t know a good pattern to deal with this situation."},{"file":"lib/util.sh","line":61,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"That\u0027s deeply unfortunate.  It\u0027s a shame that there\u0027s no equivalent of exit(3C).  I suppose I\u0027ll need to change it all to use explicit returns and checks all the way down."},{"file":"lib/util.sh","line":61,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I agree.  I asked in the bash IRC a while back about this and, while there were a couple suggestions, none of them really worked in a sane/predictable way."},{"file":"lib/util.sh","line":66,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"The parameter expansion here is meaningless.  The \"${1:-\u003cfoo\u003e}\" construct says to use $1 if it set and not the empty string, otherwise use  \"\u003cfoo\u003e\".  However, in this specific situation, \"\u003cfoo\u003e\" is empty... so this is already the default behavior.  Suggested change:\n\n\n    local md_key\u003d$1"},{"file":"lib/util.sh","line":66,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"So I do this to be safe against usage of the \"nounset\" shell option.  If an argument is not passed, then $1 is not set, and the program aborts before I get to use \"[[ -z\" on it."},{"file":"lib/util.sh","line":66,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"ah ok, that makes sense, thanks."},{"file":"lib/util.sh","line":88,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Same as above, I\u0027m not sure what the intent is here.  I won\u0027t comment on every repeated instance."},{"file":"lib/util.sh","line":94,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"consider adding a \"_sdc_debug\" function or similar to wrap this functionality as it appears multiple time in the code... it\u0027s usage could be similar to that of \"warn\""},{"file":"lib/util.sh","line":104,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Consider using a bash array to manage programatic argument managing\n\n\n     local flags\u003d()"},{"file":"lib/util.sh","line":104,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/util.sh","line":111,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Append to the array\n\n\nflags+\u003d(-s)"},{"file":"lib/util.sh","line":111,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/util.sh","line":117,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Use the array now... this will avoid any potential word splitting and other shell logic.\n\n\n    if ! /usr/sbin/svcadm enable \"${flags[@]}\" \"$1\"; then"},{"file":"lib/util.sh","line":117,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/util.sh","line":163,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"It may be worth it to check the exit status of this command as well, since bash redirection can fail for many reasons (file can\u0027t be created, permissions, etc.)\n\n\n    $ printf \u0027%s\u0027 foo \u003e /.dcinfo\n    -bash: /.dcinfo: Permission denied\n    $ echo $?\n    1"},{"file":"lib/util.sh","line":163,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/util.sh","line":239,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"So, in the past I\u0027ve done this:\n\n\n    $ node /dev/stdin foo bar baz \u003c\u003c-EOF\n    \u003e console.log(process.argv)\n    \u003e EOF\n    [ \u0027node\u0027, \u0027/dev/stdin\u0027, \u0027foo\u0027, \u0027bar\u0027, \u0027baz\u0027 ]\n\n\nSo, in a script it would be:\n\n\n    \"$node\" /dev/stdin arg1 arg2 \u003c\u003c-\"EOF\"\n    // node code here with full use of double quotes, single quotes,\n    // and $ symbols without any bash interpolation\n    EOF\n    if (($? !\u003d 0)); then\n        # something failed\n    fi\n\n\nI prefer this form because it allows you to not have to worry about quoting or bash special characters in the node code itself."},{"file":"lib/util.sh","line":239,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ve fixed this whole thing by moving the Javascript into a separate file."},{"file":"lib/util.sh","line":239,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"perfect"},{"file":"lib/util.sh","line":366,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"From personal experience, I have seen curl hang indefinitely if the server is malfunctioning.  I\u0027d prefer to have some sort of global timeout for curl, that can be wrapped in a function... such as\n\n    _sdc_curl() {\n        local timeout\u003d300\n        curl -m \"$timeout\" \"$@\"\n    }"},{"file":"lib/util.sh","line":366,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"OK, I will add a wrapper with a connect timeout and a maximum request duration."},{"file":"lib/util.sh","line":408,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"just making sure: this function should be successful if the base directory does not exist?"},{"file":"lib/util.sh","line":408,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, it is (as I understand it) to allow for \"config-agent\" to optional in images."},{"file":"lib/util.sh","line":534,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"bash can do this way faster than grep\n\n\n    re\u003d\u0027[_ ]\u0027\n    if [[ $name \u003d~ $re ]]; then\n        fatal ...\n    fi\n\n\n\"re\" must be defined as a variable and used without quotes inside the [[ ... ]] construct."},{"file":"lib/util.sh","line":534,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"lib/util.sh","line":697,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I realize you are only modifying what is already here, but these if statements could be condensed down to reduce the indentation level"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"etc/security/exec_attr.d/mdata","type":"ADDED","insertions":14,"deletions":0},{"file":"etc/security/prof_attr.d/mdata","type":"ADDED","insertions":12,"deletions":0},{"file":"lib/util.sh","type":"MODIFIED","insertions":541,"deletions":-179},{"file":"smf/manifests/rbac.xml","type":"ADDED","insertions":105,"deletions":0}],"sizeInsertions":672,"sizeDeletions":-179},{"number":"5","revision":"17fc5c8b83623078388b00260e5ad4be4f7348ac","parents":["6db4018c4db1e86aa14c6a0d4d1e7e50faaeeb4b"],"ref":"refs/changes/50/50/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1468389021,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468627840,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1468874763,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468858132,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"etc/security/exec_attr.d/mdata","type":"ADDED","insertions":14,"deletions":0},{"file":"etc/security/prof_attr.d/mdata","type":"ADDED","insertions":12,"deletions":0},{"file":"lib/setup_config_agent.js","type":"ADDED","insertions":155,"deletions":0},{"file":"lib/util.sh","type":"MODIFIED","insertions":541,"deletions":-179},{"file":"smf/manifests/rbac.xml","type":"ADDED","insertions":105,"deletions":0}],"sizeInsertions":827,"sizeDeletions":-179}],"allReviewers":[{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}