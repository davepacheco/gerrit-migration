From 4bd286ac784b6cd715d8a6c65edd9e947357a7cd Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 19 Aug 2019 11:25:51 -0700
Subject: [PATCH] TRITON-1871 vmapi migration test fail when using uuid
 override

---
 lib/workflows/vm-migration/rollback.js | 6 ++----
 package.json                           | 2 +-
 test/lib/migration.js                  | 8 ++++----
 3 files changed, 7 insertions(+), 9 deletions(-)

diff --git a/lib/workflows/vm-migration/rollback.js b/lib/workflows/vm-migration/rollback.js
index a9f59b7..864fe47 100644
--- a/lib/workflows/vm-migration/rollback.js
+++ b/lib/workflows/vm-migration/rollback.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 
@@ -50,8 +50,6 @@ function stopTargetVm(job, cb) {
 
     assert.uuid(record.target_server_uuid, 'record.target_server_uuid');
     assert.uuid(record.target_vm_uuid, 'record.target_vm_uuid');
-    assert.equal(job.params.vm_uuid, record.target_vm_uuid,
-        'job.params.vm_uuid should be the same as record.target_vm_uuid');
 
     job.workflow_job_uuid = null;
 
@@ -126,7 +124,7 @@ function stopTargetVm(job, cb) {
                 headers: {'x-request-id': job.params['x-request-id']},
                 url: vmapiUrl
             });
-            vmapi.stopVm({uuid: job.params.vm_uuid}, function (err, body) {
+            vmapi.stopVm({uuid: record.target_vm_uuid}, function (err, body) {
                 if (err) {
                     next(err);
                     return;
diff --git a/package.json b/package.json
index 5f5efe5..d5d1ec1 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.8.15",
+  "version": "9.8.16",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
diff --git a/test/lib/migration.js b/test/lib/migration.js
index 612825e..9cfd90f 100644
--- a/test/lib/migration.js
+++ b/test/lib/migration.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var stream = require('stream');
@@ -1278,7 +1278,7 @@ function TestMigrationCfg(test, cfg) {
         // migration is finalized.
         client.post({
             path: format('/vms/%s?action=migrate&migration_action=begin',
-                targetVm.uuid)
+                sourceVm.uuid)
         }, function onMigrateBeginFromStateSuccessCb(err) {
             t.ok(err,
                 'expect an error for migration begin when a previous ' +
@@ -1300,7 +1300,7 @@ function TestMigrationCfg(test, cfg) {
 
         client.post({
             path: format('/vms/%s?action=migrate&migration_action=finalize',
-                targetVm.uuid)
+                sourceVm.uuid)
         }, function onMigrateFinalizeCb(err, req, res) {
             common.ifError(t, err, 'no error from migration finalize call');
             if (!err) {
@@ -1569,7 +1569,7 @@ function TestMigrationCfg(test, cfg) {
 
         client.post({
             path: format('/vms/%s?action=migrate&migration_action=rollback',
-                targetVm.uuid)
+                sourceVm.uuid)
         }, function onMigrateRollbackCb(err, req, res, body) {
             common.ifError(t, err, 'no error from migration rollback call');
             if (!err) {
-- 
2.21.0

