From 8869ab46acd4128cfe75d32de052d402d256069c Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 27 Feb 2017 17:41:55 -0800
Subject: [PATCH] joyent/node-cueball#101 want "connectionHandlesError" option
 for moray

---
 CHANGES.adoc          | 10 ++++++++++
 docs/api.adoc         |  5 +++++
 lib/connection-fsm.js |  7 ++++++-
 lib/set.js            |  5 +++++
 package.json          |  2 +-
 5 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/CHANGES.adoc b/CHANGES.adoc
index d92829d..d155fa3 100644
--- a/CHANGES.adoc
+++ b/CHANGES.adoc
@@ -6,6 +6,16 @@ toc::[]
 
 ## v2.x
 
+### v2.2.0
+
+New minor release, due to addition of new API.
+
+API changes:
+
+ - Users of `ConnectionSet` can now supply the option `connectionHandlesError`
+   to avoid the need to add a no-op `"error"` handler when using a `constructor`
+   that already handles errors.
+
 ### v2.1.1
 
 Maintenance release.
diff --git a/docs/api.adoc b/docs/api.adoc
index 7aa2f66..69f92a5 100644
--- a/docs/api.adoc
+++ b/docs/api.adoc
@@ -648,6 +648,11 @@ Parameters
                   Note that this number may temporarily be exceeded by 1 socket
                   to allow the set to re-balance.
    * `log` -- optional Object, a `bunyan`-style logger to use
+   * `connectionHandlesError` -- optional Boolean (default `false`). If `true`,
+                                 cueball assumes that the connection object (the
+                                 instance returned from `constructor`) handles
+                                 `"error"` events internally and the emission of
+                                 this event is for cueball's information only.
 
 ### `->added(key, connection, handle)`
 
diff --git a/lib/connection-fsm.js b/lib/connection-fsm.js
index dbeeb0d..2b776fd 100644
--- a/lib/connection-fsm.js
+++ b/lib/connection-fsm.js
@@ -474,6 +474,11 @@ function CueBallClaimHandle(options) {
 	mod_assert.object(options.pool, 'options.pool');
 	this.ch_pool = options.pool;
 
+	mod_assert.optionalBool(options.throwError, 'options.throwError');
+	this.ch_throwError = options.throwError;
+	if (options.throwError === undefined || options.throwError === null)
+		this.ch_throwError = true;
+
 	mod_assert.string(options.claimStack, 'options.claimStack');
 	this.ch_claimStack = options.claimStack.split('\n').slice(1).
 	    map(function (l) { return (l.replace(/^[ ]*at /, '')); });
@@ -628,7 +633,7 @@ CueBallClaimHandle.prototype.state_claimed = function (S) {
 
 	S.on(this.ch_connection, 'error', function clHandleErrorListener(err) {
 		var count = countListeners(self.ch_connection, 'error');
-		if (count === 0) {
+		if (count === 0 && self.ch_throwError) {
 			/*
 			 * Our end-user never set up an 'error' event listener
 			 * and the socket emitted 'error'. We want to act like
diff --git a/lib/set.js b/lib/set.js
index 2ff0e2a..4775484 100644
--- a/lib/set.js
+++ b/lib/set.js
@@ -46,6 +46,10 @@ function CueBallConnectionSet(options) {
 	mod_utils.assertRecoverySet(options.recovery);
 	this.cs_recovery = options.recovery;
 
+	mod_assert.optionalBool(options.connectionHandlesError,
+	    'options.connectionHandlesError');
+	this.cs_connHandlesErr = !!(options.connectionHandlesError);
+
 	mod_assert.optionalObject(options.log, 'options.log');
 	this.cs_log = options.log || mod_bunyan.createLogger({
 		name: 'cueball'
@@ -674,6 +678,7 @@ LogicalConnection.prototype.state_init = function (S) {
 		    ' at CueBallConnectionSet.addConnection',
 		callback: S.callback(onClaimed),
 		log: this.lc_log,
+		throwError: !(this.lc_set.cs_connHandlesErr),
 		claimTimeout: Infinity
 	};
 	this.lc_hdl = new CueBallClaimHandle(hdlOpts);
diff --git a/package.json b/package.json
index d526295..d5523c4 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "cueball",
-  "version": "2.1.1",
+  "version": "2.2.0",
   "description": "manage a pool of connections to a multi-node service where nodes are listed in DNS",
   "main": "lib/index.js",
   "dependencies": {
-- 
2.21.0

