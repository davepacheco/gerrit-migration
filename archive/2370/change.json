{"project":"joyent/illumos-joyent","branch":"master","id":"I7c9cf15db394630449591dfb9e3186a6908030bd","number":"2370","subject":"OS-5725 allow swap to be \"disabled\" in LX Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2370","commitMessage":"OS-5725 allow swap to be \"disabled\" in LX\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1502370141,"lastUpdated":1502472787,"open":false,"status":"MERGED","comments":[{"timestamp":1502370141,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1502379556,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1502385575,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1502385584,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1502429447,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1502453150,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nI tested this with cassandra using the new service I described in the ticket. I also ran LTP and did manual testing by turning swap on/off and checking the data in the two /proc files."},{"timestamp":1502472023,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1502472646,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1502472705,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1502472787,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"4","revision":"7c9cf15db394630449591dfb9e3186a6908030bd","parents":["35d5f63341902524053682b3ec36ff1d269932b6"],"ref":"refs/changes/70/2370/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1502472705,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502429447,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1502472023,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1502472787,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":40,"deletions":-19},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":64,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-25},"patchSets":[{"number":"1","revision":"5346b71c75082ee0aae0956028ea517d7bd9b901","parents":["89420cc6448331a712735c3624e5282875879a7d"],"ref":"refs/changes/70/2370/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1502370141,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","line":77,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Hooray"},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":4345,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Is this necessary?  LXPTOZ() should always emit the branded non-global zone."},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":4345,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":4373,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe we make this a brand-wide define and use it to compare against the paths passed into swapon/swapoff?"},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","line":4373,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"If we do that I will have to disable those LTP tests again. Realistically, I don\u0027t think we need to go that far in the syscall emulation. This whole thing is really just to provide a way to turn the /proc visibility for swap on and off and is not an attempt to get a full emulation for swap management."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","line":474,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Could be lazy and use curzone if you want."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","line":474,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","line":477,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"These manipulations should probably be synchronized with lxzd_lock."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","line":477,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should we be checking here (and in swapon) if the swap state is already set as desired?  (Preventing repeated disable or enable)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","line":477,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I\u0027m not sure what that would buy us, given the intent for this emulation. Certainly with LTP, which is messing with multiple swap \"devices\", we would have to be a lot more sophisticated, but like I said, I don\u0027t see a benefit to doing this."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","line":477,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I don\u0027t see why that is necessary."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":46,"deletions":-16},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":64,"deletions":0}],"sizeInsertions":117,"sizeDeletions":-22},{"number":"2","revision":"663aad1d3c7398ec4598772dc9a8f16dc43afe1f","parents":["89420cc6448331a712735c3624e5282875879a7d"],"ref":"refs/changes/70/2370/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1502385584,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502429447,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1502472023,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":40,"deletions":-19},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":64,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-25},{"number":"3","revision":"690137e1fefdb30d910f241c67a25381661aadf0","parents":["35d5f63341902524053682b3ec36ff1d269932b6"],"ref":"refs/changes/70/2370/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1502472646,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502429447,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1502472023,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":40,"deletions":-19},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":64,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-25},{"number":"4","revision":"7c9cf15db394630449591dfb9e3186a6908030bd","parents":["35d5f63341902524053682b3ec36ff1d269932b6"],"ref":"refs/changes/70/2370/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1502472705,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1502472787,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502429447,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1502472023,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"usr/src/uts/common/brand/lx/procfs/lx_prvnops.c","type":"MODIFIED","insertions":40,"deletions":-19},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":64,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-25}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}