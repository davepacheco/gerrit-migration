{"project":"joyent/illumos-joyent","branch":"master","id":"I8e13cb0cf6db47c055c50e017b0c73894b277112","number":"3744","subject":"OS-6858 vmm tracing framework is dead code Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/3744","commitMessage":"OS-6858 vmm tracing framework is dead code\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1522442464,"lastUpdated":1522777481,"open":false,"status":"MERGED","comments":[{"timestamp":1522442464,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1522444214,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1522691784,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522768429,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522768795,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1522769353,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1522769409,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)\n\n[root@buglets ~]# grep HVM /var/adm/messages\n2018-04-03T15:26:51.871799+00:00 buglets unix: [ID 141716 kern.warning] WARNING: zone \u0027bea9fe7d-2a04-c98f-d469-d35e38d569f4\u0027 cannot take HVM exclusion lock as \u0027SmartOS KVM\u0027: held by \u0027bhyve\u0027\n2018-04-03T15:27:45.259974+00:00 buglets unix: [ID 141716 kern.warning] WARNING: zone \u0027ffbba7da-2278-60a4-d514-9329b141f8ec\u0027 cannot take HVM exclusion lock as \u0027bhyve\u0027: held by \u0027SmartOS KVM\u0027"},{"timestamp":1522769428,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\ndoh, wrong CR for last comment."},{"timestamp":1522769566,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1522769809,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1522776700,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1\n\nThe rebase included in the latest patch set was throwing me off, but once I re-reviewed the entire base change, this looks fine."},{"timestamp":1522777262,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\nTesting: builds cleanly (debug, non-debug), bhyve still works."},{"timestamp":1522777300,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1522777451,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Commit message was updated."},{"timestamp":1522777460,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1522777481,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"5","revision":"7ab3f5348d729755d5a5fe1c679174b62ec4861e","parents":["8098ab85dc79c5d039404142c4182f341a23ac0c"],"ref":"refs/changes/44/3744/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522777460,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769809,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522776700,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522777300,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1522777481,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/Makefile","type":"DELETED","insertions":0,"deletions":-21},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/amd64/Makefile","type":"DELETED","insertions":0,"deletions":-35},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/vmm.c","type":"DELETED","insertions":0,"deletions":-237},{"file":"usr/src/pkg/manifests/system-bhyve.mf","type":"MODIFIED","insertions":0,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":0,"deletions":-175},{"file":"usr/src/uts/i86pc/sys/vmm_dev.h","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":0,"deletions":-33}],"sizeInsertions":2,"sizeDeletions":-518},"patchSets":[{"number":"1","revision":"ace0fc5e77c7efee8f84e62f90922265d6ad1fc6","parents":["b409c9a314a881a4aa643e85cd5494af77fa4488"],"ref":"refs/changes/44/3744/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522442464,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522444214,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":100,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe just fold these into the vmm_mod_load/unload functions in vmm.c?  They\u0027re already behind an ifdef and custom to us."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":100,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"vmmdev_list is declared as static in vmm_sol_dev.c, which seems to be reasonable. That means the content of vmmdev_cleanup() is probably not a good candidate for moving.  In the interest of symmetry, if vmmdev_cleanup() stays put, vmmdev_init() probably should too.\n\nI can be swayed to take a different approach - just sharing what I found as I went off to do what you asked."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":100,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The VERIFY is really a belt-and-suspenders thing since it\u0027s called via vmmdev_mod_decr -\u003e vmm_mod_unload, where vmmdev_inst_count is already checked to be zero.  If it were me, I would nix both functions.  (And if you wanted to keep the VERIFY, toss it in vmm_mod_decr."},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":100,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/Makefile","type":"DELETED","insertions":0,"deletions":-21},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/amd64/Makefile","type":"DELETED","insertions":0,"deletions":-35},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/vmm.c","type":"DELETED","insertions":0,"deletions":-237},{"file":"usr/src/pkg/manifests/system-bhyve.mf","type":"MODIFIED","insertions":0,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":0,"deletions":-163},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":0,"deletions":-33}],"sizeInsertions":2,"sizeDeletions":-499},{"number":"2","revision":"9d8dd844d1a9661f34547fd55f48811dc5fd8c9e","parents":["d5eb108ff4a94b03a014e90e6213bf7bf4faa374"],"ref":"refs/changes/44/3744/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522769353,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/os/pc_hvm.c","type":"MODIFIED","insertions":10,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"3","revision":"8e13cb0cf6db47c055c50e017b0c73894b277112","parents":["b409c9a314a881a4aa643e85cd5494af77fa4488"],"ref":"refs/changes/44/3744/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522769566,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522776700,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769809,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522777300,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/Makefile","type":"DELETED","insertions":0,"deletions":-21},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/amd64/Makefile","type":"DELETED","insertions":0,"deletions":-35},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/vmm.c","type":"DELETED","insertions":0,"deletions":-237},{"file":"usr/src/pkg/manifests/system-bhyve.mf","type":"MODIFIED","insertions":0,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":0,"deletions":-175},{"file":"usr/src/uts/i86pc/sys/vmm_dev.h","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":0,"deletions":-33}],"sizeInsertions":2,"sizeDeletions":-518},{"number":"4","revision":"2df3d3b6eb756e7f8ba3a61c33ae6fb9e1fe795b","parents":["b409c9a314a881a4aa643e85cd5494af77fa4488"],"ref":"refs/changes/44/3744/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522777451,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522776700,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769809,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522777300,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/Makefile","type":"DELETED","insertions":0,"deletions":-21},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/amd64/Makefile","type":"DELETED","insertions":0,"deletions":-35},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/vmm.c","type":"DELETED","insertions":0,"deletions":-237},{"file":"usr/src/pkg/manifests/system-bhyve.mf","type":"MODIFIED","insertions":0,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":0,"deletions":-175},{"file":"usr/src/uts/i86pc/sys/vmm_dev.h","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":0,"deletions":-33}],"sizeInsertions":2,"sizeDeletions":-518},{"number":"5","revision":"7ab3f5348d729755d5a5fe1c679174b62ec4861e","parents":["8098ab85dc79c5d039404142c4182f341a23ac0c"],"ref":"refs/changes/44/3744/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1522777460,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522776700,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1522769809,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1522777300,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1522777481,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/cmd/mdb/intel/amd64/Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/Makefile","type":"DELETED","insertions":0,"deletions":-21},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/amd64/Makefile","type":"DELETED","insertions":0,"deletions":-35},{"file":"usr/src/cmd/mdb/intel/amd64/vmm/vmm.c","type":"DELETED","insertions":0,"deletions":-237},{"file":"usr/src/pkg/manifests/system-bhyve.mf","type":"MODIFIED","insertions":0,"deletions":-7},{"file":"usr/src/uts/i86pc/io/vmm/vmm.c","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":0,"deletions":-175},{"file":"usr/src/uts/i86pc/sys/vmm_dev.h","type":"MODIFIED","insertions":0,"deletions":-5},{"file":"usr/src/uts/i86pc/sys/vmm_impl.h","type":"MODIFIED","insertions":0,"deletions":-33}],"sizeInsertions":2,"sizeDeletions":-518}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}