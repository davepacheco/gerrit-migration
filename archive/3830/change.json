{"project":"joyent/manta-muskie","branch":"master","id":"Ib0bff3202f25949a529a19e5c982e040d0505350","number":"3830","subject":"MANTA-2909 muskie logs incorrect bytesTransferred for some failed, streaming uploads Reviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e Reviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e Approved by: Kody A Kantor \u003ckody.kantor@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/3830","commitMessage":"MANTA-2909 muskie logs incorrect bytesTransferred for some failed, streaming uploads\nReviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\nReviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\nApproved by: Kody A Kantor \u003ckody.kantor@joyent.com\u003e\n","createdOn":1523987833,"lastUpdated":1524113860,"open":false,"status":"MERGED","comments":[{"timestamp":1523987833,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1523989132,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 1: Code-Review+1\n\nThis looks good to me, thanks for adding that comment. For IA we should show that the log message contains a reasonable value for bytesTransferred when the request is abandoned in next_err. Ideally we could show the abandon log message in the function itself in addition to the appropriate audit log."},{"timestamp":1523994117,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n\u003e This looks good to me, thanks for adding that comment. For IA we\n \u003e should show that the log message contains a reasonable value for\n \u003e bytesTransferred when the request is abandoned in next_err. Ideally\n \u003e we could show the abandon log message in the function itself in\n \u003e addition to the appropriate audit log.\n\nThanks for the feedback -- sounds good.  So would setting a breakpoint in next_err and examining that value (check.bytes), then lining it up with resulting logging statement be satisfactory?"},{"timestamp":1523996741,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1524086716,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1524088276,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1524088576,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1524090981,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 1: Integration-Approval+1\n\nThe make-check bot doesn\u0027t seem to be running, but Robert assured me that both \u0027make check\u0027 and \u0027make test\u0027 come out fine."},{"timestamp":1524113790,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1524113860,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"2","revision":"b0bff3202f25949a529a19e5c982e040d0505350","parents":["9261933081e5af4f693cda5c9b8c32a51bab78e9"],"ref":"refs/changes/30/3830/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1524113790,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523989132,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524088576,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524090981,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1524113860,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":10,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"69ae5d9e44056a953e33dcd307ce8882dd7da426","parents":["9261933081e5af4f693cda5c9b8c32a51bab78e9"],"ref":"refs/changes/30/3830/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1523987833,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524088576,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524090981,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523989132,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"comments":[{"file":"lib/obj.js","line":464,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"What do you think of recording this in a new field? It seems like the `_size` field is used elsewhere in the code and might be overloaded."},{"file":"lib/obj.js","line":464,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"My primary concern with adding yet another property to `req\u0027 is that when the time comes to perform the logging, we\u0027ll have to decide which of the two properties to use now: req._size on success (that\u0027s what we appear to currently do in audit.js), or the prospective new member on failure.\n\nIn my opinion, there should be a single member dedicated to indicating the total number of bytes transferred over the course of the operation, regardless of success or failure.  If you\u0027d like me to add a new member, I can do that -- I\u0027d just prefer a single source of truth for this purpose."},{"file":"lib/obj.js","line":464,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"There is a member of req (`req._totalBytes\u0027) and incidentally, its value also comes from `check.bytes\u0027.  At the outset, this seems more appropriate if there are no objections.  In the future, I think it would be ideal consolidate things like `req._size\u0027 and `req._totalBytes\u0027 if possible, but I recognize that that might be considered beyond the scope of this CR."},{"file":"lib/obj.js","line":464,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Sure, that makes sense. I probably should have been clearer -- I meant that we would use the same field for both success and failure (and that would mean it needs to be set on success elsewhere in muskie).\n\nLooking at the code again, it looks like we already have a pattern of overwriting req._size with the actual bytes streamed (https://github.com/joyent/manta-muskie/blob/master/lib/obj.js#L585). So I suppose it\u0027s fine to be consistent with that.\n\nThanks for thinking it through with me!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":10,"sizeDeletions":0},{"number":"2","revision":"b0bff3202f25949a529a19e5c982e040d0505350","parents":["9261933081e5af4f693cda5c9b8c32a51bab78e9"],"ref":"refs/changes/30/3830/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1524113790,"author":{"name":"Robert Bogart","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524088576,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1524090981,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1523989132,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"SUBM","value":"1","grantedOn":1524113860,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":10,"sizeDeletions":0}],"allReviewers":[{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}