From 41d7e9e6024019ffc49e922e9004858b2dc4456e Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Thu, 11 Apr 2019 10:50:42 -0700
Subject: [PATCH] OS-7732 more cases where vm tests are creating VMs without
 cpu_caps which can break DAPI-using tests

---
 src/img/test/create.test.js     | 1 +
 src/img/test/mk-custom-image    | 1 +
 src/img/test/try-custom-image   | 1 +
 src/vm/tests/test-blocksizes.js | 4 ++++
 4 files changed, 7 insertions(+)

diff --git a/src/img/test/create.test.js b/src/img/test/create.test.js
index 44b8483f..7a87e9a1 100644
--- a/src/img/test/create.test.js
+++ b/src/img/test/create.test.js
@@ -261,6 +261,7 @@ test('create image from bhyve vm', function (t) {
 
     var payloadCommon = {
         brand: 'bhyve',
+        cpu_cap: 100,
         autoboot: true,
         do_not_inventory: true,
         ram: 512,
diff --git a/src/img/test/mk-custom-image b/src/img/test/mk-custom-image
index 48966630..5aa7da3d 100755
--- a/src/img/test/mk-custom-image
+++ b/src/img/test/mk-custom-image
@@ -63,6 +63,7 @@ function create_basis_zone {
 {
   "uuid": "$vm_uuid",
   "brand": "joyent",
+  "cpu_cap": 100,
   "zfs_io_priority": 30,
   "quota": 20,
   "image_uuid": "$image_uuid",
diff --git a/src/img/test/try-custom-image b/src/img/test/try-custom-image
index 39b8ffa2..697e8d71 100755
--- a/src/img/test/try-custom-image
+++ b/src/img/test/try-custom-image
@@ -71,6 +71,7 @@ vmadm create <<EOM
 {
   "uuid": "$vm_uuid",
   "brand": "joyent",
+  "cpu_cap": 100,
   "zfs_io_priority": 30,
   "quota": 20,
   "image_uuid": "$image_uuid",
diff --git a/src/vm/tests/test-blocksizes.js b/src/vm/tests/test-blocksizes.js
index 9f5a8191..d84cc030 100644
--- a/src/vm/tests/test-blocksizes.js
+++ b/src/vm/tests/test-blocksizes.js
@@ -246,6 +246,7 @@ test('create zone with data_recsize 64k', function(t) {
     var payload = {
         alias: 'test-blocksizes-' + process.pid,
         brand: 'joyent-minimal',
+        cpu_cap: 100,
         autoboot: false,
         image_uuid: image_uuid,
         do_not_inventory: true,
@@ -459,6 +460,7 @@ test('create zone with compression', function(t) {
     var payload = {
         alias: 'test-blocksizes-' + process.pid,
         brand: 'joyent-minimal',
+        cpu_cap: 100,
         autoboot: false,
         image_uuid: image_uuid,
         do_not_inventory: true,
@@ -593,6 +595,7 @@ test('create KVM with block_size 64k', function(t) {
     var payload = {
         alias: 'test-blocksizes-' + process.pid,
         brand: 'kvm',
+        cpu_cap: 100,
         autoboot: false,
         do_not_inventory: true,
         ram: 128,
@@ -736,6 +739,7 @@ test('create KVM with compression', function(t) {
     var payload = {
         alias: 'test-blocksizes-' + process.pid,
         brand: 'kvm',
+        cpu_cap: 100,
         autoboot: false,
         do_not_inventory: true,
         ram: 128,
-- 
2.21.0

