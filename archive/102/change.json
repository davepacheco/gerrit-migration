{"project":"joyent/illumos-joyent","branch":"master","id":"I5b906d728d7999b28ec95f09b8e95dd56216a546","number":"102","subject":"OS-5515 segumap_fault can race for loaded mapping Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/102","commitMessage":"OS-5515 segumap_fault can race for loaded mapping\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1468951906,"lastUpdated":1468956488,"open":false,"status":"MERGED","comments":[{"timestamp":1468951906,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1468952601,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+2"},{"timestamp":1468952769,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1468953190,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1468953342,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1468956365,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1468956488,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"2","revision":"5b906d728d7999b28ec95f09b8e95dd56216a546","parents":["8487e1434c4e4ba3924dab4a986939d06fb2b34a"],"ref":"refs/changes/02/102/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1468956365,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468952601,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468953342,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1468956488,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/vm/seg_umap.c","type":"MODIFIED","insertions":11,"deletions":-25},{"file":"usr/src/uts/common/vm/seg_umap.h","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-26},"patchSets":[{"number":"1","revision":"e76848521aa34367107b14853615efb47762507c","parents":["8487e1434c4e4ba3924dab4a986939d06fb2b34a"],"ref":"refs/changes/02/102/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1468951906,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468953342,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468952601,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"comments":[{"file":"usr/src/uts/common/vm/seg_umap.c","line":247,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I tried to look at this to better understand this claim. It seems like if the sud_prot value is different, then there will be a race in terms of establishing which permissions ultimately end up winning, is that right? In such a case, does our internal state tracking get thrown off or is it impossible for us to establish two different mappings here with different perms and that even if two different threads were in here, they\u0027d always have the same mapping / prot."},{"file":"usr/src/uts/common/vm/seg_umap.c","line":247,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"As the driver stands today, sud_prot is invariant through the lifetime of the segment.  In a situation where that wasn\u0027t the case, the protection settings present when the last thread entered segumap_fault would prevail."},{"file":"usr/src/uts/common/vm/seg_umap.c","line":247,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/vm/seg_umap.c","type":"MODIFIED","insertions":11,"deletions":-25},{"file":"usr/src/uts/common/vm/seg_umap.h","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-26},{"number":"2","revision":"5b906d728d7999b28ec95f09b8e95dd56216a546","parents":["8487e1434c4e4ba3924dab4a986939d06fb2b34a"],"ref":"refs/changes/02/102/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1468956365,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468953342,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468952601,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1468956488,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/vm/seg_umap.c","type":"MODIFIED","insertions":11,"deletions":-25},{"file":"usr/src/uts/common/vm/seg_umap.h","type":"MODIFIED","insertions":0,"deletions":-1}],"sizeInsertions":11,"sizeDeletions":-26}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}