From 4604c604630ed7537f951783d84de6efe4ee9366 Mon Sep 17 00:00:00 2001
From: Mohamed Khalfella <khalfella@gmail.com>
Date: Mon, 14 Oct 2019 20:00:16 +0000
Subject: [PATCH] MANTA-4614 medusa requests need to use marlin client

---
 lib/auth.js   |  4 ++--
 lib/common.js | 10 +++-------
 lib/server.js |  5 +++--
 3 files changed, 8 insertions(+), 11 deletions(-)

diff --git a/lib/auth.js b/lib/auth.js
index a425919..0788e30 100644
--- a/lib/auth.js
+++ b/lib/auth.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 //
@@ -929,7 +929,7 @@ function getActiveRoles(req, res, next) {
         var i, names;
         /* JSSTYLED */
         names = requestedRoles.split(/\s*,\s*/);
-        for (var i = 0; i < names.length; ++i) {
+        for (i = 0; i < names.length; ++i) {
             var roles = lookup[names[i]];
             if (roles === undefined || roles.length < 1) {
                 next(new InvalidRoleError(names[i]));
diff --git a/lib/common.js b/lib/common.js
index 532f0f4..ce74525 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var EventEmitter = require('events').EventEmitter;
@@ -1115,14 +1115,10 @@ module.exports = {
                 req.picker = clients.picker;
             }
 
-            // Job request setup
-            if (req.isMarlinRequest()) {
+            // Job and Medusa requests setup
+            if (req.isMarlinRequest() || req.isMedusaRequest()) {
                 req.marlin = clients.marlin;
                 req.jobCache = options.jobCache;
-            }
-
-            // Medusa request setup
-            if (req.isMedusaRequest()) {
                 req.medusa = clients.medusa;
             }
 
diff --git a/lib/server.js b/lib/server.js
index be938a0..b677a48 100644
--- a/lib/server.js
+++ b/lib/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var crypto = require('crypto');
@@ -254,7 +254,8 @@ function createServer(options, clients, name) {
             ok = false;
         }
 
-        if (!clients.marlin && req.isMarlinRequest()) {
+        if (!clients.marlin &&
+            (req.isMarlinRequest() || req.isMedusaRequest())) {
             error = 'marlin unavailable';
             errors.push(new Error(error));
             req.log.error(error);
-- 
2.17.2 (Apple Git-113)

