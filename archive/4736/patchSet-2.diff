From cfc6b518d9decc4a3f3347a73ff46e3a589c23ac Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 23 Aug 2018 09:41:55 -0700
Subject: [PATCH] joyent/node-manta#353 Add msign url shortener

---
 CHANGES.md        |  2 ++
 bin/msign         | 25 ++++++++++++++++++++++++-
 docs/man/msign.md |  3 +++
 man/man1/msign.1  |  3 +++
 package.json      |  1 +
 5 files changed, 33 insertions(+), 1 deletion(-)

diff --git a/CHANGES.md b/CHANGES.md
index 2ef85d7..dbbbb41 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -6,6 +6,8 @@
   mln, or mmkdir
 - joyent/node-manta#329 Refactor all commands to use common option parsing code
 - joyent/node-manta#343 Add `mjob wait` as an alias to `mjob watch`.
+- joyent/node-manta#353 add "msign -s" argument to shorten signed urls using the
+  https://i.no.de service.
 
 ## 5.1.1
 
diff --git a/bin/msign b/bin/msign
index 6cd1ca0..31d3a78 100755
--- a/bin/msign
+++ b/bin/msign
@@ -10,6 +10,7 @@ var url = require('url');
 
 var bunyan = require('bunyan');
 var dashdash = require('dashdash');
+var mantaShortenerClient = require('manta-shortener-client');
 
 var manta = require('../lib');
 
@@ -54,6 +55,11 @@ function optionsParser(name) {
                 type: 'arrayOfString',
                 help: 'role tags to apply to the created object',
                 helpArg: 'TAG,TAG...'
+            },
+            {
+                names: ['short', 's'],
+                type: 'bool',
+                help: 'Create a short URL'
             }
         ])
     });
@@ -150,7 +156,24 @@ function parseCmdOptions(opts, parser) {
             // the signed path:
             /* JSSTYLED */
             var uu = opts.url.replace(/\/*$/, '');
-            console.log(uu + resource);
+            if (!opts.short) {
+                console.log(uu + resource);
+                return;
+            }
+            // Shorten the URL using the manta url shortener.
+            var shortenOpts = {
+                expires: opts.expires,
+                url: uu + resource
+            };
+            mantaShortenerClient.shorten(shortenOpts, function (sErr, sUrl) {
+                if (sErr) {
+                    // In the case of a shortening error, show the full url.
+                    console.log(uu + resource);
+                    ifError(sErr);
+                    return;
+                }
+                console.log(sUrl);
+            });
         });
     });
 
diff --git a/docs/man/msign.md b/docs/man/msign.md
index 946ef0d..066e7d4 100644
--- a/docs/man/msign.md
+++ b/docs/man/msign.md
@@ -68,6 +68,9 @@ OPTIONS
 `--role-tag=ROLE,ROLE,...`
   Set the role tags on objects created with the signed URL.
 
+`-s, --short`
+  Create a short url by using the https://i.no.de url shortener service.
+
 `--user user`
   Authenticate as user under account.
 
diff --git a/man/man1/msign.1 b/man/man1/msign.1
index a8d9b72..caf5dbf 100644
--- a/man/man1/msign.1
+++ b/man/man1/msign.1
@@ -64,6 +64,9 @@ Specify which roles to assume for the request.
 \fB\fC\-\-role\-tag=ROLE,ROLE,...\fR
 Set the role tags on objects created with the signed URL.
 .TP
+\fB\fC\-s, \-\-short\fR
+Create a short url by using the \[la]https://i.no.de\[ra] url shortener service.
+.TP
 \fB\fC\-\-user user\fR
 Authenticate as user under account.
 .TP
diff --git a/package.json b/package.json
index 9dd62ec..3ad9f80 100644
--- a/package.json
+++ b/package.json
@@ -21,6 +21,7 @@
         "jsprim": "^1.3.0",
         "lomstream": "^1.1.0",
         "lstream": "~0.0.4",
+        "manta-shortener-client": "^1.0.4",
         "mime": "~1.2.11",
         "moment": "~2.13.0",
         "once": "~1.3.3",
-- 
2.21.0

