commit 05eb39b96f110d80b4f89708531feaee410e6579
Author: Todd Whiteman <todd.whiteman@joyent.com>
Date:   2019-05-10T08:59:52-07:00 (5 months ago)
    
    joyent/node-manta#353 Add msign url shortener

diff --git a/CHANGES.md b/CHANGES.md
index 65c1d75..546d451 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -11,6 +11,8 @@ See `CONTRIBUTING.md` for details on how to update this file
   CHANGES.md should link to GitHub issues
 - [#335](https://github.com/joyent/node-manta/issues/335) Want option to confim
   removal of files for `mrm`
+- [#353](https://github.com/joyent/node-manta/issues/353) add "msign -s"
+  argument to shorten signed urls using the https://i.no.de service.
 
   `mrm -I` and `mrmdir -I` now supported
 - [#62](https://github.com/joyent/node-manta/issues/62) RFE - mls list with human readable format
diff --git a/bin/msign b/bin/msign
index 280a535..6ccbed4 100755
--- a/bin/msign
+++ b/bin/msign
@@ -10,6 +10,7 @@ var url = require('url');
 
 var bunyan = require('bunyan');
 var dashdash = require('dashdash');
+var mantaShortenerClient = require('manta-shortener-client');
 
 var manta = require('../lib');
 
@@ -59,6 +60,11 @@ function optionsParser(name) {
                 type: 'arrayOfString',
                 help: 'role tags to apply to the created object',
                 helpArg: 'TAG,TAG...'
+            },
+            {
+                names: ['short', 's'],
+                type: 'bool',
+                help: 'Create a short URL'
             }
         ])
     });
@@ -205,7 +211,24 @@ function parseCmdOptions(opts, parser) {
             // the signed path:
             /* JSSTYLED */
             var uu = opts.url.replace(/\/*$/, '');
-            console.log(uu + resource);
+            if (!opts.short) {
+                console.log(uu + resource);
+                return;
+            }
+            // Shorten the URL using the manta url shortener.
+            var shortenOpts = {
+                expires: opts.expires,
+                url: uu + resource
+            };
+            mantaShortenerClient.shorten(shortenOpts, function (sErr, sUrl) {
+                if (sErr) {
+                    // In the case of a shortening error, show the full url.
+                    console.log(uu + resource);
+                    ifError(sErr);
+                    return;
+                }
+                console.log(sUrl);
+            });
         });
     });
 
diff --git a/docs/man/msign.md b/docs/man/msign.md
index 53285a4..729bc57 100644
--- a/docs/man/msign.md
+++ b/docs/man/msign.md
@@ -87,6 +87,9 @@ OPTIONS
 `--role-tag=ROLE,ROLE,...`
   Set the role tags on objects created with the signed URL.
 
+`-s, --short`
+  Create a short url by using the https://i.no.de url shortener service.
+
 `--user user`
   Authenticate as user under account.
 
diff --git a/man/man1/msign.1 b/man/man1/msign.1
index 6b2fca6..3749891 100644
--- a/man/man1/msign.1
+++ b/man/man1/msign.1
@@ -92,6 +92,9 @@ Specify which roles to assume for the request.
 \fB\fC\-\-role\-tag=ROLE,ROLE,...\fR
 Set the role tags on objects created with the signed URL.
 .TP
+\fB\fC\-s, \-\-short\fR
+Create a short url by using the \[la]https://i.no.de\[ra] url shortener service.
+.TP
 \fB\fC\-\-user user\fR
 Authenticate as user under account.
 .TP
diff --git a/package.json b/package.json
index 911a3eb..bf710d1 100644
--- a/package.json
+++ b/package.json
@@ -21,6 +21,7 @@
         "jsprim": "^1.3.0",
         "lomstream": "^1.1.0",
         "lstream": "~0.0.4",
+        "manta-shortener-client": "^1.0.4",
         "mime": "~1.2.11",
         "moment": "^2.22.2",
         "once": "~1.4.0",
