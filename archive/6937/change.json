{"project":"joyent/illumos-joyent","branch":"master","id":"Ie4b201171637339e9c582457e461fb99e6a4cc56","number":"6937","subject":"OS-8000 viona ring reset can race with Rx packets Reviewed by: Mike Zeller \u003cmike.zeller@joyent.com\u003e Reviewed by: Patrick Mooney \u003cpmooney@pfmooney.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Mike Zeller \u003cmike.zeller@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/6937","commitMessage":"OS-8000 viona ring reset can race with Rx packets\nReviewed by: Mike Zeller \u003cmike.zeller@joyent.com\u003e\nReviewed by: Patrick Mooney \u003cpmooney@pfmooney.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Mike Zeller \u003cmike.zeller@joyent.com\u003e\n","createdOn":1569611329,"lastUpdated":1569951638,"open":false,"status":"MERGED","comments":[{"timestamp":1569611329,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1569617178,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\nThis looks good to me.\nWould you mind adding a comment to viona_ioc_delete mentioning why we reset the ring before closing the mac client.  Since resetting the ring will also cause the barrier to be used now."},{"timestamp":1569617844,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n\u003e This looks good to me.\n \u003e Would you mind adding a comment to viona_ioc_delete mentioning why\n \u003e we reset the ring before closing the mac client.  Since resetting\n \u003e the ring will also cause the barrier to be used now.\n\nI\u0027m not sure the order really matters (I know it doesn\u0027t matter in terms of this bug, but Patrick may have more insight as to why he originally wanted it ordered this way) and I\u0027m not sure what I would put in such a comment. I didn\u0027t change the order because the real bug was the lack of coordination between the Rx worker exit (aka ring reset) and the ring state/mac Rx. If we are going to add a comment about the order of those things perhaps Patrick has a good one in mind."},{"timestamp":1569877042,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1569946516,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1569946940,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)\n\nLooks good, modulo a couple nits."},{"timestamp":1569947560,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1569947780,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1569947816,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1569950970,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3:\n\nTest notes added to the ticket."},{"timestamp":1569951314,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1569951389,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1569951394,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1569951611,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1569951638,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"5","revision":"e4b201171637339e9c582457e461fb99e6a4cc56","parents":["2ae9c4827fce220d14433c796b18141d48a597d9"],"ref":"refs/changes/37/6937/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1569951611,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947780,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947816,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569951314,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"SUBM","value":"1","grantedOn":1569951638,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_main.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_rx.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_tx.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":23,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"517ad91dff2670d516523f6c1edbd130ba17be5e","parents":["d34708cffc24f32c1138efa4de13db7b240c1b90"],"ref":"refs/changes/37/6937/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1569611329,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","line":73,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Perhaps update the diagram in viona_main.c to include this state?"},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","line":401,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If it were me, I would do the mac_rx_barrier() call in viona_worker_rx(), so the conditional isn\u0027t needed here.  You could require the worker functions to set vr_state to VRS_STOP by a VERIFY() here instead.\n\nAlso, vr_lock should not be held while issuing the mac_rx_barrier() call."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","type":"MODIFIED","insertions":11,"deletions":0}],"sizeInsertions":12,"sizeDeletions":0},{"number":"2","revision":"03ebf6c499a81799495840622919e8f8b9d56ff4","parents":["d34708cffc24f32c1138efa4de13db7b240c1b90"],"ref":"refs/changes/37/6937/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1569946516,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569946940,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/i86pc/io/viona/viona_main.c","line":139,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: for consistency, RX/TX are capitalized elsewhere in viona"},{"file":"usr/src/uts/i86pc/io/viona/viona_rx.c","line":129,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: for consistency, RX/TX are capitalized elsewhere in viona"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_main.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_rx.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_tx.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":23,"sizeDeletions":-2},{"number":"3","revision":"663e3c4f01015ce6c6a5b0c2d9d2b06d3d739b96","parents":["d34708cffc24f32c1138efa4de13db7b240c1b90"],"ref":"refs/changes/37/6937/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1569947560,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947780,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947816,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569951314,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569951394,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_main.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_rx.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_tx.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":23,"sizeDeletions":-2},{"number":"4","revision":"027ffefe932426fd3d2693f650512332c69564aa","parents":["2ae9c4827fce220d14433c796b18141d48a597d9"],"ref":"refs/changes/37/6937/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1569951389,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947780,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947816,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569951314,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_main.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_rx.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_tx.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":23,"sizeDeletions":-2},{"number":"5","revision":"e4b201171637339e9c582457e461fb99e6a4cc56","parents":["2ae9c4827fce220d14433c796b18141d48a597d9"],"ref":"refs/changes/37/6937/5","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1569951611,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947780,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569947816,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569951314,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}},{"type":"SUBM","value":"1","grantedOn":1569951638,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_impl.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_main.c","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"usr/src/uts/i86pc/io/viona/viona_ring.c","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_rx.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona_tx.c","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":23,"sizeDeletions":-2}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}