{"project":"joyent/smartos-live","branch":"master","id":"If2c5dfb162157c3d25a15917b353f4442dc1f3cc","number":"6049","subject":"OS-7698 Add mkzpool -e for creating encrypted zpools","owner":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"url":"https://cr.joyent.us/6049","commitMessage":"OS-7698 Add mkzpool -e for creating encrypted zpools\n","createdOn":1554416338,"lastUpdated":1573153958,"open":false,"status":"ABANDONED","comments":[{"timestamp":1554416338,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 1."},{"timestamp":1554416383,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 1: Code-Review-1\n\n-1 as I don\u0027t plan to integrate this until after kbmd has been added to illumos."},{"timestamp":1554416391,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1554416493,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 2."},{"timestamp":1554416545,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560797483,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nOther than using spaces for a file that has been using tabs LGTM"},{"timestamp":1560797515,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n\u003e -1 as I don\u0027t plan to integrate this until after kbmd has been\n \u003e added to illumos.\n\nShouldn\u0027t you put the -1 into IA then? :-)"},{"timestamp":1560800350,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 3."},{"timestamp":1560800369,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: -Code-Review Integration-Approval-1"},{"timestamp":1560800428,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560845406,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Code-Review+1\n\nLooks fine Jason. Thanks for updating to keep the tabs!"},{"timestamp":1560878295,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1560881308,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3:\n\n(3 comments)\n\nOne other note -- there is a mkzpool(1M) man page.  I haven\u0027t updated that (yet) -- since mkzpool can (in theory) be used with standalone SmartOS, while `mkzpool -e` currently requires Triton (and specifically KBMAPI to manage the PIV token pin), I though it\u0027d be better to leave it undocumented for now.  Once we have a better handle on isolating out the KBMAPI specific parts of kbmd, we can document then."},{"timestamp":1560881348,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Uploaded patch set 4."},{"timestamp":1560881429,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560885072,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1560885694,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1573153958,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Abandoned"}],"currentPatchSet":{"number":"4","revision":"f2c5dfb162157c3d25a15917b353f4442dc1f3cc","parents":["f09afc33f0583bd1b86519a99756cbc9b905bd45"],"ref":"refs/changes/49/6049/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1560881348,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1560800369,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560881429,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/node_modules/zfs.js","line":137,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Thanks for adding the asserts.  assert.optionalBool() will allow unspecified options (they are optional, after all) to be treated as false."},{"file":"src/node_modules/zfs.js","line":137,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"If no options are specified, then you\u0027d call the function using something like `zfs.zpool.create(pool, config, {}, cb)`, which seems non-canonical.  I thought for something like that, you\u0027d just omit the parameter, though that means you\u0027re back to something similar to the original version of the change.\n\nI\u0027ve not done enough node code to definitively say one way or the other would be better.  Maybe someone more familiar with node conventions can chime in?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/mkzpool.js","type":"MODIFIED","insertions":13,"deletions":-4},{"file":"src/node_modules/zfs.js","type":"MODIFIED","insertions":24,"deletions":-13}],"sizeInsertions":37,"sizeDeletions":-17},"patchSets":[{"number":"1","revision":"ec1561178b089fad29e8528b5a188ddb42516b06","parents":["f09afc33f0583bd1b86519a99756cbc9b905bd45"],"ref":"refs/changes/49/6049/1","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1554416338,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554416391,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1554416383,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/mkzpool.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"src/node_modules/zfs.js","type":"MODIFIED","insertions":24,"deletions":-10}],"sizeInsertions":31,"sizeDeletions":-13},{"number":"2","revision":"28623acf010e875c642a31725443f012cea51b49","parents":["f09afc33f0583bd1b86519a99756cbc9b905bd45"],"ref":"refs/changes/49/6049/2","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1554416493,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554416545,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560797483,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1554416383,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"src/node_modules/zfs.js","line":129,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Nit: shouldn\u0027t these be tabs?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/mkzpool.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"src/node_modules/zfs.js","type":"MODIFIED","insertions":25,"deletions":-11}],"sizeInsertions":33,"sizeDeletions":-15},{"number":"3","revision":"ac30b18b741b10974550794a0f7459667e12d2d3","parents":["f09afc33f0583bd1b86519a99756cbc9b905bd45"],"ref":"refs/changes/49/6049/3","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1560800350,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560800428,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560845406,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1560800369,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"src/mkzpool.js","line":4,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Copyright 2019 Joyent, Inc."},{"file":"src/mkzpool.js","line":4,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"src/node_modules/zfs.js","line":2,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Copyright 2019 Joyent, Inc."},{"file":"src/node_modules/zfs.js","line":2,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Done"},{"file":"src/node_modules/zfs.js","line":141,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Rather than dealing with the complications of optional positional parameters that are not the last parameter, it would seem to be better to make this:\n\nzpool.create \u003d function zpoolCreate(pool, config, options, callback)\n\nThen use options.encrypt and options.force."},{"file":"src/node_modules/zfs.js","line":141,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"I was originally concerned about things other than mkzpool using this and breaking, but it appears the only things are mkzpool and imgadm (and imgadm doesn\u0027t use this function), so it\u0027s probably safe to do."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/mkzpool.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"src/node_modules/zfs.js","type":"MODIFIED","insertions":22,"deletions":-8}],"sizeInsertions":30,"sizeDeletions":-12},{"number":"4","revision":"f2c5dfb162157c3d25a15917b353f4442dc1f3cc","parents":["f09afc33f0583bd1b86519a99756cbc9b905bd45"],"ref":"refs/changes/49/6049/4","uploader":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"createdOn":1560881348,"author":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560881429,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"-1","grantedOn":1560800369,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"comments":[{"file":"src/node_modules/zfs.js","line":137,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Thanks for adding the asserts.  assert.optionalBool() will allow unspecified options (they are optional, after all) to be treated as false."},{"file":"src/node_modules/zfs.js","line":137,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"If no options are specified, then you\u0027d call the function using something like `zfs.zpool.create(pool, config, {}, cb)`, which seems non-canonical.  I thought for something like that, you\u0027d just omit the parameter, though that means you\u0027re back to something similar to the original version of the change.\n\nI\u0027ve not done enough node code to definitively say one way or the other would be better.  Maybe someone more familiar with node conventions can chime in?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/mkzpool.js","type":"MODIFIED","insertions":13,"deletions":-4},{"file":"src/node_modules/zfs.js","type":"MODIFIED","insertions":24,"deletions":-13}],"sizeInsertions":37,"sizeDeletions":-17}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}