{"project":"joyent/manta-muskie","branch":"master","topic":"MANTA-2169","id":"Idd5e5f2f78e8e20853b73209862ca5d629fb2351","number":"1292","subject":"MANTA-2169 Support multipart upload of a single file to Manta Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Reviewed by: Angela Fong \u003cangela.fong@joyent.com\u003e Reviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approv","owner":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"url":"https://cr.joyent.us/1292","commitMessage":"MANTA-2169 Support multipart upload of a single file to Manta\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nReviewed by: Angela Fong \u003cangela.fong@joyent.com\u003e\nReviewed by: Kody Kantor \u003ckody.kantor@joyent.com\u003e\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1484790711,"lastUpdated":1493827783,"open":false,"status":"MERGED","comments":[{"timestamp":1484790711,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 1."},{"timestamp":1484790745,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(33 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1484846719,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Topic set to MANTA-2169"},{"timestamp":1484857095,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 2."},{"timestamp":1484857137,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing-1\n\n(5 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1485191763,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 3."},{"timestamp":1485191805,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485541886,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 4."},{"timestamp":1485541918,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485542643,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 5."},{"timestamp":1485542668,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485542944,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 6."},{"timestamp":1485542971,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1485544771,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1485558682,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(5 comments)\n\nNote: I only reviewed some of the restify-y bits of this CR."},{"timestamp":1486080470,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6:\n\n(6 comments)"},{"timestamp":1486503619,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 7."},{"timestamp":1486503646,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486516829,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 7:\n\n(94 comments)\n\nNice work!  This is a big chunk of work, and it\u0027s in great shape and clearly well thought out.\n\nI\u0027ve got lots of notes in this review.  Many of them are pretty small and many of the others can likely be deferred.  Let me know if you have questions about which ones seem like blockers.  One note that didn\u0027t go with any particular file: there don\u0027t seem to be any tests here."},{"timestamp":1491507390,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 7:\n\n(3 comments)\n\nLooks good. The only thing that I noticed that wasn\u0027t covered already is to watch for unused imports."},{"timestamp":1491860784,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 8."},{"timestamp":1491860811,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491861005,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7:\n\n(93 comments)\n\nThanks so much to everyone who reviewed this. I believe this new patsetch (#8) has addressed all feedback so far, but please let me know if there\u0027s anything I missed!\n\nThere are a still a few TODOs in here, but I wanted to get this chunk of work back out again so folks can take a look at the second version.\n\nI also have some improvements I need to make to the MPU tests, including proper cleanup of uploads that are created and ways to prevent running into intermittent out of space errors that I\u0027ve hit on my one-CN Manta setup.\n\nOther than the intermittent out of space errors, this patchset passes the muskie test suite, including the new MPU tests."},{"timestamp":1491954206,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 8:\n\n(17 comments)\n\nThis looks great!  I think the new comments and constants really help readability.  I have a few items below that I hope are trivial (e.g., unused functions, changed log level).  If any of these takes more than a couple of minutes, we can just punt it to a new ticket."},{"timestamp":1492460950,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 9."},{"timestamp":1492460977,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492461040,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 9:\n\n(22 comments)\n\nPatchset #9 responds to feedback on patchset #8, and a missed comment or two from patchset #7. I believe I have filed tickets for everything not addressed. I also added some tests for MPU routes that aren\u0027t allowed (see here for a summary https://github.com/joyent/rfd/blob/master/rfd/0065/README.md#http-api)."},{"timestamp":1492461061,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 9:\n\nI also re-ran the muskie test suite against patchset #9."},{"timestamp":1492464006,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 9: Code-Review+1\n\n(2 comments)"},{"timestamp":1492492072,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 10."},{"timestamp":1492492099,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492524848,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1492555813,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 10:\n\n(7 comments)\n\nLooks good! As a personal aside, I\u0027m not sure if there\u0027s a standard around what we do after calling next(). It seems like sometimes we return, sometimes we don\u0027t."},{"timestamp":1492635539,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1492652971,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 11."},{"timestamp":1492652998,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492653024,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 11:\n\n(7 comments)\n\nThanks for reviewing this, Kody! I responded to your feedback and fixed a few more spelling mistakes. (As usual, I re-ran the test suite as well before pushing the patch set.)"},{"timestamp":1492698812,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 11:\n\n(3 comments)\n\nLooks good. Thanks for fixing the little things."},{"timestamp":1492790059,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1492791170,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 12."},{"timestamp":1492791197,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1492791211,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 12:\n\n(1 comment)"},{"timestamp":1492791328,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1493311845,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 13."},{"timestamp":1493311877,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1493311913,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 13:\n\nThis patchset fixes the bug uncovered by an audit job alarm in staging (see LAB-196).\n\nThis patchset is `make prepush` clean."},{"timestamp":1493413222,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13:\n\n(1 comment)"},{"timestamp":1493414716,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1493415537,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 13:\n\n(1 comment)"},{"timestamp":1493827683,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 13: Integration-Approval+1"},{"timestamp":1493827763,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Uploaded patch set 14: Commit message was updated."},{"timestamp":1493827783,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jordan Hendricks"}],"currentPatchSet":{"number":"14","revision":"dd5e5f2f78e8e20853b73209862ca5d629fb2351","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/14","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1493827763,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493311877,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493414716,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493827683,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1493827783,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":64,"deletions":-12},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":566,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1145,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":336,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":116,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6364,"sizeDeletions":-103},"patchSets":[{"number":"1","revision":"aaafb550ed87c38b2a159245fa961ab3aedc9976","parents":["c9f13a526195ef6cda586063ef2ad061e6349e97"],"ref":"refs/changes/92/1292/1","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1484790711,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1484790745,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":361,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"},{"file":"lib/server.js","line":406,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"},{"file":"lib/server.js","line":410,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"},{"file":"lib/server.js","line":414,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"},{"file":"lib/server.js","line":418,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"},{"file":"lib/uploads/abort.js","line":37,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"},{"file":"lib/uploads/abort.js","line":54,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadFinalizeConflictError"},{"file":"lib/uploads/commit.js","line":47,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadAbortedError"},{"file":"lib/uploads/commit.js","line":55,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadCommitInProgessError"},{"file":"lib/uploads/commit.js","line":86,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer obj hides an identifier in a parent scope"},{"file":"lib/uploads/commit.js","line":105,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadPartEtagError"},{"file":"lib/uploads/commit.js","line":107,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadPartSizeError"},{"file":"lib/uploads/commit.js","line":129,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer req hides an identifier in a parent scope"},{"file":"lib/uploads/commit.js","line":136,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadContentLengthError"},{"file":"lib/uploads/commit.js","line":184,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"},{"file":"lib/uploads/commit.js","line":195,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadFinalizeConflictError"},{"file":"lib/uploads/commit.js","line":233,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: log"},{"file":"lib/uploads/common.js","line":126,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: colon_after_id"},{"file":"lib/uploads/create.js","line":65,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: log"},{"file":"lib/uploads/create.js","line":82,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadMissingObjecPathError"},{"file":"lib/uploads/create.js","line":84,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: size"},{"file":"lib/uploads/create.js","line":89,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: len"},{"file":"lib/uploads/create.js","line":90,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: len"},{"file":"lib/uploads/create.js","line":91,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: len"},{"file":"lib/uploads/create.js","line":103,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: len"},{"file":"lib/uploads/create.js","line":123,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"},{"file":"lib/uploads/create.js","line":140,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer md hides an identifier in a parent scope"},{"file":"lib/uploads/create.js","line":140,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer wrap hides an identifier in a parent scope"},{"file":"lib/uploads/create.js","line":140,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"},{"file":"lib/uploads/create.js","line":166,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: variable is declared but never referenced: log"},{"file":"lib/uploads/create.js","line":172,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer err hides an identifier in a parent scope"},{"file":"lib/uploads/upload.js","line":40,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadPartNumError"},{"file":"lib/uploads/upload.js","line":48,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: undeclared identifier: MultipartUploadFinalizeConflictError"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":13,"deletions":-20},{"file":"lib/dir.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":83,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":221,"deletions":-1},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":91,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":266,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":854,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":39,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":85,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":120,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":2021,"sizeDeletions":-27},{"number":"2","revision":"e895780377083229f20dbd4dded2acf1dd21fff9","parents":["c9f13a526195ef6cda586063ef2ad061e6349e97"],"ref":"refs/changes/92/1292/2","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1484857095,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1484857137,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/uploads/common.js","line":661,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/uploads/common.js","line":680,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/uploads/common.js","line":682,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/uploads/common.js","line":698,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/uploads/common.js","line":699,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":13,"deletions":-20},{"file":"lib/dir.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":85,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":186,"deletions":-1},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":269,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":859,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":39,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":86,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":122,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":8,"deletions":0}],"sizeInsertions":2008,"sizeDeletions":-27},{"number":"3","revision":"1890be15f2fbbc8a06b3cd03c18c48132d551317","parents":["c9f13a526195ef6cda586063ef2ad061e6349e97"],"ref":"refs/changes/92/1292/3","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1485191763,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485191805,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":13,"deletions":-20},{"file":"lib/dir.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":86,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":186,"deletions":-1},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":243,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":964,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":207,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":39,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":86,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":8,"deletions":0}],"sizeInsertions":2093,"sizeDeletions":-27},{"number":"4","revision":"7fedf846011d1cd440ee217b21a07ccc5a067e11","parents":["c9f13a526195ef6cda586063ef2ad061e6349e97"],"ref":"refs/changes/92/1292/4","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1485541886,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485541918,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":13,"deletions":-20},{"file":"lib/dir.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":107,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":186,"deletions":-1},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":49,"deletions":-10},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":94,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":429,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1109,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":225,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":52,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":86,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":2529,"sizeDeletions":-37},{"number":"5","revision":"f37dacb7b83c13e0e148b2fc3196016974f65fae","parents":["c9f13a526195ef6cda586063ef2ad061e6349e97"],"ref":"refs/changes/92/1292/5","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1485542643,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485542668,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":13,"deletions":-20},{"file":"lib/dir.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":107,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":186,"deletions":-1},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":49,"deletions":-10},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":94,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":429,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1082,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":225,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":52,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":86,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":2502,"sizeDeletions":-37},{"number":"6","revision":"2d4b72ebe897c191fa9d91e6e810297f87da499a","parents":["c9f13a526195ef6cda586063ef2ad061e6349e97"],"ref":"refs/changes/92/1292/6","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1485542944,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1485542971,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":468,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"missing the upload id reference?"},{"file":"lib/errors.js","line":468,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/obj.js","line":195,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"assuming you don\u0027t want to commit this"},{"file":"lib/obj.js","line":195,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/server.js","line":307,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Why the explicit forbiddenHandler\u0027s? My understanding is that restify does this automatically for you and throws a MethodNotAllowedError. Here: https://github.com/restify/node-restify/blob/4.x/lib/router.js#L603"},{"file":"lib/server.js","line":307,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Because the uploads directory is in the common.StoragePaths array, routes are automatically created to get/put/head paths under it. If we don\u0027t explicitly forbid it, then it\u0027s still possible to get the parts, which is bad. (I\u0027ve tested this without the handler there.)"},{"file":"lib/server.js","line":376,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this for the UUID prefix? Two Qs:\n\n- The range `0-f` allows all ASCII between 0x30 (\"0\") and 0x66 (\"f\"), which is a lot more than you want here for hex. E.g.:\n\n    \u003e /[0-f]+/.test(\u0027\u003e\u0027)\n    true\n\n- Any particular reason to use \u0027+\u0027 rather than a fixed number of prefix chars?"},{"file":"lib/server.js","line":442,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Unrelated to your change, but I think this means that authorization isn\u0027t done for the endpoints registered above this point."},{"file":"lib/server.js","line":442,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"That\u0027s true. In the case of MPU (and looks like the jobs endpoints as well), authorization is done within the API handler chain."},{"file":"lib/server.js","line":461,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Head is meant to be allowed? Was that endpoint skipped here?"},{"file":"lib/server.js","line":461,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"HEAD is allowed, but there\u0027s no special handler for it."},{"file":"lib/uploads/abort.js","line":58,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"should be types.ABORT ?"},{"file":"lib/uploads/common.js","line":776,"reviewer":{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},"message":"should be types.COMMIT ?"},{"file":"lib/uploads/common.js","line":776,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":13,"deletions":-20},{"file":"lib/dir.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":107,"deletions":-1},{"file":"lib/obj.js","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":186,"deletions":-1},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":49,"deletions":-10},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":94,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":430,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1082,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":225,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":52,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":86,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":125,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":2503,"sizeDeletions":-37},{"number":"7","revision":"38fa9739e76e613f4aa651038baea4ff7b675396","parents":["7b4a35e739ba05cc274d5a435ff0a521e8d9c09a"],"ref":"refs/changes/92/1292/7","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1486503619,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486503646,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":".gitignore","line":14,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This isn\u0027t a problem but it probably belongs in your own .gitignore since it\u0027s editor-specific."},{"file":".gitignore","line":14,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/audit.js","line":235,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s \"req.route\" for?  I see other checks for its presence, but I don\u0027t see assignments in this repo.  Do you know when it gets set?"},{"file":"lib/audit.js","line":235,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It is set by restify. The `route` corresponds to the name of the route chain a chosen for a request (e.g., \"putdirectory\" or \"uploadpart\"). I added it for debugging when I was having trouble figuring out what route a request was taking. I\u0027m open to taking it out, but I think it is useful to know precisely which route chain a request went through for many situations."},{"file":"lib/common.js","line":152,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s this about?"},{"file":"lib/common.js","line":152,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think it\u0027s irrelevant now. Removed."},{"file":"lib/errors.js","line":447,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be nice to make these messages a bit more consistent.  Maybe:\n\n    upload $ID: [part $PART:] message\n\nfor all of them?"},{"file":"lib/errors.js","line":447,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/errors.js","line":485,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"Objec\" should be \"Object\" here."},{"file":"lib/errors.js","line":485,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/errors.js","line":508,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This one is missing the \"Error\" suffix."},{"file":"lib/errors.js","line":508,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/errors.js","line":517,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"For what it\u0027s worth, I don\u0027t think you need this many different 400-level error codes for these cases.  From a client\u0027s perspective, if they get any of these, it\u0027s a programmer\u0027s error and not really something that can be handled automatically."},{"file":"lib/errors.js","line":517,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I pared them down quite a bit. Let me know what you think."},{"file":"lib/errors.js","line":530,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This restCode is missing the \"Error\" suffix."},{"file":"lib/errors.js","line":530,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/obj.js","line":921,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Especially since we\u0027re exporting it, could we add a comment to this tunable?"},{"file":"lib/obj.js","line":921,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/server.js","line":438,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think Trent mentioned this in another patchset, but shouldn\u0027t this be handled by restify with a 405 error?  I wouldn\u0027t think you\u0027d need to add all the routes that use this handler."},{"file":"lib/server.js","line":438,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Below is my response to Trent on this, but I\u0027m open to other ways of dealing with this problem:\n\n\"Because the uploads directory is in the common.StoragePaths array, routes are automatically created to get/put/head paths under it. If we don\u0027t explicitly forbid it, then it\u0027s still possible to get the parts, which is bad. (I\u0027ve tested this without the handler there.)\""},{"file":"lib/server.js","line":438,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Okay, it sounds like we\u0027re adding a more specific route to add one that we\u0027d previously added in a more generic code path.  That\u0027s okay.  We probably should return a 405 for this case, though.  It might be nice to add a comment explaining this (maybe in addMultipartUploadDataPlaneRoutes().)"},{"file":"lib/server.js","line":438,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/server.js","line":594,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The indenting here doesn\u0027t match the previous function."},{"file":"lib/server.js","line":594,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/shark_client.js","line":91,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Instead of setting the timeout and then immediately removing it, could we just avoid setting it in this case (and avoid clearing it later if it wasn\u0027t set)?  It would also be good to update the comment to explain why."},{"file":"lib/shark_client.js","line":91,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"What\u0027s the advantage of doing that? It seems like it would be clearer to the reader if we explicitly cleared it for POSTs."},{"file":"lib/uploads/abort.js","line":26,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Extra blank here?"},{"file":"lib/uploads/abort.js","line":26,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/abort.js","line":38,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Under normal operation, we only want one \"info\" level log message for each request.  This should probably be under \"debug\".  This applies to a lot of other places."},{"file":"lib/uploads/abort.js","line":38,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/abort.js","line":43,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I found it confusing which parts of the code are responsible for managing the finalizing state -- both in the upload record and the finalizing record.  A block comment about that would be helpful (or, if I missed it, a pointer to that comment in this file).\n\nWhat do you think about having abortUpload() not only deal with the finalizing record, but also finalize the upload record (instead of doing part of that here, in the HTTP-facing code, and part of it in lib/uploads/common.js)?"},{"file":"lib/uploads/abort.js","line":43,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Sorry, I realized I missed this comment the first time around.\n\nFor both commits and aborts, the upload record and the finalizing records are updated in separate handlers. This is intentional, as they are two async operations on Moray. I also tried to make the sequence of handleres match the logical steps for implementing abort-mpu and commit-mpu, as outlined in the RFd. \n\nI made the structure of the commit and abort handler chains as parallel as possible: there\u0027s a handler called \"finalizingState\" that calls into common code to update the upload record. The {commit,abort} handlers called into {commit,abort}Upload() in the common code, which inserts the finalizing record. I\u0027m happy to add a comment to explain this, but I\u0027m not sure the best place to do that. All of the code referenced here in lib/uploads/common.js is commented (finalizeUploadRecord(), commitUpload(), and abortUpload())."},{"file":"lib/uploads/abort.js","line":46,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Since the different code paths here do vastly different things, it would be interesting to figure out how to make this more debuggable post hoc.  One idea would be to record a list of the actions we took (e.g., \"FinalizeUpload\") and include that in the final log entry.  So different abort requests might go: [ \"FinalizeUpload\", \"Abort\" ] or just [ \"Abort\" ]."},{"file":"lib/uploads/abort.js","line":46,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Are you referring to whether we update the upload record or not? One option would be to change the log statement in the second block (the first \"else\") to log at level \"info\" so that\u0027s obvious in the logs post-hoc."},{"file":"lib/uploads/abort.js","line":47,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The indenting here is off."},{"file":"lib/uploads/abort.js","line":47,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":14,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"These two imports are unused (unless I\u0027m missing something)"},{"file":"lib/uploads/commit.js","line":14,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":32,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\"clone\" is used elsewhere to mean deepCopy.  (Even then it\u0027s ambiguous, IMO.)  Can we use shallowCopy here?"},{"file":"lib/uploads/commit.js","line":32,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":35,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This would be a good place to explain why we have a minimum part size."},{"file":"lib/uploads/commit.js","line":35,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Added a comment. Let me know what you think."},{"file":"lib/uploads/commit.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"For a moment I thought the presence of this meant that we could avoid hardcoding the POST logic in SharkClient.  However, seeing how getClient works, it seems that would do the wrong thing.  It\u0027s kind of busted that the parameters we use here have to match what we use in other invocations of getClient, but nothing enforces that."},{"file":"lib/uploads/commit.js","line":52,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m not sure I understand this comment. Which hardcoded logic are you referring to?"},{"file":"lib/uploads/commit.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"In _request() in lib/shark_client.js (lines 91-94), we have a special case for POST to remove the connectTimeout handler that we had just previously added.  Strictly speaking, the lack of a timeout doesn\u0027t really have anything to do with POSTs, but that\u0027s the only property that the shark client could use to distinguish this case from the ones where we want a timeout.\n\nWhen I first saw that we\u0027re providing a connectTimeout to getClient(), I thought that maybe we could instead specify a null value for connectTimeout to indicate that we should skip the timeout.  Then we wouldn\u0027t have to assume that all POSTs would have no connect timeout -- we\u0027d be expressing exactly what we want, which is that requests from this caller shouldn\u0027t have one.\n\nWhen I looked at the implementation, I realized that getClient() would happily return a client here that was constructed with a different connectTimeout.  Perhaps worse, if getClient didn\u0027t already have a client, it would have created one with the connectTimeout we specified here (null, in this ideal world), and then later it would return that to some other request that actually needs a timeout.\n\nThe conclusion is that all callers of getClient() really need to use the same values for parameters like connectTimeout, but nothing currently enforces that.  It would be nice to at least assert when we return an existing client that it has the same values that the caller asked for.  Ideally, the connect timeout would be specified per-request, not in getClient.\n\nI\u0027m not sure how much of this is worth tackling right now, but I\u0027d be tempted to at least add the assertions because it\u0027ll be an extremely confusing failure mode and not likely seen in normal testing."},{"file":"lib/uploads/commit.js","line":52,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for the explanation. The `getClient` interface does seems like it could use some improvements in how it handles things, so I\u0027ve filed MANTA-3222 to address this. I added a couple assertions here as well -- let me know if there\u0027s anything else you think I should add."},{"file":"lib/uploads/commit.js","line":117,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I have the same comments as I did in the storage parts: it would be good if at the least we made clear in those other handlers that they\u0027re being used elsewhere."},{"file":"lib/uploads/commit.js","line":117,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"In this case, both getMetadata and storageContext are used by most requests already, as they\u0027re added using `server.use` on in the handler chain. I added a comment to both and an additional assertion to getMetadata."},{"file":"lib/uploads/commit.js","line":132,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s the difference between OBJECT_PATH and OBJECT_PATH_KEY?"},{"file":"lib/uploads/commit.js","line":132,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"OBJECT_PATH is the path of the object we are commiting (e.g., /jhendricks/stor/foo), and OBJECT_PATH_KEY is its key in Moray (e.g., /4204a7f8-3d97-ec27-c16d-f2f49366cc3c/stor/foo). I save the key mostly for convenience, so that I can generate it once and reuse it later (and across requests)."},{"file":"lib/uploads/commit.js","line":221,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This limit appears in a few places.  It would be better if it were pulled out into a constant with a comment."},{"file":"lib/uploads/commit.js","line":221,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":253,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m not sure if this is possible given the current functions exposed by libmanta, but it would likely be significantly more efficient to list the parts rather than fetch each one like this.  You\u0027d make one request per 1000 parts instead of 1000."},{"file":"lib/uploads/commit.js","line":253,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It looks like it might be possible using the search() method in libmanta, but I\u0027ll need to try it out to be sure."},{"file":"lib/uploads/commit.js","line":253,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"MANTA-3219 created."},{"file":"lib/uploads/commit.js","line":298,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/uesr/user/"},{"file":"lib/uploads/commit.js","line":298,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":302,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think it would be good to assert that e.statusCode is a number here (in case someone thinks they can add any kind of Error above)."},{"file":"lib/uploads/commit.js","line":302,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":315,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why is this an error?  For normal PUTs, I thought this was disallowed only if you didn\u0027t specify a content-length up front."},{"file":"lib/uploads/commit.js","line":315,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think I misunderstood what DEF_MAX_LEN represented. Fixed."},{"file":"lib/uploads/commit.js","line":340,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we assert that this is non-null?"},{"file":"lib/uploads/commit.js","line":340,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":379,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I see this is also hardcoded in lib/obj.js, but can we pull it out into a constant with a comment?"},{"file":"lib/uploads/commit.js","line":379,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":26,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Nice block comment!\n\nThere seems to be an extra leading space here."},{"file":"lib/uploads/common.js","line":26,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":35,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/sum/concatenation/ ?\ns/indistinguisable/indistinguishable/"},{"file":"lib/uploads/common.js","line":35,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":60,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Maybe add: \"This is different from the object path.\""},{"file":"lib/uploads/common.js","line":60,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":68,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This may be too late to be useful, but I\u0027ve wondered if we shouldn\u0027t call this the \"target object\" to give it a more concrete term, since \"object\" is so generic."},{"file":"lib/uploads/common.js","line":68,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I agree it\u0027s pretty generic. It would require a breaking change to change the naming in Moray, but I have updated documentation and relevant function names to use \"target object\"."},{"file":"lib/uploads/common.js","line":80,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/begun/completed/ ?"},{"file":"lib/uploads/common.js","line":80,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":100,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This field is redundant with the key of the upload record, isn\u0027t it?"},{"file":"lib/uploads/common.js","line":100,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I suppose, but having it there makes it easier to simply load the upload record, grab the \"upload\" blob and use that directly instead of introducing more logic to parse that."},{"file":"lib/uploads/common.js","line":103,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Was this updated for the change to use an md5?"},{"file":"lib/uploads/common.js","line":103,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":110,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this supposed to be a different type name than \"upload\"?"},{"file":"lib/uploads/common.js","line":110,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"No, that is what it\u0027s called in the Moray record."},{"file":"lib/uploads/common.js","line":113,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is just an md5, right?"},{"file":"lib/uploads/common.js","line":113,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":118,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/explitily/explicitly/"},{"file":"lib/uploads/common.js","line":118,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":130,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"contentMD5 is duplicated here."},{"file":"lib/uploads/common.js","line":130,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":166,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This could use a comment."},{"file":"lib/uploads/common.js","line":166,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":169,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"You\u0027re using an object as a namespace here.  That\u0027s fine, but if you use a prefix instead (e.g., MPU_S_CREATED), then linters can check whether you\u0027ve used the wrong one (because it will be an undeclared identifier).  I use this a lot, as in node-fast: https://github.com/joyent/node-fast/blob/master/lib/fast_protocol.js#L85-L98.\n\nIn that case, they\u0027re both defined for that file and exported.  If they\u0027re exported, then users in other files lose much of the benefit, but you can at least still easily find usages of them and most misspellings (by looking for the prefix, as in \"MPU_S_\").\n\nThis is just a thought -- what you\u0027ve got here is fine (and probably more idiomatic anyway)."},{"file":"lib/uploads/common.js","line":169,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This was the most idiomatic way I found to represent enums in Javascript. Given how often linters have saved me from bugs, I like this approach too. I\u0027ve updated the states and finalizing types to use a prefix. For the upload keys, I prefer the object namespace, because the get/set interface makes it much easier to add additional information to the upload record in the future."},{"file":"lib/uploads/common.js","line":185,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be nice to document how OBJECT_PATH is different than OBJECT_PATH_KEY."},{"file":"lib/uploads/common.js","line":185,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Since this object is the source of truth for what actually goes in the upload record, I\u0027ve documented all of these values here."},{"file":"lib/uploads/common.js","line":240,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Remove?"},{"file":"lib/uploads/common.js","line":240,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I actually think we want this here (uncommented)."},{"file":"lib/uploads/common.js","line":282,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this the MD5 of the list of parts or the MD5 of the object\u0027s contents?  Could the name reflect that?"},{"file":"lib/uploads/common.js","line":282,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It is the md5 of the part etags. I realize the name is not as descriptive as it could be. If we think it\u0027s important enough to change, I would like to do that in a different commit, as it would require changing the format of the upload blob as saved in Moray. That said, I have tried to make sure this is well-documented, so let me know if you see areas of improvement in that regard."},{"file":"lib/uploads/common.js","line":286,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is there any reason this function doesn\u0027t just return the value?"},{"file":"lib/uploads/common.js","line":286,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"One of the many artifacts from earlier implementations when it made more sense to have a callback :) Done."},{"file":"lib/uploads/common.js","line":291,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we clarify \"in memory\"?  I first thought this actually created it in Moray.  Maybe add the same to the other create.*Record functions?"},{"file":"lib/uploads/common.js","line":291,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":357,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This function seems to assume that only one consumer might be modifying the state or persisting the upload at a time.  It would be nice to assert at least that there is not an outstanding persist operation ongoing."},{"file":"lib/uploads/common.js","line":357,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I believe the etag hanging off the record should prevent this. Even if there are two identical requests on the same muskie, they always fetch the upload record first and would have their own copy of it. I\u0027ve added an assertion here to verify that the etag is null for creating an upload record and that it\u0027s not null/undefined for an update to the record.\n\nIf for some reason another handler in an MPU chain that calls persist, the second invocation would fail if it used the same etag as before without doing another getMetadata(), so I believe this takes care of that case as well."},{"file":"lib/uploads/common.js","line":371,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is there something that prevents one request from clobbering an update from a previous request?  I imagine that would have to be an etag hanging off toSave or something like that."},{"file":"lib/uploads/common.js","line":371,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Updated loadUploadRecord to use the etag from the previous record to prevent clobbering updates, and I added an assertion to finalizeUploadRecord to aser that it\u0027s there."},{"file":"lib/uploads/common.js","line":391,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Personally, I find it pretty helpful to use the same identifier everywhere for the same thing.  In this case, you could use \"uploadMd\" everywhere you refer to an object with the uploadMd structure."},{"file":"lib/uploads/common.js","line":391,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I intentionally tried to use the record term generically throughout to refer to the upload record, finalizing record and target object record, especially since that matches the function names."},{"file":"lib/uploads/common.js","line":407,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Left in from debugging."},{"file":"lib/uploads/common.js","line":407,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":439,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why is \"load\" a separate function here?"},{"file":"lib/uploads/common.js","line":439,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Another artifact from an earlier implementation. Removed."},{"file":"lib/uploads/common.js","line":483,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Could we add a comment here, like: \"Common route handler used to load information about the upload record that will be used in subsequent handlers.\""},{"file":"lib/uploads/common.js","line":483,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":512,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t quite understand what this handler is supposed to be doing."},{"file":"lib/uploads/common.js","line":512,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It is the analog of \"storageContext\" or \"jobContext\" from the jobs API. I have added a header comment."},{"file":"lib/uploads/common.js","line":517,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Did you mean this to say \"started\"?"},{"file":"lib/uploads/common.js","line":517,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":521,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think this appears elsewhere, and could probably use a separate function."},{"file":"lib/uploads/common.js","line":521,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"A similar, but not identical, line of code does that generates the /account/uploads line in create.js. I\u0027m not sure of a better way to abstract this. We also do this in the jobs code."},{"file":"lib/uploads/common.js","line":537,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does this mean that if you try to operate on somebody else\u0027s upload directory you\u0027ll get a 404?"},{"file":"lib/uploads/common.js","line":537,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Yeah. The jobs API also does this (and has an explicit test for it). My interpretation is that it\u0027s meant to prevent information leakage, but that\u0027s just a guess. I thought it would be best to be consistent, but I\u0027m open to a different approach."},{"file":"lib/uploads/common.js","line":577,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can we use a prefix other than \"_\"?  I always find that pretty ambiguous, and prefixes are pretty useful anyway.  Something like \"mpu\" (\"mpuHeaders\", \"mpuSize\", \"mpuCopies\", \"mpuMd5\") would at least distinguish these fields from other places we use them (e.g., \"headers\", which is all over the place)."},{"file":"lib/uploads/common.js","line":577,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":674,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this supposed to be removed?"},{"file":"lib/uploads/common.js","line":674,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":681,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Left in from debugging."},{"file":"lib/uploads/common.js","line":681,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":805,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think we decided this needed to be a new libmanta interface, right?"},{"file":"lib/uploads/common.js","line":805,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":829,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think in the case of getUpload we\u0027ve already called this, haven\u0027t we?"},{"file":"lib/uploads/common.js","line":829,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":839,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Yeah, we want to remove implementation details from this."},{"file":"lib/uploads/common.js","line":839,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":866,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/Attemtps/Attempts/"},{"file":"lib/uploads/common.js","line":866,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":869,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this function used anywhere?"},{"file":"lib/uploads/common.js","line":869,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Looks like it became obsolete at some point. Removed."},{"file":"lib/uploads/common.js","line":885,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/Attemtps/Attempts/"},{"file":"lib/uploads/common.js","line":885,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":928,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it worth asserting that this is a valid key?"},{"file":"lib/uploads/common.js","line":928,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":938,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it worth asserting that this is a valid key?"},{"file":"lib/uploads/common.js","line":938,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":952,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think this could be more clearly written by separating it out instead of using ||, especially if content-length is allowed to be zero."},{"file":"lib/uploads/common.js","line":952,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":1012,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Maybe assert that u.sharks is an array here?"},{"file":"lib/uploads/common.js","line":1012,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":1034,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"If we didn\u0027t take this \"if\", that would be a bug, right?"},{"file":"lib/uploads/common.js","line":1034,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":1046,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Maybe assert that this is a string here?"},{"file":"lib/uploads/common.js","line":1046,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":40,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"In general, I think it would be good to add argument assertions to these functions."},{"file":"lib/uploads/create.js","line":40,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":43,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"You probably want to wrap this with a setImmediate() call.  It\u0027s generally recommended that a function either invoke a callback synchronously or asynchronously, but always one or the other.  It can be pretty surprising to consumers when a normally-async function invokes the callback synchronously, especially if that happens only in an edge case.  A lot of code implicitly assumes the callback isn\u0027t going to be executed right away."},{"file":"lib/uploads/create.js","line":43,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":50,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I wonder if we should attempt to establish connections to these sharks and, if that fails within the usual \"connect\" timeout, then try the next pair, just like we do in the PUT path.  Obviously it\u0027s different here because we don\u0027t need to use these sharks now, but one problem I\u0027d like to address is that if we lose a shark, we may keep picking it for new uploads while it\u0027s down, which seems unnecessary.  (We\u0027ve talked about the harder case, where existing uploads are affected when a shark is down, but this case seems easier to deal with.)"},{"file":"lib/uploads/create.js","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I would like to do this, but I have a feeling it will take an insignificant amount of development time and will be important to test well. Do you think we could punt on it for now, and I can add that when I make some improvements I\u0027m planning for the shark client, such as using 100-continues on commits?"},{"file":"lib/uploads/create.js","line":50,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Definitely.  Let\u0027s just make sure there\u0027s a ticket filed."},{"file":"lib/uploads/create.js","line":50,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"MANTA-3220."},{"file":"lib/uploads/create.js","line":76,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think this could use a comment, if not a function to abstract what it\u0027s doing."},{"file":"lib/uploads/create.js","line":76,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Added a comment. The authorization code for MPU is heavily borrowed from the jobs authorization code. I think it might be good to improve the abstractions for plugging into authorization code as part of the metadata handling improvements (MANTA-3177)."},{"file":"lib/uploads/create.js","line":87,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it worth creating a function somewhere to abstract this?  Like createAuthResourceForMetadata(req, md)?"},{"file":"lib/uploads/create.js","line":87,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m not opposed to it, but I\u0027m not sure if you mean just for MPU or for authorization more generally. I am hesitant to touch the authorization code too much in this commit."},{"file":"lib/uploads/create.js","line":100,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What do you think of putting this chunk inline into uploadContextRoot?  I mainly ask because I was wondering why this wasn\u0027t in all the other operations\u0027 handlers, and I found that it\u0027s done by uploadsCommon.loadUpload() in the other cases, and it would be clearer if this code looked more like the code there.  Also, this doesn\u0027t benefit much from being a separate handler because it\u0027s synchronous."},{"file":"lib/uploads/create.js","line":100,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":125,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is probably where we should reject any conditional headers (like if-none-match, if-match, if-modified-since, etc.)."},{"file":"lib/uploads/create.js","line":125,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":152,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I know muskie uses this pattern a lot, but I think it\u0027s kind of error prone.  Presumably it\u0027s impossible for content-length to be 0, though?"},{"file":"lib/uploads/create.js","line":152,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think I\u0027ve made this better using jsprim\u0027s parseInteger and checking against max/min values allowed. Let me know if you think there are other ways to improve it."},{"file":"lib/uploads/create.js","line":152,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t see parseInteger() here. It seems like by the time we got here, it\u0027s already a number?"},{"file":"lib/uploads/create.js","line":152,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Yes, it is. Sorry for not updating this."},{"file":"lib/uploads/create.js","line":164,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this default hardcoded elsewhere, too?  It would be nice if it came from a constant with a comment."},{"file":"lib/uploads/create.js","line":164,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I added a constant to represent this in obj.js and commented it, along with some other default values."},{"file":"lib/uploads/create.js","line":168,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same here."},{"file":"lib/uploads/create.js","line":168,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":216,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why do we do that?"},{"file":"lib/uploads/create.js","line":216,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It\u0027s possible that the prefix directory hasn\u0027t been created yet. I\u0027m not sure if that answers your question."},{"file":"lib/uploads/create.js","line":216,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"When I wrote that, I didn\u0027t realize we allowed that.  I\u0027d probably rather have required that users create whatever directory tree they want, but it\u0027s probably not a big deal here and the ship may have sailed."},{"file":"lib/uploads/create.js","line":216,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Are we still talking about the parts directories (/jhendricks/uploads/a/abcdef...)? I would think we want to control the directory structure for those. That\u0027s the case with jobs as well, right?"},{"file":"lib/uploads/create.js","line":276,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be good to include a Location header here."},{"file":"lib/uploads/create.js","line":276,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"At one point we discussed this, and I thought that we decided that it wouldn\u0027t make sense to have a location header here, as it didn\u0027t follow the semantics of the response code 201."},{"file":"lib/uploads/create.js","line":276,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sorry I\u0027ve forgotten that.\n\nHTTP says that you can include a URL in a Location header for 201.  Did we decide it would be the wrong URL?  Usually it\u0027s useful for the client to look at this header to avoid having to either hardcode how to construct the URL for the thing that was just created or else make another round-trip to the server to find it."},{"file":"lib/uploads/get.js","line":31,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"missing a space"},{"file":"lib/uploads/get.js","line":31,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/redirect.js","line":14,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"possibly unused import"},{"file":"lib/uploads/redirect.js","line":14,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/redirect.js","line":37,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Does this work if partNum is 0?  Is that because it\u0027s a string in that case and hasn\u0027t been parsed as a number?  If so, could we assert that so that if someone decides to parse it earlier then it doesn\u0027t break this case silently?"},{"file":"lib/uploads/redirect.js","line":37,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think I\u0027ve fixed this in a way that makes sense. Let me know if you think there is a better way to do things."},{"file":"lib/uploads/upload.js","line":31,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think a previous version of this did check the durability level, but that seems to be gone.  Is that intentional?"},{"file":"lib/uploads/upload.js","line":31,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Yeah, it was removed intentionally. The original idea was that if the client tries to specify the durability-level on a part (as compared to what we determined on create), we should fail the request. This seems unnecessarily strict to me, as I could imagine a client that always adds that header by default. So I think it makes sense to just ignore headers controlling the durability-level for upload-part."},{"file":"lib/uploads/upload.js","line":31,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Personally, I think it would be better to be stricter here to avoid any confusion about the durability level."},{"file":"lib/uploads/upload.js","line":31,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Okay. I added a check back in. Do you think it should fail just if the durability-level is different, or if the header is present at all? I\u0027m leaning toward the former."},{"file":"lib/uploads/upload.js","line":48,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This seems like a confusing name for this error code, since you\u0027re not finalizing anything here."},{"file":"lib/uploads/upload.js","line":48,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/upload.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"The indenting is off here."},{"file":"lib/uploads/upload.js","line":52,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/upload.js","line":63,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This approach makes sense for now, and it\u0027s good that this is clearly called out and documented.  Longer term, do you think it makes sense to refactor the PUT code so that we\u0027re not calling directly into its handlers?  What do you think about adding documentation and argument assertions to that code, and adding a note that there are other callers than people might expect?"},{"file":"lib/uploads/upload.js","line":63,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"We\u0027ve talked about this some since this. I think the longer-term improvements can be a part of the work MANTA-3177.\n\nI also realized it\u0027s probably a mistake to export the PUT handlers directly. Instead, I\u0027ve created a new function in obj.js that returns the chain of PUT handlers that MPU needs. I added a comment there. Hopefully that makes it clearer to anyone modifying those handlers that they are consumed externally of obj.js."},{"file":"lib/uploads/upload.js","line":114,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"We should figure that one out."},{"file":"lib/uploads/upload.js","line":114,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Figured it out, but I don\u0027t actually think that handler is needed."},{"file":"package.json","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it intentional to change the spacing here?  It makes it harder to see the delta."},{"file":"package.json","line":0,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"package.json","line":26,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This makes sense for now, but we\u0027ve got to remember to fix it when we integrate the change."},{"file":"package.json","line":26,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"package.json","line":33,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m surprised this works -- you definitely want to set this back to 3.0.0 or later as it is upstream."},{"file":"package.json","line":33,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"sapi_manifests/muskie/template","line":137,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think you want to add an analogous block to etc/config.coal.json."},{"file":"sapi_manifests/muskie/template","line":137,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":17,"deletions":-4},{"file":"lib/common.js","type":"MODIFIED","insertions":39,"deletions":-38},{"file":"lib/dir.js","type":"MODIFIED","insertions":1,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":110,"deletions":-3},{"file":"lib/obj.js","type":"MODIFIED","insertions":8,"deletions":-2},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":202,"deletions":-4},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":54,"deletions":-11},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":103,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":522,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1064,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":306,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":85,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":123,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":50,"deletions":-50},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":10,"deletions":0}],"sizeInsertions":2783,"sizeDeletions":-115},{"number":"8","revision":"098fb505db405ebdeebf3de0df78110844425f1c","parents":["184e25ebc2cffc5ad8f3c5d5d8a6f8428f1d120e"],"ref":"refs/changes/92/1292/8","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1491860784,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491860811,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"etc/config.coal.json","line":48,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I\u0027m assuming this (and likely a bunch of other stuff) came in with the rebase?"},{"file":"etc/config.coal.json","line":48,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Yeah, I hadn\u0027t updated to the most recent version of muskie it seems."},{"file":"lib/uploads/abort.js","line":76,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should this be .debug() too?"},{"file":"lib/uploads/abort.js","line":76,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/common.js","line":356,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"s/metdata/metadata/"},{"file":"lib/uploads/common.js","line":356,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":74,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this vestigial?"},{"file":"lib/uploads/create.js","line":74,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":126,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Can this function be removed now?"},{"file":"lib/uploads/create.js","line":126,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/upload.js","line":22,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I don\u0027t actually know if we want to do this, so I\u0027m going to remove this todo for now."},{"file":"test/helper.js","line":71,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Where does this end up coming from?  I know the auth tests require you to have run \"acsetup.js\" to create a test subuser and roles and such.  Should we use that here?"},{"file":"test/helper.js","line":71,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I don\u0027t think this is actually needed."},{"file":"test/mpu/abort.test.js","line":16,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What\u0027s all this about?"},{"file":"test/mpu/abort.test.js","line":16,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"All of the muskie tests do this, and I think it\u0027s pretty janky. As far as I can tell, we do this because it forces the code in the helper file to get re-run for each set of tests. Otherwise, it only gets run once, and the initialization code needed doesn\u0027t get run again."},{"file":"test/mpu/commit.test.js","line":65,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Replace these with a ticket?"},{"file":"test/mpu/commit.test.js","line":65,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I added the MD5 tests, and filed MANTA-3221."},{"file":"test/mpu/upload.test.js","line":59,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Replace with a ticket?"},{"file":"test/mpu/upload.test.js","line":59,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"MANTA-3221 filed for the first, and I believe the second one isn\u0027t needed."},{"file":"test/obj.test.js","line":278,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"OOC, why did this have to change?"},{"file":"test/obj.test.js","line":278,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I ran these tests against a muskie using a config file without a \"maxObjectCopies\" field, and they failed. We don\u0027t actually enforce that this value exists in the config, and use a default value of 9 if none exists. The value we ship in the config.coal.json is 6 copies, which is why I think no one has noticed (or at the least, updated this)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":40,"deletions":-38},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":72,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":250,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":54,"deletions":-11},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":542,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1133,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":349,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":107,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"test/helper.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":230,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":269,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":799,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":547,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":107,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":260,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":423,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":276,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":5843,"sizeDeletions":-97},{"number":"9","revision":"626b688c175b68ade4a79699f91dbbfcb52df626","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/9","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1492460950,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1492464006,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492460977,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/uploads/commit.js","line":66,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I was actually thinking of putting the assertion inside the sharkClient -- when it returned a client back, making sure that it had the same parameters it was asked for.  Or we could add the same assertions to the other caller of getClient()?  Or leave it.  Your call."},{"file":"lib/uploads/commit.js","line":66,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Okay, I moved some assertions to getClient, and the muskie test suite passes with that."},{"file":"lib/uploads/commit.js","line":508,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should this one be \"debug\" too?"},{"file":"lib/uploads/commit.js","line":508,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I thought this would be good to log at `info`, or otherwise we lose information like the parts MD5 and the number of parts committed when the upload is garbage collected. I\u0027m thinking of situations like LAB-185, when that would be useful (and we will have less verbose logs than we did then, as I\u0027ve pared down the log statements quite a bit)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":54,"deletions":-11},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":564,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1134,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":335,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":121,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6345,"sizeDeletions":-102},{"number":"10","revision":"3d918142dc5944e3b798005604132436a6886135","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/10","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1492492072,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1492635539,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492492099,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/uploads/commit.js","line":94,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I believe that InternalError needs to take a cause object, not a string. I see this a few times in this CR - it might be worth a double check."},{"file":"lib/uploads/commit.js","line":94,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for pointing that out --  this is indeed the case. I\u0027ve updated all the InteralErrors in this CR to have proper causes. Do you think it\u0027s worth adding assertions to the InternalError constructor? I know this is related to the work you are doing with MANTA-3123."},{"file":"lib/uploads/commit.js","line":94,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"That\u0027s a good idea! I\u0027ll look into that."},{"file":"lib/uploads/commit.js","line":463,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It would be awesome if we could get this all in one log statement somehow. If there\u0027s some sort of packet corruption in the DC, this could happen to more than one operation at a time. If that\u0027s the case it might be confusing to see what\u0027s going on due to the number of requests all logging these errors simultaneously."},{"file":"lib/uploads/commit.js","line":463,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/commit.js","line":465,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"We should try to give InternalErrors causes (MANTA-3123)"},{"file":"lib/uploads/commit.js","line":465,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":63,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This should probably be debug"},{"file":"lib/uploads/create.js","line":63,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/create.js","line":210,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Do we need to do these assertions? I thought the above code is doing what this block does."},{"file":"lib/uploads/create.js","line":210,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It may be overkill. Writing this validation code proved to be really annoying and prone to errors, and having the assertions saved me from making mistakes for various edge cases. I would rather have additional assertions here, before continuing with teh request, mostly to prevent regressions later on down the line."},{"file":"lib/uploads/create.js","line":210,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Sounds good. Thanks!"},{"file":"lib/uploads/create.js","line":304,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"completed*"},{"file":"lib/uploads/create.js","line":304,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"},{"file":"lib/uploads/upload.js","line":53,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"I think we could forgo the \u0027else\u0027 statement here by doing something like\n\nnext(new ...);\nreturn;\n\nI\u0027m not sure if that would alter the flow in a positive/negative way, but it\u0027s a thought. I see both patterns being used outside of this CR, so either way is probably fine."},{"file":"lib/uploads/upload.js","line":53,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Yeah, that\u0027s true. This is relevant to your question about whether there\u0027s a convention between branching on a conditional, calling next() in each branch, versus explicitly returning after calling next(). From what I\u0027ve seen, the convention for next() matches that of callbacks in general, which can be done either way. Generally I will tend toward using conditional branches so it\u0027s very clear which callback/next path we take, and only explicitly return if it would improve readability of the function (like going more than one or two branches deep). In this case, I don\u0027t think it matters too much."},{"file":"lib/uploads/upload.js","line":53,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Okay, that sounds reasonable. Thanks!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":64,"deletions":-12},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":562,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1134,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":335,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":121,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6353,"sizeDeletions":-103},{"number":"11","revision":"66d90b7f0e3c13de1f3bfaaf9130f0e343dcd7bf","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/11","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1492652971,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492652998,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/uploads/commit.js","line":469,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Did you mean this to be `new Error(msg)`?"},{"file":"lib/uploads/commit.js","line":469,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":64,"deletions":-12},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":566,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1134,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":336,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":116,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6353,"sizeDeletions":-103},{"number":"12","revision":"bf4aa641ad89c505b62ba9237a19815ec3ebba48","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/12","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1492791170,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1492791328,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1492791197,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":64,"deletions":-12},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":566,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1134,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":336,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":116,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6353,"sizeDeletions":-103},{"number":"13","revision":"a29b069584cfaa3dbbd54120ead6e15dec02b0b7","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/13","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1493311845,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493414716,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493827683,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493311877,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/uploads/common.js","line":407,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"What happens to the possible 0-byte object for the part that was uploaded?  (Maybe the same as for streaming uploads, where only the cruft job cleans it up?)"},{"file":"lib/uploads/common.js","line":407,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"To summarize what we discussed in person:\n\nThere are a few cases in which a zero-byte object can be created through MPU.\n\n1) No parts are uploaded, and the MPU is committed\n2) Parts are uploaded, but none are committed\n3) A single zero-byte part is committed\n\nIn all cases, the commit path does not talk to mako. For non-zero byte objects, the mako-finalize routine invoked by the commit path will clean up parts that are used for the object.\n\nIn the first case, nothing was ever uploaded to mako, so there is nothing to clean up.\n\nIn cases 2 and 3, however, there may be parts, either zero-byte or not, that exist on mako. It is important that we still have references to which sharks these parts are on so that they can be cleaned up. For this we can rely on two things: 1) the sharks a part is uploaded to are stored in the part record, and 2) MPU GC will have to clean up all parts uploaded for an MPU, regardless of whether the MPU was committed or aborted. This is because it is possible for the user to commit a subset of parts uploaded."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":64,"deletions":-12},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":566,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1145,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":336,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":116,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6364,"sizeDeletions":-103},{"number":"14","revision":"dd5e5f2f78e8e20853b73209862ca5d629fb2351","parents":["b8cc937d7aed6900678ec2f024e96635b01a729b"],"ref":"refs/changes/92/1292/14","uploader":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"createdOn":1493827763,"author":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493414716,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493827683,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493311877,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1493827783,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/audit.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":27,"deletions":-6},{"file":"lib/common.js","type":"MODIFIED","insertions":43,"deletions":-40},{"file":"lib/dir.js","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"lib/errors.js","type":"MODIFIED","insertions":43,"deletions":-13},{"file":"lib/obj.js","type":"MODIFIED","insertions":71,"deletions":-9},{"file":"lib/other.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":251,"deletions":-5},{"file":"lib/shark_client.js","type":"MODIFIED","insertions":64,"deletions":-12},{"file":"lib/uploads/abort.js","type":"ADDED","insertions":101,"deletions":0},{"file":"lib/uploads/commit.js","type":"ADDED","insertions":566,"deletions":0},{"file":"lib/uploads/common.js","type":"ADDED","insertions":1145,"deletions":0},{"file":"lib/uploads/create.js","type":"ADDED","insertions":336,"deletions":0},{"file":"lib/uploads/get.js","type":"ADDED","insertions":51,"deletions":0},{"file":"lib/uploads/index.js","type":"ADDED","insertions":29,"deletions":0},{"file":"lib/uploads/redirect.js","type":"ADDED","insertions":106,"deletions":0},{"file":"lib/uploads/upload.js","type":"ADDED","insertions":116,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4},{"file":"sapi_manifests/muskie/template","type":"MODIFIED","insertions":5,"deletions":0},{"file":"test/dir.test.js","type":"MODIFIED","insertions":26,"deletions":-5},{"file":"test/mpu/abort.test.js","type":"ADDED","insertions":193,"deletions":0},{"file":"test/mpu/auth.test.js","type":"ADDED","insertions":716,"deletions":0},{"file":"test/mpu/commit.test.js","type":"ADDED","insertions":702,"deletions":0},{"file":"test/mpu/create.test.js","type":"ADDED","insertions":439,"deletions":0},{"file":"test/mpu/get.test.js","type":"ADDED","insertions":88,"deletions":0},{"file":"test/mpu/helper.js","type":"ADDED","insertions":573,"deletions":0},{"file":"test/mpu/redirect.test.js","type":"ADDED","insertions":355,"deletions":0},{"file":"test/mpu/upload.test.js","type":"ADDED","insertions":298,"deletions":0},{"file":"test/obj.test.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":6364,"sizeDeletions":-103}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}