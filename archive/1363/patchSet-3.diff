From db1a581989faa6d9d8b8dfab21b73fe6c340455e Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Mon, 10 Apr 2017 17:49:29 +0200
Subject: [PATCH] TOOLS-1642 sdcadm should use cueball HttpAgent to connect to
 Triton HTTP services

---
 CHANGES.md    |  4 ++++
 lib/sdcadm.js | 64 +++++++++++++++++++++++++++++++++++++++++++++++----
 package.json  |  1 +
 3 files changed, 64 insertions(+), 5 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 8b96829..6d88d63 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -42,11 +42,15 @@
 
 ## 1.15.2
 
+- TOOLS-1642: Use cueball HttpAgent to connect to Triton HTTP services.
+- TOOLS-1648 sdcadm post-setup cmon should setup cmon-agent
 - TOOLS-1662: Fix 'sdcadm experimental add-new-agent-svcs' when adding new
   services.
 
 ## 1.15.1
 
+- TOOLS-1574, TOOLS-1631: Fix `sdcadm experimental update AGENT` when there are
+  no agent instances or missing service image uuids.
 - TOOLS-1633: Fix 'sdcadm up' of the assets zone. It was broken in
   version 1.15.0.
 
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 3b99fbd..34ec452 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -32,6 +32,7 @@ var vasync = require('vasync');
 var WfClient = require('wf-client');
 var uuid = require('node-uuid');
 var ProgressBar = require('progbar').ProgressBar;
+var cueball = require('cueball');
 
 var common = require('./common');
 var svcadm = require('./svcadm');
@@ -114,12 +115,62 @@ function SdcAdm(options) {
     self._reprovFailLockPath = '/var/sdcadm/reprovFailLock.json';
 
     self.userAgent = UA;
+    Object.defineProperty(this, 'cueballAgent', {
+        get: function () {
+            if (self._cueballAgent === undefined) {
+                self._cueballAgent = new cueball.HttpAgent({
+                    log: self.log,
+                    resolvers: [format('binder.%s.%s',
+                        self.config.datacenter_name, self.config.dns_domain)],
+                    initialDomains: [
+                        'cnapi',
+                        'napi',
+                        'papi',
+                        'sapi',
+                        'vmapi'
+                    ].map(function (s) {
+                        return format('%s.%s.%s', s,
+                            self.config.datacenter_name,
+                            self.config.dns_domain);
+                    }),
+                    spares: 4,
+                    maximum: 12,
+                    recovery: {
+                        default: {
+                            timeout: 2000,
+                            maxTimeout: 8000,
+                            retries: 3,
+                            delay: 0,
+                            maxDelay: 1000
+                        }
+                    }
+                });
+
+                Object.keys(self._cueballAgent.pools).forEach(
+                    function (p_domain) {
+                    var pool = self._cueballAgent.pools[p_domain];
+                    pool.on('stateChanged', function (state) {
+                        self.log.debug('Pool %s entered state: %s',
+                            p_domain, state);
+                    });
+                });
+
+                Object.defineProperty(self, 'pools', {
+                    get: function () {
+                        return self._cueballAgent.pools;
+                    }
+                });
+            }
+
+            return self._cueballAgent;
+        }
+    });
     Object.defineProperty(this, 'sapi', {
         get: function () {
             if (self._sapi === undefined) {
                 self._sapi = new sdcClients.SAPI({
                     url: self.config.sapi.url,
-                    agent: false,
+                    agent: self.cueballAgent,
                     userAgent: self.userAgent,
                     log: self.log,
                     headers: {
@@ -135,7 +186,7 @@ function SdcAdm(options) {
             if (self._cnapi === undefined) {
                 self._cnapi = new sdcClients.CNAPI({
                     url: self.config.cnapi.url,
-                    agent: false,
+                    agent: self.cueballAgent,
                     userAgent: self.userAgent,
                     log: self.log,
                     headers: {
@@ -152,7 +203,7 @@ function SdcAdm(options) {
             if (self._papi === undefined) {
                 self._papi = new sdcClients.PAPI({
                     url: self.config.papi.url,
-                    agent: false,
+                    agent: self.cueballAgent,
                     userAgent: self.userAgent,
                     log: self.log,
                     headers: {
@@ -168,7 +219,7 @@ function SdcAdm(options) {
             if (self._vmapi === undefined) {
                 self._vmapi = new sdcClients.VMAPI({
                     url: self.config.vmapi.url,
-                    agent: false,
+                    agent: self.cueballAgent,
                     userAgent: self.userAgent,
                     log: self.log,
                     headers: {
@@ -251,7 +302,7 @@ function SdcAdm(options) {
             if (self._napi === undefined) {
                 self._napi = new sdcClients.NAPI({
                     url: self.config.napi.url,
-                    agent: false,
+                    agent: self.cueballAgent,
                     userAgent: self.userAgent,
                     log: self.log,
                     headers: {
@@ -397,6 +448,9 @@ SdcAdm.prototype.fini = function fini() {
     if (self.sadm_ur !== null) {
         self.sadm_ur.close();
     }
+    if (self._cueballAgent !== undefined) {
+        self.cueballAgent.stop();
+    }
 };
 
 SdcAdm.prototype._returnUrClients = function _returnUrClients() {
diff --git a/package.json b/package.json
index 8214f3f..11f2037 100644
--- a/package.json
+++ b/package.json
@@ -10,6 +10,7 @@
     "backoff": "2.5.0",
     "bunyan": "0.23.1",
     "cmdln": "4.2.1",
+    "cueball": "2.2.4",
     "extsprintf": "^1.3.0",
     "kthxbai": "~0.4.0",
     "joyent-schemas": "git+https://github.com/joyent/schemas.git#385e6eb",
-- 
2.21.0

