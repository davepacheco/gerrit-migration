From cc4c27343a866fee28f54bd075e18a3c41c4b8a5 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Thu, 23 Mar 2017 15:12:39 -0700
Subject: [PATCH] DOCKER-1022 fix 'make git-hooks' to install a pre-commit hook
 that works, add Copyright checker

---
 Makefile            |  4 ++--
 tools/pre-commit.sh | 27 ++++++++++++++++++++++++++-
 2 files changed, 28 insertions(+), 3 deletions(-)
 mode change 100644 => 100755 tools/pre-commit.sh

diff --git a/Makefile b/Makefile
index ffe15f8..b8c770c 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright 2016 Joyent, Inc.
+# Copyright 2017 Joyent, Inc.
 #
 
 NAME:=docker
@@ -95,7 +95,7 @@ test-integration-in-coal:
 
 .PHONY: git-hooks
 git-hooks:
-	[[ -e .git/hooks/pre-commit ]] || ln -s ./tools/pre-commit.sh .git/hooks/pre-commit
+	[[ -e .git/hooks/pre-commit ]] || ln -sf ../../tools/pre-commit.sh .git/hooks/pre-commit
 
 
 .PHONY: check-docs
diff --git a/tools/pre-commit.sh b/tools/pre-commit.sh
old mode 100644
new mode 100755
index 48f2d61..3eeaf69
--- a/tools/pre-commit.sh
+++ b/tools/pre-commit.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright 2017 Joyent, Inc.
 #
 
 #
@@ -18,5 +18,30 @@
 set -o errexit
 set -o pipefail
 
+function ensure_copyright_year() {
+    currYear=$(date -u "+%Y")
+    filesToBeCommited=$(git diff --staged --name-only HEAD)
+    nErrs=0
+    for f in $filesToBeCommited; do
+        year=$((grep Copyright $f || true) \
+             | (grep Joyent || true) \
+             | sed -E 's/^(.*)([0-9]{4})(.*)$/\2/')
+        if [[ -n "$year" && "$year" != "$currYear" ]]; then
+            echo "$f: error: Copyright year is $year instead of $currYear"
+            nErrs=$(( $nErrs + 1 ))
+        fi
+    done
+    if [[ $nErrs -gt 0 ]]; then
+        exit 1
+    fi
+}
+
+
+#---- mainline
+
+# Redirect output to stderr.
+exec 1>&2
+
+ensure_copyright_year
 make check
 make test
-- 
2.21.0

