From 9d80711c42363f76b4700f9959137c31b46cf90c Mon Sep 17 00:00:00 2001
From: Julien Gilli <julien.gilli@joyent.com>
Date: Tue, 25 Jul 2017 20:47:08 -0700
Subject: [PATCH] TOOLS-1823 split sdcadm experimental volapi into sdcadm
 postsetup and sdcadm experimental commands

---
 tools/setup/setup.sh | 12 +++++-------
 1 file changed, 5 insertions(+), 7 deletions(-)

diff --git a/tools/setup/setup.sh b/tools/setup/setup.sh
index 8262643..111e1b2 100644
--- a/tools/setup/setup.sh
+++ b/tools/setup/setup.sh
@@ -275,8 +275,8 @@ else
     fatal "Could not find latest sdcadm version with tritonnfs support"
 fi
 
-echo "Enabling experimental VOLAPI service"
-sdcadm experimental volapi
+echo "Setting up VOLAPI service"
+sdcadm post-setup volapi
 
 upgrade_core_service_to_latest_branch_image "sdc" "tritonnfs"
 upgrade_core_service_to_latest_branch_image "workflow" "tritonnfs"
@@ -291,17 +291,15 @@ upgrade_core_service_to_latest_branch_image "volapi" "tritonnfs"
 echo "Running other experimental migration processes"
 # "sdcadm experimental update-other" takes care of doing things such as adding a
 # VOLAPI_SERVICE key in the sdc's SAPI application metadata, running VMAPI
-# migrations, etc., which are not done by "sdcadm experimental volapi", so this
+# migrations, etc., which are not done by "sdcadm post-setup volapi", so this
 # needs to be run every time to make sure everything is up to date.
 sdcadm experimental update-other
 
 # Needed to add additional programs in the HN's GZ, such as sdc-volapi
 upgrade_gz_tools_to_latest_branch_image tritonnfs
 
-echo "Restarting sdc-docker to account for configuration changes..."
-/opt/smartdc/bin/sdc-login -l docker svcadm restart config-agent
-/opt/smartdc/bin/sdc-login -l docker svcadm restart docker
-echo "sdc-docker restarted!"
+# Now enable the experimental_nfs_shared_volumes flag in SAPI
+sdcadm experimental nfs-volumes
 
 EOS
 
-- 
2.21.0

