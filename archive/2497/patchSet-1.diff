From 0dccc788dabc4fea279f83bf5066d99252d75cd0 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 5 Sep 2017 16:03:35 -0700
Subject: [PATCH] CNAPI-717 CNAPI ServerList endpoint should doc that max limit
 is 1000

---
 docs/index.md                 | 22 +++++++++++-----------
 lib/endpoints/nics.js         |  2 +-
 lib/endpoints/servers.js      | 29 +++++++++++++++++++++++++----
 lib/workflows/server-setup.js |  2 +-
 4 files changed, 38 insertions(+), 17 deletions(-)

diff --git a/docs/index.md b/docs/index.md
index 28c63d3..cbe91d0 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -1055,17 +1055,17 @@ Returns Servers present in datacenter.
 
 ### Inputs
 
-| Param     | Type    | Description                                                               |
-| --------- | ------- | ------------------------------------------------------------------------- |
-| uuids     | String  | Comma seperated list of UUIDs to look up                                  |
-| setup     | Boolean | Return only setup servers                                                 |
-| headnode  | Boolean | Return only headnodes                                                     |
-| reserved  | Boolean | Return only reserved servers                                              |
-| reservoir | Boolean | Return only reservoir servers                                             |
-| hostname  | String  | Return machine with given hostname                                        |
-| extras    | String  | Comma seperated values: agents, vms, memory, disk, sysinfo, capacity, all |
-| limit     | Number  | Maximum number of results to show                                         |
-| offset    | Number  | Offset the subset of results returned                                     |
+| Param     | Type    | Description                                                                                                               |
+| --------- | ------- | ------------------------------------------------------------------------------------------------------------------------- |
+| uuids     | String  | Comma seperated list of UUIDs to look up                                                                                  |
+| setup     | Boolean | Return only setup servers                                                                                                 |
+| headnode  | Boolean | Return only headnodes                                                                                                     |
+| reserved  | Boolean | Return only reserved servers                                                                                              |
+| reservoir | Boolean | Return only reservoir servers                                                                                             |
+| hostname  | String  | Return machine with given hostname                                                                                        |
+| extras    | String  | Comma seperated values: agents, vms, memory, disk, sysinfo, capacity, all                                                 |
+| limit     | Integer | Maximum number of results to return. It must be between 1-1000, inclusive. Defaults to 1000 (the maxmimum allowed value). |
+| offset    | Integer | Offset the subset of results returned                                                                                     |
 
 
 ### Responses
diff --git a/lib/endpoints/nics.js b/lib/endpoints/nics.js
index c090e75..518f389 100644
--- a/lib/endpoints/nics.js
+++ b/lib/endpoints/nics.js
@@ -70,7 +70,7 @@ Nic.update = function handlerNicUpdate(req, res, next) {
     if (action !== 'update' && action !== 'replace' && action !== 'delete') {
         res.send(500, validation.formatValidationErrors([ {
             param: 'action',
-            message: 'action must be \'update\', \'replace\', or \'delete\''
+            msg: 'action must be \'update\', \'replace\', or \'delete\''
         }]));
         next();
         return;
diff --git a/lib/endpoints/servers.js b/lib/endpoints/servers.js
index 489c0c1..b0e58c9 100644
--- a/lib/endpoints/servers.js
+++ b/lib/endpoints/servers.js
@@ -30,6 +30,14 @@ var ModelServer = require('../models/server');
 var validation = require('../validation/endpoints');
 
 
+// ---- globals/constants
+
+var SERVER_LIST_MIN_LIMIT = 1;
+var SERVER_LIST_MAX_LIMIT = 1000;
+
+
+// ---- exports
+
 function Server() {}
 
 
@@ -48,8 +56,8 @@ function Server() {}
  * @param {Boolean} reservoir Return only reservoir servers
  * @param {String} hostname Return machine with given hostname
  * @param {String} extras Comma seperated values: agents, vms, memory, disk, sysinfo, capacity, all
- * @param {Number} limit Maximum number of results to show
- * @param {Number} offset Offset the subset of results returned
+ * @param {Integer} limit Maximum number of results to return. It must be between 1-1000, inclusive. Defaults to 1000 (the maxmimum allowed value).
+ * @param {Integer} offset Offset the subset of results returned
  *
  * @example GET /servers
  * @example GET /servers?uuids=uuid1,uuid2
@@ -90,8 +98,8 @@ Server.list = function handlerSeverList(req, res, next) {
             ['sanitize', 'toBoolean']
         ],
         'hostname': ['optional', 'isStringType', 'isTrim'],
-        'limit': ['optional', 'isNumberType'],
-        'offset': ['optional', 'isNumberType'],
+        'limit': ['optional', 'isInt'],
+        'offset': ['optional', 'isInt'],
         'uuids': [
             ['optional', undefined],
             /*JSSTYLED*/
@@ -104,6 +112,19 @@ Server.list = function handlerSeverList(req, res, next) {
         return;
     }
 
+    if (req.params.hasOwnProperty('limit')) {
+        var limit = Number(req.params.limit); // TODO: int guard, do it above?
+        if (limit < SERVER_LIST_MIN_LIMIT || SERVER_LIST_MAX_LIMIT < limit) {
+            res.send(400, validation.formatValidationErrors([ {
+                param: 'limit',
+                msg: 'limit must be in the range ' + SERVER_LIST_MIN_LIMIT
+                    + '-' + SERVER_LIST_MAX_LIMIT + ' (inclusive)'
+            }]));
+            next();
+            return;
+        }
+    }
+
     async.waterfall([
         function (cb) {
             var options = {};
diff --git a/lib/workflows/server-setup.js b/lib/workflows/server-setup.js
index 25c4f2a..e6b0ca6 100644
--- a/lib/workflows/server-setup.js
+++ b/lib/workflows/server-setup.js
@@ -115,7 +115,7 @@ function fetchSetupFiles(job, callback) {
 
     cnapi.post(urUrl, payload, function (error, req, res) {
         if (error) {
-            job.log.info('Error executing joysetup: ' + error.message);
+            job.log.info('Error fetching setup files: ' + error.message);
             job.log.info(error.stack.toString());
             callback(error);
             return;
-- 
2.21.0

