From eb10bdf9bc08a65cc187baefb23234192e0ee03c Mon Sep 17 00:00:00 2001
From: Bryan Cantrill <bryan@joyent.com>
Date: Sun, 8 Oct 2017 08:53:21 +0000
Subject: [PATCH] OS-6387 1K zfs_abd_chunk_size is inducing excessive
 fragmentation

---
 usr/src/uts/common/fs/zfs/abd.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/common/fs/zfs/abd.c b/usr/src/uts/common/fs/zfs/abd.c
index 92e7814df5..49e23bd43d 100644
--- a/usr/src/uts/common/fs/zfs/abd.c
+++ b/usr/src/uts/common/fs/zfs/abd.c
@@ -146,9 +146,12 @@ boolean_t zfs_abd_scatter_enabled = B_TRUE;
  * it at runtime would cause ABD iteration to work incorrectly for ABDs which
  * were allocated with the old size, so a safeguard has been put in place which
  * will cause the machine to panic if you change it and try to access the data
- * within a scattered ABD.
+ * within a scattered ABD. Note that tuning this value to be smaller than the
+ * page size can induce heavy fragmentation in the slab layer, which may itself
+ * result in more memory waste than is saved by the smaller chunk size -- and
+ * will induces more computational work in the slab layer. Tune with caution!
  */
-size_t zfs_abd_chunk_size = 1024;
+size_t zfs_abd_chunk_size = 4096;
 
 #ifdef _KERNEL
 extern vmem_t *zio_alloc_arena;
-- 
2.21.0

