{"project":"joyent/illumos-joyent","branch":"master","id":"Ie2e74e16e5398731f7fcbec3126085ce72c3b236","number":"832","subject":"OS-5751 lxbrand bind 9.10 can\u0027t bind to AF_NETLINK Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/832","commitMessage":"OS-5751 lxbrand bind 9.10 can\u0027t bind to AF_NETLINK\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1478028439,"lastUpdated":1478105686,"open":false,"status":"MERGED","comments":[{"timestamp":1478028439,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1478029668,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478029962,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1478029991,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478030067,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1478032925,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\nLTP passes on 64/32 bit.  lx-tests passes on 64-bit (which is the only arch it supports for now)"},{"timestamp":1478039464,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)\n\nThe code itself seems fine. But I was a little murky on the one comment -- probably a lack of understanding netlink on my part."},{"timestamp":1478043011,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1478043075,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1478051262,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1478089808,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1478097757,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1478098004,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1478100887,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1478101501,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1478102533,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5:\n\nbind 9.10 was tested under the conditions listed in the ticket and was found to be functioning.  A simple test to trigger the lx-unsupported output was also run."},{"timestamp":1478105686,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"5","revision":"e2e74e16e5398731f7fcbec3126085ce72c3b236","parents":["0aa3d09c1783d581c3207ef29cd4cc12f0007420"],"ref":"refs/changes/32/832/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1478101501,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478089808,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478097757,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478098004,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1478105686,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","type":"MODIFIED","insertions":79,"deletions":-7}],"sizeInsertions":79,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"10d7d7b777185cf09e5413c745f66fb61d187470","parents":["8f4dce5d41f21746863ef9c9670a26b7599ad302"],"ref":"refs/changes/32/832/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1478028439,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1532,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"can you move the above block after the following declaration?"},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1532,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","type":"MODIFIED","insertions":79,"deletions":-7}],"sizeInsertions":79,"sizeDeletions":-7},{"number":"2","revision":"74303cfd2cdcc809fe829f8ea08092f0e7a0a189","parents":["8f4dce5d41f21746863ef9c9670a26b7599ad302"],"ref":"refs/changes/32/832/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1478029962,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478030067,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478039464,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1540,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Nit: rt_netlink made me think this was a funciton, eventually realized it refers to rtnetlink(7)."},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1540,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1541,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I\u0027m a bit lost here. My understanding is that we are writing an unsupported entry to the log because this is not an rtnetlink(7) msg, but the check above was to see if the msg was not directed solely at the kernel; i.e., it\u0027s aimed at user process or a multicast group. Is it always the case that any netlink message directed solely at the kernel is a rtnetlink(7) one? My quick reading of an article on netlink makes it seem that a netlink message of other types might be aimed at the kernel. So I\u0027m confused why this comment is referring purely to rtnetlink(7). That is, this comment makes me believe that if we aren\u0027t in this if-case that the message is _definitely_ rtnetlink(7), but I don\u0027t see how that is. Since I\u0027m not familiar with netlink I\u0027m probably missing something."},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1541,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"No, the lx_unsupported call is because the message is targeted at a port or group.  I don\u0027t have a deep understanding of the guts of netlink, but we certainly don\u0027t have any logic which keys off ports and groups today, so it\u0027s probably best to at least fire a probe when that behavior is being triggered.\n\nIf the caller doesn\u0027t pass in an address, which I believe is the common case for consumers such as iputils, then it\u0027s not a factor at all."},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","line":1541,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Right, when nl_pid (lxnl_port) and nl_groups (lxnl_groups) are both 0 it means \"send to the kernel\". In this case we are _not_ sending to the kernel, but keyed on a specific port or group as you said. So I understand why you are calling lx_unsupported(). What I don\u0027t follow is why your comment specifically calls out rtnetlink(7), which is a type of netlink family, of which there are many. So where you say \"support for netlink messages beyond rt_netlink\" I get confused because its my understanding we could be in this part of the code for other types of netlink families. I would expect something more like \"Support for netlink messages directed at a port or group are...\". I hope that clarifies my confusion."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","type":"MODIFIED","insertions":79,"deletions":-7}],"sizeInsertions":79,"sizeDeletions":-7},{"number":"3","revision":"edfc7bfe79a9cc0ad8316617192ee5460212c908","parents":["71eae4df251e827c8d207b8ccb808a703740b189"],"ref":"refs/changes/32/832/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1478043075,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478089808,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478098004,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478097757,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","type":"MODIFIED","insertions":79,"deletions":-7}],"sizeInsertions":79,"sizeDeletions":-7},{"number":"4","revision":"7a34a853e8be1f448c6dc8e672d8e0d4e60453fe","parents":["0aa3d09c1783d581c3207ef29cd4cc12f0007420"],"ref":"refs/changes/32/832/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1478100887,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478089808,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478098004,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478097757,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","type":"MODIFIED","insertions":79,"deletions":-7}],"sizeInsertions":79,"sizeDeletions":-7},{"number":"5","revision":"e2e74e16e5398731f7fcbec3126085ce72c3b236","parents":["0aa3d09c1783d581c3207ef29cd4cc12f0007420"],"ref":"refs/changes/32/832/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1478101501,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478089808,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478098004,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1478105686,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1478097757,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/io/lx_netlink.c","type":"MODIFIED","insertions":79,"deletions":-7}],"sizeInsertions":79,"sizeDeletions":-7}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}