{"project":"joyent/illumos-extra","branch":"master","id":"I38b3e673ae75d709a59a608137850367dae331de","number":"5066","subject":"OS-7373 gcc7 strapfix is incomplete OS-7376 binutils build has incorrect compiler flags OS-7380 openssl should use the strap compiler OS-7382 nss-nspr build doesn\u0027t use LDFLAGS OS-7384 libgcc-unwind.map should be version 2 style Reviewed by: Robert Mustac","owner":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"url":"https://cr.joyent.us/5066","commitMessage":"OS-7373 gcc7 strapfix is incomplete\nOS-7376 binutils build has incorrect compiler flags\nOS-7380 openssl should use the strap compiler\nOS-7382 nss-nspr build doesn\u0027t use LDFLAGS\nOS-7384 libgcc-unwind.map should be version 2 style\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1542325833,"lastUpdated":1542803743,"open":false,"status":"MERGED","comments":[{"timestamp":1542325833,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 1."},{"timestamp":1542325895,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1: Code-Review-1"},{"timestamp":1542373569,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1: -Code-Review"},{"timestamp":1542403072,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)\n\nIn general, I think this makes sense. I\u0027m still trying to convince myself on the main phase and just copying the runtime libraries. Isn\u0027t there a chance where if we\u0027re building a runtime library on a build machine newer than the target platform, we can end up adding additional libc features detected than actually exist? I think the code below is correct for what we\u0027re trying to do, just not 100% sure yet that it makes sense."},{"timestamp":1542408708,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nI think I\u0027m not understanding your comment about a newer build machine. We never promise to be forwards compatible like this, no? That\u0027s why our platform builds are supposed to be on the oldest supported platform?\n\nAre you thinking more of the casual developer case? If my build zone just happens to be a little bit ahead and I\u0027m building some special PI that\u0027s behind? I guess it\u0027s possible, but also pretty simple to rectify later if we need like I suggested.\n\nMakefile.gcc - I considered this, but I don\u0027t think it will ever make sense to have more than two gcc\u0027s will it? It didn\u0027t seem worth the effort, but happy to do so if you\u0027d prefer."},{"timestamp":1542409695,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 2."},{"timestamp":1542467700,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n\u003e I think I\u0027m not understanding your comment about a newer build\n \u003e machine. We never promise to be forwards compatible like this, no?\n \u003e That\u0027s why our platform builds are supposed to be on the oldest\n \u003e supported platform?\n \u003e \n \u003e Are you thinking more of the casual developer case? If my build\n \u003e zone just happens to be a little bit ahead and I\u0027m building some\n \u003e special PI that\u0027s behind? I guess it\u0027s possible, but also pretty\n \u003e simple to rectify later if we need like I suggested.\n\nHistorically we\u0027ve tried to build the platform image such that it the resulting artifacts are independent of the build machine from a correctness of running the artifact perspective (hence why everything is trying to look at the proto area). So we\u0027ve tried to avoid the \u0027oldest supported platform\u0027 issue with the platform build for the non-build machine artifacts. Otherwise that would suggest software built against proto/ can\u0027t use the features from proto/ that aren\u0027t on the build machine as well. Now, I agree that the building the past case is rare, so it\u0027s probably not the case to optimize for. However, it seems like this also means we can\u0027t have a runtime library that uses the features present in proto/, but no the build machine. But maybe that\u0027s OK.\n\n \u003e Makefile.gcc - I considered this, but I don\u0027t think it will ever\n \u003e make sense to have more than two gcc\u0027s will it? It didn\u0027t seem\n \u003e worth the effort, but happy to do so if you\u0027d prefer.\n\nNo, I think that\u0027s fine."},{"timestamp":1542467755,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1\n\nThe gcc7 patch seems fine."},{"timestamp":1542557566,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\nUnderstood. So yes, both the problems you point out seem at least possible. I think we can see how this approach goes? And if we start hitting problems with any of the 3 shared libs, we\u0027ll go with the rebuilding gcc thing"},{"timestamp":1542662424,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n\u003e Understood. So yes, both the problems you point out seem at least\n \u003e possible. I think we can see how this approach goes? And if we\n \u003e start hitting problems with any of the 3 shared libs, we\u0027ll go with\n \u003e the rebuilding gcc thing\n\nOK. I think that seems reasonable. I\u0027ll admit it feels a little bit like a step backwards in terms of correctness, but might as well see how it goes."},{"timestamp":1542747063,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1542795945,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1542803743,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by John Levon"}],"currentPatchSet":{"number":"3","revision":"38b3e673ae75d709a59a608137850367dae331de","parents":["a8f4b93a3b68a50db6fab7c634fa58ea97f5fb1e"],"ref":"refs/changes/66/5066/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542795945,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542467755,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542747063,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1542803743,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"binutils/Makefile","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":49,"deletions":-40},{"file":"gcc7/Makefile","type":"MODIFIED","insertions":58,"deletions":-36},{"file":"gcc7/Patches/1001-unwind-map.patch","type":"ADDED","insertions":51,"deletions":0},{"file":"nss-nspr/Patches/ldflags.diff","type":"ADDED","insertions":25,"deletions":0},{"file":"openssl/Makefile","type":"MODIFIED","insertions":33,"deletions":-31},{"file":"openssl/Makefile.com","type":"MODIFIED","insertions":8,"deletions":-8}],"sizeInsertions":264,"sizeDeletions":-135},"patchSets":[{"number":"1","revision":"309e391f0951d8beea7fe0ab1005d8a7c965ea3b","parents":["a8f4b93a3b68a50db6fab7c634fa58ea97f5fb1e"],"ref":"refs/changes/66/5066/1","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542325833,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542403072,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"comments":[{"file":"Makefile","line":170,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"This is an overdue thing to add. Thanks for thinking to do so."},{"file":"gcc7/Makefile","line":153,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we centralize all this now in Makefile.gcc?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"binutils/Makefile","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":49,"deletions":-40},{"file":"gcc7/Makefile","type":"MODIFIED","insertions":58,"deletions":-36},{"file":"nss-nspr/Patches/ldflags.diff","type":"ADDED","insertions":25,"deletions":0},{"file":"openssl/Makefile","type":"MODIFIED","insertions":33,"deletions":-31},{"file":"openssl/Makefile.com","type":"MODIFIED","insertions":8,"deletions":-8}],"sizeInsertions":213,"sizeDeletions":-135},{"number":"2","revision":"957027233d1b6c2477ee5d084f291d4c4865a5db","parents":["a8f4b93a3b68a50db6fab7c634fa58ea97f5fb1e"],"ref":"refs/changes/66/5066/2","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542409695,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542467755,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542747063,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"binutils/Makefile","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":49,"deletions":-40},{"file":"gcc7/Makefile","type":"MODIFIED","insertions":58,"deletions":-36},{"file":"gcc7/Patches/1001-unwind-map.patch","type":"ADDED","insertions":51,"deletions":0},{"file":"nss-nspr/Patches/ldflags.diff","type":"ADDED","insertions":25,"deletions":0},{"file":"openssl/Makefile","type":"MODIFIED","insertions":33,"deletions":-31},{"file":"openssl/Makefile.com","type":"MODIFIED","insertions":8,"deletions":-8}],"sizeInsertions":264,"sizeDeletions":-135},{"number":"3","revision":"38b3e673ae75d709a59a608137850367dae331de","parents":["a8f4b93a3b68a50db6fab7c634fa58ea97f5fb1e"],"ref":"refs/changes/66/5066/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1542795945,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542467755,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542747063,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1542803743,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":31,"deletions":-17},{"file":"Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"binutils/Makefile","type":"MODIFIED","insertions":7,"deletions":-1},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":49,"deletions":-40},{"file":"gcc7/Makefile","type":"MODIFIED","insertions":58,"deletions":-36},{"file":"gcc7/Patches/1001-unwind-map.patch","type":"ADDED","insertions":51,"deletions":0},{"file":"nss-nspr/Patches/ldflags.diff","type":"ADDED","insertions":25,"deletions":0},{"file":"openssl/Makefile","type":"MODIFIED","insertions":33,"deletions":-31},{"file":"openssl/Makefile.com","type":"MODIFIED","insertions":8,"deletions":-8}],"sizeInsertions":264,"sizeDeletions":-135}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}