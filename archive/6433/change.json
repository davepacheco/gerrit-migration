{"project":"joyent/muppet","branch":"master","id":"I37a0deb56c73a86325e4b0bd5403b5a3844b2aef","number":"6433","subject":"MANTA-4337 muppet needs debouncing and protection against lost backends Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/6433","commitMessage":"MANTA-4337 muppet needs debouncing and protection against lost backends\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1560394801,"lastUpdated":1560531734,"open":false,"status":"MERGED","comments":[{"timestamp":1560394801,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1560394833,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1560442798,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(3 comments)\n\nHope you don\u0027t mind me taking a look at this (mostly for my own edification)"},{"timestamp":1560451918,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1560451948,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560451998,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1560452628,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)\n\nThanks for the comments, looks great to me, modulo the typo"},{"timestamp":1560457729,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3: Published edit on patch set 2."},{"timestamp":1560457742,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1560457760,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560457833,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1560460281,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1560460311,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560460329,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4:\n\nAfter some further discussion in the office, we decided to add some extra randomization to the timeouts (just 5 seconds) so that a large group of muppets won\u0027t all send commands exactly in sync."},{"timestamp":1560460362,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1560460392,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560465742,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5:\n\n(2 comments)\n\nThis looks pretty good in general. Thanks for putting this together and the state transition diagram."},{"timestamp":1560467923,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 6."},{"timestamp":1560467953,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1560469818,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1560508522,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1560528979,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1560531727,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1560531734,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"7","revision":"f38f9bbd3eb3e1c313f818381d65274846d40485","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560531727,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560467953,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560469818,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560508522,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1560528979,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1560531734,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":432,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":689,"sizeDeletions":-589},"patchSets":[{"number":"1","revision":"5c970c67aa9f922fd619b30e63c667d1916304e9","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560394801,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1560394833,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/watch.js","line":93,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Isn\u0027t there a very small window here where we\u0027ve just set a new expiry on line :197, but by the time we get back to idle state here, it\u0027s less than now? In which case we\u0027d not wake up into collecting state (unless we got a childrenChangedAssert())."},{"file":"lib/watch.js","line":93,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yeah, I revised this to use null instead for the no-expiry indication (see revised ps)"},{"file":"lib/watch.js","line":106,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think this is intentionally waiting for the time-out before switching to the fetch state, right? Is it worth a comment saying why?"},{"file":"lib/watch.js","line":106,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"This was pretty short on explanatory comments in general. I\u0027ve added one, along with a state transition diagram. Let me know if you think it still needs more."},{"file":"lib/watch.js","line":117,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Why isn\u0027t this S.gotoStateTimeout() ?"},{"file":"lib/watch.js","line":117,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"No reason! it is now! :)"},{"file":"lib/watch.js","line":279,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"indent by tabs instead of spaces"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":201,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":246,"deletions":-268},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":499,"sizeDeletions":-593},{"number":"2","revision":"ebb6ed324226fcd6eb345ed54be2c8f4a74d9cfc","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560451918,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560451948,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560452628,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"lib/watch.js","line":58,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\"unnecessary\""},{"file":"lib/watch.js","line":58,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"woops! thanks"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":378,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":635,"sizeDeletions":-589},{"number":"3","revision":"d458d87339817d6033d2c41d09519e1ce60ab141","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560457729,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560457760,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560457833,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":378,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":635,"sizeDeletions":-589},{"number":"4","revision":"4ae09927b640bab0a845106b6124d07534ce01f1","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560460281,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560460311,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":392,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":649,"sizeDeletions":-589},{"number":"5","revision":"f58392e3abb4316085c76051b807230dc005d9d1","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560460362,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560460392,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/watch.js","line":33,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Mind mentioning the units for the time parameters? e.g. these are 15s in ms or something else?"},{"file":"lib/watch.js","line":375,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"return an error?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":392,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":649,"sizeDeletions":-589},{"number":"6","revision":"37a0deb56c73a86325e4b0bd5403b5a3844b2aef","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560467923,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560469818,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1560528979,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560467953,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560508522,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":432,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":689,"sizeDeletions":-589},{"number":"7","revision":"f38f9bbd3eb3e1c313f818381d65274846d40485","parents":["cb8e7d2fb9ff692574a0ebd70ce6bbb79f67dc19"],"ref":"refs/changes/33/6433/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1560531727,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560469818,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1560528979,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1560531734,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1560467953,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560508522,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/app.js","type":"ADDED","insertions":205,"deletions":0},{"file":"lib/index.js","type":"DELETED","insertions":0,"deletions":-23},{"file":"lib/watch.js","type":"MODIFIED","insertions":432,"deletions":-264},{"file":"lib/zk.js","type":"DELETED","insertions":0,"deletions":-44},{"file":"muppet.js","type":"MODIFIED","insertions":21,"deletions":-228},{"file":"package.json","type":"MODIFIED","insertions":31,"deletions":-30}],"sizeInsertions":689,"sizeDeletions":-589}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}