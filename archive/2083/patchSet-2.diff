From 8dd198deda1ac4e6de837a897c07ba588059616f Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 13 Jun 2017 16:41:07 -0700
Subject: [PATCH] MON-364 cmd alarm faults could include environment details

---
 plugins/lib/cmd.js   | 29 +++++++++++++++--------------
 plugins/package.json |  2 +-
 2 files changed, 16 insertions(+), 15 deletions(-)

diff --git a/plugins/lib/cmd.js b/plugins/lib/cmd.js
index 240d2f5..804bd30 100644
--- a/plugins/lib/cmd.js
+++ b/plugins/lib/cmd.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
@@ -23,7 +23,7 @@ var util = require('util'),
 var assert = require('assert-plus');
 
 var ProbeType = require('./probe');
-
+var objCopy = require('amon-common').utils.objCopy;
 
 
 //---- globals
@@ -99,16 +99,17 @@ CmdProbe.prototype.runCmd = function runCmd() {
 
     try {
         exec(this.cmd, this._cmdOptions, function (cmdErr, stdout, stderr) {
-            var cmdSummary;
-            if (log.debug()) {
-                cmdSummary = {
-                    cmd: self.cmd,
-                    exitStatus: (cmdErr ? cmdErr.code : 0),
-                    signal: (cmdErr ? cmdErr.signal : undefined),
-                    stdout: clip(stdout, 1024),
-                    stderr: clip(stderr, 1024)
-                };
+            var cmdDetails = {
+                cmd: self.cmd,
+                exitStatus: (cmdErr ? cmdErr.code : 0),
+                signal: (cmdErr ? cmdErr.signal : null),
+                stdout: clip(stdout, 1024),
+                stderr: clip(stderr, 1024)
+            };
+            if (self._cmdOptions.env) {
+                cmdDetails.env = self._cmdOptions.env;
             }
+
             var fail = false, reason;
             if (!self.ignoreExitStatus && cmdErr) {
                 fail = true;
@@ -133,9 +134,9 @@ CmdProbe.prototype.runCmd = function runCmd() {
                 reason = 'stderr';
             }
             if (!fail) {
-                log.trace(cmdSummary, 'cmd pass');
+                log.trace(cmdDetails, 'cmd pass');
             } else {
-                log.debug(cmdSummary, 'cmd fail (%s)', reason);
+                log.debug(cmdDetails, 'cmd fail (%s)', reason);
                 if (++self._count >= self.threshold) {
                     log.info({count: self._count, threshold: self.threshold},
                         'cmd event');
@@ -152,7 +153,7 @@ CmdProbe.prototype.runCmd = function runCmd() {
                     else if (reason === 'stderr')
                         msg = format('Command failed (stderr matched %s).',
                             self.stderrMatcher);
-                    self.emitEvent(msg, self._count, cmdSummary);
+                    self.emitEvent(msg, self._count, cmdDetails);
                 }
             }
 
diff --git a/plugins/package.json b/plugins/package.json
index 4f349d1..a5bd099 100644
--- a/plugins/package.json
+++ b/plugins/package.json
@@ -1,7 +1,7 @@
 {
   "name": "amon-plugins",
   "description": "Smart DataCenter Monitoring Probes package",
-  "version": "1.0.1",
+  "version": "1.1.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "main": "lib/index.js",
-- 
2.21.0

