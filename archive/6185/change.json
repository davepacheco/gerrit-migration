{"project":"joyent/sdc-cloudapi","branch":"master","id":"Ie46b9540cba121dd80c536c829f3c611fceadf6a","number":"6185","subject":"TRITON-1631 CloudAPI CreateMachineDisk should be able to accept a size of \"remaining\" Reviewed by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/6185","commitMessage":"TRITON-1631 CloudAPI CreateMachineDisk should be able to accept a size of \"remaining\"\nReviewed by: Todd Whiteman \u003ctodd.whiteman@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1556730090,"lastUpdated":1557412191,"open":false,"status":"MERGED","comments":[{"timestamp":1556730090,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1556730095,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 5add084a9378454f4c3900932c810dab5cb50b2c\n    \n    TRITON-1631 CloudAPI CreateMachineDisk should be able to accept a size of remaining"},{"timestamp":1556730127,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556730261,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nTests passing so far. Test output added to the JIRA issue. Note most of the modification of the test suite are made in order to avoid tests run either if there is no Bhyve image available or if the VM target for the tests hasn\u0027t been successfully provisioned."},{"timestamp":1556830169,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1: Code-Review+1\n\n(1 comment)"},{"timestamp":1556830849,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1557141151,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1557141155,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 5944c7328908fb62dbf7badc58abe70b4e767c7f\n    \n    Applied suggested changes, kind of."},{"timestamp":1557141189,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557141287,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(4 comments)\n\nTodd, let me know what do you think of the different solution to your proposed change."},{"timestamp":1557248545,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1557264526,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1557336897,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1557336902,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit dd933ef2c033580be8a63dd7ddff0e0e84ee49d2\n    \n    Applied latest Todd suggestion"},{"timestamp":1557336918,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\n(1 comment)\n\nDone! Mind to take another look?"},{"timestamp":1557336934,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557346430,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1557348970,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1557412110,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1557412161,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1557412191,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"4","revision":"e46b9540cba121dd80c536c829f3c611fceadf6a","parents":["7e07f311aa358021ca5b3940fd4bd3aae8b9c6e5"],"ref":"refs/changes/85/6185/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1557412161,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557336934,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557346430,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557348970,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557412110,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"SUBM","value":"1","grantedOn":1557412190,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/endpoints/disks.js","type":"MODIFIED","insertions":44,"deletions":-14},{"file":"test/machines.94.test.js","type":"MODIFIED","insertions":1025,"deletions":-1023}],"sizeInsertions":1069,"sizeDeletions":-1037},"patchSets":[{"number":"1","revision":"4b2d2ec333e92fd243e86aafdf1acb8c09637236","parents":["7e07f311aa358021ca5b3940fd4bd3aae8b9c6e5"],"ref":"refs/changes/85/6185/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1556730090,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556730127,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1556830169,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"comments":[{"file":"lib/endpoints/disks.js","line":22,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Just delete it"},{"file":"lib/endpoints/disks.js","line":22,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Just delete it if it\u0027s not used."},{"file":"lib/endpoints/disks.js","line":22,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/endpoints/disks.js","line":22,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/endpoints/disks.js","line":96,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Possibly assert that req.vm.disks is an array, and assert that disk.size is a number (otherwise it could end up with a Nan value if disk.size does not exist, or a string value if size is a string - e.g. 0 + \u0027abc\u0027 + 4 \u003d\u003d\u003d \u00270abc4\u0027)."},{"file":"lib/endpoints/disks.js","line":96,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Actually, I went for an alternate approach since I don\u0027t like to throw an exception on any of the proposed failure scenarios:\n- Will set req.vm.disks to empty array if it\u0027s not set\n- Instead of throwing an exception in case disk.size is not a number, will try o make it a number first and, in case it doesn\u0027t work, will reset it to zero"},{"file":"lib/endpoints/disks.js","line":100,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Small nit - can these two items be grouped into the one block:\n  if (size \u003d\u003d\u003d \u0027remaining\u0027) {\n    if (!req.vm.flexible_disk_size) {\n      ...\n  }"},{"file":"lib/endpoints/disks.js","line":100,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/endpoints/disks.js","type":"MODIFIED","insertions":43,"deletions":-12},{"file":"test/machines.94.test.js","type":"MODIFIED","insertions":1025,"deletions":-1023}],"sizeInsertions":1068,"sizeDeletions":-1035},{"number":"2","revision":"18b52a3bdb21d46cca15e4b4d4e94c9d9b0f45ba","parents":["7e07f311aa358021ca5b3940fd4bd3aae8b9c6e5"],"ref":"refs/changes/85/6185/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1557141151,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557141189,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557248545,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"comments":[{"file":"lib/endpoints/disks.js","line":100,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"In that case, I think the code can be simplified to:\n  return (sum + Number(disk.size) || 0);"},{"file":"lib/endpoints/disks.js","line":100,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/endpoints/disks.js","type":"MODIFIED","insertions":48,"deletions":-14},{"file":"test/machines.94.test.js","type":"MODIFIED","insertions":1025,"deletions":-1023}],"sizeInsertions":1073,"sizeDeletions":-1037},{"number":"3","revision":"89fd726282189cd5483db5d8cef7b2f01236788c","parents":["7e07f311aa358021ca5b3940fd4bd3aae8b9c6e5"],"ref":"refs/changes/85/6185/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1557336897,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557336934,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557346430,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557348970,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557412110,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/endpoints/disks.js","type":"MODIFIED","insertions":44,"deletions":-14},{"file":"test/machines.94.test.js","type":"MODIFIED","insertions":1025,"deletions":-1023}],"sizeInsertions":1069,"sizeDeletions":-1037},{"number":"4","revision":"e46b9540cba121dd80c536c829f3c611fceadf6a","parents":["7e07f311aa358021ca5b3940fd4bd3aae8b9c6e5"],"ref":"refs/changes/85/6185/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1557412161,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557336934,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1557412190,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557346430,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557348970,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557412110,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/endpoints/disks.js","type":"MODIFIED","insertions":44,"deletions":-14},{"file":"test/machines.94.test.js","type":"MODIFIED","insertions":1025,"deletions":-1023}],"sizeInsertions":1069,"sizeDeletions":-1037}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}