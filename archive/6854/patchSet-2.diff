From 1c5837ada88bae952fa185b8d5ede1310754fc92 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Fri, 30 Aug 2019 10:42:52 +0000
Subject: [PATCH] OS-7973 fbt entry probes incorrectly placed due to
 -fshrink-wrap

---
 usr/src/uts/Makefile.uts | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/usr/src/uts/Makefile.uts b/usr/src/uts/Makefile.uts
index 1256d73d5d..e95700780a 100644
--- a/usr/src/uts/Makefile.uts
+++ b/usr/src/uts/Makefile.uts
@@ -24,7 +24,6 @@
 # Copyright (c) 2011 Bayard G. Bell. All rights reserved.
 # Copyright (c) 2011,2017 by Delphix. All rights reserved.
 # Copyright (c) 2013 Andrew Stormont.  All rights reserved.
-# Copyright 2018 Joyent, Inc.
 # Copyright 2016 Hans Rosenfeld <rosenfeld@grumpf.hope-2000.org>
 # Copyright 2019 Joyent, Inc.
 #
@@ -251,6 +250,12 @@ CFLAGS_uts_i386 += -_gcc7=-mindirect-branch-register
 CFLAGS_uts_i386 += -_gcc8=-mindirect-branch=thunk-extern
 CFLAGS_uts_i386 += -_gcc8=-mindirect-branch-register
 
+#
+# Ensure that the standard function prologue remains at the very start of a function,
+# so DTrace fbt will instrument the right place.
+#
+CFLAGS_uts_i386 = -_gcc=-fno-shrink-wrap
+
 CSTD = $(CSTD_GNU99)
 
 CFLAGS_uts		=
-- 
2.21.0

