{"project":"joyent/pg_prefaulter","branch":"master","id":"I1ec450da49d134d16ebebbda2d8d1ab0affa8703","number":"6097","subject":"MANTA-4020 pg_prefaulter should support postgres version 10 or later MANTA-4217 Prefaulter development tooling should not use default postgres port MANTA-4219 Prefaulter\u0027s check target should not run tests Reviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@j","owner":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"url":"https://cr.joyent.us/6097","commitMessage":"MANTA-4020 pg_prefaulter should support postgres version 10 or later\nMANTA-4217 Prefaulter development tooling should not use default postgres port\nMANTA-4219 Prefaulter\u0027s check target should not run tests\nReviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1554995697,"lastUpdated":1561625892,"open":false,"status":"MERGED","comments":[{"timestamp":1554995697,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 1."},{"timestamp":1554995699,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n go test -v ./...\n gmake: go: Command not found\n GNUmakefile:20: recipe for target \u0027check\u0027 failed\n gmake: *** [check] Error 127"},{"timestamp":1555024219,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\n(3 comments)\n\nJust a few comments, but overall this looks really nice. I\u0027m mostly curious to see the results of some 9.6 testing to make sure we\u0027re still ok there, but great work so far."},{"timestamp":1555076980,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 2."},{"timestamp":1555077035,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1555081805,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1555539042,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2: Code-Review+1\n\nThe code changes look good to me now. I\u0027ll give it the CR +1 and take a look at your testing notes for IA once those are ready."},{"timestamp":1557223473,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 3."},{"timestamp":1557441776,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1559128027,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1559838647,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 5."},{"timestamp":1560783386,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1560784932,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1560785283,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\n\u003e (1 comment)\n\nI think it\u0027s probably fine for now as it is. I just was thinking about it as I was looking over the changes again. I think it\u0027s probably another thing to consider when we look at a more major overhaul of the prefaulter."},{"timestamp":1560785292,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1561480760,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1561625805,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1561625892,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Richard Bradley"}],"currentPatchSet":{"number":"6","revision":"1ec450da49d134d16ebebbda2d8d1ab0affa8703","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1561625805,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560785292,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561480760,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1561625892,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"README.adoc","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/agent.go","type":"MODIFIED","insertions":36,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":57,"deletions":-21},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/proc/args_illumos.go","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"agent/proc/args_unix.go","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":81,"deletions":0}],"sizeInsertions":216,"sizeDeletions":-50},"patchSets":[{"number":"1","revision":"bce34e6ace0d668f50f9e02a2148173707eb6423","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/1","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1554995697,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1554995699,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"GNUmakefile","line":90,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I think it\u0027s still `xlog` for 92 and since we technically still support that version we should probably account for it as well as 96."},{"file":"GNUmakefile","line":90,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Yea, I\u0027m not keen on this part. At the time I thought the prefaulter was only supported from 9.6 onwards anyway, but I think I was confusing that with the other reason for our bump to 9.6 (the introduction of pg_stat_progress_vacuum, which doesn\u0027t apply here). You\u0027re right; we still need to account for other versions.\n\nI toyed a bit with hitting the primary via `psql` to get its server_version_num, but actually it seems this long form option can be reduced to just `-X`, which is wal/xlog agnostic, though not as self-explanatory. I\u0027ve opted for this instead in PS2."},{"file":"GNUmakefile","line":90,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"While testing 9.2 against PS2, I found that it was complaining about a missing `pg_xlogdump` binary. As it turns out, that was added in 9.3: https://www.postgresql.org/docs/9.3/release-9-3.html\n\nYour point still stands though in case of development work on \u003c9.6, but I thought you might find it interesting! I\u0027ll also add this to my testing notes."},{"file":"GNUmakefile","line":104,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I\u0027m curious about this change. I\u0027m not sure why it was previously 5433 and now it\u0027s 5452. Is this related to the different version?"},{"file":"GNUmakefile","line":104,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"MANTA-4217 has some details on this port stuff.\n\nBasically, primary port was never defined, so was assumed to be 5432 (the default). It\u0027s the follower port that has changed from 5433 to 5452, with the primary now being defined as 5442.\n\nThe numbering seems a bit weird, but I wanted to emulate what Manatee development tooling does. That is, the primary is 5432, and every subsequent peer is $previousPort+10. With MANTA-4217 I wanted to not clobber any existing postgres installation, so I opted to have the primary start later in this range also, hence the new primary port of 5442, and the change of the follower port to 5452. I also wanted the follower port to be greater than the primary port.\n\nI figure this is only development tooling so won\u0027t affect its usage while deployed proper. They\u0027re also using the `?\u003d` assignment, so they can be overridden by environment variables if it\u0027s problematic.\n\nHopefully that makes sense. I don\u0027t feel massively strongly about this port change, but it\u0027s something I found surprising while working on the prefaulter to wanted to make a little easier for future developers."},{"file":"pg/translate.go","line":60,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"This is probably just due to my go ignorance, but I\u0027m curious about the use of the nested block here. Is there a reason behind it? I\u0027m unsure what the difference is compared to if it wasn\u0027t nested."},{"file":"pg/translate.go","line":60,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"This is definitely a mix of my Go ignorance and refactoring! I think I had this block doing some other stuff previously which meant it was indented for whatever reason. It doesn\u0027t look like it needs to be now, so I\u0027ve un-indented in PS2."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":11,"deletions":-4},{"file":"agent/agent.go","type":"MODIFIED","insertions":33,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":18,"deletions":-22},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":83,"deletions":0}],"sizeInsertions":173,"sizeDeletions":-43},{"number":"2","revision":"9c6eaf9d5b9d89c81b8f1f9dd6e9855fb072c043","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/2","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1555076980,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1555539042,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"README.adoc","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/agent.go","type":"MODIFIED","insertions":33,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":18,"deletions":-22},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":81,"deletions":0}],"sizeInsertions":170,"sizeDeletions":-47},{"number":"3","revision":"5d50935f640a6abb983b77430c1b53445285770c","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/3","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1557223473,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557441776,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"README.adoc","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/agent.go","type":"MODIFIED","insertions":33,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":18,"deletions":-22},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/proc/args_illumos.go","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"agent/proc/args_unix.go","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":81,"deletions":0}],"sizeInsertions":173,"sizeDeletions":-50},{"number":"4","revision":"b77d81a06a342b935a78ec03b0b2b6dc793b2768","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/4","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1559128027,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557441776,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"README.adoc","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/agent.go","type":"MODIFIED","insertions":33,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":18,"deletions":-22},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/proc/args_illumos.go","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"agent/proc/args_unix.go","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":81,"deletions":0}],"sizeInsertions":173,"sizeDeletions":-50},{"number":"5","revision":"66eab2a46098c860c25eb41cb92b542dec64b5a6","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/5","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1559838647,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561480760,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560785292,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"comments":[{"file":"agent/agent.go","line":229,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Do you think we need to do this repeatedly inside this event loop  or could we get away with doing it prior to entering the loop? Perhaps doing it this way lets us swap versions of postgres without restarting the prefaulter?"},{"file":"agent/agent.go","line":229,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"\u003e Perhaps doing it this way lets us swap versions of postgres without restarting the prefaulter?\n\nI believe it will, but that wasn\u0027t my reason for putting this here.\n\nThe reason for doing this here is because it was where a bunch of other retryable logic was already built. If we wanted to get this prior to this point, we\u0027d have to do another round of retryable work somewhere else in the project so that when starting the prefaulter we know that this is a retryable error. For instance, we don\u0027t want the prefaulter to go into maintenance if it can\u0027t find this file on start of the SMF service.\n\nI agree with your sentiment though. I\u0027m not totally keen on hitting PG_VERSION on every loop, but I figured it wasn\u0027t the most intensive operation. Perhaps I could noop this based on walTranslations.Major if we know we\u0027ve got the version on the previous pass?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"README.adoc","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/agent.go","type":"MODIFIED","insertions":36,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":57,"deletions":-21},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/proc/args_illumos.go","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"agent/proc/args_unix.go","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":81,"deletions":0}],"sizeInsertions":216,"sizeDeletions":-50},{"number":"6","revision":"1ec450da49d134d16ebebbda2d8d1ab0affa8703","parents":["21e0ec67ea7d97f4334b61517cbf0983c96a274a"],"ref":"refs/changes/97/6097/6","uploader":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"createdOn":1561625805,"author":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1561480760,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1561625892,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1560785292,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"GNUmakefile","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"README.adoc","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/agent.go","type":"MODIFIED","insertions":36,"deletions":-10},{"file":"agent/db.go","type":"MODIFIED","insertions":57,"deletions":-21},{"file":"agent/errors.go","type":"MODIFIED","insertions":20,"deletions":0},{"file":"agent/proc/args_illumos.go","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"agent/proc/args_unix.go","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"agent/walcache/cache.go","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"pg/lag.go","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"pg/translate.go","type":"ADDED","insertions":81,"deletions":0}],"sizeInsertions":216,"sizeDeletions":-50}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}]}