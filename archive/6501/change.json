{"project":"joyent/muppet","branch":"master","id":"I17c02dd645447ac2deeb2f552bb910b730ded3dd","number":"6501","subject":"MANTA-4373 muppet should use the stats/control socket to disable backends Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/6501","commitMessage":"MANTA-4373 muppet should use the stats/control socket to disable backends\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1561511857,"lastUpdated":1562881102,"open":false,"status":"MERGED","comments":[{"timestamp":1561511857,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1561511890,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1561512395,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1561512425,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1561581458,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1561581487,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1561582538,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1561582572,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1561583876,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4:\n\nPS#3, #4: as per some in-person feedback, I made the \"backends out of sync\" error non-fatal (triggers a config regen and restart), and added a periodic double-check of the state of the backends through the stats socket so we can correct it if haproxy restarts behind our back"},{"timestamp":1562004801,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 5."},{"timestamp":1562004831,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562004854,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\nRebased on top of MANTA-3525"},{"timestamp":1562084585,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\n(13 comments)"},{"timestamp":1562191768,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 6."},{"timestamp":1562191772,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\n(9 comments)"},{"timestamp":1562191798,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562195983,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\n(7 comments)"},{"timestamp":1562196600,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1562197364,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1562197467,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1562197600,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1562228705,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1562610863,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 7."},{"timestamp":1562610895,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562610932,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 8."},{"timestamp":1562610962,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562618324,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 8: Code-Review+1\n\nThanks"},{"timestamp":1562718776,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 9."},{"timestamp":1562718810,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562850521,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1562869879,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 9: Integration-Approval+1"},{"timestamp":1562880786,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 10: Commit message was updated."},{"timestamp":1562881102,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"10","revision":"fa1a279d1b93731c4e08bead5eec0bb6e6b3669e","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/10","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562880786,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562718810,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562850521,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562869879,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1562881102,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":265,"deletions":-18},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":346,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":616,"sizeDeletions":-20},"patchSets":[{"number":"1","revision":"5d7d877594edb131c18ab38c7816fb1e3968a291","parents":["f38f9bbd3eb3e1c313f818381d65274846d40485"],"ref":"refs/changes/01/6501/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1561511857,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1561511890,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":204,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer host hides an identifier in a parent scope"},{"file":"lib/app.js","line":214,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: identifer host hides an identifier in a parent scope"},{"file":"lib/haproxy_sock.js","line":35,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: missing semicolon"},{"file":"lib/haproxy_sock.js","line":311,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: trailing_comma"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":51,"deletions":-16},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":311,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":368,"sizeDeletions":-19},{"number":"2","revision":"869b6b5955ee47100ce4a37c536a1e61c6abafc7","parents":["f38f9bbd3eb3e1c313f818381d65274846d40485"],"ref":"refs/changes/01/6501/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1561512395,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561512425,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":51,"deletions":-16},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":308,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":365,"sizeDeletions":-19},{"number":"3","revision":"075ef422a90973edffa77bf1e1e45908e9e86323","parents":["f38f9bbd3eb3e1c313f818381d65274846d40485"],"ref":"refs/changes/01/6501/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1561581458,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561581487,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":51,"deletions":-16},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":318,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":375,"sizeDeletions":-19},{"number":"4","revision":"7b909d1c138a77c18fab6d91e01e2ab50fc58ac3","parents":["f38f9bbd3eb3e1c313f818381d65274846d40485"],"ref":"refs/changes/01/6501/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1561582538,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1561582572,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":79,"deletions":-16},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":325,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":410,"sizeDeletions":-19},{"number":"5","revision":"b0bf51805a67435c355e415f511c8b7c4505f3e6","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562004801,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562004831,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":213,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Shouldn\u0027t this be called \"servers\"?"},{"file":"lib/app.js","line":213,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I don\u0027t think so? It only contains backends, not servers (servers are the \u0027frontend/backend\u0027 string I think? versus just the backend part of it?)"},{"file":"lib/app.js","line":213,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Not in haproxy lingo. You basically have \"frontend\" and \"backend\" definitions for proxies. As it happens, ours have different pxnames, but I think typically they\u0027d be the same, e.g.\n\nfrontend secure_api (spelt \u0027https\u0027 in our config)\n  default_backend secure_api\n\nbackend secure_api\n  server be0 ...\n  server be1 ...\n\nSo this really is a dict of servers (if it were backends, the keys would be \u0027secure_api\u0027, \u0027insecure_api\u0027, etc.)\n\n(And yes those be* names are mis-nomers, at least in terms of haproxy config...)"},{"file":"lib/app.js","line":213,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Ok, so in the \u0027secure_api/be0\u0027 specifier, the \u0027secure_api\u0027 bit is the \u0027backend\u0027 and \u0027be0\u0027 is the \u0027server\u0027? The whole thing is.. a fully-qualified server?"},{"file":"lib/app.js","line":213,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Almost, the \u0027secure_api\u0027 bit is the \"proxy\" (pxname). Backends themselves don\u0027t have a name. But since there\u0027s only one per pxname it\u0027s skirting close to sophistry.\n\nThe fully qualified name of the server is pxname:svname e.g. secure_api:be0."},{"file":"lib/app.js","line":213,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"In the syntax of the disable/enable command it says \"disable server \u003cbackend\u003e/\u003cserver\u003e\"\n\nAnd then \"Both the backend and the server may be specified either by their name or by their numeric ID...\""},{"file":"lib/app.js","line":213,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"So that \"backend name\" there is the pxname and it relies on the 1:1 relationship?"},{"file":"lib/app.js","line":213,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"So looking again at the docs it does say backends are named (though it\u0027s somewhat ambiguous). It\u0027s really in the stats that it\u0027s called \"pxname\". But anyway, this doesn\u0027t change the fact that we have a dict of servers under a single backend, not multiple backends, here."},{"file":"lib/app.js","line":214,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"it took me a moment to figure this out: is it worth commenting that the reason we have false/true here instead of just a membership list, is that we want to identify when we\u0027re out of sync with haproxy\u0027s idea of servers?\n\nOr, perhaps, have the values be \u0027MAINT\u0027 or \u0027UP\u0027 ?"},{"file":"lib/app.js","line":214,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I really don\u0027t like \u0027UP\u0027 because the server/backend might actually be DOWN or in some other state in haproxy, not necessarily UP. I\u0027ll add a comment."},{"file":"lib/app.js","line":214,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Yeah, I thought the same in fact.."},{"file":"lib/app.js","line":251,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Do we want a specific Manta alarm to match this?"},{"file":"lib/app.js","line":251,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Maybe. We don\u0027t have any way to trigger arbitrary alarms here at the moment that I know of."},{"file":"lib/app.js","line":251,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I was suggesting we add a log-grepping alarm in sdc-manta. So not something as part of this CR anyway."},{"file":"lib/haproxy_sock.js","line":76,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"What happens if either of these calls fail?"},{"file":"lib/haproxy_sock.js","line":76,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"They can\u0027t. Stream write() calls don\u0027t fail synchronously. They either buffer the data up, or don\u0027t and trigger an \u0027error\u0027 event to be emitted in the next tick. Since we synchronously transition here from one state which has an error handler, to another state which has an error handler, we\u0027ll be back to having one by the time the emit happens."},{"file":"lib/haproxy_sock.js","line":114,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Do disable/enable/shutdown all do the right thing on a health-failed DOWN server?"},{"file":"lib/haproxy_sock.js","line":114,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Yes."},{"file":"lib/haproxy_sock.js","line":124,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"haproxy tells us that enable/disable are deprecated; should these be \u0027set server\u0027 ?"},{"file":"lib/haproxy_sock.js","line":124,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Does it? I don\u0027t see anything about them being deprecated in the 1.8 documentation. Did I miss that somewhere?"},{"file":"lib/haproxy_sock.js","line":124,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"It\u0027s more hidden than I\u0027d remembered, but it\u0027s in the help:\n\n4564         { { \"enable\", \"server\",  NULL }, \"enable server  : enable a disabled server (use \u0027set server\u0027 instead)\", cli_parse_enable_server, NULL },\n\n\nIt\u0027s not going away, presumably, so it doesn\u0027t matter much."},{"file":"lib/haproxy_sock.js","line":124,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Haha, that is pretty buried. Hmm... I guess we\u0027ll keep an eye on it. I doubt they\u0027d take it away any time soon given their attitude with other socket commands which they\u0027ve kept going."},{"file":"lib/haproxy_sock.js","line":198,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Maybe \"show stat json\" wasn\u0027t available in 1.5, but it is now, and seems preferable to parsing CSV?"},{"file":"lib/haproxy_sock.js","line":198,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Why is it preferable? The CSV parsing works fine and it\u0027s been a stable interface in haproxy forever (which lots of other tools use too)."},{"file":"lib/haproxy_sock.js","line":198,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Just seems natural (and less code) to parse JSON in JS, but it doesn\u0027t really matter."},{"file":"lib/haproxy_sock.js","line":222,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Should we comment that this assumes the different proxies are alway synced in terms of their servers?"},{"file":"lib/haproxy_sock.js","line":228,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Why is this called \"backends\" not \"servers\" ?"},{"file":"lib/haproxy_sock.js","line":228,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Same reason as above."},{"file":"lib/haproxy_sock.js","line":241,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We can explicitly ask just for servers with:\n\nshow stat -1 4 json\n\nwhich seems a little more robust to future haproxy changes."},{"file":"lib/haproxy_sock.js","line":241,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"If we\u0027re keeping the csv, fine, but I\u0027d still like this to be more robust against other entries."},{"file":"lib/haproxy_sock.js","line":241,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I changed it to use \"show stat -1 4 -1\" in this latest ps. Do you think there\u0027s more we need to do here?"},{"file":"lib/haproxy_sock.js","line":241,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Nope, sorry, that\u0027s fine."},{"file":"lib/haproxy_sock.js","line":266,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"nit, remove double space?"},{"file":"lib/haproxy_sock.js","line":279,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I guess it\u0027s intentional that we\u0027re doing a new connection for each operation (to get an individual error?). Can we get a comment to that effect?"},{"file":"lib/haproxy_sock.js","line":279,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"You mean, as opposed to stringing them all together with semi-colons? The \"prompt\" mode is the only other way to run multiple commands on a connection and it\u0027s annoying to deal with because it\u0027ll try to use terminal escapes.\n\nAnd yeah, I didn\u0027t want to do the semi-colon thing because there\u0027s no way to tell which command failed."},{"file":"lib/haproxy_sock.js","line":279,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"OK, thanks."},{"file":"lib/haproxy_sock.js","line":320,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Why are we exporting these?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":78,"deletions":-15},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":325,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":408,"sizeDeletions":-17},{"number":"6","revision":"c8677f3c40113a3819e1a283448485ff24668c68","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562191768,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562191798,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":89,"deletions":-15},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":345,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":439,"sizeDeletions":-17},{"number":"7","revision":"6135d4abfbad4d130f8964c3df8f40a41e4502d9","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/7","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562610863,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562610895,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"deps/eng","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/app.js","type":"MODIFIED","insertions":89,"deletions":-15},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":345,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":440,"sizeDeletions":-18},{"number":"8","revision":"ba1f0e2ad9c66355aa46a9754b0ccb2f97b61691","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/8","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562610932,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562610962,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562618324,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":89,"deletions":-15},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":345,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":439,"sizeDeletions":-17},{"number":"9","revision":"17c02dd645447ac2deeb2f552bb910b730ded3dd","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/9","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562718776,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562869879,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562718810,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562850521,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":265,"deletions":-18},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":346,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":616,"sizeDeletions":-20},{"number":"10","revision":"fa1a279d1b93731c4e08bead5eec0bb6e6b3669e","parents":["009fb01b42862738388de6d5f60843c5494bf8af"],"ref":"refs/changes/01/6501/10","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1562880786,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562869879,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1562881102,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562718810,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562850521,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":265,"deletions":-18},{"file":"lib/haproxy_sock.js","type":"ADDED","insertions":346,"deletions":0},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/watch.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":616,"sizeDeletions":-20}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}