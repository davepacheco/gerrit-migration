From c1fb60781166ccbf790ccbf96134bee1c621b040 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Fri, 29 Mar 2019 11:22:28 +0000
Subject: [PATCH] TRITON-1353 Triton systems should ship with HT disabled

---
 www/js/tpl/server.hbs  | 14 +++++++++-----
 www/js/views/server.js | 23 ++++++++++++++++++++---
 2 files changed, 29 insertions(+), 8 deletions(-)

diff --git a/www/js/tpl/server.hbs b/www/js/tpl/server.hbs
index b8b1683e..7e7a12e6 100644
--- a/www/js/tpl/server.hbs
+++ b/www/js/tpl/server.hbs
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright (c) 2019, Joyent, Inc.
 -->
 
 <div class="server-page-header"></div>
@@ -149,12 +149,16 @@
           <td>{{cpu_type}}</td>
         </tr>
         <tr>
-          <th>Physical CPUs</th>
-          <td>{{cpu_physical_cores}}</td>
+          <th>CPU Sockets / Cores</th>
+          <td>{{cpu_sockets}} / {{cpu_cores}}</td>
         </tr>
         <tr>
-          <th>Total CPU Cores</th>
-          <td>{{cpu_total_cores}}</td>
+          <th>Online CPUs</th>
+          <td>{{cpu_online_cpus}}</td>
+        </tr>
+        <tr>
+          <th>Hyper-threading enabled</th>
+          <td>{{ht_enabled}}</td>
         </tr>
         <tr>
           <th>Serial Number</th>
diff --git a/www/js/views/server.js b/www/js/views/server.js
index 07c9d262..fbc67d5a 100644
--- a/www/js/views/server.js
+++ b/www/js/views/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 'use strict';
@@ -161,12 +161,29 @@ var ServerView = Backbone.Marionette.Layout.extend({
         cpu_type: function () {
             return this.sysinfo['CPU Type'];
         },
-        cpu_physical_cores: function () {
+        cpu_sockets: function () {
+            if (this.sysinfo.hasOwnProperty('CPU Socket Count'))
+                return this.sysinfo['CPU Socket Count'];
+            // legacy value: this really is sockets
             return this.sysinfo['CPU Physical Cores'];
         },
-        cpu_total_cores: function () {
+        cpu_cores: function () {
+            if (this.sysinfo.hasOwnProperty('CPU Core Count'))
+                return this.sysinfo['CPU Core Count'];
+            return 'unknown';
+        },
+        cpu_online_cpus: function () {
+            if (this.sysinfo.hasOwnProperty('CPU Online Count'))
+                return this.sysinfo['CPU Online Count'];
+            // legacy value: this is really *all* *CPUs*
             return this.sysinfo['CPU Total Cores'];
         },
+        ht_enabled: function () {
+            if (this.sysinfo.hasOwnProperty('Psrinfo'))
+                return this.sysinfo.Psrinfo.ht_enabled;
+            // legacy value: HT is - probably - enabled
+            return 'true';
+        },
         serial_number: function () {
             return this.sysinfo['Serial Number'];
         },
-- 
2.21.0

