From 33e064c718f8277a7770ad760a7073b4609ac3c1 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 14 May 2019 19:37:49 +0000
Subject: [PATCH] =?UTF-8?q?TRITON-1353=20Triton=20systems=20should=20be=20?=
 =?UTF-8?q?able=20to=20disable=20SMT=20Reviewed=20by:=20Pedro=20Palaz?=
 =?UTF-8?q?=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved=20by:=20Pedro?=
 =?UTF-8?q?=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 www/js/tpl/server.hbs  | 14 +++++++++-----
 www/js/views/server.js | 23 ++++++++++++++++++++---
 2 files changed, 29 insertions(+), 8 deletions(-)

diff --git a/www/js/tpl/server.hbs b/www/js/tpl/server.hbs
index b8b1683e..5b1dbb1c 100644
--- a/www/js/tpl/server.hbs
+++ b/www/js/tpl/server.hbs
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright 2019 Joyent, Inc.
 -->
 
 <div class="server-page-header"></div>
@@ -149,12 +149,16 @@
           <td>{{cpu_type}}</td>
         </tr>
         <tr>
-          <th>Physical CPUs</th>
-          <td>{{cpu_physical_cores}}</td>
+          <th>CPU Sockets / Cores</th>
+          <td>{{cpu_sockets}} / {{cpu_cores}}</td>
         </tr>
         <tr>
-          <th>Total CPU Cores</th>
-          <td>{{cpu_total_cores}}</td>
+          <th>Online CPUs</th>
+          <td>{{cpu_online_cpus}}</td>
+        </tr>
+        <tr>
+          <th>Simultaneous multi-threading enabled</th>
+          <td>{{smt_enabled}}</td>
         </tr>
         <tr>
           <th>Serial Number</th>
diff --git a/www/js/views/server.js b/www/js/views/server.js
index 07c9d262..5c0257ee 100644
--- a/www/js/views/server.js
+++ b/www/js/views/server.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2015, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 'use strict';
@@ -161,12 +161,29 @@ var ServerView = Backbone.Marionette.Layout.extend({
         cpu_type: function () {
             return this.sysinfo['CPU Type'];
         },
-        cpu_physical_cores: function () {
+        cpu_sockets: function () {
+            if (this.sysinfo.hasOwnProperty('CPU Socket Count'))
+                return this.sysinfo['CPU Socket Count'];
+            // legacy value: this is really number of sockets
             return this.sysinfo['CPU Physical Cores'];
         },
-        cpu_total_cores: function () {
+        cpu_cores: function () {
+            if (this.sysinfo.hasOwnProperty('CPU Core Count'))
+                return this.sysinfo['CPU Core Count'];
+            return 'unknown';
+        },
+        cpu_online_cpus: function () {
+            if (this.sysinfo.hasOwnProperty('CPU Online Count'))
+                return this.sysinfo['CPU Online Count'];
+            // legacy value: this is really *all* *CPUs*
             return this.sysinfo['CPU Total Cores'];
         },
+        smt_enabled: function () {
+            if (this.sysinfo.hasOwnProperty('Psrinfo'))
+                return this.sysinfo.Psrinfo.smt_enabled;
+            // legacy value: SMT is - probably - enabled
+            return 'true';
+        },
         serial_number: function () {
             return this.sysinfo['Serial Number'];
         },
-- 
2.21.0

