{"project":"joyent/v8plus","branch":"master","id":"I01401f696b9f766bf768ff33b9843163e672193f","number":"809","subject":"TOOLS-1586 v8plus support for node 0.12.X and 4.X Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/809","commitMessage":"TOOLS-1586 v8plus support for node 0.12.X and 4.X\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1477636995,"lastUpdated":1478026055,"open":false,"status":"MERGED","comments":[{"timestamp":1477636995,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1477637184,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1477637521,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\nFor reference, I originally read through this blog post while making the changes for 0.12.X:\n\nhttps://strongloop.com/strongblog/node-js-v0-12-c-apis-breaking/\n\nThe additional change for 4.X was relatively minor, and likely would not be documented anywhere (it involves the generation of mangled C++ function names and dlopen...)."},{"timestamp":1477673780,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\nI took a look through this and I think it makes sense; however, I\u0027m not very confident in my understanding of the v8 API, so I\u0027d suggest getting a second reviewer who\u0027s more familiar."},{"timestamp":1477696197,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1477939090,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1477939286,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\ns/unmangled/mangled/ in my last comments."},{"timestamp":1477948918,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1477949592,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1477952508,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1478025512,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1478025726,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1478026053,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1478026055,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"5","revision":"2fbcc650dec9bd4ed9e79ba3d85ffa1d3d34f7a2","parents":["09cabe9925ddab464b5cbf1ba96ae79d9b712ffc"],"ref":"refs/changes/09/809/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1478026053,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477948918,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478025512,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1478026055,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"v8plus_csup.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"v8plus_impl.h","type":"MODIFIED","insertions":86,"deletions":-12},{"file":"v8plus_objectwrap.cc","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"v8plus_subr.cc","type":"MODIFIED","insertions":121,"deletions":-49}],"sizeInsertions":241,"sizeDeletions":-89},"patchSets":[{"number":"1","revision":"5c1a99649cf9779e734e183d01625e9aaab91e7f","parents":["320c858c36bb8204fd3afafbbb05ab226315b9b8"],"ref":"refs/changes/09/809/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1477636995,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"v8plus_csup.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"v8plus_impl.h","type":"MODIFIED","insertions":86,"deletions":-12},{"file":"v8plus_objectwrap.cc","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"v8plus_subr.cc","type":"MODIFIED","insertions":95,"deletions":-47}],"sizeInsertions":214,"sizeDeletions":-87},{"number":"2","revision":"5d253b3a4bea17ff8f1c9811850cdb2091bda22b","parents":["320c858c36bb8204fd3afafbbb05ab226315b9b8"],"ref":"refs/changes/09/809/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1477637184,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"v8plus_csup.c","type":"MODIFIED","insertions":4,"deletions":0},{"file":"v8plus_impl.h","type":"MODIFIED","insertions":86,"deletions":-12},{"file":"v8plus_objectwrap.cc","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"v8plus_subr.cc","type":"MODIFIED","insertions":94,"deletions":-47}],"sizeInsertions":213,"sizeDeletions":-87},{"number":"3","revision":"ddc998c807b01e5ace3fd0454a5f35315498d54c","parents":["320c858c36bb8204fd3afafbbb05ab226315b9b8"],"ref":"refs/changes/09/809/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1477696197,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478025512,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477948918,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"v8plus_impl.h","line":45,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is \"obj\" an instance of v8::Object? If so why using \"CreationContext()-\u003eGetIsolate()\" instead of just \"-\u003eGetIsolate()\"?"},{"file":"v8plus_impl.h","line":45,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As discussed elsewhere, it seems that \"obj-\u003eCreationContext()-\u003eGetIsolate()\" is the only way to get the Isolate from the Object in 0.12.X.  In 4.6.1, there is \"obj-\u003eGetIsolate()\", but it is (of course) already deprecated.\n\nIn a future version of v8plus, we will probably need to switch to either passing the Isolate around as a parameter to every function, or sticking it in a thread-local (e.g \"curisolate\") at appropriate points in the code.\n\nI\u0027ve filed TOOLS-1596 to look into this."},{"file":"v8plus_impl.h","line":45,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Added a comment in TOOLS-1596 to suggest another approach."},{"file":"v8plus_subr.cc","line":20,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I don\u0027t understand why dynamic dispatch is needed in create_and_populate. My understanding is that there\u0027s a fixed set of error types that is statically defined. Wouldn\u0027t it be possible to determine which factory method to use depending on the error type name and using preprocessor conditionals, instead of using dlopen with unmangled symbol names?"},{"file":"v8plus_subr.cc","line":20,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It\u0027s true, and I think a future version of v8plus may move to that model.  I _believe_ I understand all of the places that \"create_and_populate()\" is called, and honestly it\u0027s probably just \"Error\" that needs to be plumbed up anyway -- but I think a little more due diligence is required before I\u0027m completely comfortable.\n\nI have filed TOOLS-1596."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"v8plus_csup.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"v8plus_impl.h","type":"MODIFIED","insertions":86,"deletions":-12},{"file":"v8plus_objectwrap.cc","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"v8plus_subr.cc","type":"MODIFIED","insertions":121,"deletions":-49}],"sizeInsertions":241,"sizeDeletions":-89},{"number":"4","revision":"01401f696b9f766bf768ff33b9843163e672193f","parents":["320c858c36bb8204fd3afafbbb05ab226315b9b8"],"ref":"refs/changes/09/809/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1478025726,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478025512,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477948918,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"v8plus_csup.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"v8plus_impl.h","type":"MODIFIED","insertions":86,"deletions":-12},{"file":"v8plus_objectwrap.cc","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"v8plus_subr.cc","type":"MODIFIED","insertions":121,"deletions":-49}],"sizeInsertions":241,"sizeDeletions":-89},{"number":"5","revision":"2fbcc650dec9bd4ed9e79ba3d85ffa1d3d34f7a2","parents":["09cabe9925ddab464b5cbf1ba96ae79d9b712ffc"],"ref":"refs/changes/09/809/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1478026053,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1478025512,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1478026055,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477948918,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"v8plus_csup.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"v8plus_impl.h","type":"MODIFIED","insertions":86,"deletions":-12},{"file":"v8plus_objectwrap.cc","type":"MODIFIED","insertions":29,"deletions":-28},{"file":"v8plus_subr.cc","type":"MODIFIED","insertions":121,"deletions":-49}],"sizeInsertions":241,"sizeDeletions":-89}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}