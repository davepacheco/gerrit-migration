{"project":"joyent/illumos-joyent","branch":"master","id":"I1ee89f3ab0fcdfbd337595dc3b86031c68704474","number":"2509","subject":"OS-6276 lx set TCP_KEEPINTVL fails Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2509","commitMessage":"OS-6276 lx set TCP_KEEPINTVL fails\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1504805240,"lastUpdated":1504909551,"open":false,"status":"MERGED","comments":[{"timestamp":1504805240,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1504810859,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1504816441,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nI implemented all of the suggested changes."},{"timestamp":1504816454,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1504821411,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1\n\n(2 comments)\n\nLooks good.  I included a couple minor style comments.\n\nIf we\u0027re worried about raciness in the long run, perhaps we add a custom setsockopt at the TCP level (something hidden in the headers via a _KERNEL guard) to perform all of the changes described below while guarded by the socket/squeue lock."},{"timestamp":1504823855,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nThanks for the good suggestions. I\u0027ve made the two changes and added a comment about locking."},{"timestamp":1504823867,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1504891485,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\nI tested with a simple program that steps up the interval from 10 to 600. Using DTrace I can see when we change the other two limits internally. I also tested with a 7k limit, which works, and an 8k limit which fails due to the 2 hour max (and I can see us reset the other two limits back to their previous values)."},{"timestamp":1504908440,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1504909331,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1504909521,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1504909551,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"5","revision":"1ee89f3ab0fcdfbd337595dc3b86031c68704474","parents":["a7395cadf27a69889b3c5acb6d39491a2e76a1f6"],"ref":"refs/changes/09/2509/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504909521,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1504909551,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":78,"deletions":-4}],"sizeInsertions":78,"sizeDeletions":-4},"patchSets":[{"number":"1","revision":"0bbff91de2cac0b6b3d8ac3e5dd3838411dc943f","parents":["b5921b68e3c3270372dc07d568b4024543b4f957"],"ref":"refs/changes/09/2509/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504805240,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":2917,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It seems that Linux constrains the input value to 32k (tossing EINVAL for those over).  Perhaps we should do the same to avoid overflow here?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":2920,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Since we don\u0027t care much about these since we know our input is of the proper length, maybe just use one throw-away length var for the intermediate steps?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":2940,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"If the subsequent setsockopt were to fail, would we perhaps want to try to tune these back to their original values?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":35,"deletions":0}],"sizeInsertions":35,"sizeDeletions":0},{"number":"2","revision":"5b05ed0b1185bd3505307404943d6f836668c993","parents":["b5921b68e3c3270372dc07d568b4024543b4f957"],"ref":"refs/changes/09/2509/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504816454,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504821411,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":2933,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe use SHRT_MAX"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","line":2938,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027d save a few characters (and maybe some work) to cache this, given how many times its referenced."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":71,"deletions":0}],"sizeInsertions":71,"sizeDeletions":0},{"number":"3","revision":"f48291674ab6243d5fbc118a1db44cacc0c21e04","parents":["b5921b68e3c3270372dc07d568b4024543b4f957"],"ref":"refs/changes/09/2509/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504823867,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":78,"deletions":-4}],"sizeInsertions":78,"sizeDeletions":-4},{"number":"4","revision":"8f29a09e219927953adf08ac822f383ca06d6965","parents":["a7395cadf27a69889b3c5acb6d39491a2e76a1f6"],"ref":"refs/changes/09/2509/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504909331,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":78,"deletions":-4}],"sizeInsertions":78,"sizeDeletions":-4},{"number":"5","revision":"1ee89f3ab0fcdfbd337595dc3b86031c68704474","parents":["a7395cadf27a69889b3c5acb6d39491a2e76a1f6"],"ref":"refs/changes/09/2509/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1504909521,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1504909551,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1504908440,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_socket.c","type":"MODIFIED","insertions":78,"deletions":-4}],"sizeInsertions":78,"sizeDeletions":-4}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}