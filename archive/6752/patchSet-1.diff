From b4ce3c51dde701699e1e29453435758fbd1acc26 Mon Sep 17 00:00:00 2001
From: Mark Brooks <mark.brooks@joyent.com>
Date: Mon, 5 Aug 2019 14:46:26 -0400
Subject: [PATCH] OS-7887 dcmd rnd_stats reports incorrect statistics

---
 usr/src/cmd/mdb/common/modules/random/random.c | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/usr/src/cmd/mdb/common/modules/random/random.c b/usr/src/cmd/mdb/common/modules/random/random.c
index a1b41f0eb8..adf254a1b0 100644
--- a/usr/src/cmd/mdb/common/modules/random/random.c
+++ b/usr/src/cmd/mdb/common/modules/random/random.c
@@ -24,6 +24,10 @@
  * Use is subject to license terms.
  */
 
+/*
+ * Copyright (c) 2019, Joyent, Inc. All rights reserved.
+ */
+
 #pragma ident	"%Z%%M%	%I%	%E% SMI"
 
 #include <sys/mdb_modapi.h>
@@ -39,10 +43,10 @@ rnd_get_stats(uintptr_t addr, uint_t flags, int argc, const mdb_arg_t *argv)
 {
 	rnd_stats_t rnd_stats, rnd_stats_cpu;
 	uint32_t random_max_ncpus;
-	size_t rndmag_t_size;
+	size_t rndmag_pad_t_size;
 	ulong_t rndmag_t_offset;
 	uintptr_t rndmag;
-	mdb_ctf_id_t rndmag_id;
+	mdb_ctf_id_t rndmag_id, rndmag_pad_id;
 	int i;
 
 	if ((flags & DCMD_ADDRSPEC) || argc != 0)
@@ -57,11 +61,13 @@ rnd_get_stats(uintptr_t addr, uint_t flags, int argc, const mdb_arg_t *argv)
 	    (mdb_ctf_offsetof(rndmag_id, "rm_stats", &rndmag_t_offset) != 0) ||
 	    (mdb_readvar(&random_max_ncpus, "random_max_ncpus") == -1) ||
 	    (mdb_readvar(&rndmag, "rndmag") == -1) ||
-	    ((rndmag_t_size = mdb_ctf_type_size(rndmag_id)) == 0)) {
+	    (mdb_ctf_lookup_by_name("rndmag_pad_t", &rndmag_pad_id) != 0) ||
+	    ((rndmag_pad_t_size = mdb_ctf_type_size(rndmag_pad_id)) == 0)) {
 		/* Can't find per-cpu stats.  Don't add them in. */
 		random_max_ncpus = 0;
 	}
 
+	/* mdb_ctf_offsetof() returns offset in bits, not bytes */
 	rndmag_t_offset /= 8;
 
 	/*
@@ -69,7 +75,7 @@ rnd_get_stats(uintptr_t addr, uint_t flags, int argc, const mdb_arg_t *argv)
 	 */
 	for (i = 0; i < random_max_ncpus; i++) {
 		mdb_vread(&rnd_stats_cpu, sizeof (rnd_stats_cpu),
-		    rndmag + rndmag_t_offset + i * rndmag_t_size);
+		    rndmag + rndmag_t_offset + i * rndmag_pad_t_size);
 
 		rnd_stats.rs_rndOut += rnd_stats_cpu.rs_rndOut;
 		rnd_stats.rs_rndcOut += rnd_stats_cpu.rs_rndcOut;
-- 
2.21.0

