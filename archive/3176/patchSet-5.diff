commit ecd0aa8a41e84c77d49f6c114916ccc259e0046a (refs/changes/76/3176/5)
Author: Jan Wyszynski <jan.wyszynski@joyent.com>
Date:   2018-01-10T00:19:56+00:00 (1 year, 9 months ago)
    
    MANTA-3542 zookeeper reports ephemeral nodes with previous owning sessions

diff --git a/lib/register.js b/lib/register.js
index ca4582e..28efa0c 100644
--- a/lib/register.js
+++ b/lib/register.js
@@ -190,44 +190,106 @@ function registerEntries(opts, cb) {
             var data = new Buffer(JSON.stringify(_obj), 'utf8');
 
             /*
-             * Manual testing shows that in cases where the zookeeper server
-             * process has been shut down long enough so that the session
-             * held by this client has expired, it's possible that once the
-             * server comes back up the ephemeral will still exist for a short
-             * time. Syncing the node makes sure that we are up to date on its
-             * latest state before trying to create it. We don't have to worry
-             * about this for service nodes, since they are persistent.
+             * Time to wait before again stating the ephemeral node we've
+             * tried to created but had found already exists. On each successive
+             * call, this value increases by a power of two up to 16 seconds.
              */
-            zk.sync(n, function (err) {
-                if (err) {
-                    _cb(err);
-                    return;
+            var INTERVAL_FLOOR = 1000;
+            var INTERVAL_CEIL = 16000;
+            var GROWTH_FACTOR = 2;
+
+            var statInterval = INTERVAL_FLOOR;
+            var timer;
+
+            /*
+             * Schedule a stat operation on the node in N seconds, where
+             * INTERVAL_FLOOR <= N < INTERVAL_CEIL.
+             */
+            function tryDelayedCheckNodeExists(callback) {
+                if (statInterval >= INTERVAL_CEIL) {
+                    statInterval = INTERVAL_FLOOR;
                 }
+                log.info('checking for existence of ephemeral node ' + n +
+                        ' in ' + statInterval + ' seconds.');
+                timer = setTimeout(checkNodeExists.bind(null, callback),
+                    statInterval);
+                statInterval *= GROWTH_FACTOR;
+            }
+
+            /*
+             * Check for the existence of the ephemeral node with the
+             * appropriate owning session. If one doesn't exist, or we've
+             * suffered a transient connection loss due to the zookeeper servers
+             * just starting up, create the node.
+             */
+            function checkNodeExists (callback) {
+                zk.stat(n, function (err, stat) {
+                    if (err) {
+                        if (err.code === 'NO_NODE') {
+                            createEphemeral(callback);
+                        } else {
+                            callback(err);
+                        }
+                        return;
+                    }
+                    tryDelayedCheckNodeExists(callback);
+                });
+            }
+
+            function createEphemeral(callback) {
                 /*
-                 * It's possible that we're recovering an existing session
-                 * before it times out. In this case, the ephemeral nodes we'll
-                 * want to create already exist. Since this is likely to happen
-                 * over a flappy connection, simply log the error and move on.
+                 * It's possible that zookeeper will report nodes that were owned
+                 * by previous sessions even after said session has expired. This
+                 * presents a window during which it's possible for the node to
+                 * silently drop out of zookeeper. To prevent this, we use an
+                 * exponential backoff mechanism that checks if the node exists,
+                 * recreating it if it drops out.
                  */
                 zk.createWithEmptyParents(n, data, _opts, function (err) {
                     if (err) {
                         if (err.code === 'NODE_EXISTS') {
                             log.warn(err, 'register: ephemeral node ' + n +
-                                ' already exists');
-                            _cb();
+                                ' already exists. Starting delayed ' +
+                                'existence checks.');
+                            tryDelayedCheckNodeExists(callback);
+                            return;
+                        } else if (err.code === 'CONNECTION_LOSS') {
+                            /*
+                             * On restart, it's possible that node-zkstreams
+                             * cueball connection set will move the session to a
+                             * new backend due to zookeeper servers going down.
+                             */
+                            log.warn(err, 'register: experienced connection ' +
+                                'loss while createing ephemeral node ' + n +
+                                '. Starting delayed re-create attempts.');
+                            tryDelayedCheckNodeExists(callback);
                             return;
                         }
-                        _cb(err);
+                        callback(err);
                     } else {
                         opts.registrar.ephemerals[n] = {
                             data: data,
                             flags: _opts.flags,
                             path: n
                         };
-                        _cb();
+                        callback();
                     }
                 });
-            });
+            }
+
+            /*
+             * Interpose the vasync callback with a callback that clears the
+             * stat-interval timer. This is only called when either there is a
+             * fatal error during creation, or the node was successfully
+             * created. In both cases, if we've set a timeout, we'll want it
+             * gone before proceeding.
+             */
+            var clearTimerAndCallback = function (err) {
+                clearTimeout(timer);
+                _cb(err);
+            }
+
+            createEphemeral(clearTimerAndCallback);
         },
         inputs: opts.nodes
     }, function (err) {
