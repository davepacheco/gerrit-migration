{"project":"joyent/registrar","branch":"master","id":"Ie8c90281c314f4c83f125ccb785ec7430d2389be","number":"3176","subject":"MANTA-3542 zookeeper reports ephemeral nodes with previous owning sessions","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/3176","commitMessage":"MANTA-3542 zookeeper reports ephemeral nodes with previous owning sessions\n","createdOn":1515467072,"lastUpdated":1515614017,"open":false,"status":"ABANDONED","comments":[{"timestamp":1515467072,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1515467097,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515533969,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1515537203,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1515541154,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1515541177,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515541260,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2:\n\n(7 comments)"},{"timestamp":1515541266,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1515541290,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515541561,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3:\n\nI think there\u0027s still a problem with this code because it doesn\u0027t check whether the stat function returns a node with an ephemeralOwner that corresponds to the current session. It\u0027s possible (this just came up in one of my tests) that the node is re-created (for the current session), but then something else triggers a register operation. At this point the node is created and has the current session as it\u0027s owner, but we\u0027ve dispatched a chain of existence checks that will never terminate because the node that exists is the correct one. I think a fix for this would require us to check compare the \u0027ephemeralOwner\u0027 field in the stat structure to the current session id, but I don\u0027t think that the current session id is accessible from registrar."},{"timestamp":1515541706,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1515541730,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515543632,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1515543656,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515544259,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 5:\n\nActually, please disregard the previous comment. The real problem is that createWithEmptyParents is not atomic, and may return a CONNECTION_LOSS error if cueball decides to move the connection to a different backed as createWithEmptyParents is executing, but before it has determined whether the \u0027basename\u0027 node exists. In this case we need to retry the operation so that we can determine whether the ephemeral node does exist, and if it does kick off a delayed stat chain."},{"timestamp":1515544551,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1515549430,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1515549453,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515550750,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 7."},{"timestamp":1515550774,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515557579,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7:\n\n(7 comments)"},{"timestamp":1515558839,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1515559634,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1515561442,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1515561471,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515562605,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(7 comments)"},{"timestamp":1515562920,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1515614017,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Abandoned\n\nI\u0027m going to abandon this CR since the changes that it introduces are going to be rolled back in change 3185. I will push a new CR with the combined changes of MANTA-3223, MANTA-3536, and MANTA-3542 which really should all be in the same ticket."}],"currentPatchSet":{"number":"8","revision":"e8c90281c314f4c83f125ccb785ec7430d2389be","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515561442,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515561471,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":125,"deletions":-21}],"sizeInsertions":125,"sizeDeletions":-21},"patchSets":[{"number":"1","revision":"476c76346186f1d8e5d9e670be782494948d10f8","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515467072,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515467097,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/register.js","line":193,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Can we do this as 1000, 2000, 4000, 8000 then 8000 for all subsequent retries, please? I want to get rid of anything hammering zk faster than ~10 sec in a loop."},{"file":"lib/register.js","line":193,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":196,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As mentioned below, comments should generally just contain the context you\u0027re referring to, rather than a ticket number."},{"file":"lib/register.js","line":196,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":198,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"no space here"},{"file":"lib/register.js","line":198,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":201,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"We should log here how long it will be until our next retry and the fact that we\u0027re retrying."},{"file":"lib/register.js","line":201,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":205,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"In general I think it\u0027s common to make the \"if (err) {\" case the early return path.  Either way, these two \"if\" blocks are mutually exclusive so one of them can just be the main body; e.g.,\n\n    if (err) {\n        if (err.code \u003d\u003d\u003d \u0027NO_NODE\u0027) {\n            createEphemeral();\n            return;\n        }\n    \n        _cb(err);\n        return;\n    }\n    \n    timer \u003d setTimeout(checkNodeExists..."},{"file":"lib/register.js","line":205,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":215,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"no space here"},{"file":"lib/register.js","line":215,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":222,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It\u0027s best to make the comments stand alone without references to ticket numbers.  The source history will reflect that this all went in for MANTA-3542.  I would clip out this out."},{"file":"lib/register.js","line":222,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":232,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"This log message should note that we\u0027re going to retry in N seconds"},{"file":"lib/register.js","line":232,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":233,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"This line is too wide."},{"file":"lib/register.js","line":233,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":260,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As with \"free(3C)\", it is safe to just call \"clearTimeout(timer)\" without checking if it\u0027s falsey."},{"file":"lib/register.js","line":260,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":48,"deletions":-14}],"sizeInsertions":48,"sizeDeletions":-14},{"number":"2","revision":"4501b5fe40fd43298aed2f1a1b89f195bb38aeb7","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515541154,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515541177,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/register.js","line":259,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Don\u0027t know how this got in here, removed in the next patchset"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":77,"deletions":-20}],"sizeInsertions":77,"sizeDeletions":-20},{"number":"3","revision":"677eea1ba54516f24e201aa227eef2d6b71d1277","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515541266,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515541290,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":77,"deletions":-20}],"sizeInsertions":77,"sizeDeletions":-20},{"number":"4","revision":"ace6aa8ab009224c0e31014c90d75571e54bb81e","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515541706,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515541730,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":77,"deletions":-20}],"sizeInsertions":77,"sizeDeletions":-20},{"number":"5","revision":"ecd0aa8a41e84c77d49f6c114916ccc259e0046a","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515543632,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515543656,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":82,"deletions":-20}],"sizeInsertions":82,"sizeDeletions":-20},{"number":"6","revision":"7f79c55d2ba2471299f9d1c45526f4a533e769ed","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515549430,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515549453,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":73,"deletions":-21}],"sizeInsertions":73,"sizeDeletions":-21},{"number":"7","revision":"5bf3c1fda136e98d13c084ffca9a815db7310226","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515550750,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515550774,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/register.js","line":218,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Should this be \"INTERVAL_CEIL\"?  Doesn\u0027t this mean that we\u0027ll basically do a retry after 1s, 2s, 4s, 8s, 16s, 1s, 2s, 4s, 8s, ... ?"},{"file":"lib/register.js","line":218,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Yeah - it\u0027s probably better to keep it at INTERVAL_CEIL as opposed to backing off again."},{"file":"lib/register.js","line":223,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this can just be:\n\n    timer \u003d setTimeout(checkNodeExists, statInterval, callback);\n\nThe signature of \"setTimeout()\" is:\n\n    setTimeout(callback, interval, [arg, arg, ...]);\n\nAll of the arguments after the timeout interval are passed as arguments to the callback function."},{"file":"lib/register.js","line":223,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":234,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Should we log the result of a successful \"stat\", in case we need to see it later?"},{"file":"lib/register.js","line":236,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This line is now \u003e80 characters."},{"file":"lib/register.js","line":236,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":239,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"In cases like this where we\u0027re deciding to fail fatally, it might help to use a \"VError\" to add some context; e.g.,\n\n    setImmediate(callback, new VError(err, \u0027check node \"%s\" exists\u0027, n));"},{"file":"lib/register.js","line":239,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":250,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"\u003e80 columns"},{"file":"lib/register.js","line":250,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":266,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"VError here as well, perhaps?\n\n    setImmediate(callback, new VError(err, \u0027create node \"%s\"\u0027, n));"},{"file":"lib/register.js","line":266,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/register.js","line":290,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027m finding the control flow to be a bit difficult to follow.  It seems like the only value \"callback\" will ever have in any of these functions is actually \"clearTimerAndCallback()\".  Is that right?  It seems like the possible transitions are:\n\n    ,-\u003e  createEphemeral  ---\u003e  clearTimerAndCallback\n    |                                     \n    |        |                           ^\n    |        |                           |\n    |        V                           |\n    |                                    |\n    |   tryDelayedCheckNodeExists        |\n    |                                    |\n    |        |     ^                     |\n    |        |     |                     |\n    |        V     |                     |\n    |                                    |\n    `-- checkNodeExists -----------------\u0027\n\nIf so, could we make this a function definition the same as the others (rather than a \"var\" statement) and just refer to it by name, rather than passing \"callback\" around?\n\nIt may also help to include something like the diagram above, perhaps with annotations that describe the transitions."},{"file":"lib/register.js","line":290,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"In addition, I\u0027m a bit concerned that there might be ways (particularly involving the CONNECTION_LOSS error) where we might continue to poll forever because we were able to create our node correctly, but did not receive acknowledgement of that fact.  That is, if we\u0027re _not_ in the condition we\u0027re trying to avoid, where the node vanishes later, won\u0027t we get stuck here forever?"},{"file":"lib/register.js","line":290,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I think the only way we could ever get started down the stat\u0027ing path is if we find that an ephemeral node that we need to create already exists. There are only two ways this function gets executed in registrar: \n\n(1) node-zkstream sends it a \u0027session\u0027 event - which means that the existing ephemeral nodes from previous session should already be gone, or we are racing with another registrar process trying to create the same ephemeral node in the same zone. I *think* that the latter case is a problem in its own right that would require operator intervention. A registrar process creating a unique ephemeral node that cannot have multiple zookeeper sessions at the same time should never see the ephemeral node as it\u0027s trying to create it. \n\n(2) a healthcheck event indicates that the process registrar is representing has come back up. In order for such an event to be emitted, the healthcheck must have failed at some point, at which point the ephemeral nodes would be unregistered (https://github.com/joyent/registrar/blob/dev-MANTA-3542/lib/index.js#L142, that ordering is enforced by the \u0027down\u0027 variable) and so wouldn\u0027t exist when we come to create them again.\n\nAs I\u0027m writing this I think I might see what you\u0027re saying here. I suppose if we do suffer a connection loss for sessionTimeout+epsilon and we are unable to resume the session, a new session will be created. At that point this code and the creation code for the new session would race to create the node and one of them will get stuck running the state chain forever. I think we could resolve this by recording the session id of the current session before we start executing and check against any node we find to ensure it matches or it is smaller? \n\nSorry for long comment."},{"file":"lib/register.js","line":290,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"We could also kick off a timeout if we received a CONNECTION_LOSS error that short circuits this operation if it takes longer than 2 * sessionTimeout. At that point we can assume something went wrong because the ghost node from the previous session should already have dropped out, meaning something else is maintaining the pre-existing ephemeral node."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":81,"deletions":-21}],"sizeInsertions":81,"sizeDeletions":-21},{"number":"8","revision":"e8c90281c314f4c83f125ccb785ec7430d2389be","parents":["9cc905f3600e69b1c5e8e9ed01fbe9294ca50851"],"ref":"refs/changes/76/3176/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1515561442,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515561471,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/register.js","type":"MODIFIED","insertions":125,"deletions":-21}],"sizeInsertions":125,"sizeDeletions":-21}],"allReviewers":[{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Joyent Automation","username":"joyent-automation"}]}