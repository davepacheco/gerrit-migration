{"project":"joyent/illumos-joyent","branch":"master","id":"Iea9d7b5c804b8f84f0f7f73d8747c06291d0614d","number":"6498","subject":"OS-6135 comm page should fallback to syscall after excessive migration Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/6498","commitMessage":"OS-6135 comm page should fallback to syscall after excessive migration\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1561486211,"lastUpdated":1562337184,"open":false,"status":"MERGED","comments":[{"timestamp":1561486211,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1561498249,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nRobert\u0027s upstreaming effort of commpage-adjacent logic reminded me to dig this up and test it."},{"timestamp":1561498391,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1561566548,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1561577793,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1561586926,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1561657100,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1561657826,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1561657882,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1561657910,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1561669234,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1561669457,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1561669804,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1561736060,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1562165781,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1562168111,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1562177512,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1562177629,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1562177652,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\nI\u0027m waiting until branches are cut tonight to merge this."},{"timestamp":1562337141,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1562337184,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"7","revision":"ea9d7b5c804b8f84f0f7f73d8747c06291d0614d","parents":["7b68e6271c0d65aaf13b11f96df43d8572db22fb"],"ref":"refs/changes/98/6498/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1562337141,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669234,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669804,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561736060,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562177512,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1562337184,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53},"patchSets":[{"number":"1","revision":"5f4adbf72c863c9650ed11b90cc0d4af76ff241b","parents":["d152c784e9ec5ececac97129ea92fe6afc57078c"],"ref":"refs/changes/98/6498/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1561486211,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/lib/commpage/amd64/cp_subr.s","line":13,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"update to current year"},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","line":13,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Originally I was going to leave these, since it\u0027s when the change was authored, but with the little nit updates, I\u0027ll bring \u0027em up to current."},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","line":181,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"You could remove this instruction and put label 3 back where it was previously, before line 110 in the new code, which might be a little clearer, but it\u0027s up to you."},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","line":181,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"label 3 signifies the start of the switch() statement for TSC reading type.  I\u0027d like to keep it that way at the cost of an extra register operation.  There is no cost unless a CPU migration happens during the tsc/offset read."},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","line":186,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Should we use rax here since this is the 64-bit asm? I\u0027m just worried about the top 32 bits somehow holding data."},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","line":186,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This effectively clears the upper bits."},{"file":"usr/src/lib/commpage/common/cp_main.c","line":13,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"update to current year"},{"file":"usr/src/lib/commpage/i386/cp_subr.s","line":123,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"You might be asking: Why is %eax being moved here, rather than %ecx?  It\u0027s a legitimate bug in the old code."},{"file":"usr/src/lib/commpage/i386/cp_subr.s","line":13,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"year"},{"file":"usr/src/lib/commpage/i386/cp_subr.s","line":34,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Shouldn\u0027t the arg be `comm_page_t *`?"},{"file":"usr/src/lib/commpage/i386/cp_subr.s","line":34,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Aye.  Seems to have been busted for a while.  Will fix."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":62,"deletions":-19}],"sizeInsertions":160,"sizeDeletions":-51},{"number":"2","revision":"4b3392b616aac21bf043d126f2544d07f9b15b2c","parents":["d152c784e9ec5ececac97129ea92fe6afc57078c"],"ref":"refs/changes/98/6498/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1561657826,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53},{"number":"3","revision":"66251d90370e26090f16430ab2e1be69b3e1192c","parents":["d52326b14627b369debbeb1c820b08a811328317"],"ref":"refs/changes/98/6498/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1561657910,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669234,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669804,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561736060,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/lib/commpage/i386/cp_subr.s","line":38,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"One thing I found a little confusing is that while this is all described relative to %ebp a number of the actual accesses are all relative to %esp."},{"file":"usr/src/lib/commpage/i386/cp_subr.s","line":38,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It made sense to me to have them sorted like that since the stores are in that order in the code immediately below."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53},{"number":"4","revision":"b6dde59fac49483d8df921323a71c4c2c9436eea","parents":["5c0d9bd77b0d611d65763bdd3980ecb13f9ab4ea"],"ref":"refs/changes/98/6498/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1562165781,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669234,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669804,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561736060,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53},{"number":"5","revision":"7853918975421c22acab0a0bf1d8f6b07bb0fe08","parents":["5c0d9bd77b0d611d65763bdd3980ecb13f9ab4ea"],"ref":"refs/changes/98/6498/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1562168111,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669234,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562177512,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669804,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561736060,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53},{"number":"6","revision":"cbdd67393fd7a7fd0d990983bfac082b77b44b06","parents":["5c0d9bd77b0d611d65763bdd3980ecb13f9ab4ea"],"ref":"refs/changes/98/6498/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1562177629,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669234,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562177512,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669804,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561736060,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53},{"number":"7","revision":"ea9d7b5c804b8f84f0f7f73d8747c06291d0614d","parents":["7b68e6271c0d65aaf13b11f96df43d8572db22fb"],"ref":"refs/changes/98/6498/7","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1562337141,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669234,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562177512,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561669804,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1562337184,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1561736060,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/commpage/amd64/cp_subr.s","type":"MODIFIED","insertions":88,"deletions":-31},{"file":"usr/src/lib/commpage/common/cp_main.c","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"usr/src/lib/commpage/i386/cp_subr.s","type":"MODIFIED","insertions":63,"deletions":-20}],"sizeInsertions":162,"sizeDeletions":-53}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}