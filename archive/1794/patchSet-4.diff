From 6095b68db4562ade3665802d73a806f96853e1d5 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Tue, 18 Apr 2017 19:23:46 -0700
Subject: [PATCH] TOOLS-1753 sdcnode inexplicably doing `npm install` before
 building node

---
 Makefile           |  8 ++------
 nodeconfigs.json   |  8 ++++----
 package.json       |  3 ---
 tools/build-a-node | 15 +++++++--------
 4 files changed, 13 insertions(+), 21 deletions(-)

diff --git a/Makefile b/Makefile
index 39a1b64..a8f5b41 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
 #
@@ -34,10 +34,6 @@ HOST_IMAGE=$(shell mdata-get sdc:image_uuid)
 .PHONY: all
 all: build/src nodes bits
 
-.PHONY: npmdeps
-npmdeps:
-	npm install
-
 build/src:
 	git clone https://github.com/nodejs/node.git build/src
 
@@ -47,7 +43,7 @@ nodesrc: | build/src
 		&& git fetch origin && git pull --rebase origin master
 
 .PHONY: nodes
-nodes: nodesrc npmdeps
+nodes: nodesrc
 	./tools/build-all-nodes $(TOP)/build/nodes $(STAMP) "this.image=='$(HOST_IMAGE)'"
 
 .PHONY: bits
diff --git a/nodeconfigs.json b/nodeconfigs.json
index 3539973..1821b57 100644
--- a/nodeconfigs.json
+++ b/nodeconfigs.json
@@ -4,7 +4,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v4.8.1",
         "configure_flags": "--dest-cpu=ia32 --with-dtrace",
-        "gcc_version_range": "4.9.x",
+        "gcc_version_prefix": "4.9.",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -31,7 +31,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v4.7.3",
         "configure_flags": "--dest-cpu=ia32 --with-dtrace",
-        "gcc_version_range": "4.9.x",
+        "gcc_version_prefix": "4.9.",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -50,7 +50,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v4.6.1",
         "configure_flags": "--dest-cpu=ia32 --with-dtrace",
-        "gcc_version_range": "4.9.x",
+        "gcc_version_prefix": "4.9.",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
@@ -69,7 +69,7 @@
         "image": "18b094b0-eb01-11e5-80c1-175dac7ddf02",
         "version": "v4.6.0",
         "configure_flags": "--dest-cpu=ia32 --with-dtrace",
-        "gcc_version_range": "4.9.x",
+        "gcc_version_prefix": "4.9.",
         "rpath": "$ORIGIN/../lib",
         "include_gcc_runtime_libs": true,
         "build_tag": "gz"
diff --git a/package.json b/package.json
index f639040..7b9e1d9 100644
--- a/package.json
+++ b/package.json
@@ -7,8 +7,5 @@
   "engines": [
     "node >=0.10.0"
   ],
-  "devDependencies": {
-    "semver": "5.3.0"
-  },
   "license": "MPL-2.0"
 }
diff --git a/tools/build-a-node b/tools/build-a-node
index c8dfe90..ab41f40 100755
--- a/tools/build-a-node
+++ b/tools/build-a-node
@@ -27,7 +27,7 @@
 # - configure_flags:
 # - build_env: Environment vars to pass to the `make` command to build node
 # - build_tag:
-# - gcc_version_range: A node-semver range to compare against the GCC used to
+# - gcc_version_prefix: A node-semver range to compare against the GCC used to
 #   build node
 # - rpath: A string to which to set the node RPATH/RUNPATH.
 # - include_gcc_runtime_libs: Include the needed libs from the GCC runtime
@@ -63,13 +63,12 @@ echo "# Build a node in $buildDir with this config:"
 echo "$buildOpts" | json
 
 # Ensure we have a particular gcc version.
-gccVersionRange=$(echo "$buildOpts" | json gcc_version_range)
-if [[ -n "$gccVersionRange" ]]; then
-    currGccVer=$($GCC --version | head -1 | awk '{print $NF}')
-    matching=$(./node_modules/.bin/semver -r "$gccVersionRange" $currGccVer || true)
-    if [[ -z "$matching" ]]; then
-        echo "build-a-node: fatal error: gcc version ($currGccVer) does not" \
-            "match the given range: $gccVersionRange" >&2
+gccVersionPrefix=$(echo "${buildOpts}" | json gcc_version_prefix)
+if [[ -n "${gccVersionPrefix}" ]]; then
+    currGccVer=$(${GCC} --version | head -1 | awk '{print $NF}')
+    if [[ ${currGccVer} != ${gccVersionPrefix}* ]]; then
+        echo "build-a-node: fatal error: gcc version (${currGccVer}) does not" \
+            "match the given prefix: ${gccVersionPrefix}" >&2
         exit 1
     fi
 fi
-- 
2.21.0

