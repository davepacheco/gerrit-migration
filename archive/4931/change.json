{"project":"joyent/illumos-joyent","branch":"master","id":"I41cf9b3848d0c50f837a8d5e390d9b2ae462ce5b","number":"4931","subject":"OS-7288 race during process exit blows assertion in lx_ptrace_exit_tracee Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Dan McDonald \u003cdanmcd@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/4931","commitMessage":"OS-7288 race during process exit blows assertion in lx_ptrace_exit_tracee\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Dan McDonald \u003cdanmcd@joyent.com\u003e\n","createdOn":1538773457,"lastUpdated":1539629786,"open":false,"status":"MERGED","comments":[{"timestamp":1538773457,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1538839585,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: Code-Review-1\n\nTesting the fix has turned up a hang during process teardown. Better than a panic, but still not quite there.\n\n\u003e fffffe4c25cccff8::walk thread | ::findstack -v\nstack pointer for thread fffffe0c2922e480: fffffe00108a1c60\n[ fffffe00108a1c60 _resume_from_idle+0x12b() ]\n  fffffe00108a1c90 swtch+0x18a()\n  fffffe00108a1cc0 cv_wait+0x89(fffffe4c25ccd0be, fffffe0be6676280)\n  fffffe00108a1d00 exitlwps+0x13c(0)\n  fffffe00108a1d90 proc_exit+0x5d(2, 19)\n  fffffe00108a1db0 exit+0x15(2, 19)\n  fffffe00108a1e30 psig+0x3b4()\n  fffffe00108a1ef0 post_syscall+0x895(0, 1)\n  fffffe00108a1f00 0xfffffffffb801277()\nstack pointer for thread fffffe0bf004b3e0: fffffe000ffbecc0\n[ fffffe000ffbecc0 _resume_from_idle+0x12b() ]\n  fffffe000ffbecf0 swtch+0x18a()\n  fffffe000ffbed70 stop+0x3d6(9, 2)\n  fffffe000ffbedc0 lx_ptrace_stop_common+0x71(fffffe4c25cccff8, fffffe181a673a00, 2)\n  fffffe000ffbee00 lx_ptrace_stop+0x92(2)\n  fffffe000ffbee60 lx_syscall_return+0x64(fffffe0bee6aa0c0, 2b, 4)\n  fffffe000ffbeee0 lx_syscall_enter+0x1b8()\n  fffffe000ffbef00 sys_syscall+0x242()"},{"timestamp":1539009420,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: -Code-Review\n\nPrevious -1 was false alarm.  I was reproducing OS-6580."},{"timestamp":1539016032,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1539018038,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1539029050,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1\n\nThank you, that was what I was hoping to hear."},{"timestamp":1539358410,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1539365294,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1:\n\nThe ticket documents testing to exercise this code path - done on debug and non-debug.  Unfortunately, this gets hung up somewhat frequently due to OS-6580."},{"timestamp":1539620918,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Integration-Approval+1"},{"timestamp":1539621879,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2: Commit message was updated."},{"timestamp":1539621886,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1539629786,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"3","revision":"169deab52cd857330565aa848f67d4d1538ccb67","parents":["399b0f0918b61aac804de87f751fd86187c86201"],"ref":"refs/changes/31/4931/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1539621886,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539029050,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539358410,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539620918,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1539629786,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":48,"deletions":-9}],"sizeInsertions":48,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"41cf9b3848d0c50f837a8d5e390d9b2ae462ce5b","parents":["6dfc9cdf26a31c05ac54748aa413187e43a0a214"],"ref":"refs/changes/31/4931/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1538773457,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539358410,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539029050,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539620918,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","line":1986,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is it *possible* for this to endlessly loop?  If so, can root@zone or less use malicious processes to make that happen?"},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","line":1986,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I think that hitting it once would be pretty unlikely, even if trying.\n\nSupposing it is easier than I think, it still isn\u0027t particularly dangerous.  Hitting it requires two system calls, giving the system (e.g. kill -9, zone halt) a chance to kill the process(es) that are  causing the tracer to be updated."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":48,"deletions":-9}],"sizeInsertions":48,"sizeDeletions":-9},{"number":"2","revision":"f32845ee1831fe58e5f2b2fd399047d8e9751c12","parents":["6dfc9cdf26a31c05ac54748aa413187e43a0a214"],"ref":"refs/changes/31/4931/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1539621879,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539358410,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539029050,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539620918,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":48,"deletions":-9}],"sizeInsertions":48,"sizeDeletions":-9},{"number":"3","revision":"169deab52cd857330565aa848f67d4d1538ccb67","parents":["399b0f0918b61aac804de87f751fd86187c86201"],"ref":"refs/changes/31/4931/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1539621886,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539358410,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539029050,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539620918,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1539629786,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/brand/lx/os/lx_ptrace.c","type":"MODIFIED","insertions":48,"deletions":-9}],"sizeInsertions":48,"sizeDeletions":-9}],"allReviewers":[{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}