commit d5e551c4d761f6b459f8a3d53ae193114556a83f (refs/changes/13/5513/2)
Author: Rui Loura <rui@joyent.com>
Date:   2019-02-15T16:03:52+00:00 (8 months ago)
    
    TRITON-823 adminui needs to be rack aware

diff --git a/lib/api/imgapi-external-nic-status.js b/lib/api/imgapi-external-nic-status.js
index 7466b578..2a009f8e 100644
--- a/lib/api/imgapi-external-nic-status.js
+++ b/lib/api/imgapi-external-nic-status.js
@@ -5,10 +5,11 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var restify = require('restify');
+var netconfig = require('triton-netconfig');
 
 module.exports = function imgapiExternalNicStatus(req, res, next) {
     req.sdc[req.dc].vmapi.listVms({
@@ -17,12 +18,11 @@ module.exports = function imgapiExternalNicStatus(req, res, next) {
         'tag.smartdc_type':'core'
     }, function listVmsCallback(err, vms) {
         if (err || !vms[0]) {
-            return next(new restify.InternalError('Unable to retrieve nic information'));
+            return next(new restify.InternalError(
+                'Unable to retrieve nic information'));
         }
 
-        var externalNic = vms[0].nics.filter(function (n) {
-            return n.nic_tag === 'external';
-        })[0];
+        var externalNic = vms[0].nics.filter(netconfig.isNicExternal);
 
         res.send({
             imgapiUuid: vms[0].uuid,
diff --git a/lib/api/manta.js b/lib/api/manta.js
index 889c8ea5..66f02ebc 100644
--- a/lib/api/manta.js
+++ b/lib/api/manta.js
@@ -5,12 +5,13 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var kang = require('kang');
 var _ = require('underscore');
 var Promise = require('promise');
+var netconfig = require('triton-netconfig');
 
 var sapi;
 var vmapi;
@@ -97,17 +98,12 @@ var getServerForServerUuids = function (serverUuids) {
     return Promise.all(tasks);
 };
 
-var getMantaNicIpsFromServers = function (servers) {
+var getAdminIpsFromMantaServers = function (servers) {
     return new Promise(function (revolve, reject) {
         log.info('got servers with manta agents', servers.length);
+
         var ips = servers.map(function (sv) {
-            var ip;
-            _.each(sv.sysinfo['Network Interfaces'], function (nic, n) {
-                if (nic['NIC Names'].indexOf('admin') !== -1) {
-                    ip = nic.ip4addr;
-                }
-            });
-            return ip;
+            return netconfig.adminIpFromSysinfo(sv.sysinfo);
         });
 
         revolve(ips);
@@ -144,7 +140,7 @@ function getHosts() {
                 return getServerForServerUuids(serverUuids);
             })
              .then(function (servers) {
-                return getMantaNicIpsFromServers(servers);
+                return getAdminIpsFromMantaServers(servers);
             });
     }
 }
diff --git a/package.json b/package.json
index 85c9bc5c..208a9489 100644
--- a/package.json
+++ b/package.json
@@ -38,6 +38,7 @@
     "superagent": "0.21.0",
     "through": "2.3.4",
     "trace-event": "1.3.0",
+    "triton-netconfig": "1.3.0",
     "uglify-js": "2.4.16",
     "underscore": "1.8.3",
     "underscore.string": "3.0.3",
