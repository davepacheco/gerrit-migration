From 4e24ae8711ed05c13f580e406282e566d9268432 Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Tue, 19 Feb 2019 18:56:54 +0000
Subject: [PATCH] =?UTF-8?q?TRITON-823=20adminui=20needs=20to=20be=20rack?=
 =?UTF-8?q?=20aware=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<pe?=
 =?UTF-8?q?dro@joyent.com>=20Reviewed=20by:=20Cody=20Peter=20Mello=20<mell?=
 =?UTF-8?q?oc@writev.io>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Candel?=
 =?UTF-8?q?=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 lib/api/imgapi-external-nic-status.js | 10 +++++-----
 lib/api/manta.js                      | 16 ++++++----------
 package.json                          |  1 +
 3 files changed, 12 insertions(+), 15 deletions(-)

diff --git a/lib/api/imgapi-external-nic-status.js b/lib/api/imgapi-external-nic-status.js
index 7466b578..2a009f8e 100644
--- a/lib/api/imgapi-external-nic-status.js
+++ b/lib/api/imgapi-external-nic-status.js
@@ -5,10 +5,11 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var restify = require('restify');
+var netconfig = require('triton-netconfig');
 
 module.exports = function imgapiExternalNicStatus(req, res, next) {
     req.sdc[req.dc].vmapi.listVms({
@@ -17,12 +18,11 @@ module.exports = function imgapiExternalNicStatus(req, res, next) {
         'tag.smartdc_type':'core'
     }, function listVmsCallback(err, vms) {
         if (err || !vms[0]) {
-            return next(new restify.InternalError('Unable to retrieve nic information'));
+            return next(new restify.InternalError(
+                'Unable to retrieve nic information'));
         }
 
-        var externalNic = vms[0].nics.filter(function (n) {
-            return n.nic_tag === 'external';
-        })[0];
+        var externalNic = vms[0].nics.filter(netconfig.isNicExternal);
 
         res.send({
             imgapiUuid: vms[0].uuid,
diff --git a/lib/api/manta.js b/lib/api/manta.js
index 889c8ea5..66f02ebc 100644
--- a/lib/api/manta.js
+++ b/lib/api/manta.js
@@ -5,12 +5,13 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2019, Joyent, Inc.
  */
 
 var kang = require('kang');
 var _ = require('underscore');
 var Promise = require('promise');
+var netconfig = require('triton-netconfig');
 
 var sapi;
 var vmapi;
@@ -97,17 +98,12 @@ var getServerForServerUuids = function (serverUuids) {
     return Promise.all(tasks);
 };
 
-var getMantaNicIpsFromServers = function (servers) {
+var getAdminIpsFromMantaServers = function (servers) {
     return new Promise(function (revolve, reject) {
         log.info('got servers with manta agents', servers.length);
+
         var ips = servers.map(function (sv) {
-            var ip;
-            _.each(sv.sysinfo['Network Interfaces'], function (nic, n) {
-                if (nic['NIC Names'].indexOf('admin') !== -1) {
-                    ip = nic.ip4addr;
-                }
-            });
-            return ip;
+            return netconfig.adminIpFromSysinfo(sv.sysinfo);
         });
 
         revolve(ips);
@@ -144,7 +140,7 @@ function getHosts() {
                 return getServerForServerUuids(serverUuids);
             })
              .then(function (servers) {
-                return getMantaNicIpsFromServers(servers);
+                return getAdminIpsFromMantaServers(servers);
             });
     }
 }
diff --git a/package.json b/package.json
index 85c9bc5c..208a9489 100644
--- a/package.json
+++ b/package.json
@@ -38,6 +38,7 @@
     "superagent": "0.21.0",
     "through": "2.3.4",
     "trace-event": "1.3.0",
+    "triton-netconfig": "1.3.0",
     "uglify-js": "2.4.16",
     "underscore": "1.8.3",
     "underscore.string": "3.0.3",
-- 
2.21.0

