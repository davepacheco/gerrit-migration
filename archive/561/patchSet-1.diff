From f3bed495a24757fcf256836dd3a8910277694b32 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 30 Sep 2016 13:14:12 -0700
Subject: [PATCH] CAPI-524 move ufds client docs from node-sdc-clients to
 node-ufds

---
 .gitmodules                      |   7 +-
 Makefile                         |  18 +-
 deps/restdown                    |   1 +
 docs/index.md                    | 377 +++++++++++++++++++++++++++++++
 tools/mk/Makefile.deps           |   2 +
 tools/mk/Makefile.node.defs      | 104 ---------
 tools/mk/Makefile.node.targ      |  42 ----
 tools/mk/Makefile.node_deps.defs |  43 ----
 tools/mk/Makefile.node_deps.targ |  24 --
 tools/mk/Makefile.targ           |  16 +-
 10 files changed, 396 insertions(+), 238 deletions(-)
 create mode 160000 deps/restdown
 create mode 100644 docs/index.md
 delete mode 100644 tools/mk/Makefile.node.defs
 delete mode 100644 tools/mk/Makefile.node.targ
 delete mode 100644 tools/mk/Makefile.node_deps.defs
 delete mode 100644 tools/mk/Makefile.node_deps.targ

diff --git a/.gitmodules b/.gitmodules
index d65f40b..9254389 100644
--- a/.gitmodules
+++ b/.gitmodules
@@ -1,6 +1,9 @@
 [submodule "deps/javascriptlint"]
 	path = deps/javascriptlint
-	url = git://github.com/davepacheco/javascriptlint.git
+	url = https://github.com/davepacheco/javascriptlint.git
 [submodule "deps/jsstyle"]
 	path = deps/jsstyle
-	url = git://github.com/davepacheco/jsstyle.git
+	url = https://github.com/davepacheco/jsstyle.git
+[submodule "deps/restdown"]
+	path = deps/restdown
+	url = https://github.com/trentm/restdown.git
diff --git a/Makefile b/Makefile
index a183284..2b35118 100644
--- a/Makefile
+++ b/Makefile
@@ -5,34 +5,20 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-#
-# Makefile: basic Makefile for template API service
-#
-# This Makefile is a template for new repos. It contains only repo-specific
-# logic and uses included makefiles to supply common targets (javascriptlint,
-# jsstyle, restdown, etc.), which are used by other repos as well. You may well
-# need to rewrite most of this file, but you shouldn't need to touch the
-# included makefiles.
-#
-# If you find yourself adding support for new targets that could be useful for
-# other projects too, you should add these to the original versions of the
-# included Makefiles (in eng.git) so that other teams can use them too.
+# Copyright 2016 Joyent, Inc.
 #
 
 #
 # Tools
 #
 # Get md2man-roff from <https://github.com/sunaku/md2man>
-MD2MAN                  := md2man-roff
 NODEUNIT		:= ./node_modules/.bin/nodeunit
 NPM			:= npm
 
 #
 # Files
 #
+DOC_FILES		 = index.md
 JS_FILES	:= $(shell find lib test -name '*.js')
 JSL_CONF_NODE	 = tools/jsl.node.conf
 JSL_FILES_NODE   = $(JS_FILES)
diff --git a/deps/restdown b/deps/restdown
new file mode 160000
index 0000000..1b833da
--- /dev/null
+++ b/deps/restdown
@@ -0,0 +1 @@
+Subproject commit 1b833da2199b08c3bc92ef16cf52b0b0d6e4c189
diff --git a/docs/index.md b/docs/index.md
new file mode 100644
index 0000000..c5d97bf
--- /dev/null
+++ b/docs/index.md
@@ -0,0 +1,377 @@
+---
+title: node-ufds
+markdown2extras: tables, code-friendly
+---
+
+# node-ufds
+
+node-ufds (`npm install ufds`) is a node.js client library for the Triton
+internal UFDS service.
+
+# UFDS API Client
+
+## UFDS(options)
+
+Creates a UFDS client instance.
+
+Options must be an object that contains
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| url | String | UFDS location |
+| bindDN | String | admin bindDN for UFDS. |
+| password | String | password to said adminDN |
+| cache | Object or *false* | age(Default 60s) size(default 1k) *false* to disable |
+
+
+## close(callback)
+
+Unbinds the underlying LDAP client.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| callback | Function | optional* callback of the form ``f(err)``. |
+
+
+## authenticate(username, password, cb)
+
+Checks a user's password in UFDS.
+
+Returns a RestError of '401' if password mismatches. Returns the same user
+object as getUser on success.
+
+### Arguments:
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| login | String | login one of login, uuid or the result of getUser. |
+| password | String | password correct password. |
+| cb | Function | callback of the form ``fn(err, user)``. |
+
+### Throws:
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input |
+
+
+## addUser(user, callback)
+
+Adds a new user into UFDS.
+
+This call expects the user object to look like the `sdcPerson` UFDS
+schema, minus objectclass/dn/uuid.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | the entry to add. |
+| callback | Function | callback of the form ``fn(err, user).`` |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input |
+
+
+## getUser(login, callback)
+
+Looks up a user by login to UFDS.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| login | String | login (or uuid) for a customer. |
+| options | Object | options (optional). |
+| callback | Function | callback of the form f(err, user). |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## updateUser(user, changes, callback)
+
+Updates a user record.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | String or Object | The user UUID or login string or a user object with a `user.dn`, `user.uuid` or `user.login` (i.e. a user object as from `getUser`).user the user record you got from getUser. |
+| changes | Object | Changes to the object you want merged in. For example: `{myfield: "blah"}` will add/replace the existing `myfield`. You can delete an existing field by passing in a null value, e.g.: `{addthisfield: "blah", rmthisfield: null}`. |
+| callback | Function | callback of the form `function (err, user)`. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## deleteUser(user, callback)
+
+Deletes a user record.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | user the user record you got from getUser. |
+| callback | Function | callback of the form ``fn(err, user)``. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input |
+
+
+## addKey(user, key, callback)
+
+Adds a new SSH key to a given user record.
+
+You can either pass in an SSH public key (string) or an object of the form
+
+    {
+      name: foo,
+      openssh: public key
+    }
+
+This method will return you the full key as processed by UFDS. If you don't
+pass in a name, then the name gets set to the fingerprint of the SSH key.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | the user record you got from getUser. |
+| key | String | the OpenSSH public key. |
+| callback | Function | callback of the form `fn(err, key)`. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## getKey(user, fingerprint, callback)
+
+Retrieves an SSH key by fingerprint.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | user the object you got back from getUser. |
+| fingerprint | String | fingerprint the SSH fp (or name) of the SSH key you want. |
+| callback | Function | callback of the form `fn(err, key)`. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## listKeys(user, callback)
+
+Loads all keys for a given user.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | user the user you got from getUser. |
+| callback | Function | callback of the form fn(err, keys). |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## deleteKey(user, key, callback)
+
+Deletes an SSH key under a user.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | User | the object you got back from getUser. |
+| key | Object | key the object you got from getKey. |
+| callback | Function | callback of the form fn(err, key). |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## listLimits(user, callback)
+
+Lists "CAPI" limits for a given user.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | the object returned from ``getUser`` |
+| callback | Function | callback of the form ``fn(err, limits)`` |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## getLimit(user, datacenter, callback)
+
+Gets a "CAPI" limit for a given user.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | user the object returned from getUser. |
+| datacenter | String | datacenter the datacenter name. |
+| callback | Function | callback of the form fn(err, limits). |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## addLimit(user, limit, callback)
+
+Creates a "CAPI"" limit for a given user.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | the object returned from getUser. |
+| limit | Object | the limit to add. |
+| callback | Function | callback of the form ``fn(err, limits)`` |
+
+
+## updateLimit(user, limit, callback)
+
+Updates a "CAPI"" limit for a given user.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | the object returned from getUser. |
+| limit | Object | the limit to add. |
+| callback | Function | callback of the form ``fn(err, limits)`` |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## deleteLimit(user, limit, callback)
+
+Deletes a "CAPI"" limit for a given user.
+
+Note that this deletes _all_ limits for a datacenter, so if you just want
+to purge one, you probably want to use updateLimit.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| user | Object | the object returned from getUser. |
+| limit | Object | the limit to delete. |
+| callback | Function callback of the form ``fn(err)``. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## add(dn, entry, callback)
+
+Low-level API to wrap up UFDS add operations.
+
+See ldapjs docs.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| dn | String | dn of the record to add. |
+| entry | Object | entry record attributes. |
+| callback | Function | callback of the form ``fn(error, entries).`` |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## del(dn, callback)
+
+Low-level API to wrap up UFDS delete operations.
+
+See ldapjs docs.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| dn | String | dn dn to delete. |
+| callback | Function | callback of the form ``fn(error)``. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## modify(dn, changes, callback)
+
+Low-level API to wrap up UFDS modify operations.
+
+See ldapjs docs.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| dn | String | dn to update |
+| changes | Object | changes to make. |
+| callback | Function | callback of the form fn(error). |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## search(base, options, callback)
+
+Low-level API to wrap up UFDS search operations.
+See ldapjs docs.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| base | String | search base. |
+| options | Object | search options. |
+| callback | Function | callback of the form ``fn(error, entries)``. |
+
+### Returns
+
+| Type | Description |
+| ---- | ----------- |
+| Boolean | true if callback was invoked from cache, false if not. |
+
+### Throw
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
+
+
+## setLogLevel(level)
+
+Convenience mechanism to set the LDAP log level.
+
+| Name | Type | Description |
+| ---- | ---- | ----------- |
+| level | String | see Log4js levels. |
+
+### Throws
+
+| Error | Description |
+| ----- | ----------- |
+| TypeError | on bad input. |
diff --git a/tools/mk/Makefile.deps b/tools/mk/Makefile.deps
index 2d92ec3..1cffbe7 100644
--- a/tools/mk/Makefile.deps
+++ b/tools/mk/Makefile.deps
@@ -50,3 +50,5 @@ $(JSSTYLE_EXEC): | deps/jsstyle/.git
 RESTDOWN_EXEC	?= deps/restdown/bin/restdown
 RESTDOWN	?= python $(RESTDOWN_EXEC)
 $(RESTDOWN_EXEC): | deps/restdown/.git
+
+EXTRA_DOC_DEPS	?=
diff --git a/tools/mk/Makefile.node.defs b/tools/mk/Makefile.node.defs
deleted file mode 100644
index 9376841..0000000
--- a/tools/mk/Makefile.node.defs
+++ /dev/null
@@ -1,104 +0,0 @@
-# -*- mode: makefile -*-
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-#
-# Makefile.node.defs: Makefile for building and bundling your own Node.js.
-#
-# NOTE: This makefile comes from the "eng" repo. It's designed to be dropped
-# into other repos as-is without requiring any modifications. If you find
-# yourself changing this file, you should instead update the original copy in
-# eng.git and then update your repo to use the new version.
-#
-
-#
-# This Makefile facilitates building and bundling your own copy of Node.js in
-# your repo.  All it does is define variables for node, node-waf, and npm for
-# you to use elsewhere in your Makefile and rules to build these tools when
-# needed.
-#
-# To use this facility, include "Makefile.node.defs", use the variables as
-# described below to define targets, and then include "Makefile.node.targ".
-#
-# There are two use cases addressed here:
-#
-# (1) Invoking node, node-waf, or npm as part of the build process, as in "npm
-#     install" and "node-waf configure build".  To facilitate this, this
-#     Makefile defines Make variables NODE, NODE_WAF, and NPM that you can use
-#     to invoke these commands during the build process.  You MUST NOT assume
-#     that these variables just evaluate to the filenames themselves, as they
-#     may have environment variable definitions and other things that prevent
-#     you from using them directly as a filename.  If you want that, see (2).
-#
-#     Wherever you use one of these variables, you MUST include a dependency on
-#     the corresponding *_EXEC variable as well, like so:
-#
-#	node_modules/restify: deps/restify $(NPM_EXEC)
-#		$(NPM) install deps/restify
-#
-#     or better, use an order-only dependency to avoid spurious rebuilds:
-#
-#	node_modules/restify: deps/restify | $(NPM_EXEC)
-#		$(NPM) install deps/restify
-#
-#     Otherwise, the underlying file will not get built.  We don't
-#     automatically build them as part of "all" because that approach is
-#     brittle.
-#
-# (2) Specifying paths for invoking node, node-waf, or npm at RUNTIME, as in
-#     specifying the path to node used for the start method of your service's
-#     SMF manifest.  For this, this Makefile defines variables NODE_EXEC,
-#     NODE_WAF_EXEC, and NPM_EXEC, which represent the relative paths of these
-#     files from the root of the workspace.  You MUST NOT use these variables
-#     to invoke these commands during the build process.  See (1) instead.
-#
-#     However, in order to work at runtime, you must build the tool as well.
-#     That is, if you use NODE_EXEC to specify the path to node, you must
-#     depend on NODE_EXEC somewhere. This usually happens anyway because you
-#     usually need them during the build process too, but if you don't then
-#     you need to explicitly add NODE_EXEC (or whichever) to your "all"
-#     target.
-#
-# When including this Makefile, you MAY also specify:
-#
-#	BUILD			top-level directory for built binaries
-#				(default: "build")
-#
-#	NODE_INSTALL		where node should install its built items
-#				(default: "$BUILD/node")
-#
-#	NODE_CONFIG_FLAGS	extra flags to pass to Node's "configure"
-#				(default: "--with-dtrace" on SmartOS; empty
-#				otherwise.)
-#
-
-TOP ?= $(error You must include Makefile.defs before this makefile)
-
-BUILD		?= build
-NODE_INSTALL 	?= $(BUILD)/node
-DISTCLEAN_FILES	+= $(NODE_INSTALL)
-
-NODE_CONFIG_FLAGS += --prefix=$(TOP)/$(NODE_INSTALL)
-
-ifeq ($(shell uname -s),SunOS)
-	NODE_CONFIG_FLAGS += 	--with-dtrace \
-				--openssl-libpath=/opt/local/lib \
-				--openssl-includes=/opt/local/include
-endif
-
-NODE_EXEC	= $(NODE_INSTALL)/bin/node
-NODE_WAF_EXEC	= $(NODE_INSTALL)/bin/node-waf
-NPM_EXEC	= $(NODE_INSTALL)/bin/npm
-
-# Ensure these use absolute paths to the executables to allow running
-# from a dir other than the project top.
-NODE		:= $(TOP)/$(NODE_EXEC)
-NODE_WAF	:= $(TOP)/$(NODE_WAF_EXEC)
-NPM		:= PATH=$(TOP)/$(NODE_INSTALL)/bin:$(PATH) node $(TOP)/$(NPM_EXEC)
diff --git a/tools/mk/Makefile.node.targ b/tools/mk/Makefile.node.targ
deleted file mode 100644
index abdc616..0000000
--- a/tools/mk/Makefile.node.targ
+++ /dev/null
@@ -1,42 +0,0 @@
-# -*- mode: makefile -*-
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-#
-# Makefile.node.targ: See Makefile.node.defs.
-#
-# NOTE: This makefile comes from the "eng" repo. It's designed to be dropped
-# into other repos as-is without requiring any modifications. If you find
-# yourself changing this file, you should instead update the original copy in
-# eng.git and then update your repo to use the new version.
-#
-
-ifneq ($(shell uname -s),SunOS)
-NODE_PREBUILT_VERSION ?= $(error You must define NODE_PREBUILT_VERSION to use Makefile.node.targ on non-SunOS)
-endif
-
-ifeq ($(shell uname -s),SunOS)
-$(NODE_EXEC) $(NPM_EXEC) $(NODE_WAF_EXEC): | deps/node/.git
-	(cd deps/node; ./configure $(NODE_CONFIG_FLAGS) && $(MAKE) && $(MAKE) install)
-else
-$(NODE_EXEC) $(NPM_EXEC) $(NODE_WAF_EXEC):
-	(mkdir -p $(BUILD) \
-		&& cd $(BUILD) \
-		&& [[ -d src-node ]] && (cd src-node && git checkout master && git pull) || git clone git://github.com/joyent/node.git src-node \
-		&& cd src-node \
-		&& git checkout $(NODE_PREBUILT_VERSION) \
-		&& ./configure $(NODE_CONFIG_FLAGS) \
-		&& $(MAKE) && $(MAKE) install)
-endif
-
-DISTCLEAN_FILES += $(NODE_INSTALL) $(BUILD)/src-node
-
-distclean::
-	-([[ ! -d deps/node ]] || (cd deps/node && $(MAKE) distclean))
diff --git a/tools/mk/Makefile.node_deps.defs b/tools/mk/Makefile.node_deps.defs
deleted file mode 100644
index 29a83f7..0000000
--- a/tools/mk/Makefile.node_deps.defs
+++ /dev/null
@@ -1,43 +0,0 @@
-# -*- mode: makefile -*-
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-#
-# Makefile.node_deps.defs: Makefile for including npm modules whose sources
-# reside inside the repo.  This should NOT be used for modules in the npm
-# public repo or modules that could be specified with git SHAs.
-#
-# NOTE: This makefile comes from the "eng" repo. It's designed to be dropped
-# into other repos as-is without requiring any modifications. If you find
-# yourself changing this file, you should instead update the original copy in
-# eng.git and then update your repo to use the new version.
-#
-
-#
-# This Makefile takes as input the following make variable:
-#
-#    REPO_MODULES	List of relative paths to node modules (i.e., npm
-#    			packages) inside this repo.  For example:
-#    			src/node-canative, where there's a binary npm package
-#    			in src/node-canative.
-#
-# Based on the above, this Makefile defines the following new variables:
-#
-#    REPO_DEPS		List of relative paths to the installed modules.  For
-#    			example: "node_modules/canative".
-#
-# The accompanying Makefile.node_deps.targ defines a target that will install
-# each of REPO_MODULES into REPO_DEPS and remove REPO_DEPS with "make clean".
-# The top-level Makefile is responsible for depending on REPO_DEPS where
-# appropriate (usually the "deps" or "all" target).
-#
-
-REPO_DEPS    = $(REPO_MODULES:src/node-%=node_modules/%)
-CLEAN_FILES += $(REPO_DEPS)
diff --git a/tools/mk/Makefile.node_deps.targ b/tools/mk/Makefile.node_deps.targ
deleted file mode 100644
index bb2ab4f..0000000
--- a/tools/mk/Makefile.node_deps.targ
+++ /dev/null
@@ -1,24 +0,0 @@
-# -*- mode: makefile -*-
-#
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-#
-
-#
-# Copyright (c) 2014, Joyent, Inc.
-#
-
-#
-# Makefile.node_deps.targ: targets for Makefile.node_deps.defs.
-#
-# NOTE: This makefile comes from the "eng" repo. It's designed to be dropped
-# into other repos as-is without requiring any modifications. If you find
-# yourself changing this file, you should instead update the original copy in
-# eng.git and then update your repo to use the new version.
-#
-
-NPM_EXEC  ?= $(error NPM_EXEC must be defined for Makefile.node_deps.targ)
-
-node_modules/%: src/node-% | $(NPM_EXEC)
-	$(NPM) install $<
diff --git a/tools/mk/Makefile.targ b/tools/mk/Makefile.targ
index ea19000..ee7688a 100644
--- a/tools/mk/Makefile.targ
+++ b/tools/mk/Makefile.targ
@@ -89,9 +89,9 @@
 #
 #	JSSTYLE_FLAGS	Additional flags to pass through to jsstyle
 #
-#	RESTDOWN_EXT	By default '.restdown' is required for DOC_FILES
-#			(see above). If you want to use, say, '.md' instead, then
-#			set 'RESTDOWN_EXT=.md' in your Makefile.
+#	RESTDOWN_EXT	By default '.md' is required for DOC_FILES (see above).
+#			If you want to use, say, '.restdown' instead, then set
+#			'RESTDOWN_EXT=.restdown' in your Makefile.
 #
 
 #
@@ -108,7 +108,7 @@ JSSTYLE		?= jsstyle
 MKDIR		?= mkdir -p
 MV		?= mv
 RESTDOWN_FLAGS	?=
-RESTDOWN_EXT	?= .restdown
+RESTDOWN_EXT	?= .md
 RMTREE		?= rm -rf
 JSL_FLAGS  	?= --nologo --nosummary
 
@@ -209,7 +209,7 @@ check-jsstyle:  $(JSSTYLE_EXEC)
 	$(JSSTYLE) $(JSSTYLE_FLAGS) $(JSSTYLE_FILES)
 
 .PHONY: check
-check: check-jsl check-json $(JSSTYLE_TARGET) check-bash
+check:: check-jsl check-json $(JSSTYLE_TARGET) check-bash
 	@echo check ok
 
 .PHONY: clean
@@ -264,7 +264,7 @@ DOC_MEDIA_FILES_BUILD := $(DOC_MEDIA_FILES:%=$(DOC_BUILD)/media/%)
 # to get there.
 #
 .PHONY: docs
-docs:							\
+docs::							\
 	$(DOC_FILES:%$(RESTDOWN_EXT)=$(DOC_BUILD)/%.html)		\
 	$(DOC_FILES:%$(RESTDOWN_EXT)=$(DOC_BUILD)/%.json)		\
 	$(DOC_MEDIA_FILES_BUILD)
@@ -294,9 +294,11 @@ CLEAN_FILES +=					\
 $(DOC_MEDIA_FILES_BUILD): | $(DOC_MEDIA_DIRS_BUILD)
 
 $(DOC_BUILD)/%: docs/% | $(DOC_BUILD)
+	$(MKDIR) $(shell dirname $@)
 	$(CP) $< $@
 
-docs/%.json docs/%.html: docs/%$(RESTDOWN_EXT) | $(DOC_BUILD) $(RESTDOWN_EXEC)
+docs/%.json docs/%.html: docs/%$(RESTDOWN_EXT) | $(DOC_BUILD) $(RESTDOWN_EXEC) \
+    $(EXTRA_DOC_DEPS)
 	$(RESTDOWN) $(RESTDOWN_FLAGS) -m $(DOC_BUILD) $<
 
 $(DOC_BUILD):
-- 
2.21.0

