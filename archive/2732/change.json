{"project":"joyent/manta-muskie","branch":"master","id":"If0bada24a3811e8e435f87664b5be9717c6f2d67","number":"2732","subject":"MANTA-3452 Muskie should wait for minimal set of services before servicing requests","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/2732","commitMessage":"MANTA-3452 Muskie should wait for minimal set of services before servicing requests\n","createdOn":1507241847,"lastUpdated":1513703278,"open":false,"status":"MERGED","comments":[{"timestamp":1507241847,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1507241849,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit d67f16ca21a3ee509e1f21715f58ab64627c3ebd\n    \n    MANTA-3452 Muskie should wait for minimal set of services before servicing requests\n    Change Muskie to wait for Moray and Picker initialization before starting the\n    restify servers. This change also includes some more general refactoring that\n    includes replacing the use of some global variables, making the configuration\n    data object immutable, and adding a separate object to store client connections."},{"timestamp":1507241882,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507322206,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\n(1 comment)\n\n+1 from me after that small nitpick"},{"timestamp":1507323120,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1507323122,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 3081fcb9b18dd45f7b70cb889f648ea2f62e9852\n    \n    Use lowercase for a log message in clientsConnected function"},{"timestamp":1507323152,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507323244,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1509058753,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1509058755,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit e279d9943b3fcd7f498421d5c914e869936c9f61\n    \n    MANTA-3452 Muskie should wait for minimal set of services before servicing requests"},{"timestamp":1509058785,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509380764,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 4."},{"timestamp":1509380765,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit e3192c1be1bb5676603fe3f31ebc3bbb5ac8d827\n    \n    Adjust client connection log message"},{"timestamp":1509380790,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509388014,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 5."},{"timestamp":1509388015,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 12bbee7584e3f37f1fa8e2d80b69ae0b88835fe4\n    \n    Remove extra whitespace in multi-line string"},{"timestamp":1509388041,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509388381,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1509396123,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 6."},{"timestamp":1509396125,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit b3d50cde9da88ece9199964fd0dab118fcee53fe\n    \n    Javascript multiline strings and nice formatting are mutually exclusive"},{"timestamp":1509396151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509397349,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1509401570,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 7."},{"timestamp":1509401572,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 33bbf48418d00514f4a6079daa822b2705f8419a\n    \n    Another log message edit that makes the jsstyle continuation check happy"},{"timestamp":1509401598,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509644727,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1510180297,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7:\n\n(8 comments)\n\nThanks for taking this on! I\u0027ve left some comments, mostly about the code that sets up the minimal set of services. (Side note: Could we also document in the ticket which services those are, and why? I noted that a comment about this could be good, too.)"},{"timestamp":1510186950,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7:\n\n(6 comments)\n\n\u003e (8 comments)\n \u003e \n \u003e Thanks for taking this on! I\u0027ve left some comments, mostly about\n \u003e the code that sets up the minimal set of services. (Side note:\n \u003e Could we also document in the ticket which services those are, and\n \u003e why? I noted that a comment about this could be good, too.)\n\nYes, some of it is alluded to in this comment: https://jira.joyent.us/browse/MANTA-3452?focusedCommentId\u003d165508\u0026page\u003dcom.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-165508, but that information got spread around between a previous version of this CR prior to breaking it out into a separate issue. I\u0027ll summarize it all in a single comment. Thanks!"},{"timestamp":1510331767,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 8."},{"timestamp":1510331768,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 59ed64f447733a78fb7fe5286a965f280f36bec6\n    \n    Refactor the client connection helpers\n    Refactor the client connection helpers so that they either return the client\n    connection object or invoke a callback when the connection is established rather\n    than directly modifying the clients object.\n    \n    commit 773c5e9c4cbe66cd3a272ced3f1bcd5711d81a9d\n    \n    Update the configuration helper functions\n    Update the configuration helper functions to improve the organization and fix\n    some bugs.\n    \n    commit 2a224d1c816cca12b8881db2c505c504d8731f7c\n    \n    Another log message edit that makes the jsstyle continuation check happy\n    \n    commit 6d89eb0237608200ff34daeb4d87dcdc6f69f9ca\n    \n    Javascript multiline strings and nice formatting are mutually exclusive\n    \n    commit 2e38504cd4c73ace1ee9fbb5de59d1b6643aa3a4\n    \n    Remove extra whitespace in multi-line string\n    \n    commit 0b88aaf4f08031dc79e0f7af104672c3c5426e87\n    \n    Adjust client connection log message\n    \n    commit de2584bff6946ea776dd732a3971add1d00ee8be\n    \n    MANTA-3452 Muskie should wait for minimal set of services before servicing requests"},{"timestamp":1510331794,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510332140,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7:\n\nPatch set 8 addresses most of the review feedback. I ended up refactoring the configuration helpers a bit more to try and group all the logging configuration together and generally make it a bit more organized. I also ran into a longstanding bug where if the optional syslog config for bunyan is not specified and the log level is less than INFO then the syslog logging never gets set up. May not mean much in practice for us, but from a correctness and completeness standpoint it was a bug. \n\nI also reworked the client connection helpers so they either return the client connection directly or invoke a passed in function when the connect callback happens. \n\nLet me know if any of these changes don\u0027t make sense."},{"timestamp":1510333723,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7:\n\n\u003e Patch set 8 addresses most of the review feedback. I ended up\n \u003e refactoring the configuration helpers a bit more to try and group\n \u003e all the logging configuration together and generally make it a bit\n \u003e more organized. I also ran into a longstanding bug where if the\n \u003e optional syslog config for bunyan is not specified and the log\n \u003e level is less than INFO then the syslog logging never gets set up.\n \u003e May not mean much in practice for us, but from a correctness and\n \u003e completeness standpoint it was a bug.\n \u003e \n \u003e I also reworked the client connection helpers so they either return\n \u003e the client connection directly or invoke a passed in function when\n \u003e the connect callback happens.\n \u003e \n \u003e Let me know if any of these changes don\u0027t make sense.\n\nI wrongly described the logging bug I fixed in the last comment. The problem is that if the log level is set to lower than INFO in the configuration file and a syslog config is specified then the syslog logging is never set up.\n\nAlso I didn\u0027t mention, but I ran these latest changes through the muskie test suite and all looks good."},{"timestamp":1511829829,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 8:\n\n(9 comments)\n\nThanks for the revisions. I think it\u0027s a lot easier to follow how the clients are set up now. I have a few more comments / questions on the latest patchset."},{"timestamp":1512169720,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 7:\n\n(5 comments)"},{"timestamp":1512169774,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 9."},{"timestamp":1512169776,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 682d0271548c12516aeb0a14461699fff994d1e2\n    \n    More updates based on review feedback\n    \n    commit be54e7b5b032fe71799284274c363dbeebc16cb7\n    \n    Refactor the client connection helpers\n    Refactor the client connection helpers so that they either return the client\n    connection object or invoke a callback when the connection is established rather\n    than directly modifying the clients object.\n    \n    commit c0473ab98729cc5b12b40cecff849c6507563173\n    \n    Update the configuration helper functions\n    Update the configuration helper functions to improve the organization and fix\n    some bugs.\n    \n    commit 6c262c4d3042b0cccc434ab290859bac3c5e797c\n    \n    Another log message edit that makes the jsstyle continuation check happy\n    \n    commit d6d37e2dd1641eecb082ff82650759c153a0c523\n    \n    Javascript multiline strings and nice formatting are mutually exclusive\n    \n    commit aee031516df21b63f0485c520e73fbf1bb1f6cb5\n    \n    Remove extra whitespace in multi-line string\n    \n    commit 801345ef3ea9f2a2256c9779af93efdfa73a0337\n    \n    Adjust client connection log message\n    \n    commit ba6628a369675077e2735a11cfb336c20490a832\n    \n    MANTA-3452 Muskie should wait for minimal set of services before servicing requests"},{"timestamp":1512169802,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513016159,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 9:\n\n(6 comments)\n\nThis is looking good. Most of my comments this round are minor."},{"timestamp":1513035796,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 10."},{"timestamp":1513035798,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 10:\n\nNew commits:\n    \n    commit 1dd6fc718d72f65a991d54e21a7fd3e427d58a15\n    \n    More review feedback changes\n    \n    commit 891c6b2edc70b79e4a0a39f1a32919610f3414e0\n    \n    More updates based on review feedback\n    \n    commit 51e674bfbfb0a908c656c0b2baf2ed32cb399830\n    \n    Refactor the client connection helpers\n    Refactor the client connection helpers so that they either return the client\n    connection object or invoke a callback when the connection is established rather\n    than directly modifying the clients object.\n    \n    commit 8d45add889007a4ba92082d8cda38055d26ad2b2\n    \n    Update the configuration helper functions\n    Update the configuration helper functions to improve the organization and fix\n    some bugs.\n    \n    commit f40ff49a68c090659dfffc8fa06b6fcddac49708\n    \n    Another log message edit that makes the jsstyle continuation check happy\n    \n    commit 80a595357899caefe4513b35bf3e8119cf2cb0a7\n    \n    Javascript multiline strings and nice formatting are mutually exclusive\n    \n    commit d9f9f4bdf76f61c7ba025aedc20609f4ed8bb688\n    \n    Remove extra whitespace in multi-line string\n    \n    commit e1f91ba34c383ceed796a324fb149e66f4cb2acd\n    \n    Adjust client connection log message\n    \n    commit 5c7ca81aeccb4a2365379a30f8b982807893f2b8\n    \n    MANTA-3452 Muskie should wait for minimal set of services before servicing requests"},{"timestamp":1513035841,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513035951,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 8:\n\n(6 comments)"},{"timestamp":1513212070,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1513212260,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1513292404,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1513630198,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 10: Integration-Approval+1"},{"timestamp":1513703278,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"10","revision":"f0bada24a3811e8e435f87664b5be9717c6f2d67","parents":["a5f88038c3c740acfe1a205d0925fd909cefdd94"],"ref":"refs/changes/32/2732/10","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1513035796,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513035841,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513212260,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513292404,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513630198,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"SUBM","value":"1","grantedOn":1513703278,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":12,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"main.js","type":"MODIFIED","insertions":307,"deletions":-218}],"sizeInsertions":335,"sizeDeletions":-249},"patchSets":[{"number":"1","revision":"cca8f504acf477547ebbb3e71b9469b43f2e5702","parents":["2e4845c519e1915da9965868d467bd4d1242a2cb"],"ref":"refs/changes/32/2732/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1507241847,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507241882,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"main.js","line":520,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Style nit carried over from previous CR. Manta logs are lowercase."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":198,"deletions":-172}],"sizeInsertions":225,"sizeDeletions":-198},{"number":"2","revision":"663c24c7fe3f575cf11ec805d9dea923590cc798","parents":["2e4845c519e1915da9965868d467bd4d1242a2cb"],"ref":"refs/changes/32/2732/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1507323120,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507323152,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507323244,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":198,"deletions":-172}],"sizeInsertions":225,"sizeDeletions":-198},{"number":"3","revision":"18f47de3946102ad18104b2432f20576bd53cae5","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/32/2732/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1509058753,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509058785,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":198,"deletions":-172}],"sizeInsertions":225,"sizeDeletions":-198},{"number":"4","revision":"1d7ce8d75f649c26f35536408063d5a25ed0107a","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/32/2732/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1509380764,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509380790,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":199,"deletions":-172}],"sizeInsertions":226,"sizeDeletions":-198},{"number":"5","revision":"8a39835770e78a8cf685f94d26b40b465731f80d","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/32/2732/5","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1509388014,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509388041,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509388381,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":199,"deletions":-172}],"sizeInsertions":226,"sizeDeletions":-198},{"number":"6","revision":"9e14fd21a0cc01bfaf4778f6b326264f48556a88","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/32/2732/6","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1509396123,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509396151,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"main.js","line":521,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"You are going to hate this, but the indention rules don\u0027t have this aligned with the above quote (as I would like it).  It should just be the standard 4-space indent."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":199,"deletions":-172}],"sizeInsertions":226,"sizeDeletions":-198},{"number":"7","revision":"64c488279484904aadd42312c5c0f1949819064d","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/32/2732/7","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1509401570,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509401598,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509644727,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"comments":[{"file":"main.js","line":40,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for cleaning these up!"},{"file":"main.js","line":42,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: Let\u0027s make this a bit more descriptive? Something like \"getMuskieOptions\"?"},{"file":"main.js","line":81,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"While we\u0027re at it, should we pass in the values used from environment variables in an \"options\" block to configure()?"},{"file":"main.js","line":81,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"yes, i like it"},{"file":"main.js","line":88,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"OOC, why were these lines moved up?"},{"file":"main.js","line":88,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"There\u0027s some logging that was happening prior to this code executing previously and it seemed like if you\u0027re opting for debug or trace level logging then the source info could be useful for those messages as well."},{"file":"main.js","line":189,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"These arguments are a little hairy, especially given that the only thing that might be on the \"opts\" object is the \"verbose\" flag. What do you think about putting all of the arguments into a single \"args\" object?"},{"file":"main.js","line":189,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"That seems reasonable."},{"file":"main.js","line":189,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m not sure I see this changed in the current PS (8)."},{"file":"main.js","line":189,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"As part of the PS8 changes I made the arguments for this function more specific to what it actually needs and reduced the count down to just three and after that refactor it didn\u0027t seem like the args wrapper was needed."},{"file":"main.js","line":257,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It seems like it might make more sense to move the assertions at the beginning of this function into configureLogging() and set the logs there. I\u0027m not sure what having a separate function adds."},{"file":"main.js","line":257,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"The setLogger function predates my changes, but my guess is that it\u0027s because the previous configure function may bail out early or defer the log setup to the end. I was a bit hesitant to change too much, but I will go back and take another pass at it based on your feedback."},{"file":"main.js","line":567,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think the \"const\" implies that we don\u0027t want you to mutate it. If it\u0027s worth expanding as to why, I think we should do that (or just not have the comment.)"},{"file":"main.js","line":567,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Cool, I\u0027ll remove the comment. Evidently I should also add \u0027use strict\u0027 to this module in order for const to behave like I intend and throw an exception if something tries to modify the cfg rather than just have it silently fail."},{"file":"main.js","line":567,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Ah, yes. I\u0027ve been burned by that one before, I think!"},{"file":"main.js","line":567,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Turns out \u0027use strict\u0027 doesn\u0027t play nicely with const in our old version of node so will have to forgo adding that until we\u0027ve updated to node v4 or later."},{"file":"main.js","line":569,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Looking at this, it\u0027s hard for me as a reader to quickly grok that this code is responsible for ensuring the minimal set of services muskie needs is started up, and why that\u0027s important. I think there are a couple things contributing to this:\n- the \"client*Client\" functions mutate the \"clients\" argument instead of returning a client object (or passing on in a callback). It\u0027s not obvious that the argument is modified in this way imo.\n- the use of a barrier for some \"create*Clients\" and not others\n- passing the \"clients\" object argument to some \"create*Client\" functions and not others\n\nIf I understand correctly, the \"clients\" object is passed to helper functions that actually create some sort of client (as opposed to say, a monitoring server), and the barrier is used for the minimal set of services we care about starting before starting the muskie server.\n\nIf that understanding is correct, then I think there are a few things that we could do to make the intent clearer:\n- Pass in the created client object in a callback instead of mutating an argument object and assign it in the callback function to the \"clients\" object.\n- Group the calls to \"create*Client\" functions for the minimal set of services needed from the ones that aren\u0027t needed. This would make clear why they all take a barrier as an argument.\n- I also think it would be good to expand the comment a bit to explain not just that we wait for some set of services to start up, but which ones are necessary to wait for, to give some context.\n\nLet me know if you have any thoughts on this!"},{"file":"main.js","line":569,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Good feedback. This was me again trying not to change too much all at once, but I\u0027ll gladly take another pass at this and try to make things clearer."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-9},{"file":"main.js","type":"MODIFIED","insertions":199,"deletions":-172}],"sizeInsertions":226,"sizeDeletions":-198},{"number":"8","revision":"6aeb35ee82be4226c5b0eb1c9c071e34d0054029","parents":["5aabef170d667adb088ee83a5e022fdfe9534405"],"ref":"refs/changes/32/2732/8","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1510331767,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510331794,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server.js","line":94,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Let\u0027s add the \"clients\" param to this comment?"},{"file":"lib/server.js","line":94,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done in PS10"},{"file":"main.js","line":99,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: We usually try to use periods (and capitalization, though that\u0027s not relevant here) for complete sentences in this repo. The same goes for some other comments in this diff."},{"file":"main.js","line":447,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Why invoke the callback here instead of at the end of this function?"},{"file":"main.js","line":447,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"This is where the marlin client was formerly assigned to the global variable MARLIN so I was just replacing that statement where it lived."},{"file":"main.js","line":447,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I see. I think it might make more sense to invoke the callback after all the work for this function is finished? Otherwise I think it might be possible to use the client prior to having set up the barrier below."},{"file":"main.js","line":447,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done in PS10"},{"file":"main.js","line":610,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I know this repo isn\u0027t always consistent, but generally we prefer C-style block comments for muskie. (i.e. using, /* ... */)."},{"file":"main.js","line":612,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/requests/services?"},{"file":"main.js","line":612,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I think that last clause is superfluous. I think \"...starting up the restify servers.\" conveys the necessary information."},{"file":"main.js","line":619,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Do we also need the shark agent for PUTs?"},{"file":"main.js","line":619,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Good catch, will reword"},{"file":"main.js","line":631,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Maybe: \"Establish other client connections needed for jobs requests.\"? (If that is the most accurate way to say that.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":10,"deletions":-14},{"file":"main.js","type":"MODIFIED","insertions":295,"deletions":-215}],"sizeInsertions":322,"sizeDeletions":-246},{"number":"9","revision":"c5608a72f91d9618cfcae886fddca5e74868998e","parents":["b8572701cb060b262a94ef01e95f9a56bec726fa"],"ref":"refs/changes/32/2732/9","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1512169774,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1512169802,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/auth.js","line":1004,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I know these lines were here prior to your change, but it seems like we assign the mahi object and the keyapi object twice: once here and once in \"setupHandler\" in lib/common.js. Do you know why that is? (And can one of the assignments be safely removed?)"},{"file":"lib/auth.js","line":1004,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"That\u0027s a great question. It is indeed a case of redundant assignments. To be sure I tested out removing the assignments from setupHandler and made sure all the muskie tests still passed. I\u0027ll clean that up in the next patchset."},{"file":"lib/auth.js","line":1004,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Sounds good. Thanks for looking at that!"},{"file":"lib/server.js","line":92,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/options/clients (here and the following lines of the comment)"},{"file":"lib/server.js","line":92,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Not sure I follow why this would need to change with the options parameter still present."},{"file":"lib/server.js","line":92,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Sorry, misread this. Looks good."},{"file":"lib/server.js","line":98,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Assert the `name` argument as well? (And sync up the function comment?)"},{"file":"main.js","line":104,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Why was this removed?"},{"file":"main.js","line":104,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I felt like it was redundant since the usage function conveys the same information."},{"file":"main.js","line":131,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I wonder if if we should assert that `cfg.storage` is an optional object in the asserts above."},{"file":"main.js","line":131,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Done is PS10"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":14,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":11,"deletions":-14},{"file":"main.js","type":"MODIFIED","insertions":305,"deletions":-218}],"sizeInsertions":333,"sizeDeletions":-249},{"number":"10","revision":"f0bada24a3811e8e435f87664b5be9717c6f2d67","parents":["a5f88038c3c740acfe1a205d0925fd909cefdd94"],"ref":"refs/changes/32/2732/10","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1513035796,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513035841,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513212260,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513292404,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513630198,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"SUBM","value":"1","grantedOn":1513703278,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/auth.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"lib/common.js","type":"MODIFIED","insertions":12,"deletions":-14},{"file":"lib/server.js","type":"MODIFIED","insertions":13,"deletions":-14},{"file":"main.js","type":"MODIFIED","insertions":307,"deletions":-218}],"sizeInsertions":335,"sizeDeletions":-249}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}]}