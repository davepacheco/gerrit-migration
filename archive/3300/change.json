{"project":"joyent/sdc-sapi","branch":"master","id":"Ia4c3caee6d3819b81c8ba0e74be2dbee07a5ad2b","number":"3300","subject":"TRITON-108 SAPI dies when files missing in /sapi/sapi_manifests Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Approved by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"url":"https://cr.joyent.us/3300","commitMessage":"TRITON-108 SAPI dies when files missing in /sapi/sapi_manifests\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nApproved by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1517908407,"lastUpdated":1517960810,"open":false,"status":"MERGED","comments":[{"timestamp":1517908407,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Uploaded patch set 1."},{"timestamp":1517908435,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1517942458,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1517942555,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nWhat was the case you hit where /sapi/sapi_manifests didn\u0027t have all the data?"},{"timestamp":1517945644,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\nSure, I can change the code in getObject() to return an error for that case; I found the fact that it didn\u0027t counter-intuitive.\n\nI suspect the original reason for it returning (null, null) is that the author didn\u0027t want vasync.forEachParallel to terminate early, because a missing file in that particular code is not an error.\n\nI triggered this when I hard shut down a coal that was in the middle of starting up."},{"timestamp":1517946282,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1517959904,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1517960807,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 2: Commit message was updated."},{"timestamp":1517960810,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Marsell Kukuljevic"}],"currentPatchSet":{"number":"2","revision":"78c13394c917fd73ed8e3f0ad15462305b49c8b8","parents":["9a3428d6d98cc9c2a06af00feb518c85fd45c4c7"],"ref":"refs/changes/00/3300/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1517960807,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517908435,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517959904,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517959904,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1517960810,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server/stor/moray_local.js","type":"MODIFIED","insertions":7,"deletions":-3}],"sizeInsertions":7,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"a4c3caee6d3819b81c8ba0e74be2dbee07a5ad2b","parents":["9a3428d6d98cc9c2a06af00feb518c85fd45c4c7"],"ref":"refs/changes/00/3300/1","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1517908407,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517908435,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517959904,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517959904,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/server/stor/moray_local.js","line":201,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Marsell,\nIn this case we\u0027d have a manifest UUID on the app, service or instance, but the manifest file is missing in the local \"database\".  Shouldn\u0027t this be reported as an error? I.e. Perhaps `loadAppObjects` should return an error here, rather than silently dropping one or more of the manifests."},{"file":"lib/server/stor/moray_local.js","line":201,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"While I can change getObject() to return an error, I\u0027m not sure loadAppObjects() should. loadAppObjects() is used by code that syncs up local from moray, so potential missing objects is not an error -- it\u0027s expected."},{"file":"lib/server/stor/moray_local.js","line":201,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh, I see. Okay, thanks.\n\nIs this a dupe of SAPI-292? It looks like it. If so, can you resolve that one as a dupe of this one?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server/stor/moray_local.js","type":"MODIFIED","insertions":7,"deletions":-3}],"sizeInsertions":7,"sizeDeletions":-3},{"number":"2","revision":"78c13394c917fd73ed8e3f0ad15462305b49c8b8","parents":["9a3428d6d98cc9c2a06af00feb518c85fd45c4c7"],"ref":"refs/changes/00/3300/2","uploader":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"createdOn":1517960807,"author":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1517908435,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1517959904,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1517959904,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1517960810,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server/stor/moray_local.js","type":"MODIFIED","insertions":7,"deletions":-3}],"sizeInsertions":7,"sizeDeletions":-3}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}]}