{"project":"joyent/illumos-joyent","branch":"master","id":"I63e028448bae2a1090e60d798e9cee9cdfbf7156","number":"5481","subject":"OS-7556 IPv6 packets dropped after crossing MAC-loopback Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/5481","commitMessage":"OS-7556 IPv6 packets dropped after crossing MAC-loopback\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1549318110,"lastUpdated":1549422961,"open":false,"status":"MERGED","comments":[{"timestamp":1549318110,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1549319344,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1: Code-Review+1\n\nI\u0027m sorry I missed this during the original code review.  I should\u0027ve seen the ip_input.c changes and asked about the corresponding ip6_input.c ones."},{"timestamp":1549320492,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\nWe all share a piece of the blame for missing such a simple and easily testable case. I\u0027m sure we\u0027ll do better in the future. Thanks for the review."},{"timestamp":1549383123,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549385927,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549386089,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549386660,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549386942,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549401045,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549402583,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1549405656,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1549405965,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nThank you Ryan for the followup, and thank you Robert for pointing out the corner case.  I\u0027m happy to review or run any tests you come up with in the future."},{"timestamp":1549406022,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1549407807,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\nTesting notes added to ticket."},{"timestamp":1549414174,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1549422861,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1549422938,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1549422961,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"4","revision":"63e028448bae2a1090e60d798e9cee9cdfbf7156","parents":["5b248548c9ca0108aa36e7e3db7fbc46077bcf4b"],"ref":"refs/changes/81/5481/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1549422938,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549405965,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549406022,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1549414174,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1549422961,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","type":"MODIFIED","insertions":11,"deletions":-4},{"file":"usr/src/uts/common/inet/ip/ip_input.c","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"006ec922b643c3f2b881ed5e878bfe2e096f4256","parents":["9899b6b1d6d0c6ec99ef3c33a692aee217d3976b"],"ref":"refs/changes/81/5481/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1549318110,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549319344,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Can you remind me what happens when the ill_t doesn\u0027t support checksumming and we get a loopback packet? I saw that this check was above the place where we look at ILL_HCKSUM_CAPABLE(). I don\u0027t recall offhand if we\u0027ll fix up the checksum if the device we\u0027re going to doesn\u0027t support checksums or not. The case I\u0027m thinking about is that we have one device that does support checksumming, loops back, and arrives on one that doesn\u0027t."},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Hmmm, see a few lines earlier (line 1901) where ILL_HCKSUM_CAPABLE(ill) is checked. Looks like we kick to slow-path (i.e. do-the-checksum) there. Similar check happens on line 2253 of ip_input.c for the IPv4 equivalent."},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Yes, I know that\u0027s what happens, that\u0027s why I asked. If we\u0027ve set up for hardware checksumming and loop back we won\u0027t pass a software checksum because the checksum field won\u0027t be filled in correctly."},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"I see what you are saying. But let\u0027s be specific about the data paths in play here. I think the only time your scenario applies is in a bridge forwarding scenario, correct? So we have a packet traveling from a HW-capable device, hitting a bridge, and landing on a non-HW-capable device; without ever leaving the host machine. I believe I accounted for this in the bridge code but I\u0027m going to run a test and double check that. But were there other scenarios you had in mind?"},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I suspect a bridge might be the only way to do so today, but I could imagine a case where one device on an etherstub or overlay could have checksumming and the other doesn\u0027t. I guess when devices are in the same netstack, they\u0027ll never get here, so maybe the bridge is the only case and what I\u0027m imagining doesn\u0027t currently work."},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Yes, a bridge is the only way I know to do this. But this quickly turns into a rabbit hole because of bridge\u0027s own idiosyncrasies (as I\u0027ve discovered over the last 4 hours) and the fact that I don\u0027t own hardware that doesn\u0027t support HW checksums (in today\u0027s world, who would?). In any event, I found that I could tell igb to disable its Tx HW checksum which gets the ill_t into the appropriate state. With that in place I then setup a bridge between an i40e with HW Tx csum enabled, and an igb with HW Tx csum disabled. I used mdb to verify the ill_t\u0027s capabilities were as expected in regards to checksumming. I then tried to setup VNICs on both side of the bridge but remembered that you MUST use VLANs on a bridge. I then tried to setup VLAN VNICs on both sides of the bridge only to remember that  there\u0027s some bug that prevents the bridge from forwarding the packets of these VNICs (this existed before I ever touched any of the networking code and I\u0027ve been meaning to track it down and write up a ticket). Finally, I used create-vlan to create the VLAN VNICs on each side of the bridge. And these VNICs were able to send both TCP/IPv4 and TCP/IPv6 traffic just fine; but I was expecting it to fail given Robert\u0027s observation.\n\nSo I dug into things a bit more and noticed the following.\n\n1. For IPv4, the create-vlan VNICs don\u0027t get DLS bypass and so we perform HW emul before delivering to IP.\n\n2. For IPv6, the path between i40e -\u003e igb ends up going over IP loopback and thus doesn\u0027t verify checksums at all (i.e. IRAF_VERIFY_ULP_CKSUM is not set). In the other direction it doesn\u0027t use IP loopback (don\u0027t ask me why because I have no clue) but since i40e supports HW offload we avoid running SW checksum verification.\n\nAll that said, however, we should change the code to check for HW_LOCAL_MAC before ILL_HCKSUM_CAPABLE. Otherwise, we do risk dropping packets in the future if any of these details change. Furthermore, it just makes more sense this way. If it\u0027s a HW_LOCAL_MAC packet then the entire point is to NOT bother with checksum verification AT ALL."},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","line":1913,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Also, as a reminder to myself: I\u0027m convinced that I need to spend some real time on expanding simnet to emulate HW features and start writing up programmatic networking tests. There are too many scenarios to cover manually and it\u0027s too easy to miss one. Not to mention it\u0027s a massive time sink. This bug, along with the IPv4 forwarding bug, could have easily been caught with automated testing."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","type":"MODIFIED","insertions":5,"deletions":-3}],"sizeInsertions":5,"sizeDeletions":-3},{"number":"2","revision":"5b62469907c7e77d3eca18f187a1f804cd350e25","parents":["9899b6b1d6d0c6ec99ef3c33a692aee217d3976b"],"ref":"refs/changes/81/5481/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1549405656,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549406022,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1549414174,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549405965,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","type":"MODIFIED","insertions":11,"deletions":-4},{"file":"usr/src/uts/common/inet/ip/ip_input.c","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-11},{"number":"3","revision":"2468699ebf56c8d8f35f6f382060f88874a1ffe8","parents":["5b248548c9ca0108aa36e7e3db7fbc46077bcf4b"],"ref":"refs/changes/81/5481/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1549422861,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549406022,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1549414174,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549405965,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","type":"MODIFIED","insertions":11,"deletions":-4},{"file":"usr/src/uts/common/inet/ip/ip_input.c","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-11},{"number":"4","revision":"63e028448bae2a1090e60d798e9cee9cdfbf7156","parents":["5b248548c9ca0108aa36e7e3db7fbc46077bcf4b"],"ref":"refs/changes/81/5481/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1549422938,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549406022,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1549414174,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1549422961,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1549405965,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/uts/common/inet/ip/ip6_input.c","type":"MODIFIED","insertions":11,"deletions":-4},{"file":"usr/src/uts/common/inet/ip/ip_input.c","type":"MODIFIED","insertions":14,"deletions":-7}],"sizeInsertions":25,"sizeDeletions":-11}],"allReviewers":[{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}