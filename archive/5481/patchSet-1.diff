From 006ec922b643c3f2b881ed5e878bfe2e096f4256 Mon Sep 17 00:00:00 2001
From: Ryan Zezeski <rpz@joyent.com>
Date: Mon, 4 Feb 2019 14:33:52 -0700
Subject: [PATCH] OS-7556 IPv6 packets dropped after crossing MAC-loopback

---
 usr/src/uts/common/inet/ip/ip6_input.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/usr/src/uts/common/inet/ip/ip6_input.c b/usr/src/uts/common/inet/ip/ip6_input.c
index 79a53eff7c..107a6976c7 100644
--- a/usr/src/uts/common/inet/ip/ip6_input.c
+++ b/usr/src/uts/common/inet/ip/ip6_input.c
@@ -23,7 +23,7 @@
  * Copyright (c) 2009, 2010, Oracle and/or its affiliates. All rights reserved
  *
  * Copyright 2011 Nexenta Systems, Inc. All rights reserved.
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 /* Copyright (c) 1990 Mentat Inc. */
 
@@ -1910,9 +1910,11 @@ ip_input_cksum_v6(iaflags_t iraflags, mblk_t *mp, ip6_t *ip6h,
 
 	hck_flags = DB_CKSUMFLAGS(mp);
 
-	if (hck_flags & HCK_FULLCKSUM_OK) {
+	if (hck_flags & HCK_FULLCKSUM_OK || (hck_flags & HW_LOCAL_MAC)) {
 		/*
-		 * Hardware has already verified the checksum.
+		 * Either the hardware already verified the checksum
+		 * or the packet is from a same-machine sender in
+		 * which case we assume data integrity.
 		 */
 		return (B_TRUE);
 	}
-- 
2.21.0

