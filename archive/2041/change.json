{"project":"joyent/illumos-joyent","branch":"master","id":"If7ba5f06c4b2ec24c3ac7cc02f134b3101cc3add","number":"2041","subject":"OS-5561 rtld needs to learn about AVX512 OS-5560 Need AVX512 core kernel support","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2041","commitMessage":"OS-5561 rtld needs to learn about AVX512\nOS-5560 Need AVX512 core kernel support\n","createdOn":1496700204,"lastUpdated":1497011731,"open":false,"status":"MERGED","comments":[{"timestamp":1496700204,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1496709031,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)\n\nI have two major comments on this:\n\n* I think we need to break apart all of the different AVX flags that Intel has into the feature sets, etc. For the purpose of rtld we only care about avx512f, but for elfcap and the aux vector we need to mention them all.\n\n* I wonder if we can use the trick that Intel was describing around xgetbv in userland to figure out if a program is using the xmm or ymm or zmm registers. Therefore we don\u0027t have to save and restore every zmm register on the transition potentially and can get away with just saving and restoring those bits. I\u0027m not 100% sure that\u0027s the right instruction, but this is kind of similar to what was talked about around xsaveopt in Volume 1."},{"timestamp":1496788303,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(2 comments)\n\nI updated the code to break out each feature (which you are correct and is the right thing to do). I will explore the xgetbv option as a separate issue."},{"timestamp":1496788315,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1496852809,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(3 comments)\n\nIn general, I think this looks good. I just have a few minor nits."},{"timestamp":1496857267,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1496857315,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1496870605,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1496941402,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1496950574,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1496950633,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1497011661,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6."},{"timestamp":1497011731,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"6","revision":"f7ba5f06c4b2ec24c3ac7cc02f134b3101cc3add","parents":["4c3b19248f96fcd5ab5457943477588a42a87673"],"ref":"refs/changes/41/2041/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1497011661,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496870605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1496941402,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1497011731,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":204,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":46,"deletions":-13},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":18,"deletions":-16}],"sizeInsertions":343,"sizeDeletions":-128},"patchSets":[{"number":"1","revision":"c5c480b332983fefef34c412ab14b67d7bac563e","parents":["c74b5e77f4d2fbda8db1fe76990657b997609379"],"ref":"refs/changes/41/2041/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1496700204,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","line":112,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I\u0027m not sure what this is referring to."},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","line":112,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Since we\u0027re offset off of rsp, which is 64-bit aligned, the zmm register storage is ok. If we were using a negative offset off of rbp, we would need an adjustment."},{"file":"usr/src/uts/common/sys/auxv_386.h","line":97,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we call this AVX512F to go along with everything else?"},{"file":"usr/src/uts/common/sys/auxv_386.h","line":97,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":199,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":5,"deletions":-7}],"sizeInsertions":220,"sizeDeletions":-103},{"number":"2","revision":"1a121395ef6ea030c714f725c8721b8a417e90bc","parents":["c74b5e77f4d2fbda8db1fe76990657b997609379"],"ref":"refs/changes/41/2041/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1496788315,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","line":112,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think this is still confusing as I don\u0027t know where the 48 bytes of padding would come from. Is this trying to be a reference to the fact that the 144 bytes from above don\u0027t add up to a 64-byte aligned number (e.g. 144 % 64 \u003d\u003d 16)?"},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","line":112,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I updated the comment with your suggestion, plus a little additional change from me."},{"file":"usr/src/common/elfcap/elfcap.c","line":381,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should this match Intel and have a \u0027_\u0027 after the AVX512 per section 2.2 of the Intel ISA extensions doc?"},{"file":"usr/src/common/elfcap/elfcap.c","line":381,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"yes, that is correct, fixed"},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":189,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"There\u0027s a similar comment here on the use of the underscore as elsewhere."},{"file":"usr/src/uts/i86pc/os/cpuid.c","line":189,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":199,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":46,"deletions":-13},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":18,"deletions":-16}],"sizeInsertions":338,"sizeDeletions":-128},{"number":"3","revision":"021d9f9c6a1a1f936f23e2d9d60899d54b1b2ee1","parents":["c74b5e77f4d2fbda8db1fe76990657b997609379"],"ref":"refs/changes/41/2041/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1496857315,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496870605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1496941402,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":204,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":46,"deletions":-13},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":18,"deletions":-16}],"sizeInsertions":343,"sizeDeletions":-128},{"number":"4","revision":"0dfc95eaf528f05dcf60f827ad9c582cb44cd401","parents":["8cb9f5acecaded019a9a55454a31dcf4328d0d1b"],"ref":"refs/changes/41/2041/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1496950574,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496870605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1496941402,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":204,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":46,"deletions":-13},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":18,"deletions":-16}],"sizeInsertions":343,"sizeDeletions":-128},{"number":"5","revision":"50930dde714118b0b0d828f264efabd130967184","parents":["8cb9f5acecaded019a9a55454a31dcf4328d0d1b"],"ref":"refs/changes/41/2041/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1496950633,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496870605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1496941402,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":204,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":46,"deletions":-13},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":18,"deletions":-16}],"sizeInsertions":343,"sizeDeletions":-128},{"number":"6","revision":"f7ba5f06c4b2ec24c3ac7cc02f134b3101cc3add","parents":["4c3b19248f96fcd5ab5457943477588a42a87673"],"ref":"refs/changes/41/2041/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1497011661,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1496870605,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1496941402,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1497011731,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/sgs/include/rtld.h","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"usr/src/cmd/sgs/rtld/amd64/boot_elf.s","type":"MODIFIED","insertions":204,"deletions":-90},{"file":"usr/src/common/elfcap/elfcap.c","type":"MODIFIED","insertions":50,"deletions":-2},{"file":"usr/src/common/elfcap/elfcap.h","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"usr/src/uts/common/sys/auxv_386.h","type":"MODIFIED","insertions":20,"deletions":-3},{"file":"usr/src/uts/i86pc/os/cpuid.c","type":"MODIFIED","insertions":46,"deletions":-13},{"file":"usr/src/uts/intel/sys/x86_archext.h","type":"MODIFIED","insertions":18,"deletions":-16}],"sizeInsertions":343,"sizeDeletions":-128}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}