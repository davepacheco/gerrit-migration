{"project":"joyent/sdc-headnode","branch":"master","topic":"lullaby-phase4","id":"I1e0a1e095f9ba8c2376502f169fe2fcac4ca3686","number":"6093","subject":"TOOLS-2228 convert headnode build to engbld framework TOOLS-2071 headnode build should work with a local manta-style BITS_DIR Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Trent Mick \u003ctrent.mick@joyent.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/6093","commitMessage":"TOOLS-2228 convert headnode build to engbld framework\nTOOLS-2071 headnode build should work with a local manta-style BITS_DIR\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Trent Mick \u003ctrent.mick@joyent.com\u003e\n","createdOn":1554989272,"lastUpdated":1557952942,"open":false,"status":"MERGED","comments":[{"timestamp":1554989272,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1554989490,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Topic set to lullaby-phase4"},{"timestamp":1554989785,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1554990200,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1554990295,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1554990550,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4."},{"timestamp":1554990649,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556301351,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1556301583,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1556301943,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nMy build failed on Mac: https://gist.github.com/trentm/139b50eec922c7893b85151516953ecb\n\n```\n...\ntouch /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/share/usbkey\nmake: uuid: Command not found\nmkdir -p /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/etc\nrm -f /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/etc/gz-tools.image\necho  \u003e /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/etc/gz-tools.image\nchmod 644 /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/etc/gz-tools.image\nrm -rf /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/node_modules\ncp -RP tools/node_modules /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc/node_modules\nrm -f /Users/trentm/joy/sdc-headnode2/tools.tar.gz\ncd /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc \u0026\u0026 tar -I gzip -cf /Users/trentm/joy/sdc-headnode2/tools.tar.gz \\\n\t    bin cmd share lib man node_modules etc\ntar: Couldn\u0027t open gzip: No such file or directory\nmake: *** [tools.tar.gz] Error 1\n```"},{"timestamp":1556552887,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n\u003e (1 comment)\n\nThis was originally written back when all of the lullaby code was trying to be MG-compatible - so \"bits-dir\" indicated the layout that MG writes, and \"mbits-dir\" indicated the (clearly superior) layout that we maintain in Manta.\n\nGiven than almost none of the MG compatibility stuff we wrote was ever used (that is, component builds switched straight to lullaby and never looked back) I suspect I could probably just remove the old \u0027bits-dir\u0027 layout and rename \u0027mbits-dir\u0027 to it in place.\n\nSeem reasonable?"},{"timestamp":1556553093,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1556553292,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1556553337,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n\u003e My build failed on Mac: https://gist.github.com/trentm/139b50eec922c7893b85151516953ecb\n\n \u003e cd /Users/trentm/joy/sdc-headnode2/proto/opt/smartdc \u0026\u0026 tar -I gzip\n \u003e -cf /Users/trentm/joy/sdc-headnode2/tools.tar.gz \\\n \u003e bin cmd share lib man node_modules etc\n \u003e tar: Couldn\u0027t open gzip: No such file or directory\n \u003e make: *** [tools.tar.gz] Error 1\n \u003e ```\n\nUgh, thanks - I\u0027ll fix that. Darn non-standard tar options :-("},{"timestamp":1556625058,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(18 comments)"},{"timestamp":1556631928,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n(14 comments)"},{"timestamp":1556633845,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1556799205,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 5."},{"timestamp":1556799260,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1556799303,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5:\n\n\u003e Uploaded patch set 5.\n\nThe changes here do the following:\n - generate a build.spec.branches file from \u0027configure-branches\u0027\n - remove the proposed \u0027mbits-dir\u0027 directory layout, instead\n   changing \u0027bits-dir\u0027 to look for the Manta-style layout rather\n   than MG layout\n - be a bit more careful cleaning up lofi devices before starting the build"},{"timestamp":1556799485,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 6."},{"timestamp":1556799509,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5:\n\n\u003e Uploaded patch set 6.\n\nand fix bashstyle on ./bin/reflash, sorry."},{"timestamp":1556799581,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556803701,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 6:\n\n(15 comments)"},{"timestamp":1556803723,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 7."},{"timestamp":1556803823,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1556803858,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 7:\n\n\u003e Uploaded patch set 7.\n\nThis just fixed an assumption that jenkins builds would always have a build.spec.local file (no longer the case after the build.spec.branches reorg)"},{"timestamp":1556805775,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6:\n\n(11 comments)"},{"timestamp":1556890247,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 8."},{"timestamp":1556890290,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing-1\n\n(1 comment)\n\n\"make check\" exited with status 2"},{"timestamp":1556890329,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 8:\n\n\u003e Uploaded patch set 8.\n\nThis change has the build producing \u0027build.spec.merged\u0027 at the beginning of the build, with all build.spec consumers using that single file, rather than merging build.spec.* as they go.\n\nWe also tidied up convert-configure-branches to remove async methods."},{"timestamp":1556890421,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 9."},{"timestamp":1556890520,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557239929,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 10."},{"timestamp":1557240022,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557320929,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 10:\n\n(4 comments)\n\nNice cleanup!"},{"timestamp":1557326638,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 10:\n\n(4 comments)\n\nNo problem. I\u0027ll fix these, do a sweep for RFD 164 copyrights across all changes, and include those in the next patch set."},{"timestamp":1557334149,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 11."},{"timestamp":1557334239,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557394807,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1557395999,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1557396882,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1557416554,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 11:\n\n(1 comment)"},{"timestamp":1557416579,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 12."},{"timestamp":1557416675,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557418280,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1557826995,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 13: Commit message was updated."},{"timestamp":1557947498,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 14: Patch Set 13 was rebased."},{"timestamp":1557947594,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14:\n\n\"make check\" passed ok"},{"timestamp":1557949343,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 14: Integration-Approval+1\n\nLooks sane/reasonable to me. COAL build worked for me."},{"timestamp":1557952111,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 15: Commit message was updated."},{"timestamp":1557952942,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"15","revision":"1e0a1e095f9ba8c2376502f169fe2fcac4ca3686","parents":["fcc8f59a5d89830ffa4e4a496cb43725a5f45cca"],"ref":"refs/changes/93/6093/15","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557952111,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557416675,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557418280,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557949343,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1557952942,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":220,"deletions":-27},{"file":"README.md","type":"MODIFIED","insertions":39,"deletions":-12},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":41,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":14,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":4,"deletions":-20},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":750,"sizeDeletions":-762},"patchSets":[{"number":"1","revision":"070dff2577963e00539694a2df1dffa67fbf7a64","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554989272,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":224,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":138,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":39,"deletions":-6},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":88,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":574,"sizeDeletions":-582},{"number":"2","revision":"82a70783764dbc0d0ce226a0e2cea2221f7c3f55","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554989785,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":224,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":138,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":39,"deletions":-6},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":88,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":574,"sizeDeletions":-582},{"number":"3","revision":"56da4e45ef80147df624a5f3cfd571d191f47b5e","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554990200,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554990295,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":213,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":138,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":39,"deletions":-6},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":88,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":563,"sizeDeletions":-582},{"number":"4","revision":"a822edc4b273f06e0bc5d7636d0eb877b1ade810","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1554990550,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1554990649,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":257,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I know you\u0027ve done the work now, so fine. However, if it would simplify things, I would be fine (even slightly prefer) that the user can specify *either* configure-branches *or* build.spec.local, but not both.  \n\nE.g. A build I started with a configure-branches with basically nothing in it, and a build.spec.local. A \"WARNING: ...\" is emitted, but I\u0027d miss that: https://gist.github.com/trentm/139b50eec922c7893b85151516953ecb\n\nWhich one wins here?\n\n\nThen we could drop the complexity of comparing if they are \"equivalent\" to some degree.\n\nSo then the build steps would be:\n- fail if both are specified\n- merge build.spec and either build.spec.local or configure-branches (if they exist) into a \"$BUILDDIR/build.spec.effective\"\n- have all parts of the build depend on and use $BUILDDIR/build.spec.effective"},{"file":"Makefile","line":257,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"It\u0027s true that build.spec does provide quite a few bells and whistles, and that it\u0027s quite likely most users will only ever use one or the other mechanism.\n\nThe problem occurs due to build.spec.local being generated to the same place as user-written versions of the same file - I agree that if we have $BUILDDIR/build.spec.effective, things would be easier.\n\nI\u0027ll have a go at doing that and see how it feels."},{"file":"Makefile","line":257,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I agree with Trent. In addition, I\u0027d be pretty mad if the makefile over-wrote my build.spec.local, even if it was my fault for trying to use both files.\n\nI wonder if the .effective or whatever it\u0027s called could really be the merge of build.spec and {build.spec.local|configure-branches}"},{"file":"Makefile","line":257,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep, that seems reasonable.\n\nThe merge code of build.spec and build.spec.local in novus is currently very primitive - it simply loads the files in serial and the last key in wins, with no warnings about overwriting previously set keys. Assuming we\u0027re ok with that, then adding another config file ought to be straightforward, but otherwise, I\u0027d prefer to punt that work to a different changeset."},{"file":"Makefile","line":257,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I\u0027m fine with it personally. It\u0027d be great to record - including in the bits dir - what the actual configuration used was, and building a single temporary build.spec.whatever seems like a good way of doing that. Especially if we could use a simple makefile rule to rebuild when timestamps change etc."},{"file":"Makefile","line":260,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"skipped reviewing all this due to the above."},{"file":"Makefile","line":275,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"small preference: can we make this script take an argument for the input file too? Just if people might want to use by hand for whatever reason."},{"file":"Makefile","line":275,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Sure, I\u0027ll do that."},{"file":"Makefile","line":294,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"did this comment escape from smartos-live\u0027s Makefile?"},{"file":"Makefile","line":294,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"No, just a thinko - will fix."},{"file":"Makefile","line":317,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This is a bit worrying, what\u0027s this about? At least on my build system I\u0027ve been known to build sdc-headnode at the same time as a smartos-live build; it looks like this will break it."},{"file":"Makefile","line":317,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"This is a straight port from existing MG code,  https://github.com/joyent/mountain-gorilla/blob/master/Makefile#L2620 Jenkins is currently setup to only do a single build at a time, so it\u0027s safe there.\n\nI\u0027ll see if we can improve this, to better name sdc-headnode build temporary mountpoints so that we can grep for those, but have a bad feeling that this isn\u0027t straightforward."},{"file":"Makefile","line":317,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"If this isn\u0027t new, please don\u0027t feel the need to look at this."},{"file":"Makefile","line":479,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Thanks for fixing this."},{"file":"README.md","line":198,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t know if I\u0027m being daft, but I don\u0027t grok why we have support for two different dir layouts here. I don\u0027t think most will be able to meaningfully know that diff btwn \"manta dir structure\" and \"MG dir structure\".  Perhaps that is fine, but I don\u0027t have a feel for it.\n\nI\u0027m curious why the change from BITS_DIR to \"SOURCE_BITS_DIR\"."},{"file":"README.md","line":198,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"(previous comments about mbits-dir vs bits-dir, tl;dr I agree - let\u0027s remove them)\n\nAs for the name change, I was trying to disambiguate between the different uses of \"BITS_DIR\" across our components.\n\nFor almost everything, BITS_DIR has been \"the place build artifacts are written to\".\n\nFor the headnode build, BITS_DIR was \"the place we read interim build artifacts, to assemble into a headnode image\" and the actual headnode artifacts themselves end up going somewhere completely different.  SOURCE_BITS_DIR seemed like a better description for what we want here."},{"file":"README.md","line":329,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"skipped review for now as this is changing"},{"file":"README.md","line":341,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"platimages also has to match"},{"file":"README.md","line":341,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Thanks, I\u0027ll add that here, and corresponding logic in bin/convert-configure-branches.js"},{"file":"bin/convert-configure-branches.js","line":29,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"why even bother with a main function?"},{"file":"bin/convert-configure-branches.js","line":29,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Force of habit really."},{"file":"bin/convert-configure-branches.js","line":49,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"spaces around equals?"},{"file":"bin/convert-configure-branches.js","line":49,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"thanks, will fix."},{"file":"bin/convert-configure-branches.js","line":56,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I think this will break for:\n\n# I really hate calling # an octothorpe\n\nWhy not just .startsWith() ?"},{"file":"bin/convert-configure-branches.js","line":56,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":".startsWith() isn\u0027t present in ancient node, and that\u0027s what the rest of the headnode build uses right now\n\nhttps://jenkins.joyent.us/job/headnode/3350/consoleFull\n\n[root@kura ~]# /usr/node/bin/node -v\nv0.10.26\n[root@kura ~]# echo \u0027s \u003d \"this is text\" ; s.startWith(\"this\");\u0027 | /usr/node/bin/node\n\n[stdin]:1\ns \u003d \"this is text\" ; s.startWith(\"this\");\n                       ^\nTypeError: Object this is text has no method \u0027startWith\u0027\n    at [stdin]:1:24\n    at Object.\u003canonymous\u003e ([stdin]-wrapper:6:22)\n    at Module._compile (module.js:456:26)\n    at evalScript (node.js:532:25)\n    at Socket.\u003canonymous\u003e (node.js:154:11)\n    at Socket.EventEmitter.emit (events.js:117:20)\n    at _stream_readable.js:920:16\n    at process._tickCallback (node.js:415:13)\n[root@kura ~]#"},{"file":"bin/convert-configure-branches.js","line":56,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"It\u0027s \u0027starts\u0027 not \u0027start\u0027 but yeah, ugh. I think you can just look at line[0] then."},{"file":"bin/convert-configure-branches.js","line":109,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"missing platimages"},{"file":"bin/convert-configure-branches.js","line":109,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Thanks, will fix that."},{"file":"bin/convert-configure-branches.js","line":114,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"console.info ??? Although, shouldn\u0027t we error out completely if they disagree?"},{"file":"bin/convert-configure-branches.js","line":114,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yeah, reporting an error would be better alright. I\u0027ll do that."},{"file":"buildtools/lib/common.sh","line":38,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Bit confused by this, why do we need :21-23 then?"},{"file":"buildtools/lib/common.sh","line":38,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Good question. I think this was to set a default for non-SunOS platforms, but I\u0027m not sure why I ended up choosing the same value. Earlier, Trent was complaining the headnode build failed on Mac where its tar doesn\u0027t have \"-I \u003ccompress cmd\u003e\", so I need to account for that here too."},{"file":"buildtools/novus/cmd/downloader.js","line":257,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"skipped review as this is changing"},{"file":"buildtools/novus/cmd/unique-branches.js","line":31,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"\".js\" ?"},{"file":"buildtools/novus/cmd/unique-branches.js","line":31,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep."},{"file":"buildtools/novus/cmd/unique-branches.js","line":37,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"If we have a single build.spec.build or whatever, this could be simplified to just use that?"},{"file":"buildtools/novus/cmd/unique-branches.js","line":37,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"It could, yes - will keep that in mind when looking at that stuff."},{"file":"buildtools/novus/cmd/unique-branches.js","line":52,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I know you can\u0027t use Set() unfortunately, but why have \u0027null\u0027 as the sentinel value? It was a little confusing to me, whereas \u0027true\u0027 would have been more obvious IMO."},{"file":"buildtools/novus/cmd/unique-branches.js","line":52,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yeah, I see the concern. I\u0027ll switch to \u0027true\u0027 and add a comment explaining that we\u0027re only looking for Set-like behaviour rather than expecting \u0027true\u0027 to actually mean anything. (because \u0027branches[bits_branch] \u003d false\u0027 would confusingly mean the same thing to us)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":213,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":46,"deletions":-3},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":138,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":9,"deletions":-2},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":39,"deletions":-6},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":88,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":562,"sizeDeletions":-581},{"number":"5","revision":"8b443df78da40aee1d69ad26b4eea3e7d60d07fb","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556799205,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1556799260,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/reflash","line":507,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line exceeds 80 columns"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":4,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":186,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":36,"deletions":-8},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"bin/build-dataset","type":"MODIFIED","insertions":12,"deletions":-8},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":14,"deletions":-9},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":268,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":37,"deletions":-42},{"file":"bin/reflash","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":754,"sizeDeletions":-674},{"number":"6","revision":"a87ab5e31f6dc09ef6d3a035f11f892529e5aee0","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/6","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556799485,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556799581,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/build-coal-image","line":83,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This is actually really handy, thanks. It means I can still use the convenient branch notation and set build-tgz\u003dfalse!"},{"file":"bin/build-tar-image","line":112,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Please move this common stuff over to buildtools/lib/common.sh or somesuch, as you\u0027re changing all the callsites.\n\n(But see my other comment.)"},{"file":"bin/build-usb-image","line":195,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"spurious tab?"},{"file":"bin/convert-configure-branches.js","line":32,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"mix of 4-spaces and tabs in this file, can we pick one?"},{"file":"bin/convert-configure-branches.js","line":32,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Sorry, I nabbed this from elsewhere in sdc-headnode and didn\u0027t clean up. Will fix this."},{"file":"bin/convert-configure-branches.js","line":136,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"should this be return ({...}) ? (Genuinely don\u0027t know the correct style here.)"},{"file":"bin/convert-configure-branches.js","line":136,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I\u0027m not sure either, but will change it to be consistent."},{"file":"bin/convert-configure-branches.js","line":154,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"style nit again, maybe?"},{"file":"bin/convert-configure-branches.js","line":154,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I have no idea - there\u0027s a pretty wild range of styles in sdc-headnode already (bin/json-merge wrecked my head, for example) Trent, any strong opinions here?\n\nI\u0027ve generally just been keeping to whatever the eslint defaults are (via https://github.com/Microsoft/vscode-eslint)"},{"file":"bin/convert-configure-branches.js","line":204,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I don\u0027t mind if you really want to keep it, but again, you can just remove the main() function altogether, script-style."},{"file":"bin/convert-configure-branches.js","line":204,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Will do."},{"file":"bin/convert-configure-branches.js","line":218,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Is there any reason we can\u0027t use the Sync() versions instead of callbacks here?"},{"file":"bin/convert-configure-branches.js","line":218,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I think I was worried those weren\u0027t present on ancient node, but I\u0027m wrong. I\u0027ll change these over."},{"file":"bin/convert-configure-branches.js","line":219,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"style nit, maybe?"},{"file":"bin/convert-configure-branches.js","line":219,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I\u0027m not sure. I was extra-indenting the function signature so that it wouldn\u0027t be lost in the body. I suspect once I switch to readFileSync, that problem will go away."},{"file":"bin/convert-configure-branches.js","line":228,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"s/\u003d 0 ;/ \u003d 0;/"},{"file":"bin/convert-configure-branches.js","line":228,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"yep thanks (annoying eslint didn\u0027t catch that!)"},{"file":"bin/convert-configure-branches.js","line":229,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"curious as to why the trim() isn\u0027t part of process_line() ?"},{"file":"bin/convert-configure-branches.js","line":229,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yeah, it really should - I\u0027d refactored this file as part of this patchset, but missed that."},{"file":"bin/convert-configure-branches.js","line":255,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"indenting?"},{"file":"bin/convert-configure-branches.js","line":255,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"och, yes thanks. Switching to sync calls should fix this regardless."},{"file":"bin/reflash","line":493,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Note, you can include buildtools here too: reflash always runs from the source tree."},{"file":"buildtools/lib/common.sh","line":38,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"sorry, I should have said before: the defaults are on :14-:15, so this should go there too. No need for if then"},{"file":"buildtools/lib/common.sh","line":38,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"d\u0027oh, yes that\u0027s better."},{"file":"buildtools/novus/lib/buildspec.js","line":246,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"So I realise this isn\u0027t something directly due to your changes, but I\u0027ve only really just noticed how weird it is that we have these two different ways of merging the build specs. And things have got even more complicated now with the branches file.\n\nI\u0027d expected to see something like this in Makefile:\n\nbuild.spec.branches: configure-branches\n    ./bin/convert-configure-branches -f $\u003c -o $@\n\nbuild.spec.out: build.spec build.spec.local build.spec.branches\n    ./bin/json-merge -o $@ $^\n\n(fixed up for optional files but you get the idea).\n\nThen, everything else just always uses build.spec.out, and that is the file of record for input to the build-* scripts as well as buildspec.js. We can remove all merging from everywhere else.\n\nIs there something I\u0027m missing here?"},{"file":"buildtools/novus/lib/buildspec.js","line":246,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"That\u0027s a fair point, and I\u0027m in the same boat - only realized we had the additional merge mechanism as part of this patchset.\n\nI\u0027m really not sure why we had both mechanisms before, so will embark on just using json-merge like you suggest. (Trent/Josh, if there\u0027s more history here, please chime in!)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":4,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":186,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":36,"deletions":-8},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"bin/build-dataset","type":"MODIFIED","insertions":12,"deletions":-8},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":14,"deletions":-9},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":268,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":37,"deletions":-42},{"file":"bin/reflash","type":"MODIFIED","insertions":13,"deletions":-9},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":755,"sizeDeletions":-674},{"number":"7","revision":"30b1f53ffa66eb9be33932cb735aaa4e3761413b","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/7","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556803723,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556803823,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":4,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":191,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":36,"deletions":-8},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":15,"deletions":-10},{"file":"bin/build-dataset","type":"MODIFIED","insertions":12,"deletions":-8},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":11,"deletions":-6},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":14,"deletions":-9},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":268,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":37,"deletions":-42},{"file":"bin/reflash","type":"MODIFIED","insertions":13,"deletions":-9},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":7,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":5,"deletions":-2},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":23,"deletions":-7},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":760,"sizeDeletions":-674},{"number":"8","revision":"068a8cea2ad39b82294a83f4fc51ef043fc14dd4","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/8","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556890247,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1556890290,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"buildtools/lib/common.sh","line":151,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"file does not end with newline"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":197,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":36,"deletions":-8},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":42,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":23,"deletions":-8},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":707,"sizeDeletions":-734},{"number":"9","revision":"640a7bbb8b2e179fe60849833d1db498bd6177c1","parents":["252de200998ced060fb693fbfaaacaf62798fedf"],"ref":"refs/changes/93/6093/9","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556890421,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556890520,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":197,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":36,"deletions":-8},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":42,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":23,"deletions":-8},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":707,"sizeDeletions":-734},{"number":"10","revision":"976d9a0d79cdf37bfb8f83edfae876687c1a07a6","parents":["2ecd142490fd42247fa86f6ee1c6e301248045ce"],"ref":"refs/changes/93/6093/10","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557239929,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557240022,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/json-merge","line":15,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"dangling sentence?"},{"file":"bin/json-merge","line":15,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"bin/json-merge","line":57,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Is this a little noisy for the very common case?"},{"file":"bin/json-merge","line":57,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep, I\u0027ll just remove that."},{"file":"buildtools/novus/lib/buildspec.js","line":247,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Thanks for cleaning this up, but can we rename this \u0027load_build_spec\u0027 ?"},{"file":"buildtools/novus/lib/buildspec.js","line":247,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"buildtools/novus/lib/buildspec.js","line":253,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"We don\u0027t need this now, it can just directly do .load_file on the single file"},{"file":"buildtools/novus/lib/buildspec.js","line":253,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":219,"deletions":-26},{"file":"README.md","type":"MODIFIED","insertions":36,"deletions":-8},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":0,"deletions":-15},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":42,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":5,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":23,"deletions":-8},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":2,"deletions":-4},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":729,"sizeDeletions":-734},{"number":"11","revision":"544671447cabc7222010025c4c4f4ac71d923960","parents":["2ecd142490fd42247fa86f6ee1c6e301248045ce"],"ref":"refs/changes/93/6093/11","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557334149,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557334239,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"buildtools/novus/lib/buildspec.js","line":254,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Sorry, one more! You\u0027re actually losing more detailed errors from .load_file() here - this can be replaced a simple:\n\nbs.load_file(base_file, false, cb);"},{"file":"buildtools/novus/lib/buildspec.js","line":254,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yeah, I had spent a while trying to work out how to do this\nproperly. I had tried what you suggested here but was seeing\nthat if I used just \u0027cb\u0027 as a parameter to bs.load_file,\ncallers weren\u0027t getting a populated object:\n\ntimf@iorangi-eth0 (master) ls -l build.spec.merged\n4 -rw-r--r--  1 timf  staff  1988  7 May 11:57 build.spec.merged\ntimf@iorangi-eth0 (master) ./bin/buildspec -a zones\n/Volumes/projects/submodule/non-shared/sdc-headnode.git/buildtools/novus/cmd/buildspec.js:129\n\t\t\tconsole.log(SPEC.keys(opts.name).join(\u0027\\n\u0027));\n\t\t\t                 ^\n\nTypeError: Cannot read property \u0027keys\u0027 of undefined\n    at /Volumes/projects/submodule/non-shared/sdc-headnode.git/buildtools/novus/cmd/buildspec.js:129:21\n    at /Volumes/projects/submodule/non-shared/sdc-headnode.git/buildtools/novus/lib/buildspec.js:138:3\n    at FSReqWrap.readFileAfterClose [as oncomplete] (fs.js:511:3)\ntimf@iorangi-eth0 (master)"},{"file":"buildtools/novus/lib/buildspec.js","line":254,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Oops, sorry, yeah, the callback doesn\u0027t provide that value as the 2nd arg. So you need:\n\nbs.load_file(base_file, false, function (err) {\n    cb(err, bs);\n});\n\n(or change load_file to pass back bs too, don\u0027t really mind which.."},{"file":"buildtools/novus/lib/buildspec.js","line":254,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Much nicer, thank you!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":220,"deletions":-27},{"file":"README.md","type":"MODIFIED","insertions":39,"deletions":-12},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":41,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":14,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":4,"deletions":-15},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":750,"sizeDeletions":-757},{"number":"12","revision":"c534df7befe490898abae8ecb5af5e0e035f6377","parents":["2ecd142490fd42247fa86f6ee1c6e301248045ce"],"ref":"refs/changes/93/6093/12","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557416579,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557416675,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557418280,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":220,"deletions":-27},{"file":"README.md","type":"MODIFIED","insertions":39,"deletions":-12},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":41,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":14,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":4,"deletions":-20},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":750,"sizeDeletions":-762},{"number":"13","revision":"9cebecc3f529618af745d9e896363bed7d342247","parents":["2ecd142490fd42247fa86f6ee1c6e301248045ce"],"ref":"refs/changes/93/6093/13","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557826995,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557416675,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557418280,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":220,"deletions":-27},{"file":"README.md","type":"MODIFIED","insertions":39,"deletions":-12},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":41,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":14,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":4,"deletions":-20},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":750,"sizeDeletions":-762},{"number":"14","revision":"5ce88aabd6c8f6d286fed67295c21da32e1076a1","parents":["fcc8f59a5d89830ffa4e4a496cb43725a5f45cca"],"ref":"refs/changes/93/6093/14","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557947498,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557416675,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557949343,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557418280,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":220,"deletions":-27},{"file":"README.md","type":"MODIFIED","insertions":39,"deletions":-12},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":41,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":14,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":4,"deletions":-20},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":750,"sizeDeletions":-762},{"number":"15","revision":"1e0a1e095f9ba8c2376502f169fe2fcac4ca3686","parents":["fcc8f59a5d89830ffa4e4a496cb43725a5f45cca"],"ref":"refs/changes/93/6093/15","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1557952111,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557416675,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557949343,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557418280,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1557952942,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":5,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":220,"deletions":-27},{"file":"README.md","type":"MODIFIED","insertions":39,"deletions":-12},{"file":"bin/build-coal-image","type":"MODIFIED","insertions":4,"deletions":-18},{"file":"bin/build-dataset","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-tar-image","type":"MODIFIED","insertions":1,"deletions":-16},{"file":"bin/build-usb-image","type":"MODIFIED","insertions":3,"deletions":-17},{"file":"bin/convert-configure-branches.js","type":"ADDED","insertions":250,"deletions":0},{"file":"bin/include-tar-generic","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"bin/json-merge","type":"MODIFIED","insertions":41,"deletions":-44},{"file":"bin/reflash","type":"MODIFIED","insertions":6,"deletions":-32},{"file":"bin/unique-branches","type":"ADDED","insertions":14,"deletions":0},{"file":"buildtools/lib/common.sh","type":"MODIFIED","insertions":19,"deletions":0},{"file":"buildtools/mk/Makefile.defs","type":"DELETED","insertions":0,"deletions":-51},{"file":"buildtools/mk/Makefile.deps","type":"DELETED","insertions":0,"deletions":-52},{"file":"buildtools/mk/Makefile.node.defs","type":"DELETED","insertions":0,"deletions":-104},{"file":"buildtools/mk/Makefile.node.targ","type":"DELETED","insertions":0,"deletions":-42},{"file":"buildtools/mk/Makefile.node_deps.defs","type":"DELETED","insertions":0,"deletions":-43},{"file":"buildtools/mk/Makefile.node_deps.targ","type":"DELETED","insertions":0,"deletions":-24},{"file":"buildtools/mk/Makefile.node_prebuilt.defs","type":"DELETED","insertions":0,"deletions":-153},{"file":"buildtools/mk/Makefile.smf.defs","type":"DELETED","insertions":0,"deletions":-40},{"file":"buildtools/mk/Makefile.smf.targ","type":"DELETED","insertions":0,"deletions":-29},{"file":"buildtools/novus/cmd/buildspec.js","type":"MODIFIED","insertions":5,"deletions":-4},{"file":"buildtools/novus/cmd/checker.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"buildtools/novus/cmd/downloader.js","type":"MODIFIED","insertions":25,"deletions":-10},{"file":"buildtools/novus/cmd/unique-branches.js","type":"ADDED","insertions":89,"deletions":0},{"file":"buildtools/novus/lib/bits_from/dir.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"buildtools/novus/lib/buildspec.js","type":"MODIFIED","insertions":4,"deletions":-20},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0}],"sizeInsertions":750,"sizeDeletions":-762}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}