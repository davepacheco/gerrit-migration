commit 1601be5078dc64bcb860cd7f77d43915220b6cda (refs/changes/40/340/6)
Author: Josh Wilsdon <jwilsdon@joyent.com>
Date:   2016-09-01T21:38:20+00:00 (3 years, 1 month ago)
    
    OS-5618 vmadm should only write what it read
    Reviewed by: Trent Mick <trent.mick@joyent.com>

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index c85ed286..5f4bd40c 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -6677,12 +6677,19 @@ exports.markVMFailure = function (vmobj, options, callback)
                     fs.read(fd, buffer, 0, 4096, startpos,
                         function (read_err, bytesRead, buff) {
 
-                        log.info({'zoneinit_log': buff.toString()},
-                            'data from ' + zoneinit_log + ' ('
-                            + startpos + '/' + stats.size + ')');
+                        var buffStr;
+
+                        if (!read_err) {
+                            buffStr = buff.toString('utf8', 0, bytesRead);
+                            log.info({zoneinit_log: buffStr},
+                                'data from %s (%d/%d)',
+                                zoneinit_log,
+                                startpos,
+                                stats.size);
+                            startpos += bytesRead;
+                        }
 
-                        startpos += bytesRead;
-                        cb();
+                        cb(read_err);
                     });
                 }, function (read_err) {
                     if (read_err) {
