From a27783a812de76bdd6084cd9baf187e50ef1d6d5 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Wed, 24 Aug 2016 12:26:02 -0700
Subject: [PATCH] OS-5618 vmadm should only write what it read

---
 src/vm/node_modules/VM.js | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index c85ed286..bd361429 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -6677,9 +6677,10 @@ exports.markVMFailure = function (vmobj, options, callback)
                     fs.read(fd, buffer, 0, 4096, startpos,
                         function (read_err, bytesRead, buff) {
 
-                        log.info({'zoneinit_log': buff.toString()},
-                            'data from ' + zoneinit_log + ' ('
-                            + startpos + '/' + stats.size + ')');
+                        log.info({
+                            'zoneinit_log': buff.toString('utf8', 0, bytesRead)
+                        }, 'data from ' + zoneinit_log + ' (' + startpos + '/'
+                            + stats.size + ')');
 
                         startpos += bytesRead;
                         cb();
-- 
2.21.0

