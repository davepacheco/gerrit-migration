From 0eecf0190264c666ee27e9a991206175698ff78b Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Wed, 24 Aug 2016 12:30:07 -0700
Subject: [PATCH] OS-5618 vmadm should only write what it read

---
 src/vm/node_modules/VM.js | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/src/vm/node_modules/VM.js b/src/vm/node_modules/VM.js
index c85ed286..885dfa1d 100644
--- a/src/vm/node_modules/VM.js
+++ b/src/vm/node_modules/VM.js
@@ -6677,12 +6677,17 @@ exports.markVMFailure = function (vmobj, options, callback)
                     fs.read(fd, buffer, 0, 4096, startpos,
                         function (read_err, bytesRead, buff) {
 
-                        log.info({'zoneinit_log': buff.toString()},
-                            'data from ' + zoneinit_log + ' ('
-                            + startpos + '/' + stats.size + ')');
+                        var buffStr;
+
+                        if (!read_err) {
+                            buffStr = buff.toString('utf8', 0, bytesRead);
+                            log.info({zoneinit_log: buffStr}, 'data from '
+                                + zoneinit_log + ' (' + startpos + '/'
+                                + stats.size + ')');
+                            startpos += bytesRead;
+                        }
 
-                        startpos += bytesRead;
-                        cb();
+                        cb(read_err);
                     });
                 }, function (read_err) {
                     if (read_err) {
-- 
2.21.0

