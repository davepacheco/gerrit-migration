From 8d983fbd6354c56a2ae88e8c673a575a86c464d8 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 11 Oct 2016 14:17:15 -0700
Subject: [PATCH] PUBAPI-1333 use cueball when talking to mahi

---
 lib/app.js                       |  7 +++++++
 package.json                     |  5 +++--
 sapi_manifests/cloudapi/template | 17 +++++++++++++++++
 3 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/lib/app.js b/lib/app.js
index afc816a..e4d7970 100644
--- a/lib/app.js
+++ b/lib/app.js
@@ -29,6 +29,7 @@ var SDC = require('sdc-clients');
 var UFDS = require('ufds');
 var keyapi = require('keyapi');
 var mahi = require('mahi');
+var cueball = require('cueball');
 
 var account = require('./account');
 var analytics = require('./analytics');
@@ -190,6 +191,11 @@ function createClients(options, callback) {
     assert.ok(options.ufds);
     assert.ok(options.ufds_master);
 
+    var agent;
+    if (options.cueballHttpAgent) {
+        agent = new cueball.HttpAgent(options.cueballHttpAgent);
+    }
+
     options.ufds.log   = options.log.child({ component: 'ufds' });
     options.ufds_master.log = options.log.child({ component: 'ufds_master' });
     options.ca.log     = options.log.child({ component: 'ca' });
@@ -201,6 +207,7 @@ function createClients(options, callback) {
     if (options.mahi) {
         options.mahi.log = options.log.child({ component: 'mahi' });
         options.mahi.typeTable = apertureConfig.typeTable;
+        options.mahi.agent = agent;
     }
 
     if (options.cns) {
diff --git a/package.json b/package.json
index bf0a4ee..8c0f702 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "8.0.2",
+    "version": "8.0.3",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
@@ -21,6 +21,7 @@
         "nopt": "2.0.0",
         "restify": "git+ssh://git@github.com:mcavage/node-restify.git#0d7b4ba",
         "bunyan": "0.22.1",
+        "cueball": "1.1.1",
         "sdc-clients": "9.4.0",
         "ufds": "1.1.3",
         "semver": "2.2.1",
@@ -31,7 +32,7 @@
         "ctype": "0.5.2",
         "keyapi": "git+ssh://git@github.com:joyent/keyapi.git#c30dd2710ad2175095dc0e96479686fa774b8063",
         "aperture": "git+ssh://git@github.com:joyent/node-aperture.git#016977",
-        "mahi": "git+ssh://git@github.com:joyent/node-mahi.git#7c0499",
+        "mahi": "2.0.1",
         "aperture-config": "git+ssh://git@github.com:joyent/aperture-config.git#master",
         "joyent-schemas": "git+ssh://git@github.com:joyent/schemas.git#caf3a226ed0707f5da897e1da151cc6d97fccda2",
         "jsprim": "0.6.1",
diff --git a/sapi_manifests/cloudapi/template b/sapi_manifests/cloudapi/template
index 385c56b..e23dead 100644
--- a/sapi_manifests/cloudapi/template
+++ b/sapi_manifests/cloudapi/template
@@ -63,6 +63,23 @@
     "ca": {
         "url": "http://{{{ca_domain}}}:23181"
     },
+    "cueballHttpAgent": {
+        "resolvers": ["{{{BINDER_SERVICE}}}"],
+        "initialDomains": [
+            "{{{mahi_domain}}}"
+        ],
+        "spares": 4,
+        "maximum": 10,
+        "recovery": {
+            "default": {
+                "timeout": 2000,
+                "maxTimeout": 8000,
+                "retries": 5,
+                "delay": 250,
+                "maxDelay": 1000
+            }
+        }
+    },
     {{#MAHI_SERVICE}}
     "mahi": {
         "url": "http://{{{mahi_domain}}}",
-- 
2.21.0

