From 34557ae708087411b8a76344126f0770169328e5 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Fri, 24 Nov 2017 10:56:25 -0800
Subject: [PATCH] DOCKER-1102 docker pull by manifest digest fails with an
 InternalError

---
 lib/wfapi/workflows/pull-image-v2.js |  2 +-
 package.json                         |  2 +-
 test/integration/api-images.test.js  | 21 ++++++++++++++++++++-
 3 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/lib/wfapi/workflows/pull-image-v2.js b/lib/wfapi/workflows/pull-image-v2.js
index 4da3f51..e43a01a 100644
--- a/lib/wfapi/workflows/pull-image-v2.js
+++ b/lib/wfapi/workflows/pull-image-v2.js
@@ -111,7 +111,7 @@ function pullImageLayersV2(job, cb) {
     var opts = {
         repo: job.params.rat.canonicalName,
         tag: job.params.rat.tag,
-        config_digest: job.params.rat.digest,
+        digest: job.params.rat.digest,
         regAuth: job.params.regAuth,
         regConfig: job.params.regConfig,
         /*
diff --git a/package.json b/package.json
index 94236e6..3cd95c1 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "sdc-docker",
-  "version": "0.4.9",
+  "version": "0.4.10",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
diff --git a/test/integration/api-images.test.js b/test/integration/api-images.test.js
index 91d3922..93a4a09 100644
--- a/test/integration/api-images.test.js
+++ b/test/integration/api-images.test.js
@@ -86,7 +86,6 @@ test('docker images', function (tt) {
             name: 'ubuntu:latest',
             user: ALICE
         }, function (err) {
-            console.log('ubuntu pull err: ', err);
             t.error(err, 'should be no error pulling image');
             t.end();
         });
@@ -188,6 +187,26 @@ test('docker images', function (tt) {
         });
     });
 
+    // Ensure an image can be pulled using the manifest digest.
+    tt.test('pull ubuntu image by manifest digest', function (t) {
+        var repoDigest = img.RepoDigests[0];
+        h.ensureImage({
+            name: repoDigest,
+            user: ALICE
+        }, function (err) {
+            t.error(err, 'should be no error pulling image by digest');
+            t.end();
+        });
+    });
+
+    tt.test('delete image', function (t) {
+        DOCKER_ALICE.del('/images/ubuntu', ondel);
+        function ondel(err, req, res) {
+            t.error(err, 'should be no error retrieving images');
+            t.end();
+        }
+    });
+
     tt.test('pull image name containing port', function (t) {
         h.ensureImage({
             name: IMAGE_NAME_WITH_PORT,
-- 
2.21.0

