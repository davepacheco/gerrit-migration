{"project":"joyent/binder","branch":"master","topic":"MANTA-3141","id":"If8cf3513f4c7ad80e5c3c876c7b0bd311cf8c686","number":"3545","subject":"MANTA-3141 binder saturated, manta sadness ensues Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Reviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e Approved by: Alex Wilson \u003calex.wilson@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/3545","commitMessage":"MANTA-3141 binder saturated, manta sadness ensues\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nReviewed by: Alex Wilson \u003calex.wilson@joyent.com\u003e\nApproved by: Alex Wilson \u003calex.wilson@joyent.com\u003e\n","createdOn":1520297369,"lastUpdated":1520893511,"open":false,"status":"MERGED","comments":[{"timestamp":1520297369,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1520297581,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1520368056,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(36 comments)"},{"timestamp":1520372118,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\nOne other note: there don\u0027t seem to be any automated tests for any of the new code."},{"timestamp":1520398613,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1520398663,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(34 comments)\n\nThanks for taking a look, Dave!  I have made some fixes based on your feedback, as well as created a list of follow-up work."},{"timestamp":1520475456,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520475505,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520476279,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520493275,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4."},{"timestamp":1520493308,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520493336,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Topic set to MANTA-3141"},{"timestamp":1520640541,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\nThe only remaining integration issue is the package.json dependency.  The rest can be addressed in follow-up changes."},{"timestamp":1520642899,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1520888240,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5."},{"timestamp":1520888268,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520890303,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1520893406,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1"},{"timestamp":1520893485,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1520893511,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"6","revision":"f8cf3513f4c7ad80e5c3c876c7b0bd311cf8c686","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520893485,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520888268,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520890303,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520893406,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520893406,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1520893511,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":76,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":303,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1125,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":448,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":54,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":103,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":39,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2683,"sizeDeletions":-50},"patchSets":[{"number":"1","revision":"875820ffedcd6426451dae51b3f9a7650e2a7c24","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520297369,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520475456,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":64,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":291,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1082,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":434,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":44,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":155,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":46,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2651,"sizeDeletions":-50},{"number":"2","revision":"204cd5676ffad444035d91e5d23f9f8979df6af2","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520297581,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520475505,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"Makefile","line":74,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Presumably this should move into eng.git?\n\nWould it not make sense to use the same temporary directory that we use for other build stamps?"},{"file":"Makefile","line":74,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes on both counts, and I\u0027ll move it there as follow-up work.\n\nI have filed TOOLS-1997 to cover this."},{"file":"boot/setup.sh","line":56,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think it might be worth mentioning that we\u0027re deliberately adding rules for all possible processes, and that there\u0027s no impact to having rules for processes that don\u0027t exist.  I say that because I think it would be easy to misread this code as setting up rules for the current config, which would be broken if the config ever changed."},{"file":"boot/setup.sh","line":56,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"boot/setup.sh","line":57,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It seems like this could have a clearer name."},{"file":"boot/setup.sh","line":57,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"boot/setup.sh","line":135,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is the expectation that subsequent changes to Binder should test both the Triton and Manta contexts?  Maybe that\u0027s already the case?"},{"file":"boot/setup.sh","line":135,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think they already must, as this initialisation path is already bifurcated along at least those two cases.\n\nI left \"single-binder.xml\" as a copy of the original \"binder.xml\" in an attempt to avoid the immediate need to test Triton binder in any way more completely than confirming it still starts up and services requests as before."},{"file":"lib/server.js","line":546,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Seems like this could be clearer with a barrier (but that\u0027s quite minor)."},{"file":"lib/server.js","line":546,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think it might be clearer still as a waterfall, and I\u0027ll add that to the follow-up list."},{"file":"package.json","line":13,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is just a note that this needs to be updated before integration."},{"file":"smf/manifests/binder-balancer.xml.in","line":42,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why is this /tmp, out of curiosity?"},{"file":"smf/manifests/binder-balancer.xml.in","line":42,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I suppose I could set it to \"/\".  It feels like it should probably be writable, but \"nobody\" doesn\u0027t have a home directory per se."},{"file":"smf/manifests/mksockdir.xml.in","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is there any particular reason to do this with another service instead of having either the binder start method do this or have binders do it when they bind their ports?"},{"file":"smf/manifests/mksockdir.xml.in","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would like those services to run from startup as \"nobody\" (or, perhaps in future, a dedicated user for each of the frontend and backend services).  The \"/var/run\" directory is a tmpfs, but without the magic bit that lets just anybody write there.  This service runs as root to create the directory, but does nothing else."},{"file":"src/nvlist_equal.c","line":62,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is that...okay?"},{"file":"src/nvlist_equal.c","line":62,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027m not sure.  Lists allocated without NV_UNIQUE_NAME are frankly pretty weird, and there are lots of edge cases in the library already.  I added nested nvlist equality checking fairly late, and only then realised that I\u0027d need to be able to return an error from \"nvpair_equal()\" in the event that this happens.\n\nI\u0027ve added fixing this to the follow-up list."},{"file":"src/nvlist_equal.c","line":98,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This could use a comment."},{"file":"src/nvlist_equal.c","line":98,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/nvlist_equal.c","line":107,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this necessary?  It looks like the value is supposed to be a boolean_t.  Would it not be reasonable to assert that it\u0027s either B_TRUE or B_FALSE?"},{"file":"src/nvlist_equal.c","line":107,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/nvlist_equal.c","line":156,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Seems like maybe this block could be commonized with another macro defining the comparator expression (but I don\u0027t blame you if you preferred not to)."},{"file":"src/nvlist_equal.c","line":156,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It could.  I\u0027ve added this to the follow-up list."},{"file":"src/nvlist_equal.c","line":264,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Yipes!"},{"file":"src/nvlist_equal.c","line":264,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Rather!"},{"file":"src/smf_adjust.c","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Have you considered moving this to a separate repo?"},{"file":"src/smf_adjust.c","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I have, and I think I would like to once it\u0027s more complete.  One thing that I think probably needs to happen, for instance, is a way to provide the set of properties to create within the \"config\" property group, probably based on some kind of basic template string."},{"file":"src/smf_adjust.c","line":10,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"A comment here explaining the purpose of this tool would be helpful.\n\nA manual page would be fantastic!  (There are Make targets for building these from Markdown files, though they use the pattern that checks in the generated pages.)"},{"file":"src/smf_adjust.c","line":10,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ve added a brief comment that describes what the tool is for.  I\u0027ve also added better documentation and a manual page to the list of things for follow-up work.\n\nAs it stands, I envisage this tool will probably continue to live in \"lib/\" and not be something people run directly.  Rather, I\u0027d probably provide a basic shell-script wrapper with a better name; e.g., \"binder_set_instance_count\" which accepts just an integer argument for the number of instances."},{"file":"src/smf_adjust.c","line":47,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be helpful to comment this structure, as well as the data structure \"g_insts\"."},{"file":"src/smf_adjust.c","line":47,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smf_adjust.c","line":173,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this a question or an exclamation!"},{"file":"src/smf_adjust.c","line":173,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Why not both!"},{"file":"src/smf_adjust.c","line":326,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This appears to be an undocumented interface!"},{"file":"src/smf_adjust.c","line":326,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It is, but it\u0027s been relatively stable over time.  I\u0027ve added this to the follow-up list, as well as frankly better diagnostic output in general -- what\u0027s there today is not good in any sense of the word."},{"file":"src/smf_adjust.c","line":839,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Are these options documented anywhere?"},{"file":"src/smf_adjust.c","line":839,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Not yet.  I\u0027ve added this to the follow-up list."},{"file":"src/smf_adjust.c","line":878,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"How would someone determine why we aborted here?  (It might be clearer to make the \u0027?\u0027 case the \"default\" one and VERIFY that `c \u003d\u003d \u0027?\u0027`.)"},{"file":"src/smf_adjust.c","line":878,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smf_adjust.c","line":919,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should this read `insts_add_planned`?"},{"file":"src/smf_adjust.c","line":919,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smf_adjust.c","line":977,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is there a significance to the iteration order here?"},{"file":"src/smf_adjust.c","line":977,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, though it is perhaps not that important.  I\u0027m trying to remove the services in the reverse of the order in which they should have been created and enabled.  If we get stuck half way through for some unexpected reason, we should still have a contiguous set of instances from BASE+1 up to where we stopped removing."},{"file":"src/smf_adjust.c","line":1034,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should this be PATH_MAX? or something configured from pathconf(3c)?"},{"file":"src/smf_adjust.c","line":1034,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.c","line":10,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"It would be nice if either this file or \"smfx.h\" had a 1-2 sentence overview of what these interfaces are for.  (Speaking of that, what is this for?  Is it basically to wrap things with better error messages?)"},{"file":"src/smfx.c","line":10,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.c","line":75,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Recent bugs notwithstanding, strerror(3C) is documented to always return a pointer to a string."},{"file":"src/smfx.c","line":76,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Personally, I prefer interfaces where passed-in strings used as output parameters always include the size, even when the interface also provides a value (like this one) indicating how large that buffer can be (or must be, or should be).  Otherwise, you rely on callers to have inferred what the minimum buffer size must be, which is sometimes non-trivial and anyway introduces a way this can easily be wrong."},{"file":"src/smfx.c","line":76,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ll add this to the list of follow-ups."},{"file":"src/smfx.c","line":144,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Seems like a lot of these paths could use smfx_free()."},{"file":"src/smfx.c","line":144,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ll add this to the list of follow-ups."},{"file":"src/smfx.c","line":165,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is \"config\" supposed to be the name of a property group, or is it some type of property group?  Is this comment correct?"},{"file":"src/smfx.c","line":165,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.c","line":207,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think there\u0027s a missing `free(type)` here."},{"file":"src/smfx.c","line":207,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.c","line":232,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I don\u0027t really understand what this function is supposed to do."},{"file":"src/smfx.c","line":232,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.c","line":250,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Isn\u0027t this by definition NULL at this point?"},{"file":"src/smfx.c","line":250,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.c","line":267,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is it ever possible that this would ever change the state of an instance unintentionally?  Would it make sense to specify SMF_TEMPORARY?"},{"file":"src/smfx.c","line":267,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think it\u0027s unlikely.  The function \"smf_get_state(3SCF)\" is documented to fail with \"SCF_ERROR_NOT_FOUND\" in the event that the FMRI is not valid, but absent a logic error in the program or concurrent modification of the SCF from outside this process, that should never happen -- we\u0027re flushing an instance we just created or loaded.\n\nI\u0027m also not sure that the use of SMF_TEMPORARY will have the desired effect.  I can add this to the list of things to check in follow-up work."},{"file":"src/smfx.c","line":329,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why is this called \"locate\", but it seems like the analogous function for instances is called \"load\"?"},{"file":"src/smfx.c","line":329,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Because it takes an FMRI string, rather than a service name.  I would want the analogous service \"load\" routine to take a bare service name, as would be passed to \"scf_scope_get_service(3SCF)\".  I confess that it\u0027s not a good verb choice -- do you have something better in mind?"},{"file":"src/smfx.c","line":375,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we not bail out here?  If not, it seems like we\u0027d be returning a garbage string, and the caller wouldn\u0027t know we hit this case."},{"file":"src/smfx.c","line":375,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Done"},{"file":"src/smfx.h","line":40,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This is pretty nitty, but the naming convention here seems unclear -- sometimes it\u0027s (object, verb), as in \"instance_create\", and sometimes it\u0027s (verb, object), as in \"load_instance\"."},{"file":"src/smfx.h","line":40,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027ll add this to the list of follow-ups."},{"file":"src/utils.c","line":37,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Out of curiosity, is there any reason this doesn\u0027t use the POSIX-specified usleep() or nanosleep()?"},{"file":"src/utils.c","line":37,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I believe nanosleep() is technically specified to use CLOCK_REALTIME, and I\u0027d prefer to use the monotonic clock.  I believe, also, that this is in POSIX as of 2001."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":64,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":291,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1082,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":434,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":44,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":103,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":39,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2592,"sizeDeletions":-50},{"number":"3","revision":"95fa35ea6a0ec0a34af5807b653faa487c3e73de","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520398613,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520476279,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":76,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":303,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1125,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":448,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":54,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":103,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":39,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2683,"sizeDeletions":-50},{"number":"4","revision":"b57867ded22981e1ac3b73d20024e2d73369bf92","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520493275,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520642899,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520493308,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":76,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":303,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1125,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":448,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":54,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":103,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":39,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2683,"sizeDeletions":-50},{"number":"5","revision":"4891580c500cedd31d8fc3ce887b59ffe33af134","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520888240,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520890303,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520893406,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520893406,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520888268,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":76,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":303,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1125,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":448,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":54,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":103,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":39,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2683,"sizeDeletions":-50},{"number":"6","revision":"f8cf3513f4c7ad80e5c3c876c7b0bd311cf8c686","parents":["10d8802cebc09b7f07d4e932b6418519863c44a7"],"ref":"refs/changes/45/3545/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1520893485,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520890303,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520893406,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520893406,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1520893511,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520888268,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":3,"deletions":0},{"file":".gitmodules","type":"MODIFIED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":96,"deletions":-31},{"file":"bin/balstat","type":"ADDED","insertions":32,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":76,"deletions":-9},{"file":"deps/mname-balancer","type":"ADDED","insertions":1,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"main.js","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"smf/manifests/binder-balancer.xml.in","type":"ADDED","insertions":60,"deletions":0},{"file":"smf/manifests/mksockdir.xml.in","type":"ADDED","insertions":40,"deletions":0},{"file":"smf/manifests/multi-binder.xml.in","type":"ADDED","insertions":93,"deletions":0},{"file":"smf/manifests/single-binder.xml.in","fileOld":"smf/manifests/binder.xml.in","type":"RENAMED","insertions":0,"deletions":0},{"file":"smf/methods/mksockdir","type":"ADDED","insertions":29,"deletions":0},{"file":"src/nvlist_equal.c","type":"ADDED","insertions":303,"deletions":0},{"file":"src/nvlist_equal.h","type":"ADDED","insertions":20,"deletions":0},{"file":"src/smf_adjust.c","type":"ADDED","insertions":1125,"deletions":0},{"file":"src/smfx.c","type":"ADDED","insertions":448,"deletions":0},{"file":"src/smfx.h","type":"ADDED","insertions":54,"deletions":0},{"file":"src/utils.c","type":"ADDED","insertions":103,"deletions":0},{"file":"src/utils.h","type":"ADDED","insertions":39,"deletions":0},{"file":"tools/download_ctftools","type":"ADDED","insertions":84,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2683,"sizeDeletions":-50}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}