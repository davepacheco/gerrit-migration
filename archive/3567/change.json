{"project":"joyent/manta-muskie","branch":"master","id":"I617d19d8ead635db6e3e2ce59e7cf89d3db01beb","number":"3567","subject":"MANTA-3591 muskie throttle doesn\u0027t enforce concurrency properly","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/3567","commitMessage":"MANTA-3591 muskie throttle doesn\u0027t enforce concurrency properly\n","createdOn":1520539584,"lastUpdated":1546452651,"open":true,"status":"NEW","comments":[{"timestamp":1520539584,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1520539797,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 2."},{"timestamp":1520635687,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 3."},{"timestamp":1520636920,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1520883426,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 5."},{"timestamp":1520887716,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1520888382,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 7."},{"timestamp":1520888579,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7:\n\nI\u0027ve pushed a couple of patchsets after asking for review, sorry about that. PS7 is the latest one that I\u0027ve tested and seems to work. I\u0027m going to pause work on this pending review because I think it\u0027s in a good place as far as functionality is concerned."},{"timestamp":1521068233,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7:\n\n(14 comments)"},{"timestamp":1521138846,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1521138858,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(12 comments)"},{"timestamp":1521138911,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 9."},{"timestamp":1521139192,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1521147171,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 10."},{"timestamp":1521147203,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 10:\n\n(2 comments)"},{"timestamp":1521233725,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 10:\n\n(9 comments)"},{"timestamp":1521480371,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 11."},{"timestamp":1521480414,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 11:\n\n(6 comments)"},{"timestamp":1521498613,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 11: Code-Review+1\n\n(14 comments)\n\nMost of my comments are pretty minor this time around."},{"timestamp":1521508669,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 11:\n\n(12 comments)"},{"timestamp":1521508674,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 12."},{"timestamp":1521563811,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 12: Code-Review+1\n\n(2 comments)"},{"timestamp":1521744729,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 13."},{"timestamp":1521757844,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1521769647,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 14."},{"timestamp":1521769684,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 14:\n\nupdated the name of the function returned from throttlePreHandler to \u0027throttleWait\u0027 so it\u0027s more obvious what the purpose is in \u0027req.timers\u0027."},{"timestamp":1521771053,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 14: Code-Review+1"},{"timestamp":1522428558,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542751829,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 15: Patch Set 14 was rebased"},{"timestamp":1542751878,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15:\n\n\"make check\" passed ok"},{"timestamp":1546452651,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"15","revision":"2e7b01013f3013aa202a5acc0d7e1f61e149cf5d","parents":["4d9be47aa0e74267e0211f566c07f6ddad566db6"],"ref":"refs/changes/67/3567/15","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542751829,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521771053,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522428558,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":43,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":269,"deletions":-121}],"sizeInsertions":351,"sizeDeletions":-168},"patchSets":[{"number":"1","revision":"adc266ea05d17009474905e726eb42850cac004e","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520539584,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":15,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":158,"deletions":-50}],"sizeInsertions":173,"sizeDeletions":-55},{"number":"2","revision":"e3a6fde9e60d79d9f7592bf825cb003a9126141a","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520539797,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":158,"deletions":-50}],"sizeInsertions":175,"sizeDeletions":-55},{"number":"3","revision":"a9ac2b974ebea9d4fac42465f0079d52e4669459","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520635687,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/throttleprocstat.d","type":"ADDED","insertions":76,"deletions":0},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":40,"deletions":-17},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":205,"deletions":-122}],"sizeInsertions":338,"sizeDeletions":-144},{"number":"4","revision":"abcd6e19518fbcc697f2c052ee3d59a310126be2","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520636920,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":14,"deletions":-19},{"file":"bin/throttleprocstat.d","type":"ADDED","insertions":76,"deletions":0},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":40,"deletions":-17},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":205,"deletions":-122}],"sizeInsertions":352,"sizeDeletions":-163},{"number":"5","revision":"39f61fac23af4eaa47d70162653ea95edd73460d","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520883426,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":236,"deletions":-123}],"sizeInsertions":313,"sizeDeletions":-170},{"number":"6","revision":"3732a55c23618cb44f06b91f0e356d68dc6e7d26","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520887716,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":37,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":237,"deletions":-123}],"sizeInsertions":314,"sizeDeletions":-170},{"number":"7","revision":"8b0afba891609df3406a23b845baee1e6ec346a2","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1520888382,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"bin/throttlestat.d","line":76,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: wrap here?"},{"file":"lib/throttle.js","line":35,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Maybe a \"recently added request\"?"},{"file":"lib/throttle.js","line":35,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":65,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Would it make sense to separate the following two paragraphs out with a header? Something like: \"Throttle Parameter Tradeoffs\"?"},{"file":"lib/throttle.js","line":78,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think this could probably use a comment, even if it\u0027s short, to explain what it is, any tradeoffs for larger or smaller intervals, and maybe even why 5 seconds is a reasonable value as default."},{"file":"lib/throttle.js","line":78,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":80,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I would recommend a function comment on this, mentioning at the least, that the constructor kicks off the first scheduling of request reaping."},{"file":"lib/throttle.js","line":80,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":87,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"assert.object?"},{"file":"lib/throttle.js","line":87,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":100,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This comment and the ones immediately below it need to be updated, I think."},{"file":"lib/throttle.js","line":100,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I\u0027m not sure why. These all just pass the restify request id now. It seemed like a cleaner interface that allows clients to perform latency calculations and track queueing delays. \n\nThe last probe is meant to provide the ground truth about what\u0027s in the queue at any given moment."},{"file":"lib/throttle.js","line":100,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It looks like the \"// request id\" comment was copy-pasted above each probe. Was it not intended to be different for each one?"},{"file":"lib/throttle.js","line":100,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"No, they\u0027re all the same now. Would you prefer to see a single comment indicating that the argument is the same for all them?"},{"file":"lib/throttle.js","line":100,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"That might be clearer, I think. Up to you."},{"file":"lib/throttle.js","line":118,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m not sure I understand what \"request handling function\" means here."},{"file":"lib/throttle.js","line":118,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It\u0027s a chain of restify handlers. I\u0027ll modify it to state that more explicitly."},{"file":"lib/throttle.js","line":118,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks, the comment in PS 10 is a lot clearer."},{"file":"lib/throttle.js","line":131,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I think the core of the problem here is not that we don\u0027t know whether muskie routes invoke next() correctly -- that is something that could in theory be verified, I think.\n\nThe deeper problem is that in the event that such a situation does happen, due to programmer error now or in the future, we don\u0027t want the request to be queued indefinitely or removed from the queue early."},{"file":"lib/throttle.js","line":131,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":138,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"It would be good to document in the function comment that this function schedules itself on an interval, too."},{"file":"lib/throttle.js","line":138,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":147,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"nit: camel case instead? (\"numReqs\")"},{"file":"lib/throttle.js","line":147,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is this flag set by restify?"},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It is actually set on http.OutgoingMessage (which http.ServerResponse inherits from) by nodes core when req.end() is called by restify. req.end() is always called as a result of res.send()."},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Ah. It might be good to explain that it is set by the node core then? My first instinct was to look through the muskie source to see where it was set, and I couldn\u0027t find it."},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":220,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for this comment. I\u0027ve often seen \"once\" used to paper over incorrect code, so I was stoked to find an explanation as to why it was needed. It seems like this is a reasonable use of it.\n\nnit: I would say \"the request was reaped from the queue\" instead of giving function name for (1), since that describes what happened, and isn\u0027t tied to the name of the function as it is today in code."},{"file":"lib/throttle.js","line":220,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":266,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"When could this condition happen?"},{"file":"lib/throttle.js","line":266,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"It shouldn\u0027t, I\u0027ll turn this into an assertion."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":42,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":236,"deletions":-123}],"sizeInsertions":318,"sizeDeletions":-170},{"number":"8","revision":"e71643bc9a60d9bfce510d009a61bbaea5f927cc","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521138846,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":42,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":256,"deletions":-120}],"sizeInsertions":338,"sizeDeletions":-167},{"number":"9","revision":"073eb5b1eaaf089dd4ff08f5c7f0021afa9d04fb","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521138911,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":42,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":256,"deletions":-120}],"sizeInsertions":338,"sizeDeletions":-167},{"number":"10","revision":"cbefc71d18143cdc6de14c32c5c2b95cb96ebcde","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521147171,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"lib/throttle.js","line":80,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for adding this."},{"file":"lib/throttle.js","line":83,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Is this the only reason we know of that this could happen?"},{"file":"lib/throttle.js","line":83,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"As far as I know the only way that neither the \u0027after\u0027 nor \u0027uncaughtException\u0027 event are emitted for a request is when a route is missing a call to \u0027next.\u0027 All correctly implemented routes should call next in each handler either with an error or no arguments. \n\nIt\u0027s not actually directly stated in the docs, but I\u0027m basing this off my reading of the source in addition to various github issue discussions:\n\nhttps://github.com/restify/node-restify/issues/1585\nhttps://github.com/restify/node-restify/issues/416\nhttps://github.com/restify/node-restify/issues/201\n\nThe restify documentation reads \"The handler chain for a route has been fully completed.\""},{"file":"lib/throttle.js","line":87,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"and tie up CPU, presumably?"},{"file":"lib/throttle.js","line":87,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":149,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Sorry to be so nitty on this, but I\u0027m not sure Muskie is any more prone to programmer error than any other restify consumer, so I don\u0027t think it\u0027s really fair to dog on it.\n\nHow about something like: \"In the unfortunate event that a restify handler chain contains a handler that does not always properly invoke the restify `next` callback, the restify server will not emit an `after` event nor an `uncaughtException` event for that request. Listening only for these events can potentially lead to leaked requests in the throttle.\""},{"file":"lib/throttle.js","line":149,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":156,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"throttle\u0027s\""},{"file":"lib/throttle.js","line":156,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"maybe just: \"for\"?"},{"file":"lib/throttle.js","line":157,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":249,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"server\u0027s\""},{"file":"lib/throttle.js","line":249,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":42,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":259,"deletions":-120}],"sizeInsertions":341,"sizeDeletions":-167},{"number":"11","revision":"87b13b0e6b26ea2d4d602bea81989015a4f67f6a","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/11","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521480371,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521498613,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"comments":[{"file":"README.md","line":271,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Most tools I\u0027ve seen like this will run for a single invocation and exit if no interval is given. Does throttlestat.d do that?"},{"file":"README.md","line":271,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"In the last patchset I actually changed the tool not to take an argument and instead generate the report every second. I forgot to update the documentation."},{"file":"bin/throttlestat.d","line":70,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Can this be wrapped?"},{"file":"bin/throttlestat.d","line":70,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/server.js","line":220,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Does this handler show up in `req.timers` of the audit entry? (Just curious.)"},{"file":"lib/throttle.js","line":53,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"This is ambiguous, as the previous sentence is referring to a different request. It may be worth saying something like \"a request already in stage 2\" to indicate we are talking about a different request than the previous paragraph."},{"file":"lib/throttle.js","line":53,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":54,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"request\u0027s\""},{"file":"lib/throttle.js","line":54,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":60,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"method\"?"},{"file":"lib/throttle.js","line":60,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":61,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m pretty sure this should be \"invoke\" here, right? (As this process invokes the callback; it does not already find that the vasync callback has been invoked)"},{"file":"lib/throttle.js","line":61,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":62,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"Muskie\" (same for other places in this file)"},{"file":"lib/throttle.js","line":62,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":90,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"s/for what is currently/for"},{"file":"lib/throttle.js","line":90,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":152,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Looking at the docs, I noticed that the server can emit a \"restifyError\" as well. Should we address that error in any of the comments in this file?"},{"file":"lib/throttle.js","line":152,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Based on the documentation here: http://restify.com/docs/4to5/ (the fact that a migration guide says \"restify now emits a generic error\" along with the fact that the \u0027restifyError\u0027 symbol doesn\u0027t exist in v2.6.3 (used by Muskie) it seems that this an event that we won\u0027t see in Muskie."},{"file":"lib/throttle.js","line":152,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for looking into that."},{"file":"lib/throttle.js","line":184,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Should we assert these values exist and are the proper types?"},{"file":"lib/throttle.js","line":184,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":222,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"The top-level request object for Muskie is cluttered with values that Muskie, node and restify code (and possibly other modules) have stored on it, making it hard to parse in debugging. If possible, it might be worth storing all throttle-related values under a new object (e.g., \"req.throttle\"). If it\u0027s too annoying to change, that\u0027s okay. Still, I generally try to avoid cluttering up the namespace on the object any further than it already is."},{"file":"lib/throttle.js","line":222,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I can add it to it\u0027s own object!"},{"file":"lib/throttle.js","line":222,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Thanks for doing that. I think it makes it a lot easier to find where these values are set when debugging."},{"file":"lib/throttle.js","line":256,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Would it be worth calling this \"queueCb\" or something similar? It would be nice if it were immediately clear that this is related to the vasync queue (and not, for instance, the next() call in the request\u0027s handler chain)."},{"file":"lib/throttle.js","line":256,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Done"},{"file":"lib/throttle.js","line":303,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"\"reqId\"? (same for other places in this file)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":42,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":261,"deletions":-120}],"sizeInsertions":343,"sizeDeletions":-167},{"number":"12","revision":"ce6ee011ae4b8a88638cf4717ad0e67ec0798a5c","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/12","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521508674,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521563811,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":43,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":268,"deletions":-121}],"sizeInsertions":350,"sizeDeletions":-168},{"number":"13","revision":"1adfed6134f466ed0d9ba08ea011d93b50465f8b","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/13","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521744729,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521757844,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":43,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":269,"deletions":-121}],"sizeInsertions":351,"sizeDeletions":-168},{"number":"14","revision":"617d19d8ead635db6e3e2ce59e7cf89d3db01beb","parents":["7d3edb20b400abf08f3f2465b6662074662f0529"],"ref":"refs/changes/67/3567/14","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1521769647,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522428558,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521771053,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":43,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":269,"deletions":-121}],"sizeInsertions":351,"sizeDeletions":-168},{"number":"15","revision":"2e7b01013f3013aa202a5acc0d7e1f61e149cf5d","parents":["4d9be47aa0e74267e0211f566c07f6ddad566db6"],"ref":"refs/changes/67/3567/15","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1542751829,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1522428558,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521771053,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":-21},{"file":"bin/throttlestat.d","type":"MODIFIED","insertions":43,"deletions":-19},{"file":"etc/config.coal.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":17,"deletions":-5},{"file":"lib/throttle.js","type":"MODIFIED","insertions":269,"deletions":-121}],"sizeInsertions":351,"sizeDeletions":-168}],"allReviewers":[{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Joyent Automation","username":"joyent-automation"}]}