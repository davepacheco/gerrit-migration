From a54f79bd012eecf8aa15745a97278149ca0ac97d Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 2 Aug 2017 17:56:05 -0700
Subject: [PATCH] joyent/node-cueball#118 slot should retain reference to
 previous claim handle

---
 lib/connection-fsm.js | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/lib/connection-fsm.js b/lib/connection-fsm.js
index 4588ebf..602596c 100644
--- a/lib/connection-fsm.js
+++ b/lib/connection-fsm.js
@@ -872,6 +872,7 @@ function ConnectionSlotFSM(options) {
 	this.csf_backend = options.backend;
 	this.csf_wanted = true;
 	this.csf_handle = undefined;
+	this.csf_prevHandle = undefined;
 	this.csf_monitor = options.monitor;
 
 	this.csf_checker = options.checker;
@@ -1008,6 +1009,8 @@ ConnectionSlotFSM.prototype.state_idle = function (S) {
 	var self = this;
 	var smgr = this.csf_smgr;
 
+	if (this.csf_handle !== undefined)
+		this.csf_prevHandle = this.csf_handle;
 	this.csf_handle = undefined;
 
 	/* Monitor successfully connected: make it into a normal slot now. */
-- 
2.21.0

