From 6f9a3157c81b18dd942e6d5ca631d1d5b9ca5bc1 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Tue, 6 Aug 2019 13:28:54 +0100
Subject: [PATCH] OS-7770 remove platform build dep on download.joyent.com

---
 README.md               |  8 ++++----
 configure               | 15 ++++++++-------
 default.configure-build |  8 ++++----
 3 files changed, 16 insertions(+), 15 deletions(-)

diff --git a/README.md b/README.md
index 9caf9fde..8784a3ec 100644
--- a/README.md
+++ b/README.md
@@ -432,10 +432,10 @@ If this file does not exist, the following defaults are set by `configure`:
 ```
 PUBLISHER="joyent"
 RELEASE_VER="joyent_147"
-SUNW_SPRO12_URL="https://download.joyent.com/pub/build/SunStudio.tar.bz2"
-ON_CLOSED_BINS_URL="https://download.joyent.com/pub/build/illumos/on-closed-bins.i386.tar.bz2"
-ON_CLOSED_BINS_ND_URL="https://download.joyent.com/pub/build/illumos/on-closed-bins-nd.i386.tar.bz2"
-ILLUMOS_ADJUNCT_TARBALL_URL="https://download.joyent.com/pub/build/adjuncts/"
+SUNW_SPRO12_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/SunStudio.tar.bz2"
+ON_CLOSED_BINS_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/illumos/on-closed-bins.i386.tar.bz2"
+ON_CLOSED_BINS_ND_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/illumos/on-closed-bins-nd.i386.tar.bz2"
+ILLUMOS_ADJUNCT_TARBALL_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/adjuncts/illumos-adjunct.20130131.tgz"
 ```
 
 #### Debug Builds
diff --git a/configure b/configure
index f57039a6..6e5fced2 100755
--- a/configure
+++ b/configure
@@ -25,7 +25,7 @@ conf_arg0_dir=$(dirname $0)
 conf_root=$PWD
 conf_ips=
 conf_priv="pfexec"
-conf_pkgsrcurl="https://download.joyent.com/pub/build/pkgsrc"
+conf_pkgsrcurl="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/pkgsrc"
 
 #
 # Build defaults which are unlikely to change, but may be overridden by
@@ -216,7 +216,12 @@ function install_pkgin
 	#
 	# Packages not in pkgsrc
 	#
-	for pkg in dmake sgstools rpcgen astmsgtools; do
+	local unpublished_pkgs="
+		astmsgtools-20130402
+		dmake-20130927
+		rpcgen-20130402
+		sgstools-20130402"
+	for pkg in $unpublished_pkgs; do
 		if ! pkg_info -qe $pkg; then
 			curl -k "$conf_pkgsrcurl/$pkg.tgz" -o \
 			    /var/tmp/$pkg.tgz || fatal \
@@ -275,11 +280,7 @@ function fetch_adjuncts
 	local tgz
 	[[ -z "$ILLUMOS_ADJUNCT_TARBALL_URL" ]] && fatal \
 	    "ILLUMOS_ADJUNCT_TARBALL_URL missing from configure"
-	tgz=$(curl -k "$ILLUMOS_ADJUNCT_TARBALL_URL" | grep href | tail -n1 | \
-	    cut -d '"' -f2)
-	[[ -z "$tgz" ]] && fatal \
-	    "Unable to get adjuncts from ILLUMOS_ADJUNCT_TARBALL_URL"
-	curl -kO $ILLUMOS_ADJUNCT_TARBALL_URL/$tgz
+	curl -kO $ILLUMOS_ADJUNCT_TARBALL_URL
 	[[ $? -eq 0 ]] || fatal "failed to fetch adjuncts tarball"
 }
 
diff --git a/default.configure-build b/default.configure-build
index 930a273c..2e55b740 100644
--- a/default.configure-build
+++ b/default.configure-build
@@ -1,6 +1,6 @@
 PUBLISHER="joyent"
 RELEASE_VER="joyent_147"
-SUNW_SPRO12_URL="https://download.joyent.com/pub/build/SunStudio.tar.bz2"
-ON_CLOSED_BINS_URL="https://download.joyent.com/pub/build/illumos/on-closed-bins.i386.tar.bz2"
-ON_CLOSED_BINS_ND_URL="https://download.joyent.com/pub/build/illumos/on-closed-bins-nd.i386.tar.bz2"
-ILLUMOS_ADJUNCT_TARBALL_URL="https://download.joyent.com/pub/build/adjuncts/"
+SUNW_SPRO12_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/SunStudio.tar.bz2"
+ON_CLOSED_BINS_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/illumos/on-closed-bins.i386.tar.bz2"
+ON_CLOSED_BINS_ND_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/illumos/on-closed-bins-nd.i386.tar.bz2"
+ILLUMOS_ADJUNCT_TARBALL_URL="https://us-east.manta.joyent.com/Joyent_Dev/public/releng/adjuncts/illumos-adjunct.20130131.tgz"
-- 
2.21.0

