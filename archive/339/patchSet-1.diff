From 29bfe158e4790a2e212845700cae647cc4c120e6 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Wed, 24 Aug 2016 09:47:52 -0700
Subject: [PATCH] DOCKER-918: Allow docker build to copy files to a directory
 when no trailing slash is used

---
 lib/build.js       | 17 +++++++++++++++++
 test/test_build.js | 26 ++++++++++++++++++++++++++
 2 files changed, 43 insertions(+)

diff --git a/lib/build.js b/lib/build.js
index a2ce9d7..9d5f5bd 100644
--- a/lib/build.js
+++ b/lib/build.js
@@ -1528,6 +1528,23 @@ Builder.prototype.getCopyInfo = function getCopyInfo(cmd, opts, callback) {
         return;
     }
 
+    // There is one docker edge case when a file is being copied to a directory,
+    // but dest has no trailing slash, the file gets copied into the directory
+    // as /dest/file. So if dest is a directory here, we add a trailing slash.
+    if (filepaths.length == 1 && dest[dest.length - 1] != '/') {
+        var globalDest = path.join(builder.containerRootDir, resolvedDest);
+        var destStat = null;
+        try {
+            destStat = fs.statSync(globalDest);
+        } catch (e) {
+            // No file/dir, then nothing to do.
+        }
+        if (destStat && destStat.isDirectory()) {
+            builder.log.debug('Adding trailing slash to dest, as it is a directory');
+            resolvedDest += '/';
+        }
+    }
+
     var calcOpts = {
         origPath: '', // Updated in mapFn
         destPath: resolvedDest,
diff --git a/test/test_build.js b/test/test_build.js
index b5e37be..7e5f1a7 100644
--- a/test/test_build.js
+++ b/test/test_build.js
@@ -781,6 +781,32 @@ tape('addMissingFile', function (t) {
 });
 
 
+// DOCKER-918: Test copying a file to a directory, but leave out the trailing
+// slash. Following docker/docker this should be allowed.
+tape('copy to dir without trailing slash', function (t) {
+    var fileAndContents = {
+        'Dockerfile': [
+            'FROM busybox',
+            'RUN mkdir /adir',
+            'COPY file.txt /adir'
+        ].join('\n'),
+        'file.txt': 'hello'
+    };
+    testBuildContents(t, fileAndContents, function (err, result) {
+        var builder = result.builder;
+        if (showError(t, err, builder)) {
+            return;
+        }
+
+        var root = builder.containerRootDir;
+        contents = fs.readFileSync(path.join(root, '/adir/file.txt')).toString();
+        t.equal(contents, fileAndContents['file.txt'], 'Check file.txt');
+
+        testEnd(t, builder);
+    });
+});
+
+
 tape('workdir', function (t) {
     var fileAndContents = {
         'Dockerfile': [
-- 
2.21.0

