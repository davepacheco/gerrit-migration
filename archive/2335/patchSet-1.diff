commit 1f47054f5b8559fff85442dbf68153e3101a8644 (refs/changes/35/2335/1)
Author: Todd Whiteman <todd.whiteman@joyent.com>
Date:   2017-08-04T15:58:03-07:00 (2 years, 2 months ago)
    
    DOCKER-1086 Docker build copy and no trailing slash after a cached command

diff --git a/lib/build.js b/lib/build.js
index 2d39412..9cabd01 100644
--- a/lib/build.js
+++ b/lib/build.js
@@ -693,7 +693,27 @@ Builder.prototype.cmdAdd = function cmdAdd(cmd, callback) {
     // Note: copyInfos are populated in the cmdAddPreFn.
     assert.arrayOfObject(cmd.ctx.copyInfos, 'cmd.ctx.copyInfos');
 
-    this.performCopy(cmd, cmd.ctx.copyInfos, callback);
+    var builder = this;
+
+    // DOCKER-935
+    // When the previous cmd was cached, update the copyInfo, as the previous
+    // copyInfo was generated when there was no real file content (as the
+    // zone had not been reprovisioned yet), and as such the copyInfo.destPath
+    // could be incorrect.
+    var lastLayer = builder.layers[builder.layers.length-2];
+    if (lastLayer && lastLayer.cmd === null) {
+        builder.log.info('cmdAdd: update copyInfo since last layer was cached');
+        builder.cmdAddPreFn(cmd, function (err) {
+            if (err) {
+                callback(err);
+                return;
+            }
+            builder.performCopy(cmd, cmd.ctx.copyInfos, callback);
+        });
+        return;
+    }
+
+    builder.performCopy(cmd, cmd.ctx.copyInfos, callback);
 };
 
 Builder.prototype.addArgEntry = function addArgEntry(name, value) {
