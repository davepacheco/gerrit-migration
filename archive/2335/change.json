{"project":"joyent/sdc-docker-build","branch":"master","id":"I5eae810b5669a621a114dea8460deba08fcacb65","number":"2335","subject":"DOCKER-1086 Docker build copy and no trailing slash after a cached command Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/2335","commitMessage":"DOCKER-1086 Docker build copy and no trailing slash after a cached command\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1501887484,"lastUpdated":1502320846,"open":false,"status":"MERGED","comments":[{"timestamp":1501887484,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1501887485,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 2d8db42648b19c3a4d1e98486b7f4974dad3e4ac\n    \n    Docker build copy and no trailing slash after a cached command"},{"timestamp":1501887513,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502302941,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2."},{"timestamp":1502302942,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 2e45e6a6fb4d7f185d072b01549cd775fa672d82\n    \n    Docker build copy and no trailing slash after a cached command"},{"timestamp":1502302969,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502313987,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2: Code-Review+1\n\n(10 comments)"},{"timestamp":1502315331,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 2:\n\n(10 comments)\n\nUpdated for review comments. Tests passing:\n\n1..240\n# tests 240\n# pass  240"},{"timestamp":1502315347,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3."},{"timestamp":1502315349,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 5ae89c70ee49710c93679b4f0f7d68f5c35cafb6\n    \n    Update for review comments"},{"timestamp":1502315376,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1502316206,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1502320838,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1502320846,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"}],"currentPatchSet":{"number":"3","revision":"5eae810b5669a621a114dea8460deba08fcacb65","parents":["de16a1e065d7f9505df9b2c76b4840b443131e33"],"ref":"refs/changes/35/2335/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1502315347,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502315376,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502316206,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1502320838,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"SUBM","value":"1","grantedOn":1502320846,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":23,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":150,"deletions":-30}],"sizeInsertions":173,"sizeDeletions":-32},"patchSets":[{"number":"1","revision":"1f47054f5b8559fff85442dbf68153e3101a8644","parents":["de16a1e065d7f9505df9b2c76b4840b443131e33"],"ref":"refs/changes/35/2335/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1501887484,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1501887513,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":21,"deletions":-1}],"sizeInsertions":21,"sizeDeletions":-1},{"number":"2","revision":"edba160b88eb05c7265abd5472ea1e19e9e15e94","parents":["de16a1e065d7f9505df9b2c76b4840b443131e33"],"ref":"refs/changes/35/2335/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1502302941,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502302969,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502313987,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"lib/build.js","line":703,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is there always at least one layer for an instance of a builder?"},{"file":"lib/build.js","line":703,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"No it could be empty, but it\u0027s always an array at the least. That\u0027s why the check on the next line for \u0027lastLayer \u0026\u0026\u0027"},{"file":"lib/build.js","line":707,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: the callback function should be named."},{"file":"lib/build.js","line":707,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"test/test_build.js","line":32,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Where does this digest come from?"},{"file":"test/test_build.js","line":32,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"It\u0027s just made up - it\u0027s the same as what was previously used (but that code was all inlined)."},{"file":"test/test_build.js","line":42,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What does \u0027#(nop) CMD [\"sh\"]\u0027 mean as a container command? Does it mean that container is built using a command that does nothing, and so that container\u0027s image contains nothing and when it runs it does nothing?"},{"file":"test/test_build.js","line":42,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"That\u0027s the weird docker thing that docker adds to each layer metadata - if you do a docker history, or docker inspect on busybox (or another container) you\u0027ll see this.\n\nIt\u0027s basically the Dockerfile command that created this layer."},{"file":"test/test_build.js","line":53,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why does empty_layer need to be set to true?"},{"file":"test/test_build.js","line":53,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"For metadata command changes like CMD, ENV, LABEL (i.e. no bits are changed on the filesystem) then docker marks the history entry as having an \u0027empty_layer\u0027."},{"file":"test/test_build.js","line":154,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name this callback."},{"file":"test/test_build.js","line":154,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"test/test_build.js","line":155,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does \"task\" always have an \"imageName\" property, and does \"img\" always have a \"config_digest\" property? If so, is it worth it to add an assert on those?"},{"file":"test/test_build.js","line":155,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Yes they should - so I added the assert."},{"file":"test/test_build.js","line":156,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is it guaranteed that the filter function will return an array with at least one value?"},{"file":"test/test_build.js","line":156,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"No, it\u0027s not guaranteed, but in that case cachedImg is undefined and all is good (i.e. it uses busybox instead)."},{"file":"test/test_build.js","line":263,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: assert on the function\u0027s parameters\u0027 types?"},{"file":"test/test_build.js","line":263,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done"},{"file":"test/test_build.js","line":947,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: alphabetize variables declaration."},{"file":"test/test_build.js","line":947,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Done, well buildOpts still needs to be later as it references the configWorkdir variable."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":23,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":144,"deletions":-30}],"sizeInsertions":167,"sizeDeletions":-32},{"number":"3","revision":"5eae810b5669a621a114dea8460deba08fcacb65","parents":["de16a1e065d7f9505df9b2c76b4840b443131e33"],"ref":"refs/changes/35/2335/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1502315347,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1502315376,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1502316206,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1502320838,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}},{"type":"SUBM","value":"1","grantedOn":1502320846,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/build.js","type":"MODIFIED","insertions":23,"deletions":-2},{"file":"test/test_build.js","type":"MODIFIED","insertions":150,"deletions":-30}],"sizeInsertions":173,"sizeDeletions":-32}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}