{"project":"joyent/smartos-live","branch":"master","id":"I6e14949de611ae79803213369bbb89a1ead3e2b6","number":"6263","subject":"OS-5176 vmadm stop and reboot may propagate improper error Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/6263","commitMessage":"OS-5176 vmadm stop and reboot may propagate improper error\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1558021242,"lastUpdated":1558721706,"open":false,"status":"MERGED","comments":[{"timestamp":1558021242,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1558021297,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558028994,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)\n\nMy biggest concern with this change I think is that it means that it\u0027s possible that when zlogin or shutdown fail immediately with a fatal error (the shutdown was not actually triggered), we\u0027ll now wait 2 minutes to timeout before failing instead of failing immediately.\n\nI also wonder if it\u0027d be worth calling out this behavior in the man page?"},{"timestamp":1558037136,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1558037191,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558037333,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(2 comments)\n\nThe zlogin or shutdown failure is possible, but rather unlikely compared to other failures we have been seeing.  Notably, `vmadm stop` does not try to stop a VM if it is already stopped.  Sure there\u0027s a race, but that covers the most likely cause of a zlogin failure.  After re-evaluating a decision to not just halt after a shutdown timeout, I\u0027ve reverted the timeout to 60 seconds.  This only half as bad as waiting 120 seconds, right?"},{"timestamp":1558368876,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Code-Review+1\n\nThe code LGTM. Now you folks reach an agreement regarding the convenience of the change and I\u0027m sold ;-)"},{"timestamp":1558638247,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\nIn chat with joshw where I asked if he had more feedback:\n\n\u003e +0 I haven\u0027t read the new code that carefully, but I\u0027m not going to block it"},{"timestamp":1558698240,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1558721636,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Commit message was updated."},{"timestamp":1558721650,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1558721673,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"},{"timestamp":1558721706,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"4","revision":"009dfe433c8ba38e5df14abb62c25a224f10ba33","parents":["1546b80ce8d5a70455dd94be0073972622a2d37b"],"ref":"refs/changes/63/6263/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1558721650,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558037191,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558368876,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558698240,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1558721672,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":36,"deletions":-16}],"sizeInsertions":45,"sizeDeletions":-23},"patchSets":[{"number":"1","revision":"1fc5fb9b5a68a94ff80d669f92deed90562f3ae6","parents":["4a90933b843370f461433d7ec71ad0538e5302b9"],"ref":"refs/changes/63/6263/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1558021242,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558021297,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":152,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"What\u0027s the reasoning behind increasing this timeout?"},{"file":"src/vm/node_modules/VM.js","line":152,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"debian 9 lx images have some bug that cause systemd-shutdown to sleep for 90 seconds before exiting.  See IMAGE-1172.\n\nI\u0027ve flip-flopped on an earlier decision to force a halt when the shutdown times out and reverted this to 60 seconds.  FWIW, this variable was dead code until I started to use it with this change."},{"file":"src/vm/node_modules/VM.js","line":17508,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"When shutdown fails to actually shutdown the zone, we\u0027ll hit this timeout 2 minutes later now. But the zone will just continue running, correct?"},{"file":"src/vm/node_modules/VM.js","line":17508,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"The zone could continue running or shut down at some unknown time in the future, likely depending on whether the instance is doing something useful with the shutdown request.\n\nPreviously, a zone that had a broken shutdown command could hang here indefinitely.  If someone came along and halted the zone, the zlogin process would likely return 0 and vmadm would go on its merry way.  If someone instead killed vmadm, the zone configuration would not be updated.\n\nAny way you slice it, it\u0027s a bit of a mess.  OS-6950 probably describes the solution.  FWIW, I\u0027ve seen the kvm timeout mentioned in OS-6950 in action.  See OS-7800.  There the timeout is 3 minutes, which feels way too long.\n\nI had thought about just issuing a \"zoneadm halt\" if waitForZoneState times out, but then decided to punt in favor of a more complete solution with OS-6950.  As I was making man page changes, I realized that a forced halt after timeout would be consistent with HVMs.  OS-6950 is still relevant, as this timeout does not help the case where the shutdown command does not have a timely exit."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":15,"deletions":-16}],"sizeInsertions":15,"sizeDeletions":-16},{"number":"2","revision":"6e14949de611ae79803213369bbb89a1ead3e2b6","parents":["4a90933b843370f461433d7ec71ad0538e5302b9"],"ref":"refs/changes/63/6263/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1558037136,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558037191,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558368876,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558698240,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":36,"deletions":-16}],"sizeInsertions":45,"sizeDeletions":-23},{"number":"3","revision":"19f205625630f4e5cf75e311b4710db7e0cc45dd","parents":["4a90933b843370f461433d7ec71ad0538e5302b9"],"ref":"refs/changes/63/6263/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1558721636,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558037191,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558368876,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558698240,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":36,"deletions":-16}],"sizeInsertions":45,"sizeDeletions":-23},{"number":"4","revision":"009dfe433c8ba38e5df14abb62c25a224f10ba33","parents":["1546b80ce8d5a70455dd94be0073972622a2d37b"],"ref":"refs/changes/63/6263/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1558721650,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558037191,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1558368876,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1558698240,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1558721672,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":9,"deletions":-7},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":36,"deletions":-16}],"sizeInsertions":45,"sizeDeletions":-23}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}