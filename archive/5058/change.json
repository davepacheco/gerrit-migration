{"project":"joyent/smartos-live","branch":"master","topic":"OS-7353","id":"I97305065a128d956d7ee9921cc009a6a9194bb2b","number":"5058","subject":"OS-7353 bhyve support for persistent pci slots for disks OS-7004 support adding new disks to bhyve VMs via \u0027vmadm update\u0027 Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Reviewed by: Dylan Yep \u003cdylan.yep@joyent.com\u003e Approved by: Pedro Palazón Candel ","owner":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"url":"https://cr.joyent.us/5058","commitMessage":"OS-7353 bhyve support for persistent pci slots for disks\nOS-7004 support adding new disks to bhyve VMs via \u0027vmadm update\u0027\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nReviewed by: Dylan Yep \u003cdylan.yep@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1542207532,"lastUpdated":1543517875,"open":false,"status":"MERGED","comments":[{"timestamp":1542207532,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 1."},{"timestamp":1542207581,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542208086,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 1: Code-Review-1\n\nin self review; please don\u0027t waste your time yet."},{"timestamp":1542344637,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 2."},{"timestamp":1542344688,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542345412,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2: -Code-Review\n\n(4 comments)"},{"timestamp":1542345452,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Topic set to OS-7353"},{"timestamp":1542385529,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(16 comments)\n\nA lot of things to review for a huge change!"},{"timestamp":1542671221,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(18 comments)\n\nWork on the  illumos-joyent portion of this change refreshed my memory a bit and made some of this a little more complicated in order to keep the slot assignments.  Now using exceptions to make error paths simpler.  Also, \"bus:device:function\", not \"bus:slot:function\" seems to be more in line with proper terminology."},{"timestamp":1542671759,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 3."},{"timestamp":1542671814,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542683607,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 4."},{"timestamp":1542683659,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542719251,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\nI think this also closes https://github.com/joyent/smartos-live/issues/804 ?"},{"timestamp":1542720387,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\n@sjorge - Yes, this should address that issue.  See this comment that I left in an early round.  https://cr.joyent.us/#/c/5058/2/src/vm/node_modules/VM.js@16156"},{"timestamp":1542814198,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(3 comments)\n\nApart of the observation regarding `for p in obj` we already commented through chat, there are couple callback calls I\u0027ve got doubts"},{"timestamp":1542831930,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 5."},{"timestamp":1542831946,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1542831985,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543001249,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5: Code-Review+1\n\n(1 comment)"},{"timestamp":1543386425,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 5:\n\n(8 comments)"},{"timestamp":1543445259,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 6."},{"timestamp":1543445268,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5:\n\n(8 comments)"},{"timestamp":1543445340,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543463476,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 6: Code-Review+1\n\nAhh didn\u0027t realize you already switched the forEach to for loops. I tend to use forEach loops unless I need to \u0027break\u0027 or am writing something where performance is critical enough to sacrifice some readability. With that being said, I think I might be in the minority here on that and if you or Pedro disagree, for loops will certainly still get CR +1 from me."},{"timestamp":1543506058,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1\n\n(1 comment)\n\nLGTM!"},{"timestamp":1543515695,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Uploaded patch set 7."},{"timestamp":1543515762,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1543516378,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1543516652,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1543516962,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 8: Commit message was updated."},{"timestamp":1543517875,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Mike Gerdts"}],"currentPatchSet":{"number":"8","revision":"cdd9eef075b172b336dd78cfa2bbfc2ec7ae771c","parents":["466f00ae497b80384d8aaf99cef47dc358881a2a"],"ref":"refs/changes/58/5058/8","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543516962,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543515762,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543516378,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543516652,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543516652,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1543517875,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":50,"deletions":-12},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":341,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1266,"sizeDeletions":-58},"patchSets":[{"number":"1","revision":"455d7cd9f8424dd437f35d121ac6412e284eab16","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/58/5058/1","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1542207532,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542207581,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1542208086,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":141,"deletions":-16},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":441,"deletions":0}],"sizeInsertions":593,"sizeDeletions":-17},{"number":"2","revision":"3d471b8184729f7d00256801f27e064a967f8a9b","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/58/5058/2","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1542344637,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542344688,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":1302,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"`util.isError` has been deprecated since node v4.0 and, additionally, it\u0027s not very reliable. A good enough approach should be to use `variable instanceof Error` on these cases."},{"file":"src/vm/node_modules/VM.js","line":1302,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Reworked to use an exception."},{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If `assignBhyvePCIslots` is an async function, this call should be inside the `_gatherVM` callback."},{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Reworked with exceptions."},{"file":"src/vm/node_modules/VM.js","line":9295,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I think this one should also be within the `_gatherPayload` callback"},{"file":"src/vm/node_modules/VM.js","line":9295,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Reworked with exceptions."},{"file":"src/vm/node_modules/VM.js","line":9657,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ditto, another callback call out of scope?"},{"file":"src/vm/node_modules/VM.js","line":9657,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Reworked with exceptions."},{"file":"src/vm/node_modules/VM.js","line":13828,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"While taking a fresh look at usr/src/lib/brand/bhyve/boot.c I found:\n\ntypedef enum {\n        PCI_SLOT_HOSTBRIDGE \u003d 0,\n        PCI_SLOT_CD \u003d 3,                /* Windows ahci allows slots 3 - 6 */\n        PCI_SLOT_BOOT_DISK,\n        PCI_SLOT_OTHER_DISKS,\n        PCI_SLOT_NICS,\n        PCI_SLOT_FBUF \u003d 30,\n        PCI_SLOT_LPC \u003d 31,              /* Windows requires lpc in slot 31 */\n} pci_slot_t;\n\nThe boot disk should go into 0:4:0, data disks can go into 0:5:0 and we need to ensure that we don\u0027t occupy slots where other devices may land."},{"file":"src/vm/node_modules/VM.js","line":13855,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Same comment regarding using `util.isError` than before."},{"file":"src/vm/node_modules/VM.js","line":13855,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"parse_pci_slot now thows an error, which the caller can catch"},{"file":"src/vm/node_modules/VM.js","line":13886,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not sure I like this approach. It\u0027s somewhat confusing. I\u0027d prefer to assign a value to the call to `disks.some` instead and, in case that\u0027s true, return the error then."},{"file":"src/vm/node_modules/VM.js","line":13886,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"reworked with exceptions."},{"file":"src/vm/node_modules/VM.js","line":13924,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Same than the above. On this case anyway you should just call `cb(err)` and move ahead. If error is unset that should to it. Otherwise, \"looks like\" you aren\u0027t calling the callback to finish this function."},{"file":"src/vm/node_modules/VM.js","line":13924,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"reworked with exceptions"},{"file":"src/vm/node_modules/VM.js","line":13948,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Same question. Shouldn\u0027t this be inside `_gather_updates`?"},{"file":"src/vm/node_modules/VM.js","line":13948,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"reworked with exceptions"},{"file":"src/vm/node_modules/VM.js","line":14053,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Nice, nice, nice!"},{"file":"src/vm/node_modules/VM.js","line":14053,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":16093,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I will remove this line in the next update."},{"file":"src/vm/node_modules/VM.js","line":16093,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":16156,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This part is OS-7004.  I needed to bring this fix in to test adding of disks."},{"file":"src/vm/node_modules/VM.js","line":17975,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If instead of using `return new Error` you were throwing it here, you could simply use `try/catch` block when this function is called. Which happens to be the only 100% reliable way to know that something is an error, AFAIK."},{"file":"src/vm/node_modules/VM.js","line":17975,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci.js","line":42,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"While editing the Makefile, I realized this file wasn\u0027t in it.  Adding it caused `make check` to emit lots of noise.  Most of the changes here are to fix that.  Then there are other changes like this and lines 45-46 that are just fixes of nits.\n\nI didn\u0027t add a lot of testing of the bounds of pci_slot values to the other test file because this uses shared code and already seems to provide adequate coverage."},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":81,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"In CoaL, the tests in this file take about 3 minutes to run.  Much of that time is waiting for several boots to run the operator script.  If that\u0027s too much time to add, I can probably trim a boot or two without relatively little risk that a botched slot assignment would be missed."},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":264,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"You can, and should, pass `err` to `t.end()`"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":264,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":288,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"This function could use a name, given it\u0027s already within another anonymous function"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":288,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":299,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"This could use a name too."},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":299,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":303,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Hrrrm, shouldn\u0027t this one call `cb2(err)` anyway, since that one will call `cb(err)` below when passing in the results?"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":303,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":689,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Pass `err` to `t.end()`"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":689,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":741,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Pass `err` to `t.end()`"},{"file":"src/vm/tests/test-bhyve-pci_slot.js","line":741,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":275,"deletions":-16},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":744,"deletions":0}],"sizeInsertions":1063,"sizeDeletions":-49},{"number":"3","revision":"8c10777ff1687c94e63ce3b9a78a3dfad95b5195","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/58/5058/3","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1542671759,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542671814,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":338,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1213,"sizeDeletions":-46},{"number":"4","revision":"3d4017334f78906d37a97844ee5aa13939167893","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/58/5058/4","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1542683607,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542683659,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"In general `for prop in object` shouldn\u0027t be used if you can do the same using a simple for loop instead."},{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":13794,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Should this callback invocation be here right at the same scope than `vasync.pipeline`?"},{"file":"src/vm/node_modules/VM.js","line":13794,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I\u0027ve not touched this code entire function (setDockerRestartOpts) or anything that seems related.  If there\u0027s a problem here, let\u0027s take that up in a separate ticket."},{"file":"src/vm/node_modules/VM.js","line":13794,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sounds good, yeah"},{"file":"src/vm/node_modules/VM.js","line":14011,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Don\u0027t wanna call `return` right after?"},{"file":"src/vm/node_modules/VM.js","line":14011,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":349,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1224,"sizeDeletions":-46},{"number":"5","revision":"bb3b296c61682fd8f239efa525e33c03fb47f955","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/58/5058/5","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1542831930,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1542831985,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543001249,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Given that assignments.length is pretty small and you\u0027re not looking to break the loop before iterating through every item, a forEach loop is more idiomatic JS"},{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"ok.  Hopefully Pedro will agree because earlier I flipped all of my array.forEach() loops over to for loops.  This was in response to doing horrible things when I needed a `break`, after which he said:\n\nso for example\nunless it\u0027s really tedious or are very small arrays\nnever use array.forEach\n\nWhich I took to mean that `for` is almost always preferred.  But maybe since this is a \"very small array\" forEach is the right thing.  :shrug:"},{"file":"src/vm/node_modules/VM.js","line":9277,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"What you removed before was your `for p in arr` looping, Mike :D. I\u0027m fine with both, array.length and array.forEach. Anyway, given the performance I\u0027ve been getting recently for sdcadm with arrays of just 10 elements, I\u0027m trying to avoid `forEach` and pretty much all the other array looping methods but for cases where the elements in use are very limited and well known in advance. 6\u0027 lecture about it: https://medium.com/tech-tajawal/loops-performances-in-node-js-9fbccf2d6aa6\n\nHere I\u0027ll be fine with either the array.length approach or array.forEach, both are perfectly valid."},{"file":"src/vm/node_modules/VM.js","line":13851,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Assert that this is an object?"},{"file":"src/vm/node_modules/VM.js","line":13851,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":13866,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Any reason these function names are snake case instead of camel case?"},{"file":"src/vm/node_modules/VM.js","line":13866,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":13909,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"forEach?"},{"file":"src/vm/node_modules/VM.js","line":13909,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":13955,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"forEach?"},{"file":"src/vm/node_modules/VM.js","line":13955,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":14022,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Might be nice as a map function. \n\nvar updates \u003d assignments.map( \n..."},{"file":"src/vm/node_modules/VM.js","line":14022,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/node_modules/VM.js","line":18033,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"jsprim.parseInteger will ensure js integer parsing is slightly less insane \n\nhttps://github.com/joyent/node-jsprim#parseintegerstr-options"},{"file":"src/vm/node_modules/VM.js","line":18033,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"},{"file":"src/vm/tests/test-bhyve-pci.js","line":140,"reviewer":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},"message":"Test name is duplicate of the previous. Without unique test names, nodeunit-plus will only run the duplicate, silently ignoring the first one."},{"file":"src/vm/tests/test-bhyve-pci.js","line":140,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":50,"deletions":-12},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":350,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1275,"sizeDeletions":-58},{"number":"6","revision":"9bfe16e04f257a082add11636c7c25a807288f1e","parents":["87aa89bd1fa57bc910461ca672d3a4b856ed448c"],"ref":"refs/changes/58/5058/6","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543445259,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543445340,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543506058,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543506058,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543463476,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":50,"deletions":-12},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":341,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1266,"sizeDeletions":-58},{"number":"7","revision":"97305065a128d956d7ee9921cc009a6a9194bb2b","parents":["466f00ae497b80384d8aaf99cef47dc358881a2a"],"ref":"refs/changes/58/5058/7","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543515695,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543515762,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543516652,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543516652,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543516378,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":50,"deletions":-12},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":341,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1266,"sizeDeletions":-58},{"number":"8","revision":"cdd9eef075b172b336dd78cfa2bbfc2ec7ae771c","parents":["466f00ae497b80384d8aaf99cef47dc358881a2a"],"ref":"refs/changes/58/5058/8","uploader":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"createdOn":1543516962,"author":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1543515762,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543516652,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1543516652,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1543517875,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1543516378,"by":{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"src/Makefile","type":"MODIFIED","insertions":2,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":50,"deletions":-12},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":341,"deletions":-13},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":9,"deletions":0},{"file":"src/vm/tests/test-bhyve-pci.js","type":"MODIFIED","insertions":33,"deletions":-33},{"file":"src/vm/tests/test-bhyve-pci_slot.js","type":"ADDED","insertions":831,"deletions":0}],"sizeInsertions":1266,"sizeDeletions":-58}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Dylan Yep","email":"dyep49@gmail.com","username":"dyep49"},{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}]}