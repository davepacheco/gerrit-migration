From 307a3dae2edb5952fd4d5ee48154678a8e2575e5 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Fri, 9 Mar 2018 23:50:24 +1030
Subject: [PATCH] TRITON-168 Regex anti-affinity rules fail unexpectedly

---
 lib/machines.js           |  7 ++++++-
 lib/triton-affinity.js    |  2 +-
 test/machines/affinity.js | 13 +++++++++++++
 3 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/lib/machines.js b/lib/machines.js
index f2e3451..a566b9a 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -697,7 +697,12 @@ function getCreateOptions(req) {
             throw new InvalidArgumentError(
                 'cannot specify both "locality" (deprecated) and "affinity"');
         }
-        opts.affinity = params.affinity;
+
+        if (Array.isArray(params.affinity)) {
+            opts.affinity = params.affinity;
+        } else {
+            opts.affinity = [params.affinity];
+        }
     }
 
     Object.keys(pkg).forEach(function (p) {
diff --git a/lib/triton-affinity.js b/lib/triton-affinity.js
index 44c5aa3..7ee9036 100644
--- a/lib/triton-affinity.js
+++ b/lib/triton-affinity.js
@@ -428,7 +428,7 @@ function _vmsFromRule(opts, cb) {
             return;
         }
         opts.vmapi.listVms({
-            fields: 'uuid,alias,internal_metadata,docker',
+            fields: 'uuid,alias,server_uuid,internal_metadata,docker',
             owner_uuid: opts.ownerUuid,
             state: 'active'
         }, {
diff --git a/test/machines/affinity.js b/test/machines/affinity.js
index 5aa9d6b..3fc934b 100644
--- a/test/machines/affinity.js
+++ b/test/machines/affinity.js
@@ -52,6 +52,19 @@ function (suite, client, other, imgUuid, pkgUuid, headnodeUuid, cb) {
     });
 
 
+    // Same as above, but using a regular expression
+    suite.test('CreateMachine with affinity "container==/^' + CONTAINER_PREFIX +
+        '/"', function (t) {
+
+        var args = createArgs('container==/^' + CONTAINER_PREFIX + '/');
+
+        client.post('/my/machines', args, function (err, req, res, body) {
+            t.ok(err, 'VM with false affinity should fail');
+            t.end();
+        });
+    });
+
+
     // This should work: no container with name 'sdccloudapitest_affinity_*'.
     // This behaviour was changed in DAPI-306.
     suite.test('CreateMachine with affinity "container!=' + CONTAINER_PREFIX +
-- 
2.21.0

