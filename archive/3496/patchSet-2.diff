commit 03bb64d93b1fd3c478be5fd75ef33c14136932dd (refs/changes/96/3496/2)
Author: Trent Mick <trentm@gmail.com>
Date:   2018-02-27T11:38:08-08:00 (1 year, 7 months ago)
    
    TRITON-185 add 'server', 'x-request-id', and 'x-server-name' header handling to SAPI

diff --git a/Makefile b/Makefile
index 247685b..48c0103 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
@@ -27,7 +27,7 @@ JS_FILES	:= $(shell ls *.js) $(shell find cmd lib test tools -name '*.js')
 JSL_CONF_NODE	 = tools/jsl.node.conf
 JSL_FILES_NODE   = $(JS_FILES)
 JSSTYLE_FILES	 = $(JS_FILES)
-JSSTYLE_FLAGS    = -o indent=4,doxygen
+JSSTYLE_FLAGS    = -o indent=4,doxygen,unparenthesized-return=0
 SMF_MANIFESTS_IN = smf/manifests/sapi.xml.in
 
 NODE_PREBUILT_VERSION=v4.8.7
diff --git a/lib/server/sapi.js b/lib/server/sapi.js
index 82700d4..dddc6fa 100644
--- a/lib/server/sapi.js
+++ b/lib/server/sapi.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
 /*
@@ -14,13 +14,39 @@
 
 var assert = require('assert-plus');
 var async = require('async');
+var fs = require('fs');
 var http = require('http');
 var https = require('https');
+var os = require('os');
 var restify = require('restify');
 
 var endpoints = require('./endpoints');
 var Model = require('./model');
 
+var VERSION = null;
+var HOSTNAME = os.hostname();
+
+
+// ---- internal helper functions
+
+/**
+ * Returns the current semver version stored in package.json, used for the
+ * "Server" header in responses.
+ *
+ * @return {String} version.
+ */
+function serverVersion() {
+    if (!VERSION) {
+        var pkg = fs.readFileSync(__dirname + '/../../package.json', 'utf8');
+        VERSION = JSON.parse(pkg).version;
+    }
+
+    return VERSION;
+}
+
+
+// ---- SAPI app object
+
 function SAPI(config) {
     assert.object(config.log, 'config.log');
 
@@ -83,7 +109,7 @@ SAPI.prototype.shutdown = function shutdown(cb) {
 
 function createServer(options) {
     var server = restify.createServer({
-        name: 'Services API',
+        name: 'sapi/' + serverVersion(),
         log: options.log,
         version: ['1.0.0', '2.0.0']
     });
@@ -106,6 +132,17 @@ function createServer(options) {
         next();
     });
 
+    // Set stock Triton service headers.
+    server.use(function stdTritonResHeaders(req, res, next) {
+        res.on('header', function onHeader() {
+            res.header('Server', server.name);
+            res.header('x-request-id', req.getId());
+            res.header('x-server-name', HOSTNAME);
+        });
+
+        next();
+    });
+
     server.use(restify.acceptParser(server.acceptable));
     server.use(restify.authorizationParser());
     server.use(restify.dateParser());
