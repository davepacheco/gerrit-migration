{"project":"joyent/illumos-joyent","branch":"master","id":"Ib9b6bff7dba526305121aa318ce898f3c708c8a1","number":"3918","subject":"OS-6925 kmem_dump_size is a corrupting influence Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"url":"https://cr.joyent.us/3918","commitMessage":"OS-6925 kmem_dump_size is a corrupting influence\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1525789657,"lastUpdated":1525881153,"open":false,"status":"MERGED","comments":[{"timestamp":1525789657,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 1."},{"timestamp":1525789659,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit ab01933b35259d5ee33c7e8b9575ac8c5339e37b\n    \n    m\n    \n    commit 80f161bc39c5578f0af5d4cc6276a044f45a38f6\n    \n    m\n    \n    commit 2666248de953d49968d88f6ddb669e0bd7c342ec\n    \n    m\n    \n    commit 60c6c243c26511df33d038971bca9d4755a7c040\n    \n    m\n    \n    commit 7d897f88ce78361a03acf7bda14197f5a314b154\n    \n    m\n    \n    commit 1f40c57070bb326f5f8b28549c2e1cad109269e2\n    \n    m\n    \n    commit f9a3df2f23f4551a90b4ce45776ac42bee5c6fd4\n    \n    m"},{"timestamp":1525794800,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1525795247,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1525795747,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1525805028,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 2."},{"timestamp":1525805037,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 36c583425014035bc64d221e118064b1d15d0d25\n    \n    m"},{"timestamp":1525811544,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1525864771,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 3."},{"timestamp":1525864773,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 8b3c001bbbf1e83417169bbfc9c424f837a298a3\n    \n    m"},{"timestamp":1525874985,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1525880757,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1525880764,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1525880878,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1525880996,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1525880997,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 53c2576b868226804083b0f0b59a375b4fcb6fe2\n    \n    m\n    \n    commit ce1899406958b4c2924734786995d5545b9339c1\n    \n    m\n    \n    commit 7f570a72c0c348972a5d2236de031d60085ec7be\n    \n    m\n    \n    commit baeedf9628b09c5ecbaa77f81b213e5e856d3211\n    \n    m\n    \n    commit 88722c700b463168c576a415199c01f1a27cb20c\n    \n    m\n    \n    commit 1a5285765d5164a46e2f01b10478ad9a89c41d7d\n    \n    m\n    \n    commit 1a281e6e6055fa63d1d7d04d8c1f631af148ea4e\n    \n    m\n    \n    commit 0f32d56e5a2c282e42c19ceee0a3abeeea787790\n    \n    m\n    \n    commit 05c81e621e656793bdb65746c9b3139b249a8ed1\n    \n    m"},{"timestamp":1525881153,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by John Levon"}],"currentPatchSet":{"number":"5","revision":"b9b6bff7dba526305121aa318ce898f3c708c8a1","parents":["2139ceaceb15b2ac9e5998c2fbd0601416fa233b"],"ref":"refs/changes/18/3918/5","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1525880996,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525874985,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525880757,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525880764,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1525881152,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/kmem.c","type":"MODIFIED","insertions":57,"deletions":-35},{"file":"usr/src/uts/common/os/dumpsubr.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/os/kmem.c","type":"MODIFIED","insertions":37,"deletions":-98},{"file":"usr/src/uts/common/sys/kmem_impl.h","type":"MODIFIED","insertions":8,"deletions":-2}],"sizeInsertions":122,"sizeDeletions":-141},"patchSets":[{"number":"1","revision":"f79f23488250904b4d3a76397170839ab3b53168","parents":["1b2c15a7560df76b763b5eebcf9b645296c0234e"],"ref":"refs/changes/18/3918/1","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1525789657,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/os/kmem.c","line":2252,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is there a reason that we are no longer assuming that kmem_dump_start() can be NULL? If size is set to zero, then kmem_alloc will definitely return NULL. It\u0027s not clear to me if all the surrounding code is safe with this reality. It may be worth a comment discussing how that is handled or how it\u0027s safe in this mode. I couldn\u0027t initially see anything that made sure the argument to kmem_dump_init() couldn\u0027t be zero."},{"file":"usr/src/uts/common/os/kmem.c","line":2252,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"In the caller we now use a zero value for dump_kmem_pages as a sentinel for \"not yet initialized\", so we should be sure at this point that size is \u003e 0, if that\u0027s what you mean.\n\nI can add a comment + assert."},{"file":"usr/src/uts/common/os/kmem.c","line":2252,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, I wasn\u0027t 100% sure whether or not that was the only means to someone getting there or if it could be somehow influenced through dumpadm. If that\u0027s the case, then yeah. I think just adding an assert is probably fine."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/kmem.c","type":"MODIFIED","insertions":57,"deletions":-35},{"file":"usr/src/uts/common/os/dumpsubr.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/os/kmem.c","type":"MODIFIED","insertions":34,"deletions":-97},{"file":"usr/src/uts/common/sys/kmem_impl.h","type":"MODIFIED","insertions":8,"deletions":-2}],"sizeInsertions":119,"sizeDeletions":-140},{"number":"2","revision":"8a7d4a7c7f0e8e77583bc48599b6cfc9b62325e4","parents":["1b2c15a7560df76b763b5eebcf9b645296c0234e"],"ref":"refs/changes/18/3918/2","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1525805028,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525811544,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/kmem.c","type":"MODIFIED","insertions":57,"deletions":-35},{"file":"usr/src/uts/common/os/dumpsubr.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/os/kmem.c","type":"MODIFIED","insertions":37,"deletions":-97},{"file":"usr/src/uts/common/sys/kmem_impl.h","type":"MODIFIED","insertions":8,"deletions":-2}],"sizeInsertions":122,"sizeDeletions":-140},{"number":"3","revision":"7878de444d25f0ed90232b537436917866803ccf","parents":["1b2c15a7560df76b763b5eebcf9b645296c0234e"],"ref":"refs/changes/18/3918/3","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1525864771,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525880757,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525880764,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525874985,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/kmem.c","type":"MODIFIED","insertions":57,"deletions":-35},{"file":"usr/src/uts/common/os/dumpsubr.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/os/kmem.c","type":"MODIFIED","insertions":37,"deletions":-98},{"file":"usr/src/uts/common/sys/kmem_impl.h","type":"MODIFIED","insertions":8,"deletions":-2}],"sizeInsertions":122,"sizeDeletions":-141},{"number":"4","revision":"85bac1ab3d2bd42d6ee70c6618809e0984c972ce","parents":["2139ceaceb15b2ac9e5998c2fbd0601416fa233b"],"ref":"refs/changes/18/3918/4","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1525880878,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525880757,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525880764,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525874985,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/kmem.c","type":"MODIFIED","insertions":57,"deletions":-35},{"file":"usr/src/uts/common/os/dumpsubr.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/os/kmem.c","type":"MODIFIED","insertions":37,"deletions":-98},{"file":"usr/src/uts/common/sys/kmem_impl.h","type":"MODIFIED","insertions":8,"deletions":-2}],"sizeInsertions":122,"sizeDeletions":-141},{"number":"5","revision":"b9b6bff7dba526305121aa318ce898f3c708c8a1","parents":["2139ceaceb15b2ac9e5998c2fbd0601416fa233b"],"ref":"refs/changes/18/3918/5","uploader":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"createdOn":1525880996,"author":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525880757,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525880764,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1525874985,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1525881152,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/mdb/common/modules/genunix/kmem.c","type":"MODIFIED","insertions":57,"deletions":-35},{"file":"usr/src/uts/common/os/dumpsubr.c","type":"MODIFIED","insertions":20,"deletions":-6},{"file":"usr/src/uts/common/os/kmem.c","type":"MODIFIED","insertions":37,"deletions":-98},{"file":"usr/src/uts/common/sys/kmem_impl.h","type":"MODIFIED","insertions":8,"deletions":-2}],"sizeInsertions":122,"sizeDeletions":-141}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}]}