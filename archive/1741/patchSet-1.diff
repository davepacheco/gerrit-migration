From 1e449d46f3e44aeb64ab619026e2635d6f282172 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 4 Apr 2017 11:42:09 +0200
Subject: [PATCH] TOOLS-1739 having a vmapi instance on non-headnode can break
 'sdcadm experimental update-other'

---
 lib/cli/do_update_other.js | 17 ++++++++++-------
 1 file changed, 10 insertions(+), 7 deletions(-)

diff --git a/lib/cli/do_update_other.js b/lib/cli/do_update_other.js
index 7e33b65..f019750 100644
--- a/lib/cli/do_update_other.js
+++ b/lib/cli/do_update_other.js
@@ -643,13 +643,16 @@ function do_update_other(subcmd, opts, args, cb) {
                     var curImg = parts[parts.length - 2];
                     if (curImg >= '20141030T234934Z') {
                         progress('Running VMAPI migrations');
-                        var argv = [
-                            '/usr/sbin/zlogin',
-                            vmapi.uuid,
-                            'cd /opt/smartdc/vmapi && ./build/node/bin/node ' +
-                                'tools/migrations/add-docker-index.js'
-                        ];
-                        common.spawnRun({argv: argv, log: log}, next);
+                        var cmd = 'cd /opt/smartdc/vmapi && ' +
+                            './build/node/bin/node ' +
+                            'tools/migrations/add-docker-index.js';
+
+                        common.execRemote({
+                            server: vmapi.server_uuid,
+                            vm: vmapi.uuid,
+                            cmd: cmd,
+                            log: log
+                        }, next);
                     } else {
                         return next();
                     }
-- 
2.21.0

