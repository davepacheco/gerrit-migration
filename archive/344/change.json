{"project":"joyent/sdc-cn-agent","branch":"master","id":"Ied5e9c64725aa25b5bf3997b350574ab3872abc5","number":"344","subject":"AGENT-1031 cn-agent incorrectly using platform modules","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/344","commitMessage":"AGENT-1031 cn-agent incorrectly using platform modules\n","createdOn":1472117639,"lastUpdated":1472165202,"open":false,"status":"MERGED","comments":[{"timestamp":1472117639,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1472117672,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472143765,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nFollowing  making the changes I:\n- ensure VMAPI tests continue to pass\n- tried out machine_proc (uses procread.js)\n- ensure CNAPI tests continue to pass"},{"timestamp":1472150752,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(4 comments)"},{"timestamp":1472161767,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1472162105,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1472162147,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1472163858,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1472165198,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1472165202,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"2","revision":"ed5e9c64725aa25b5bf3997b350574ab3872abc5","parents":["9180b53c80fbe7f8c43850ca9ccbdd3e42368866"],"ref":"refs/changes/44/344/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472162105,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472162147,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472163858,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472163858,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472165198,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472165198,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1472165202,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"bin/docker-build.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"node_modules/procread.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"smf/manifests/cn-agent-update.xml.in","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"smf/manifests/cn-agent.xml.in","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"test/runtests","type":"MODIFIED","insertions":2,"deletions":-4}],"sizeInsertions":5,"sizeDeletions":-14},"patchSets":[{"number":"1","revision":"0dfca12f1137b91d3d2c47e9045d5b7ac1f8446f","parents":["9180b53c80fbe7f8c43850ca9ccbdd3e42368866"],"ref":"refs/changes/44/344/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472117639,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472117672,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: this isn\u0027t the title text of the ticket"},{"file":"bin/docker-build.js","line":31,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Note here that this is changing from the node-zfs in the platform (quite old):\n\n```\ncommit 2c119a265781873d104008b341eb3fb8c6d66d56\nAuthor: Bill Pijewski \u003cwdp@joyent.com\u003e\nDate:   Tue Feb 26 15:02:56 2013 -0800\n\n    OS-1954 node_zfs timeout too low\n```\n\nto this one (still a little old, but with all the latest *code* changes to node-zfs.git at least):\n\n\n```\ncommit 657a90d9424c45066e3e0919dfe9b34f5636e0e9\nAuthor: Orlando Vazquez \u003covazquez@gmail.com\u003e\nDate:   Tue Aug 5 22:40:25 2014 +0000\n\n    AGENT-787: fix package.json invalid JSON\n```\n\nThat is this diff: https://github.com/joyent/node-zfs/compare/2c119a265781873d104008b341eb3fb8c6d66d56...657a90d9424c45066e3e0919dfe9b34f5636e0e9\n\nThis is a *newer* node-zfs, so presumably this is an improvement. :)"},{"file":"bin/docker-build.js","line":31,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Yeah, any changes in node-zfs should be backwards compatible, but good thought. Todd did me a favour and checked docker build with that change and reported it was ok."},{"file":"test/runtests","line":43,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps let\u0027s change that to cn-agent"},{"file":"test/runtests","line":43,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Gah."},{"file":"test/runtests","line":106,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The globe-theatre script just calls:\n\n```\n/opt/smartdc/agents/lib/node_modules/cn-agent/test/runtests\n```\n\nSo I don\u0027t think the relpath will work here.\n\nPerhaps change this to: `$TOP/node/bin/node`.\n\nCan you please try running the globe-theatre `./bin/nightly-test-cn-agent coal` against your coal (run that command from your Mac)?"},{"file":"test/runtests","line":106,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"On line 99 we chdir into $TOP, but that\u0027s okay, better to be more explicit.\n\nWill do."},{"file":"test/runtests","line":106,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh, duh on the \"cd $TOP\". Thanks."},{"file":"test/runtests","line":106,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"`./bin/nightly-test-cn-agent coal` looks good."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"bin/docker-build.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"node_modules/procread.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"smf/manifests/cn-agent-update.xml.in","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"smf/manifests/cn-agent.xml.in","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"test/runtests","type":"MODIFIED","insertions":1,"deletions":-3}],"sizeInsertions":2,"sizeDeletions":-12},{"number":"2","revision":"ed5e9c64725aa25b5bf3997b350574ab3872abc5","parents":["9180b53c80fbe7f8c43850ca9ccbdd3e42368866"],"ref":"refs/changes/44/344/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1472162105,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472162147,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472163858,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472163858,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1472165198,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1472165198,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}},{"type":"SUBM","value":"1","grantedOn":1472165202,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"bin/docker-build.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/apm.js","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"node_modules/procread.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"smf/manifests/cn-agent-update.xml.in","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"smf/manifests/cn-agent.xml.in","type":"MODIFIED","insertions":0,"deletions":-2},{"file":"test/runtests","type":"MODIFIED","insertions":2,"deletions":-4}],"sizeInsertions":5,"sizeDeletions":-14}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}