From 0dfca12f1137b91d3d2c47e9045d5b7ac1f8446f Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Wed, 24 Aug 2016 16:52:25 -0700
Subject: [PATCH] AGENT-1031 remove references to platform node_modules

---
 Makefile                             | 1 -
 bin/docker-build.js                  | 2 +-
 lib/apm.js                           | 2 --
 node_modules/procread.js             | 1 -
 smf/manifests/cn-agent-update.xml.in | 2 --
 smf/manifests/cn-agent.xml.in        | 2 --
 test/runtests                        | 4 +---
 7 files changed, 2 insertions(+), 12 deletions(-)

diff --git a/Makefile b/Makefile
index 7fed324..330a51e 100644
--- a/Makefile
+++ b/Makefile
@@ -37,7 +37,6 @@ JSSTYLE_FLAGS =		-o indent=4,doxygen,unparenthesized-return=0
 # doesn't know about (@@ENABLED@@)
 # SMF_MANIFESTS_IN = smf/manifests/cn-agent.xml.in
 
-# Should be the same version as the platform's /usr/node/bin/node.
 NODE_PREBUILT_VERSION =	v0.10.26
 NODE_PREBUILT_TAG =	gz
 ifeq ($(shell uname -s),SunOS)
diff --git a/bin/docker-build.js b/bin/docker-build.js
index 6923653..6b7555e 100644
--- a/bin/docker-build.js
+++ b/bin/docker-build.js
@@ -28,7 +28,7 @@ var IMGAPI = require('sdc-clients').IMGAPI;
 var mkdirp = require('mkdirp');
 var rimraf = require('rimraf');
 var sprintf = require('sprintf').sprintf;
-var zfs = require('/usr/node/node_modules/zfs.js').zfs;
+var zfs = require('zfs').zfs;
 
 var LineStream = require('../lib/linestream');
 var smartDcConfig = require('../lib/task_agent/smartdc-config');
diff --git a/lib/apm.js b/lib/apm.js
index 3c0605a..9feb04a 100755
--- a/lib/apm.js
+++ b/lib/apm.js
@@ -1,5 +1,3 @@
-#!/usr/node/bin/node
-
 /*
  *
  * apm.js - Ain't a Package Manager
diff --git a/node_modules/procread.js b/node_modules/procread.js
index ae0733d..8de36ee 100755
--- a/node_modules/procread.js
+++ b/node_modules/procread.js
@@ -1,4 +1,3 @@
-#!/usr/node/bin/node
 /*
  * This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
diff --git a/smf/manifests/cn-agent-update.xml.in b/smf/manifests/cn-agent-update.xml.in
index 1c440f4..66f68c0 100644
--- a/smf/manifests/cn-agent-update.xml.in
+++ b/smf/manifests/cn-agent-update.xml.in
@@ -32,8 +32,6 @@
       <method_context>
         <method_credential user="root" group="staff"/>
         <method_environment>
-          <!-- TODO: NODE_PATH wanted here? -->
-          <envvar name="NODE_PATH" value="/usr/node_modules:/usr/vm/node_modules:/usr/img/node_modules"/>
           <envvar name="PATH" value="@@PREFIX@@/bin:/usr/local/bin:/opt/local/bin:/usr/bin:/usr/sbin:/bin"/>
           <envvar name="PORT" value="@@PORT@@"/>
         </method_environment>
diff --git a/smf/manifests/cn-agent.xml.in b/smf/manifests/cn-agent.xml.in
index 2ccc9f5..d0624ef 100644
--- a/smf/manifests/cn-agent.xml.in
+++ b/smf/manifests/cn-agent.xml.in
@@ -32,8 +32,6 @@
       <method_context>
         <method_credential user="root" group="staff"/>
         <method_environment>
-          <!-- TODO: NODE_PATH wanted here? -->
-          <envvar name="NODE_PATH" value="/usr/node_modules:/usr/vm/node_modules:/usr/img/node_modules"/>
           <envvar name="PATH" value="@@PREFIX@@/bin:/usr/local/bin:/opt/local/bin:/usr/bin:/usr/sbin:/bin"/>
           <envvar name="PORT" value="@@PORT@@"/>
         </method_environment>
diff --git a/test/runtests b/test/runtests
index 8de5e7f..6757136 100755
--- a/test/runtests
+++ b/test/runtests
@@ -96,8 +96,6 @@ mkdir -p $OUTPUT_DIR
 
 #---- start tests
 
-export NODE_PATH=/usr/node_modules:/usr/vm/node_modules:/usr/img/node_modules
-
 cd $TOP
 
 test_files=$(ls -1 test/*.test.js)
@@ -105,7 +103,7 @@ if [[ -n "$opt_test_pattern" ]]; then
     test_files=$(echo "$test_files" | grep "$opt_test_pattern" || true)
     echo "# Running filtered set of test files: $test_files"
 fi
-/usr/node/bin/node ./node_modules/nodeunit/bin/nodeunit $test_files --reporter=tap \
+./node/bin/node ./node_modules/nodeunit/bin/nodeunit $test_files --reporter=tap \
     | tee $OUTPUT_DIR/cn-agent.tap
 
 
-- 
2.21.0

