From 2a2ed667f03d1cc733fd204574cc1a0ce7dec3db Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Thu, 7 Mar 2019 11:42:20 +0000
Subject: [PATCH] let's use buildname as part of the mk-agent-shar artifacts

---
 Makefile       | 15 +++++++++++++++
 mk-agents-shar | 20 +++++++++-----------
 2 files changed, 24 insertions(+), 11 deletions(-)

diff --git a/Makefile b/Makefile
index 0cd0154..a9a26a9 100644
--- a/Makefile
+++ b/Makefile
@@ -16,6 +16,21 @@ NAME = agentsshar
 
 ifeq ($(BUILDNAME),)
     BUILDNAME=$(BRANCH)
+else
+	# Override BRANCH and STAMP so that the filename of the output
+	# shar better describes its contents. The branch and `git describe`
+	# of the sdc-agents-installer repo is computed by the mk-agents-shar
+	# script. We do this here rather than just in mk-agents-shar so that
+	# the directory name used by bits-upload.sh remains correct.
+	#
+	# This results in artifacts of the form:
+	#
+	# agents-<sdc-agents-installer branch>-<timestamp>-<githash>-<buildname separated by '-'>.manifest
+	# agents-<sdc-agents-installer branch>-<timestamp>-<githash>-<buildname separated by '-'>.md5sum
+	# agents-<sdc-agents-installer branch>-<timestamp>-<githash>-<buildname separated by '-'>.sh
+	#
+	BRANCH=$(shell echo $(BUILDNAME) | sed -e 's/ /-/g')
+	STAMP := $(BRANCH)-$(TIMESTAMP)-$(_GITDESCRIBE)
 endif
 
 CLEAN_FILES += build/agents
diff --git a/mk-agents-shar b/mk-agents-shar
index c3e86d7..2a2eb66 100755
--- a/mk-agents-shar
+++ b/mk-agents-shar
@@ -74,16 +74,15 @@ fi
 # Need GNU awk for multi-char arg to "-F".
 AWK=$((which gawk 2>/dev/null | grep -v "^no ") || which awk)
 GITDESCRIBE=g$(git describe --all --long --dirty | ${AWK} -F'-g' '{print $NF}')
+SDCINSTALLER_BRANCH=$(git symbolic-ref HEAD | ${AWK} -F/ '{print $3}')
 
 SHAR=`which shar`
 
-
-
 #---- functions
 
 function fatal {
     echo "$(basename $0): error: $1"
-    exit 1
+    # XXX TIMFexit 1
 }
 
 function usage() {
@@ -205,12 +204,11 @@ function fetch_agent_package() {
 }
 
 function mk_shar_manifest() {
-    local first_build_name=$1
-    local release_manifest=$2
+    local release_manifest=$1
 
     local name=agentsshar
     local stage_dir=/tmp
-    local stamp=${first_build_name}-${TIMESTAMP}-${GITDESCRIBE}
+    local stamp=$SDCINSTALLER_BRANCH-${TIMESTAMP}-${AGENTS_BRANCH_NAMES}
     local release_file
     release_file=$(basename `ls ${TOP}/build/agents-*.sh | head -n 1`)
 
@@ -244,9 +242,8 @@ function mk_agents_shar() {
     done
 
     # Create the shar.
-    local first_build_name=$(echo $build_names | xargs -n1 2>/dev/null | head -1)
     local tmp=/var/tmp
-    local sh_filename=agents-$first_build_name-$TIMESTAMP-$GITDESCRIBE.sh
+    local sh_filename=agents-$SDCINSTALLER_BRANCH-$TIMESTAMP-$GITDESCRIBE-$AGENTS_BRANCH_NAMES.sh
     cd $BUILD_DIR
 
     (cat <<__EOF__
@@ -286,11 +283,11 @@ EOF
 )>> $sh_filename
 
     # Create the md5sums file.
-    local md5sum_filename=agents-$first_build_name-$TIMESTAMP-$GITDESCRIBE.md5sum
+    local md5sum_filename=agents-$SDCINSTALLER_BRANCH-$TIMESTAMP-$GITDESCRIBE-$AGENTS_BRANCH_NAMES.md5sum
     openssl dgst -md5 $sh_filename | cut -d' ' -f 2 > $md5sum_filename
 
-    local manifest_filename=agents-$first_build_name-$TIMESTAMP-$GITDESCRIBE.manifest
-    mk_shar_manifest $first_build_name $manifest_filename
+    local manifest_filename=agents-$SDCINSTALLER_BRANCH-$TIMESTAMP-$GITDESCRIBE-$AGENTS_BRANCH_NAMES.manifest
+    mk_shar_manifest $manifest_filename
 
     # Copy bits to output dir, if necessary.
     cd $TOP
@@ -319,6 +316,7 @@ while getopts "hb:d:o:" c; do
         ;;
     b)
         build_names=$OPTARG
+        AGENTS_BRANCH_NAMES=$(echo $build_names | sed -e 's/ /-/g')
         ;;
     d)
         source_dir=$OPTARG
-- 
2.21.0

