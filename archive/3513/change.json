{"project":"joyent/illumos-joyent","branch":"master","id":"I887132348b2882cd572106fe2dede45955e3a623","number":"3513","subject":"OS-6681 modernize viona driver Reviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/3513","commitMessage":"OS-6681 modernize viona driver\nReviewed by: Hans Rosenfeld \u003chans.rosenfeld@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1519787151,"lastUpdated":1519844647,"open":false,"status":"MERGED","comments":[{"timestamp":1519787151,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1519793499,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2."},{"timestamp":1519793591,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\nThis change is largely composed of illumos-native code and should receive full scrutiny."},{"timestamp":1519828852,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(7 comments)\n\nThis looks good to me, I just had a few small things. One other comment; it might be good to update all of the copyright years to 2018, I noticed a mix of 2017 and 2018 in this changeset."},{"timestamp":1519831598,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3."},{"timestamp":1519831612,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1519834489,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1519836032,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\nChecked with a full DEBUG build, which ran clean."},{"timestamp":1519836974,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1519837491,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 2:\n\n(22 comments)\n\nStill working on viona.c"},{"timestamp":1519838533,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1519839829,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Code-Review+1\n\nSince none of my comments are likely to cause problems for initial integration, I\u0027m happy to give my CR +1 now.  We should consider my feedback for future cleanup work."},{"timestamp":1519842482,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4."},{"timestamp":1519842536,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4:\n\n(20 comments)"},{"timestamp":1519842971,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1519843045,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4: Code-Review+1\n\nThe latest update still looks good to me."},{"timestamp":1519843280,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 5: Patch Set 4 was rebased."},{"timestamp":1519843424,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1519844220,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 6:\n\nDEBUG build with the update ran clean, a smoke test of viona with the changes seemed fine too."},{"timestamp":1519844613,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1519844647,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"6","revision":"887132348b2882cd572106fe2dede45955e3a623","parents":["9c1f0b4865ff20abeb270b5e73b7372aa4f49fea"],"ref":"refs/changes/13/3513/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519843424,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519842971,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519843045,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1519844613,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1519844647,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":293,"deletions":-179},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1439,"deletions":-774},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1801,"sizeDeletions":-970},"patchSets":[{"number":"1","revision":"058d706d6d687c42f1e737e6a72de597b256f467","parents":["db8da1c3372e95fc1a7c50de538e5fc00dcf39bf"],"ref":"refs/changes/13/3513/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519787151,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":32,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":294,"deletions":-178},{"file":"usr/src/cmd/devfsadm/i386/Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1435,"deletions":-771},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1796,"sizeDeletions":-966},{"number":"2","revision":"8ad97539cd8469ec704fcea8a6ad3c160cefb4ab","parents":["db8da1c3372e95fc1a7c50de538e5fc00dcf39bf"],"ref":"refs/changes/13/3513/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519793499,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/bhyve/pci_emul.h","line":26,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"joyent copyright?"},{"file":"usr/src/cmd/bhyve/pci_emul.h","line":26,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":92,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"It seems odd to define these values here, when equivalent values (which are used by the kernel when these values are passed via ioctl()) are defined in sys/viona_io.h, which is included by this file."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":92,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It\u0027s crufty, but I\u0027d rather clean it up when we add ctlq functionality"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":119,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I think a comment is needed for this.  Where can one find the values that may be in this mask (VIONIA_S_HOSTCAPS)?  Is this a mask of the allowed or disallowed faatures?"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":119,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This was largely an internal feature for my own development use, FYI"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":167,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I have a general question about the use of WPRINTF and fprintf(stderr, in this file. Both are used in different places. I am not sure if that should be consistent or if it matters. Maybe its just fine since zhyve sends both stdout and stderr to the same log file."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":167,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"A follow-up which cleans that up would be fine.  I don\u0027t have strong opinions about changing it now, though."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":197,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"could be declared in block starting at 213"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":197,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":217,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"can this change on each iteration of the loop?  If not, perhaps it should be moved out of the loop."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":217,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It could be, AFAIK.  During normal operation, this is not on the hot path (all the interrupt stuff is done in-kernel), so I\u0027m not worried about perf."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":255,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"probably check for \u003e\u003d 0 too"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":255,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m going to leave this for a later cleanup of that logic (where we should get rid of all the unsigned nonsense)"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":319,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"WPRINTF(), here and elsewhere"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":335,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Since this is a bitmask, probably better to force it to base 16.  Check endptr."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":335,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I don\u0027t mind sharp edges on this dev-only feature for the moment."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":346,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"It is quite reasonable for someone to think that they could pass a value of \"8k\".  This will happily accept it and set the value to 8.  Best to check endptr and generate an error message if *endptr !\u003d \u0027\\0\u0027."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":346,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Like feature_mask, this was meant as developer-only for the time being.  I didn\u0027t add robustness because I don\u0027t expect folks to use it until it\u0027s more well documented."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":351,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Is this VRING_MAX_LEN?  If so, it should probably move to a header so that it can be used here and in viona.c."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":355,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"A future compiler will probably complain this isn\u0027t ffsl"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":355,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe.  It\u0027s not incorrect thanks to the ring size bounds."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":515,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"There are no external callers and getting here is a logic error elsewhere.  assert() or at least WPRINTF()."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":515,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"will change to assert()"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":523,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Why copy the structure?"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":523,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"concurrency paranoia"},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":602,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"maybe add \"not supported\""},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":602,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"We\u0027re not advertising this (CTLQ) capability to the guest yet, so they shouldn\u0027t be writing this value."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":605,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"It\u0027s an error to get here, right?  Maybe an DPRINTF() to draw attention would be good."},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","line":605,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"It would be a guest error for any other value here.  I\u0027m fine with silence for now."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":107,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"I\u0027m not sure what this capability is, but I don\u0027t see any place that viona makes use of it.  It does seem as though an ASSERT() can be tripped if it\u0027s not set.  Does viona need special handling if this is disabled by  features_mask?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":107,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This is a host capability that we advertise to the guest.  Admittedly we\u0027re not checking to see if they set it before we go on to handle indirect descriptors, if they are passed to us, but that\u0027s not a big deal IMO"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":180,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This should be broken up into state and flags (separate variables in viona_vring).  A state of VRS_INIT | VRS_RUN is invalid, but VRS_RUN | VRS_REQ_STOP is valid.  Confusing."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":180,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m going to leave that update for later."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":186,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"This is used around a lot of cv_wait_sig(), but it\u0027s not clear to me that an exiting process will cause a signal that will wake up the cv_wait().  Theres a note about such cases in convar(9F).  Is this a concern?  Should the cv_wait_sig() calls be cv_timedwait_sig() with a timeout of several seconds/minutes to prevent indefinite hangs that force reboots?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":186,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I spent a while reading through the proc_exit() stuff and am fairly convinced our behavior around CVs and signals is adequate to shutdown in a timely manner."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":193,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Changing this to \u0027enum viona_ring_state\u0027 will help mdb decode the value.  It will also help future developers understand what values are expected."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":496,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"is this getting cleaned up in a later CR?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":496,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"One doesn\u0027t exist presently.  I\u0027d like to see us protect this (and vmm) with a privilege, in addition to the sdev protections, but nothing has been done there yet."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":575,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"need mutex_exit"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":575,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":580,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"need mutex_exit"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":580,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":989,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"EINVAL seems more appropriate, as all valid states are already covered.  It could be an indication that state \u003d\u003d VRS_INIT|VRS_RUN, which would be invalid."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":989,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m going to stick with this to contrast with the above case of invalid params."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1097,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"VRING_NEED_BAIL"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1097,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1180,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"VRING_NEED_BAIL"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1180,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1331,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Do we need a copy of it, or would a pointer be enough?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1331,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"This references memory from the guest, so the copy here is very intentional to prevent the guest from changing the entry after we do permissions/length/etc checks on it.  I will update with a comment."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1913,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Are we leaving this here for now?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1913,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Yup"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1922,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"same q"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1922,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":32,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":4,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":294,"deletions":-179},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1434,"deletions":-774},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1794,"sizeDeletions":-970},{"number":"3","revision":"29073d0fdb5753c3b1c83c1c28161953c57e26a0","parents":["db8da1c3372e95fc1a7c50de538e5fc00dcf39bf"],"ref":"refs/changes/13/3513/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519831598,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519834489,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519836974,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519839829,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1412,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Why return anything when the only caller, which is new in our code, casts it to void?"},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","line":1412,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027d rather have it available for now."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":32,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":294,"deletions":-179},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1435,"deletions":-774},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1798,"sizeDeletions":-970},{"number":"4","revision":"fcb810675407fb5309c40f20172c9a7098e695bd","parents":["db8da1c3372e95fc1a7c50de538e5fc00dcf39bf"],"ref":"refs/changes/13/3513/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519842482,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519843045,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519842971,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":32,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":293,"deletions":-179},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1439,"deletions":-774},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1801,"sizeDeletions":-970},{"number":"5","revision":"5a5b9612fff174ad78231f0970eaa71e239bb6e4","parents":["9c1f0b4865ff20abeb270b5e73b7372aa4f49fea"],"ref":"refs/changes/13/3513/5","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519843280,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519843045,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519842971,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":32,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":293,"deletions":-179},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1439,"deletions":-774},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1801,"sizeDeletions":-970},{"number":"6","revision":"887132348b2882cd572106fe2dede45955e3a623","parents":["9c1f0b4865ff20abeb270b5e73b7372aa4f49fea"],"ref":"refs/changes/13/3513/6","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1519843424,"author":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519843045,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1519844613,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1519844647,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1519842971,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/bhyve/Makefile.com","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.c","type":"MODIFIED","insertions":5,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_emul.h","type":"MODIFIED","insertions":7,"deletions":0},{"file":"usr/src/cmd/bhyve/pci_virtio_viona.c","type":"MODIFIED","insertions":293,"deletions":-179},{"file":"usr/src/cmd/devfsadm/i386/misc_link_i386.c","type":"MODIFIED","insertions":6,"deletions":0},{"file":"usr/src/uts/i86pc/Makefile.i86pc","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":1439,"deletions":-774},{"file":"usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c","type":"MODIFIED","insertions":11,"deletions":0},{"file":"usr/src/uts/i86pc/sys/viona_io.h","type":"MODIFIED","insertions":33,"deletions":-16},{"file":"usr/src/uts/i86pc/sys/vmm_drv.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/i86pc/viona/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":1801,"sizeDeletions":-970}],"allReviewers":[{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}]}