{"project":"joyent/illumos-joyent","branch":"master","id":"Ib164e87ae56fcf64dbfbba90ada71d50466bece5","number":"2857","subject":"OS-6407 lx: move mmap and mremap support in-kernel Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Approved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e","owner":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"url":"https://cr.joyent.us/2857","commitMessage":"OS-6407 lx: move mmap and mremap support in-kernel\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nApproved by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\n","createdOn":1508934698,"lastUpdated":1510330258,"open":false,"status":"MERGED","comments":[{"timestamp":1508934698,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 1."},{"timestamp":1508936273,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\nMost of this is a straightforward move of the original user-level code into the kernel. The two key changes are the new lx_search_as() function in place of using /proc, and the lx_u2u_copy() function to handle relocating an anonymous mapping."},{"timestamp":1509072016,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1509110074,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1509110082,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 2."},{"timestamp":1509114900,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2: Code-Review+1\n\nThanks. Will you leave testing notes here or in the bug report (so I know where to look)?"},{"timestamp":1509134305,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1509139983,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(1 comment)\n\nAs a high-level observation, I was approaching this as a move of the existing code into the kernel with a pretty direct translation, but it is true that there might be opportunities to rewrite the original implementation now that it\u0027s in the kernel. I\u0027ll spend some time exploring that and then update the CR with the additional changes that seem to make sense."},{"timestamp":1509145364,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\nAs a quick POC, I wrote a micro-benchmark which does 2M mremap calls to grow/shrink the same mapping. Using the current code it averages just over 1second for 10 runs. I then built a platform which disables the cache check and just searches the address space each time. It averages just over 1.7seconds for 10 runs. This doesn\u0027t account for any rewrite of the address space search, but it does seem like the cache is still worthwhile."},{"timestamp":1509218198,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1509383497,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1509383519,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 3."},{"timestamp":1509388787,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)\n\nOne nit, otherwise ship it."},{"timestamp":1509984880,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3:\n\n(12 comments)"},{"timestamp":1510097847,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 3:\n\n(13 comments)"},{"timestamp":1510097892,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 4."},{"timestamp":1510106244,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4: Code-Review+1"},{"timestamp":1510250349,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\ntesting notes in ticket"},{"timestamp":1510274012,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 4: Code-Review+1\n\n(7 comments)\n\nFound a bunch of minor nits on a closer pass.  Up to you on if you want to include \u0027em or not."},{"timestamp":1510316274,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 4:\n\n(7 comments)\n\nI went ahead and addressed all but one of these now."},{"timestamp":1510316285,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 5."},{"timestamp":1510316853,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 5:\n\nAfter these changes, I successfully re-ran all of the tests outlined in the ticket."},{"timestamp":1510329546,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Code-Review+1\n\nThanks for addressing Patrick\u0027s comments, and ship it."},{"timestamp":1510329552,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1510329560,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1510329566,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1510330157,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 6: Patch Set 5 was rebased."},{"timestamp":1510330242,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1510330258,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jerry Jelinek"}],"currentPatchSet":{"number":"7","revision":"b164e87ae56fcf64dbfbba90ada71d50466bece5","parents":["7dd996f96ad1fff4ba9219b2ff8108c83c73e67e"],"ref":"refs/changes/57/2857/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1510330242,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329546,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329560,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329566,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1510330258,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":797,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":825,"sizeDeletions":-692},"patchSets":[{"number":"1","revision":"be82655d5c8c0fbf9f65763e8c91d46d1ff345cc","parents":["c78733726279ff79f248a5ce19150a4e28d1dd7f"],"ref":"refs/changes/57/2857/1","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1508934698,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":397,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"OMG these comments alone are worth this change."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":397,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I can\u0027t take credit for these since they were in the original user-land code :-)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":447,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"What about 32-bit kernels where size_t is 32-bit?  Or do we not care/support this?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":447,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"It is true that we don\u0027t care about 32-bit kernels. Also, this code has not changed from when it was is user-land."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":453,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Overflow check?  If off * PAGESIZE overflows off64_t?  Or will it never do so because off_t is always 32-bit?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":453,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This code has not changed from user-land and also, yes, off_t seems to be documented as a 32-bit page count."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":807,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Can\u0027t you just say \"m \u003d *mapin;\"?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":807,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Sure. Changed."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":951,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"It looks like there\u0027s a BUNCH of stuff here solely dependent on whether or not LX_MREMAP_FIXED is set:  we check for LX_REMAP_FIXED 4 times, when we could check once.  I don\u0027t know... maybe something like:\n\n/* Check old_addr page-alignment \u0026 new_size \u003d\u003d 0... */\n\n/* We check and setup things differently for FIXED vs. not */\nif (flags \u0026 LX_MREMAP_FIXED) {\n     if (!(flags \u0026 LX_MREMAP_MAYMOVE))\n          return (set_errno(EINVAL));\n     if ((new_addr \u0026 (PAGESIZE - 1)) !\u003d 0)\n          return (set_errno(EINVAL));\n     mflags |\u003d MAP_FIXED;\n} else {\n     if (new_size \u003d\u003d old_size)\n          return (old_addr);\n     new_addr \u003d NULL;\n}\n\nCould just be me, though."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":951,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This was all just pulled in from the original user-land code, but your suggestion is cleaner so I rewrote it that way."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1028,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Is this the case where the anonymous mapping cache is overfull?  Or can we reach here some other way?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1028,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Either the cache is full or this is the first time we\u0027re mremapping the anonymous segment, so it is not yet in the cache."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1028,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":800,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":828,"sizeDeletions":-692},{"number":"2","revision":"27045de99880cbe14ec8e3f8da5449be57877231","parents":["e0c6772393ee04366494174e8e95ba7bcc980ed7"],"ref":"refs/changes/57/2857/2","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1509110082,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509114900,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":368,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: An \u0027lx_\u0027 prefix would probably be nice to see when this is in the stacktrace."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":368,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":411,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Aliased with the definition above (and the assignment below)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":411,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"fixed"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":454,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Overflow detection?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":454,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"I asked him about this already.  Apparently off_t is always 32-bit, and therefore won\u0027t overflow into the 64-bit off64_t that gets passed in to {,lx_}mmap_common() (I like your naming suggestion for that function)."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":454,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I added a comment to try to clarify this."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":655,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why are we walking the address space as opposed to using as_segat (and making use of the built-in avl tree)?\n\nFurthermore it might be nice to quantify the cost of searching the AS given the access we have in the kernel.  It might be unnecessary to maintain the mremap cache."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":655,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I rewrote the code to use as_segat and split this up into two functions as a result. To summarize the performance testing I did:\n\nwith cache 1.07sec (same for old and new which makes sense since cached).\nold code without cache  1.75sec\nnew code without cache 1.32 sec\n\nSo I think the the cache is still valuable and I\u0027ve kept it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":700,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"While the pagelock should prevent this from faulting, on a node with SMAP, it\u0027s going to blow up.  Something like a narrowly scoped on_fault guard would probably be adequate to  fix that."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":700,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"good catch, fixed"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":798,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":826,"sizeDeletions":-692},{"number":"3","revision":"b08d9f47eeb1747d4759b5277de57b7da3c1164e","parents":["99e0ea6f8add1cf97455a780f409f34b33c9d6d0"],"ref":"refs/changes/57/2857/3","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1509383519,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1509388787,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":518,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"What\u0027s the reason behind the TRYENTER loop versus a \"forced\" ENTER?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":518,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Inherited from proc code I based this on, but it doesn\u0027t seem necessary here, so I changed it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":637,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"uint_t"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":637,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":651,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: The way this check is phrased (with \u0027addr\u0027 on opposite sides for the two clauses) is a little confusing.  (Although it does, on close inspection, appear correct)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":651,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"same as pre-existing code so I left it as-is"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":663,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"uint_t"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":663,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":702,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Extra sentence for pedants:\n\n\"retvaddr\" will not be set if this function returns B_FALSE."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":702,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"No longer applies, superseded by other CR changes."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":769,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason in particular to use the point-style reference vs direct to the \u0027m\u0027 struct?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":769,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I was trying to keep this relatively aligned with our pre-existing code to that CR/comparison would be easier. No other reason so I changed it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":867,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"awkward phrasing, maybe \"bottom of the acceptable range\" or something?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":867,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"This was Bryan\u0027s comment from our pre-existing code, but given next item I rewrote it."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":876,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m a little confused about the point of this search.  Is this something that the as_gap* functions cannot accomplish for us?  (granted the locking could get a little weird there)"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":876,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Only Bryan could explain his thinking here, I was just trying keep aligned with what we already had. However, I agree this is not very obvious and that as_gap seems like a reasonable alternative, so I rewrote the code to use that."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":930,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"PAGEOFFSET"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":930,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":942,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"PAGEOFFSET"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":942,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1075,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"What\u0027s the story behind this?  on_fault() grouchiness from the compiler?  That portion (the on_fault/bcopy/no_fault) could be extract out of the loop with the address calculation to smooth over that issue, maybe?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1075,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Our ancient version of gcc has real problems with any kind of longjmp handling. I have already tried every permutation I can think of to try to get it to shut up, without success, so I finally settled for suppressing the check in the narrowest way that will compile on our version of gcc."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1107,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: cache this for brevity?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1107,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1117,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Would \u0027void *\u0027 be more appropriate for these?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1117,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":844,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":872,"sizeDeletions":-692},{"number":"4","revision":"dab737e03b3a8fcb386a54071cf7095885a99e58","parents":["7354012d871a98cfeba6ab962af30b16d0455e5f"],"ref":"refs/changes/57/2857/4","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1510097892,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510274012,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510106244,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"comments":[{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":540,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: Some uintptr_t casts below would probably satiate the compiler/linter here."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":540,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":544,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: PAGEOFFSET"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":544,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":560,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: P2ROUNDUP might be cleaner?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":560,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I looked at this a bit, but in the end I felt this seemed clearer to me, so I left it as-is."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":683,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: If you initialize \u0027oldest\u0027 to UINT64_MAX (or l_remap_anoncache_generation, for that matter), this half of the comparison can be skipped."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":683,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"good suggestion, done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":770,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: The previous size (and MREMAP_FIXED) comparison ensures (I believe) that the desired size here will be greater than the old size.  Perhaps an ASSERT() would make it easier to grok that."},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":770,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1050,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: PAGEOFFSET, like the rest"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1050,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"done"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1053,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"nit: maybe VERIFY that these are both \u003c USERLIMIT?"},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","line":1053,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"I went with an ASSERT instead since we should be able to depend on mmap being correct here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":795,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":823,"sizeDeletions":-692},{"number":"5","revision":"27cb957302a1ee2060311f05b94a8cddbb5718fc","parents":["7354012d871a98cfeba6ab962af30b16d0455e5f"],"ref":"refs/changes/57/2857/5","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1510316285,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329560,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329546,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329566,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":797,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":825,"sizeDeletions":-692},{"number":"6","revision":"ea1a51e4bd2a86f9d66fb82845033c7d6a6c579d","parents":["7dd996f96ad1fff4ba9219b2ff8108c83c73e67e"],"ref":"refs/changes/57/2857/6","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1510330157,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329560,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329546,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329566,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":797,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":825,"sizeDeletions":-692},{"number":"7","revision":"b164e87ae56fcf64dbfbba90ada71d50466bece5","parents":["7dd996f96ad1fff4ba9219b2ff8108c83c73e67e"],"ref":"refs/changes/57/2857/7","uploader":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"createdOn":1510330242,"author":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1510330258,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329552,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329560,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510329546,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510329566,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/lx/lx_brand/Makefile.com","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"usr/src/lib/brand/lx/lx_brand/common/lx_brand.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/lib/brand/lx/lx_brand/common/mem.c","type":"DELETED","insertions":0,"deletions":-664},{"file":"usr/src/lib/brand/lx/lx_brand/sys/lx_syscall.h","type":"MODIFIED","insertions":0,"deletions":-6},{"file":"usr/src/lib/brand/lx/testing/ltp_skiplist","type":"MODIFIED","insertions":1,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/os/lx_syscall.c","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"usr/src/uts/common/brand/lx/sys/lx_brand.h","type":"MODIFIED","insertions":14,"deletions":0},{"file":"usr/src/uts/common/brand/lx/sys/lx_syscalls.h","type":"MODIFIED","insertions":3,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_mem.c","type":"MODIFIED","insertions":797,"deletions":0},{"file":"usr/src/uts/common/brand/lx/syscall/lx_miscsys.c","type":"MODIFIED","insertions":0,"deletions":-6}],"sizeInsertions":825,"sizeDeletions":-692}],"allReviewers":[{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}]}