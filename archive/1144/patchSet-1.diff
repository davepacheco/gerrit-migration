From 355167c0bca6aa022558ce7b002745512886ca8a Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 19 Dec 2016 11:20:10 -0800
Subject: [PATCH] DOCKER-987 Update docker build to allow container package
 selection from a label

---
 bin/docker-build.js | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/bin/docker-build.js b/bin/docker-build.js
index 8071b6d..187bad6 100644
--- a/bin/docker-build.js
+++ b/bin/docker-build.js
@@ -203,6 +203,14 @@ function sendMessage(message, opts, callback) {
 }
 
 
+/**
+ * Remove joyent specific labels that we don't want inside the built image.
+ */
+function sanatizeLabels(labels) {
+    delete labels['com.joyent.package'];
+}
+
+
 function downloadContext(opts) {
     var log = opts.log;
     var socket = opts.contextSocket;
@@ -364,13 +372,18 @@ function buildFromContext(opts, callback) {
         }
     });
 
+    // Sanitize labels.
+    var labels = JSON.parse(opts.payload.labels || '{}');
+    sanatizeLabels(labels);
+    labels = JSON.stringify(labels);
+
     var buildOpts = {
         buildargs: opts.payload.buildargs,
         commandType: 'build',
         containerRootDir: path.join('/zones', opts.uuid, 'root'),
         contextFilepath: opts.contextFilepath,
         dockerfile: opts.payload.dockerfile,
-        labels: opts.payload.labels,
+        labels: labels,
         suppressSuccessMsg: true,  // Stop the 'Build successful: ' message.
         existingImages: opts.payload.allDockerImages,
         log: opts.log,
@@ -655,6 +668,13 @@ function commitImage(opts, callback) {
                 if (opts.payload.comment) {
                     img.comment = opts.payload.comment;
                 }
+                // Sanatize labels.
+                if (image.config && image.config.Labels) {
+                    sanatizeLabels(image.config.Labels);
+                }
+                if (image.container_config && image.container_config.Labels) {
+                    sanatizeLabels(image.container_config.Labels);
+                }
                 cb();
             },
             function importImages(cb) {
-- 
2.21.0

