{"project":"joyent/sdc-cnapi","branch":"master","id":"Iff590f904d19cfcaaefdb6f18ab9c82dac97812e","number":"2694","subject":"CNAPI-722 TaskWait request can miss task finish event and timeout even though task completed Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/2694","commitMessage":"CNAPI-722 TaskWait request can miss task finish event and timeout even though task completed\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1506716781,"lastUpdated":1507913105,"open":false,"status":"MERGED","comments":[{"timestamp":1506716781,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1506716783,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 0c8706d1f9e022034e61ebc52a6f34206a4dc5f9\n    \n    Cache task execution results in case we don\u0027t start waiting in time"},{"timestamp":1506716815,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1506720500,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1506720501,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 8de846423ccfb77732b95a6a57dd8d5332d712fc\n    \n    commit new test"},{"timestamp":1506720550,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507658180,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1507710380,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 3."},{"timestamp":1507710381,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 9f488c418c05d50dfda5906427ff3f3cb71221ac\n    \n    Address Julien\u0027s feedback"},{"timestamp":1507710413,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507743665,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)"},{"timestamp":1507760161,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 4."},{"timestamp":1507760162,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 97249e78df759701fa8009095dbb08263fc7b23d\n    \n    grammar\n    \n    commit 1b4fe7dc2697c7f05711a59cfa464b8376359cd5\n    \n    Address Julien\u0027s feedback\n    \n    commit f7e3949fbfa666418e04b9af32cc082c63831d78\n    \n    commit new test\n    \n    commit 24bf8d011e105c457afcade8b1d97de0d2652ff5\n    \n    Cache task execution results in case we don\u0027t start waiting in time"},{"timestamp":1507760200,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507760793,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1507913099,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1507913105,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"5","revision":"ff590f904d19cfcaaefdb6f18ab9c82dac97812e","parents":["6e83bc4b4a1e87ace5ab808a0b5a28cbf2b0821c"],"ref":"refs/changes/94/2694/5","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1507913099,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507760200,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507760793,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507760793,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1507913105,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":58,"deletions":-11},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"test/api/test-tasks.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-14},"patchSets":[{"number":"1","revision":"8879965c416f4e217f60b195a6c390535ed81302","parents":["1b8ea8127be7bb5045418bf7436e790f31bd00ee"],"ref":"refs/changes/94/2694/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1506716781,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506716815,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":56,"deletions":-11},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":4,"deletions":-3}],"sizeInsertions":60,"sizeDeletions":-14},{"number":"2","revision":"b7197a3c26b99a2e9098836d7065efcd1536d0e6","parents":["1b8ea8127be7bb5045418bf7436e790f31bd00ee"],"ref":"refs/changes/94/2694/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1506720500,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506720550,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":1364,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"We might want to unref() that timer instance so that it doesn\u0027t hold the loop open when everything else (including the actual HTTP server) is closed."},{"file":"test/api/test-tasks.js","line":95,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we add a comment mentioning that this test was added as part of CNAPI-722, but that however we never managed to reproduce that problem with this test, and we decided to keep it anyway because it doesn\u0027t hurt?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":56,"deletions":-11},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"test/api/test-tasks.js","type":"MODIFIED","insertions":41,"deletions":0}],"sizeInsertions":101,"sizeDeletions":-14},{"number":"3","revision":"a4bb4be1384cd388ae5483b80ab7b96eb6a35066","parents":["1b8ea8127be7bb5045418bf7436e790f31bd00ee"],"ref":"refs/changes/94/2694/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1507710380,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507710413,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507743665,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"test/api/test-tasks.js","line":99,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"useful ensure -\u003e useful to ensure."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":58,"deletions":-11},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"test/api/test-tasks.js","type":"MODIFIED","insertions":48,"deletions":0}],"sizeInsertions":110,"sizeDeletions":-14},{"number":"4","revision":"72879f2510e0688d694b9d8f1d9a1e0f3dba2d09","parents":["6e83bc4b4a1e87ace5ab808a0b5a28cbf2b0821c"],"ref":"refs/changes/94/2694/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1507760161,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507760200,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507760793,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507760793,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":58,"deletions":-11},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"test/api/test-tasks.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-14},{"number":"5","revision":"ff590f904d19cfcaaefdb6f18ab9c82dac97812e","parents":["6e83bc4b4a1e87ace5ab808a0b5a28cbf2b0821c"],"ref":"refs/changes/94/2694/5","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1507913099,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507760200,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1507760793,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1507760793,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1507913105,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":58,"deletions":-11},{"file":"lib/endpoints/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"test/api/test-tasks.js","type":"MODIFIED","insertions":49,"deletions":0}],"sizeInsertions":111,"sizeDeletions":-14}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}