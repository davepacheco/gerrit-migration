From 0d2e51ded1f6a27ad81596b224063d062cd4cba9 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Fri, 10 May 2019 12:44:22 -0700
Subject: [PATCH] TRITON-1662 setup-prometheus.sh's loose package selection
 broken by packages with brand=bhyve

---
 setup-grafana.sh    | 9 ++++++++-
 setup-prometheus.sh | 7 ++++++-
 2 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/setup-grafana.sh b/setup-grafana.sh
index f09ede0..724de51 100755
--- a/setup-grafana.sh
+++ b/setup-grafana.sh
@@ -69,7 +69,14 @@ headnode_uuid=\$(sysinfo | json UUID)
 admin_uuid=\$(sdc-useradm get admin | json uuid)
 admin_network_uuid=\$(sdc-napi /networks?name=admin | json -H 0.uuid)
 external_network_uuid=\$(sdc-napi /networks?name=external | json -H 0.uuid)
-package=\$(sdc-papi /packages | json -Ha uuid max_physical_memory | sort -n -k 2 \
+
+# Find package
+# - Exclude packages with "brand" set to limit to a provision of a particular
+#   brand (e.g. brand=bhyve ones that have shown up recently for flexible
+#   disk support).
+package=\$(sdc-papi /packages \
+    | json -c '!this.brand' -Ha uuid max_physical_memory \
+    | sort -n -k 2 \
     | while read uuid mem; do
 
     # Find the first one with at least ${MIN_MEMORY}
diff --git a/setup-prometheus.sh b/setup-prometheus.sh
index a9f1ad8..1d5bc79 100755
--- a/setup-prometheus.sh
+++ b/setup-prometheus.sh
@@ -83,7 +83,12 @@ network_uuid=\$(vmadm get \$(vmadm lookup alias=~^cmon | head -1) | json nics.1.
 admin_network_uuid=\$(sdc-napi /networks?name=admin | json -H 0.uuid)
 
 # Find package
-package=\$(sdc-papi /packages | json -Ha uuid max_physical_memory | sort -n -k 2 \
+# - Exclude packages with "brand" set to limit to a provision of a particular
+#   brand (e.g. brand=bhyve ones that have shown up recently for flexible
+#   disk support).
+package=\$(sdc-papi /packages \
+    | json -c '!this.brand' -Ha uuid max_physical_memory \
+    | sort -n -k 2 \
     | while read uuid mem; do
 
     # Find the first one with at least ${MIN_MEMORY}
-- 
2.21.0

