{"project":"joyent/node-cueball","branch":"master","id":"I2419ebf63f989d0701cc5ee9108899f6d11b803a","number":"781","subject":"joyent/node-cueball#14 leaked event handler warning on node \u003e\u003d4.x Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/781","commitMessage":"joyent/node-cueball#14 leaked event handler warning on node \u003e\u003d4.x\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1477438481,"lastUpdated":1477519717,"open":false,"status":"MERGED","comments":[{"timestamp":1477438481,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1477438623,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1477516323,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1477516663,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1477516942,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1477517258,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1477517310,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1477517384,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1477519716,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1477519717,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"2","revision":"2419ebf63f989d0701cc5ee9108899f6d11b803a","parents":["d4e5a330148217cee662f7dc186ec1417bf65907"],"ref":"refs/changes/81/781/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1477517258,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477517310,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477517384,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477519716,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1477519717,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":38,"deletions":-10}],"sizeInsertions":38,"sizeDeletions":-10},"patchSets":[{"number":"1","revision":"fd2f34fe617db4d564f76e07a54f9e3dc31adb07","parents":["d4e5a330148217cee662f7dc186ec1417bf65907"],"ref":"refs/changes/81/781/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1477438481,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477438623,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/connection-fsm.js","line":373,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be filtering out the node debugging handler here? Or is it okay to keep it here? Since it won\u0027t be counted among the newCount/oldCount values there.\n\nWhere does g come from?"},{"file":"lib/connection-fsm.js","line":373,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I\u0027ve gone back and forth a few times on whether to filter it out here or not. On the one hand, it could be confusing that the number of things won\u0027t always match the count it actually used to decide if it leaked. On the other hang, if there\u0027s an issue with the filter, this will make it obvious and leave evidence in the logs rather than it disappearing... I don\u0027t know.\n\nThe node EventEmitter code when you call ev.once(\u0027thing\u0027, function) actually works by calling ev.on(\u0027thing\u0027, g) where \u0027g\u0027 is a locally created function in events.js that upon being called once, removes itself from listeners and sets a flag. It\u0027s been called \u0027g\u0027 in all node versions currently released, and since this is a specific workaround for this issue, I don\u0027t want to simply ignore any function with a property named \u0027listener\u0027. If I could here, I would make it check that the function came specifically from events.js in node, but alas the only information v8 will give me is the name and the fact that it has a .listener -- that\u0027s as specific as I can be. I don\u0027t want to have a real user handler be leaked here and be falsely ignored."},{"file":"lib/connection-fsm.js","line":373,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"OK, thanks for clarifying that. I think it\u0027d help immensely if a comment was here explaining where \u0027g\u0027 comes from and why it\u0027s there.\n\nOtherwise, the reason it\u0027s being shown and not filtered seems reasonable. We should probably have it be accurate. As it looks like we\u0027re not actually emitting the number."},{"file":"lib/connection-fsm.js","line":530,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Where does g come from?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":27,"deletions":-10}],"sizeInsertions":27,"sizeDeletions":-10},{"number":"2","revision":"2419ebf63f989d0701cc5ee9108899f6d11b803a","parents":["d4e5a330148217cee662f7dc186ec1417bf65907"],"ref":"refs/changes/81/781/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1477517258,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1477517310,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1477519716,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1477519717,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1477517384,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/connection-fsm.js","type":"MODIFIED","insertions":38,"deletions":-10}],"sizeInsertions":38,"sizeDeletions":-10}],"allReviewers":[{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}