From 99b4534c0c662495ab9cac2f5e574fa86f391b77 Mon Sep 17 00:00:00 2001
From: dyep49 <dyep49@gmail.com>
Date: Fri, 15 Jun 2018 12:59:41 -0700
Subject: [PATCH] TRITON-489 Add metricPorts metadata to IMGAPI for cmon-agent
 Reviewed by: Trent Mick <trentm@gmail.com> Approved by: Trent Mick
 <trentm@gmail.com>

---
 CHANGES.md    | 3 +++
 boot/setup.sh | 5 ++++-
 package.json  | 4 ++--
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 20db701..b2c6e2a 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -1,5 +1,8 @@
 # IMGAPI changelog
 
+## 4.3.1
+- TRITON-489 Add metricPort metadata to IMGAPI for cmon-agent
+
 ## 4.3.0
 
 - TRITON-178 Add support for image creation with bhyve brand (requires platform
diff --git a/boot/setup.sh b/boot/setup.sh
index 8f1fb0c..a9b6fb2 100755
--- a/boot/setup.sh
+++ b/boot/setup.sh
@@ -7,7 +7,7 @@
 #
 
 #
-# Copyright (c) 2014, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
@@ -50,6 +50,9 @@ sdc_log_rotation_add registrar /var/svc/log/*registrar*.log 1g
 sdc_log_rotation_add $role /var/svc/log/*$role*.log 1g
 sdc_log_rotation_setup_end
 
+# Add metadata for cmon-agent discovery
+mdata-put metricPorts 8881
+
 # All done, run boilerplate end-of-setup
 sdc_setup_complete
 
diff --git a/package.json b/package.json
index ebd267e..470d91b 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "imgapi",
   "description": "Image API to manage images for SDC 7",
-  "version": "4.3.0",
+  "version": "4.3.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -40,7 +40,7 @@
     "sshpk": "1.13.0",
     "through2": "2.0.3",
     "trace-event": "1.2.0",
-    "triton-metrics": "0.1.0",
+    "triton-metrics": "0.1.1",
     "ufds": "1.2.0",
     "uuid": "2.0.2",
     "vasync": "1.6.3",
-- 
2.21.0

