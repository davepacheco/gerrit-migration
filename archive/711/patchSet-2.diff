From e65dacfad2358694d3ea6b9ff0ce152ba792f8ca Mon Sep 17 00:00:00 2001
From: David Pacheco <dap@joyent.com>
Date: Mon, 17 Oct 2016 10:14:08 -0700
Subject: [PATCH] MANTA-3005 muskie should adopt moray v2

---
 lib/medusa/connector.js | 6 +-----
 lib/picker.js           | 6 +-----
 package.json            | 2 +-
 3 files changed, 3 insertions(+), 11 deletions(-)

diff --git a/lib/medusa/connector.js b/lib/medusa/connector.js
index 546cd69..bc71d6b 100644
--- a/lib/medusa/connector.js
+++ b/lib/medusa/connector.js
@@ -51,13 +51,9 @@ function MedusaConnector(options) {
     self.inactivityTimeout = options.inactivityTimeout || 30000;
     self.watershed = new Watershed();
     self.moray = moray.createClient({
+        unwrapErrors: true,
         log: options.log,
         connectTimeout: self.connectTimeout,
-        reconnect: true,
-        retry: { // try to reconnect forever
-            maxTimeout: 30000,
-            retries: Infinity
-        },
         host: options.moray.host,
         port: options.moray.port
     });
diff --git a/lib/picker.js b/lib/picker.js
index 1965fc7..cb982a1 100644
--- a/lib/picker.js
+++ b/lib/picker.js
@@ -314,13 +314,9 @@ function Picker(opts) {
     var self = this;
 
     this.client = moray.createClient({
+        unwrapErrors: true,
         log: opts.log,
         connectTimeout: opts.connectTimeout,
-        reconnect: true,
-        retry: {
-            maxTimeout: 30000,
-            retries: Infinity
-        },
         url: opts.url
     });
     this.connectTimeout = opts.connectTimeout || 1000;
diff --git a/package.json b/package.json
index eee7f26..1558f1c 100644
--- a/package.json
+++ b/package.json
@@ -28,7 +28,7 @@
         "mahi": "2.0.1",
         "marlin": "git+ssh://git@github.com:joyent/manta-marlin.git#master",
         "mime": "1.2.11",
-        "moray": "git+ssh://git@github.com:joyent/node-moray.git#fd5781bc25a9bfe2ba82167664639753fb9f0ca5",
+        "moray": "^2.0.0",
         "once": "1.3.0",
         "restify": "2.6.3",
         "vasync": "1.4.3",
-- 
2.21.0

