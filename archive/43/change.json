{"project":"joyent/sdcadm","branch":"master","id":"I0b6367a90e59810500faa0352f44d28f9f9fb6fb","number":"43","subject":"TOOLS-1336 sdcadm should also update USB keys Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/43","commitMessage":"TOOLS-1336 sdcadm should also update USB keys\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1467994622,"lastUpdated":1468567304,"open":false,"status":"MERGED","comments":[{"timestamp":1467994622,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1468017616,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1: Code-Review-1\n\n(29 comments)\n\nHi Pedro,\n\nI\u0027ve taken a look, and added some feedback!\n\nCheers."},{"timestamp":1468240803,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1468256646,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nEr... may we not include details on the commit below the top paragraph dictated by https://github.com/joyent/eng/blob/master/docs/index.md#commit-comments ?\n\nE.g.:\n\n```\nPROJECT-123 the ticket title\nReviewed By: Bob\nPossibly-Other-Commit-Metadata: blah\n\n...some prose details on the commit...\n```"},{"timestamp":1468258069,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1468258405,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3:\n\n\u003e Er... may we not include details on the commit below the top\n \u003e paragraph dictated by https://github.com/joyent/eng/blob/master/docs/index.md#commit-comments\n \u003e ?\n \u003e \n \u003e E.g.:\n \u003e \n \u003e ```\n \u003e PROJECT-123 the ticket title\n \u003e Reviewed By: Bob\n \u003e Possibly-Other-Commit-Metadata: blah\n \u003e \n \u003e ...some prose details on the commit...\n \u003e ```\n\nThe prose really belongs in either the ticket itself, if it\u0027s analysis; or in the source in the repository (in comments or documentation) if it describes the functioning of the system or constraints on implementation.\n\nWith respect to \"Possibly-Other-Commit-Metadata\", it\u0027s conceivable we could add more things to the expected format, but I\u0027d prefer we not just add random one-off things."},{"timestamp":1468275070,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 3: Code-Review-1\n\n(11 comments)\n\nI took a look at the updates, and I think we\u0027re nearly ready to ship here.  Just a few more things:"},{"timestamp":1468324291,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1468389622,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4: Code-Review+1\n\nAlright, it looks ready to ship!  What\u0027s the test plan for this change?"},{"timestamp":1468402192,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1468419544,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(39 comments)\n\n\u003e Alright, it looks ready to ship!  What\u0027s the test plan for this\n \u003e change?\n\nUnless we agree into including some of the staging setups as part of our \"usual cycle\", this will be limited to:\n- Push changes to sdcadm master\n- Wait for nightly to run all setup jobs and then manually test gz-tools update\n- Test straight into east-3b\n\nOn this case, testing in nightly will not provide much more information than doing at my local setup (HN+CN), specially trying to run the installer with a concurrency small enough to see the process complete in more than a single batch of servers.\n\nI was thinking that the sdcadm tests would already cover the changes made for this issue but, given there are zero tests for `update-gz-tools` I\u0027ll add those to cover not only this change but the whole subcmd"},{"timestamp":1468419628,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n\u003e Uploaded patch set 5.\n\nNote this just removed the old update_cn_tools function (using the script at /usbkey). The bad thing about these CR tools is that you pay attention only to what you changed, not to what you should have changed or even more, removed"},{"timestamp":1468427308,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nJosh, is there a ticket to deprecate and remove update_cn_tools after this?"},{"timestamp":1468427373,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n\u003e Josh, is there a ticket to deprecate and remove update_cn_tools\n \u003e after this?\n\nNot that I know, Trent"},{"timestamp":1468427424,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nGiven that the commit message has no details... and there isn\u0027t a plan/overview of the change to sdcadm in the ticket, I\u0027m not really sure what is being changed. Can a plan be added to the ticket?"},{"timestamp":1468427479,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n\u003e Given that the commit message has no details... and there isn\u0027t a\n \u003e plan/overview of the change to sdcadm in the ticket, I\u0027m not really\n \u003e sure what is being changed. Can a plan be added to the ticket?\n\nDefinitely, I\u0027ll add it now"},{"timestamp":1468431094,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 5: Code-Review+1\n\n\u003e \u003e Alright, it looks ready to ship!  What\u0027s the test plan for this\n \u003e \u003e change?\n \u003e Unless we agree into including some of the staging setups as part\n \u003e of our \"usual cycle\", this will be limited to:\n \u003e - Push changes to sdcadm master\n \u003e - Wait for nightly to run all setup jobs and then manually test\n \u003e gz-tools update\n \u003e - Test straight into east-3b\n\nWell, pushing changes to \"master\" is definitely not a step in a test plan.\n\nA change like this can definitely be tested pretty easily in Staging.  If you push a TOOLS-1336 branch and build it with Jenkins, you could deploy that new \"sdcadm\" in \"staging-1\" (which has 3 CNs).  You could then test the change there.\n\n \u003e On this case, testing in nightly will not provide much more\n \u003e information than doing at my local setup (HN+CN), specially trying\n \u003e to run the installer with a concurrency small enough to see the\n \u003e process complete in more than a single batch of servers.\n\nIs your compute node a VMware instance, or a real host?  There are some subtle differences between what we do for a faux USB drive in VMware and what a real host has available.\n\nDid you verify that \"sdc-usbkey update\" runs, and that the contents of the USB key were actually updated?\n\n \u003e \u003e Uploaded patch set 5.\n \u003e Note this just removed the old update_cn_tools function (using the\n \u003e script at /usbkey). The bad thing about these CR tools is that you\n \u003e pay attention only to what you changed, not to what you should have\n \u003e changed or even more, removed\n\nThis is more the job of a linting tool, run via \"make check\".  When I worked on TOOLS-1459 recently I was using \"jshint\" to find unreferenced code and variables.  Cody is working on getting an \"eslint\" configuration together that does everything we have traditionally gotten from \"javascriptlint\" and more, and we can work on evaluating that soon.  That should definitely help avoid leaving dead code around.\n\n \u003e Josh, is there a ticket to deprecate and remove update_cn_tools\n \u003e after this?\n\nI have just filed HEAD-2312 to cover this.\n\n \u003e Can I assume this means that we\u0027re also expected to modify JIRA issue titles to make them sightly more meaningful when required?. For example, what about a commit message for TOOLS-1046 saying \"sdcadm hung up on me\"?\n\nYes, I often clean up the text in an issue title to trim it down or make it more on point.\n\n \u003e Also, I assume this requirement applies strictly to the first line and we can continue using lines after the first blank for explanatory notes when appropriate, correct?\n\nNo, the commit message section of the engineering guide describes the entire contents of the commit message."},{"timestamp":1468433417,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n\u003e \u003e \u003e Alright, it looks ready to ship!  What\u0027s the test plan for this\n \u003e \u003e \u003e change?\n \u003e \u003e Unless we agree into including some of the staging setups as part\n \u003e \u003e of our \"usual cycle\", this will be limited to:\n \u003e \u003e - Push changes to sdcadm master\n \u003e \u003e - Wait for nightly to run all setup jobs and then manually test\n \u003e \u003e gz-tools update\n \u003e \u003e - Test straight into east-3b\n \u003e \n \u003e Well, pushing changes to \"master\" is definitely not a step in a\n \u003e test plan.\n \u003e \n \u003e A change like this can definitely be tested pretty easily in\n \u003e Staging.  If you push a TOOLS-1336 branch and build it with\n \u003e Jenkins, you could deploy that new \"sdcadm\" in \"staging-1\" (which\n \u003e has 3 CNs).  You could then test the change there.\n \u003e \n\nSold!\n\n \u003e \u003e On this case, testing in nightly will not provide much more\n \u003e \u003e information than doing at my local setup (HN+CN), specially\n \u003e trying\n \u003e \u003e to run the installer with a concurrency small enough to see the\n \u003e \u003e process complete in more than a single batch of servers.\n \u003e \n \u003e Is your compute node a VMware instance, or a real host?  There are\n \u003e some subtle differences between what we do for a faux USB drive in\n \u003e VMware and what a real host has available.\n \u003e \n\nNo, it\u0027s everything VMWare. Good point\n\n \u003e Did you verify that \"sdc-usbkey update\" runs, and that the contents\n \u003e of the USB key were actually updated?\n \u003e \n\nI verified that the sdc-usbkey command run and returned an exit status of 0.\nThe contents of the USB key are updated into my COAL\u0027s headnode, but my\nCN errors with `no pcfs devices found` which I assume it\u0027s due to being\na VMWare image or too old, or maybe both.\n\n \u003e \u003e \u003e Uploaded patch set 5.\n \u003e \u003e Note this just removed the old update_cn_tools function (using\n \u003e the\n \u003e \u003e script at /usbkey). The bad thing about these CR tools is that\n \u003e you\n \u003e \u003e pay attention only to what you changed, not to what you should\n \u003e have\n \u003e \u003e changed or even more, removed\n \u003e \n \u003e This is more the job of a linting tool, run via \"make check\".  When\n \u003e I worked on TOOLS-1459 recently I was using \"jshint\" to find\n \u003e unreferenced code and variables.  Cody is working on getting an\n \u003e \"eslint\" configuration together that does everything we have\n \u003e traditionally gotten from \"javascriptlint\" and more, and we can\n \u003e work on evaluating that soon.  That should definitely help avoid\n \u003e leaving dead code around.\n \u003e \n\nLooking forward to have it available!\n\n \u003e \u003e Josh, is there a ticket to deprecate and remove update_cn_tools\n \u003e \u003e after this?\n \u003e \n \u003e I have just filed HEAD-2312 to cover this.\n \u003e \n \u003e \u003e Can I assume this means that we\u0027re also expected to modify JIRA\n \u003e issue titles to make them sightly more meaningful when required?.\n \u003e For example, what about a commit message for TOOLS-1046 saying\n \u003e \"sdcadm hung up on me\"?\n \u003e \n \u003e Yes, I often clean up the text in an issue title to trim it down or\n \u003e make it more on point.\n \u003e \n \u003e \u003e Also, I assume this requirement applies strictly to the first\n \u003e line and we can continue using lines after the first blank for\n \u003e explanatory notes when appropriate, correct?\n \u003e \n \u003e No, the commit message section of the engineering guide describes\n \u003e the entire contents of the commit message.\n\nAll this means that we\u0027re trusting more our ticket system (JIRA) than our\nSCM (git). I\u0027m not really sure if that\u0027s how I feel about it. To me is a little\nbit like source code comments.\n\nMaybe it\u0027s just b/c I\u0027ve got the feeling that it\u0027s easy to find things into\nrepository than digging into JIRA searches but, anyway, that\u0027s a discussion\nfor some other place than this tiny Gerrit box :-)"},{"timestamp":1468434393,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1468495849,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n\u003e Uploaded patch set 6.\n\nI\u0027ve just added the successful results of running this into staging1 to the JIRA issue. Looks like we\u0027re good to go. Any last objection?"},{"timestamp":1468566725,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6: Code-Review+2"},{"timestamp":1468567304,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"6","revision":"0b6367a90e59810500faa0352f44d28f9f9fb6fb","parents":["c68c437f3135a00570d11d24853ec53a2e5234c6"],"ref":"refs/changes/43/43/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1468434393,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468566725,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1468567303,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":27,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":279,"deletions":-18},{"file":"lib/ur.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/update-gz-tools.test.js","type":"ADDED","insertions":110,"deletions":0}],"sizeInsertions":431,"sizeDeletions":-21},"patchSets":[{"number":"1","revision":"a101b0ddc1ec51f7a4efa69c9c03914650ac1a83","parents":["b786ee8926076728dbbd01a9ffdaba32776f947e"],"ref":"refs/changes/43/43/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1467994622,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1468017616,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"comments":[{"file":"/COMMIT_MSG","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"The commit message should match up with what\u0027s in the Joyent Engineering Guide[1].  It ought to match the synopsis of the ticket, and not contain superfluous characters or additional descriptive lines.  For example, for this ticket, I would expect the commit message to be:\n\n  TOOLS-1336 sdcadm should also update USB keys\n  Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n\n[1]: https://github.com/joyent/eng/blob/master/docs/index.md#commit-comments"},{"file":"/COMMIT_MSG","line":0,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Can I assume this means that we\u0027re also expected to modify JIRA issue titles to make them sightly more meaningful when required?. For example, what about a commit message for TOOLS-1046 saying \"sdcadm hung up on me\"?\n\nAlso, I assume this requirement applies strictly to the first line and we can continue using lines after the first blank for explanatory notes when appropriate, correct?"},{"file":"lib/cli/do_update_gz_tools.js","line":8,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Update to\n\n    Copyright 2016 Joyent, Inc."},{"file":"lib/cli/do_update_gz_tools.js","line":8,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/cli/do_update_gz_tools.js","line":51,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"You should make sure that \"updateGzTools()\" has a type assertion for this new parameter.  I would probably also convert it to \"common.assertStrictOptions()\" if it is not using that already."},{"file":"lib/cli/do_update_gz_tools.js","line":82,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would make the help arg \"CONCURRENCY\", rather than \"N\"."},{"file":"lib/cli/do_update_gz_tools.js","line":82,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2185,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would file a ticket describing the problem, i.e. that the backup files currently appear to accumulate without bound, but I don\u0027t think you need to deal with that in this change.  I would remove this comment, too."},{"file":"lib/sdcadm.js","line":2185,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. TOOLS-1472"},{"file":"lib/sdcadm.js","line":2193,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would ditch this custom format -- it\u0027s not a committed interface.  Just use the regular \"toISOString()\" format."},{"file":"lib/sdcadm.js","line":2193,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2200,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We should use \"mod_fs.rename()\" for this, I think, instead of running \"mv\"."},{"file":"lib/sdcadm.js","line":2200,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2231,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"If we _must_ run \"cp\", rather than using some kind of library function, we should at least fully qualify the path; i.e. \"/usr/bin/cp\"."},{"file":"lib/sdcadm.js","line":2231,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027ll rather try adding some function to common, since we have many instances of system cmd calls across sdcadm source."},{"file":"lib/sdcadm.js","line":2472,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would flesh this line out a little more; e.g.\n\n  * Deploy updated compute node tools throughout the data center,\n  * and update boot files on the USB key of machines which have one."},{"file":"lib/sdcadm.js","line":2472,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2478,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"You\u0027re not actually returning a value here, so it would be better to separate the call to the callback and the \"return\" statement, e.g.\n\n  if (justDownload) {\n      next();\n      return;\n  }"},{"file":"lib/sdcadm.js","line":2478,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2501,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2501,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2504,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think we _can_ update servers that are not yet set up, as the CN tools tarball is extracted into the ZFS pool (in \"/opt\"), which will not have been created.  We should put a comment to that effect here, e.g.\n\n  /*\n   * The compute node tools are installed into the ZFS pool, which is created\n   * during compute node setup.  As such, this process does not currently\n   * apply to compute nodes that have not yet been set up.\n   */"},{"file":"lib/sdcadm.js","line":2504,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2509,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2509,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2511,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"You should add this property to the initial context definition up the top (~L2316), even if it\u0027s just set to \"null\" up there.  I would probably assert that it _does_ equal \"null\" here, before setting it, to ensure we\u0027re not setting it twice."},{"file":"lib/sdcadm.js","line":2511,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. Good call!"},{"file":"lib/sdcadm.js","line":2518,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2518,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2525,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Please break this across three lines, i.e.\n\n    function (s) {\n        return (s.uuid);\n    }),"},{"file":"lib/sdcadm.js","line":2525,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2529,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2529,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2532,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2532,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2538,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2538,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2545,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this continuation is indented too far.  I would also assert that \"assets_admin_ip\" is the type you\u0027re expecting.  If it should be an IPv4 address, I would assert on \"mod_net.isIPv4()\".\n\nhttp://nodejs.org/dist/v0.10.46/docs/api/net.html#net_net_isipv4_input"},{"file":"lib/sdcadm.js","line":2545,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2554,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would fully qualify the path to OS tools that might also appear in other parts of PATH, e.g. \"/usr/bin/rm\", \"/usr/bin/mkdir\", etc."},{"file":"lib/sdcadm.js","line":2554,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sure, just did it. Note this was just a \"copy source from the script, which wasn\u0027t qualifying paths at all."},{"file":"lib/sdcadm.js","line":2559,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"You should guard against this command failing, e.g.\n\n    \u0027if ! /usr/bin/mkdir -p /opt/smartdc; then\u0027,\n    \u0027    echo \"failed to create /opt/smartdc\",\n    \u0027    exit 1\u0027,\n    \u0027fi\u0027,"},{"file":"lib/sdcadm.js","line":2559,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2576,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This should just be:\n\n    \u0027if ! /opt/smartdc/bin/sdc-usbkey update --ignore-missing; then\u0027,\n    \u0027    exit $?\u0027,\n    \u0027fi\u0027,"},{"file":"lib/sdcadm.js","line":2576,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2594,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"It would be good to prefix these property names, e.g. \"cmd_str\", \"cmd_progbarName\", \"cmd_timeout\".\n\nAlso, I think that the progress bar strings should really be:\n\n  \"Update compute node tools\"\n  \"Update USB key contents\""},{"file":"lib/sdcadm.js","line":2594,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done with the progbar strings.\n\nNot sure I buy the idea of prefixing the properties with \"cmd_\", mostly b/c this would make these vars look, inside the runUrQueue function as:\n\n    command: cmd.cmd_str,\n    concurrency: options.concurrency,\n    timeout: cmd.cmd_timeout\n\nwhich looks like sightly redundant. Also, with the exception of the option names used for subcommands options, I\u0027d like to continue avoiding using underscores in property names when possible."},{"file":"lib/sdcadm.js","line":2616,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Presumably this should be something that the common \"runQueue\" function in \"lib/ur.js\" does?"},{"file":"lib/sdcadm.js","line":2616,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"No, it doesn\u0027t"},{"file":"lib/sdcadm.js","line":2620,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this would be better formatted as:\n\n  self.log.trace({\n      command: cmd.str,\n      concurrency: options.rate\n  }, \u0027runUrQueue\u0027);"},{"file":"lib/sdcadm.js","line":2620,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done. Also, much better using `options.concurrency` than `options.rate`:-)"},{"file":"lib/sdcadm.js","line":2624,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As above, separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2624,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2647,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would flesh this comment out a bit more, e.g.\n\n  /*\n   * The \"success\" event means that the process was successfully started and\n   * ran to completion, but we still need to check for a non-zero exit status.\n   */"},{"file":"lib/sdcadm.js","line":2647,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2672,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This should probably be a VError instance, e.g.\n\n  if (err) {\n      err \u003d VError(err, \"could not update compute node tools\");\n  }\n  next(err);"},{"file":"lib/sdcadm.js","line":2672,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"That\u0027s already an instance of VError, either UpdateError or MultiError, both of them using VError"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":244,"deletions":-3}],"sizeInsertions":254,"sizeDeletions":-4},{"number":"2","revision":"1af1a1532ee311e1fddfe0d6e1a01eff65ce539f","parents":["6489a37e50cdd91e4aa95f42d2c575d5c2d71c4e"],"ref":"refs/changes/43/43/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1468240803,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":72,"deletions":-45}],"sizeInsertions":104,"sizeDeletions":-48},{"number":"3","revision":"ee47647ab1e94b9c7fa5bb3a264d989e889066bd","parents":["c68c437f3135a00570d11d24853ec53a2e5234c6"],"ref":"refs/changes/43/43/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1468258069,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1468275070,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"comments":[{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Please lose the colon after the ticket ID! i.e.\n\n   TOOLS-1336 sdcadm should also update USB keys\n   Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e"},{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I personally have zero preferences for one form or the other, but note that including the colon has been the default behavior for many repos, including not only sdcadm, but pretty much everything SDC."},{"file":"lib/cli/do_update_gz_tools.js","line":51,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I had added a comment about \"updateGzTools()\":\n\n\u003e You should make sure that \"updateGzTools()\" has a type assertion for this new parameter.  I would probably also convert it to \"common.assertStrictOptions()\" if it is not using that already.\n\nCan you please take a look at this one?"},{"file":"lib/cli/do_update_gz_tools.js","line":51,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/common.js","line":1574,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This \"return\" statement is unneeded here."},{"file":"lib/common.js","line":1574,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/common.js","line":1584,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think that if we get an \"error\" event on either one of these streams, we need to call \"destroy()\" on the _other_ one to prevent a file descriptor leak.  See also: TOOLS-629.  I would probably add that to \"onErr()\"."},{"file":"lib/common.js","line":1584,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/common.js","line":1588,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think you need to wait for the \"open\" event, but can just do \"readStream.pipe(writeStream);\" as the last thing in the function."},{"file":"lib/common.js","line":1588,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/common.js","line":1592,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This return statement is unneeded."},{"file":"lib/common.js","line":1592,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":1978,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As per the comment I added to another file:\n\n\u003e You should make sure that \"updateGzTools()\" has a type assertion for this new parameter.  I would probably also convert it to \"common.assertStrictOptions()\" if it is not using that already."},{"file":"lib/sdcadm.js","line":1978,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2191,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Separate \"return\" from callback invocation."},{"file":"lib/sdcadm.js","line":2191,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2194,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this \"return\" is superfluous and can be removed."},{"file":"lib/sdcadm.js","line":2194,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2635,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Did you look at moving this into \"runQueue()\" itself?"},{"file":"lib/sdcadm.js","line":2635,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/sdcadm.js","line":2672,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this comment is now not quite indented correctly.  (Needs to come in two more spaces?)"},{"file":"lib/sdcadm.js","line":2672,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":30,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":272,"deletions":-4}],"sizeInsertions":313,"sizeDeletions":-7},{"number":"4","revision":"2ede634f144bdf0c1e113cf5e620923b1b60eacb","parents":["c68c437f3135a00570d11d24853ec53a2e5234c6"],"ref":"refs/changes/43/43/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1468324291,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468389622,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":27,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":279,"deletions":-8},{"file":"lib/ur.js","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":321,"sizeDeletions":-11},{"number":"5","revision":"ff6f34a559dca942ea26baee0c56f1c3f642c56d","parents":["c68c437f3135a00570d11d24853ec53a2e5234c6"],"ref":"refs/changes/43/43/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1468402192,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1468431094,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":27,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":279,"deletions":-18},{"file":"lib/ur.js","type":"MODIFIED","insertions":4,"deletions":0}],"sizeInsertions":321,"sizeDeletions":-21},{"number":"6","revision":"0b6367a90e59810500faa0352f44d28f9f9fb6fb","parents":["c68c437f3135a00570d11d24853ec53a2e5234c6"],"ref":"refs/changes/43/43/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1468434393,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"2","grantedOn":1468566725,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1468567303,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_gz_tools.js","type":"MODIFIED","insertions":11,"deletions":-2},{"file":"lib/common.js","type":"MODIFIED","insertions":27,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":279,"deletions":-18},{"file":"lib/ur.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"test/update-gz-tools.test.js","type":"ADDED","insertions":110,"deletions":0}],"sizeInsertions":431,"sizeDeletions":-21}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}