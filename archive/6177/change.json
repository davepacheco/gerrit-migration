{"project":"joyent/illumos-extra","branch":"master","topic":"base-64-gcc","id":"I121ebcb53842496487948ee4ec34382ff0f80641","number":"6177","subject":"OS-7775 platform builds on base-64 need gcc4.x to bootstrap Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/6177","commitMessage":"OS-7775 platform builds on base-64 need gcc4.x to bootstrap\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1556617569,"lastUpdated":1559817331,"open":false,"status":"MERGED","comments":[{"timestamp":1556617569,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1556617575,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 514b63f566a00bdba6d113e4b3e4703652c7fb5f\n    \n    OS-7775 platform builds on base-64 need gcc4.x to bootstrap"},{"timestamp":1556618040,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Topic set to base-64-gcc"},{"timestamp":1556618594,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1556620479,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(3 comments)\n\nThanks for the review!"},{"timestamp":1556620615,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1556622207,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1556622213,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 7f8a42cca1c0815fee34abf30e99868b155ad429\n    \n    OS-7775 platform builds on base-64 need gcc4.x to bootstrap"},{"timestamp":1556622361,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1556622686,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1556623186,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1559568264,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1559575854,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1559578330,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1559735389,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1559745704,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4."},{"timestamp":1559747148,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n\u003e Uploaded patch set 4.\n\nI built these changes on multiarch and x64 build zones, and didn\u0027t hit any problems."},{"timestamp":1559747745,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n(additional testing notes are in the OS-7775 ticket)"},{"timestamp":1559770240,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1\n\nThanks for chasing that down, Tim."},{"timestamp":1559812654,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1559816379,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1559817331,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"5","revision":"121ebcb53842496487948ee4ec34382ff0f80641","parents":["3fa6c35b518057ce2a05093c5d969f6c6d379783"],"ref":"refs/changes/77/6177/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1559816379,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770240,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559812654,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559812654,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1559817331,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile.defs","type":"MODIFIED","insertions":10,"deletions":-3},{"file":"Makefile.gcc","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":24,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"094f2a291e3501b435f9cca793e26eafd04dfe0c","parents":["3fa6c35b518057ce2a05093c5d969f6c6d379783"],"ref":"refs/changes/77/6177/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556617569,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","comments":[{"file":"Makefile.defs","line":51,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"what are these changes for?"},{"file":"Makefile.defs","line":51,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Really just tidiness, to keep the same pattern we\u0027re establishing for GCC4.* below."},{"file":"Makefile.defs","line":63,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"when do we use these?"},{"file":"Makefile.defs","line":63,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"We\u0027re not using the .64 variants anywhere afacit. I can remove those if you prefer?\n\nThe GCC4.host and GXX4.host macros get used in gcc4/Makefile to pass as AUTOCONV_ENV overrides for CC and CXX so that we always compile our copy of gcc4 with the build machine\u0027s gcc 4.x."},{"file":"Makefile.defs","line":63,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I would prefer not to define stuff we don\u0027t use."},{"file":"Makefile.defs","line":63,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Sure - I\u0027ve removed that in patch set 2."},{"file":"Makefile.gcc","line":48,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"I imagine we just picked this up from the PATH before?"},{"file":"Makefile.gcc","line":48,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yep. I can remove these if you like, but I thought that it\u0027d be good to show our expectations here."},{"file":"Makefile.gcc","line":48,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"No, that\u0027s fine, being explicit here seems good."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile.defs","type":"MODIFIED","insertions":13,"deletions":-2},{"file":"Makefile.gcc","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":20,"sizeDeletions":-4},{"number":"2","revision":"32643d69b4ba257df167ed9d2e593eb7904f0ca4","parents":["3fa6c35b518057ce2a05093c5d969f6c6d379783"],"ref":"refs/changes/77/6177/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1556622207,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","comments":[{"file":"Makefile.defs","line":58,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"this comment is stale"},{"file":"Makefile.defs","line":58,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"doh. Will fix, sorry about that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile.defs","type":"MODIFIED","insertions":10,"deletions":-2},{"file":"Makefile.gcc","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":17,"sizeDeletions":-4},{"number":"3","revision":"7b8a7d91454e22645f33c1348cf4bcaa59702102","parents":["3fa6c35b518057ce2a05093c5d969f6c6d379783"],"ref":"refs/changes/77/6177/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1559568264,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559575854,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"gcc4/Makefile","line":36,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we be overriding GCC.host before including this? In the current form, doesn\u0027t this mean that we\u0027ve set CC and CXX twice on the command line? I\u0027m sure things work in the current form, I\u0027m just not sure if it\u0027s a bit of a time bomb where refactoring could change this around."},{"file":"gcc4/Makefile","line":36,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Yes, I agree.\n\nWithout the fix as it stands (and adding a print-% target here for debugging) we are getting CC and CXX twice, and this only works now because the last one in wins:\n\n\u003d\u003d\u003d\u003d\u003d\ntimf@smartos-build-64 (grr-OS-7775) pwd\n/space/timf/smartos-live-64/projects/illumos-extra/gcc4\ntimf@smartos-build-64 (grr-OS-7775) tail Makefile\nGXX \u003d /bin/false\nCFLAGS \u003d -nostdinc -isystem /usr/include -g -O2\n\ninclude ../Makefile.gcc\n\n# We specifically need GCC 4.x in order to build gcc4\nAUTOCONF_ENV +\u003d CC\u003d$(GCC4.host) CXX\u003d$(GXX4.host)\n\nprint-%:\n        @echo \u0027$*\u003d$($*)\u0027\n\n\ntimf@smartos-build-64 (grr-OS-7775) make print-AUTOCONF_ENV\nAUTOCONF_ENV\u003dPKG_CONFIG_LIBDIR\u003d\"\" CC\u003d\"/opt/local/bin/gcc\" CXX\u003d\"/bin/false\"  CFLAGS\u003d\"-g -O2\" LDFLAGS\u003d\"-L/space/timf/smartos-live-64/projects/illumos-extra/gcc4/../proto//usr/lib -L/space/timf/smartos-live-64/projects/illumos-extra/gcc4/../proto//lib \"  DESTDIR\u003d/space/timf/smartos-live-64/projects/illumos-extra/gcc4/../proto MAKE\u003dgmake GCC\u003d/opt/local/bin/gcc GXX\u003d/opt/local/bin/g++ CC\u003d/opt/local/gcc49/bin/gcc CXX\u003d/opt/local/gcc49/bin/g++\ntimf@smartos-build-64 (grr-OS-7775)\n\u003d\u003d\u003d\u003d\n\nAs you suggest, overriding GCC.host is safer. It\u0027s not\nquite sufficient, since Makefile.defs will still set\nCC to $(GCC) early in the AUTOCONF_ENV, so we override\nthat too:\n\n\u003d\u003d\u003d\u003d\ntimf@smartos-build-64 (grr-OS-7775) git diff\ndiff --git a/Makefile.gcc b/Makefile.gcc\nindex bb1617b..0600969 100644\n--- a/Makefile.gcc\n+++ b/Makefile.gcc\n@@ -21,7 +21,7 @@\n #\n SEPARATE_BUILD \u003d yes\n\n-GCC \u003d /opt/local/bin/gcc\n+GCC ?\u003d /opt/local/bin/gcc\n CFLAGS \u003d -g -O2\n PREFIX \u003d /usr/gcc/$(GCC_VER)\n\ndiff --git a/gcc4/Makefile b/gcc4/Makefile\nindex 701c57f..2940198 100644\n--- a/gcc4/Makefile\n+++ b/gcc4/Makefile\n@@ -32,8 +32,15 @@ MPFR_TARBALL \u003d $(MPFR_VER).tar.gz\n GMP_VER \u003d gmp-5.1.1\n GXX \u003d /bin/false\n CFLAGS \u003d -nostdinc -isystem /usr/include -g -O2\n+# Override these so that Makefile.gcc doesn\u0027t set them\n+GCC \u003d\n+GCC.host \u003d $(GCC4.host)\n+GXX.host \u003d $(GXX4.host)\n\n include ../Makefile.gcc\n\n # We specifically need GCC 4.x in order to build gcc4\n AUTOCONF_ENV +\u003d CC\u003d$(GCC4.host) CXX\u003d$(GXX4.host)\n+\n+print-%:\n+       @echo \u0027$*\u003d$($*)\u0027\n\u003d\u003d\u003d\n\nThis results in:\n\n\u003d\u003d\u003d\ntimf@smartos-build-64 (grr-OS-7775) make print-AUTOCONF_ENV\nAUTOCONF_ENV\u003dPKG_CONFIG_LIBDIR\u003d\"\" CC\u003d\"\" CXX\u003d\"/bin/false\"  CFLAGS\u003d\"-g -O2\" LDFLAGS\u003d\"-L/space/timf/smartos-live-64/projects/illumos-extra/gcc4/../proto//usr/lib -L/space/timf/smartos-live-64/projects/illumos-extra/gcc4/../proto//lib \"  DESTDIR\u003d/space/timf/smartos-live-64/projects/illumos-extra/gcc4/../proto MAKE\u003dgmake GCC\u003d/opt/local/gcc49/bin/gcc GXX\u003d/opt/local/gcc49/bin/g++ CC\u003d/opt/local/gcc49/bin/gcc CXX\u003d/opt/local/gcc49/bin/g++\n\u003d\u003d\u003d\n\nthe empty string for CC near the beginning of AUTOCONV_ENV\nisn\u0027t fantastic, but might prevent future refactoring\nfrom breaking this.\n\nI\u0027ve tested this on my x86 build zone, I\u0027ll test on multiarch too before submitting an updated patch here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile.defs","type":"MODIFIED","insertions":10,"deletions":-3},{"file":"Makefile.gcc","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":18,"sizeDeletions":-6},{"number":"4","revision":"795bee5cff3da87abb75f7dd96f841b6ac6fad36","parents":["3fa6c35b518057ce2a05093c5d969f6c6d379783"],"ref":"refs/changes/77/6177/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1559745704,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770240,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559812654,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559812654,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile.defs","type":"MODIFIED","insertions":10,"deletions":-3},{"file":"Makefile.gcc","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":24,"sizeDeletions":-7},{"number":"5","revision":"121ebcb53842496487948ee4ec34382ff0f80641","parents":["3fa6c35b518057ce2a05093c5d969f6c6d379783"],"ref":"refs/changes/77/6177/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1559816379,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559770240,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559812654,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559812654,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1559817331,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile.defs","type":"MODIFIED","insertions":10,"deletions":-3},{"file":"Makefile.gcc","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"gcc4/Makefile","type":"MODIFIED","insertions":9,"deletions":-1}],"sizeInsertions":24,"sizeDeletions":-7}],"allReviewers":[{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}