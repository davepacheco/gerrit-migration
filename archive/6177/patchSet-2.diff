From 32643d69b4ba257df167ed9d2e593eb7904f0ca4 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Tue, 30 Apr 2019 12:03:23 +0100
Subject: [PATCH] OS-7775 platform builds on base-64 need gcc4.x to bootstrap

---
 Makefile.defs | 12 ++++++++++--
 Makefile.gcc  |  4 +++-
 gcc4/Makefile |  5 ++++-
 3 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/Makefile.defs b/Makefile.defs
index 75b445e..9ed1526 100644
--- a/Makefile.defs
+++ b/Makefile.defs
@@ -47,11 +47,19 @@ MAKE_VERBOSE =	V=1
 GCC.64 =	$(GCC) -m64
 GXX.64 =	$(GXX) -m64
 
-GCC.host =	/opt/local/bin/gcc
-GXX.host =	/opt/local/bin/g++
+# The version of gcc in /opt/local/bin varies depending on the pkgsrc release
+GCC.host_prefix ?= /opt/local/bin
+GCC.host =	$(GCC.host_prefix)/gcc
+GXX.host =	$(GCC.host_prefix)/g++
 GCC.host.64 =	$(GCC.host) -m64
 GXX.host.64 =	$(GXX.host) -m64
 
+# We need gcc 4.x in order to build our copy of gcc 4.4. This is set by the
+# 'build_strap' script in smartos-live using the HOST_GCC4_PREFIX value from
+# 'build.env'. That value is computed by 'configure' from smartos-live.
+GCC4.host =	$(HOST_GCC4_PREFIX)/gcc
+GXX4.host =	$(HOST_GCC4_PREFIX)/g++
+
 LEX = 		/opt/local/bin/lex
 YACC = 		/opt/local/bin/yacc
 GPATCH =	/opt/local/bin/gpatch
diff --git a/Makefile.gcc b/Makefile.gcc
index b1e698a..7760384 100644
--- a/Makefile.gcc
+++ b/Makefile.gcc
@@ -44,7 +44,9 @@ AUTOCONF_OPTS += \
 
 AUTOCONF_ENV += \
 	DESTDIR=$(DESTDIR) \
-	MAKE=$(MAKE)
+	MAKE=$(MAKE) \
+	GCC=$(GCC.host) \
+	GXX=$(GXX.host)
 
 OVERRIDES += \
 	$(AUTOCONF_CFLAGS) \
diff --git a/gcc4/Makefile b/gcc4/Makefile
index ffaa7e3..c3331b5 100644
--- a/gcc4/Makefile
+++ b/gcc4/Makefile
@@ -20,7 +20,7 @@
 #
 # Copyright 2010 Sun Microsystems, Inc.  All rights reserved.
 # Use is subject to license terms.
-# Copyright (c) 2018, Joyent, Inc.  All rights reserved.
+# Copyright (c) 2019, Joyent, Inc.  All rights reserved.
 #
 
 include ../Makefile.defs
@@ -34,3 +34,6 @@ GXX = /bin/false
 CFLAGS = -nostdinc -isystem /usr/include -g -O2
 
 include ../Makefile.gcc
+
+# We specifically need GCC 4.x in order to build gcc4
+AUTOCONF_ENV += CC=$(GCC4.host) CXX=$(GXX4.host)
-- 
2.21.0

