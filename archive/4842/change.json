{"project":"joyent/illumos-joyent","branch":"master","id":"I2b4a3b61df2d434e6512ab10225e77b1ab2396fa","number":"4842","subject":"OS-6884 viona frame headers risk TOCTOU","owner":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"url":"https://cr.joyent.us/4842","commitMessage":"OS-6884 viona frame headers risk TOCTOU\n","createdOn":1536971391,"lastUpdated":1537483430,"open":false,"status":"MERGED","comments":[{"timestamp":1536971391,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 1."},{"timestamp":1537220694,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1537301843,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1537301854,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 2."},{"timestamp":1537302006,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1537323783,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1537371055,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1537372876,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1537373024,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1537464311,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1537473444,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1537473949,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 3."},{"timestamp":1537474227,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1537482864,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1537482905,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 4:\n\nTesting notes added to ticket."},{"timestamp":1537483390,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1537483430,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Ryan Zezeski"}],"currentPatchSet":{"number":"4","revision":"2b4a3b61df2d434e6512ab10225e77b1ab2396fa","parents":["3794882f9ab1c5aa999be8248687eb16980bce11"],"ref":"refs/changes/42/4842/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1537482864,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537474227,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1537483390,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1537483430,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":102,"deletions":-32}],"sizeInsertions":102,"sizeDeletions":-32},"patchSets":[{"number":"1","revision":"d07ae7d524146239d91298a308b7e4206cb303ac","parents":["a1c95bbb7c9625aab345559b448cd77dad78b4b3"],"ref":"refs/changes/42/4842/1","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1536971391,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":247,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"For the same of correctness, are we worried about the whole max-length TCP header?  Wouldn\u0027t sizeof (tcpha_t) cover the important data?  (Unless we\u0027re worried about TOCTOU on the options)"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":247,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"It seems prudent given there could be options with values, and I\u0027m not sure how those values could effect the behavior of the TCP stack."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":247,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"That\u0027s a good point.  I imagine our TCP stack hasn\u0027t been verified to avoid going totally off the rails if the contents options changed during execution."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1184,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Maybe worth a little viona_ring_desb_free() helper so we don\u0027t have this repeated all over the codebase?  Alternatively, d_headers could be a uint8_t[VIONA_MAX_HDRS_LEN], skipping the separate allocations."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1184,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Makes sense. I like having the headers hang off each individual desb, makes the relationship clear."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2220,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Necessary?  I don\u0027t think normally allocated buffers have any expectation of zeroing."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2220,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Removed."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2402,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I would tweak this to check mp_head right after the desballoc attempt above."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2402,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2408,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"append comma"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2408,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2413,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"could be const"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2413,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":101,"deletions":-26}],"sizeInsertions":101,"sizeDeletions":-26},{"number":"2","revision":"909353fc4d2df9c467b3f583cc449897bbe2a6e2","parents":["a1c95bbb7c9625aab345559b448cd77dad78b4b3"],"ref":"refs/changes/42/4842/2","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1537301854,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537464311,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"comments":[{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1465,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Let\u0027s keep this VERIFY?"},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":1465,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Sigh, I got a little too quick on the draw there. Did not mean to remove this. I\u0027ll fix that."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2442,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Is there anything to prevent a guest from sending us a 0-byte iovec?  I think desballoc/allocb/bcopy will DTRT (and you end up with a 0-data length mblk_t in the list) -- I\u0027m almost sure we\u0027ve seen such mblk_t\u0027s handed to the overlay driver (suggesting other parts of the stack tolerate such mblk_t\u0027s).\n\nI suspect we want to remove the assert and maybe just do \u0027if (chunk \u003d\u003d 0) continue;\u0027 (if only to skip a needless allocation)."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2442,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"That\u0027s a good question. We probably can\u0027t assume anything coming from a guest, as both the network stack and driver are in its control. My feeling is well behaved guests wouldn\u0027t do this. But we have to account for all possible guests.\n\nI\u0027ll give pmooney some time to weigh in before changing it."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2442,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027ll write up a new ticket for this.  The TOCTOU logic itself needn\u0027t worry about zero-length descriptors."},{"file":"usr/src/uts/i86pc/io/viona/viona.c","line":2442,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Fair enough."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":102,"deletions":-33}],"sizeInsertions":102,"sizeDeletions":-33},{"number":"3","revision":"048a838a6f6314e85baf70cd2572d4c27d42b894","parents":["a1c95bbb7c9625aab345559b448cd77dad78b4b3"],"ref":"refs/changes/42/4842/3","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1537473949,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537474227,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":102,"deletions":-32}],"sizeInsertions":102,"sizeDeletions":-32},{"number":"4","revision":"2b4a3b61df2d434e6512ab10225e77b1ab2396fa","parents":["3794882f9ab1c5aa999be8248687eb16980bce11"],"ref":"refs/changes/42/4842/4","uploader":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"createdOn":1537482864,"author":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1537483390,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1537474227,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1537483430,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/i86pc/io/viona/viona.c","type":"MODIFIED","insertions":102,"deletions":-32}],"sizeInsertions":102,"sizeDeletions":-32}],"allReviewers":[{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}