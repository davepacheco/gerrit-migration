From 442270cc873090cf9ae547f610a0378ff620c1b9 Mon Sep 17 00:00:00 2001
From: Jared Morrow <jm@joyent.com>
Date: Thu, 16 Aug 2018 14:39:23 -0600
Subject: [PATCH] MANTA-3877 Add no_reindex option to manta bucket creation for
 GC trigger update

---
 lib/moray.js | 23 ++++++++++++++++++++++-
 package.json |  2 +-
 2 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/lib/moray.js b/lib/moray.js
index 35f2981..391c079 100644
--- a/lib/moray.js
+++ b/lib/moray.js
@@ -35,7 +35,15 @@ var utils = require('./utils');
 var sprintf = util.format;
 
 var BUCKET = process.env.MANTA_RING_BUCKET || 'manta';
+/*
+ * NOTE: Care must be taken when deploying a incremented version of the manta
+ * bucket for large databases. Currently `no_reindex = true` is being
+ * passed into createBucket below. If new columns are added to the manta
+ * bucket, this reindex option should be removed or at least revisited.
+ * Do not change BUCKET_VERSION without discussing a deployment strategy.
+ */
 var BUCKET_VERSION = 2;
+
 /* JSSTYLED */
 var ROOT_RE = /^\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}\/stor$/;
 var SCHEMA = {
@@ -113,6 +121,9 @@ function setupMantaBuckets(log, client, cb) {
                     version: BUCKET_VERSION
                 }
             },
+            reqopts: {
+                no_reindex: true // See comment above BUCKET_VERSION definition
+            },
             log: log
         }, {
             client: client,
@@ -123,6 +134,7 @@ function setupMantaBuckets(log, client, cb) {
                     version: MANTA_UPLOADS_VERSION
                 }
             },
+            reqopts: {},
             log: log
         }, {
             client: client,
@@ -133,6 +145,7 @@ function setupMantaBuckets(log, client, cb) {
                     version: DELETE_LOG_VERSION
                 }
             },
+            reqopts: {},
             log: log
         }, {
             client: client,
@@ -142,6 +155,7 @@ function setupMantaBuckets(log, client, cb) {
                     version: FASTDELETE_QUEUE_VERSION
                 }
             },
+            reqopts: {},
             log: log
         }, {
             client: client,
@@ -152,6 +166,7 @@ function setupMantaBuckets(log, client, cb) {
                     version: DIR_COUNT_VERSION
                 }
             },
+            reqopts: {},
             log: log
         } ]
     }, function onPipelineDone(err) {
@@ -409,10 +424,16 @@ function createMetadata(options) {
 
 
 function createBucket(opts, cb) {
+    assert.string(opts.bucket, 'opts.bucket');
+    assert.object(opts.client, 'opts.client');
+    assert.object(opts.opts, 'opts.opts');
+    assert.object(opts.reqopts, 'opts.reqopts');
+    assert.object(opts.log, 'opts.log');
+    assert.func(cb, 'callback');
     var bucket = opts.bucket;
     var client = opts.client;
 
-    client.putBucket(bucket, opts.opts, function (err) {
+    client.putBucket(bucket, opts.opts, opts.reqopts, function (err) {
         var realErrors = [];
 
         /*
diff --git a/package.json b/package.json
index e2027f8..1f4b014 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "libmanta",
     "description": "common functions et al for manta services",
-    "version": "1.1.0",
+    "version": "1.1.1",
     "author": "Joyent (joyent.com)",
     "private": true,
     "main": "./lib/index.js",
-- 
2.21.0

