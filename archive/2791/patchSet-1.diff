From bda3761d22c321608d6f872b2dec2022d0938f53 Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Mon, 16 Oct 2017 12:29:00 -0700
Subject: [PATCH] DOCKER-592 disable the restify uncaughtException handler

---
 lib/common.js | 25 -------------------------
 lib/docker.js |  3 +--
 2 files changed, 1 insertion(+), 27 deletions(-)

diff --git a/lib/common.js b/lib/common.js
index da6f812..e4daf07 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -371,30 +371,6 @@ function filteredAuditLog(req, res, route, err) {
 }
 
 
-/*
- * Returns a handler that will log uncaught exceptions properly
- */
-function uncaughtHandler(req, res, route, err) {
-    res.send(new restify.InternalError(err, 'Internal error'));
-    /**
-     * We don't bother logging the `res` here because it always looks like
-     * the following, no added info to the log.
-     *
-     *      HTTP/1.1 500 Internal Server Error
-     *      Content-Type: application/json
-     *      Content-Length: 51
-     *      Date: Wed, 29 Oct 2014 17:33:02 GMT
-     *      x-request-id: a1fb11c0-5f91-11e4-92c7-3755959764aa
-     *      x-response-time: 9
-     *      Connection: keep-alive
-     *
-     *      {"code":"InternalError","message":"Internal error"}
-     */
-    req.log.error({err: err, route: route && route.name,
-        req: req}, 'Uncaught exception');
-}
-
-
 /*
  * Handler for checking if the required servics are online before serving
  * any request
@@ -890,7 +866,6 @@ module.exports = {
     writeToDockerRawStream: writeToDockerRawStream,
     generateDockerId: generateDockerId,
     formatProgress: formatProgress,
-    uncaughtHandler: uncaughtHandler,
     waitForJob: waitForJob,
     writeProgress: writeProgress,
     writeStatus: writeStatus,
diff --git a/lib/docker.js b/lib/docker.js
index 31c0e6a..023d69f 100644
--- a/lib/docker.js
+++ b/lib/docker.js
@@ -145,7 +145,6 @@ function App(opts) {
     });
 
     server.on('after', common.filteredAuditLog);
-    server.on('uncaughtException', common.uncaughtHandler);
     endpoints.register(server, self.log, [
         common.checkReadonlyMode,
         common.checkServices,
@@ -315,6 +314,7 @@ App.prototype.setupServer = function () {
 App.prototype.setupAdminSever = function listen(callback) {
     var self = this;
     var admin = self.admin = restify.createServer({
+        handleUncaughtExceptions: false,
         log: self.log,
         name: 'docker-admin',
         version: self.version
@@ -340,7 +340,6 @@ App.prototype.setupAdminSever = function listen(callback) {
     admin.use(restify.queryParser({mapParams: false}));
     admin.use(restify.bodyParser());
     admin.on('after', common.filteredAuditLog);
-    admin.on('uncaughtException', common.uncaughtHandler);
     adminEndpoints.register(admin, self.log, [ common.checkServices ]);
 };
 
-- 
2.21.0

