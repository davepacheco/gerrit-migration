From 390df790f2dacee3f71af095a01444014cfd6cba Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Thu, 2 Feb 2017 21:39:13 -0800
Subject: [PATCH] AGENT-1057 log setup for agents should move to a -setup
 service instead of the agent's startup script

---
 npm/postinstall.sh                         | 36 +++++++-------
 package.json                               |  2 +-
 smf/manifests/vm-agent-setup.xml.in        | 55 ++++++++++++++++++++++
 smf/manifests/vm-agent.xml.in              |  6 +--
 smf/method/{vm-agent.in => vm-agent-setup} |  5 +-
 5 files changed, 80 insertions(+), 24 deletions(-)
 create mode 100644 smf/manifests/vm-agent-setup.xml.in
 rename smf/method/{vm-agent.in => vm-agent-setup} (85%)

diff --git a/npm/postinstall.sh b/npm/postinstall.sh
index d64e499..79a87b4 100755
--- a/npm/postinstall.sh
+++ b/npm/postinstall.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright 2015 Joyent, Inc.
+# Copyright 2017 Joyent, Inc.
 #
 
 if [[ "${SDC_AGENT_SKIP_LIFECYCLE:-no}" = "yes" ]]; then
@@ -65,31 +65,33 @@ function subfile
 }
 
 #
-# Replace substitution tokens in the SMF method and manifest files, and then
+# Replace substitution tokens in the SMF manifest files, and then
 # import the SMF service.
 #
 function import_smf_manifest
 {
-    local method_in="$ROOT/smf/method/$AGENT.in"
-    local method_out="$ROOT/smf/method/$AGENT"
-    local manifest_in="$ROOT/smf/manifests/$AGENT.xml.in"
-    local manifest_out="$SMF_DIR/$AGENT.xml"
-
-    if [[ ! -f "${method_in}" ]]; then
-        fatal 'could not find smf method input file: %s' "${method_in}"
+    local agent_manifest_in="$ROOT/smf/manifests/$AGENT.xml.in"
+    local agent_manifest_out="$SMF_DIR/$AGENT.xml"
+    local agent_setup_manifest_in="$ROOT/smf/manifests/$AGENT-setup.xml.in"
+    local agent_setup_manifest_out="$SMF_DIR/$AGENT-setup.xml"
+
+    if [[ ! -f "${agent_manifest_in}" ]]; then
+        fatal 'could not find smf manifest input file: %s' \
+            "${agent_manifest_in}"
     fi
-    if [[ ! -f "${manifest_in}" ]]; then
-        fatal 'could not find smf manifest input file: %s' "${manifest_in}"
+    if [[ ! -f "${agent_setup_manifest_in}" ]]; then
+        fatal 'could not find smf manifest input file: %s'
+        "${agent_setup_manifest_in}"
     fi
 
-    if ! subfile "${method_in}" "${method_out}" ||
-      ! chmod +x "${method_out}"; then
-        fatal 'could not process smf method (%s)' "${method_in}"
+    if ! subfile "${agent_manifest_in}" "${agent_manifest_out}" ||
+      ! svccfg import "${agent_manifest_out}"; then
+        fatal 'could not process smf manifest (%s)' "${agent_manifest_in}"
     fi
 
-    if ! subfile "${manifest_in}" "${manifest_out}" ||
-      ! svccfg import "${manifest_out}"; then
-        fatal 'could not process smf manifest (%s)' "${manifest_in}"
+    if ! subfile "${agent_setup_manifest_in}" "${agent_setup_manifest_out}" ||
+      ! svccfg import "${agent_setup_manifest_out}"; then
+        fatal 'could not process smf manifest (%s)' "${agent_setup_manifest_in}"
     fi
 }
 
diff --git a/package.json b/package.json
index 6e11445..9491510 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "vm-agent",
     "description": "SmartDC Node VM Agent",
-    "version": "1.5.0",
+    "version": "1.6.0",
     "author": "Joyent (joyent.com)",
     "private": true,
     "dependencies": {
diff --git a/smf/manifests/vm-agent-setup.xml.in b/smf/manifests/vm-agent-setup.xml.in
new file mode 100644
index 0000000..7c41c65
--- /dev/null
+++ b/smf/manifests/vm-agent-setup.xml.in
@@ -0,0 +1,55 @@
+<?xml version="1.0"?>
+<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
+<!--
+    This Source Code Form is subject to the terms of the Mozilla Public
+    License, v. 2.0. If a copy of the MPL was not distributed with this
+    file, You can obtain one at http://mozilla.org/MPL/2.0/.
+-->
+
+<!--
+    Copyright (c) 2017, Joyent, Inc.
+-->
+
+<service_bundle type="manifest" name="vm-agent-setup">
+  <service name="smartdc/agent/vm-agent-setup" type="service" version="@@VERSION@@">
+
+    <create_default_instance enabled="@@ENABLED@@"/>
+    <single_instance/>
+
+    <dependency name="network" grouping="require_all" restart_on="error" type="service">
+      <service_fmri value="svc:/milestone/network:default"/>
+    </dependency>
+
+    <exec_method
+      type="method"
+      name="start"
+      exec="@@ROOT@@/smf/method/vm-agent-setup %m"
+      timeout_seconds="600">
+      <method_context>
+        <method_credential user="root" group="staff"/>
+        <method_environment>
+          <envvar name="PATH" value="/usr/bin:/usr/sbin"/>
+        </method_environment>
+      </method_context>
+    </exec_method>
+
+    <exec_method type="method" name="stop" exec=":true" timeout_seconds="60" />
+
+    <property_group name="startd" type="framework">
+      <propval name="duration" type="astring" value="transient" />
+      <propval name="ignore_error" type="astring" value="core,signal" />
+    </property_group>
+
+    <property_group name="application" type="application">
+    </property_group>
+
+    <stability value="Evolving"/>
+
+    <template>
+      <common_name>
+        <loctext xml:lang="C">SmartDataCentre VM Agent Setup</loctext>
+      </common_name>
+    </template>
+
+  </service>
+</service_bundle>
diff --git a/smf/manifests/vm-agent.xml.in b/smf/manifests/vm-agent.xml.in
index 533084e..4c2461f 100644
--- a/smf/manifests/vm-agent.xml.in
+++ b/smf/manifests/vm-agent.xml.in
@@ -7,7 +7,7 @@
 -->
 
 <!--
-    Copyright (c) 2015, Joyent, Inc.
+    Copyright (c) 2017, Joyent, Inc.
 -->
 
 <service_bundle type="manifest" name="vm-agent">
@@ -27,14 +27,14 @@
     <exec_method
       type="method"
       name="start"
-      exec="@@ROOT@@/smf/method/vm-agent %m"
+      exec="/usr/bin/ctrun -l child -o noorphan @@ROOT@@/node/bin/node --abort_on_uncaught_exception @@ROOT@@/bin/vm-agent &amp;"
       timeout_seconds="60">
       <method_context>
         <method_credential user="root" group="staff"/>
         <method_environment>
           <!-- TODO: NODE_PATH wanted here? -->
           <envvar name="NODE_PATH" value="/usr/node_modules:/usr/vm/node_modules"/>
-          <envvar name="PATH" value="@@PREFIX@@/bin:/usr/local/bin:/opt/local/bin:/usr/bin:/usr/sbin:/bin"/>
+          <envvar name="PATH" value="@@PREFIX@@/bin:/usr/bin:/usr/sbin"/>
         </method_environment>
       </method_context>
     </exec_method>
diff --git a/smf/method/vm-agent.in b/smf/method/vm-agent-setup
similarity index 85%
rename from smf/method/vm-agent.in
rename to smf/method/vm-agent-setup
index ba65df6..0aa1083 100755
--- a/smf/method/vm-agent.in
+++ b/smf/method/vm-agent-setup
@@ -6,11 +6,11 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2017, Joyent, Inc.
 #
 
 #
-# SMF Startup script for vm-agent
+# Runs on node (CN + HN) boot to setup log rotation for vm-agent logs.
 #
 
 set -o xtrace
@@ -37,7 +37,6 @@ function setup_logadm {
 case "$1" in
 'start')
     setup_logadm
-    /usr/bin/ctrun -l child -o noorphan @@ROOT@@/node/bin/node --abort_on_uncaught_exception @@ROOT@@/bin/vm-agent &
     ;;
 
 'stop')
-- 
2.21.0

