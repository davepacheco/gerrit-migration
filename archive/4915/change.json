{"project":"joyent/illumos-joyent","branch":"master","id":"I20f1f63c28d59d3ecaae72024228e5abab37bebb","number":"4915","subject":"OS-7257 race in cpustat(1) results in dropped output Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e Reviewed by: Rob Johnston \u003crob.johnston@joyent.com\u003e Approved by: Robert Mustacchi \u003crm@joyent.com\u003e","owner":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"url":"https://cr.joyent.us/4915","commitMessage":"OS-7257 race in cpustat(1) results in dropped output\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\nReviewed by: Rob Johnston \u003crob.johnston@joyent.com\u003e\nApproved by: Robert Mustacchi \u003crm@joyent.com\u003e\n","createdOn":1538521478,"lastUpdated":1538524492,"open":false,"status":"MERGED","comments":[{"timestamp":1538521478,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Uploaded patch set 1."},{"timestamp":1538522138,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1538522140,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1538522333,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1538522659,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1: Code-Review+1\n\n(2 comments)"},{"timestamp":1538522701,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 1: Code-Review+1\n\nVery well."},{"timestamp":1538522703,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1538522849,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"Patch Set 2: Commit message was updated."},{"timestamp":1538522951,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2: Integration-Approval+1"},{"timestamp":1538524492,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Bryan Cantrill"}],"currentPatchSet":{"number":"2","revision":"f5903b691655d2bffd8dfb3bcee76486d7d59240","parents":["fe10e0740dd87c89538183dcb46f8787d84d1c54"],"ref":"refs/changes/15/4915/2","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1538522849,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522659,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522701,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522703,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1538522951,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1538524492,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/cpc/common/cpustat.c","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":19,"sizeDeletions":0},"patchSets":[{"number":"1","revision":"20f1f63c28d59d3ecaae72024228e5abab37bebb","parents":["fe10e0740dd87c89538183dcb46f8787d84d1c54"],"ref":"refs/changes/15/4915/1","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1538521478,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522659,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522701,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522703,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"comments":[{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Should we not handle a possible failure of \"fcntl()\" here?"},{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"We should probably check for the failure of the F_GETFL fnctl so we don\u0027t try to pass -1 | O_APPEND."},{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"STDOUT_FILENO?"},{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"The rest of the code uses \"1\" for its writes and so on -- so I wanted to keep it consistent, for better or for worse."},{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"message":"F_GETFL can\u0027t actually return a negative number for stdout -- it is defined to return the flags."},{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I guess someone closing stdout is going to leave us with more problems than its worth addressing here."},{"file":"usr/src/cmd/cpc/common/cpustat.c","line":304,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Seems reasonable."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/cpc/common/cpustat.c","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":19,"sizeDeletions":0},{"number":"2","revision":"f5903b691655d2bffd8dfb3bcee76486d7d59240","parents":["fe10e0740dd87c89538183dcb46f8787d84d1c54"],"ref":"refs/changes/15/4915/2","uploader":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"createdOn":1538522849,"author":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522659,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1538522951,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522701,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1538524492,"by":{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538522703,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/cmd/cpc/common/cpustat.c","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":19,"sizeDeletions":0}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},{"name":"Bryan Cantrill","email":"bryan@joyent.com","username":"bcantrill"}]}