{"project":"joyent/manta-remora","branch":"master","id":"I05390d63b1fba26a7c5ab0a93af8256aa38fca39","number":"6830","subject":"MANTA-4497 Rebalancer Agent: Define and implement unit test cases Reviewed by: Rui Loura \u003crui.loura@joyent.com\u003e Approved by: Rui Loura \u003crui.loura@joyent.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/6830","commitMessage":"MANTA-4497 Rebalancer Agent: Define and implement unit test cases\nReviewed by: Rui Loura \u003crui.loura@joyent.com\u003e\nApproved by: Rui Loura \u003crui.loura@joyent.com\u003e\n","createdOn":1566496511,"lastUpdated":1567112256,"open":false,"status":"MERGED","comments":[{"timestamp":1566496511,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1566935743,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1566936498,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1566936575,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1566936691,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5."},{"timestamp":1566943795,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing-1\n\n\"make check\" exited with status 2\n\n    Compiling openssl v0.10.24\n     Checking openssl-sys v0.9.49\n error: aborting due to previous error\n \n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1566993383,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 5:\n\n(4 comments)\n\nJust some questions for this pass.  \n\nOne high level question... it is not clear to me what runs test_init.sh.  Does that have to be invoked manually before running `cargo test`?"},{"timestamp":1567020444,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1567024712,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 5:\n\n(1 comment)\n\nAlso, I forgot to mention, yes, test_init.sh needs to run first.  It\u0027s what places objects on to the storage node (or localhost depending on the mode) as well as generate the sqlite database containing the assignment."},{"timestamp":1567105563,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1567105984,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 6."},{"timestamp":1567106070,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing-1\n\n\"make check\" exited with status 2\n\n \n     Checking aho-corasick v0.7.6\n error: aborting due to previous error\n \n error: Could not compile `typenum`.\n warning: build failed, waiting for other jobs to finish...\n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:3:5\n   |\n 3 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n  --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:6:5\n   |\n 6 | use std::convert::TryInto;\n   |     ^^^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1124:52\n      |\n 1124 |         let bytes: [u8; 4] \u003d self.b.dict[pos..end].try_into().unwrap();\n      |                                                    ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n     --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/deflate/core.rs:1133:56\n      |\n 1133 |         let bytes: [u8; 8] \u003d self.b.dict[pos..pos + 8].try_into().unwrap();\n      |                                                        ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:342:44\n     |\n 342 |         let two_bytes \u003d iter.as_ref()[..2].try_into().unwrap();\n     |                                            ^^^^^^^^\n \n error[E0658]: use of unstable library feature \u0027try_from\u0027 (see issue #33417)\n    --\u003e /home/build/.cargo/registry/src/github.com-1ecc6299db9ec823/miniz_oxide-0.3.2/src/inflate/core.rs:357:54\n     |\n 357 |         let four_bytes: [u8; 4] \u003d iter.as_ref()[..4].try_into().unwrap();\n     |                                                      ^^^^^^^^\n \n error: aborting due to 6 previous errors\n \n For more information about this error, try `rustc --explain E0658`.\n error: Could not compile `miniz_oxide`.\n warning: build failed, waiting for other jobs to finish...\n error: build failed\n gmake: *** [Makefile:12: check] Error 101"},{"timestamp":1567110149,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1"},{"timestamp":1567112244,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1567112256,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"7","revision":"05390d63b1fba26a7c5ab0a93af8256aa38fca39","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/7","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1567112244,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1567106070,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567110149,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567110149,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1567112256,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":257,"deletions":-5},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":712,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"73b85d3841a72845d6aae20c90a4fc578310721b","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1566496511,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Cargo.toml","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":197,"deletions":-2},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":164,"deletions":0}],"sizeInsertions":647,"sizeDeletions":-3},{"number":"2","revision":"50783567ac943597da7bc852e0a12f7d966732ed","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1566935743,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Cargo.toml","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":256,"deletions":-4},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":712,"sizeDeletions":-5},{"number":"3","revision":"e0740e32f85aa7b9f125056d3561b25aac6f726f","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1566936498,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":255,"deletions":-4},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":710,"sizeDeletions":-5},{"number":"4","revision":"5b01fa50b7e810c492dc637078dea4da2da9178b","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1566936575,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":255,"deletions":-4},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":710,"sizeDeletions":-5},{"number":"5","revision":"48795cea5b2b7b7705cdaf61783216d1c94a2de6","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1566936691,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1566943795,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567105563,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"comments":[{"file":"src/agent.rs","line":253,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"This takes a path with a uuid, correct?"},{"file":"src/agent.rs","line":253,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Yeah, it\u0027s a path.  I think when I originally implemented this weeks ago, it actually only took the uuid and it tacked on the path under the hood.  Then at some point, I realized that I may want to recall assignments from either the completed directory OR the scheduled directory and that\u0027s when the argument became more than a uuid.  I should update this comment to reflect that."},{"file":"src/agent.rs","line":831,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"Does this need to be a Vec\u003cu8\u003e?  I haven\u0027t used the gotham test server before.  Will it accept something like this (https://docs.rs/reqwest/0.9.20/reqwest/#json) without having to convert it to bytes before sending?\n\nI am asking because presumably the agent endpoint is similar."},{"file":"src/agent.rs","line":831,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"It can also be a string.  I believe something like this can be done:\n\nlet body \u003d serde_json::to_string(tasks).expect(\"Serialized assignment\");\n\nIt\u0027s hard to tell from the documentation, but in this case, whether it\u0027s a string or a vector doesn\u0027t seem to impact us either way in this case.  Why you\u0027d want to use one over another isn\u0027t even explicitly obvious to me.  My only theory is that the use of strings is also intended for JSON objects that don\u0027t necessarily have a type definition in rust.\n\nYou should able to send an assignment as a string if that\u0027s what you\u0027re wondering."},{"file":"src/agent.rs","line":847,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"If a JSON string was used, maybe this step wouldn\u0027t be needed? Again, not sure exactly how this crate works."},{"file":"src/agent.rs","line":847,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"One way or another it\u0027s needed since I am using serde_json on the sending end -- it\u0027s the only way that I know of to \"stringify\" an object in order to pack the body of a response.  Is there another way?\n\nIt is possible to use serde_json::to_string() instead of serde_json::to_vec(), but in this case, I don\u0027t know if it makes a big difference either way.  I think serde_json::to_string() is largely intended for use with typeless JSON objects, but it can be used on a strongly typed object too.\n\nThe TestServer API for the client (I believe) is based on hyper client, so the body of the response is a vector of bytes, per the documentation and the compiler."},{"file":"src/agent.rs","line":962,"reviewer":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},"message":"If I\u0027m reading this call stack correctly the string \"areacodes\" is the \"uuid\" that assignment recall uses, correct?"},{"file":"src/agent.rs","line":962,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Yeah, but for what it\u0027s worth, that\u0027s not the uuid of the actual assignment.  I just load the database file and send off the information to the agent where the real uuid is generated (today).  I know, we\u0027re going to hand the agent a uuid with the assignment, but I don\u0027t want to make that part of this change.  I\u0027m thinking just change the commentary around assignment_recall to omit any mention of the uuid and instead just say \"path\"."},{"file":"src/agent.rs","line":962,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Also, for what it\u0027s worth, in this iteration of the code, it probably doesn\u0027t matter that the uuid ends up being something erroneous because we never send that part of the assignment over.  I can rename \"areacodes\" to be uuid compliant and also add something in assignment_recall that looks at the file name and fails if it doesn\u0027t match a uuid type of naming convention as part of this change although it might be easier to fold that in with MANTA-4523."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":256,"deletions":-4},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":711,"sizeDeletions":-5},{"number":"6","revision":"0ac6fadc950d2397f3fb11beedab2fe6eae12a2a","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/6","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1567105984,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1567106070,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567110149,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567110149,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":257,"deletions":-5},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":712,"sizeDeletions":-6},{"number":"7","revision":"05390d63b1fba26a7c5ab0a93af8256aa38fca39","parents":["eb3e362d83b76a4d64b2065b2816e6533b0ec581"],"ref":"refs/changes/30/6830/7","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1567112244,"author":{"name":"rhb2","email":"robert.bogart@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1567106070,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1567110149,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1567110149,"by":{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"}},{"type":"SUBM","value":"1","grantedOn":1567112256,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/agent.rs","type":"MODIFIED","insertions":257,"deletions":-5},{"file":"src/jobs/mod.rs","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/agent/files/area_codes_by_state.csv","type":"ADDED","insertions":284,"deletions":0},{"file":"test/agent/test_init.sh","type":"ADDED","insertions":170,"deletions":0}],"sizeInsertions":712,"sizeDeletions":-6}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Rui Loura","email":"rui@joyent.com","username":"rjloura"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}