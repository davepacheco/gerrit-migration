{"project":"joyent/pgstatsmon","branch":"master","id":"I8415b87290b808d4e25dd113c6412c5f8449bbca","number":"3106","subject":"joyent/pgstatsmon#1 support Prometheus-style metric collection Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"url":"https://cr.joyent.us/3106","commitMessage":"joyent/pgstatsmon#1 support Prometheus-style metric collection\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1513182982,"lastUpdated":1513639106,"open":false,"status":"MERGED","comments":[{"timestamp":1513182982,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 1."},{"timestamp":1513182985,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513183040,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 2."},{"timestamp":1513183042,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513185456,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2: Code-Review+1\n\n(9 comments)\n\nThis looks terrific!"},{"timestamp":1513286909,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 3."},{"timestamp":1513286912,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513287073,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 4."},{"timestamp":1513287075,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513287103,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(3 comments)\n\nThanks Dave"},{"timestamp":1513360529,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1\n\n(3 comments)"},{"timestamp":1513637903,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1513639094,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1513639106,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kody A Kantor"}],"currentPatchSet":{"number":"5","revision":"8415b87290b808d4e25dd113c6412c5f8449bbca","parents":["f0697ede7f235eafcb20d37a447725568ab1a323"],"ref":"refs/changes/06/3106/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1513639094,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513287075,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513360529,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513637903,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1513639106,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"bin/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":198,"deletions":-151},{"file":"lib/queries.js","type":"ADDED","insertions":230,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":443,"sizeDeletions":-165},"patchSets":[{"number":"1","revision":"2fd88c2642d56fb7e4b080f9412ec578539e9a81","parents":["f0697ede7f235eafcb20d37a447725568ab1a323"],"ref":"refs/changes/06/3106/1","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1513182982,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513182985,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"bin/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/.config.json.swp","type":"ADDED","insertions":0,"deletions":0},{"file":"etc/config.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":165,"deletions":-151},{"file":"lib/queries.js","type":"ADDED","insertions":134,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":313,"sizeDeletions":-165},{"number":"2","revision":"1c4df328f5f51208aef8c0c8ff7c9b882d7f860e","parents":["f0697ede7f235eafcb20d37a447725568ab1a323"],"ref":"refs/changes/06/3106/2","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1513183040,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513185456,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513183042,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/pgstatsmon.js","line":252,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we expose some metrics of our own for stuff like this?"},{"file":"lib/pgstatsmon.js","line":324,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Should we bump our own separate counter for this?"},{"file":"lib/pgstatsmon.js","line":341,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Same."},{"file":"lib/queries.js","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"This file could use a comment describing the format.  It would be neat if there were a JSON schema, too, so there would be nice messages if somebody makes a mistake editing it."},{"file":"lib/queries.js","line":21,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"If there\u0027s room, it\u0027d be nice to add \"estimated\" to the help output of these."},{"file":"lib/queries.js","line":25,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"We talked at one point about having counters for the WAL position and calculating the lag in bytes as a delta.  That\u0027s a little more flexible, since we could record WAL write throughput, too."},{"file":"lib/queries.js","line":25,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yeah. I\u0027m planning on shoring up the exact queries in another CR. \n\nThe WAL record data type varies between PG 9.2 and 9.6, so there might be a larger change necessary to support the different versions."},{"file":"lib/queries.js","line":25,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sounds good."},{"file":"lib/queries.js","line":37,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Aren\u0027t these bytes?"},{"file":"lib/queries.js","line":37,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Herp. Thanks. I forgot to check this."},{"file":"lib/queries.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Would it make sense to have this be a delta from the parameter that controls when the autovacuum will kick off?  Or maybe to provide that as a separate metric?"},{"file":"lib/queries.js","line":52,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yep! I\u0027m planning on working out the exact query for this in the same CR I use to address the WAL positions if that\u0027s fine."},{"file":"lib/queries.js","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Sounds good."},{"file":"lib/queries.js","line":62,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"maybe add \"process\" (i.e., \"worker process state\")?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"bin/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":165,"deletions":-151},{"file":"lib/queries.js","type":"ADDED","insertions":134,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":313,"sizeDeletions":-165},{"number":"3","revision":"47e075efea8ec3b0cfdc2c98cd603d0f85481afe","parents":["f0697ede7f235eafcb20d37a447725568ab1a323"],"ref":"refs/changes/06/3106/3","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1513286909,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513286912,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"bin/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":198,"deletions":-151},{"file":"lib/queries.js","type":"ADDED","insertions":230,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":443,"sizeDeletions":-165},{"number":"4","revision":"3526570af4e9080df4989ea3406df3bada6b851d","parents":["f0697ede7f235eafcb20d37a447725568ab1a323"],"ref":"refs/changes/06/3106/4","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1513287073,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513360529,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513637903,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513287075,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/queries.js","line":4,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks for this (and sorry for not having done it originally)."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"bin/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":198,"deletions":-151},{"file":"lib/queries.js","type":"ADDED","insertions":230,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":443,"sizeDeletions":-165},{"number":"5","revision":"8415b87290b808d4e25dd113c6412c5f8449bbca","parents":["f0697ede7f235eafcb20d37a447725568ab1a323"],"ref":"refs/changes/06/3106/5","uploader":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"createdOn":1513639094,"author":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513360529,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513637903,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513287075,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1513639106,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":2,"deletions":-3},{"file":"bin/pgstatsmon.js","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"etc/config.json","type":"MODIFIED","insertions":6,"deletions":-5},{"file":"lib/pgstatsmon.js","type":"MODIFIED","insertions":198,"deletions":-151},{"file":"lib/queries.js","type":"ADDED","insertions":230,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-4}],"sizeInsertions":443,"sizeDeletions":-165}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}]}