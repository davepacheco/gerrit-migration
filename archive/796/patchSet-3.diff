From b92a23df1def462d803fe4e607a14bed74e0ca55 Mon Sep 17 00:00:00 2001
From: Patrick Mooney <pmooney@pfmooney.com>
Date: Thu, 27 Oct 2016 21:19:36 +0000
Subject: [PATCH] OS-5748 lxbrand /proc/1/stat access fails Reviewed by: Jerry
 Jelinek <jerry.jelinek@joyent.com> Approved by: Jerry Jelinek
 <jerry.jelinek@joyent.com>

---
 usr/src/uts/common/brand/lx/procfs/lx_prsubr.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/common/brand/lx/procfs/lx_prsubr.c b/usr/src/uts/common/brand/lx/procfs/lx_prsubr.c
index 0e26346b63..f4897385d1 100644
--- a/usr/src/uts/common/brand/lx/procfs/lx_prsubr.c
+++ b/usr/src/uts/common/brand/lx/procfs/lx_prsubr.c
@@ -223,11 +223,14 @@ retry:
 	/*
 	 * Make sure that thread lookups (where non-main LX threads are
 	 * assigned a pid not equal to the encompassing parent) match the pid
-	 * of the encompasing directory.
+	 * of the encompasing directory.  This must be performed carefully for
+	 * the Linux pid 1 as it will not equal the native pid despite the
+	 * process matching.
 	 *
 	 * This is necessary to constrain paths such as /proc/<pid>/task/<tid>.
 	 */
-	if (lxpnp->lxpr_pid != 0 && lxpnp->lxpr_pid != pid) {
+	if (lxpnp->lxpr_pid != 0 && lxpnp->lxpr_pid != pid &&
+	    !(pid == 1 && lxpnp->lxpr_pid == zone->zone_proc_initpid)) {
 		klwp_t *lwp;
 		lx_lwp_data_t *lwpd;
 
-- 
2.21.0

