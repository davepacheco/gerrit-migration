From 8ec9ab10a047556dd9c198d8b3c4c77270bf1180 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Wed, 20 Sep 2017 12:03:18 -0700
Subject: [PATCH] =?UTF-8?q?TOOLS-1842=20'sdcadm=20create=20SERVICE-NAME=20?=
 =?UTF-8?q?--server=3DUUID'=20fails=20with=20'Unknown=20change=20type:=20i?=
 =?UTF-8?q?nstances'=20Reviewed=20by:=20Pedro=20Palaz=C3=B3n=20Candel=20<p?=
 =?UTF-8?q?edro@joyent.com>=20Approved=20by:=20Pedro=20Palaz=C3=B3n=20Cand?=
 =?UTF-8?q?el=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.md    |  4 ++++
 lib/sdcadm.js | 29 ++++++++++++++++++-----------
 package.json  |  2 +-
 3 files changed, 23 insertions(+), 12 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 3e52fa2..aac37c5 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.16.1
+
+- TOOLS-1842 Fix 'sdcadm create SERVICE-NAME -s SERVER' which was failing
+  after TOOLS-1770 changes.
 
 ## 1.16.0
 
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index f492199..44cdbeb 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -2776,14 +2776,13 @@ SdcAdm.prototype.genUpdatePlan = function genUpdatePlan(options, cb) {
 
             var changeFromSvc = {};
             var changeFromInst = {};
-            var i, ch, typeTarg, svc;
+            var i, ch, svc;
             for (i = 0; i < changes.length; i++) {
                 ch = changes[i];
-                // e.g. 'update-service' -> 'service'
-                // (Some instance changes like 'delete' or 'create' do not
-                // include the two pieces).
-                typeTarg = ch.type.split('-')[1] || 'instance';
-                if (typeTarg === 'service') {
+                switch (ch.type) {
+                case 'delete-service':
+                case 'update-service':
+                case 'create-instances':
                     svc = ch.service.name;
                     if (changeFromSvc[svc]) {
                         next(new errors.UpdateError(format(
@@ -2793,7 +2792,14 @@ SdcAdm.prototype.genUpdatePlan = function genUpdatePlan(options, cb) {
                         return;
                     }
                     changeFromSvc[svc] = ch;
-                } else if (typeTarg === 'instance') {
+                    break;
+                case 'delete':
+                    // `validateChanges` is too lenient that it allows "delete".
+                    // Eventually it should become more strict to require
+                    // explicit "delete-instance".
+                    // fall through
+                case 'delete-instance':
+                case 'update-instance':
                     var inst = (ch.instance) ? ch.instance.instance : null;
                     if (changeFromInst[inst]) {
                         next(new errors.UpdateError(format(
@@ -2803,16 +2809,17 @@ SdcAdm.prototype.genUpdatePlan = function genUpdatePlan(options, cb) {
                         return;
                     }
                     changeFromInst[inst] = ch;
-                } else {
+                    break;
+                default:
                     next(new errors.UpdateError(format(
-                        'Unknown change type: %s', typeTarg)));
+                        'Unknown change type: %s', ch.type)));
                     return;
                 }
             }
             for (i = 0; i < changes.length; i++) {
                 ch = changes[i];
-                typeTarg = ch.type.split('-')[1] || 'instance';
-                if (typeTarg === 'instance') {
+                if (ch.type === 'update-instance' ||
+                    ch.type === 'delete-instance') {
                     svc = ch.service.name;
                     if (changeFromSvc[svc]) {
                         next(new errors.UpdateError(format(
diff --git a/package.json b/package.json
index f91ef8e..30d0a29 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.16.0",
+  "version": "1.16.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

