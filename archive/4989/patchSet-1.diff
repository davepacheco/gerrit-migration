commit d4a02061df3dbf659283b43d0d677a107eff4fc8 (refs/changes/89/4989/1)
Author: Alex Wilson <alex.wilson@joyent.com>
Date:   2018-10-22T16:35:56-07:00 (12 months ago)
    
    TRITON-880 want ufds to store and understand Yubikey attestation certs

diff --git a/lib/replicator/transforms/sdckey.js b/lib/replicator/transforms/sdckey.js
index 11df477..4c7415c 100644
--- a/lib/replicator/transforms/sdckey.js
+++ b/lib/replicator/transforms/sdckey.js
@@ -30,6 +30,17 @@ function add(opts, cb) {
     var uuid = changes._owner[0];
     var key = sprintf('/uuid/%s', uuid);
 
+    var attribs = {};
+    if (changes.attested && changes.attested[0] === 'true') {
+        attribs.attested = true;
+    }
+    if (changes.ykpinrequired && changes.ykpinrequired[0] === 'true') {
+        attribs.pin = true;
+    }
+    if (changes.yktouchrequired && changes.yktouchrequired[0] === 'true') {
+        attribs.touch = true;
+    }
+
     redis.get(key, function (err, res) {
         if (err) {
             cb(err);
@@ -40,6 +51,10 @@ function add(opts, cb) {
 
         payload.keys = payload.keys || {};
         payload.keys[fingerprint] = pkcs;
+
+        payload.key_info = payload.key_info || {};
+        payload.key_info[fingerprint] = attribs;
+
         batch.set(key, JSON.stringify(payload));
 
         log.debug({batch: batch.queue}, 'sdckey.add: done');
@@ -77,6 +92,9 @@ function del(opts, cb) {
         if (payload.keys) {
             delete payload.keys[fingerprint];
         }
+        if (payload.key_info) {
+            delete payload.key_info[fingerprint];
+        }
 
         batch.set(key, JSON.stringify(payload));
         log.debug({batch: batch.queue}, 'sdckey.del: done');
diff --git a/test/sdckey.test.js b/test/sdckey.test.js
index 5724287..9c8cc92 100644
--- a/test/sdckey.test.js
+++ b/test/sdckey.test.js
@@ -47,6 +47,9 @@ test('add - account', function (t) {
             'fingerprint': [
                 '7b:a4:7c:6c:c7:2f:d9:a6:bd:ec:1b:2f:e8:3d:40:18'
             ],
+            'attested': [
+                'false'
+            ],
             '_owner': [
                 '1a940615-65e9-4856-95f9-f4c530e86ca4'
             ],
@@ -69,6 +72,9 @@ test('add - account', function (t) {
     var value = {
         keys: {
             '7b:a4:7c:6c:c7:2f:d9:a6:bd:ec:1b:2f:e8:3d:40:18': 'elided-pkcs'
+        },
+        key_info: {
+            '7b:a4:7c:6c:c7:2f:d9:a6:bd:ec:1b:2f:e8:3d:40:18': {}
         }
     };
 
@@ -108,6 +114,15 @@ test('add - user', function (t) {
             'pkcs': [
                 'elided-pkcs'
             ],
+            'attested': [
+                'true'
+            ],
+            'ykpinrequired': [
+                'false'
+            ],
+            'yktouchrequired': [
+                'true'
+            ],
             'fingerprint': [
                 '7b:a4:7c:6c:c7:2f:d9:a6:bd:ec:1b:2f:e8:3d:40:18'
             ],
@@ -134,6 +149,12 @@ test('add - user', function (t) {
     var value = {
         keys: {
             '7b:a4:7c:6c:c7:2f:d9:a6:bd:ec:1b:2f:e8:3d:40:18': 'elided-pkcs'
+        },
+        key_info: {
+            '7b:a4:7c:6c:c7:2f:d9:a6:bd:ec:1b:2f:e8:3d:40:18': {
+                'attested': true,
+                'touch': true
+            }
         }
     };
 
