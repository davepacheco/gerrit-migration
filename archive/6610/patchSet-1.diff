From 94a4660fb13610bee94a7ea4056f32b14a43fd18 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Tue, 16 Jul 2019 13:59:33 -0700
Subject: [PATCH] OS-7892 new ssh-keygen defaults to openssh key format

---
 openssh/Patches/0001-Skip-config-check.patch  |   4 +-
 openssh/Patches/0002-PAM-Support.patch        |   4 +-
 openssh/Patches/0003-lastlogin.patch          |   4 +-
 ...ages-into-Illumos-numbering-adjust-t.patch |   4 +-
 .../0005-Deprecated-SunSSH-options.patch      |   4 +-
 .../0006-GSS-store-creds-for-Solaris.patch    |   4 +-
 .../0007-DTrace-support-for-SFTP.patch        |   4 +-
 .../0008-Add-DisableBanner-option.patch       |   4 +-
 .../Patches/0009-PAM-conversation-fix.patch   |   4 +-
 .../0010-PAM-enhancements-for-Solaris.patch   |   4 +-
 ...-SunSSH-compat-default-config-values.patch |   4 +-
 ...ate-SunSSH-compatible-server-options.patch |   4 +-
 .../0013-Solaris-Auditing-support.patch       |   4 +-
 .../0014-GSS-API-key-exchange-support.patch   |   4 +-
 ...login-to-a-role-if-PAM-is-ok-with-it.patch |   4 +-
 .../Patches/0016-PAM-setcred-failures.patch   |   4 +-
 ...0017-Don-t-call-do_pam_setcred-twice.patch |   4 +-
 .../Patches/0018-Per-session-xauthfile.patch  |   4 +-
 .../Patches/0019-PubKeyPlugin-support.patch   |   4 +-
 ...-Compatibility-fix-for-ListenAddress.patch |   4 +-
 ...ivsep-chroot-dir-if-it-doesn-t-exist.patch |   4 +-
 ...manifest-and-method-and-install-them.patch |   4 +-
 ...d_config-more-like-the-old-illumos-o.patch |   4 +-
 ...-configure-option-to-place-SSH-host-.patch |   4 +-
 .../0025-Re-enable-DSA-keys-for-pk-auth.patch |   4 +-
 ...onfig-to-check-for-GSSAPI-on-Illumos.patch |   4 +-
 ...d-options-based-on-etc-default-login.patch |   4 +-
 ...r-SunSSH_1.5-should-include-old-DH-K.patch |   4 +-
 ...LANG-and-LC_-environment-variables-b.patch |   4 +-
 ...ssh-keygen-and-ssh-add-to-old-FP-for.patch |   4 +-
 ...-Restore-tcpwrappers-libwrap-support.patch |   4 +-
 ...lback-copy-of-DH-moduli-in-a-system-.patch |   4 +-
 ...ssh-keygen-to-use-old-PKCS-1-PEM-for.patch | 143 ++++++++++++++++++
 openssh/Patches/1000-smartos-dtrace32.patch   |   6 +-
 openssh/Patches/1001-sunw_ssl.patch           |   6 +-
 35 files changed, 213 insertions(+), 70 deletions(-)
 create mode 100644 openssh/Patches/0033-Temporarily-set-ssh-keygen-to-use-old-PKCS-1-PEM-for.patch

diff --git a/openssh/Patches/0001-Skip-config-check.patch b/openssh/Patches/0001-Skip-config-check.patch
index aa49962..dad4e84 100644
--- a/openssh/Patches/0001-Skip-config-check.patch
+++ b/openssh/Patches/0001-Skip-config-check.patch
@@ -1,7 +1,7 @@
 From c73038ed9429a7703b9a7d95334893d1d1fa6a78 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:31:53 -0700
-Subject: [PATCH 01/34] Skip config check
+Subject: [PATCH 01/35] Skip config check
 
 #
 # This change is to remove some misleading error messages when running
@@ -37,5 +37,5 @@ index 126b2c74..b89d638f 100644
  install-files:
  	$(MKDIR_P) $(DESTDIR)$(bindir)
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0002-PAM-Support.patch b/openssh/Patches/0002-PAM-Support.patch
index 92a386d..ac3255d 100644
--- a/openssh/Patches/0002-PAM-Support.patch
+++ b/openssh/Patches/0002-PAM-Support.patch
@@ -1,7 +1,7 @@
 From 38db2f2128af55e2fc1a287f114b6c67d09507ff Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:34:19 -0700
-Subject: [PATCH 02/34] PAM Support
+Subject: [PATCH 02/35] PAM Support
 
 #
 # To comply to the Solaris PAM policy, the UsePAM option is changed to be
@@ -50,5 +50,5 @@ index 932d363b..d6f430e4 100644
  	/* Standard Options */
  	case sBadOption:
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0003-lastlogin.patch b/openssh/Patches/0003-lastlogin.patch
index 2ebb58c..ecb2f19 100644
--- a/openssh/Patches/0003-lastlogin.patch
+++ b/openssh/Patches/0003-lastlogin.patch
@@ -1,7 +1,7 @@
 From b06c3bd0eb76b40b9b2329bc08b4a04c5721fa8a Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:34:41 -0700
-Subject: [PATCH 03/34] lastlogin
+Subject: [PATCH 03/35] lastlogin
 
 *** old/servconf.c Wed Sep 17 02:54:26 2014
 ---
@@ -34,5 +34,5 @@ index c6484370..6050adda 100644
  .An -nosplit
  OpenSSH is a derivative of the original and free
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0004-Reorganise-man-pages-into-Illumos-numbering-adjust-t.patch b/openssh/Patches/0004-Reorganise-man-pages-into-Illumos-numbering-adjust-t.patch
index f2a35d7..6e18be6 100644
--- a/openssh/Patches/0004-Reorganise-man-pages-into-Illumos-numbering-adjust-t.patch
+++ b/openssh/Patches/0004-Reorganise-man-pages-into-Illumos-numbering-adjust-t.patch
@@ -1,7 +1,7 @@
 From 77ecfcdc322fb88737ba1311d5fe0ef424de2cc0 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:34:55 -0700
-Subject: [PATCH 04/34] Reorganise man pages into Illumos numbering, adjust
+Subject: [PATCH 04/35] Reorganise man pages into Illumos numbering, adjust
  text
 
 ---
@@ -1373,5 +1373,5 @@ index 6050adda..8b5d40a5 100644
  .Sh AUTHORS
  .An -nosplit
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0005-Deprecated-SunSSH-options.patch b/openssh/Patches/0005-Deprecated-SunSSH-options.patch
index c95c47a..20532bb 100644
--- a/openssh/Patches/0005-Deprecated-SunSSH-options.patch
+++ b/openssh/Patches/0005-Deprecated-SunSSH-options.patch
@@ -1,7 +1,7 @@
 From 3b68156b76d0f41f78153fa778ed294428159db7 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:35:12 -0700
-Subject: [PATCH 05/34] Deprecated SunSSH options
+Subject: [PATCH 05/35] Deprecated SunSSH options
 
 #
 # To make the transition from SunSSH to OpenSSH as smooth as possible, we
@@ -45,5 +45,5 @@ index 43381152..7612b54d 100644
  };
  
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0006-GSS-store-creds-for-Solaris.patch b/openssh/Patches/0006-GSS-store-creds-for-Solaris.patch
index 9e6a3f9..7a5d332 100644
--- a/openssh/Patches/0006-GSS-store-creds-for-Solaris.patch
+++ b/openssh/Patches/0006-GSS-store-creds-for-Solaris.patch
@@ -1,7 +1,7 @@
 From 38ea92225566d34b1941865619a526dbacdd95fd Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:35:34 -0700
-Subject: [PATCH 06/34] GSS store creds for Solaris
+Subject: [PATCH 06/35] GSS store creds for Solaris
 
 ---
  configure.ac    |  3 +++
@@ -174,5 +174,5 @@ index ba26287b..2e6cf143 100644
  #endif
  #ifdef USE_PAM
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0007-DTrace-support-for-SFTP.patch b/openssh/Patches/0007-DTrace-support-for-SFTP.patch
index 2a436e7..f3876dd 100644
--- a/openssh/Patches/0007-DTrace-support-for-SFTP.patch
+++ b/openssh/Patches/0007-DTrace-support-for-SFTP.patch
@@ -1,7 +1,7 @@
 From 321b94d7b0b66c76535c1977e7fa66176c5f3ad1 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:35:43 -0700
-Subject: [PATCH 07/34] DTrace support for SFTP
+Subject: [PATCH 07/35] DTrace support for SFTP
 
 ---
  Makefile.in          | 24 ++++++++++++---
@@ -375,5 +375,5 @@ index 00000000..4b18e6ec
 +
 +#endif /* _SFTP_PROVIDER_IMPL_H */
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0008-Add-DisableBanner-option.patch b/openssh/Patches/0008-Add-DisableBanner-option.patch
index 7432442..b940759 100644
--- a/openssh/Patches/0008-Add-DisableBanner-option.patch
+++ b/openssh/Patches/0008-Add-DisableBanner-option.patch
@@ -1,7 +1,7 @@
 From 89b96ba5c87db219f18a1640e6c1004430885e01 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:36:00 -0700
-Subject: [PATCH 08/34] Add DisableBanner option
+Subject: [PATCH 08/35] Add DisableBanner option
 
 ---
  readconf.c    | 31 +++++++++++++++++++++++++++++++
@@ -188,5 +188,5 @@ index 1675f393..ebdbeabf 100644
  	return 0;
  }
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0009-PAM-conversation-fix.patch b/openssh/Patches/0009-PAM-conversation-fix.patch
index bcb8a8f..6f751f5 100644
--- a/openssh/Patches/0009-PAM-conversation-fix.patch
+++ b/openssh/Patches/0009-PAM-conversation-fix.patch
@@ -1,7 +1,7 @@
 From e264c94da2b26887dbc28793c6fc42385f0f8a99 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:36:13 -0700
-Subject: [PATCH 09/34] PAM conversation fix
+Subject: [PATCH 09/35] PAM conversation fix
 
 ---
  auth-pam.c | 36 ++++++++++++++++++++++++++++++++++++
@@ -94,5 +94,5 @@ index 1dec53e9..b0c3d2d3 100644
  		debug("PAM: password authentication accepted for %.100s",
  		    authctxt->user);
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0010-PAM-enhancements-for-Solaris.patch b/openssh/Patches/0010-PAM-enhancements-for-Solaris.patch
index ccb39f0..c420117 100644
--- a/openssh/Patches/0010-PAM-enhancements-for-Solaris.patch
+++ b/openssh/Patches/0010-PAM-enhancements-for-Solaris.patch
@@ -1,7 +1,7 @@
 From b3b2132fc89d826365c93715c5dd7d5e902a789d Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:36:19 -0700
-Subject: [PATCH 10/34] PAM enhancements for Solaris
+Subject: [PATCH 10/35] PAM enhancements for Solaris
 
 ---
  auth-pam.c     | 113 +++++++++++++++++++++++++++++++++++++++++++++++++
@@ -666,5 +666,5 @@ index 8b5d40a5..6eac9806 100644
  Optionally specifies additional text to append to the SSH protocol banner
  sent by the server upon connection.
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0011-SunSSH-compat-default-config-values.patch b/openssh/Patches/0011-SunSSH-compat-default-config-values.patch
index 81a93d1..f42d6c0 100644
--- a/openssh/Patches/0011-SunSSH-compat-default-config-values.patch
+++ b/openssh/Patches/0011-SunSSH-compat-default-config-values.patch
@@ -1,7 +1,7 @@
 From 14e01e463b4fd9d7aa89c26d56c8bd697b6ff6af Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:36:22 -0700
-Subject: [PATCH 11/34] SunSSH compat default config values
+Subject: [PATCH 11/35] SunSSH compat default config values
 
 Some options in OpenSSH have different default values from those in SunSSH.
 To make the transition smoother from SunSSH to OpenSSH, we change default
@@ -128,5 +128,5 @@ index 6eac9806..446e67e7 100644
  When X11 forwarding is enabled, there may be additional exposure to
  the server and to client displays if the
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0012-Deprecate-SunSSH-compatible-server-options.patch b/openssh/Patches/0012-Deprecate-SunSSH-compatible-server-options.patch
index 9d29bdb..b74e802 100644
--- a/openssh/Patches/0012-Deprecate-SunSSH-compatible-server-options.patch
+++ b/openssh/Patches/0012-Deprecate-SunSSH-compatible-server-options.patch
@@ -1,7 +1,7 @@
 From d8c9de9b7443dcd97469c16c9cd78925915bb99d Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:36:33 -0700
-Subject: [PATCH 12/34] Deprecate SunSSH compatible server options
+Subject: [PATCH 12/35] Deprecate SunSSH compatible server options
 
 #
 # Originally we planned to only deprecate client config (ssh_config) options
@@ -57,5 +57,5 @@ index 5e870e82..93761629 100644
  	{ "revokedkeys", sRevokedKeys, SSHCFG_ALL },
  	{ "trustedusercakeys", sTrustedUserCAKeys, SSHCFG_ALL },
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0013-Solaris-Auditing-support.patch b/openssh/Patches/0013-Solaris-Auditing-support.patch
index 1909c01..389e171 100644
--- a/openssh/Patches/0013-Solaris-Auditing-support.patch
+++ b/openssh/Patches/0013-Solaris-Auditing-support.patch
@@ -1,7 +1,7 @@
 From c31040ba0ca7c7cf14b8e5f9d1c0f5eed011b909 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:37:01 -0700
-Subject: [PATCH 13/34] Solaris Auditing support
+Subject: [PATCH 13/35] Solaris Auditing support
 
 ---
  INSTALL         |  15 +-
@@ -734,5 +734,5 @@ index 2e6cf143..866f7df9 100644
  	/*
  	 * In privilege separation, we fork another child and prepare
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0014-GSS-API-key-exchange-support.patch b/openssh/Patches/0014-GSS-API-key-exchange-support.patch
index d30c84c..6d8fc59 100644
--- a/openssh/Patches/0014-GSS-API-key-exchange-support.patch
+++ b/openssh/Patches/0014-GSS-API-key-exchange-support.patch
@@ -1,7 +1,7 @@
 From 5ad94de91adf64484b2538f8b23f1c2a462e76b1 Mon Sep 17 00:00:00 2001
 From: Simon Wilkinson <simon@sxw.org.uk>
 Date: Fri, 27 Jan 2017 16:46:31 -0800
-Subject: [PATCH 14/34] GSS-API key exchange support
+Subject: [PATCH 14/35] GSS-API key exchange support
 
 ---
  ChangeLog.gssapi | 113 ++++++++++++++++
@@ -3481,5 +3481,5 @@ index f6a007fd..08348200 100644
  };
  
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0015-Enable-login-to-a-role-if-PAM-is-ok-with-it.patch b/openssh/Patches/0015-Enable-login-to-a-role-if-PAM-is-ok-with-it.patch
index 8f7d2da..bf7cf71 100644
--- a/openssh/Patches/0015-Enable-login-to-a-role-if-PAM-is-ok-with-it.patch
+++ b/openssh/Patches/0015-Enable-login-to-a-role-if-PAM-is-ok-with-it.patch
@@ -1,7 +1,7 @@
 From 326be58a153548e8218d1cdc2b0224612814d63f Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:38:19 -0700
-Subject: [PATCH 15/34] Enable login to a role if PAM is ok with it
+Subject: [PATCH 15/35] Enable login to a role if PAM is ok with it
 
 ---
  auth-pam.c        | 14 ++++++++++++++
@@ -154,5 +154,5 @@ index 426a5736..0190d034 100644
  
  	if ((r = sshbuf_put_u32(m, ret)) != 0 ||
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0016-PAM-setcred-failures.patch b/openssh/Patches/0016-PAM-setcred-failures.patch
index 0e17f3f..f6e4d33 100644
--- a/openssh/Patches/0016-PAM-setcred-failures.patch
+++ b/openssh/Patches/0016-PAM-setcred-failures.patch
@@ -1,7 +1,7 @@
 From 587e5e335de79d83365264cbb82a1130bbd991c9 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:38:26 -0700
-Subject: [PATCH 16/34] PAM setcred failures
+Subject: [PATCH 16/35] PAM setcred failures
 
 #
 # This patch contains bug fixes to the PAM credential and session operations.
@@ -61,5 +61,5 @@ index cf692526..962b51a0 100644
  
  }
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0017-Don-t-call-do_pam_setcred-twice.patch b/openssh/Patches/0017-Don-t-call-do_pam_setcred-twice.patch
index 59c16a3..4d8facd 100644
--- a/openssh/Patches/0017-Don-t-call-do_pam_setcred-twice.patch
+++ b/openssh/Patches/0017-Don-t-call-do_pam_setcred-twice.patch
@@ -1,7 +1,7 @@
 From c03a29b1e7cbe6c40b4d32c2c9ca704e6e43a00c Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Mon, 3 Aug 2015 14:38:41 -0700
-Subject: [PATCH 17/34] Don't call do_pam_setcred twice
+Subject: [PATCH 17/35] Don't call do_pam_setcred twice
 
 # This issue has been raised with the upstream OpenSSH community:
 #
@@ -43,5 +43,5 @@ index 41acc937..f5f3ce37 100644
  	 * PAM credentials may take the form of supplementary groups.
  	 * These will have been wiped by the above initgroups() call.
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0018-Per-session-xauthfile.patch b/openssh/Patches/0018-Per-session-xauthfile.patch
index 87da37f..f5b3c73 100644
--- a/openssh/Patches/0018-Per-session-xauthfile.patch
+++ b/openssh/Patches/0018-Per-session-xauthfile.patch
@@ -1,7 +1,7 @@
 From 231cc12ac06a3dce54a48548caefa7badc4e0925 Mon Sep 17 00:00:00 2001
 From: oracle <solaris@oracle.com>
 Date: Tue, 22 Dec 2015 17:12:50 -0800
-Subject: [PATCH 18/34] Per-session xauthfile
+Subject: [PATCH 18/35] Per-session xauthfile
 
 This patch is to fix a X11 connection failure when a user's home directory
 is read-only.
@@ -238,5 +238,5 @@ index ce59dabd..1f078799 100644
  
  	int	chanid;
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0019-PubKeyPlugin-support.patch b/openssh/Patches/0019-PubKeyPlugin-support.patch
index b5e572e..dd8b6cf 100644
--- a/openssh/Patches/0019-PubKeyPlugin-support.patch
+++ b/openssh/Patches/0019-PubKeyPlugin-support.patch
@@ -1,7 +1,7 @@
 From 556dde99419ae10f0ceb60723ccaa90d5b4ebb5f Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Mon, 3 Aug 2015 16:27:44 -0700
-Subject: [PATCH 19/34] PubKeyPlugin support
+Subject: [PATCH 19/35] PubKeyPlugin support
 
 This adds the PubKeyPlugin directive and associated code from
 SunSSH, allowing an in-process shared library to be called
@@ -267,5 +267,5 @@ index 77743737..72f0c42b 100644
  
  /* Information about the incoming connection as used by Match */
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0020-Compatibility-fix-for-ListenAddress.patch b/openssh/Patches/0020-Compatibility-fix-for-ListenAddress.patch
index e068815..651ef97 100644
--- a/openssh/Patches/0020-Compatibility-fix-for-ListenAddress.patch
+++ b/openssh/Patches/0020-Compatibility-fix-for-ListenAddress.patch
@@ -1,7 +1,7 @@
 From 7bef9919e295caced9cc2c9b73c03516dbff54b2 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Mon, 3 Aug 2015 17:27:41 -0700
-Subject: [PATCH 20/34] Compatibility fix for "ListenAddress ::"
+Subject: [PATCH 20/35] Compatibility fix for "ListenAddress ::"
 
 In SunSSH, a config that specifies only "ListenAddress ::" in
 fact will listen on both IPv4 and IPv6.
@@ -37,5 +37,5 @@ index c61923c1..6c1df5ac 100644
  	options->queued_listen_addrs = NULL;
  	options->num_queued_listens = 0;
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0021-Try-to-create-privsep-chroot-dir-if-it-doesn-t-exist.patch b/openssh/Patches/0021-Try-to-create-privsep-chroot-dir-if-it-doesn-t-exist.patch
index a786d42..919841b 100644
--- a/openssh/Patches/0021-Try-to-create-privsep-chroot-dir-if-it-doesn-t-exist.patch
+++ b/openssh/Patches/0021-Try-to-create-privsep-chroot-dir-if-it-doesn-t-exist.patch
@@ -1,7 +1,7 @@
 From 74f1ea24ef32d76b13a51e80db87531631218299 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Wed, 5 Aug 2015 12:25:15 -0700
-Subject: [PATCH 21/34] Try to create privsep chroot dir if it doesn't exist
+Subject: [PATCH 21/35] Try to create privsep chroot dir if it doesn't exist
  yet
 
 ---
@@ -47,5 +47,5 @@ index 994b7c9e..e09f3934 100644
  #ifdef HAVE_CYGWIN
  		if (check_ntsec(_PATH_PRIVSEP_CHROOT_DIR) &&
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0022-Add-SMF-manifest-and-method-and-install-them.patch b/openssh/Patches/0022-Add-SMF-manifest-and-method-and-install-them.patch
index cd7d7b7..460c7ce 100644
--- a/openssh/Patches/0022-Add-SMF-manifest-and-method-and-install-them.patch
+++ b/openssh/Patches/0022-Add-SMF-manifest-and-method-and-install-them.patch
@@ -1,7 +1,7 @@
 From 9650f9c45018654a86011193c3f51414e3d69d58 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Fri, 7 Aug 2015 12:19:47 -0700
-Subject: [PATCH 22/34] Add SMF manifest and method, and install them
+Subject: [PATCH 22/35] Add SMF manifest and method, and install them
 
 ---
  Makefile.in      |   6 ++
@@ -340,5 +340,5 @@ index 00000000..e91ed553
 +exit $?
 \ No newline at end of file
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0023-Make-default-sshd_config-more-like-the-old-illumos-o.patch b/openssh/Patches/0023-Make-default-sshd_config-more-like-the-old-illumos-o.patch
index 91ce27f..b8cbca0 100644
--- a/openssh/Patches/0023-Make-default-sshd_config-more-like-the-old-illumos-o.patch
+++ b/openssh/Patches/0023-Make-default-sshd_config-more-like-the-old-illumos-o.patch
@@ -1,7 +1,7 @@
 From 21d32a4b36f94c6eae6e2f9310243a5404cbac81 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Fri, 7 Aug 2015 13:24:58 -0700
-Subject: [PATCH 23/34] Make default sshd_config more like the old illumos one
+Subject: [PATCH 23/35] Make default sshd_config more like the old illumos one
 
 ---
  sshd_config | 44 +++++++++++++++++++++++---------------------
@@ -93,5 +93,5 @@ index 2c48105f..d8e5e74b 100644
  #PermitUserEnvironment no
  #Compression delayed
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0024-Add-with-key-dir-configure-option-to-place-SSH-host-.patch b/openssh/Patches/0024-Add-with-key-dir-configure-option-to-place-SSH-host-.patch
index fc9b89e..f0dd18a 100644
--- a/openssh/Patches/0024-Add-with-key-dir-configure-option-to-place-SSH-host-.patch
+++ b/openssh/Patches/0024-Add-with-key-dir-configure-option-to-place-SSH-host-.patch
@@ -1,7 +1,7 @@
 From b6173767c53e34b6bfddb2a08954f89f097833fb Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Fri, 7 Aug 2015 13:32:53 -0700
-Subject: [PATCH 24/34] Add --with-key-dir configure option to place SSH host
+Subject: [PATCH 24/35] Add --with-key-dir configure option to place SSH host
  keys
 
 ---
@@ -126,5 +126,5 @@ index cb44caa4..61214e07 100644
  #ifndef _PATH_SSH_PROGRAM
  #define _PATH_SSH_PROGRAM		"/usr/bin/ssh"
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0025-Re-enable-DSA-keys-for-pk-auth.patch b/openssh/Patches/0025-Re-enable-DSA-keys-for-pk-auth.patch
index b3c9a80..6c4dddb 100644
--- a/openssh/Patches/0025-Re-enable-DSA-keys-for-pk-auth.patch
+++ b/openssh/Patches/0025-Re-enable-DSA-keys-for-pk-auth.patch
@@ -1,7 +1,7 @@
 From 4948042cfd14e37fbed3a9cc225f4ec2d44c9d47 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Wed, 19 Aug 2015 11:35:32 -0700
-Subject: [PATCH 25/34] Re-enable DSA keys for pk auth
+Subject: [PATCH 25/35] Re-enable DSA keys for pk auth
 
 ---
  myproposal.h  | 4 +++-
@@ -59,5 +59,5 @@ index dce30d07..3dc39cca 100644
  .Pp
  The list of available key types may also be obtained using
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0026-Don-t-use-krb5-config-to-check-for-GSSAPI-on-Illumos.patch b/openssh/Patches/0026-Don-t-use-krb5-config-to-check-for-GSSAPI-on-Illumos.patch
index f8aad9b..cd0d294 100644
--- a/openssh/Patches/0026-Don-t-use-krb5-config-to-check-for-GSSAPI-on-Illumos.patch
+++ b/openssh/Patches/0026-Don-t-use-krb5-config-to-check-for-GSSAPI-on-Illumos.patch
@@ -1,7 +1,7 @@
 From e55139013a14a4855eee7185c2626816d97e9ca3 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Fri, 21 Aug 2015 18:47:46 -0700
-Subject: [PATCH 26/34] Don't use krb5-config to check for GSSAPI on Illumos
+Subject: [PATCH 26/35] Don't use krb5-config to check for GSSAPI on Illumos
 
 ---
  configure.ac | 7 ++++++-
@@ -33,5 +33,5 @@ index 5223563d..a956f1ff 100644
  			AC_SEARCH_LIBS([dn_expand], [resolv])
  
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0027-Set-default-sshd-options-based-on-etc-default-login.patch b/openssh/Patches/0027-Set-default-sshd-options-based-on-etc-default-login.patch
index e6ed78e..3119c1f 100644
--- a/openssh/Patches/0027-Set-default-sshd-options-based-on-etc-default-login.patch
+++ b/openssh/Patches/0027-Set-default-sshd-options-based-on-etc-default-login.patch
@@ -1,7 +1,7 @@
 From 1f49e55db1b8bfc158d95368c39216bf39981d38 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Mon, 24 Aug 2015 18:57:27 -0700
-Subject: [PATCH 27/34] Set default sshd options based on /etc/default/login
+Subject: [PATCH 27/35] Set default sshd options based on /etc/default/login
 
 ---
  pathnames.h   |  1 +
@@ -141,5 +141,5 @@ index 3dc39cca..c652f116 100644
  Specifies the addresses/ports on which a remote TCP port forwarding may listen.
  The listen specification must be one of the following forms:
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0028-Compatibility-for-SunSSH_1.5-should-include-old-DH-K.patch b/openssh/Patches/0028-Compatibility-for-SunSSH_1.5-should-include-old-DH-K.patch
index 100c8f1..2f21319 100644
--- a/openssh/Patches/0028-Compatibility-for-SunSSH_1.5-should-include-old-DH-K.patch
+++ b/openssh/Patches/0028-Compatibility-for-SunSSH_1.5-should-include-old-DH-K.patch
@@ -1,7 +1,7 @@
 From 2a080be73f6b1f38b112d1009b79994c69de83c4 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Fri, 4 Sep 2015 10:38:28 -0700
-Subject: [PATCH 28/34] Compatibility for SunSSH_1.5* should include old DH KEx
+Subject: [PATCH 28/35] Compatibility for SunSSH_1.5* should include old DH KEx
  algos
 
 We use the kex compat mechanism here to recognise old SunSSH
@@ -126,5 +126,5 @@ index 0624dc6d..5cfbf28a 100644
  	debug2("%s: compat KEX proposal: %s", __func__, p);
  	if (*p == '\0')
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0029-Accept-and-send-LANG-and-LC_-environment-variables-b.patch b/openssh/Patches/0029-Accept-and-send-LANG-and-LC_-environment-variables-b.patch
index b287747..db1fd98 100644
--- a/openssh/Patches/0029-Accept-and-send-LANG-and-LC_-environment-variables-b.patch
+++ b/openssh/Patches/0029-Accept-and-send-LANG-and-LC_-environment-variables-b.patch
@@ -1,7 +1,7 @@
 From 851736f485d533b7df18d91eab609d769d79a868 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Fri, 4 Sep 2015 11:04:30 -0700
-Subject: [PATCH 29/34] Accept and send LANG and LC_* environment variables by
+Subject: [PATCH 29/35] Accept and send LANG and LC_* environment variables by
  default
 
 This preserves most of the old SunSSH locale negotiation
@@ -259,5 +259,5 @@ index c652f116..0fcf9368 100644
  Specifies which address family should be used by
  .Xr sshd 1M .
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0030-Temporarily-set-ssh-keygen-and-ssh-add-to-old-FP-for.patch b/openssh/Patches/0030-Temporarily-set-ssh-keygen-and-ssh-add-to-old-FP-for.patch
index 5abc657..63a061f 100644
--- a/openssh/Patches/0030-Temporarily-set-ssh-keygen-and-ssh-add-to-old-FP-for.patch
+++ b/openssh/Patches/0030-Temporarily-set-ssh-keygen-and-ssh-add-to-old-FP-for.patch
@@ -1,7 +1,7 @@
 From 06fe54a51934fa827979584991f37145ca18ea0f Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Wed, 9 Sep 2015 10:36:05 -0700
-Subject: [PATCH 30/34] Temporarily set ssh-keygen and ssh-add to old FP format
+Subject: [PATCH 30/35] Temporarily set ssh-keygen and ssh-add to old FP format
 
 SDC and its users have a lot of scripts that expect ssh-add
 and ssh-keygen to return fingerprints in the old format.
@@ -143,5 +143,5 @@ index 46b3af5a..61760745 100644
  				fatal("Invalid hash algorithm \"%s\"", optarg);
  			break;
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0031-Restore-tcpwrappers-libwrap-support.patch b/openssh/Patches/0031-Restore-tcpwrappers-libwrap-support.patch
index 00f2b39..2fde3af 100644
--- a/openssh/Patches/0031-Restore-tcpwrappers-libwrap-support.patch
+++ b/openssh/Patches/0031-Restore-tcpwrappers-libwrap-support.patch
@@ -1,7 +1,7 @@
 From 7c9d6785b45d7f436f8f5e209cf20ecbd8c34fba Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Wed, 16 Sep 2015 10:54:13 -0700
-Subject: [PATCH 31/34] Restore tcpwrappers/libwrap support
+Subject: [PATCH 31/35] Restore tcpwrappers/libwrap support
 
 This reverts commit f9696566fb41320820f3b257ab564fa321bb3751
 and commit f2719b7c2b8a3b14d778d8a6d8dc729b5174b054.
@@ -159,5 +159,5 @@ index 9654b041..0cc270b9 100644
  	rdomain = ssh_packet_rdomain_in(ssh);
  
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0032-Let-us-put-a-fallback-copy-of-DH-moduli-in-a-system-.patch b/openssh/Patches/0032-Let-us-put-a-fallback-copy-of-DH-moduli-in-a-system-.patch
index 14ee304..9cb518e 100644
--- a/openssh/Patches/0032-Let-us-put-a-fallback-copy-of-DH-moduli-in-a-system-.patch
+++ b/openssh/Patches/0032-Let-us-put-a-fallback-copy-of-DH-moduli-in-a-system-.patch
@@ -1,7 +1,7 @@
 From 82ea71c2e1ba3fd966a677e0a081794e2d8a3e0f Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Thu, 15 Oct 2015 16:02:37 -0700
-Subject: [PATCH 32/34] Let us put a fallback copy of DH moduli in a system
+Subject: [PATCH 32/35] Let us put a fallback copy of DH moduli in a system
  path
 
 Live distributions like SmartOS can't keep and update default
@@ -107,5 +107,5 @@ index 657b32da..94bede77 100644
  		    _PATH_DH_MODULI, strerror(errno));
  		return (dh_new_group_fallback(max));
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/0033-Temporarily-set-ssh-keygen-to-use-old-PKCS-1-PEM-for.patch b/openssh/Patches/0033-Temporarily-set-ssh-keygen-to-use-old-PKCS-1-PEM-for.patch
new file mode 100644
index 0000000..129d8a0
--- /dev/null
+++ b/openssh/Patches/0033-Temporarily-set-ssh-keygen-to-use-old-PKCS-1-PEM-for.patch
@@ -0,0 +1,143 @@
+From b0852fdcb9ecd2a0518f6e6af5996f86cacbc96d Mon Sep 17 00:00:00 2001
+From: Alex Wilson <alex.wilson@joyent.com>
+Date: Tue, 16 Jul 2019 13:43:14 -0700
+Subject: [PATCH 33/35] Temporarily set ssh-keygen to use old PKCS#1 PEM format
+
+SDC and its users have a lot of scripts and tools which expect
+ssh-keygen to produce the old private key format.
+
+We want to balance this against the fact that the new format
+vastly improves security for passphrase protected keys, so if
+we are generating a key with a passphrase, we will default
+to the new format, otherwise old.
+---
+ ssh-keygen.1 | 20 ++++++++++++++------
+ ssh-keygen.c | 25 +++++++++++++++++++++++--
+ 2 files changed, 37 insertions(+), 8 deletions(-)
+
+diff --git a/ssh-keygen.1 b/ssh-keygen.1
+index 4aa3586b..9226c361 100644
+--- a/ssh-keygen.1
++++ b/ssh-keygen.1
+@@ -231,8 +231,10 @@ This is used by
+ .Pa /lib/svc/method/sshd
+ to generate new host keys.
+ .It Fl a Ar rounds
+-When saving a private key this option specifies the number of KDF
+-(key derivation function) rounds used.
++When saving a new-format private key (i.e. an ed25519 key or when the
++.Fl o
++flag is set), this option specifies the number of KDF (key derivation function)
++rounds used.
+ Higher numbers result in slower passphrase verification and increased
+ resistance to brute-force password cracking (should the keys be stolen).
+ .Pp
+@@ -260,6 +262,8 @@ flag will be ignored.
+ Provides a new comment.
+ .It Fl c
+ Requests changing the comment in the private and public key files.
++This operation is only supported for keys stored in the
++newer OpenSSH format.
+ The program will prompt for the file containing the private keys, for
+ the passphrase if the key has one, and for the new comment.
+ .It Fl D Ar pkcs11
+@@ -404,10 +408,6 @@ or
+ (PEM public key).
+ The default conversion format is
+ .Dq RFC4716 .
+-Setting a format of
+-.Dq PEM
+-when generating or updating a supported private key type will cause the
+-key to be stored in the legacy PEM private key format.
+ .It Fl N Ar new_passphrase
+ Provides the new passphrase.
+ .It Fl n Ar principals
+@@ -502,6 +502,14 @@ The
+ is a comma-separated list of one or more address/netmask pairs in CIDR
+ format.
+ .El
++.It Fl o
++Causes
++.Nm
++to save private keys using the new OpenSSH format rather than
++the more compatible PEM format.
++The new format has increased resistance to brute-force password cracking
++but is not supported by versions of OpenSSH prior to 6.5.
++Ed25519 keys always use the new private key format.
+ .It Fl P Ar passphrase
+ Provides the (old) passphrase.
+ .It Fl p
+diff --git a/ssh-keygen.c b/ssh-keygen.c
+index 61760745..03880aaf 100644
+--- a/ssh-keygen.c
++++ b/ssh-keygen.c
+@@ -181,7 +181,7 @@ char *key_type_name = NULL;
+ char *pkcs11provider = NULL;
+ 
+ /* Use new OpenSSH private key format when writing SSH2 keys instead of PEM */
+-int use_new_format = 1;
++int use_new_format = -1;
+ 
+ /* Cipher for new-format private keys */
+ char *new_format_cipher = NULL;
+@@ -1035,6 +1035,9 @@ do_gen_all_hostkeys(struct passwd *pw)
+ 	int i, type, fd, r;
+ 	FILE *f;
+ 
++	if (use_new_format == -1)
++		use_new_format = 0;
++
+ 	for (i = 0; key_types[i].key_type; i++) {
+ 		public = private = NULL;
+ 		prv_tmp = pub_tmp = prv_file = pub_file = NULL;
+@@ -1421,6 +1424,12 @@ do_change_passphrase(struct passwd *pw)
+ 		free(passphrase2);
+ 	}
+ 
++	if (strlen(passphrase1) > 0 && use_new_format == -1) {
++		use_new_format = 1;
++	} else if (use_new_format == -1) {
++		use_new_format = 0;
++	}
++
+ 	/* Save the file using the new passphrase. */
+ 	if ((r = sshkey_save_private(private, identity_file, passphrase1,
+ 	    comment, use_new_format, new_format_cipher, rounds)) != 0) {
+@@ -1510,6 +1519,12 @@ do_change_comment(struct passwd *pw)
+ 		}
+ 	}
+ 
++	if (strlen(passphrase) > 0 && use_new_format == -1) {
++		use_new_format = 1;
++	} else if (use_new_format == -1) {
++		use_new_format = 0;
++	}
++
+ 	if (private->type != KEY_ED25519 && private->type != KEY_XMSS &&
+ 	    !use_new_format) {
+ 		error("Comments are only supported for keys stored in "
+@@ -2546,7 +2561,7 @@ main(int argc, char **argv)
+ 			cert_principals = optarg;
+ 			break;
+ 		case 'o':
+-			/* no-op; new format is already the default */
++			use_new_format = 1;
+ 			break;
+ 		case 'p':
+ 			change_passphrase = 1;
+@@ -2906,6 +2921,12 @@ passphrase_again:
+ 		snprintf(comment, sizeof comment, "%s@%s", pw->pw_name, hostname);
+ 	}
+ 
++	if (strlen(passphrase1) > 0 && use_new_format == -1) {
++		use_new_format = 1;
++	} else if (use_new_format == -1) {
++		use_new_format = 0;
++	}
++
+ 	/* Save the key with the given passphrase and comment. */
+ 	if ((r = sshkey_save_private(private, identity_file, passphrase1,
+ 	    comment, use_new_format, new_format_cipher, rounds)) != 0) {
+-- 
+2.22.0
+
diff --git a/openssh/Patches/1000-smartos-dtrace32.patch b/openssh/Patches/1000-smartos-dtrace32.patch
index 58c6f83..876a008 100644
--- a/openssh/Patches/1000-smartos-dtrace32.patch
+++ b/openssh/Patches/1000-smartos-dtrace32.patch
@@ -1,7 +1,7 @@
-From cb181c987c723fd7d298cd8a71e51e0f34353f24 Mon Sep 17 00:00:00 2001
+From 0c05cd15579c81db3ad8160d12d8b50558bd7293 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Tue, 22 Dec 2015 14:30:19 -0800
-Subject: [PATCH 33/34] SmartOS local: make dtrace lib 32-bit
+Subject: [PATCH 34/35] SmartOS local: make dtrace lib 32-bit
 
 ---
  Makefile.in | 6 +++---
@@ -39,5 +39,5 @@ index 91442e0f..066382ad 100644
  	$(srcdir)/mkinstalldirs $(SMFNETMANIDIR)
  	$(INSTALL) -m 555 smf/method.sh $(SMFMETHODDIR)/sshd
 -- 
-2.20.1
+2.22.0
 
diff --git a/openssh/Patches/1001-sunw_ssl.patch b/openssh/Patches/1001-sunw_ssl.patch
index 3f761ae..db1d8a8 100644
--- a/openssh/Patches/1001-sunw_ssl.patch
+++ b/openssh/Patches/1001-sunw_ssl.patch
@@ -1,7 +1,7 @@
-From c3198d9a3813b341d12cceb477fe6228c51edf0e Mon Sep 17 00:00:00 2001
+From 407a9de12a752ba1b38c92445620e655828f2bf2 Mon Sep 17 00:00:00 2001
 From: Alex Wilson <alex.wilson@joyent.com>
 Date: Tue, 22 Dec 2015 14:31:25 -0800
-Subject: [PATCH 34/34] SmartOS local: use sunw_ssl lib from platform
+Subject: [PATCH 35/35] SmartOS local: use sunw_ssl lib from platform
 
 ---
  configure.ac                    | 98 ++++++++++++++++-----------------
@@ -388,5 +388,5 @@ index c6e6c97a..313848f0 100644
  # endif
  #else
 -- 
-2.20.1
+2.22.0
 
-- 
2.21.0

