From 16842e980d99d7b17d98aac769957d68aabf61e1 Mon Sep 17 00:00:00 2001
From: "Pedro P. Candel" <pedro@joyent.com>
Date: Tue, 20 Sep 2016 18:47:16 +0200
Subject: [PATCH] TOOLS-1549 sdcadm post-setup manatee fails due to missing
 image version Reviewed by: Trent Mick <trent.mick@joyent.com>

---
 lib/post-setup/ha-manatee.js        | 6 +++---
 lib/procedures/update-manatee-v2.js | 9 ++++++---
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/lib/post-setup/ha-manatee.js b/lib/post-setup/ha-manatee.js
index 812cce1..978f716 100644
--- a/lib/post-setup/ha-manatee.js
+++ b/lib/post-setup/ha-manatee.js
@@ -282,14 +282,13 @@ function do_ha_manatee(subcmd, opts, args, cb) {
             });
         },
 
-        // This is for merely informative purposes and in order to add our
-        // changes to history:
         function getImage(_, next) {
             self.sdcadm.imgapi.getImage(pri.image_uuid, {}, function (err, im) {
                 if (err) {
                     next(err);
                 } else {
                     img = im;
+                    arg.change.image = img;
                     next();
                 }
             });
@@ -485,7 +484,7 @@ function do_ha_manatee(subcmd, opts, args, cb) {
                     server: opts.servers[0],
                     type: 'create',
                     service: 'manatee',
-                    image: img.uuid,
+                    image: img,
                     inst: {
                         instance: newId,
                         zonename: newId,
@@ -494,6 +493,7 @@ function do_ha_manatee(subcmd, opts, args, cb) {
                         server: opts.servers[0],
                         service: 'manatee',
                         image: img.uuid,
+                        version: img.version,
                         type: 'vm'
                     }
                 },
diff --git a/lib/procedures/update-manatee-v2.js b/lib/procedures/update-manatee-v2.js
index 5d3d34a..38b5f67 100644
--- a/lib/procedures/update-manatee-v2.js
+++ b/lib/procedures/update-manatee-v2.js
@@ -863,7 +863,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                         server: arg.shard.async.server_uuid,
                         type: 'create',
                         service: 'manatee',
-                        image: arg.change.image.uuid,
+                        image: arg.change.image,
                         inst: {
                             instance: arg.shard.async.zoneId,
                             zonename: arg.shard.async.zoneId,
@@ -871,6 +871,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                             server: arg.shard.async.server_uuid,
                             service: 'manatee',
                             image: arg.change.image.uuid,
+                            version: arg.change.image.version,
                             type: 'vm'
                         }
                     },
@@ -935,7 +936,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                         server: arg.shard.sync.server_uuid,
                         type: 'create',
                         service: 'manatee',
-                        image: arg.change.image.uuid,
+                        image: arg.change.image,
                         inst: {
                             instance: arg.shard.sync.zoneId,
                             zonename: arg.shard.sync.zoneId,
@@ -943,6 +944,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                             server: arg.shard.sync.server_uuid,
                             service: 'manatee',
                             image: arg.change.image.uuid,
+                            version: arg.change.image.version,
                             type: 'vm'
                         }
                     },
@@ -995,7 +997,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                         server: arg.shard.primary.server_uuid,
                         type: 'create',
                         service: 'manatee',
-                        image: arg.change.image.uuid,
+                        image: arg.change.image,
                         inst: {
                             instance: arg.shard.primary.zoneId,
                             zonename: arg.shard.primary.zoneId,
@@ -1003,6 +1005,7 @@ UpdateManateeV2.prototype.execute = function manateev2Execute(opts, cb) {
                             server: arg.shard.primary.server_uuid,
                             service: 'manatee',
                             image: arg.change.image.uuid,
+                            version: arg.change.image.version,
                             type: 'vm'
                         }
                     },
-- 
2.21.0

