From d76994877597b4ebe7aeeb910127a27b20901f60 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Mon, 22 Jul 2019 12:30:22 +0000
Subject: [PATCH] OS-7790 enable smatch build for illumos-joyent

---
 usr/src/boot/sys/boot/efi/libefi/i386/Makefile | 4 ++++
 usr/src/boot/sys/boot/libstand/Makefile.com    | 4 ++++
 usr/src/lib/fm/topo/libtopo/common/topo_mod.c  | 2 +-
 3 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/usr/src/boot/sys/boot/efi/libefi/i386/Makefile b/usr/src/boot/sys/boot/efi/libefi/i386/Makefile
index 3d1c95feed..cc749255bd 100644
--- a/usr/src/boot/sys/boot/efi/libefi/i386/Makefile
+++ b/usr/src/boot/sys/boot/efi/libefi/i386/Makefile
@@ -12,6 +12,7 @@
 #
 # Copyright 2016 Toomas Soome <tsoome@me.com>
 # Copyright 2016 RackTop Systems.
+# Copyright 2019 Joyent, Inc.
 #
 
 MACHINE=	$(MACH)
@@ -23,6 +24,9 @@ include ../Makefile.com
 
 CFLAGS +=	-m32
 
+# false positive only with a 64-bit smatch
+SMOFF += uninitialized
+
 CLEANFILES +=	machine x86
 
 $(OBJS): machine x86
diff --git a/usr/src/boot/sys/boot/libstand/Makefile.com b/usr/src/boot/sys/boot/libstand/Makefile.com
index 135944335c..e41ee5cb3c 100644
--- a/usr/src/boot/sys/boot/libstand/Makefile.com
+++ b/usr/src/boot/sys/boot/libstand/Makefile.com
@@ -11,6 +11,7 @@
 
 #
 # Copyright 2016 Toomas Soome <tsoome@me.com>
+# Copyright 2019 Joyent, Inc.
 #
 
 include $(SRC)/Makefile.master
@@ -27,6 +28,9 @@ include $(ZFSSRC)/Makefile.inc
 
 CPPFLAGS +=	-I$(SRC)/uts/common
 
+# 64-bit smatch false positive :/
+SMOFF += uninitialized
+
 clean: clobber
 clobber:
 	$(RM) $(CLEANFILES) $(OBJS) machine $(LIBRARY)
diff --git a/usr/src/lib/fm/topo/libtopo/common/topo_mod.c b/usr/src/lib/fm/topo/libtopo/common/topo_mod.c
index b8a1373d86..4b1cf13d34 100644
--- a/usr/src/lib/fm/topo/libtopo/common/topo_mod.c
+++ b/usr/src/lib/fm/topo/libtopo/common/topo_mod.c
@@ -989,7 +989,7 @@ topo_mod_create_ufm_slot(topo_mod_t *mod, tnode_t *ufmnode,
 	if (slotinfo == NULL || slotinfo->usi_version == NULL ||
 	    slotinfo->usi_mode == 0) {
 		topo_mod_dprintf(mod, "invalid slot info");
-		topo_mod_seterrno(mod, ETOPO_MOD_INVAL);
+		(void) topo_mod_seterrno(mod, ETOPO_MOD_INVAL);
 		return (NULL);
 	}
 	if ((auth = topo_mod_auth(mod, ufmnode)) == NULL) {
-- 
2.21.0

