From 57c424e145e378f68aab66002f5363bc02e6c198 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Fri, 10 Feb 2017 13:55:22 -0800
Subject: [PATCH] OS-5950 metadata should notice KVM VM start sooner Reviewed
 by: Orlando Vazquez <orlando@joyent.com>

---
 src/vm/lib/metadata/agent.js | 25 ++++++++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

diff --git a/src/vm/lib/metadata/agent.js b/src/vm/lib/metadata/agent.js
index 124f0779..ae607427 100644
--- a/src/vm/lib/metadata/agent.js
+++ b/src/vm/lib/metadata/agent.js
@@ -20,7 +20,7 @@
  *
  * CDDL HEADER END
  *
- * Copyright (c) 2016, Joyent, Inc. All rights reserved.
+ * Copyright (c) 2017, Joyent, Inc. All rights reserved.
  *
  *
  * # OVERVIEW
@@ -682,6 +682,29 @@ MetadataAgent.prototype.start = function start() {
             return;
         }
 
+        // For non-KVM, we only care about create/delete since the socket
+        // only needs to be created once for these zones. For KVM however,
+        // the qemu process recreates the socket on every boot, so we want
+        // to catch 'start' events for KVM to ensure we connect to metadata
+        // as soon as possible.
+        if (msg.cmd === 'start' && self.zones.hasOwnProperty(msg.zonename)
+            && self.zones[msg.zonename].brand === 'kvm') {
+            // KVM VM started
+
+            self.log.debug({
+                delay: (new Date()).getTime() - when.getTime(), // in ms
+                when: when,
+                zonename: msg.zonename
+            }, 'ZWatch watcher saw KVM zone start');
+
+            self.addDebug(msg.zonename, 'last_zone_start');
+
+            // The "zone" wasn't technically created here, but the socket was
+            // (by qemu) so as far as we're concerned this is the same thing.
+            self.handleZoneCreated(msg.zonename);
+            return;
+        }
+
         // ignore everything else except create
         if (msg.cmd !== 'create') {
             return;
-- 
2.21.0

