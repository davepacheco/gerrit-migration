{"project":"joyent/illumos-joyent","branch":"master","id":"I3c582c76bac2887ab32c99a58ed3f8c5b80ca04e","number":"5625","subject":"OS-7607 savecore(1M) should be able to work on read-only dump devices Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: John Levon \u003cjohn.levon@joyent.com\u003e","owner":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"url":"https://cr.joyent.us/5625","commitMessage":"OS-7607 savecore(1M) should be able to work on read-only dump devices\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: John Levon \u003cjohn.levon@joyent.com\u003e\n","createdOn":1550846565,"lastUpdated":1553178634,"open":false,"status":"MERGED","comments":[{"timestamp":1550846565,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 1."},{"timestamp":1550846975,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nInstead of a new option, why don\u0027t we just handle a read-only device, and warn about it?"},{"timestamp":1550847562,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\nI consider this a rarely used recovery feature, it shouldn\u0027t really do that unless asked to. Especially I don\u0027t want it to accidentally save the same crash dump over and over again when being faced with a read-only dump dev at boot, even though there are currently other mechanisms at work which would prevent that."},{"timestamp":1550852306,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(3 comments)\n\nI don\u0027t have strong feelings either way on the option question, but noticed some related bits."},{"timestamp":1551104174,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\nIf there\u0027s a risk it\u0027ll get stuck in a loop, then I suppose I\u0027m fine with it. But in general when it comes to \"can we get failure data from a machine\" I\u0027m always inclined to trying harder. I suppose the good thing here is that the dump is likely to still be available after the fact?"},{"timestamp":1551451521,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 2."},{"timestamp":1551451580,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1551451777,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 1:\n\n\u003e If there\u0027s a risk it\u0027ll get stuck in a loop, then I suppose I\u0027m\n \u003e fine with it. But in general when it comes to \"can we get failure\n \u003e data from a machine\" I\u0027m always inclined to trying harder. I\n \u003e suppose the good thing here is that the dump is likely to still be\n \u003e available after the fact?\n\nsavecore always leaves the dump intact, at most it updates flags in the dump header to indicate it was already saved. With -r it doesn\u0027t even do that.\n\nWhile the risk of saving a dump more than once is pretty low if we make all of this automatic (you would have to repeatedly boot from a read-only pool, which I\u0027m not sure we even support), I\u0027d really prefer to keep the -r switch to help in case of a manual recovery from a pool that\u0027s read-only.\n\nLooking at the whole savecore code, I think it could use a bit of an overhaul. At least the way dump device opening is handled is quite weird. Not sure I want to do that now, though."},{"timestamp":1551461863,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2: Code-Review+1"},{"timestamp":1551822982,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1552401896,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 3."},{"timestamp":1552401917,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\n(3 comments)"},{"timestamp":1552402155,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 2:\n\nTesting notes are in the ticket."},{"timestamp":1552402514,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1552403780,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1553175993,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1553177744,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1553178597,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1553178634,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Hans Rosenfeld"}],"currentPatchSet":{"number":"5","revision":"8e6d083b0f4cf225cf85597a4b87f60d7cc25a4a","parents":["aa302656385001628e17e2a5f29a9b9f9ba70efe"],"ref":"refs/changes/25/5625/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1553178597,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552402514,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552403780,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553175993,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"SUBM","value":"1","grantedOn":1553178634,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/savecore/savecore.c","type":"MODIFIED","insertions":24,"deletions":-14},{"file":"usr/src/man/man1m/savecore.1m","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":39,"sizeDeletions":-22},"patchSets":[{"number":"1","revision":"5861c7b6fdf6d9f412fd1582fc287487799f3977","parents":["d5a09eef79eda8a53185fd17c5ffc05c5fae807e"],"ref":"refs/changes/25/5625/1","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1550846565,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/cmd/savecore/savecore.c","line":168,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Missing an update for the new option."},{"file":"usr/src/cmd/savecore/savecore.c","line":168,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/cmd/savecore/savecore.c","line":1540,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we use O_DSYNC in this case and not in the others?"},{"file":"usr/src/cmd/savecore/savecore.c","line":1540,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Just an oversight, fixed it."},{"file":"usr/src/cmd/savecore/savecore.c","line":1696,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is -r actually always valid with other flags? (I realize this may change based on what you and John hash out). I guess -r is implied for -L and -f. But at least it doesn\u0027t seem like it makes sense with -c?"},{"file":"usr/src/cmd/savecore/savecore.c","line":1696,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"I don\u0027t think it should work with -L, -c, or -m. I\u0027m considering to also avoid sending the FMA events in case of -r. What do you think?"},{"file":"usr/src/cmd/savecore/savecore.c","line":1696,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I think that\u0027s reasonable on both parts. I would make -r exclusive and make it so that it doesn\u0027t send events."},{"file":"usr/src/cmd/savecore/savecore.c","line":1696,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/savecore/savecore.c","type":"MODIFIED","insertions":20,"deletions":-9},{"file":"usr/src/man/man1m/savecore.1m","type":"MODIFIED","insertions":14,"deletions":-8}],"sizeInsertions":34,"sizeDeletions":-17},{"number":"2","revision":"2267bb37b402954d21964b27e17a2de609b83531","parents":["d5a09eef79eda8a53185fd17c5ffc05c5fae807e"],"ref":"refs/changes/25/5625/2","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1551451521,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551461863,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"comments":[{"file":"usr/src/cmd/savecore/savecore.c","line":168,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The option block should indicate -r is exclusive of -L. I think this probably wants to look like [-L | -r] [-vd] or similar."},{"file":"usr/src/cmd/savecore/savecore.c","line":168,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/cmd/savecore/savecore.c","line":1538,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"These cases seem reversed. Shouldn\u0027t we only open the dump O_RDONLY If rflag is set?"},{"file":"usr/src/cmd/savecore/savecore.c","line":1538,"reviewer":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"message":"Done"},{"file":"usr/src/man/man1m/savecore.1m","line":12,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"See note on usage for phrasing here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/savecore/savecore.c","type":"MODIFIED","insertions":18,"deletions":-8},{"file":"usr/src/man/man1m/savecore.1m","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":33,"sizeDeletions":-16},{"number":"3","revision":"793457ed302a638ce5de2e6140b952071ff911e8","parents":["d5a09eef79eda8a53185fd17c5ffc05c5fae807e"],"ref":"refs/changes/25/5625/3","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1552401896,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552402514,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552403780,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553175993,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/cmd/savecore/savecore.c","type":"MODIFIED","insertions":24,"deletions":-14},{"file":"usr/src/man/man1m/savecore.1m","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":39,"sizeDeletions":-22},{"number":"4","revision":"3c582c76bac2887ab32c99a58ed3f8c5b80ca04e","parents":["d5a09eef79eda8a53185fd17c5ffc05c5fae807e"],"ref":"refs/changes/25/5625/4","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1553177744,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552402514,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552403780,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553175993,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/savecore/savecore.c","type":"MODIFIED","insertions":24,"deletions":-14},{"file":"usr/src/man/man1m/savecore.1m","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":39,"sizeDeletions":-22},{"number":"5","revision":"8e6d083b0f4cf225cf85597a4b87f60d7cc25a4a","parents":["aa302656385001628e17e2a5f29a9b9f9ba70efe"],"ref":"refs/changes/25/5625/5","uploader":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"createdOn":1553178597,"author":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552402514,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1553178634,"by":{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1552403780,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553175993,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/cmd/savecore/savecore.c","type":"MODIFIED","insertions":24,"deletions":-14},{"file":"usr/src/man/man1m/savecore.1m","type":"MODIFIED","insertions":15,"deletions":-8}],"sizeInsertions":39,"sizeDeletions":-22}],"allReviewers":[{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Hans Rosenfeld","email":"hans.rosenfeld@joyent.com","username":"hrosenfeld"}]}