commit 7622d2463cbc3fbd928673871573ea1365dd2118 (refs/changes/43/5243/2)
Author: Robert Mustacchi <rm@joyent.com>
Date:   2018-12-15T02:12:28+00:00 (10 months ago)
    
    OS-4960 in-gate dmake should be used to build the platform

diff --git a/configure b/configure
index 870504bd..52e02057 100755
--- a/configure
+++ b/configure
@@ -300,7 +300,7 @@ PKGPUBLISHER_REDIST="${PUBLISHER}";		export PKGPUBLISHER_REDIST
 MAKEFLAGS=k;					export MAKEFLAGS
 UT_NO_USAGE_TRACKING="1";			export UT_NO_USAGE_TRACKING
 MULTI_PROTO="no";				export MULTI_PROTO
-BUILD_TOOLS="\${CODEMGR_WS}/usr/src/tools/proto/root_\${MACH}-nd/opt";
+BUILD_TOOLS="\$SRC/tools/proto/root_\${MACH}-nd/opt";
 						export BUILD_TOOLS
 SPRO_ROOT=/opt/SUNWspro;			export SPRO_ROOT
 SPRO_VROOT=\$SPRO_ROOT;				export SPRO_VROOT
@@ -326,7 +326,13 @@ NM=/usr/bin/nm;					export NM
 STRIP=/usr/bin/strip;				export STRIP
 TSORT=/usr/bin/tsort;				export TSORT
 AR=/usr/bin/ar;					export AR
-MAKE="$conf_root/proto.strap/usr/bin/dmake";	export MAKE
+#
+# We override $MAKE in ./tools/build_illumos so we can properly
+# bootstrap the tools build.
+#
+if [[ -z "\$MAKE" ]]; then
+MAKE="\$SRC/tools/proto/root_i386-nd/opt/onbld/bin/i386/dmake";	export MAKE
+fi
 LEX=/opt/local/bin/lex;				export LEX
 YACC=/opt/local/bin/yacc;			export YACC
 BISON=/opt/local/bin/bison;			export BISON
diff --git a/tools/build_illumos b/tools/build_illumos
index 7f493080..5288d4c1 100755
--- a/tools/build_illumos
+++ b/tools/build_illumos
@@ -52,9 +52,11 @@ else
 fi
 gsed -i -e "s|^MAX_JOBS=.*$|MAX_JOBS=${MJ}; export MAX_JOBS|" illumos.sh
 
+export MAKE=/opt/local/bin/dmake
 ksh93 ./usr/src/tools/scripts/bldenv.sh illumos.sh \
     'cd $CODEMGR_WS/usr/src && export PATH="$PATH:/opt/local/bin" && \
     dmake setup && cd tools && dmake install'
+export -n MAKE
 
 printf "\nRunning illumos nightly(1).\n"
 printf "This will take a while.\n"
diff --git a/tools/clobber_illumos b/tools/clobber_illumos
index 1d2c2670..a010f35a 100755
--- a/tools/clobber_illumos
+++ b/tools/clobber_illumos
@@ -16,13 +16,11 @@
 
 #
 # Attempt to clobber an illumos build. We need to make sure that we have
-# a dmake available. The one that's in -extra is the one that we
-# generally need. As a heuristic, we use its presence for determining
-# whether or not we need it. This isn't perfect. Ideally we'd ship a set
-# of onbld tools to always use this. However, this should work for most
-# folks. You can't build illumos without the 0-extra-stramp. Therefore
-# if the dmake from proto.strap is missing, illumos likely hasn't been
-# built.
+# a dmake available. The one that's in the illumos-joyent tools
+# bootstrap that we  generally use. As a heuristic, we use its presence
+# for determining whether or not we need to clobber illumos. This isn't
+# perfect. Ideally we'd ship a set of onbld tools to always use this.
+# However, this should work for most folks.
 #
 # This does mean that a user that manually removes things in proto.strap
 # and then calls gmake clobber at the top level will result in build
@@ -30,12 +28,13 @@
 # this will be a rare case.
 #
 set -o pipefail
+set -o xtrace
 
 ci_wsroot=$(cd $(dirname $0)/../; pwd)
 ci_arg0=$(basename $0)
-ci_dmake=$ci_wsroot/proto.strap/usr/bin/dmake
-ci_stamp=$ci_wsroot/0-illumos-stamp
-ci_illumos=$ci_wsroot/projects/illumos/usr/src
+ci_illumos="$ci_wsroot/projects/illumos/usr/src"
+ci_dmake="/opt/local/bin/dmake"
+ci_stamp="$ci_wsroot/0-illumos-stamp"
 
 export PATH=/usr/bin:/usr/sbin:/opt/local/bin:/opt/local/sbin
 
@@ -109,6 +108,7 @@ EOF
 function ci_do_clobber
 {
 	echo "Clobbering $ci_wsroot/projects/illumos"
+	export MAKE="$ci_dmake"
 	ksh93 $ci_illumos/tools/scripts/bldenv.sh $ci_illumos/../../illumos.sh \
 	    'cd $CODEMGR_WS/usr/src && dmake clobber'
 }
