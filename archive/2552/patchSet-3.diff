From 65ebbd4b9249946c321dc48fdb087e14e9136366 Mon Sep 17 00:00:00 2001
From: Orlando Vazquez <ovazquez@gmail.com>
Date: Wed, 6 Dec 2017 09:36:42 -0800
Subject: [PATCH] CNAPI-720 CNAPI should use SRV-based service discovery when
 communicating with moray (following upgrade to node-moray 3.2.1)

---
 lib/apis/moray.js             | 24 ++++++++++--------------
 sapi_manifests/cnapi/template |  8 +++++---
 2 files changed, 15 insertions(+), 17 deletions(-)

diff --git a/lib/apis/moray.js b/lib/apis/moray.js
index ce2681e..9fdc7c8 100644
--- a/lib/apis/moray.js
+++ b/lib/apis/moray.js
@@ -5,17 +5,18 @@
  */
 
 /*
- * Copyright (c) 2016, Joyent, Inc.
+ * Copyright (c) 2017, Joyent, Inc.
  */
 
 /*
  * Moray client wrapper.
  */
 
-var moray_client = require('moray');
 var assert = require('assert-plus');
-var bunyan = require('bunyan');
 var async = require('async');
+var bunyan = require('bunyan');
+var mod_jsprim = require('jsprim');
+var mod_moray = require('moray');
 var VError = require('verror');
 
 var BUCKETS = {
@@ -112,17 +113,12 @@ Moray.prototype.getClient = function (callback) {
 
 Moray.prototype.connect = function () {
     var self = this;
-    self.log.info('Initializing moray client');
-    var client = self._morayClient = moray_client.createClient({
-        host: self.config.moray.host,
-        port: self.config.moray.port,
-        log: bunyan.createLogger({
-            name: 'moray',
-            serializers: bunyan.stdSerializers
-        }),
-        reconnect: true,
-        noCache: true
-    });
+
+    self.log.info('initializing moray client');
+
+    var config = mod_jsprim.deepCopy(self.config.moray);
+    config.log = self.log;
+    var client = self._morayClient = mod_moray.createClient(config);
 
     function onConnect() {
         self.log.info({moray: client.toString()}, 'moray: connected');
diff --git a/sapi_manifests/cnapi/template b/sapi_manifests/cnapi/template
index 5af56aa..3cc75fc 100644
--- a/sapi_manifests/cnapi/template
+++ b/sapi_manifests/cnapi/template
@@ -3,7 +3,7 @@
 	"datacenter_name": "{{{datacenter_name}}}",
 	"adminUuid": "{{{ufds_admin_uuid}}}",
 {{#no_rabbit}}
-        "useCnAgent": true,
+	"useCnAgent": true,
 {{/no_rabbit}}
 	"amqp": {
 		"host": "{{{RABBITMQ_SERVICE}}}"
@@ -12,8 +12,10 @@
 	"fluentd_host": "{{{experimental_fluentd_host}}}",
 {{/experimental_fluentd_host}}
 	"moray": {
-		"host": "{{{MORAY_SERVICE}}}",
-		"port": 2020
+		"srvDomain": "{{{MORAY_SERVICE}}}",
+		"cueballOptions": {
+			"resolvers": [ "{{{BINDER_SERVICE}}}" ]
+		}
 	},
 	"api": {
 		"username": "{{{cnapi_http_admin_user}}}",
-- 
2.21.0

