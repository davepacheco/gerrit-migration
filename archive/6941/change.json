{"project":"joyent/illumos-joyent","branch":"master","id":"Id71e63f2240a31f0a5769f8a5e2307c386fd41ad","number":"6941","subject":"OS-8003 Do not destroy external delegated dataset Reviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e","owner":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"url":"https://cr.joyent.us/6941","commitMessage":"OS-8003 Do not destroy external delegated dataset\nReviewed by: Dan McDonald \u003cdanmcd@joyent.com\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n","createdOn":1569703399,"lastUpdated":1569888916,"open":false,"status":"MERGED","comments":[{"timestamp":1569703399,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 1."},{"timestamp":1569703530,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 2."},{"timestamp":1569703606,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1569703719,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 4."},{"timestamp":1569703858,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\nTesting notes from this (and previous iterations) https://github.com/joyent/smartos-live/issues"},{"timestamp":1569703920,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\nhttps://github.com/joyent/smartos-live/issues/850, 3rd copy past fail in 10 minutes. It\u0027s getting late."},{"timestamp":1569773154,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1569773749,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1569783534,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 5."},{"timestamp":1569857586,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1569859289,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1569862414,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1569862449,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 5: Code-Review+1\n\nMake sure you put the test notes in the OS-8003 ticket."},{"timestamp":1569863533,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 5:\n\nI think either you or Mike would need to copy them from github, As I cannot."},{"timestamp":1569871046,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\n(1 comment)"},{"timestamp":1569871875,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 6."},{"timestamp":1569871891,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1569871941,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Uploaded patch set 7: Commit message was updated."},{"timestamp":1569873373,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 7: Code-Review+1 Integration-Approval+1"},{"timestamp":1569888895,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"Patch Set 7: Code-Review+1"},{"timestamp":1569888916,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dan McDonald"}],"currentPatchSet":{"number":"7","revision":"d71e63f2240a31f0a5769f8a5e2307c386fd41ad","parents":["ae44c1df3a1e5ae3cabdddd67abd8aa021e4e1b6"],"ref":"refs/changes/41/6941/7","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569871941,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569873373,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569873373,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569888895,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1569888916,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"usr/src/lib/brand/joyent-minimal/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"usr/src/lib/brand/joyent/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-17},"patchSets":[{"number":"1","revision":"71c647d541e94ddd6d07a4c510ec743d249defbc","parents":["e10f469cd879b7a323b6dcd76c8de9bb8a187e0c"],"ref":"refs/changes/41/6941/1","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569703399,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-3},{"number":"2","revision":"b53450079f3bdac3051b1b3a375d49d682435070","parents":["d34708cffc24f32c1138efa4de13db7b240c1b90"],"ref":"refs/changes/41/6941/2","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569703530,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":10,"deletions":-4}],"sizeInsertions":10,"sizeDeletions":-4},{"number":"3","revision":"e4acfc104124bf50b89581ce6bc73a8972c9d6c0","parents":["d34708cffc24f32c1138efa4de13db7b240c1b90"],"ref":"refs/changes/41/6941/3","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569703606,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"NO_CODE_CHANGE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":10,"deletions":-4}],"sizeInsertions":10,"sizeDeletions":-4},{"number":"4","revision":"00f8f358da42e01e31cea9013802188b2a1b7435","parents":["d34708cffc24f32c1138efa4de13db7b240c1b90"],"ref":"refs/changes/41/6941/4","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569703719,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"REWORK","comments":[{"file":"/COMMIT_MSG","line":7,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"8003"},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","line":94,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"We must not clear zoned or mount these in the global zone.  For example, if some dataset had mountpoint\u003d/opt/local/sbin, it would cause the dataset that was previously under the control of a zone to be in root\u0027s PATH.\n\nBetter to leave zoned\u003don, preventing automatic mounting in the global zone.  If there\u0027s a desire for content to be shared between the global zone and a zone, it\u0027s better to have it persistently mounted in the global zone and use a fs resource to lofs mount it into zones."},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","line":94,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"So that would mean just removing the juninstall_delegated_dataset and removing the calls to it?"},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","line":94,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"NOTE:  ipkg/lipkg zones do NOT alter the state of `zoned` either, so Mike\u0027s advice is highly valid here.  Do *not* remount and do NOT alter the zoned property."},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","line":94,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"It should already be fixed in patchset 5, unless I messed up the push to Gerrit"},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","line":94,"reviewer":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},"message":"You did not mess it up, I missed change 5."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":10,"deletions":-4}],"sizeInsertions":10,"sizeDeletions":-4},{"number":"5","revision":"8ee86aa826f74b2a0446dfccb014534d853525f0","parents":["9025f331a2570d6d68b91bc20ea24ab6a5b9d8b4"],"ref":"refs/changes/41/6941/5","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569783534,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569862449,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569871046,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569871046,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"comments":[{"file":"/COMMIT_MSG","line":11,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"These lines should be deleted, replaced with review \u0026 approve lines."},{"file":"/COMMIT_MSG","line":11,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"usr/src/lib/brand/joyent-minimal/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"usr/src/lib/brand/joyent/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-17},{"number":"6","revision":"b366dfa4b513f81c83f5d26c5d3ffbae22ca2294","parents":["ae44c1df3a1e5ae3cabdddd67abd8aa021e4e1b6"],"ref":"refs/changes/41/6941/6","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569871875,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"usr/src/lib/brand/joyent-minimal/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"usr/src/lib/brand/joyent/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-17},{"number":"7","revision":"d71e63f2240a31f0a5769f8a5e2307c386fd41ad","parents":["ae44c1df3a1e5ae3cabdddd67abd8aa021e4e1b6"],"ref":"refs/changes/41/6941/7","uploader":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"createdOn":1569871941,"author":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569888895,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"SUBM","value":"1","grantedOn":1569888916,"by":{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1569873373,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1569873373,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"usr/src/lib/brand/jcommon/libhooks.ksh","type":"MODIFIED","insertions":1,"deletions":-11},{"file":"usr/src/lib/brand/joyent-minimal/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3},{"file":"usr/src/lib/brand/joyent/zone/juninstall","type":"MODIFIED","insertions":1,"deletions":-3}],"sizeInsertions":3,"sizeDeletions":-17}],"allReviewers":[{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Dan McDonald","email":"danmcd@joyent.com","username":"danmcd"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}]}