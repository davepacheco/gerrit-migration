commit e1e85afcca70c4c20882499108941e53e6c34429 (refs/changes/68/4168/1)
Author: Tim Foster <tim.foster@joyent.com>
Date:   2018-06-08T11:32:34+00:00 (1 year, 4 months ago)
    
    TRITON-478 agent builds fail as non-root when postinstall.sh writes to /

diff --git a/agent/pkg/postinstall.sh b/agent/pkg/postinstall.sh
index a3b8588..73a3e30 100755
--- a/agent/pkg/postinstall.sh
+++ b/agent/pkg/postinstall.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
@@ -21,6 +21,12 @@
 #    compute node GZ.
 #
 
+
+if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]]; then
+    echo "Skipping Amon postinstall (assuming build-time install)"
+    exit 0
+fi
+
 if [ "$TRACE" != "" ]; then
     export PS4='${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
     set -o xtrace
diff --git a/relay/pkg/postinstall.sh b/relay/pkg/postinstall.sh
index d0336af..e08346b 100755
--- a/relay/pkg/postinstall.sh
+++ b/relay/pkg/postinstall.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 OS=$(uname -s)
@@ -16,6 +16,11 @@ if [[ $OS != "SunOS" ]]; then
   exit 0
 fi
 
+if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]]; then
+  echo "Skipping Amon postinstall (assuming build-time install)"
+  exit 0
+fi
+
 set -o xtrace
 
 export SMFDIR=$npm_config_smfdir
