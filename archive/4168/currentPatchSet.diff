commit 5008279f7251c34a1c621e4ea616010bfb41d752 (refs/changes/68/4168/3)
Author: Tim Foster <tim.foster@joyent.com>
Date:   2018-06-12T07:31:03+01:00 (1 year, 4 months ago)
    
    TRITON-478 agent builds fail as non-root when postinstall.sh writes to /

diff --git a/agent/pkg/postinstall.sh b/agent/pkg/postinstall.sh
index a3b8588..a6b7f23 100755
--- a/agent/pkg/postinstall.sh
+++ b/agent/pkg/postinstall.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 #
@@ -28,6 +28,10 @@ fi
 set -o errexit
 set -o pipefail
 
+if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]]; then
+    echo "Skipping amon-agent postinstall (assuming build-time install)"
+    exit 0
+fi
 
 TOP=$(cd $(dirname $0)/../ >/dev/null; pwd)
 
diff --git a/relay/pkg/postinstall.sh b/relay/pkg/postinstall.sh
index d0336af..b375032 100755
--- a/relay/pkg/postinstall.sh
+++ b/relay/pkg/postinstall.sh
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2015, Joyent, Inc.
+# Copyright (c) 2018, Joyent, Inc.
 #
 
 OS=$(uname -s)
@@ -18,6 +18,11 @@ fi
 
 set -o xtrace
 
+if [[ -z "$npm_config_smfdir" || ! -d "$npm_config_smfdir" ]]; then
+  echo "Skipping amon-relay postinstall (assuming build-time install)"
+  exit 0
+fi
+
 export SMFDIR=$npm_config_smfdir
 
 function subfile () {
