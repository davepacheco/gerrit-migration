{"project":"joyent/sdc-firewaller-agent","branch":"master","id":"I0906745cbb3efb7e6faaa1e6fd38cca4333e5a06","number":"6542","subject":"TRITON-1794 firewaller\u0027s configuration migration SMF service cannot be imported TRITON-1803 firewaller\u0027s configuration migration script should apply to all rules Reviewed by: John Levon \u003cjohn.levon@joyent.com\u003e Approved by: Alex Wilson \u003calex.wilson@joyent.","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/6542","commitMessage":"TRITON-1794 firewaller\u0027s configuration migration SMF service cannot be imported\nTRITON-1803 firewaller\u0027s configuration migration script should apply to all rules\nReviewed by: John Levon \u003cjohn.levon@joyent.com\u003e\nApproved by: Alex Wilson \u003calex.wilson@joyent.com\u003e\n","createdOn":1562112751,"lastUpdated":1562706064,"open":false,"status":"MERGED","comments":[{"timestamp":1562112751,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1562112800,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562149005,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1562188158,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1562188209,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562188571,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1562189673,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1562189725,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562190081,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1562190141,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 3: Code-Review+1\n\nThanks."},{"timestamp":1562631524,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4."},{"timestamp":1562631578,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562682209,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1562694772,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5."},{"timestamp":1562694823,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1562695023,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1562699766,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Patch Set 5: Code-Review+1\n\n(1 comment)\n\nThanks for fixing this again."},{"timestamp":1562705957,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Integration-Approval+1"},{"timestamp":1562706055,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1562706064,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"6","revision":"0906745cbb3efb7e6faaa1e6fd38cca4333e5a06","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/6","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562706055,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562694823,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562699766,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562705957,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"SUBM","value":"1","grantedOn":1562706064,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"config-migration.js","type":"MODIFIED","insertions":22,"deletions":-85},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":18,"deletions":-11}],"sizeInsertions":42,"sizeDeletions":-97},"patchSets":[{"number":"1","revision":"7f6f2f46e5f1eb72bf7649b9014c48c5a647da41","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562112751,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562112800,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"smf/manifests/firewaller-config-migration.xml.in","line":27,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This already depends on it, via smartdc/init-\u003esystem/zones\nI don\u0027t think you need to add this."},{"file":"smf/manifests/firewaller-config-migration.xml.in","line":27,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve removed the vminfod \"dependent\". I also added a \"dependency\" for vminfod, since this service seems to race with it during startup, and causes running vmadm in config-migration.js to fail with ECONNREFUSED."},{"file":"smf/manifests/firewaller-config-migration.xml.in","line":33,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"This service should be marked as duration\u003dtransient. That way you don\u0027t need the ctrun or the SMF_EXIT_NODAEMON."},{"file":"smf/manifests/firewaller-config-migration.xml.in","line":33,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":1,"deletions":0},{"file":"config-migration.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":4,"deletions":-2}],"sizeInsertions":10,"sizeDeletions":-2},{"number":"2","revision":"1c7bb2e05be486680d7e9b21e4b8c4b4b3eed5fc","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562188158,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562188209,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"smf/manifests/firewaller-config-migration.xml.in","line":34,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"if you still need the ctrun instead of just starting node, then a comment here would be good."},{"file":"smf/manifests/firewaller-config-migration.xml.in","line":34,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve added a comment here. I think keeping the ctrun here would be good for the noorphan bit. If I understand svc.startd(1M) correctly, then using duration\u003dtransient will prevent tracking the processes."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"config-migration.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":12,"deletions":-11}],"sizeInsertions":17,"sizeDeletions":-12},{"number":"3","revision":"2747d72efb98dc05227e670082ddc84293cf0346","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562189673,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562189725,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562190141,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"config-migration.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":18,"deletions":-11}],"sizeInsertions":23,"sizeDeletions":-12},{"number":"4","revision":"e4abceadb05991b242eb4f9e7f9fa05690dd1c44","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562631524,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562631578,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"config-migration.js","line":55,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"isn\u0027t this loading all rules?"},{"file":"config-migration.js","line":55,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Yes. We can remove this part now, and just regenerate configurations for all VMs with their firewalls enabled."},{"file":"config-migration.js","line":65,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Where are these two arguments used?\n\n(If they\u0027re not, I don\u0027t think you need to pass both ctx.vms and ctx.vmsByVmUUID around - the latter suffices for :58)"},{"file":"config-migration.js","line":65,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"These are used in the fwadm code:\n\nhttps://github.com/joyent/sdc-firewaller-agent/blob/release-20190620/deps/fw/lib/fw.js#L3034-L3054\n\nI\u0027ve removed this step and the next. I\u0027ve file TRITON-1803 to explain why we need to operate on all VMs that have their firewall enabled."},{"file":"config-migration.js","line":65,"reviewer":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},"message":"Not for fw.list (at least that I could see) but the point is moot."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"config-migration.js","type":"MODIFIED","insertions":15,"deletions":-18},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":18,"deletions":-11}],"sizeInsertions":35,"sizeDeletions":-30},{"number":"5","revision":"6a9146c427a1cd5c82983a847b9e8d07a409ecf3","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562694772,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562705957,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562694823,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562699766,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"config-migration.js","type":"MODIFIED","insertions":22,"deletions":-85},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":18,"deletions":-11}],"sizeInsertions":42,"sizeDeletions":-97},{"number":"6","revision":"0906745cbb3efb7e6faaa1e6fd38cca4333e5a06","parents":["f62aba70f179be08a5fc04253fdd177199bd1a6c"],"ref":"refs/changes/42/6542/6","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1562706055,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1562706064,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1562705957,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1562694823,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1562699766,"by":{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"config-migration.js","type":"MODIFIED","insertions":22,"deletions":-85},{"file":"smf/manifests/firewaller-config-migration.xml.in","type":"MODIFIED","insertions":18,"deletions":-11}],"sizeInsertions":42,"sizeDeletions":-97}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"John Levon","email":"john.levon@joyent.com","username":"johnlevon"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}