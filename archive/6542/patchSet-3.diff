From 2747d72efb98dc05227e670082ddc84293cf0346 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Wed, 3 Jul 2019 21:34:14 +0000
Subject: [PATCH] TRITON-1794 firewaller's configuration migration SMF service
 cannot be imported

---
 Makefile                                      |  3 +-
 config-migration.js                           |  3 ++
 .../firewaller-config-migration.xml.in        | 29 ++++++++++++-------
 3 files changed, 23 insertions(+), 12 deletions(-)

diff --git a/Makefile b/Makefile
index d5d17f3..ce8e692 100644
--- a/Makefile
+++ b/Makefile
@@ -18,7 +18,7 @@
 
 
 BASH_FILES  := npm/postinstall.sh npm/postuninstall.sh
-JS_FILES        := $(shell find lib test -name '*.js') main.js
+JS_FILES        := $(shell find lib test -name '*.js') $(wildcard ./*.js)
 JSON_FILES       = package.json config.json
 JSL_CONF_NODE    = tools/jsl.node.conf
 JSL_FILES_NODE   = $(JS_FILES)
@@ -101,6 +101,7 @@ release: all docs $(SMF_MANIFESTS)
 	(git symbolic-ref HEAD | awk -F/ '{print $$3}' && git describe) > $(DSTDIR)/describe
 	cp -r \
     $(TOP)/config.json \
+    $(TOP)/config-migration.js \
     $(TOP)/main.js \
     $(TOP)/lib \
     $(TOP)/node_modules \
diff --git a/config-migration.js b/config-migration.js
index 3c6ee11..c889c8d 100644
--- a/config-migration.js
+++ b/config-migration.js
@@ -185,6 +185,9 @@ vasync.pipeline({
 }, function pipeCb(pipeErr) {
     if (pipeErr) {
         console.error(pipeErr);
+        process.exit(1);
+    } else {
+        process.exit(0);
     }
 });
 
diff --git a/smf/manifests/firewaller-config-migration.xml.in b/smf/manifests/firewaller-config-migration.xml.in
index a7f5982..6688877 100644
--- a/smf/manifests/firewaller-config-migration.xml.in
+++ b/smf/manifests/firewaller-config-migration.xml.in
@@ -20,15 +20,24 @@
       <service_fmri value="svc:/network/physical"/>
       <service_fmri value="svc:/system/filesystem/local"/>
     </dependency>
+    <dependency name="vminfod_when_present" grouping="optional_all" restart_on="error" type="service">
+      <service_fmri value="svc:/system/smartdc/vminfod"/>
+    </dependency>
     <!--
-        Make vmadmd and zones services depend on this service so that firewall
-        rules are correct before those services cause them to be read.
+        We make the zones service depend on this service so that the firewall
+        rules are correct before the zones (and other services like vmadmd)
+        cause them to be read.
     -->
-    <dependent name="smartdc_vmadmd_and_system_zones" grouping="optional_all" restart_on="none">
-      <service_fmri value="svc:/system/smartdc/vmadmd:default"/>
+    <dependent name="system_zones" grouping="optional_all" restart_on="none">
       <service_fmri value="svc:/system/zones:default"/>
     </dependent>
-    <exec_method type="method" name="start" exec="/usr/bin/ctrun -l child -o noorphan @@ROOT@@/node/bin/node --abort_on_uncaught_exception @@ROOT@@/config-migration.js &amp;" timeout_seconds="60">
+    <!--
+        When the config-migration.js script runs, it will look up all of the
+        VMs that have their firewall enabled, and will take care of regenerating
+        their ipfilter configuration if neeed. We run it using ctrun since it
+        spawns child processes, to ensure they get cleaned up.
+    -->
+    <exec_method type="method" name="start" exec="/usr/bin/ctrun -l child -o noorphan @@ROOT@@/node/bin/node --abort_on_uncaught_exception @@ROOT@@/config-migration.js" timeout_seconds="0">
       <method_context>
         <method_credential user="root" group="staff"/>
         <method_environment>
@@ -36,16 +45,14 @@
         </method_environment>
       </method_context>
     </exec_method>
-    <exec_method type="method" name="restart" exec=":kill" timeout_seconds="60">
-      <method_context>
-        <method_credential user="root" group="staff"/>
-      </method_context>
-    </exec_method>
-    <exec_method type="method" name="stop" exec=":kill" timeout_seconds="60">
+    <exec_method type="method" name="stop" exec=":true" timeout_seconds="60">
       <method_context>
         <method_credential user="root" group="staff"/>
       </method_context>
     </exec_method>
+    <property_group name='startd' type='framework'>
+      <propval name='duration' type='astring' value='transient' />
+    </property_group>
     <instance name="default" enabled="true"/>
     <stability value="Unstable"/>
     <template>
-- 
2.21.0

