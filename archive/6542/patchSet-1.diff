From 7f6f2f46e5f1eb72bf7649b9014c48c5a647da41 Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Wed, 3 Jul 2019 00:01:59 +0000
Subject: [PATCH] TRITON-1794 firewaller's configuration migration SMF service
 cannot be imported

---
 Makefile                                         | 1 +
 config-migration.js                              | 5 +++++
 smf/manifests/firewaller-config-migration.xml.in | 6 ++++--
 3 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index d5d17f3..68007af 100644
--- a/Makefile
+++ b/Makefile
@@ -101,6 +101,7 @@ release: all docs $(SMF_MANIFESTS)
 	(git symbolic-ref HEAD | awk -F/ '{print $$3}' && git describe) > $(DSTDIR)/describe
 	cp -r \
     $(TOP)/config.json \
+    $(TOP)/config-migration.js \
     $(TOP)/main.js \
     $(TOP)/lib \
     $(TOP)/node_modules \
diff --git a/config-migration.js b/config-migration.js
index 3c6ee11..65f4cdc 100644
--- a/config-migration.js
+++ b/config-migration.js
@@ -32,6 +32,8 @@ var LOG = bunyan.createLogger({
 var DEV_IPFEV = '/dev/ipfev';
 var IPF_CONF = '%s/config/ipf.conf';
 
+var SMF_EXIT_NODAEMON = 94;
+
 vasync.pipeline({
     funcs: [
         // Get all the local VMs with firewall_enabled=true
@@ -185,6 +187,9 @@ vasync.pipeline({
 }, function pipeCb(pipeErr) {
     if (pipeErr) {
         console.error(pipeErr);
+        process.exit(1);
+    } else {
+        process.exit(SMF_EXIT_NODAEMON);
     }
 });
 
diff --git a/smf/manifests/firewaller-config-migration.xml.in b/smf/manifests/firewaller-config-migration.xml.in
index a7f5982..a99956b 100644
--- a/smf/manifests/firewaller-config-migration.xml.in
+++ b/smf/manifests/firewaller-config-migration.xml.in
@@ -24,11 +24,13 @@
         Make vmadmd and zones services depend on this service so that firewall
         rules are correct before those services cause them to be read.
     -->
-    <dependent name="smartdc_vmadmd_and_system_zones" grouping="optional_all" restart_on="none">
+    <dependent name="smartdc_vmadmd" grouping="optional_all" restart_on="none">
       <service_fmri value="svc:/system/smartdc/vmadmd:default"/>
+    </dependent>
+    <dependent name="system_zones" grouping="optional_all" restart_on="none">
       <service_fmri value="svc:/system/zones:default"/>
     </dependent>
-    <exec_method type="method" name="start" exec="/usr/bin/ctrun -l child -o noorphan @@ROOT@@/node/bin/node --abort_on_uncaught_exception @@ROOT@@/config-migration.js &amp;" timeout_seconds="60">
+    <exec_method type="method" name="start" exec="/usr/bin/ctrun -l child -o noorphan @@ROOT@@/node/bin/node --abort_on_uncaught_exception @@ROOT@@/config-migration.js" timeout_seconds="0">
       <method_context>
         <method_credential user="root" group="staff"/>
         <method_environment>
-- 
2.21.0

