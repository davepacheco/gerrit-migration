{"project":"joyent/electric-moray","branch":"master","id":"I27c91ecbf129a0845e3b62b73d5b10329e4b57c9","number":"3114","subject":"MANTA-3476 read-only pnodes Reviewed by: Tim Kordas \u003ctim.kordas@joyent.com\u003e Reviewed by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e Approved by: Tim Kordas \u003ctim.kordas@joyent.com\u003e","owner":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"url":"https://cr.joyent.us/3114","commitMessage":"MANTA-3476 read-only pnodes\nReviewed by: Tim Kordas \u003ctim.kordas@joyent.com\u003e\nReviewed by: Kody A Kantor \u003ckody.kantor@gmail.com\u003e\nApproved by: Tim Kordas \u003ctim.kordas@joyent.com\u003e\n","createdOn":1513368368,"lastUpdated":1515537720,"open":false,"status":"MERGED","comments":[{"timestamp":1513368368,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 1."},{"timestamp":1513368395,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513373350,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 2."},{"timestamp":1513373376,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513626213,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(10 comments)"},{"timestamp":1513724599,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 3."},{"timestamp":1513724630,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513724896,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 4."},{"timestamp":1513725028,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513728350,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 5."},{"timestamp":1513728376,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513728746,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 6."},{"timestamp":1513728771,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513729191,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 7."},{"timestamp":1513729218,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513729535,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(20 comments)"},{"timestamp":1513740120,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 8."},{"timestamp":1513740145,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513800062,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 8:\n\n(5 comments)\n\nLooks good!"},{"timestamp":1513831887,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1513871468,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1513895570,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 9."},{"timestamp":1513895596,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514405675,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 9:\n\n(5 comments)"},{"timestamp":1514407851,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1514412473,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1514413314,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1514427184,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1514427251,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 10."},{"timestamp":1514427278,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514922702,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 10:\n\n(2 comments)\n\nLooks good to me, especially if we\u0027re going to cover cobweb cleaning at a later time. The only other small thing is that it\u0027s now 2018, so the copyrights could be updated."},{"timestamp":1514922717,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 10: Code-Review+1"},{"timestamp":1514945061,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 11."},{"timestamp":1514945089,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514945184,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 12."},{"timestamp":1514945212,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514995758,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 12: Code-Review+1"},{"timestamp":1515026539,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 13."},{"timestamp":1515026564,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515026645,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Patch Set 13: Code-Review+1 Integration-Approval+1"},{"timestamp":1515173500,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 13: Code-Review+1"},{"timestamp":1515519766,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Project policy requires all submissions to be a fast-forward.\n\nPlease rebase the change locally and upload again for review."},{"timestamp":1515519894,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 14: Commit message was updated."},{"timestamp":1515519963,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 15."},{"timestamp":1515519989,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15:\n\n\"make check\" passed ok"},{"timestamp":1515519994,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Uploaded patch set 16: Commit message was updated."},{"timestamp":1515524320,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 16: Code-Review+1\n\n(1 comment)"},{"timestamp":1515537720,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Brittany Wald"}],"currentPatchSet":{"number":"16","revision":"27c91ecbf129a0845e3b62b73d5b10329e4b57c9","parents":["16ae0803476aa58718df95712d1a73034345fbfb"],"ref":"refs/changes/14/3114/16","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1515519994,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515026564,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173500,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515524320,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"SUBM","value":"1","grantedOn":1515537720,"by":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":149,"deletions":-98},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-40}],"sizeInsertions":384,"sizeDeletions":-218},"patchSets":[{"number":"1","revision":"ae91ac4cc45984198672026d20928708779e0685","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/1","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513368368,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513368395,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"lib/ring.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"lib/server.js","type":"MODIFIED","insertions":290,"deletions":-100},{"file":"lib/status_server.js","type":"ADDED","insertions":87,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":23,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":2,"deletions":-33}],"sizeInsertions":505,"sizeDeletions":-140},{"number":"2","revision":"25fb86ddbd0526c8d4ff9ff2f16fbeb901b38ae8","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/2","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513373350,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513373376,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027m having trouble seeing where this new file gets used in the broader change.  If I\u0027ve just missed it, I apologise!"},{"file":"lib/errors.js","line":60,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think this is quite right -- the expansion token \"%s\" will require an additional string argument after the format string.\n\nAlso, the \"cause\" argument is, I think, intended to carry another Error object to make up the cause chain for WError/VError.  It doesn\u0027t seem to be _used_ anywhere in the code base, so I think we could just replace it with an optional pnode name; e.g.,\n\nfunction ReadOnlyError(pnode) {\n    if (!pnode) {\n        WError.call(this, cause, \u0027some vnodes are in read-only mode\u0027);\n    } else {\n        WError.call(this, cause, \u0027pnode \"%s\" is in read-only mode\u0027,\n            pnode);\n    }\n    this.name \u003d this.constructor.name;\n}"},{"file":"lib/server.js","line":317,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Is there a reason you decided to make this function asynchronous?  The information we\u0027re basing this decision on is always in memory (i.e., loaded from the configuration file into the \"indexShards\" object), so this could just be a synchronous function that returns the boolean directly.\n\nI think it would probably result in a lot less boilerplate at the call sites below; e.g., the calls could just be:\n\n    if (isReadOnlyPnode(readOnlyInfo)) {\n        rpc.fail(new ReadOnly...\n        return;\n    }\n\nThe structure of the function is otherwise good -- I just think we can make it all simpler by returning the value on 337 and 351 instead of requiring a callback."},{"file":"lib/server.js","line":320,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think we could make a more specific type assertion here; e.g., \"assert.arrayOfObject()\""},{"file":"lib/server.js","line":330,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think we should assert the shape of each entry in \"indexShards\"; e.g.,\n\n    assert.string(shard.host, \u0027shard.host\u0027);"},{"file":"lib/server.js","line":399,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Have you seen \"hostLabel\" documented somewhere as being a stable property that the Moray client object exposes to consumers?  I had a quick look, and I couldn\u0027t find any commitment to keep this in future versions."},{"file":"lib/server.js","line":608,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think this might not be a safe replacement for the original code.  In the original, a synchronous decision was made (L550) and the entire operation was failed if there were any read-only pnodes.\n\nIn the new version, it seems that we\u0027re leaving the read-only pnode decision until much later.  If one pnode is read-only, but it\u0027s the last one in the list, we will still have issued a number of bucket update operations to backends prior to deciding to fail the frontend RPC.  Indeed, we will also continue issuing more backend RPCs _after_ making the decision to fail the frontend RPC.\n\nI think we need to restructure this so that the decision is made _prior_ to issuing _any_ requests to backends."},{"file":"lib/server.js","line":657,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Doing this here has the same issue I described above (for \"updateBucket()\")"},{"file":"main.js","line":199,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"When we were initially working on this part, I hadn\u0027t noticed that the monitoring stuff was using a command-line flag to allow the port to be overridden.  We should probably follow suite; see:\n\n- the \u0027p\u0027 and \u0027k\u0027 options (line 127-132 above)\n- the DEFAULTS on line 32 above\n- the function \"manta_setup_electric_moray\" in \"boot/setup.sh\", which calculates the ports and sets SMF properties\n- the \"exec_method\" in \"smf/manifests/electric-moray.xml.in\", which turns the SMF properties into flags"},{"file":"sapi_manifests/electric-moray/template","line":28,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"While mustache makes it a bit difficult to correctly wrap these files to 80 columns, can we at least wrap the comment that way?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":3,"deletions":-4},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":290,"deletions":-100},{"file":"lib/status_server.js","type":"ADDED","insertions":87,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":24,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":6,"deletions":-1},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-32}],"sizeInsertions":506,"sizeDeletions":-142},{"number":"3","revision":"88bbd89de159fe2971e3cbbf4f2368a3eba81b29","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/3","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513724599,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513724630,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":193,"deletions":-78},{"file":"lib/status_server.js","type":"ADDED","insertions":87,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":29,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-32}],"sizeInsertions":434,"sizeDeletions":-128},{"number":"4","revision":"56e295e52fcc6501ff62f5b0151819c9878c529e","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/4","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513724896,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513725028,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":14,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would remove this comment."},{"file":"lib/client.js","line":88,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Remove this comment too, I think."},{"file":"lib/server.js","line":24,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think it\u0027s generally good to have the file name be the same as the variable we use during module import.  Either rename the variable to be just \"client\", or rename the file to be \"moray_client\".  Whichever is easier with respect to other naming conflicts."},{"file":"lib/server.js","line":312,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would either remove this part of the comment, or be a bit more explicit, e.g.:\n\n   Accepts an object \"ro\", with the following properties:\n      \"log\"            a bunyan logger\n      \"indexShards\"    array of index pnodes from our configuration file\n      \"morayClients\"   the moray client tracking object"},{"file":"lib/server.js","line":318,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think restructuring the arguments of this function might make sense as well.  In particular, you\u0027re getting \"indexShards\" and \"morayClients\" from the \"options\" variable that gets passed around -- so it might make sense to just pass that in directly; e.g.\n\nfunction listReadOnlyPnodes(log, options) {\n    assert.object(log, \u0027log\u0027);\n    assert.object(options, \u0027options\u0027);\n    assert.arrayOfObject(options.indexShards, \u0027indexShards\u0027);\n    assert.object(options.clients.map, \u0027clients.map\u0027);"},{"file":"lib/server.js","line":347,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I know I had suggested the use of \"forEachParallel()\", but (sorry!) I had meant for replacing (if needed) the use of \"opt.clients.array.forEach()\" in some of the multi-pnode operations.\n\nFor this function specifically, because it\u0027s a totally synchronous check, we should do something simpler like:\n\n    var allPnodes \u003d Object.keys(ro.morayClients.map);\n    var readOnlyPnodes \u003d allPnodes.filter(function (pnode) {\n        return (isReadOnlyPnode(log, indexShards, pnode));\n    });\n\nNote that this depends on restructuring the arguments to \"isReadOnlyPnode()\" as described below."},{"file":"lib/server.js","line":355,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Same block comment feedback as above for \"listReadOnlyPnodes()\"."},{"file":"lib/server.js","line":361,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I think to make this function a bit more composable, it might make sense to restructure the arguments; e.g.,\n\n    function isReadOnlyPnode(log, indexShards, pnode) {\n        assert.object(log, \u0027log\u0027);\n        assert.arrayOfObject(indexShards, \u0027indexShards\u0027);\n        assert.string(pnode, \u0027pnode\u0027);\n\nIn particular, \"pnode\" would accept the full URL (\"tcp://...\") rather than the shorter \"host\"-only Moray name."},{"file":"lib/server.js","line":373,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"If you make the \"pnode\" change above, this could then become:\n\n    var shard_url \u003d \u0027tcp://\u0027 + shard.host + \u0027:2020\u0027;\n\n    if (shard_url \u003d\u003d\u003d ro.pnode) {"},{"file":"lib/server.js","line":463,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think this line needed to change?"},{"file":"lib/server.js","line":623,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This line too?"},{"file":"lib/server.js","line":703,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think these lines needed to change?"},{"file":"lib/server.js","line":778,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I\u0027m still not sure that \"hostLabel\" on the Moray client is the right thing to use here.  Why not the value of \"pnode\"?  See also my comments in \"isReadOnlyPnode()\" above."},{"file":"lib/server.js","line":1266,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"While capitalising, can you also add a trailing period, and convert to\n\n  /*\n   * A C-style comment?\n   */"},{"file":"lib/status_server.js","line":14,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would remove the \"mod_\" prefix from this module import, for consistency with the others.\n\nAlso, I don\u0027t think any of \"fs\", \"path\", \"fash\", \"ring\", or \"Logger\" are actually used here?"},{"file":"lib/status_server.js","line":24,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I would ditch this, and all of the other, section heading comments.  They\u0027re mostly vestigial detritus to the extent that they still exist in other files."},{"file":"lib/status_server.js","line":26,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Please make this a C style comment; i.e.\n\n    /*\n     * This serves HTTP requests for electric-moray process state access.\n     */"},{"file":"lib/status_server.js","line":46,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Let\u0027s call the server \u0027electric-moray-status\u0027, rather than just \u0027status\u0027."},{"file":"lib/status_server.js","line":74,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t think this comment quite reflects the intent of the function.  In particular, we\u0027re not reading from \"svcs\" output -- just providing values that one might (e.g., in the resharding service) _correlate_ with information from svcs.  Maybe instead something like:\n\n    /*                                                                           \n     * Expose current configured state from this Electric Moray process.         \n     * We provide some details about our process and SMF identity to enable      \n     * other systems to correlate the output of svcs(1) with this status         \n     * object.                                                                   \n     */"},{"file":"sapi_manifests/electric-moray/template","line":29,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"\"mustache\"?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":10,"deletions":-10},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":193,"deletions":-78},{"file":"lib/status_server.js","type":"ADDED","insertions":87,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":29,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-32}],"sizeInsertions":435,"sizeDeletions":-129},{"number":"5","revision":"db7191959dc59166f192c7bb14eed5897ba22142","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/5","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513728350,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513728376,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-35},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":193,"deletions":-78},{"file":"lib/status_server.js","type":"ADDED","insertions":87,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":29,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-32}],"sizeInsertions":436,"sizeDeletions":-154},{"number":"6","revision":"1ef1050208f56e48cbd206f935f13fe5bd798512","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/6","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513728746,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513728771,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-35},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":193,"deletions":-78},{"file":"lib/status_server.js","type":"ADDED","insertions":81,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":29,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-32}],"sizeInsertions":430,"sizeDeletions":-154},{"number":"7","revision":"9d3060db8e98c5b84114109ad9ab92e6f44f15c4","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/7","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513729191,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513729218,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/client.js","type":"ADDED","insertions":92,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":11,"deletions":-35},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/server.js","type":"MODIFIED","insertions":193,"deletions":-78},{"file":"lib/status_server.js","type":"ADDED","insertions":81,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-6},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-32}],"sizeInsertions":431,"sizeDeletions":-157},{"number":"8","revision":"1c92fbf67992e3b7f28a843fb550c17065c27ec9","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/8","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513740120,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513740145,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/moray_client.js","line":37,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"It looks like we always throw errors in this function rather than return them through the callback. It looks like this function\u0027s caller immediately throws any errors sent up to it. Maybe instead of throwing in this function we could invoke callback(error, null)? I\u0027m not sure it would be any better or worse, but just different.\n\nI understand this code was just moved from another file, so if we don\u0027t want to make this change it\u0027s fine with me."},{"file":"lib/server.js","line":356,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Since this represents a serious configuration issue maybe this should be at the \u0027warn\u0027 level. What do you think?"},{"file":"lib/status_server.js","line":68,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Would you want to call next() at the end of this?"},{"file":"lib/status_server.js","line":68,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Yes, indeed!  I missed that."},{"file":"main.js","line":30,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"What do you think about adding the statusServer functionality to the monitoringServer instead of standing up another restify server?"},{"file":"main.js","line":30,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Our intent with the status server is to provide more control plane functionality in the future; e.g., the ability to manipulate the read-only pnode configuration on the fly without restarting, and the ability to update the hash ring database live as well.  I think keeping them separate allows us to evolve both API endpoint name spaces without future conflicts."},{"file":"main.js","line":30,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Okay, that sounds good. I think using the name \u0027status server\u0027 seems a little off, since that sort of makes it sound like it only supports read-only operations. But I guess the name could change whenever we wanted if we thought it stopped making sense."},{"file":"sapi_manifests/electric-moray/template","line":35,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Can we split this line up, or does it have to be all on a single line to work?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":148,"deletions":-97},{"file":"lib/status_server.js","type":"ADDED","insertions":74,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":11,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":0,"deletions":-39}],"sizeInsertions":378,"sizeDeletions":-215},{"number":"9","revision":"6bca1eae4f8456b50b5574c81e17f961c48e6db4","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/9","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1513895570,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513895596,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":25,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This ought to be:\n\n    VError.call(this, \u0027pnode \"%s\" is in read-only mode\u0027, pnode);\n\nSo that the \"pnode\" string variable is then included in the error message where the \"%s\" token is."},{"file":"lib/moray_client.js","line":62,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"With sort of a nod to Tim\u0027s comments in lib/server.js about the repeated code that checks if the pnode being used is read only, did you consider pushing that check into node-moray (providing an optional parameter that doesn\u0027t break the existing interface)? \n\nSince it doesn\u0027t seem like indexShards is changing during the lifetime of an e-moray process, could we mark each corresponding node-moray client as readOnly and let the decisions about what operations to allow to be made in its client API?\n\nThis way we could avoid the repeated code and prevent mistakes introduced by changes to the electric-moray rpc handlers. It might also allow us to leverage this functionality in other components that talk to moray (though I\u0027m not sure if such applications exist)."},{"file":"lib/moray_client.js","line":62,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"My thoughts are basically in line with what Josh had mentioned regarding the sentinel file here - I would like to involve as few components as possible in this change to limit the scope of testing.  The value of electric-moray for these checks is that the hash ring (and its pnode list) is directly accessible.  The duplication of the code in server.js is a choice for (imho) better readability and incremental improvement rather than a bigger rewrite.  After we do the first reshard there are a lot of refactors to electric-moray we\u0027ll make.  However, controlling which rpcs make it through to the morays is electric-moray\u0027s job, so that part will likely stay in here."},{"file":"lib/moray_client.js","line":62,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Makes sense, thanks for explaining that."},{"file":"lib/moray_client.js","line":70,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"do we not have multiple instances running in one zone ? maybe we should add the listen-port or something to the sentinel file ?"},{"file":"lib/moray_client.js","line":70,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I agree this is awful, but I\u0027d like to limit the scope of this change.  This function was really just moved out into a separate file.  We can file a follow-up ticket to deal with the sentinel file?"},{"file":"lib/server.js","line":339,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"hard-coded port ? is this always correct ? worth pulling out to the top as URL_PORT or something ?"},{"file":"lib/server.js","line":339,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"This is a somewhat unfortunate part of the original hash ring design.  I suspect it was done this way to allow test environments where several moray shards are running on different ports on a single host, and with no host name resolution configured.  Or just because we didn\u0027t think too hard about it.\n\nThe port stored in the database is decided when we set up the hash ring to begin with:\n\nhttps://github.com/joyent/sdc-manta/blob/master/bin/manta-deploy-dev#L86\n\nIn practice, we only use the port number as a fall-back in the case that SRV resolution (which would give us a new port, e.g. 2021, 2022, etc) is not working:\n\nhttps://github.com/joyent/electric-moray/blob/b94a706a7c94260ac41974173ea96d3fef9b75f5/lib/server.js#L1055\n\nIn fact, in the test configuration, it seems like we have created another level of indirection for test setups anyway:\n\nhttps://github.com/joyent/electric-moray/blob/b94a706a7c94260ac41974173ea96d3fef9b75f5/test/etc/config.json#L24-L25\n\nThe other option here would be to use the \"url\" module to attempt to parse the value of \"pnode\" as a URL, and possibly ignore the port number.  But that module has pretty awful error handling, and lots of sharp edges.\n\nAs far as I\u0027m aware, all of the production and lab rings which exist use port 2020."},{"file":"lib/server.js","line":409,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"this code is duplicated three times, maybe we can pull it out or refactor ? Or maybe I don\u0027t understand what\u0027s happening here ?"},{"file":"lib/server.js","line":409,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"Looking at this again; it seems like the refactor here could be to pull out this check, and forEach() block following into some common code, and pass the client.createBucket() function, with error handling, into that. Seems like the implementations of createBucket, updateBucket, and deleteBucket are almost all the same code with some small kernel of difference."},{"file":"lib/server.js","line":409,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"This is good suggestion, thank you!  If it is ok with you though, I think I will hold off on it until the first reshard is over.  I find the code a bit easier to follow this way, since the rpc fails more clearly in line with the pattern of how read-only vnodes fail.  I thought that readability gain was worth the sacrifice of leaving in some duplication (though much of the work is in the common functions listReadOnlyPnodes and isReadOnlyPnode)."},{"file":"lib/server.js","line":564,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"second occurrence."},{"file":"lib/server.js","line":638,"reviewer":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},"message":"third."},{"file":"sapi_manifests/electric-moray/template","line":37,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Why might it be the case that readOnly \u003d false? Should this array always contain all the pnodes we get from the hash ring? What does it mean for a pnode object (an \u0027index pnode\u0027) to be in this array and where is decision about what pnodes to put in made?\n\nI would find it useful to have a note or link to an explanation of what the meaning of this field is and what the consistent values for it are (though I may have just not found the right documentation so apologies if it already exists)."},{"file":"sapi_manifests/electric-moray/template","line":37,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"readOnly should never be false, only true or absent -- in order to preserve backwards compatibility.  indexShards should indeed always be the same as the pnodes for the hash ring, and serves as a map of hosts (pnodes) to their readOnly status -- these values are pulled from SAPI metadata, which is set either through manta-shardadm or direct manipulation of the app metadata fields.  server.js contains a note after a check for this correspondence on line 351, but I\u0027ll include fuller documentation here with respect to appropriate values for the field -- thank you for giving it your attention!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":148,"deletions":-97},{"file":"lib/status_server.js","type":"ADDED","insertions":75,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":13,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":0,"deletions":-39}],"sizeInsertions":381,"sizeDeletions":-215},{"number":"10","revision":"57c0a446101b2d016d7e63cc1989e7625d09b819","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/10","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1514427251,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514427278,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1514922717,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"lib/status_server.js","line":43,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Should we return the error through the callback, or is this fine the way it is? I notice that the caller has an error handler that is currently unused, but it does essentially the same thing as this (prints error and exits 1). The only difference seems to be the log level (fatal vs error). Not a big deal if we decide not to make this change."},{"file":"lib/status_server.js","line":47,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Not a big deal, but the pattern for the other servers seems to be \u0027\u003cserver name\u003e listening|started on \u003cport\u003e\u0027"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":148,"deletions":-97},{"file":"lib/status_server.js","type":"ADDED","insertions":75,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":0,"deletions":-39}],"sizeInsertions":384,"sizeDeletions":-215},{"number":"11","revision":"86386bebf911b3ad0242802ec3de654279c22104","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/11","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1514945061,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514945089,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":148,"deletions":-97},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/etc/read-only-pnode-config.json","type":"ADDED","insertions":29,"deletions":0},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":0,"deletions":-39}],"sizeInsertions":410,"sizeDeletions":-215},{"number":"12","revision":"6d56618261a80610dee5cecd748d38197c3bd504","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/12","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1514945184,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514945212,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1514995758,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":148,"deletions":-97},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":0,"deletions":-39}],"sizeInsertions":381,"sizeDeletions":-215},{"number":"13","revision":"284e44d575014879ca1d1ac6c14d1d5841808bff","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/13","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1515026539,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515026564,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173500,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":149,"deletions":-98},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-40}],"sizeInsertions":384,"sizeDeletions":-218},{"number":"14","revision":"9a513e08391ff3a1a1a977493f8de186f38666fa","parents":["b94a706a7c94260ac41974173ea96d3fef9b75f5"],"ref":"refs/changes/14/3114/14","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1515519894,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515026564,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173500,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":149,"deletions":-98},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-40}],"sizeInsertions":384,"sizeDeletions":-218},{"number":"15","revision":"1f23dc5f604580c9975535722cc9823f3a66789d","parents":["16ae0803476aa58718df95712d1a73034345fbfb"],"ref":"refs/changes/14/3114/15","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1515519963,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515026564,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173500,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":149,"deletions":-98},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-40}],"sizeInsertions":384,"sizeDeletions":-218},{"number":"16","revision":"27c91ecbf129a0845e3b62b73d5b10329e4b57c9","parents":["16ae0803476aa58718df95712d1a73034345fbfb"],"ref":"refs/changes/14/3114/16","uploader":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"createdOn":1515519994,"author":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515026564,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1515537720,"by":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515173500,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515026645,"by":{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515524320,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"boot/setup.sh","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"lib/errors.js","type":"MODIFIED","insertions":13,"deletions":-52},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-7},{"file":"lib/moray_client.js","type":"ADDED","insertions":90,"deletions":0},{"file":"lib/server.js","type":"MODIFIED","insertions":149,"deletions":-98},{"file":"lib/status_server.js","type":"ADDED","insertions":72,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":30,"deletions":-16},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/electric-moray/template","type":"MODIFIED","insertions":16,"deletions":-1},{"file":"smf/manifests/electric-moray.xml.in","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"test/resharding/roBuckets.test.js","type":"MODIFIED","insertions":1,"deletions":-40}],"sizeInsertions":384,"sizeDeletions":-218}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Tim Kordas","email":"tim.kordas@joyent.com","username":"timkordas"},{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}]}