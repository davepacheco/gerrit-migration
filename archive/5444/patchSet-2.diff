From 5936ecf25754c62df5703816c6561092afb0eba4 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Thu, 7 Feb 2019 19:04:34 +0000
Subject: [PATCH] OS-7543 Marlin jobs crash zoneadmd on 20181206T011455Z PI

---
 usr/src/cmd/zoneadmd/log.c      | 15 ++++++++-------
 usr/src/cmd/zoneadmd/zcons.c    |  4 ++--
 usr/src/cmd/zoneadmd/zfd.c      |  6 +++---
 usr/src/cmd/zoneadmd/zoneadmd.c |  4 ++--
 usr/src/cmd/zoneadmd/zoneadmd.h |  4 ++--
 5 files changed, 17 insertions(+), 16 deletions(-)

diff --git a/usr/src/cmd/zoneadmd/log.c b/usr/src/cmd/zoneadmd/log.c
index 1afe8e9fae..f08f0288ec 100644
--- a/usr/src/cmd/zoneadmd/log.c
+++ b/usr/src/cmd/zoneadmd/log.c
@@ -10,7 +10,7 @@
  */
 
 /*
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -257,7 +257,7 @@ logfile_write_event(logfile_t *lfp, const char *stream, const char *event)
 }
 
 static void
-close_log(logfile_t *lfp, const char *why)
+close_log(logfile_t *lfp, const char *why, boolean_t ign_err)
 {
 	int err;
 
@@ -278,7 +278,8 @@ close_log(logfile_t *lfp, const char *why)
 	logfile_write_event(lfp, "logfile", why);
 
 	err = close(lfp->lf_fd);
-	assert(err == 0);
+	if (!ign_err)
+		assert(err == 0);
 
 	lfp->lf_size = 0;
 	lfp->lf_fd = -1;
@@ -340,7 +341,7 @@ logstream_sighandler(int sig)
 
 		switch (sig) {
 		case SIGHUP:
-			close_log(&logfiles[i], "close-rotate");
+			close_log(&logfiles[i], "close-rotate", B_FALSE);
 			open_log(&logfiles[i], "open-rotate");
 			break;
 		case SIGUSR1:
@@ -500,7 +501,7 @@ rotate_log(logfile_t *lfp)
 		    "'%s' to '%s'", lfp->lf_path, path);
 	}
 
-	close_log(lfp, "close-rotate");
+	close_log(lfp, "close-rotate", B_FALSE);
 	open_log(lfp, "open-rotate");
 
 	if (logging_rot_keep == 0) {
@@ -917,7 +918,7 @@ logstream_open(const char *logname, const char *stream, logstream_flags_t flags)
 }
 
 void
-logstream_close(int ls)
+logstream_close(int ls, boolean_t abrupt)
 {
 	logstream_t *lsp;
 	logfile_t *lfp;
@@ -948,7 +949,7 @@ logstream_close(int ls)
 
 	/* No more streams using this log file so return to initial state */
 
-	close_log(lfp, "close");
+	close_log(lfp, "close", abrupt);
 
 	(void) memset(lfp, 0, sizeof (*lfp));
 	lfp->lf_fd = -1;
diff --git a/usr/src/cmd/zoneadmd/zcons.c b/usr/src/cmd/zoneadmd/zcons.c
index ce398faf30..70abfc8d66 100644
--- a/usr/src/cmd/zoneadmd/zcons.c
+++ b/usr/src/cmd/zoneadmd/zcons.c
@@ -22,7 +22,7 @@
 /*
  * Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  * Copyright 2015 Nexenta Systems, Inc. All rights reserved.
  */
 
@@ -1055,5 +1055,5 @@ death:
 	destroy_console_sock(serverfd);
 	(void) destroy_console_devs(zlogp);
 
-	logstream_close(conslog);
+	logstream_close(conslog, B_FALSE);
 }
diff --git a/usr/src/cmd/zoneadmd/zfd.c b/usr/src/cmd/zoneadmd/zfd.c
index 3ccc6575da..8f4307a653 100644
--- a/usr/src/cmd/zoneadmd/zfd.c
+++ b/usr/src/cmd/zoneadmd/zfd.c
@@ -22,7 +22,7 @@
 /*
  * Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 /*
@@ -1107,8 +1107,8 @@ death:
 	eventstream[0] = -1;
 	(void) close(eventstream[1]);
 	eventstream[1] = -1;
-	logstream_close(logout);
-	logstream_close(logerr);
+	logstream_close(logout, B_FALSE);
+	logstream_close(logerr, B_FALSE);
 }
 
 /*
diff --git a/usr/src/cmd/zoneadmd/zoneadmd.c b/usr/src/cmd/zoneadmd/zoneadmd.c
index 71ded8ba0c..798eb766a0 100644
--- a/usr/src/cmd/zoneadmd/zoneadmd.c
+++ b/usr/src/cmd/zoneadmd/zoneadmd.c
@@ -22,7 +22,7 @@
 /*
  * Copyright (c) 2003, 2010, Oracle and/or its affiliates. All rights reserved.
  * Copyright 2014 Nexenta Systems, Inc. All rights reserved.
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  * Copyright (c) 2016 by Delphix. All rights reserved.
  */
 
@@ -1727,7 +1727,7 @@ server(void *cookie, char *args, size_t alen, door_desc_t *dp,
 	 * it is time for us to shut down zoneadmd.
 	 */
 	if (zargp == DOOR_UNREF_DATA) {
-		logstream_close(platloghdl);
+		logstream_close(platloghdl, B_TRUE);
 
 		/*
 		 * See comment at end of main() for info on the last rites.
diff --git a/usr/src/cmd/zoneadmd/zoneadmd.h b/usr/src/cmd/zoneadmd/zoneadmd.h
index 471aa40a0e..06353cbe61 100644
--- a/usr/src/cmd/zoneadmd/zoneadmd.h
+++ b/usr/src/cmd/zoneadmd/zoneadmd.h
@@ -22,7 +22,7 @@
 /*
  * Copyright (c) 2003, 2010, Oracle and/or its affiliates. All rights reserved.
  * Copyright 2014 Nexenta Systems, Inc. All rights reserved.
- * Copyright 2018 Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 #ifndef	_ZONEADMD_H
@@ -177,7 +177,7 @@ extern void destroy_log_thread(zlog_t *);
 extern void logstream_init(zlog_t *);
 extern int logstream_open(const char *, const char *, logstream_flags_t);
 extern void logstream_write(int, char *, int);
-extern void logstream_close(int);
+extern void logstream_close(int, boolean_t);
 
 /*
  * Contract handling.
-- 
2.21.0

