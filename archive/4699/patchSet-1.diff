From 31b3b6552929f1a1b937bd3fdf5da3db4b13f7bc Mon Sep 17 00:00:00 2001
From: Dave Eddy <dave@daveeddy.com>
Date: Thu, 16 Aug 2018 14:01:03 -0400
Subject: [PATCH] joyent/node-manta#251 specifying a path multiple times to
 mfind results in crash

---
 bin/mfind | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/bin/mfind b/bin/mfind
index 820582b..8f65083 100755
--- a/bin/mfind
+++ b/bin/mfind
@@ -8,6 +8,7 @@ var http = require('http');
 var https = require('https');
 var path = require('path');
 var url = require('url');
+var util = require('util');
 
 var assert = require('assert-plus');
 var bunyan = require('bunyan');
@@ -156,8 +157,9 @@ function printEntry(opts, obj) {
         }
     });
 
-    options.paths.forEach(function (p) {
-        barrier.start(p);
+    options.paths.forEach(function (p, i) {
+        var id = util.format('%d %s', i, p);
+        barrier.start(id);
         client.ftw(p, options, function (err, res) {
             if (err) {
                 if (err.name === 'InvalidDirectoryError') {
@@ -168,14 +170,14 @@ function printEntry(opts, obj) {
                     if (options.limit && totalEntries >= options.limit) {
                         process.exit(0);
                     }
-                    barrier.done(p);
+                    barrier.done(id);
                     return;
                 } else if (err.name === 'NotFoundError') {
                     if (err.path === undefined)
                         err.path = p;
                     printError(err.path, err);
                     lastError = err;
-                    barrier.done(p);
+                    barrier.done(id);
                     return;
                 } else {
                     var epath = p;
@@ -187,7 +189,7 @@ function printEntry(opts, obj) {
             }
 
             res.on('entry', print);
-            res.on('end', barrier.done.bind(barrier, p));
+            res.on('end', barrier.done.bind(barrier, id));
         });
     });
 })();
-- 
2.21.0

