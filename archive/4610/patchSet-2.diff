From 7ce691cde22a9f1264a831f7a8d62b1d92e70f0d Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Tue, 31 Jul 2018 14:42:02 -0700
Subject: [PATCH] TRITON-647 vmapi NAT zone destruction should use SAPI
 DeleteInstance

---
 lib/workflows/fabric-common.js | 23 ++++++++++++++---------
 package.json                   |  2 +-
 2 files changed, 15 insertions(+), 10 deletions(-)

diff --git a/lib/workflows/fabric-common.js b/lib/workflows/fabric-common.js
index 5d03c78..53d95e6 100644
--- a/lib/workflows/fabric-common.js
+++ b/lib/workflows/fabric-common.js
@@ -487,10 +487,6 @@ function destroyFabricNats(job, cb) {
         url: napiUrl,
         headers: headers
     });
-    var vmapi = new sdcClients.VMAPI({
-        url: vmapiUrl,
-        headers: headers
-    });
 
     /* Find the NAT VM and destroy it. */
     function destroyNatZone(fabricNic, done) {
@@ -498,7 +494,14 @@ function destroyFabricNats(job, cb) {
             alias: 'nat-' + fabricNic.network_uuid,
             state: 'running'
         };
+        var vmapi = new sdcClients.VMAPI({
+            url: vmapiUrl,
+            headers: headers
+        });
+
         vmapi.listVms(listVmParams, function onGetVm(err, vms) {
+            var sapi;
+
             if (err) {
                 done(err);
                 return;
@@ -520,11 +523,13 @@ function destroyFabricNats(job, cb) {
                 'Destroying NAT zone');
 
             /* Synchronously destroy the NAT vm. */
-            var deleteVmParams = {
-                sync: true,
-                uuid: vms[0].uuid
-            };
-            vmapi.deleteVm(deleteVmParams, function (dErr) {
+            sapi = new sdcClients.SAPI({
+                url: sapiUrl,
+                headers: headers,
+                version: '~2',
+                log: job.log.child({ component: 'sapi' })
+            });
+            sapi.deleteInstance(vms[0].uuid, function (dErr) {
                 if (dErr && dErr.statusCode !== 404) {
                     done(dErr);
                     return;
diff --git a/package.json b/package.json
index dc7a977..54d449d 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "vmapi",
   "description": "VMs API",
-  "version": "9.6.1",
+  "version": "9.6.2",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

