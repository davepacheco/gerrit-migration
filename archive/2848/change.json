{"project":"joyent/sdc-vmapi","branch":"master","id":"Iffdfd0c36259ecd674a5813a9d6498df69a13164","number":"2848","subject":"ZAPI-805 VM.internal_metadata field should be searchable Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"url":"https://cr.joyent.us/2848","commitMessage":"ZAPI-805 VM.internal_metadata field should be searchable\nReviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1508882448,"lastUpdated":1510025869,"open":false,"status":"MERGED","comments":[{"timestamp":1508882448,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 1."},{"timestamp":1508882477,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508889859,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(25 comments)\n\nNot quite done lib/data-migrations/... yet, but here is a start."},{"timestamp":1508893766,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1508906083,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(8 comments)"},{"timestamp":1508967551,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1508972761,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(32 comments)"},{"timestamp":1509139826,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(10 comments)\n\nI\u0027ll probably take another pass through this to make sure I didn\u0027t miss anything, but overall it looks good to me. I do have one question though: is the idea that a single property will be handled by, at max, only one of the scripts under lib/data-migrations/migrations? If you realized that you needed to add a new field, and migrating it relied on internal-metadata-search.js having done its job already, you would need to add that work inside internal-metadata-search.js instead of adding a new file, since there\u0027s no guarantee that the migrations will be run in any order.\n\nI\u0027m not sure if the way I\u0027m phrasing that is very clear, so any example would be: DATA_VERSION\u003d2 comes out, and we haven\u0027t migrated to DATA_VERSION\u003d1 yet. DATA_VERSION\u003d2 relies on having the internal metadata search field already there. In order for the object to be migrated correctly, we\u0027ll need to make sure that the logic comes towards the end of internal-metadata-search.js, instead of adding a my-new-field.js."},{"timestamp":1509144209,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(10 comments)"},{"timestamp":1509148021,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1509148652,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1509149289,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1509585947,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 2."},{"timestamp":1509585975,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1509656539,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(13 comments)"},{"timestamp":1509662778,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 3."},{"timestamp":1509662784,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(12 comments)"},{"timestamp":1509662806,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510010083,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1510010452,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1510011478,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 4."},{"timestamp":1510011481,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1510011506,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510011894,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1510016004,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3:\n\n(12 comments)"},{"timestamp":1510017651,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Uploaded patch set 5."},{"timestamp":1510017656,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(6 comments)"},{"timestamp":1510017679,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1510021371,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1510023821,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1510023917,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1510023959,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1510025869,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Julien Gilli"}],"currentPatchSet":{"number":"7","revision":"a4ffc12f2ed72f26f78dfd21e77ce755248ecfdc","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/7","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1510023959,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510017679,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510021371,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510023917,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1510025869,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":47,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":390,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-2},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":302,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":618,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2603,"sizeDeletions":-241},"patchSets":[{"number":"1","revision":"3f96ef87c63247591cd8c4cccddf055378689fe9","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/1","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1508882448,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508882477,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":431,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"thanks for alphabetizing these!"},{"file":"docs/index.md","line":438,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Markdown link would be great here as it is \u003e200 lines away."},{"file":"docs/index.md","line":438,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"docs/index.md","line":685,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: \"There are\""},{"file":"docs/index.md","line":685,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"docs/index.md","line":686,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think restructuring this would make it clearer:\n\n    Pattern matching is not available, so matching needs to be exact."},{"file":"docs/index.md","line":686,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"docs/index.md","line":698,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"What\u0027s the reason for this? Is this a Moray limitation, or something else? And do I need to just truncate the query, or do I also need to truncate the internal metadata value when I initially set it?"},{"file":"docs/index.md","line":698,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"The rationale for this is more about preventing to write unbounded metadata values to the database, and thus potentially incurring a significant performance impact for several components of the stack (when metadata is written to VM configuration objects on CNs, sent back to VMAPI by vm-agent, etc.).\n\nIt\u0027s a bit lazy and incomplete, since one would still be able to have a metadata key longer than 100 characters.\n\n\u003e And do I need to just truncate the query, or do I also need to truncate the internal metadata value when I initially set it?\n\nTruncating the internal metadata value is not needed when it is initially set, it is truncated implicitly when it\u0027s written to Moray.\n\nWhat are your thoughts on this? I think we want to keep limiting the length of the internal_metadata values for the reason mentioned above, and possibly the length of the internal_metadata keys too. If we do that though, I\u0027m sure we can make this doc clearer."},{"file":"docs/index.md","line":698,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"How about just *dropping* keys with values \u003e100 chars from internal_metadata_search_array? I.e. it is only for searching short values."},{"file":"docs/index.md","line":698,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Or not allow searching on objects at all? Relying on the order that the keys are stringified in does not feel very reliable."},{"file":"docs/index.md","line":698,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m sorry if I missed something. How is *order* involved here?"},{"file":"lib/apis/moray.js","line":447,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"`\u003d\u003d\u003d 0`  You want it rooted at the start."},{"file":"lib/apis/moray.js","line":447,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":453,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is wrong if there is a \u0027.\u0027 in the param name:\n\n```\n\u003e paramName \u003d \u0027internal_metadata.foo.bar\u0027\n\u0027internal_metadata.foo.bar\u0027\n\u003e paramName.split(\u0027.\u0027)[1]\n\u0027foo\u0027\n```\n\nuse strsplit module or get the first indexOf(\u0027.\u0027)."},{"file":"lib/apis/moray.js","line":453,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This function assumes that all query parameters are already validated. This validation assumes that internal metadata keys have a specific format, where a dot character is not allowed.\n\nIt seems from this comment and others in this CR that it is a wrong assumption though. So I\u0027ll check what the format of internal metadata keys/values is and I\u0027ll revisit both this code and the validation code.\n\nThoughts?"},{"file":"lib/apis/moray.js","line":457,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Can a metadataKey have a \u0027\u003d\u0027 in it?\n\n```\nsdc-vmapi /vms?tag.fart%3Dblah\u003dfoo\n```\n\nresults in this in the VMAPI log, for example:\n\n```\n    GET /vms?tag.fart%3Dblah\u003dfoo HTTP/1.1\n    host: vmapi.nightly-1.joyent.us\n    user-agent: curl/7.51.0\n    accept: application/json\n    content-type: application/json\n    accept-version: *\n    --\n    HTTP/1.1 200 OK\n    connection: close\n    x-joyent-resource-count: 0\n    content-type: application/json\n    content-length: 2\n    content-md5: 11FxOYiYfpMxmANj4kGJzg\u003d\u003d\n    date: Tue, 24 Oct 2017 22:57:52 GMT\n    server: VMAPI\n    x-request-id: efff8ed4-8175-47a7-afeb-e8b06a6b0fd4\n    x-response-time: 17\n    x-server-name: dc889cf7-59a4-40cb-96c4-138ca266e0b1\n    --\n    req.query: {\n      \"tag.fart\u003dblah\": \"foo\"\n    }\n```\n\nShould this code then LDAP\u003descape here? Actually maybe it is fine. The metadataKey and Value are already after the first \u0027\u003d\u0027 in the filter."},{"file":"lib/apis/moray.js","line":457,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e Should this code then LDAP\u003descape here? Actually maybe it is fine. The metadataKey and Value are already after the first \u0027\u003d\u0027 in the filter.\n\nThat was my reasoning, but adding a test for this wouldn\u0027t hurt, thanks!"},{"file":"lib/apis/moray.js","line":457,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"There are problems with having an \u0027\u003d\u0027 in the value part of the query, due to bugs in the old Moray filter parser. If these are operating on user-defined values, then it would probably be best to use node-moray-filter to construct the filter, so that it escapes \u0027\u003d\u0027 and other troublesome characters."},{"file":"lib/apis/moray.js","line":457,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It doesn\u0027t seem to affect the findObjects requests filtering on the newly added internal_metadata_search_array field though, but I could be missing something:\n\n```\n[root@8333b79f-6f23-42fd-b988-e05dd8955292 (coal:moray0) ~]# putbucket -i \u0027search_array:[string]\u0027 test_search_array\n[root@8333b79f-6f23-42fd-b988-e05dd8955292 (coal:moray0) ~]# putobject -d \u0027{\"search_array\":[\"some\u003dkey\u003dfoo\"]}\u0027 test_search_array foo\n[root@8333b79f-6f23-42fd-b988-e05dd8955292 (coal:moray0) ~]# findobjects test_search_array \u0027(search_array\u003dsome\u003dkey\u003dfoo)\u0027\n{\n  \"bucket\": \"test_search_array\",\n  \"key\": \"foo\",\n  \"value\": {\n    \"search_array\": [\n      \"some\u003dkey\u003dfoo\"\n    ]\n  },\n  \"_id\": 2,\n  \"_etag\": \"1257C1F6\",\n  \"_mtime\": 1509141668351,\n  \"_txn_snap\": null,\n  \"_count\": 1\n}\n[root@8333b79f-6f23-42fd-b988-e05dd8955292 (coal:moray0) ~]# \n```\n\nand in manatee:\n```\nmoray\u003d\u003e SELECT search_array FROM test_search_array;\n  search_array  \n----------------\n \n {some\u003dkey\u003dfoo}\n(2 rows)\n\nmoray\u003d\u003e\n```"},{"file":"lib/apis/moray.js","line":1556,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is it \"all\" or is it one page up to 1000 of them?"},{"file":"lib/apis/moray.js","line":1556,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It\u0027s not all, just one page. Thanks for catching that. How about I change this to:\n\n\"Finds the next chunk of VM records that need to be changed...\"\n\n?"},{"file":"lib/apis/moray.js","line":1571,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Do we want some assertion that it is an *integer*? Might be overkill."},{"file":"lib/apis/moray.js","line":1571,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does the \"assert.ok(version \u003e\u003d 1, \u0027version \u003e\u003d 1\u0027);\" achieve what you\u0027re thinking about, or is there an \"integer\" function in assert-plus that I missed (looking at assert-plus\u0027 README, I wasn\u0027t able to find one).\n\nI also made the opinionated choice of not allowing version 0 for data migrations, although I don\u0027t have a strong opinion about this, so we could allow 0 as a valid data migration version number too."},{"file":"lib/apis/moray.js","line":1645,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Would be nice to have the func name or something, e.g. \"findVmRecordsToMigrate: ...\", in the message."},{"file":"lib/apis/moray.js","line":1645,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You want that to be \u0027err\u0027 or just call `log.error(err, \u0027your message ...\u0027)`"},{"file":"lib/apis/moray.js","line":1645,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":1645,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I changed that to:\n\n\"Error when finding next chunk of records to migrate\"\n\nto make it less generic.\n\nSomehow I don\u0027t like duplicating the function name in the log message, but if you\u0027d rather have that I don\u0027t have a strong opinion about it, so I could change it to that."},{"file":"lib/apis/moray.js","line":1647,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Curious: can that be false? Can the \u0027error\u0027 event be called without an error object?"},{"file":"lib/apis/moray.js","line":1647,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I don\u0027t think it can be false, this was muscle memory (originally this code was dereferencing \"err\"). I\u0027ll remove that."},{"file":"lib/apis/moray.js","line":1662,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this what one of the above tickets is about? If so, the association isn\u0027t super clear."},{"file":"lib/apis/moray.js","line":1662,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"MORAY-428 and MORAY-104 are about something different than what this section of the comment is about.\n\nThis section is about the fact that after a new indexed field has been added to a Moray bucket\u0027s schema, there\u0027s still a delay before queries can be made that use this field in their filter.\n\nLet\u0027s talk in meat space to see how I can clarify this."},{"file":"lib/common/ldap-filter.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"2017? This is new code? or copied from somewhere else?"},{"file":"lib/common/ldap-filter.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"OOPS!"},{"file":"lib/common/ldap-filter.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This is new code, but copyright statement was copied. I really have difficulties with updating copyright statements :(. Fixed!"},{"file":"lib/common/ldap-filter.js","line":27,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Need to escape the parenthesis?\n\n```\n\u003e pat \u003d new RegExp(\u0027(\u0027 + \u0027foo\u0027  + \u0027\u003d\u0027)\nSyntaxError: Invalid regular expression: /(foo\u003d/: Unterminated group\n```"},{"file":"lib/common/ldap-filter.js","line":27,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good catch, I didn\u0027t have an integration test exercising this code path, so I just added one, made sure it was triggering this error, fixed the problem and made sure the newly added test case passed."},{"file":"lib/common/predicate.js","line":218,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Add \u0027^\u0027 anchor.\nPerhaps add it for the /tag.../ regex above as well."},{"file":"lib/common/predicate.js","line":218,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Make sense, I added a ^, but also an \"end\" anchor ($) to both."},{"file":"lib/common/predicate.js","line":218,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Should this be \u0027+\u0027 (and maybe for tag, too)?"},{"file":"lib/common/predicate.js","line":218,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e Should this be \u0027+\u0027 (and maybe for tag, too)?\n\nIt seems that ideally we\u0027d want to do that, but:\n\n1. for internal_metadata at least, in practice the JSON predicate is already validated and we don\u0027t accept empty values\n\n2. Even if we didn\u0027t validate that values are not the empty string, we wouldn\u0027t handle the empty string case well, since we\u0027d get into the else branch which would basically generate a bogus LDAP filter. So it seems that this module operates on the assumption that the JSON predicate is well formed.\n\nFor these reasons I\u0027m reluctant to make further changes *in this CR* to make this implementation potentially more robust.\n\nDoes that make sense?"},{"file":"lib/common/predicate.js","line":360,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Doubled \"that\"."},{"file":"lib/common/predicate.js","line":360,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/common/predicate.js","line":371,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: parsedJsonPred"},{"file":"lib/common/predicate.js","line":371,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/common/validation.js","line":40,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Does this add a new restriction that internal_metadata keys on VMs must match this?  I don\u0027t think that matches currently allowed values. E.g.:\n\n```\n[root@headnode (nightly-1) ~]# echo \u0027{\"set_internal_metadata\": {\"foo\": \"bar\"}}\u0027 | vmadm update 52167905-0387-45e6-9bc3-a4d959b1a5d0\nSuccessfully updated VM 52167905-0387-45e6-9bc3-a4d959b1a5d0\n[root@headnode (nightly-1) ~]# vmadm get 52167905-0387-45e6-9bc3-a4d959b1a5d0 | json internal_metadata\n{\n  \"foo\": \"bar\"\n}\n```\n\nOh... or if this is just for ListVms params, why can I not search for `GET /vms?internal_metadata.foo\u003dbar` (no \u0027:\u0027 in my query)?"},{"file":"lib/common/validation.js","line":40,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"As mentioned in previous replies, I made some assumptions about the format of internal metadata keys/values that I need to revisit. I\u0027ll update this in consequence."},{"file":"lib/common/validation.js","line":742,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"wanted \"Param\" there?"},{"file":"lib/common/validation.js","line":742,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/common/validation.js","line":2449,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"What are the valid values for field name here? Can it contain things like \u0027.\u0027 or other regex-special characters? Would it be better to do below:\n\n    if (paramName.indexOf(fieldName + \u0027.\u0027) \u003d\u003d\u003d 0) {\n        return true;\n    }"},{"file":"lib/common/validation.js","line":2449,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e Would it be better to do below:\n\n    if (paramName.indexOf(fieldName + \u0027.\u0027) \u003d\u003d\u003d 0) {\n        return true;\n    }\n\nYes, that\u0027s much better, done!"},{"file":"lib/common/vm-common.js","line":8,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"SO SAD!"},{"file":"lib/common/vm-common.js","line":8,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Think of the Joshes!"},{"file":"lib/common/vm-common.js","line":8,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Oops, sorry Josh :D"},{"file":"lib/common/vm-common.js","line":507,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"\"has no\""},{"file":"lib/common/vm-common.js","line":507,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/data-migrations/controller.js","line":18,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"What is that import? Is there a migrations.js that I\u0027m missing? or a migrations/index.js?"},{"file":"lib/data-migrations/controller.js","line":18,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It\u0027s a leftover from a previous iteration of these changes. I didn\u0027t catch this because \"tools/rsync-to\" didn\u0027t delete that file from my COAL test environment when I deleted it from my source tree. Will remove!"},{"file":"lib/data-migrations/controller.js","line":53,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps lowercase?"},{"file":"lib/data-migrations/controller.js","line":53,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done, also a leftover from a previous iteration."},{"file":"lib/data-migrations/controller.js","line":71,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This is a transient error, since this gets returned when there  are no current connections to Manatee, or when Moray is currently overloaded due to too many requests. It\u0027s also what we\u0027re going to start returning at some point when the database returns an error stating that it\u0027s starting up/shutting down.\n\nWhile this might not resolve right away (e.g. if Manatee is broken), it\u0027s no reason to stop retrying. It might also resolve very quickly (e.g., after a Manatee flip, or during headnode startup while we\u0027re still waiting on the Manatee zone to start)."},{"file":"lib/data-migrations/controller.js","line":71,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sounds good, a quick look at the code in Moray:\n\n    if (!db) {\n        callback(new NoDatabasePeersError());\n        return;\n    }\n\nmade me think it was about the actual database not being created, thank you for clarifying. Taking a closer look at the rest of the code makes sense now.\n\nI\u0027ll remove that error from the set of transient errors."},{"file":"lib/data-migrations/controller.js","line":104,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Bunyan does `(\u0027... %sms\u0027, delay)`. Just sayin\u0027. ;)"},{"file":"lib/data-migrations/controller.js","line":104,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/data-migrations/controller.js","line":111,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can we include number and delay in this object?"},{"file":"lib/data-migrations/controller.js","line":111,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Good point, done!"},{"file":"lib/data-migrations/controller.js","line":173,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could this block be reduced to something like?\n\n```\nfunction runSingleMigration(migration, next) {\n    _runSingleMigration({\n        log: log,\n        moray: moray,\n        migration: migration\n    }, next);\n}\n```\n\nand then tweak _runSingleMigration slightly to use `migration.DATA_VERSION`?"},{"file":"lib/data-migrations/controller.js","line":173,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/data-migrations/controller.js","line":231,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This\u0027ll be a huge amount of log output?"},{"file":"lib/data-migrations/controller.js","line":231,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, does a trace level log sound good to you?"},{"file":"lib/data-migrations/controller.js","line":240,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"double indentation?"},{"file":"lib/data-migrations/controller.js","line":240,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/data-migrations/index.js","line":20,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is allowing a custom migrationsDirPath here to support testing? Else it feels like an unnecessary feature."},{"file":"lib/data-migrations/index.js","line":20,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, that is precisely the reason. Hopefully I can come up with automated tests for the data migrations process in a future patch in this CR."},{"file":"lib/data-migrations/index.js","line":39,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Really suggest that only files following a certain pattern (*.js or migration-*.js or something) be considered for migrationFiles. Then a README.md or Vim .swp file or a \"*.bak\" or \"*.orig\" file, e.g. if a developer is editing/monkey-patching a deployed VMAPI, doesn\u0027t accidentally break things."},{"file":"lib/data-migrations/index.js","line":39,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That makes sense, will do."},{"file":"lib/data-migrations/index.js","line":46,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"DataMigrationController seems to expect these migrations to be ordered by data_version... but this code doesn\u0027t do that. Perhaps the data_version could be part of the migration module name?  Something like migrations/v001-internal-metadata-search.js and then the read files can be sorted alphabetically."},{"file":"lib/data-migrations/index.js","line":46,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That also makes sense, will do."},{"file":"lib/data-migrations/migrations/internal-metadata-search.js","line":41,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Do we want to crash (repeatedly) if there is a record with bogus data that isn\u0027t JSON.parseable?\n\nDoes VMAPI already crash on these VMAPI records? E.g. in GetVm or ListVms? If so, perhaps this is fine."},{"file":"lib/data-migrations/migrations/internal-metadata-search.js","line":41,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"My reasoning was that any data that is in Moray has been validated, so it\u0027s unlikely this would error (but I agree it\u0027s not impossible).\n\nIt\u0027s not clear what to do if we had a parse error here. If we don\u0027t mark the record as migrated, then we\u0027ll be stuck on that migration forever until we notice there\u0027s an error.\n\nOn the other hand, if we abort due to an uncaught exception, then we can notice earlier and maybe fix the object in place?\n\nOne problem with this approach is that we wouldn\u0027t be able to use VMAPI to fix that object, because VMAPI would crash as soon as we\u0027d start it, so we\u0027d have to do that manually (using a moray client or a PostgreSQL client).\n\nThe \"translateVm\" function in lib/common/vm-common.js catches exceptions when parsing the internal_metadata property, and just ignores the error, which seems to indicate we don\u0027t care too much about being notified of tese errors.\n\nSo maybe we can try/catch here and just log any error, write the empty array to the internal_metadata_search_array indexed field, mark this record as migrated and move on?"},{"file":"lib/endpoints/vms.js","line":208,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"perhaps trace level for this"},{"file":"lib/endpoints/vms.js","line":208,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/moray/moray-buckets-config.js","line":30,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Where if anywhere are there docs for what each field in the vmapi_vms bucket means? Would this be a good place (just before the \"var VMS_BUCKET_CONFIG\") to have a block comment for interesting fields here? E.g. data_version?"},{"file":"lib/moray/moray-buckets-config.js","line":30,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Added comments for \"internal_metadata_search_array\" and \"data_version\" fields."},{"file":"lib/vmapi.js","line":395,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Should this be indented four spaces?"},{"file":"lib/vmapi.js","line":395,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I don\u0027t know. I\u0027ve seen a lot of different styles across many different Triton repos.\n\nIn general, if the style checker doesn\u0027t output an error, I consider that the style is fine.\n\nIf I indent this by four spaces, should I indent the body of the function from the function declaration too like following:\n\nVmapiApp.prototype.getLatestCompletedDataMigration \u003d\n    function getLatestCompletedDataMigration() {\n        if (this.dataMigrationCtrl \u003d\u003d\u003d undefined) {\n            return;\n        }\n\n        return this.dataMigrationCtrl.latestCompletedMigration;\n    };\n\n?"},{"file":"lib/vmapi.js","line":395,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I was thinking that just the line with the function keyword would need to change, so that the style would be similar to how things are indented in lib/moray/moray-buckets-initializer.js, like the MorayBucketsInitializer.start() method."},{"file":"lib/vmapi.js","line":395,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I made the change, but in the future I\u0027d appreciate if we considered that code that passes the style checker is fine. Otherwise it opens the door to endless subjective nitpicking.\n\nIf we want a stricter style, let\u0027s fix the style checker."},{"file":"server.js","line":157,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ignorant Q: Is it a problem to have the changefeed publisher running when we are doing data migrations?"},{"file":"server.js","line":157,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Changefeed listeners need to specify the list of properties for which they\u0027d like to be notified when their value changes.\n\nSo unless one listener explcitly mentions \u0027data_version\u0027, it should not have any impact, besides generating more writes to the VMAPI\u0027s publisher moray bucket, but at the same tome all writes performed by VMAPI do that.\n\nDoes that answer the question?"},{"file":"server.js","line":170,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"are these lines needed?"},{"file":"server.js","line":216,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"purposefully?"},{"file":"server.js","line":216,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I think I was going for \"purposely\", is that correct?"},{"file":"server.js","line":225,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is it possible to race and miss this \u0027done\u0027 event?"},{"file":"server.js","line":225,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In theory, it is possible. In practice, it is very unlikely. \n\nBasically, for the morayBucketsInitializer\u0027s \u0027done\u0027 event to be emitted before this listener is set, the whole buckets initialization process would need to happen in one turn of the event loop.\n\nSince the moray buckets initialization process itself uses a multiple stage vasync.pipeline and each of these stages performs network I/O, this wouldn\u0027t happen unless there\u0027s a fundamental bug in that process.\n\nSo currently, I made the decision to write this code in a separate vasync function for clarity, but putting it in the previous \"initMorayApi\" function would definitely be more correct.\n\nSo I\u0027ll probably just do that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":29,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":208,"deletions":-8},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":69,"deletions":-4},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":112,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":76,"deletions":-1},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":260,"deletions":0},{"file":"lib/data-migrations/index.js","type":"ADDED","insertions":61,"deletions":0},{"file":"lib/data-migrations/migrations/internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":37,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":28,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":11,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":0},{"file":"server.js","type":"MODIFIED","insertions":56,"deletions":-7},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":250,"deletions":0},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":1295,"sizeDeletions":-77},{"number":"2","revision":"8f012e372f7ec26d52e54cee298e7bfc75dad43d","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/2","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1509585947,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509585975,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":715,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"grammar nit: \"There are two\""},{"file":"docs/index.md","line":715,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"docs/index.md","line":717,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps say \"not supported\" rather than not possible. \"Possible\" could be interpreted as the it being impossible to implement, rather than a design choice."},{"file":"docs/index.md","line":717,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"docs/index.md","line":721,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this really a limitation to mention? Perhaps we could just remind the caller that IM values are strings, so if you are searching for values that are encoded objects it is up to the caller to use a canonical or stable string serialization."},{"file":"docs/index.md","line":721,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/common/vm-common.js","line":521,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"What other type can there be? I though vmadm restricted internal_metadata values to only the above three."},{"file":"lib/common/vm-common.js","line":521,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/common/vm-common.js","line":526,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I thought we\u0027d not want to add keys to searchArray if above the 100 char length.  If \"foo\u003d\" is put on search array, will I get a hit for `?internal_metadata.foo\u003d`? Or does something else prevent that?"},{"file":"lib/common/vm-common.js","line":526,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/data-migrations/controller.js","line":85,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"That should be plural, right?"},{"file":"lib/data-migrations/controller.js","line":85,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/data-migrations/controller.js","line":143,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah... for a while there I thought this was saying it would multiple migrations *for the same model* in parallel (which would be problematic). However it is just doing separate models in parallel."},{"file":"lib/data-migrations/controller.js","line":143,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That\u0027s a good point, hopefully I clarified this part of the comment."},{"file":"lib/data-migrations/controller.js","line":153,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"twitch on that space :)"},{"file":"lib/data-migrations/controller.js","line":153,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Me too! Done."},{"file":"lib/data-migrations/loader.js","line":35,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps include the literal hyphen there?"},{"file":"lib/data-migrations/loader.js","line":35,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That makes sense, fixed."},{"file":"lib/data-migrations/loader.js","line":118,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"typo?"},{"file":"lib/data-migrations/loader.js","line":131,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is `dirEntries` necessarily set if there is a `rootDirReadErr`?"},{"file":"lib/data-migrations/loader.js","line":131,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It\u0027s not, fixed!"},{"file":"lib/data-migrations/noop-controller.js","line":12,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"immediately"},{"file":"lib/data-migrations/noop-controller.js","line":12,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":52,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":386,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-1},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":301,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":255,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":614,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":259,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2592,"sizeDeletions":-240},{"number":"3","revision":"3b2c7c2c2267ccce4ddf92a033dca87bfe648f10","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/3","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1509662778,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509662806,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510010083,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510010083,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/apis/moray.js","line":134,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"assert.object?"},{"file":"lib/apis/moray.js","line":134,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/apis/moray.js","line":136,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"assert.finite?"},{"file":"lib/apis/moray.js","line":136,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"In this case we want to check that the buckets configuration object as a \"schema.index.data_version\" property that is an object of the form \"{type: \u0027number\u0027}\" that represents an index.\n\nSo I refactored this a bit to check that (including the index type)."},{"file":"lib/apis/moray.js","line":1668,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Can you add: \"(See below for why.)\""},{"file":"lib/apis/moray.js","line":1668,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"lib/common/vm-common.js","line":518,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"assert.fail?"},{"file":"lib/common/vm-common.js","line":518,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What\u0027s the advantage of using \"fail\" over \"ok\"? Also, I don\u0027t see any doc on how to use fail, so I\u0027m inclined to keep it as is, at least for now."},{"file":"lib/data-migrations/loader.js","line":219,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Maybe rephrase this as \u0027Found %d invalid file names\u0027, so that it\u0027s clearer that the number\u0027s a count?"},{"file":"lib/data-migrations/loader.js","line":219,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"},{"file":"test/vms.data-migrations.test.js","line":271,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Does this make it select a random port?"},{"file":"test/vms.data-migrations.test.js","line":271,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Yes, let me clarify that in a comment."},{"file":"test/vms.data-migrations.test.js","line":287,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"t.ifError(pingErr,"},{"file":"test/vms.data-migrations.test.js","line":287,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Using t.ifError with nodeunit doesn\u0027t output any message, so  using t.ok allows us to output a bit more context."},{"file":"test/vms.data-migrations.test.js","line":347,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"You can drop the \u0027got: ...\u0027 bit and do:\n\n    t.ifError(pingErr,"},{"file":"test/vms.data-migrations.test.js","line":423,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"t.ifError(findErr,"},{"file":"test/vms.data-migrations.test.js","line":449,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"t.ifError(pingErr,"},{"file":"test/vms.data-migrations.test.js","line":493,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"t.ifError(cleanupErr,"},{"file":"test/vms.data-migrations.test.js","line":543,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"t.ifError(writeErr,"},{"file":"test/vms.data-migrations.test.js","line":596,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"t.fail"},{"file":"test/vms.list-filter-internal-metadata.test.js","line":109,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This indentation is a bit confusing to initially read. Maybe move doList up out of the object, and do:\n\n    function doList(...) {\n        ...\n    }\n\n    vasync.forEachPipeline({\n        func: doList,\n        inputs: testCase.queryStrings\n    }, next);"},{"file":"test/vms.list-filter-internal-metadata.test.js","line":109,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":47,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":386,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-2},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":302,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":614,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":259,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2590,"sizeDeletions":-241},{"number":"4","revision":"cda87be46788ca1477280f6690142cdc1e4c9fac","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/4","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1510011478,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510011506,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510011894,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510011894,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":47,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":390,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-2},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":302,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":614,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":259,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2594,"sizeDeletions":-241},{"number":"5","revision":"ffdfd0c36259ecd674a5813a9d6498df69a13164","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/5","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1510017651,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510021371,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510017679,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":47,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":390,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-2},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":302,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":618,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2603,"sizeDeletions":-241},{"number":"6","revision":"df011deb4ee0c779cf367822beb6ed30429e3025","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/6","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1510023821,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510021371,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510017679,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510023917,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":47,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":390,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-2},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":302,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":618,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2603,"sizeDeletions":-241},{"number":"7","revision":"a4ffc12f2ed72f26f78dfd21e77ce755248ecfdc","parents":["537b4b18ca98e88636862313ab903374bfda1546"],"ref":"refs/changes/48/2848/7","uploader":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"createdOn":1510023959,"author":{"name":"Julien Gilli","email":"julien.gilli@joyent.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1510021371,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1510017679,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1510023917,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1510025869,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":47,"deletions":-10},{"file":"lib/apis/moray.js","type":"MODIFIED","insertions":390,"deletions":-98},{"file":"lib/common/index.js","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"lib/common/ldap-filter.js","type":"ADDED","insertions":34,"deletions":0},{"file":"lib/common/predicate.js","type":"MODIFIED","insertions":70,"deletions":-5},{"file":"lib/common/validation.js","type":"MODIFIED","insertions":102,"deletions":-40},{"file":"lib/common/vm-common.js","type":"MODIFIED","insertions":66,"deletions":-2},{"file":"lib/data-migrations/controller.js","type":"ADDED","insertions":302,"deletions":0},{"file":"lib/data-migrations/loader.js","type":"ADDED","insertions":257,"deletions":0},{"file":"lib/data-migrations/migrations/vms/001-internal-metadata-search.js","type":"ADDED","insertions":55,"deletions":0},{"file":"lib/data-migrations/noop-controller.js","type":"ADDED","insertions":49,"deletions":0},{"file":"lib/endpoints/ping.js","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/endpoints/vms.js","type":"MODIFIED","insertions":38,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":44,"deletions":-1},{"file":"lib/moray/moray-buckets-config.js","type":"MODIFIED","insertions":26,"deletions":-8},{"file":"lib/moray/moray-buckets-initializer.js","type":"MODIFIED","insertions":16,"deletions":-22},{"file":"lib/moray/moray-init.js","type":"MODIFIED","insertions":6,"deletions":-4},{"file":"lib/vmapi.js","type":"MODIFIED","insertions":21,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"server.js","type":"MODIFIED","insertions":79,"deletions":-17},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/001-invalid-file-extension.foo","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js","type":"ADDED","insertions":9,"deletions":0},{"file":"test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js","type":"ADDED","insertions":23,"deletions":0},{"file":"test/fixtures/vmapi-server-throwing-expected-stderr.txt","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"test/fixtures/vmapi-server-with-throwing-handler.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/lib/vm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"test/vms.data-migrations.test.js","type":"ADDED","insertions":618,"deletions":0},{"file":"test/vms.list-filter-internal-metadata.test.js","type":"ADDED","insertions":264,"deletions":0},{"file":"test/vms.reindex-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"test/vms.update-moray-bucket-non-transient-error.test.js","type":"MODIFIED","insertions":9,"deletions":-6},{"file":"test/vms.update-moray-bucket-removes-index-fails.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"test/vms.update-moray-bucket-transient-error.test.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"test/vms.update-moray-bucket-versioning.test.js","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/jsl.node.conf","type":"MODIFIED","insertions":1,"deletions":0}],"sizeInsertions":2603,"sizeDeletions":-241}],"allReviewers":[{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}]}