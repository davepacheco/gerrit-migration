{"project":"joyent/sdc-sapi","branch":"master","id":"Id7546ef94b9f17a5addb039eb7a001cf76b39c1e","number":"3594","subject":"TRITON-231 sapi: abort-on-uncaught-exception, improved audit logging (include GetConfig), drop unused middleware Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/3594","commitMessage":"TRITON-231 sapi: abort-on-uncaught-exception, improved audit logging (include GetConfig), drop unused middleware\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1520883561,"lastUpdated":1520895176,"open":false,"status":"MERGED","comments":[{"timestamp":1520883561,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1520883562,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 6925db859712697cdd8de0b6f9c03e059e2b13dd\n    \n    better audit logger; drop middleware; don\u0027t handle uncaught exceptions"},{"timestamp":1520883598,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(2 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1520888569,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nneed a package.json bump?"},{"timestamp":1520889753,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\n(10 comments)"},{"timestamp":1520891310,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1520891533,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1520892230,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2."},{"timestamp":1520892231,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 79e1562cce904952ec7cfa5e78de49e9bd154f8b\n    \n    fix make check; move funcs to top-level that don\u0027t enclose vars"},{"timestamp":1520892258,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520892802,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Code-Review+1\n\n(4 comments)\n\nstill missing a package.json bump?"},{"timestamp":1520893224,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1520893225,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 9167c8ffa43032c040d1af67a44670d1378c5e64\n    \n    clarify req.body type for audit logging (diff starting in restify 5.x)"},{"timestamp":1520893250,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520893419,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3: Code-Review+1\n\n(1 comment)\n\nstill missing package.json bump. :)"},{"timestamp":1520893484,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 4."},{"timestamp":1520893485,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 9fd90794eca5fae826ad0fa205e965d4f5b4338c\n    \n    clarify req.body type for audit logging (diff starting in restify 5.x)\n    \n    commit f3ee768a6afa92c4d3b52f5b10b28357d706cc28\n    \n    fix make check; move funcs to top-level that don\u0027t enclose vars\n    \n    commit 03419263472e2e63173c3db77a9b367754519ac2\n    \n    better audit logger; drop middleware; don\u0027t handle uncaught exceptions"},{"timestamp":1520893553,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520894218,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 5."},{"timestamp":1520894220,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 61634b6328d44115105dbac3dd6065273302ff07\n    \n    ver bump; missed on newline for elided\n    \n    commit 3bedf17b62527e8026c7e96d57aa5a787dbb56de\n    \n    sort fields in objects"},{"timestamp":1520894245,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1520894571,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\n(2 comments)\n\nlgtm. I just noticed a lot of unnamed functions, but I guess we don\u0027t care as much about that until we have better `make check`."},{"timestamp":1520894676,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1520894681,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"},{"timestamp":1520895176,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(2 comments)"}],"currentPatchSet":{"number":"6","revision":"d7546ef94b9f17a5addb039eb7a001cf76b39c1e","parents":["9031d01af19f900bcf930ec96c2cb891d84c6225"],"ref":"refs/changes/94/3594/6","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520894676,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520894245,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520894571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520894571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1520894681,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":384,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-22},"patchSets":[{"number":"1","revision":"87c2ffa949c08eac487214cf0661feec184adb83","parents":["73af84391c89f486180f307d7bf8bf549aec43ea"],"ref":"refs/changes/94/3594/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520883561,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1520883598,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/server/audit.js","line":63,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: empty statement or extra semicolon"},{"file":"lib/server/audit.js","line":105,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"warning: empty statement or extra semicolon"},{"file":"lib/server/audit.js","line":112,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I wonder if we might want a newline here before the ...\u003celided?"},{"file":"lib/server/audit.js","line":112,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"sure, will do."},{"file":"lib/server/audit.js","line":120,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"POJO?! Since when are we using Java Objects?"},{"file":"lib/server/audit.js","line":120,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Note the \"(This was lifted from restify v6.x\u0027s lib/plugins/audit.js.)\"."},{"file":"lib/server/audit.js","line":120,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"restify: demerit"},{"file":"lib/server/audit.js","line":134,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Are we ok using ES6 features?"},{"file":"lib/server/audit.js","line":134,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Interesting. This function is copied from restify\u0027s lib/plugins/audit.js. It exists in restify 4.x which has \n```\n  \"engines\": {\n    \"node\": \"\u003e\u003d0.10\"\n  },\n```\n\nSo that is a restify bug.\n\nFWIW, this works in node v4.x. I\u0027d be happy limiting this audit module to only working on node v4.x. Thoughts?"},{"file":"lib/server/audit.js","line":134,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"That\u0027s fine with me. I just wanted to point that out in case we made it a module and we tried to use it somewhere with 0.10."},{"file":"lib/server/audit.js","line":191,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Why create this function here instead of top-level? Is there an advantage none of the `opts` are used so aren\u0027t we just creating extra closures and making createAuditLogHandler longer?"},{"file":"lib/server/audit.js","line":191,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yup, it could be at top-level.\n\nXXX I\u0027m asking about your second Q. I\u0027m confused."},{"file":"lib/server/audit.js","line":191,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I think gerrit ate part of my message earlier. But I think we straightened this out."},{"file":"lib/server/audit.js","line":200,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Why create this function here instead of top-level? Is there an advantage none of the `opts` are used so aren\u0027t we just creating extra closures and making createAuditLogHandler longer?"},{"file":"lib/server/audit.js","line":226,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Why create this function here instead of top-level? Is there an advantage none of the `opts` are used so aren\u0027t we just creating extra closures and making createAuditLogHandler longer?"},{"file":"lib/server/audit.js","line":266,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Why create this function here instead of top-level? Is there an advantage none of the `opts` are used so aren\u0027t we just creating extra closures and making createAuditLogHandler longer?"},{"file":"lib/server/audit.js","line":293,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"perhaps sort these? ¯\\_(ツ)_/¯"},{"file":"lib/server/audit.js","line":293,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This block was copied from restify\u0027s lib/plugins/audit.js. I could tho."},{"file":"lib/server/audit.js","line":315,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"perhaps sort these? ¯\\_(ツ)_/¯"},{"file":"lib/server/audit.js","line":315,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This block was copied from restify\u0027s lib/plugins/audit.js. I could tho."},{"file":"lib/server/audit.js","line":339,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"perhaps sort these? ¯\\_(ツ)_/¯"},{"file":"lib/server/audit.js","line":339,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This block was copied from restify\u0027s lib/plugins/audit.js. I could tho."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":365,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21}],"sizeInsertions":385,"sizeDeletions":-21},{"number":"2","revision":"4efb548c284b9e8efcbd409ad0f01f9df0311b4b","parents":["73af84391c89f486180f307d7bf8bf549aec43ea"],"ref":"refs/changes/94/3594/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520892230,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520892258,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520892802,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/server/audit.js","line":114,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"You added a \u0027\\n\u0027 to the previous ...\u003celided message, should this have one too?"},{"file":"lib/server/audit.js","line":114,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"bump"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":380,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21}],"sizeInsertions":400,"sizeDeletions":-21},{"number":"3","revision":"f61102ce3abb182e9da70bb42bf971f0d234db1c","parents":["73af84391c89f486180f307d7bf8bf549aec43ea"],"ref":"refs/changes/94/3594/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520893224,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520893250,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520893419,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":384,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21}],"sizeInsertions":404,"sizeDeletions":-21},{"number":"4","revision":"c936788a0454740b6f0632f3938154e4622cbe6e","parents":["9031d01af19f900bcf930ec96c2cb891d84c6225"],"ref":"refs/changes/94/3594/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520893484,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520893553,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":384,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21}],"sizeInsertions":404,"sizeDeletions":-21},{"number":"5","revision":"73db54406073a144b5e9a96842e4d09604db7e27","parents":["9031d01af19f900bcf930ec96c2cb891d84c6225"],"ref":"refs/changes/94/3594/5","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520894218,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520894245,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520894571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520894571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/server/audit.js","line":77,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"ooc: what other cases are there?"},{"file":"lib/server/audit.js","line":77,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Other cases:\n- it is defined, but not a string (e.g. in restify 4.x `req.body` will be the parsed JSON as an object, assuming into is JSON)\n- it is defined, is a string, but is not above maxLen.\n\nFor these cases we just want to leave `auditBody` as is."},{"file":"lib/server/audit.js","line":120,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"same question as above: what other cases are there?"},{"file":"lib/server/audit.js","line":120,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Other cases:\n- it is defined, is a string, but is not above maxLen.\n\nFor these cases we just want to leave `auditBody` as is."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":384,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-22},{"number":"6","revision":"d7546ef94b9f17a5addb039eb7a001cf76b39c1e","parents":["9031d01af19f900bcf930ec96c2cb891d84c6225"],"ref":"refs/changes/94/3594/6","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1520894676,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1520894245,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1520894681,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1520894571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1520894571,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/server/audit.js","type":"ADDED","insertions":384,"deletions":0},{"file":"lib/server/sapi.js","type":"MODIFIED","insertions":20,"deletions":-21},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-22}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}