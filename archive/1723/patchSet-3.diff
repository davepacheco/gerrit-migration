From 1d56cba6b62f59771a8d6cc8fb6232b233467316 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Mon, 27 Mar 2017 18:24:32 +1300
Subject: [PATCH] DAPI-338: DAPI hard-filter-invalid-servers algorithm dies on
 VMs in transient state

---
 lib/algorithms/calculate-ticketed-vms.js      |  3 +-
 package.json                                  |  2 +-
 .../algorithms/calculate-ticketed-vms.test.js |  2 --
 test/algorithms/hf-invalid-servers.json       | 36 +++++++------------
 test/common.json                              | 36 ++++---------------
 test/validations.test.js                      |  3 +-
 6 files changed, 21 insertions(+), 61 deletions(-)

diff --git a/lib/algorithms/calculate-ticketed-vms.js b/lib/algorithms/calculate-ticketed-vms.js
index 5ef2168..5dddaee 100644
--- a/lib/algorithms/calculate-ticketed-vms.js
+++ b/lib/algorithms/calculate-ticketed-vms.js
@@ -106,8 +106,7 @@ createVm(ticket)
 		quota: meta.quota,
 		brand: meta.brand,
 		zone_state: 'running',
-		state: 'running',
-		last_modified: new Date().toISOString()
+		state: 'running'
 	};
 
 	if (vm.brand === 'kvm') {
diff --git a/package.json b/package.json
index 7af21ec..18d66ce 100644
--- a/package.json
+++ b/package.json
@@ -8,7 +8,7 @@
     "assert-plus": "~1.0.0",
     "bunyan": "1.8.5",
     "libuuid": "0.2.1",
-    "joyent-schemas": "git+https://github.com/joyent/schemas.git#ccd6342096ae044be07c840e4e281fa1f695f767",
+    "joyent-schemas": "git+https://github.com/joyent/schemas.git#77afd7c080fb89c1efe1afd582e9b553ae856e5d",
     "jsprim": "1.3.1",
     "vasync": "~1.6.4"
   },
diff --git a/test/algorithms/calculate-ticketed-vms.test.js b/test/algorithms/calculate-ticketed-vms.test.js
index 8d748f2..a6646a6 100644
--- a/test/algorithms/calculate-ticketed-vms.test.js
+++ b/test/algorithms/calculate-ticketed-vms.test.js
@@ -211,7 +211,6 @@ test('calculate ticketed VMs', function (t) {
 
 		var vmUuid = '8e54da2f-996f-491c-92ff-1b1d6c48f314';
 		var server = servers[1];
-		delete server.vms[vmUuid].last_modified;
 		t.deepEqual(server, {
 			uuid: '67e48c2e-45bb-400a-bc7d-3143894aacfa',
 			disk_kvm_zvol_volsize_bytes: 0,
@@ -232,7 +231,6 @@ test('calculate ticketed VMs', function (t) {
 
 		vmUuid = 'cbd5b6b3-861d-44d1-a2b7-65ea39ada45a';
 		server = servers[2];
-		delete server.vms[vmUuid].last_modified;
 		t.deepEqual(server, {
 			uuid: '0c104a5b-1844-4205-821b-f0c989ccf6e7',
 			disk_kvm_zvol_volsize_bytes: 25 * GiB,
diff --git a/test/algorithms/hf-invalid-servers.json b/test/algorithms/hf-invalid-servers.json
index bbe3298..7e09ffe 100644
--- a/test/algorithms/hf-invalid-servers.json
+++ b/test/algorithms/hf-invalid-servers.json
@@ -27,16 +27,14 @@
 				"state": "running",
 				"cpu_cap": 350,
 				"quota": 25,
-				"max_physical_memory": 2048,
-				"last_modified": "2014-03-12T10:55:29.487Z"
+				"max_physical_memory": 2048
 			},
 			"b3d04682-536f-4f09-8170-1954e45e9e1c": {
 				"brand": "kvm",
 				"state": "running",
 				"cpu_cap": 350,
 				"quota": 5,
-				"max_physical_memory": 128,
-				"last_modified": "2014-03-12T14:37:34.598Z"
+				"max_physical_memory": 128
 			}
 		}
 	},
@@ -64,8 +62,7 @@
 				"state": "running",
 				"cpu_cap": 350,
 				"quota": 20,
-				"max_physical_memory": 512,
-				"last_modified": "2014-03-12T13:55:38.326Z"
+				"max_physical_memory": 512
 			},
 			"335498f7-a1ed-420c-8367-7f2769ca1e84": {
 				"owner_uuid": "fa08a498-3264-4ec0-99ef-365731a1c9cc",
@@ -73,8 +70,7 @@
 				"state": "running",
 				"cpu_cap": 350,
 				"quota": 10,
-				"max_physical_memory": 4096,
-				"last_modified": "2014-03-12T14:44:42.110Z"
+				"max_physical_memory": 4096
 			}
 		}
 	},
@@ -108,8 +104,7 @@
 				"state": "failed",
 				"cpu_cap": 350,
 				"quota": 20,
-				"max_physical_memory": 512,
-				"last_modified": "2014-03-12T13:10:45.293Z"
+				"max_physical_memory": 512
 			},
 			"335498f7-a1ed-420c-8367-7f2769ca1e84": {
 				"owner_uuid": "24ccd11a-fb18-45e8-99ea-a2b561352526",
@@ -117,8 +112,7 @@
 				"state": "running",
 				"cpu_cap": 350,
 				"quota": 10,
-				"max_physical_memory": 4096,
-				"last_modified": "2014-03-12T12:49:49.246Z"
+				"max_physical_memory": 4096
 			}
 		}
 	},
@@ -153,8 +147,7 @@
 				"state": "failed",
 				"cpu_cap": 350,
 				"quota": 20,
-				"max_physical_memory": 512,
-				"last_modified": "2014-03-12T13:10:45.293Z"
+				"max_physical_memory": 512
 			},
 			"335498f7-a1ed-420c-8367-7f2769ca1e84": {
 				"owner_uuid": "24ccd11a-fb18-45e8-99ea-a2b561352526",
@@ -162,8 +155,7 @@
 				"state": "running",
 				"cpu_cap": 350,
 				"quota": 10,
-				"max_physical_memory": 4096,
-				"last_modified": "2014-03-12T12:49:49.246Z"
+				"max_physical_memory": 4096
 			}
 		}
 	},
@@ -200,8 +192,7 @@
 				"state": "running",
 				"cpu_cap": 700,
 				"quota": 20,
-				"max_physical_memory": 512,
-				"last_modified": "2014-03-12T12:19:52.789Z"
+				"max_physical_memory": 512
 			},
 			"9dd471a6-4679-4201-a02d-5e824deefc3e": {
 				"owner_uuid": "08c55217-b479-42af-8968-4ae52c183241",
@@ -209,8 +200,7 @@
 				"state": "installed",
 				"cpu_cap": 200,
 				"quota": 30,
-				"max_physical_memory": 4096,
-				"last_modified": "2014-03-12T12:25:57.093Z"
+				"max_physical_memory": 4096
 			},
 			"3575c7b5-e644-4357-8b89-9188a883da8d": {
 				"owner_uuid": "ffc02424-c50d-4fa8-bb63-d848ac55ea21",
@@ -218,8 +208,7 @@
 				"state": "failed",
 				"cpu_cap": 200,
 				"quota": 30,
-				"max_physical_memory": 4096,
-				"last_modified": "2014-03-12T12:27:40.235Z"
+				"max_physical_memory": 4096
 			}
 		}
 	},
@@ -281,8 +270,7 @@
 				"brand": "joyent",
 				"cpu_cap": 200,
 				"quota": 30,
-				"max_physical_memory": 4096,
-				"last_modified": "2014-03-12T12:27:40.235Z"
+				"max_physical_memory": 4096
 			}
 		}
 	},
diff --git a/test/common.json b/test/common.json
index fc94152..c80c4f8 100644
--- a/test/common.json
+++ b/test/common.json
@@ -175,8 +175,7 @@
 					"zone_state": "running",
 					"state": "running",
 					"brand": "joyent",
-					"cpu_cap": 100,
-					"last_modified": "2013-06-21T17:38:51.000Z"
+					"cpu_cap": 100
 				},
 				"c3ae2426-9ed2-4322-a780-9ef032359d9a": {
 					"uuid": "c3ae2426-9ed2-4322-a780-9ef032359d9a",
@@ -186,8 +185,7 @@
 					"zone_state": "running",
 					"state": "running",
 					"brand": "joyent",
-					"cpu_cap": 300,
-					"last_modified": "2013-06-06T22:22:31.000Z"
+					"cpu_cap": 300
 				},
 				"9dc466a4-b918-4a6f-9226-1e49d0017a79": {
 					"uuid": "9dc466a4-b918-4a6f-9226-1e49d0017a79",
@@ -197,8 +195,7 @@
 					"zone_state": "running",
 					"state": "running",
 					"brand": "joyent",
-					"cpu_cap": 100,
-					"last_modified": "2013-07-09T20:22:25.000Z"
+					"cpu_cap": 100
 				},
 				"01d16d02-9713-4bfa-a572-b68ef9eed942": {
 					"uuid": "01d16d02-9713-4bfa-a572-b68ef9eed942",
@@ -208,8 +205,7 @@
 					"zone_state": "running",
 					"state": "running",
 					"brand": "kvm",
-					"cpu_cap": 300,
-					"last_modified": "2013-07-30T20:30:52.000Z"
+					"cpu_cap": 300
 				},
 				"6295c165-e718-47be-b4d1-af78ee54bbb9": {
 					"uuid": "6295c165-e718-47be-b4d1-af78ee54bbb9",
@@ -219,8 +215,7 @@
 					"zone_state": "running",
 					"state": "running",
 					"brand": "joyent-minimal",
-					"cpu_cap": 400,
-					"last_modified": "2013-08-20T00:16:45.000Z"
+					"cpu_cap": 400
 				},
 				"edaaee38-6e2a-4f0c-b7af-655959b60c36": {
 					"uuid": "edaaee38-6e2a-4f0c-b7af-655959b60c36",
@@ -230,8 +225,7 @@
 					"zone_state": "installed",
 					"state": "failed",
 					"brand": "joyent",
-					"cpu_cap": 100,
-					"last_modified": "2013-07-08T12:07:31.000Z"
+					"cpu_cap": 100
 				}
 			}
 		},
@@ -404,8 +398,6 @@
 					"owner_uuid": "9c294396-cddf-44b7-924b-baaddbec4be6",
 					"max_physical_memory": 512,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-22T21:25:05.000Z",
-					"create_timestamp": "2013-05-22T21:25:05.000Z",
 					"quota": 10
 				},
 				"6f0a4b97-3642-48ba-bae1-b1215f4ad972": {
@@ -416,8 +408,6 @@
 					"owner_uuid": "d97bb63b-b7cb-4711-acc3-d9437619e71c",
 					"max_physical_memory": 1024,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-22T21:25:05.000Z",
-					"create_timestamp": "2013-05-22T21:25:05.000Z",
 					"quota": 15
 				},
 				"834bd053-ddb4-4d68-8bcd-5db976501cb6": {
@@ -428,8 +418,6 @@
 					"owner_uuid": "390c229a-8c77-445f-b227-88e41c2bb3cf",
 					"max_physical_memory": 1024,
 					"cpu_cap": 350,
-					"last_modified": "2013-06-21T12:46:34.000Z",
-					"create_timestamp": "2013-06-21T12:46:34.000Z",
 					"quota": 15
 				},
 				"29d4f6b3-ccf1-481f-a0fa-5f04b0d4b853": {
@@ -440,8 +428,6 @@
 					"owner_uuid": "390c229a-8c77-445f-b227-88e41c2bb3cf",
 					"max_physical_memory": 1024,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-22T21:25:05.000Z",
-					"create_timestamp": "2013-05-22T21:25:05.000Z",
 					"quota": 15
 				},
 				"1ac5a633-c0ab-4bd3-9642-92f84470406f": {
@@ -452,8 +438,6 @@
 					"owner_uuid": "390c229a-8c77-445f-b227-88e41c2bb3cf",
 					"max_physical_memory": 512,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-22T21:25:06.000Z",
-					"create_timestamp": "2013-05-22T21:25:06.000Z",
 					"quota": 10
 				},
 				"ae9f609c-25b6-47fb-b429-e7e341a7875f": {
@@ -464,8 +448,6 @@
 					"owner_uuid": "390c229a-8c77-445f-b227-88e41c2bb3cf",
 					"max_physical_memory": 512,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-22T21:25:06.000Z",
-					"create_timestamp": "2013-05-22T21:25:06.000Z",
 					"quota": 10
 				},
 				"a90b17b8-527f-4b57-bef9-c429c2d90049": {
@@ -476,8 +458,6 @@
 					"owner_uuid": "5c3a2297-e01b-4faf-9495-8d8c3314e08c",
 					"max_physical_memory": 64,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-14T18:23:07.000Z",
-					"create_timestamp": "2013-05-14T18:23:07.000Z",
 					"quota": 1024
 				},
 				"6b525cdd-8d0d-454a-9b0a-39cd654300cd": {
@@ -488,8 +468,6 @@
 					"cpu_cap": 700,
 					"owner_uuid": "f723a444-e17e-4c6f-a1f9-233ea4ccb48b",
 					"max_physical_memory": 1024,
-					"last_modified": "2013-05-14T18:23:08.000Z",
-					"create_timestamp": "2013-05-14T18:23:08.000Z",
 					"quota": 1024
 				},
 				"02dd4dd4-6393-457b-a859-359da549549c": {
@@ -500,8 +478,6 @@
 					"owner_uuid": "13ed069e-d25e-47c9-a91f-0c202e25e945",
 					"max_physical_memory": 64,
 					"cpu_cap": 350,
-					"last_modified": "2013-05-14T18:23:08.000Z",
-					"create_timestamp": "2013-05-14T18:23:08.000Z",
 					"quota": 1024
 				}
 			}
diff --git a/test/validations.test.js b/test/validations.test.js
index 41dc9bb..16ac95b 100644
--- a/test/validations.test.js
+++ b/test/validations.test.js
@@ -89,8 +89,7 @@ var SERVER = {
 			zone_state: 'running',
 			state: 'running',
 			brand: 'joyent',
-			cpu_cap: 800,
-			last_modified: '2014-05-15T17:33:29.000Z'
+			cpu_cap: 800
 		}
 	},
 	transitional_status: '',
-- 
2.21.0

