commit 2befff81df3b7be1b0b53127a63f69ba7bfe6ba6 (refs/changes/54/1054/1)
Author: Cody Peter Mello <cody.mello@joyent.com>
Date:   2016-12-03T00:34:25+00:00 (2 years, 10 months ago)
    
    MORAY-363 Validate index names

diff --git a/test/buckets.test.js b/test/buckets.test.js
index 6462d72..136912d 100644
--- a/test/buckets.test.js
+++ b/test/buckets.test.js
@@ -379,6 +379,100 @@ test('create bucket bad index type', function (t) {
     });
 });
 
+test('bad index names', function (t) {
+    var names = [
+        // Reserved names
+        '_etag', '_id', '_key', '_mtime', '_rver', '_txn_snap',
+        '_value', '_vnode',
+
+        // Reserved names, different case
+        '_ETag', '_ID', '_Key', '_MTime', '_Value', '_VNODE',
+
+        // Disallowed characters
+        'a!b', 'b@c', '&', '*', 'a+b', '~name', 'a-b',
+
+        // Empty string
+        '',
+
+        // Numbers at the beginning
+        '1', '2nd', '5column',
+
+        // Ending with a hyphen
+        '_', 'foo_', 'a2_',
+
+        // Begins with "moray"
+        '_moray', '__moray', '___Moray', '_moray_column', 'moray',
+        'MORAY', 'morayC', 'moray_index', 'MoraY_foo', 'moray_bar'
+    ];
+
+    function isInvalidBucketErr(err) {
+        return err && VError.hasCauseWithName(err, 'InvalidBucketConfigError');
+    }
+
+    vasync.forEachPipeline({
+        inputs: names,
+        func: function checkIndexName(name, cb) {
+            var schema = { index: { } };
+            schema.index[name] = { type: 'string' };
+
+            c.createBucket(b, schema, function (err) {
+                t.ok(isInvalidBucketErr(err),
+                    JSON.stringify(name) + ' should be rejected');
+                cb();
+            });
+        }
+    }, function () {
+        t.end();
+    });
+});
+
+test('good index names', function (t) {
+    var names = [
+        // Contains an underscore
+        '_v', '_foo', '__bar', 'belongs_to_uuid', 'zfs_io_priority',
+
+        // Mixed case
+        'wantInputRemoved', 'wantRetry', 'timeDone',
+
+        // All upper-case
+        'ZFS', 'AVAILABLE_MB',
+
+        // Numbers at the end
+        'foo1', 'number10', '_v2',
+
+        // Index names from Triton and Manta
+        '_default', '_owner', '_replicated', 'result', 'status', 'target',
+        'timestamp', 'transient', 'updated_at', 'urn', 'v', 'valid',
+        'version', 'worker',
+
+        // Single letter
+        'a', 'b', 'v', 'A', 'Z', 'V'
+    ];
+
+    t.test('create bucket', function (t2) {
+        c.createBucket(b, {}, function (err) {
+            t2.ifError(err);
+            t2.end();
+        });
+    });
+
+
+    t.test('update bucket w/ different index names', function (t2) {
+        vasync.forEachPipeline({
+            inputs: names,
+            func: function checkIndexName(name, cb) {
+                var schema = { index: {} };
+                schema.index[name] = { type: 'string' };
+                c.updateBucket(b, schema, function (err) {
+                    t2.ifError(err, JSON.stringify(name) + ' should be okay');
+                    cb();
+                });
+            }
+        }, function () {
+            t2.end();
+        });
+    });
+});
 
 test('create bucket triggers not function', function (t) {
     c.createBucket(b, {pre: ['foo']}, function (err) {
