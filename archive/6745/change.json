{"project":"joyent/sdc-vmapi","branch":"master","id":"Ie24437e042447f25ed2f20574a003957fd737d92","number":"6745","subject":"TRITON-1858 move instance migration quota handling to the begin/switch phases Reviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e Approved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e","owner":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"url":"https://cr.joyent.us/6745","commitMessage":"TRITON-1858 move instance migration quota handling to the begin/switch phases\nReviewed by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\nApproved by: Pedro Palazón Candel \u003cpedro@joyent.com\u003e\n","createdOn":1564779389,"lastUpdated":1565634487,"open":false,"status":"MERGED","comments":[{"timestamp":1564779389,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 1."},{"timestamp":1564779391,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 9fc2152b14fa80523967241da2678cc27b3b0b92\n    \n    TRITON-1858 move instance migration quota handling to the begin/switch phases"},{"timestamp":1564779434,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1564779592,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 1:\n\nFYI, tested this in nightly-1, where all vmapi migration tests now pass."},{"timestamp":1565620670,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1"},{"timestamp":1565630101,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 2: Commit message was updated."},{"timestamp":1565634435,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1565634441,"reviewer":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 66cb644d9e68faf0ad07a1bc7edbc83b8f6c4448\n    \n    TRITON-1858 move instance migration quota handling to the begin/switch phases"},{"timestamp":1565634450,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Todd Whiteman"},{"timestamp":1565634487,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" exited with status 2\n\n /tmp/repo/lib/restify-plugins/curl-user-agent.js\n /tmp/repo/lib/validation/sort.js\n /tmp/repo/lib/common/util.js\n /tmp/repo/lib/common/validation.js\n /tmp/repo/lib/common/marker.js\n /tmp/repo/lib/common/predicate.js\n /tmp/repo/lib/common/index.js\n /tmp/repo/lib/common/vm-common.js\n /tmp/repo/lib/common/ldap-filter.js\n /tmp/repo/lib/data-migrations/noop-controller.js\n /tmp/repo/lib/data-migrations/migrations/vms/001-internal-metadata-search.js\n /tmp/repo/lib/data-migrations/controller.js\n /tmp/repo/lib/data-migrations/loader.js\n /tmp/repo/lib/moray/moray-init.js\n /tmp/repo/lib/moray/moray-buckets-initializer.js\n /tmp/repo/lib/moray/moray-buckets-config.js\n /tmp/repo/test/vms.update-moray-bucket-non-transient-error.test.js\n /tmp/repo/test/vms.update-moray-bucket-versioning.test.js\n /tmp/repo/test/vms.validate.test.js\n /tmp/repo/test/vms.marker.test.js\n /tmp/repo/test/vms.reindex-moray-bucket-transient-error.test.js\n /tmp/repo/test/vms.migrate.test.js\n /tmp/repo/test/vms.list-sort.test.js\n /tmp/repo/test/lib/uuid.js\n /tmp/repo/test/lib/migration.js\n /tmp/repo/test/lib/vm.js\n /tmp/repo/test/lib/moray.js\n /tmp/repo/test/common.js\n /tmp/repo/test/vms.curl-head-requests.test.js\n /tmp/repo/test/vms.delete_non_existing_no_workflow.test.js\n /tmp/repo/test/vms.list-filter-internal-metadata.test.js\n /tmp/repo/test/vms.list.test.js\n /tmp/repo/test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js\n /tmp/repo/test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js\n /tmp/repo/test/fixtures/vmapi-server-with-throwing-handler.js\n /tmp/repo/test/vms.update-moray-bucket-transient-error.test.js\n /tmp/repo/test/vms.exits-on-uncaught.test.js\n /tmp/repo/test/vms.changefeed.test.js\n /tmp/repo/test/vms.disks.test.js\n /tmp/repo/test/vms.data-migrations.test.js\n /tmp/repo/test/vms.volumes.test.js\n /tmp/repo/test/vms.full.test.js\n /tmp/repo/test/vms.update-moray-bucket-removes-index-fails.test.js\n deps/jsstyle/jsstyle -o indent\u003d4,doxygen,unparenthesized-return\u003d0,leading-right-paren-ok\u003d1 server.js tools/perf/profile.js tools/perf/random-load.js tools/add-test-vms.js tools/kvm-backfill.js tools/migrations/add-docker-index.js tools/fix-no-owner.js lib/errors.js lib/apis/moray.js lib/apis/imgapi.js lib/apis/papi.js lib/apis/wfapi.js lib/apis/cnapi.js lib/endpoints/role-tags.js lib/endpoints/jobs.js lib/endpoints/ping.js lib/endpoints/vms.js lib/endpoints/metadata.js lib/endpoints/statuses.js lib/workflows/migrate-abort.js lib/workflows/update.js lib/workflows/job-common.js lib/workflows/start.js lib/workflows/add-nics.js lib/workflows/kill.js lib/workflows/rollback.js lib/workflows/provision.js lib/workflows/stop.js lib/workflows/remove-nics.js lib/workflows/fabric-common.js lib/workflows/migrate-rollback.js lib/workflows/destroy.js lib/workflows/delete-snapshot.js lib/workflows/update-nics.js lib/workflows/migrate-begin.js lib/workflows/migrate-pause.js lib/workflows/snapshot.js lib/workflows/reprovision.js lib/workflows/migrate-sync.js lib/workflows/vm-migration/common.js lib/workflows/vm-migration/abort.js lib/workflows/vm-migration/sync.js lib/workflows/vm-migration/cleanup_source.js lib/workflows/vm-migration/switch.js lib/workflows/vm-migration/begin.js lib/workflows/vm-migration/pause.js lib/workflows/vm-migration/rollback.js lib/workflows/vm-migration/cleanup_target.js lib/workflows/migrate-switch.js lib/workflows/reboot.js lib/workflows/nfs-volumes/index.js lib/interceptors.js lib/changefeed.js lib/vm-migration/migrate.js lib/config-loader.js lib/vmapi.js lib/restify-plugins/curl-user-agent.js lib/validation/sort.js lib/common/util.js lib/common/validation.js lib/common/marker.js lib/common/predicate.js lib/common/index.js lib/common/vm-common.js lib/common/ldap-filter.js lib/data-migrations/noop-controller.js lib/data-migrations/migrations/vms/001-internal-metadata-search.js lib/data-migrations/controller.js lib/data-migrations/loader.js lib/moray/moray-init.js lib/moray/moray-buckets-initializer.js lib/moray/moray-buckets-config.js test/vms.update-moray-bucket-non-transient-error.test.js test/vms.update-moray-bucket-versioning.test.js test/vms.validate.test.js test/vms.marker.test.js test/vms.reindex-moray-bucket-transient-error.test.js test/vms.migrate.test.js test/vms.list-sort.test.js test/lib/uuid.js test/lib/migration.js test/lib/vm.js test/lib/moray.js test/common.js test/vms.curl-head-requests.test.js test/vms.delete_non_existing_no_workflow.test.js test/vms.list-filter-internal-metadata.test.js test/vms.list.test.js test/fixtures/data-migrations-valid/vms/001-foo-to-bar.js test/fixtures/data-migrations-invalid-filenames/vms/invalid-file-name.js test/fixtures/vmapi-server-with-throwing-handler.js test/vms.update-moray-bucket-transient-error.test.js test/vms.exits-on-uncaught.test.js test/vms.changefeed.test.js test/vms.disks.test.js test/vms.data-migrations.test.js test/vms.volumes.test.js test/vms.full.test.js test/vms.update-moray-bucket-removes-index-fails.test.js\n deps/eng/tools/check-copyright -q\n error: lib/workflows/migrate-begin.js: copyright not in RFD 164 form, \u0027 * Copyright (c) 2019, Joyent, Inc.\u0027 does not match /Copyright [0-9]{4} Joyent, Inc\\.$/\n error: lib/workflows/migrate-sync.js: copyright not in RFD 164 form, \u0027 * Copyright (c) 2019, Joyent, Inc.\u0027 does not match /Copyright [0-9]{4} Joyent, Inc\\.$/\n error: test/lib/migration.js: copyright not in RFD 164 form, \u0027 * Copyright (c) 2019, Joyent, Inc.\u0027 does not match /Copyright [0-9]{4} Joyent, Inc\\.$/\n gmake: *** [deps/eng/tools/mk/Makefile.targ:292: check-copyright] Error 1"}],"currentPatchSet":{"number":"3","revision":"e24437e042447f25ed2f20574a003957fd737d92","parents":["91de5b6e62a40e989e2491f35a53725c543817c4"],"ref":"refs/changes/45/6745/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1565634435,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564779434,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1565634450,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/workflows/migrate-begin.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/workflows/migrate-sync.js","type":"MODIFIED","insertions":0,"deletions":-10},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":15,"sizeDeletions":-17},"patchSets":[{"number":"1","revision":"60f45a87158233718ae328229c3ee349226347af","parents":["8887095d7413f4b9941f27093cefea2625d67b35"],"ref":"refs/changes/45/6745/1","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1564779389,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564779434,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/workflows/migrate-begin.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/workflows/migrate-sync.js","type":"MODIFIED","insertions":0,"deletions":-10},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":15,"sizeDeletions":-17},{"number":"2","revision":"d4f5093cf2123c08af0035a59b458b0aaf4f6fd6","parents":["8887095d7413f4b9941f27093cefea2625d67b35"],"ref":"refs/changes/45/6745/2","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1565630101,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564779434,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/workflows/migrate-begin.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/workflows/migrate-sync.js","type":"MODIFIED","insertions":0,"deletions":-10},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":15,"sizeDeletions":-17},{"number":"3","revision":"e24437e042447f25ed2f20574a003957fd737d92","parents":["91de5b6e62a40e989e2491f35a53725c543817c4"],"ref":"refs/changes/45/6745/3","uploader":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"createdOn":1565634435,"author":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1564779434,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1565620670,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"SUBM","value":"1","grantedOn":1565634450,"by":{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/workflows/migrate-begin.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/workflows/migrate-sync.js","type":"MODIFIED","insertions":0,"deletions":-10},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/lib/migration.js","type":"MODIFIED","insertions":10,"deletions":-6}],"sizeInsertions":15,"sizeDeletions":-17}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Todd Whiteman","email":"todd.whiteman@joyent.com","username":"twhiteman"}]}