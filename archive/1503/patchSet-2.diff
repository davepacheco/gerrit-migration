From 1f2fddc6a8c90e509524acc51e933189f3a1ff22 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Tue, 14 Feb 2017 16:52:07 +0000
Subject: [PATCH] OS-5946 Avoid modifying the object string table when patching
 USDT probes

---
 usr/src/lib/libdtrace/common/dt_link.c | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/usr/src/lib/libdtrace/common/dt_link.c b/usr/src/lib/libdtrace/common/dt_link.c
index e910ac3ff1..55d2fbd3bc 100644
--- a/usr/src/lib/libdtrace/common/dt_link.c
+++ b/usr/src/lib/libdtrace/common/dt_link.c
@@ -22,10 +22,9 @@
 /*
  * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.
  * Use is subject to license terms.
+ * Copyright 2016 Mark Johnston.
  */
 
-#pragma ident	"%Z%%M%	%I%	%E% SMI"
-
 #define	ELF_TARGET_ALL
 #include <elf.h>
 
@@ -1013,6 +1012,7 @@ process_obj(dtrace_hdl_t *dtp, const char *obj, int *eprobesp)
 	static const char dt_enabled[] = "enabled";
 	static const char dt_symprefix[] = "$dtrace";
 	static const char dt_symfmt[] = "%s%d.%s";
+	char probename[DTRACE_NAMELEN];
 	int fd, i, ndx, eprobe, mod = 0;
 	Elf *elf = NULL;
 	GElf_Ehdr ehdr;
@@ -1355,8 +1355,6 @@ process_obj(dtrace_hdl_t *dtp, const char *obj, int *eprobesp)
 			bcopy(s, pname, p - s);
 			pname[p - s] = '\0';
 
-			p = strhyphenate(p + 3); /* strlen("___") */
-
 			if (dt_symtab_lookup(data_sym, isym, rela.r_offset,
 			    shdr_rel.sh_info, &fsym) != 0)
 				goto err;
@@ -1406,9 +1404,17 @@ process_obj(dtrace_hdl_t *dtp, const char *obj, int *eprobesp)
 				    "no such provider %s", pname));
 			}
 
-			if ((prp = dt_probe_lookup(pvp, p)) == NULL) {
+			/* strlen("___") */
+			if (strlcpy(probename, p + 3, sizeof (probename)) >=
+			    sizeof (probename))
+				return (dt_link_error(dtp, elf, fd, bufs,
+				    "invalid probe name %s", probename));
+
+			(void) strhyphenate(probename);
+
+			if ((prp = dt_probe_lookup(pvp, probename)) == NULL) {
 				return (dt_link_error(dtp, elf, fd, bufs,
-				    "no such probe %s", p));
+				    "no such probe %s", probename));
 			}
 
 			assert(fsym.st_value <= rela.r_offset);
-- 
2.21.0

