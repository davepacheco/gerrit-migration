From 1fefd8bc77d20f178009a32977a2d3e325557c40 Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Mon, 5 Mar 2018 10:28:15 -0800
Subject: [PATCH] MANTA-3594 mahi crashed when processing 'admin' group
 membership after MANTA-3508

---
 v1/lib/auth_cache.js | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/v1/lib/auth_cache.js b/v1/lib/auth_cache.js
index 7231340..cbca8e3 100644
--- a/v1/lib/auth_cache.js
+++ b/v1/lib/auth_cache.js
@@ -735,6 +735,15 @@ function removeGroupMember(self, userdn, groupdn, cb) {
                 user: payload
             }, 'got user entry');
             payload = JSON.parse(payload);
+            if (payload.groups === undefined) {
+                // don't bother with client.set() we didn't do anything
+                log.info({
+                    key: key,
+                    entry: payload
+                }, 'user has no groups');
+                cb(err);
+                return;
+            }
             delete payload.groups[group];
             payload = JSON.stringify(payload);
             log.info({
-- 
2.21.0

