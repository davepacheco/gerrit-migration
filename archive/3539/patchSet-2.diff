From 549ffe79f2b3d417184af3d97e32eadf9547a49d Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Mon, 5 Mar 2018 10:28:15 -0800
Subject: [PATCH] MANTA-3594 mahi crashed when processing 'admin' group
 membership after MANTA-3508

---
 package.json         | 2 +-
 v1/lib/auth_cache.js | 9 +++++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/package.json b/package.json
index 8356b9b..5e5540f 100644
--- a/package.json
+++ b/package.json
@@ -31,7 +31,7 @@
     },
     "devDependencies": {
         "fakeredis": "0.1.3",
-        "nodeunit": "0.8.3",
+        "nodeunit": "0.9.1",
         "nodeunit-plus": "0.0.1"
     },
     "sdcDependencies": {
diff --git a/v1/lib/auth_cache.js b/v1/lib/auth_cache.js
index 7231340..cbca8e3 100644
--- a/v1/lib/auth_cache.js
+++ b/v1/lib/auth_cache.js
@@ -735,6 +735,15 @@ function removeGroupMember(self, userdn, groupdn, cb) {
                 user: payload
             }, 'got user entry');
             payload = JSON.parse(payload);
+            if (payload.groups === undefined) {
+                // don't bother with client.set() we didn't do anything
+                log.info({
+                    key: key,
+                    entry: payload
+                }, 'user has no groups');
+                cb(err);
+                return;
+            }
             delete payload.groups[group];
             payload = JSON.stringify(payload);
             log.info({
-- 
2.21.0

