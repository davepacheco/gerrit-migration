From 77159d0412b3f854e193baef284c42a414608294 Mon Sep 17 00:00:00 2001
From: Jordan Hendricks <jordan.hendricks@joyent.com>
Date: Tue, 20 Mar 2018 00:39:41 +0000
Subject: [PATCH] MANTA-3410 Audit job reports missing MPU parts MANTA-3608
 update mola node-verror dependency

---
 lib/auditor.js | 29 +++++++++++++++++++++++++----
 package.json   |  3 ++-
 2 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/lib/auditor.js b/lib/auditor.js
index 7b592f9..5e04106 100644
--- a/lib/auditor.js
+++ b/lib/auditor.js
@@ -5,14 +5,28 @@
  */
 
 /*
- * Copyright (c) 2014, Joyent, Inc.
+ * Copyright (c) 2018, Joyent, Inc.
  */
 
-var util = require('util');
-var events = require('events');
+var assert = require('assert-plus');
 var carrier = require('carrier');
+var events = require('events');
+var util = require('util');
+
+
+///--- Globals
+
+var UPLOADS_REGEX = /^\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}\/uploads\//;
 
 
+///--- Helpers
+
+function isMultipartUploadPart(key) {
+    assert.string(key, 'key');
+
+    return (key.match(UPLOADS_REGEX));
+}
+
 
 ///--- API
 
@@ -62,7 +76,14 @@ function Auditor(opts, listener) {
                 } else {
                         if ((currMako.objectId !== objectId) ||
                             (currMako.storageNodes.indexOf(storageId) === -1)) {
-                                self.emit('problem', line);
+
+                            var key = parts[3];
+
+                            if (isMultipartUploadPart(key)) {
+                                    return;
+                            }
+
+                            self.emit('problem', line);
                         }
                 }
         });
diff --git a/package.json b/package.json
index 8d477f7..98f2bc2 100644
--- a/package.json
+++ b/package.json
@@ -12,6 +12,7 @@
                 "dashdash": "1.7.0",
                 "forkexec": "^1.1.0",
                 "jsprim": "^1.4.0",
+                "libmanta": "git+https://github.com/joyent/node-libmanta.git#master",
                 "lstream": "0.0.4",
                 "once": "1.3.1",
                 "manta-hk": "git+https://github.com/joyent/manta-hk.git#master",
@@ -23,7 +24,7 @@
                 "posix-getopt": "1.0.0",
                 "sprintf-js": "0.0.7",
                 "vasync": "1.6.1",
-                "verror": "^1.9.0",
+                "verror": "^1.10.0",
                 "vstream": "0.1.0"
         },
         "devDependencies": {
-- 
2.21.0

