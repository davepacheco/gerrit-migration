From 1403a4e3824a0a069be6f8e95bab75e71141fbc2 Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Thu, 25 Aug 2016 16:24:38 -0700
Subject: [PATCH] RELENG-713 the amon test suite creates a 'amontestzone' with
 no cpu_cap

---
 test/prep.js | 20 ++++++++++++++++++--
 1 file changed, 18 insertions(+), 2 deletions(-)

diff --git a/test/prep.js b/test/prep.js
index 5fce639..3d36e0b 100644
--- a/test/prep.js
+++ b/test/prep.js
@@ -57,6 +57,7 @@ var headnodeUuid;
 var amonZoneUuid;
 var smartosImageUuid;
 var externalNetworkUuid;
+var testPackageUuid;
 var gzIp;
 
 
@@ -308,6 +309,20 @@ function getExternalNetworkUuid(next) {
 }
 
 
+function getTestPackageUuid(next) {
+    log('# Get "sample-128M" package UUID (this assumes "sdcadm post-setup dev-sample-data" was run).');
+    exec('sdc-papi /packages | json -H -c \'this.name === "sample-128M"\' 0.uuid',
+             function (err, stdout, stderr) {
+        if (err) {
+            return next(err);
+        }
+        testPackageUuid = stdout.trim();
+        log('# test package UUID is "%s".', testPackageUuid);
+        next();
+    });
+}
+
+
 function createAmontestzone(next) {
     var vmapiClient = new VMAPI({
         url: process.env.VMAPI_URL
@@ -333,9 +348,9 @@ function createAmontestzone(next) {
                 image_uuid: smartosImageUuid,
                 server_uuid: headnodeUuid,
                 brand: 'joyent',
-                ram: '128',
+                billing_id: testPackageUuid,
                 alias: 'amontestzone',
-                networks: externalNetworkUuid
+                networks: externalNetworkUuid,
             },
             function (err2, jobInfo) {
                 if (err2) {
@@ -440,6 +455,7 @@ async.series([
         getHeadnodeUuid,
         getSmartosDatasetUuid,
         getExternalNetworkUuid,
+        getTestPackageUuid,
         createAmontestzone,
         ensureAmontestzoneIsRunning,
         getAmonZoneUuid,
-- 
2.21.0

