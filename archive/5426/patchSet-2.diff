From 7236307304ea42ae43ea8e56f140c5d08dd856af Mon Sep 17 00:00:00 2001
From: Bryan Cantrill <bryan@joyent.com>
Date: Fri, 25 Jan 2019 00:55:49 +0000
Subject: [PATCH] OS-7535 allow platform builds on base-64 image

---
 Makefile.gcc                      |  3 +++
 binutils/Makefile                 |  2 ++
 binutils/patches/sigsetmask.patch | 31 +++++++++++++++++++++++++++++++
 node.js/Makefile                  |  5 +++--
 4 files changed, 39 insertions(+), 2 deletions(-)
 create mode 100644 binutils/patches/sigsetmask.patch

diff --git a/Makefile.gcc b/Makefile.gcc
index 2754d45..b6e11e7 100644
--- a/Makefile.gcc
+++ b/Makefile.gcc
@@ -28,6 +28,9 @@ PREFIX = /usr/gcc/$(GCC_VER)
 AUTOCONF_PREFIX = $(PREFIX)
 
 AUTOCONF_OPTS += \
+	--enable-bootstrap \
+	--build=i386-pc-solaris2.11 \
+	--host=i386-pc-solaris2.11 \
 	--with-ld=/usr/bin/ld \
 	--without-gnu-ld \
 	--with-gnu-as \
diff --git a/binutils/Makefile b/binutils/Makefile
index d956806..cbfe686 100644
--- a/binutils/Makefile
+++ b/binutils/Makefile
@@ -34,6 +34,8 @@ CFLAGS += $(CPPFLAGS)
 TARBALL =		$(VER).tar.bz2
 TARBALL_COMPRESS =	-j
 AUTOCONF_OPTS = \
+	--build=i386-pc-solaris2.11 \
+	--host=i386-pc-solaris2.11 \
 	--prefix=/usr/gnu \
 	--enable-64-bit-bfd \
 	--program-prefix=g
diff --git a/binutils/patches/sigsetmask.patch b/binutils/patches/sigsetmask.patch
new file mode 100644
index 0000000..efcc87d
--- /dev/null
+++ b/binutils/patches/sigsetmask.patch
@@ -0,0 +1,31 @@
+From 2e463c84a3332cb70c14579e9138551c4d78bb7c Mon Sep 17 00:00:00 2001
+From: Bryan Cantrill <bryan@joyent.com>
+Date: Fri, 25 Jan 2019 17:20:31 -0800
+Subject: [PATCH] allow sigsetmask.c to compile under C99
+
+Note: this can be removed (and will no longer apply cleanly) when we
+update to 2.26 or later -- at which point old versions of gcc (e.g., 4.7.3)
+won't compile it unless this patch is regenerated against the post-2.26
+sigsetmask.c
+---
+ libiberty/sigsetmask.c | 3 +++
+ 1 file changed, 3 insertions(+)
+
+diff --git a/libiberty/sigsetmask.c b/libiberty/sigsetmask.c
+index 3b708b16ad..6d899d674a 100644
+--- a/libiberty/sigsetmask.c
++++ b/libiberty/sigsetmask.c
+@@ -15,7 +15,10 @@ be the value @code{1}).
+ 
+ */
+ 
++#if __STDC_VERSION__ - 0 < 199901L
+ #define _POSIX_SOURCE
++#endif
++
+ #include <ansidecl.h>
+ /* Including <sys/types.h> seems to be needed by ISC. */
+ #include <sys/types.h>
+-- 
+2.14.3 (Apple Git-98)
+
diff --git a/node.js/Makefile b/node.js/Makefile
index 0724322..2edc13e 100644
--- a/node.js/Makefile
+++ b/node.js/Makefile
@@ -18,7 +18,7 @@
 #
 # CDDL HEADER END
 #
-# Copyright 2018 Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 MAJOR_VER =	0.10
@@ -33,7 +33,7 @@ VERSIONJS =	$(NODE_ROOT)/node_modules/platform_node_version.js
 # ../deps/v8/src/objects.h:5188:44: error: left operand of shift expression
 # '(-1 << 3)' is negative
 #
-CXXFLAGS +=	-fpermissive
+CXXFLAGS += -fpermissive
 
 #
 # https://github.com/nodejs/node/issues/6272
@@ -81,6 +81,7 @@ AUTOCONF_OPTS += \
 AUTOCONF_CFLAGS =	CFLAGS="$(CPPFLAGS) $(CFLAGS)"
 AUTOCONF_LIBS =
 AUTOCONF_ENV +=		CXXFLAGS="$(CPPFLAGS) $(CFLAGS) $(CXXFLAGS)"
+AUTOCONF_ENV +=		CXXFLAGS.host="$(CPPFLAGS) $(CFLAGS) $(CXXFLAGS)"
 
 #
 # Jump through hoops to get the locally-run build tools to build with the
-- 
2.21.0

