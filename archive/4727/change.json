{"project":"joyent/moray","branch":"master","id":"I531994cc846322bbe3c7d0c057118ea33862a468","number":"4727","subject":"MORAY-420 Moray\u0027s database setup logic in boot/setup.sh is brittle Reviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/4727","commitMessage":"MORAY-420 Moray\u0027s database setup logic in boot/setup.sh is brittle\nReviewed by: Jan Wyszynski \u003cjan.wyszynski@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1534804639,"lastUpdated":1535756877,"open":false,"status":"MERGED","comments":[{"timestamp":1534804639,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1534804666,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/haproxy.xml\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/pg-setup.xml\n /tmp/repo/build/node/bin/node node_modules/.bin/eslint  main.js pg-setup.js lib/index.js lib/schema.js lib/cmd.js lib/types.js lib/buckets/get.js lib/buckets/del.js lib/buckets/index.js lib/buckets/creat.js lib/buckets/update.js lib/buckets/common.js lib/buckets/list.js lib/control.js lib/errors.js lib/dtrace.js lib/objects/index.js lib/objects/reindex.js lib/objects/common.js lib/objects/batch.js lib/objects/update.js lib/objects/del_many.js lib/objects/find.js lib/objects/put.js lib/objects/del.js lib/objects/get.js lib/ping.js lib/pg.js lib/server.js\n \n /tmp/repo/pg-setup.js\n   104:19  error  Unexpected trailing comma  comma-dangle\n \n ✖ 1 problem (1 error, 0 warnings)\n \n tools/mk/Makefile.targ:201: recipe for target \u0027check-eslint\u0027 failed\n gmake: *** [check-eslint] Error 1"},{"timestamp":1534805856,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1534805909,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1534973133,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1534973157,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing-1\n\n\"make check\" exited with status 2\n\n fatal: ref HEAD is not a symbolic ref\n xmllint --noout --path tools/ --dtdvalid tools/service_bundle.dtd.1 smf/manifests/haproxy.xml\n /tmp/repo/build/node/bin/node node_modules/.bin/eslint  main.js pg-setup.js lib/control.js lib/objects/put.js lib/objects/index.js lib/objects/find.js lib/objects/reindex.js lib/objects/get.js lib/objects/del.js lib/objects/batch.js lib/objects/del_many.js lib/objects/update.js lib/objects/common.js lib/errors.js lib/dtrace.js lib/ping.js lib/cmd.js lib/server.js lib/schema.js lib/index.js lib/pg.js lib/buckets/update.js lib/buckets/common.js lib/buckets/creat.js lib/buckets/index.js lib/buckets/list.js lib/buckets/del.js lib/buckets/get.js lib/types.js\n \n /tmp/repo/pg-setup.js\n   219:1  error  Line 219 exceeds the maximum line length of 80  max-len\n \n ✖ 1 problem (1 error, 0 warnings)\n \n tools/mk/Makefile.targ:201: recipe for target \u0027check-eslint\u0027 failed\n gmake: *** [check-eslint] Error 1"},{"timestamp":1534973260,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4."},{"timestamp":1534973308,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535052070,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5."},{"timestamp":1535052126,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535056073,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 6."},{"timestamp":1535056123,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535058894,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 7."},{"timestamp":1535058945,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535077218,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7:\n\n(18 comments)\n\nThis is much cleaner, readable, and less-brittle than the previous moray setup script. Thanks!"},{"timestamp":1535140395,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 8."},{"timestamp":1535140445,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535140536,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 8:\n\n(12 comments)"},{"timestamp":1535381744,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(1 comment)\n\nCould we change the name of the file to be moray-pg-setup.js so that it matches the SMF manifest?"},{"timestamp":1535388291,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 9."},{"timestamp":1535388296,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 8:\n\n(1 comment)"},{"timestamp":1535388512,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535397509,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 9: Code-Review+1\n\nLooks good to me!"},{"timestamp":1535492003,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 9:\n\n(4 comments)"},{"timestamp":1535655471,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 10."},{"timestamp":1535655525,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535655906,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 10:\n\n(4 comments)"},{"timestamp":1535739019,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 11."},{"timestamp":1535739165,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 11:\n\nI\u0027ve updated the SHA for node-manatee to pull in MANATEE-411. Additional testing notes can be found in that ticket."},{"timestamp":1535752480,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 11: Code-Review+1"},{"timestamp":1535752654,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 11: Integration-Approval+1"},{"timestamp":1535752706,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 12: Commit message was updated."},{"timestamp":1535754075,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1535756877,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"}],"currentPatchSet":{"number":"12","revision":"531994cc846322bbe3c7d0c057118ea33862a468","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/12","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535752706,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535752480,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535752654,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1535756877,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":15,"deletions":-284},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"pg-setup.js","type":"ADDED","insertions":420,"deletions":0},{"file":"smf/manifests/moray-pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":602,"sizeDeletions":-335},"patchSets":[{"number":"1","revision":"723d7b1b28a6257e057bf3bcbfd2a616fad076e6","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1534804639,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1534804666,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":78,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-47},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":391,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":559,"sizeDeletions":-327},{"number":"2","revision":"4878c3d3a9481e59e94681e6d3ce288103661d4e","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1534805856,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534805909,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":4,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":78,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-47},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":390,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":558,"sizeDeletions":-327},{"number":"3","revision":"c0353bcd494fd45537ce87f16283caf75e4b421b","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1534973133,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1534973157,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":78,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-47},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":392,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":563,"sizeDeletions":-327},{"number":"4","revision":"3864d240cfa1b98145bde5820e8dd66430b5409b","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1534973260,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1534973308,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":78,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":5,"deletions":-47},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":393,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":564,"sizeDeletions":-327},{"number":"5","revision":"cc042eba7cc152faa851b9adf67c04d7aa2fe3fb","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535052070,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535052126,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":393,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":567,"sizeDeletions":-328},{"number":"6","revision":"55cd5c4403e5ee97b4305b84ad2bc39a06d1bec7","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/6","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535056073,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535056123,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":394,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":568,"sizeDeletions":-328},{"number":"7","revision":"0fdbccead93d36d3c924479e65d539d2f915ca9c","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/7","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535058894,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535058945,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"main.js","line":17,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Do we have best practices for organizing requires?"},{"file":"main.js","line":17,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I usually just put them in alphabetical order."},{"file":"package.json","line":21,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"What do you think about keeping up with minor releases here? Is there any reason not to do this with exeunt?"},{"file":"package.json","line":21,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Sure, I\u0027ll make both of these use ^."},{"file":"pg-setup.js","line":35,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"nit/proposition: CREATE_BUCKETS_CFG_SQL?"},{"file":"pg-setup.js","line":35,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"pg-setup.js","line":44,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"nit/proposition: ALTER_BUCKETS_CFG_SQL?"},{"file":"pg-setup.js","line":44,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"pg-setup.js","line":98,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is it worth putting this into a local variable called \u0027cmd\u0027 or something so that we don\u0027t have two string literals in this function?"},{"file":"pg-setup.js","line":98,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think repeating the literal will help when trying to track down where the line gets logged."},{"file":"pg-setup.js","line":110,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is there much benefit to be had from wrapping this in a VError?"},{"file":"pg-setup.js","line":110,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t think so. Between the log message, info.err and info.stderr, I think that there should be enough context."},{"file":"pg-setup.js","line":127,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"In the original boot/setup.sh there is a comment giving a bit more context for the createuser command: https://github.com/joyent/moray/blob/master/boot/setup.sh#L287-L290. Would it be reasonable to preserve that here?"},{"file":"pg-setup.js","line":129,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Same note about local putting this into a local variable. It\u0027s pretty nitty though and if you think it obfuscates things a bit I\u0027m fine not having it."},{"file":"pg-setup.js","line":141,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Wrap in a VError (if worth it -- not really sure how many ways this could fail or if the error is useful)."},{"file":"pg-setup.js","line":149,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"What do you think of putting this explanation (along with others like it) in the log? Something like, \u0027failed to create %s user, assuming created.\u0027\n\nIf I understand correctly, the purpose of this change is to try as hard as possible to setup the database. However, if something actually does fail for a legitimate reason, might it be difficult to deduce what happened. \n\nThe original boot/setup.sh also has an explanation for why it\u0027s difficult to deduce what the problem was: https://github.com/joyent/moray/blob/master/boot/setup.sh#L294-L295. Could we articulate that in the comments here as well?"},{"file":"pg-setup.js","line":149,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done. Let me know if the comment changes need any editing.\n\n\u003e If I understand correctly, the purpose of this change is to try as hard as possible to setup the database.\n\nThat\u0027s part of it. The other important thing is that the setup script now does a lot less, so mdata:execute is less likely to easily fail on first boot and create broken Moray zones that require operator intervention."},{"file":"pg-setup.js","line":244,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"nit: local var?"},{"file":"pg-setup.js","line":258,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is there any information to be gained in logging this error (or wrapping it in a VError)?"},{"file":"pg-setup.js","line":270,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"If I understand correctly, the only table we\u0027re creating in the setup sequence is \u0027buckets_cfg\u0027. Is your aim here to not special case these functions to that table in case we introduce new tables at some point?\nIf so, could we pass the sql in as an argument, and have the argument be named for the table we\u0027re creating? This is sort of related to my previous comment about changing the sql string variable names.\n\nThis is kind of a nit so I\u0027m find without it. It may also sacrifice readability to some extent so I defer to you."},{"file":"pg-setup.js","line":270,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I made this and the ALTER TABLE their own functions so that they have their own steps in the pipeline, and can be tracked in the status object."},{"file":"pg-setup.js","line":274,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Similar note here as for createTable."},{"file":"pg-setup.js","line":361,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Is it true that with the resolver there is no longer a \u0027timeout period\u0027 (formerly 90 seconds - I think) after which pg-setup.js will fail if there is there is no shard primary in zookeeper? \n\nIf that\u0027s true, then you could potentially have many Moray processes waiting for this event. If they all suddenly receive it, I think everything should be fine and the database should get created exactly once because all the actions are idempotent. \n\nIf what I\u0027ve described is all intentional in the design (and I think it is), could we have a comment that sort of summarizes that. Or at least call to attention the fact that we don\u0027t have a timeout anymore."},{"file":"pg-setup.js","line":361,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"pg-setup.js","line":363,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"I suppose there isn\u0027t really much of a point in trying to handle the \u0027removed\u0027 event here? Is it possible for the primary to change while we\u0027re trying to set up the database?"},{"file":"pg-setup.js","line":363,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"The primary could possibly change. If that happened, everything that uses the cueball pool will continue working, but the CLI tools will error out. In that case this script will exit, and SMF will rerun us. If the script fails enough times, then it\u0027ll go into maintenance."},{"file":"smf/manifests/pg-setup.xml.in","line":14,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Will pg-setup appear as a completely separate service in the moray zone now? If so, could we change the name so it reference moray in some way? Maybe \u0027moray-db-setup\u0027 or \u0027moray-pg-setup\u0027."},{"file":"smf/manifests/pg-setup.xml.in","line":14,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Sure, I\u0027ll change it to \"moray-pg-setup\"."},{"file":"smf/manifests/pg-setup.xml.in","line":31,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Mostly a question: how would pg-setup.js run if the config-agent hasn\u0027t run yet? Is there a default config, or is the config-agent guaranteed to have run already for some other reason?"},{"file":"smf/manifests/pg-setup.xml.in","line":31,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"After talking this over with Jan and checking the behaviour of \"optional_all\", this seems to be the setting that we want."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":394,"deletions":0},{"file":"smf/manifests/pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":568,"sizeDeletions":-328},{"number":"8","revision":"93bf5a174f44663160bbfebaa4b5a6dfa12572e6","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/8","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535140395,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535140445,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"smf/manifests/moray-pg-setup.xml.in","line":43,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Does this need net_privaddr? I ran this from one of my Moray zones:\n\n[root@bdc158e9 (moray) ~]$ ndd -get /dev/tcp tcp_extra_priv_ports                                                     \n2049                         \n4045\n\nAnd the SMF man page says that the privileged ports are 1 - 1023. I\u0027m fine with keeping it, mostly just curious about why it\u0027s there."},{"file":"smf/manifests/moray-pg-setup.xml.in","line":43,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"There\u0027s no good reason for this, I just copied it from the Moray SMF manifest I based this on. I\u0027ll go ahead and remove it. (Moray probably also doesn\u0027t need it, but we can leave that for a separate ticket.)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":415,"deletions":0},{"file":"smf/manifests/moray-pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":589,"sizeDeletions":-328},{"number":"9","revision":"bc41d708e704a550b037eb6f539ef356017dfde9","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/9","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535388291,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535388512,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535397509,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"comments":[{"file":"boot/setup.sh","line":156,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"I don\u0027t believe this file is running with \"errexit\" set (and fair enough) so we should check that sed did not fail."},{"file":"boot/setup.sh","line":156,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"boot/setup.sh","line":158,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"We should really quote these, I think."},{"file":"boot/setup.sh","line":158,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"boot/setup.sh","line":160,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Quote this?"},{"file":"boot/setup.sh","line":160,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done. I\u0027ve also added quotes around similar things above and below."},{"file":"pg-setup.js","line":382,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"So I think it\u0027s pretty critical that we get to a place where we don\u0027t need to do this.  There are at least two SMF-level options that might make help:\n\n- set \"timeout_seconds\" to zero in the SMF start method, as per smf_method(5); this means there is no startup timeout\n- set the \"critical_failure_period\" property in the \"startd\" property group to zero; looking at svc.startd(1M), and at the code[1], it seems like this would keep SMF from marking the service in maintenance for restarting too often\n\nOption 1 would be tripped up if this tool ever gets \"stuck\" for some reason (e.g., a lack of TCP keepalives on the PostgreSQL connection).  Option 2 would be less than ideal if this program ends up (at least under some unexpected conditions) to immediately exit every time it is started, as SMF might restart it very quickly (I\u0027m not sure if there\u0027s even short delay between restarts?) and not stop.\n\n\n[1]: https://github.com/joyent/illumos-joyent/blob/master/usr/src/cmd/svc/startd/method.c#L99-L180"},{"file":"pg-setup.js","line":382,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I\u0027ve set \"timeout_seconds\", but left \"critical_failure_period\" as-is. It should be pretty difficult for this service to enter maintenance now that it uses the Manatee client to wait, a simple Postgres SELECT to verify the database is up and running, and using idempotent SQL queries."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":8,"deletions":-278},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":415,"deletions":0},{"file":"smf/manifests/moray-pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":589,"sizeDeletions":-328},{"number":"10","revision":"09a05008c990589f66a4fbd95ca24db4bd638fc2","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/10","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535655471,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535655525,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":15,"deletions":-284},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"pg-setup.js","type":"ADDED","insertions":415,"deletions":0},{"file":"smf/manifests/moray-pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":596,"sizeDeletions":-334},{"number":"11","revision":"884745820872568423a09b76a7d9c43d1705c73f","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/11","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535739019,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535752654,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1535754075,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535752480,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":15,"deletions":-284},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"pg-setup.js","type":"ADDED","insertions":420,"deletions":0},{"file":"smf/manifests/moray-pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":602,"sizeDeletions":-335},{"number":"12","revision":"531994cc846322bbe3c7d0c057118ea33862a468","parents":["c0d928d0730169e841501868bc95500cd711e3e0"],"ref":"refs/changes/27/4727/12","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1535752706,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1535756877,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1535752654,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1535752480,"by":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"boot/setup.sh","type":"MODIFIED","insertions":15,"deletions":-284},{"file":"lib/cmd.js","type":"ADDED","insertions":79,"deletions":0},{"file":"main.js","type":"MODIFIED","insertions":7,"deletions":-48},{"file":"package.json","type":"MODIFIED","insertions":3,"deletions":-2},{"file":"pg-setup.js","type":"ADDED","insertions":420,"deletions":0},{"file":"smf/manifests/moray-pg-setup.xml.in","type":"ADDED","insertions":76,"deletions":0}],"sizeInsertions":602,"sizeDeletions":-335}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}