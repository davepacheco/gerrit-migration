From 560dce1d4d63158e7822fd1aeae56a5fc557fa4c Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Wed, 27 Sep 2017 10:03:34 -0700
Subject: [PATCH] DOCKER-1095 docker pull should distinguish between auth error
 and not found error

---
 lib/backends/sdc/images.js | 23 ++++++++++++++++-------
 package.json               |  4 ++--
 2 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/lib/backends/sdc/images.js b/lib/backends/sdc/images.js
index c78e266..77be77c 100644
--- a/lib/backends/sdc/images.js
+++ b/lib/backends/sdc/images.js
@@ -2555,16 +2555,25 @@ function pullImage(opts, callback) {
             /*
              * --- UnauthorizedError
              * Docker-docker:
-             *  $ docker pull trentm/busybox-i-am-in-you
+             *  $ docker pull joyentunsupported/test-nginx
              *  Using default tag: latest
-             *  Pulling repository docker.io/trentm/busybox-i-am-in-you
-             *  Error: image trentm/busybox-i-am-in-you:latest not found
-             *
-             * --- ResourceNotFoundError
-             * E.g.: `docker pull quay.io/no-such-user`
+             *  Error response from daemon: Get https://registry-1.docker.io
+             *     /v2/joyentunsupported/test-nginx/manifests/latest:
+             *     unauthorized: incorrect username or password
              */
             err.code === 'UnauthorizedError' || /* newer IMGAPI */
-            err.code === 'UNAUTHORIZED' || /* older IMGAPI */
+            err.code === 'UNAUTHORIZED')        /* older IMGAPI */
+        {
+            errmsg = format('unauthorized: %s', err.message);
+        } else if (
+            /*
+             * --- ResourceNotFoundError
+             * Docker-docker:
+             *  $ docker pull unknownreponame/foo
+             *  Using default tag: latest
+             *  Error response from daemon: repository unknownreponame/foo
+             *     not found: does not exist or no pull access
+             */
             err.code === 'ResourceNotFound' || /* newer IMGAPI */
             err.code === 'NotFoundError')      /* older IMGAPI */
         {
diff --git a/package.json b/package.json
index 24471a6..3268d86 100644
--- a/package.json
+++ b/package.json
@@ -1,12 +1,12 @@
 {
   "name": "sdc-docker",
-  "version": "0.4.6",
+  "version": "0.4.7",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
     "assert-plus": "1.0.0",
     "async": "0.9.0",
-    "docker-registry-client": "3.2.8",
+    "docker-registry-client": "3.2.11",
     "bunyan": "1.8.8",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
     "fwrule": "git+https://github.com/joyent/sdc-fwrule.git#d1174be",
-- 
2.21.0

