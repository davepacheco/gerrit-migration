From 3334d45eaba09149ec4e3b6b996772a886caa5fc Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Tue, 27 Feb 2018 14:39:02 -0800
Subject: [PATCH] OS-6561 reboot (or unmount) inside zone while tailing file
 from GZ leaks fem handler(s)

---
 usr/src/uts/common/fs/fem.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/usr/src/uts/common/fs/fem.c b/usr/src/uts/common/fs/fem.c
index 5f524def30..2a80144486 100644
--- a/usr/src/uts/common/fs/fem.c
+++ b/usr/src/uts/common/fs/fem.c
@@ -4035,8 +4035,11 @@ fsem_install(
 	int	error;
 	struct fem_node	nnode;
 
-	/* If this vfs hasn't been properly initialized, fail the install */
-	if (vfsp->vfs_implp == NULL)
+	/*
+	 * If this vfs hasn't been properly initialized or has been unmounted,
+	 * fail the install.
+	 */
+	if (vfsp->vfs_implp == NULL || (vfsp->vfs_flag & VFS_UNMOUNTED))
 		return (EINVAL);
 
 	nnode.fn_available = arg;
-- 
2.21.0

