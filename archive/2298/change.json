{"project":"joyent/eng","branch":"master","id":"I200799a2ea8c634e5758a0b69e5695c6a1c440d7","number":"2298","subject":"TOOLS-1826 eng.git Makefile support for check-eslint Reviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e Approved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/2298","commitMessage":"TOOLS-1826 eng.git Makefile support for check-eslint\nReviewed by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\nApproved by: Cody Peter Mello \u003ccody.mello@joyent.com\u003e\n","createdOn":1501274049,"lastUpdated":1513989043,"open":false,"status":"MERGED","comments":[{"timestamp":1501274049,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1501274050,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit dee14fe3b138c10d0b86fdd499a4262baa3a6f30\n    \n    check-eslint support"},{"timestamp":1501518014,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2."},{"timestamp":1501518015,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 22e710ff8cf9fdf570c6fb9c32444b256c190576\n    \n    Update eng.git docs regarding eslint as a linting option."},{"timestamp":1501518426,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nDave, Cody,\n\nWould you be able to review this at your leisure? I\u0027ve tested using these makefiles with (a) joybot1999.git (a repo that doesn\u0027t use sdcnode) and (b) sdc-imgapi.git (a repo that *does* use sdcnode, see IMGAPI-638).\n\nThe ticket links to https://gist.github.com/trentm/8b1c53aee245fe0cf04aef843ee0eaf4 docs that I\u0027d propose adding to RFD 100 describing how to use eslint as an option."},{"timestamp":1501522147,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1501523637,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1501523832,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1502935055,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1502935724,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\nShould we also add eslint* dependencies to the package.json in this repo?"},{"timestamp":1513988227,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1513988228,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 3382c9b301a59f32a33fd516b82d73da5eba7a9b\n    \n    don\u0027t try to npm install eslint@undefined\n    \n    commit 69836006b473dcb11520b5040a6b2a0e42b07b8e\n    \n    drop dep on json; only run check-eslint if ESLINT_FILES is defined; error if devDepencies aren\u0027t there for eslint"},{"timestamp":1513988369,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)\n\nI think I\u0027ve answered all the Qs.\n\nI\u0027ve tested this against sdc-imgapi.git, covering these cases:\n- no changes (i.e. not using eslint at all)\n- not having eslint and eslint-plugin-joyent in package.json devDependencies\n- not re-running \u0027npm install eslint ...\u0027 every time \u0027make check\u0027 is run (this is why the `touch $(ESLINT_EXEC)`)\n- not defining ESLINT_FILES in my Makefile\n- existing node_modules and no exsiting node_modules"},{"timestamp":1513988572,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1513988942,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1513989038,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1513989043,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"4","revision":"200799a2ea8c634e5758a0b69e5695c6a1c440d7","parents":["a3caa0cb0f936d561acd08f6ca4cd19ab2a0f982"],"ref":"refs/changes/98/2298/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513989038,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513988942,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513988942,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1513989043,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/mk/Makefile.deps","type":"MODIFIED","insertions":34,"deletions":-1},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":58,"sizeDeletions":-11},"patchSets":[{"number":"1","revision":"85aecceb1e6f651a05bd170f97bcfea09c8548a9","parents":["a3caa0cb0f936d561acd08f6ca4cd19ab2a0f982"],"ref":"refs/changes/98/2298/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1501274049,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/mk/Makefile.deps","type":"MODIFIED","insertions":29,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":41,"sizeDeletions":-1},{"number":"2","revision":"10b4133b63ba4bc774445e52c293e861614634bc","parents":["a3caa0cb0f936d561acd08f6ca4cd19ab2a0f982"],"ref":"refs/changes/98/2298/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1501518014,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","comments":[{"file":"tools/mk/Makefile.deps","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Why \":\u003d\" instead of \"?\u003d\"?  It can be useful to override stuff like ESLINT."},{"file":"tools/mk/Makefile.deps","line":52,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Shouldn\u0027t it be possible to always use:\n\n    $(NODE) $(ESLINT_EXEC)\n\nIf NODE needs the PATH set to work, isn\u0027t that supposed to be part of $(NODE)?  If not, I think it should be.  There\u0027s a lot encoded here -- stuff in which there have been bug fixes as recently as this month.\n\nAnyway, it seems like this Makefile shouldn\u0027t have to know anything about NODE_INSTALL."},{"file":"tools/mk/Makefile.deps","line":64,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Similarly, I think we should be able to use $(NPM) here, regardless of where it came from."},{"file":"tools/mk/Makefile.deps","line":65,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think that this and below should be $(ESLINT_EXEC). $(ESLINT) would include the PATH and $(NODE) when NODE_INSTALL is present."},{"file":"tools/mk/Makefile.deps","line":67,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"I think that `npm install foo` inside a directory with a package.json installs a version of \"foo\" compatible with that package.json.  If that\u0027s true, could we use that and not need to worry about pulling this out of package.json?\n\nIs there a way to make this fail if \"eslint\" or \"eslint-plugin-joyent\" isn\u0027t in the package dependencies?\n\nCan/should this be modified to use jclulow\u0027s newly added build stamp targets?"},{"file":"tools/mk/Makefile.deps","line":67,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Even if we don\u0027t use the stamp stuff, these targets should probably at least depend on \"package.json\", right?"},{"file":"tools/mk/Makefile.deps","line":67,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I don\u0027t think the stamp stuff is needed here, since this is intentionally trying to install just a subset of the packages. (Installing all of the packages has an adverse affect on the duration of the `make check\u0027 bot and the `make check\u0027 Jenkins job, and also seems to increase the likelihood of hitting weird npm bugs, as seen in FWAPI-279.)\n\nWe could probably make this fail if eslint or eslint-plugin-joyent aren\u0027t present by doing something like:\n\n    ESLINT_VER\u003d$$(json -f package.json devDependencies.eslint) \u0026\u0026 \\\n    ESLINT_JOY_VER\u003d$$(json -f package.json devDependencies.eslint-plugin-joyent) \u0026\u0026 \\\n    [[ -n $$ESLINT_VER \u0026\u0026 -n $$ESLINT_JOY_VER ]] \u0026\u0026 \\\n    npm install eslint@$$ESLINT_VER eslint-plugin-joyent@$$ESLINT_JOY_VER"},{"file":"tools/mk/Makefile.deps","line":67,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m going to use Cody\u0027s block with a couple changes:\n\n1. use `node -e ...` instead of `json` to not at a dep on `json` being installed\n2. finish with a `touch $(ESLINT_EXEC)` because `npm install` installs `node_modules/eslint/bin/eslint` with the possibly/likely older mtime in the tarball package -- which is possibly older than your \"package.json\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/mk/Makefile.deps","type":"MODIFIED","insertions":29,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-10},{"number":"3","revision":"ffc79320ae18ea934c7e4987c285c610a5cd66c0","parents":["a3caa0cb0f936d561acd08f6ca4cd19ab2a0f982"],"ref":"refs/changes/98/2298/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513988227,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513988942,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513988942,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"comments":[{"file":"tools/mk/Makefile.deps","line":70,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027ve used Cody\u0027s code with a couple changes:\n\n1. use `node -e ...` instead of `json` to not at a dep on `json` being installed\n2. finish with a `touch $(ESLINT_EXEC)` because `npm install` installs `node_modules/eslint/bin/eslint` with the possibly/likely older mtime in the tarball package -- which is possibly older than your \"package.json\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/mk/Makefile.deps","type":"MODIFIED","insertions":34,"deletions":-1},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":58,"sizeDeletions":-11},{"number":"4","revision":"200799a2ea8c634e5758a0b69e5695c6a1c440d7","parents":["a3caa0cb0f936d561acd08f6ca4cd19ab2a0f982"],"ref":"refs/changes/98/2298/4","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1513989038,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513988942,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513988942,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1513989043,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":12,"deletions":-9},{"file":"tools/mk/Makefile.deps","type":"MODIFIED","insertions":34,"deletions":-1},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":12,"deletions":-1}],"sizeInsertions":58,"sizeDeletions":-11}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}