{"project":"joyent/sdc-agents-installer","branch":"master","topic":"lullaby-phase2","id":"I54beab583e9713cf16f9e8c8a3e70fa616a988c6","number":"5518","subject":"TRITON-1142 convert sdc-agents-installer to engbld framework Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/5518","commitMessage":"TRITON-1142 convert sdc-agents-installer to engbld framework\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1549625017,"lastUpdated":1551177181,"open":false,"status":"MERGED","comments":[{"timestamp":1549625017,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1549625025,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 3b236bdaaaf025fa1d7e5435781e4db2cc3b3975\n    \n    TRITON-1142 convert sdc-agents-installer to engbld framework"},{"timestamp":1549625135,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1549626772,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Topic set to lullaby-phase2"},{"timestamp":1550761937,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1550761944,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 46960f03492d056598aa60f55618d078ca67acb1\n    \n    TRITON-1142 convert sdc-agents-installer to engbld framework"},{"timestamp":1550761974,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1550967478,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2: Code-Review+1\n\n(7 comments)\n\nSome Qs below before I IA this.  I built and installed in nightly-1 and things seem to be fine."},{"timestamp":1550967868,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1551030991,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1551030995,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1551030998,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1551031071,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit d6489b13535b329f6cee589c7bc0db6d7323d002\n    \n    TRITON-1142 convert sdc-agents-installer to engbld framework"},{"timestamp":1551032297,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1551032355,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1"},{"timestamp":1551177046,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1551177181,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"4","revision":"54beab583e9713cf16f9e8c8a3e70fa616a988c6","parents":["30addf374995aef4732c409e3bd3275238a01f1b"],"ref":"refs/changes/18/5518/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1551177046,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1551030995,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551032355,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551032355,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1551177181,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":".gitmodules","type":"ADDED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-8},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":40,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"b473e52763d5e22af6ada6e28eb0e2a782038d79","parents":["30addf374995aef4732c409e3bd3275238a01f1b"],"ref":"refs/changes/18/5518/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1549625017,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1549625135,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":".gitmodules","type":"ADDED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":24,"deletions":-8},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":40,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":70,"sizeDeletions":-13},{"number":"2","revision":"90640a499feb5bfd78a4ad2bab9f9b91315d72be","parents":["30addf374995aef4732c409e3bd3275238a01f1b"],"ref":"refs/changes/18/5518/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1550761937,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1550761974,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1550967478,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"Makefile","line":41,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this eng Makefile needed?"},{"file":"Makefile","line":41,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Och, thanks - no need for this."},{"file":"mk-agents-shar","line":109,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"At this point \u0027DEFAULT_SOURCE_DIR\u0027 was *set* to a given \u0027ENGBLD_DEST_OUT_PATH\u0027 above."},{"file":"mk-agents-shar","line":109,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Thanks, I\u0027ll reword to referencing MANTA_BASE"},{"file":"mk-agents-shar","line":132,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Do we need to disable errexit for this whole block? Is this to avoid non-zero exit from the `grep` calls in the else-block?  I suppose there *is* the \"success\u003d1\" guard here to catch most surprises."},{"file":"mk-agents-shar","line":132,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Right, we\u0027ve got potential for non-zero grep in a bunch of places, and that\u0027s now more likely as we test our way through the different possibly layouts. When MG goes away, we should probably simplify this, but for now, compatibility is the aim."},{"file":"mk-agents-shar","line":139,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"The git sha isn\u0027t included here in this dir layout."},{"file":"mk-agents-shar","line":139,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh... actually with the new engbld changes it now *is*. I gather that is fine. I don\u0027t recall if we had discussed this before."},{"file":"mk-agents-shar","line":139,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Hm, I\u0027m not sure we did. It seems unlikely we\u0027d ever have a clash where the addition of the sha would be required to disambiguate two builds which started at the same time, otoh,\nthe extra metadata might be useful sometime?"},{"file":"mk-agents-shar","line":139,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Seems fine to keep it. It makes the dirnames a little longer is the only downside I see. I believe it was elided before because this dir level was only intended to (a) group by branch and (b) sort by build date as a proxy for \"newer is the latest available\"."},{"file":"mk-agents-shar","line":166,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Freudian slip?"},{"file":"mk-agents-shar","line":166,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":":)  I\u0027ll fix."},{"file":"mk-agents-shar","line":253,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We are dropping TRY_BRANCH and the way to build an agentsshar with alternate branch builds of individual agents is to make changes to the local repo (to agents.json) and possibly commiting those to a feature branch. \n\nI think that because of that, we should change this to $STAMP from the eng.git Makefiles. This will mean that a build of the agentsshar from a \"foo\" branch of sdc-agents-installer.git will result in the agentsshar having \"foo\" in its name rather than \"master\" as it does right now.\n\nHrm... perhaps that means dropping the \u0027-b BUILDNAMES\u0027 option? I.e. it changes so that \u0027./mk-agents-shar ...\u0027 always uses *its* repo branch for the build name for all agents to include.... unless agents.json entries specify a buildname (aka \"branch\").   We can defer and do this separately if you like. I also suspect I\u0027m not being that clear. :)"},{"file":"mk-agents-shar","line":253,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I think I followed all that. I wonder would the best approach\nbe to have users supply their own agents.json file (or\nfallback to it from an \u0027agents-user.json\u0027, so as not to dirty the repo) and describe how to specify named branches from there?\n\nThat\u0027s the approach I was thinking of for smartos-live, having\njenkins pass a multi-line parameter so the user supplies\na config file.\n\nI\u0027ll spend a bit of time playing with this tomorrow, and\neither come up with a solution, or defer till later."},{"file":"mk-agents-shar","line":253,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think requiring the developer to make a commit on a feature branch to change agents.json would *suffice* because we have less developer need for custom agentsshar builds. There is a lot more developer need for lower-friction customized platform builds, so slicker support for smartos-live is more justitified.\n\nI see what you mean about a \"-dirty\" build and that getting in the way of \"make bits-upload\" for a local build.\n\nDeferring this to later is totally fine with me."},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"There is a significant change here, it would be good to bump the minor or at least patch level version. ... though granted that isn\u0027t currently used anywhere, so meh.\n\nI\u0027ll probably make the same request of the agent repos where we *do* expose the version and typically bump the ver for all changes."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":".gitmodules","type":"ADDED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":20,"deletions":-8},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":40,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":66,"sizeDeletions":-13},{"number":"3","revision":"fd9c1b0e11f0ae3a4a44907844025f90854fa721","parents":["30addf374995aef4732c409e3bd3275238a01f1b"],"ref":"refs/changes/18/5518/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1551030991,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1551030995,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551032355,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551032355,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":".gitmodules","type":"ADDED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-8},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":40,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-13},{"number":"4","revision":"54beab583e9713cf16f9e8c8a3e70fa616a988c6","parents":["30addf374995aef4732c409e3bd3275238a01f1b"],"ref":"refs/changes/18/5518/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1551177046,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1551030995,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551032355,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551032355,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1551177181,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":".gitignore","type":"MODIFIED","insertions":1,"deletions":0},{"file":".gitmodules","type":"ADDED","insertions":3,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":19,"deletions":-8},{"file":"deps/eng","type":"ADDED","insertions":1,"deletions":0},{"file":"mk-agents-shar","type":"MODIFIED","insertions":40,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":65,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}