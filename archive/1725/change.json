{"project":"joyent/sdcadm","branch":"master","id":"I2a3bfad212f398988633e65d44134435a9006e7d","number":"1725","subject":"TOOLS-1731 sdcadm post-setup common-external-nics should set external network as primary Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/1725","commitMessage":"TOOLS-1731 sdcadm post-setup common-external-nics should set external network as primary\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1490643616,"lastUpdated":1493749934,"open":false,"status":"MERGED","comments":[{"timestamp":1490643616,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1490643621,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 561e67b534fe8f5f6f8468afe39fdd780e57386e\n    \n    TOOLS-1731 sdcadm post-setup common-external-nics should set external network as primary"},{"timestamp":1490643647,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491328121,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1491501958,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2."},{"timestamp":1491501965,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 197f6d7fedb1d438fdbc11c728185f370a0beab1\n    \n    TOOLS-1731 sdcadm post-setup common-external-nics should set external network as primary"},{"timestamp":1491501982,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1491501989,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491502017,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491504367,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review-1\n\n(1 comment)"},{"timestamp":1491575484,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1491575490,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 00105f6824dbd84d77ac03218948ebe185f0091d\n    \n    TOOLS-1731 sdcadm post-setup common-external-nics should set external network as primary\n    \n    commit 6c82e344fe6eb8b884db5e75c5f0afc454504962\n    \n    TOOLS-1748 sdcadm reprovision timeout after TOOLS-1715"},{"timestamp":1491575520,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1491575558,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(3 comments)\n\nDone."},{"timestamp":1491836227,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1493747616,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nWas working correctly (see gist), but then it went boom on re-run of \u0027sdcadm experimental update-other\u0027"},{"timestamp":1493747996,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\nI believe you want this diff:\n\n```\ndiff --git a/lib/cli/do_update_other.js b/lib/cli/do_update_other.js\nindex 5a471ce..97bfb45 100644\n--- a/lib/cli/do_update_other.js\n+++ b/lib/cli/do_update_other.js\n@@ -799,11 +799,11 @@ function do_update_other(subcmd, opts, args, cb) {\n                         });\n                     }\n\n-                    if (toUpdateItems.length \u003d\u003d\u003d 0) {\n-                        next();\n-                        return;\n-                    }\n                 });\n+                if (toUpdateItems.length \u003d\u003d\u003d 0) {\n+                    next();\n+                    return;\n+                }\n\n                 vasync.forEachPipeline({\n                     inputs: toUpdateItems,\n```\n\nAlso, let\u0027s bump the package.json version (and a changelog entry)."},{"timestamp":1493749556,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1493749562,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit d603b5860061577616aec93abbedc3923d3524f5\n    \n    TOOLS-1731 sdcadm post-setup common-external-nics should set external network as primary"},{"timestamp":1493749619,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1493749724,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6: Code-Review+1 Integration-Approval+1\n\nWFM"},{"timestamp":1493749934,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"6","revision":"2a3bfad212f398988633e65d44134435a9006e7d","parents":["0d9ec17fcc444d4fc25a0080343d1c53dc9cac6f"],"ref":"refs/changes/25/1725/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1493749556,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493749619,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493749724,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493749724,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1493749934,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":73,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":83,"sizeDeletions":-2},"patchSets":[{"number":"1","revision":"3b2f0a1cf5c59fb4bca311fd3088b46b7d599f93","parents":["cb83542b039ff7a1b9fba6256ac1eb28afb044ff"],"ref":"refs/changes/25/1725/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1490643616,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490643647,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/cli/do_update_other.js","line":754,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"There should be a block comment here mentioning that this is fixing up for older versions of \u0027sdcadm post-setup common-external-nics\u0027."},{"file":"lib/cli/do_update_other.js","line":754,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/cli/do_update_other.js","line":755,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Call this \u0027updateCommonExternalNics\u0027 to keep the similar naming with related functionality."},{"file":"lib/cli/do_update_other.js","line":755,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/cli/do_update_other.js","line":759,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think the impl should be more like this:\n\n- for each relevant service, look for the expected condition (that the external network is defined and is primary)\n- if not, then add that case to a \"todo\" list\n- process the todo list and emit using `progress` for each thing done\n\nSuggested patch for that: https://gist.github.com/trentm/0022d57a1ec3d109cddd6f31bf42b594\nThoughts?\n\nHere is what it looks like running:\n\n```\n[root@headnode (nightly-2) ~]# sdcadm post-setup common-external-nics\nAdminUI already has an external nic\nIMGAPI already has an external nic\n\n[root@headnode (nightly-2) ~]# sdcadm experimental update-other\nUpdate \"sdc\" SAPI app metadata_schema\n...\nUpdating service for agent \u0027smartlogin\u0027\nUpdate \"imgapi\" service params.networks to ensure the external NIC is primary\nUpdate \"adminui\" service params.networks to ensure the external NIC is primary\n\n[root@headnode (nightly-2) ~]# sdcadm experimental update-other\nRunning VMAPI migrations\n```"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":37,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":41,"sizeDeletions":-1},{"number":"2","revision":"656caa501a69ff23403a5399b24ebb245a9b7bf5","parents":["4510d0799c004d90119b2454644382846b648064"],"ref":"refs/changes/25/1725/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1491501958,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491501989,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":73,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":77,"sizeDeletions":-1},{"number":"3","revision":"51205f7340e336d973fdb8ded06556f0c955bfcf","parents":["6c82e344fe6eb8b884db5e75c5f0afc454504962"],"ref":"refs/changes/25/1725/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1491501982,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491502017,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1491504367,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/cli/do_update_other.js","line":803,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This calls \u0027next\u0027 twice if neither service needs to update.\nThe if(toUpdateItemts.length) check and the forEachPipeline below need to be pulled out of the svcs.forEach."},{"file":"lib/cli/do_update_other.js","line":803,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, I messed it up when working on top of your patch"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":73,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":77,"sizeDeletions":-1},{"number":"4","revision":"0a1b6b60499d01b400239d2f8a9a4f603c9c9d9f","parents":["4510d0799c004d90119b2454644382846b648064"],"ref":"refs/changes/25/1725/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1491575484,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491575520,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1491504367,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":73,"deletions":0},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"lib/ur.js","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":79,"sizeDeletions":-3},{"number":"5","revision":"d8b920afe7765621bf122f63a585ece9b3a64532","parents":["6c82e344fe6eb8b884db5e75c5f0afc454504962"],"ref":"refs/changes/25/1725/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1491836227,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1491575520,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1491504367,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":73,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":77,"sizeDeletions":-1},{"number":"6","revision":"2a3bfad212f398988633e65d44134435a9006e7d","parents":["0d9ec17fcc444d4fc25a0080343d1c53dc9cac6f"],"ref":"refs/changes/25/1725/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1493749556,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1493749619,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1493749724,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1493749724,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1493749934,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/cli/do_update_other.js","type":"MODIFIED","insertions":73,"deletions":0},{"file":"lib/sdcadm.js","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":83,"sizeDeletions":-2}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},{"name":"Angela Fong","email":"angela.fong@joyent.com","username":"askfongjojo"}]}