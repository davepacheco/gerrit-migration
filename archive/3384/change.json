{"project":"joyent/illumos-joyent","branch":"master","id":"Ic258591bb17c772b4c77a02cae64932aaa17bef4","number":"3384","subject":"OS-6643 cxgbe should clean TX descriptors in timely manner Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e Reviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e Approved by: Jerry Jelinek \u003cjerry.jelinek@j","owner":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"url":"https://cr.joyent.us/3384","commitMessage":"OS-6643 cxgbe should clean TX descriptors in timely manner\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Ryan Zezeski \u003crpz@joyent.com\u003e\nReviewed by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\nApproved by: Jerry Jelinek \u003cjerry.jelinek@joyent.com\u003e\n","createdOn":1518815111,"lastUpdated":1521672062,"open":false,"status":"MERGED","comments":[{"timestamp":1518815111,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 1."},{"timestamp":1518819782,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(1 comment)\n\nI\u0027m wondering if we should instead of always dispatching cleaning up tasks look at doing it inline or using fixed taskq entities so we don\u0027t have potential memory situations."},{"timestamp":1518820031,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1521668507,"reviewer":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1521669070,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1521669596,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 1:\n\nI tested this with some cxgbe cards and the bhyve workload which was previously agitated by the lack of cleanup.  With the updated bits, bhyve guests were able to shutdown, thanks to their TX descriptors being cleaned up."},{"timestamp":1521670457,"reviewer":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},"message":"Patch Set 1: Code-Review+1 Integration-Approval+1"},{"timestamp":1521671235,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1521671329,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 3: Commit message was updated."},{"timestamp":1521671989,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Project policy requires all submissions to be a fast-forward.\n\nPlease rebase the change locally and upload again for review."},{"timestamp":1521672031,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1521672062,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Patrick Mooney"}],"currentPatchSet":{"number":"4","revision":"c258591bb17c772b4c77a02cae64932aaa17bef4","parents":["ec03b232c131f2289fedb6a63a9990898bbe16c2"],"ref":"refs/changes/84/3384/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521672031,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521668507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521669070,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"SUBM","value":"1","grantedOn":1521672062,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"8b92b3742d61257821d2aced4542db1df0a85737","parents":["32f885afcedb16f3b8334274714b013343c23d6e"],"ref":"refs/changes/84/3384/1","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1518815111,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521669070,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521668507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"comments":[{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","line":3377,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So what happens if we fail to dispatch because we\u0027re in a low memory situation? Should we be doing the reclaim task from here and just bite the cost? Otherwise, assume we got one large reclaim task for a lot of packets that have the memory we need to free up for something like this to succeed."},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","line":3377,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"The existing code is doing reclaims on the txq during packet transmission operations, which should keep usage there low during steady-state.  The reclaim behavior is primarily an issue when no packets are flowing at all.  I\u0027m not sure what level of paranoia we would want here."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1},{"number":"2","revision":"85dd50ffb02fe2176dd69eecfc9da281e973c755","parents":["f3195f72a46cb863b80329145921191a60882155"],"ref":"refs/changes/84/3384/2","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521671235,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521669070,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521668507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1},{"number":"3","revision":"baf3891437d9e516e6cec6f41d7d1280572bc3e1","parents":["f3195f72a46cb863b80329145921191a60882155"],"ref":"refs/changes/84/3384/3","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521671329,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521669070,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521668507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1},{"number":"4","revision":"c258591bb17c772b4c77a02cae64932aaa17bef4","parents":["ec03b232c131f2289fedb6a63a9990898bbe16c2"],"ref":"refs/changes/84/3384/4","uploader":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"createdOn":1521672031,"author":{"name":"Vishal Kulkarni","email":"vishal@chelsio.com","username":""},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1521670457,"by":{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521669070,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"SUBM","value":"1","grantedOn":1521672062,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1521668507,"by":{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":11,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/adapter.h","type":"MODIFIED","insertions":1,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_nexus.c","type":"MODIFIED","insertions":21,"deletions":0},{"file":"usr/src/uts/common/io/cxgbe/t4nex/t4_sge.c","type":"MODIFIED","insertions":17,"deletions":-1}],"sizeInsertions":39,"sizeDeletions":-1}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Jerry Jelinek","email":"jerry.jelinek@joyent.com","username":"jjelinek"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Ryan Zezeski","email":"rpz@joyent.com","username":"rzezeski"}]}