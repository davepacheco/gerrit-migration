{"project":"joyent/sdc-net-agent","branch":"master","id":"Ifd95baf44ac37445f6fa4e3b6e007de5932f031e","number":"6219","subject":"TRITON-1303 net-agent is hitting the refreshments a bit too hard TRITON-1316 net-agent should remove the NIC locally when updating a NIC returns 404 TRITON-1395 net-agent crashing with \"Invalid FSM transition: refresh \u003d\u003e release\" TRITON-1206 net-agent cra","owner":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"url":"https://cr.joyent.us/6219","commitMessage":"TRITON-1303 net-agent is hitting the refreshments a bit too hard\nTRITON-1316 net-agent should remove the NIC locally when updating a NIC returns 404\nTRITON-1395 net-agent crashing with \"Invalid FSM transition: refresh \u003d\u003e release\"\nTRITON-1206 net-agent crashing with \"Invalid FSM transition: refresh \u003d\u003e stopped\"\nReviewed by: Jordan Hendricks \u003cjordan.hendricks@joyent.com\u003e\nReviewed by: Jason King \u003cjason.king@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1557361650,"lastUpdated":1559076015,"open":false,"status":"MERGED","comments":[{"timestamp":1557361650,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 1."},{"timestamp":1557361831,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557866435,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 2."},{"timestamp":1557866491,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558382234,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 3."},{"timestamp":1558382275,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1558383424,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1559063964,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1559064254,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 5."},{"timestamp":1559064261,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1559064296,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559064683,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 4:\n\n(2 comments)\n\nAs"},{"timestamp":1559065287,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 5: Code-Review+1"},{"timestamp":1559067734,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Uploaded patch set 6."},{"timestamp":1559067773,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1559067781,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 6:\n\n(2 comments)"},{"timestamp":1559068174,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1559068601,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 6: Code-Review+1"},{"timestamp":1559075720,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1559075964,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1559075974,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1559075987,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Cody Peter Mello"},{"timestamp":1559076015,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"8","revision":"b5b4d6003a945ea46e7c9e299243a45df6d7776e","parents":["1f3e050da601ba8dacd6d9ab9f4d7644f0a569ec"],"ref":"refs/changes/19/6219/8","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1559075974,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559067773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068174,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068601,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559075720,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1559075987,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":46,"deletions":-52},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":248,"sizeDeletions":-122},"patchSets":[{"number":"1","revision":"9a95f6e773fa61614678a5d92f3455a0fb65a666","parents":["d4248523c646b974039ec9f834244f40af8dbbb7"],"ref":"refs/changes/19/6219/1","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1557361650,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557361831,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":44,"deletions":-51},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":134,"deletions":-55}],"sizeInsertions":239,"sizeDeletions":-119},{"number":"2","revision":"f42f9d7c4b0fa697a5b8779a5d758d16ce536dc2","parents":["fe8baaa2fff18a7ed1f23b5a09127206faa6d81f"],"ref":"refs/changes/19/6219/2","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1557866435,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1557866491,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":44,"deletions":-51},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56}],"sizeInsertions":243,"sizeDeletions":-120},{"number":"3","revision":"2b8d99d62c6d6b23a159d5a3e54eb934b0b864a6","parents":["c5f4af1d15c16e5a8c6a3722ef723f88a6488bee"],"ref":"refs/changes/19/6219/3","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1558382234,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558382275,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":44,"deletions":-51},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":245,"sizeDeletions":-120},{"number":"4","revision":"acb7cbf3192a7b1beb4dbfcfb1923fa8277a46af","parents":["3459512f2f640da44537abc8a25253d948213725"],"ref":"refs/changes/19/6219/4","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1558383424,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1558382275,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/aggr-fsm.js","line":8,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"update copyright"},{"file":"lib/aggr-fsm.js","line":8,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/aggr-fsm.js","line":57,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"The code seems to allow a refresh -\u003e release transition, though the diagram suggests refresh-\u003ewaiting-\u003erelease.  Should the diagram be updated?"},{"file":"lib/aggr-fsm.js","line":57,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/aggr-fsm.js","line":175,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"add \u0027update\u0027 to valid transitions?"},{"file":"lib/aggr-fsm.js","line":175,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"},{"file":"lib/aggr-fsm.js","line":316,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Will this case only happen when NAPI is stuck initializing (as in TRITON-1303)? I am wondering if the 5 second time out is too long, but I\u0027m not sure when we will hit this."},{"file":"lib/aggr-fsm.js","line":316,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"This can happen for multiple reasons: NAPI might still be initializing, it might be offline, or it could be any non-404 HTTP status code. Waiting 5 seconds is fine, since we aren\u0027t in a rush to make sure the aggregation is updated in NAPI."},{"file":"lib/nic-fsm.js","line":122,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"There seems to be a refresh-\u003erelease transition allowed in the code that\u0027s not reflected in the diagram"},{"file":"lib/nic-fsm.js","line":122,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":44,"deletions":-51},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":9,"deletions":-4},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":245,"sizeDeletions":-120},{"number":"5","revision":"ffe3aaafdbc7c1158b9202ba74c425ed45cd4f16","parents":["3459512f2f640da44537abc8a25253d948213725"],"ref":"refs/changes/19/6219/5","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1559064254,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559064296,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559065287,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":46,"deletions":-52},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":248,"sizeDeletions":-122},{"number":"6","revision":"fd95baf44ac37445f6fa4e3b6e007de5932f031e","parents":["3459512f2f640da44537abc8a25253d948213725"],"ref":"refs/changes/19/6219/6","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1559067734,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559067773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068601,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068174,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559075720,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":46,"deletions":-52},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":248,"sizeDeletions":-122},{"number":"7","revision":"0f4b6fb4eb644158794de554dca6c0e943789f47","parents":["3459512f2f640da44537abc8a25253d948213725"],"ref":"refs/changes/19/6219/7","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1559075964,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559067773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068601,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068174,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559075720,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":46,"deletions":-52},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":248,"sizeDeletions":-122},{"number":"8","revision":"b5b4d6003a945ea46e7c9e299243a45df6d7776e","parents":["1f3e050da601ba8dacd6d9ab9f4d7644f0a569ec"],"ref":"refs/changes/19/6219/8","uploader":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"createdOn":1559075974,"author":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"SUBM","value":"1","grantedOn":1559075987,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1559067773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068601,"by":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1559068174,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1559075720,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":13,"deletions":0},{"file":"lib/aggr-fsm.js","type":"MODIFIED","insertions":46,"deletions":-52},{"file":"lib/inst-fsm.js","type":"MODIFIED","insertions":34,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":18,"deletions":-9},{"file":"lib/net-fsm.js","type":"MODIFIED","insertions":10,"deletions":-5},{"file":"lib/nic-fsm.js","type":"MODIFIED","insertions":138,"deletions":-56},{"file":"lib/server-fsm.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":248,"sizeDeletions":-122}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}