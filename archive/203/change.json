{"project":"joyent/sdcadm","branch":"master","id":"I5344723d24831914c0b6a79d66fab57399b03adf","number":"203","subject":"TOOLS-1345 sdcadm update manatee does not update more than one async Reviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e Approved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/203","commitMessage":"TOOLS-1345 sdcadm update manatee does not update more than one async\nReviewed by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\nApproved by: Marsell Kukuljevic \u003cmarsell@joyent.com\u003e\n","createdOn":1470292546,"lastUpdated":1527508292,"open":false,"status":"MERGED","comments":[{"timestamp":1470292546,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1470292588,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1470292710,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nFor testing/integration purposes, I\u0027d like to repeat the following tests made into different local setups in staging1 (2 asyncs), staging2 (one async) and emy-12 (ONWM): https://gist.github.com/kusor/ea9b8c906afefb600ed3946014d54f78"},{"timestamp":1470465426,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1470465467,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1471515826,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3: Patch Set 2 was rebased."},{"timestamp":1471515866,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1472834403,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1472834444,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474310019,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4:\n\nShould get rebased. I\u0027m cool with changes here if it is demonstrated to fix it in staging1. However I don\u0027t know this code at all so I\u0027m not that comfortable reviewing it right now. I\u0027d really like to see us get manatee HA on 3 separate CNs in nightly and get testing going there... but that\u0027s all for separate tickets."},{"timestamp":1474972142,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5."},{"timestamp":1474972215,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1474988508,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nAlready tested in staging1, details at the JIRA issue. Waiting for approval in order to merge this"},{"timestamp":1475527119,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1475593816,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(4 comments)\n\nTrent, replies to your comments below. I have my doubts regarding documenting or not too much the possibility of two or more async peers. Indeed, it\u0027s not even documented into manatee project itself.\n\nAnyway, you\u0027re right that the \"we\u0027re done and all the async members are back to business\" needs a better explanation. It may save me some time in the future when I need to review this code ;-)"},{"timestamp":1475598778,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 6."},{"timestamp":1475598817,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475601128,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(3 comments)"},{"timestamp":1475603754,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 7."},{"timestamp":1475603800,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475603827,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\n(2 comments)\n\nDone with the two \"little\" changes. Gonna give a real try to what would be needed to add a specific peer UUID to our status check, which will definitely require some testing through all the possible scenarios"},{"timestamp":1475767109,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 8."},{"timestamp":1475767181,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1475767334,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 5:\n\nTrent: I\u0027ve added the optional peer identifier to the waitForManatee function to make unambiguous what is the async shard member we want disabled when we have more than one async.\n\nI\u0027ve also reviewed the whole sdcadm code and verified that, right now, there\u0027s no place where we\u0027re looking for disabled async members. Which doesn\u0027t mean this couldn\u0027t happen in the future, though."},{"timestamp":1476704802,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 9: Patch Set 8 was rebased"},{"timestamp":1476704858,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9:\n\n\"make check\" passed ok"},{"timestamp":1476981489,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 10: Patch Set 9 was rebased"},{"timestamp":1476981525,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10:\n\n\"make check\" passed ok"},{"timestamp":1477670952,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 11: Patch Set 10 was rebased"},{"timestamp":1477670988,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11:\n\n\"make check\" passed ok"},{"timestamp":1478511499,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 12: Patch Set 11 was rebased"},{"timestamp":1478511529,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12:\n\n\"make check\" passed ok"},{"timestamp":1480027292,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 12:\n\n(8 comments)"},{"timestamp":1490290437,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 13."},{"timestamp":1490290442,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13:\n\nNew commits:\n    \n    commit d110f6c68e3a59f969f671c8110738593edbd4e2\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async\n    Reviewed by: Trent Mick \u003ctrent.mick@joyent.com\u003e"},{"timestamp":1490290474,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490891079,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 14."},{"timestamp":1490891085,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 14:\n\nNew commits:\n    \n    commit a39d172d747a49ff58228e23dddd2e70e5b259ad\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1490891111,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1490891140,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 13:\n\n(8 comments)\n\nTrent: suggested changes applied + explanations + local tests made with 3 and 4 manatees"},{"timestamp":1502791999,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 15: Patch Set 14 was rebased."},{"timestamp":1502792005,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 15:\n\nNew commits:\n    \n    commit 056b31ea520092d68287ee7a6e724c05daa68278\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1502792042,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15:\n\n\"make check\" passed ok"},{"timestamp":1526830048,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 16."},{"timestamp":1526830054,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 16:\n\nNew commits:\n    \n    commit c9e5918d1999753a47e13f8ea2232408c8d72f8a\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1526830088,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1526985865,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 16:\n\nHey Marsell, can you take a look at this one? Trent has enough CRs on his plate and he already did his pass through this one anyway. If you don\u0027t mind going through the history here ... I\u0027d really appreciate it.\n\nNote that my next step after this issue is to complete https://jira.joyent.us/browse/TOOLS-1569 so we finally have sdcadm ha-manatee tests."},{"timestamp":1526985949,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 17: Patch Set 16 was rebased."},{"timestamp":1526985954,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 17:\n\nNew commits:\n    \n    commit 39af4e77d821710ce24d91b7c2032c061425fa95\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1526985990,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 17:\n\n\"make check\" passed ok"},{"timestamp":1527149826,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 17:\n\n(17 comments)"},{"timestamp":1527179925,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 18: Patch Set 17 was rebased."},{"timestamp":1527179931,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\nNew commits:\n    \n    commit 93b2e55eadafeaf286fceec38d125867a2dbddb6\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1527179967,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 18:\n\n\"make check\" passed ok"},{"timestamp":1527184970,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 19."},{"timestamp":1527184976,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 19:\n\nNew commits:\n    \n    commit ee4dc983e3908ebe802b6c390d07642472f4bd88\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1527184997,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 18:\n\n(17 comments)\n\nDone with the suggested changes Marsell. Thanks!"},{"timestamp":1527185006,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 19: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527249486,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 19: Code-Review+1 Integration-Approval+1\n\n(11 comments)\n\nAt this point I\u0027m just bikeshedding..."},{"timestamp":1527487445,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 20."},{"timestamp":1527487450,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 20:\n\nNew commits:\n    \n    commit a98074634513f52c6503b66cdc31466c1cf06ab4\n    \n    TOOLS-1345 sdcadm update manatee does not update more than one async"},{"timestamp":1527487482,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 20: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1527487482,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 20:\n\n(11 comments)\n\nDone with all the suggestions + rebased. Thanks again Marsell!"},{"timestamp":1527501774,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Patch Set 20: Code-Review+1 Integration-Approval+1\n\nOnwards and upwards!"},{"timestamp":1527508292,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"}],"currentPatchSet":{"number":"20","revision":"5344723d24831914c0b6a79d66fab57399b03adf","parents":["b21565d0217bb66f9895528a0e312d142a060b46"],"ref":"refs/changes/03/203/20","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1527487445,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527487482,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527501774,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527501774,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"SUBM","value":"1","grantedOn":1527508292,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":19,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":146,"deletions":-108},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":233,"deletions":-175}],"sizeInsertions":398,"sizeDeletions":-291},"patchSets":[{"number":"1","revision":"3a3fcc58951cf3e851ecd481eaeb2723aacf15ef","parents":["fde3068854da34d1bf54ac00daab0dbd4d62c66c"],"ref":"refs/changes/03/203/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1470292546,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1470292588,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":37,"deletions":-20},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":259,"deletions":-210}],"sizeInsertions":303,"sizeDeletions":-234},{"number":"2","revision":"8d6db6e99d1339f060dfb47371dff150656d923b","parents":["f8833f98d7131670c77da8355257a7cca017c6ea"],"ref":"refs/changes/03/203/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1470465426,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1470292588,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":37,"deletions":-20},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":259,"deletions":-210}],"sizeInsertions":303,"sizeDeletions":-234},{"number":"3","revision":"a542ee8a4d828542f70d51461a22466c556554b4","parents":["b834aca07d6f4eb5aac08cb9ae65c002d78f0a06"],"ref":"refs/changes/03/203/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1471515826,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1470292588,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":37,"deletions":-20},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":259,"deletions":-210}],"sizeInsertions":303,"sizeDeletions":-234},{"number":"4","revision":"9c1ca8e4f30db95fdd11721f3b2cde41c796ba70","parents":["28cfd7326210e57a2eba8a01f662c04898c11d3d"],"ref":"refs/changes/03/203/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1472834403,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1472834444,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":35,"deletions":-19},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":259,"deletions":-210}],"sizeInsertions":299,"sizeDeletions":-232},{"number":"5","revision":"03796f9628323304d982eeaef688e334f55cafe9","parents":["16842e980d99d7b17d98aac769957d68aabf61e1"],"ref":"refs/changes/03/203/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1474972142,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1474972215,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":888,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"update this ocmment to include the \u0027repl_status\u0027"},{"file":"lib/common.js","line":888,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not sure we should, not at least w/o a commend saying that repl_status will be present only if we have more than one async shard member, which it\u0027s not the common scenario"},{"file":"lib/common.js","line":888,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Then definitely say that. Otherwise the example is just wrong. That \u0027repl_status\u0027 will be *present*, it just may be \u0027-\u0027."},{"file":"lib/common.js","line":888,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1266,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"shouldn\u0027t we require that *all* async peers are off (pg_status!\u003d\u003d\u0027ok\u0027) before being \"done\" here?"},{"file":"lib/procedures/shared.js","line":1266,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I don\u0027t think we need to \"disable\" more than one async to be done here. Indeed, I think that one disabled async is exactly what we\u0027re looking for here, since we just want to disable one peer, let the others be"},{"file":"lib/procedures/shared.js","line":1269,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I think this section needs a comment explaining in prose the requirements for being \"done\". E.g. the last case:\n\n    done \u003d obj.async.some(function (peer) {\n        return (peer.repl_status \u0026\u0026\n                peer.repl_status !\u003d\u003d \u0027async\u0027);\n    });\n\nQ: We are \"done\" enabling a particular async peer when one or more of the async peers have a repl_status that is not equal to \u0027async\u0027?  I don\u0027t know manatee replicating well enough to know what that means. E.g. this in staging:\n\n    [root@8372b732-007c-400c-9642-9eb63d169cf2 (staging-1:manatee0) ~]# manatee-adm pg-status\n    ROLE     PEER     PG   REPL  SENT          FLUSH         REPLAY        LAG\n    primary  8372b732 ok   sync  4B/458DB3F0   4B/458DB3F0   4B/458DB048   -\n    sync     cd89eb35 ok   async 4B/458DB3F0   4B/458DB3F0   4B/458DB048   -\n    async    cce218f8 ok   async 4B/458DB3F0   4B/458DB3F0   4B/458DB048   0m00s\n    async    4243db81 ok   -     -             -             -             0m00s\n\nIf we added more async peers... do all async peers but the last one have a \"REPL\" column value of \"async\"? Does that mean they are replicating in a chain?"},{"file":"lib/procedures/shared.js","line":1269,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If I understood correctly, manatee uses PSQL cascading replication, which means each node is replicating exactly from the one in top of it. \n\nYou\u0027re right this one needs a huge explanation about when we\u0027re done enabling asyncs: those will not appear until they\u0027re catching up on replication, and depending on the number of asyncs our expectations may be different. I\u0027ll re-work this one."},{"file":"lib/procedures/shared.js","line":1276,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"this line is cruft, right?"},{"file":"lib/procedures/shared.js","line":1276,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not really, we could be checking that it\u0027s enabled using ONWM, i.e. a single manatee primary instance, which is also supported"},{"file":"lib/procedures/shared.js","line":1276,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I mean the \"done \u003d true;\" line, follow immediately by another assignment to \"done\"."},{"file":"lib/procedures/shared.js","line":1276,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Modifying it into the next patch set, you\u0027re right"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":5,"deletions":-3},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":35,"deletions":-19},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":300,"sizeDeletions":-233},{"number":"6","revision":"9ee2641d6afd8cb22baf13beebe7a0caf22ce479","parents":["63860de971e00215e442e4ddbf4484e0a8db2abb"],"ref":"refs/changes/03/203/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1475598778,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475598817,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/shared.js","line":1269,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Is this really correct? I think part of the problem I have here is that we call this function with a *specific* async in mind, but the function doesn\u0027t wait for that specific one.\n\nMy ideal would be to change this function to operate on a\nspecific manatee instance UUID. If we did that, then the definition of \"this manatee instance is done disabling or done enabling\" can be more crisply defined.\n\nWould making that change be possible? I understand this could be annoying given that I\u0027m not actually sure we explicitly decided to *support* more than 3 manatee instances."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":7,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":55,"deletions":-19},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":322,"sizeDeletions":-234},{"number":"7","revision":"98f36a30bdcf7e899cfb9b2d5ca4c7be0fabd7b5","parents":["63860de971e00215e442e4ddbf4484e0a8db2abb"],"ref":"refs/changes/03/203/7","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1475603754,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475603800,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":8,"deletions":-4},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":52,"deletions":-19},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":320,"sizeDeletions":-234},{"number":"8","revision":"62aa5823123b404b61f7ec7ab713bd850bda203e","parents":["63860de971e00215e442e4ddbf4484e0a8db2abb"],"ref":"refs/changes/03/203/8","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1475767109,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475767181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":83,"deletions":-23},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":360,"sizeDeletions":-242},{"number":"9","revision":"630e0aaa38a4be47b008123503da20f9b019d77f","parents":["aa0ea58066f8489e99c0f32ce5789f6ca3f95916"],"ref":"refs/changes/03/203/9","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1476704802,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475767181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":83,"deletions":-23},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":360,"sizeDeletions":-242},{"number":"10","revision":"a62c176495d5a3c64778d55e84b88a347e1a6ee9","parents":["27385a38a4578ad0b0247a76fc72a075c86b88cb"],"ref":"refs/changes/03/203/10","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1476981489,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475767181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":83,"deletions":-23},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":360,"sizeDeletions":-242},{"number":"11","revision":"a1daf9f91f91d617ce2cd39c55a3678be7c9478d","parents":["b4c58fedcd3771521f6fdab31c448ffea9419d5b"],"ref":"refs/changes/03/203/11","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1477670952,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475767181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":83,"deletions":-23},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":360,"sizeDeletions":-242},{"number":"12","revision":"0da9f99957f720daa30972bf8a51e232e2613759","parents":["5d14e20e4538153be5c88e83cea7b94e61e0e34d"],"ref":"refs/changes/03/203/12","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1478511499,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1475767181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/procedures/shared.js","line":1159,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"A UUID or uuid prefix is accepted here. My ideal is that it only accept the full UUID. UUID prefix stuff should only be supported for users at the CLI-level. Is there a strong reason we want this to support the UUID prefix?\n\nPerhaps make \u0027role\u003dasync\u0027 without a \u0027peer\u0027 mean \"all asyncs\". Or change to requiring \u0027peer\u0027 when saying \u0027async\u0027. See the note below."},{"file":"lib/procedures/shared.js","line":1159,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Mainly, the reason is that manatee-adm supports and uses by default uuid prefixes. I\u0027d say it\u0027ll be less confusing to keep support for it, given it doesn\u0027t really cost too much.\n\nAnd yeah, I think it\u0027s a good idea to make \"role\u003dasync\" w/o a peer mean \"all asyncs\""},{"file":"lib/procedures/shared.js","line":1296,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Not true for some cases, see above. E.g. \u0027disableManateeSitter\u0027 will be broken now: it\u0027ll leave one of the asyncs up, IIUC.\n\nBoth \u0027disableManateeSitter\u0027 and \u0027enableManateeSitter\u0027 are broken if there are multiple asyncs. I think this whole change needs to include fixes for those too. I.e. the ticket should become \u0027sdcadm does not support multiple manatee asyncs\u0027."},{"file":"lib/procedures/shared.js","line":1296,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1373,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Don\u0027t need this \u0027return;\u0027 statement."},{"file":"lib/procedures/shared.js","line":1373,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":524,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Here you allow for arg.shared.async to be an object..."},{"file":"lib/procedures/update-manatee-v2.js","line":524,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"On the lines above (510) it says \"if (Array.isArray(arg.shard[role])){\" which will always catch arg.shared.async, since it\u0027s always an array, despite of the fact it might or not be empty. The same is true for a role not mentioned here which will be \"deposed\". Line 524\u0027s else contained code will apply only to shard\u0027s primary and sync which are always objects, but will never be reached by async or deposed shard members."},{"file":"lib/procedures/update-manatee-v2.js","line":548,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"... but here assume that it is an array.\n\nEither we update it here to handle both, or (perhaps would be cleaner), we update \u0027getShardStateLocally\u0027 to always return a shard state in the new format (where \u0027async\u0027 is always an array)."},{"file":"lib/procedures/update-manatee-v2.js","line":548,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"As mentioned above, arg.shard.async is always an array, b/c that\u0027s what getShardStateLocally always returns  - which is just the JSON output of `manatee-adm zk-state|json`"},{"file":"lib/procedures/update-manatee-v2.js","line":604,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"...likewise assuming shared.async in an array here."},{"file":"lib/procedures/update-manatee-v2.js","line":604,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Already answered. Always an array"},{"file":"lib/procedures/update-manatee-v2.js","line":634,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Don\u0027t need this statement."},{"file":"lib/procedures/update-manatee-v2.js","line":634,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":962,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Shouldn\u0027t this pass the new \u0027peer\u0027 arg to be explicit about which async we want to wait for here?"},{"file":"lib/procedures/update-manatee-v2.js","line":962,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Not really. Given I\u0027ve just added the assumption that if no peer is given, waitForManatee will wait for all the async manatees to reach the desired status, it\u0027s the perfect fit for this situation, when we\u0027re waiting for full shard HA."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":83,"deletions":-23},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":360,"sizeDeletions":-242},{"number":"13","revision":"c3d2d71f09ba241d9aa67fcdcf1d348c20c56690","parents":["cb83542b039ff7a1b9fba6256ac1eb28afb044ff"],"ref":"refs/changes/03/203/13","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1490290437,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490290474,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":83,"deletions":-23},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":260,"deletions":-211}],"sizeInsertions":360,"sizeDeletions":-242},{"number":"14","revision":"9c8be9eb8534c92c875f550875c8de7f5d4c034d","parents":["cb83542b039ff7a1b9fba6256ac1eb28afb044ff"],"ref":"refs/changes/03/203/14","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1490891079,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490891111,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":155,"deletions":-92},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":259,"deletions":-211}],"sizeInsertions":431,"sizeDeletions":-311},{"number":"15","revision":"7771e2f0f4dfef4b93da9dbc25ca3bcb0fdc6d34","parents":["003277077f0006fa698189f39c7f7d48ce4ea049"],"ref":"refs/changes/03/203/15","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1502791999,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1490891111,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":154,"deletions":-91},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":259,"deletions":-211}],"sizeInsertions":430,"sizeDeletions":-310},{"number":"16","revision":"f510abff875227d14704c2bed9622892dfa79c09","parents":["3a87f3d6270cd478d9bd492c6ba698992d4f8ff9"],"ref":"refs/changes/03/203/16","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1526830048,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526830088,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":146,"deletions":-109},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":198,"deletions":-138}],"sizeInsertions":361,"sizeDeletions":-255},{"number":"17","revision":"6adc992f9e0d89af90dc22b648cf80a26e912761","parents":["b718594e7acfaa9a18c5486bf3306d603fc89585"],"ref":"refs/changes/03/203/17","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1526985949,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526830088,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":906,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Might wanna document what this case indicates."},{"file":"lib/common.js","line":906,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1309,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This should totally be hoisted into its own variable.\n\nThis code looks vaguely familiar, mind you. You prolly did it in some other CR."},{"file":"lib/procedures/shared.js","line":1309,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, the one related to ha-binder. Done here too."},{"file":"lib/procedures/shared.js","line":1420,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"successive"},{"file":"lib/procedures/shared.js","line":1420,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1421,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Eh. Given how much this if() is doing, can prolly omit this."},{"file":"lib/procedures/shared.js","line":1421,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1433,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"You can prolly omit this."},{"file":"lib/procedures/shared.js","line":1433,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1621,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Can omit."},{"file":"lib/procedures/shared.js","line":1621,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1737,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"pew pew lasers!"},{"file":"lib/procedures/shared.js","line":1737,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":358,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Can you go into why it was async before, but primary now?"},{"file":"lib/procedures/update-manatee-v2.js","line":358,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, it\u0027s simple: we can freeze the shard using any member. Anyway, this assumed we had a working async member, and we could have a shard with just primary/sync members. Therefore, move to use the primary, which always will be present."},{"file":"lib/procedures/update-manatee-v2.js","line":412,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Also, arg.shard.* is used a *lot* in this pipeline. I think it\u0027d be best split out into var primary/var sync/var asyncs"},{"file":"lib/procedures/update-manatee-v2.js","line":412,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":523,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"name"},{"file":"lib/procedures/update-manatee-v2.js","line":523,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":524,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"name"},{"file":"lib/procedures/update-manatee-v2.js","line":524,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":528,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Methinks this should be in its own var."},{"file":"lib/procedures/update-manatee-v2.js","line":528,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":540,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Ditto."},{"file":"lib/procedures/update-manatee-v2.js","line":540,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":622,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Maybe:\n\n    var shard \u003d arg.shard;\n    var inputs \u003d [shard.primary, shard.sync].concat(shard.async);\n\n?"},{"file":"lib/procedures/update-manatee-v2.js","line":622,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done with the little difference that we must add\n\n                    .filter(function exists(x) { return x; });\n\nOtherwise we may be appending a nice \"undefined\" in case we have no async."},{"file":"lib/procedures/update-manatee-v2.js","line":622,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"var inputs \u003d [primary, sync].concat(asyncs || []);\n\n?"},{"file":"lib/procedures/update-manatee-v2.js","line":622,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Indeed"},{"file":"lib/procedures/update-manatee-v2.js","line":670,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Remove the superfluous parens."},{"file":"lib/procedures/update-manatee-v2.js","line":670,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":701,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"You don\u0027t need the extra parens here either. I don\u0027t think it clears much up."},{"file":"lib/procedures/update-manatee-v2.js","line":701,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":739,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Like above."},{"file":"lib/procedures/update-manatee-v2.js","line":739,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":146,"deletions":-109},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":198,"deletions":-138}],"sizeInsertions":361,"sizeDeletions":-255},{"number":"18","revision":"e33c26c9f153c3aeaa225e85dd3bdb7e5d062548","parents":["8e04a29a57bcc8d8226bf3b887a06a75021a6bff"],"ref":"refs/changes/03/203/18","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1527179925,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1526830088,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":17,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":146,"deletions":-109},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":198,"deletions":-138}],"sizeInsertions":361,"sizeDeletions":-255},{"number":"19","revision":"9b8205c65dc55c3e4eaf3c554fe807373e583009","parents":["8e04a29a57bcc8d8226bf3b887a06a75021a6bff"],"ref":"refs/changes/03/203/19","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1527184970,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527185006,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527249486,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527249486,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"comments":[{"file":"lib/procedures/shared.js","line":1306,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Personally, I\u0027d add a:\n\n    if (member.error)\n        return;\n\nhere, because both the if/else if branches check for !member.error.\n\nThis is turning into CR creep though. Feel free to skip."},{"file":"lib/procedures/shared.js","line":1306,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Good call"},{"file":"lib/procedures/shared.js","line":1312,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"This is totally abusing things, but this could be shortened to:\n\n    (member.repl \u0026\u0026 member.repl.sync_state) || \u0027-\u0027\n\nI only mention this because this code is running out of space. Feel free to skip."},{"file":"lib/procedures/shared.js","line":1312,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1322,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"member.online !\u003d\u003d undefined"},{"file":"lib/procedures/shared.js","line":1322,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/shared.js","line":1429,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Just out of curiosity, is it possible to have more than one async without repl_status \u0027async\u0027, and what would that mean?"},{"file":"lib/procedures/shared.js","line":1429,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"If everything is working as expected, we should have just a single async with repl_status of \u0027-\u0027 and all the others of \u0027async\u0027. It may be possible to have more than one on such status and that would probably mean that it hasn\u0027t yet detected it\u0027s part of a shard."},{"file":"lib/procedures/update-manatee-v2.js","line":511,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"These can also be eliminated if the \"primary\" assignment below is raised four lines."},{"file":"lib/procedures/update-manatee-v2.js","line":511,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":530,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Does this not fit on the previous line?"},{"file":"lib/procedures/update-manatee-v2.js","line":530,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"It does!"},{"file":"lib/procedures/update-manatee-v2.js","line":560,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Could be eliminated by moving the next line up one."},{"file":"lib/procedures/update-manatee-v2.js","line":560,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":703,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Can forEachPipeline() handle undefined here?\n\nOtherwise \"|| []\""},{"file":"lib/procedures/update-manatee-v2.js","line":703,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/update-manatee-v2.js","line":949,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"I dunno what is going on here.\n\nI think you mentioned you were going to remove anything to do with 1.0.0 at some point?"},{"file":"lib/procedures/update-manatee-v2.js","line":949,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, upcoming issue. Let\u0027s just finish one thing at time :)"},{"file":"lib/procedures/update-manatee-v2.js","line":984,"reviewer":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},"message":"Same here?"},{"file":"lib/procedures/update-manatee-v2.js","line":984,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":19,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":140,"deletions":-104},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":231,"deletions":-170}],"sizeInsertions":390,"sizeDeletions":-282},{"number":"20","revision":"5344723d24831914c0b6a79d66fab57399b03adf","parents":["b21565d0217bb66f9895528a0e312d142a060b46"],"ref":"refs/changes/03/203/20","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1527487445,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1527487482,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1527508292,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1527501774,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1527501774,"by":{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":19,"deletions":-8},{"file":"lib/procedures/shared.js","type":"MODIFIED","insertions":146,"deletions":-108},{"file":"lib/procedures/update-manatee-v2.js","type":"MODIFIED","insertions":233,"deletions":-175}],"sizeInsertions":398,"sizeDeletions":-291}],"allReviewers":[{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Marsell Kukuljevic","email":"marsell@joyent.com","username":"marsell"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}