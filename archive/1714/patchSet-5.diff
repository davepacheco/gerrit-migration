From 0c6422add774835b1adcb1706fce875d5ad48b40 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 11 Apr 2017 12:21:20 +0200
Subject: [PATCH] TOOLS-1727 sdcadm create cloudapi does not give it an
 external nic

---
 lib/cli/do_update_other.js | 29 ++++++++++++++++++++++++++++-
 1 file changed, 28 insertions(+), 1 deletion(-)

diff --git a/lib/cli/do_update_other.js b/lib/cli/do_update_other.js
index f019750..9ad5b2f 100644
--- a/lib/cli/do_update_other.js
+++ b/lib/cli/do_update_other.js
@@ -755,7 +755,34 @@ function do_update_other(subcmd, opts, args, cb) {
             }, next);
         },
 
-        steps.agentServicesEnsureCreated
+        steps.agentServicesEnsureCreated,
+
+        /*
+         * Previously CloudAPI configuration did not include an external
+         * network. We need to add it and make sure it's primary.
+         */
+        function updateCloudapiCfg(ctx, next) {
+            var cloudapiSvc = ctx.svcs.filter(function (svc) {
+                return svc.name === 'cloudapi';
+            })[0];
+            if (cloudapiSvc.params.networks.length > 1) {
+                next();
+                return;
+            }
+            progress('Add "external" network parameter to "CloudAPI" service');
+            updateService(cloudapiSvc.uuid, { params: {
+                networks: [
+                    { name: 'admin' },
+                    { name: 'external', primary: true}
+                ]
+            } }, function (cloudapiErr) {
+                if (cloudapiErr) {
+                    next(new errors.SDCClientError(cloudapiErr, 'sapi'));
+                    return;
+                }
+                next();
+            });
+        }
 
     ]}, function (err) {
         if (!history) {
-- 
2.21.0

