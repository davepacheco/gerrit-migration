From 991ae49b57867ac69cc515c45a5b4d2ba7eb61b6 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Thu, 3 Nov 2016 18:46:07 +0000
Subject: [PATCH] OS-5764 LTP sendto02 wrong errno

---
 usr/src/lib/brand/lx/testing/ltp_skiplist       | 1 +
 usr/src/uts/common/brand/lx/syscall/lx_socket.c | 6 ++++++
 2 files changed, 7 insertions(+)

diff --git a/usr/src/lib/brand/lx/testing/ltp_skiplist b/usr/src/lib/brand/lx/testing/ltp_skiplist
index d7bf37319a..ecf78a7e3e 100644
--- a/usr/src/lib/brand/lx/testing/ltp_skiplist
+++ b/usr/src/lib/brand/lx/testing/ltp_skiplist
@@ -218,6 +218,7 @@ sendfile06_64
 sendfile07
 sendfile07_64
 sendmsg01
+sendto02		# OS-5764
 setgroups04_16
 setns01
 setns02
diff --git a/usr/src/uts/common/brand/lx/syscall/lx_socket.c b/usr/src/uts/common/brand/lx/syscall/lx_socket.c
index 8e774924b5..2db0204b51 100644
--- a/usr/src/uts/common/brand/lx/syscall/lx_socket.c
+++ b/usr/src/uts/common/brand/lx/syscall/lx_socket.c
@@ -2173,6 +2173,12 @@ done:
 	return (len - uiop->uio_resid);
 }
 
+/*
+ * For both send and sendto Linux evaluates errors in a different order than
+ * we do internally. Specifically it will check the buffer address before
+ * checking if the socket is connected. This can lead to a different errno on
+ * us vs. Linux (seen with LTP) but we don't bother to emulate this.
+ */
 long
 lx_send(int sock, void *buffer, size_t len, int flags)
 {
-- 
2.21.0

