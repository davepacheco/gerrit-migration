{"project":"joyent/muppet","branch":"master","id":"If4fea24a048507847c47dee770bbeed94efd7ccc","number":"3110","subject":"MANTA-3408 muppet stops watching for updates if it loses connection to zookeeper MANTA-3473 Update Muppet to node v4 MANTA-3163 muppet crashes when its ZK session expires Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e Reviewed by: Kelly McLaugh","owner":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"url":"https://cr.joyent.us/3110","commitMessage":"MANTA-3408 muppet stops watching for updates if it loses connection to zookeeper\nMANTA-3473 Update Muppet to node v4\nMANTA-3163 muppet crashes when its ZK session expires\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\nReviewed by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\nApproved by: Kelly McLaughlin \u003ckelly.mclaughlin@joyent.com\u003e\n","createdOn":1513209266,"lastUpdated":1515176158,"open":false,"status":"MERGED","comments":[{"timestamp":1513209266,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 1."},{"timestamp":1513209267,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit e256e3fb236ef120eda9bb433afee5963ad38ce9\n    \n    Adjust var-\u003econst in lb_manager while I\u0027m at it\n    \n    commit 4deeef02b29460e3d9b1528d6f928c4405749c93\n    \n    Make failures restart muppet\n    \n    commit 6bc520dfd334cf32db66693d45c37ec22e62dd65\n    \n    Comment to handle error\n    \n    commit e9e1c7be04f9ed8137296ffc0a8e024aa8a127b3\n    \n    More bug fixes and comment cleanup\n    \n    commit e37ab733162001040ad5c3056bba270539e98c60\n    \n    Get watcher working finally\n    \n    commit 5f5eee992504d412b385bc76084090add33a524d\n    \n    Cleanup\n    \n    commit fc61efb230968bee6390ac6e54f9af21cbe0a66d\n    \n    Update to zkstream 0.10.0 and catch NODE_EXISTS errors\n    \n    commit ce375123cc2dc8995196c92cdda03f44ff295c9d\n    \n    Upgrade nodeunit to something that supports node 4\n    \n    commit e7af62624150ca9714d34956eca93f92f4d97b0e\n    \n    Fix make check issues\n    \n    commit b2dd1905b0e808209ee6d59b696e62a2b3ca753a\n    \n    Push latest of muppet-\u003ezkstream\n    \n    commit 5d837bddbef4da902c2e0a7243585ae50360f9cd\n    \n    More zkplus-\u003ezkstream changes, also picked up Jan\u0027s CR sha\n    \n    commit b8876b542571427b5f0ec04fd92091b03c75b579\n    \n    More var-\u003econst\n    \n    commit 9282fe2bb3db4d863ec210e4f2e8f51d296fc1a8\n    \n    More small changes I don\u0027t want getting lost\n    \n    commit c9ec0725f4db8975fcee98c31548db13ac59a713\n    \n    To keep from losing work again from emy, push temporary work\n    \n    commit 2b56050c134593c2f97742e384b1ad75bc21e5c5\n    \n    Global cleanup, switch to node v4\n    \n    commit 42c18d76ee1a53c375385944fd9414d63df04397\n    \n    Push temporarily in case vpn goes down"},{"timestamp":1513209290,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513209552,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 2."},{"timestamp":1513209553,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 2ff76d73d04534dcd37efb71edc8b1387e7e81ed\n    \n    Remove comments from makefile"},{"timestamp":1513209576,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513284129,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1513298259,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 3."},{"timestamp":1513298260,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 056176b510a2b72df3b9cdcd3ebd3414b233346f\n    \n    Address code review comments"},{"timestamp":1513298310,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513298335,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1513710795,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\n(2 comments)"},{"timestamp":1513713826,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 4."},{"timestamp":1513713828,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 5f44efaa49cf903bf0e10fe8effbaaefe8aa6413\n    \n    Name callback for help in debugging\n    \n    commit 9b70dec0f9a27f25c70636616dddfc87b8e3eda9\n    \n    Cleanup for review comments\n    \n    commit b7bce974385e5901affb0ab123eb2c74339a2e01\n    \n    Cleanup in response to CR review comments"},{"timestamp":1513713865,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513713903,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1513731059,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 5."},{"timestamp":1513731060,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 1cae218cee3386baab2a4ace2c12799be2143294\n    \n    Change config order to favor zkstream"},{"timestamp":1513731083,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513787465,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nI\u0027ve run through the automated tests and put this change through the paces on my lab manta and it has worked as expected and is a great improvement on the current muppet behavior."},{"timestamp":1515057214,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(7 comments)\n\nThanks for putting this together! I want to preface my comments with the fact that I\u0027ve never worked with Node v4, or done too much heavy work against ZooKeeper with our various clients.\n\nI\u0027m a little dubious about restarting the SMF service, and also falling into maintenance if no ZooKeeper instances can be contacted.\n\nI don\u0027t know if any other service in Manta does this, but would it not be preferable to simply wait forever for ZooKeeper to come back? From what I\u0027ve seen, we tend to try and avoid any failure modes that would result in an operator having to perform an action to recover. If we just wait for ZooKeeper to come back then we\u0027re still in the same position as if the service was in maintenance (i.e. HAProxy config won\u0027t get updated), just that service can resume automatically.\n\nFor example, in Manatee, if ZooKeeper goes away entirely then we appear to just wait (https://github.com/joyent/manatee/blob/master/lib/zookeeperMgr.js defines our interactions with ZooKeeper). In this state, the cluster won\u0027t know if a peer has gone missing and as such won\u0027t take action, but without ZooKeeper then that\u0027s expected. We simply log on \"disconnect\", then when ZooKeeper comes back we see a \"connect\" event from our ZooKeeper client and re-init.\n\nCan Muppet do something similar here? Is this a different failure scenario than I\u0027m aware of? Happy to do some reading of other projects we might have done this in for more context.\n\nAs for restarting the SMF service, when will this be done? It looks like this will happen on an \"error\" event from zkstream, but the comment mentions that this isn\u0027t a documented event. Do we need to include this fallback mechanism? Would a call to \"stop\" then \"start\" be enough (with backoff), if we need to do anything at all? I don\u0027t know what Muppet did in the past in this case."},{"timestamp":1515079189,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\n(7 comments)\n\nRegarding the restart mechanism, before I get into an explanation, I agree with you, I will remove the restart function and the call to it.\n\nBefore these changes, muppet/zkplus had a habit of just going away. Mind you, they didn\u0027t actually crash, dump a core, or restart.  They just simply stopped paying attention to ZK.  This is the issue that happened over Christmas break in fact.  ZK was restarted cluster wide and muppet just went off the farm.  With that in mind, I wanted to make sure all real errors that muppet couldn\u0027t handle actually ended up showing a real error or restart to maximize availability.  In zkplus\u0027 time, there was an error event, so I put this code in early to do something about it.  In testing zkstream, both Kelly and I realized this would never happen.  Any errors were handled upstream with zkstream \u0026 cueball. I left in the code as a complete \"just in case, I\u0027m going to cover my back\", but since both you and Kelly had the same comment, I\u0027ll remove it."},{"timestamp":1515085605,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(6 comments)\n\nThanks for the details. Given that \"error\" isn\u0027t a documented event from zkstream (as you mentioned), I don\u0027t think we\u0027d ever hit that restart mechanism anyway. My understanding of updating to zkstream was that this library would handle the ZK-reconnect thing that bit us over Christmas for us. If this proves not to be the case, then with a more up-to-date library (zkstream) we\u0027d stand a better chance of debugging.\n\nDoes that make sense? I could very well have the wrong end of the stick here!"},{"timestamp":1515088084,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1515089291,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 6."},{"timestamp":1515089292,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 8033c919c73da725c1ccd422f5c76ce0da6095e3\n    \n    Address review comments"},{"timestamp":1515089315,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515089496,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 5:\n\n(3 comments)\n\nAlso realized that zkstream added a bug fix for one thing, so going to bump that to 0.10.1 to align with registrar."},{"timestamp":1515089635,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 7."},{"timestamp":1515089637,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit e2af20baa560edda5ac381a91ec836ba175a5355\n    \n    Update zkstream to 0.10.1"},{"timestamp":1515089658,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515155532,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7:\n\n(3 comments)"},{"timestamp":1515162607,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 7:\n\n(2 comments)"},{"timestamp":1515164397,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 7:\n\n(1 comment)"},{"timestamp":1515165404,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Uploaded patch set 8."},{"timestamp":1515165406,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 8:\n\nNew commits:\n    \n    commit 560a0098ba4a033e0b30e3d669e7fc9944217cc7\n    \n    Change log to fatal on failed event"},{"timestamp":1515165429,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515165984,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 9: Commit message was updated."},{"timestamp":1515166180,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1515170485,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 9: Code-Review+1"},{"timestamp":1515175541,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 9: Integration-Approval+1"},{"timestamp":1515176139,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Patch Set 10: Commit message was updated."},{"timestamp":1515176158,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Jared Morrow"}],"currentPatchSet":{"number":"10","revision":"9ed98841dea7be2fa3796e1c6d3bd8a876c235d6","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/10","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1515176139,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515165429,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515166180,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515170485,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515175541,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"SUBM","value":"1","grantedOn":1515176158,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":96,"deletions":-73},{"file":"lib/zk.js","type":"ADDED","insertions":44,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":139,"deletions":-155},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":351,"sizeDeletions":-292},"patchSets":[{"number":"1","revision":"e5ab2c3f25ea4f40b5c794cd09319b6ddd5b9cf2","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/1","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1513209266,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513209290,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":4,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":98,"deletions":-64},{"file":"lib/zk.js","type":"ADDED","insertions":45,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":162,"deletions":-135},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":13,"deletions":-17}],"sizeInsertions":366,"sizeDeletions":-258},{"number":"2","revision":"d9321f20690ce4eea64af5d6625069f8430b15c8","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/2","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1513209552,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513209576,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/watch.js","line":135,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"missing \u0027n\u0027 in corresponding"},{"file":"lib/watch.js","line":135,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"lib/watch.js","line":186,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I know this is existing code, but it\u0027s less than ideal to traverse the results twice to filter out two different things. The nulls and duplicates could be filtered in the forEach traversal."},{"file":"lib/watch.js","line":186,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"muppet.js","line":62,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"How about moving this function definition prior to its use and giving it a name?"},{"file":"muppet.js","line":62,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"test/helper.js","line":1,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Should we update the copyright year? Should it also be Joyent rather than Mark Cavage?"},{"file":"test/helper.js","line":1,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"test/helper.js","line":7,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Does this module need \u0027use strict\u0027?"},{"file":"test/helper.js","line":7,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":98,"deletions":-64},{"file":"lib/zk.js","type":"ADDED","insertions":45,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":162,"deletions":-135},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":13,"deletions":-17}],"sizeInsertions":364,"sizeDeletions":-258},{"number":"3","revision":"a4b679b4e7ed9a73d2c1849606f9be5fe520eba2","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/3","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1513298259,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513298310,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"muppet.js","line":271,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Is this nested function necessary or useful? Seems like it could just use the statements without the wrapping function."},{"file":"muppet.js","line":271,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"muppet.js","line":294,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Why add another `failed` event handler here?"},{"file":"muppet.js","line":294,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":101,"deletions":-68},{"file":"lib/zk.js","type":"ADDED","insertions":45,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":166,"deletions":-138},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":384,"sizeDeletions":-270},{"number":"4","revision":"663fe4e409e3220b2081117c924361f7bb482921","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/4","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1513713826,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513713865,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":101,"deletions":-68},{"file":"lib/zk.js","type":"ADDED","insertions":45,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":183,"deletions":-151},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":401,"sizeDeletions":-283},{"number":"5","revision":"0e75fada92f46b3f18417e322165ff2380629df2","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/5","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1513731059,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513731083,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1513787465,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1513787465,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"comments":[{"file":"lib/watch.js","line":82,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is it common across this codebase to explicitly pass null in a non-error callback? I tend to just use `cb()`, and it seems a few other places in this code does, too."},{"file":"lib/watch.js","line":82,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Whenever I changed the code, I preferred to be explicit about whether there was an error or not.  This was mostly the good of the reader and myself.  I can change it back to cb() if that is the preferred style."},{"file":"lib/watch.js","line":82,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"So long as lint and style checking doesn\u0027t flag this then I think we can take it that this is fine. I don\u0027t personally have a major problem with this."},{"file":"lib/watch.js","line":121,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The following comes from my lack of understanding between the old and new ZooKeeper library we\u0027re using, so apologies if it doesn\u0027t make sense.\n\nIs this something that\u0027s changed in the ZooKeeper library we\u0027re using? That is, are the \"children\" and \"childrenChanged\" events from the library equivalent?\n\nWithout knowing the differences and only going by name, it feels like we might either:\n\n1. Drop the first event when starting a watch (because there hasn\u0027t been a change)\n2. Only see events when the list has changed\n\nSpecifically for 2, is that a problem? It seems like it would make sense, but I don\u0027t know if the rest of the code assumes we _always_ get an event, even if somehow it\u0027s fired with no changes."},{"file":"lib/watch.js","line":121,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"The names are equivalent from \u0027children\u0027 in zkplus to \u0027childrenChanged\u0027 in zkstream.  Your #2 is what we will see, and what we want.  No action will be taken if the config we have is what is sent.  Even in the case of starting up, we won\u0027t automatically restart haproxy if our config hasn\u0027t changed."},{"file":"lib/watch.js","line":121,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Thanks clearing that up for me!"},{"file":"lib/watch.js","line":186,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Given that the comment above refers to dropping duplicates, is \"uniqHost\" an appropriate name for this function? My understanding is that they\u0027re not guaranteed to be unique."},{"file":"lib/watch.js","line":186,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"That was sort of my point.  This little function makes sure the returned list is a list of unique hosts.  The original list might be [a, a, null, b, null, b, b] and it would return [a, b]"},{"file":"lib/watch.js","line":186,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Ah, I understand. If I read it as \"uniqifyHost\" then I think we\u0027re on the same page.\n\nIn this case it\u0027s nothing major, so I don\u0027t think it\u0027s worth changing."},{"file":"lib/watch.js","line":205,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like we could do without this log entry given the new one above (that contains more data)."},{"file":"lib/watch.js","line":205,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Ah yes, you are correct, will remove."},{"file":"lib/watch.js","line":205,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"lib/zk.js","line":13,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Does this function need to accept a callback? It looks like it\u0027s all synchronous calls here."},{"file":"lib/zk.js","line":13,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"I\u0027m going to chalk this up to my confusion about how nodejs\u0027 objects/classes work. Beneath zkstream.Client creation is a lot of async code. In this case, zkstream uses cueball to start up the zk connections. Registrar did the same then when switching to zkstream https://cr.joyent.us/#/c/2826/1..20/lib/index.js so that won the battle in my mind on how to structure this. I\u0027m happy to be corrected as JS\u0027s OO model is maddening to me."},{"file":"lib/zk.js","line":13,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I believe it\u0027s because the zkstream is an EventEmitter (somewhere in the depth of its code/dependencies), so when we create the client with \"new\", nothing happens until it emits an event saying it\u0027s ready (in our case it looks like a \"session\" event, on which we start \"watcher()\").\n\nCheck out how binder creates this connection, then later does a thing on \"session\": https://github.com/joyent/binder/blob/595814295b75e9cb5b0e6d774060e0910d6e376e/lib/zk.js#L25\n\nI don\u0027t think it\u0027s major, but if you\u0027re up for it then this could be made synchronous by just returning the zkstream.Client (mostly because I figure given that this function doesn\u0027t plan on returning an asynchronous error in its current state), but I won\u0027t hold out on a CR+1 if this function stays as is."},{"file":"lib/zk.js","line":13,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Thanks, I will change it."},{"file":"lib/zk.js","line":13,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"},{"file":"muppet.js","line":11,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Are we required to make use of \"use strict\" and \"const\"? According to RFD59, sdc-vmapi (among others) are running node v4 and still use \"var\"."},{"file":"muppet.js","line":11,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"We aren\u0027t required to do it, I just wanted to make the code safer, efficient, and more explicit. To use const, you must `use strict`, otherwise const reassignment is silently ignored with no error or warning (crazy, I know).  I would\u0027ve replaced the remaining `var` calls with `let`, but our code checker didn\u0027t support `let` when I made those changes."},{"file":"muppet.js","line":11,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Understood, thanks for the details.\n\nI\u0027m tempted to suggest sticking to \"var\" here just to get us onto v4, then take discussion to joyent/eng in making sure our lint config can handle this particular issue. As far as I\u0027m aware, any reassignment using \"var\" is covered with our linter, but if there are other dangerous pieces that are missing then we should definitely update our config.\n\nWhat do you think? It\u0027ll bring the patch size down (not a big deal), and it means discussion on this won\u0027t block this change. Unless there\u0027s something else I\u0027m missing here that using \"const\" buys us?"},{"file":"muppet.js","line":11,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Ah yes, `const` is mostly there for an optimization. Though our linter protects against reassignment with `var`, the compiler doesn\u0027t know that.  `const` gives the compiler a hint that it won\u0027t be changed so it can treat it differently.  In addition `const` is block scoped rather than function scoped."},{"file":"muppet.js","line":11,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Great, thanks for clearing that up for me.\n\nIt sounds like \"const\" is actually what we want in projects using Node v4  (and up), so would you mind creating a ticket to get our linter up to speed on this? I would guess that\u0027s an issue in https://github.com/joyent/eng, but I\u0027ve also seen a handful of tickets in the TOOLS project in JIRA."},{"file":"muppet.js","line":29,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is there a particular reason for no using forkexec here instead?"},{"file":"muppet.js","line":29,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"There is no forkexec in node4 that I\u0027m aware of. This will be removed anyway when I remove the restart code."},{"file":"muppet.js","line":29,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"It looks like we do a \"forkexec.forkExecWait\" later on in the code (L47 with this change). \"forkexec\" is an npm module (https://github.com/joyent/node-forkexec), but I\u0027m not sure of any reason why it wouldn\u0027t work on node v4.\n\nIn any case, if this is going away, no worries."},{"file":"muppet.js","line":29,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":101,"deletions":-68},{"file":"lib/zk.js","type":"ADDED","insertions":45,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":183,"deletions":-151},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":401,"sizeDeletions":-283},{"number":"6","revision":"b597e30a2c0275a4773a6dc675e01ac6045ebbbc","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/6","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1515089291,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515089315,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":96,"deletions":-73},{"file":"lib/zk.js","type":"ADDED","insertions":44,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":139,"deletions":-155},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":351,"sizeDeletions":-292},{"number":"7","revision":"ff297823baf9a30c2d6a0d6615e7d495f3656386","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/7","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1515089635,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515089658,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/watch.js","line":217,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is this a method we still want? I don\u0027t know if it\u0027s used, and zkstream doesn\u0027t document a stop() method on its watcher, but I guess we could at least drop all listeners if we want to stop watching.\n\nI can\u0027t see a reason why we\u0027d ever want to stop watching in Muppet\u0027s current state, but just want to make sure we definitely don\u0027t want this any more."},{"file":"lib/watch.js","line":217,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"I removed it in the latest patch. Another carry over from zkplus days. We did call it during the other restart method that was removed."},{"file":"muppet.js","line":290,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I understand this to be the line that will put us into maintenance if there are no ZooKeeper servers available for long enough. Do we want to remove this to prevent us going into maintenance?\n\nI\u0027m not actually sure what is expected of us in this \"failed\" event. Does zkstream expect Muppet to create a new client? Or can we tell zkstream to retry forever, essentially meaning we won\u0027t see this \"failed\" event? I don\u0027t know enough about zkstream/cueball to advise here, but my understanding of this current state is that we\u0027d still go into maintenance if there are no ZooKeeper servers available for an extended period of time.\n\nReading over the zktsteam docs/code, I expect Muppet would need to tear down and create a new client in the event of this \"failed\" event. Perhaps Alex can advise here? What does binder do (which is perhaps a daft question because zkstream there would connect to a localhost ZooKeeper server)?"},{"file":"muppet.js","line":290,"reviewer":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"message":"Yes, so it would hit this if we have no ZK servers at all for a while. Cueball and zkstream would have both gone through their retry policies. Talking with Alex and Josh while I was in SF it seemed like the case where we\u0027d want to stop here. SMF would restart us a few times, (which would create new clients) for one last hurrah, but then we\u0027d go into maintenance.  That is the right course of action in the case that we can\u0027t do anything of value. Haproxy would still be running with its current config, and with no ZK, we have nothing to do.  When ZK came back up (by an Operator most likely), muppet would also be brought up."},{"file":"muppet.js","line":290,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Understood. It sounds like there\u0027s been prior discussion on this, so I don\u0027t want to make this a stickler for review in that case.\n\nThis is an improvement on the current situation because it\u0027s a fairly loud thing to do and will be obvious to an operator that we\u0027ve stopped Muppet (alarms, `svcs -xv`, etc.), as opposed to silently stopping the watch (today).\n\nI would personally argue that Muppet could do with its own retry mechanism that would try and re-create a zkstream client forever on \"failed\" at some low frequency (every few minutes or so?) or be able to pass this through as an option to zkstream/cueball, but I\u0027d be happy for that to be covered in a separate ticket. Ultimately, if the Christmas issue happened with this change in place, it would still require operator intervention (assuming the ZooKeeper servers were down for long enough), but at least it would have been fairly obvious what had happened.\n\nI think it might be good to have this corresponding error message mention that we\u0027re exiting on the \"failed\" event, and also be at level \"fatal\". I know it\u0027ll be obvious in SMF logs what\u0027s happening, but for our alarming it might be beneficial to including a descriptive message so that anyone viewing from that perspective has the right info."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":96,"deletions":-73},{"file":"lib/zk.js","type":"ADDED","insertions":44,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":139,"deletions":-155},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":351,"sizeDeletions":-292},{"number":"8","revision":"f4fea24a048507847c47dee770bbeed94efd7ccc","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/8","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1515165404,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515165429,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":96,"deletions":-73},{"file":"lib/zk.js","type":"ADDED","insertions":44,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":139,"deletions":-155},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":351,"sizeDeletions":-292},{"number":"9","revision":"71ab517cbe5d86da77313e7438eaa9580316d3d1","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/9","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1515165984,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515165429,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515166180,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515170485,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515175541,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":96,"deletions":-73},{"file":"lib/zk.js","type":"ADDED","insertions":44,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":139,"deletions":-155},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":351,"sizeDeletions":-292},{"number":"10","revision":"9ed98841dea7be2fa3796e1c6d3bd8a876c235d6","parents":["66b2bf12d7e8eaedc12693bc877cbfe80d4ba054"],"ref":"refs/changes/10/3110/10","uploader":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"createdOn":1515176139,"author":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515165429,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515166180,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1515176158,"by":{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515170485,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515175541,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":12,"deletions":0},{"file":"Makefile","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"lib/index.js","type":"MODIFIED","insertions":4,"deletions":-3},{"file":"lib/lb_manager.js","type":"MODIFIED","insertions":32,"deletions":-28},{"file":"lib/watch.js","type":"MODIFIED","insertions":96,"deletions":-73},{"file":"lib/zk.js","type":"ADDED","insertions":44,"deletions":0},{"file":"muppet.js","type":"MODIFIED","insertions":139,"deletions":-155},{"file":"package.json","type":"MODIFIED","insertions":5,"deletions":-5},{"file":"sapi_manifests/muppet/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/muppet/template","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"sapi_manifests/registrar/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"sapi_manifests/ssl_cert/manifest.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/helper.js","type":"MODIFIED","insertions":26,"deletions":-22}],"sizeInsertions":351,"sizeDeletions":-292}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Jared Morrow","email":"jm@joyent.com","username":"jaredmorrow"}]}