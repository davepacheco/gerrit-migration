From ae85376c679c624e3f4176d5733fbfa4452589a9 Mon Sep 17 00:00:00 2001
From: rhb2 <robert.bogart@joyent.com>
Date: Fri, 30 Aug 2019 05:15:28 +0000
Subject: [PATCH] MANTA-4523 Rebalancer Agent requires uuid to accompany list
 of tasks when posting an assignment.

---
 src/agent.rs | 62 +++++++++++++++++++++++++++++++++++++++++++---------
 1 file changed, 52 insertions(+), 10 deletions(-)

diff --git a/src/agent.rs b/src/agent.rs
index 6eccf73..a8b35cb 100644
--- a/src/agent.rs
+++ b/src/agent.rs
@@ -34,6 +34,7 @@ use crate::jobs::TaskStatus;
 
 use reqwest::StatusCode;
 use rusqlite;
+use serde_json::Value;
 use serde_derive::{Deserialize, Serialize};
 use threadpool::ThreadPool;
 use uuid::Uuid;
@@ -372,8 +373,15 @@ fn post(agent: Agent, mut state: State) -> Box<HandlerFuture> {
             Ok(valid_body) => {
                 // Ceremony for parsing the information needed to create an
                 // an assignent out of the message body.
-                let v = validate_assignment(&valid_body).unwrap();
-                let uuid = Uuid::new_v4().to_hyphenated().to_string();
+                let (uuid, v) = match validate_assignment(&valid_body) {
+                    Ok(uv) => uv,
+                    Err(_e) => {
+                        let res = create_empty_response(&state,
+                            StatusCode::BAD_REQUEST);
+                        return future::ok((state, res));
+                    },
+                };
+
                 let assignment =
                     Arc::new(RwLock::new(Assignment::new(v, &uuid)));
 
@@ -478,16 +486,26 @@ fn get_assignment(
     Box::new(future::ok((state, res)))
 }
 
-fn validate_assignment(body: &Chunk) -> Result<Vec<Task>, String> {
+fn validate_assignment(body: &Chunk) -> Result<(String, Vec<Task>), String> {
     let data = String::from_utf8(body.to_vec()).unwrap();
 
-    let v = match serde_json::from_str(&data) {
+    let v: Value = match serde_json::from_str(&data) {
         Ok(v) => v,
         Err(e) => return Err(format!("Failed to deserialize: {}", e)),
     };
 
-    let assignment: Vec<Task> = serde_json::from_value(v).unwrap();
-    Ok(assignment)
+    let assignment: Vec<Task> = match serde_json::from_str(
+        v["tasks"].as_str().unwrap()) {
+        Ok(tasks) => tasks,
+        Err(e) => return Err(format!("Task list: {}", e)),
+    };
+
+    let uuid : String = match v["uuid"].as_str() {
+        Some(u) => u.to_string(),
+        _ => return Err(format!("Missing uuid in assignment.")),
+    };
+
+    Ok((uuid, assignment))
 }
 
 impl Handler for Agent {
@@ -828,8 +846,28 @@ mod tests {
         assignment: Arc<RwLock<Assignment>>,
     ) -> String {
         let tasks = &assignment.read().unwrap().tasks;
+
+        // Encode our list of tasks as one monolithic string representing a
+        // JSON object.
+        let ser_tasks = serde_json::to_string(&tasks)
+            .expect("serialized tasks");
+
+        // Generate a uuid to accompany the assignment that we are about to
+        // send to the agent.
+        let uuid = Uuid::new_v4().to_hyphenated().to_string();
+
+        // Instantiate a HashMap that will contain two parts.  One, the uuid
+        // of the the assignment (indexed by the field "uuid") and the
+        // encoded list of tasks for our assignment (indexed by the field
+        // "tasks".
+        let mut obj = HashMap::new();
+        obj.insert("tasks".to_string(), ser_tasks);
+        obj.insert("uuid".to_string(), uuid.clone());
+
+        // Finally, serialize the entire HashMap before stuffing it in the
+        // message body.
         let body: Vec<u8> =
-            serde_json::to_vec(tasks).expect("Serialized assignment");
+            serde_json::to_vec(&obj).expect("Serialized assignment");
 
         let response = test_server
             .client()
@@ -845,13 +883,17 @@ mod tests {
 
         let body = response.read_body().unwrap();
         let data = String::from_utf8(body.to_vec()).unwrap();
-        let uuid: String = match serde_json::from_str(&data) {
+        let resp_uuid: String = match serde_json::from_str(&data) {
             Ok(s) => s,
             Err(e) => panic!(format!("Error: {}", e)),
         };
 
-        println!("response: {:?}", uuid);
-        uuid.to_string()
+        println!("Response: {:?}", resp_uuid);
+
+        // Perhaps it is overkill, but check to ensure that the uuid given
+        // back to us matches what we actually sent.
+        assert_eq!(uuid, resp_uuid);
+        resp_uuid.to_string()
     }
 
     // Given a path of an assignment on disk, load it in to memory.  If for
-- 
2.21.0

