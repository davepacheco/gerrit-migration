{"project":"joyent/sdc-cloudapi","branch":"master","id":"I6524045a0dce3f5603b579894296920435f18952","number":"3131","subject":"PUBAPI-1081 Enable requesting IP addresses on networks when provisioning or adding nics Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"url":"https://cr.joyent.us/3131","commitMessage":"PUBAPI-1081 Enable requesting IP addresses on networks when provisioning or adding nics\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1513900698,"lastUpdated":1515202011,"open":false,"status":"MERGED","comments":[{"timestamp":1513900698,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 1."},{"timestamp":1513900729,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1513981770,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(29 comments)"},{"timestamp":1514490467,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 1:\n\n(29 comments)"},{"timestamp":1514490479,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 2."},{"timestamp":1514490510,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514490527,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 3."},{"timestamp":1514490559,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514490620,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3:\n\nDocs and version bump will come in another patch set."},{"timestamp":1514495457,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\n(8 comments)"},{"timestamp":1514506932,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3:\n\n(21 comments)"},{"timestamp":1514593842,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3:\n\n(28 comments)"},{"timestamp":1514593855,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 4."},{"timestamp":1514593886,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514593949,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 3:\n\nTest\u0027s have not been updated to reflect the new error messages.\nOnce we come to a consensus I will update them.\n\nThere\u0027s still an open question in lib/machines.js regarding how to wrap the error from vmapi which could actually be from napi."},{"timestamp":1514666834,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(4 comments)"},{"timestamp":1514675671,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 5."},{"timestamp":1514675680,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 4:\n\n(3 comments)"},{"timestamp":1514675703,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514687332,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(2 comments)"},{"timestamp":1514701455,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 6."},{"timestamp":1514701486,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514704611,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 7: Patch Set 6 was rebased."},{"timestamp":1514704642,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1514704683,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 8."},{"timestamp":1514704713,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514705076,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(5 comments)"},{"timestamp":1514751318,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1514767193,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 8:\n\n(7 comments)"},{"timestamp":1514767243,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 9."},{"timestamp":1514767274,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1514767541,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 9:\n\n(1 comment)"},{"timestamp":1514916841,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 9:\n\n(3 comments)"},{"timestamp":1514922896,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 9:\n\n(2 comments)"},{"timestamp":1514930078,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 9:\n\n(5 comments)"},{"timestamp":1514958016,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 9:\n\n(10 comments)"},{"timestamp":1514958100,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 10."},{"timestamp":1514958132,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515001886,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 10:\n\n(3 comments)"},{"timestamp":1515002807,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 10:\n\n(3 comments)"},{"timestamp":1515002812,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 11."},{"timestamp":1515002844,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 11: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515002993,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 11: Code-Review+1"},{"timestamp":1515025086,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 11:\n\n(15 comments)"},{"timestamp":1515108652,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 11:\n\n(15 comments)"},{"timestamp":1515108667,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 12."},{"timestamp":1515108698,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 12: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515111797,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 12:\n\n(4 comments)"},{"timestamp":1515114323,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 13."},{"timestamp":1515114330,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 11:\n\n(2 comments)"},{"timestamp":1515114355,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 13: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515116681,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 13:\n\n(1 comment)"},{"timestamp":1515195418,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 14."},{"timestamp":1515195449,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 14: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515196503,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 15."},{"timestamp":1515196534,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 15: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515198200,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 15:\n\n(3 comments)"},{"timestamp":1515201007,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Patch Set 15:\n\n(3 comments)"},{"timestamp":1515201029,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 16."},{"timestamp":1515201060,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 16: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1515201610,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 16: Code-Review+1 Integration-Approval+1"},{"timestamp":1515201984,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Uploaded patch set 17: Commit message was updated."},{"timestamp":1515202011,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Michael Zeller"}],"currentPatchSet":{"number":"17","revision":"6524045a0dce3f5603b579894296920435f18952","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/17","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515201984,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201060,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201610,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515201610,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1515202011,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":72,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":85,"deletions":-26},{"file":"lib/nics.js","type":"MODIFIED","insertions":124,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":378,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1010,"sizeDeletions":-79},"patchSets":[{"number":"1","revision":"d0d24e46edb4436dbb61e0003e653b3ff5d35799","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/31/3131/1","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1513900698,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1513900729,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/machines.js","line":467,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Do we use an array because we plan to eventually support specifying more than one ip for a given machine on a given network?"},{"file":"lib/machines.js","line":467,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Yep that\u0027s the plan.  The nic will also eventually support ipv4 and ipv6, hence the ipv4_ prefix everywhere.\n\nMore info https://github.com/joyent/sdc-vmapi/blob/master/docs/index.md#specifying-networks-for-a-vm"},{"file":"lib/machines.js","line":491,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why use an underscore to prefix the variable name \"_net\"? Is that common in this code base?"},{"file":"lib/machines.js","line":491,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I believe at one point I had a \"net\".  But this will be cleaned up in the next patch set which moves this block of code to a common location."},{"file":"lib/machines.js","line":586,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should this comment be updated to mention ipv4_ips?"},{"file":"lib/machines.js","line":586,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":593,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"else we don\u0027t need to set ipv4_count? Why?"},{"file":"lib/machines.js","line":593,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Same doc link I posted above.  tl;dr in the future nic\u0027s will support ipv4 and ipv6 networks as well as multiple ips on those networks.  If you don\u0027t care about which ips you get a count can be used.  Today vmapi only accepts a count of 1."},{"file":"lib/machines.js","line":1546,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback, helps with post-mortem debugging."},{"file":"lib/machines.js","line":1546,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1564,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback (helps with post-mortem debugging)."},{"file":"lib/machines.js","line":1564,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1604,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback."},{"file":"lib/machines.js","line":1604,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1606,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What\u0027s the purpose of this?"},{"file":"lib/machines.js","line":1606,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Trent suggested that we don\u0027t pass back the raw napi error to cloudapi consumers, and that we should translate it like we do for other errors.  I am also going to modify this message so we no longer leak zone uuid\u0027s on shared networks.  Theres a napi ticket open to include the ip in the error so we can be more helpful in the future.\n\nexample napi error:\n{\n  \"code\": \"InvalidParameters\",\n  \"message\": \"Invalid parameters\",\n  \"errors\": [\n    {\n      \"type\": \"zone\",\n      \"id\": \"aed36f3a-8f52-44e8-988d-d057dba10cef\",\n      \"code\": \"UsedBy\",\n      \"message\": \"IP in use by zone \\\"aed36f3a-8f52-44e8-988d-d057dba10cef\\\"\",\n      \"field\": \"ip\"\n    }\n  ]\n}"},{"file":"lib/nics.js","line":148,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: assert on what properties we expect on \"netObj\"."},{"file":"lib/nics.js","line":148,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Can\u0027t assert on these properties.  The checks below are to validate user input."},{"file":"lib/nics.js","line":153,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: Ideally it\u0027d be nice to be able to report all errors, not just the first error. This can be a follow-up ticket though if we agree."},{"file":"lib/nics.js","line":153,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I agree that it might be worth while to loop over each network object and do this basic check and return a verror multierror with everything we catch up front."},{"file":"lib/nics.js","line":178,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Could that block of code be factored out in a function in order to avoid code duplication with the same code in lib/machines.js?"},{"file":"lib/nics.js","line":178,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I ended up doing this.\nThe only odd thing now is that we have to modify the errors returned after the fact to clue the user in better on what field had an issue.  Perhaps you will have a suggestion there once you see the updated code."},{"file":"lib/nics.js","line":422,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I think it\u0027s fine to use \"arg\" (the name used in examples provided by vasync in its documentation IIRC) instead of \"notUsed\" and remove that comment."},{"file":"lib/nics.js","line":422,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"The linter is complaining for me.  I asked in chat and was told told to file a ticket for that issue to be fixed."},{"file":"lib/nics.js","line":427,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback."},{"file":"lib/nics.js","line":427,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":433,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What\u0027s the purpose of this?"},{"file":"lib/nics.js","line":433,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"See comment in machines.js"},{"file":"lib/nics.js","line":442,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: maybe worth bumping to an \"info\" level?"},{"file":"lib/nics.js","line":442,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":448,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I think it\u0027s fine to use \"arg\" (the name used in examples provided by vasync in its documentation IIRC) instead of \"notUsed\" and remove that comment."},{"file":"lib/nics.js","line":448,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Same comment as in machines.js"},{"file":"lib/nics.js","line":450,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: change to assert.string?"},{"file":"lib/nics.js","line":450,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":452,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback."},{"file":"lib/nics.js","line":452,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.70.test.js","line":36,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is that addition still relevant? It doesn\u0027t seem to be used anywhere."},{"file":"test/machines.70.test.js","line":36,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"cleaned up."},{"file":"test/machines.80.test.js","line":72,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: prefix the name with a substring that identifies the test, such as \"machines-8-0-test-network-owned\u0027 so that when  multiple tests in the codebase create a test network, we can grep easily through the code base if we find a leftover network with that name in a DC when investigating test failures."},{"file":"test/machines.80.test.js","line":72,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.80.test.js","line":109,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Do we also want to maybe check that the VM\u0027s nic is actually created with the correct IP?\n\nIn addition to that, should we write this test in a way we can actually ping that VM on that IP to make sure that it actually works?"},{"file":"test/machines.80.test.js","line":109,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"This will be done in the updated test.\n\nI think pinging is out of the scope for this test."},{"file":"test/machines.80.test.js","line":115,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Where is \"MACHINE_UUID\" compared with \"false\" to not run machine tests?\n\nIt seems that having a variable that is either a UUID or a boolean value of false is a bit convoluted. Why not just use another variable?"},{"file":"test/machines.80.test.js","line":115,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Test was in the wrong place.  Should be good now."},{"file":"test/machines.80.test.js","line":118,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: generally I find using \"err\", \"err2\", \"errN\" names for variables representing error objects to be error prone.\n\nI find using names such as \"delNetworkErr\" more readable."},{"file":"test/machines.80.test.js","line":118,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":353,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"All the tests added in this file make sure that machine creation where we pass an IP always fails. Is there a use case for which we want it to succeed?\n\nIf so, should a test for those use cases be present here?"},{"file":"test/machines.test.js","line":353,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"That\u0027s what the test in machines.80.test.js is.  I am moving it inside of this test file because its the better place for it."},{"file":"test/machines.test.js","line":355,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What makes this network public?"},{"file":"test/machines.test.js","line":355,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Having owner_uuids be set to an empty array."},{"file":"test/machines.test.js","line":409,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"The test title is \"CreateMachine using network *and ip*\" but it seems we only set a network in \"vmDetails\", not an ip.\n\nWhat am I missing?"},{"file":"test/machines.test.js","line":409,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"This is meant to be the test from machines.80,  I will get this cleaned up."},{"file":"test/nics.test.js","line":1712,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Are we sure that \"fabricNetwork\" is an object here?"},{"file":"test/nics.test.js","line":1712,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Yes because it came from /my/networks.  If that endpoint ever returns something that\u0027s not an object we probably have a bigger issue."},{"file":"test/nics.test.js","line":1712,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What I mean is: what if no network object in \"networks\" passes the filter? \"fabricNetwork\" would end up \"undefined\", and accessing the property \"fabricNetwork.id\" would throw an error."},{"file":"test/nics.test.js","line":1790,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Are we sure that \"fabricNetwork\" is never \"undefined\" here?"},{"file":"test/nics.test.js","line":1790,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Hmm the test only runs if fabrics are enable, but that doesn\u0027t guarantee there is a fabric network.\n\nHowever, the \" Add fabric network NIC\" test that already exists assumes the same thing, which is where I borrowed some of the logic from."},{"file":"test/nics.test.js","line":1794,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: In general I prefer not using names such as \"err2\", \"req2\" and \"res2\" because it makes the code difficult to read.\n\nInstead, I\u0027d use names such as \"nicCreateErr\", \"nicCreateReq\" and \"nicCreateRes\"."},{"file":"test/nics.test.js","line":1794,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":134,"deletions":-19},{"file":"lib/nics.js","type":"MODIFIED","insertions":183,"deletions":-22},{"file":"test/machines.70.test.js","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"test/machines.80.test.js","type":"MODIFIED","insertions":59,"deletions":0},{"file":"test/machines.test.js","type":"MODIFIED","insertions":258,"deletions":0},{"file":"test/nics.test.js","type":"MODIFIED","insertions":190,"deletions":0}],"sizeInsertions":827,"sizeDeletions":-42},{"number":"2","revision":"eac977e87e89341341a1ea4bc08ffc6b193e6fa1","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/31/3131/2","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514490479,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514490510,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":93,"deletions":-24},{"file":"lib/nics.js","type":"MODIFIED","insertions":132,"deletions":-22},{"file":"test/machines.70.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.test.js","type":"MODIFIED","insertions":339,"deletions":-2},{"file":"test/nics.test.js","type":"MODIFIED","insertions":191,"deletions":0}],"sizeInsertions":756,"sizeDeletions":-49},{"number":"3","revision":"5bc2380a6b2e9edf66788affcbd54bc9d46483e2","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/31/3131/3","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514490527,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514490559,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/machines.js","line":454,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: in general I avoid *throwing* errors from functions that return operational errors instead of programmer errors.  So in this case I\u0027d prefer that \"validateNetworkObject\" *return* an error.\n\nIn this case I think it\u0027s not a big deal, but it\u0027d be more consistent with what we use in other code bases."},{"file":"lib/machines.js","line":454,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":457,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Due*"},{"file":"lib/machines.js","line":457,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":459,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can we achieve the same goal of having an explicit error message without having to augment the error messages returned by \"validateNetworkObject\"? For instance, if the error message returned by \"validateNetworkObject\" include the network name, or any other property that could identify the problematic network object parameter, wouldn\u0027t that be enough?"},{"file":"lib/machines.js","line":459,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Feedback appreciated on the new returned errors."},{"file":"lib/machines.js","line":1495,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback for post-mortem debugging."},{"file":"lib/machines.js","line":1495,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1522,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"since nothing is done here besides the callback being called, you could replace the entire highlighted code with \"cb\""},{"file":"lib/machines.js","line":1522,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1555,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027d prefer this to be explicit, i.e.:\n\n \u0026\u0026 body.errors.length \u003e 0"},{"file":"lib/machines.js","line":1555,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1560,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is having an ip in use the _only_ case where the response from VMAPI is an \"InvalidParametersError\" with an \"ip\" field present?\n\nWould using \"vmapiErrorWrap\" (https://github.com/joyent/sdc-cloudapi/blob/b04b26e710a40794f8f7e87cf0cc905da38bd29f/lib/errors.js#L278-L304) instead be more future-proof?"},{"file":"lib/machines.js","line":1560,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Fixed it to check for UsedBy parameter. \n\nHowever, the error coming back from vmapi may actually be returning a napi error.  What\u0027s the best way to handle that since the wrapper is for a specific api."},{"file":"lib/machines.js","line":1560,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e However, the error coming back from vmapi may actually be returning a napi error. What\u0027s the best way to handle that since the wrapper is for a specific api.\n\nI don\u0027t understand your question, let\u0027s move that part of the discussion to Mattermost if time permits."},{"file":"lib/nics.js","line":48,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: declaration should be in alphabetic order, so after \"restify\" and before \"vasync\"."},{"file":"lib/nics.js","line":48,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"no longer needed."},{"file":"lib/nics.js","line":49,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I personally don\u0027t like calling this `sprintf` since util.format is not as full featured nor compatible with sprintf."},{"file":"lib/nics.js","line":49,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"no longer needed."},{"file":"lib/nics.js","line":164,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as the previous usage of \"validateNetworkObject\" in this CR."},{"file":"lib/nics.js","line":164,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"See other response."},{"file":"lib/nics.js","line":368,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: I would remove this comment, since \"_\" is not present anymore in this code block."},{"file":"lib/nics.js","line":368,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":377,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"same as before where this should explicitly be checked as \u0027length \u003e 0\u0027"},{"file":"lib/nics.js","line":377,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":381,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same question as before: is having an IP in use the *only* use case when NAPI would return an \"InvalidParametersError\" with an \"ip\" field\"?\n\nRegardless, would it make sense to create/use a \"napiErrorWrap\" function instead similar to the existing \"*ErrorWrap\" functions found in lib/errors.js?"},{"file":"lib/nics.js","line":381,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I added a napiErrorWrap.  See other comment for additional feedback."},{"file":"lib/nics.js","line":396,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above re: \"_\"."},{"file":"lib/nics.js","line":396,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":397,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027ve personally used \"__\" (double underscore) but it\u0027s lame"},{"file":"lib/nics.js","line":397,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: I would declare \"validateIp\" *before* \"provisionNic\" to improve readability, since \"validateIp\" would run *before* \"provisionNic\" as part of the vasync pipeline."},{"file":"lib/nics.js","line":397,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":397,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":431,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"The highlighted area can be replaced with \"cb\""},{"file":"lib/nics.js","line":431,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/validation/networks.js","line":13,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: I would remove this blank line, because \"util\" is an external module, but not a big deal."},{"file":"lib/validation/networks.js","line":13,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.70.test.js","line":153,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"remove - this file shouldn\u0027t be modified by this CR (AFAIK)"},{"file":"test/machines.70.test.js","line":153,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":14,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: blank line before external modules and other declarations (like requiring internal modules)."},{"file":"test/machines.test.js","line":14,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":357,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: rename to \"machines-test-network-fake-public\" to convey that this network was created by this file."},{"file":"test/machines.test.js","line":357,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":383,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: instead of \"err2\", use a variable name that convey what this error represents (e.g \"machineCreateErr\")?"},{"file":"test/machines.test.js","line":383,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":392,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: same as above, use a name that is more self-explanatory than \"err3\"."},{"file":"test/machines.test.js","line":392,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":499,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why set MACHINE_UUID to false instead of \"undefined\"?"},{"file":"test/machines.test.js","line":499,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"That\u0027s what I meant to do, however the test has been moved lower to avoid issues with the first CreateMachine and the line is not actually needed."},{"file":"test/machines.test.js","line":578,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: use \"machines-test-network-pool-fake-1\" to make it clearer that this network pool was created from tests in this file?"},{"file":"test/machines.test.js","line":578,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":1232,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Why does this number need to be increased?"},{"file":"test/machines.test.js","line":1232,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"The location of my test messed up a few other tests.  It has since been moved below these tests to avoid issues."},{"file":"test/nics.test.js","line":1711,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can fabricNetwork be undefined here because networks.filter above did not match any fabric network, and thus returned an empty array?"},{"file":"test/nics.test.js","line":1711,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"That would be true. Another preexisting test makes the same assumption.  Since fabrics have to be enabled for us to hit this test we are safe on that front.  I also believe that when the CLIENT is setup, we create a default fabric network for new accounts but I am not 100% sure on that one."},{"file":"test/nics.test.js","line":1711,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"That is correct. However, if any of these guarantees/assumptions change, then the failure mode is a crash of the process that runs tests, which would prevent running all other tests. This is a bit annoying e.g when running nightly tests, since we can\u0027t know whether any other test would have failed.\n\nBy checking that \"fabricNetwork\" is not null or undefined before accessing any of its properties, the failure mode would be a test not passing, and all subsequent tests would be allowed to run.\n\nIt\u0027s not a big deal though, I wouldn\u0027t consider that a blocker for this CR."},{"file":"test/nics.test.js","line":1785,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above re: fabricNetwork being undefined."},{"file":"test/nics.test.js","line":1785,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"See response above."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":93,"deletions":-24},{"file":"lib/nics.js","type":"MODIFIED","insertions":132,"deletions":-22},{"file":"lib/validation/networks.js","type":"ADDED","insertions":83,"deletions":0},{"file":"test/machines.70.test.js","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.test.js","type":"MODIFIED","insertions":339,"deletions":-2},{"file":"test/nics.test.js","type":"MODIFIED","insertions":191,"deletions":0}],"sizeInsertions":839,"sizeDeletions":-49},{"number":"4","revision":"fc58d2ece5c1a6e93fc933159da0550ba9d8db23","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/31/3131/4","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514593855,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514593886,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/validation/networks.js","line":38,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"you shouldn\u0027t need util.format as the restify errors (I believe) format arguments by default."},{"file":"lib/validation/networks.js","line":38,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/validation/networks.js","line":48,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Change this to `length !\u003d\u003d 1` as this will technically ignore empty arrays"},{"file":"lib/validation/networks.js","line":48,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/validation/networks.js","line":49,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"same as above re util.format"},{"file":"lib/validation/networks.js","line":49,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.70.test.js","line":138,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"put newline back if you want to remove this file from the diff"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":87,"deletions":-25},{"file":"lib/nics.js","type":"MODIFIED","insertions":125,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":91,"deletions":0},{"file":"test/machines.70.test.js","type":"MODIFIED","insertions":0,"deletions":-1},{"file":"test/machines.test.js","type":"MODIFIED","insertions":362,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":191,"deletions":0}],"sizeInsertions":885,"sizeDeletions":-68},{"number":"5","revision":"749c2b432bc50d1aece61fc938fa74c797cab5c9","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/31/3131/5","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514675671,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514675703,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":400,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: alphabetize this (napiErrorWrap before vmapiErrorWrap)."},{"file":"lib/errors.js","line":400,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1553,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"If there is more than one error if a field of \u0027ip\u0027 and a code of \"UsedBy\", then it seems only the last error will actually be sent in the response, is that correct? If so, is that acceptable?"},{"file":"lib/machines.js","line":1553,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"The UsedBy error is to inform you that the IP is already in use which is what this check is looking for.  I only expect one error because as vmapi processes the params.networks that are passed in it will return the first error it hits.  I could replace the forEach with [0] if you wish."},{"file":"lib/machines.js","line":1553,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\u003e I only expect one error because as vmapi processes the params.networks that are passed in it will return the first error it hits. \n\nI think it\u0027d be helpful to mention that in a comment.\n\n\u003e I could replace the forEach with [0] if you wish.\n\nI think that\u0027d make the code clearer. It might also be worth it to either warn or assert of there\u0027s more than one of those UsedBy errors."},{"file":"lib/nics.js","line":370,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Does \"cannot provision ip\" actually convey what\u0027s happening here? Would \"cannot validate IP\" be more representative?"},{"file":"lib/nics.js","line":401,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as in previous file: it seems that if there is more than one \"UsedBy\" error, then only the last one is kept."},{"file":"test/machines.test.js","line":435,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: should this test use an existing network UUID instead of a non-existing one in order to make sure that it fails due to the invalid number of IPs instead of potentially for the non-existence of the network?"},{"file":"test/machines.test.js","line":435,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I guess I am testing the implementation detail because I was the one who wrote it so I know the order in which things are processed.  You are right, let me see if there\u0027s an existing network uuid I can use instead."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":87,"deletions":-25},{"file":"lib/nics.js","type":"MODIFIED","insertions":125,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":91,"deletions":0},{"file":"test/machines.test.js","type":"MODIFIED","insertions":363,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":888,"sizeDeletions":-67},{"number":"6","revision":"7da2e918d50bd23f36db3615ca6b3ac16603ca02","parents":["01d386de765e6ffca8267fcee0ded9c44f9c4ef0"],"ref":"refs/changes/31/3131/6","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514701455,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514701486,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":87,"deletions":-25},{"file":"lib/nics.js","type":"MODIFIED","insertions":127,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":107,"deletions":0},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":363,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":913,"sizeDeletions":-74},{"number":"7","revision":"95579c280655635853b81c4b49d6cf404fcb0717","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/7","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514704611,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514701486,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/errors.js","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":87,"deletions":-25},{"file":"lib/nics.js","type":"MODIFIED","insertions":127,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":107,"deletions":0},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":363,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":913,"sizeDeletions":-74},{"number":"8","revision":"97ee265b89205218123d561228ce5ea257d5dac2","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/8","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514704683,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514704713,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/nics.js","line":167,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"should we assert.equal(ipv4_count, 1)? Is it a programming error to arrive at this logic where ipv4_count !\u003d 1?"},{"file":"lib/nics.js","line":167,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"ipv4_count is not documented.  I only left it in because previous tests checked for it.  In the future the plan is to support multiple IPs via the count or IPs array.  Therefore today count must be set to exactly 1 or the array must contain a single IP.  So its a useless parameter to inform users about in the documentation today since we will just default to a count of 1 if they omit the IPs array anyways."},{"file":"lib/validation/networks.js","line":86,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"No need for util.format"},{"file":"lib/validation/networks.js","line":86,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/validation/networks.js","line":91,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"No need for util.format"},{"file":"lib/validation/networks.js","line":91,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/validation/networks.js","line":96,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"No need for util.format"},{"file":"lib/validation/networks.js","line":96,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":29,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":87,"deletions":-25},{"file":"lib/nics.js","type":"MODIFIED","insertions":127,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":107,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":363,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":956,"sizeDeletions":-77},{"number":"9","revision":"804539f83a45b753f82afce4ddf5bd55a3ce1f17","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/9","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514767243,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514767274,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":914,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"This reads like CreateMachine and AddNic do not support passing a network UUID anymore, but I thought it now supported both network objects and passing a network UUID. Am I missing something?\n\n\"Prefer\" seems like a vague term. I\u0027d prefer if we mentioned what parameter is now supported, what is not supported anymore and what happens if both a network UUID and network objects are passed."},{"file":"docs/index.md","line":914,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"docs/index.md","line":4479,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Typo \"subent\" -\u003e \"subnet\"."},{"file":"docs/index.md","line":4479,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"docs/index.md","line":8795,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"\"netmask\" is now a network object?"},{"file":"docs/index.md","line":8795,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Thanks for catching this."},{"file":"docs/index.md","line":8804,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above regarding the use of the term \"prefers\"."},{"file":"docs/index.md","line":8804,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/errors.js","line":334,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Unnecessary newline addition"},{"file":"lib/errors.js","line":334,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1485,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: name callback."},{"file":"lib/machines.js","line":1485,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1505,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"it\u0027s*.\n\n\nHowever, in nics.js you say \"it is a managed ip\" so perhaps just do that here to avoid the single quote needed to make this grammatically correct."},{"file":"lib/machines.js","line":1505,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1547,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Julien: This is where I was referring to when I mentioned the error wrapping question.  Since ZAPI-816 we will now pre-provision NICs.  In that case if the IP is taken we will hit this block of code.  However the error returned from vmapi may actually be another napi error such as ResourceNotFound in the case of the IP not being valid or the IP not being a part of the network\u0027s subnet.  So I was wondering what your opinion is here.  Do I use the vmapiErrorWrap even though it might be a napi error.  Or are we okay with passing through the napi error we get today."},{"file":"lib/machines.js","line":1547,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"This logic will be factored out into errors.js so that nic.js and machines.js can both benefit."},{"file":"test/machines.test.js","line":342,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: if \"machineCreateErr\" is not an object, then accessing machineCreateErr.statusCode will crash, preventing the remainder of the test to run."},{"file":"test/machines.test.js","line":342,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":387,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above re: accessing machineCreateErr.statusCode when machineCrateErr is undefined or null."},{"file":"test/machines.test.js","line":387,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":42,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":31,"deletions":0},{"file":"lib/machines.js","type":"MODIFIED","insertions":87,"deletions":-25},{"file":"lib/nics.js","type":"MODIFIED","insertions":127,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":362,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":956,"sizeDeletions":-77},{"number":"10","revision":"8d9e13fa1e514ef653b1b748d143d9cef2afbaba","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/10","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1514958100,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1514958132,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":400,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Since above you `assert.object` on an error object, perhaps this line should be `assert.arrayOfObject`"},{"file":"lib/errors.js","line":400,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1499,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Remove commented code"},{"file":"lib/machines.js","line":1499,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1550,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"I\u0027d prefer this to be explicitly checked\n\n\n if (msgs.length \u003e 0) {\n    ..\n }"},{"file":"lib/machines.js","line":1550,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":71,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":92,"deletions":-29},{"file":"lib/nics.js","type":"MODIFIED","insertions":119,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":366,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":1000,"sizeDeletions":-82},{"number":"11","revision":"8f7ffbe9733a6de47f6d10e1e1a62ee633ef0a8e","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/11","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515002812,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515002844,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515002993,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"comments":[{"file":"docs/index.md","line":4353,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should this still mention that it mentions both forms of inputs (UUIDs and objects)?"},{"file":"docs/index.md","line":4353,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"That means your object needs to look like this at a minimum:\n\n{\n  ipv4_uuid: UUID\n}\n\nPerhaps that is not clear in my wording?"},{"file":"docs/index.md","line":4353,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What I meant is: doesn\u0027t it _also_ support passing the following:\n\n[\n  \"some-network-uuid\"\n]\n\n? If so, the current doc sounds like it _only_ supports passing an array of objects, when it actually _also_ support passing an array of strings (network UUIDs)."},{"file":"docs/index.md","line":4474,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Typo \"and and\"."},{"file":"docs/index.md","line":4474,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/errors.js","line":403,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"If we\u0027re always overwriting \"err\" with the latest \"UsedBy\" error, maybe we can stop processing those errors as soon as we encounter one \"UsedBy\" error? Otherwise it seems that the code has a bug.\n\nOr we could process all errors but at least adapt the error message to be \"IPs in use\" (plural form) instead of \"IP in use\" (singular form) if more than one \"UsedBy\" error is found."},{"file":"lib/errors.js","line":403,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/machines.js","line":1555,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"If checkForDuplicateError doesn\u0027t find a UsedBy error, it seems it will just return \"err\". In this case, the non-wrapped error, maybe that\u0027s not what we want to do because we\u0027d risk exposing internal errors?"},{"file":"lib/machines.js","line":1555,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":168,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Where do we validate that \"networkArg.ipv4_uuid\" is a valid UUID?"},{"file":"lib/nics.js","line":168,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"That happens in validateNetworkObject.  I will add an assert here."},{"file":"lib/nics.js","line":169,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What happens if \"ipv4_ips\" is not an object? Does it make sdc-napi abort? Do we validate that somewhere?"},{"file":"lib/nics.js","line":169,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"If specified ipv4_ips is an array consisting of a single IP.  Validation happens in validateNetworkObject."},{"file":"lib/nics.js","line":169,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sounds good!"},{"file":"lib/nics.js","line":369,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is \"network\" always an object? Where do we validate that? Should we assert here that it\u0027s an object?\n\nSame for validating/asserting that network.uuid is a valid UUID."},{"file":"lib/nics.js","line":369,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"network is populated via napi calls to either getNetwork or getNetworkPool which should return an object.  I will add an assert here for the things you mentioned since we expect napi to give us valid data."},{"file":"lib/nics.js","line":372,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Would \"cannot validate IP\" be a more accurate message?"},{"file":"lib/nics.js","line":372,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"lib/nics.js","line":402,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Do we want to wrap the error using napiErrorWrap in case it\u0027s not a \"UsedBy\" error?"},{"file":"lib/nics.js","line":402,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":16,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: the blank line should be between vasync and common, not between util and tape.\n\nI think my previous comment about that wasn\u0027t clear and may have mislead you, sorry about that :("},{"file":"test/machines.test.js","line":16,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":426,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment for machineCreateErr as before: we should check whether it\u0027s an object before accessing its statusCode property."},{"file":"test/machines.test.js","line":426,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":515,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above re: machineCreateErr."},{"file":"test/machines.test.js","line":515,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":1620,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above re: err.statusCode."},{"file":"test/machines.test.js","line":1620,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/machines.test.js","line":1662,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Same comment as above re: machineCreateErr.statusCode."},{"file":"test/machines.test.js","line":1662,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/nics.test.js","line":788,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: alphabetize:\n\n// filled in later when adding a fabric nic\nvar fabricNetworkIp;\nvar fixtures;\nvar instNic;"},{"file":"test/nics.test.js","line":788,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":71,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":91,"deletions":-29},{"file":"lib/nics.js","type":"MODIFIED","insertions":119,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":366,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":193,"deletions":0}],"sizeInsertions":999,"sizeDeletions":-82},{"number":"12","revision":"4e411e8a81abc7de7ef9b7865f60c4baa8236b5e","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/12","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515108667,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515108698,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/errors.js","line":413,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It\u0027s not clear from NAPI-438\u0027s description why that\u0027d affect this code. Does that mean that when NAPI-438 is integrated, NAPI will be able to report more than one UsedBy error? If so, it would help to mention that in the ticket\u0027s description."},{"file":"lib/errors.js","line":413,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"I can update the message.  But basically there is no reason to process more than the first UsedBy error (even if there is currently ever just one) because we lack the IP in question.  Once we have the IP we can loop over all errors and say IPs x.x.x.x, y.y.y.y  etc are in use."},{"file":"lib/errors.js","line":413,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sounds good to me, thanks for clarifying!"},{"file":"lib/nics.js","line":405,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Shouldn\u0027t we always wrap the error from napi, unless it\u0027s a duplicateIpError? If so, the current code wraps only the \"InvalidParameters\" errors."},{"file":"lib/nics.js","line":405,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Yep, sorry missed this one after handling this one in machines.js\n\nFixed."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":68,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":96,"deletions":-29},{"file":"lib/nics.js","type":"MODIFIED","insertions":128,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":374,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1017,"sizeDeletions":-82},{"number":"13","revision":"1b5b98d8305e16b8b73a07f3b21413aee4b9014a","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/13","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515114323,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515114355,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":74,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":96,"deletions":-29},{"file":"lib/nics.js","type":"MODIFIED","insertions":132,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":374,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1027,"sizeDeletions":-82},{"number":"14","revision":"65e7acad1cb3f263a08958983dbe06c0ac865f20","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/14","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515195418,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515195449,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":72,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":85,"deletions":-26},{"file":"lib/nics.js","type":"MODIFIED","insertions":126,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":378,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1012,"sizeDeletions":-79},{"number":"15","revision":"4f79f84ef624f3edf5dd9bfda14678d5be4f98de","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/15","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515196503,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515196534,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/machines.js","line":1500,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I think at some point this was \"cannot validate IP\" instead of \"cannot provision\". Any reason why we changed it back to \"cannot provision\"?"},{"file":"lib/machines.js","line":1500,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Fixed in machines.js and nics.js"},{"file":"lib/nics.js","line":401,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Maybe also test if \"body\" is truthy by using \"if (body \u0026\u0026 body.code \u003d\u003d\u003d \u0027InvalidParameters\u0027 \u0026\u0026 ...)\" instead?"},{"file":"lib/nics.js","line":401,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"Done"},{"file":"test/nics.test.js","line":779,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It seems we don\u0027t test the use case where an IP is already in use and we want to add a NIC with that IP. There\u0027s a test that does that in machines.test.js, but I\u0027m wondering if we want to have a similar test here?"},{"file":"test/nics.test.js","line":779,"reviewer":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"message":"This is a good idea.  It will require an additional test instance be provisioned.  I will open a new ticket to enhance some tests."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":72,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":85,"deletions":-26},{"file":"lib/nics.js","type":"MODIFIED","insertions":123,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":378,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1009,"sizeDeletions":-79},{"number":"16","revision":"f8fd670a1030b0041320e3ae62874e552b5cd7c4","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/16","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515201029,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201060,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201610,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515201610,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":72,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":85,"deletions":-26},{"file":"lib/nics.js","type":"MODIFIED","insertions":124,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":378,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1010,"sizeDeletions":-79},{"number":"17","revision":"6524045a0dce3f5603b579894296920435f18952","parents":["b04b26e710a40794f8f7e87cf0cc905da38bd29f"],"ref":"refs/changes/31/3131/17","uploader":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"createdOn":1515201984,"author":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1515201060,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1515201610,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1515201610,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1515202011,"by":{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":45,"deletions":-2},{"file":"lib/errors.js","type":"MODIFIED","insertions":72,"deletions":-1},{"file":"lib/machines.js","type":"MODIFIED","insertions":85,"deletions":-26},{"file":"lib/nics.js","type":"MODIFIED","insertions":124,"deletions":-23},{"file":"lib/validation/networks.js","type":"ADDED","insertions":106,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/machines.73.test.js","type":"MODIFIED","insertions":7,"deletions":-7},{"file":"test/machines.test.js","type":"MODIFIED","insertions":378,"deletions":-19},{"file":"test/nics.test.js","type":"MODIFIED","insertions":192,"deletions":0}],"sizeInsertions":1010,"sizeDeletions":-79}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Michael Zeller","email":"mike.zeller@joyent.com","username":"papertigers"}]}