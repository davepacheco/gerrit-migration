{"project":"joyent/node-vmadm","branch":"master","id":"Id9852b72390ead6e0d7a814befd23cb1632d79da","number":"2798","subject":"joyent/node-vmadm#2 want support for `vmadm events` Reviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/2798","commitMessage":"joyent/node-vmadm#2 want support for `vmadm events`\nReviewed by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1508263576,"lastUpdated":1508961056,"open":false,"status":"MERGED","comments":[{"timestamp":1508263576,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1508263579,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit c378241b30b62390b7412eeb4ccc19459b8f9b69\n    \n    add vmadm events support"},{"timestamp":1508263616,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508277134,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1508277137,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 6e3e9669f580205b5928e4f0cbebb58838b0a37f\n    \n    docs"},{"timestamp":1508277181,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508343656,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1508343659,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 5c555da9ebecdb2e21975cd16b0d36d6f0317e57\n    \n    make uuid check an arg to `vmadm`"},{"timestamp":1508343680,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508351395,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4."},{"timestamp":1508351398,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 7f871479aa311a6730ce44106db6305e80fe6356\n    \n    quote log lines\n    \n    commit 0d6c1f3cbc03e867b4f28fc4f8e17f57d67376d6\n    \n    copy env, ensure events barely touches stderr"},{"timestamp":1508351430,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508819905,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Code-Review+1\n\n(10 comments)\n\nOverall looks fine. I assume you\u0027ve done some testing on this? If you don\u0027t want to change any of the nits just reply with testing info and I can IA+1 as well."},{"timestamp":1508863874,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\n(10 comments)"},{"timestamp":1508873380,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5."},{"timestamp":1508873383,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 9779b2fb76998069785c46187ed36718028bfeed\n    \n    changes based on joshw review"},{"timestamp":1508873408,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508960172,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Code-Review+1 Integration-Approval+1\n\nAssuming all tests pass, I think this looks good."},{"timestamp":1508960964,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 6: Commit message was updated."},{"timestamp":1508961056,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"6","revision":"d9852b72390ead6e0d7a814befd23cb1632d79da","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/6","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508960964,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508873408,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508960172,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508960172,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1508961056,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":244,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":270,"sizeDeletions":-5},"patchSets":[{"number":"1","revision":"6bc1986057225b6906d887985def0af068ee01fe","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508263576,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508263616,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":214,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":216,"sizeDeletions":-3},{"number":"2","revision":"a3debeeb07d18c599adce65124097e96730c9370","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508277134,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508277181,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":225,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":246,"sizeDeletions":-3},{"number":"3","revision":"c7d799020c45ebb60bb945b669551d20e11cd703","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508343656,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508343680,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":225,"deletions":-2},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":246,"sizeDeletions":-3},{"number":"4","revision":"c6dc3d6fef71bdfc8e9398bd4d1c3390ad4d250c","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508351395,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508351430,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508819905,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"comments":[{"file":"lib/index.js","line":28,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Would be good to add a name for this function. I realize there are other examples in this file though without function names, so if you want to leave it so we add names for this and other functions here separately/later that\u0027d also be ok."},{"file":"lib/index.js","line":28,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1193,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"would be nice to name the callback function here."},{"file":"lib/index.js","line":1193,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1195,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"What use is ready_ev here? (asking honestly)\n\nI wonder whether it wouldn\u0027t be better to call:\n\n    callback(err)\n\nand:\n\n    callback(null, stopFn)\n\nor:\n\n    callback(null, {stopFn: \u003cstopFn\u003e})\n\nin the success case so that the caller doesn\u0027t need to both handle the callback and the return value to handle both cases? Just a thought.\n\nIf ready_ev is really useful that could be included in an object returned as well..."},{"file":"lib/index.js","line":1195,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"the \"ready_ev\" is the event sent from vminfod when a listener is created on `GET /events`.  This object looks like:\n\n {\n   \"type\": \"ready\",\n   \"date\": \u003cdate obj\u003e,\n   \"uuid\": \u003cuuid for event listener\u003e\n   \"vms\": {\n     \"\u003cuuid\u003e\": \u003cjson payload\u003e,\n   }\n }\n\n`uuid` is a unique identifier for the event listener that can be used to track it in the vminfod logs, and `vms` is an object of *every* vm known by vminfod at the time of the event listener creation.  This is convenient for knowing the exact VM state when the listener is created instead of having to do a separate `GET /vms` which could potentially be a race.\n\nThe ready_ev could definitely be useful to consumers of `vmadm.events` so I would prefer it stays.  I like the idea of the stopFn being passed with the ready event too, since in the case of an error the stopFn should be undefined."},{"file":"lib/index.js","line":1198,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"this function could also use a name."},{"file":"lib/index.js","line":1198,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1259,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Nameless functions get no presents from Santa."},{"file":"lib/index.js","line":1259,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1266,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"This function is sad. Because it wishes it had a name. :)"},{"file":"lib/index.js","line":1266,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1294,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Function name."},{"file":"lib/index.js","line":1294,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1297,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: I think we prefer the {} even for single line statements like this. But I\u0027d not block over this."},{"file":"lib/index.js","line":1297,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1301,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"nit: see above Re: {}"},{"file":"lib/index.js","line":1301,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/index.js","line":1310,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Would be good to name this function."},{"file":"lib/index.js","line":1310,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":19,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":236,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":257,"sizeDeletions":-5},{"number":"5","revision":"98753e8ed77c17d33c380f71e0ce2f886448e791","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508873380,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508873408,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508960172,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508960172,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":244,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":270,"sizeDeletions":-5},{"number":"6","revision":"d9852b72390ead6e0d7a814befd23cb1632d79da","parents":["f98fb9f26a68bb8def46ed18de4d0825ee780837"],"ref":"refs/changes/98/2798/6","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1508960964,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508873408,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508960172,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508960172,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1508961056,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":24,"deletions":0},{"file":"lib/index.js","type":"MODIFIED","insertions":244,"deletions":-4},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-1}],"sizeInsertions":270,"sizeDeletions":-5}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}