{"project":"joyent/sdc-imgapi","branch":"master","id":"Ie9ba3ee89183084cbf4b65536cb18d363cb159a1","number":"4902","subject":"TRITON-774 imgapi should allow admin-only add-file from URLs Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"url":"https://cr.joyent.us/4902","commitMessage":"TRITON-774 imgapi should allow admin-only add-file from URLs\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1538399205,"lastUpdated":1542715937,"open":false,"status":"MERGED","comments":[{"timestamp":1538399205,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 1."},{"timestamp":1538399210,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 13db05590a62509eceb8fa21d20d6d3fe3a7b21e\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs"},{"timestamp":1538399241,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(3 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1538399469,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 2."},{"timestamp":1538399473,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 2559d36df6d2c91d63935126a713c0d01564dcbd\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs"},{"timestamp":1538399519,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538559428,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 3."},{"timestamp":1538559436,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 868fb1e05520c2f23ea3b9319d12c36514e64c45\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    \n    commit 15182e0dd1abff91a41b4987d8e79c18015fbc78\n    \n    TRITON-812 imgapi lacks documentation of requirements.bootrom\n    Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n    Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e"},{"timestamp":1538559468,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539213968,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(10 comments)"},{"timestamp":1539789698,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 4."},{"timestamp":1539789705,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit 6872545fff9de54d3646dcfda39fa16219dd6eb3\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    \n    commit 15182e0dd1abff91a41b4987d8e79c18015fbc78\n    \n    TRITON-812 imgapi lacks documentation of requirements.bootrom\n    Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n    Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e"},{"timestamp":1539789741,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539791609,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4:\n\n(7 comments)\n\nI\u0027ve addressed these comments in Patch set 4.\n\nI did some more error-handling testing:\n\n* When a server returns an unexpected HTTP status\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file --url -f http://10.0.0.20:9000/assets-zfs-master-20180925T100358Z-g3f3d1b8.zfs.gz -s e6a828afa242ecad289f3114e6e2856ef2404a48 2d74d0fb-8402-4e10-a145-86864b14bca7\nsdc-imgadm: error (Download): HTTP 299 error attempting to download image\n[root@headnode (uk-1) /tmp]#\n\n\n\n\n* When we reach our req.connection.setTimeout for the *imgapi* connection from imgadm:\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file --url -f http://10.0.0.20:9000/assets-zfs-master-20180925T100358Z-g3f3d1b8.zfs.gz -s e6a828afa242ecad289f3114e6e2856ef2404a48 2d74d0fb-8402-4e10-a145-86864b14bca7\nsdc-imgadm: error (ClientError): Error: socket hang up\n\nThis results in nothing being added (if we haven\u0027t started connecting to the remote\nhttp server to download content)\n\n\n* When we kill the HTTP server part of the way through the download\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file --url -f http://10.0.0.20:9000/assets-zfs-master-20180925T100358Z-g3f3d1b8.zfs.gz -s e6a828afa242ecad289f3114e6e2856ef2404a48 2d74d0fb-8402-4e10-a145-86864b14bca7\nsdc-imgadm: error (Download): expected sha1 hash, e6a828afa242ecad289f3114e6e2856ef2404a48, does not match the uploaded file sha1 hash, 4d26818446d7152efe5937d0fdccf560bd99a312\n[root@headnode (uk-1) /tmp]#\n\n\n* When we kill the HTTP server before it has started streaming content:\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file --url -f http://10.0.0.20:9000/assets-zfs-master-20180925T100358Z-g3f3d1b8.zfs.gz -s e6a828afa242ecad289f3114e6e2856ef2404a48 2d74d0fb-8402-4e10-a145-86864b14bca7\nsdc-imgadm: error (Download): Error getting image: Error: socket hang up\n\n\n* When we attempt to contact a missing server\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file --url -f http://www.0.20:9000/assets-zfs-master-20180925T100358Z-g3f3d1b8.zfs.gz -s e6a828afa242ecad289f3114e6e2856ef2404a48 2d74d0fb-8402-4e10-a145-86864b14bca7\nsdc-imgadm: error (Download): Error getting image: Error: getaddrinfo ENOTFOUND www.0.20:9000\n\n* When we ask for an address that we\u0027ll never be able to connect to:\n\n[root@headnode (uk-1) /tmp]# sdc-imgadm add-file --url -f http://10.11.0.20:90/assets-zfs-master-20180925T100358Z-g3f3d1b8.zfs.gz -s e6a828afa242ecad289f3114e6e2856ef2404a48 2d74d0fb-8402-4e10-a145-86864b14bca7\n(~3 minutes pass)\nsdc-imgadm: error (Download): Error getting image: Error: connect ETIMEDOUT 10.11.0.20:9000"},{"timestamp":1539860121,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 5."},{"timestamp":1539860126,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 6cb668e8e69f6c483fa7da33b4b3b672ca73ab8d\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    \n    commit 15182e0dd1abff91a41b4987d8e79c18015fbc78\n    \n    TRITON-812 imgapi lacks documentation of requirements.bootrom\n    Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n    Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e"},{"timestamp":1539860157,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1539860457,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5:\n\nPatch set 5 fixes an issue where, despite validating the sha hash of the downloaded file, we somehow ended up storing a corruped version of it.\n\nI tracked this down to a missing \u0027response.pause()\u0027 when dealing with the https response stream - stor.storeFileFromStream(..) requires a paused stream.\n\nI believe it needs a paused stream so that \u0027data\u0027 events aren\u0027t emitted by the https response before the stor has setup its pipe to the output file on the imgapi service. (this makes me wonder if there\u0027s a chance of a race - can we start getting events before we\u0027ve paused the stream?)"},{"timestamp":1540500040,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 5:\n\n(4 comments)\n\nJust nits, then I\u0027m fine adding this."},{"timestamp":1541177025,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 6."},{"timestamp":1541177029,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 6:\n\nNew commits:\n    \n    commit 05b386ddecb45454920c858cfb8371c28251f05d\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    \n    commit 15182e0dd1abff91a41b4987d8e79c18015fbc78\n    \n    TRITON-812 imgapi lacks documentation of requirements.bootrom\n    Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n    Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e"},{"timestamp":1541177052,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541177238,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 5:\n\n(3 comments)"},{"timestamp":1541440589,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 7."},{"timestamp":1541440590,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 7:\n\nNew commits:\n    \n    commit 48c2bd36db12c12e6299fc2ab1862fc35da7a07f\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    \n    commit dba785572f00ae8928bf9f80feb8e6ba3fc44c10\n    \n    TRITON-566 need windows-prepare-image script\n    Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n    Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n    Approved by: Trent Mick \u003ctrentm@gmail.com\u003e\n    \n    commit 191097b109596e8d43580cc89bb6a40360b91d9e\n    \n    TRITON-793 Add IMGAPI operator docs for x-DC image copying\n    Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n    Approved by: Trent Mick \u003ctrentm@gmail.com\u003e\n    \n    commit 15182e0dd1abff91a41b4987d8e79c18015fbc78\n    \n    TRITON-812 imgapi lacks documentation of requirements.bootrom\n    Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\n    Approved by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e"},{"timestamp":1541440618,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541442013,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 7:\n\nThe git book-keeping doesn\u0027t seem right here, that or I\u0027m not understanding how gerrit displays changes. The fact that it\u0027s saying \"cannot merge\" and appears to be showing a bunch of commits from master as part of this change seems incorrect. What am I doing wrong?"},{"timestamp":1541442185,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1541442247,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 8:\n\n\u003e The git book-keeping doesn\u0027t seem right here, that or I\u0027m not\n \u003e understanding how gerrit displays changes. The fact that it\u0027s\n \u003e saying \"cannot merge\" and appears to be showing a bunch of commits\n \u003e from master as part of this change seems incorrect. What am I doing\n \u003e wrong?\n\nThe rebase seemed to fix that, though I\u0027m unclear why grr wasn\u0027t taking care of that for me."},{"timestamp":1542330102,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 8:\n\nGrr doesn\u0027t handle rebasing for you. You need to do something like this in your working copy:\n\n```\ngit checkout master\ngit pull\ngit checkout -\ngit rebase master\ngrr\n```"},{"timestamp":1542330578,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 8: Code-Review+1 Integration-Approval+1"},{"timestamp":1542371307,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1542371311,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 9:\n\nNew commits:\n    \n    commit 2a371d8ed3301b6b9c663a4aa2874cfcb7fcb6d1\n    \n    TRITON-774 imgapi should allow admin-only add-file from URLs\n    Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\n    Approved by: Trent Mick \u003ctrentm@gmail.com\u003e"},{"timestamp":1542394006,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 9:\n\npoke (so my CR dashboard doesn\u0027t bold this CR)"},{"timestamp":1542715937,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Tim Foster"}],"currentPatchSet":{"number":"9","revision":"e9ba3ee89183084cbf4b65536cb18d363cb159a1","parents":["dba785572f00ae8928bf9f80feb8e6ba3fc44c10"],"ref":"refs/changes/02/4902/9","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1542371307,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541440618,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542330578,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542330578,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1542715937,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":93,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":198,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":298,"sizeDeletions":-13},"patchSets":[{"number":"1","revision":"bfd78b8a9c9144643db682090880e53080804bff","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/1","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1538399205,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1538399241,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/images.js","line":3138,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"missing space before left brace"},{"file":"lib/images.js","line":3144,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"missing space before left brace"},{"file":"lib/images.js","line":3265,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"missing space between \u0027function\u0027 and paren"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":93,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":175,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":274,"sizeDeletions":-6},{"number":"2","revision":"730cee7d3987a4b74331bcc0e9f3e2f6ab2cfe8a","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/2","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1538399469,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538399519,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":93,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":175,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":274,"sizeDeletions":-6},{"number":"3","revision":"eb1437774d347edfdc4051c40b83cd8fd68de2ea","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/3","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1538559428,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538559468,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"docs/index.md","line":1473,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Quote with backticks to make Markdown happy."},{"file":"lib/images.js","line":3111,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"debug\" level is what most other \": start\" log records do here."},{"file":"lib/images.js","line":3111,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"lib/images.js","line":3152,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I don\u0027t have a high comfort level to what might happen when this expires. Say we have a huge file, and it is taking \u003e1hr to download it (and upload it from this IMGAPI to Manta where the file is potentially stored). The client connection is severed. Does the server side continue adding the file?\n\nCan those \"AddImageFileFromUrl\"s pile up on the server side if the client is retrying?\n\nI don\u0027t know that we *need* to solve these, but it might be nice. One way would be to have a queue for file-adds in the IMGAPI process. When a AddImageFileFromUrl request comes in, it looks in the queue and \"attaches\" to an existing one (i.e. just waits on it completing).\n\nAnyway, perhaps this is all for a follow-up ticket. :) Along with the hoped-for follow up support for progress messages."},{"file":"lib/images.js","line":3152,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"In this case yes, the server side continues downloading and the file will ultimately get added to the image and moved to its final location as normal.\n\nIf a client keeps retrying the same request, subsequent attempts to add the same image will proceed and eventually one will complete its download and the others will then fail to add an image file that already exists - this isn\u0027t wonderful, I admit."},{"file":"lib/images.js","line":3223,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"It might be nice to also passing in a \u0027User-Agent\u0027 header. Not required tho. Meh. :)"},{"file":"lib/images.js","line":3223,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027m curious what happens if this is given a URL to a server that hangs: accepts the connection, but responds with nothing. Should we have some timeout guard on that?\n\nAgain, as with other points, we may be fine just deferring this because it is basically an admin-only endpoint."},{"file":"lib/images.js","line":3223,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"The http request connection will eventually hit its 5(ish?) minute connection-idle timeout and we\u0027ll HTTP 400 the request."},{"file":"lib/images.js","line":3223,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"lib/images.js","line":3224,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This won\u0027t handle redirects, FWIW. I think that is probably fine for a start."},{"file":"lib/images.js","line":3224,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Good point, I\u0027ve added a comment to mention that explictly."},{"file":"lib/images.js","line":3240,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\u0027binary\u0027 doesn\u0027t mean what you think it means here. hash.update for node is gross. (https://nodejs.org/docs/latest/api/all.html#crypto_hash_update_data_inputencoding  Click the \"History\" disclosure button. The default changed from \u0027binary\u0027 -- which means something close to latin1 -- to \u0027utf8\u0027 in node v6. This caused a number of issues in Triton/Manta client/server interactions, e.g. MANTA-3679 if you are curious.)\n\nHowever, I think we can just drop the \u0027binary\u0027 arg, because `chunk` for us should be a Buffer (and *not* a String object)... meaning that the second argument (the \"encoding\") to `hash.update` is ignored."},{"file":"lib/images.js","line":3240,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"lib/images.js","line":4813,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps append \u0027/images/:uuid/file/from-url\u0027 or \u0027/images/:uuid/file-from-url\u0027 per my excess commentary on https://cr.joyent.us/#/c/4901/ ?"},{"file":"lib/images.js","line":4813,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"package.json","line":3,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Wow. Perhaps slip in a \"Triton Data Center\" update here."},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"We are adding a feature, so let\u0027s bump to \"4.6.0\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":100,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":175,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":281,"sizeDeletions":-6},{"number":"4","revision":"48133fbdf862644d39ce82a66c4d1e31a8e3c5bb","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/4","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1539789698,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539789741,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":100,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":193,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":300,"sizeDeletions":-13},{"number":"5","revision":"0e65fae58d2aa2211064a79eaed5cba39b5d0c60","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/5","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1539860121,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1539860157,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"CHANGES.md","line":6,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: double colon there."},{"file":"CHANGES.md","line":6,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"lib/images.js","line":3229,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"How about using what IMGAPI uses for its `Server` header, e.g.:\n\n```\n[root@headnode (nightly-1) ~]# sdc-imgapi /ping\nHTTP/1.1 200 OK\nContent-Type: application/json\nContent-Length: 75\nDate: Thu, 25 Oct 2018 20:33:04 GMT\nServer: imgapi/4.5.2              \u003c---- HERE\nx-request-id: fff764bf-774a-4446-a28f-dfe95a24e079\n...\n```\n\nI think that value is `req._app.serverName`."},{"file":"lib/images.js","line":3237,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Should name all our functions. The primary argument is that we\u0027ll have that func name in mdb debugging cores."},{"file":"lib/images.js","line":3237,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"},{"file":"lib/images.js","line":3242,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Perhaps open that sentence with \"Limitation: \" to (help?) clarify this isn\u0027t by design, it is just a current limitation."},{"file":"lib/images.js","line":3242,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":100,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":198,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":305,"sizeDeletions":-13},{"number":"6","revision":"7daa1bbb8a1730bf008411ff743d98bb7ca698eb","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/6","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1541177025,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541177052,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":100,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":198,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":305,"sizeDeletions":-13},{"number":"7","revision":"ca6103382908127225e2daaf3783fa8b5f69a9a1","parents":["7d1f23a0d945a0a6b8e2652d193acc6868731bdb"],"ref":"refs/changes/02/4902/7","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1541440589,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541440618,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":100,"deletions":-4},{"file":"docs/operator-guide.md","type":"MODIFIED","insertions":26,"deletions":-1},{"file":"lib/images.js","type":"MODIFIED","insertions":214,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/prepare-image/windows-prepare-image","type":"ADDED","insertions":153,"deletions":0}],"sizeInsertions":500,"sizeDeletions":-14},{"number":"8","revision":"869524d8c66fcecac9a7dede26ff9b7dd26aff84","parents":["dba785572f00ae8928bf9f80feb8e6ba3fc44c10"],"ref":"refs/changes/02/4902/8","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1541442185,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541440618,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542330578,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542330578,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":93,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":198,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":298,"sizeDeletions":-13},{"number":"9","revision":"e9ba3ee89183084cbf4b65536cb18d363cb159a1","parents":["dba785572f00ae8928bf9f80feb8e6ba3fc44c10"],"ref":"refs/changes/02/4902/9","uploader":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"createdOn":1542371307,"author":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541440618,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542330578,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542330578,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1542715937,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":93,"deletions":-4},{"file":"lib/images.js","type":"MODIFIED","insertions":198,"deletions":-7},{"file":"package.json","type":"MODIFIED","insertions":2,"deletions":-2}],"sizeInsertions":298,"sizeDeletions":-13}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}]}