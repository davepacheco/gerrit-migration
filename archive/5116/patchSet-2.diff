From 1ef21b0096b75e522c236f5476d671f0f8c14058 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 23 Nov 2018 09:11:53 -0800
Subject: [PATCH] TRITON-983 cn-agent doesn't need effluent-logger any more

---
 lib/backends/smartos/common.js                | 24 -------------------
 lib/backends/smartos/tasks/docker_copy.js     |  2 --
 lib/backends/smartos/tasks/machine_boot.js    |  1 -
 lib/backends/smartos/tasks/machine_create.js  |  3 ---
 .../smartos/tasks/machine_create_snapshot.js  |  3 ---
 .../smartos/tasks/machine_delete_snapshot.js  |  3 ---
 lib/backends/smartos/tasks/machine_destroy.js |  1 -
 lib/backends/smartos/tasks/machine_info.js    |  2 --
 lib/backends/smartos/tasks/machine_kill.js    |  2 --
 lib/backends/smartos/tasks/machine_load.js    |  2 --
 lib/backends/smartos/tasks/machine_proc.js    |  3 ---
 lib/backends/smartos/tasks/machine_reboot.js  |  2 --
 .../smartos/tasks/machine_reprovision.js      |  4 ----
 .../tasks/machine_rollback_snapshot.js        |  5 ----
 .../smartos/tasks/machine_screenshot.js       |  2 --
 .../smartos/tasks/machine_shutdown.js         |  2 --
 lib/backends/smartos/tasks/machine_update.js  |  2 --
 .../smartos/tasks/machine_update_nics.js      |  8 +------
 package.json                                  |  3 +--
 19 files changed, 2 insertions(+), 72 deletions(-)

diff --git a/lib/backends/smartos/common.js b/lib/backends/smartos/common.js
index e224aa9..cb58295 100644
--- a/lib/backends/smartos/common.js
+++ b/lib/backends/smartos/common.js
@@ -19,7 +19,6 @@ var execFile = require('child_process').execFile;
 var fs = require('fs');
 
 var async = require('async');
-var EffluentLogger = require('effluent-logger');
 var verror = require('verror');
 
 var FIELDS = 'zoneid:zonename:state:zonepath:uuid:brand:ip-type'.split(':');
@@ -116,28 +115,6 @@ function zoneadm(zone, addtlArgs, opts, callback) {
             return;
         });
 }
-/*
- * Create a logger for re-logging vmadm log messages.
- *
- * These messages will currently be sent to fluentd if one is configured.
- *
- */
-function makeVmadmLogger(task) {
-    var evtLogger;
-
-    if (process.env.FLUENTD_HOST) {
-        evtLogger = new EffluentLogger({
-            filter: function _evtFilter(obj) { return (!!obj.evt); },
-            host: process.env.FLUENTD_HOST,
-            log: task.log,
-            port: 24224,
-            tag: 'debug'
-        });
-        return evtLogger;
-    }
-
-    return null;
-}
 
 function provisionInProgressFile(uuidOrZonename, callback) {
     var filename = '/var/tmp/machine-provision-' + uuidOrZonename;
@@ -189,7 +166,6 @@ function ensureProvisionComplete(uuid, callback) {
 
 module.exports = {
     ensureProvisionComplete: ensureProvisionComplete,
-    makeVmadmLogger: makeVmadmLogger,
     modifyConfig: modifyConfig,
     provisionInProgressFile: provisionInProgressFile,
     zoneList: zoneList,
diff --git a/lib/backends/smartos/tasks/docker_copy.js b/lib/backends/smartos/tasks/docker_copy.js
index a3384d4..b87896c 100644
--- a/lib/backends/smartos/tasks/docker_copy.js
+++ b/lib/backends/smartos/tasks/docker_copy.js
@@ -9,7 +9,6 @@
  */
 
 var Task = require('../../../task_agent/task');
-var common = require('../common');
 var fork = require('child_process').fork;
 var getFirstAdminIp = require('../smartdc-config').getFirstAdminIp;
 var once = require('once');
@@ -47,7 +46,6 @@ function start(callback) {
     opts.log = self.log;
     opts.req_id = self.req.req_id;
     opts.uuid = self.req.params.uuid;
-    opts.vmadmLogger = common.makeVmadmLogger(self);
 
     getFirstAdminIp(function (err, adminIp) {
         if (err) {
diff --git a/lib/backends/smartos/tasks/machine_boot.js b/lib/backends/smartos/tasks/machine_boot.js
index 9dbe3c1..6fa280c 100644
--- a/lib/backends/smartos/tasks/machine_boot.js
+++ b/lib/backends/smartos/tasks/machine_boot.js
@@ -43,7 +43,6 @@ function start(callback) {
 
     vmadmOpts.log = self.log;
     vmadmOpts.req_id = self.req.req_id;
-    vmadmOpts.vmadmLogger = common.makeVmadmLogger(self);
 
     if (self.req.params.idempotent === true ||
         self.req.params.idempotent === 'true') {
diff --git a/lib/backends/smartos/tasks/machine_create.js b/lib/backends/smartos/tasks/machine_create.js
index b12a0ba..5f7c010 100644
--- a/lib/backends/smartos/tasks/machine_create.js
+++ b/lib/backends/smartos/tasks/machine_create.js
@@ -36,7 +36,6 @@ Task.createTask(MachineCreateTask);
 function start(callback) {
     var self = this;
 
-    self.vmadmLogger = common.makeVmadmLogger(self);
     var creationGuardFilename;
 
     async.waterfall([
@@ -104,7 +103,6 @@ function start(callback) {
         loadOpts.log = self.log;
         loadOpts.req_id = self.req.req_id;
         loadOpts.uuid = self.req.params.uuid;
-        loadOpts.vmadmLogger = self.vmadmLogger;
 
         vmadm.load(
             loadOpts,
@@ -306,7 +304,6 @@ function create_machine(callback) {
     opts = req.params;
     opts.log = self.log;
     opts.req_id = req.req_id;
-    opts.vmadmLogger = self.vmadmLogger;
 
     vmadm.create(opts, function (error, info) {
         if (error) {
diff --git a/lib/backends/smartos/tasks/machine_create_snapshot.js b/lib/backends/smartos/tasks/machine_create_snapshot.js
index 66e11ac..e5feeb6 100644
--- a/lib/backends/smartos/tasks/machine_create_snapshot.js
+++ b/lib/backends/smartos/tasks/machine_create_snapshot.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineCreateSnapshotTask = module.exports = function (req) {
     Task.call(this);
@@ -27,7 +26,6 @@ function start(callback) {
     opts = self.req.params;
     opts.log = self.log;
     opts.req_id = self.req.req_id;
-    opts.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadm.create_snapshot(opts, function (error) {
         var loadOpts = {};
@@ -46,7 +44,6 @@ function start(callback) {
         loadOpts.log = self.log;
         loadOpts.req_id = self.req.req_id;
         loadOpts.uuid = self.req.params.uuid;
-        loadOpts.vmadmLogger = self.vmadmLogger;
 
         vmadm.load(
             loadOpts,
diff --git a/lib/backends/smartos/tasks/machine_delete_snapshot.js b/lib/backends/smartos/tasks/machine_delete_snapshot.js
index d5ceec8..d6a9e62 100644
--- a/lib/backends/smartos/tasks/machine_delete_snapshot.js
+++ b/lib/backends/smartos/tasks/machine_delete_snapshot.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineDeleteSnapshotTask = module.exports = function (req) {
     Task.call(this);
@@ -27,7 +26,6 @@ function start(callback) {
     opts = self.req.params;
     opts.log = self.log;
     opts.req_id = self.req.req_id;
-    opts.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadm.delete_snapshot(opts, function (error) {
         var loadOpts = {};
@@ -48,7 +46,6 @@ function start(callback) {
         loadOpts.log = self.log;
         loadOpts.req_id = self.req.req_id;
         loadOpts.uuid = self.req.params.uuid;
-        loadOpts.vmadmLogger = self.vmadmLogger;
 
         vmadm.load(
             loadOpts,
diff --git a/lib/backends/smartos/tasks/machine_destroy.js b/lib/backends/smartos/tasks/machine_destroy.js
index 02ce9c8..83e2cb2 100644
--- a/lib/backends/smartos/tasks/machine_destroy.js
+++ b/lib/backends/smartos/tasks/machine_destroy.js
@@ -40,7 +40,6 @@ function start() {
     vmadmOpts.log = self.log;
     vmadmOpts.req_id = self.req.req_id;
     vmadmOpts.uuid = uuid;
-    vmadmOpts.vmadmLogger = common.makeVmadmLogger(self);
 
     vasync.pipeline({
         funcs: [
diff --git a/lib/backends/smartos/tasks/machine_info.js b/lib/backends/smartos/tasks/machine_info.js
index 407fac7..5fec880 100644
--- a/lib/backends/smartos/tasks/machine_info.js
+++ b/lib/backends/smartos/tasks/machine_info.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineInfoTask = module.exports = function (req) {
     Task.call(this);
@@ -31,7 +30,6 @@ function start(callback) {
     opts = self.req.params;
     opts.log = self.log;
     opts.req_id = self.req.req_id;
-    opts.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadm.info(opts, function (error, info) {
         if (error) {
diff --git a/lib/backends/smartos/tasks/machine_kill.js b/lib/backends/smartos/tasks/machine_kill.js
index ade8778..5d8ff48 100644
--- a/lib/backends/smartos/tasks/machine_kill.js
+++ b/lib/backends/smartos/tasks/machine_kill.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm  = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineKillTask = module.exports = function (req) {
     Task.call(this);
@@ -50,7 +49,6 @@ function start(callback) {
     opts = self.req.params;
     opts.log = self.log;
     opts.req_id = self.req.req_id;
-    opts.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadm.kill(opts, function (error) {
         if (error && (!idempotent || !ignoreError(error, self.log))) {
diff --git a/lib/backends/smartos/tasks/machine_load.js b/lib/backends/smartos/tasks/machine_load.js
index 2942058..997b249 100644
--- a/lib/backends/smartos/tasks/machine_load.js
+++ b/lib/backends/smartos/tasks/machine_load.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineLoadTask = module.exports = function (req) {
     Task.call(this);
@@ -27,7 +26,6 @@ function start(callback) {
     opts.log = self.log;
     opts.req_id = self.req.req_id;
     opts.uuid = self.req.params.uuid;
-    opts.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadm.load(opts, function (error, machine) {
         if (error) {
diff --git a/lib/backends/smartos/tasks/machine_proc.js b/lib/backends/smartos/tasks/machine_proc.js
index dd971ef..f274655 100644
--- a/lib/backends/smartos/tasks/machine_proc.js
+++ b/lib/backends/smartos/tasks/machine_proc.js
@@ -8,7 +8,6 @@
  * Copyright (c) 2018, Joyent, Inc.
  */
 
-var common = require('../common');
 var execFile = require('child_process').execFile;
 var procread = require('procread');
 var Task = require('../../../task_agent/task');
@@ -28,12 +27,10 @@ function start(callback) {
     var vmadmOpts = {};
 
     log = self.log;
-    self.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadmOpts.log = self.log;
     vmadmOpts.req_id = self.req.req_id;
     vmadmOpts.uuid = uuid;
-    vmadmOpts.vmadmLogger = common.makeVmadmLogger(self);
 
     if (!uuid) {
         self.fatal('missing uuid for machine_proc');
diff --git a/lib/backends/smartos/tasks/machine_reboot.js b/lib/backends/smartos/tasks/machine_reboot.js
index b6cf0e2..61a305a 100644
--- a/lib/backends/smartos/tasks/machine_reboot.js
+++ b/lib/backends/smartos/tasks/machine_reboot.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineRebootTask = module.exports = function (req) {
     Task.call(this);
@@ -46,7 +45,6 @@ function start(callback) {
 
     vmadmOpts.log = self.log;
     vmadmOpts.req_id = self.req.req_id;
-    vmadmOpts.vmadmLogger = common.makeVmadmLogger(self);
 
     function _addVmadmOpts(obj) {
         var newobj = obj;
diff --git a/lib/backends/smartos/tasks/machine_reprovision.js b/lib/backends/smartos/tasks/machine_reprovision.js
index 301720c..5026685 100644
--- a/lib/backends/smartos/tasks/machine_reprovision.js
+++ b/lib/backends/smartos/tasks/machine_reprovision.js
@@ -31,8 +31,6 @@ function start(callback) {
     var self = this;
     var provisionGuardFilename;
 
-    self.vmadmLogger = common.makeVmadmLogger(self);
-
     self.pre_check(function (error) {
         if (error) {
             self.fatal(error.message);
@@ -69,7 +67,6 @@ function start(callback) {
                 loadOpts.log = self.log;
                 loadOpts.req_id = self.req.req_id;
                 loadOpts.uuid = self.req.params.uuid;
-                loadOpts.vmadmLogger = self.vmadmLogger;
 
                 if (err) {
                     self.fatal(err.message);
@@ -195,7 +192,6 @@ function reprovision_machine(callback) {
     opts.log = self.log;
     opts.req_id = self.req.req_id;
     opts.uuid = self.req.params.uuid;
-    opts.vmadmLogger = self.vmadmLogger;
 
     vmadm.reprovision(opts, function (error) {
         if (error) {
diff --git a/lib/backends/smartos/tasks/machine_rollback_snapshot.js b/lib/backends/smartos/tasks/machine_rollback_snapshot.js
index b5dcabc..7d5071f 100644
--- a/lib/backends/smartos/tasks/machine_rollback_snapshot.js
+++ b/lib/backends/smartos/tasks/machine_rollback_snapshot.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineRollbackSnapshotTask = module.exports = function (req) {
     Task.call(this);
@@ -24,12 +23,9 @@ function start(callback) {
     var self = this;
     var opts = {};
 
-    self.vmadmLogger = common.makeVmadmLogger(self);
-
     opts = self.req.params;
     opts.log = self.log;
     opts.req_id = self.req.req_id;
-    opts.vmadmLogger = self.vmadmLogger;
 
     vmadm.rollback_snapshot(opts, function (error) {
         var loadOpts = {};
@@ -48,7 +44,6 @@ function start(callback) {
         loadOpts.log = self.log;
         loadOpts.req_id = self.req.req_id;
         loadOpts.uuid = self.req.params.uuid;
-        loadOpts.vmadmLogger = self.vmadmLogger;
 
         vmadm.load(
             loadOpts,
diff --git a/lib/backends/smartos/tasks/machine_screenshot.js b/lib/backends/smartos/tasks/machine_screenshot.js
index 49bbd70..7335103 100644
--- a/lib/backends/smartos/tasks/machine_screenshot.js
+++ b/lib/backends/smartos/tasks/machine_screenshot.js
@@ -12,7 +12,6 @@ var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
 var fs = require('fs');
-var common = require('../common');
 
 var MachineLoadTask = module.exports = function (req) {
     Task.call(this);
@@ -29,7 +28,6 @@ function start(callback) {
     sysrqopts.req_id = self.req.req_id;
     sysrqopts.req = 'screenshot';
     sysrqopts.uuid = self.req.params.uuid;
-    sysrqopts.vmadmLogger = common.makeVmadmLogger(self);
 
     vmadm.sysrq(sysrqopts, function (error, response) {
         if (error) {
diff --git a/lib/backends/smartos/tasks/machine_shutdown.js b/lib/backends/smartos/tasks/machine_shutdown.js
index b7de190..6fc88d8 100644
--- a/lib/backends/smartos/tasks/machine_shutdown.js
+++ b/lib/backends/smartos/tasks/machine_shutdown.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineShutdownTask = module.exports = function (req) {
     Task.call(this);
@@ -47,7 +46,6 @@ function start(callback) {
 
     vmadmOpts.log = self.log;
     vmadmOpts.req_id = self.req.req_id;
-    vmadmOpts.vmadmLogger = common.makeVmadmLogger(self);
 
     loadOpts = vmadmOpts;
     loadOpts.uuid = self.req.params.uuid;
diff --git a/lib/backends/smartos/tasks/machine_update.js b/lib/backends/smartos/tasks/machine_update.js
index 470c6a0..b3a58c4 100644
--- a/lib/backends/smartos/tasks/machine_update.js
+++ b/lib/backends/smartos/tasks/machine_update.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var execFile = require('child_process').execFile;
-var common = require('../common');
 
 var MachineUpdateTask = module.exports = function (req) {
     Task.call(this);
@@ -27,7 +26,6 @@ function start(callback) {
 
     vmadmOpts.log = self.log;
     vmadmOpts.req_id = self.req.req_id;
-    vmadmOpts.vmadmLogger = common.makeVmadmLogger(self);
 
     function _addVmadmOpts(obj) {
         var newobj = obj;
diff --git a/lib/backends/smartos/tasks/machine_update_nics.js b/lib/backends/smartos/tasks/machine_update_nics.js
index 492f8d1..b896ab1 100644
--- a/lib/backends/smartos/tasks/machine_update_nics.js
+++ b/lib/backends/smartos/tasks/machine_update_nics.js
@@ -11,7 +11,6 @@
 var Task = require('../../../task_agent/task');
 var vmadm = require('vmadm');
 var async = require('async');
-var common = require('../common');
 var net = require('net');
 var util = require('util');
 
@@ -201,7 +200,6 @@ function filter_vms(callback) {
     };
     var updates = [];
 
-    opts.vmadmLogger = self.vmadmLogger;
     opts.log = self.log;
     opts.req_id = self.req.req_id;
 
@@ -331,7 +329,6 @@ function perform_updates(callback) {
     }
 
     async.eachSeries(self.updates, function (update, cb) {
-        update.vmadmLogger = self.vmadmLogger;
         update.log = self.log;
         update.req_id = self.req.req_id;
 
@@ -364,8 +361,6 @@ function perform_updates(callback) {
 function start(callback) {
     var self = this;
 
-    self.vmadmLogger = common.makeVmadmLogger(self);
-
     async.waterfall([
         self.pre_check.bind(self),
         self.filter_vms.bind(self),
@@ -383,8 +378,7 @@ function start(callback) {
         var loadOpts = {
             log: self.log,
             req_id: self.req.req_id,
-            uuid: self.req.params.uuid,
-            vmadmLogger: self.vmadmLogger
+            uuid: self.req.params.uuid
         };
 
         vmadm.load(loadOpts, function _load(loadError, machine) {
diff --git a/package.json b/package.json
index b9301e2..e72951a 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "cn-agent",
   "description": "Triton Compute Node Agent",
-  "version": "2.5.0",
+  "version": "2.5.1",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
@@ -12,7 +12,6 @@
     "ctype": "0.5.4",
     "cueball": "2.7.1",
     "digest-stream": "0.2.2",
-    "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
     "imgmanifest": "3.1.0",
     "jsprim": "2.0.0",
     "kstat": "1.0.1",
-- 
2.21.0

