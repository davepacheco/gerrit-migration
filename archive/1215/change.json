{"project":"joyent/illumos-joyent","branch":"master","id":"I1b21b404a7c90bcf4b323de2a3d61d8a62b48df2","number":"1215","subject":"OS-5887 want ugen nodes for devices attached by hid Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Approved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e","owner":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"url":"https://cr.joyent.us/1215","commitMessage":"OS-5887 want ugen nodes for devices attached by hid\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nApproved by: Joshua M. Clulow \u003cjmc@joyent.com\u003e\n","createdOn":1483743554,"lastUpdated":1484008803,"open":false,"status":"MERGED","comments":[{"timestamp":1483743554,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 1."},{"timestamp":1483743922,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 2."},{"timestamp":1483744093,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 3."},{"timestamp":1483745082,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 3:\n\n(5 comments)\n\nIn general, this looks good. I think this\u0027ll also help everyone with a UPS."},{"timestamp":1483745979,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 3:\n\n(5 comments)"},{"timestamp":1483746376,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Uploaded patch set 4."},{"timestamp":1483749831,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1\n\nThanks for the follow ups, Alex."},{"timestamp":1484008140,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1484008667,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1484008747,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1484008803,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Alex Wilson"}],"currentPatchSet":{"number":"6","revision":"ef863daaba22cc716ed3cfc450359044c2e6dde6","parents":["a20de2b86d0939a58dfb2f51057f86b1cbbdc7e3"],"ref":"refs/changes/15/1215/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1484008747,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483749831,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484008140,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"SUBM","value":"1","grantedOn":1484008803,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":204,"deletions":-8},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":221,"sizeDeletions":-15},"patchSets":[{"number":"1","revision":"7cae399e342c48fb35bbd7c0807671604012e000","parents":["3bf32d20a3f6b8bfaabf39e2ef539e46e311e973"],"ref":"refs/changes/15/1215/1","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1483743554,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":203,"deletions":-7},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":12,"deletions":-5},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":3,"deletions":0}],"sizeInsertions":218,"sizeDeletions":-12},{"number":"2","revision":"a997813a5b1753e836a141a932e19eabd90e62f2","parents":["3bf32d20a3f6b8bfaabf39e2ef539e46e311e973"],"ref":"refs/changes/15/1215/2","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1483743922,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":204,"deletions":-8},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":221,"sizeDeletions":-15},{"number":"3","revision":"c215d3e4254cdfe0d2de99ae539b65f4cee4f939","parents":["3bf32d20a3f6b8bfaabf39e2ef539e46e311e973"],"ref":"refs/changes/15/1215/3","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1483744093,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","comments":[{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":511,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Do we want this to be non-fatal in general or should we warn the user in a way that they may actually find out and we have a hope of debugging?"},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":511,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"The policy in other drivers that use ugen seems to be to make it non-fatal like this. Looking at ways we can fail here: it looks like the main one that\u0027s of interest is if ugen tries to create \u003e255 minor nodes for the device. There are some paths via the controller code not returning data to ugen, too. And memory allocation can fail in ddi_create_minor_common and friends (they use KM_NOSLEEP).\n\nI think it\u0027s useful with hid devices to try to continue to init the hid part of it without ugen nodes if we encounter one of these errors, as the hid device may be our system console."},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":801,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I don\u0027t see anything in here that seems like a privilege check. How are we stopping nobody from taking over via ugen?"},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":801,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"ugen nodes are created 0600 root/root, and usb_ugen_open does some additional checks (to make sure the access mode you\u0027re asking for makes sense with the ugen API).\n\nThere are no special privileges needed beyond filesystem rights to touch the device nodes. This is standard across all drivers that engage ugen at the moment."},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":983,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do this under the lock?"},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":983,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It doesn\u0027t need to be. I\u0027ll move it. I cleaned up the other instances of this but missed this one, thanks."},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":1872,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Explicit comparison for hid_ugen_hdl as it\u0027s a pointer. This also occurs in a few other places."},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":1872,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Roger."},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":2331,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Is it safe to release the handle if usb_ugen_detach() fails?"},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","line":2331,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"It turns out that at the moment, usb_ugen_detach() can never fail. And every other ugen driver is calling it this way, too. I suppose that looking at the API it would seem that you should check the return value of detach() first though. It\u0027s not documented."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":204,"deletions":-8},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":221,"sizeDeletions":-15},{"number":"4","revision":"1b21b404a7c90bcf4b323de2a3d61d8a62b48df2","parents":["3bf32d20a3f6b8bfaabf39e2ef539e46e311e973"],"ref":"refs/changes/15/1215/4","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1483746376,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483749831,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484008140,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":204,"deletions":-8},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":221,"sizeDeletions":-15},{"number":"5","revision":"580476bf3cfbfe03c11d666fb016330060c35591","parents":["a20de2b86d0939a58dfb2f51057f86b1cbbdc7e3"],"ref":"refs/changes/15/1215/5","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1484008667,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483749831,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484008140,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":204,"deletions":-8},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":221,"sizeDeletions":-15},{"number":"6","revision":"ef863daaba22cc716ed3cfc450359044c2e6dde6","parents":["a20de2b86d0939a58dfb2f51057f86b1cbbdc7e3"],"ref":"refs/changes/15/1215/6","uploader":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"createdOn":1484008747,"author":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1483749831,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"SUBM","value":"1","grantedOn":1484008803,"by":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1484008140,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"usr/src/uts/common/io/usb/clients/hid/hid.c","type":"MODIFIED","insertions":204,"deletions":-8},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidminor.h","type":"MODIFIED","insertions":13,"deletions":-6},{"file":"usr/src/uts/common/sys/usb/clients/hid/hidvar.h","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":221,"sizeDeletions":-15}],"allReviewers":[{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}