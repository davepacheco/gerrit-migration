From 8768443e8297361ba4b9c5b1fe054c922e857271 Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Wed, 11 Apr 2018 12:05:10 -0700
Subject: [PATCH] joyent/node-sshpk-agent#15 "failure" messages from agent
 should produce nicer errors

---
 lib/client.js | 47 +++++++++++++++++++++++++++++++++++++----------
 1 file changed, 37 insertions(+), 10 deletions(-)

diff --git a/lib/client.js b/lib/client.js
index 9aec5f7..4cc8259 100644
--- a/lib/client.js
+++ b/lib/client.js
@@ -26,7 +26,7 @@ Client.prototype.listKeys = function (opts, cb) {
 	assert.func(cb, 'callback');
 
 	var frame = {type: 'request-identities'};
-	var resps = ['identities-answer'];
+	var resps = ['identities-answer', 'failure'];
 
 	this.doRequest(frame, resps, timeout, function (err, resp) {
 		if (err) {
@@ -34,6 +34,13 @@ Client.prototype.listKeys = function (opts, cb) {
 			return;
 		}
 
+		if (resp.type === 'failure') {
+			cb(new Error('SSH agent returned generic failure ' +
+			    'code to request-identities'));
+			return;
+		}
+		assert.strictEqual(resp.type, 'identities-answer');
+
 		var keys = [];
 		for (var i = 0; i < resp.identities.length; ++i) {
 			var id = resp.identities[i];
@@ -71,7 +78,7 @@ Client.prototype.listCertificates = function (opts, cb) {
 	assert.func(cb, 'callback');
 
 	var frame = {type: 'request-identities'};
-	var resps = ['identities-answer'];
+	var resps = ['identities-answer', 'failure'];
 
 	this.doRequest(frame, resps, timeout, function (err, resp) {
 		if (err) {
@@ -79,6 +86,13 @@ Client.prototype.listCertificates = function (opts, cb) {
 			return;
 		}
 
+		if (resp.type === 'failure') {
+			cb(new Error('SSH agent returned generic failure ' +
+			    'code to request-identities'));
+			return;
+		}
+		assert.strictEqual(resp.type, 'identities-answer');
+
 		var certs = [];
 		for (var i = 0; i < resp.identities.length; ++i) {
 			var id = resp.identities[i];
@@ -136,10 +150,11 @@ Client.prototype.sign = function (key, data, opts, cb) {
 		}
 
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure, no ' +
-			    'reason given'));
+			cb(new Error('SSH agent returned generic failure ' +
+			    'code to sign-request'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'sign-response');
 
 		try {
 			var sig = sshpk.parseSignature(resp.signature,
@@ -428,9 +443,11 @@ Client.prototype.addCertificate = function (cert, key, opts, cb) {
 			return;
 		}
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure'));
+			cb(new Error('SSH agent add-identity command ' +
+			    'failed (not supported or invalid key?)'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'success');
 		cb(null);
 	});
 };
@@ -468,9 +485,11 @@ Client.prototype.addKey = function (key, opts, cb) {
 			return;
 		}
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure'));
+			cb(new Error('SSH agent add-identity command ' +
+			    'failed (not supported or invalid key?)'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'success');
 		cb(null);
 	});
 };
@@ -499,9 +518,11 @@ Client.prototype.removeKey = function (key, opts, cb) {
 			return;
 		}
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure'));
+			cb(new Error('SSH agent remove-identity command ' +
+			    'failed (not supported?)'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'success');
 		cb(null);
 	});
 };
@@ -525,9 +546,11 @@ Client.prototype.removeAllKeys = function (opts, cb) {
 			return;
 		}
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure'));
+			cb(new Error('SSH agent remote-all-identities ' +
+			    'command failed (not supported?)'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'success');
 		cb(null);
 	});
 };
@@ -555,9 +578,11 @@ Client.prototype.lock = function (pw, opts, cb) {
 			return;
 		}
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure'));
+			cb(new Error('SSH agent lock command failed ' +
+			    '(empty or invalid password?)'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'success');
 		cb(null);
 	});
 };
@@ -585,9 +610,11 @@ Client.prototype.unlock = function (pw, opts, cb) {
 			return;
 		}
 		if (resp.type === 'failure') {
-			cb(new Error('SSH agent returned failure'));
+			cb(new Error('SSH agent unlock command failed ' +
+			    '(invalid password?)'));
 			return;
 		}
+		assert.strictEqual(resp.type, 'success');
 		cb(null);
 	});
 };
-- 
2.21.0

