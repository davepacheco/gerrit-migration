{"project":"joyent/illumos-joyent","branch":"master","id":"I3416ecda28031d334306967dcced78e7d41eff8b","number":"3823","subject":"OS-6893 Want basic AHCI enclosure services Reviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e Reviewed by: Rob Johnston \u003crob.johnston@joyent.com\u003e Approved by: Jason King \u003cjason.king@joyent.com\u003e","owner":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"url":"https://cr.joyent.us/3823","commitMessage":"OS-6893 Want basic AHCI enclosure services\nReviewed by: Patrick Mooney \u003cpatrick.mooney@joyent.com\u003e\nReviewed by: Rob Johnston \u003crob.johnston@joyent.com\u003e\nApproved by: Jason King \u003cjason.king@joyent.com\u003e\n","createdOn":1523913986,"lastUpdated":1525130351,"open":false,"status":"MERGED","comments":[{"timestamp":1523913986,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 1."},{"timestamp":1523986551,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 1:\n\n(5 comments)\n\nLooks pretty good to me - just a few minor nits."},{"timestamp":1524000180,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 2."},{"timestamp":1524000184,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 1:\n\n(5 comments)"},{"timestamp":1524000428,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 2: Code-Review+1\n\nLooks good."},{"timestamp":1524180540,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 2:\n\n(10 comments)"},{"timestamp":1524240520,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 3."},{"timestamp":1524629358,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1524860878,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1525120200,"reviewer":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1525130229,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1525130343,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1525130351,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Mustacchi"}],"currentPatchSet":{"number":"5","revision":"3416ecda28031d334306967dcced78e7d41eff8b","parents":["66c901cbd443b11122d6c3b84de5ccb16e76efeb"],"ref":"refs/changes/23/3823/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1525130343,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524629358,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524860878,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525120200,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"SUBM","value":"1","grantedOn":1525130351,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/ahciem/Makefile","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/cmd/ahciem/ahciem.c","type":"ADDED","insertions":302,"deletions":0},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","type":"MODIFIED","insertions":554,"deletions":-8},{"file":"usr/src/uts/common/io/sata/impl/sata.c","type":"MODIFIED","insertions":15,"deletions":-9},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","type":"MODIFIED","insertions":55,"deletions":-1}],"sizeInsertions":1043,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"aaefe65217bac8a8a77f57f6b1f62e7167452d8f","parents":["9f9eb51579cad092cf3b3070d80becbe3355cc3d"],"ref":"refs/changes/23/3823/1","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1523913986,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","comments":[{"file":"manifest","line":4705,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Do we want to also deliver ahciem.h?"},{"file":"manifest","line":4705,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"No, it\u0027s private."},{"file":"usr/src/cmd/ahciem/ahciem.c","line":258,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"Maybe also have \"-h\" print the usage message.  When I encounter a command I\u0027m not familiar with and there\u0027s no manpage, I tend to first run it with \"-h\" to see the usage - but maybe that\u0027s just me :)"},{"file":"usr/src/cmd/ahciem/ahciem.c","line":258,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"That is what will happen here because it will be an unknown option. Though there is a bug in the usage of warnx vs. vwarnx earlier."},{"file":"usr/src/cmd/ahciem/ahciem.c","line":258,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"I\u0027m a fan of making \u0027-h\u0027 explicit, and not announcing it as an unknown option if driving the usage() output is desired.  Up to you, though."},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":57,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"s/set/sent/ ?"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":57,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","line":20,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"s/Enclsoure/Enclosure/"},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","line":20,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Done"},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","line":675,"reviewer":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},"message":"What pragma state is this restoring? I didn\u0027t see a pragma push - or maybe I missed it?"},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","line":675,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The pragma pack at +662. I should probably make it more explicitly an end to the pack."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/ahciem/Makefile","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/cmd/ahciem/ahciem.c","type":"ADDED","insertions":301,"deletions":0},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","type":"MODIFIED","insertions":551,"deletions":-7},{"file":"usr/src/uts/common/io/sata/impl/sata.c","type":"MODIFIED","insertions":15,"deletions":-9},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","type":"MODIFIED","insertions":55,"deletions":-1}],"sizeInsertions":1039,"sizeDeletions":-18},{"number":"2","revision":"7aff386103521058b547eee2a8734ee644263090","parents":["9f9eb51579cad092cf3b3070d80becbe3355cc3d"],"ref":"refs/changes/23/3823/2","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1524000180,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524000428,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"comments":[{"file":"usr/src/cmd/ahciem/ahciem.c","line":75,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"should this be \"noactivity\"?"},{"file":"usr/src/cmd/ahciem/ahciem.c","line":85,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"These could be constructed via preprocessor concatenation via the ACHIEM_* defines, avoiding future mix-ups between the led-\u003estring and string-\u003eled functions.  (But simple might be better.  It\u0027s up to you)"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":473,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Any reason why these aren\u0027t static?"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":10471,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"locally cache this to protect against weirdness from runtime changes? (and/or change to \u003e\u003d comparison)"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":10492,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"same as above"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":10604,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Sound probably cache this locally in case it is changed during runtime"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":10782,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Why assign this here when it\u0027s done below, unconditionally?"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":10799,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"style nit: I\u0027d prefer to see this wrapped in parens"},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","line":10843,"reviewer":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},"message":"Should the logic which submits requests to the taskq check this flag as well, prior to submission, or does ahci ordering prevent the need?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/ahciem/Makefile","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/cmd/ahciem/ahciem.c","type":"ADDED","insertions":301,"deletions":0},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","type":"MODIFIED","insertions":551,"deletions":-7},{"file":"usr/src/uts/common/io/sata/impl/sata.c","type":"MODIFIED","insertions":15,"deletions":-9},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","type":"MODIFIED","insertions":55,"deletions":-1}],"sizeInsertions":1039,"sizeDeletions":-18},{"number":"3","revision":"cb115ccdbbc7c613337a4650cf08e0a8ce053596","parents":["7c5e4381770bd2b9a10d2fddb545c6883a87abe0"],"ref":"refs/changes/23/3823/3","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1524240520,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524860878,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525120200,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524629358,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/ahciem/Makefile","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/cmd/ahciem/ahciem.c","type":"ADDED","insertions":302,"deletions":0},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","type":"MODIFIED","insertions":554,"deletions":-8},{"file":"usr/src/uts/common/io/sata/impl/sata.c","type":"MODIFIED","insertions":15,"deletions":-9},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","type":"MODIFIED","insertions":55,"deletions":-1}],"sizeInsertions":1043,"sizeDeletions":-19},{"number":"4","revision":"7d926c3a31749694b62e23a65c9f4da0d3b8b402","parents":["66c901cbd443b11122d6c3b84de5ccb16e76efeb"],"ref":"refs/changes/23/3823/4","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1525130229,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524860878,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525120200,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524629358,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/ahciem/Makefile","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/cmd/ahciem/ahciem.c","type":"ADDED","insertions":302,"deletions":0},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","type":"MODIFIED","insertions":554,"deletions":-8},{"file":"usr/src/uts/common/io/sata/impl/sata.c","type":"MODIFIED","insertions":15,"deletions":-9},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","type":"MODIFIED","insertions":55,"deletions":-1}],"sizeInsertions":1043,"sizeDeletions":-19},{"number":"5","revision":"3416ecda28031d334306967dcced78e7d41eff8b","parents":["66c901cbd443b11122d6c3b84de5ccb16e76efeb"],"ref":"refs/changes/23/3823/5","uploader":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"createdOn":1525130343,"author":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1525130351,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524860878,"by":{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1525120200,"by":{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1524629358,"by":{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"manifest","type":"MODIFIED","insertions":2,"deletions":0},{"file":"usr/src/cmd/Makefile","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"usr/src/cmd/ahciem/Makefile","type":"ADDED","insertions":39,"deletions":0},{"file":"usr/src/cmd/ahciem/ahciem.c","type":"ADDED","insertions":302,"deletions":0},{"file":"usr/src/uts/common/io/sata/adapters/ahci/ahci.c","type":"MODIFIED","insertions":554,"deletions":-8},{"file":"usr/src/uts/common/io/sata/impl/sata.c","type":"MODIFIED","insertions":15,"deletions":-9},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahciem.h","type":"ADDED","insertions":74,"deletions":0},{"file":"usr/src/uts/common/sys/sata/adapters/ahci/ahcivar.h","type":"MODIFIED","insertions":55,"deletions":-1}],"sizeInsertions":1043,"sizeDeletions":-19}],"allReviewers":[{"name":"Rob Johnston","email":"rob.johnston@joyent.com","username":"rejohnst"},{"name":"Patrick Mooney","email":"pmooney@pfmooney.com","username":"pfmooney"},{"name":"Jason King","email":"jason.king@joyent.com","username":"jasonbking"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}]}