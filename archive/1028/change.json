{"project":"joyent/smartos-live","branch":"master","id":"I2d591807eab8cfab999cd52003a617e9ce009ad5","number":"1028","subject":"OS-5783 make .zonecontrol a mount from the GZ instead of a directory in the dataset Reviewed by: Robert Mustacchi \u003crm@joyent.com\u003e Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/1028","commitMessage":"OS-5783 make .zonecontrol a mount from the GZ instead of a directory in the dataset\nReviewed by: Robert Mustacchi \u003crm@joyent.com\u003e\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1480535513,"lastUpdated":1481245237,"open":false,"status":"MERGED","comments":[{"timestamp":1480535513,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1480535514,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 44d4e65caf369a02271e09e43f44f2f879b3da61\n    \n    cleanup KVM handling to avoid trying to connect to sockets for deleted zones\n    \n    commit 9dcdd45ab67d34c5bcbe577352711c06c3ed2c80\n    \n    move sockets to /var/zonecontrol\n    \n    commit 9ac56cb060c61b1804a4d64dc7265cbe44783c09\n    \n    fix make check\n    \n    commit 70d0dc51b4d9764d66164fdeb30fd7a778f06883\n    \n    move sockets to /etc/zonecontrol\n    \n    commit 9da63d461a29bfeeac6b36306b212594a8ddb4ba\n    \n    fix make check\n    \n    commit 07d777204146f10faf09d850845ab2f82c3ed55b\n    \n    Merge branch \u0027master\u0027 into OS-5783\n    \n    commit f9ebc7b906de4711c5a5ffd39a9f5b2ca4ed46f9\n    \n    updates for RFD 69\n    \n    commit cfdf3edb89fe1fa4a2ce28e0322cd19ee192ddbb\n    \n    mount zonecontrol for joyent + joyent-minimal\n    \n    commit 4bcc7d725511553f9f4ef9d8510f7db84762bbfb\n    \n    make .zonecontrol a mount from the GZ instead of a directory in the dataset"},{"timestamp":1480536281,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1480702438,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1480702509,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1480974232,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(5 comments)\n\nThis looks pretty good in general. I\u0027d probably get another pair of eyes on the metadata changes itself. While I went through them, not sure if I followed them 100% correctly."},{"timestamp":1481052906,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1481052907,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 3c4ed298b71c0d9f25288321e89c7a9f276a6105\n    \n    fixes\n    \n    commit 4df24ebb987320cce4c3c5adbdc6bce5b475397a\n    \n    Merge branch \u0027master\u0027 into OS-5783"},{"timestamp":1481052953,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481053241,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4."},{"timestamp":1481053242,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit d9cdb57f3b013fd2c6012e8e8aaad24909730f23\n    \n    fixes\n    \n    commit 4df24ebb987320cce4c3c5adbdc6bce5b475397a\n    \n    Merge branch \u0027master\u0027 into OS-5783\n    \n    commit 44d4e65caf369a02271e09e43f44f2f879b3da61\n    \n    cleanup KVM handling to avoid trying to connect to sockets for deleted zones\n    \n    commit 9dcdd45ab67d34c5bcbe577352711c06c3ed2c80\n    \n    move sockets to /var/zonecontrol\n    \n    commit 9ac56cb060c61b1804a4d64dc7265cbe44783c09\n    \n    fix make check\n    \n    commit 70d0dc51b4d9764d66164fdeb30fd7a778f06883\n    \n    move sockets to /etc/zonecontrol\n    \n    commit 9da63d461a29bfeeac6b36306b212594a8ddb4ba\n    \n    fix make check\n    \n    commit 07d777204146f10faf09d850845ab2f82c3ed55b\n    \n    Merge branch \u0027master\u0027 into OS-5783\n    \n    commit f9ebc7b906de4711c5a5ffd39a9f5b2ca4ed46f9\n    \n    updates for RFD 69\n    \n    commit cfdf3edb89fe1fa4a2ce28e0322cd19ee192ddbb\n    \n    mount zonecontrol for joyent + joyent-minimal\n    \n    commit 4bcc7d725511553f9f4ef9d8510f7db84762bbfb\n    \n    make .zonecontrol a mount from the GZ instead of a directory in the dataset"},{"timestamp":1481053300,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481053489,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 5."},{"timestamp":1481053490,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\nNew commits:\n    \n    commit 5f129e8cc35bcdb17e54eb77ef955d46b973be1d\n    \n    fixes\n    \n    commit 4df24ebb987320cce4c3c5adbdc6bce5b475397a\n    \n    Merge branch \u0027master\u0027 into OS-5783\n    \n    commit 44d4e65caf369a02271e09e43f44f2f879b3da61\n    \n    cleanup KVM handling to avoid trying to connect to sockets for deleted zones\n    \n    commit 9dcdd45ab67d34c5bcbe577352711c06c3ed2c80\n    \n    move sockets to /var/zonecontrol\n    \n    commit 9ac56cb060c61b1804a4d64dc7265cbe44783c09\n    \n    fix make check\n    \n    commit 70d0dc51b4d9764d66164fdeb30fd7a778f06883\n    \n    move sockets to /etc/zonecontrol\n    \n    commit 9da63d461a29bfeeac6b36306b212594a8ddb4ba\n    \n    fix make check\n    \n    commit 07d777204146f10faf09d850845ab2f82c3ed55b\n    \n    Merge branch \u0027master\u0027 into OS-5783\n    \n    commit f9ebc7b906de4711c5a5ffd39a9f5b2ca4ed46f9\n    \n    updates for RFD 69\n    \n    commit cfdf3edb89fe1fa4a2ce28e0322cd19ee192ddbb\n    \n    mount zonecontrol for joyent + joyent-minimal\n    \n    commit 4bcc7d725511553f9f4ef9d8510f7db84762bbfb\n    \n    make .zonecontrol a mount from the GZ instead of a directory in the dataset"},{"timestamp":1481053570,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\n(5 comments)"},{"timestamp":1481053583,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1481078743,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 5: Code-Review+1\n\nThanks for follow ups Josh. I\u0027d probably get another pair of eyes on the metadata agent part from someone more familiar with that code base."},{"timestamp":1481239360,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5: Code-Review+1\n\n(4 comments)\n\nPosted some comments, but the changes look good to me."},{"timestamp":1481240082,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5:\n\n(4 comments)"},{"timestamp":1481241150,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 5:\n\n(1 comment)"},{"timestamp":1481243501,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1481243539,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6:\n\n\"make check\" passed ok"},{"timestamp":1481243584,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1481243625,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 7."},{"timestamp":1481243664,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 8: Patch Set 7 was rebased"},{"timestamp":1481243666,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1481243716,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8:\n\n\"make check\" passed ok"},{"timestamp":1481245237,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"8","revision":"8074b65033c088e50f9abaed4294358704396d0f","parents":["78cf71138f7336ed4b7850c415df2c55231d65ea"],"ref":"refs/changes/28/1028/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481243664,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481053583,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481078743,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481239360,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481243584,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1481245237,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":212,"sizeDeletions":-439},"patchSets":[{"number":"1","revision":"e5020835e32480aa13827d476067cf511d03595d","parents":["b18efbec2db5be64e27d656ea26994ce3575641d"],"ref":"refs/changes/28/1028/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1480535513,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480536281,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":29,"deletions":0}],"sizeInsertions":222,"sizeDeletions":-439},{"number":"2","revision":"93e71000b17c0bf4d88347dfd90b751db4cd6273","parents":["859a75f1950ca9d463ec87cb5e35f8a2ec6df74f"],"ref":"refs/changes/28/1028/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1480702438,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1480536281,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"overlay/generic/lib/svc/method/svc-zones","line":180,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Should we care about the permissions or owner of this directory like we do with the sub-directories?"},{"file":"overlay/generic/lib/svc/method/svc-zones","line":180,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Done"},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","line":38,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I wonder if it\u0027s worth adding a nodevices, nosetuid, and noexec here as mount options to further restrict what can be done in this FS."},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","line":38,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Done"},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","line":38,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"I wonder if it\u0027s worth adding a nodevices, nosetuid, and noexec here as mount options to further restrict what can be done in this FS."},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","line":38,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Done"},{"file":"src/vm/lib/metadata/agent.js","line":745,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"The abort comment here was a little confusing. At first it might be suggesting that we should end up aborting the process where as I think this is suggesting that we should abort the waterfall. Might be worth clarifying."},{"file":"src/vm/lib/metadata/agent.js","line":745,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Done"},{"file":"src/vm/lib/metadata/zwatch.js","line":2,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"If we\u0027re adding these, can we use the updated prototype from the illumos usr/src/prototype directory? Which is a bit more concise."},{"file":"src/vm/lib/metadata/zwatch.js","line":2,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":29,"deletions":0}],"sizeInsertions":222,"sizeDeletions":-439},{"number":"3","revision":"ab51d1aec5f5813584211206e2997e5c89f8ff02","parents":["07df6e96b60b3ebdce991e22f02023972f7dc499"],"ref":"refs/changes/28/1028/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481052906,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481052953,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":29,"deletions":0}],"sizeInsertions":222,"sizeDeletions":-439},{"number":"4","revision":"ffc276f305d926b61de3a93b88adc426294bc698","parents":["07df6e96b60b3ebdce991e22f02023972f7dc499"],"ref":"refs/changes/28/1028/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481053241,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481053300,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":29,"deletions":0}],"sizeInsertions":222,"sizeDeletions":-439},{"number":"5","revision":"5368311c3cb1b15b613579381322d1c9b7007800","parents":["07df6e96b60b3ebdce991e22f02023972f7dc499"],"ref":"refs/changes/28/1028/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481053489,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481078743,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481053583,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481239360,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"src/vm/lib/metadata/agent.js","line":918,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Isn\u0027t this directory supposed to be created on state change now? If so this code would still work as expected, but I\u0027m wondering what it would mean for the directory to not exist at this point."},{"file":"src/vm/lib/metadata/agent.js","line":918,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Because we\u0027re watching for zone creation, it\u0027s possible we\u0027ll see the create event and get here before the zone has actually started for the first time. I believe in that case (if it never got to ready yet) the directory would not yet exist when we\u0027re creating the socket."},{"file":"src/vm/lib/metadata/agent.js","line":937,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Would it simplify things to use a line-streaming npm module? Maybe not in this case because it would mean bundling the module\u0027s code into the code repository?\n\nActually I just realized that this code already existed, and we\u0027re introducing extra code, so this could be taken care of in a subsequent change if it would help."},{"file":"src/vm/lib/metadata/agent.js","line":937,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"yep, it\u0027s a good point though. I\u0027ve created OS-5839 to look into this at some point."},{"file":"src/vm/lib/metadata/agent.js","line":988,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What is handling the deletion of the socket when the zone is deleted? I assume this is the code that handles the zone\u0027s lifecycle, but I thought I\u0027d make sure this assumption is correct."},{"file":"src/vm/lib/metadata/agent.js","line":988,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"yep, see the change in /overlay/generic/usr/lib/brand/jcommon/cuninstall bundled with this, that script is run when the zone is being deleted and will rm -rf the zonecontrol/\u003cuuid\u003e directory."},{"file":"src/vm/lib/metadata/agent.js","line":1008,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is using/storing the fd that points to the UNIX socket directly still the best way to hold a reference to the UNIX socket? If I understand correctly, this was necessary because previously node-zsock would return a fd, but maybe now using/storing only the path to the UNIX socket would be best?"},{"file":"src/vm/lib/metadata/agent.js","line":1008,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"The reason for continuing to store the fd here is that I thought when we have a core it is useful when looking at the open files (with say pfiles) to be able to tie that to a specific zone\u0027s socket when we\u0027re trying to account for which fd is held for which zone. If we were leaking fds for example, it could be useful to know which ones we thought were active and what zone they belong to."},{"file":"src/vm/lib/metadata/agent.js","line":1008,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"OK, but wouldn\u0027t pfiles output the file name of each fd, which contains the zone UUID?"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":212,"sizeDeletions":-439},{"number":"6","revision":"206e34d72bed4125347fa8f5dde719659301579b","parents":["78cf71138f7336ed4b7850c415df2c55231d65ea"],"ref":"refs/changes/28/1028/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481243501,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481078743,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481053583,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481243584,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481239360,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":212,"sizeDeletions":-439},{"number":"7","revision":"2d591807eab8cfab999cd52003a617e9ce009ad5","parents":["07df6e96b60b3ebdce991e22f02023972f7dc499"],"ref":"refs/changes/28/1028/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481243625,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481078743,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481053583,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481239360,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":212,"sizeDeletions":-439},{"number":"8","revision":"8074b65033c088e50f9abaed4294358704396d0f","parents":["78cf71138f7336ed4b7850c415df2c55231d65ea"],"ref":"refs/changes/28/1028/8","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1481243664,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481078743,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1481053583,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1481243584,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1481245237,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1481239360,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"overlay/generic/lib/svc/method/svc-zones","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/cuninstall","type":"MODIFIED","insertions":1,"deletions":0},{"file":"overlay/generic/usr/lib/brand/jcommon/statechange","type":"MODIFIED","insertions":3,"deletions":0},{"file":"overlay/generic/usr/lib/brand/joyent-minimal/platform.xml","type":"MODIFIED","insertions":4,"deletions":-1},{"file":"overlay/generic/usr/lib/brand/joyent/platform.xml","type":"MODIFIED","insertions":3,"deletions":-1},{"file":"src/vm/lib/metadata/agent.js","type":"MODIFIED","insertions":174,"deletions":-436},{"file":"src/vm/lib/metadata/common.js","type":"MODIFIED","insertions":5,"deletions":-1},{"file":"src/vm/lib/metadata/zwatch.js","type":"MODIFIED","insertions":19,"deletions":0}],"sizeInsertions":212,"sizeDeletions":-439}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}