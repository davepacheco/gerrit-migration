{"project":"joyent/muppet","branch":"master","id":"I20e768dc6ce63fa46c4ad64607e99d9490ecc79c","number":"5414","subject":"MANTA-4071 muppet cannot find zk path \"The specified ZooKeeper path does not exist\"","owner":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"url":"https://cr.joyent.us/5414","commitMessage":"MANTA-4071 muppet cannot find zk path \"The specified ZooKeeper path does not exist\"\n","createdOn":1548262858,"lastUpdated":1548896578,"open":false,"status":"MERGED","comments":[{"timestamp":1548262858,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 1."},{"timestamp":1548262898,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548263715,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 2."},{"timestamp":1548263717,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit c47407b8bf9cf5927905dd544b1245a3fa5b63da\n    \n    Remove some testing code"},{"timestamp":1548263746,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548280572,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1548280873,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1548281725,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1548282281,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1548283527,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1548284191,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Uploaded patch set 3."},{"timestamp":1548284193,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit c8fa40e2ad3367613fef31ba4aa4c81f84d56975\n    \n    Remove some of the information MANTA-4064 info gathering code"},{"timestamp":1548284212,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1548284217,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548284244,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1548371783,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4:\n\n(1 comment)\n\nLooks good otherwise."},{"timestamp":1548372986,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Patch Set 4:\n\n(1 comment)"},{"timestamp":1548373158,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Patch Set 4: Code-Review+1\n\n(1 comment)"},{"timestamp":1548884073,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1548885644,"reviewer":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},"message":"Patch Set 4: Code-Review+1 -Integration-Approval\n\nWe\u0027ve run the experimental image in prod and aren\u0027t seeing any issues with it so far, so I\u0027m giving this a +1."},{"timestamp":1548895606,"reviewer":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1548896578,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Kelly McLaughlin"}],"currentPatchSet":{"number":"4","revision":"4d082e57dc3311f4965cd15fd05a79ff9f28bd29","parents":["8118e45cd65c133140f8add8b40dad62d438060f"],"ref":"refs/changes/14/5414/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1548284212,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548284244,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548373158,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548885644,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548895606,"by":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}},{"type":"SUBM","value":"1","grantedOn":1548896578,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"comments":[{"file":"lib/watch.js","line":144,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we now set err.path?"},{"file":"lib/watch.js","line":144,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I wanted to capture the child path(s) that failed for logging in the NO_NODE error case so we\u0027d have more info for debugging if a host was perpetually failing lookup. Prior to this all we logged was `self.path` which wasn\u0027t helpful to determine which of the children actually failed."},{"file":"lib/watch.js","line":144,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Thanks for the clarification. I wasn\u0027t sure if setting arbitrary properties was good or not (in case they conflicted), but makes sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":89,"deletions":-47},{"file":"muppet.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":100,"sizeDeletions":-48},"patchSets":[{"number":"1","revision":"7459a5b97f35e5ba4dc795f0adeef2188ef929e6","parents":["b47f952a8b6823e40da84dac916abe34e416e705"],"ref":"refs/changes/14/5414/1","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1548262858,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548262898,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":118,"deletions":-51},{"file":"muppet.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":129,"sizeDeletions":-52},{"number":"2","revision":"bdc61160b8f303bcf540aae35f0bb42851d388f7","parents":["b47f952a8b6823e40da84dac916abe34e416e705"],"ref":"refs/changes/14/5414/2","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1548263715,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548263746,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/watch.js","line":143,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Honestly I\u0027d prefer to see this phrased in the more idiomatic node way (which we see elsewhere here when one branch is much longer than the other):\n\n    if (err) {\n      ...\n      _cb(err);\n      return;\n    }\n    ... rest of code ..."},{"file":"lib/watch.js","line":151,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Coming back to this case again, what was the example where this was triggered?"},{"file":"lib/watch.js","line":151,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"I\u0027m not sure why we need this extra branch here when the else below it will still correctly include the entire object in the log message? Also... this seems like guarding against a programmatic error (the wrong types being produced by zkstream) with operational error semantics (logging and throwing it away). I believe we *should* blow up here and end the process if _obj is not a buffer and err is null -- anything else is a serious bug in the zk client and should be fixed there, not worked around and ignored here. The code in that module is wrong if this workaround is needed."},{"file":"lib/watch.js","line":151,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Yeah, that\u0027s a good point about the extra branch. I was being very cautious to ensure we collected the data necessary to gain further understanding, but I can remove the extra branch. \n\nIt definitely is guarding against programmatic error and is only intended to be temporary. Muppet currently doesn\u0027t generate core files (MANTA-4069 will address that) so I added this to be able to collect more information about the problem since I wasn\u0027t able to catch it live over a few days and it was causing ops some headaches."},{"file":"lib/watch.js","line":151,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"This was based on the original description provided in MANTA-4064:\n\n```\n[object Object]\n ^\n\nSyntaxError: Unexpected token o\n    at Object.parse (native)\n    at ZKRequest.\u003canonymous\u003e (/opt/smartdc/muppet/lib/watch.js:143:38)\n    at ZKRequest.g (events.js:260:16)\n    at emitTwo (events.js:92:20)\n    at ZKRequest.emit (events.js:172:7)\n    at ZKConnectionFSM.processReply (/opt/smartdc/muppet/node_modules/zkstream/lib/connection-fsm.js:347:7)\n    at ZKDecodeStream.onZkReadable (/opt/smartdc/muppet/node_modules/zkstream/lib/connection-fsm.js:210:9)\n    at emitNone (events.js:67:13)\n    at ZKDecodeStream.emit (events.js:166:7)\n    at emitReadable_ (_stream_readable.js:419:10)\n    at emitReadable (_stream_readable.js:413:7)\n    at readableAddChunk (_stream_readable.js:164:13)\n```"},{"file":"lib/watch.js","line":151,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Given that the changes for MANTA-4069 are approved to merge I\u0027m gonna go ahead and remove these extra checks entirely since for the next deployment we\u0027ll be able to collect core files."},{"file":"lib/watch.js","line":153,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"Can you please point to exactly where in MANTA-4064 we saw an object instance that\u0027s not a Buffer come back as the second arg to this function when there was no err? Because I can\u0027t seem to see that there. That would also be a pretty serious bug in the ZK client, and I\u0027ve gone and re-read all of that logic in zkstream and I can\u0027t see any obvious way it would mess up to this level (returning something other than a Buffer as that first argument if no error was returned)"},{"file":"lib/watch.js","line":153,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"This was based on the original description provided in MANTA-4064:\n\n```\n[object Object]\n ^\n\nSyntaxError: Unexpected token o\n    at Object.parse (native)\n    at ZKRequest.\u003canonymous\u003e (/opt/smartdc/muppet/lib/watch.js:143:38)\n    at ZKRequest.g (events.js:260:16)\n    at emitTwo (events.js:92:20)\n    at ZKRequest.emit (events.js:172:7)\n    at ZKConnectionFSM.processReply (/opt/smartdc/muppet/node_modules/zkstream/lib/connection-fsm.js:347:7)\n    at ZKDecodeStream.onZkReadable (/opt/smartdc/muppet/node_modules/zkstream/lib/connection-fsm.js:210:9)\n    at emitNone (events.js:67:13)\n    at ZKDecodeStream.emit (events.js:166:7)\n    at emitReadable_ (_stream_readable.js:419:10)\n    at emitReadable (_stream_readable.js:413:7)\n    at readableAddChunk (_stream_readable.js:164:13)\n```"},{"file":"lib/watch.js","line":206,"reviewer":{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"},"message":"This code check is redundant. Just looking for the ZKPingTimeoutError name is fine."},{"file":"lib/watch.js","line":206,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Cool, I\u0027ll simplify that."},{"file":"muppet.js","line":246,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"So for the cases which aren\u0027t the ones you called out elsewhere (NO_NODE, ping timeout), this will swallow all of them and just log it. do emitted errors here have any impact on the underlying connection to ZK or anything else? Even if these don\u0027t represent programmer error and mean that we should handle them, is there really nothing else we should do other than just log it?"},{"file":"muppet.js","line":246,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"Errors with the underlying session should result in events on  the zk client that tell muppet to attempt a new connection or give up if it doesn\u0027t work. The errors on watch activity shouldn\u0027t affect muppet\u0027s ability to continue working and the watch should continue to get updated as new `childrenChanged` events come in. That\u0027s what should happen. A lot of this behavior has been covered up by the previous issue and I don\u0027t have long enough experience watching all the errors that happen to say that for sure. We could still abort in the new error handler after logging if you think that\u0027s a safer approach, but it could mean yet another fix for routine error conditions that throw muppet into maintenance mode. I don\u0027t know, I could honestly go either way on it."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":115,"deletions":-51},{"file":"muppet.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":126,"sizeDeletions":-52},{"number":"3","revision":"20e768dc6ce63fa46c4ad64607e99d9490ecc79c","parents":["b47f952a8b6823e40da84dac916abe34e416e705"],"ref":"refs/changes/14/5414/3","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1548284191,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548284217,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":89,"deletions":-47},{"file":"muppet.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":100,"sizeDeletions":-48},{"number":"4","revision":"4d082e57dc3311f4965cd15fd05a79ff9f28bd29","parents":["8118e45cd65c133140f8add8b40dad62d438060f"],"ref":"refs/changes/14/5414/4","uploader":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"createdOn":1548284212,"author":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548373158,"by":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1548284244,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1548885644,"by":{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1548895606,"by":{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"}},{"type":"SUBM","value":"1","grantedOn":1548896578,"by":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"}}],"comments":[{"file":"lib/watch.js","line":144,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Why do we now set err.path?"},{"file":"lib/watch.js","line":144,"reviewer":{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},"message":"I wanted to capture the child path(s) that failed for logging in the NO_NODE error case so we\u0027d have more info for debugging if a host was perpetually failing lookup. Prior to this all we logged was `self.path` which wasn\u0027t helpful to determine which of the children actually failed."},{"file":"lib/watch.js","line":144,"reviewer":{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},"message":"Thanks for the clarification. I wasn\u0027t sure if setting arbitrary properties was good or not (in case they conflicted), but makes sense."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/watch.js","type":"MODIFIED","insertions":89,"deletions":-47},{"file":"muppet.js","type":"MODIFIED","insertions":10,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":100,"sizeDeletions":-48}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Robert Mustacchi","email":"rm+illumos@fingolfin.org","username":"rmustacc"},{"name":"Brian Bennett","email":"brian.bennett@joyent.com","username":"bahamat"},{"name":"Brittany Wald","email":"brittany.wald@joyent.com","username":"princesspretzel"},{"name":"Kelly McLaughlin","email":"kelly.mclaughlin@joyent.com","username":"kellymclaughlin"},{"name":"Alex Wilson","email":"alex@cooperi.net","username":"arekinath"}]}