From 00d95d8a0dbd01c53f6cc22f22dd6bbf13befb22 Mon Sep 17 00:00:00 2001
From: Marsell Kukuljevic <marsell@joyent.com>
Date: Tue, 18 Oct 2016 15:29:12 +1300
Subject: [PATCH] PUBAPI-1310: Upgrade Node.js to v4 before 0.10 EOL in Oct
 2016

---
 Makefile              |  4 ++--
 docs/index.md         | 10 +++++++++
 etc/cloudapi.coal.cfg | 47 +++++++++++++++++++++++++++++--------------
 lib/app.js            | 38 +++++-----------------------------
 lib/machines.js       | 24 ++++++++++++++--------
 package.json          | 18 ++++++++---------
 test/common.js        |  2 +-
 7 files changed, 75 insertions(+), 68 deletions(-)

diff --git a/Makefile b/Makefile
index 753d0fa..e1f4c2f 100644
--- a/Makefile
+++ b/Makefile
@@ -47,9 +47,9 @@ CLEAN_FILES	+= node_modules cscope.files
 
 # The prebuilt sdcnode version we want. See
 # "tools/mk/Makefile.node_prebuilt.targ" for details.
-NODE_PREBUILT_VERSION=v0.10.47
+NODE_PREBUILT_VERSION=v4.6.0
 ifeq ($(shell uname -s),SunOS)
-	NODE_PREBUILT_IMAGE=de411e86-548d-11e4-a4b7-3bb60478632a
+	NODE_PREBUILT_IMAGE=18b094b0-eb01-11e5-80c1-175dac7ddf02
 	NODE_PREBUILT_TAG=zone
 endif
 
diff --git a/docs/index.md b/docs/index.md
index e13a2fb..d497992 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -859,6 +859,15 @@ variable or the `--api-version=RANGE` option to each command.
 
 The rest of this section describes API changes in each version.
 
+
+## 8.1.0
+
+- This version should have no visible API changes, but updates a lot of
+  libraries that Cloudapi depends on, as well as the nodejs major version.
+  Visible differences with 8.0.0 are bugs, but it's possible some might have
+  crept through.
+
+
 ## 8.0.0
 
 - Instance/machine objects (from GetMachine, ListMachines) now has a `brand`
@@ -885,6 +894,7 @@ The rest of this section describes API changes in each version.
 - Network fabrics (software-defined networking) support.
   This allows the creation of virtual LANs and layer-three networks.
 
+
 ## 7.2.0
 
 - RBAC v1 has been made available on the CloudAPI interface. Accounts can create
diff --git a/etc/cloudapi.coal.cfg b/etc/cloudapi.coal.cfg
index 7b8968d..1773ada 100644
--- a/etc/cloudapi.coal.cfg
+++ b/etc/cloudapi.coal.cfg
@@ -17,7 +17,7 @@
          "*": true
     },
     "ufds": {
-        "url": "ldaps://10.99.99.18",
+        "url": "ldaps://ufds.coal.joyent.us",
         "bindDN": "cn=root",
         "bindPassword": "secret",
         "cache": {
@@ -45,31 +45,48 @@
         }
     },
     "wfapi": {
-        "url": "http://10.99.99.19"
-    },
-    "cnapi": {
-        "url": "http://10.99.99.22"
+        "url": "http://workflow.coal.joyent.us"
     },
     "vmapi": {
-        "url": "http://10.99.99.27"
+        "url": "http://vmapi.coal.joyent.us"
     },
-    "napi": {
-        "url": "http://10.99.99.10"
+    "cnapi": {
+        "url": "http://cnapi.coal.joyent.us"
     },
-    "imgapi": {
-        "url": "http://10.99.99.21"
+    "napi": {
+        "url": "http://napi.coal.joyent.us"
     },
     "fwapi": {
-        "url": "http://10.99.99.26"
+        "url": "http://fwapi.coal.joyent.us"
+    },
+    "imgapi": {
+        "url": "http://imgapi.coal.joyent.us"
     },
     "papi": {
-        "url": "http://10.99.99.29"
+        "url": "http://papi.coal.joyent.us"
     },
     "ca": {
-        "url": "http://10.99.99.30:23181"
+        "url": "http://ca.coal.joyent.us:23181"
+    },
+    "cueballHttpAgent": {
+        "resolvers": ["binder.coal.joyent.us"],
+        "initialDomains": [
+            "mahi.coal.joyent.us"
+        ],
+        "spares": 4,
+        "maximum": 10,
+        "recovery": {
+            "default": {
+                "timeout": 2000,
+                "maxTimeout": 8000,
+                "retries": 5,
+                "delay": 250,
+                "maxDelay": 1000
+            }
+        }
     },
     "mahi": {
-        "url": "http://10.99.99.33",
+        "url": "http://mahi.coal.joyent.us",
         "maxAuthCacheSize": 1000,
         "maxAuthCacheAgeMs": 300,
         "maxTranslationCacheSize": 1000,
@@ -82,7 +99,7 @@
     },
     "maxHttpSockets": 100,
     "datacenters": {
-        "coal": "http://127.0.0.1"
+        "coal": "https://cloudapi.coal.joyent.us"
     },
     "plugins": [
         {
diff --git a/lib/app.js b/lib/app.js
index 06b9ab4..0b379a8 100644
--- a/lib/app.js
+++ b/lib/app.js
@@ -345,36 +345,7 @@ module.exports = {
         var machineThrottle;
 
         config.name = 'Joyent Triton ' + version();
-        config.version = ['8.0.0', '7.3.0', '7.2.0', '7.1.0', '7.0.0'];
-        config.formatters = {
-            'text/html': function formatHTML(req, res, body) {
-                if (typeof (body) === 'string') {
-                    return body;
-                }
-
-                var html;
-                if (body instanceof Error) {
-                    html = sprintf(HTML_FMT, body.stack);
-                } else if (Buffer.isBuffer(body)) {
-                    html = sprintf(HTML_FMT, body.toString('base64'));
-                } else {
-                    html = sprintf(HTML_FMT, body.toString());
-                }
-
-                return html;
-            },
-            'text/css': function formatCSS(req, res, body) {
-                if (typeof (body) === 'string') {
-                    return body;
-                }
-
-                return '';
-            },
-
-            'image/png': function formatPNG(req, res, body) {
-                return body;
-            }
-        };
+        config.version = ['8.1.0', '8.0.0', '7.3.0', '7.2.0', '7.1.0', '7.0.0'];
 
         if (config.dc_maint_eta) {
             var d = new Date(config.dc_maint_eta);
@@ -631,10 +602,10 @@ module.exports = {
                 policies.mount(server, userThrottle(config, 'policies'),
                         config);
                 roles.mount(server, userThrottle(config, 'roles'), config);
-                resources.mount(server, userThrottle(config, 'resources'),
-                        config);
                 nics.mount(server, userThrottle(config, 'nics'));
                 mod_config.mount(server, userThrottle(config, 'config'));
+                resources.mount(server, userThrottle(config, 'resources'),
+                        config);
 
                 server.on('after', auditLogger({
                     log: log.child({component: 'audit'})
@@ -698,10 +669,11 @@ module.exports = {
                     });
                 });
 
-                server.on('uncaughtException', function (req, res, route, err) {
+                server.on('uncaughtException', function (req, res, err, cb) {
                     var e = new restify.InternalError('Internal Error');
                     req.log.error(err, 'unexpected error');
                     res.send(e);
+                    cb();
                 });
 
                 server._clients = clients;
diff --git a/lib/machines.js b/lib/machines.js
index 2e28682..da765ea 100644
--- a/lib/machines.js
+++ b/lib/machines.js
@@ -306,11 +306,12 @@ function getListOptions(req) {
     opts.offset = req.params.offset || 0;
 
     // Copy in any and all tags
-    Object.keys(req.params).forEach(function (k) {
-        if (TAG_RE.test(k)) {
-            opts[k] = req.params[k];
-        }
-    });
+    var tags = req.params.tag;
+    if (tags) {
+        Object.keys(tags).forEach(function (tag) {
+            opts['tag.' + tag] = tags[tag];
+        });
+    }
     // By default, VMAPI will return everything unless it's told to not
     // retrieve destroyed machines.
     if (!req.params.tombstone && !opts.state) {
@@ -795,17 +796,24 @@ function xorIfPresent(a, b) {
 function loadMachine(req, res, next) {
     var pathname = req.getUrl().pathname;
 
-    if (pathname === '/--ping') {
+    if (pathname === '/--ping' || !(/\/machines/.test(pathname))) {
         return next();
     }
 
     assert.ok(req.sdc);
 
     var customer = req.account.uuid;
-    if (!req.params.machine || !(/\/machines/.test(pathname))) {
+    var name = req.params.machine;
+
+    // set by resources.js, if a PUT with role tags is being done
+    if (req.params.resource_name === 'machines' && req.params.resource_id) {
+        name = name || req.params.resource_id;
+    }
+
+    if (!name) {
         return next();
     }
-    var name = req.params.machine;
+
     var machine;
 
     return vasync.pipeline({
diff --git a/package.json b/package.json
index 8c0f702..1292751 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "cloudapi",
     "description": "SmartDataCenter CloudAPI",
-    "version": "8.0.3",
+    "version": "8.1.0",
     "author": "Joyent (joyent.com)",
     "private": true,
     "engines": {
@@ -13,24 +13,24 @@
         "url": "git+ssh://git@github.com:joyent/sdc-cloudapi.git"
     },
     "dependencies": {
-        "vasync": "1.4.3",
+        "vasync": "1.6.4 ",
         "filed": "0.0.7",
         "http-signature": "1.1.0",
         "mime": "1.2.7",
-        "libuuid": "0.1.2",
+        "libuuid": "0.2.1",
         "nopt": "2.0.0",
-        "restify": "git+ssh://git@github.com:mcavage/node-restify.git#0d7b4ba",
-        "bunyan": "0.22.1",
+        "restify": "4.1.1 ",
+        "bunyan": "1.8.1",
+        "sdc-clients": "10.0.0",
         "cueball": "1.1.1",
-        "sdc-clients": "9.4.0",
-        "ufds": "1.1.3",
+        "ufds": "1.2.0",
         "semver": "2.2.1",
         "nodemailer": "0.3.29",
         "clone": "0.1.5",
         "assert-plus": "1.0.0",
         "asn1": "0.1.11",
         "ctype": "0.5.2",
-        "keyapi": "git+ssh://git@github.com:joyent/keyapi.git#c30dd2710ad2175095dc0e96479686fa774b8063",
+        "keyapi": "git+https://github.com/joyent/keyapi.git#e14b3d582e1d9d338b7082d61f34ba8d1bbc540a",
         "aperture": "git+ssh://git@github.com:joyent/node-aperture.git#016977",
         "mahi": "2.0.1",
         "aperture-config": "git+ssh://git@github.com:joyent/aperture-config.git#master",
@@ -40,7 +40,7 @@
     },
     "devDependencies": {
         "tape": "3.5.0",
-        "smartdc": "git+ssh://git@github.com:joyent/node-smartdc.git#adea68"
+        "smartdc": "8.1.0"
     },
     "sdcDependencies": {
         "imgapi": ">=2.1.0",
diff --git a/test/common.js b/test/common.js
index ac59440..9ea766a 100644
--- a/test/common.js
+++ b/test/common.js
@@ -23,7 +23,7 @@ var util = require('util');
 var fs = require('fs');
 var vasync = require('vasync');
 
-var UFDS = require('sdc-clients').UFDS;
+var UFDS = require('ufds');
 var VMAPI = require('sdc-clients').VMAPI;
 var CNAPI = require('sdc-clients').CNAPI;
 var NAPI = require('sdc-clients').NAPI;
-- 
2.21.0

