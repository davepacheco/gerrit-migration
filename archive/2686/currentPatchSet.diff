commit 0f39a291b4665e241130776b909742bb71dc73d0 (refs/changes/86/2686/2)
Author: Jan Wyszynski <jan.wyszynski@joyent.com>
Date:   2017-09-29T00:45:41+00:00 (2 years ago)
    
    MANTA-3426 Want tool to show shard information on object prior to it existing

diff --git a/bin/mlocate b/bin/mlocate
index 993e949..aa46c35 100755
--- a/bin/mlocate
+++ b/bin/mlocate
@@ -55,6 +55,12 @@ var OPTIONS = [
         names: ['verbose', 'v'],
         type: 'arrayOfBool',
         help: 'Verbose output. Use multiple times for more verbose.'
+    },
+    {
+        names: ['shard', 's'],
+        type: 'bool',
+        help: 'Return the shard on which metadata for the object would be ' +
+            'stored, even if the object doesn\'t exist.'
     }
 ];
 
@@ -129,6 +135,8 @@ function configure() {
         });
     }
 
+    cfg.shard = (opts.shard) ? true : false;
+
     if (LOG.level() <= bunyan.DEBUG)
         LOG = LOG.child({src: true});
 
@@ -183,18 +191,34 @@ function configure() {
                     key: key,
                     requestId: libuuid.create()
                 };
-                moray.getMetadata(opts, function (err2, md, rawMd) {
-                    if (err2) {
-                        console.error('error loading %s: %s', p, err2);
-                        process.exit(1);
-                    }
-
-                    md._key = opts.path;
-                    md._moray = moray.url;
-                    md._node = rawMd._node;
-                    console.log(JSON.stringify(md));
-                    barrier.done(p);
-                });
+
+                if (cfg.shard) {
+                    moray.getShard(opts, function (err2, node) {
+                        if (err2) {
+                            console.error('error loading %s: %s', p, err2);
+                            process.exit(1);
+                        }
+                        var md = {
+                            _key: opts.key,
+                            _node: node
+                        };
+                        console.log(JSON.stringify(md));
+                        barrier.done(p);
+                    });
+                } else {
+                    moray.getMetadata(opts, function (err2, md, rawMd) {
+                        if (err2) {
+                            console.error('error loading %s: %s', p, err2);
+                            process.exit(1);
+                        }
+
+                        md._key = opts.path;
+                        md._moray = moray.url;
+                        md._node = rawMd._node;
+                        console.log(JSON.stringify(md));
+                        barrier.done(p);
+                    });
+                }
             });
         }
 
diff --git a/package.json b/package.json
index ba69922..64eb790 100644
--- a/package.json
+++ b/package.json
@@ -24,14 +24,14 @@
         "kang": "1.1.0",
         "keep-alive-agent": "0.0.1",
         "keyapi": "git+https://github.com/joyent/keyapi.git#e14b3d58",
-        "libmanta": "git+https://github.com/joyent/node-libmanta.git#master",
+        "libmanta": "file:../node-libmanta",
         "libuuid": "0.1.2",
         "lru-cache": "2.3.1",
         "lstream": "0.0.4",
         "mahi": "2.0.1",
         "marlin": "git+https://github.com/joyent/manta-marlin.git#master",
         "mime": "1.2.11",
-        "moray": "3.1.1",
+        "moray": "file:../node-moray",
         "once": "1.3.0",
         "restify": "2.6.3",
         "vasync": "^1.5.0",
