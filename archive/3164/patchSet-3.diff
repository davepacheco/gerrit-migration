From 0cca582fab2027352a5a9fb8f6286613f7a902d8 Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Wed, 10 Jan 2018 16:32:58 +0000
Subject: [PATCH] OS-6553 CPU counter support doesn't work on many modern CPUs

---
 manifest                             | 13 ++++++++++++-
 usr/src/uts/intel/core_pcbe/Makefile | 16 +++++++++++++++-
 usr/src/uts/intel/pcbe/core_pcbe.c   | 18 ++++++++++++++++++
 3 files changed, 45 insertions(+), 2 deletions(-)

diff --git a/manifest b/manifest
index 4b369a1a0e..091d6a5e38 100644
--- a/manifest
+++ b/manifest
@@ -19,7 +19,7 @@
 # CDDL HEADER END
 #
 #
-# Copyright 2017 Joyent, Inc.
+# Copyright 2018 Joyent, Inc.
 # Copyright 2017 ASS-Einrichtungssysteme GmbH
 #
 # This lists all the files that illumos-joyent delivers as part of a build.
@@ -1858,11 +1858,22 @@ s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.29=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.30=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.31=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.37=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.42=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.44=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.45=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.46=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.47=pcbe.GenuineIntel.6.15
 s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.58=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.60=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.61=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.62=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.63=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.69=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.70=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.71=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.78=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.79=pcbe.GenuineIntel.6.15
+s platform/i86pc/kernel/pcbe/amd64/pcbe.GenuineIntel.6.85=pcbe.GenuineIntel.6.15
 d platform/i86pc/kernel/sys 0755 root sys
 d platform/i86pc/kernel/sys/amd64 0755 root sys
 f platform/i86pc/kernel/sys/amd64/cpc 0755 root sys
diff --git a/usr/src/uts/intel/core_pcbe/Makefile b/usr/src/uts/intel/core_pcbe/Makefile
index 7f2d1ad8e5..1673cfe252 100644
--- a/usr/src/uts/intel/core_pcbe/Makefile
+++ b/usr/src/uts/intel/core_pcbe/Makefile
@@ -21,6 +21,7 @@
 #
 # Copyright (c) 2008, 2010, Oracle and/or its affiliates. All rights reserved.
 #
+# Copyright 2018, Joyent, Inc.
 #
 # This Makefile builds
 # the Intel Core Architecture Performance Counter BackEnd (PCBE).
@@ -42,9 +43,22 @@ SOFTLINKS	= pcbe.GenuineIntel.6.23 \
 			pcbe.GenuineIntel.6.30 \
 			pcbe.GenuineIntel.6.31 \
 			pcbe.GenuineIntel.6.37 \
+			pcbe.GenuineIntel.6.42 \
 			pcbe.GenuineIntel.6.44 \
+			pcbe.GenuineIntel.6.45 \
 			pcbe.GenuineIntel.6.46 \
-			pcbe.GenuineIntel.6.47
+			pcbe.GenuineIntel.6.47 \
+			pcbe.GenuineIntel.6.58 \
+			pcbe.GenuineIntel.6.60 \
+			pcbe.GenuineIntel.6.61 \
+			pcbe.GenuineIntel.6.62 \
+			pcbe.GenuineIntel.6.63 \
+			pcbe.GenuineIntel.6.69 \
+			pcbe.GenuineIntel.6.70 \
+			pcbe.GenuineIntel.6.71 \
+			pcbe.GenuineIntel.6.78 \
+			pcbe.GenuineIntel.6.79 \
+			pcbe.GenuineIntel.6.85
 ROOTSOFTLINKS	= $(SOFTLINKS:%=$(ROOT_PSM_PCBE_DIR)/%)
 
 #
diff --git a/usr/src/uts/intel/pcbe/core_pcbe.c b/usr/src/uts/intel/pcbe/core_pcbe.c
index bc571c45e9..b02b6fb2db 100644
--- a/usr/src/uts/intel/pcbe/core_pcbe.c
+++ b/usr/src/uts/intel/pcbe/core_pcbe.c
@@ -20,6 +20,7 @@
  */
 /*
  * Copyright (c) 2008, 2010, Oracle and/or its affiliates. All rights reserved.
+ * Copyright 2018 Joyent, Inc.
  */
 
 /*
@@ -1326,9 +1327,26 @@ core_pcbe_init(void)
 			/* Westmere */
 			case 37:
 			case 44:
+			/* Sandy Bridge */
+			case 42:
+			case 45:
 			/* Nehalem-EX */
 			case 46:
 			case 47:
+			/* Ivy Bridge */
+			case 58:
+			case 62:
+			/* Haswell */
+			case 60:
+			case 63:
+			case 69:
+			case 70:
+			/* Broadwell */
+			case 61:
+			case 71:
+			/* Skylake */
+			case 78:
+			case 85:
 				events_table = events_fam6_nhm;
 				break;
 			case 28:
-- 
2.21.0

