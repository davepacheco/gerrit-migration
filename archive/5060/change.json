{"project":"joyent/mako-regional-report","branch":"master","id":"I3dbc6038f37d772f5fa125fba313e7b761ec8b5d","number":"5060","subject":"MANTA-3664 Research Simple Minnow Based File Count / Size Check Reviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"url":"https://cr.joyent.us/5060","commitMessage":"MANTA-3664 Research Simple Minnow Based File Count / Size Check\nReviewed by: Richard Bradley \u003crichard.bradley@joyent.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1542218319,"lastUpdated":1544049508,"open":false,"status":"MERGED","comments":[{"timestamp":1542218319,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 1."},{"timestamp":1542238284,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 2."},{"timestamp":1542304236,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 3."},{"timestamp":1542304624,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1542378657,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(10 comments)\n\nThanks for putting this together. I have glazed over the gruesome gawk for now :)\n\nAre you able to tell me the intended user of this script? I\u0027m sure it\u0027s possible for an operator to run this on their local machine, but is this intended to be used in the ops zone? Would a customer ever think they would need this? Could we add a note to the README.md about who should use the tool, and perhaps how often would be applicable or inadvisable?\n\nAlso, I don\u0027t think this is particularly major and could come in a separate ticket, but have you considered including the joyent/eng.git Make tooling to this repository so that this can be style and lint checked? I\u0027ll be honest, I\u0027m not sure to what extent those tools actually do anything for bash (details of which I read here: https://github.com/joyent/eng/blob/master/docs/index.md#bash-programming-guidelines), but I figured it\u0027s worth raising."},{"timestamp":1542388884,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\nHey Rich, I\u0027ll try to answer the questions for this one inline:\n\n \u003e (10 comments)\n \u003e \n \u003e Thanks for putting this together. I have glazed over the gruesome\n \u003e gawk for now :)\n \u003e \n \u003e Are you able to tell me the intended user of this script?\n\n[Robert] The short answer is: Joyent Engineering.  It\u0027s basically just an internal tool that we want to use to provide Samsung with the size/count information of all the makos in a region.  Strictly speaking, it\u0027s not intended to be part of the actual product (for now).\n\n \u003e I\u0027m sure\n \u003e it\u0027s possible for an operator to run this on their local machine,\n \u003e but is this intended to be used in the ops zone?\n\n[Robert] I forgot that you may not have been included on the discussion that I had with dap where he asked that the first version of the tool only consume public Manta APIs so that it did not need access to any private networks/interfaces.  You gave some valuable insights on how to obtain storage nodes and datacenter information via SAPI and I did end up prototyping it, but afterwards, it was strongly suggested that for the time being, I only consume public APIs and to do it from outside of the product with the intention of keeping the testing bar and risk factor lower.\n\n \u003e Would a customer\n \u003e ever think they would need this? Could we add a note to the\n \u003e README.md about who should use the tool, and perhaps how often\n \u003e would be applicable or inadvisable?\n\n[Robert] Honestly, I doubt a customer would ever use it but since it\u0027s public, I guess if they wanted to, they could in theory.  I think the goal is for Samsung to use the JSON reports that come from this more than the automation itself.  Either way, I agree with your point and I should expand on what it\u0027s for and how we recommend using it in the README.md (without mentioning Samsung of course).  For the purposes of how we will use it to serve Samsung, the intention is to run it as part of a daily cron job in an isolated zone.\n\n \u003e \n \u003e Also, I don\u0027t think this is particularly major and could come in a\n \u003e separate ticket, but have you considered including the\n \u003e joyent/eng.git Make tooling to this repository so that this can be\n \u003e style and lint checked?\n\n[Robert] The idea hadn\u0027t occurred to me, but I think it\u0027s wonderful.  Minimally, I should investigate if there is tooling in there that can actually help with bash script.\n\n \u003e I\u0027ll be honest, I\u0027m not sure to what extent\n \u003e those tools actually do anything for bash (details of which I read\n \u003e here: https://github.com/joyent/eng/blob/master/docs/index.md#bash-programming-guidelines),\n \u003e but I figured it\u0027s worth raising.\n\nI hope this clarifies some of the motivation behind the current design decisions, but if not, let me know.  I\u0027ll make my way through the finer points that you\u0027ve raised throughout the CR and try to shed as much light as I can on the questions behind decisions and incorporate your suggestions (they all seemed really good to me)."},{"timestamp":1542390562,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 3:\n\n(7 comments)"},{"timestamp":1542622149,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 3:\n\n(4 comments)\n\nThanks for addressing my questions!"},{"timestamp":1542675541,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 4."},{"timestamp":1542675743,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 4:\n\n(9 comments)\n\nAlright this hopefully covers everything that we\u0027ve discussed so far *except* for the 1024 limit on mls.  It\u0027s on the todo list to get to the bottom of that.  There is a lot of change to iterate over since the last patchset and since I\u0027ve tested it and it\u0027s working, I didn\u0027t want to hold back further review on it.  Thanks for your help so far."},{"timestamp":1542676072,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 5."},{"timestamp":1542730082,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 5:\n\n(1 comment)\n\nThanks for adding the `json` bits! I\u0027m finding it much easier to read. I\u0027ve also cross checked L133 of bin/report.sh with https://cr.joyent.us/#/c/4880/13/bin/upload_mako_ls.sh for functional equivalency and it looks good.\n\nI can\u0027t say I\u0027m overly proficient with bash so it would be good to get a different set of eyes on this IMO."},{"timestamp":1542743513,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 5:\n\n(1 comment)\n\n\u003e (1 comment)\n \u003e \n \u003e Thanks for adding the `json` bits! I\u0027m finding it much easier to\n \u003e read. I\u0027ve also cross checked L133 of bin/report.sh with\n \u003e https://cr.joyent.us/#/c/4880/13/bin/upload_mako_ls.sh for\n \u003e functional equivalency and it looks good.\n \u003e \n \u003e I can\u0027t say I\u0027m overly proficient with bash so it would be good to\n \u003e get a different set of eyes on this IMO.\n\nSounds good -- I\u0027ll  get at least another set of eyes on it.  Lucky for them, they won\u0027t have to endure the nasty JSON scaffolding that you did the first time around.\n\nGoing back to our original conversation about mls limitations, I decided to do some initial investigatory work before asking more folks for their time and here\u0027s what I\u0027ve found (in no particular order):\n1. It appears that you are correct -- there is no way to override the limit value of 1024\n2. At the same time, it looks like originally, the intention was to allow an administrator to override the limit.  Put another way, it looked to me like if no value was specified, then they received a default of 1024.  Apparently however, they never got around to wiring that up to the command and this is problem #1.\n3. I toyed around with the options using a live debugger and even set the limit to 2 and it did not seem to make a difference at all.  Put another way, it looks to me like we disregard the limit anyway.  If I\u0027m right, that would be problem #2.\n\nOn another fronts, I have looked at the ftw approach that you mentioned (consumed my mfind) and that appears to work in obtaining a directory listing of depth\u003d1.  Not only that, but I am able to override the limit from the command line which does appear to be effective.  I think I have enough to seek out clarification now."},{"timestamp":1542747162,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 6."},{"timestamp":1542747205,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 6:\n\n(1 comment)"},{"timestamp":1542886064,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 6: Code-Review+1\n\nThanks for the changes!\n\nCode lgtm, but again, I\u0027m not overly confident in bash. I think it would be worth another set of eyes for CR. I\u0027m not really sure what kind of IA would be appropriate here, but if you\u0027re stuck for someone to do that then let me know and I can take a look."},{"timestamp":1543866409,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 6:\n\n(11 comments)\n\nThis is a start. I don\u0027t know that I have enough understanding of the Manta system to eventually give IA. However, this runs outside of Manta and doesn\u0027t look to hammer any part of the Manta API, so I don\u0027t see a reason to block it from making master. :)\n\nIf this is just meant to be a report generator that we run manually and occasionally as a one-off, then this looks generally fine to me. Then I\u0027d consider not bothering with the time to convert to errexit/pipefail usage (see comments below)."},{"timestamp":1543883605,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 7."},{"timestamp":1543883710,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 7:\n\n(10 comments)"},{"timestamp":1544039276,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 7:\n\n(2 comments)"},{"timestamp":1544040781,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 8."},{"timestamp":1544040792,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Patch Set 8:\n\n(2 comments)"},{"timestamp":1544040845,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 8: Code-Review+1 Integration-Approval+1\n\nI hope I\u0027m not overreaching by giving +IA to manta stuff."},{"timestamp":1544046017,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Patch Set 8: Code-Review+1"},{"timestamp":1544049453,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Uploaded patch set 9: Commit message was updated."},{"timestamp":1544049508,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Robert Bogart"}],"currentPatchSet":{"number":"9","revision":"3dbc6038f37d772f5fa125fba313e7b761ec8b5d","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/9","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1544049453,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544040845,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544040845,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544046017,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1544049508,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":347,"deletions":0}],"sizeInsertions":542,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"233d4bd89fb1aacf65eb3bddbbc8b97fcd557875","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/1","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1542218319,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":158,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":298,"deletions":0}],"sizeInsertions":456,"sizeDeletions":-1},{"number":"2","revision":"17aba4aec439dc32edcfdc26332726ae1a7c0d0a","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/2","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1542238284,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":171,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":298,"deletions":0}],"sizeInsertions":469,"sizeDeletions":-1},{"number":"3","revision":"c192fa7c51037b3394939e3551ed65c222999fe5","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/3","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1542304236,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","comments":[{"file":"README.md","line":13,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"* manifest"},{"file":"README.md","line":13,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"README.md","line":126,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think I\u0027ve seen disabling done as deleting the property (as opposed to setting it to false) in the past, but I don\u0027t recall where I\u0027ve seen that. I don\u0027t have any strong feelings about this either way, but it would be nice if we provided the \"deletion\" steps so that an operator can return their metadata to the way it was found prior to enabling this process."},{"file":"README.md","line":126,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":11,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think we tend to set a few bash options on scripts, which we\u0027ve documented here: https://github.com/joyent/eng/blob/master/docs/index.md#bash-programming-guidelines."},{"file":"bin/report.sh","line":11,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I reviewed the options here and I\u0027d say that I probably don\u0027t want to set `errexit\u0027 given that I already have warn and fatal with different intentions.  I set the xtrace option which turned out to be pretty verbose."},{"file":"bin/report.sh","line":31,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is this function used anywhere?"},{"file":"bin/report.sh","line":31,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I\u0027ll remove it."},{"file":"bin/report.sh","line":31,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":74,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think this needs to be `MAKO_PROCESS_MANIFEST`."},{"file":"bin/report.sh","line":74,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Can do."},{"file":"bin/report.sh","line":74,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":133,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"For someone unfamiliar with gawk, this might look gruesome, but for what it\u0027s worth, it has already been reviewed and is part of manta-mako here:\n\nhttps://github.com/joyent/manta-mako/blob/bec43535c914a9455b244cd47bc77697c3423f10/bin/upload_mako_ls.sh#L130-L180\n\nWhile it\u0027s ok to trust, feel free to verify."},{"file":"bin/report.sh","line":168,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I haven\u0027t quite worked my way through this yet, but clippy said it looks like you\u0027re attempting to build a JSON structure.\n\nHave you considered something like the following?\n\n    echo \"{}\" | json -e \"this.datacenter \u003d \u0027${datacenter}\u0027\"\n\nYou could store the full structure in a bash variable, then append to it doing something like so:\n\n    # json\u003d$(echo \"{}\" | json -e \"this.tombstone \u003d []\")\n    # tombstone_dir\u003d$(echo \"{}\" | json -e \"this.date \u003d \u00272018-11-16\u0027; this.objects \u003d 5;\")\n    # echo $json | json -e \"this.tombstone.push(${tombstone_dir})\"\n    {\n        \"tombstone\": [\n            {\n                \"date\": \"2018-11-16\",\n                \"objects\": 5\n            }\n        ]\n    }\n\nI think this might help with readability and maintainability, but I\u0027m not sure how well this would work given that I haven\u0027t fully read this part yet!"},{"file":"bin/report.sh","line":168,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"The JSON utility and frankly shell script are all pretty new to me, so I hadn\u0027t considered the approach that you mentioned, but anything that helps readability and maintainability is worth the extra mile.  I will give this a shot."},{"file":"bin/report.sh","line":168,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I\u0027ve tried to find some examples of using `json` like this in an existing project but I\u0027m not turning much up. I\u0027d be happy to help here, otherwise I think Trent might be the best person to ask about this for some more examples."},{"file":"bin/report.sh","line":168,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":168,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":219,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I think `mls` limits itself to listing 1024 objects in a directory, but I\u0027ve personally never seen this.\n\nHas this been executed in SPC, and have you noticed this limit?"},{"file":"bin/report.sh","line":219,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"That\u0027s not good.  I did not realize that -- thanks for bringing this to my attention.  I haven\u0027t looked too closely at the source for mls, but if that\u0027s the case, that makes things more difficult.  While I haven\u0027t hit this limit yet, some regions are dangerously close to having that many makos.  I\u0027ll need to consider my options, one of which might be providing the automation with a list of nodes (which I don\u0027t like honestly), the other would be changing `mls`, but without looking, I have no idea how much work that would be right now.  I\u0027ll have to get back to you on that."},{"file":"bin/report.sh","line":219,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"The limit of 1024 is not actually something I\u0027ve seen happen, but I think it\u0027s the intention. Here\u0027s what made me think we limit to that value:\n\n    https://github.com/joyent/node-manta/blob/da7a8ea23d03ebe20da239bcef15d26950739e4e/lib/client.js#L1522\n\nI don\u0027t think there\u0027s a way to override that. Another option might be to use the client\u0027s `ftw` method:\n\n    https://github.com/joyent/node-manta/blob/da7a8ea23d03ebe20da239bcef15d26950739e4e/lib/client.js#L976\n\n... which ultimately still uses `ls` and will probably try and limit, but maybe it\u0027s more overrideable? I\u0027m not sure.\n\nEither way, I think this will actually work today with \u003e1024 objects in a directory, but I don\u0027t know if this particular quirk will last forever (or if it\u0027s actually intended)."},{"file":"bin/report.sh","line":219,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I agree -- even if we can go beyond 1024 objects and it\u0027s due to a bug, I\u0027ll break when if/when it\u0027s fixed.  I need to get to the bottom of this before I proceed.  I\u0027l consult manta-dev get back to you on this."},{"file":"bin/report.sh","line":227,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I didn\u0027t realise we stored this header. Is this a custom one that the makos themselves set, specific to these mako dumps?"},{"file":"bin/report.sh","line":227,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"It\u0027s a custom one set by the mako during upload, yeah.  It was part of MANTA-4015 which was integrated yesterday.  I\u0027ve actually re-worked this routine since you started looking at it to do this instead:\n\nget_datacenter()\n{\n        file\u003d\"$1\"\n        dc\u003d\"\"\n\n        dc\u003d$(minfo $file |grep m-datacenter | gawk \u0027{print $2}\u0027)\n        #\n        # If we are unable to obtain the datacenter for this mako, it could be\n        # for a number of reasons: maybe minfo did not succeed, or it did\n        # succeed but the datacenter was not present in the header information\n        # because the mako was not yet running a build with MANTA-4015.  Either\n        # way, it\u0027s an inconvenience, but not a deal breaker.\n        #\n        if [[ -z \"$dc\" ]]; then\n                echo \"Unknown\"\n                return\n        fi\n\n        echo $dc\n}"},{"file":"bin/report.sh","line":227,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":285,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I\u0027m personally a fan of this style/method of interpolation in bash. This isn\u0027t major, but it only seems to be done in a handful of places. Is there a particular reason for that?"},{"file":"bin/report.sh","line":285,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"In general, I do it to protect a variable whenever there is a \u0027.\u0027 after it.  I\u0027ve observed strange behavior specifically in those cases, but not anywhere else.  I am willing to make this a convention throughout the script though if you\u0027d like."},{"file":"bin/report.sh","line":285,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"That explains it, thanks! I think it\u0027s fine in that case."},{"file":"bin/report.sh","line":298,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I don\u0027t recall $STATUS being set to anything but 0 at the start of the script. Should this be \"exit 0\" instead?"},{"file":"bin/report.sh","line":298,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"It will get set whenever warn() is invoked.  Incidentally, in this CR, it\u0027s not called anywhere so your point still stands.  I might need it in the next patch set.  If not, then I\u0027ll exit 0 as you recommended."},{"file":"bin/report.sh","line":298,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"I see it in the warn function now, thanks! I had missed that previously. I think we still warn in at least \"get_datacenter()\"."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":171,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":298,"deletions":0}],"sizeInsertions":469,"sizeDeletions":-1},{"number":"4","revision":"44d22617f2b1e603720f8cdc4b1f72a2ba3e5871","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/4","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1542675541,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":324,"deletions":0}],"sizeInsertions":519,"sizeDeletions":-1},{"number":"5","revision":"a32b93a920efe5051aaaaceabc86dcbde3892933","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/5","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1542676072,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","comments":[{"file":"bin/report.sh","line":19,"reviewer":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},"message":"Is this intended to be commented out?"},{"file":"bin/report.sh","line":19,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I had been toying with having it in and out.  Sorry about that.  I\u0027ll uncomment it."},{"file":"bin/report.sh","line":19,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":324,"deletions":0}],"sizeInsertions":519,"sizeDeletions":-1},{"number":"6","revision":"60499f1ca5cc8ef5091bf56e86b91c64e074f3d1","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/6","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1542747162,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542886064,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"comments":[{"file":"README.md","line":182,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"typo: \"mako\""},{"file":"bin/report.sh","line":11,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"A short comment at the top of the script giving its basic purpose would be nice. I know that feels duplicative with the repo\u0027s README, though."},{"file":"bin/report.sh","line":11,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":13,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: having a scoped file name here might be nice. E.g. something like /tmp/mako-regional-report.pid."},{"file":"bin/report.sh","line":13,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":19,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d strongly encourage all new Bash scripts use the errexit and pipefail options. That adds a burden that things like `grep` (which exit non-zero if there are no hits) need to sometimes be coped with. But it does mean that there should be far fewer surprises with a command failing unexpectedly.\n\n\nA common pattern I have at the start of all bash scripts is:\n\n```\nif [[ -n \"$TRACE\" ]]; then\n    export PS4\u003d\u0027[\\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }\u0027\n    set -o xtrace\nfi\nset -o errexit\nset -o pipefail\n```\n\nThat also turns off `xtrace` by default, but allows enalbing it via `TRACE\u003d1 ...`.\n\n\nUpdate after reading more of this bash script: I think if using errexit and pipefail, you\u0027d have to adjust quite a lot of your code below. I\u0027ll leave it up to you if you want to re-write sections and use errexit/pipefail, given that this isn\u0027t something that is running directly in the product.\nI think if I had to start this script all over I\u0027d consider writing it in node, but that seems overkill at this point."},{"file":"bin/report.sh","line":19,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":128,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Had you considered uploading the summary file that was just generated here? Or don\u0027t want to go there?"},{"file":"bin/report.sh","line":128,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I think we could justify it if something else (besides this script) had a use for them, but in the context of this tool, they\u0027re a means to an end and once we\u0027ve generated the regional report, they\u0027re not of much use to this application.\n\nSecond, if we saved our summaries, they\u0027d have to go in a different location than where we expect them to be if a mako uploads one, otherwise it could lead to a situation where we would always just download our own saved summaries and we\u0027d generate stale regional reports.\n\nAt any rate, it\u0027s not that I don\u0027t want to go there -- we could if there was a specific need, but once we\u0027ve generated the regional report, there is no need on this end.  Maybe something else could make use of it?  If not, I\u0027d probably be in favor of tabling that one for now."},{"file":"bin/report.sh","line":132,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Bash\u0027s `pipefail` would make the script error out of `mget` failed."},{"file":"bin/report.sh","line":132,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"With pipefail, we don\u0027t need this anymore.  We can just check the value of $? now."},{"file":"bin/report.sh","line":158,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"IIRC the docs in the README say \"kb\" as the field name."},{"file":"bin/report.sh","line":158,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"I revised the README.md to reconcile the difference.  I think \"kilobytes\" is more clear."},{"file":"bin/report.sh","line":170,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Use `local sn\u003d\"$1\"` for vars inside functions, otherwise they become global vars."},{"file":"bin/report.sh","line":170,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Done"},{"file":"bin/report.sh","line":238,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"What does \"sns\" stand for? Ah \"Storage NodeS\"? It took me a while.\n\nWho writes those files to /poseidon/stor/mako? Does the Manta system do this? Perhaps a brief comment on this function about expectations? (Or mostly I\u0027m showing my lack of understanding of Manta.)"},{"file":"bin/report.sh","line":238,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"It\u0027s the storage nodes themselves that push those files to /poseidon/stor/mako.  I\u0027ll add a comment discussing the situation.\n\nAlso, I went ahead and %s/sns/storage_nodes/cg for you."},{"file":"bin/report.sh","line":250,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Using errexit and pipefail will change how to handle this, but should make handling the various error cases more explicit."},{"file":"bin/report.sh","line":250,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Makes sense."},{"file":"bin/report.sh","line":252,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Ah, I see staging-1/2/3 are in this situation."},{"file":"bin/report.sh","line":252,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Truth be told, I hadn\u0027t tested this on staging.  In fact, I\u0027ve tested it on everything BUT staging."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":324,"deletions":0}],"sizeInsertions":519,"sizeDeletions":-1},{"number":"7","revision":"89cffbb5e97c50141a94a7e56512d96527f4ca2f","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/7","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1543883605,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","comments":[{"file":"bin/report.sh","line":57,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: Mixed intentation styles. Ditto for the \u0027set -o xtrace\u0027 line above."},{"file":"bin/report.sh","line":57,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Will do."},{"file":"bin/report.sh","line":289,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: I might have missed it, but if `storage_nodes` is only used in this function, it could be made local."},{"file":"bin/report.sh","line":289,"reviewer":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"message":"Nice catch.  This has gone back and forth between local and global use between iterations prior to even creating this CR and I just lost track of where I settled.  I\u0027ll take care of that."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":348,"deletions":0}],"sizeInsertions":543,"sizeDeletions":-1},{"number":"8","revision":"a2c838ee84a61e596d28d1b48c75ccb45a94e71b","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/8","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1544040781,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544040845,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544040845,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544046017,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":347,"deletions":0}],"sizeInsertions":542,"sizeDeletions":-1},{"number":"9","revision":"3dbc6038f37d772f5fa125fba313e7b761ec8b5d","parents":["2bb0a8e43bf02ad107cfa0777bd4726802c95396"],"ref":"refs/changes/60/5060/9","uploader":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"createdOn":1544049453,"author":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544040845,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1544040845,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1544046017,"by":{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"}},{"type":"SUBM","value":"1","grantedOn":1544049508,"by":{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"README.md","type":"MODIFIED","insertions":195,"deletions":-1},{"file":"bin/report.sh","type":"ADDED","insertions":347,"deletions":0}],"sizeInsertions":542,"sizeDeletions":-1}],"allReviewers":[{"name":"Richard Bradley","email":"richard.bradley@joyent.com","username":"chudley"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Robert Bogart","email":"Robert.bogart@joyent.com","username":"rhb2"}]}