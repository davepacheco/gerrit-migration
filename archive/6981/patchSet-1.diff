From bee0cfd8d551ca0c576ba3b30828c039064a0131 Mon Sep 17 00:00:00 2001
From: Mohamed Khalfella <khalfella@gmail.com>
Date: Tue, 15 Oct 2019 18:07:55 +0000
Subject: [PATCH] MANTA-4618 Multipart uploads created under a different
 account get the wrong objectPathKey

---
 lib/auth.js             |  4 ++--
 lib/uploads/create.js   | 36 ++++++++++++++++++++++++++++++++++--
 test/mpu/commit.test.js | 30 +-----------------------------
 test/mpu/create.test.js | 20 +++++++++++++++++++-
 4 files changed, 56 insertions(+), 34 deletions(-)

diff --git a/lib/auth.js b/lib/auth.js
index a425919..0788e30 100644
--- a/lib/auth.js
+++ b/lib/auth.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2018, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 //
@@ -929,7 +929,7 @@ function getActiveRoles(req, res, next) {
         var i, names;
         /* JSSTYLED */
         names = requestedRoles.split(/\s*,\s*/);
-        for (var i = 0; i < names.length; ++i) {
+        for (i = 0; i < names.length; ++i) {
             var roles = lookup[names[i]];
             if (roles === undefined || roles.length < 1) {
                 next(new InvalidRoleError(names[i]));
diff --git a/lib/uploads/create.js b/lib/uploads/create.js
index b1b1cc5..b0a6200 100644
--- a/lib/uploads/create.js
+++ b/lib/uploads/create.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var assert = require('assert-plus');
@@ -195,7 +195,7 @@ function validateParams(req, res, next) {
     var log = req.log;
 
     var opts = {
-        account: req.owner.account,
+        account: req.targetObjectOwner.account,
         path: req.body.objectPath
     };
     libmanta.normalizeMantaPath(opts, function (err, p) {
@@ -365,6 +365,37 @@ function createUpload(req, res, next) {
     });
 }
 
+function loadTargetObjectOwner(req, res, next) {
+    var objectPath = req.body.objectPath;
+    var account;
+    try {
+        account = decodeURIComponent(objectPath.split('/', 2).pop());
+    } catch (e) {
+        next(new MultipartUploadCreateError('Invalid objectPath' + objectPath));
+        return;
+    }
+
+
+    // We don't support mpu for users yet.
+    var user = common.ANONYMOUS_USER;
+    var fallback = true;
+    req.mahi.getUser(user, account, fallback, function (err, owner) {
+        if (err) {
+            switch (err.restCode || err.name) {
+            case 'AccountDoesNotExist':
+                next(new AccountDoesNotExistError(account));
+                return;
+            default:
+                next(new InternalError(err));
+                return;
+            }
+        }
+
+        req.targetObjectOwner = owner;
+        next();
+    });
+}
+
 
 ///--- Exports
 
@@ -379,6 +410,7 @@ module.exports = {
             }),
             setupUpload,
             validateSchema,
+            loadTargetObjectOwner,
             validateParams,
             ensurePrefixDir,
             createUpload
diff --git a/test/mpu/commit.test.js b/test/mpu/commit.test.js
index 33be978..839fac9 100644
--- a/test/mpu/commit.test.js
+++ b/test/mpu/commit.test.js
@@ -5,7 +5,7 @@
  */
 
 /*
- * Copyright (c) 2017, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var MemoryStream = require('stream').PassThrough;
@@ -629,34 +629,6 @@ test('commit upload: object path under another account', function (t) {
 });
 
 
-test('commit upload: object path under a nonexistent account', function (t) {
-    var self = this;
-    var bogus = uuid.v4();
-    var p = '/' + bogus + '/foo.txt';
-
-    self.createUpload(p, null, function (err) {
-        if (ifErr(t, err, 'created upload')) {
-            t.end();
-            return;
-        }
-
-        self.commitUpload(self.uploadId, [], function (err2) {
-            if (!err2) {
-                t.fail('upload created under a different account');
-                t.end();
-                return;
-            }
-
-            t.ok(verror.hasCauseWithName(err2,
-                'AccountDoesNotExistError'));
-            t.end();
-        });
-    });
-});
-
-
-
-
 // Commit: bad inputs to API
 
 test('commit upload: empty part etag', function (t) {
diff --git a/test/mpu/create.test.js b/test/mpu/create.test.js
index c1b50e0..b9c5083 100644
--- a/test/mpu/create.test.js
+++ b/test/mpu/create.test.js
@@ -5,10 +5,11 @@
  */
 
 /*
- * Copyright (c) 2019, Joyent, Inc.
+ * Copyright 2019 Joyent, Inc.
  */
 
 var path = require('path');
+var uuid = require('node-uuid');
 var verror = require('verror');
 
 if (require.cache[path.join(__dirname, '/../helper.js')])
@@ -287,6 +288,23 @@ test('create upload: no input object path', function (t) {
     });
 });
 
+test('create upload: object path under a nonexistent account', function (t) {
+    var self = this;
+    var bogus = uuid.v4();
+    var p = '/' + bogus + '/foo.txt';
+
+    self.createUpload(p, null, function (err) {
+        if (!err) {
+            t.fail('upload created under a different account');
+            t.end();
+            return;
+        }
+
+        t.ok(verror.hasCauseWithName(err, 'AccountDoesNotExistError'));
+        t.end();
+    });
+});
+
 
 test('create upload: object path not a string', function (t) {
     var self = this;
-- 
2.17.2 (Apple Git-113)

