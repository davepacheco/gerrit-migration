{"project":"joyent/sdcadm","branch":"master","id":"I980d8d0b01a320ae1c0524b3ca35fed37bc6f304","number":"5909","subject":"TRITON-1298 need logarchiver0 zone Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com\u003e","owner":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"url":"https://cr.joyent.us/5909","commitMessage":"TRITON-1298 need logarchiver0 zone\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1552935656,"lastUpdated":1553422532,"open":false,"status":"MERGED","comments":[{"timestamp":1552935656,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 1."},{"timestamp":1552935661,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 95225bbb8cc63d1f012992f1624502c667e45f28\n    \n    TRITON-1298 need logarchiver0 zone"},{"timestamp":1552935700,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 2: Patch Set 1 was rebased."},{"timestamp":1552935704,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 004dc7c7ec6ab7b83c79d534d8fc9ff0790fda97\n    \n    TRITON-1298 need logarchiver0 zone"},{"timestamp":1553040237,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(5 comments)\n\nAttempting on my coal:\n\n\n```\n[root@headnode (coal) ~]# sdcadm post-setup logarchiver\nUncaught VError: vasync.waterfall: function 1 (\"getChannel\") invoked its callback twice\n\nFROM\nnext (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:799:4)\n/opt/smartdc/sdcadm/lib/procedures/add-service.js:303:25\n/opt/smartdc/sdcadm/lib/sdcadm.js:1330:9\nnext (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:843:6)\ngetChannel (/opt/smartdc/sdcadm/lib/sdcadm.js:1308:17)\nImmediate.\u003canonymous\u003e (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:875:12)\nrunCallback (timers.js:672:20)\ntryOnImmediate (timers.js:645:5)\nprocessImmediate [as _immediateCallback] (timers.js:617:5)\n/opt/smartdc/bin/sdcadm: line 18: 15913 Illegal Instruction     (core dumped) /opt/smartdc/sdcadm/node/bin/node --abort_on_uncaught_exception /opt/smartdc/sdcadm/lib/cli/index.js \"$@\"\n```\n\n\nI haven\u0027t yet reviewed add-service.js, but wanted to make sure I got this out if I don\u0027t get to it tonight."},{"timestamp":1553041618,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(8 comments)\n\nfirst round of add0-service.js review."},{"timestamp":1553097503,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 2:\n\n(11 comments)\n\nFixed the uncaught exception + committing in a moment. Thanks a lot for the CR!\n\n\u003e (5 comments)\n \u003e \n \u003e Attempting on my coal:\n \u003e \n \u003e \n \u003e ```\n \u003e [root@headnode (coal) ~]# sdcadm post-setup logarchiver\n \u003e Uncaught VError: vasync.waterfall: function 1 (\"getChannel\")\n \u003e invoked its callback twice\n \u003e \n \u003e FROM\n \u003e next (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:799:4)\n \u003e /opt/smartdc/sdcadm/lib/procedures/add-service.js:303:25\n \u003e /opt/smartdc/sdcadm/lib/sdcadm.js:1330:9\n \u003e next (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:843:6)\n \u003e getChannel (/opt/smartdc/sdcadm/lib/sdcadm.js:1308:17)\n \u003e Immediate.\u003canonymous\u003e (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:875:12)\n \u003e runCallback (timers.js:672:20)\n \u003e tryOnImmediate (timers.js:645:5)\n \u003e processImmediate [as _immediateCallback] (timers.js:617:5)\n \u003e /opt/smartdc/bin/sdcadm: line 18: 15913 Illegal Instruction    \n \u003e (core dumped) /opt/smartdc/sdcadm/node/bin/node --abort_on_uncaught_exception\n \u003e /opt/smartdc/sdcadm/lib/cli/index.js \"$@\"\n \u003e ```\n \u003e \n \u003e \n \u003e I haven\u0027t yet reviewed add-service.js, but wanted to make sure I\n \u003e got this out if I don\u0027t get to it tonight."},{"timestamp":1553097763,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 3."},{"timestamp":1553097768,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 6ac9b37c894943d39a39e03177e43e46aae8db5b\n    \n    TRITON-1298 need logarchiver0 zone"},{"timestamp":1553185938,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(4 comments)\n\nNow I hit this:\n\n```\n[root@headnode (coal) ~]# sdcadm post-setup logarchiver\n\nThis will make the following changes:\n    create \"logarchiver\" service in SAPI\n    download image f54012c4-1b22-48a5-8739-46a107c621ca (logarchiver@master-20190315T173453Z-ga40cf29)\n        from updates server using channel \"dev\"\n    create \"logarchiver\" service instance on server \"564d854d-046e-56c2-b9fb-49a585a63d40\"\n\nWould you like to continue? [y/N] y\n\nUsing image f54012c4-1b22-48a5-8739-46a107c621ca (logarchiver@master-20190315T173453Z-ga40cf29)\nNeed to import image f54012c4-1b22-48a5-8739-46a107c621ca from updates server\nUncaught AssertionError: options.progress (func) is required\n\nFROM\n_toss (/opt/smartdc/sdcadm/node_modules/assert-plus/assert.js:22:5)\nFunction.out.(anonymous function) [as func] (/opt/smartdc/sdcadm/node_modules/assert-plus/assert.js:122:17)\nDownloadImages.diExecute [as execute] (/opt/smartdc/sdcadm/lib/procedures/download-images.js:64:12)\nArray.importSvcImageIfNecessary (/opt/smartdc/sdcadm/lib/procedures/add-service.js:478:22)\nwaterfall_impl (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:888:11)\nObject.pipeline (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:168:10)\nAddServiceProcedure.addServiceExecute [as execute] (/opt/smartdc/sdcadm/lib/procedures/add-service.js:461:12)\nexecProc (/opt/smartdc/sdcadm/lib/procedures/index.js:1200:26)\nArray.\u003canonymous\u003e (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:209:13)\nwaterfall_impl (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:888:11)\npipeline (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:168:10)\nObject.forEachPipeline (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:213:10)\nexec (/opt/smartdc/sdcadm/lib/procedures/index.js:1196:20)\nImmediate.\u003canonymous\u003e (/opt/smartdc/sdcadm/node_modules/vasync/lib/vasync.js:875:12)\nrunCallback (timers.js:672:20)\ntryOnImmediate (timers.js:645:5)\nprocessImmediate [as _immediateCallback] (timers.js:617:5)\n\n/opt/smartdc/bin/sdcadm: line 18: 15593 Illegal Instruction     (core dumped) /opt/smartdc/sdcadm/node/bin/node --abort_on_uncaught_exception /opt/smartdc/sdcadm/lib/cli/index.js \"$@\"\n```\n\non my COAL.\n\n\n... I still haven\u0027t finished a full walk through add-service.js."},{"timestamp":1553196139,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\n(10 comments)\n\nAfter the patch below, it worked for me:\n\n```\n[root@headnode (coal) ~]# sdcadm post-setup logarchiver -y\nThis will make the following changes:\n    create \"logarchiver\" service in SAPI\n    download image f54012c4-1b22-48a5-8739-46a107c621ca (logarchiver@master-20190315T173453Z-ga40cf29)\n        from updates server using channel \"dev\"\n    create \"logarchiver\" service instance on server \"564d854d-046e-56c2-b9fb-49a585a63d40\"\n\nUsing image f54012c4-1b22-48a5-8739-46a107c621ca (logarchiver@master-20190315T173453Z-ga40cf29)\nNeed to import image f54012c4-1b22-48a5-8739-46a107c621ca from updates server\nDownloading image f54012c4-1b22-48a5-8739-46a107c621ca\n    (logarchiver@master-20190315T173453Z-ga40cf29)\nImported image f54012c4-1b22-48a5-8739-46a107c621ca\n    (logarchiver@master-20190315T173453Z-ga40cf29)\nCreating \"logarchiver\" service\nCreating \"logarchiver\" instance on server 564d854d-046e-56c2-b9fb-49a585a63d40\nCreated VM 85015af4-812b-4f1e-ba41-b333670912a2 (logarchiver0)\nCompleted successfully (elapsed 95s).\n```"},{"timestamp":1553364926,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 4."},{"timestamp":1553364931,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit e293ce802ba049546f528a2e37161810627c0aee\n    \n    TRITON-1298 need logarchiver0 zone"},{"timestamp":1553364985,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\n(13 comments)\n\nDone with all the suggested changes but the bulleted messages that I\u0027d like to discuss a little bit more before we go deeper on changing things. Thanks for the patch, working fine so far."},{"timestamp":1553399827,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\n(1 comment)\n\nOne minor thing."},{"timestamp":1553422386,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1553422474,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1553422501,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Pedro Palazón Candel"},{"timestamp":1553422532,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Patch Set 4:\n\nWill split that line during `sdcadm post-setup kbmapi` addition, though"}],"currentPatchSet":{"number":"6","revision":"9a44a7b78227ed388e0ee95a83a07334b923e574","parents":["304c3673c4482d37ccfbdb6f7fe0a8295a7825d7"],"ref":"refs/changes/09/5909/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553422474,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1553422501,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":127,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":570,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":716,"sizeDeletions":-8},"patchSets":[{"number":"1","revision":"b5ee0e63181d082aa1e8ef2137868a3d1eec6ace","parents":["0f411eee9840cba3b7b406fcc954b867092834ec"],"ref":"refs/changes/09/5909/1","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1552935656,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":193,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":603,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":802,"sizeDeletions":-4},{"number":"2","revision":"5acf9c074bde31b5acac33c9acfd4e17a5b18526","parents":["a75f9f88b5553410ef48cfcad02ae764ff8c14a2"],"ref":"refs/changes/09/5909/2","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1552935700,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","comments":[{"file":"lib/post-setup/logarchiver.js","line":15,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"remove?"},{"file":"lib/post-setup/logarchiver.js","line":15,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/logarchiver.js","line":66,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Any reason to not use the recently added `runProcs` function? It\u0027ll handle prepare/confirm/execute as well as getting the sdcadm lock to avoid concurrent sdcadm commands."},{"file":"lib/post-setup/logarchiver.js","line":66,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Actually none other than I already got this code before you pushed it. updated now!"},{"file":"lib/post-setup/logarchiver.js","line":178,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: I\u0027m leaning towards this pattern: https://github.com/joyent/sdcadm/blob/a75f9f88b5553410ef48cfcad02ae764ff8c14a2/lib/cli/do_remove_ca.js#L88-L97\nI.e. an array joined on \u0027\\n\u0027 to avoid repeating the \u0027\\n\u0027s.  Thought looking through sdcadm, there aren\u0027t many that do that. We\u0027ve been doing the array.join thing in node-triton for a while, I think. Anyway, just a nit. :)"},{"file":"lib/post-setup/logarchiver.js","line":178,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027ve always preferred the array.join approach. Happily changing to use it!"},{"file":"lib/post-setup/logarchiver.js","line":182,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"A little blurb about what the logarchiver service is about would be helpful I think. I\u0027m not sure that other commands do this, however."},{"file":"lib/post-setup/logarchiver.js","line":182,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok, why not"},{"file":"lib/procedures/add-service.js","line":11,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nit: can we space those out?"},{"file":"lib/procedures/add-service.js","line":11,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Sure!"},{"file":"lib/procedures/add-service.js","line":19,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"`:`"},{"file":"lib/procedures/add-service.js","line":40,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"could elide this and point to `runProcs` usage"},{"file":"lib/procedures/add-service.js","line":40,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":42,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nothing should *require* parallel setup. However, eventually supporting parallel setup (e.g. to have parallel provisioning of first instances) might be nice, but that could all be sear"},{"file":"lib/procedures/add-service.js","line":42,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nothing should *rquire* parallel setup. Supporting parallel setup later (separate work) might be nice for parallel provisions of first instances, for example."},{"file":"lib/procedures/add-service.js","line":42,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Ok, calling it off for now."},{"file":"lib/procedures/add-service.js","line":77,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Eventually for this Proc to be generic we\u0027d want to expose params for package_name, delegate_dataset, networks (perhaps ust a \"have external\" boolean), firewall_enabled (perhaps key off networks having an external). What about doing so now and show a good usage of the proc by \"do_logarchiver\"?"},{"file":"lib/procedures/add-service.js","line":77,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Has sense, why not. Will anyway go for an explicit network array of objects, since recent networking related work involves networks not necessarily named \"admin\" or \"external\""},{"file":"lib/procedures/add-service.js","line":108,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, `runProcs` and I think the docs in `procedure.js` specify that if `prepare` says it has nothing to do that summarize won\u0027t be called."},{"file":"lib/procedures/add-service.js","line":108,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":133,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"on\""},{"file":"lib/procedures/add-service.js","line":133,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":282,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"nerd nit: Prepare is generally called first, so it might help readability to put it before the summarize and execute implementations."},{"file":"lib/procedures/add-service.js","line":282,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Of course!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":193,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":603,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3}],"sizeInsertions":802,"sizeDeletions":-4},{"number":"3","revision":"29ffcf7606afbf37daf989159b71c820992e4d58","parents":["a75f9f88b5553410ef48cfcad02ae764ff8c14a2"],"ref":"refs/changes/09/5909/3","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553097763,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","comments":[{"file":"CHANGES.md","line":16,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"\"AddServiceProcedure\""},{"file":"CHANGES.md","line":16,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/logarchiver.js","line":84,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Put the period inside the parenthesis."},{"file":"lib/post-setup/logarchiver.js","line":84,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/logarchiver.js","line":115,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"{{options}} ends with a newline, so this extra one would be removed otherwise there are *two* blank lines before the description."},{"file":"lib/post-setup/logarchiver.js","line":115,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/post-setup/logarchiver.js","line":116,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"perhaps this?\n\nThe \"logarchiver\" service uploads specific Triton log files to a configured Manta object store."},{"file":"lib/post-setup/logarchiver.js","line":116,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":44,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Could remove this var. It isn\u0027t used anywhere other than inside the \"prepare\" method."},{"file":"lib/procedures/add-service.js","line":44,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":46,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Oh, I wonder if this will be necessary. Do you think? I\u0027d be inclined to NOT give another option here for callers. Not sure if you had a speific case in mind, though."},{"file":"lib/procedures/add-service.js","line":46,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Well, it had sense before we added so many specific options. Let\u0027s remove it now and, eventually, take it back if 200% necessary."},{"file":"lib/procedures/add-service.js","line":112,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I\u0027d prefer this be `self.channel` -- which is a real channel name. `self.channelRef` can then stay as the \"channel name or the special \u0027default\u0027 string\" type.\n\n*Or*, as the prometheus CR had it: *don\u0027t* allow a special \"default\" value, but just use `opts.channel \u003d\u003d\u003d null or undefined` to mean \"the default\" channel."},{"file":"lib/procedures/add-service.js","line":112,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":381,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Please quote the given hostname in the error message."},{"file":"lib/procedures/add-service.js","line":381,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":403,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Nit: I would invert the logic and use a var called \"nothingToDo\" to match the var defined by Procedure.prepare. But just a nit."},{"file":"lib/procedures/add-service.js","line":403,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":418,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This is a separate issue, but I\u0027m thinking we should change to using \"- blah blah\" bulleted lines here. I did that for TRITON-884, e.g.:\n\n```\n[root@headnode (nightly-1) ~]# sdcadm experimental remove-ca\nGathering SAPI service data.\nGathering SAPI instance data.\nGathering server agent data.\nGathering VM instance data.\n\nThis will make the following changes:\n    - Remove \"ca\" service: SAPI records, 1 vm instance\n        - VM e97f7d18-1c9e-4ca5-82ba-4dbf2ee2c1cc (ca0)\n    - Remove \"cabase\" service: nothing to do\n    - Remove \"cainstsvc\" service: nothing to do\n```\n\nI think if we switch other things over that the bulleted list would be a little clearer when the lines are long.\nLonger example: https://gist.github.com/trentm/06b0e77c30926e3e2f0d9cbbab48ca83\n\nAnyway, that\u0027s a separate ticket. I created TRITON-1342 to discuss it."},{"file":"lib/procedures/add-service.js","line":418,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Yeah, let\u0027s just discuss about it first a little bit"},{"file":"lib/procedures/add-service.js","line":473,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Both of these could be replace with just a single\n\n```\nui.info(\u0027Importing image %s (%s@%s)\u0027, ...)\n```"},{"file":"lib/procedures/add-service.js","line":473,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"lib/procedures/add-service.js","line":476,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"This will not work if the channel is other than the default unless you also take this patch from the prometheus CR:\n\n```\n--- a/lib/procedures/download-images.js\n+++ b/lib/procedures/download-images.js\n@@ -28,7 +28,9 @@ var Procedure \u003d require(\u0027./procedure\u0027).Procedure;\n\n function DownloadImages(options) {\n     assert.arrayOfObject(options.images, \u0027options.images\u0027);\n+    assert.optionalString(options.channel, \u0027options.channel\u0027);\n     this.images \u003d options.images;\n+    this.channel \u003d options.channel;\n }\n util.inherits(DownloadImages, Procedure);\n\n@@ -54,7 +56,7 @@ DownloadImages.prototype.summarize \u003d function diSummarize() {\n\n /**\n  * The \u0027source\u0027 URL (IMGAPI endpoint) can optionally be passed in. It defaults\n- * to \u0027updates.joyent.com?channel\u003d\u003ccurrent-channel\u003e\u0027.\n+ * to \u0027https://updates.joyent.com?channel\u003d\u003ccurrent-channel\u003e\u0027.\n  */\n DownloadImages.prototype.execute \u003d function diExecute(options, cb) {\n     assert.object(options, \u0027options\u0027);\n@@ -72,7 +74,9 @@ DownloadImages.prototype.execute \u003d function diExecute(options, cb) {\n     var source \u003d options.source;\n     if (!source) {\n         source \u003d sdcadm.config.updatesServerUrl;\n-        if (sdcadm.updates.channel) {\n+        if (self.channel) {\n+            source +\u003d \u0027?channel\u003d\u0027 + self.channel;\n+        } else if (sdcadm.updates.channel) {\n             source +\u003d \u0027?channel\u003d\u0027 + sdcadm.updates.channel;\n         }\n     }\n```\n\nOr we could add this patch as a separate change."},{"file":"lib/procedures/add-service.js","line":476,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"I\u0027m gonna take the patch here and then re-do the prometheus thing myself using AddServiceProcedure"},{"file":"lib/procedures/add-service.js","line":481,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"You need this patch for the crash I mentioned in the previous comment:\n\n```\n--- a/lib/procedures/add-service.js\n+++ b/lib/procedures/add-service.js\n@@ -478,7 +478,8 @@ AddServiceProcedure.prototype.execute \u003d function addServiceExecute(opts, cb) {\n                 proc.execute({\n                     sdcadm: sdcadm,\n                     log: log,\n-                    ui: ui\n+                    ui: ui,\n+                    progress: ui.progressFunc()\n                 }, next);\n             },\n```"},{"file":"lib/procedures/add-service.js","line":481,"reviewer":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"message":"Done"},{"file":"package.json","line":4,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"could be a minor version bump (new feature), but meh. :)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":127,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":572,"deletions":0},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":711,"sizeDeletions":-5},{"number":"4","revision":"db343017aa0faa8ffa88e32d2707bede462091e4","parents":["f17347b930d5759eac4c929dadb44287a2e7ad97"],"ref":"refs/changes/09/5909/4","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553364926,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/post-setup/logarchiver.js","line":116,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Probably want to break this onto two lines. But I\u0027ll +1 this so you don\u0027t need a re-CR/IA."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":127,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":570,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":716,"sizeDeletions":-8},{"number":"5","revision":"980d8d0b01a320ae1c0524b3ca35fed37bc6f304","parents":["f17347b930d5759eac4c929dadb44287a2e7ad97"],"ref":"refs/changes/09/5909/5","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553422386,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":127,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":570,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":716,"sizeDeletions":-8},{"number":"6","revision":"9a44a7b78227ed388e0ee95a83a07334b923e574","parents":["304c3673c4482d37ccfbdb6f7fe0a8295a7825d7"],"ref":"refs/changes/09/5909/6","uploader":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"createdOn":1553422474,"author":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1553399827,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1553422501,"by":{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":6,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":2,"deletions":-1},{"file":"lib/post-setup/index.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/post-setup/logarchiver.js","type":"ADDED","insertions":127,"deletions":0},{"file":"lib/procedures/add-service.js","type":"ADDED","insertions":570,"deletions":0},{"file":"lib/procedures/download-images.js","type":"MODIFIED","insertions":6,"deletions":-3},{"file":"lib/procedures/index.js","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":716,"sizeDeletions":-8}],"allReviewers":[{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Pedro Palazón Candel","email":"pedro@joyent.com","username":"kusor"}]}