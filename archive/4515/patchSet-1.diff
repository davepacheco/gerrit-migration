From 5a720214c5d089c5afa2648925337219afc6705f Mon Sep 17 00:00:00 2001
From: Jason King <jason.king@joyent.com>
Date: Wed, 11 Jul 2018 16:56:45 +0000
Subject: [PATCH] Move sarc to usr/src/common

---
 usr/src/{uts/common/io/overlay => common/sarc}/sarc.c | 5 +++--
 usr/src/uts/common/Makefile.files                     | 3 ++-
 usr/src/uts/common/Makefile.rules                     | 9 ++++++++-
 usr/src/uts/common/sys/Makefile                       | 4 +++-
 usr/src/uts/common/sys/overlay_impl.h                 | 3 +--
 usr/src/uts/common/{io/overlay => sys}/sarc_impl.h    | 0
 6 files changed, 17 insertions(+), 7 deletions(-)
 rename usr/src/{uts/common/io/overlay => common/sarc}/sarc.c (99%)
 rename usr/src/uts/common/{io/overlay => sys}/sarc_impl.h (100%)

diff --git a/usr/src/uts/common/io/overlay/sarc.c b/usr/src/common/sarc/sarc.c
similarity index 99%
rename from usr/src/uts/common/io/overlay/sarc.c
rename to usr/src/common/sarc/sarc.c
index ba762dfc3c..006ed3e098 100644
--- a/usr/src/uts/common/io/overlay/sarc.c
+++ b/usr/src/common/sarc/sarc.c
@@ -15,7 +15,10 @@
 
 #include <sys/debug.h>
 #include <sys/errno.h>
+#include <sys/sarc.h>
+#include <sys/sarc_impl.h>
 #include <sys/sysmacros.h>
+
 #ifdef _KERNEL
 #include <sys/types.h>
 #else
@@ -43,8 +46,6 @@
 #define	FREE		umem_free
 #endif
 
-#include "sarc_impl.h"
-
 /*
  * The *_overflow functions mimic the gcc/clang intrinsic functions.  Once
  * we are using a newer compiler version to that includes these as intrisnics,
diff --git a/usr/src/uts/common/Makefile.files b/usr/src/uts/common/Makefile.files
index 2def4f2ff2..4e714dff92 100644
--- a/usr/src/uts/common/Makefile.files
+++ b/usr/src/uts/common/Makefile.files
@@ -297,6 +297,7 @@ GENUNIX_OBJS +=	\
 		rw.o		\
 		rwstlock.o	\
 		sad_conf.o	\
+		sarc.o		\
 		sid.o		\
 		sidsys.o	\
 		sched.o		\
@@ -697,7 +698,7 @@ NET80211_OBJS += net80211.o net80211_proto.o net80211_input.o \
 VNIC_OBJS +=	vnic_ctl.o vnic_dev.o
 
 OVERLAY_OBJS +=	overlay.o overlay_fm.o overlay_mux.o overlay_plugin.o \
-		overlay_prop.o overlay_target.o sarc.o
+		overlay_prop.o overlay_target.o
 
 OVERLAY_VXLAN_OBJS +=	overlay_vxlan.o
 
diff --git a/usr/src/uts/common/Makefile.rules b/usr/src/uts/common/Makefile.rules
index 7c9834f3d3..1c78b62b5b 100644
--- a/usr/src/uts/common/Makefile.rules
+++ b/usr/src/uts/common/Makefile.rules
@@ -23,7 +23,7 @@
 # Copyright (c) 1991, 2010, Oracle and/or its affiliates. All rights reserved.
 # Copyright 2016 Garrett D'Amore <garrett@damore.org>
 # Copyright 2013 Saso Kiselkov. All rights reserved.
-# Copyright 2017 Joyent, Inc.
+# Copyright 2018 Joyent, Inc.
 # Copyright 2016 Nexenta Systems, Inc.
 # Copyright (c) 2016 by Delphix. All rights reserved.
 #
@@ -1625,6 +1625,10 @@ $(OBJS_DIR)/%.o:		$(UTSBASE)/common/rpc/sec_gss/%.c
 	$(COMPILE.c) -o $@ $<
 	$(CTFCONVERT_O)
 
+$(OBJS_DIR)/%.o:        $(COMMONBASE)/sarc/%.c
+	$(COMPILE.c) -o $@ $<
+	$(CTFCONVERT_O)
+
 $(OBJS_DIR)/%.o:		$(COMMONBASE)/crypto/edonr/%.c
 	$(COMPILE.c) -o $@ $<
 	$(CTFCONVERT_O)
@@ -2894,3 +2898,6 @@ $(LINTS_DIR)/%.ln:		$(COMMONBASE)/fsreparse/%.c
 
 $(LINTS_DIR)/%.ln:		$(COMMONBASE)/idspace/%.c
 	@($(LHEAD) $(LINT.c) $< $(LTAIL))
+
+$(LINTS_DIR)/%.ln:      $(COMMONBASE)/sarc/%.c
+	@($(LHEAD) $(LINT.c) $< $(LTAIL))
diff --git a/usr/src/uts/common/sys/Makefile b/usr/src/uts/common/sys/Makefile
index 0fa800d39e..1e8c5615f9 100644
--- a/usr/src/uts/common/sys/Makefile
+++ b/usr/src/uts/common/sys/Makefile
@@ -23,7 +23,7 @@
 # Copyright (c) 1989, 2010, Oracle and/or its affiliates. All rights reserved.
 # Copyright 2014, Joyent, Inc. All rights reserved.
 # Copyright 2013 Garrett D'Amore <garrett@damore.org>
-# Copyright 2015, Joyent, Inc. All rights reserved.
+# Copyright 2018, Joyent, Inc. All rights reserved.
 # Copyright 2013 Saso Kiselkov. All rights reserved.
 # Copyright 2015 Igor Kozhukhov <ikozhukhov@gmail.com>
 # Copyright 2016 Nexenta Systems, Inc.
@@ -506,6 +506,8 @@ CHKHDRS=			\
 	rwlock_impl.h		\
 	rwstlock.h		\
 	sad.h			\
+	sarc.h			\
+	sarc_impl.h		\
 	schedctl.h		\
 	sdt.h			\
 	secflags.h		\
diff --git a/usr/src/uts/common/sys/overlay_impl.h b/usr/src/uts/common/sys/overlay_impl.h
index d132f565d9..52a87e7f6c 100644
--- a/usr/src/uts/common/sys/overlay_impl.h
+++ b/usr/src/uts/common/sys/overlay_impl.h
@@ -31,8 +31,7 @@
 #include <sys/socket.h>
 #include <sys/ethernet.h>
 #include <sys/list.h>
-
-#include "sarc.h"
+#include <sys/sarc.h>
 
 #ifdef __cplusplus
 extern "C" {
diff --git a/usr/src/uts/common/io/overlay/sarc_impl.h b/usr/src/uts/common/sys/sarc_impl.h
similarity index 100%
rename from usr/src/uts/common/io/overlay/sarc_impl.h
rename to usr/src/uts/common/sys/sarc_impl.h
-- 
2.21.0

