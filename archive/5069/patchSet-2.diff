From 8ab102cf02618886a6a2c10e6ab18fb27a1589ba Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Fri, 16 Nov 2018 07:56:07 -0800
Subject: [PATCH] =?UTF-8?q?TOOLS-2110=20sdcadm=20can=20crash=20when=20SAPI?=
 =?UTF-8?q?=20instance=20has=20undefined=20image=20Reviewed=20by:=20Pedro?=
 =?UTF-8?q?=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>=20Approved=20by:?=
 =?UTF-8?q?=20Pedro=20Palaz=C3=B3n=20Candel=20<pedro@joyent.com>?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.md    | 4 ++++
 lib/sdcadm.js | 2 +-
 package.json  | 2 +-
 3 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 258ff14..6cf671a 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.21.5
+
+- TOOLS-2110 sdcadm can crash when SAPI instance has undefined image
+
 ## 1.21.4
 
 - TRITON-722 "sdcadm health" still assumes each CN will have an "admin" nictag
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index a466f20..ffc2bc3 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -832,7 +832,7 @@ SdcAdm.prototype.listInsts = function listInsts(opts, cb) {
             vasync.forEachParallel({
                 inputs: ctx.insts,
                 func: function imgadmGetImg(inst, nextInst) {
-                    if (inst.version || !inst.server) {
+                    if (inst.version || !inst.server || !inst.image) {
                         nextInst();
                         return;
                     }
diff --git a/package.json b/package.json
index ea136e2..fc73d37 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.21.4",
+  "version": "1.21.5",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

