From 37ed37946e2a86d743dd8862c2efd3de99ee0ad8 Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <josh@wilsdon.ca>
Date: Thu, 15 Nov 2018 21:06:32 -0800
Subject: [PATCH] TOOLS-2110 sdcadm can crash when SAPI instance has undefined
 image

---
 CHANGES.md    | 4 ++++
 lib/sdcadm.js | 2 +-
 package.json  | 2 +-
 3 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/CHANGES.md b/CHANGES.md
index 258ff14..6cf671a 100644
--- a/CHANGES.md
+++ b/CHANGES.md
@@ -10,6 +10,10 @@
 
 # sdcadm Changelog
 
+## 1.21.5
+
+- TOOLS-2110 sdcadm can crash when SAPI instance has undefined image
+
 ## 1.21.4
 
 - TRITON-722 "sdcadm health" still assumes each CN will have an "admin" nictag
diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index a466f20..ffc2bc3 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -832,7 +832,7 @@ SdcAdm.prototype.listInsts = function listInsts(opts, cb) {
             vasync.forEachParallel({
                 inputs: ctx.insts,
                 func: function imgadmGetImg(inst, nextInst) {
-                    if (inst.version || !inst.server) {
+                    if (inst.version || !inst.server || !inst.image) {
                         nextInst();
                         return;
                     }
diff --git a/package.json b/package.json
index ea136e2..fc73d37 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "sdcadm",
   "description": "Administer a SmartDataCenter (SDC) standup",
-  "version": "1.21.4",
+  "version": "1.21.5",
   "author": "Joyent (joyent.com)",
   "private": true,
   "dependencies": {
-- 
2.21.0

