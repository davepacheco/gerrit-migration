From 69f4ee9c85d3c5ed3260b47af7a68ff8d4ba64bd Mon Sep 17 00:00:00 2001
From: Jerry Jelinek <jerry.jelinek@joyent.com>
Date: Mon, 12 Mar 2018 19:37:05 +0000
Subject: [PATCH] OS-6682 bhyve zones can destroy any VM

---
 usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c b/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c
index 977987589f..602889b779 100644
--- a/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c
+++ b/usr/src/uts/i86pc/io/vmm/vmm_sol_dev.c
@@ -1611,6 +1611,9 @@ vmmdev_do_vm_destroy(const char *name, cred_t *cr)
 	vmm_softc_t	*sc;
 	int		err;
 
+	if (crgetuid(cr) != 0)
+		return (EPERM);
+
 	mutex_enter(&vmmdev_mtx);
 	mutex_enter(&vmm_mtx);
 
@@ -1619,6 +1622,15 @@ vmmdev_do_vm_destroy(const char *name, cred_t *cr)
 		mutex_exit(&vmmdev_mtx);
 		return (ENOENT);
 	}
+	/*
+	 * We don't check this in vmm_lookup() since that function is also used
+	 * for validation during create and currently vmm names must be unique.
+	 */
+	if (!INGLOBALZONE(curproc) && sc->vmm_zone != curzone) {
+		mutex_exit(&vmm_mtx);
+		mutex_exit(&vmmdev_mtx);
+		return (EPERM);
+	}
 	err = vmm_do_vm_destroy_locked(sc, B_TRUE);
 
 	mutex_exit(&vmm_mtx);
-- 
2.21.0

