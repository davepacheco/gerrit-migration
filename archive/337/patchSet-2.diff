From dea9ee7ed7774824252d437f18c03c0f6bdcd13c Mon Sep 17 00:00:00 2001
From: Trent Mick <trentm@gmail.com>
Date: Tue, 23 Aug 2016 15:20:42 -0700
Subject: [PATCH] IMGAPI-582 imgapi-cli should have a --insecure option for an
 IMGAPI with a self-signed cert

---
 bin/imgapi-cli     | 3 ++-
 bin/joyent-imgadm  | 3 ++-
 bin/updates-imgadm | 3 ++-
 lib/cli.js         | 7 +++++--
 4 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/bin/imgapi-cli b/bin/imgapi-cli
index 4d7cf58..f084ce7 100755
--- a/bin/imgapi-cli
+++ b/bin/imgapi-cli
@@ -55,7 +55,8 @@ function main(argv) {
         envopts: [
             ['IMGAPI_CLI_IDENTITY', 'identity'],
             ['IMGAPI_CLI_USER', 'user'],
-            ['IMGAPI_CLI_CHANNEL', 'channel']
+            ['IMGAPI_CLI_CHANNEL', 'channel'],
+            ['IMGAPI_CLI_INSECURE', 'insecure']
         ],
         connectTimeout: 10000
     });
diff --git a/bin/joyent-imgadm b/bin/joyent-imgadm
index 92061d9..7dee488 100755
--- a/bin/joyent-imgadm
+++ b/bin/joyent-imgadm
@@ -66,7 +66,8 @@ function main(argv) {
         features: FEATURES,
         envopts: [
             ['JOYENT_IMGADM_IDENTITY', 'identity'],
-            ['JOYENT_IMGADM_USER', 'user']
+            ['JOYENT_IMGADM_USER', 'user'],
+            ['JOYENT_IMGADM_INSECURE', 'insecure']
         ],
         connectTimeout: 10000
     });
diff --git a/bin/updates-imgadm b/bin/updates-imgadm
index cebf3d3..ff21077 100755
--- a/bin/updates-imgadm
+++ b/bin/updates-imgadm
@@ -71,7 +71,8 @@ function main(argv) {
         envopts: [
             ['UPDATES_IMGADM_IDENTITY', 'identity'],
             ['UPDATES_IMGADM_USER', 'user'],
-            ['UPDATES_IMGADM_CHANNEL', 'channel']
+            ['UPDATES_IMGADM_CHANNEL', 'channel'],
+            ['UPDATES_IMGADM_INSECURE', 'insecure']
         ],
         connectTimeout: 10000
     });
diff --git a/lib/cli.js b/lib/cli.js
index 4bf3dd8..e86e193 100644
--- a/lib/cli.js
+++ b/lib/cli.js
@@ -306,6 +306,7 @@ CLI.prototype.main = function main(argv, callback) {
         if (self._connectTimeout) {
             imgapiOpts.connectTimeout = self._connectTimeout;
         }
+        imgapiOpts.rejectUnauthorized = !opts.insecure;
         self.client = imgapi.createClient(imgapiOpts);
 
         var subcmd = args.shift();
@@ -334,7 +335,8 @@ CLI.prototype.handleArgv = function handleArgv(argv, envopts, callback) {
     var longOpts = this.longOpts = {
         'help': Boolean,
         'version': Boolean,
-        'debug': Boolean
+        'debug': Boolean,
+        'insecure': Boolean
     };
     var shortOpts = this.shortOpts = {
         'h': ['--help'],
@@ -428,7 +430,8 @@ CLI.prototype.printHelp = function printHelp(callback) {
         'Options:',
         '    -h, --help          Show this help message and exit.',
         '    --version           Show version and exit.',
-        '    -d, --debug         Verbose logging.'
+        '    -d, --debug         Verbose logging.',
+        '    --insecure          Do not validate a TLS certificate.'
     ]);
     if (this.auth === 'basic') {
         lines = lines.concat([
-- 
2.21.0

