From 8d395674a91993fa34f111d096c0363f8d712a6a Mon Sep 17 00:00:00 2001
From: Tim Kordas <tim.kordas@joyent.com>
Date: Fri, 4 Aug 2017 14:35:04 -0700
Subject: [PATCH] joyent/node-checker#38 http checker never reads responses,
 resulting in leaks and failed checks Reviewed by: Dave Pacheco
 <dap@joyent.com>

---
 lib/checkers/http_checker.js | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/lib/checkers/http_checker.js b/lib/checkers/http_checker.js
index c34c82d..f14995c 100644
--- a/lib/checkers/http_checker.js
+++ b/lib/checkers/http_checker.js
@@ -60,8 +60,19 @@ HttpChecker.prototype.check = function (cb) {
                         error = new Error('status code is >= 300');
                         error.code = res.statusCode;
                 }
-                cb(error, {
-                        'httpStatusCode': res.statusCode
+                /*
+                 * There is an unfortunate side-effect here: without the
+                 * data listener, no data is consumed from the connection,
+                 * and the end-listener will never be called. The unconsumed
+                 * data is leaked, and the underlying TCP socket is left in
+                 * CLOSE_WAIT. So we add an "empty" data-listener: it consumes
+                 * inbound response-data, preventing the leak.
+                 */
+                res.on('data', function (d) { /* consume */});
+                res.on('end', function () {
+                       cb(error, {
+                               'httpStatusCode': res.statusCode
+                       });
                 });
         });
         req.once('error', function (err) {
-- 
2.21.0

