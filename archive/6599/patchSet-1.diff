From da7df359472f4e9a180a6903f7a8e0a0ad3901c5 Mon Sep 17 00:00:00 2001
From: Rui Loura <rui@joyent.com>
Date: Fri, 12 Jul 2019 11:19:05 -0400
Subject: [PATCH] MANTA-4409 Arbitrary MantaObject in rust-libmanta should
 format manta_storage_id as domain name

---
 Cargo.toml   |  1 +
 src/lib.rs   | 13 ++-----------
 src/moray.rs | 49 +++++++++++++++++++++++++++++++++++++++++++++----
 src/util.rs  |  4 +---
 4 files changed, 49 insertions(+), 18 deletions(-)

diff --git a/Cargo.toml b/Cargo.toml
index 63dea15..c7e6354 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -12,3 +12,4 @@ uuid = {version = "0.7.4", features = ["v4"] }
 md5 = "0.6.1"
 base64 = "0.10.1"
 rand = "0.6.5"
+regex = "1.1.9"
diff --git a/src/lib.rs b/src/lib.rs
index 717268f..e112549 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -1,13 +1,4 @@
-/*
- * Copyright 2019 Joyent, Inc.
- */
+// Copyright 2019 Joyent, Inc.
+
 pub mod moray;
 mod util;
-
-#[cfg(test)]
-mod tests {
-    #[test]
-    fn it_works() {
-        ()
-    }
-}
diff --git a/src/moray.rs b/src/moray.rs
index ebf0098..ef4a1e0 100644
--- a/src/moray.rs
+++ b/src/moray.rs
@@ -1,6 +1,4 @@
-/*
- * Copyright 2019 Joyent, Inc.
- */
+// Copyright 2019 Joyent, Inc.
 
 use crate::util;
 use base64;
@@ -76,9 +74,18 @@ pub struct MantaDirectory {
 impl Arbitrary for MantaObjectShark {
     fn arbitrary<G: Gen>(g: &mut G) -> MantaObjectShark {
         let len = g.gen::<u8>() as usize;
+
+        // Instead of modifying random_string to always have a strlen >= 1,
+        // just pre-pend a single character to each string.
+        let msid = format!(
+            "{}.a{}.b{}",
+            len,
+            util::random_string(g, len),
+            util::random_string(g, len)
+        );
         MantaObjectShark {
             datacenter: util::random_string(g, len),
-            manta_storage_id: util::random_string(g, len),
+            manta_storage_id: msid,
         }
     }
 }
@@ -144,3 +151,37 @@ impl Arbitrary for MantaObject {
         }
     }
 }
+
+#[cfg(test)]
+mod tests {
+    use super::*;
+    use quickcheck::quickcheck;
+    use regex::Regex;
+    use std::str::FromStr;
+
+    quickcheck!(
+        fn create_manta_object(mobj: MantaObject) -> bool {
+            dbg!(&mobj);
+
+            let str_etag = Uuid::from_str(mobj.etag.as_str());
+            let str_owner = Uuid::from_str(mobj.owner.as_str());
+            let str_object_id = Uuid::from_str(mobj.object_id.as_str());
+            assert!(str_etag.is_ok());
+            assert!(str_owner.is_ok());
+            assert!(str_object_id.is_ok());
+
+            assert_eq!(str_etag.unwrap().to_string(), mobj.etag);
+            assert_eq!(str_owner.unwrap().to_string(), mobj.owner);
+            assert_eq!(str_object_id.unwrap().to_string(), mobj.object_id);
+
+            let re = Regex::new(r"(?i)\d+.[a-z0-9-]+.[a-z0-9-]+").unwrap();
+
+            for shark in mobj.sharks.iter() {
+                dbg!(&shark.manta_storage_id);
+                assert!(re.is_match(&shark.manta_storage_id));
+            }
+
+            true
+        }
+    );
+}
diff --git a/src/util.rs b/src/util.rs
index 64760d2..5b6bd0d 100644
--- a/src/util.rs
+++ b/src/util.rs
@@ -1,6 +1,4 @@
-/*
- * Copyright 2019 Joyent, Inc.
- */
+// Copyright 2019 Joyent, Inc.
 
 use quickcheck::Gen;
 use rand::distributions::Alphanumeric;
-- 
2.21.0

