From 3b48adb446ec8fb147434b00f0d0ef843f512a1e Mon Sep 17 00:00:00 2001
From: Alex Wilson <alex.wilson@joyent.com>
Date: Mon, 10 Jun 2019 11:18:46 -0700
Subject: [PATCH] joyent/node-zkstream#47 negative lengths result in sadness
 Reviewed by: Cody Peter Mello <cody.mello@joyent.com> Approved by: Cody Peter
 Mello <cody.mello@joyent.com>

---
 lib/jute-buffer.js |  6 ++++++
 package.json       |  2 +-
 test/basic.test.js | 28 ++++++++++++++++++++++++++++
 3 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/lib/jute-buffer.js b/lib/jute-buffer.js
index f7e1cbc..21fd2ac 100644
--- a/lib/jute-buffer.js
+++ b/lib/jute-buffer.js
@@ -96,6 +96,8 @@ LongDate.prototype.toString = function () {
 
 JuteBuffer.prototype.readBuffer = function () {
 	var len = this.readInt();
+	if (len < 0)
+		len = 0;
 	mod_assert.ok(this.jb_offset + len <= this.jb_size);
 	var buf = this.jb_buffer.slice(this.jb_offset, this.jb_offset + len);
 	this.jb_offset += len;
@@ -122,6 +124,10 @@ JuteBuffer.prototype.writeBuffer = function (v, assertName) {
 	mod_assert.buffer(v, assertName || 'value');
 	while (this.jb_offset + v.length + 4 > this.jb_size)
 		this.expand();
+	if (v.length === 0) {
+		this.writeInt(-1);
+		return;
+	}
 	this.writeInt(v.length);
 	v.copy(this.jb_buffer, this.jb_offset);
 	this.jb_offset += v.length;
diff --git a/package.json b/package.json
index 10b30d8..74de4d4 100644
--- a/package.json
+++ b/package.json
@@ -1,6 +1,6 @@
 {
   "name": "zkstream",
-  "version": "0.11.6",
+  "version": "0.11.7",
   "description": "",
   "repository": {
     "type": "git",
diff --git a/test/basic.test.js b/test/basic.test.js
index c13cf16..e5b1d69 100644
--- a/test/basic.test.js
+++ b/test/basic.test.js
@@ -248,6 +248,34 @@ mod_tape.test('create a new node', function (t) {
 	});
 });
 
+mod_tape.test('create a new node with no data (null)', function (t) {
+	var zkc = new mod_zkc.Client({
+		log: log,
+		address: '127.0.0.1',
+		port: 2181
+	});
+
+	zkc.on('close', function () {
+		t.end();
+	});
+
+	zkc.on('connect', function () {
+		var d = new Buffer(0);
+		zkc.create('/foonull', d, {}, function (err, path) {
+			t.error(err);
+			t.strictEqual(path, '/foonull');
+			zkc.get('/foonull', function (err2, data) {
+				t.error(err2);
+				t.strictEqual(data.length, 0);
+				zkc.delete('/foonull', -1, function (err3) {
+					t.error(err3);
+					zkc.close();
+				});
+			});
+		});
+	});
+});
+
 // Helper used by the createWithEmptyParents API tests
 
 /*
-- 
2.21.0

