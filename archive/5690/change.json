{"project":"joyent/eng","branch":"master","id":"I225cc21b332fce9c36227e4d8aa87745ad5afb8c","number":"5690","subject":"TOOLS-2192 buildimage target fails with non-default BUILDIMAGE_VERSION value Reviewed by: Tim Foster \u003ctim.foster@joyent.com\u003e Approved by: Tim Foster \u003ctim.foster@joyent.com\u003e","owner":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"url":"https://cr.joyent.us/5690","commitMessage":"TOOLS-2192 buildimage target fails with non-default BUILDIMAGE_VERSION value\nReviewed by: Tim Foster \u003ctim.foster@joyent.com\u003e\nApproved by: Tim Foster \u003ctim.foster@joyent.com\u003e\n","createdOn":1551477136,"lastUpdated":1551811592,"open":false,"status":"MERGED","comments":[{"timestamp":1551477136,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 1."},{"timestamp":1551477201,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1551695058,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\nI think this is ok - did you test that \u0027make bits-upload-latest\u0027 still does the right thing, uploading to a $(STAMP) directory?\n\nArguably, bits-upload should prune any cruft from the bits dir or refuse to upload things that don\u0027t meet one or more of these criteria\n\n - name must contain $(STAMP)\n - (and now) name must $(BUILDIMAGE_VERSION)\n - or one of a named set of special files [build-environment, latest-build-stamp, npm-ls.json ]\n\nbut that\u0027s not this commit."},{"timestamp":1551710398,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 2:\n\nThe behavior that you would expect/want on upload is?\n  * (default) Manta dir has $(STAMP), $(STAMP) in file name\n * (BUILDIMAGE_VERSION set) Manta dir has $(STAMP), $(BUILDIMAGE_VERSION) in file name"},{"timestamp":1551710579,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 2:\n\n\u003e The behavior that you would expect/want on upload is?\n \u003e * (default) Manta dir has $(STAMP), $(STAMP) in file name\n \u003e * (BUILDIMAGE_VERSION set) Manta dir has $(STAMP),\n \u003e $(BUILDIMAGE_VERSION) in file name\n\nYep. Specifically, we should still be able to disambiguate two builds of the same component, even if they produce files of the same name, so what you suggest above sounds correct."},{"timestamp":1551726524,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 3."},{"timestamp":1551726748,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 3:\n\nExamples with default BUILDIMAGE_VERSION and with it overridden\n\n$ mls  ~~/public/builds/triton-origin-multiarch-15.4.1/\nbuildy-mc-buildface-20190304T190039Z-gc68731a-dirty/\nbuildy-mc-buildface-20190304T190425Z-gc68731a-dirty/\nbuildy-mc-buildface-latest\n\n$ mls -l ~~/public/builds/triton-origin-multiarch-15.4.1/buildy-mc-buildface-20190304T190039Z-gc68731a-dirty/triton-origin-multiarch-15.4.1/\n-rwxr-xr-x 1 cburroughs           136 Mar 04 14:02 build-environment\n-rwxr-xr-x 1 cburroughs            52 Mar 04 14:03 latest-build-stamp\n-rwxr-xr-x 1 cburroughs         71417 Mar 04 14:03 npm-ls.json\n-rwxr-xr-x 1 cburroughs           838 Mar 04 14:02 triton-origin-multiarch-15.4.1-zfs-buildy-mc-buildface-20190304T190039Z-gc68731a-dirty.imgmanifest\n-rwxr-xr-x 1 cburroughs     273182755 Mar 04 14:03 triton-origin-multiarch-15.4.1-zfs-buildy-mc-buildface-20190304T190039Z-gc68731a-dirty.zfs.gz\n\n\nmls -l ~~/public/builds/triton-origin-multiarch-15.4.1/buildy-mc-buildface-20190304T190425Z-gc68731a-dirty/triton-origin-multiarch-15.4.1/\n-rwxr-xr-x 1 cburroughs           136 Mar 04 14:06 build-environment\n-rwxr-xr-x 1 cburroughs            52 Mar 04 14:06 latest-build-stamp\n-rwxr-xr-x 1 cburroughs         71417 Mar 04 14:06 npm-ls.json\n-rwxr-xr-x 1 cburroughs           807 Mar 04 14:06 triton-origin-multiarch-15.4.1-zfs-1.1.20190304T190425Z.imgmanifest\n-rwxr-xr-x 1 cburroughs     273174723 Mar 04 14:06 triton-origin-multiarch-15.4.1-zfs-1.1.20190304T190425Z.zfs.gz"},{"timestamp":1551788674,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 3:\n\n(1 comment)\n\nThanks for that extra testing, this looks like it\u0027s doing the right thing now. Only a minor nit on what might occur if we kick off two builds in parallel on the same build machine."},{"timestamp":1551805410,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 4."},{"timestamp":1551806107,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1551811352,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1551811505,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1551811590,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1551811592,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Chris Burroughs"}],"currentPatchSet":{"number":"7","revision":"cc594dbf729d5abc558b92bb57888bea13f24b95","parents":["89ac056591a1e1f105373ac0c1e516d7aba6b3db"],"ref":"refs/changes/90/5690/7","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551811590,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"SUBM","value":"1","grantedOn":1551811592,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":6,"sizeDeletions":-6},"patchSets":[{"number":"1","revision":"0e760e5860d1db7e531508c9a2f8658c973226cc","parents":["f6b4449b52f0c86d55ce0eaa071b25217915e10f"],"ref":"refs/changes/90/5690/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551477136,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":4,"sizeDeletions":-4},{"number":"2","revision":"e7670df5fbfa09c7bffaf0fb8149c4b6ecb8139f","parents":["85dc74d8b11c8f7b17267778d616ce4f35b711b0"],"ref":"refs/changes/90/5690/2","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551477201,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"TRIVIAL_REBASE","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":4,"sizeDeletions":-4},{"number":"3","revision":"f1c35e3f29ed56561a0f52a15748dc6eeddd3d6b","parents":["5b2a538c55362c04448f90847c8e63136dfa5abc"],"ref":"refs/changes/90/5690/3","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551726524,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","comments":[{"file":"tools/mk/Makefile.defs","line":196,"reviewer":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},"message":"I think you probably always want this to be the stamp so that any concurrent builds of the same BUILDIMAGE_VERSION don\u0027t overwrite each other\u0027s tmp files (unless we\u0027re somehow leaking the stage-dir name into the image somehow?)"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":3,"deletions":-3},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":7,"sizeDeletions":-7},{"number":"4","revision":"225cc21b332fce9c36227e4d8aa87745ad5afb8c","parents":["def9948f18aa2cf0059dccbf468e4d650f3d50e3"],"ref":"refs/changes/90/5690/4","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551805410,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":6,"sizeDeletions":-6},{"number":"5","revision":"7ef20f058b98950c595b92e767efd3ce630940e0","parents":["def9948f18aa2cf0059dccbf468e4d650f3d50e3"],"ref":"refs/changes/90/5690/5","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551811352,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":6,"sizeDeletions":-6},{"number":"6","revision":"2d6010c9daacc3982f7b86f18eb1b638baf3d6d1","parents":["14c5ef62fc47b07093ff909518d38d5518913e24"],"ref":"refs/changes/90/5690/6","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551811505,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":6,"sizeDeletions":-6},{"number":"7","revision":"cc594dbf729d5abc558b92bb57888bea13f24b95","parents":["89ac056591a1e1f105373ac0c1e516d7aba6b3db"],"ref":"refs/changes/90/5690/7","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1551811590,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"SUBM","value":"1","grantedOn":1551811592,"by":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1551806107,"by":{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"tools/mk/Makefile.defs","type":"MODIFIED","insertions":2,"deletions":-2},{"file":"tools/mk/Makefile.targ","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":6,"sizeDeletions":-6}],"allReviewers":[{"name":"Tim Foster","email":"tim.foster@joyent.com","username":"timfoster"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"}]}