From 52fa679cd2b50f0023a3d8feaf8352b53b3ff4af Mon Sep 17 00:00:00 2001
From: Cody Peter Mello <cody.mello@joyent.com>
Date: Tue, 26 Jul 2016 02:07:05 +0000
Subject: [PATCH] NET-361 booter uses type=file instead of type=hash for
 networking.json hash

---
 lib/menulst.js | 29 +++++++++++++++++++++++++----
 1 file changed, 25 insertions(+), 4 deletions(-)

diff --git a/lib/menulst.js b/lib/menulst.js
index c1d46b2..8e7cf5e 100644
--- a/lib/menulst.js
+++ b/lib/menulst.js
@@ -18,6 +18,9 @@ var fmt = require('util').format;
 var fs = require('fs');
 
 
+var HASH_RE = /^(.*)\.hash$/;
+
+
 /**
  * Using an object of unordered key/value pairs, create an string of parameters
  * (alphabetically sorted). If any flags are created, the string will end with
@@ -81,8 +84,17 @@ function addMenuItem(menu, opts) {
 
     if (!opts.disableBootTimeFiles && opts.bootFiles) {
         opts.bootFiles.forEach(function (bf) {
-            menu.push(fmt('  module$ %s/%s type=file name=%s',
-                opts.bootFsDirRelative, bf, bf));
+            var fparts = HASH_RE.exec(bf);
+            var ftype = 'file';
+            var fname = bf;
+
+            if (fparts !== null) {
+                fname = fparts[1];
+                ftype = 'hash';
+            }
+
+            menu.push(fmt('  module$ %s/%s type=%s name=%s',
+                opts.bootFsDirRelative, bf, ftype, fname));
         });
     }
 
@@ -294,9 +306,18 @@ function buildGpxeCfg_impl(opts, cb)  {
     if (!opts.disableBootTimeFiles && opts.bootFiles &&
         opts.bootFiles.length !== 0 && opts.bootFsDirRelative) {
         opts.bootFiles.forEach(function (bf) {
+            var fparts = HASH_RE.exec(bf);
+            var ftype = 'file';
+            var fname = bf;
+
+            if (fparts !== null) {
+                fname = fparts[1];
+                ftype = 'hash';
+            }
+
             result.push(fmt(
-                'module %s://${next-server}%s/%s type=file name=%s ',
-                proto, opts.bootFsDirRelative, bf, bf));
+                'module %s://${next-server}%s/%s type=%s name=%s ',
+                proto, opts.bootFsDirRelative, bf, ftype, fname));
         });
     }
 
-- 
2.21.0

