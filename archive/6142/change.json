{"project":"joyent/sdcadm","branch":"master","id":"I181da3023aa40899696b5b4af76d1917e87bc801","number":"6142","subject":"TRITON-1625 Have `sdcadm post-setup prometheus` add prometheus zone IP to CNS allow_transfer list TRITON-1624 Change prometheus image name to \"manta-prometheus\" in sdcadm Reviewed by: Trent Mick \u003ctrentm@gmail.com\u003e Approved by: Trent Mick \u003ctrentm@gmail.com","owner":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"url":"https://cr.joyent.us/6142","commitMessage":"TRITON-1625 Have `sdcadm post-setup prometheus` add prometheus zone IP to CNS allow_transfer list\nTRITON-1624 Change prometheus image name to \"manta-prometheus\" in sdcadm\nReviewed by: Trent Mick \u003ctrentm@gmail.com\u003e\nApproved by: Trent Mick \u003ctrentm@gmail.com\u003e\n","createdOn":1555959804,"lastUpdated":1557434954,"open":false,"status":"MERGED","comments":[{"timestamp":1555959804,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 1."},{"timestamp":1555965404,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\n(2 comments)"},{"timestamp":1556651077,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 2."},{"timestamp":1556651156,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Uploaded patch set 3."},{"timestamp":1556651227,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 3:\n\n(1 comment)\n\nSee ticket for testing notes for new AddAllowTransferProcedure procedure."},{"timestamp":1556668773,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1557434314,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3: Code-Review+1 Integration-Approval+1\n\n(2 comments)\n\nParfait."},{"timestamp":1557434620,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 4: Patch Set 3 was rebased"},{"timestamp":1557434656,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1557434902,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1557434954,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Isaac Davis"}],"currentPatchSet":{"number":"5","revision":"f3ab2b54fba9f58b3ee7cd39c0e1083bb6c14442","parents":["68397ac09343d8af9ad971a56d57651ea4a2ccf0"],"ref":"refs/changes/42/6142/5","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1557434902,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556668773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1557434954,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"MODIFIED","insertions":34,"deletions":-17},{"file":"lib/procedures/add-allow-transfer.js","type":"ADDED","insertions":364,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"b3fc944ec22af0b506dc3c90ecc1ca6cff6c1e5d","parents":["7b8b7e1075ad2d46510e65a1c57842a3e7070052"],"ref":"refs/changes/42/6142/1","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1555959804,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","comments":[{"file":"CHANGES.md","line":15,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"markdown syntax: escape the underscore"},{"file":"CHANGES.md","line":15,"reviewer":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"message":"Done"},{"file":"lib/post-setup/prometheus.js","line":87,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Hrm. This is subtle info passing out of the procedure. I\u0027d prefer some cleaner way.\n\nHow about this:\n\n- Add a new procedure called something like \"PrometheusInstsInCnsAllowTransferProc\" (or something shorter if you can make it at least somewhat self-explanatory). The job of this procedure is to ensure that the (admin?) IP of each prometheus instance (there might be more than one) is in the CNS `allow_transfer` array.\n- Create an instance of that Proc and add it to the `procs` array arg to `runProcs` here.\n\n\nWe then shouldn\u0027t need to pass data out of the AddServiceProc. The whole process here will also then be idempotent: a re-run will re-attempt to update the CNS `allow_transfer` list if that failed for some transient reason in an earlier run."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"MODIFIED","insertions":95,"deletions":-2},{"file":"lib/procedures/add-service.js","type":"MODIFIED","insertions":10,"deletions":-1},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":112,"sizeDeletions":-5},{"number":"2","revision":"2dea3bf5853aa8c3908d5ad9bcde69a0565bb634","parents":["7b8b7e1075ad2d46510e65a1c57842a3e7070052"],"ref":"refs/changes/42/6142/2","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1556651077,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"MODIFIED","insertions":34,"deletions":-17},{"file":"lib/procedures/add-allow-transfer.js","type":"ADDED","insertions":364,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-19},{"number":"3","revision":"181da3023aa40899696b5b4af76d1917e87bc801","parents":["7b8b7e1075ad2d46510e65a1c57842a3e7070052"],"ref":"refs/changes/42/6142/3","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1556651156,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556668773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"comments":[{"file":"lib/procedures/add-allow-transfer.js","line":63,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"FWIW, the pattern of prefixing a prototype function with something close to the class name (e.g. \"addAllowTransfer\" here) only ever originated to cope with multiple classes with the same method names in the same file.\n\nE.g.\n\n```\nFoo.prototype.bar \u003d function bar() {...}\n\nFry.prototype.bar \u003d function bar() {...}\n```\n\nThose two \"function bar\"\u0027s collide in the top-level namespace.\n\n\nBecause new procedures are being put in their own files, you should definitely feel welcome to just re-use the short method name, e.g.:\n\n```\nAddAllowTransferProcedure.prototype.prepare \u003d function prepare(...)\n```"},{"file":"lib/procedures/add-allow-transfer.js","line":178,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"I feel like we should consider an optional first Object arg to `ui.info` to have it include in the `log.info` that *it* does. Then we wouldn\u0027t need the pattern of ui.info *and* a log.info right after.\n\nSeparate work, though."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"MODIFIED","insertions":34,"deletions":-17},{"file":"lib/procedures/add-allow-transfer.js","type":"ADDED","insertions":364,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-19},{"number":"4","revision":"4d1525636b1e4179dfebc8f17f065f631f5fd055","parents":["68397ac09343d8af9ad971a56d57651ea4a2ccf0"],"ref":"refs/changes/42/6142/4","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1557434620,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556668773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"MODIFIED","insertions":34,"deletions":-17},{"file":"lib/procedures/add-allow-transfer.js","type":"ADDED","insertions":364,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-19},{"number":"5","revision":"f3ab2b54fba9f58b3ee7cd39c0e1083bb6c14442","parents":["68397ac09343d8af9ad971a56d57651ea4a2ccf0"],"ref":"refs/changes/42/6142/5","uploader":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"createdOn":1557434902,"author":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1556668773,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1557434314,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"SUBM","value":"1","grantedOn":1557434954,"by":{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"etc/defaults.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"lib/post-setup/prometheus.js","type":"MODIFIED","insertions":34,"deletions":-17},{"file":"lib/procedures/add-allow-transfer.js","type":"ADDED","insertions":364,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":405,"sizeDeletions":-19}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},{"name":"Isaac Davis","email":"isaac.davis@joyent.com","username":"isaacdavis"}]}