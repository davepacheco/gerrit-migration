From c16e23a2000ad7c7645fb5477d039783027b67d0 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 15 Oct 2019 18:37:35 +0000
Subject: [PATCH] TRITON-1888 server-setup workflow should always reboot

---
 deps/eng                      |  2 +-
 lib/workflows/server-setup.js | 24 ++++++++++--------------
 2 files changed, 11 insertions(+), 15 deletions(-)

diff --git a/deps/eng b/deps/eng
index 9058562..940d8fb 160000
--- a/deps/eng
+++ b/deps/eng
@@ -1 +1 @@
-Subproject commit 9058562f2f59892795e470ce25443ff636c90478
+Subproject commit 940d8fbbef6f4d0e6a9e45409fc4646eda8255e8
diff --git a/lib/workflows/server-setup.js b/lib/workflows/server-setup.js
index f2cab70..d4b0250 100644
--- a/lib/workflows/server-setup.js
+++ b/lib/workflows/server-setup.js
@@ -284,8 +284,16 @@ function markServerAsSetup(job, callback) {
     });
 }
 
-// XXX most of this comes from sendRebootMessage in the server-reboot job
-//     should refactor.
+/*
+ * Note that we always reboot the CN even if the hostname param isn't set.  This
+ * is because an un-setup server is in a slightly odd state - without the zones
+ * pool, vmadmd will be disabled.  Worse, joysetup.sh needs to replace /var, and
+ * the way it does that effectively stomps on /var/run, and in particular any
+ * door servers there.  The simplest way to get to a sane state is to reboot.
+ *
+ * XXX most of this comes from sendRebootMessage in the server-reboot job;
+ * should refactor.
+ */
 function rebootServer(job, callback) {
     var cnapiUrl = job.params.cnapi_url;
     var cnapi = restify.createJsonClient({ url: cnapiUrl});
@@ -297,12 +305,6 @@ function rebootServer(job, callback) {
 
     job.log.info('rebootServer');
 
-    if (!job.params.hostname) {
-        job.log.info('No need to reboot, hostname not set');
-        callback();
-        return;
-    }
-
     cnapi.post(urUrl, payload, function (error, req, res) {
         job.log.info('rebootServer (post)');
         if (error) {
@@ -323,12 +325,6 @@ function waitForReboot(job, callback) {
 
     job.log.info('waitForReboot()');
 
-    if (!job.params.hostname) {
-        job.log.info('No need to wait for reboot, hostname not set');
-        callback();
-        return;
-    }
-
     function checkRebooted() {
         cnapi.get(serverUrl, function (err, req, res, server) {
             var cn_state;
-- 
2.17.2 (Apple Git-113)

