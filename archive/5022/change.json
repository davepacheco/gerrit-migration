{"project":"joyent/node-fast","branch":"master","id":"I8307398871dfa7c3d01ca7dbc1bfdf83d5210aa8","number":"5022","subject":"joyent/node-fast#21 node-fast should support fixed buckets and artedi v2 Reviewed by: Kody A Kantor \u003ckody@kkantor.com\u003e Approved by: Kody A Kantor \u003ckody@kkantor.com\u003e","owner":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"url":"https://cr.joyent.us/5022","commitMessage":"joyent/node-fast#21 node-fast should support fixed buckets and artedi v2\nReviewed by: Kody A Kantor \u003ckody@kkantor.com\u003e\nApproved by: Kody A Kantor \u003ckody@kkantor.com\u003e\n","createdOn":1541140830,"lastUpdated":1542399093,"open":false,"status":"MERGED","comments":[{"timestamp":1541140830,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 1."},{"timestamp":1541140831,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 8e6dc285573981869143ed4ff6fabf901bcac056\n    \n    add support for node-artedi v2, switch histogram metrics to using seconds rather than milliseconds"},{"timestamp":1541140835,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing-1\n\n(4 comments)\n\n\"make check\" exited with status 2"},{"timestamp":1541141028,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 2."},{"timestamp":1541141029,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 9f2b877d115e8996ab5c636ae578ecd57c9610d2\n    \n    fix \u0027make check\u0027 on account of tabs"},{"timestamp":1541141032,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1541181525,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 3."},{"timestamp":1541181526,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 0e9b97475bb709f9bc7ff7df445656987a42b471\n    \n    fix comment, extend range after looking at more data"},{"timestamp":1541181529,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1542038359,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3: Code-Review+1\n\n(2 comments)"},{"timestamp":1542038521,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1542089151,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(3 comments)"},{"timestamp":1542127556,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(3 comments)\n\nNice! Thanks!"},{"timestamp":1542131945,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 3:\n\n(1 comment)"},{"timestamp":1542232710,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 3:\n\n(1 comment)\n\nLooks good. FWIW it looks like the node-fast repo usually uses GitHub issues instead of Jira tickets for issue tracking. If it\u0027s not too much of a bother it\u0027d be nice if an issue could be opened there."},{"timestamp":1542327738,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1542327779,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 5: Commit message was updated."},{"timestamp":1542398794,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 6: Commit message was updated."},{"timestamp":1542398987,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Patch Set 6: Integration-Approval+1"},{"timestamp":1542399084,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 7: Commit message was updated."},{"timestamp":1542399093,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Josh Wilsdon"}],"currentPatchSet":{"number":"7","revision":"cb09be8dc546c7fa4e66a637633003eb9ca13dc0","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1542399084,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541181529,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542038359,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542398987,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"SUBM","value":"1","grantedOn":1542399093,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-7},"patchSets":[{"number":"1","revision":"8d1e447931aab12778925e20060085f2f9f4fe95","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/1","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1541140830,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"-1","grantedOn":1541140835,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/fast_client.js","line":135,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/fast_client.js","line":137,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/fast_server.js","line":239,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"},{"file":"lib/fast_server.js","line":241,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"line \u003e 80 characters"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":22,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":22,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":60,"sizeDeletions":-7},{"number":"2","revision":"d55d4b4b488e8ceddb3f5e27ea00bd0b3ed21717","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/2","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1541141028,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541141032,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":23,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":23,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":62,"sizeDeletions":-7},{"number":"3","revision":"616ef8d6a60434a97eb4f0cf12a10a008d09a3b3","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/3","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1541181525,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541181529,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542038359,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"comments":[{"file":"CHANGES.md","line":19,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"This is a good approach. Any reason we\u0027re not using \u0027buckets_version\u003d\"2\"\u0027 here instead (version \"1\" implied to represent the broken buckets)?\n\nI\u0027m not sure which option is more confusing."},{"file":"CHANGES.md","line":19,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yeah, I\u0027m not sure either. If we go with buckets_version\u003d\"2\", there will never be a buckets_version\u003d\"1\" which I thought was also confusing."},{"file":"CHANGES.md","line":19,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Yeah, works for me. Both are confusing so whatever you think is best works for me!"},{"file":"lib/fast_server.js","line":137,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Any reason we shouldn\u0027t call the artedi.logLinearBuckets() function instead of hard-coding the buckets here? (same question about fast_client.js)"},{"file":"lib/fast_server.js","line":137,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Yes. The reason is that at node-fast we get an artedi *collector* passed to us. Not an artedi module. As such, we don\u0027t have access to logLinearBuckets or the other bucket generator functions. The two ways we could do that that I thought of were:\n\n1) have node-fast use *its* version of node-artedi (which we\u0027d have to add to the dependencies). However this would mean that very often we\u0027re using a different version from the collector. Which seems... odd too.\n\n2) have the collector somehow expose a method to get access to the bucket generation functions. Every way I tried to do this felt pretty gross to me.\n\nNeither of which seemed like it was better than the more explicit hardcoding of the buckets here. If you have a preference for some other option, I could do that."},{"file":"lib/fast_server.js","line":137,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Ah, right. Thanks.\n\nThe downside to this approach is that we\u0027ll probably have other libraries that would want to create their own histograms (cueball is the only one I can think of at the moment).\n\nThe only other option I can think of would be to pull the bucket generator code out of node-artedi into a separate node module. That would be yet another package to maintain.\n\nIf you think hard coding the buckets here is the best option then that\u0027s fine with me too."},{"file":"lib/fast_server.js","line":137,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"I have asked around for a few opinions and so far I think I am getting more confident that I\u0027d like to hardcode these here. I think this also has the advantage of being much more obvious when someone looks at the code and wants to know what the buckets are. I suspect it\u0027s easier to look at this array for most people than artedi.logLinearBuckets(10, -4, 1, 5) and know what the buckets are going to look like. On top of that, diffs from one version to the next will make it much more clear what buckets changed. And there are no *more* changes than would be required if the parameters to the bucket generator arguments changed."},{"file":"lib/fast_server.js","line":137,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Great! Works for me. Thanks for looking into it."},{"file":"lib/fast_server.js","line":230,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Also, the upgrade plan here is to update the node-artedi version in the package.json file from 1.1.1 to 2.0.0 at some point in the future after we\u0027ve navigated the flag day in our monitoring systems?"},{"file":"lib/fast_server.js","line":230,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"No. That was not my plan.\n\nBecause this version of node-fast supports both artedi v1.x and artedi v2.x I did not think we needed to have a new major version. Callers themselves (on the client side: usually callers of node-moray which needs no modification here) will decide when they want to take a major version bump and move from node-arted v1 -\u003e v2. That will be a major version *for them* as they will now behave differently. For this library itself, updating to a newer node-fast will not break anything regardless of which node-artedi you\u0027re currently using. It\u0027s only when you update your node-artedi and now start passing a v2 collector in that you have caused yourself a backward incompatible change.\n\nThat was my perspective on this anyway. Let me know if you think differently. The fundamental point for me though was that if you take your existing program and update only node-fast, you won\u0027t see any difference in behavior unless you\u0027ve also upgraded node-artedi first. At which point you would have taken a major version when you did that. And to me at least it feels like a grey area what should happen if you update node-artedi to v2 without updating node-moray. And then you update node-moray later and suddenly the behavior is different (because node moray now uses a newer node-fast which is actually non-broken for artedi v2 collectors where the older node-fast will have used the default v2 fixed buckets). At this point your buckets would change from the default artedi v2 set, to the default node-fast set in this CR.\n\nI guess another option would be to call out a flag day here and say that you should only ever either update node-moray/node-fast before or at the same time as you go to node-artedi v2. Then there\u0027s never a behavior change imposed by the node-fast update itself."},{"file":"lib/fast_server.js","line":230,"reviewer":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},"message":"Right, this is fine. I mentioned this because I forgot that we\u0027re not actually using the node-artedi module here. I think the module itself is only used in the node-fast test suite."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-7},{"number":"4","revision":"8307398871dfa7c3d01ca7dbc1bfdf83d5210aa8","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/4","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1542327738,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541181529,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542038359,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-7},{"number":"5","revision":"05613a0a0c45020911d08e396dc8eeafa06b2466","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/5","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1542327779,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541181529,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542038359,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-7},{"number":"6","revision":"7933d74896548090491264e0ea335df1501d3f2b","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/6","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1542398794,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541181529,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542038359,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542398987,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-7},{"number":"7","revision":"cb09be8dc546c7fa4e66a637633003eb9ca13dc0","parents":["2aacf2d696b447eecd2353df2084436e6b47dbfe"],"ref":"refs/changes/22/5022/7","uploader":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"createdOn":1542399084,"author":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1541181529,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1542399093,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1542038359,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1542398987,"by":{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":15,"deletions":0},{"file":"lib/fast_client.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"lib/fast_server.js","type":"MODIFIED","insertions":24,"deletions":-3},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":64,"sizeDeletions":-7}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Kody A Kantor","email":"kody.kantor@joyent.com","username":"KodyKantor"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}]}