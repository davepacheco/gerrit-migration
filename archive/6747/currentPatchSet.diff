From 9058562f2f59892795e470ce25443ff636c90478 Mon Sep 17 00:00:00 2001
From: Tim Foster <tim.foster@joyent.com>
Date: Fri, 9 Aug 2019 10:30:50 +0100
Subject: [PATCH] TOOLS-2248 move download.joyent.com/pub/build/go/... builds
 to Manta TOOLS-2247 move sdcnode to manta Reviewed by: Trent Mick
 <trentm@gmail.com> Approved by: Trent Mick <trentm@gmail.com>

---
 tools/download_go                    | 19 +++++++++++-----
 tools/mk/Makefile.node_prebuilt.defs | 34 ++++++++++++++++++++++++----
 tools/mk/Makefile.node_prebuilt.targ |  2 +-
 3 files changed, 43 insertions(+), 12 deletions(-)

diff --git a/tools/download_go b/tools/download_go
index 69e9a3e..ac312b9 100755
--- a/tools/download_go
+++ b/tools/download_go
@@ -6,7 +6,7 @@
 #
 
 #
-# Copyright (c) 2018, Joyent, Inc.
+# Copyright 2019 Joyent, Inc.
 #
 
 #
@@ -42,7 +42,7 @@
 # the output file and target link will be unaffected.
 #
 
-BASEURL='https://download.joyent.com/pub/build/go/adhoc/'
+BASEURL='https://us-east.manta.joyent.com/Joyent_Dev/public/releng/go/adhoc/'
 GOVERSION=$1
 GOOS=$2
 GOARCH=$3
@@ -58,13 +58,20 @@ if [[ ! -d $OUTDIR ]]; then
 	exit 1
 fi
 
+HAS_JSON=$(command -v json)
+if [[ -z "$HAS_JSON" ]]; then
+	printf 'ERROR: "json" command not found in $PATH'
+	exit 1
+fi
+
 TARGET="go-$GOVERSION.tar.bz2"
 
 #
-# Download the index page which lists the current set of available go
-# builds:
+# Download the Manta index which lists the current set of available go
+# builds. Note that this is assumed to be a application/x-json-stream
+# with one json record per line:
 #
-if ! list=$(curl -sSfL "$BASEURL") || [[ -z "$list" ]]; then
+if ! list=$(curl -sSfL "$BASEURL" | json -ag name) || [[ -z "$list" ]]; then
 	printf 'ERROR: could not download index page\n' >&2
 	exit 1
 fi
@@ -79,7 +86,7 @@ fi
 #
 if ! name=$(/usr/bin/awk -v "v=$GOVERSION" -v "o=$GOOS" -v "a=$GOARCH" -F\" '
     BEGIN { pattern = "^go"v"."o"-"a".tar.bz2$"; }
-    $1 == "<a href=" && $2 ~ pattern { print $2 }' <<< "$list") ||
+    $1 ~ pattern { print $1 }' <<< "$list") ||
     [[ -z "$name" ]]; then
 	printf 'ERROR: could not locate file name in index page\n' >&2
 	printf '\t(Does Go version %s (%s-%s) exist?)\n' \
diff --git a/tools/mk/Makefile.node_prebuilt.defs b/tools/mk/Makefile.node_prebuilt.defs
index a1ef278..fd23fbf 100644
--- a/tools/mk/Makefile.node_prebuilt.defs
+++ b/tools/mk/Makefile.node_prebuilt.defs
@@ -69,7 +69,21 @@
 #				can either be a *local directory* or *a
 #				URL* dir (with trailing '/') which serves
 #				Apache/Nginx dir listing HTML.
-#				(default: sdcnode master build dir on stuff)
+#				(default: not set)
+#
+#	NODE_PREBUILT_MANTA_DIR
+#				Used in preference to NODE_PREBUILT_DIR,
+#				this is a http(s) URL to a Manta object,
+#				typically $(NODE_PREBUILT_BRANCH)-latest,
+#				which contains a Manta path to the build
+#				for that branch. The build expects that
+#				path to contain an 'sdcnode' subdirectory.
+#				Note that doing a curl on a Manta directory
+#				returns JSON results, with one object per
+#				line.
+#				(default: sdcnode master build dir on
+#				US-East manta for the given branch)
+#
 #
 #	NODE_PREBUILT_TAG	The 'sdcnode' project supports special
 #				configuration builds of node, e.g. say a
@@ -88,7 +102,7 @@
 #				for an sdcnode build that you want to use (potential compat
 #				issues be damned), then set this to the UUID of the sdcnode
 #				build you want. See here for available build image uuids:
-#				<https://download.joyent.com/pub/build/sdcnode/master-latest/sdcnode/>
+#				<https://us-east.manta.joyent.com/Joyent_Dev/public/releng/sdcnode>
 #
 #	BUILD			top-level directory for built binaries
 #				(default: "build")
@@ -132,9 +146,19 @@ else
 	NODE_PREBUILT_NAME := $(NODE_PREBUILT_VERSION)-$(NODE_PREBUILT_TAG)-$(NODE_PREBUILT_IMAGE)
 endif
 NODE_PREBUILT_PATTERN := sdcnode-$(NODE_PREBUILT_NAME)-$(NODE_PREBUILT_BRANCH)-.*\.tgz
-NODE_PREBUILT_DIR ?= https://download.joyent.com/pub/build/sdcnode/$(NODE_PREBUILT_IMAGE)/$(NODE_PREBUILT_BRANCH)-latest/sdcnode/
-ifeq ($(shell echo $(NODE_PREBUILT_DIR) | cut -c 1-4),http)
-	NODE_PREBUILT_BASE := $(shell curl -ksS --fail --connect-timeout 30 $(NODE_PREBUILT_DIR) | grep 'href=' | cut -d'"' -f2 | grep "^$(NODE_PREBUILT_PATTERN)$$" | sort | tail -1)
+NODE_PREBUILT_MANTA_URL ?= https://us-east.manta.joyent.com
+NODE_PREBUILT_MANTA_DIR ?= /Joyent_Dev/public/releng/sdcnode/$(NODE_PREBUILT_IMAGE)/$(NODE_PREBUILT_BRANCH)-latest
+
+# only use NODE_PREBUILT_DIR if it is set.
+ifeq ($(NODE_PREBUILT_DIR),)
+	NODE_PREBUILT_MANTA_REAL_DIR := $(shell curl -sS --fail --connect-timeout 30 $(NODE_PREBUILT_MANTA_URL)$(NODE_PREBUILT_MANTA_DIR))
+	NODE_PREBUILT_BASE := $(shell curl -sS --fail --connect-timeout 30 $(NODE_PREBUILT_MANTA_URL)$(NODE_PREBUILT_MANTA_REAL_DIR)/sdcnode | json -ag name | grep "^$(NODE_PREBUILT_PATTERN)$$" | sort | tail -1)
+	ifneq ($(NODE_PREBUILT_BASE),)
+		NODE_PREBUILT_TARBALL := $(NODE_PREBUILT_MANTA_URL)$(NODE_PREBUILT_MANTA_REAL_DIR)/sdcnode/$(NODE_PREBUILT_BASE)
+	endif
+else ifeq ($(shell echo $(NODE_PREBUILT_DIR) | cut -c 1-4),http)
+	# assume Apache/Nginx style indexing
+	NODE_PREBUILT_BASE := $(shell curl -sS --fail --connect-timeout 30 $(NODE_PREBUILT_DIR) | grep 'href=' | cut -d'"' -f2 | grep "^$(NODE_PREBUILT_PATTERN)$$" | sort | tail -1)
 	ifneq ($(NODE_PREBUILT_BASE),)
 		NODE_PREBUILT_TARBALL := $(NODE_PREBUILT_DIR)$(NODE_PREBUILT_BASE)
 	endif
diff --git a/tools/mk/Makefile.node_prebuilt.targ b/tools/mk/Makefile.node_prebuilt.targ
index 334552e..e79411d 100644
--- a/tools/mk/Makefile.node_prebuilt.targ
+++ b/tools/mk/Makefile.node_prebuilt.targ
@@ -42,7 +42,7 @@ $(NODE_EXEC) $(NPM_EXEC) $(NODE_WAF_EXEC):
 	mkdir -p $(shell dirname $(NODE_INSTALL))
 	if [[ $(shell echo $(NODE_PREBUILT_TARBALL) | cut -c 1-4) == "http" ]]; then \
 		echo "Downloading '$(NODE_PREBUILT_BASE)'."; \
-		curl -ksS --fail --connect-timeout 30 -o $(shell dirname $(NODE_INSTALL))/$(NODE_PREBUILT_BASE) $(NODE_PREBUILT_TARBALL); \
+		curl -sS --fail --connect-timeout 30 -o $(shell dirname $(NODE_INSTALL))/$(NODE_PREBUILT_BASE) $(NODE_PREBUILT_TARBALL); \
 		(cd $(shell dirname $(NODE_INSTALL)) && $(TAR) xf $(NODE_PREBUILT_BASE)); \
 	else \
 		(cd $(shell dirname $(NODE_INSTALL)) && $(TAR) xf $(NODE_PREBUILT_TARBALL)); \
-- 
2.21.0

