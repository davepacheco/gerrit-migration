commit ade4ad5f1685fb62bb0a71a1a41a3624ad36c9b7 (refs/changes/83/783/1)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2016-10-26T16:49:11+02:00 (2 years, 11 months ago)
    
    TOOLS-1581 `sdcadm post-setup common-external-nics` should update the SAPI service params.networks

diff --git a/lib/sdcadm.js b/lib/sdcadm.js
index 4e3e4e5..1cd497e 100644
--- a/lib/sdcadm.js
+++ b/lib/sdcadm.js
@@ -6127,6 +6127,34 @@ setupCommonExternalNics(opts, cb) {
         });
     }
 
+    function updateSvcParamsNetworks(name, subcb) {
+        self.sapi.listServices({name: name}, function (sapiErr, svcArr) {
+            if (sapiErr) {
+                subcb(new errors.SDCClientError(sapiErr, 'sapi'));
+                return;
+            }
+
+            if (!svcArr.length) {
+                subcb(new errors.InternalError(new Error(
+                    'Cannot find service ' + name)));
+                return;
+            }
+
+
+            self.sapi.updateService(svcArr[0].uuid, {
+                params: {
+                    networks: ['admin', 'external']
+                }
+            }, function (err) {
+                if (err) {
+                    subcb(new errors.SDCClientError(err, 'sapi'));
+                    return;
+                }
+                subcb();
+            });
+        });
+    }
+
     vasync.pipeline({ funcs: [
         function (_, next) {
             self.checkMissingExternalNics(opts, function (err, res) {
@@ -6193,7 +6221,7 @@ setupCommonExternalNics(opts, cb) {
                     return next(err);
                 }
                 progress('Added external nic to adminui');
-                next();
+                updateSvcParamsNetworks('adminui', next);
             });
         },
 
@@ -6207,7 +6235,7 @@ setupCommonExternalNics(opts, cb) {
                     return next(err);
                 }
                 progress('Added external nic to imgapi');
-                next();
+                updateSvcParamsNetworks('imgapi', next);
             });
         }
     ]}, function (err) {
diff --git a/test/post-setup.test.js b/test/post-setup.test.js
index d6cfc51..beee5be 100644
--- a/test/post-setup.test.js
+++ b/test/post-setup.test.js
@@ -429,6 +429,23 @@ test('teardown', function (t) {
         },
         inputs: vmsWithExternalNics
     }, function (resErr) {
-        t.end();
+        vasync.forEachParallel({
+            func: function updateParamsNetworks(svc, next) {
+                var command = 'echo \'{"params": {"networks": ["admin"]}}\'|' +
+                    'sapiadm update $(sdc-sapi /services?name=' + svc +
+                    '|json -Ha uuid)';
+                exec(command, function (err, stdout, stderr) {
+                    t.ifError(err, 'Execution error');
+                    t.equal(stderr, '', 'Empty stderr');
+                    next();
+                });
+
+            },
+            inputs: vmsWithExternalNics.map(function (vm) {
+                return vm.tags.smartdc_role;
+            })
+        }, function (paraRes) {
+            t.end();
+        });
     });
 });
