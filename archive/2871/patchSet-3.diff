From e88c81da1515e2542fac5d1357ffcd50323ec61a Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Fri, 27 Oct 2017 20:30:48 +0000
Subject: [PATCH] MANTA-3475 muskie should report 503 errors when moray hits
 its max queue length

---
 lib/errors.js | 15 ++++++++++++---
 lib/pg.js     |  4 +++-
 2 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/lib/errors.js b/lib/errors.js
index 93be507..fbc9e8a 100644
--- a/lib/errors.js
+++ b/lib/errors.js
@@ -214,12 +214,13 @@ function InvocationError() {
 util.inherits(InvocationError, VError);
 
 
-function NoDatabasePeersError(msg) {
+function NoDatabasePeersError(msg, cause) {
     assert.string(msg, 'msg');
-    WError.call(this, msg);
+    assert.optionalObject(cause);
+    VError.call(this, cause, msg);
     this.name = this.constructor.name;
 }
-util.inherits(NoDatabasePeersError, WError);
+util.inherits(NoDatabasePeersError, VError);
 
 
 function NotFunctionError(cause, name) {
@@ -298,6 +299,13 @@ function ObjectNotFoundError(cause, bucket, key) {
 util.inherits(ObjectNotFoundError, WError);
 
 
+function OverloadedError(msg) {
+    WError.call(this, msg);
+    this.name = this.constructor.name;
+}
+util.inherits(OverloadedError, WError);
+
+
 function QueryTimeoutError(cause, sql) {
     if (arguments.length === 1) {
         sql = cause;
@@ -360,6 +368,7 @@ module.exports = {
     NotFunctionError: NotFunctionError,
     NotIndexedError: NotIndexedError,
     NotNullableError: NotNullableError,
+    OverloadedError: OverloadedError,
     ObjectNotFoundError: ObjectNotFoundError,
     QueryTimeoutError: QueryTimeoutError,
     SchemaChangeError: SchemaChangeError,
diff --git a/lib/pg.js b/lib/pg.js
index 44c2ae6..c4115be 100644
--- a/lib/pg.js
+++ b/lib/pg.js
@@ -29,6 +29,7 @@ var ConnectTimeoutError = mod_errors.ConnectTimeoutError;
 var InternalError = mod_errors.InternalError;
 var InvalidIndexDefinitionError = mod_errors.InvalidIndexDefinitionError;
 var NoDatabasePeersError = mod_errors.NoDatabasePeersError;
+var OverloadedError = mod_errors.OverloadedError;
 var QueryTimeoutError = mod_errors.QueryTimeoutError;
 var UniqueAttributeError = mod_errors.UniqueAttributeError;
 
@@ -634,7 +635,8 @@ PGPool.prototype.checkout = function checkout(callback) {
     if (this.pool.queue.length >= this.maxQueueLength) {
         setImmediate(callback, new NoDatabasePeersError(
             'unable to acquire backend connection due to ' +
-            'service being overloaded'));
+            'service being overloaded', new OverloadedError(
+                'maximum moray queue length reached')));
         return;
     }
 
-- 
2.21.0

