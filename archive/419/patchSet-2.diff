From 31bcc64baa73db63ba5becc973acf6371b7aaf4d Mon Sep 17 00:00:00 2001
From: Robert Mustacchi <rm@joyent.com>
Date: Sun, 28 Aug 2016 19:19:16 +0000
Subject: [PATCH] OS-5652 platform build needs to work with python 2.7 OS-5651
 better handle the lack of signed package support OS-5653 tools/sorter should
 work with python2/3

---
 configure    |  5 +++--
 tools/sorter | 27 ++++++++++++++++++++-------
 2 files changed, 23 insertions(+), 9 deletions(-)

diff --git a/configure b/configure
index ffed9f51..578ee757 100755
--- a/configure
+++ b/configure
@@ -91,7 +91,7 @@ function install_pkgin
 	fi
 
 	pkglist="$pkglist flex libxslt openjdk7 nodejs"
-	pkglist="$pkglist p5-XML-Parser gettext python26 py26-expat"
+	pkglist="$pkglist p5-XML-Parser gettext python27 py27-expat"
 	pkglist="$pkglist coreutils gsed pkg_alternatives cdrtools"
 
 	for pkg in $pkglist; do
@@ -109,7 +109,7 @@ function install_pkgin
 			curl -k "$conf_pkgsrcurl/$pkg.tgz" -o \
 			    /var/tmp/$pkg.tgz || fatal \
 			    "failed to fetch $pkg.tgz"
-			$conf_priv pkg_add /var/tmp/$pkg.tgz || fatal \
+			$conf_priv pkg_add -C /dev/null /var/tmp/$pkg.tgz || fatal \
 			    "failed to pkg_add $pkg"
 			rm -f /var/tmp/$pkg.tgz
 		fi
@@ -302,6 +302,7 @@ JAVA_ROOT=/opt/local/java/openjdk7;		export JAVA_ROOT
 FLEX=/opt/local/bin/flex;			export FLEX
 GNUXGETTEXT=/opt/local/bin/xgettext;		export GNUXGETTEXT
 PYTHON_26=/opt/local/bin/python2.6;		export PYTHON_26
+PYTHON_27=/opt/local/bin/python2.7;		export PYTHON_27
 ELFDUMP=/usr/bin/elfdump;			export ELFDUMP
 LORDER=/usr/bin/lorder;				export LORDER
 MCS=/usr/bin/mcs;				export MCS
diff --git a/tools/sorter b/tools/sorter
index 7f620b17..fee239e3 100755
--- a/tools/sorter
+++ b/tools/sorter
@@ -1,28 +1,41 @@
-#! /usr/bin/env python2.6
+#! /usr/bin/env python
 # vi: expandtab ts=4 sw=4
 #
-# Takes a 'manifest' style file and outputs a sorted version, warning about
-# any duplicates.
+# Takes a 'manifest' style file and outputs a sorted version. It will emit
+# "ERROR: ..." on stderr and exit non-zero if there are any duplicates or
+# bogus lines.
+#
+# Usage:
+#   <manifest content on stdin> | ./tools/sorter
+#
+# Dev Note: This should work with any Python >= 2.6 (including Python 3).
 #
 
 import os
 import sys
 
+nErrors = 0
 files = {}
 
 for line in sys.stdin.readlines():
     line = line.strip()
     if len(line) == 0 or line[0] == '#':
         continue
-    fields = line.split(' ')
+    fields = line.split()
     if len(fields) < 2:
-        sys.stderr.write("WARNING: unexpected manifest line: '%s' (removing)\n" % line)
+        sys.stderr.write(
+            "ERROR: unexpected manifest line: '%s' (removing)\n" % line)
+        nErrors +=1
         continue
     if fields[1] in files and not (
             # Don't warn about same directory with identical properties.
             fields[0] == 'd' and files[fields[1]] == line):
-        sys.stderr.write("WARNING: duplicate entry for '%s'\n" % fields[1])
+        sys.stderr.write(
+            "WARNING: duplicate manifest entry for '%s'\n" % fields[1])
     files[fields[1]] = line
 
 for key in sorted(files):
-    print files[key].rstrip(' ')
+    print(files[key].rstrip())
+
+if nErrors > 0:
+    sys.exit(1)
-- 
2.21.0

