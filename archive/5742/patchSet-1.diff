From 981319557d5781afcf09f3dec77218b0c8f849ce Mon Sep 17 00:00:00 2001
From: Jon Anderson <jon.anderson@joyent.com>
Date: Fri, 8 Mar 2019 08:23:24 -0500
Subject: [PATCH] MANTA-4150 Muppet test case writeHaproxyConfig fails on
 SmartOS

---
 package.json        |  6 ++++--
 test/config.test.js | 30 +++++++++++++++++++-----------
 2 files changed, 23 insertions(+), 13 deletions(-)

diff --git a/package.json b/package.json
index a9b24e3..37c84d2 100644
--- a/package.json
+++ b/package.json
@@ -10,8 +10,9 @@
         "bunyan": "2.0.2",
         "dashdash": "1.14.1",
         "forkexec": "1.1.0",
+        "haproxy-stat": "0.1.0",
+        "joyent-grr": "^1.6.0",
         "jsprim": "1.4.0",
-        "haproxy-stat" : "0.1.0",
         "node-uuid": "1.4.1",
         "once": "1.4.0",
         "vasync": "2.2.0",
@@ -19,7 +20,8 @@
         "zkstream": "0.11.3"
     },
     "devDependencies": {
-        "nodeunit": "0.11.2"
+        "nodeunit": "0.11.2",
+        "diff": "4.0.1"
     },
     "scripts": {
         "start": "node ./muppet.js"
diff --git a/test/config.test.js b/test/config.test.js
index 0f0aba7..6d50618 100644
--- a/test/config.test.js
+++ b/test/config.test.js
@@ -7,13 +7,12 @@
 /*
  * Copyright (c) 2017, Joyent, Inc.
  */
-
 var vasync = require('vasync');
-var execFile = require('child_process').execFile;
 var helper = require('./helper.js');
 var lbm = require('../lib/lb_manager.js');
 var path = require('path');
 var fs = require('fs');
+var jsdiff = require('diff');
 
 ///--- Globals
 var test = helper.test;
@@ -110,15 +109,24 @@ test('test writeHaproxyConfig', function (t) {
     };
     lbm.writeHaproxyConfig(opts, function (err, data) {
         t.equal(null, err);
-        // compare output file with reference
-        execFile('diff', ['-wq', '-I', 'log-send-hostname',
-                          updConfig_out, updConfig_out_chk],
-            function (error, _stdout, _stderr) {
-                t.equal(null, error);
-                // cleanup test file
-                fs.unlinkSync(updConfig_out);
-                t.done();
-            });
+        var test_txt = fs.readFileSync(updConfig_out, 'utf8');
+        var check_txt = fs.readFileSync(updConfig_out_chk, 'utf8');
+
+        var diff = jsdiff.diffTrimmedLines(test_txt, check_txt);
+
+        diff.forEach(function (part) {
+            if (part.added) {
+                if (! part.value.includes('log-send-hostname')) {
+                    t.equal(null, part.value);
+                }
+            } else if (part.removed) {
+                if (! part.value.includes('log-send-hostname')) {
+                    t.equal(null, part.value);
+                }
+            }
+        });
+        fs.unlinkSync(updConfig_out);
+        t.done();
     });
 });
 
-- 
2.21.0

