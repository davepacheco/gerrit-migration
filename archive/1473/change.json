{"project":"joyent/node-triton","branch":"master","id":"I3dd59ab1097923aa3dd6cfec661d7901c0830801","number":"1473","subject":"joyent/node-triton#129 `triton reboot --wait INST` doesn\u0027t wait Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"url":"https://cr.joyent.us/1473","commitMessage":"joyent/node-triton#129 `triton reboot --wait INST` doesn\u0027t wait\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1486595921,"lastUpdated":1486760901,"open":false,"status":"MERGED","comments":[{"timestamp":1486595921,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 1."},{"timestamp":1486595922,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 7374703e3130088ad630260710f16993ffd5c488\n    \n    a stab at this"},{"timestamp":1486595950,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486596888,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 2."},{"timestamp":1486596889,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 11db66168434ebe900cb4b611102d9881e1d338f\n    \n    fix a but with a short audit log; changelog"},{"timestamp":1486596924,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 1:\n\nAlternative proposal to https://cr.joyent.us/#/c/880"},{"timestamp":1486596925,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486597730,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\nTesting notes: The test suite passed for me (running on Mac, node v4):\n\n```\n$ make test-in-parallel\nNODE_NDEBUG\u003d prove -j15 -e ./node_modules/.bin/tape \\\n\t\ttest/unit/*.test.js test/integration/*.test.js\ntest/unit/common.test.js ...................... ok\ntest/unit/metadataFromOpts.test.js ............ ok\ntest/unit/tagsFromCreateOpts.test.js .......... ok\ntest/unit/tagsFromSetArgs.test.js ............. ok\n\u003d\u003d\u003d(     134;1  1/?  1/?  1/?  1/?  0/?  0/?  0/?  0/?  0/?  0/?... )\u003d\u003d\u003d** skipping /Users/trentm/joy/node-triton/test/integration/cli-rbac.test.js tests\n** set \"allowRbacDestructiveTesting\" in test config to enable\ntest/integration/cli-rbac.test.js ............. skipped: (no reason given)\ntest/integration/api-instances.test.js ........ ok\ntest/integration/api-packages.test.js ......... ok\ntest/integration/api-networks.test.js ......... ok\ntest/integration/cli-basics.test.js ........... ok\ntest/integration/cli-profiles.test.js ......... ok\ntest/integration/api-images.test.js ........... ok\ntest/integration/cli-keys.test.js ............. ok\ntest/integration/cli-account.test.js .......... ok\ntest/integration/cli-networks.test.js ......... ok\ntest/integration/cli-subcommands.test.js ...... ok\ntest/integration/cli-fwrules.test.js .......... ok\ntest/integration/cli-snapshots.test.js ........ ok\ntest/integration/cli-manage-workflow.test.js .. ok\ntest/integration/cli-instance-tag.test.js ..... ok\ntest/integration/cli-image-create.test.js ..... ok\ntest/integration/cli-affinity.test.js ......... ok\nAll tests successful.\nFiles\u003d21, Tests\u003d1155, 513 wallclock secs ( 0.40 usr  0.11 sys + 177.13 cusr 18.00 csys \u003d 195.64 CPU)\nResult: PASS\n```"},{"timestamp":1486598812,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(6 comments)\n\nSide question: how do you handle versioning for node-triton? Do you update package.version only when it\u0027s time for a release, and look at the \"not yet released\" section of the changelog to determine how to bump the version number?"},{"timestamp":1486598862,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2: Code-Review+1\n\nAll my comments are mostly nits, I wouldn\u0027t mind if this was merged as is."},{"timestamp":1486600038,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(6 comments)"},{"timestamp":1486600363,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 2:\n\n(4 comments)"},{"timestamp":1486601341,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Uploaded patch set 3."},{"timestamp":1486601342,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit ce6bd6bcbf484dbf6337af4252875d290b5f7a91\n    \n    process.hrtime; assert for programming error; cb(err) for operational error"},{"timestamp":1486601347,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1486601375,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1486601449,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1486601608,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1486601632,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1486760901,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Trent Mick"}],"currentPatchSet":{"number":"3","revision":"3dd59ab1097923aa3dd6cfec661d7901c0830801","parents":["1503088abd917f40368d5d80ce1c1e2c83ea5a96"],"ref":"refs/changes/73/1473/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1486601341,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486601375,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486601608,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486601632,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1486760901,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/do_instance/do_reboot.js","type":"MODIFIED","insertions":90,"deletions":-3},{"file":"lib/do_instance/gen_do_ACTION.js","type":"MODIFIED","insertions":1,"deletions":-6},{"file":"lib/errors.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":149,"deletions":-1},{"file":"test/integration/cli-manage-workflow.test.js","type":"MODIFIED","insertions":19,"deletions":-1}],"sizeInsertions":271,"sizeDeletions":-14},"patchSets":[{"number":"1","revision":"2d68e586f633376a2c514bd8daebe55eb4504a39","parents":["1503088abd917f40368d5d80ce1c1e2c83ea5a96"],"ref":"refs/changes/73/1473/1","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1486595921,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486595950,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/do_instance/do_reboot.js","type":"MODIFIED","insertions":90,"deletions":-3},{"file":"lib/do_instance/gen_do_ACTION.js","type":"MODIFIED","insertions":1,"deletions":-6},{"file":"lib/errors.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":132,"deletions":-1},{"file":"test/integration/cli-manage-workflow.test.js","type":"MODIFIED","insertions":19,"deletions":-1}],"sizeInsertions":249,"sizeDeletions":-14},{"number":"2","revision":"13c2a4158791492779c762b7553d717e90bb5464","parents":["1503088abd917f40368d5d80ce1c1e2c83ea5a96"],"ref":"refs/changes/73/1473/2","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1486596888,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486596925,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486598862,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"comments":[{"file":"lib/do_instance/do_reboot.js","line":57,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"It seems that \"err\" can never be !\u003d\u003d undefined. Is that conditional here for future proofing?"},{"file":"lib/do_instance/do_reboot.js","line":57,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yah, fair. I could change that to assert no `err`."},{"file":"lib/tritonapi.js","line":2328,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Isn\u0027t the poll interval between 1s and 3s with the call to \"setTimeout(pollMachineAudit, (POLL_INTERVAL / 2) + randrange(0, POLL_INTERVAL))\"?"},{"file":"lib/tritonapi.js","line":2328,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"That\u0027s just the first poll. After that it is stead at 2s."},{"file":"lib/tritonapi.js","line":2328,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Right, I was a bit confused by the multiple setTimeout at first, sounds good!"},{"file":"lib/tritonapi.js","line":2333,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should we use a monotonic clock (using process.hrtime) instead of wall clock time to prevent issues with clock drift?"},{"file":"lib/tritonapi.js","line":2333,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Wow, yes, I guess. Is that for time jumping fwd/bwd for daylight savings or leap seconds, you mean?"},{"file":"lib/tritonapi.js","line":2333,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Correct, also ntp changes, etc."},{"file":"lib/tritonapi.js","line":2335,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should that really be throwing, that is considered to be a programming error, or an operational error? I would lean towards the later."},{"file":"lib/tritonapi.js","line":2335,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Sure."},{"file":"lib/tritonapi.js","line":2335,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Example:\n\n```\n$ triton reboot -w tmp3 2\u003e \u003e(bunyan)\nRebooting instance tmp3\nError rebooting instance tmp3: cannot wait for reboot: CloudAPI RebootMachine response did not include a \"Date\" header (req cab91404-5f9e-4f88-80d5-e40eba66ab75)\ntriton instance reboot: error (InternalError): cannot wait for reboot: CloudAPI RebootMachine response did not include a \"Date\" header (req cab91404-5f9e-4f88-80d5-e40eba66ab75)\n```"},{"file":"lib/tritonapi.js","line":2342,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Thinking out loud, should one or more retry(ies) be performed in case of an error response from the machine audit endpoint?"},{"file":"lib/tritonapi.js","line":2342,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"My understanding is that we already get the retries from the default restify-clients retry options for the cloudapi client:\n\nhttps://github.com/restify/clients/blob/master/lib/HttpClient.js#L59-L77"},{"file":"lib/tritonapi.js","line":2342,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"I was more thinking about: what if the machine endpoint is down for e.g 1 minute? It\u0027s really minor though. As I said, it was more thinking out loud."},{"file":"lib/tritonapi.js","line":2342,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"Yah, that\u0027s fair. I don\u0027t want to cope with that case at this point.  There are other things too like coping with rate limiting, e.g. if we try to reboot 100 instances at once, currently we poll once per 2s for each of those. That\u0027ll likely hit cloudapi rate limiting... and surprise the triton CLI."},{"file":"lib/tritonapi.js","line":2391,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"What\u0027s the second \"null\" argument to \"cb\"?"},{"file":"lib/tritonapi.js","line":2391,"reviewer":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"message":"https://github.com/joyent/node-triton/blob/1503088abd917f40368d5d80ce1c1e2c83ea5a96/lib/tritonapi.js#L85-L107"},{"file":"lib/tritonapi.js","line":2391,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Sounds good, and sorry for being lazy and not looking this up myself!"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/do_instance/do_reboot.js","type":"MODIFIED","insertions":90,"deletions":-3},{"file":"lib/do_instance/gen_do_ACTION.js","type":"MODIFIED","insertions":1,"deletions":-6},{"file":"lib/errors.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":132,"deletions":-1},{"file":"test/integration/cli-manage-workflow.test.js","type":"MODIFIED","insertions":19,"deletions":-1}],"sizeInsertions":254,"sizeDeletions":-14},{"number":"3","revision":"3dd59ab1097923aa3dd6cfec661d7901c0830801","parents":["1503088abd917f40368d5d80ce1c1e2c83ea5a96"],"ref":"refs/changes/73/1473/3","uploader":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"createdOn":1486601341,"author":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486601375,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1486760901,"by":{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1486601608,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1486601632,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/do_instance/do_reboot.js","type":"MODIFIED","insertions":90,"deletions":-3},{"file":"lib/do_instance/gen_do_ACTION.js","type":"MODIFIED","insertions":1,"deletions":-6},{"file":"lib/errors.js","type":"MODIFIED","insertions":7,"deletions":-3},{"file":"lib/tritonapi.js","type":"MODIFIED","insertions":149,"deletions":-1},{"file":"test/integration/cli-manage-workflow.test.js","type":"MODIFIED","insertions":19,"deletions":-1}],"sizeInsertions":271,"sizeDeletions":-14}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Trent Mick","email":"trentm@gmail.com","username":"trentm"}]}