From 45b426be8c3fcc1c0af37631b1f1eda997e7ffe6 Mon Sep 17 00:00:00 2001
From: Russell Brown <russell.brown@joyent.com>
Date: Fri, 10 May 2019 14:05:25 +0100
Subject: [PATCH] MANTA-3525 Muppet should handle haproxy config changes
 without restarting haproxy

---
 .gitmodules                    | 8 ++++----
 README.md                      | 6 +++---
 deps/haproxy-1.5               | 1 -
 deps/haproxy-1.8               | 1 +
 etc/haproxy.cfg.default        | 2 +-
 etc/haproxy.cfg.in             | 2 +-
 lib/lb_manager.js              | 2 +-
 smf/manifests/haproxy.xml.in   | 4 +++-
 tools/mk/Makefile.haproxy.defs | 2 +-
 9 files changed, 15 insertions(+), 13 deletions(-)
 delete mode 160000 deps/haproxy-1.5
 create mode 160000 deps/haproxy-1.8

diff --git a/.gitmodules b/.gitmodules
index 61d8a53..198ac31 100644
--- a/.gitmodules
+++ b/.gitmodules
@@ -10,10 +10,10 @@
 [submodule "deps/manta-scripts"]
 	path = deps/manta-scripts
 	url = https://github.com/joyent/manta-scripts.git
-[submodule "deps/haproxy-1.5"]
-	path = deps/haproxy-1.5
-	url = https://github.com/joyent/haproxy-1.5.git
-	branch = joyent/v1.5.19
+[submodule "deps/haproxy-1.8"]
+	path = deps/haproxy-1.8
+	url = https://github.com/joyent/haproxy-1.8.git
+	branch = joyent/dev-v1.8.8
 [submodule "deps/eng"]
 	path = deps/eng
 	url = https://github.com/joyent/eng.git
diff --git a/README.md b/README.md
index e31fb65..50d5c7f 100644
--- a/README.md
+++ b/README.md
@@ -5,7 +5,7 @@
 -->
 
 <!--
-    Copyright (c) 2014, Joyent, Inc.
+    Copyright (c) 2019, Joyent, Inc.
 -->
 
 # muppet
@@ -34,9 +34,9 @@ pkgsrc:
 - haproxy
 
 Though the version of haproxy might differ from the running `loadbalancer` zone,
-it is simply used to check that haproxy can properly parse the resulting
+it is used to check that haproxy can properly parse the resulting
 `haproxy.cfg` files generated in the tests.
 
 ## Running the Tests
 
-Then to run the tests, simply run `make test`
+Then to run the tests, run `make test`
diff --git a/deps/haproxy-1.5 b/deps/haproxy-1.5
deleted file mode 160000
index 836df3b..0000000
--- a/deps/haproxy-1.5
+++ /dev/null
@@ -1 +0,0 @@
-Subproject commit 836df3bc832e572c42e2618fcb1a10a81d63df3c
diff --git a/deps/haproxy-1.8 b/deps/haproxy-1.8
new file mode 160000
index 0000000..7c46751
--- /dev/null
+++ b/deps/haproxy-1.8
@@ -0,0 +1 @@
+Subproject commit 7c46751ac9ccc41610c35680bf4bd541981fb1aa
diff --git a/etc/haproxy.cfg.default b/etc/haproxy.cfg.default
index 531309a..a2840e2 100644
--- a/etc/haproxy.cfg.default
+++ b/etc/haproxy.cfg.default
@@ -5,7 +5,7 @@ global
         daemon
         maxconn 65535
         pidfile /var/run/haproxy.pid
-        stats socket /tmp/haproxy mode 0600 level admin
+        stats socket /tmp/haproxy mode 0600 level admin expose-fd listeners
 
 defaults
         balance leastconn
diff --git a/etc/haproxy.cfg.in b/etc/haproxy.cfg.in
index 879c30f..d65ff08 100644
--- a/etc/haproxy.cfg.in
+++ b/etc/haproxy.cfg.in
@@ -6,7 +6,7 @@ global
         maxconn 65535
         pidfile /var/run/haproxy.pid
         log-send-hostname %s
-        stats socket /tmp/haproxy mode 0600 level admin
+        stats socket /tmp/haproxy mode 0600 level admin expose-fd listeners
 
 
 defaults
diff --git a/lib/lb_manager.js b/lib/lb_manager.js
index f3f855b..4ceae7d 100644
--- a/lib/lb_manager.js
+++ b/lib/lb_manager.js
@@ -33,7 +33,7 @@ const CFG_FILE = path.resolve(__dirname, '../etc/haproxy.cfg');
 const CFG_FILE_TMP = path.resolve(__dirname, '../etc/haproxy.cfg.tmp');
 const CFG_IN = fs.readFileSync(path.resolve(__dirname, '../etc/haproxy.cfg.in'),
                              'utf8');
-const RESTART = '/usr/sbin/svcadm restart haproxy';
+const RESTART = '/usr/sbin/svcadm refresh haproxy';
 /* JSSTYLED */
 const CLEAR_SERVER_LINE = '        server be%d %s:81 check inter 30s slowstart 10s\n';
 /* JSSTYLED */
diff --git a/smf/manifests/haproxy.xml.in b/smf/manifests/haproxy.xml.in
index 7a98423..be3f33f 100644
--- a/smf/manifests/haproxy.xml.in
+++ b/smf/manifests/haproxy.xml.in
@@ -39,7 +39,7 @@
 
 	<exec_method type="method"
 		     name="start"
-		     exec="/opt/smartdc/muppet/build/haproxy/sbin/haproxy -f /opt/smartdc/muppet/etc/haproxy.cfg -D"
+		     exec="/opt/smartdc/muppet/build/haproxy/sbin/haproxy -W -f /opt/smartdc/muppet/etc/haproxy.cfg -D"
 		     timeout_seconds="30">
 	    <method_context working_directory="/opt/smartdc/muppet">
 		<method_environment>
@@ -51,6 +51,8 @@
 	    </method_context>
 	</exec_method>
 
+        <exec_method name='refresh' type='method' exec='/usr/bin/pkill -USR2 -z $(zonename) -u root haproxy' timeout_seconds='30'/>
+
 	<exec_method type="method"
 		     name="stop"
 		     exec=":kill"
diff --git a/tools/mk/Makefile.haproxy.defs b/tools/mk/Makefile.haproxy.defs
index 83a2dfb..5b4c3ad 100644
--- a/tools/mk/Makefile.haproxy.defs
+++ b/tools/mk/Makefile.haproxy.defs
@@ -20,7 +20,7 @@ HAPROXY_INSTALL ?= $(BUILD)/haproxy
 DISTCLEAN_FILES	+= $(HAPROXY_INSTALL)
 
 HAPROXY_EXEC	= $(HAPROXY_INSTALL)/sbin/haproxy
-HAPROXY_SRC	:= deps/haproxy-1.5
+HAPROXY_SRC	:= deps/haproxy-1.8
 
 # Ensure these use absolute paths to the executables to allow running
 # from a dir other than the project top.
-- 
2.21.0

