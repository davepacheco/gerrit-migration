{"project":"joyent/manta-mola","branch":"master","id":"I276695f6ada287f17348dd92059df15396015d91","number":"1447","subject":"MANTA-3085 gc_create_links must limit concurrent operations Reviewed by: David Pacheco \u003cdap@joyent.com\u003e Approved by: David Pacheco \u003cdap@joyent.com\u003e","owner":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"url":"https://cr.joyent.us/1447","commitMessage":"MANTA-3085 gc_create_links must limit concurrent operations\nReviewed by: David Pacheco \u003cdap@joyent.com\u003e\nApproved by: David Pacheco \u003cdap@joyent.com\u003e\n","createdOn":1486427174,"lastUpdated":1488235231,"open":false,"status":"MERGED","comments":[{"timestamp":1486427174,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 1."},{"timestamp":1486427206,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487293713,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 2."},{"timestamp":1487293739,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487575944,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 3."},{"timestamp":1487575970,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1487977844,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 4: Patch Set 3 was rebased."},{"timestamp":1487977875,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4:\n\n\"make check\" passed ok"},{"timestamp":1488213231,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1488214071,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1\n\nAh, I found maxsockets.js in change 1436.  I assume this change depends on that one."},{"timestamp":1488232359,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 4:\n\n(2 comments)"},{"timestamp":1488234668,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1488235223,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"Patch Set 6: Patch Set 5 was rebased"},{"timestamp":1488235231,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Joshua M. Clulow"}],"currentPatchSet":{"number":"6","revision":"05b37633e587e37220a9e703aeafe6506379d30d","parents":["492c32366708cfab9a8325b3a0036987bdbf7c09"],"ref":"refs/changes/47/1447/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1488235223,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487575970,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1488235231,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":151,"deletions":-69}],"sizeInsertions":151,"sizeDeletions":-69},"patchSets":[{"number":"1","revision":"bc5bd1dcdc17d6c07abdb3594c5da4e76736ce1e","parents":["37ab548b31b96d526e9af54db5050cfaed5d7dcc"],"ref":"refs/changes/47/1447/1","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1486427174,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1486427206,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":4,"deletions":-4}],"sizeInsertions":4,"sizeDeletions":-4},{"number":"2","revision":"e1bf6017094f90818ac727ae7aad8c1b95a5cd9a","parents":["74b2123ad7de5c3f42274f7bcaa663ad2e61b128"],"ref":"refs/changes/47/1447/2","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1487293713,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487293739,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":144,"deletions":-69}],"sizeInsertions":144,"sizeDeletions":-69},{"number":"3","revision":"eae4ecffdb859ec042f739fc0e50ea1e99972382","parents":["8a30c6451bcf4bb2f1960c84819ab56665021ad2"],"ref":"refs/changes/47/1447/3","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1487575944,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487575970,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":151,"deletions":-69}],"sizeInsertions":151,"sizeDeletions":-69},{"number":"4","revision":"aae3c8d8274b0acda7cdbe9bb596c554540f65f7","parents":["e5b406312e5d04f7824914eb10a8ae0f17a09af8"],"ref":"refs/changes/47/1447/4","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1487977844,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487575970,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"bin/gc_create_links.js","line":0,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"As I understand it, we used to process the input objects with unbounded parallelism, and within each object, we processed all the \"mkdir\" operations with unbounded parallelism, and then all the \"mln\" operations with unbounded parallelism.   Now, we still process the input objects with unbounded parallelism, but within each object, we process the instructions sequentially, and we bail out after the first error.  Is that right?"},{"file":"bin/gc_create_links.js","line":0,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"That is correct.  Assuming this job runs correctly each day, the number of input objects is generally the same as the number of metadata shards plus one.  This count is determined by the GC job itself:\n\nhttps://github.com/joyent/manta-mola/blob/master/bin/kick_off_gc.js#L202-L205"},{"file":"bin/gc_create_links.js","line":18,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Is this file supposed to be part of this change?  I can\u0027t find it in the change or in the current manta-mola repository.  (Sorry if I\u0027ve missed where this comes from.)"},{"file":"bin/gc_create_links.js","line":18,"reviewer":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"message":"As you note, this change depends on another one which introduces this file."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":151,"deletions":-69}],"sizeInsertions":151,"sizeDeletions":-69},{"number":"5","revision":"276695f6ada287f17348dd92059df15396015d91","parents":["e5b406312e5d04f7824914eb10a8ae0f17a09af8"],"ref":"refs/changes/47/1447/5","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1488234668,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487575970,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":151,"deletions":-69}],"sizeInsertions":151,"sizeDeletions":-69},{"number":"6","revision":"05b37633e587e37220a9e703aeafe6506379d30d","parents":["492c32366708cfab9a8325b3a0036987bdbf7c09"],"ref":"refs/changes/47/1447/6","uploader":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"createdOn":1488235223,"author":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"},"isDraft":false,"kind":"NO_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1488214071,"by":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"}},{"type":"SUBM","value":"1","grantedOn":1488235231,"by":{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1487575970,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"bin/gc_create_links.js","type":"MODIFIED","insertions":151,"deletions":-69}],"sizeInsertions":151,"sizeDeletions":-69}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Joshua M. Clulow","email":"jmc@joyent.com","username":"jclulow"}]}