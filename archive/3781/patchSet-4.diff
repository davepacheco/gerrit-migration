commit cbe1d4ec7d9020722932a6abf4187e568abd061b (refs/changes/81/3781/4)
Author: dyep49 <dyep49@gmail.com>
Date:   2018-04-12T15:52:32-07:00 (1 year, 6 months ago)
    
    WORKFLOW-222 artedi metrics for job times

diff --git a/docs/index.md b/docs/index.md
index 87b5200..959dc53 100644
--- a/docs/index.md
+++ b/docs/index.md
@@ -334,3 +334,7 @@ For example:
           "name": "provision-7.0.2",
           "execution": "succeeded"
         }
+
+## Metrics
+
+Workflow exposes metrics via [node-triton-metrics](https://github.com/joyent/node-triton-metrics). wf-runner metrics are exposed  on `http://<ADMIN_IP>:8881/metrics` and wf-api metrics are exposed on 'http://<ADMIN_IP>:8882/metrics`.
diff --git a/package.json b/package.json
index 48e9f96..168e655 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "workflow",
   "description": "SmartDataCenter Workflow API and Runners",
-  "version": "1.2.2",
+  "version": "1.3.0",
   "author": "Joyent (joyent.com)",
   "private": true,
   "repository": {
@@ -9,18 +9,18 @@
     "url": "git+https://github.com/joyent/sdc-workflow.git"
   },
   "dependencies": {
-    "wf-moray-backend": "git+https://github.com/joyent/node-workflow-moray-backend.git#82c49db9",
-    "wf": "git+https://github.com/joyent/node-workflow.git#aac927e4",
+    "async": "0.1.22",
     "bunyan": "1.8.1",
     "effluent-logger": "git+https://github.com/joshwilsdon/effluent-logger.git#d662f161a07f94045ad2afb45442931511c40e51",
+    "imgmanifest": "git+https://github.com/joyent/node-imgmanifest.git#e21ea53",
+    "lstream": "0.0.4",
     "restify": "4.1.1",
+    "sdc-clients": "10.5.0",
     "uuid": "3.0.1",
-    "async": "0.1.22",
     "vasync": "1.6.4",
-    "sdc-clients": "10.5.0",
     "verror": "1.6.0",
-    "imgmanifest": "git+https://github.com/joyent/node-imgmanifest.git#e21ea53",
-    "lstream": "0.0.4"
+    "wf": "1.2.0",
+    "wf-moray-backend": "1.2.0"
   },
   "devDependencies": {
     "tap": "~0.3"
diff --git a/sapi_manifests/workflow/template b/sapi_manifests/workflow/template
index 4a6d36c..d0f2857 100644
--- a/sapi_manifests/workflow/template
+++ b/sapi_manifests/workflow/template
@@ -1,4 +1,9 @@
 {
+    "datacenterName": "{{{datacenter_name}}}",
+    "serviceName": "{{SERVICE_NAME}}",
+    "instanceUuid": "{{auto.ZONENAME}}",
+    "serverUuid": "{{auto.SERVER_UUID}}",
+    "adminIp": "{{auto.ADMIN_IP}}",
     "backend": {
         "module": "wf-moray-backend",
         "opts": {
diff --git a/wf-api.js b/wf-api.js
index c72d5d8..0ff52fd 100644
--- a/wf-api.js
+++ b/wf-api.js
@@ -65,6 +65,14 @@ fs.readFile(config_file, 'utf8', function (err, data) {
             }]
         };
 
+        config.metrics = {
+            datacenterName: config.datacenterName,
+            serviceName: config.serviceName,
+            instanceUuid: config.instanceUuid,
+            serverUuid: config.serverUuid,
+            adminIp: config.adminIp
+        };
+
         api = wf.API(config);
         log = api.log;
 
diff --git a/wf-runner.js b/wf-runner.js
index 7b7f0fb..020f5bf 100644
--- a/wf-runner.js
+++ b/wf-runner.js
@@ -66,6 +66,14 @@ fs.readFile(config_file, 'utf8', function (err, data) {
             }]
         };
 
+        config.metrics = {
+            datacenterName: config.datacenterName,
+            serviceName: config.serviceName,
+            instanceUuid: config.instanceUuid,
+            serverUuid: config.serverUuid,
+            adminIp: config.adminIp
+        };
+
         MAX_RETRIES = config.maxInitRetries || 10;
 
         // Poll less frequently in COAL:
