From fff9eefe3b76ac86e4684670c8d8267e3b2e401c Mon Sep 17 00:00:00 2001
From: Todd Whiteman <todd.whiteman@joyent.com>
Date: Thu, 2 Mar 2017 15:25:53 -0800
Subject: [PATCH] IMGAPI-619 add better error handling for
 _dockerDownloadAndImportImage

---
 lib/images.js  | 17 ++++++++++++-----
 lib/storage.js |  9 ++++++---
 2 files changed, 18 insertions(+), 8 deletions(-)

diff --git a/lib/images.js b/lib/images.js
index 086d972..691a7f5 100644
--- a/lib/images.js
+++ b/lib/images.js
@@ -2448,7 +2448,7 @@ function _dockerDownloadAndImportImage(opts, callback) {
     var manifest;
     var newImage;
 
-    log.debug({uuid: uuid},
+    log.debug({imgId: imgId, uuid: uuid},
         'AdminImportDockerImage: check if image already exists');
     Image.get(app, uuid, log, function (gErr, image) {
         if (!gErr) {
@@ -2703,7 +2703,12 @@ function _dockerDownloadAndImportImage(opts, callback) {
                 // Give a short respite and then go again.
                 setTimeout(function () {
                     if (ctx.downloadsCanceled) {
-                        next(new errors.DownloadError('Download canceled'));
+                        log.info({err: rErr, imgId: imgId, fileSize: fileSize,
+                            addImageFileAttempts: addImageFileAttempts},
+                            'dockerDownloadAndImportImage: not retrying, ' +
+                            'download already canceled');
+                        next(new errors.DownloadError(rErr,
+                            'Download canceled'));
                         return;
                     }
                     log.info({imgId: imgId, fileSize: fileSize,
@@ -2731,7 +2736,7 @@ function _dockerDownloadAndImportImage(opts, callback) {
                         retryAddImageFile(fErr);
                         return;
                     }
-                    log.info({imgId: imgId, err: err},
+                    log.info({imgId: imgId, err: fErr},
                         'dockerDownloadAndImportImage: ' +
                         'not retrying on this error');
                     return next(fErr);
@@ -2830,10 +2835,12 @@ function _dockerDownloadAndImportImage(opts, callback) {
                 image: newImage,
                 stream: stream,
                 reqId: stream.id(),
-                filename: 'file0'
+                filename: 'file0',
+                noStreamErrorHandler: true
             }, function (sErr, tmpFilename, filename) {
                 if (sErr) {
-                    req.log.error(sErr, 'error storing image file');
+                    log.error({err: sErr, imgId: imgId},
+                        'error storing image file');
                     finish(errors.parseErrorFromStorage(
                         sErr, 'error receiving image file'));
                 } else {
diff --git a/lib/storage.js b/lib/storage.js
index 09b17dd..e41e308 100644
--- a/lib/storage.js
+++ b/lib/storage.js
@@ -294,6 +294,7 @@ LocalStorage.prototype.storeFileFromStream =
     assert.string(opts.filename, 'opts.filename');
     assert.optionalNumber(opts.size, 'opts.size');
     assert.optionalString(opts.contentMD5, 'opts.contentMD5');
+    assert.optionalBool(opts.noStreamErrorHandler, 'opts.noStreamErrorHandler');
     assert.func(callback, 'callback');
     var callbackOnce = once(callback);
 
@@ -315,9 +316,11 @@ LocalStorage.prototype.storeFileFromStream =
             return;
         }
 
-        opts.stream.on('error', function (err) {
-            onFileWriteStream(err);
-        });
+        if (!opts.noStreamErrorHandler) {
+            opts.stream.on('error', function (err) {
+                onFileWriteStream(err);
+            });
+        }
 
         if (opts.size !== undefined || opts.contentMD5) {
             opts.stream.on('data', function (chunk) {
-- 
2.21.0

