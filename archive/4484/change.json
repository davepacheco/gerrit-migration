{"project":"joyent/sdc-net-agent","branch":"master","id":"Ic8e08453ccc01b7c3300fa13365399c814d5cce8","number":"4484","subject":"TRITON-456 net-agent needs vminfod watcher Reviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e Approved by: Cody Peter Mello \u003cmelloc@writev.io\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/4484","commitMessage":"TRITON-456 net-agent needs vminfod watcher\nReviewed by: Cody Peter Mello \u003cmelloc@writev.io\u003e\nApproved by: Cody Peter Mello \u003cmelloc@writev.io\u003e\n","createdOn":1530807371,"lastUpdated":1531528094,"open":false,"status":"MERGED","comments":[{"timestamp":1530807371,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1530807374,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 63ba3aca0ea3d6b06ad0a2b6534ee07974b8c4f1\n    \n    initial commit"},{"timestamp":1530807414,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1530807811,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1: Code-Review-1\n\nNeeds retry logic for `vmadm events` failure if possible..."},{"timestamp":1530826245,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1530893872,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1530893983,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1530893986,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 94e6ffcfca0d8b37adf0b09f1ada716598c30703\n    \n    - 2 FSM inside vmadm-watcher-fsm to match watcher-fsm style\n     1 manages `vmadm(1M)`, the other is exported as a meta watcher\n    - iteration based on Cody\u0027s review\n    - better error handling and retry log\n    - bumped node-vmadm version for `vmadm.events` return object"},{"timestamp":1530894035,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531165285,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2: -Code-Review"},{"timestamp":1531172545,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1531239725,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\n(2 comments)"},{"timestamp":1531239765,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1531239768,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 214e175866b8254b0d0aa11a14eee36746952509\n    \n    changes based on cody review"},{"timestamp":1531239813,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531498146,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4."},{"timestamp":1531498149,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 4:\n\nNew commits:\n    \n    commit f86fdb862a4b6c18052bde03fc0bfa11383ab68e\n    \n    error handling in determineEventSource\n    This can error if ECONNREFUSED"},{"timestamp":1531498199,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1531511367,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Patch Set 4: Code-Review+1 Integration-Approval+1"},{"timestamp":1531528071,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1531528094,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"5","revision":"c8e08453ccc01b7c3300fa13365399c814d5cce8","parents":["c38ec6078b3bf2a5d151d1b61b2efa21615a7a06"],"ref":"refs/changes/84/4484/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1531528071,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531498199,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1531511367,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1531511367,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"SUBM","value":"1","grantedOn":1531528094,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/event-source.js","type":"ADDED","insertions":62,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":51,"deletions":-8},{"file":"lib/vmadm-watcher-fsm.js","type":"ADDED","insertions":279,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":393,"sizeDeletions":-9},"patchSets":[{"number":"1","revision":"c44518916e52dcba89615fcc2fb4af38b795bcb1","parents":["c38ec6078b3bf2a5d151d1b61b2efa21615a7a06"],"ref":"refs/changes/84/4484/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1530807371,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530807414,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"-1","grantedOn":1530807811,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"comments":[{"file":"lib/event-source.js","line":20,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"assert.object"},{"file":"lib/event-source.js","line":20,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/net-agent.js","line":138,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Let\u0027s initialize this.watcher and this.eventSource to null in the constructor."},{"file":"lib/net-agent.js","line":138,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/net-agent.js","line":138,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"Still need to initialize this.eventSource here. I\u0027ve tried to put all fields on objects inside their constructors (initialized to null if their values will come later) so that they show up under a single representative object in mdb_v8."},{"file":"lib/net-agent.js","line":138,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Ah ok, that makes sense. Will do."},{"file":"lib/net-agent.js","line":287,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"If there\u0027s an error here, let\u0027s log.error() it and then retry:\n\n    S.timeout(1000, function () {\n        S.gotoState(\u0027init.determineEventSource\u0027);\n    });"},{"file":"lib/net-agent.js","line":287,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/net-agent.js","line":314,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"throw new VError(\u0027unknown event source %j\u0027, this.eventSource);"},{"file":"lib/net-agent.js","line":314,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/vmadm-watcher-fsm.js","line":18,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"We should also watch \"owner_uuid\" here."},{"file":"lib/vmadm-watcher-fsm.js","line":18,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"},{"file":"lib/vmadm-watcher-fsm.js","line":180,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"assert.func()"},{"file":"lib/vmadm-watcher-fsm.js","line":180,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Done"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/event-source.js","type":"ADDED","insertions":56,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":46,"deletions":-9},{"file":"lib/vmadm-watcher-fsm.js","type":"ADDED","insertions":208,"deletions":0}],"sizeInsertions":310,"sizeDeletions":-9},{"number":"2","revision":"7f48a990b3a73a1372b02148824ef54fd37350d7","parents":["c38ec6078b3bf2a5d151d1b61b2efa21615a7a06"],"ref":"refs/changes/84/4484/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1530893983,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1530894035,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/vmadm-watcher-fsm.js","line":167,"reviewer":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"},"message":"I think this would be better as:\n\n    self.emitter \u003d vmadm.events(opts, handler, ready);\n\n    S.on(this.emitter, \u0027error\u0027, function onError(err) {\n        self.log.error(err, \u0027vmadm events error\u0027);\n        S.gotoState(\u0027init\u0027);\n    });\n\nAnd then in state_running, you can do:\n\n    S.on(self.emitter, \u0027error\u0027, function onError(err) {\n        self.log.error(err, \u0027vmadm events error\u0027);\n        self.stopWatcher();\n        self.stopWatcher \u003d null;\n        self.emitter \u003d null;\n        S.gotoState(\u0027init\u0027);\n    });\n\nThat way the logic within the \"error\" handler is specific to the state that it was registered under."},{"file":"lib/vmadm-watcher-fsm.js","line":167,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Ah ok this is perfect.  I\u0027m still getting used to the mooremachine way of doing things - I find it incredibly easy to read but a little more difficult to write... given time it\u0027ll make more sense to me"}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/event-source.js","type":"ADDED","insertions":56,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":50,"deletions":-8},{"file":"lib/vmadm-watcher-fsm.js","type":"ADDED","insertions":279,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":386,"sizeDeletions":-9},{"number":"3","revision":"12d3eae927eb34e8d2a81b89389504517bdf3bc7","parents":["c38ec6078b3bf2a5d151d1b61b2efa21615a7a06"],"ref":"refs/changes/84/4484/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1531239765,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531239813,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/event-source.js","type":"ADDED","insertions":56,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":51,"deletions":-8},{"file":"lib/vmadm-watcher-fsm.js","type":"ADDED","insertions":279,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":387,"sizeDeletions":-9},{"number":"4","revision":"b7f7a16572d98b304ae8e769cf6c647e7250e6f0","parents":["c38ec6078b3bf2a5d151d1b61b2efa21615a7a06"],"ref":"refs/changes/84/4484/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1531498146,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1531511367,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1531511367,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531498199,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/event-source.js","type":"ADDED","insertions":62,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":51,"deletions":-8},{"file":"lib/vmadm-watcher-fsm.js","type":"ADDED","insertions":279,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":393,"sizeDeletions":-9},{"number":"5","revision":"c8e08453ccc01b7c3300fa13365399c814d5cce8","parents":["c38ec6078b3bf2a5d151d1b61b2efa21615a7a06"],"ref":"refs/changes/84/4484/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1531528071,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1531511367,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1531511367,"by":{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}},{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1531498199,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"SUBM","value":"1","grantedOn":1531528094,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/event-source.js","type":"ADDED","insertions":62,"deletions":0},{"file":"lib/net-agent.js","type":"MODIFIED","insertions":51,"deletions":-8},{"file":"lib/vmadm-watcher-fsm.js","type":"ADDED","insertions":279,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1}],"sizeInsertions":393,"sizeDeletions":-9}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},{"name":"Cody Peter Mello","email":"melloc@writev.io","username":"melloc"}]}