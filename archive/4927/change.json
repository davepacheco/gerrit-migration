{"project":"joyent/smartos-live","branch":"master","id":"I6a1255390f2359e83cc7d46a0ebdbc73021cc0b8","number":"4927","subject":"TRITON-826 vminfod timeout during `vmadm update` Reviewed by: Jorge Schrauwen \u003csjorge@blackdot.be\u003e Reviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e Approved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e","owner":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"url":"https://cr.joyent.us/4927","commitMessage":"TRITON-826 vminfod timeout during `vmadm update`\nReviewed by: Jorge Schrauwen \u003csjorge@blackdot.be\u003e\nReviewed by: Mike Gerdts \u003cmike.gerdts@joyent.com\u003e\nApproved by: Josh Wilsdon \u003cjosh@wilsdon.ca\u003e\n","createdOn":1538723833,"lastUpdated":1539188108,"open":false,"status":"MERGED","comments":[{"timestamp":1538723833,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 1."},{"timestamp":1538723836,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit 982d2ca0f0f66d09986a06be3d4cbdde15c3026a\n    \n    initial commit"},{"timestamp":1538723891,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538729110,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 1: Code-Review+1"},{"timestamp":1538729227,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 1: -Code-Review\n\nOops wrong button,... as I wanted to leave a question not a +1.\n\nSo you\u0027re adding a \u0027HVM\u0027 attr to the zonecfg too? Or am I miss-reading the code? If you are and it is listed with vmadm list the man page will also need updating. Other than that it looks Ok at first glance. I will try to go over it in more detail if I find some extra time to dig a bit deeper."},{"timestamp":1538756946,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 1:\n\nThis is not adding a zonecfg attribute - this is merely adding a VM JSON payload property of \"hvm\" that is calculated at load time based on the \"brand\" property.  \"load time\" being when the information is gathered from the system, which is now done by vminfod for all VMs whenever 1. it is started or 2. a modification is made on the system.\n\nBasically, this \"hvm\" property won\u0027t be stored anywhere specifically by itself, but will always be available on any VM at any time.\n\nGood call about the manpage - I\u0027ll add that!"},{"timestamp":1538757012,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 2."},{"timestamp":1538757016,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit dc44f2ccd4961f09f69e709e59b6b4d82aa97cd3\n    \n    add hvm property to vmadm man page, ty sjorge"},{"timestamp":1538757066,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538757782,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1538757880,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 2: Code-Review+1\n\n(1 comment)"},{"timestamp":1538760833,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 3."},{"timestamp":1538760837,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit e65ee62cba04b7614210019ed26d563a1d671779\n    \n    ensure all HVM cases are handled when ram is modified"},{"timestamp":1538760882,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\nUpdate: I ran the entire test suite on COAL against patchset 3 and it worked as expected."},{"timestamp":1538760885,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1538770674,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1539016843,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3:\n\nThere are a lot of instances of:\n\nif (vmobj.brand \u003d\u003d\u003d \u0027kvm\u0027 || vmobj.brand \u003d\u003d\u003d \u0027bhyve\u0027) {\n ...\n\nIt seems all of them should be updated to use vmobj.hvm.  If you don\u0027t want to include that in this wad, please open a ticket so that we remember to do that as follow-up work."},{"timestamp":1539017939,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Patch Set 3:\n\n@Mike Gerdts: https://jira.joyent.us/browse/OS-7295 follow up ticket created."},{"timestamp":1539018068,"reviewer":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1539018627,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1539154737,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4: Integration-Approval+1"},{"timestamp":1539154770,"reviewer":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},"message":"Patch Set 4:\n\nI tested and VMAPI seems to correctly ignore this property. So it will have nothing to do with Triton."},{"timestamp":1539188091,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Uploaded patch set 5: Commit message was updated."},{"timestamp":1539188108,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Dave Eddy"}],"currentPatchSet":{"number":"5","revision":"6a1255390f2359e83cc7d46a0ebdbc73021cc0b8","parents":["8989e0c7eca187545d9867df22fe358ea880ea4e"],"ref":"refs/changes/27/4927/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1539188091,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538760885,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538770674,"by":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539018068,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539154737,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1539188108,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-14},{"file":"src/vm/node_modules/expander.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":56,"sizeDeletions":-14},"patchSets":[{"number":"1","revision":"cb2ae54bedfa96b6bfe89ff6bce4b16fd89504bb","parents":["8989e0c7eca187545d9867df22fe358ea880ea4e"],"ref":"refs/changes/27/4927/1","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1538723833,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538723891,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":26,"deletions":-14},{"file":"src/vm/node_modules/expander.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":43,"sizeDeletions":-14},{"number":"2","revision":"5fac67f326fb26fe6aeca92743254cf8d5cbfffc","parents":["8989e0c7eca187545d9867df22fe358ea880ea4e"],"ref":"refs/changes/27/4927/2","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1538757012,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538757066,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538757880,"by":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}}],"comments":[{"file":"src/vm/node_modules/VM.js","line":15374,"reviewer":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"message":"Perhaps I should add:\n\n assert(!vmobj.hvm, \u0027hvm VM ram case not handled\u0027);\n\nTo ensure that, if we make it to the default case, that we are not processing a hardware virtualized VM."},{"file":"src/vm/node_modules/VM.js","line":15374,"reviewer":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},"message":"I like that idea."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":26,"deletions":-14},{"file":"src/vm/node_modules/expander.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":55,"sizeDeletions":-14},{"number":"3","revision":"f184d8cb7654d7d383875d9758c22cc8d5cee2c4","parents":["8989e0c7eca187545d9867df22fe358ea880ea4e"],"ref":"refs/changes/27/4927/3","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1538760833,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538760885,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538770674,"by":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539018068,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":8,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-14},{"file":"src/vm/node_modules/expander.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":56,"sizeDeletions":-14},{"number":"4","revision":"fbb963e4026ec4d68381df54b065861e5486d780","parents":["8989e0c7eca187545d9867df22fe358ea880ea4e"],"ref":"refs/changes/27/4927/4","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1539018627,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538760885,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539154737,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538770674,"by":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539018068,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-14},{"file":"src/vm/node_modules/expander.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":56,"sizeDeletions":-14},{"number":"5","revision":"6a1255390f2359e83cc7d46a0ebdbc73021cc0b8","parents":["8989e0c7eca187545d9867df22fe358ea880ea4e"],"ref":"refs/changes/27/4927/5","uploader":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"createdOn":1539188091,"author":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1538760885,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1539154737,"by":{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"}},{"type":"SUBM","value":"1","grantedOn":1539188108,"by":{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1538770674,"by":{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1539018068,"by":{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":10,"deletions":0},{"file":"src/vm/man/vmadm.1m.md","type":"MODIFIED","insertions":12,"deletions":0},{"file":"src/vm/node_modules/VM.js","type":"MODIFIED","insertions":27,"deletions":-14},{"file":"src/vm/node_modules/expander.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/node_modules/proptable.js","type":"MODIFIED","insertions":8,"deletions":0},{"file":"src/vm/node_modules/vmload/index.js","type":"MODIFIED","insertions":3,"deletions":0},{"file":"src/vm/sbin/vmadm.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"src/vm/tests/test-defaults.js","type":"MODIFIED","insertions":2,"deletions":0}],"sizeInsertions":56,"sizeDeletions":-14}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jorge Schrauwen","email":"sjorge@blackdot.be","username":"sjorge"},{"name":"Mike Gerdts","email":"mike.gerdts@joyent.com","username":"mgerdts"},{"name":"Josh Wilsdon","email":"josh@wilsdon.ca","username":"joshwilsdon"},{"name":"Dave Eddy","email":"dave.eddy@joyent.com","username":"bahamas10"}]}