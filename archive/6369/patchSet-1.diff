commit 05e86f42897cdb9073267a8b9dea2b462f93c536
Author: Patrick Mooney <pmooney@pfmooney.com>
Date:   2019-05-29T20:04:21+00:00 (4 months ago)
    
    OS-7812 viona bungles refcount during ipf hook

diff --git a/usr/src/uts/i86pc/io/viona/viona.c b/usr/src/uts/i86pc/io/viona/viona.c
index 030c2dabad..fa7813413f 100644
--- a/usr/src/uts/i86pc/io/viona/viona.c
+++ b/usr/src/uts/i86pc/io/viona/viona.c
@@ -2967,8 +2967,22 @@ viona_tx(viona_link_t *link, viona_vring_t *ring)
 			goto drop_hook;
 		}
 
-		if (dp != NULL)
+		if (dp != NULL) {
 			dp->d_ref--;
+
+			/*
+			 * It is possible that the hook(s) accepted the packet,
+			 * but as part of its processing, it issued a pull-up
+			 * which released all references to the desb.  In that
+			 * case, go back to acting like the packet is entirely
+			 * copied (which it is).
+			 */
+			if (dp->d_ref == 1) {
+				dp->d_cookie = 0;
+				dp->d_ref = 0;
+				dp = NULL;
+			}
+		}
 	}
 
 	/*
