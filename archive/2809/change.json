{"project":"joyent/sdc-cnapi","branch":"master","id":"I4eb7ed4abb89fcc0c5c612b71a90e0f46dbb4605","number":"2809","subject":"CNAPI-724 CNAPI still not alerting clients waiting on tasks Reviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e Approved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e","owner":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"url":"https://cr.joyent.us/2809","commitMessage":"CNAPI-724 CNAPI still not alerting clients waiting on tasks\nReviewed by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\nApproved by: Julien Gilli \u003cjulien.gilli@joyent.com\u003e\n","createdOn":1508322135,"lastUpdated":1508517965,"open":false,"status":"MERGED","comments":[{"timestamp":1508322135,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 1."},{"timestamp":1508322136,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\nNew commits:\n    \n    commit eeafecbfc8e85887995b5a49667af6f0b19b278c\n    \n    pass in task value as an argument to alertWaitingTasks"},{"timestamp":1508322168,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508450979,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(3 comments)"},{"timestamp":1508452668,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 1:\n\n(10 comments)"},{"timestamp":1508456373,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(6 comments)"},{"timestamp":1508456472,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 2."},{"timestamp":1508456473,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\nNew commits:\n    \n    commit 97704b344bc5e7a05b87378b652e61504ea58028\n    \n    add logging statements to task execution code, cache values if no one clients waiting on a task"},{"timestamp":1508456500,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508458728,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1508459656,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 3."},{"timestamp":1508459657,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 3:\n\nNew commits:\n    \n    commit 10ff1ed8b21230115423183edfd03fc97dd6261e\n    \n    remove unnecessary log object"},{"timestamp":1508459676,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Patch Set 2:\n\n(1 comment)"},{"timestamp":1508459690,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508460248,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Code-Review+1"},{"timestamp":1508467494,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Patch Set 3: Integration-Approval+1"},{"timestamp":1508517957,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Uploaded patch set 4: Commit message was updated."},{"timestamp":1508517965,"reviewer":{"name":"Gerrit Code Review","email":"no-reply@cr.joyent.us"},"message":"Change has been successfully merged by Orlando Vazquez"}],"currentPatchSet":{"number":"4","revision":"4eb7ed4abb89fcc0c5c612b71a90e0f46dbb4605","parents":["ff590f904d19cfcaaefdb6f18ab9c82dac97812e"],"ref":"refs/changes/09/2809/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1508517957,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508459690,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508460248,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508467494,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1508517965,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":23,"deletions":-12},{"file":"lib/endpoints/tasks.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"lib/models/server.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-19},"patchSets":[{"number":"1","revision":"951ab71ab44090c1cfe1da46781d2584388ff836","parents":["ff590f904d19cfcaaefdb6f18ab9c82dac97812e"],"ref":"refs/changes/09/2809/1","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1508322135,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508322168,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/app.js","line":1292,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"This is the part that was breaking, because this value was erronously being set to \"undefined\" via a function parameter which was being omitted."},{"file":"lib/app.js","line":1336,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Turns out this parameter was unused, so I removed it."},{"file":"lib/app.js","line":1295,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"The else is not needed here, since we return from the function in the \"if\" branch."},{"file":"lib/app.js","line":1295,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"lib/app.js","line":1338,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Can we assert on the type of all parameters to avoid any confusion in the future?"},{"file":"lib/app.js","line":1338,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"lib/app.js","line":1358,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: maybe turn that into one log statement:\n\nself.log.warn({task: task},\n            \u0027alertWaitingTasks: wanted to alert callbacks for task, but none found, caching response\u0027);\n\n?"},{"file":"lib/app.js","line":1358,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"lib/endpoints/tasks.js","line":72,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Is warn the proper log level? Should it be debug to avoid flooding log files (the default loglevel seems to be \"info\")?\n\nI don\u0027t know how frequently this function is called."},{"file":"lib/endpoints/tasks.js","line":72,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done - updated log lines to debug()"},{"file":"lib/endpoints/tasks.js","line":76,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Maybe s/get task/got task/?\n\nSame question for the log level."},{"file":"lib/endpoints/tasks.js","line":84,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"\"not complete or failure\" seems a bit confusing, it sounds like the task is either not complete or failed. Although it seems you meant it\u0027s neither complete *nor* failed?\n\nSame question for log level."},{"file":"lib/endpoints/tasks.js","line":84,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done - Right, we want to know that the task is not neither complete nor failed."},{"file":"lib/endpoints/tasks.js","line":89,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"nit: s/get/got/?\n\nSame question for log level."},{"file":"lib/endpoints/tasks.js","line":128,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Should the caller of \"wait\" be updated with the new error param?\n\nAlso maybe put the log statement before calling the call back so that log statements from the callback don\u0027t appear *before* the log statement below?\n\nSame question as above for the log level."},{"file":"lib/endpoints/tasks.js","line":128,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Should the caller of \"wait\" be updated with the new error param?\n\nDid you mean the callback to wait() should handle the new err param? - Done, if so.\n\nGood catch on log site."},{"file":"lib/endpoints/tasks.js","line":133,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Isn\u0027t the task already set in the \"get\" function?  Were we missing something before this change then?"},{"file":"lib/endpoints/tasks.js","line":133,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"`_task` coming from `waitForTask` could be the cached value we have in memory."},{"file":"lib/endpoints/tasks.js","line":146,"reviewer":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},"message":"Where is this used?"},{"file":"lib/endpoints/tasks.js","line":146,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Done"},{"file":"lib/models/server.js","line":2252,"reviewer":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"message":"Adding this argument is the allows the CNAPI-722 fix to work."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":12,"deletions":-7},{"file":"lib/endpoints/tasks.js","type":"MODIFIED","insertions":17,"deletions":-3},{"file":"lib/models/server.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":33,"sizeDeletions":-11},{"number":"2","revision":"ffda2d8b47b255c49fcbd7eddd18383fd6ab0fa3","parents":["ff590f904d19cfcaaefdb6f18ab9c82dac97812e"],"ref":"refs/changes/09/2809/2","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1508456472,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508456500,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":23,"deletions":-12},{"file":"lib/endpoints/tasks.js","type":"MODIFIED","insertions":28,"deletions":-6},{"file":"lib/models/server.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":55,"sizeDeletions":-19},{"number":"3","revision":"c2e1dea7d3d83f228f7b40ca23104da9a7b83789","parents":["ff590f904d19cfcaaefdb6f18ab9c82dac97812e"],"ref":"refs/changes/09/2809/3","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1508459656,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508459690,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508460248,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508467494,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":23,"deletions":-12},{"file":"lib/endpoints/tasks.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"lib/models/server.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-19},{"number":"4","revision":"4eb7ed4abb89fcc0c5c612b71a90e0f46dbb4605","parents":["ff590f904d19cfcaaefdb6f18ab9c82dac97812e"],"ref":"refs/changes/09/2809/4","uploader":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"createdOn":1508517957,"author":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"},"isDraft":false,"kind":"NO_CODE_CHANGE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508459690,"by":{"name":"Joyent Automation","username":"joyent-automation"}},{"type":"Code-Review","description":"Code-Review","value":"1","grantedOn":1508460248,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"Integration-Approval","description":"Integration-Approval","value":"1","grantedOn":1508467494,"by":{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"}},{"type":"SUBM","value":"1","grantedOn":1508517965,"by":{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":9,"deletions":0},{"file":"lib/app.js","type":"MODIFIED","insertions":23,"deletions":-12},{"file":"lib/endpoints/tasks.js","type":"MODIFIED","insertions":26,"deletions":-6},{"file":"lib/models/server.js","type":"MODIFIED","insertions":4,"deletions":-1}],"sizeInsertions":53,"sizeDeletions":-19}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Julien Gilli","email":"jgilli@netflix.com","username":"misterdjules"},{"name":"Orlando Vazquez","email":"orlando@joyent.com","username":"orlandov"}]}