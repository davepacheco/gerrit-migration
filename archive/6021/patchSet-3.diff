From 39c563298456c50dcfc065e715ed910066ca68e5 Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Fri, 29 Mar 2019 11:23:02 +0000
Subject: [PATCH] TRITON-1353 Triton systems should ship with HT disabled

---
 lib/models/server.js          | 17 +++++++++++++++++
 sapi_manifests/cnapi/template |  3 ++-
 test/test-servers.js          |  1 +
 3 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/lib/models/server.js b/lib/models/server.js
index 08f21ac..b58d729 100644
--- a/lib/models/server.js
+++ b/lib/models/server.js
@@ -1258,6 +1258,23 @@ ModelServer.getBootParamsDefault = function (callback) {
                 params.kernel_flags[k] = server.kernel_flags[k];
             }
 
+            /*
+             * We want to default new / factory-reset CNs to disabling HT. The
+             * default boot params is originally generated via
+             * initializeBuckets(), but we want this policy to apply on upgrade,
+             * not just a completely fresh install. So we will mix in the HT
+             * default setting from SAPI here.
+             *
+             * The net effect here is that a new CN will have HT disabled, but
+             * a system that is merely upgraded will already have its own
+             * bootparams, and hence not see this change in behavior.
+             * FIXME: update static.md
+             */
+            if (!params.kernel_args.hasOwnProperty('ht_enabled')) {
+                params.kernel_args['ht_enabled'] =
+                    ModelServer.getConfig().cnapi.ht_enabled_default;
+            }
+
             params.boot_modules = server.boot_modules;
 
             params.default_console = server.default_console;
diff --git a/sapi_manifests/cnapi/template b/sapi_manifests/cnapi/template
index 2dc3f6b..606cabf 100644
--- a/sapi_manifests/cnapi/template
+++ b/sapi_manifests/cnapi/template
@@ -43,7 +43,8 @@
 		"url": "http://{{{assets_admin_ips}}}"
 	},
 	"cnapi": {
-		"url": "http://{{{auto.ADMIN_IP}}}"
+		"url": "http://{{{auto.ADMIN_IP}}}",
+                "ht_enabled_default": {{{HT_ENABLED_DEFAULT}}}{{^HT_ENABLED_DEFAULT}}false{{/HT_ENABLED_DEFAULT}}
 	},
 	"imgapi": {
 		"url": "http://{{{IMGAPI_SERVICE}}}"
diff --git a/test/test-servers.js b/test/test-servers.js
index e892747..92037a4 100644
--- a/test/test-servers.js
+++ b/test/test-servers.js
@@ -365,6 +365,7 @@ function testUpdateServerOverprovisionRatios(t) {
 //  * ensure that the boot time was updated in the server object
 //  * DELETE the server
 //
+// FIXME: test jlevon
 function testServerSysinfo(t) {
     // Taken from a Joyent Lab system, modified only to set UUID randomly and
     // to transpose characters in the hostname and serial number in case this
-- 
2.21.0

