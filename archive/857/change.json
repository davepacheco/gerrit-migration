{"project":"joyent/node-manta","branch":"master","id":"Ic194ed75d57bc9433068846930b5201fac17b1c2","number":"857","subject":"joyent/node-manta#274 mkdirp should not overwrite existing dirs","owner":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"url":"https://cr.joyent.us/857","commitMessage":"joyent/node-manta#274 mkdirp should not overwrite existing dirs\n","createdOn":1478564887,"lastUpdated":1535120540,"open":false,"status":"ABANDONED","comments":[{"timestamp":1478564887,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Uploaded patch set 1."},{"timestamp":1478564923,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1478565106,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\nThis is my first foray into node callback-land.  The basic approach I took was to do an `info` call on each dir, and only `put` if not found.\n\nThere appears to be some existing: many can\u0027t be run individually and may have dependencies on order or the actions of other tests.  Adding a new top level dir was the smallest possible change there."},{"timestamp":1478565398,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478620913,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478631159,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478632535,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478634475,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1478636386,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Patch Set 1:\n\n(1 comment)"},{"timestamp":1480497138,"reviewer":{"name":"Jonathan Perkin","email":"jperkin@joyent.com","username":"jperkin"},"message":"Patch Set 1:\n\nJust to note that this issue is a blocker for the new pkgsrc rbac bits, as we depend upon multiple subusers using muntar. For now we\u0027re running with installs manually monkey patched with Chris\u0027 patch and it works great."},{"timestamp":1535120540,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"Abandoned\n\nSee comments on multi-object transactions."}],"currentPatchSet":{"number":"1","revision":"c194ed75d57bc9433068846930b5201fac17b1c2","parents":["8f0e631d2e59e3788af81da6edae5b3648d393ee"],"ref":"refs/changes/57/857/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1478564887,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478564923,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":1742,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks for fixing this.  It seems like there\u0027s still a race here.  Wouldn\u0027t it be better to make this conditional on the directory not already existing?  (That would also cut the number of requests in half, I believe.)"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I didn\u0027t see an api for transactions on multiple objects.  Is the race you are refering to client (1) writing metadata to /a/b while client (2) is doing mkdirp(/a/b/c/d) ?  I\u0027m unsure how we could prevent that.\n\nRegarding the number of requests, in the context of put we only end down this path if the initial put fails: https://github.com/joyent/node-manta/blob/0e222e9a1ab7b421013b02e3b458c44e00e84bff/lib/client.js#L1856\n\nFor mkdirp in general I don\u0027t see a mechanism to do put-if-does-not-exist (although that sounds useful), and if we just blindly put we overwrite metadata (the original problem).  Am I missing another option?"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Yes, the race I\u0027m talking about is where another client creates the directory while we\u0027re in the middle of the mkdirp operation, and we end up clobbering their metadata.  This isn\u0027t all that unlikely if two clients end up running mkdirp at the same time.  This happens frequently inside jobs.\n\nRFC 2616 provides the If-None-Match header for handling exactly this:\nhttps://tools.ietf.org/html/rfc2616#section-14.26\n\nThe way this is supposed to work is that the client specifies the header: \"If-None-Match: *\", which means that the request should succeed only if the resource does NOT already exist.  Unfortunately, this doesn\u0027t seem to work in Muskie.  That\u0027s an existing bug: MANTA-1634.\n\nI think it\u0027s worth fixing the server-side problem and updating the client to use the if-none-match header."},{"file":"lib/client.js","line":1742,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"So if I understand what you are saying correctly: no fix for #274 should move forward until MANTA-1634 is resolved?\n\nI\u0027m not sure how often metadata is used, but overwriting it on (from the user\u0027s point of view) unrelated directories seems like a significant bug.  Can you help me understand why the two step check-and-set behavior would be worse than the existing bug+race?"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\u003e Can you help me understand why the two step check-and-set behavior would be worse than the existing bug+race?\n\nThe two-step check-and-set behavior reduces the window significantly, and is an improvement, but without using if-none-match we can\u0027t eliminate the window.  We ought to completely fix the bug.  If there\u0027s particular urgency around the fix, then maybe we should integrate a hybrid change that checks for the presence of the directory first, and then uses an appropriate if-none-match header if it decides to create the directory?"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"That makes sense.  Thank you for helping me understand.\n\nI\u0027d defer to Angela on the urgency since she opened the original ticket."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"test/client.test.js","type":"MODIFIED","insertions":40,"deletions":0}],"sizeInsertions":49,"sizeDeletions":-3},"patchSets":[{"number":"1","revision":"c194ed75d57bc9433068846930b5201fac17b1c2","parents":["8f0e631d2e59e3788af81da6edae5b3648d393ee"],"ref":"refs/changes/57/857/1","uploader":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"createdOn":1478564887,"author":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1478564923,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/client.js","line":1742,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Thanks for fixing this.  It seems like there\u0027s still a race here.  Wouldn\u0027t it be better to make this conditional on the directory not already existing?  (That would also cut the number of requests in half, I believe.)"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"I didn\u0027t see an api for transactions on multiple objects.  Is the race you are refering to client (1) writing metadata to /a/b while client (2) is doing mkdirp(/a/b/c/d) ?  I\u0027m unsure how we could prevent that.\n\nRegarding the number of requests, in the context of put we only end down this path if the initial put fails: https://github.com/joyent/node-manta/blob/0e222e9a1ab7b421013b02e3b458c44e00e84bff/lib/client.js#L1856\n\nFor mkdirp in general I don\u0027t see a mechanism to do put-if-does-not-exist (although that sounds useful), and if we just blindly put we overwrite metadata (the original problem).  Am I missing another option?"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"Yes, the race I\u0027m talking about is where another client creates the directory while we\u0027re in the middle of the mkdirp operation, and we end up clobbering their metadata.  This isn\u0027t all that unlikely if two clients end up running mkdirp at the same time.  This happens frequently inside jobs.\n\nRFC 2616 provides the If-None-Match header for handling exactly this:\nhttps://tools.ietf.org/html/rfc2616#section-14.26\n\nThe way this is supposed to work is that the client specifies the header: \"If-None-Match: *\", which means that the request should succeed only if the resource does NOT already exist.  Unfortunately, this doesn\u0027t seem to work in Muskie.  That\u0027s an existing bug: MANTA-1634.\n\nI think it\u0027s worth fixing the server-side problem and updating the client to use the if-none-match header."},{"file":"lib/client.js","line":1742,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"So if I understand what you are saying correctly: no fix for #274 should move forward until MANTA-1634 is resolved?\n\nI\u0027m not sure how often metadata is used, but overwriting it on (from the user\u0027s point of view) unrelated directories seems like a significant bug.  Can you help me understand why the two step check-and-set behavior would be worse than the existing bug+race?"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},"message":"\u003e Can you help me understand why the two step check-and-set behavior would be worse than the existing bug+race?\n\nThe two-step check-and-set behavior reduces the window significantly, and is an improvement, but without using if-none-match we can\u0027t eliminate the window.  We ought to completely fix the bug.  If there\u0027s particular urgency around the fix, then maybe we should integrate a hybrid change that checks for the presence of the directory first, and then uses an appropriate if-none-match header if it decides to create the directory?"},{"file":"lib/client.js","line":1742,"reviewer":{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},"message":"That makes sense.  Thank you for helping me understand.\n\nI\u0027d defer to Angela on the urgency since she opened the original ticket."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"CHANGES.md","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/client.js","type":"MODIFIED","insertions":8,"deletions":-3},{"file":"test/client.test.js","type":"MODIFIED","insertions":40,"deletions":0}],"sizeInsertions":49,"sizeDeletions":-3}],"allReviewers":[{"name":"David Pacheco","email":"dap@joyent.com","username":"davepacheco"},{"name":"Jonathan Perkin","email":"jperkin@joyent.com","username":"jperkin"},{"name":"Chris Burroughs","email":"chris.burroughs@joyent.com","username":"cburroughs"},{"name":"Joyent Automation","username":"joyent-automation"}]}