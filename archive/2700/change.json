{"project":"joyent/manta-muskie","branch":"master","topic":"3440","id":"I092778ac6c6df31313ba42cfa647f64e35645fde","number":"2700","subject":"MANTA-3440 Add support for Content-Encoding for objects","owner":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"url":"https://cr.joyent.us/2700","commitMessage":"MANTA-3440 Add support for Content-Encoding for objects\n","createdOn":1506997450,"lastUpdated":1546453023,"open":true,"status":"NEW","comments":[{"timestamp":1506997450,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 1."},{"timestamp":1506997480,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 1: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507072417,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 2: Patch Set 1 was rebased"},{"timestamp":1507072466,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 2:\n\n\"make check\" passed ok"},{"timestamp":1507574547,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 3: Patch Set 2 was rebased"},{"timestamp":1507574576,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 3:\n\n\"make check\" passed ok"},{"timestamp":1507582623,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 4."},{"timestamp":1507582657,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 4: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1507588201,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 5: Patch Set 4 was rebased"},{"timestamp":1507588235,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 5:\n\n\"make check\" passed ok"},{"timestamp":1508182355,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 6."},{"timestamp":1508182389,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 6: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508182401,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 6:\n\nThe most recent patchset adds support for create mpus with the content-encoding field. A test will follow shortly."},{"timestamp":1508182404,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7: Patch Set 6 was rebased"},{"timestamp":1508182444,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 7:\n\n\"make check\" passed ok"},{"timestamp":1508186373,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 7:\n\nI\u0027ve updated the comments in the ticket to include a manual test run for the mpu use case."},{"timestamp":1508360200,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 7:\n\n(2 comments)\n\nGiven that this is an API change, we should at the least update the public docs (https://apidocs.joyent.com/manta/api.html). I think there are probably some additional ways that we should be testing it with the fact that it is an API change in mind -- e.g., across a muskie upgrade. I would test at the least that object records created under an older muskie don\u0027t break it when fetched by a newer muskie.\n\nAlso, would you mind putting the related changes for this ticket in a Gerrit topic page? Let me know if you need help with that. It makes finding all related changes for the same ticket much more straightforward."},{"timestamp":1508438556,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 8."},{"timestamp":1508438589,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 8: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1508440773,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 8:\n\n(2 comments)\n\nI\u0027ve updated the testing notes to include the following cases:\n\n- PUTing an object or committing an mpu against an old version of muskie and then performing metadata reads on it from the new version of muskie still works.\n- PUTing an object or committing an mpu with the content-encoding header (using the new version of muskie) and then performing metadata reads on it from a version without this change doesn\u0027t show the new content-encoding header.\n\nI think it is reasonable to prevent old muskies from exposing the content-encoding header so that we don\u0027t inadvertently break clients that may expect a particular set of headers returned on metadata reads. However since we\u0027re including the content-encoding field in the public api docs, maybe we should specify that this field is only supported on the version of muskie that contains this change so that clients don\u0027t expect the header on versions of muskie without this change."},{"timestamp":1508440796,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Patch Set 9: Patch Set 8 was rebased"},{"timestamp":1508440829,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 9:\n\n\"make check\" passed ok"},{"timestamp":1508441017,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Topic set to 3440"},{"timestamp":1509042283,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"Patch Set 9:\n\nI don\u0027t see any way around integrating this without some sort of versioning of muskie. At the moment, we don\u0027t really do that, though restify does support versioned routes. I\u0027ve left a comment in MANTA-3467 to invite others to discuss it, since it would be a fairly significant change."},{"timestamp":1509050855,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Uploaded patch set 10."},{"timestamp":1509050882,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10: CI-Testing+1\n\n\"make check\" passed ok"},{"timestamp":1546453023,"reviewer":{"name":"Joyent Automation","username":"joyent-automation"},"message":"Patch Set 10:\n\n\"make check\" passed ok"}],"currentPatchSet":{"number":"10","revision":"092778ac6c6df31313ba42cfa647f64e35645fde","parents":["4d0ed4ef4d76e3059a3cc3914686e8167708c1dd"],"ref":"refs/changes/00/2700/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509050855,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509050882,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":64,"sizeDeletions":-1},"patchSets":[{"number":"1","revision":"14f52f4e0f82bdbf5252baf8fe24686846a06a34","parents":["4d0ed4ef4d76e3059a3cc3914686e8167708c1dd"],"ref":"refs/changes/00/2700/1","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1506997450,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506997480,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":23,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-1},{"number":"2","revision":"3ce5e4828397a7dbd28a5485759f1a72c01f0758","parents":["2e4845c519e1915da9965868d467bd4d1242a2cb"],"ref":"refs/changes/00/2700/2","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507072417,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506997480,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":23,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-1},{"number":"3","revision":"e804273196f03f089e4a3911f781232727df0471","parents":["839994735d9ec2f5414b83ab5a863c41ea31d47f"],"ref":"refs/changes/00/2700/3","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507574547,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1506997480,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":23,"deletions":0}],"sizeInsertions":30,"sizeDeletions":-1},{"number":"4","revision":"55ec776700858f6698880c89a38bb20d97c4e248","parents":["4d0ed4ef4d76e3059a3cc3914686e8167708c1dd"],"ref":"refs/changes/00/2700/4","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507582623,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507582657,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":60,"sizeDeletions":-1},{"number":"5","revision":"592061250e3bfbaf7bac456bf332e696a52b4feb","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/00/2700/5","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1507588201,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1507582657,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":60,"sizeDeletions":-1},{"number":"6","revision":"25a81f93a2f0f0b512360e35c9e2fbdf2a6e0c02","parents":["4d0ed4ef4d76e3059a3cc3914686e8167708c1dd"],"ref":"refs/changes/00/2700/6","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508182355,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508182389,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":65,"sizeDeletions":-1},{"number":"7","revision":"a6c4444eb2bd3f60d472cca53a647b98edb6fd26","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/00/2700/7","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508182404,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508182389,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"comments":[{"file":"lib/common.js","line":222,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"In what case would we need the contentEncoding stored on `prev`?"},{"file":"lib/common.js","line":222,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"Looking at it now, I don\u0027t think I really understood what this field meant and was trying to mimic the management of contentLength. If I correctly understand it now - this is the metadata possibly loaded for an object with the same metadata key that we are now overwriting with a PUT request so it wouldn\u0027t make sense to use this field. I\u0027ll remove this."},{"file":"lib/uploads/common.js","line":466,"reviewer":{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},"message":"I\u0027m surprised we need this here. Looking at the createMetadata change, I would think the content-encoding header would be correct, since it would be in the headers of the request (as set on line 440)."},{"file":"lib/uploads/common.js","line":466,"reviewer":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"message":"That\u0027s right. Again, I was looking at how contentType was being treated and didn\u0027t really figure out why a similar codeblock appears above when it also seems to be set in createMetadata. I re-ran tests, this is not necessary."}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":2,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"lib/uploads/common.js","type":"MODIFIED","insertions":5,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":65,"sizeDeletions":-1},{"number":"8","revision":"6be185639c50511ed55580dee37d77da353aa67e","parents":["4d0ed4ef4d76e3059a3cc3914686e8167708c1dd"],"ref":"refs/changes/00/2700/8","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508438556,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508438589,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":64,"sizeDeletions":-1},{"number":"9","revision":"dbe33666771cf8c1e443091ccc1ad246b58628f8","parents":["a612da71491efd1e926b986741f30f2f2055b685"],"ref":"refs/changes/00/2700/9","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1508440796,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"TRIVIAL_REBASE","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1508438589,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":64,"sizeDeletions":-1},{"number":"10","revision":"092778ac6c6df31313ba42cfa647f64e35645fde","parents":["4d0ed4ef4d76e3059a3cc3914686e8167708c1dd"],"ref":"refs/changes/00/2700/10","uploader":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"createdOn":1509050855,"author":{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"},"isDraft":false,"kind":"REWORK","approvals":[{"type":"CI-Testing","description":"CI-Testing","value":"1","grantedOn":1509050882,"by":{"name":"Joyent Automation","username":"joyent-automation"}}],"files":[{"file":"/COMMIT_MSG","type":"ADDED","insertions":7,"deletions":0},{"file":"docs/index.md","type":"MODIFIED","insertions":5,"deletions":0},{"file":"lib/common.js","type":"MODIFIED","insertions":1,"deletions":0},{"file":"lib/obj.js","type":"MODIFIED","insertions":4,"deletions":0},{"file":"package.json","type":"MODIFIED","insertions":1,"deletions":-1},{"file":"test/obj.test.js","type":"MODIFIED","insertions":53,"deletions":0}],"sizeInsertions":64,"sizeDeletions":-1}],"allReviewers":[{"name":"Joyent Automation","username":"joyent-automation"},{"name":"Jordan Hendricks","email":"jordan.hendricks@joyent.com","username":"jordanhendricks"},{"name":"Elijah Zupancic","email":"elijah.zupancic@joyent.com","username":"dekobon"},{"name":"Jan Wyszynski","email":"jan.wyszynski@joyent.com","username":"IanWyszynski"}]}