From e804273196f03f089e4a3911f781232727df0471 Mon Sep 17 00:00:00 2001
From: Jan Wyszynski <jan.wyszynski@joyent.com>
Date: Tue, 3 Oct 2017 02:23:38 +0000
Subject: [PATCH] MANTA-3440 Add support for Content-Encoding for objects

---
 lib/common.js    |  2 ++
 lib/obj.js       |  4 ++++
 package.json     |  2 +-
 test/obj.test.js | 23 +++++++++++++++++++++++
 4 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/lib/common.js b/lib/common.js
index 5688a80..b74b601 100644
--- a/lib/common.js
+++ b/lib/common.js
@@ -219,6 +219,8 @@ function createMetadata(req, type, cb) {
         break;
 
     case 'object':
+        md.contentEncoding = req.header('content-encoding') ||
+            prev.contentEncoding;
         md.contentLength = req._size !== undefined ?
             req._size : prev.contentLength;
         md.contentMD5 = req._contentMD5 || prev.contentMD5;
diff --git a/lib/obj.js b/lib/obj.js
index 23082b5..9994840 100644
--- a/lib/obj.js
+++ b/lib/obj.js
@@ -377,6 +377,7 @@ function startSharkStreams(req, res, next) {
 
     var ndx = 0;
     var opts = {
+        contentEncoding: req.headers['content-encoding'],
         contentType: req.getContentType(),
         contentLength: req.isChunked() ? undefined : req._size,
         contentMd5: req.headers['content-md5'],
@@ -626,6 +627,7 @@ function saveMetadata(req, res, next) {
         log.debug({
             options: opts
         }, 'saveMetadata: entered');
+
         req.moray.putMetadata(opts, function (err2) {
             req.sharks = null;
             if (err2) {
@@ -708,6 +710,7 @@ function streamFromSharks(req, res, next) {
     if (md.contentLength === 0 || req.method === 'HEAD') {
         log.debug('streamFromSharks: HEAD || zero-byte object');
         res.header('Durability-Level', req.metadata.sharks.length);
+        res.header('Content-Encoding', md.contentEncoding);
         res.header('Content-Length', md.contentLength);
         res.header('Content-MD5', md.contentMD5);
         res.header('Content-Type', md.contentType);
@@ -731,6 +734,7 @@ function streamFromSharks(req, res, next) {
             res.header('Content-MD5', md.contentMD5);
         }
 
+        res.header('Content-Encoding', req.metadata.contentEncoding);
         res.header('Content-Length', sh['content-length']);
         res.header('Durability-Level', req.metadata.sharks.length);
 
diff --git a/package.json b/package.json
index a82fad1..d44d805 100644
--- a/package.json
+++ b/package.json
@@ -26,7 +26,7 @@
         "kang": "1.1.0",
         "keep-alive-agent": "0.0.1",
         "keyapi": "git+https://github.com/joyent/keyapi.git#e14b3d58",
-        "libmanta": "git+https://github.com/joyent/node-libmanta.git#master",
+        "libmanta": "file:../node-libmanta",
         "libuuid": "0.1.2",
         "lru-cache": "2.3.1",
         "lstream": "0.0.4",
diff --git a/test/obj.test.js b/test/obj.test.js
index c4863a1..539e8e3 100644
--- a/test/obj.test.js
+++ b/test/obj.test.js
@@ -14,6 +14,7 @@ var MemoryStream = require('stream').PassThrough;
 var restify = require('restify');
 var uuid = require('node-uuid');
 var vasync = require('vasync');
+var util = require('util');
 
 if (require.cache[__dirname + '/helper.js'])
     delete require.cache[__dirname + '/helper.js'];
@@ -550,6 +551,28 @@ test('put unmodified-since fail', function (t) {
 });
 
 
+test('put check content-encoding', function (t) {
+    var self = this;
+    var opts = {
+        headers: {
+            'content-encoding': 'gzip'
+        }
+    };
+
+    self.putObject(t, opts, function (_, headers) {
+        self.client.info(self.key, function (err2, info, res) {
+            t.ifError(err2);
+            if (!err2) {
+                t.ok(res && res.headers);
+                t.ok(res.headers['content-encoding']);
+                t.equal(res.headers['content-encoding'], 'gzip');
+            }
+            t.end();
+        });
+    });
+});
+
+
 test('put bad content-md5', function (t) {
     var opts = {
         md5: 'bogus',
-- 
2.21.0

