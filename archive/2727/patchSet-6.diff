From c0ff9cf6b68016f498a2aa4e8d7d1bb346f3dcf2 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Tue, 10 Oct 2017 17:17:41 +0200
Subject: [PATCH] PAPI-143 Moray buckets need to be reindexed after schema
 updates

---
 lib/backend.js | 42 +++++++++++++++++++++++++++++++++++++++---
 1 file changed, 39 insertions(+), 3 deletions(-)

diff --git a/lib/backend.js b/lib/backend.js
index 2f68328..13e912a 100644
--- a/lib/backend.js
+++ b/lib/backend.js
@@ -15,13 +15,13 @@
 
 var moray  = require('moray');
 var assert = require('assert');
-var util   = require('util');
 var jsprim = require('jsprim');
 var VError = require('verror');
 
 var RETRY_BUCKET_CREATION_INTERVAL = 10000; // in ms
 var DB_RESERVED_NAMES = ['default', 'group'];
-
+var MAX_ROWS_TO_REINDEX = 100;
+var MAX_REINDEX_ATTEMPTS = 5;
 
 /*
  * Backend constructor. Returns a set of methods useful for fetching and
@@ -60,6 +60,42 @@ function (cb) {
     var backend = createMorayClient(self.opts);
     self.backend = backend;
 
+    var reindexAttempts = 0;
+
+    function reindexObjects(done) {
+        backend.reindexObjects(bucket, MAX_ROWS_TO_REINDEX,
+            function reindexCb(reindexErr, reindexRes) {
+            if (reindexErr) {
+                reindexAttempts += 1;
+                log.error({
+                    err: reindexErr,
+                    bucket: bucket
+                }, 'Reindex bucket error');
+                if (reindexAttempts < MAX_REINDEX_ATTEMPTS) {
+                    setTimeout(function () {
+                        reindexObjects(done);
+                    }, RETRY_BUCKET_CREATION_INTERVAL);
+                } else {
+                    done(reindexErr);
+                }
+                return;
+            }
+
+            if (reindexRes.processed === 0) {
+                log.info('Reindex bucket done');
+                done();
+                return;
+            }
+
+            log.info({
+                bucket: bucket,
+                results: reindexRes
+            }, 'reindexed %d rows', reindexRes.processed);
+
+            reindexObjects(done);
+        });
+    }
+
     /*
      * Ensure bucket for packages in Moray exists. Keep retrying every 10s
      * until successful.
@@ -97,7 +133,7 @@ function (cb) {
                     morayConnectCallback();
                 }, RETRY_BUCKET_CREATION_INTERVAL);
             } else {
-                cb();
+                reindexObjects(cb);
             }
         });
     };
-- 
2.21.0

