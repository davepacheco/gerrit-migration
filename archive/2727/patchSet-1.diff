commit 9e122da3f77dec2c4c59a0dca4ecb77168fa1671 (refs/changes/27/2727/1)
Author: Pedro Palazon Candel <pedro@joyent.com>
Date:   2017-10-05T18:26:48+02:00 (2 years ago)
    
    PAPI-143 Moray buckets need to be reindexed after schema updates

diff --git a/lib/backend.js b/lib/backend.js
index 2f68328..5722ee5 100644
--- a/lib/backend.js
+++ b/lib/backend.js
@@ -15,12 +15,12 @@
 
 var moray  = require('moray');
 var assert = require('assert');
-var util   = require('util');
 var jsprim = require('jsprim');
 var VError = require('verror');
 
 var RETRY_BUCKET_CREATION_INTERVAL = 10000; // in ms
 var DB_RESERVED_NAMES = ['default', 'group'];
+var MAX_ROWS_TO_REINDEX = 100;
 
 
 /*
@@ -88,6 +88,30 @@ function (cb) {
                 version: opts.moray.version
             }
         }, function (err) {
+
+            function reindexObjects(rowsToReindex) {
+                backend.reindexObjects(bucket, rowsToReindex,
+                    function reindexCb(reindexErr, reindexRes) {
+                    if (reindexErr) {
+                        log.error({
+                            err: reindexErr
+                        }, 'Reindex bucket error');
+                        cb(reindexErr);
+                        return;
+                    }
+
+                    if (reindexRes.processed === 0) {
+                        log.info('Reindex bucket done');
+                        cb();
+                        return;
+                    }
+
+                    rowsToReindex = reindexRes.remaining < rowsToReindex ?
+                            reindexRes.remaining : rowsToReindex;
+                    reindexObjects(rowsToReindex);
+                });
+            }
+
             if (err) {
                 log.fatal({ err: err }, 'Unable to put SDC Packages bucket');
                 log.info('Trying again in ' + RETRY_BUCKET_CREATION_INTERVAL +
@@ -97,7 +121,7 @@ function (cb) {
                     morayConnectCallback();
                 }, RETRY_BUCKET_CREATION_INTERVAL);
             } else {
-                cb();
+                reindexObjects(MAX_ROWS_TO_REINDEX);
             }
         });
     };
