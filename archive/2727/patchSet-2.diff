From 59bda25b1374a4728bc1914b328abcca5bab7fd1 Mon Sep 17 00:00:00 2001
From: Pedro Palazon Candel <pedro@joyent.com>
Date: Fri, 6 Oct 2017 16:22:38 +0200
Subject: [PATCH] PAPI-143 Moray buckets need to be reindexed after schema
 updates

---
 lib/backend.js | 26 ++++++++++++++++++++++++--
 1 file changed, 24 insertions(+), 2 deletions(-)

diff --git a/lib/backend.js b/lib/backend.js
index 2f68328..06887cb 100644
--- a/lib/backend.js
+++ b/lib/backend.js
@@ -15,12 +15,12 @@
 
 var moray  = require('moray');
 var assert = require('assert');
-var util   = require('util');
 var jsprim = require('jsprim');
 var VError = require('verror');
 
 var RETRY_BUCKET_CREATION_INTERVAL = 10000; // in ms
 var DB_RESERVED_NAMES = ['default', 'group'];
+var MAX_ROWS_TO_REINDEX = 100;
 
 
 /*
@@ -60,6 +60,28 @@ function (cb) {
     var backend = createMorayClient(self.opts);
     self.backend = backend;
 
+    function reindexObjects(done) {
+        backend.reindexObjects(bucket, MAX_ROWS_TO_REINDEX,
+            function reindexCb(reindexErr, reindexRes) {
+            if (reindexErr) {
+                log.error({
+                    err: reindexErr,
+                    bucket: bucket
+                }, 'Reindex bucket error');
+                done(reindexErr);
+                return;
+            }
+
+            if (reindexRes.processed === 0) {
+                log.info('Reindex bucket done');
+                done();
+                return;
+            }
+
+            reindexObjects(done);
+        });
+    }
+
     /*
      * Ensure bucket for packages in Moray exists. Keep retrying every 10s
      * until successful.
@@ -97,7 +119,7 @@ function (cb) {
                     morayConnectCallback();
                 }, RETRY_BUCKET_CREATION_INTERVAL);
             } else {
-                cb();
+                reindexObjects(cb);
             }
         });
     };
-- 
2.21.0

