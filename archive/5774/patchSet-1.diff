From b846a303328bde8adc358d8de4d4e0b66e582e0e Mon Sep 17 00:00:00 2001
From: Josh Wilsdon <jwilsdon@joyent.com>
Date: Tue, 12 Mar 2019 12:05:57 -0700
Subject: [PATCH] TRITON-1304 net-agent fails to properly handle admin NIC for
 CNs

---
 lib/nic-fsm.js | 24 ++++++++++++++++++++++++
 package.json   |  2 +-
 2 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/lib/nic-fsm.js b/lib/nic-fsm.js
index a128fda..fefd62b 100644
--- a/lib/nic-fsm.js
+++ b/lib/nic-fsm.js
@@ -28,6 +28,7 @@ var ANTI_SPOOF_FIELDS = [
 
 var LOCAL_FIELDS = [
     'belongs_to_type',
+    'belongs_to_uuid',
     'cn_uuid',
     'owner_uuid',
     'primary',
@@ -318,6 +319,7 @@ NicFSM.prototype.state_update = function (S) {
         'refresh',
         'remove',
         'update.local',
+        'update.napi',
         'waiting'
     ]);
 
@@ -331,6 +333,28 @@ NicFSM.prototype.state_update = function (S) {
         return;
     }
 
+    /*
+     * When a new CN is first booted, booter inserts a NAPI record for the admin
+     * NIC which has:
+     *
+     *   belongs_to_type = other
+     *   belongs_to_uuid = <admin user's UUID>
+     *
+     * if we see this for a NIC we "own", we should update NAPI so the type gets
+     * corrected.
+     */
+    if (this.remote.belongs_to_type === 'other' &&
+        this.remote.belongs_to_uuid === this.app.admin_uuid &&
+        this.local.belongs_to_type === 'server') {
+
+        this.log.info({
+            nic: this.local
+        }, 'found our NIC unclaimed in NAPI, claiming.');
+
+        S.gotoState('update.napi');
+        return;
+    }
+
     /*
      * If the belongs_to_uuid has changed, then we need to move the NIC.
      */
diff --git a/package.json b/package.json
index c35a294..340cfd7 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
     "name": "net-agent",
     "description": "Triton Network Agent",
-    "version": "2.2.4",
+    "version": "2.2.5",
     "author": "Joyent (joyent.com)",
     "private": true,
     "dependencies": {
-- 
2.21.0

